<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš´ğŸ¾ ğŸŒ” ğŸ›… Unsafe.AsSpanï¼šSpan <T>ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹æ–¹æ³•ï¼Ÿ âœğŸ¿ ğŸ¤  ğŸš£ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C#-ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©æŸ”è»Ÿãªè¨€èªã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã§ãªãã€ãã“ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚C#è¨€èªã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã«ç‰¹å®šã®è¦ä»¶ã‚’èª²ã™ç§‘å­¦ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ä»•äº‹ã«ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œnetcoreã¯è­°é¡Œã‚’æ‰ãˆã¦ã„ã¾ã™ãŒï¼ˆä¸¡æ–¹ã®è¨€èªã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®netstandard2.0 ã»ã¨ã‚“ã©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unsafe.AsSpanï¼šSpan <T>ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹æ–¹æ³•ï¼Ÿ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465077/"><p><img src="https://habrastorage.org/webt/3f/dh/ia/3fdhia5h25mpjbabeocnlygdd1c.png"></p><br>
<p><code>C#</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©æŸ”è»Ÿãªè¨€èªã€‚</font><font style="vertical-align: inherit;">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚„ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã§ãªãã€ãã“ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><code>C#</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¨€èªã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã«ç‰¹å®šã®è¦ä»¶ã‚’èª²ã™ç§‘å­¦ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ä»•äº‹</font><font style="vertical-align: inherit;">ã«ä½¿ç”¨</font><font style="vertical-align: inherit;">ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œ</font></font><code>netcore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯è­°é¡Œã‚’æ‰ãˆã¦ã„</font><font style="vertical-align: inherit;">ã¾ã™ãŒï¼ˆä¸¡æ–¹ã®è¨€èªã¨ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®</font></font><code>netstandard2.0</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã»ã¨ã‚“ã©ã®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ©Ÿèƒ½ãŒã«ãƒãƒƒã‚¯ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„</font><font style="vertical-align: inherit;">ã“ã¨</font><font style="vertical-align: inherit;">ã‚’å‰æ</font><font style="vertical-align: inherit;">ã¨ã—ã¦ã„ã¾ã™</font></font><code>netframework</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®ä½œæ¥­ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã§ã¯ã€ç§ã¯1ã¤ã®éè‡ªæ˜ãªï¼ˆãŠãã‚‰ãå¸Œæœ›ï¼Ÿï¼‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨</font></font><code>Span&lt;T&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠã‚ˆã³å®Ÿè£…ã®é•ã„</font></font><code>Span&lt;T&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§</font></font><code>netframework</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>netcore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ©Ÿèƒ½ã«èµ·å› ã™ã‚‹ãŒ</font></font><code>clr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></p><a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…è²¬äº‹é …1</font></font></b><div class="spoiler_text"><p>               .</p><br>
<p>  (?)  â€” , , proof-of-concept.<br>
  ,     ,        .</p></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…è²¬äº‹é …2</font></font></b><div class="spoiler_text"><p>  ,  -,  -   <strong></strong>  -  .</p><br>
<p>   <code>C#</code>     - .</p><br>
<p>  ,         ,     .</p></div></div><br>
<h1 id="a-zachem-mne-voobsche-spant"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãªãœã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®</font></font><code>Span&lt;T&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã‹ï¼Ÿ</font></font></h1><br>
<p>     <code>unmanaged</code>-    ,    .    ,     <code>BCL</code> <code>netframework</code>   ,    ,  <code>System.Memory</code>, <code>System.Buffers</code>  <code>System.Runtime.CompilerServices.Unsafe</code>.<br>
    - ,      ,     .<br>
    ?       ,    .  , ,       <code>T[]</code>,  <code>T</code>    <code>unmanaged</code>  ,  <code>Int32</code> (  <code>int</code>).       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-</a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">1981-</a>,      .     â€”  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">BigEndian</a>.  ,   ( )   <code>T[]</code>,   endianess  .  .<br>
    ?</p><br>
<ol>
<li>   <code>T[]</code>,  <code>BitConverter.GetBytes(T)</code>,    ,    .</li>
<li>   <code>T[]</code>,    <code>new byte[] {(byte)((x &amp; 0xFF00) &gt;&gt; 8), (byte)(x &amp; 0x00FF)};</code> (    ),    .</li>
<li><sup>*</sup>   <code>T[]</code>  ?   , ?      ,  <code>Buffer.BlockCopy(intArray, 0, byteArray, 0, intArray.Length * sizeof(int));</code>.        .        .     .</li>
<li><sup>*</sup> ,  <code>C#</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>(C++)++</code></a>.   <code>/unsafe</code>,  <code>fixed(int* p = &amp;intArr[0]) byte* bPtr = (byte*)p;</code>          ,    endianess      ( <code>stackalloc byte[]</code>  <code>ArrayPool&lt;byte&gt;.Shared</code>   ),        .</li>
</ol><br>
<p> , <strong>4</strong>     ,    <code>unsafe</code>-     â€”  -   .       <code>Span&lt;T&gt;</code>.</p><br>
<h1 id="spant"><code>Span&lt;T&gt;</code></h1><br>
<p><code>Span&lt;T&gt;</code>              ,     ""   .  <code>GC</code>-aware    .    .<br>
   â€”    <code>System.Runtime.CompilerServices.Unsafe</code>, <code>Span&lt;T&gt;</code>     <code>T</code>. ,   ,  , <sup>1</sup> + ,       ,     ,      ?     <code>public Span&lt;T&gt;(void* pointer, int length)</code>.<br>
  :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">Test</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Test</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Flip</span>(<span class="hljs-params">Span&lt;<span class="hljs-keyword">byte</span>&gt; span</span>)</span> {<span class="hljs-comment">/*   endianess */</span>}<font></font>
    Span&lt;<span class="hljs-keyword">int</span>&gt; x = <span class="hljs-keyword">new</span> [] {<span class="hljs-number">123</span>};<font></font>
    Span&lt;<span class="hljs-keyword">byte</span>&gt; y = DangerousCast&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">byte</span>&gt;(x);<font></font>
<font></font>
    Assert.AreEqual(<span class="hljs-number">123</span>, x[<span class="hljs-number">0</span>]);<font></font>
    Flip(y);<font></font>
    Assert.AreNotEqual(<span class="hljs-number">123</span>, x[<span class="hljs-number">0</span>]);<font></font>
    Flip(y);<font></font>
    Assert.AreEqual(<span class="hljs-number">123</span>, x[<span class="hljs-number">0</span>]);<font></font>
}</code></pre><br>
<p>       ,    .   ? ,    , â€” <strong></strong>.<br>
        .  <code>netcore</code>  <em></em> ,   <code>netframework</code> â€”  .<br>
, ,    ,      100% .<br>
 .</p><br>
<p><sup>1</sup>  <em></em>.</p><br>
<h1 id="pravilnyy-otvet-zavisit"> : </h1><br>
<p>   â€” <em></em>?<br>
        :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span> =&gt; Check();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Check</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    Span&lt;<span class="hljs-keyword">int</span>&gt;  x = <span class="hljs-keyword">new</span>[] {<span class="hljs-number">999</span>, <span class="hljs-number">123</span>, <span class="hljs-number">11</span>, <span class="hljs-number">-100</span>};<font></font>
    Span&lt;<span class="hljs-keyword">byte</span>&gt; y = As&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">byte</span>&gt;(<span class="hljs-keyword">ref</span> x);<font></font>
<font></font>
    Console.WriteLine(<span class="hljs-string">@"FRAMEWORK_NAME"</span>);<font></font>
    Write(<span class="hljs-keyword">ref</span> x);<font></font>
    Write(<span class="hljs-keyword">ref</span> y);<font></font>
    Console.WriteLine();<font></font>
<font></font>
    Write&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> x, <span class="hljs-string">"Span&lt;int&gt; [0]"</span>);<font></font>
    Write&lt;<span class="hljs-keyword">byte</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> y, <span class="hljs-string">"Span&lt;byte&gt;[0]"</span>);<font></font>
    Console.WriteLine();<font></font>
<font></font>
    Write&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> Offset&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">object</span>&gt;(<span class="hljs-keyword">ref</span> x[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>), <span class="hljs-string">"Span&lt;int&gt; [0] offset by size_t"</span>);<font></font>
    Write&lt;<span class="hljs-keyword">byte</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> Offset&lt;<span class="hljs-keyword">byte</span>, <span class="hljs-keyword">object</span>&gt;(<span class="hljs-keyword">ref</span> y[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>), <span class="hljs-string">"Span&lt;byte&gt;[0] offset by size_t"</span>);<font></font>
    Console.WriteLine();<font></font>
<font></font>
    GC.Collect(<span class="hljs-number">0</span>, GCCollectionMode.Forced, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<font></font>
<font></font>
    Write&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> x, <span class="hljs-string">"Span&lt;int&gt; [0] after GC"</span>);<font></font>
    Write&lt;<span class="hljs-keyword">byte</span>, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-keyword">ref</span> y, <span class="hljs-string">"Span&lt;byte&gt;[0] after GC"</span>);<font></font>
    Console.WriteLine();<font></font>
    Write(<span class="hljs-keyword">ref</span> x);<font></font>
    Write(<span class="hljs-keyword">ref</span> y);<font></font>
}</code></pre><br>
<p> <code>Write&lt;T, U&gt;</code>    <code>T</code>,    ,         <code>U</code>.  , <code>Write&lt;int, int&gt;(ref x)</code>     +  999.<br>
 <code>Write</code>  .<br>
   <code>As&lt;,&gt;</code>:</p><br>
<pre><code class="cs hljs"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsafe</span> Span&lt;U&gt; As&lt;T, U&gt;(<span class="hljs-keyword">ref</span> Span&lt;T&gt; span)
            <span class="hljs-keyword">where</span> T : unmanaged
            <span class="hljs-keyword">where</span> U : unmanaged<font></font>
        {<font></font>
            <span class="hljs-keyword">fixed</span>(T* ptr = span)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Span&lt;U&gt;(ptr,<font></font>
                span.Length * Unsafe.SizeOf&lt;T&gt;() / Unsafe.SizeOf&lt;U&gt;());<font></font>
        }</code></pre><br>
<p>  <code>C#</code>    <code>fixed</code>-     <code>Span&lt;T&gt;.GetPinnableReference()</code>.<br>
    <code>netframework4.8</code>  <code>x64</code> . ,  :</p><br>
<pre><code class="plaintext hljs">LEGACY<font></font>
[ 999, 123, 11, -100 ]<font></font>
[ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ]<font></font>
<font></font>
0x|00|00|02|8C|00|00|2F|B0         999  Span&lt;int&gt; [0]<font></font>
0x|00|00|02|8C|00|00|2F|B0         999  Span&lt;byte&gt;[0]<font></font>
<font></font>
0x|00|00|02|8C|00|00|2F|B8          11  Span&lt;int&gt; [0] offset by size_t<font></font>
0x|00|00|02|8C|00|00|2F|B8          11  Span&lt;byte&gt;[0] offset by size_t<font></font>
<font></font>
0x|00|00|02|8C|00|00|2B|18         999  Span&lt;int&gt; [0] after GC<font></font>
0x|00|00|02|8C|00|00|2F|B0     6750318  Span&lt;byte&gt;[0] after GC<font></font>
<font></font>
[ 999, 123, 11, -100 ]<font></font>
[ 110, 0, 103, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ]</code></pre><br>
<p>   (   )   ,  <code>Span&lt;byte&gt;</code>,  ,  byte-view  . ,  .<br>
,        <code>IntPtr</code> ( <code>2 X int</code>  <code>x64</code>)  .       .    ...</p><br>
<pre><code class="plaintext hljs">GC.Collect(0, GCCollectionMode.Forced, true, true);</code></pre><br>
<p>      <code>GC</code>  .   <code>GC.Collect</code> <code>GC</code>    . <code>Span&lt;int&gt;</code>   ,    <code>Span&lt;byte&gt;</code>     ,    .       !</p><br>
<p>        ,   <code>netcore3.0.100-preview8</code>. </p><br>
<pre><code class="plaintext hljs">CORE<font></font>
[ 999, 123, 11, -100 ]<font></font>
[ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ]<font></font>
<font></font>
0x|00|00|01|F2|8F|BD|C6|90         999  Span&lt;int&gt; [0]<font></font>
0x|00|00|01|F2|8F|BD|C6|90         999  Span&lt;byte&gt;[0]<font></font>
<font></font>
0x|00|00|01|F2|8F|BD|C6|98          11  Span&lt;int&gt; [0] offset by size_t<font></font>
0x|00|00|01|F2|8F|BD|C6|98          11  Span&lt;byte&gt;[0] offset by size_t<font></font>
<font></font>
0x|00|00|01|F2|8F|BD|BF|38         999  Span&lt;int&gt; [0] after GC<font></font>
0x|00|00|01|F2|8F|BD|BF|38         999  Span&lt;byte&gt;[0] after GC<font></font>
<font></font>
[ 999, 123, 11, -100 ]<font></font>
[ 231, 3, 0, 0, 123, 0, 0, 0, 11, 0, 0, 0, 156, 255, 255, 255 ]</code></pre><br>
<p> ,   <em></em>,    .  ,     . !        -?</p><br>
<h1 id="jit-intrinsic">JIT intrinsic</h1><br>
<p>  ,      <code>netcore</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  , <code>netcore</code>            ,  <code>GC</code>  .  <code>netframework</code>  <code>nuget</code>-  â€”  .  ,      :        ,  â€”      ,    .    , -   ,   ,    .  ,  <em></em>    <code>netcore</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">readonly</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Span&lt;T&gt; <span class="hljs-keyword">where</span> T : unmanaged<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ByReference&lt;T&gt; _pointer; <span class="hljs-comment">//  -  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> _length;<font></font>
}</code></pre><br>
<p>  <code>netframework</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">readonly</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Span&lt;T&gt; <span class="hljs-keyword">where</span> T : unmanaged<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Pinnable&lt;T&gt; _pinnable;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IntPtr _byteOffset;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> _length;<font></font>
}</code></pre><br>
<p><code>_pinnable</code>    ,      , <code>_byteOffset</code>   (        ,   ,     , <em></em>).      <code>void*</code>,      <code>_byteOffset</code>.       ,        <code>if(_pinnable is null) {/*    */} else {/*    _pinnable */}</code>.     ?</p><br>
<h1 id="kak-delat-ne-stoit-no-ya-vse-zhe-sdelal">   ,     </h1><br>
<p>    ,  <code>netframework</code>,     <code>Span&lt;T&gt; -&gt; Span&lt;U&gt;</code>,    .<br>
<strong>:     , ,    Undefined Behavior  </strong></p><br>
<h2 id="metod-1-naivnyy"> 1: </h2><br>
<p>  ,        <code>netframework</code>.    <code>_pinnable</code>. ,  ,    (     ),    , .    <em>-</em> :   <code>ref struct</code>,       ,    <code>object</code>.    ,   ,     .   (      )   .</p><br>
<h2 id="metod-2-we-need-to-go-deeper"> 2: We need to go deeper</h2><br>
<p>      (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">[1]</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">[2]</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">[3]</a>).  â€” ,    <code>T</code>       (<em>  </em>).    <code>[FieldOffset(0)]</code>?  â€” .</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span>]
<span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Exchange&lt;T, U&gt;
    <span class="hljs-keyword">where</span> T : unmanaged
    <span class="hljs-keyword">where</span> U : unmanaged<font></font>
    {<font></font>
        [<span class="hljs-meta">FieldOffset(0)</span>]
        <span class="hljs-keyword">public</span> Span&lt;T&gt; Span_1;<font></font>
        [<span class="hljs-meta">FieldOffset(0)</span>]
        <span class="hljs-keyword">public</span> Span&lt;U&gt; Span_2;<font></font>
    }</code></pre><br>
<p>    (     )   <code>TypeLoadException</code> â€”     <code>LayoutKind.Explicit</code>. ,  ,    :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Exchange<font></font>
{<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">byte</span>&gt; ByteSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">sbyte</span>&gt; SByteSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">ushort</span>&gt; UShortSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">short</span>&gt; ShortSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">uint</span>&gt; UIntSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">int</span>&gt;  IntSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">ulong</span>&gt; ULongSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">long</span>&gt; LongSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">float</span>&gt; FloatSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">double</span>&gt; DoubleSpan;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-keyword">char</span>&gt; CharSpan;<font></font>
}</code></pre><br>
<p>   :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Span&lt;<span class="hljs-keyword">byte</span>&gt; <span class="hljs-title">As2</span>(<span class="hljs-params">Span&lt;<span class="hljs-keyword">int</span>&gt; span</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> exchange = <span class="hljs-keyword">new</span> Exchange()<font></font>
    {<font></font>
        IntSpan = span<font></font>
    };<font></font>
    <span class="hljs-keyword">return</span> exchange.ByteSpan;<font></font>
}</code></pre><br>
<p>      â€”  <code>_length</code>   ,    <code>int</code> -&gt; <code>byte</code>  -  4    .<br>
 :</p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Raw<font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> Pinnable;
    <span class="hljs-keyword">public</span> IntPtr Pointer;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Length;<font></font>
}<font></font>
[<span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Exchange<font></font>
{<font></font>
    <span class="hljs-comment">/* */</span>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Raw RawView;<font></font>
}</code></pre><br>
<p>  <code>RawView</code>        .</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Span&lt;<span class="hljs-keyword">byte</span>&gt; <span class="hljs-title">As2</span>(<span class="hljs-params">Span&lt;<span class="hljs-keyword">int</span>&gt; span</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> exchange = <span class="hljs-keyword">new</span> Exchange()<font></font>
    {<font></font>
        IntSpan = span<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">var</span> exchange2 = <span class="hljs-keyword">new</span> Exchange()<font></font>
    {<font></font>
        RawView = <span class="hljs-keyword">new</span> Raw()<font></font>
        {<font></font>
            Pinnable = exchange.RawView.Pinnable,<font></font>
            Pointer = exchange.RawView.Pointer,<font></font>
            Length = exchange.RawView.Length * <span class="hljs-keyword">sizeof</span>&lt;<span class="hljs-keyword">int</span>&gt; / <span class="hljs-keyword">sizeof</span>&lt;<span class="hljs-keyword">byte</span>&gt;<font></font>
        }<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">return</span> exchange2.ByteSpan;<font></font>
}</code></pre><br>
<p>   <strong>,  </strong>,     .  â€”     ,    .</p><br>
<h2 id="metod-3-bezumnyy"> 3: </h2><br>
<p>    ,    .       <code>unmanaged</code>    .    ? ,  <code>CLR</code>   <em> </em>.</p><br>
<p>  ?   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  ,   :<br>
   -&gt;    -&gt;   -&gt; {, ,  ..} -&gt;      <code>Type</code>.<br>
  ,     (  <code>ref struct</code>),     <code>ildasm</code>.      <strong>dotPeek</strong>.<br>
 type builder   :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> typeBuilder = _mBuilder.DefineType(<span class="hljs-string">$"Generated_<span class="hljs-subst">{<span class="hljs-keyword">typeof</span>(T).Name}</span>"</span>,<font></font>
                TypeAttributes.Public<font></font>
                | TypeAttributes.Sealed<font></font>
                | TypeAttributes.ExplicitLayout   <span class="hljs-comment">// &lt;-   </span><font></font>
                | TypeAttributes.AnsiClass<font></font>
                | TypeAttributes.BeforeFieldInit, <span class="hljs-keyword">typeof</span>(ValueType));</code></pre><br>
<p> â€” .     <code>Span&lt;T&gt;</code>  <code>Span&lt;U&gt;</code> -     ,          </p><br>
<pre><code class="cs hljs">[<span class="hljs-meta">StructLayout(LayoutKind.Explicit)</span>]
<span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Generated_Int32<font></font>
{<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Span&lt;Int32&gt; Span;<font></font>
    [<span class="hljs-meta">FieldOffset(0)</span>]
    <span class="hljs-keyword">public</span> Raw Raw;<font></font>
}</code></pre><br>
<p> <code>Raw</code>      .    <code>IsByRefLikeAttribute</code>.    :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> spanField = typeBuilder.DefineField(<span class="hljs-string">"Span"</span>, <span class="hljs-keyword">typeof</span>(Span&lt;T&gt;), FieldAttributes.Private);<font></font>
spanField.SetOffset(<span class="hljs-number">0</span>);
<span class="hljs-keyword">var</span> rawField = typeBuilder.DefineField(<span class="hljs-string">"Raw"</span>, <span class="hljs-keyword">typeof</span>(Raw), FieldAttributes.Private);<font></font>
rawField.SetOffset(<span class="hljs-number">0</span>);</code></pre><br>
<p>  ,   .   , .   , ,   (<code>T -&gt; Generated_{nameof(T)}</code>).  ,     <code>TIn</code>  <code>TOut</code>   -      .   .      ,     (   <code>ref struct</code>)  . <em>     </em>.   ?</p><br>
<h2 id="delegates-to-the-rescue">Delegates to the rescue</h2><br>
<p>     :</p><br>
<pre><code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword">object</span> <span class="hljs-title">Invoke</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> MethodInfo mi, <span class="hljs-keyword">object</span> @<span class="hljs-keyword">this</span>, <span class="hljs-keyword">object</span>[] otherArgs</span>)</span></code></pre><br>
<p>       ,    (= )    â€”  .<br>
  , <code>@this</code>  <code>otherArgs</code>     <code>ref struct</code>,     .<br>
   .           ( ,     ).<br>
:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">void</span> Generated_Int32.SetSpan(Span&lt;Int32&gt; span) =&gt; <span class="hljs-keyword">this</span>.Span = span;</code></pre><br>
<p>         (  ):</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> SpanSetterDelegate&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword">where</span> T : unmanaged;</code></pre><br>
<p>    ,          <code>Action&lt;Span&lt;T&gt;&gt;</code>,      -. <code>SpanSetterDelegate</code>, ,   .<br>
   .      :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> mi = type.GetMethod(<span class="hljs-string">"Method_Name"</span>); <span class="hljs-comment">// ,    public &amp; instance</span>
<span class="hljs-keyword">var</span> spanSetter =  (SpanSetterDelegate&lt;T&gt;) mi.CreateDelegate(<span class="hljs-keyword">typeof</span>(SpanSetterDelegate&lt;T&gt;), @this); </code></pre><br>
<p> <code>spanSetter</code>   , , <code>spanSetter(Span&lt;T&gt;.Empty);</code>.   <code>@this</code><sup>2</sup>,      , , ,  <code>Activator.CreateInstance(type)</code>,        .</p><br>
<p>,   â€”     .</p><br>
<p><sup>2</sup>   ,    -   â€” <code>Activator.CreateInstance()</code>  <code>ref struct</code>-. .   .</p><br>
<h2 id="znakomtes-reflectionemit">, <code>Reflection.Emit</code></h2><br>
<p> ,      ,  <code>Expression</code>, ..    /     .    ,   .</p><br>
<p>   <strong>IL</strong>-  ,    -  (<code>Debug</code>, <code>X86</code>, <code>netframework4.8</code>)</p><br>
<pre><code class="plaintext hljs">nop<font></font>
ldarg.0<font></font>
ldfld /* - */<font></font>
stloc.0<font></font>
br.s /*  */<font></font>
ldloc.0<font></font>
ret</code></pre><br>
<p>      .<br>
       :</p><br>
<pre><code class="plaintext hljs">ldarg.0<font></font>
ldfld /* - */<font></font>
ret</code></pre><br>
<p>  - â€¦ <code>this</code>.  ,  <strong>IL</strong>  :<br>
1)  <code>this</code><br>
2)   <br>
3) </p><br>
<p>, ?  <code>Reflection.Emit</code>   , ,  -,   - .   ,    ,  <code>spanField</code>.</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> getSpan = type.DefineMethod(<span class="hljs-string">"GetSpan"</span>,<font></font>
                    MethodAttributes.Public<font></font>
                    | MethodAttributes.HideBySig,<font></font>
                    CallingConventions.Standard,<font></font>
                    <span class="hljs-keyword">typeof</span>(Span&lt;T&gt;), Array.Empty&lt;Type&gt;());<font></font>
<font></font>
gen = getSpan.GetILGenerator();<font></font>
gen.Emit(OpCodes.Ldarg_0);<font></font>
gen.Emit(OpCodes.Ldfld, spanField);<font></font>
gen.Emit(OpCodes.Ret);</code></pre><br>
<p>   ,     <code>this</code>,    ,         :</p><br>
<pre><code class="cs hljs">ldarg<span class="hljs-number">.0</span>
ldarg<span class="hljs-number">.1</span>
stfld <span class="hljs-comment">/*   */</span>
ret</code></pre><br>
<p>      <code>Raw</code>,    (  ),      -,     -.</p><br>
<p> -,    - (<code>TIn</code>, <code>TOut</code>)    <code>Type</code>,    ()  ,  ,      ,    -,  </p><br>
<ol>
<li><code>void SetSpan(Span&lt;TIn&gt; span)</code>      </li>
<li><code>Raw GetRaw()</code>      <code>Raw</code>-</li>
<li><code>void SetRaw(Raw raw)</code>    <code>Raw</code>    </li>
<li><code>Span&lt;TOut&gt; GetSpan()</code>           .</li>
</ol><br>
<p>        .           <code>@this</code>. <strong>   . <code>Activator.CreateInstance</code>  <code>object</code>.       ,         <code>ref</code>-like (</strong><code>type.IsByRef</code><s>Like</s> <code>== false</code><strong>),  <code>ref</code>-like   . ,     ,  <code>CLR</code>  . ,         .</strong> <sup>3</sup></p><br>
<p>,    ,             .          .   ,   ( -)   <code>(TIn, TOut) -&gt; Generator&lt;TIn, TOut&gt;</code>.</p><br>
<h2 id="shtrih-posledniy-privodim-tipy-spantin---spantout"> :  , <code>Span&lt;TIn&gt; -&gt; Span&lt;TOut&gt;</code></h2><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Span&lt;TOut&gt; <span class="hljs-title">Cast</span>(<span class="hljs-params">Span&lt;TIn&gt; span</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">if</span> (span.IsEmpty)
        <span class="hljs-keyword">return</span> Span&lt;TOut&gt;.Empty;<font></font>
<font></font>
    <span class="hljs-comment">// Caller   ,      </span>
    <span class="hljs-keyword">if</span> (span.Length * Unsafe.SizeOf&lt;TIn&gt;() % Unsafe.SizeOf&lt;TOut&gt;() != <span class="hljs-number">0</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException();<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-comment">// Span&lt;TIn&gt; _input.Span = span;</span><font></font>
    _spanSetter(span);<font></font>
<font></font>
    <span class="hljs-comment">//  Raw</span>
    <span class="hljs-comment">// Raw raw = _input.Raw;</span>
    <span class="hljs-keyword">var</span> raw = _rawGetter();<font></font>
<font></font>
    <span class="hljs-keyword">var</span> newRaw = <span class="hljs-keyword">new</span> Raw()<font></font>
    {<font></font>
        Pinnable = raw.Pinnable, <span class="hljs-comment">//    Pinnable</span>
        Pointer = raw.Pointer, <span class="hljs-comment">//  </span>
        Length = raw.Length * Unsafe.SizeOf&lt;TIn&gt;() / Unsafe.SizeOf&lt;TOut&gt;() <span class="hljs-comment">//  </span><font></font>
    };<font></font>
<font></font>
    <span class="hljs-comment">//   Raw   </span>
    <span class="hljs-comment">// Raw _output.Raw = newRaw;</span><font></font>
    _rawSetter(newRaw);<font></font>
<font></font>
    <span class="hljs-comment">//    </span>
    <span class="hljs-comment">// Span&lt;TOut&gt; _output.Span</span>
    <span class="hljs-keyword">return</span> _spanGetter();<font></font>
}</code></pre><br>
<h1 id="vyvod"></h1><br>
<p> â€”    â€”         . ,     .  ,          <code>unsafe / fixed</code> ,    .        .</p><br>
<h1 id="dlya-teh-kto-dochital-do-konca"> ,    .</h1><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>    ?<br>
      ,    /     ,       .</p><br>
<ol>
<li><code>Cast_Explicit</code>      ,   <em> 2</em>.           ;</li>
<li><code>Cast_IL</code>  <em> 3</em>,       <code>Generator&lt;TIn, TOut&gt;</code>,       ,        ;</li>
<li><code>Cast_IL_Cached</code>     <code>Generator&lt;TIn, TOut&gt;</code>, -     , ..       ;</li>
<li><code>Buffer</code>   ,       ,     .     .</li>
</ol><br>
<p>   â€”         <code>int[N]</code>   <code>N/2</code>   .</p><br>
<p>  ,        ,    .              ,             .    ,          ,            .  ,  <em></em> <em></em> <em>   </em>     <code>unmanaged</code>   <em>  </em>.</p><br>
<pre><code class="plaintext hljs">BenchmarkDotNet=v0.11.5, OS=Windows 10.0.18362<font></font>
Intel Core i7-2700K CPU 3.50GHz (Sandy Bridge), 1 CPU, 8 logical and 4 physical cores<font></font>
  [Host] : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0<font></font>
  Clr    : .NET Framework 4.7.2 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.8.3815.0<font></font>
<font></font>
Job=Clr  Runtime=Clr  InvocationCount=1  <font></font>
UnrollFactor=1  <font></font>
</code></pre><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>N</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Median</th>
<th>Ratio</th>
<th>RatioSD</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Cast_Explicit</strong></td>
<td><strong>100</strong></td>
<td><strong>362.2 ns</strong></td>
<td><strong>18.0967 ns</strong></td>
<td><strong>52.7888 ns</strong></td>
<td><strong>400.0 ns</strong></td>
<td><strong>1.00</strong></td>
<td><strong>0.00</strong></td>
</tr>
<tr>
<td>Cast_IL</td>
<td>100</td>
<td>1,237.9 ns</td>
<td>28.5954 ns</td>
<td>67.4027 ns</td>
<td>1,200.0 ns</td>
<td>3.47</td>
<td>0.51</td>
</tr>
<tr>
<td>Cast_IL_Cached</td>
<td>100</td>
<td>522.8 ns</td>
<td>25.2640 ns</td>
<td>71.2576 ns</td>
<td>500.0 ns</td>
<td>1.46</td>
<td>0.27</td>
</tr>
<tr>
<td>Buffer</td>
<td>100</td>
<td>300.0 ns</td>
<td>0.0000 ns</td>
<td>0.0000 ns</td>
<td>300.0 ns</td>
<td>0.78</td>
<td>0.11</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Cast_Explicit</strong></td>
<td><strong>1000</strong></td>
<td><strong>2,628.6 ns</strong></td>
<td><strong>54.0688 ns</strong></td>
<td><strong>64.3650 ns</strong></td>
<td><strong>2,600.0 ns</strong></td>
<td><strong>1.00</strong></td>
<td><strong>0.00</strong></td>
</tr>
<tr>
<td>Cast_IL</td>
<td>1000</td>
<td>3,216.7 ns</td>
<td>49.8568 ns</td>
<td>38.9249 ns</td>
<td>3,200.0 ns</td>
<td>1.21</td>
<td>0.03</td>
</tr>
<tr>
<td>Cast_IL_Cached</td>
<td>1000</td>
<td>2,484.6 ns</td>
<td>44.9717 ns</td>
<td>37.5534 ns</td>
<td>2,500.0 ns</td>
<td>0.94</td>
<td>0.02</td>
</tr>
<tr>
<td>Buffer</td>
<td>1000</td>
<td>2,055.6 ns</td>
<td>43.9695 ns</td>
<td>73.4631 ns</td>
<td>2,000.0 ns</td>
<td>0.78</td>
<td>0.03</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Cast_Explicit</strong></td>
<td><strong>1000000</strong></td>
<td><strong>2,515,157.1 ns</strong></td>
<td><strong>11,809.8538 ns</strong></td>
<td><strong>10,469.1278 ns</strong></td>
<td><strong>2,516,050.0 ns</strong></td>
<td><strong>1.00</strong></td>
<td><strong>0.00</strong></td>
</tr>
<tr>
<td>Cast_IL</td>
<td>1000000</td>
<td>2,263,826.7 ns</td>
<td>23,724.4930 ns</td>
<td>22,191.9054 ns</td>
<td>2,262,000.0 ns</td>
<td>0.90</td>
<td>0.01</td>
</tr>
<tr>
<td>Cast_IL_Cached</td>
<td>1000000</td>
<td>2,265,186.7 ns</td>
<td>19,505.5913 ns</td>
<td>18,245.5422 ns</td>
<td>2,266,300.0 ns</td>
<td>0.90</td>
<td>0.01</td>
</tr>
<tr>
<td>Buffer</td>
<td>1000000</td>
<td>1,959,547.8 ns</td>
<td>39,175.7435 ns</td>
<td>49,544.7719 ns</td>
<td>1,959,200.0 ns</td>
<td>0.78</td>
<td>0.02</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Cast_Explicit</strong></td>
<td><strong>100000000</strong></td>
<td><strong>255,751,392.9 ns</strong></td>
<td><strong>2,595,107.7066 ns</strong></td>
<td><strong>2,300,495.3873 ns</strong></td>
<td><strong>255,298,950.0 ns</strong></td>
<td><strong>1.00</strong></td>
<td><strong>0.00</strong></td>
</tr>
<tr>
<td>Cast_IL</td>
<td>100000000</td>
<td>228,709,457.1 ns</td>
<td>527,430.9293 ns</td>
<td>467,553.7809 ns</td>
<td>228,864,100.0 ns</td>
<td>0.89</td>
<td>0.01</td>
</tr>
<tr>
<td>Cast_IL_Cached</td>
<td>100000000</td>
<td>227,966,553.8 ns</td>
<td>355,027.3545 ns</td>
<td>296,463.9203 ns</td>
<td>227,903,600.0 ns</td>
<td>0.89</td>
<td>0.01</td>
</tr>
<tr>
<td>Buffer</td>
<td>100000000</td>
<td>213,216,776.9 ns</td>
<td>1,198,565.1142 ns</td>
<td>1,000,856.1536 ns</td>
<td>213,517,800.0 ns</td>
<td>0.83</td>
<td>0.01</td>
</tr>
</tbody>
</table></div></div></div><br>
<div class="spoiler"><b class="spoiler_title">Acknowledgements</b><div class="spoiler_text"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>JetBrains</strong></a> (      :-))   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>R#</strong></a>    <strong>VS</strong>  standalone- <strong>dotPeek</strong>,     .  <code>BenchmarkDotNet</code>  BenchmarkDotNet, youtube- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>NDC Conferences</strong></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>DotNext</strong></a>    ,  ,         .</p></div></div><br>
<h1 id="ps">P.S.</h1><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p><sup>3</sup>         ,      <code>ref</code>,      ,   . <s></s>   (   )   .    <code>ref</code> structs,        </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">static</span> Raw Generated_Int32.GetRaw(Span&lt;<span class="hljs-keyword">int</span>&gt; span)<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> inst = <span class="hljs-keyword">new</span> Generated_Int32()<font></font>
    {<font></font>
        Span = span<font></font>
    };<font></font>
    <span class="hljs-keyword">return</span> inst.Raw;<font></font>
}</code></pre><br>
<p>    ,     <code>Reflection.Emit</code>.      ,   <em></em>  <code>ILGenerator.DeclareLocal</code>.    </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">static</span> Span&lt;<span class="hljs-keyword">int</span>&gt; Generated_Int32.GetSpan(Raw raw);</code></pre><br>
<p>  </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">delegate</span> Raw GetRaw&lt;T&gt;(Span&lt;T&gt; span) <span class="hljs-keyword">where</span> T : unmanaged;
<span class="hljs-keyword">delegate</span> Span&lt;T&gt; GetSpan&lt;T&gt;(Raw raw) <span class="hljs-keyword">where</span> T : unmanaged;</code></pre><br>
<p>, <em> </em>,       <code>ref</code> â€” . ..     ,     </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> getter = type.GetMethod(<span class="hljs-string">@"GetRaw"</span>, BindingFlags.Static | BindingFlags.Public).CreateDelegate(<span class="hljs-keyword">typeof</span>(GetRaw&lt;T&gt;), <span class="hljs-literal">null</span>) <span class="hljs-keyword">as</span> GetRaw&lt;T&gt;;</code></pre><br>
<p>  â€” </p><br>
<pre><code class="cs hljs">Raw raw = getter(Span&lt;TIn&gt;.Empty);<font></font>
Raw newRaw = convert(raw);<font></font>
Span&lt;TOut&gt; = setter(newRaw);</code></pre></div></div><br>
<p><em>UPD01:   </em></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja465063/index.html">Springãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ä½œæ¥­ã™ã‚‹éš›ã®æœ€ã‚‚ä¸€èˆ¬çš„ãª10ã®é–“é•ã„ã€‚ãƒ‘ãƒ¼ãƒˆ2</a></li>
<li><a href="../ja465069/index.html">Hadoopã®æ–°æ©Ÿèƒ½ï¼šHadoopã®ã•ã¾ã–ã¾ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç†è§£ã™ã‚‹</a></li>
<li><a href="../ja465071/index.html">TechTrain 2019 ITãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ï¼šJUG.ruã€JUGNskã€JUG.MSKãŒå‚åŠ ã—ãŸæ–¹æ³•</a></li>
<li><a href="../ja465073/index.html">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã—ãªã„ã§ãã ã•ã„ã€‚iOSã®å‰²ã‚Šè¾¼ã¿å¯èƒ½ãªé·ç§»</a></li>
<li><a href="../ja465075/index.html">é›»è»Šã®é‹è»¢å°</a></li>
<li><a href="../ja465081/index.html">CLRiumï¼ƒ6ï¼šä¸¦è¡Œæ€§ã¨ä¸¦åˆ—æ€§ã€‚ã‚¿ã‚¹ã‚¯ä¸¦åˆ—åŒ–ã®é­”æ³•ã‚’å­¦ã¶</a></li>
<li><a href="../ja465083/index.html">è­¦æˆ’ãƒ‰ã‚¢ç›£è¦–</a></li>
<li><a href="../ja465085/index.html">ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°å¯¾ç­–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</a></li>
<li><a href="../ja465087/index.html">NASAãŒã‚¹ãƒŒãƒ¼ãƒ”ãƒ¼ã‚’é›‡ã„ã€ãƒãƒ¼ãƒ“ãƒ¼ã®æœã‚’æ‰‹ã«å…¥ã‚ŒãŸæ–¹æ³•</a></li>
<li><a href="../ja465089/index.html">ãƒãƒ£ãƒ³ã‚¹ã¯ã©ã®ã‚ˆã†ã«æ•°å­¦è€…ã‚’åŠ©ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>