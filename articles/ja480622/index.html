<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙅 🕺🏻 🤸 利用可能なストレージ容量を正しく使用する方法 👩‍🎨 🙁 📹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私たちはメール、ストレージ、ソーシャルネットワーク、インスタントメッセンジャーなどのクラウドサービスを長い間使用してきました。それらはすべてリモートで動作します-メッセージとファイルを送信し、それらはリモートサーバーに保存および処理されます。クラウドゲームも機能します。ユーザーはサービスに接続し、ゲ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>利用可能なストレージ容量を正しく使用する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/480622/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはメール、ストレージ、ソーシャルネットワーク、インスタントメッセンジャーなどのクラウドサービスを長い間使用してきました。それらはすべてリモートで動作します-メッセージとファイルを送信し、それらはリモートサーバーに保存および処理されます。クラウドゲームも機能します。ユーザーはサービスに接続し、ゲームを選択して起動します。これは、ゲームがほぼ瞬時に開始され、メモリを消費せず、強力なゲーム用コンピュータを必要としないため、プレーヤーにとって便利です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/k4/oy/ejk4oyjjh1r3riqgzzd239qu_va.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドサービスの場合、すべてが異なります-データストレージの問題があります。各ゲームの重量は数十ギガバイトまたは数百ギガバイトになる可能性があります。たとえば、「The Witcher 3」は50 GB、「Call of Duty：Black Ops III」-113となります。同時に、プレーヤーは2〜3ゲームでサービスを使用せず、少なくとも数十が必要です。 。このサービスでは、数百のゲームを保存するだけでなく、プレーヤーごとに割り当てるストレージの量を決定し、数千のゲームがある場合はスケーリングする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてをサーバーに保存する必要があります。必要な数、データセンターの配置場所、複数のデータセンター間での「データの同期」の方法は？</font><font style="vertical-align: inherit;">「雲」を購入しますか？</font><font style="vertical-align: inherit;">仮想マシンを使用しますか？</font><font style="vertical-align: inherit;">ユーザーデータを5回圧縮して保存し、リアルタイムで提供することは可能ですか？</font><font style="vertical-align: inherit;">同じ仮想マシンを一貫して使用しているときに、ユーザー同士の影響を排除するにはどうすればよいですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてのタスクは、クラウドベースのゲームプラットフォームであるPlaykey.netで問題なく解決されました。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウラジミールリャボフ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グレイマンサーマ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）-システム管理部門の責任者-これに役立ったFreeBSDのZFSテクノロジーと、ZOL（Linux上のZFS）の新しいフォークについて詳しく話します。</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/SssLwMbMrQ4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同社の1000台のサーバーが、モスクワ、ロンドン、フランクフルトのリモートデータセンターに配置されています。</font><font style="vertical-align: inherit;">このサービスには250を超えるゲームがあり、毎月10万人のプレイヤーがプレイしています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s6/mv/nw/s6mvnwi5z_b5ltjl_vico2x7ro4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサービスは次のように機能します。ゲームは会社のサーバーで実行され、ユーザーはキーボード、マウス、またはゲームパッドからコントロールのストリームを受け取り、それに応答してビデオストリームが送信されます。</font><font style="vertical-align: inherit;">これにより、最新のトップエンドゲームを、ハードウェアの弱いコンピューター、ビデオが統合されたラップトップ、またはこれらのゲームがまったくリリースされていないMacでプレイできます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゲームを保存して更新する必要があります</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドゲームサービスの主なデータは、数百GBを超える可能性のあるゲームの配布とユーザーの保存です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが小さかったとき、私たちはわずか12台のサーバーと50ゲームのささやかなカタログを持っていました。すべてのデータをサーバーにローカルに保存し、手動で更新しましたが、すべて問題ありませんでした。しかし、成長の時が</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来ました。AWSクラウドに向け</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て出発し</font><strong><font style="vertical-align: inherit;">ました</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSでは、数百台のサーバーがありましたが、アーキテクチャは変わっていません。それらはサーバーでもありましたが、今では仮想であり、ゲームディストリビューションが置かれるローカルディスクがあります。ただし、100台のサーバーで手動で更新すると失敗します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは解決策を探し始めました。最初に、</font><strong><font style="vertical-align: inherit;">rsyncを</font></strong><font style="vertical-align: inherit;">介して更新を試みました</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、これは非常に遅く、メインノードの負荷が高すぎることがわかりました。</font><font style="vertical-align: inherit;">しかし、これは最悪の事態でさえありません。オンラインが不足しているときは、一部の仮想マシンをオフにして、支払いを行わないようにしました。更新時には、オフになっているサーバーにデータが注がれませんでした。</font><font style="vertical-align: inherit;">それらのすべては更新なしで残されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策は急流、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまりBTSync</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラム</font><font style="vertical-align: inherit;">でした。</font><font style="vertical-align: inherit;">中央ノードを明示的に指定しなくても、多数のノード上のフォルダーを同期できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成長の問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくの間、これはすべてうまくいきました。しかし、サービスは発展しており、より多くのゲームとサーバーがありました。ローカルストレージの数も増え、どんどん支払わなければならなくなりました。クラウドでは、特にSSDの場合は高価です。ある時点で、同期を開始するためのフォルダーの通常のインデックス作成でさえ、1時間以上かかり始め、すべてのサーバーが数日間更新される可能性がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BTSyncは、過剰なネットワークトラフィックで別の問題を引き起こしました。当時、Amazonでは、内部仮想間でも支払われていました。クラシックゲームランチャーが大きなファイルに小さな変更を加えると、BTSyncはすぐにファイル全体が変更されたことを認識し、すべてのノードに完全に転送し始めます。その結果、15 MBのアップグレードでも数十GBの同期トラフィックが生成される可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ストレージが1 TBに増加すると、状況は深刻になります。</font><font style="vertical-align: inherit;">新しいゲームWorld of Warshipsをリリースしました。</font><font style="vertical-align: inherit;">彼女のディストリビューションには数十万の小さなファイルがありました。</font><font style="vertical-align: inherit;">BTSyncはそれをダイジェストして他のすべてのサーバーに配布できませんでした-これは他のゲームの配布を遅くしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべての要因により、2つの問題が発生しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルストレージの作成は、高価で不便であり、更新が困難です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">雲は非常に高価でした。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
物理サーバーの概念に戻ることにしました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独自のストレージシステム</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
物理サーバーに移る前に、ローカルストレージを削除する必要があります。これには、独自の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレージシステム（ストレージ）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><font style="vertical-align: inherit;">です。これは、すべてのディストリビューションを保存し、すべてのサーバーに集中的に配布するシステムです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクは単純なようです-それはすでに繰り返し解決されています。しかし、ゲームにはニュアンスがあります。たとえば、ほとんどのゲームは、読み取り専用アクセス権が付与されている場合、単に動作を拒否します。通常の通常の起動でも、ファイルに何かを書き込むのが好きで、それがないと作業を拒否します。逆に、多数のユーザーが1セットのディストリビューションへのアクセス権を与えられると、競争力のあるアクセスでお互いのファイルを打ち負かし始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは問題を考え、いくつかの解決策をチェックして、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFS-FreeBSD上のZettabyteファイルシステム</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeBSD上のZFS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは通常のファイルシステムではありません。</font><font style="vertical-align: inherit;">従来のシステムは最初に1つのデバイスにインストールされ、複数のディスクを操作するにはすでにボリュームマネージャが必要です。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFSはもともと仮想プールに基づいて構築されていました。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zpool</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">呼ば</font><font style="vertical-align: inherit;">れ、ディスクグループまたはRAIDアレイで構成されます。</font><font style="vertical-align: inherit;">これらのディスクのボリューム全体は、zpool内のすべてのファイルシステムで使用できます。</font><font style="vertical-align: inherit;">これは、ZFSがもともと大量のデータを処理するシステムとして開発されたためです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFSが問題の解決にどのように役立つか</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このシステムには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショットとクローンを作成するための</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素晴らしい</font><strong><font style="vertical-align: inherit;">メカニズムがあり</font></strong><font style="vertical-align: inherit;">ます。それらは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即座</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">作成され</font><font style="vertical-align: inherit;">、重量はわずか数KBです。クローンの1つに変更を加えると、これらの変更の量だけ増加します。同時に、残りのクローンのデータは変更されず、一意のままです。これにより</font><font style="vertical-align: inherit;">、エンドユーザーに排他的にアクセスできる</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 TBの</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスクを配布し</font><font style="vertical-align: inherit;">、数KBを費やす</font><font style="vertical-align: inherit;">ことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームセッションに変更を加える過程でクローンが成長した場合、それらはすべてのゲームほど多くのスペースを占有しませんか？</font><font style="vertical-align: inherit;">いいえ、かなり長いゲームセッションでも、変更のセットが100〜200 MBを超えることはめったにありません。これは重要ではありません。</font><font style="vertical-align: inherit;">そのため、本格的な大容量ハードドライブへのフルアクセスを数百人のユーザーに同時に与えることができ、尾を付けて10 TBしか使いません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFSのしくみ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明は複雑に見えますが、ZFSは非常に単純に機能します。</font></font><code>zpool data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用可能なディスクから</font><font style="vertical-align: inherit;">作成するという簡単な例で、その作業を分析してみましょう</font></font><code>zpool create data /dev/da /dev/db /dev/dc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意。これは本番環境では必要ありません。1つのディスクが停止しても、プール全体がそれに追随するためです。 RAIDグループを使用することをお勧めします。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルシステムを作成し</font></font><code>zfs create data/games</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、その中</font></font><code>data/games/disk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に10 TB </font><font style="vertical-align: inherit;">という名前のブロックデバイス</font><font style="vertical-align: inherit;">を作成します</font><font style="vertical-align: inherit;">。デバイスは</font></font><code>/dev/zvol/data/games/disk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、通常のディスクと同じ</font><font style="vertical-align: inherit;">アドレスでアクセスできます。デバイスで</font><font style="vertical-align: inherit;">同じ操作を実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、楽しみが始まります。このディスクを</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSCSI経由で</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新ウィザード（Windowsを実行している通常の仮想マシン）に提供します。ディスクを接続して、通常の家庭用コンピューターのように、Steamからゲームを置くだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスクをゲームで満たします。</font><font style="vertical-align: inherit;">現在、このデータを</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200人のサーバー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に配布</font><font style="vertical-align: inherit;">してエンドユーザーに提供しています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このディスクのスナップショットを作成し、最初のバージョンと呼びます- </font></font><code>zfs snapshot data/games/disk@ver1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初の仮想マシンに移動</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する彼のクローンを作成します</font></font></strong> <code>zfs clone data/games/disk@ver1 data/games/disk-vm1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSCSIを介してクローンを提供し、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVMはこのディスクを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><strong><font style="vertical-align: inherit;">して</font></strong><font style="vertical-align: inherit;">仮想マシン</font><strong><font style="vertical-align: inherit;">を起動し</font></strong><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それはロードされ、ユーザーがアクセスできるサーバーのプールに入り、プレイヤーを期待します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーセッションが完了すると、この仮想マシンからすべてのユーザーの保存が取得さ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、別のサーバーに配置されます</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">仮想</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自体</font><strong><font style="vertical-align: inherit;">がオフになり、クローンが破棄されます</font></strong><font style="vertical-align: inherit;"> - </font></font><code>zfs destroy data/games/disk-vm1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のステップに戻り、もう一度クローンを作成して仮想マシンを起動します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより</font><font style="vertical-align: inherit;">、前のプレーヤーからの変更がない</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常にクリーンなマシン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を次の各ユーザーに提供できます</font><font style="vertical-align: inherit;">。各ユーザーセッションの後にディスクが削除され、ストレージ上で占有していたスペースが解放されます。また、システムディスクとすべての仮想マシンで同様の操作を実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、YouTubeでビデオを見つけました。ゲームセッション中に満足したユーザーがサーバー上のハードドライブをフォーマットし、すべてを壊してしまったことをとても嬉しく思いました。はい、お願いします、支払うだけです-彼は遊ぶことができます。いずれにせよ、前の仮想マシンが何をしていても、次のユーザーは常にクリーンで機能的な仮想マシンを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスキームによれば、ゲームは200台のサーバーにのみ配信されます。</font><font style="vertical-align: inherit;">実験的に200を計算しました。これは、ストレージドライブに重大な負荷が発生しないサーバーの数です。</font><font style="vertical-align: inherit;">これは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゲームにはかなり固有の負荷プロファイル</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があるため</font><strong><font style="vertical-align: inherit;">です</font></strong><font style="vertical-align: inherit;">。つまり、ゲームは起動段階またはレベル読み込み段階で多く読み取り、逆に、ゲーム中は実際にはディスクを使用しません。</font><font style="vertical-align: inherit;">負荷プロファイルが異なる場合、図は異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のスキームでは、200人のユーザーに同時にサービスを提供するには、2,000 TBのローカルストレージが必要でした。</font><font style="vertical-align: inherit;">これで、メインデータセットに10 TBを少し費やすことができ、ユーザーの変更用に0.5 TBの在庫が残っています。</font><font style="vertical-align: inherit;">ZFSは、プール内に少なくとも15％の空き容量があると気に入っていますが、かなり節約できたようです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のデータセンターがある場合はどうなりますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメカニズムは、ストレージシステムを備えたサーバーが少なくとも10ギガビットインターフェースで接続されている1つのデータセンター内でのみ機能します。</font><font style="vertical-align: inherit;">複数のDCがある場合はどうしますか？</font><font style="vertical-align: inherit;">それらの間のゲーム（データセット）でメインディスクを更新する方法は？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このため、ZFSには独自のソリューション（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">送信/受信メカニズム）があり</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">実行コマンドは非常に簡単です：</font></font><br>
<pre><code class="bash hljs">zfs send -v data/games/disk@ver1 | ssh myzfsuser@myserverip zfs receive data/games/disk</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメカニズムにより、メインシステムから1つのストレージシステムから別のストレージシステムにスナップショットを転送できます。</font><font style="vertical-align: inherit;">初めて、マスターノードに書き込まれた10テラバイトのデータすべてを空のストレージシステムに送信する必要があります。</font><font style="vertical-align: inherit;">ただし、次の更新では、前回のスナップショットが作成されてからの変更のみが送信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、以下が得られます。</font></font><br>
<br>
<ul>
<li><strong>      </strong>.       -   ,       .</li>
<li><strong> Send/Receive    </strong>.         ,      slave-.      ,      .</li>
<li><strong>     master-</strong>       ,        .</li>
</ul><br>
<h3>  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZFSには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重複排除という</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もう1つの便利な機能があり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">この機能は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2つの同一のデータブロックを格納しないように</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するのに役立ち</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">代わりに、最初のブロックのみが保存され、2番目のブロックの代わりに、最初のブロックへのリンクが保存されます。</font><font style="vertical-align: inherit;">2つの同一のファイルは1つのスペースとして占有され、それらが90％一致する場合、元のボリュームの110％を占めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能は、ユーザーの保存を保存するのに非常に役立ちました。</font><font style="vertical-align: inherit;">1つのゲームで、さまざまなユーザーが同じように保存し、多くのファイルが同じです。</font><font style="vertical-align: inherit;">重複排除を使用すると、5倍のデータを保存できます。</font><font style="vertical-align: inherit;">私たちの重複排除係数は5.22です。</font><font style="vertical-align: inherit;">物理的には、4.43 TBがあり、これに係数を掛けると、ほぼ23 TBの実データが得られます。</font><font style="vertical-align: inherit;">これにより、ストレージの重複を避けることでスペースを節約できます。</font></font><br>
<div class="scrollable-table"><table>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイズ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALLOC</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自由</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重複排除</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.16 TB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.43 TB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.73 TB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.22x</font></font></td>
</tr>
</tbody>
</table></div><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショットはバックアップに適してい</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">私たちはこのテクノロジーをファイルストレージに使用しています。</font><font style="vertical-align: inherit;">たとえば、1か月間毎日1つの画像を保存すると、その月の任意の日にいつでもクローンを展開して、失われたファイルや破損したファイルを取り出すことができます。</font><font style="vertical-align: inherit;">これにより、ストレージ全体をロールバックしたり、ストレージの完全なコピーを展開したりする必要がなくなります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは開発者を助けるためにクローンを使用しています</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、彼らは戦闘基地で潜在的に危険な移動を体験したいと考えています。</font><font style="vertical-align: inherit;">1 TBに近いベースのクラシックバックアップを導入するのは速くありません。</font><font style="vertical-align: inherit;">したがって、ベースディスクからクローンを削除して、新しいインスタンスに即座に追加するだけです。</font><font style="vertical-align: inherit;">これで、開発者はそこですべてを安全にテストできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFS API</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これらはすべて自動化する必要があります。</font><font style="vertical-align: inherit;">サーバーに登り、手を使って作業し、スクリプトを作成するのは、これをプログラマーに与えることができるのであれば、どうしてでしょうか。</font><font style="vertical-align: inherit;">そのため、シンプルな</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web APIを作成しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての標準ZFS関数をその中にラップし、潜在的に危険でストレージシステム全体を破壊する可能性のある関数へのアクセスを遮断し、すべてをプログラマーに渡しました。</font><font style="vertical-align: inherit;">現在、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのディスク操作は厳密に集中化</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">されており、コードによって実行されます</font><font style="vertical-align: inherit;">。また</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、各ディスクのステータス</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">常に把握しています</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">すべてがうまくいきます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZoL-Linux上のZFS&nbsp;</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムを一元化して考えたのですが、それでいいのでしょうか？</font><font style="vertical-align: inherit;">確かに、今では拡張のために、すぐにいくつかのサーバーラックを購入する必要があります。それらはストレージシステムに関連付けられており、システムを分割するのは不合理です。</font><font style="vertical-align: inherit;">他の国のパートナーにテクノロジーを紹介するために小さなデモスタンドを配置することにした場合はどうすればよいですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考えてみると、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルドライブ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">使用する</font></strong><font style="vertical-align: inherit;">という古い考え方に</font><strong><font style="vertical-align: inherit;">到達しましたが</font></strong><font style="vertical-align: inherit;">、受け取ったすべての経験と知識だけが必要でした。</font><font style="vertical-align: inherit;">アイデアをグローバルに拡大する場合、ユーザーに私たちのサーバーを使用するだけでなく、コンピューターをレンタルする機会を与えてはどうですか？</font><strong><font style="vertical-align: inherit;">Linux-ZoL</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
での</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZFS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の比較的最近の分岐は、この点で私たちに大いに役立ちました</font><font style="vertical-align: inherit;">。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在、各サーバーには独自のストレージがあります。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集中インストールの場合のように、それだけが10テラバイトのデータを格納するのではなく、それが提供するゲームの1〜2配布のみを格納します。</font><font style="vertical-align: inherit;">SSDはこれで十分です。</font><font style="vertical-align: inherit;">これはすべて正常に機能します。次の各ユーザーは常に、クリーンインストールされた仮想マシンと、戦闘インストールを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ここで2つの問題が発生しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新するには？</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データセンターで行うのと同じように、SSH経由で一元的に更新します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ストレージシステムとは異なり、ユーザーはローカルネットワークに接続することも、単にオフにすることもでき、それほど多くのSSH接続を確立する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rsyncを使用する場合と同じ問題が発生しました。ただし、ZFS上のtorrentは取得できなくなりました。送信メカニズムのしくみについて慎重に検討しました。変更されたすべてのデータブロックを最終的なストレージに送信し、Receiveがそれらを現在のデータセットに適用します。データをエンドユーザーに送信するのではなく、ファイルに書き込んでみませんか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は、</font><strong><font style="vertical-align: inherit;">diff</font></strong><font style="vertical-align: inherit;">と呼ばれるものです</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、最後の2つのスナップショット間で変更されたすべてのブロックが順次書き込まれるファイルです。</font><font style="vertical-align: inherit;">この差分をCDNに置き、HTTP経由ですべてのユーザーに送信します。マシンの電源を入れ、更新があったことを確認し、それをデフレートし、Receiveを使用してローカルデータセットに適用しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライバーをどうするか</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
集中型サーバーの構成は同じで、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドユーザーは常に異なるコンピューターとビデオカードを使用してい</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">可能な限りすべてのドライバーでOSディストリビューションを満たしたとしても、最初に起動したときは、これらのドライバーをインストールする必要があり、その後再起動し、場合によってはもう一度再起動します。</font><font style="vertical-align: inherit;">クリーンなクローンを提供するたびに、このカルーセル全体が各ユーザーセッションの後に発生します-これは悪いことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windowsが起動し、すべてのドライバーがインストールされ、彼女がやりたいことをすべて実行してから、このドライブでのみ操作するまで、初期化を実行したいと考えました。</font><font style="vertical-align: inherit;">ただし、問題は、ソースとレシーバーのデータが異なり、diffが適用されないため、メインデータセットに変更を加えると、更新が壊れることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ZFSは柔軟なシステムであり、小さな松葉杖を作ることができました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常どおり、スナップショットを作成します</font></font><code>zfs snapshot data/games/os@init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クローンを作成</font></font><code>zfs clone data/games/os@init data/games/os-init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、初期化モードで起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのドライバがインストールされるのを待っており、すべてが再起動します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮想マシンをオフにして、もう一度スナップショットを作成します。</font><font style="vertical-align: inherit;">しかし、今回は元のデータセットからではなく、初期化クローンを使用しました</font></font><code>zfs snapshot data/games/os-init@ver1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのインストール済みドライバーを含むスナップショットのクローンを作成します。</font><font style="vertical-align: inherit;">彼はもはや再起動しません：</font></font><code>zfs clone data/games/os-init@ver1 data/games/os-vm1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、クラシックな束に取り組みます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、このシステムはアルファテスト段階にあります。</font><font style="vertical-align: inherit;">Linuxの知識がなくても実際のユーザーでテストしましたが、すべて自宅で展開できました。</font><font style="vertical-align: inherit;">私たちの最終的な目標は、起動可能なUSBフラッシュドライブをコンピューターに接続し、追加のSSDドライブを接続して、クラウドプラットフォームでレンタルすることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZFS機能のごく一部についてのみ説明しました。</font><font style="vertical-align: inherit;">このシステムは、はるかに興味深いさまざまなことを実行できますが、ZFSについて知っている人はほとんどいません。ユーザーはそれについて話そうとはしません。</font><font style="vertical-align: inherit;">この記事の後に、ZFSコミュニティに新しいユーザーが登場することを願っています。</font></font><br>
<br>
<blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">DevOpsConf</a>.          , ,    DevOps-   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Saint HighLoad++</a>. </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja480610/index.html">C ++ vtables。パート2（仮想継承+コンパイラー生成コード）</a></li>
<li><a href="../ja480612/index.html">Webデザインのアクセシビリティ基準を満たすようにこれらの変更を行ってください。</a></li>
<li><a href="../ja480614/index.html">高速ENUM</a></li>
<li><a href="../ja480618/index.html">電子ゲームTic Tac Toe。私は何に来ましたか</a></li>
<li><a href="../ja480620/index.html">管理者を支援するSD-WANとDNA：アーキテクチャの特徴と実践</a></li>
<li><a href="../ja480626/index.html">レガシーシステムとプロセスの継承またはCTOの役割における最初の90日間</a></li>
<li><a href="../ja480628/index.html">最初の15万件の本番インシデントを処理したときに、SREについて何を学びましたか</a></li>
<li><a href="../ja480630/index.html">コンテナは安全ですか？</a></li>
<li><a href="../ja480632/index.html">セキュリティ部門なしでどのように（あなたが）生活しているか</a></li>
<li><a href="../ja480642/index.html">Linux ELFの概要：理解と分析</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>