<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏰 🙇 📏 NATプロバイダーを介したコンピューター間の直接VPNトンネル（VPSなし、STUNサーバーとYandex.Diskを使用） 🚬 ✋🏽 ⛹🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="プロバイダーのNATの背後にある2台のコンピューター間で直接VPNトンネルを構成する方法についての記事の続き。前回の記事では、サードパーティを使用して接続を整理するプロセスについて説明しました-仲介者（レンタルされたVPSは、STUNサーバーのような役割を果たし、接続用のノードデータの送信者です）。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>NATプロバイダーを介したコンピューター間の直接VPNトンネル（VPSなし、STUNサーバーとYandex.Diskを使用）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481034/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダーのNATの背後にある2台のコンピューター間で直接VPNトンネルを構成する方法について</font><font style="vertical-align: inherit;">の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の続き</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">前回の記事では、サードパーティを使用して接続を整理するプロセスについて説明しました-仲介者（レンタルされたVPSは、STUNサーバーのような役割を果たし、接続用のノードデータの送信者です）。</font><font style="vertical-align: inherit;">この記事では、VPSを使用しない方法を説明しますが、仲介者は残り、それらはSTUNサーバーとYandex.Diskでした...</font></font><br>
<img src="https://habrastorage.org/webt/ud/sj/3t/udsj3te1itgjnnv-bsk99369pre.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の投稿のコメントを読んだ後、実装の主な欠点は中間ノード（ノードの現在のパラメーター、接続先、接続方法を示すサードパーティ（VPS））の使用にあることがわかりました。</font><font style="vertical-align: inherit;">現在の接続パラメータを決定するために、</font><font style="vertical-align: inherit;">このSTUNを使用することを推奨します（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらの多くが存在します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">まず、STUNサーバーがクライアントと連携していて、完全に読み取り不可能なコンテンツを受け取っているときに、TCPDumpを使用してパケットの内容を確認することにしました。</font><font style="vertical-align: inherit;">プロトコルをグーグルする</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことは、プロトコルを説明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">記事に</font></a><font style="vertical-align: inherit;">出くわしました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は自分でSTUNサーバーへのリクエストを実装できないことに気付き、そのアイデアを「ファーボックス」に入れることができました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、パッケージからSTUNサーバーをDebianにインストールする必要がありました </font></font><pre><code class="bash hljs"><span class="hljs-comment"># apt install stun-server</span></code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存関係でstun-clientパッケージを見ましたが、どういうわけかこれを重要視していませんでした。</font><font style="vertical-align: inherit;">しかし、後で、スタンクライアントパッケージについて思い出し、受け取ったグーグルとPojandeksivによって、それがどのように機能するかを理解することにしました。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># apt install stun-client</span>
<span class="hljs-comment"># stun stun.ekiga.net -p 21234 -v</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それに応えて、私は受け取りました：</font></font><br>
<br>
<blockquote>STUN client version 0.97<br>
Opened port 21234 with fd 3<br>
Opened port 21235 with fd 4<br>
Encoding stun message: <br>
Encoding ChangeRequest: 0<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Received stun message: 92 bytes<br>
MappedAddress = &lt; IP&gt;:2885<br>
SourceAddress = 216.93.246.18:3478<br>
ChangedAddress = 216.93.246.17:3479<br>
Unknown attribute: 32800<br>
ServerName = Vovida.org 0.98-CPC<br>
Received message of type 257 id=1<br>
Encoding stun message: <br>
Encoding ChangeRequest: 0<br>
<br>
About to send msg of len 28 to 216.93.246.17:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 0<br>
<br>
About to send msg of len 28 to &lt; IP&gt;:2885<br>
Received stun message: 28 bytes<br>
ChangeRequest = 0<br>
Received message of type 1 id=11<br>
Encoding stun message: <br>
Encoding ChangeRequest: 0<br>
<br>
About to send msg of len 28 to 216.93.246.17:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Received stun message: 92 bytes<br>
MappedAddress = &lt; IP&gt;:2885<br>
SourceAddress = 216.93.246.17:3479<br>
ChangedAddress = 216.93.246.18:3478<br>
Unknown attribute: 32800<br>
ServerName = Vovida.org 0.98-CPC<br>
Received message of type 257 id=10<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 4<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br>
Encoding stun message: <br>
Encoding ChangeRequest: 2<br>
<br>
About to send msg of len 28 to 216.93.246.18:3478<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STUNメッセージは、符号化：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
符号化ChangeRequest：4 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
216.93.246.18:3478にlenの28のMSGを送信するために、約</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：STUNメッセージエンコード</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンコードChangeRequest：2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ためにlenを216.93.246.18:3478 28の送信MSG〜約</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストをI 1つの= </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
試験II = 0を</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストIII = 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストI（2）= 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はnat = 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マッピングされたIPは同じ= 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヘアピン= 1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
保護ポート= 0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プライマリ：独立マッピング、ポート依存フィルター、ランダムポート、ヘアピンになる</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
戻り値は0x000006</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
値を持つ文字列 </font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MappedAddress = &lt;My IP&gt;：2885</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なものだけ！</font><font style="vertical-align: inherit;">ローカルUDPポート21234での接続の現在のステータスが表示されました。しかし、これは戦いの半分にすぎません。このデータをリモートホストに転送してVPN接続を確立する方法についての質問が生じました。</font><font style="vertical-align: inherit;">メールプロトコルを使用して、おそらくテレグラム？！</font><font style="vertical-align: inherit;">多くのオプションがあり、Yandex.Diskを使用することに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">それは、Yandex.DiskでWebDavを介してCurlがどのように機能するかについての記事を見つけたから</font></a><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">実装について考えた後、私はこのスキームに行きました：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.diskにタイムスタンプが付いた特定のファイルが存在することにより、ノードが接続を確立する準備ができていることを通知します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノードの準備ができている場合は、STUNサーバーから現在のパラメーターを受け取ります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在のパラメーターをYandex.Diskにアップロードします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可用性を確認し、Yandex.Disk上のファイルからリモートサイトのパラメーターを読み取ります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPNを使用してリモートホストへの接続を確立します。</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">練習</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し考えて、前回の記事の経験を考慮して、簡単なスクリプトを書きました。</font><font style="vertical-align: inherit;">次のものが必要です。</font></font><pre><code class="bash hljs"><span class="hljs-comment"># apt install openvpn stun-client curl </span></code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際にはスクリプト自体：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期オプション</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"># cat vpn8.sh</span></code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">########################    ###</span>
WARN=<span class="hljs-string">'\033[37;1;41m'</span>				<span class="hljs-comment">#</span>
END=<span class="hljs-string">'\033[0m'</span>					<span class="hljs-comment">#</span>
RED=<span class="hljs-string">'\033[0;31m'</span>         <span class="hljs-comment">#  ${RED}		#</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>      <span class="hljs-comment">#  ${GREEN}		#</span>
<span class="hljs-comment">#################################################</span>
<span class="hljs-comment">#######################     #########################################################</span>
al=<span class="hljs-string">"echo readlink dirname grep awk md5sum shuf nc curl sleep openvpn cat stun"</span><font></font>
ch=0<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$al</span>; <span class="hljs-keyword">do</span> <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   <span class="hljs-variable">$i</span> <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || ch=1; <span class="hljs-keyword">done</span>
<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$ch</span> &gt; 0 )); <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>,      <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
<span class="hljs-comment">#######################################################################################################################</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-string">''</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   (  ,      !) <span class="hljs-variable">${END}</span> \t
<span class="hljs-variable">${GREEN}</span>           /etc/rc.local  nohup /&lt;  &gt;/vpn8.sh  &gt; /var/log/vpn8.log 2&gt;/dev/hull &amp; <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
ABSOLUTE_FILENAME=`readlink -f <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>`                                                    <span class="hljs-comment">#    </span>
DIR=`dirname <span class="hljs-string">"<span class="hljs-variable">$ABSOLUTE_FILENAME</span>"</span>`                                                      <span class="hljs-comment">#     </span>
<span class="hljs-comment">###############################     ##################################</span>
key=<span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.key"</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> ]; <span class="hljs-keyword">then</span>
				<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>  VPN-  ,    : \
openvpn --genkey --secret secret.key :       \
    !!!<span class="hljs-variable">${END}</span>
 # ls -l secret.key
 -rw------- 1 root root 637  27 11:12 secret.key
 # chmod 600 secret.key"</span>;
				<span class="hljs-built_in">exit</span>;
				<span class="hljs-keyword">fi</span>
<span class="hljs-comment">########################################################################################################################</span><font></font>
<font></font>
ABSOLUTE_FILENAME=`readlink -f <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>`                                                    <span class="hljs-comment">#    </span>
DIR=`dirname <span class="hljs-string">"<span class="hljs-variable">$ABSOLUTE_FILENAME</span>"</span>`                                                      <span class="hljs-comment">#     </span>
name=$(uname -n | md5sum | awk <span class="hljs-string">'{print $1}'</span>)<font></font>
vpn=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span> | md5sum | awk <span class="hljs-string">'{print $1}'</span>)<font></font>
stun=<span class="hljs-string">"stun.ekiga.net"</span> 	<span class="hljs-comment"># STUN </span>
username=<span class="hljs-string">"Yandex"</span>	<span class="hljs-comment">#   .	</span>
password=<span class="hljs-string">"Password"</span>	<span class="hljs-comment">#   .</span>
localport=`shuf -i 20000-65000 -n 1`	<span class="hljs-comment">#   </span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ."</span>
curl -X MKCOL --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     "</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/\n/g'</span> | grep <span class="hljs-string">"d:displayname"</span> | sed <span class="hljs-string">'s/d:displayname//g'</span> | sed <span class="hljs-string">'s/&gt;//g'</span> | sed <span class="hljs-string">'s/&lt;//'</span> | sed <span class="hljs-string">'s/\///g'</span> | grep -v $(date +%Y-%m-%d-%H-%M)`; <span class="hljs-keyword">do</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> Delete: <span class="hljs-variable">$i</span>"</span>
	curl -X DELETE --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$i</span>
	<span class="hljs-keyword">done</span><font></font>
<font></font>
until [ <span class="hljs-variable">$c</span> ];<span class="hljs-keyword">do</span><font></font>
<font></font>
	until [[ <span class="hljs-variable">$b</span> ]]; <span class="hljs-keyword">do</span>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  "</span><font></font>
		date=`date +%Y-%m-%d-%H-%M`<font></font>
		mydata=`curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/&gt;\n&lt;/g'</span> | grep <span class="hljs-variable">$name</span> | grep <span class="hljs-variable">$date</span> | grep <span class="hljs-string">"d:displayname"</span>`
		<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$mydata</span> ]]; 	<span class="hljs-keyword">then</span>
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>   "</span>
					        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> &gt; <span class="hljs-string">"/tmp/<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>-ready.txt"</span>
					        curl -T <span class="hljs-string">"/tmp/<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>-ready.txt"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>-ready.txt
					<span class="hljs-keyword">else</span>
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     - <span class="hljs-variable">$date</span>"</span>
					<span class="hljs-keyword">fi</span>
		remote=`curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/&gt;\n&lt;/g'</span> | grep -v <span class="hljs-variable">$name</span> | grep <span class="hljs-variable">$date</span> | grep <span class="hljs-string">"d:displayname"</span>`
		<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$remote</span> ]];	<span class="hljs-keyword">then</span>
						<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>     <span class="hljs-variable">${END}</span>"</span>
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> "</span><font></font>
						sleep 20<font></font>
					<span class="hljs-keyword">else</span>
						<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>    <span class="hljs-variable">${END}</span>"</span><font></font>
						b=1<font></font>
						a=<span class="hljs-string">''</span>
					<span class="hljs-keyword">fi</span>
	<span class="hljs-keyword">done</span><font></font>
<font></font>
	until [ <span class="hljs-variable">$a</span> ]; <span class="hljs-keyword">do</span>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>      STUN : <span class="hljs-variable">$stun</span>"</span>
                mydata=`stun <span class="hljs-variable">$stun</span> -p <span class="hljs-variable">$localport</span> -v 2&gt;&amp;1 | grep MappedAddress | sort | uniq`
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  : <span class="hljs-variable">$mydata</span><span class="hljs-variable">${END}</span>"</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$mydata</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ."</span>
                curl -T <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$name</span>.txt
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     "</span>
		filename=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/\n/g'</span> | grep <span class="hljs-string">"d:displayname&gt;"</span> | grep <span class="hljs-string">"txt"</span> | grep -v <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> | grep -v <span class="hljs-string">"ready"</span> | sed <span class="hljs-string">'s|.*d:displayname&gt;||'</span> | sed <span class="hljs-string">'s/&lt;/ /g'</span> | awk <span class="hljs-string">'{print $1}'</span>)
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     : <span class="hljs-variable">$filename</span>"</span>
		address=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$filename</span> | sort | uniq | head -n1 | sed <span class="hljs-string">'s/:/ /g'</span>)
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  IP-  "</span>
		ip=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$address</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>)<font></font>
		port=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$address</span>"</span> | awk <span class="hljs-string">'{print $4}'</span>)
		<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> ]]; <span class="hljs-keyword">then</span>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  <span class="hljs-variable">$ip</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">${END}</span>"</span>
       		 	openvpn --remote <span class="hljs-variable">$ip</span> --rport <span class="hljs-variable">$port</span> --lport <span class="hljs-variable">$localport</span> \<font></font>
	       	 	    --proto udp --dev tap --<span class="hljs-built_in">float</span> --auth-nocache --verb 3 --mute 20 \<font></font>
	       	 	    --ifconfig 10.45.54.2 255.255.255.252 \<font></font>
	       		    --secret <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.key"</span> \<font></font>
	       		    --auth SHA256 --cipher AES-256-CBC \<font></font>
	        	    --ncp-disable --ping 10  --ping-exit 30 \<font></font>
	        	    --comp-lzo yes<font></font>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${WARN}</span>  <span class="hljs-variable">${END}</span>"</span><font></font>
			a=1<font></font>
			b=<span class="hljs-string">''</span>
			<span class="hljs-keyword">else</span><font></font>
			a=1<font></font>
			b=<span class="hljs-string">''</span>
			<span class="hljs-keyword">fi</span>
	<span class="hljs-keyword">done</span>
<span class="hljs-keyword">done</span></code></pre><br>
   :<br>
<ol>
<li>      , :<br>
 <pre><code class="bash hljs"><span class="hljs-comment"># nano vpn8.sh </span></code></pre></li>
<li>     ..</li>
<li>  "--ifconfig 10.45.54.(1  2) 255.255.255.252"   IP- </li>
<li>c <b>secret.key</b> :<br>
 <pre><code class="bash hljs"><span class="hljs-comment"># openvpn --genkey --secret secret.key </span></code></pre></li>
<li>  :<br>
 <pre><code class="bash hljs"><span class="hljs-comment"># chmod +x vpn8.sh</span></code></pre></li>
<li> :<br>
 <pre><code class="bash hljs"><span class="hljs-comment"># ./vpn8.sh nZbVGBuX5dtturD</span></code></pre><br>
  nZbVGBuX5dtturD — ID-  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a></li>
</ol><br>
          secret.key  ID-,    .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新されたバージョン（正しい操作のためには、時刻を同期する必要があります）：</font></font><br>
<br>
<pre><code class="bash hljs">cat vpn10.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
stuns=<span class="hljs-string">"stun.sipnet.ru stun.ekiga.net"</span>   		<span class="hljs-comment">#  STUN   </span>
username=<span class="hljs-string">" Login "</span>		<span class="hljs-comment">#   .</span>
password=<span class="hljs-string">" Password "</span>   	<span class="hljs-comment">#   .</span>
intip=<span class="hljs-string">"10.23.22.1"</span>		<span class="hljs-comment"># IP-  </span><font></font>
<font></font>
WARN=<span class="hljs-string">'\033[37;1;41m'</span>
END=<span class="hljs-string">'\033[0m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
al=<span class="hljs-string">"ip echo readlink dirname grep awk md5sum openssl sha256sum shuf curl sleep openvpn cat stun"</span><font></font>
ch=0<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$al</span>; <span class="hljs-keyword">do</span> <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   <span class="hljs-variable">$i</span> <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || ch=1; <span class="hljs-keyword">done</span>
<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$ch</span> &gt; 0 )); <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>,      <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-string">''</span> ]];
	<span class="hljs-keyword">then</span>
		<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   (  ,      !) <span class="hljs-variable">${END}</span> \t
		<span class="hljs-variable">${GREEN}</span>           /etc/rc.local  nohup /&lt;  &gt;/vpn10.sh  &gt; /var/log/vpn10.log 2&gt;/dev/hull &amp; <span class="hljs-variable">${END}</span>"</span>
		<span class="hljs-built_in">exit</span>
<span class="hljs-keyword">fi</span>
ABSOLUTE_FILENAME=`readlink -f <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>`                                                    <span class="hljs-comment">#    </span>
DIR=`dirname <span class="hljs-string">"<span class="hljs-variable">$ABSOLUTE_FILENAME</span>"</span>`                                                      <span class="hljs-comment">#     </span>
key=<span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.key"</span>
until [[ -n <span class="hljs-string">"<span class="hljs-variable">$iftosrv</span>"</span> ]]
	<span class="hljs-keyword">do</span>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>   "</span>; iftosrv=`ip route get 8.8.8.8 | head -n 1 | sed <span class="hljs-string">'s|.*dev ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
		sleep 5<font></font>
<span class="hljs-keyword">done</span><font></font>
timedatectl<font></font>
name=$(uname -n | md5sum | awk <span class="hljs-string">'{print $1}'</span>)<font></font>
vpn=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span> | md5sum | awk <span class="hljs-string">'{print $1}'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ."</span>
curl -X MKCOL --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> ID  : <span class="hljs-variable">$vpn</span>"</span>
until [ <span class="hljs-variable">$c</span> ];<span class="hljs-keyword">do</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     "</span>
	<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> `curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/\n/g'</span> | grep <span class="hljs-string">"d:displayname"</span> | sed <span class="hljs-string">'s/d:displayname//g'</span> | sed <span class="hljs-string">'s/&gt;//g'</span> | sed <span class="hljs-string">'s/&lt;//'</span> | sed <span class="hljs-string">'s/\///g'</span> | grep -v $(date +%Y-%m-%d-%H-%M)`
               <span class="hljs-keyword">do</span>
               <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span><span class="hljs-variable">${RED}</span>   : <span class="hljs-variable">$i</span><span class="hljs-variable">${END}</span>"</span>
               curl -X DELETE --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$i</span>
               <span class="hljs-keyword">done</span>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> ID  : <span class="hljs-variable">$vpn</span>"</span>
        openvpn --genkey --secret <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span>
        passwd=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$vpn</span>-tt"</span> | sha256sum | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
        openssl AES-256-CBC -e -<span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> -out <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/file.enc"</span> -k <span class="hljs-string">"<span class="hljs-variable">$passwd</span>"</span> -base64<font></font>
        curl -T <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/file.enc"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/key.enc<font></font>
        rm <span class="hljs-string">"<span class="hljs-variable">$DIR</span>"</span>/file.enc
	<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> 1 -    <span class="hljs-variable">${END}</span>"</span><font></font>
	go=3<font></font>
	localport=`shuf -i 20000-65000 -n 1`    <span class="hljs-comment">#   </span>
	start=<span class="hljs-string">''</span>
	remote=<span class="hljs-string">''</span>
	timeout1=<span class="hljs-string">''</span>
	nextcheck=<span class="hljs-string">''</span>
	timestart=<span class="hljs-string">''</span>
	until [[ <span class="hljs-variable">$b</span> ]]
		<span class="hljs-keyword">do</span>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  "</span><font></font>
		date=`date +%s`<font></font>
		timeout1=60<font></font>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    <span class="hljs-variable">$date</span>"</span>
		<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$date</span>"</span> &gt; <span class="hljs-string">"/tmp/ready-<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>.txt"</span>
		curl -T <span class="hljs-string">"/tmp/ready-<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>.txt"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ready-<span class="hljs-variable">$name</span>.txt<font></font>
		readyfile=`curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/&gt;\n&lt;/g'</span> | grep -v <span class="hljs-variable">$name</span> | grep <span class="hljs-string">"ready"</span> | grep <span class="hljs-string">"d:displayname"</span> | sed <span class="hljs-string">'s/&lt;d:displayname&gt;//g'</span> | sed <span class="hljs-string">'s/&lt;\/d:displayname&gt;//g'</span>`
		<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$readyfile</span> ]]
			<span class="hljs-keyword">then</span>
				<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>     <span class="hljs-variable">${END}</span>"</span>
				<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  60 "</span>
				sleep <span class="hljs-variable">$timeout1</span>
			<span class="hljs-keyword">else</span>
				remote=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$readyfile</span>)
				<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>    <span class="hljs-variable">${END}</span>"</span>
				start=`curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/&gt;\n&lt;/g'</span> | grep <span class="hljs-string">"start"</span> | grep <span class="hljs-string">"d:displayname"</span> | sed <span class="hljs-string">'s/-/ /g'</span> | awk <span class="hljs-string">'{print $2}'</span>`
				<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$start</span> ]]
					<span class="hljs-keyword">then</span>
                                                <span class="hljs-built_in">let</span> nextcheck=<span class="hljs-variable">$timeout1</span>-<span class="hljs-variable">$date</span>+<span class="hljs-variable">$remote</span>
						<span class="hljs-built_in">let</span> timestart=<span class="hljs-variable">$date</span>+<span class="hljs-variable">$timeout1</span>-<span class="hljs-variable">$nextcheck</span>
						go=<span class="hljs-variable">$nextcheck</span>
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$timestart</span>"</span> &gt; <span class="hljs-string">"/tmp/start-<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>.txt"</span>
						curl -T <span class="hljs-string">"/tmp/start-<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>.txt"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/start-<span class="hljs-variable">$date</span>-<span class="hljs-variable">$name</span>.txt
					<span class="hljs-keyword">else</span>
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  <span class="hljs-variable">$go</span> "</span>
						sleep <span class="hljs-variable">$go</span><font></font>
						b=1<font></font>
						a=<span class="hljs-string">''</span><font></font>
<font></font>
					<span class="hljs-keyword">fi</span><font></font>
<font></font>
			<span class="hljs-keyword">fi</span>
	<span class="hljs-keyword">done</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> 2 -     <span class="hljs-variable">${END}</span>"</span>
mydata=<span class="hljs-string">''</span>
filename=<span class="hljs-string">''</span>
address=<span class="hljs-string">''</span>
myip=<span class="hljs-string">''</span>
ip=<span class="hljs-string">''</span>
port=<span class="hljs-string">''</span><font></font>
ex=0<font></font>
	until [ <span class="hljs-variable">$a</span> ]; <span class="hljs-keyword">do</span>
                until [[ -n <span class="hljs-string">"<span class="hljs-variable">$mydata</span>"</span> ]]; <span class="hljs-keyword">do</span>
				k=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$stuns</span>"</span> | wc -w`<font></font>
				x=1<font></font>
				z=`shuf -i 1-<span class="hljs-variable">$k</span> -n 1`
				<span class="hljs-keyword">for</span> st <span class="hljs-keyword">in</span> <span class="hljs-variable">$stuns</span>; <span class="hljs-keyword">do</span>
					<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$x</span> == <span class="hljs-variable">$z</span> ]]; <span class="hljs-keyword">then</span>
						stun=<span class="hljs-variable">$st</span>;
					<span class="hljs-keyword">fi</span>;<font></font>
					(( x++ ));<font></font>
				<span class="hljs-keyword">done</span>
                                <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>      STUN : <span class="hljs-variable">$stun</span>"</span>
				sleep 5 &amp;&amp; <span class="hljs-keyword">for</span> pid <span class="hljs-keyword">in</span> $(ps xa | grep <span class="hljs-string">"stun "</span><span class="hljs-variable">$stun</span><span class="hljs-string">" 1 -p "</span><span class="hljs-variable">$localport</span><span class="hljs-string">" -v"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>); <span class="hljs-keyword">do</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span>; <span class="hljs-keyword">done</span> &amp;<font></font>
                                mydata=`stun <span class="hljs-string">"<span class="hljs-variable">$stun</span>"</span> 1 -p <span class="hljs-string">"<span class="hljs-variable">$localport</span>"</span> -v 2&gt;&amp;1 | grep <span class="hljs-string">"MappedAddress"</span> | sort | uniq`
                <span class="hljs-keyword">done</span>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  : <span class="hljs-variable">$mydata</span><span class="hljs-variable">${END}</span>"</span>
               	 	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ."</span>
			<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$mydata</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span>
			<span class="hljs-built_in">echo</span> <span class="hljs-string">"IntIP <span class="hljs-variable">$intip</span>"</span> &gt;&gt; <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span>
			curl -T <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span> --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$name</span>-ipport.txt<font></font>
			rm <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/mydata"</span><font></font>
			sleep 5<font></font>
			<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     "</span>
			filename=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">${username}</span>:<span class="hljs-variable">${password}</span>"</span> -X PROPFIND -H <span class="hljs-string">"Depth: 1"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/ | sed <span class="hljs-string">'s/&gt;&lt;/\n/g'</span> | grep <span class="hljs-string">"d:displayname&gt;"</span> | grep <span class="hljs-string">"ipport"</span> | grep -v <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> |  sed <span class="hljs-string">'s|.*d:displayname&gt;||'</span> | sed <span class="hljs-string">'s/&lt;/ /g'</span> | awk <span class="hljs-string">'{print $1}'</span>)
			<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$filename</span>"</span> ]]
				<span class="hljs-keyword">then</span>
					<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>     : <span class="hljs-variable">$filename</span>"</span>
					address=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$filename</span> | grep <span class="hljs-string">"MappedAddress"</span> | head -n1 | sed <span class="hljs-string">'s/:/ /g'</span>)<font></font>
					intip2=$(curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/<span class="hljs-variable">$filename</span> | grep <span class="hljs-string">"IntIP"</span> | head -n1 | awk <span class="hljs-string">'{print $2}'</span>)
					<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  IP-  : <span class="hljs-variable">$address</span> <span class="hljs-variable">$sesid2</span> <span class="hljs-variable">$tunid2</span>"</span>
					ip=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$address</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>)<font></font>
					port=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$address</span>"</span> | awk <span class="hljs-string">'{print $4}'</span>)<font></font>
					myip=`ip route get <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> | head -n 1 | sed <span class="hljs-string">'s|.*src ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`
					<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$myip</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$localport</span>"</span> ]];
						<span class="hljs-keyword">then</span>
							<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  <span class="hljs-variable">$ip</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">${END}</span>"</span>
							<span class="hljs-built_in">echo</span> -e  <span class="hljs-string">"`date` <span class="hljs-variable">${GREEN}</span> <span class="hljs-variable">$myip</span>:<span class="hljs-variable">$localport</span> -&gt; <span class="hljs-variable">$ip</span>:<span class="hljs-variable">$port</span> <span class="hljs-variable">${END}</span>"</span>
	                	        		curl --silent --user <span class="hljs-string">"<span class="hljs-variable">$username</span>:<span class="hljs-variable">$password</span>"</span> https://webdav.yandex.ru/vpn-<span class="hljs-variable">$vpn</span>/key.enc &gt; <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.enc"</span>
	                        			openssl AES-256-CBC -d -<span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.enc"</span> -out <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> -k <span class="hljs-string">"<span class="hljs-variable">$passwd</span>"</span> -base64<font></font>
	                        			chmod 600 <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span>
	                        			rm <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.enc"</span>
	                        			openvpn --remote <span class="hljs-variable">$ip</span> --rport <span class="hljs-variable">$port</span> --lport <span class="hljs-variable">$localport</span> \<font></font>
	                        			--proto udp --dev tun --<span class="hljs-built_in">float</span> --auth-nocache --verb 3 --mute 20 \<font></font>
	                        			--ifconfig <span class="hljs-string">"<span class="hljs-variable">$intip</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$intip2</span>"</span> \<font></font>
	                        			--secret <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> \<font></font>
	                        			--auth SHA256 --cipher AES-256-CBC \<font></font>
	                        			--ncp-disable --ping 10 --ping-exit 20 \<font></font>
	                        			--comp-lzo yes<font></font>
							a=1<font></font>
							b=<span class="hljs-string">''</span>
                                         <span class="hljs-keyword">fi</span>
						<span class="hljs-keyword">else</span>
							<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$ex</span> &gt;= 5 ))
								<span class="hljs-keyword">then</span>
									<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> "</span><font></font>
									a=1<font></font>
									b=<span class="hljs-string">''</span>
							<span class="hljs-keyword">fi</span><font></font>
							(( ex++ ))<font></font>
					sleep 5<font></font>
			<span class="hljs-keyword">fi</span>
		<span class="hljs-keyword">done</span>
<span class="hljs-keyword">done</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なスクリプトを実行するには：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリップボードにコピーして、エディターに貼り付けます。次に例を示します。</font></font><br>
 <pre><code class="bash hljs"><span class="hljs-comment"># nano vpn10.sh </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Diskのログイン（2行目）とパスワード（3行目）を指定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トンネルの内部IPアドレスを指定します（4行目）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトを実行可能にします。</font></font><br>
 <pre><code class="bash hljs"><span class="hljs-comment"># chmod +x vpn10.sh</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトを実行します。</font></font><br>
 <pre><code class="bash hljs"><span class="hljs-comment"># ./vpn10.sh nZbVGBuX5dtturD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ここで、nZbVGBuX5dtturDは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ここで</font></a><font style="vertical-align: inherit;">生成さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">た接続ID </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リモートノードでも同じように、対応するトンネルの内部IPアドレスとID接続を指定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起動時にスクリプトを開始するには、ファイル/etc/rc.localに含まれるコマンド「nohup / &lt;スクリプトへのパス&gt; /vpn10.sh nZbVGBuX5dtturD&gt; /var/log/vpn10.log 2&gt; / dev / null＆」を使用します</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスクリプトは機能し、Ubuntu（18.04、19.10、20.04）とDebian 9でテストされています。他のサービスを送信機として使用できますが、経験上、Yandex.Diskを使用しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験の過程で、一部のタイプのNATプロバイダーは接続を許可しないことが発見されました。</font><font style="vertical-align: inherit;">ほとんどの場合、トレントがブロックされているモバイルオペレーターを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は次の点で最終化する予定です。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 起動するたびにsecret.keyを自動生成し、暗号化してYandex.Diskにコピーして、リモートホストに転送します（更新されたバージョンでは考慮されています）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> インターフェイスのIPアドレスを自動的に割り当てる</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yandex.Diskにアップロードする前のデータ暗号化</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> コードの最適化</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての家庭にIPv6がありますように！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新しました！</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新のファイルと、ここでDEBパッケージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yandex.disk</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja481020/index.html">純粋なJavaScriptを使用したタッチタイピングシミュレーターの作成：パート2</a></li>
<li><a href="../ja481024/index.html">Google Maps APIをやめた理由</a></li>
<li><a href="../ja481028/index.html">OpenVPNを使用して産業用PLCへのリモート接続を整理するためのガイド</a></li>
<li><a href="../ja481030/index.html">自分のためにどんなサイバーデックをやりたいですか</a></li>
<li><a href="../ja481032/index.html">なぜハッキングが可能だったのですか？おそらく攻撃者が</a></li>
<li><a href="../ja481036/index.html">30 Firefox開発ツールのユーティリティ</a></li>
<li><a href="../ja481038/index.html">デザイン中毒の告白。1か月でゲーム「IT Alchemy」を作成した方法</a></li>
<li><a href="../ja481042/index.html">私たちジャンゴの味は興奮し、魅了されます</a></li>
<li><a href="../ja481044/index.html">2020年に向けて何を発表するか：新年ガイドマドロボット</a></li>
<li><a href="../ja481048/index.html">デジタル回路の認識。一般化されたC要素</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>