<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÅ üåó üë©‚Äçüëß .Net Core Api: getting data in a request from different sources üßó üéª üóØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=".Net Core has a built-in Model Binding mechanism, which allows not only to accept input parameters in controllers, but to immediately receive objects ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>.Net Core Api: getting data in a request from different sources</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492820/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.Net Core has a built-in Model Binding mechanism, which allows not only to accept input parameters in controllers, but to immediately receive objects with filled fields. </font><font style="vertical-align: inherit;">This allows you to embed all the necessary checks into such an object using Model Validation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are just the data needed for the API to work, come to us not only from Query or Body. </font><font style="vertical-align: inherit;">Some data needs to be received from Headers (in my case there was json in base64), some data should be from external services or ActionRoute if you use REST. </font><font style="vertical-align: inherit;">You can use your Binding to get data from there. </font><font style="vertical-align: inherit;">True, there is a problem: if you decide not to break encapsulation and initialize the model through the constructor, you will have to shaman. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For myself and for future generations, I decided to write something like instructions for using Binding and shamanism with it.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A typical controller looks something like this:</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">HttpGet</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetSomeData</span>(<span class="hljs-params">[FromQuery[IncomeData someData</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(<span class="hljs-string">"X-Property"</span>);
    <span class="hljs-keyword">if</span> (moreData.Id == <span class="hljs-number">0</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> StatusCode(<span class="hljs-number">400</span>, <span class="hljs-string">"Nginx doesnt know your id"</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">var</span> externalData = GetFromExternalService(<span class="hljs-string">"http://myservice.com/MoreData"</span>);
    <span class="hljs-keyword">if</span> (externalData == <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> StatusCode(<span class="hljs-number">500</span>, <span class="hljs-string">"Cant connect to external service"</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">var</span> finalData = <span class="hljs-keyword">new</span> FinalData(someData, moreData, externalData);
    <span class="hljs-keyword">return</span> _myService.Handle(finalData);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the following problems:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The validation logic is smeared by the request object, the request method from the header, the request method from the service, and the controller method. </font><font style="vertical-align: inherit;">To make sure that the necessary check is definitely there, you need to conduct a whole investigation!</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The adjacent controller method will have exactly the same code. </font><font style="vertical-align: inherit;">Copy-paste programming in attack.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usually there are much more checks than in the example, and as a result, the only significant line - the call to the business logic processing method - is hidden in a heap of code. </font><font style="vertical-align: inherit;">To see him and understand what is happening here in general requires some effort.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom Binding (Easy Mode)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part of the problem can be solved by implementing your handler in the request processing pipeline. </font><font style="vertical-align: inherit;">To do this, first correct our controller by passing the final object to the method immediately. </font><font style="vertical-align: inherit;">It looks much better, right?</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">HttpGet</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">GetSomeData</span>(<span class="hljs-params">[FromQuery]FinalData finalData</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">return</span> _myService.Handle(finalData);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, create your binder for the type MoreData.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinder</span> : <span class="hljs-title">IModelBinder</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
        <span class="hljs-keyword">if</span> (moreData != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            bindingContext.Result = ModelBindingResult.Success(moreData);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> MoreData <span class="hljs-title">GetFromHeaderAndDecode</span>(<span class="hljs-params">IHeaderDictionary headers</span>)</span> { ... }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we‚Äôll fix the FinalData model by adding the binder binding to the property there:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FinalData</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> SomeDataNumber { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> SomeDataText { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
    [<span class="hljs-meta">ModelBinder(BinderType = typeof(MoreDataBinder))</span>]
    <span class="hljs-keyword">public</span> MoreData MoreData { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs already better, but hemorrhoids have increased: now you need to know that we have a special handler and indicate it in all models. </font><font style="vertical-align: inherit;">But it is solvable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create your BinderProvider:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinderProvider</span> : <span class="hljs-title">IModelBinderProvider</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IModelBinder <span class="hljs-title">GetBinder</span>(<span class="hljs-params">ModelBinderProviderContext context</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> modelType = context.Metadata.UnderlyingOrModelType;
        <span class="hljs-keyword">if</span> (modelType == <span class="hljs-keyword">typeof</span>(MoreData))<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinderTypeModelBinder(<span class="hljs-keyword">typeof</span>(MoreDataBinder));<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And register it in Startup:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
{<font></font>
    services.AddControllers();<font></font>
    services.AddMvc(options =&gt;<font></font>
    {<font></font>
        options.ModelBinderProviders.Insert(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> MoreDataBinderProvider());<font></font>
     });<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The provider is called for each model object in the order of the queue. </font><font style="vertical-align: inherit;">If our provider meets the desired type, it will return the desired binder. </font><font style="vertical-align: inherit;">And if not, then the default binder will work. </font><font style="vertical-align: inherit;">So now whenever we specify the type of MoreData, it will be taken and decoded from Header and special attributes in the models do not need to be specified.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom Binding (Hard Mode)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this is great, but there is one thing but: for the magic to work, our model must have public properties with set. </font><font style="vertical-align: inherit;">But what about encapsulation? </font><font style="vertical-align: inherit;">What if I want to transfer the request data to various places in the cloud and know that they will not be changed there? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is that the default binder does not work for models that do not have a default constructor. </font><font style="vertical-align: inherit;">But what prevents us from writing our own?</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The service for which I wrote this code does not use REST, the parameters are transmitted only through Query and Body, and only two types of requests are used - Get </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 and Post. </font><font style="vertical-align: inherit;">Accordingly, in the case of the REST API, the processing logic will be slightly different.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, the code will remain unchanged, only our binder needs refinement so that it creates an object and fills its private fields. </font><font style="vertical-align: inherit;">Further I will give pieces of code with comments, who are not interested - at the end of the article under the cat is the entire listing of the class. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's determine if MoreData is the only property of the class. </font><font style="vertical-align: inherit;">If yes, then you need to create the object yourself (hello, Activator), and if not, then JsonConvert will do the job perfectly, and we just slip the necessary data into the property.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">NeedActivator</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
    <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name).Distinct().Count() == <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating an object through JsonConvert is simple, for queries with Body:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromBody(ModelBindingContext bindingContext, Type modelType)<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> StreamReader(bindingContext.HttpContext.Request.Body);
    <span class="hljs-keyword">var</span> jsonString = reader.ReadToEnd();
    <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonString, modelType);
    <span class="hljs-keyword">return</span> data;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But with Query I had to lay down. </font><font style="vertical-align: inherit;">I would be glad if someone can suggest a more beautiful solution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When passing an array, several parameters with the same name are obtained. </font><font style="vertical-align: inherit;">Casting to a flat type helps, but serialization puts extra quotes on the array [], which must be removed manually.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromQuery(ModelBindingContext bindingContext, Type modelType)<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> valuesDictionary = QueryHelpers.ParseQuery(bindingContext.HttpContext.Request.QueryString.Value);
    <span class="hljs-keyword">var</span> jsonDictionary = valuesDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value.Count &lt; <span class="hljs-number">2</span> ? pair.Value.ToString() : <span class="hljs-string">$"[<span class="hljs-subst">{pair.Value}</span>]"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> jsonStr = JsonConvert.SerializeObject(jsonDictionary).Replace(<span class="hljs-string">"\"["</span>, <span class="hljs-string">"["</span>).Replace(<span class="hljs-string">"]\""</span>, <span class="hljs-string">"]"</span>);
    <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonStr, modelType);
    <span class="hljs-keyword">return</span> data;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, creating the object, it is necessary to write our data into its private property. </font><font style="vertical-align: inherit;">It was about this shamanism that I spoke at the beginning of the article. </font><font style="vertical-align: inherit;">I found this solution </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , for which many thanks to the author.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ForceSetValue</span>(<span class="hljs-params">PropertyInfo propertyInfo, <span class="hljs-keyword">object</span> obj, <span class="hljs-keyword">object</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> propName = <span class="hljs-string">$"&lt;<span class="hljs-subst">{propertyInfo.Name}</span>&gt;k__BackingField"</span>;
    <span class="hljs-keyword">var</span> propFlags = BindingFlags.Instance | BindingFlags.NonPublic;<font></font>
            <font></font>
    obj.GetType().GetField(propName, propFlags)?.SetValue(obj, <span class="hljs-keyword">value</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, we combine these methods in a single call:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
    <span class="hljs-keyword">if</span> (moreData == <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> modelType = bindingContext.ModelMetadata.UnderlyingOrModelType;
    <span class="hljs-keyword">if</span> (NeedActivator(modelType))<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> data = Activator.CreateInstance(modelType, moreData);<font></font>
        bindingContext.Result = ModelBindingResult.Success(data);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> model = bindingContext.HttpContext.Request.Method == <span class="hljs-string">"GET"</span><font></font>
                            ? GetModelFromQuery(bindingContext, modelType)<font></font>
                            : GetModelFromBody(bindingContext, modelType);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"  "</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> ignoreCase = StringComparison.InvariantCultureIgnoreCase;
    <span class="hljs-keyword">var</span> dataProperty = modelType.GetProperties()<font></font>
                            .FirstOrDefault(p =&gt; p.Name.Equals(<span class="hljs-keyword">typeof</span>(T).Name, ignoreCase));<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (dataProperty != <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        ForceSetValue(dataProperty, model, moreData);<font></font>
    }<font></font>
<font></font>
    bindingContext.Result = ModelBindingResult.Success(model);<font></font>
    <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to fix BinderProvider so that it responds to any classes with the desired property:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoreDataBinderProvider</span> : <span class="hljs-title">IModelBinderProvider</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IModelBinder <span class="hljs-title">GetBinder</span>(<span class="hljs-params">ModelBinderProviderContext context</span>)</span><font></font>
    {<font></font>
       <span class="hljs-keyword">var</span> modelType = context.Metadata.UnderlyingOrModelType;
       <span class="hljs-keyword">if</span> (HasDataProperty(modelType))<font></font>
       {<font></font>
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinderTypeModelBinder(<span class="hljs-keyword">typeof</span>(PrivateDataBinder&lt;MoreData&gt;));<font></font>
       }<font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">HasDataProperty</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
        <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name) .Contains(<span class="hljs-keyword">nameof</span>(MoreData));<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all. </font><font style="vertical-align: inherit;">Binder turned out to be a bit more complicated than in Easy Mode, but now we can bind ‚Äúexternal‚Äù properties in all methods of all controllers without additional efforts. </font><font style="vertical-align: inherit;">Of the minuses:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The constructor of objects with private fields must specify the [JsonConstrustor] attribute. </font><font style="vertical-align: inherit;">But this completely fits into the logic of the model and does not interfere with its perception.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Somewhere, you may need to get MoreData not from the header. </font><font style="vertical-align: inherit;">But this is treated by creating a separate class.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the team must be aware of the presence of magic. </font><font style="vertical-align: inherit;">But the documentation will save humanity.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A complete listing of the resulting Binder is here:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrivateMoreDataBinder.cs</font></font></b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PrivateDataBinder</span>&lt;T&gt; : <span class="hljs-title">IModelBinder</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span><span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="bindingContext"&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">BindModelAsync</span>(<span class="hljs-params">ModelBindingContext bindingContext</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> moreData = GetFromHeaderAndDecode(bindingContext.HttpContext.Request.Headers);
            <span class="hljs-keyword">if</span> (moreData == <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> modelType = bindingContext.ModelMetadata.UnderlyingOrModelType;
            <span class="hljs-keyword">if</span> (NeedActivator(modelType))<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> data = Activator.CreateInstance(modelType, moreData);<font></font>
                bindingContext.Result = ModelBindingResult.Success(data);<font></font>
<font></font>
                <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> model = bindingContext.HttpContext.Request.Method == <span class="hljs-string">"GET"</span><font></font>
                            ? GetModelFromQuery(bindingContext, modelType)<font></font>
                            : GetModelFromBody(bindingContext, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"  "</span>);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">var</span> ignoreCase = StringComparison.InvariantCultureIgnoreCase;
            <span class="hljs-keyword">var</span> dataProperty = modelType.GetProperties()<font></font>
                                        .FirstOrDefault(p =&gt; p.Name.Equals(<span class="hljs-keyword">typeof</span>(T).Name, ignoreCase));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (dataProperty != <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                ForceSetValue(dataProperty, model, moreData);<font></font>
            }<font></font>
<font></font>
            bindingContext.Result = ModelBindingResult.Success(model);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromQuery(ModelBindingContext bindingContext,<font></font>
                                                 Type modelType)<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> valuesDictionary = QueryHelpers.ParseQuery(bindingContext.HttpContext.Request.QueryString.Value);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> jsonDictionary = valuesDictionary.ToDictionary(pair =&gt; pair.Key, pair =&gt; pair.Value.Count &lt; <span class="hljs-number">2</span> ? pair.Value.ToString() : <span class="hljs-string">$"[<span class="hljs-subst">{pair.Value}</span>]"</span>);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> jsonStr = JsonConvert.SerializeObject(jsonDictionary)<font></font>
                                     .Replace(<span class="hljs-string">"\"["</span>, <span class="hljs-string">"["</span>)<font></font>
                                     .Replace(<span class="hljs-string">"]\""</span>, <span class="hljs-string">"]"</span>);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonStr, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> data;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">object</span>? GetModelFromBody(ModelBindingContext bindingContext,<font></font>
                                                Type modelType)<font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> StreamReader(bindingContext.HttpContext.Request.Body);
            <span class="hljs-keyword">var</span> jsonString = reader.ReadToEnd();
            <span class="hljs-keyword">var</span> data = JsonConvert.DeserializeObject(jsonString, modelType);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> data;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">NeedActivator</span>(<span class="hljs-params">IReflect modelType</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> propFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance;
            <span class="hljs-keyword">var</span> properties = modelType.GetProperties(propFlags);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> properties.Select(p =&gt; p.Name).Distinct().Count() == <span class="hljs-number">1</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ForceSetValue</span>(<span class="hljs-params">PropertyInfo propertyInfo, <span class="hljs-keyword">object</span> obj, <span class="hljs-keyword">object</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> propName = <span class="hljs-string">$"&lt;<span class="hljs-subst">{propertyInfo.Name}</span>&gt;k__BackingField"</span>;
            <span class="hljs-keyword">var</span> propFlags = BindingFlags.Instance | BindingFlags.NonPublic;<font></font>
            <font></font>
            obj.GetType().GetField(propName, propFlags)?.SetValue(obj, <span class="hljs-keyword">value</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> T <span class="hljs-title">GetFromHeaderAndDecode</span>(<span class="hljs-params">IHeaderDictionary headers</span>)</span> { <span class="hljs-keyword">return</span> (T)Activator.CreateInstance(<span class="hljs-keyword">typeof</span>(T), <span class="hljs-keyword">new</span> <span class="hljs-keyword">object</span>[] { <span class="hljs-string">"ok"</span> }); }<font></font>
    }<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492806/index.html">How to link engagement to monetization in mobile games and apps</a></li>
<li><a href="../en492808/index.html">Emergency light switch position sensor</a></li>
<li><a href="../en492810/index.html">[COVID-19] Your task is to smooth the peak</a></li>
<li><a href="../en492812/index.html">Trying to run GAN networks in OpenVINO</a></li>
<li><a href="../en492816/index.html">IntelliJ IDEA Tips & Tricks: 4. Synchronize and share settings</a></li>
<li><a href="../en492822/index.html">CSS developers - why do the world need them?</a></li>
<li><a href="../en492828/index.html">How to survive in a locked up world</a></li>
<li><a href="../en492830/index.html">SameSite = Lax by default - already in Chrome 80 stable (though not for everyone yet)</a></li>
<li><a href="../en492832/index.html">IoT-gateway for industrial protocols based on i.MX6 and Linux</a></li>
<li><a href="../en492834/index.html">What is common between LVM and matryoshka?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>