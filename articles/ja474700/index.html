<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍💻 🗿 ⛲️ クラウドスマートホーム。パート2：クラウドサービス 🎬 👨🏿‍🤝‍👨🏻 📕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="クラウドスマートホームに関する3つのシリーズの記事を続けます。
 
 では前の記事、スマートホームを感知するための機器は、執行デバイスのための制御コマンドに知覚データを変換するためのアルゴリズムと同様に、考えられました。スマートホームの主要コンポーネントはコントローラーであり、ほとんどの場合、セット...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>クラウドスマートホーム。パート2：クラウドサービス</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474700/"><img src="https://habrastorage.org/webt/iq/e3/kt/iqe3kte_k_di5dqmevpvprwojee.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドスマートホームに関する3つのシリーズの記事を続けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、スマートホームを感知するための機器は、執行デバイスのための制御コマンドに知覚データを変換するためのアルゴリズムと同様に、考えられました。</font><font style="vertical-align: inherit;">スマートホームの主要コンポーネントはコントローラーであり、ほとんどの場合、セットアップ段階で設定されたロジックに従って自律的に動作します。</font><font style="vertical-align: inherit;">さまざまなデバイス（IPカメラ、センサー、アクチュエーター）がコントローラーに接続され、コントローラーはこれらのデバイスから受信したデータをクラウドに送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、センサーとカメラからの情報を保存および処理するためのクラウドサービスのアーキテクチャについて説明します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドサービスの利点</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームクラウドサービスは、スマートホームデバイスから受信したデータを保存およびアクセスするためのシンプルで柔軟かつ安価な方法を提供します。クラウドサービスのユーザーは、データの安全性について心配する必要はありません。複数の10〜12 TBドライブのRAIDアレイを備えたディスクバスケットを備えたマルチプロセッサメディアサーバーの機能は、スマートホームコントローラー内のSDまたはフラッシュカードの容量をはるかに超えています。さらに、メモリカードは書き換え回数が限られており、故障することが多いため、信頼性が低くなります。クラウド内のデータストレージの深さは、ユーザーの料金によって決まり、ユーザーの個人アカウントで簡単に構成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、NATプロトコルによってスマートホームデバイスが外部ネットワークから隠されている場合、データにアクセスするためにユーザーのルーターで「ポート転送」する必要はありません。</font><font style="vertical-align: inherit;">モバイルデバイスからアクセスできる個人アカウントで、スマートホームの構成とロジックを簡単に構成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドにデータを保存するだけでなく、データを処理してユーザーにさまざまな期間の統計を提供することも便利です。</font><font style="vertical-align: inherit;">以下では、マルチセンサー測定に基づいて週あたりの平均室温を計算する例を検討します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドサービスアーキテクチャ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前回の記事では、ユーザー側にインストールされ、いくつかのプロトコルを使用してクラウドサービスと対話するスマートホームコントローラーについて説明しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTTは、コントローラーとビジネスロジックサーバーの間でJSONメッセージを交換するために使用されます。</font></font></li>
<li>HTTP   IP-        ;</li>
<li>RTMP    H.264 + AAC  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、スマートホームのクラウドサービス（クラウドサービスの主要コンポーネント、およびスマートホームコントローラーとの対話がどのように行われるか）について考えます。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開き</font></font><b><font style="vertical-align: inherit;">ます</font></b><font color="grey"><font style="vertical-align: inherit;">）</font></font><b><font style="vertical-align: inherit;">ビジネスロジックサーバー</font></b><font style="vertical-align: inherit;">は、クラウドサービス内の情報交換のスキーム全体における重要な要素です。その主な目的は、RESTful APIインターフェイスを介してさまざまなサーバーサブシステムを管理することです。これは</font><b><font style="vertical-align: inherit;">、ユーザーモデルに</font></b><font style="vertical-align: inherit;">基づいてクラウドサービスのロジックを実装し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。選択した料金に応じたビデオアーカイブとセンサー測定値の記録、ユーザーとスマートホームコントローラー間の相互作用などです。</font><b><font style="vertical-align: inherit;">MQTTブローカー</font></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/os/bd/xi/osbdxiktvu-cla3sizuxjoaxbfu.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側にインストールされたスマートホームコントローラーとビジネスロジックサーバー間でJSONメッセージを交換するために必要です。クライアントは、メッセージチャネルとして機能するブローカー内のトピックにサブスクライブします。 MQTTブローカーとして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eclipse Mosquittoが使用され</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メディアサーバークラスター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、曇ったスマートホームのIPカメラのビデオ情報を保存、処理、検索、再生するための分散システムです。特別なロードバランサーは、クラスター内の各サーバーの現在のパフォーマンスに関する情報を収集し、最小の負荷を計算して、そのIPアドレスをカメラからビデオをスマートホームコントローラーに転送します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドデータベース</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドサービスのユーザーモデル、その機器の構成と現在の状態、ビデオアーカイブエントリに関するメタ情報を保存するために必要です。 MySQL DBMSは、クラウドデータベースの実装として使用されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Touch Database</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は非リレーショナルNoSQLデータベースです。イベントとスマートホームセンサーの測定値を時間順に格納します。</font><font style="vertical-align: inherit;">このタイプのデータを操作するために最適化された</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InfluxDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMSを使用すると</font><font style="vertical-align: inherit;">、クラウドサービスのパフォーマンスが大幅に向上します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントアプリケーションバックエンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーアプリケーションです。その主な機能は、クラウドから受信したデータを提供し、ユーザーのデバイス上のクライアントアプリケーションが後で表示するための便利な形式でタッチデータベースを提供することです。バックエンドは、スマートホームコントローラーの制御コマンドをJSON形式で生成します。バックエンドは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHPフレームワークに基づいてい</font><font style="vertical-align: inherit;">ます。これについては、クラウドスマートホームとやり取りするクライアントアプリケーションに関する次の記事で詳しく説明します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プッシュ通知プロバイダー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームのイベントに関するメッセージをユーザーのモバイルデバイスに配信し、ユーザーが状況にすばやく介入できるようにします（たとえば、水漏れや煙が現れたときは、適切な応答サービスを呼び出します）。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OneSignal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスはPush-notificationsのプロバイダーとして選択されました</font><font style="vertical-align: inherit;">。これは、便利なRESTful APIインターフェイスと、ユーザーの個人アカウント内の通知の正しい操作に必要なモバイルデバイスを識別する機能を備えています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスロジックサーバー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前述したように、ビジネスロジックサーバーはクラウドスマートホームの主要コンポーネントです。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーモデル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（システム、個人、財務、論理機能を含むシステムユーザーの情報記述）に</font><font style="vertical-align: inherit;">基づいて</font><b><font style="vertical-align: inherit;">、</font></b><font style="vertical-align: inherit;">クラウド内でさまざまな実装と機能を持ち、RESTful APIインターフェースを介して相互に通信するさまざまなサービスを管理します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m0/vl/vj/m0vlvjztjnmvtrckqgvefi2ht80.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバー内のビジネスロジックモジュールは、次の操作を担当します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タッチデータベース内のスマートホームのIPカメラからのセンサーの測定値とモーション検出器のイベントのストレージの管理。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メディアサーバーのアーカイブ内のスマートホームコントローラーによるIPカメラブロードキャストのメディアストリームの記録の管理（一定/モーション検出器による）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントアプリケーションからスマートホームコントローラーへのコマンドの変換。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームコントローラーの構成をブロードキャストします（接続されたデバイス、ユーザーが定義した生産ロジックルール）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームコントローラーと接続されているデバイスのステータスに関するプッシュ通知をクライアントアプリケーションに送信する。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックサーバーの機能は、インターネット上の複数のサーバーで実行されているリモートアプリケーションとのプロセス間通信です。</font><font style="vertical-align: inherit;">ほとんどの場合、ビジネスロジックサーバーアプリケーションはI / Oロックでアイドル状態であるため、マルチスレッドアーキテクチャに基づいて設計され、一連の有限サブタスクで構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最大限の効率を確保するには、ビジネスロジックサーバーの内部実装が最も単純でなければなりません（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KISSの原則</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）ユーザーモデルは完全に確定的であり、属性間の関係の変化を含まないため、柔軟な推論メカニズムは必要ありません（ユーザーがユーザーロジックを構成するスマートホームコントローラーなど）。したがって、サーバー内のビジネスロジックモジュールの動作は、条件付き遷移を伴う従来のアルゴリズムブロック図で説明できます。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/fh/xf/70/fhxf703hqjqjjhzg9i_uuxv2qqo.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起動後すぐに、ビジネスロジックサーバーは、MQTTプロトコル（スマートホームコントローラーから）とHTTP（クライアントアプリケーションのバックエンドから）を使用して、メッセージの待機状態になります。メッセージがHTTP経由で到着した場合、これはユーザーがクライアントアプリケーションと対話してコマンドをスマートホームコントローラーに送信するか、その構成を更新することを意味します。クライアントからのメッセージをスマートホームコントローラーに送るために、メッセージはビジネスロジックサーバーによって、コントローラーがサブスクライブされているMQTTブローカーの対応するトピックに送信されます（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SendGatewayMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブタスク</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期化段階では、スマートホームコントローラーはユーザーがアカウントに登録するのを待ちます。したがって、サブタスク</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CheckGatewayExistanceが実行されます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、MySQLクラウドデータベースの対応するステータスをチェックします。</font><font style="vertical-align: inherit;">個人アカウントに登録するために、コントローラーは完全な構成をビジネスロジックサーバーに送信し、次に、そのバックエンドをクライアントアプリケーションに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロードキャストし</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font><b><font style="vertical-align: inherit;">SendBackendサブタスク</font></b><font style="vertical-align: inherit;">）、クラウドとタッチデータベースの構成レコードを作成および更新します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーがユーザーの個人アカウントに正常に登録されると、ビジネスロジックサーバーはクラウドデータベースからユーザーモデルをRAMにロードし、次のビジネスロジックアルゴリズムに従ってIPカメラとZ-Waveセンサーからのメッセージの処理を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
情報フィールドを含むZ-WaveセンサーからのJSONメッセージ：</font></font><br>
<br>
<pre><code class="json hljs">{
	<span class="hljs-attr">"vendor"</span>: <span class="hljs-string">"*****"</span>,
	<span class="hljs-attr">"version"</span>: <span class="hljs-string">"3.0.0"</span>,
	<span class="hljs-attr">"timestampMs"</span>: <span class="hljs-string">"1571754749561"</span>,
	<span class="hljs-attr">"clientType"</span>: <span class="hljs-string">"gateway"</span>,
	<span class="hljs-attr">"deviceId"</span>: <span class="hljs-string">"c8e8de37-d301-45f4-ba01-************"</span>,
	<span class="hljs-attr">"deviceType"</span>: <span class="hljs-string">"sensor"</span>,
	<span class="hljs-attr">"protocol"</span>: <span class="hljs-string">"zwave"</span>,
	<span class="hljs-attr">"messageType"</span>: <span class="hljs-string">"sensorData"</span>,
	<span class="hljs-attr">"homeId"</span>: <span class="hljs-string">"0xefa0cfa7"</span>,
	<span class="hljs-attr">"nodeId"</span>: <span class="hljs-string">"19"</span>,
	<span class="hljs-attr">"sensorType"</span>: <span class="hljs-string">"SENSOR MULTILEVEL"</span>,
	<span class="hljs-attr">"label"</span>: <span class="hljs-string">"Temperature"</span>,
	<span class="hljs-attr">"sensorData"</span>: <span class="hljs-string">"26.1"</span>,
	<span class="hljs-attr">"units"</span>: <span class="hljs-string">"C"</span>,
	<span class="hljs-attr">"gatewayId"</span>: <span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Z-WaveセンサーからのメッセージがMQTTプロトコル経由で到着すると、次のサブタスクが実行されます。</font></font><br>
<br>
<ul>
<li><b>StoreSensorDataMySQL</b>  (UPDATE)      MySQL,          .     ,       ;</li>
<li><b>StoreSensorDataInfluxDB</b>  (INSERT)      InfluxDB,      .            (,   ,   )          ;</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SendPushNotification</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、タイムスタンプ、センサー名、イベントのテキスト説明、個人アカウントにログインしたユーザーのスマートフォンのID、およびOneSignalプロバイダーシステムのアプリケーションの内部IDを含むJSONメッセージを生成します。</font><font style="vertical-align: inherit;">さらに、このメッセージはRESTful API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://onesignal.com/api/v1/notifications</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介してプッシュ通知プロバイダーに送信さ</font><font style="vertical-align: inherit;">れ、ユーザーのスマートフォンに配信されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
情報フィールドを持つIPカメラからのJSONメッセージの例：</font></font><br>
<br>
<pre><code class="json hljs">{
	<span class="hljs-attr">"vendor"</span>: <span class="hljs-string">"*****"</span>,
	<span class="hljs-attr">"version"</span>: <span class="hljs-string">"3.0.0"</span>,
	<span class="hljs-attr">"timestampMs"</span>: <span class="hljs-string">"1571753150317"</span>,
	<span class="hljs-attr">"clientType"</span>: <span class="hljs-string">"gateway"</span>,
	<span class="hljs-attr">"deviceId"</span>: <span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span>,
	<span class="hljs-attr">"deviceType"</span>: <span class="hljs-string">"camera"</span>,
	<span class="hljs-attr">"protocol"</span>: <span class="hljs-string">"onvif"</span>,
	<span class="hljs-attr">"messageType"</span>: <span class="hljs-string">"deviceState"</span>,
	<span class="hljs-attr">"deviceState"</span>: <span class="hljs-string">"streamingOn"</span>,
	<span class="hljs-attr">"mediaserverIp"</span>: <span class="hljs-string">"***.***.***.***"</span>,
	<span class="hljs-attr">"applicationName"</span>: <span class="hljs-string">"rtp-live-iot"</span>,
	<span class="hljs-attr">"gatewayId"</span>: <span class="hljs-string">"6774f85a-0a5b-4059-9b68-************"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MQTTプロトコルを使用してIPカメラからメッセージが到着すると、ビジネスロジックサーバーは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messageType</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドからそのタイプを抽出します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このフィールドの値に応じて、次のアクションが実行されます。</font></font><br>
<br>
<ul>
<li><b>«messageType»: «deviceState»</b> —       IP-.   <b>UpdateCameraState</b>,     .     <b>deviceState</b>   <b>streamingOn</b>  <b>streamingOff</b> (IP- /    ),    <b>RecordMediaStream</b>,        /        ;</li>
<li><b>«messageType»: «sensorData»</b> —       IP-.           «  »,    <b>RecordMediaStream</b>.    <b>StoreSensorDataInfluxDB</b> (      )  <b>SendPushNotification</b> ( Push-  );</li>
<li><b>«messageType»: «preview»</b> —       IP-,     .  <b>StorePreview</b>     .          ;</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"MessageType"： "command"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ユーザーがWebインターフェイスを介して設定を変更したときにスマートホームコントローラーによって送信されるコマンド。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブタスクRecordMediaStreamが実行され</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><b><font style="vertical-align: inherit;">これは</font></b><font style="vertical-align: inherit;">、ユーザーモデルに応じて、メディアサーバーの記録モードをオン/オフにします。</font></font></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/8o/_u/gy/8o_ugygyf5hm0nlyd6aw8zwge8s.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ビジネスロジックモジュールの作業の結果として、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクキュー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が形成されます-互いに独立して実行されるコードの最小セクションのシーケンス。</font><font style="vertical-align: inherit;">タスクキューは、実行のために</font><b><font style="vertical-align: inherit;">スレッドプールに</font></b><font style="vertical-align: inherit;">渡されます</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、中央プロセッサの空きコアにタスクを分散します。実行中にI / Oロックが発生すると、スレッドは一時停止してアイドル状態に入り、中央プロセッサのコアを解放します。これにより、スレッドプールはキューから次のタスクの即時実行を開始できます。 I / Oロックが解放される瞬間に、ブロックされたスレッドはその状態を作業に変更し、中央プロセッサのコアの1つが解放されるとすぐに実行を継続します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ビジネスロジックタスクを同時に実行される多くの個別のサブタスクに分解することにより、ビジネスロジックサーバーのパフォーマンスが向上します。システムのスケーリングは、中央プロセッサのコアの数を増やし、システム内のビジネスロジックサーバーの数を増やすことによって実現されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックサーバーアプリケーションはC ++で開発され</font><font style="vertical-align: inherit;">、LinuxオペレーティングシステムDebian Sargeの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスとして実行され</font><font style="vertical-align: inherit;">ます。追加のパフォーマンスモニタリングには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースモニタリングシステムが使用され</font><font style="vertical-align: inherit;">、パフォーマンスの問題が発生した場合にサービスを再起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、クラウドサービスは、Yandex。Cloud仮想マシンで実行されている1つのビジネスロジックサーバーを実行しています。</font><font style="vertical-align: inherit;">仮想マシンのパラメーター-20％のシェアが保証された4つのvCPUコア、2 GBのRAM、100 GBのHDD。</font><font style="vertical-align: inherit;">計算によると、このパフォーマンスは、3台のIPカメラと5台のZ-Waveセンサーを備えた、約1000台のスマートホームコントローラーからのメッセージを処理するのに十分です（計算はシステムの動作中に更新されます）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メディアサーバー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアサーバーは、次のような特別なソフトウェアがインストールされている専用サーバーです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">専用のネットワークプロトコルを使用してエンコーダーデバイスからビデオおよびオーディオデータのストリームを受信する。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムにアーカイブファイルの形式でデータを保存する。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーカイブファイルからの情報を、クライアントデバイスで再生するための標準ストリーミング形式でブロードキャストします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java言語で開発された追加モジュールを備えた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wowza Streaming Engine 4.7.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
は、クラウドスマートホームシステムのメディアサーバーとして使用され、</font><font style="vertical-align: inherit;">ストリーミングデータをファイルアーカイブに記録したり、クラウドデータベースを操作したりします。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font><font style="vertical-align: inherit;"> 
RTMP形式のスマートホームコントローラーからのメディアストリームがメディアサーバーに入り、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ジッターバッファー</font></a><font style="vertical-align: inherit;">内のタイムスタンプと揃えられます</font><font style="vertical-align: inherit;">。これは、インターネット経由でデータフローを送信する際のネットワークパケット遅延の影響を補正するために必要です。</font><font style="vertical-align: inherit;">
ビデオストリームをMP4ファイルとしてメディアサーバーファイルシステムに記録するには、ビジネスロジックサーバーがRESTful HTTP APIを介して次のコマンドをメディアサーバーに送信します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/va/du/c-/vaduc-wwi67k2367aoez0bnqx_s.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="json hljs">http:<span class="hljs-comment">//&lt;mediaserverIp&gt;:&lt;port&gt;/v2/servers/_defaultServer_/vhosts/_defaultVHost_/applications/rtp-live-iot/instances/_definst_/streamrecorders/1616453d-30cd-44b7-9bf0-************</span><font></font>
{<font></font>
	<span class="hljs-attr">"instanceName"</span>: <span class="hljs-string">"_definst_"</span>,
	<span class="hljs-attr">"fileVersionDelegateName"</span>: <span class="hljs-string">"CustomFileVersionDelegate"</span>,
	<span class="hljs-attr">"serverName"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"recorderName"</span>: <span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span>,
	<span class="hljs-attr">"segmentSchedule"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"outputPath"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"currentFile"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"applicationName"</span>: <span class="hljs-string">"rtp-live-iot"</span>,
	<span class="hljs-attr">"fileTemplate"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"segmentationType"</span>: <span class="hljs-string">"SegmentByDuration"</span>,
	<span class="hljs-attr">"fileFormat"</span>: <span class="hljs-string">"MP4"</span>,
	<span class="hljs-attr">"recorderState"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"option"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-attr">"currentSize"</span>: <span class="hljs-string">"0"</span>,
	<span class="hljs-attr">"segmentSize"</span>: <span class="hljs-string">"0"</span>,
	<span class="hljs-attr">"segmentDuration"</span>: <span class="hljs-string">"1800000"</span>,
	<span class="hljs-attr">"backBufferTime"</span>: <span class="hljs-string">"0"</span>,
	<span class="hljs-attr">"currentDuration"</span>: <span class="hljs-string">"0"</span>,
	<span class="hljs-attr">"startOnKeyFrame"</span>: <span class="hljs-string">"true"</span>,
	<span class="hljs-attr">"recordData"</span>: <span class="hljs-string">"false"</span>,
	<span class="hljs-attr">"moveFirstVideoFrameToZero"</span>: <span class="hljs-string">"true"</span>,
	<span class="hljs-attr">"defaultRecorder"</span>: <span class="hljs-string">"false"</span>,
	<span class="hljs-attr">"splitOnTcDiscontinuity"</span>: <span class="hljs-string">"false"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecorderName</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
フィールド</font><font style="vertical-align: inherit;">には、ビデオストリームの名前（スマートホームコントローラーのIPカメラ識別子）が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">示さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、</font><b><font style="vertical-align: inherit;">fileVersionDelegateName</font></b><font style="vertical-align: inherit;">フィールド</font><font style="vertical-align: inherit;">には、フォルダーパスとファイル名を決定するために継承されたクラスの名前</font><font style="vertical-align: inherit;">が</font><b><font style="vertical-align: inherit;">示さ</font></b><font style="vertical-align: inherit;">れ</font><font style="vertical-align: inherit;">ます。クラスのJavaコードを次のリストに示します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.util.Calendar;
<span class="hljs-keyword">import</span> java.util.TimeZone;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.wowza.wms.livestreamrecord.manager.IStreamRecorder;
<span class="hljs-keyword">import</span> com.wowza.wms.livestreamrecord.manager.IStreamRecorderFileVersionDelegate;
<span class="hljs-keyword">import</span> com.wowza.wms.logging.WMSLoggerFactory;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomFileVersionDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IStreamRecorderFileVersionDelegate</span>
</span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFilename</span><span class="hljs-params">(IStreamRecorder recorder)</span>
    </span>{<font></font>
        String	sDisk = GetDisk();<font></font>
        <span class="hljs-keyword">if</span>(sDisk == <span class="hljs-keyword">null</span>)<font></font>
        {<font></font>
            WMSLoggerFactory.getLogger(<span class="hljs-keyword">null</span>).error(<span class="hljs-string">"CustomFileVersionDelegate::getFilename(): No drive chosen"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
        }<font></font>
	<font></font>
        String sStreamName = recorder.getStreamName();<font></font>
        <span class="hljs-keyword">int</span> nCameraId = Integer.parseUnsignedInt(ServiceQueries.GetCameraId(sStreamName));<font></font>
	<font></font>
        TimeZone tz = TimeZone.getTimeZone(<span class="hljs-string">"Europe/Moscow"</span>);<font></font>
        Calendar now = Calendar.getInstance(tz);<font></font>
<font></font>
        String sDirPath =<font></font>
                ServerParams.m_sServerContentPath +<font></font>
                <span class="hljs-string">"/"</span> + sDisk +
                <span class="hljs-string">"/"</span> + Integer.toString(nCameraId / <span class="hljs-number">200</span>) +
                <span class="hljs-string">"/"</span> + sStreamName +
                <span class="hljs-string">"/"</span> + String.format(<span class="hljs-string">"%1$tY/%1$tm/%1$td"</span>, now);<font></font>
<font></font>
        String sFullFilePath =<font></font>
                sDirPath +<font></font>
                <span class="hljs-string">"/"</span> + sStreamName +
                <span class="hljs-string">"_"</span> + String.format(<span class="hljs-string">"%1$tH_%1$tM_%1$tS"</span>, now) +
                <span class="hljs-string">".mp4"</span>;<font></font>
<font></font>
        File dirs = <span class="hljs-keyword">new</span> File(sDirPath);<font></font>
        dirs.setExecutable(<span class="hljs-keyword">true</span>);<font></font>
        dirs.setWritable(<span class="hljs-keyword">true</span>);<font></font>
        dirs.mkdirs();<font></font>
	<font></font>
        WMSLoggerFactory.getLogger(<span class="hljs-keyword">null</span>).info(
                <span class="hljs-string">"CustomFileVersionDelegate::getFilename(): Filename created: "</span> + sFullFilePath);<font></font>
		<font></font>
        <span class="hljs-keyword">return</span> sFullFilePath;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CustomFileVersionDelegate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
クラスの</font><font style="vertical-align: inherit;">オーバーロードされた仮想関数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getFilename</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本クラス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IStreamRecorderFileVersionDelegate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これは、ファイルに書き込む前にフローメディアサーバーによって発生します。この関数は、パスに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sDirPath</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">してディスク上にフォルダーを作成</font><font style="vertical-align: inherit;">し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sFullFilePath</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルへの完全パスを返します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアデータのボリュームは非常に大きいため、ファイルシステムには、サブディレクトリとしてマウントされた大容量の物理ディスク（8〜12 TB）がいくつか含まれています。空き容量が最大のディスクが、記録中にターゲットディスクとして選択されます。ファイルにアクセスするときのファイルシステムの最適な操作のために、ターゲットフォルダーへのパスは次のように形成されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">/content/&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diskIdは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（フォルダを搭載）ディスクの識別子である、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cameraIdDivideBy200は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 200によってカメラの識別子の整数除算の結果であり、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streamUuidは、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メディアストリームの識別子であり、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">年、月、日を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それぞれ記録の年、月、日です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、1つのフォルダー内の多数のサブフォルダーが回避され、したがって、曇りのあるスマートホームのIPカメラの数が増えると、ファイルシステム全体のパフォーマンスが劇的に低下します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアサーバーのIPアドレス、メディアデータを含むファイルへのパス、ファイルへの書き込みの開始時間と終了時間に関する情報はクラウドデータベースに保存され、クライアントアプリケーションがそれを使用して、ビデオを選択および再生できるアーカイブタイムラインを表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントアプリケーションのフロントエンドは、ビデオストリームを受信するために、HTTP経由で次のコマンドを送信してメディアサーバーにアクセスします。</font><font style="vertical-align: inherit;">「ライブ」ビデオストリームの場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/rtp-live-iot/&lt;streamUuid&gt;/playlist.m3u8
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーカイブされたビデオストリームの場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">https://&lt;mediaserverIp&gt;:&lt;port&gt;/vod/_definst_/mp4:&lt;diskId&gt;/&lt;cameraIdDivideBy200&gt;/&lt;streamUuid&gt;/&lt;year&gt;/&lt;month&gt;/&lt;day&gt;/&lt;fileName&gt;/playlist.m3u8?wowzaplaystart=&lt;offsetMs&gt;&amp;wowzaplayduration=&lt;durationMs&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fileName</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はディスク上のアーカイブファイルの名前、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offsetMs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はファイルの先頭からの再生オフセット（ミリ秒）、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durationMs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は再生時間（ミリ秒）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアサーバーは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ストリームを送信します</font><font style="vertical-align: inherit;">。これにより、iOSおよびAndroidオペレーティングシステムを搭載したすべての最新のブラウザーおよびモバイルデバイスでH.264 + AACビデオを表示できます。 HLSパケタイザは、ストリームを個別のチャンクの形式でエンコードし、モバイルアプリケーションからの要求に対する応答としてHTTP経由で送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ストレージコストとアーカイブファイルへのアクセスを最適化するために、クラウドスマートホームメディアサーバーは、Supermicro CSE-825TQハードウェアプラットフォーム、マザーボードX8DT6、2xCPU Intel Xeon E5645 2.4 GHz、32 GB RAM、44 TB HDD Adaptec AAC-RAIDで開発されています。メディアサーバーはホスティングサイトに専用サーバーとしてインストールされ、400 Mbpsの保証幅でインターネットチャネルに接続します。 1台のメディアサーバーのパフォーマンスは、H.264コーデック、720pフレーム解像度、1 Mbpsビットレートの〜400 IPカメラからのメディアストリームを処理するのに十分です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zr/-n/sy/zr-nsyuedb8wtbakou5rzfnsyo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、1000台のIPカメラからのストリームを処理できるようにするには、3台のメディアサーバーをインストールして、負荷を均等に分散させる必要があります。これには、ロードバランサーが使用されます。ロードバランサーは、Wowza Streaming Engineメディアサーバーに別の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic Load Balancing AddOn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プラグインとして接続されます</font><font style="vertical-align: inherit;">。これにより、実際には</font><font style="vertical-align: inherit;">、最終的なメディアサーバー（または</font><b><font style="vertical-align: inherit;">エッジサーバー</font></b><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">から定期的にパフォーマンスメトリックを受信し、</font><font style="vertical-align: inherit;">この情報に基づいてクラスター内で最も負荷の少ないサーバーを見つける</font><font style="vertical-align: inherit;">ロードバランサー（または</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オリジンサーバー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が</font><font style="vertical-align: inherit;">区別さ</font><font style="vertical-align: inherit;">れます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーはHTTP経由でバランサーにアクセスし、それに応じてこのサーバーのIPアドレスを受信します。このサーバーにコントローラーがRTMP経由でIPカメラからメディアストリームを送信します。</font><font style="vertical-align: inherit;">パフォーマンスメトリックには、メディアストリームのソースおよびコンシューマとの確立された接続の数、およびサーバー上のインターネットチャネルの現在の帯域幅が含まれます。</font><font style="vertical-align: inherit;">バランサーの設定では、地理空間の位置を考慮してエッジサーバーの選択を指定することもできます。これにより、さまざまな都市や国でサーバーをホストして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CDN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツを配信するための分散ネットワークを作成できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タッチデータベース</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の記事で述べたように、Z-Waveセンサーの読み取り値、およびIPカメラの現在のステータスとイベントは、MQTTプロトコルを使用してスマートホームコントローラーによってクラウドにJSON形式で送信されます。ビジネスロジックサーバーはこれらのメッセージをデコード</font><font style="vertical-align: inherit;">し、HTTP経由でデータをタッチデータベースに送信</font><font style="vertical-align: inherit;">する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StoreSensorDataInfluxDB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブタスクを</font><font style="vertical-align: inherit;">実行します。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開き</font></font><font style="vertical-align: inherit;"> 
ます</font><font color="grey"><font style="vertical-align: inherit;">）</font></font><font style="vertical-align: inherit;">クラウドスマートホームのクラウドデータベースは、</font><font style="vertical-align: inherit;">時系列を操作するためのオープンソースDBMS </font><font style="vertical-align: inherit;">である</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">InfluxDB 1.7.xに</font></a><font style="vertical-align: inherit;">基づいて開発されています。これは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">モノ</font></a><font style="vertical-align: inherit;">のインターネットの多くのプロジェクトでデータを保存するために使用されます。センサーと分析。 touchデータベースへのリクエストは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">InfluxQL</font></a><font style="vertical-align: inherit;">言語で生成されます</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/14/lv/rv/14lvrvrra0js_mzifmrwszu9c68.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">従来のSQLに似ています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドスマートホームでのデータ保存時間は、ユーザーモデルに応じて、選択した料金によって決まります。</font><font style="vertical-align: inherit;">ビデオデータとセンサーデータの量には大きな違いがあるため、保存時間は異なります。</font><font style="vertical-align: inherit;">ビデオアーカイブのサイズは日単位で測定され（7、14、30日は異なるレート）、センサーのアーカイブのサイズは年単位で測定されます（それぞれ3、5、7年）。</font><font style="vertical-align: inherit;">したがって、スマートホームコントローラーごとに、ユーザーの個人アカウントに登録されると、異なる保持ポリシーを持つ2つの個別のデータベースがtouchデータベース内に作成されます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">720</span>h SHARD <span class="hljs-keyword">DURATION</span> <span class="hljs-number">1</span>h;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span> <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">61320</span>h SHARD <span class="hljs-keyword">DURATION</span> <span class="hljs-number">24</span>h;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントアプリケーションのバックエンドは、touchデータベース内のデータベースの作成、編集、削除を担当します。</font><font style="vertical-align: inherit;">たとえば、クラウドスマートホームユーザーが料金を変更すると、バックエンドは次のコマンドを送信してストレージポリシーを変更します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"autogen"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">168</span>h SHARD <span class="hljs-keyword">DURATION</span> <span class="hljs-number">1</span>h;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーの個人アカウントからスマートホームコントローラーを削除すると、バックエンドは対応するデータベースを削除します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_cameras"</span>;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-string">"gateway_6774f85a_0a5b_4059_9b68_************_sensors"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックサーバーは、スマートホームコントローラーから情報メッセージを受信すると、タッチデータベースにデータを挿入する要求を実行します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> device_20873eb0_dd5e_4213_a175_************,<span class="hljs-keyword">class</span>=METER,label=Energy,units=kWh value_float=<span class="hljs-number">0.05</span> <span class="hljs-number">1572194550125</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのスマートホームコントローラーのZ-Waveセンサーからのデータを含むテーブルの例：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bc/ic/ht/bcicht3izpojrvpo2bsp2347p5w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドハウスの最も有用な機能の1つは、受信したデータに基づく統計の計算です。</font><font style="vertical-align: inherit;">ユーザーは、室内の平均温度、または1か月に消費した電気の量を知る必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
InfluxQL言語では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析関数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してクエリを実行できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、1週間の平均気温を計算するには、次のクエリを実行する必要があります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> MEAN(<span class="hljs-string">"value_float"</span>) <span class="hljs-keyword">FROM</span> device_63c660da_f0e8_4eca_8d5f_************ <span class="hljs-keyword">WHERE</span> label = <span class="hljs-string">'Temperature'</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-string">'2019-10-21T00:00:00.000Z'</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">time</span> &lt;= <span class="hljs-string">'2019-10-27T23:59:59.999Z'</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>d) fill(<span class="hljs-literal">null</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクエリの結果を表に示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ze/ac/wb/zeacwb7cqvnei_raajemgoebauq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の記事では、完全にクライアントアプリケーションを取り上げ、さまざまなパラメーターの統計の計算と、それに基づくテーブルとグラフの作成について詳しく検討します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドスマートホームシステムでは、InfluxDB DBMSがYandex。Cloud仮想マシンにデプロイされ、パラメーターは次のとおりです：4つのvCPUコア、20％の保証されたシェア、2 GB RAM、100 GB HDD。</font><font style="vertical-align: inherit;">この構成の計算によれば、3,000のIPカメラと5,000のZ-Waveセンサーからのセンサーデータを7年間保存するだけで十分です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、スマートホームのクラウドサービスのアーキテクチャ、ビジネスロジックサーバーのアルゴリズム、IPカメラからのメディアストリームを記録、保存、再生するためのメディアサーバーのアーキテクチャ、およびスマートホームセンサーからのデータを保存および分析するためのタッチデータベースのアーキテクチャについて検討しました。クラウドサービスシステムは、専用サーバーと仮想サーバーの両方で機能し、さまざまなホスティングサイトに配置された安定性を高めます。システムは現在試運転中です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドに保存されているデータが古いほど、ユーザーがアクセスする頻度は低くなります。クラウドサービスの次のバージョンは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">InfluxDB連続クエリ</font></a><font style="vertical-align: inherit;">を使用してデータを間引き（またはオーバーサンプリング）するメカニズムを使用することになっています</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集約機能を利用して保存されるデータの量を減らし、それによってタッチデータベースの容量を増やすため。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4x/s-/jl/4xs-jlindsjesrddtgfb8nbstxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、クラウドサービスの次のバージョンでは、この記事で説明するメディアサーバーのクラスターの原則に従って、ビジネスロジックサーバーのクラスターが実装されます。</font><font style="vertical-align: inherit;">この図は、このようなクラスターのアーキテクチャを示しています。複数のエッジサーバー（それぞれに個別のMQTTブローカーとビジネスロジックサーバーソフトウェアが含まれています）は、パフォーマンスメトリックをオリジンサーバーに送信し、オリジンサーバーが最も負荷の少ないサーバーのIPアドレスを計算します。</font><font style="vertical-align: inherit;">これにより、システムを大幅に拡張し、スマートホームの既存の制限である1000を超えることができます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja474690/index.html">コンピューターでの作業をより便利にするために、高さが可変のコンソールを作成する</a></li>
<li><a href="../ja474692/index.html">Kubernetes開発のSkaffoldレビュー</a></li>
<li><a href="../ja474694/index.html">パフォーマンステストのフレームワークを選択してねじった方法</a></li>
<li><a href="../ja474696/index.html">Seismic Challengeのオイルチケットまたはロスネフチチケット</a></li>
<li><a href="../ja474698/index.html">ユーザーインターフェイスでのモーダルウィンドウの使用</a></li>
<li><a href="../ja474702/index.html">EcmaScriptの観点からの関数型プログラミング。純粋な機能、ラムダ、免疫</a></li>
<li><a href="../ja474704/index.html">プレイボーイインタビュー：スティーブジョブズ、パート2</a></li>
<li><a href="../ja474706/index.html">TextRadarファジー検索アルゴリズム。基本的なアプローチ（パート1）</a></li>
<li><a href="../ja474708/index.html">インターネットはこれまで以上に細分化されています。毎日100万人以上の新しいユーザーが「来る」のはどこですか。パート1</a></li>
<li><a href="../ja474710/index.html">c.tech：フロントエンドのミートアップ＃2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>