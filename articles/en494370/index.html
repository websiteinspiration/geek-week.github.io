<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôâÔ∏è üèåÔ∏è üë®üèæ‚ÄçüöÄ Clean Architecture through the eyes of a Python developer üëµüèæ üóùÔ∏è ü§®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Eugene, I am a Python developer. Over the past year and a half, our team began to actively apply the principles of Clean Architectur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Clean Architecture through the eyes of a Python developer</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/494370/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! My name is Eugene, I am a Python developer. Over the past year and a half, our team began to actively apply the principles of Clean Architecture, moving away from the classic MVC model. And today I will talk about how we came to this, what it gives us, and why the direct transfer of approaches from other PLs is not always a good solution.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t_/hs/tl/t_hstlzmkevavrg4y8tazjdfu4c.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python has been my primary development tool for over seven years now. When they ask me what I like most about him, I reply that this is his </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellent readability</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The first acquaintance began with a reading of the book </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúProgramming a Collective Mind‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I was interested in the algorithms described in it, but all the examples were in a language that was not yet familiar to me then. This was not usual (Python was not yet mainstream in machine learning), listings were often written in pseudo-code or using diagrams. But after a quick introduction to the language, I appreciated its conciseness: everything was </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">easy and clear, nothing superfluous and distracting, only the very essence of the described process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The main merit of this is the amazing design of the language, the very intuitive syntactic sugar. </font><font style="vertical-align: inherit;">This expressiveness has always been appreciated in the community. </font><font style="vertical-align: inherit;">What is ‚Äú </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">import this</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù, necessarily present on the first pages of any textbook: it looks like an invisible overseer, constantly evaluates your actions. </font><font style="vertical-align: inherit;">On forums, it was worth a beginner to use somehow </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CamelCase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the variable name in the listing, so immediately the discussion angle shifted towards the idiom of the proposed code with references to PEP8.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The pursuit of elegance plus the powerful dynamism of the language have created many libraries with a truly delightful API.&nbsp;</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, Python, although powerful, is just a tool that allows you to write expressive, self-documenting code, but it </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not guarantee this</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nor does PEP8 compliance. </font><font style="vertical-align: inherit;">When our seemingly simple online store on Django begins to make money and, as a result, pump up features, at one point we understand that it is not so simple, and even making basic changes requires more and more effort, and most importantly, this trend </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is growing. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What happened and when everything went wrong?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bad code</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bad code is not one that does not follow PEP8 or does not meet the requirements of cyclomatic complexity. </font><font style="vertical-align: inherit;">Bad code is, first of all, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uncontrolled dependencies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which lead to the fact that a change in one place of the program leads to unpredictable changes in other parts. </font><font style="vertical-align: inherit;">We are losing control over the code; expanding the functionality requires a detailed study of the project. </font><font style="vertical-align: inherit;">Such code loses its flexibility and, as it were, resists making changes, while the program itself becomes ‚Äúfragile‚Äù.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The chosen architecture of the application should avoid this problem, and we are not the first to encounter this: there has been a discussion in the Java community about creating an optimal application design for a long time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Back in 2000, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Robert Martin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (also known as Uncle Bob) in his article ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design and Design Principles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù brought together five principles for designing OOP applications under the memorable acronym </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOLID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. These principles have been well received by the community and have gone far beyond the Java ecosystem. Nevertheless, they are very abstract in nature. Later there were several attempts to develop a general application design based on SOLID principles. These include: ‚ÄúHexagonal architecture‚Äù, ‚ÄúPorts and adapters‚Äù, ‚ÄúBulbous architecture‚Äù and they all have much in common, albeit different implementation details. And in 2012, an article was published by the same Robert Martin, where he proposed his own version called ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean Architecture</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c32/3a9/769/c323a9769c90f4e28a17e1d5c05ab160.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to Uncle Bob, architecture is primarily ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">borders and barriers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù, it is necessary to clearly understand the needs and limit software interfaces in order not to lose control over the application. To do this, the program </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is divided into layers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Turning from one layer to another, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be transferred </font><font style="vertical-align: inherit;">(simple structures and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objects </font><font style="vertical-align: inherit;">can act as data </font><font style="vertical-align: inherit;">) - this is the rule of boundaries. </font><font style="vertical-align: inherit;">Another most frequently quoted phrase that ‚Äúthe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application should scream</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù means that the main thing in the application is not the used framework or data storage technology, but what this application actually does, what function it performs - the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">business logic of the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application . </font><font style="vertical-align: inherit;">Therefore, the layers do not have a linear structure, but </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have a hierarchy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hence two more rules:</font></font><br>
 <br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The priority rule for the inner layer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it is the inner layer that determines the interface through which it will interact with the outside world;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependency rule</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Dependencies should be directed from the inner layer to the outer.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last rule is quite atypical in the Python world. </font><font style="vertical-align: inherit;">To apply any complicated business logic scenario, you always need to access external services (for example, a database), but to avoid this dependency, the business logic layer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must itself declare the interface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by which it will interact with the outside world. </font><font style="vertical-align: inherit;">This technique is called ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dependency inversion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù (the letter D in SOLID) and is widely used in languages ‚Äã‚Äãwith static typing. </font><font style="vertical-align: inherit;">According to Robert Martin, this is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main advantage that came with the OOP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These three rules are the essence of Clean Architecture:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Border crossing rule;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependency rule;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The priority rule of the inner layer.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The advantages of this approach include:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ease of testing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the layers are isolated, respectively, they can be tested without monkey-patching, you can granularly set the coating for different layers, depending on the degree of their importance;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simplicity of changing business rules</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since they are all collected in one place, are not spread over the project and are not mixed with low-level code;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Independence from external agents</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the presence of abstractions between business logic and the outside world in certain cases allows you to change external sources without affecting the internal layers. </font><font style="vertical-align: inherit;">It works if you have not tied the business logic to the specific features of external agents, for example, database transactions;</font></font></li>
<li><b> </b>,   ,     ,      .</li>
</ul><br>
<blockquote>     ,    .           .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.     ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Clean Architecture</a>¬ª.<br>
</blockquote><br>
<h2>  Python</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a theory, examples of practical application can be found in the original article, reports and book of Robert Martin. They rely on several common design patterns from the Java world: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adapter, Gateway, Interactor, Fasade, Repository, DTO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, what about Python? As I said, laconicism is valued in the Python community. What has taken root in others is far from the fact that it will take root with us. The first time I turned to this topic three years ago, then there were not many materials on the topic of using Clean Architecture in Python, but the first link in Google was </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leonardo Giordani </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">project</font></a><font style="vertical-align: inherit;"> : the author describes in detail the process of creating an API for a site for searching for real estate using the TDD method, applying Clean Architecture.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, despite the scrupulous explanation and following all the canons of Uncle Bob, this example is rather </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project API consists of one method - getting a list with an available filter. I think that even for a novice developer, the code for such a project will take no more than 15 lines. But in this case, he took six packets. You can refer to a not entirely successful layout, and this is true, but in any case, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is difficult for someone to explain the effectiveness of this approach</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , referring to this project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a more serious problem, if you do not read the article and immediately begin to study the project, then it is quite difficult to understand. Consider the implementation of business logic:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> rentomatic.response_objects <span class="hljs-keyword">import</span> response_objects <span class="hljs-keyword">as</span> res<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomListUseCase</span>(<span class="hljs-params">object</span>):</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, repo</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.repo = repo<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">execute</span>(<span class="hljs-params">self, request_object</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request_object:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseFailure.build_from_invalid_request_object(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request_object)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rooms = self.repo.list(filters=request_object.filters)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseSuccess(rooms)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> res.ResponseFailure.build_system_error(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"{}: {}"</span>.format(exc.__class__.__name__, <span class="hljs-string">"{}"</span>.format(exc)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The RoomListUseCase class that implements business logic (not very similar to business logic, right?) Of the project is initialized by the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><font style="vertical-align: inherit;">. But what is a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Of course, from the context, we can understand that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implements the Repository template for accessing data, if we look at the body of RoomListUseCase, we understand that it must have one list method, the input of which is a list of filters, which is not clear at the output, you need to look in ResponseSuccess. And if the scenario is more complex, with multiple access to the data source? It turns out to understand what repo is, you can </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only refer to the implementation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But where is she located? It lies in a separate module, which is in no way associated with RoomListUseCase. Thus, to understand what is happening, you need to go up to the upper level (the level of the framework) and see what is fed to the input of the class when creating the object. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You might think that I list the disadvantages of dynamic typing, but this is not entirely true. It is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dynamic typing that allows you to write expressive and compact code</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The analogy with microservices comes to mind, when we cut a monolith into microservices, the design takes on additional rigidity, since anything can be done inside the microservice (PL, frameworks, architecture), but it must comply with the declared interface. So here: when we divided our project into layers,</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The relationships between the layers must be consistent with the contract</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , while inside the layer, the contract is optional. Otherwise, you need to keep a fairly large context in your head. Remember, I said that the problem with bad code is dependencies, and so, without an explicit interface, we again slide back to where we wanted to get away - to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absence of obvious cause-effect relationships</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote>    <i>repo</i>     RoomListUseCase,    execute ‚Äî <b>   </b>.       -    ,   ,     .     -        . ,   ,    ,  <i>repo</i>   .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, at that time I abandoned Clean Architecture in a new project, again applying the classic MVC. But, having filled the next batch of cones, he returned to this idea a year later, when, at last, we began to launch services in Python 3.5+. As you know, he brought </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type annotations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data classes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Two powerful interface description tools. Based on them, I sketched a prototype of the service, and the result was already much better: the layers stopped scattering, despite the fact that there was still a lot of code, especially when integrating with the framework. But that was enough to start applying this approach in small projects. Gradually, frameworks began to appear that focused on the maximum use of type annotations: apistar (now starlette), moltenframework. The pydantic / FastAPI bundle is now common, and integration with such frameworks has become much easier. This is what the above example of restomatic / services.py would look like:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Optional, List
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span>(<span class="hljs-params">BaseModel</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;code: str<font></font>
&nbsp;&nbsp;&nbsp;size: int<font></font>
&nbsp;&nbsp;&nbsp;price: int<font></font>
&nbsp;&nbsp;&nbsp;latitude: float<font></font>
&nbsp;&nbsp;&nbsp;longitude: float<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomFilter</span>(<span class="hljs-params">BaseModel</span>):</span>
&nbsp;&nbsp;&nbsp;code: Optional[str] = <span class="hljs-literal">None</span>
&nbsp;&nbsp;&nbsp;price_min: Optional[int] = <span class="hljs-literal">None</span>
&nbsp;&nbsp;&nbsp;price_max: Optional[int] = <span class="hljs-literal">None</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomStorage</span>:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_rooms</span>(<span class="hljs-params">self, filters: RoomFilter</span>) -&gt; List[Room]:</span> ...<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoomListUseCase</span>:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, repo: RoomStorage</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.repo = repo<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">show_rooms</span>(<span class="hljs-params">self, filters: RoomFilter</span>) -&gt; List[Room]:</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rooms = self.repo.get_rooms(filters=filters)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> rooms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RoomListUseCase - a class that implements the business logic of the project. You should not pay attention to the fact that all that the show_rooms method does is call to RoomStorage (I did not come up with this example). In real life, there can also be a discount calculation, ranking a list based on advertisements, etc. However, the module is self-sufficient. If we want to use this scenario in another project, we will have to implement RoomStorage. And what is needed for this is clearly visible right from the module. Unlike the previous example, such a layer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is self-sufficient</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and when changing it is not necessary to keep the whole context in mind. From non-systemic dependencies only pydantic, why, it will become clear in the plug-in of the framework. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No dependencies</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, another way to improve code readability, not additional context, even a novice developer will be able to understand what this module does. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A business logic scenario does not have to be a class; below is an example of a similar scenario in the form of a function:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rool_list_use_case</span>(<span class="hljs-params">filters: RoomFilter, repo: RoomStorage</span>) -&gt; List[Room]:</span><font></font>
&nbsp;&nbsp;&nbsp;rooms = repo.get_rooms(filters=filters)<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> rooms</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the connection to the framework:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> List
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Depends
<span class="hljs-keyword">from</span> rentomatic <span class="hljs-keyword">import</span> services, adapters<font></font>
app = FastAPI()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_use_case</span>() -&gt; services.RoomListUseCase:</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> services.RoomListUseCase(adapters.MemoryStorage())<font></font>
<font></font>
<span class="hljs-meta">@app.post("/rooms", response_model=List[services.Room])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rooms</span>(<span class="hljs-params">filters: services.RoomFilter, use_case=Depends(<span class="hljs-params">get_use_case</span>)</span>):</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> use_case.show_rooms(filters)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the get_use_case function, FastAPI implements the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependency Injection</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pattern </font><font style="vertical-align: inherit;">. We do not need to worry about data serialization, all the work is done by FastAPI in conjunction with pydantic. Unfortunately, data are not always business logic format suitable for live broadcast in the restaurant &lt;and, on the contrary, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the business logic does not know where the data came - with slashes, request body, cookies, etc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this case, the body of the room function will have a certain conversion of input and output data, but in most cases, if we work with the API, such an easy proxy function is enough.&nbsp;</font></font><br>
<br>
<blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>   , ,    ,    RoomStorage.  ,     15 ,     ,      ,         .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I intentionally did not separate the layer of business logic, as the canonical Clean Architecture model suggests. </font><font style="vertical-align: inherit;">The Room class was supposed to be in the Entity domain region layer representing the domain region, but for this example there is no need for this. </font><font style="vertical-align: inherit;">From combining Entity and UseCase layers, the project does not cease to be a Clean Architecture implementation. </font><font style="vertical-align: inherit;">Robert Martin himself has repeatedly said that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of layers can vary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> both upward and downward. </font><font style="vertical-align: inherit;">At the same time, the project meets the main criteria of Clean Architecture:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Border crossing </font><b><font style="vertical-align: inherit;">rule</font></b><font style="vertical-align: inherit;"> : pydantic models, which are essentially DTOs, </font><b><font style="vertical-align: inherit;">cross borders</font></b><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependency rule</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the business logic layer is independent of other layers;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The priority rule for the inner layer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : it is the business logic layer that defines the interface (RoomStorage), through which the business logic interacts with the outside world.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today, several projects of our team, implemented using the described approach, are working on the prod. </font><font style="vertical-align: inherit;">I try to organize even the smallest services this way. </font><font style="vertical-align: inherit;">It trains well - questions that I hadn‚Äôt thought about before come up. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, what is business logic here? </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is far from always obvious, for example, if you are writing some kind of proxy. </font><font style="vertical-align: inherit;">Another important point is to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">learn to think differently.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. When we get a task, we usually start thinking about the frameworks, the services used, about whether there will be a need for a queue where it is better to store this data, which can be cached. In the approach dictating Clean Architecture, we must first implement the business logic and only then move on to implementing interaction with the infrastructure, since, according to Robert Martin, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main task of architecture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is to delay the moment when the connection with any The infrastructure layer will be an integral part of your application.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, I see a favorable prospect for using Clean Architecture in Python. </font><font style="vertical-align: inherit;">But the form, most likely, will be significantly different from how it is accepted in other PLs. </font><font style="vertical-align: inherit;">Over the past few years, I have seen a significant increase in interest in the topic of architecture in the community. </font><font style="vertical-align: inherit;">So, at the last PyCon there were several reports on the use of DDD, and the guys from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dry-labs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> should be noted separately </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In our company, many teams are already implementing the approach described to one degree or another. </font><font style="vertical-align: inherit;">We are all doing the same thing, we have grown, our projects have grown, the Python community has to work with this, define the common style and language that, for example, once became for all Django.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494350/index.html">March and April Online Events Digest</a></li>
<li><a href="../en494354/index.html">Knowledge and condition</a></li>
<li><a href="../en494356/index.html">Linux Newbie Aircrack-ng Tutorial</a></li>
<li><a href="../en494364/index.html">GDPR: Consent to the processing of personal data</a></li>
<li><a href="../en494366/index.html">Online mitaps for the whole week, starting from March 27 (on back, mobile, QA, PM and all)</a></li>
<li><a href="../en494372/index.html">All-Russian Verification Software - An Inside View</a></li>
<li><a href="../en494374/index.html">Electric buses and their batteries: what is lithium titanate? (Part.1)</a></li>
<li><a href="../en494376/index.html">Hierarchical Depth Buffer</a></li>
<li><a href="../en494380/index.html">Introduction to Strategic Product Management</a></li>
<li><a href="../en494384/index.html">Functional survey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>