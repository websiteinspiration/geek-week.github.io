<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   HLS en MP4 usando ffmpeg en un navegador   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="隆Hola! Durante m谩s de dos meses, en mi tiempo libre, he estado guardando una aplicaci贸n web para convertir HLS y DASH a MP4 usando emscripten y ffmpeg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HLS en MP4 usando ffmpeg en un navegador</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504722/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">隆Hola! </font><font style="vertical-align: inherit;">Durante m谩s de dos meses, en mi tiempo libre, he estado guardando una aplicaci贸n web para convertir HLS y DASH a MP4 usando emscripten y ffmpeg, desde la cual quiero compartir c贸mo logr茅 hacer esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art铆culo no citar茅 el c贸digo fuente de las ediciones y parches de ffmpeg, como </font><font style="vertical-align: inherit;">la mayor铆a de ellos se hicieron sobre mi rodilla, y no soy muy bueno en C. Pero ahora hay suficientes art铆culos para ayudarte.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci贸n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace dos a帽os ten铆a el objetivo de combinar una pista de audio y video en un solo archivo mp4. Luego me sumerg铆 en emscripten y, para lo b谩sico, encontr茅 el repositorio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del cual aprend铆 mucho. Luego, casi pude lograr el objetivo, aunque estaba muy orientado condicionalmente en C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprendiendo el c贸digo fuente, ffmpeg hizo un parche para trabajar con el sistema de archivos, donde la lectura de un archivo causaba una funci贸n asincr贸nica en js desde la cual le铆a el blob del archivo y pasaba el b煤fer, y al escribir, Funci贸n js que envi贸 datos de b煤fer al repositorio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hubo un problema con las funciones asincr贸nicas, que no pude resolver correctamente, funcionaron a trav茅s de asyncify (fastcomp), que no funcion贸 correctamente en algunos casos, a saber, la ejecuci贸n del c贸digo en wasm no se detuvo, sin esperar un resultado de la funci贸n js, eso es todo rompi贸. </font><font style="vertical-align: inherit;">Este problema se solucion贸 mediante el indicador EMTERPRETIFY_WHITELIST, que aparentemente movi贸 el c贸digo de wasm a asm al mismo tiempo y lo ralentiz贸, y fue necesario depurar la pila de llamadas y agregar una funci贸n rota a la lista con cada excepci贸n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, con tales problemas, esto no podr铆a llamarse una soluci贸n de trabajo, en la que todo esto segu铆a siendo una peque帽a demostraci贸n.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/gu/z-/y-guz-s_vswdqlgfbt8vbshowcg.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un a帽o y medio despu茅s</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu茅s de ver un informe en Google Dev Summit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre las nuevas caracter铆sticas en WebAssambly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , fui a ver c贸mo estaba emscripten y vi un mensaje:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscripten emite WebAssembly utilizando el back-end de wasm LLVM ascendente, desde la versi贸n 1.39.0 (octubre de 2019), y el antiguo backend fastcomp est谩 en desuso</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quer铆a intentar reconstruir mis formatos de repacker. </font><font style="vertical-align: inherit;">Aproximadamente una semana busqu茅 en Google c贸mo solucionar nuevos problemas de compilaci贸n y finalmente lo arm茅 todo. </font><font style="vertical-align: inherit;">Los cambios no fueron tantos, pero no fue as铆 debido al nuevo enlazador de bibliotecas, y ya desesperado por recopilar al menos algo, acabo de ver las bibliotecas problem谩ticas (result贸 que las bibliotecas est谩n conectadas y ya no es necesario se帽alarlas a mano durante el ensamblaje). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
隆Y ahora, ha llegado el momento en que se ha reunido y ganado! </font><font style="vertical-align: inherit;">El problema con el c贸digo asincr贸nico desapareci贸, no hab铆a necesidad de depurar nada, funcion贸 como deber铆a desde el principio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu铆 parece que he alcanzado mi objetivo, pero ... apareci贸 uno nuevo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescribir protocolo HTTP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal pensamiento ha estado en mi mente durante mucho tiempo. </font><font style="vertical-align: inherit;">Esto puede permitirle descargar HLS o DASH, y no solo una lista de reproducci贸n lista para usar, sino tambi茅n una transmisi贸n en vivo. </font><font style="vertical-align: inherit;">Y nunca he visto algo as铆 en Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me llev贸 unas tres semanas hacer al menos algo que funcionara conmigo con breves descansos. </font><font style="vertical-align: inherit;">Conoc铆a C (aunque no ten铆a experiencia), hab铆a muchos problemas con los punteros (es dif铆cil hacer un seguimiento de a d贸nde va, e incluso en el c贸digo de otra persona), pero algo se compil贸 sin errores. </font><font style="vertical-align: inherit;">Despu茅s de los primeros 茅xitos, esto dio a煤n m谩s entusiasmo para completar la idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo un par de semanas, y finalmente logr茅 hacer la primera iteraci贸n del protocolo http en funcionamiento, 驴y eso parece ser todo?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando lo m谩s dif铆cil ha terminado</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, ten铆a un marco listo, un peque帽o formulario html con un campo de entrada de URL y un bot贸n de inicio, b谩sicamente funcion贸. Pero a煤n era necesario escribir una extensi贸n para evitar CORS y cargar datos, hacer un almacenamiento que escribiera datos en fragmentos, hacer una interfaz con pantalla de progreso, todo esto se depur贸 para solucionar problemas en diferentes navegadores. En general, ha llegado el momento de finalmente hacer posible su uso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B谩sicamente, se realiz贸 el script de usuario, que era un proxy para buscar solicitudes de ffmpeg para descargar datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En solo un par de d铆as, estaba lista una extensi贸n para Chrome y Firefox, que mediante webRequest recopil贸 todos los enlaces hls que carga el navegador cuando mira un video.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como result贸, en Firefox, la API de extensi贸n no le permite administrar la energ铆a, desde la cual no puede evitar que la computadora se duerma, por desgracia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La extensi贸n se ve as铆: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/a6/ig/vua6igsxprko_lw12jwmstkfq48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
solo mejor茅 la p谩gina en la que el sitio era un poco, material de interfaz de usuario atornillado, finalic茅 todos los lugares que se crearon. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/s1/il/tqs1iltzg0y1-h1hmmatewctvyo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu茅s de probar diferentes formas de almacenar datos, revel茅 una serie de problemas: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Chrome los escribe en la RAM y los deja caer en el disco cuando se desborda, pero solo en OSX cuando se desborda la memoria, el sistema operativo abandona la cuenta y cierra todas las aplicaciones que estaban abiertas. Y Firefox generalmente siempre guardaba datos en la memoria. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento en cach茅</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- funciona como IndexedDb, pero despu茅s de escribir los datos, en Chrome blob permanecen en la RAM (ya sea un error o un fitcha), pero resulta que los datos se escriben en el almacenamiento en cach茅 (en el disco) y tambi茅n se caen cuando la memoria est谩 llena volumen al disco como blob. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexedDb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : funciona como un reloj, sabe c贸mo almacenar blobs, escribe datos sin adornos, pero Firefox limita estrictamente la cantidad de 2 gb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabaj茅 un poco, logr茅 hacer la funci贸n de interrumpir el proceso ffmpeg (a trav茅s de un puntero), se me ocurri贸 c贸mo elegir los formatos (ffprobe) y manejar los errores de la red. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/80/eo/ut80eoy4c02vuelxcfrx9ngswga.png"><br>
<br>
<img src="https://habrastorage.org/webt/ae/b7/qi/aeb7qikdlqnzfhuyiy6_-onisro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora, puedes probar el resultado t煤 mismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu铆</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para m铆, esto es algo indispensable cuando necesitas grabar una transmisi贸n en un tweet o descargar un VOD. </font><font style="vertical-align: inherit;">Tambi茅n funciona con una computadora port谩til, un mezclador y cualquier otro sitio que transmita contenido en HLS o DASH (por desgracia, la implementaci贸n de DASH en ffmpeg es muy condicional y es posible que Live no se descargue correctamente, ya que no tiene en cuenta el intervalo de solicitud de fragmento). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
隆Gracias por leer! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tiene preguntas sobre ffmpeg y emscripten, escriba, intentar茅 responder.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es504712/index.html">驴Por qu茅 no estoy usando SharedViewModel para fragmentos?</a></li>
<li><a href="../es504714/index.html">Ir herramientas de medici贸n de software</a></li>
<li><a href="../es504716/index.html">Acceso seguro a una casa inteligente en ausencia de una IP p煤blica (parte 1)</a></li>
<li><a href="../es504718/index.html">El resumen de materiales frescos del mundo del front-end para la 煤ltima semana No. 417 (25 al 31 de mayo de 2020)</a></li>
<li><a href="../es504720/index.html">El motor de plantillas m谩s r谩pido para PHP</a></li>
<li><a href="../es504724/index.html">Conexionismo</a></li>
<li><a href="../es504726/index.html">4 acuerdos</a></li>
<li><a href="../es504728/index.html">Lanzamiento del puerto Godot Editor para WebAssembly</a></li>
<li><a href="../es504730/index.html">Puede resultar que compre basura en Amazon, y literalmente</a></li>
<li><a href="../es504732/index.html">Solarograf铆a digital</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>