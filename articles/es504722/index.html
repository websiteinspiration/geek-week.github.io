<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚙 🍙 👓 HLS en MP4 usando ffmpeg en un navegador 🤞🏾 🏾 😶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¡Hola! Durante más de dos meses, en mi tiempo libre, he estado guardando una aplicación web para convertir HLS y DASH a MP4 usando emscripten y ffmpeg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HLS en MP4 usando ffmpeg en un navegador</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504722/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Hola! </font><font style="vertical-align: inherit;">Durante más de dos meses, en mi tiempo libre, he estado guardando una aplicación web para convertir HLS y DASH a MP4 usando emscripten y ffmpeg, desde la cual quiero compartir cómo logré hacer esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este artículo no citaré el código fuente de las ediciones y parches de ffmpeg, como </font><font style="vertical-align: inherit;">la mayoría de ellos se hicieron sobre mi rodilla, y no soy muy bueno en C. Pero ahora hay suficientes artículos para ayudarte.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducción</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace dos años tenía el objetivo de combinar una pista de audio y video en un solo archivo mp4. Luego me sumergí en emscripten y, para lo básico, encontré el repositorio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del cual aprendí mucho. Luego, casi pude lograr el objetivo, aunque estaba muy orientado condicionalmente en C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprendiendo el código fuente, ffmpeg hizo un parche para trabajar con el sistema de archivos, donde la lectura de un archivo causaba una función asincrónica en js desde la cual leía el blob del archivo y pasaba el búfer, y al escribir, Función js que envió datos de búfer al repositorio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hubo un problema con las funciones asincrónicas, que no pude resolver correctamente, funcionaron a través de asyncify (fastcomp), que no funcionó correctamente en algunos casos, a saber, la ejecución del código en wasm no se detuvo, sin esperar un resultado de la función js, eso es todo rompió. </font><font style="vertical-align: inherit;">Este problema se solucionó mediante el indicador EMTERPRETIFY_WHITELIST, que aparentemente movió el código de wasm a asm al mismo tiempo y lo ralentizó, y fue necesario depurar la pila de llamadas y agregar una función rota a la lista con cada excepción. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, con tales problemas, esto no podría llamarse una solución de trabajo, en la que todo esto seguía siendo una pequeña demostración.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/gu/z-/y-guz-s_vswdqlgfbt8vbshowcg.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un año y medio después</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de ver un informe en Google Dev Summit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre las nuevas características en WebAssambly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , fui a ver cómo estaba emscripten y vi un mensaje:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscripten emite WebAssembly utilizando el back-end de wasm LLVM ascendente, desde la versión 1.39.0 (octubre de 2019), y el antiguo backend fastcomp está en desuso</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quería intentar reconstruir mis formatos de repacker. </font><font style="vertical-align: inherit;">Aproximadamente una semana busqué en Google cómo solucionar nuevos problemas de compilación y finalmente lo armé todo. </font><font style="vertical-align: inherit;">Los cambios no fueron tantos, pero no fue así debido al nuevo enlazador de bibliotecas, y ya desesperado por recopilar al menos algo, acabo de ver las bibliotecas problemáticas (resultó que las bibliotecas están conectadas y ya no es necesario señalarlas a mano durante el ensamblaje). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Y ahora, ha llegado el momento en que se ha reunido y ganado! </font><font style="vertical-align: inherit;">El problema con el código asincrónico desapareció, no había necesidad de depurar nada, funcionó como debería desde el principio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí parece que he alcanzado mi objetivo, pero ... apareció uno nuevo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescribir protocolo HTTP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal pensamiento ha estado en mi mente durante mucho tiempo. </font><font style="vertical-align: inherit;">Esto puede permitirle descargar HLS o DASH, y no solo una lista de reproducción lista para usar, sino también una transmisión en vivo. </font><font style="vertical-align: inherit;">Y nunca he visto algo así en Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me llevó unas tres semanas hacer al menos algo que funcionara conmigo con breves descansos. </font><font style="vertical-align: inherit;">Conocía C (aunque no tenía experiencia), había muchos problemas con los punteros (es difícil hacer un seguimiento de a dónde va, e incluso en el código de otra persona), pero algo se compiló sin errores. </font><font style="vertical-align: inherit;">Después de los primeros éxitos, esto dio aún más entusiasmo para completar la idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo un par de semanas, y finalmente logré hacer la primera iteración del protocolo http en funcionamiento, ¿y eso parece ser todo?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando lo más difícil ha terminado</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, tenía un marco listo, un pequeño formulario html con un campo de entrada de URL y un botón de inicio, básicamente funcionó. Pero aún era necesario escribir una extensión para evitar CORS y cargar datos, hacer un almacenamiento que escribiera datos en fragmentos, hacer una interfaz con pantalla de progreso, todo esto se depuró para solucionar problemas en diferentes navegadores. En general, ha llegado el momento de finalmente hacer posible su uso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Básicamente, se realizó el script de usuario, que era un proxy para buscar solicitudes de ffmpeg para descargar datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En solo un par de días, estaba lista una extensión para Chrome y Firefox, que mediante webRequest recopiló todos los enlaces hls que carga el navegador cuando mira un video.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultó, en Firefox, la API de extensión no le permite administrar la energía, desde la cual no puede evitar que la computadora se duerma, por desgracia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La extensión se ve así: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/a6/ig/vua6igsxprko_lw12jwmstkfq48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
solo mejoré la página en la que el sitio era un poco, material de interfaz de usuario atornillado, finalicé todos los lugares que se crearon. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/s1/il/tqs1iltzg0y1-h1hmmatewctvyo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de probar diferentes formas de almacenar datos, revelé una serie de problemas: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Chrome los escribe en la RAM y los deja caer en el disco cuando se desborda, pero solo en OSX cuando se desborda la memoria, el sistema operativo abandona la cuenta y cierra todas las aplicaciones que estaban abiertas. Y Firefox generalmente siempre guardaba datos en la memoria. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento en caché</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- funciona como IndexedDb, pero después de escribir los datos, en Chrome blob permanecen en la RAM (ya sea un error o un fitcha), pero resulta que los datos se escriben en el almacenamiento en caché (en el disco) y también se caen cuando la memoria está llena volumen al disco como blob. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexedDb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : funciona como un reloj, sabe cómo almacenar blobs, escribe datos sin adornos, pero Firefox limita estrictamente la cantidad de 2 gb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabajé un poco, logré hacer la función de interrumpir el proceso ffmpeg (a través de un puntero), se me ocurrió cómo elegir los formatos (ffprobe) y manejar los errores de la red. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/80/eo/ut80eoy4c02vuelxcfrx9ngswga.png"><br>
<br>
<img src="https://habrastorage.org/webt/ae/b7/qi/aeb7qikdlqnzfhuyiy6_-onisro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora, puedes probar el resultado tú mismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mí, esto es algo indispensable cuando necesitas grabar una transmisión en un tweet o descargar un VOD. </font><font style="vertical-align: inherit;">También funciona con una computadora portátil, un mezclador y cualquier otro sitio que transmita contenido en HLS o DASH (por desgracia, la implementación de DASH en ffmpeg es muy condicional y es posible que Live no se descargue correctamente, ya que no tiene en cuenta el intervalo de solicitud de fragmento). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Gracias por leer! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tiene preguntas sobre ffmpeg y emscripten, escriba, intentaré responder.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es504712/index.html">¿Por qué no estoy usando SharedViewModel para fragmentos?</a></li>
<li><a href="../es504714/index.html">Ir herramientas de medición de software</a></li>
<li><a href="../es504716/index.html">Acceso seguro a una casa inteligente en ausencia de una IP pública (parte 1)</a></li>
<li><a href="../es504718/index.html">El resumen de materiales frescos del mundo del front-end para la última semana No. 417 (25 al 31 de mayo de 2020)</a></li>
<li><a href="../es504720/index.html">El motor de plantillas más rápido para PHP</a></li>
<li><a href="../es504724/index.html">Conexionismo</a></li>
<li><a href="../es504726/index.html">4 acuerdos</a></li>
<li><a href="../es504728/index.html">Lanzamiento del puerto Godot Editor para WebAssembly</a></li>
<li><a href="../es504730/index.html">Puede resultar que compre basura en Amazon, y literalmente</a></li>
<li><a href="../es504732/index.html">Solarografía digital</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>