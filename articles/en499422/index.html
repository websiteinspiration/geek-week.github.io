<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå°Ô∏è ‚è≤Ô∏è ‚õπüèæ Teleport the process to another computer!‚Äâ üé¥ ü•™ üé•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, a colleague shared his thoughts about the API for distributed computing clusters, and I jokingly answered: ‚ÄúObviously, an ideal API would be a s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Teleport the process to another computer!‚Äâ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/499422/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once, a colleague shared his thoughts about the API for distributed computing clusters, and I jokingly answered: ‚ÄúObviously, an ideal API would be a simple call </font></font><code>telefork()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that your process wakes up on each cluster machine, returning the value of the instance ID.‚Äù But in the end, this idea took possession of me. I could not understand why it is so stupid and simple, much simpler than any API for remote work, and why computer systems do not seem to be capable of such. I also seemed to understand how this can be implemented, and I already had a good name, which is the most difficult part of any project. So I got to work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Over the first weekend, he made a basic prototype, and the second weekend brought a demo that could</font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process to a giant virtual machine in the cloud, drive off the rendering of path tracing on multiple cores, and then telefork the process back. </font><font style="vertical-align: inherit;">All this is wrapped in a simple API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The video shows that rendering on a 64-core VM in the cloud completes in 8 seconds (plus 6 seconds for telefork back and forth). </font><font style="vertical-align: inherit;">The same rendering locally in a container on my laptop takes 40 seconds:</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://thume.ca/assets/postassets/telefork/telefork-small.mp4" type="video/mp4"></video></div></div></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How is it possible to teleport the process? </font><font style="vertical-align: inherit;">Here's what this article should explain! </font><font style="vertical-align: inherit;">The basic idea is that at a low level, the Linux process has only a few components. </font><font style="vertical-align: inherit;">You just need a way to restore each of them from the donor, transfer it over the network and copy it to the cloned process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You might think: ‚ÄúBut how to replicate [something difficult, such as a TCP connection]?‚Äù </font><font style="vertical-align: inherit;">Really. </font><font style="vertical-align: inherit;">In fact, we don‚Äôt tolerate such complicated things to keep the code simple. </font><font style="vertical-align: inherit;">That is, it's </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">just a fun technical demo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that probably shouldn't be used in production. </font><font style="vertical-align: inherit;">But she still knows how to teleport a wide class of mostly computational tasks!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does it look like</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I implemented the code as a Rust library, but theoretically you can wrap the program in the C API and then run through the FFI bindings to teleport even the Python process. </font><font style="vertical-align: inherit;">The implementation is only about 500 lines of code (plus 200 lines of comments):</font></font><br>
<br>
<pre><code class="rust hljs"><span class="hljs-keyword">use</span> telefork::{telefork, TeleforkLocation};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> args: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt; = std::env::args().collect();
    <span class="hljs-keyword">let</span> destination = args.get(<span class="hljs-number">1</span>).expect(<span class="hljs-string">"expected arg: address of teleserver"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> stream = std::net::TcpStream::connect(destination).unwrap();
    <span class="hljs-keyword">match</span> telefork(&amp;<span class="hljs-keyword">mut</span> stream).unwrap() {<font></font>
        TeleforkLocation::Child(val) =&gt; {<font></font>
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"I teleported to another computer and was passed {}!"</span>, val);<font></font>
        }<font></font>
        TeleforkLocation::Parent =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Done sending!"</span>),<font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I also wrote a helper called </font></font><code>yoyo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">teleforks to the server, performs the transmitted closure, and then teleforks back. </font><font style="vertical-align: inherit;">This creates the illusion that you can easily run a piece of code on a remote server, for example, with much greater processing power.</font></font><br>
<br>
<pre><code class="rust hljs"><span class="hljs-comment">// load the scene locally, this might require loading local scene files to memory</span>
<span class="hljs-keyword">let</span> scene = create_scene();
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> backbuffer = <span class="hljs-built_in">vec!</span>[Vec3::new(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>); width * height];<font></font>
telefork::yoyo(destination, || {<font></font>
  <span class="hljs-comment">// do a big ray tracing job on the remote server with many cores!</span>
  render_scene(&amp;scene, width, height, &amp;<span class="hljs-keyword">mut</span> backbuffer);<font></font>
});<font></font>
<span class="hljs-comment">// write out the result to the local file system</span>
save_png_file(width, height, &amp;backbuffer);</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux process anatomy</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what the process looks like in Linux (on which the mother host OS is running </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/a2e/366/42ca2e366497bb88024cb351a0cb9e62.png"><br>
<br>
<ul>
<li><b> </b> (memory mappings):         ,    .    ¬´¬ª  4 .         <code>/proc/&lt;pid&gt;/maps</code>.        ,   ,    .<br>
<br>
<ul>
<li>     ,         ,          (   ).</li>
</ul></li>
<li><b></b>:      ,       .     , , -  ,    ,      ,   .              ,    .<br>
</li>
<li><b> </b>:     ,         .   -    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>.      ,       ,    ,  TCP-,  .<br>
<ul>
<li>          .      stdin/stdout/stderr,       0, 1  2.<br>
</li>
<li>  ,     ,    ,     .</li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Miscellaneous</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : There are some other parts of the process state that vary in replication complexity. </font><font style="vertical-align: inherit;">But in most cases, they do not matter, for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (heap pointer). </font><font style="vertical-align: inherit;">Some of them can be restored only with the help of strange tricks or special system calls like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR_SET_MM_MAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which complicates the recovery.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the basic implementation </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be done with a simple mapping of memory and registers of the main threads. </font><font style="vertical-align: inherit;">This should be enough for simple programs that mainly perform calculations without interacting with OS resources, such as files (in principle, for teleportation it is enough to open the file in the system and close it before calling </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to telefork a process</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was not the first to think about re-creating processes on another machine. So, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rr debugging and recording debugger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does very similar things </font><font style="vertical-align: inherit;">. I sent a </font><font style="vertical-align: inherit;">few questions </font><font style="vertical-align: inherit;">to the author of this program </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@rocallahan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and he told me about the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRIU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> system </font><font style="vertical-align: inherit;">for ‚Äúhot‚Äù migration of containers between hosts. CRIU can transfer the Linux process to another system, supports the recovery of all kinds of file descriptors and other states, however, the code is really complex and uses many system calls that require special kernel assemblies and root permissions. Using the link from the CRIU wiki page, I found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMTCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> created for snapshots of distributed tasks on supercomputers so that they can be restarted later, and this program</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code turned out to be simpler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These examples did not force me to abandon attempts to implement my own system, since these are extremely complex programs that require special runners and infrastructure, and I wanted to implement the simplest possible teleportation of processes as a library call. So I studied the fragments of the source code </font></font><code>rr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, CRIU, DMTCP, and some ptrace examples - and put together my own procedure </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. My method works in its own way, it is a mishmash of various techniques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To teleport a process, you need to do some work in the original process that calls </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and some work on the side of the function call, which receives the streaming process on the server and recreates it from the stream (function</font></font><code>telepad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">They can happen at the same time, but all serialization can also be done before downloading, for example, dropping it to a file, and later downloading it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is a simplified overview of both processes. </font><font style="vertical-align: inherit;">If you want to understand in detail, I suggest reading the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It is contained in one file and tightly commented out to read in order and understand how everything works.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Submitting a process using </font></font><code>telefork</code></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receives a stream with write capability, by which it transfers the entire state of its process.</font></font><br>
<br>
<ol>
<li><b> </b>  ¬´¬ª .       ,        ,   .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">fork</a>       .<br>
</li>
<li><b>   </b>.  <code>/proc/&lt;pid&gt;/maps</code> ,    .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">proc_maps crate</a>.<br>
</li>
<li><b>     </b>.    DMTCP,         ,        ,       .   ,   <code>[vdso]</code>,      , ,    .<br>
</li>
<li><b>         </b>   .    ,    ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">process_vm_readv</a>        ,       .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfer Registers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I use the option </font></font><code>PTRACE_GETREGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ptrace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> system call </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It allows you to get all the values ‚Äã‚Äãof the register of the child process. </font><font style="vertical-align: inherit;">Then I just write them in a message on the channel.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running system calls in a child process</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To turn the target process into a copy of the incoming process, you will need to force the process to execute a bunch of system calls on itself, without access to any code, because we deleted everything. </font><font style="vertical-align: inherit;">We make remote system calls using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ptrace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a universal system call for manipulating and checking other processes:</font></font><br>
<br>
<ol>
<li><b>  syscall</b>.        syscall   ,      .    ,      <code>process_vm_readv</code>      <code>[vdso]</code> , ,   ,      syscall    Linux,       .         ,    <code>[vdso]</code>.<br>
</li>
<li><b> </b>    ,  <code>PTRACE_SETREGS</code>.      syscall,  <code>rax</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Linux</a>,      <code>rdi, rsi, rdx, r10, r8, r9</code>.<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take one step</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the parameter </font></font><code>PTRACE_SINGLESTEP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to execute the syscall command.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read the registers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with </font></font><code>PTRACE_GETREGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to restore the syscall return value and see if it succeeded.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process acceptance in </font></font><code>telepad</code></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using this and the already described primitives, we can recreate the process:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fork a frozen child process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Similar to sending, but this time we need a child process that we can manipulate to turn it into a clone of the transferred process.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check memory allocation cards</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This time we need to know all the existing memory allocation cards in order to remove them and make room for the incoming process.</font></font><br>
</li>
<li><b>  </b>.         ,    <code>munmap</code>.<br>
</li>
<li><b>   </b>.        <code>mremap</code>,      .<br>
</li>
<li><b>    </b>.   <code>mmap</code>   ,   <code>process_vm_writev</code>      .<br>
</li>
<li><b> </b>.  <code>PTRACE_SETREGS</code>     ,   ,   <code>rax</code>.     <code>raise(SIGSTOP)</code>,    .     ,    <code>telepad</code>.<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An arbitrary value is used so that the telefork server can transfer the file descriptor of the TCP connection that the process entered, and can send data back or, in case </font></font><code>yoyo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, teleport back to the same connection.</font></font></li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restart the process</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the new content using </font></font><code>PTRACE_DETACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More competent implementation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some parts of my telefork implementation are not perfectly designed. </font><font style="vertical-align: inherit;">I know how to fix them, but in the current form I like the system, and sometimes they are really difficult to fix. </font><font style="vertical-align: inherit;">Here are some interesting examples:</font></font><br>
<br>
<ul>
<li>      (vDSO).   <code>mremap</code>  vDSO   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> DMTCP</a>,  ,            .      vDSO,            .        -  ,      CPU  glibc      vDSO   .      ,      vDSO,     syscall,    <code>rr</code>,     vDSO     vDSO   .<br>
</li>
<li> <code>brk</code>   .      DMTCP,       ,   <code>brk</code> ,  <code>brk</code> .  ,      ,&nbsp;‚Äî  <code>PR_SET_MM_MAP</code>,          .<br>
</li>
<li>   .     Rust ¬´ ¬ª, ,     FS  GS, ,   ,  -  <code>glibc</code>  pid  tid,         .    CRIU,        PID  TID    .<br>
</li>
<li>   .             , , ,       /   ,     /       FUSE.           ,    TCP-,  DMTCP  CRIU          ,    <code>perf_event_open</code>.<br>
</li>
<li>  .  <code>fork()</code>  Unix   ,           ,           .</li>
</ul><br>
<h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think you already understood that with the right low-level interfaces, you can implement some crazy things that seemed impossible to someone. </font><font style="vertical-align: inherit;">Here are some thoughts on how to develop the basic ideas of telefork. </font><font style="vertical-align: inherit;">Although much of the above can probably be fully implemented only on a completely new or fixed kernel:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster telefork</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The initial source of inspiration for telefork was the idea of ‚Äã‚Äãstreaming a process to all machines in a computing cluster. </font><font style="vertical-align: inherit;">It may even turn out to implement UDP multicast or peer-to-peer methods to speed up distribution across the entire cluster. </font><font style="vertical-align: inherit;">You probably also want to have communication primitives.</font></font><br>
</li>
<li><b>  </b>. CRIU    ,   -   <code>userfaultfd</code>.              ,   <code>SIGSEGV</code>  <code>mmap</code>.        ,    ,        &nbsp;‚Äî     .<br>
</li>
<li><b> !</b>      ,        .    <code>userfaultfd</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">      userfaultfd,       </a>,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">MESI</a>,        .         ,     ,          .  &nbsp;‚Äî    ,            .    ,       ,    ,    .      :     syscall,     -,   syscall,     .      ,           .    ,      ,     ,    .  ,       ,         .          ,     ,  (   ,      )        ,       .</li>
</ul><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I really like it a lot, because here is an example of one of my favorite techniques - diving into a lesser-known layer of abstraction, which relatively easily fulfills what we thought was almost impossible. Teleporting computations may seem impossible or very difficult. You might think that it would require methods such as serializing the entire state, copying the binary executable to the remote machine, and launching it there with special command line flags to reload the state. But no, everything is much simpler. Under your favorite programming language lies an abstraction layer where you can choose a fairly simple subset of functions - and over the weekend implement teleportation of most pure calculations in any programming language in 500 lines of code. I thinkthat such diving to another level of abstraction often leads to simpler and more universal solutions. Another of my projects like this one is</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numderline</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, such projects seem to be extreme hacks, and to a large extent it is. They do things like nobody expects, and when they break, they do it at the level of abstraction, at which similar programs should not work ‚Äî for example, your file descriptors mysteriously disappear. But sometimes you can correctly set the level of abstraction and encode any possible situations, so that in the end everything will work smoothly and magically. I think the good examples here are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (although telefork managed to sack it) and cloud migration of virtual machines in real time (in fact, telefork at the hypervisor level).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I also like to present these things as ideas for alternative ways of working computer systems. </font><font style="vertical-align: inherit;">Why are our cluster computing APIs so much more complicated than a simple program that translates functions into a cluster? </font><font style="vertical-align: inherit;">Why is network system programming so much more complicated than multithreaded? </font><font style="vertical-align: inherit;">Of course, you can give all sorts of good reasons, but they are usually based on how difficult it is to make an example of existing systems. </font><font style="vertical-align: inherit;">Or maybe with the right abstraction or with sufficient effort, everything will work easily and seamlessly? </font><font style="vertical-align: inherit;">Fundamentally, there is nothing impossible.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499404/index.html">PostgreSQL load management, when one server is not enough. Andrey Salnikov</a></li>
<li><a href="../en499408/index.html">Pitfalls of testing Kafka Streams</a></li>
<li><a href="../en499410/index.html">Automated performance-optimized MySQL configuration file creation</a></li>
<li><a href="../en499412/index.html">The best health insurance is to think with your head. Application idea</a></li>
<li><a href="../en499418/index.html">The futurism we deserve</a></li>
<li><a href="../en499426/index.html">It seems to me that Russian VPS / VDS hosting comes from hell (and yes, we mow too)</a></li>
<li><a href="../en499428/index.html">Morpheus Red Cloud Management Tablet</a></li>
<li><a href="../en499430/index.html">Googled too?</a></li>
<li><a href="../en499432/index.html">Autonomy of Unit Tests in PHPUnit</a></li>
<li><a href="../en499434/index.html">How to implement knowledge management: benefit ‚Äúpouches‚Äù, ‚Äúparrot fines‚Äù and clip thinking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>