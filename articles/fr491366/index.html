<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐯 📂 🍶 PostgreSQL Antipatterns: combattre les hordes de «morts» 🤜🏼 🏰 ✏️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les fonctionnalités des mécanismes internes de PostgreSQL lui permettent d'être très rapide dans certaines situations et moins rapide dans d'autres. A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Antipatterns: combattre les hordes de «morts»</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/491366/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les fonctionnalités des mécanismes internes de PostgreSQL lui permettent d'être très rapide dans certaines situations et moins rapide dans d'autres. </font><font style="vertical-align: inherit;">Aujourd'hui, nous nous attarderons sur l'exemple classique d'un conflit entre le fonctionnement du SGBD et ce que le développeur en fait - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE vs MVCC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tracez brièvement un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellent article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsqu'une ligne est modifiée avec la commande UPDATE, deux opérations sont réellement effectuées: DELETE et INSERT. </font><font style="vertical-align: inherit;">Dans la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version actuelle de la ligne</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , xmax est défini comme égal au numéro de la transaction qui a effectué UPDATE. </font><font style="vertical-align: inherit;">Ensuite, une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouvelle version de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la même ligne est créée; </font><font style="vertical-align: inherit;">sa valeur xmin correspond à la valeur xmax de la version précédente.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelque temps après la fin de cette transaction, l'ancienne ou la nouvelle version, selon celle-ci </font></font><code>COMMIT/ROOLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sera reconnue comme </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«morte» (tuples morts)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors du passage </font></font><code>VACUUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans la table et nettoyée. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/dw/rf/lidwrftvhlmkueb4c8rak38feh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cela ne se produira pas tout de suite, mais les problèmes avec les «morts» peuvent être acquis très rapidement - avec des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mises à jour</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> multiples ou en </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">masse des enregistrements</font></a><font style="vertical-align: inherit;"> dans une grande table, et un peu plus tard, face à une situation que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM ne pourra pas aider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: J'aime le déplacer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que votre méthode sur la logique métier fonctionne pour elle-même et se rend soudain compte qu'il serait nécessaire de mettre à jour le champ X dans un enregistrement:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis, au fur et à mesure de sa progression, il découvre que le champ Y doit également être mis à jour:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> Y = &lt;newY&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... et puis aussi Z - pourquoi chier quelque chose?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> Z = &lt;newZ&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Combien de versions de cet enregistrement ont maintenant dans la base de données? </font><font style="vertical-align: inherit;">Ouais, 4 pièces! </font><font style="vertical-align: inherit;">Parmi ceux-ci, un est pertinent, et 3 devront ramasser [auto] VIDE pour vous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ne fais pas ça! </font><font style="vertical-align: inherit;">Utilisez la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise à jour de tous les champs dans une seule demande</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - presque toujours la logique de la méthode peut être modifiée comme ceci:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt;, Y = &lt;newY&gt;, Z = &lt;newZ&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: Utilisez EST DISTINCT DE, Luke!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, vous vouliez toujours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">jour de très nombreux enregistrements dans la table</font></a><font style="vertical-align: inherit;"> (lors de l'utilisation d'un script ou d'un convertisseur par exemple). </font><font style="vertical-align: inherit;">Et quelque chose comme ça vole dans le script:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk <span class="hljs-keyword">BETWEEN</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> $<span class="hljs-number">2</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans environ ce formulaire, une requête est rencontrée assez souvent et presque toujours pour ne pas remplir un nouveau champ vide, mais pour corriger certaines erreurs dans les données. </font><font style="vertical-align: inherit;">De plus, l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactitude des données déjà existantes n'est pas du tout prise en compte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - mais en vain! </font><font style="vertical-align: inherit;">Autrement dit, le dossier est en cours de réécriture, même si c'était exactement ce que je voulais - pourquoi? </font><font style="vertical-align: inherit;">Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk <span class="hljs-keyword">BETWEEN</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> $<span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> X <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> &lt;newX&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup de gens ne sont pas conscients de l'existence d'un opérateur aussi merveilleux, alors voici une feuille de triche pour d' </font></font><b><code>IS DISTINCT FROM</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autres opérateurs logiques pour vous aider:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/a3/ci/jsa3ciwigwxqvlfcpyk0vs-zwqk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... et un peu sur les opérations sur les </font></font><code>ROW()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expressions </font><font style="vertical-align: inherit;">complexes </font><font style="vertical-align: inherit;">:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xn/3q/4t/xn3q4tiidkye-tdj7-uebntop7a.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: Je reconnais ma chérie en ... bloquant</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deux processus parallèles identiques</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dont chacun est destiné à la marque d'enregistrement, qu'il est "en fonctionnement":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> processing = <span class="hljs-literal">TRUE</span> <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même si ces processus font substantiellement des choses indépendamment les uns des autres, mais dans le cadre d'un identifiant, sur cette demande, le deuxième client se "verrouille" jusqu'à ce que la première transaction soit terminée. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution n ° 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la tâche est réduite à la précédente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez simplement à nouveau </font></font><b><code>IS DISTINCT FROM</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> processing = <span class="hljs-literal">TRUE</span> <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> processing <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">TRUE</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce formulaire, la deuxième demande ne changera tout simplement rien dans la base de données, elle est déjà «tout est comme il se doit» - par conséquent, le blocage ne se produira pas. </font><font style="vertical-align: inherit;">De plus, le fait de la "non-existence" de l'enregistrement est déjà traité dans l'algorithme appliqué. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décision numéro 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : verrous consultatifs </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un grand sujet pour un article séparé dans lequel vous pouvez lire sur les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">méthodes d'application et le "rake" des verrous de recommandation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution n ° 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : sans [d] appels intelligents </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais exactement, exactement, vous devriez avoir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un travail simultané avec le même enregistrement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">Ou avez-vous toujours gâché les algorithmes d'appel de logique métier côté client, par exemple? </font><font style="vertical-align: inherit;">Et si vous y pensez? ..</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491348/index.html">Test en ligne - Êtes-vous sérieux?</a></li>
<li><a href="../fr491350/index.html">Mitap Android à Redmadrobot le 30 avril</a></li>
<li><a href="../fr491356/index.html">Le Big Data au service du Ministère de la Santé ou comment les technologies modernes contribuent à lutter contre la maladie</a></li>
<li><a href="../fr491358/index.html">The Witcher paye avec une pièce frappée - nous analysons la chanson principale de la série The Witcher en anglais</a></li>
<li><a href="../fr491362/index.html">6 mars Java Digest</a></li>
<li><a href="../fr491372/index.html">Le Meetup Robot Operating System - 2020 se tiendra à Moscou du 18 au 19 avril 2020</a></li>
<li><a href="../fr491376/index.html">Étude étude</a></li>
<li><a href="../fr491382/index.html">Impôt sur le revenu de Google au Bélarus</a></li>
<li><a href="../fr491384/index.html">Sécurité de l'information Plateforme automatisée de réponse aux incidents</a></li>
<li><a href="../fr491388/index.html">Éloignez-vous de jQuery à Svelte, pour ainsi dire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>