<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüíª üîî üë≤üèº .NET Core: x86_64 Intrinsics on Virtual Machines üåßÔ∏è üëë ü§Ωüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We live in an era of x86 architecture dominance. All x86-compatible processors are similar, but all are slightly different. And not only the manufactu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>.NET Core: x86_64 Intrinsics on Virtual Machines</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495462/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We live in an era of x86 architecture dominance. All x86-compatible processors are similar, but all are slightly different. And not only the manufacturer, the frequency and the number of cores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The x86 architecture during its existence (and popularity) has experienced many major updates (for example, the extension to 64 bits - x86_64) and the addition of ‚Äúextended instruction sets‚Äù. Compilers, which by default generate code that is as common as possible for all processors, also have to adapt to this. But among the extended instructions, there are many interesting and useful. For example, in chess programs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instructions for working with bits </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">are often used</font></a><font style="vertical-align: inherit;"> : POPCNT, BSF / BSR (or more recent analogues of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TZCNT / LZCNT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), PDEP, BSWAP, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In C and C ++ compilers, explicit access to such instructions is implemented through "intrinsic functions of this processor". </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example1 </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example2</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
There was no such convenient access for .NET and C #, so once </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">upon a</font></a><font style="vertical-align: inherit;"> time I made my own wrapper, which provided emulation of such functions, but if the CPU supported them, I replaced their call directly in the calling code. Fortunately, most intrinsics I need were placed in 5 bytes of the CALL opcode. Details can be read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the hub at this link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many years have passed since then, in .NET normal intrinsics never appeared. But .NET Core came out, in which the situation was corrected. First came the vector instructions, then almost the entire * set of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.Intrinsics.X86</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* - there are no "outdated" BSF and BSR.</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And everything seemed to be nice and convenient. Except that the definition of support for each set of instructions has always </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">been confusing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (some are included immediately by the sets, for some there are separate flags). So .NET Core confused us even more with the fact that there are also some dependencies between the "allowed" sets.</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This surfaced when I tried to run the code on a virtual machine with the KVM hypervisor: errors fell in </font></font><code>System.PlatformNotSupportedException: Operation is not supported on this platform at System.Runtime.Intrinsics.X86.Bmi1.X64.TrailingZeroCount(UInt64 value)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Similarly for System.Runtime.Intrinsics.X86.Popcnt.X64.PopCount. But if for POPCNT it was possible to put a fairly obvious flag in the parameters of virtualization, then TZCNT led me into a dead end. In the following picture, the output of the tool that checks the availability of intrinsics in netcore (code and binary at the end of the article) and the well-known CPU-Z: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/ag/hf/nqaghfegcpctyxd2v5ajx-j1uqo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the output of the tool taken from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSDN page about CPUID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/c3/40/ftc340p3u_wetlxem38ekx2adji.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that the processor reports support for everything required, the instruction </font></font><code>Intrinsics.X86.Bmi1.X64.TrailingZeroCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">still continued to fall with execution </font></font><code>System.PlatformNotSupportedException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To figure this out, we need to look at the processor through the eyes of NETCore. Which sources lie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Let's look for cupid there and go out to the method. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">EEJitManager::SetCpuInfo</a>()</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are a lot of different conditions in it, and some of them are nested. I took this method and copied it into an empty project. In addition to it, I had to pick up a couple of other methods and a whole assembler file ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to add asm to a fresh studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Execution result: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/el/ef/yj/elefyj0jemau4g5xysaupsusymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the flag </font></font><code>InstructionSet_BMI1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is still set (although some others are not set). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look for this flag in the repository, you can come across </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (resultflags.HasInstructionSet(InstructionSet_BMI1) &amp;&amp; !resultflags.HasInstructionSet(InstructionSet_AVX))<font></font>
    resultflags.RemoveInstructionSet(InstructionSet_BMI1);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, she is our addiction! </font><font style="vertical-align: inherit;">If AVX is not defined, then BMI1 (and some other sets) is disabled. </font><font style="vertical-align: inherit;">What is the logic, it‚Äôs not clear to me yet, but we hope that it still exists. </font><font style="vertical-align: inherit;">Now it remains to understand why cpu-z and other tools see AVX, but netcore does not. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see how the output of our tool on different processors differs:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;diff a b<font></font>
7c7,8<font></font>
&lt; Test ((buffer[8] &amp; 0x02) != 0) -&gt; 0<font></font>
---<font></font>
&gt; Test ((buffer[8] &amp; 0x02) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_PCLMULQDQ<font></font>
18c19,32<font></font>
&lt; Test ((buffer[11] &amp; 0x18) == 0x18) -&gt; 0<font></font>
---<font></font>
&gt; Test ((buffer[11] &amp; 0x18) == 0x18) -&gt; 1<font></font>
&gt; Test (hMod == NULL) -&gt; 0<font></font>
&gt; Test (pfnGetEnabledXStateFeatures == NULL) -&gt; 0<font></font>
&gt; Test ((FeatureMask &amp; XSTATE_MASK_AVX) == 0) -&gt; 0<font></font>
&gt; Test (DoesOSSupportAVX() &amp;&amp; (xmmYmmStateSupport() == 1)) -&gt; 1<font></font>
&gt; Test (hMod == NULL) -&gt; 0<font></font>
&gt; Test (pfnGetEnabledXStateFeatures == NULL) -&gt; 0<font></font>
&gt; Test ((FeatureMask &amp; XSTATE_MASK_AVX) == 0) -&gt; 0<font></font>
&gt; ==&gt; Set InstructionSet_AVX<font></font>
&gt; Test ((buffer[9] &amp; 0x10) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_FMA<font></font>
&gt; Test (maxCpuId &gt;= 0x07) -&gt; 1<font></font>
&gt; Test ((buffer[4] &amp; 0x20) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_AVX2</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The check buffer [8] &amp; 0x02 fails, this is PCLMULQDQ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buffer [11] &amp; 0x18 fails, it is AVX &amp; OSXSAVE, AVX is already set (CPU-Z sees this), OSXSAVE is needed</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And behind it are other checks that lead to the InstructionSet_AVX flag</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So what to do with the viral? </font><font style="vertical-align: inherit;">If possible, it is best to put </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libvirt.cpu_mode in host-passthrough or host-model</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if this is not possible, then you have to add all the soup from the instructions, in particular </font></font><code>ssse3, sse4.1, sse4.2, sse4a, popcnt, abm, bmi1, bmi2, avx, avx2, osxsave, xsave, pclmulqdq</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here I say hello and thank you</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vdsina_m</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And you can check your host or virtual machine for instruction support and how .NET Core looks at it using this tool: (for now, zip, I'll post it to the github later).</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binaries </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">core_intrin_check.bin.win64.zip</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">core_intrin_check.source.zip</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495452/index.html">How to prepare a site for load growth</a></li>
<li><a href="../en495454/index.html">Brief Introduction to BPF and eBPF</a></li>
<li><a href="../en495456/index.html">Review of 14 fresh plugins for Figma that will help increase productivity while we all</a></li>
<li><a href="../en495458/index.html">How to write code when children run around you and ask: ‚ÄúWhat will you work for?‚Äù</a></li>
<li><a href="../en495460/index.html">A gas bubble 22,000 times the size of the Earth exploded on Uranus</a></li>
<li><a href="../en495464/index.html">Information message 404 - not only a mistake, but also a holiday</a></li>
<li><a href="../en495466/index.html">Hacker traps. Detect hacking early with Canarytokens</a></li>
<li><a href="../en495468/index.html">Price tag recognition algorithm that works even on data collection terminals</a></li>
<li><a href="../en495472/index.html">Switching to vegetarianism will not prevent people from becoming infected from diseases like COVID-19</a></li>
<li><a href="../en495474/index.html">DataGrip 2020.1: Launch configurations, export to Excel, results in the editor and more</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>