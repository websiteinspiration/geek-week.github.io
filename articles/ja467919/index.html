<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤦🏾 🍲 👩🏽‍🤝‍👨🏿 リクエストのバッチ処理の問題とその解決策（パート2） 👩‍🏫 🧓🏾 🈚️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="これは、「リクエストのバッチ処理の問題とその解決策」の続きです。最初の部分は、問題の本質とその解決策へのアプローチを詳細に説明しているため、最初に理解することをお勧めします。ここでは他の方法を見ていきます。
 
 コンテンツ 
  
     -
          
         
     ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>リクエストのバッチ処理の問題とその解決策（パート2）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/467919/"><img src="https://habrastorage.org/webt/ad/_6/oe/ad_6oeq50j8z5q33t5ixjrcssqs.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「リクエストのバッチ処理の問題とその解決策」の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続きです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初の部分は、問題の本質とその解決策へのアプローチを詳細に説明しているため、最初に理解することをお勧めします。</font><font style="vertical-align: inherit;">ここでは他の方法を見ていきます。</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font></font></b><div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   DDD</a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></div></div><br>
<a name="Revision"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事前定義された一連の参加者とドキュメントを調整するためのチャットがあります。</font><font style="vertical-align: inherit;">メッセージにはテキストとファイルが含まれます。</font><font style="vertical-align: inherit;">また、通常のチャットと同様に、メッセージは返信および転送することができます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャットメッセージモデル</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;nullable&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;persist</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>Long</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">author</font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">message</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;-&nbsp;&nbsp;&nbsp;JPA+&nbsp;&nbsp;&nbsp;&nbsp;null,&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">files</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">replyTo</font>:&nbsp;<font color="3e7eff"><b>ChatMessage</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">forwardFrom</font>:&nbsp;<font color="3e7eff"><b>ChatMessage</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><br>
<font color="000066">)</font></code></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存性注入により、次の外部サービスを実装できます。</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>ChatMessageRepository&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>findLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">&gt;</font><br>
<font color="000066">}</font><br>
<br>
<font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>FileReference</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String</b></font><br>
<font color="000066">)</font><br>
<br>
<font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>FileRemoteApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadById</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>FileReference</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>FileHeadRemote</b></font><br>
<font color="3e7eff"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;</font><br>
<font color="000066">}</font><br>
<br>
<font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>UserRemote</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String</b></font><br>
<font color="000066">)</font><br>
<br>
<font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>UserRemoteApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUserById</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>UserReference</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>UserRemote</b></font><br>
<font color="3e7eff"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Set</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getUsersByIds</b></font><font color="000066">(</font><font color="000066"><i>id</i></font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;</font><br>
<font color="000066">}&nbsp;</font></code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RESTコントローラーを実装する必要があります。</font></font><br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="333333">&gt;</font><br>
<font color="000066">}</font></code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どこ：</font></font></b><div class="spoiler_text"><code><font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
<font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ReferenceUI</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;url&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">ref</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">name</font>:&nbsp;<font color="3e7eff"><b>String</b></font><br>
<font color="000066">)</font><br>
<br>
<font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>Long</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">author</font>:&nbsp;<font color="3e7eff"><b>ReferenceUI</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">message</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">files</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ReferenceUI</b></font><font color="333333">&gt;,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">replyTo</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="395da1">/**&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">forwardFrom</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI</b></font>?&nbsp;<font color="333333">=&nbsp;</font><font color="7f0055"><b>null</b></font><br>
<font color="000066">)</font><br>
</code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のパートでは、バッチ処理を使用したサービスの素朴な実装と、それを高速化するいくつかの方法について説明しました。</font><font style="vertical-align: inherit;">これらのメソッドは非常に単純ですが、それらのアプリケーションは十分に優れたパフォーマンスを提供しません。</font></font><br>
<br>
<a name="Enlargement"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージを増やす</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
素朴なソリューションの主な問題は、パッケージのサイズが小さいことでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コールをより大きなパケットにグループ化するには、何らかの形で要求を蓄積する必要があります。この行はリクエストの蓄積を意味するものではありません</font><font style="vertical-align: inherit;">
。実行時に、ユーザーのリストを格納するための特別な場所はありません-徐々に形成されています。これは変更する必要があります。</font><font style="vertical-align: inherit;">
最初に、ChatMessage.toFrontModelメソッドでのマッピングからデータを受信するロジックを分離する必要があります。</font><font style="vertical-align: inherit;">
この関数は、3つの外部関数のみに依存することが</font><font style="vertical-align: inherit;">わかり</font><font style="vertical-align: inherit;">ます（最初のように、クラス全体ではありません）。</font><font style="vertical-align: inherit;">
このようなやり直しの後、関数の本体が明確にならず、契約が厳しくなりました（これには長所と短所の両方があります）。</font></font><br>
<br>
<code><font color="4a86e8">author&nbsp;=&nbsp;</font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUserById</font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()</font><font color="333333">,</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="000066"><i>getUser</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>UserReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>getFile</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>FileReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>serializeMessage</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatMessageUI</b></font><br>
<font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="170591">ChatMessageUI</font><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id&nbsp;</font>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="170591">IllegalStateException</font><font color="000066">(</font><b>"</b><font color="333333"><b>$</b></font><font color="7f0055"><b>this</b></font><b>&nbsp;must&nbsp;be&nbsp;persisted"</b><font color="000066">)</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">author&nbsp;=&nbsp;</font><font color="000066"><i>getUser</i></font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">files&nbsp;=&nbsp;</font><font color="566874">files</font><font color="333333">?.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><font color="000066"><i>getFile</i></font><font color="000066">)</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</b></font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>let</b></i><font color="000066">(</font><font color="000066"><i>serializeMessage</i></font><font color="000066">)</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>let</b></i><font color="000066">(</font><font color="000066"><i>serializeMessage</i></font><font color="000066">)</font><br>
<font color="000066">&nbsp;&nbsp;)</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、契約をこのように狭めることはできず、インターフェースに依存関係を残すことはできません。主なことは、代替の実装を行う必要があるため、それらに不必要なものは絶対にないということです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
serializeMessage関数は再帰関数に似ているため、これはリファクタリングの最初のステップで明示的な再帰の形で実行できます</font><font style="vertical-align: inherit;">
。これまでのところ、最初の単純な実装とまったく同じように機能するtoFrontModelメソッドのスタブを作成しました（3つの外部関数すべての実装は同じです）。</font></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatRestController</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=</font><br>
&nbsp;&nbsp;<i><b>toFrontModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="566874">userRepository</font>::getUserById<font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="566874">fileRepository</font>::getHeadById<font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="000066"><b>{</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;</b></font><font color="000066">)</font></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、関数getUser、getFile、およびserializeMessageが効率的に機能することを確認する必要があります。つまり、適切なサイズ（理論的には、このサイズはサービスごとに異なる場合があります）の対応するサービスにリクエストを送信するか、無制限のリクエストが許可されている場合は通常、サービスごとに1つのリクエストを送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このグループ化を実現する最も簡単な方法は、処理を開始する前に必要なすべてのクエリを用意しておくことです。これを行うには、toFrontModelを呼び出す前に、必要なすべてのリンクを収集し、バッチ処理を実行して、結果を使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、リクエストを蓄積して徐々に実行するスキームも試すことができます。ただし、このようなスキームでは非同期実行が必要になりますが、ここでは同期スキームに焦点を当てます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、バッチ処理の使用を開始するには、何らかの方法で、できる限り多くのリクエスト（できればすべて）を事前に確認する必要があります。</font><font style="vertical-align: inherit;">RESTコントローラーについて話している場合、セッション全体で各サービスの要求を組み合わせると便利です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての通話をグループ化</font></font></b><div class="spoiler_text">    ,   &nbsp; ,     &nbsp;&nbsp;  &nbsp; &nbsp;&nbsp; , &nbsp;&nbsp;. &nbsp;  &nbsp; &nbsp;      &nbsp;    .<br>
<br>
  ,    ,&nbsp;— ,  &nbsp;   &nbsp;  .  &nbsp;    &nbsp; ,    .<br>
<br>
  &nbsp;   ,    ,   , &nbsp; .  ,     , &nbsp;      ,     &nbsp;  .  ,        .<br>
<br>
 ,   &nbsp; -  &nbsp;  &nbsp;,      &nbsp; &nbsp;&nbsp; .    &nbsp;, &nbsp;   .<br>
<br>
 &nbsp;      ,      .</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリの大きなセットを取得するこのような方法を区別できます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リバースエンジニアリング;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスヒューリスティックス;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDDのスタイルの集計。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシと二重呼び出し。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトの例のすべてのオプションを見ていきましょう。</font></font><br>
<br>
<a name="ReverseEngineering"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リバースエンジニアリング</font></font></h4><br>
<a name="RequirementsGathering"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのリクエストの</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
収集情報の収集とフロントエンド用の変換に関連するすべての機能を実装するためのコードがあるので、リバースエンジニアリングしてこのコードを使用して、どのようなリクエストになるかを理解できます。</font><font style="vertical-align: inherit;">
すべてのリクエストが収集されたので、実際のバッチ処理を行う必要があります。</font><font style="vertical-align: inherit;">
allUserReqおよびallFileReqの場合、外部クエリを作成し、IDでグループ化します。</font><font style="vertical-align: inherit;">パケットサイズに制限がない場合、次のようになります。</font><font style="vertical-align: inherit;">
制限がある場合、コードは次のようになります。</font><font style="vertical-align: inherit;">
残念ながら、Streamとは異なり、Sequenceは並列パケット要求に簡単に切り替えることができません。</font><font style="vertical-align: inherit;">
並列クエリが有効かつ必要であると考える場合、たとえば次のようにすることができます。</font></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatRestController</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font>getLast<font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>messages&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;forward&nbsp;&nbsp;reply</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allMessages&nbsp;</font><font color="333333">=&nbsp;</font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>asSequence</b></i><font color="000066">()</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>sequenceOf</b></i><font color="000066">(</font><font color="000066"><i>it</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">forwardFrom</font><font color="333333">,&nbsp;</font><b>it</b><font color="333333">.</font><font color="566874">replyTo</font><font color="000066">)</font><font color="333333">.</font><i><b>filterNotNull</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allUserReq&nbsp;</font><font color="333333">=&nbsp;</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allFileReq&nbsp;</font><font color="333333">=&nbsp;</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUsersByIds</font><font color="000066">(</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">())</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<br>
<font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">())</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>val&nbsp;</b></font><font color="170591">userApiChunkLimit&nbsp;</font><font color="333333">=&nbsp;</font><font color="333333"><b>100</b></font><br>
<font color="170591">allMessages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>asSequence</b></i><font color="000066">()</font><font color="333333">.</font><i><b>distinct</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>chunked</b></i><font color="000066">(</font><font color="170591">userApiChunkLimit</font><font color="333333">,&nbsp;</font><font color="566874">userRepository</font>::getUsersByIds<font color="000066">)</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>flatten</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="170591">allMessages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()</font><font color="333333">.</font><font color="170591">distinct</font><font color="000066">()</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>chunked</b></i><font color="000066">(</font><font color="05314d"><b>userApiChunkLimit</b></font><font color="333333">,&nbsp;</font><font color="566874">userRepository</font>::getUsersByIds<font color="000066">)</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>flatten</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何も変わっていないことがわかります。</font><font style="vertical-align: inherit;">これには、Kotlinの魔法をある程度使用することが役立ちました。</font></font><br>
<br>
<code><font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;</font><font color="3e7eff"><b>Stream</b></font><font color="333333">&lt;</font><font color="7f0055"><b>out&nbsp;</b></font><font color="000066"><i>T</i></font><font color="333333">&gt;.</font><font color="170591"><b>chunked</b></font><font color="000066">(</font><font color="000066"><i>size</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="333333">,&nbsp;</font><font color="000066"><i>transform</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">&gt;</font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Stream</b></font><font color="333333">&lt;</font><font color="7f0055"><b>out&nbsp;</b></font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;=</font><br>
&nbsp;&nbsp;<i><b>batches</b></i><font color="000066">(</font><font color="7f0055"><b>this</b></font><font color="333333">,&nbsp;</font><font color="000066"><i>size</i></font><font color="000066">)</font><font color="333333">.</font><font color="170591">map</font><font color="000066">(</font><font color="000066"><i>transform</i></font><font color="000066">)</font><br>
<br>
<font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">&gt;&nbsp;</font><font color="3e7eff"><b>Stream</b></font><font color="333333">&lt;</font><font color="7f0055"><b>out&nbsp;</b></font><font color="3e7eff"><b>Collection</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">&gt;&gt;.</font><font color="170591"><b>flatten</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>Stream</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">&gt;&nbsp;=</font><br>
&nbsp;&nbsp;<font color="170591">flatMap&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="170591">stream</font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><br>
<br>
<font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>K</i></font><font color="333333">&gt;&nbsp;</font><font color="3e7eff"><b>Stream</b></font><font color="333333">&lt;</font><font color="000066"><i>T</i></font><font color="333333">&gt;.</font><font color="170591"><b>associateBy</b></font><font color="000066">(</font><font color="000066"><i>keySelector</i></font>:&nbsp;<font color="000066">(</font><font color="000066"><i>T</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>K</i></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>Map</b></font><font color="333333">&lt;</font><font color="000066"><i>K</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>T</i></font><font color="333333">&gt;&nbsp;=</font><br>
&nbsp;&nbsp;<font color="170591">collect</font><font color="000066">(</font><font color="3e7eff"><b>Collectors</b></font><font color="333333">.</font><font color="170591">toMap</font><font color="000066">(</font><font color="000066"><i>keySelector</i></font><font color="333333">,&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><b>it&nbsp;</b><font color="000066"><b>}</b></font><font color="000066">))</font></code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今では、すべてを一緒に収集する必要があります。</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>messages&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;forward&nbsp;&nbsp;reply</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allMessages&nbsp;</font><font color="333333">=&nbsp;</font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>asSequence</b></i><font color="000066">()</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>sequenceOf</b></i><font color="000066">(</font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">forwardFrom</font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">replyTo</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>filterNotNull</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><font color="170591">ValueHolder</font><font color="333333">&lt;</font><font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="333333">&gt;</font><font color="000066">()</font><font color="333333">.</font><i><b>apply&nbsp;</b></i><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="566874">value&nbsp;</font><font color="333333">=&nbsp;</font><i><b>memoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font>:&nbsp;<font color="3e7eff"><b>ChatMessage&nbsp;</b></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="3e7eff"><b>allMessages</b></font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()</font><font color="333333">.</font><font color="170591">distinct</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>chunked</b></i><font color="000066">(</font><font color="05314d"><b>userApiChunkLimit</b></font><font color="333333">,&nbsp;</font><font color="566874">userRepository</font>::getUsersByIds<font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>flatten</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"User&nbsp;</b><font color="333333"><b>$</b></font><b>it"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="3e7eff"><b>allMessages</b></font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">())</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"File&nbsp;</b><font color="333333"><b>$</b></font><b>it"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="566874">value</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><font color="333333">.</font><font color="566874">value</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font></code></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明と簡略化</font></font></b><div class="spoiler_text">,    &nbsp;,&nbsp;—   memoize.  &nbsp;,   serializeMessage       &nbsp;     (- reply &nbsp;forward). ,    toFrontModel      (&nbsp;     , &nbsp;&nbsp;&nbsp;).       serializeMessage.  , , :<br>
<br>
<code><font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;</font><font color="170591"><b>memoize</b></font><font color="000066">(</font><font color="000066"><i>func</i></font>:&nbsp;<font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="000066">)&nbsp;</font><font color="333333">=&nbsp;</font><font color="000066"><i>func&nbsp;</i></font><font color="7f0055"><b>as?&nbsp;</b></font><font color="3e7eff"><b>Memoize2&nbsp;</b></font>?:&nbsp;<font color="170591">Memoize2</font><font color="000066">(</font><font color="000066"><i>func</i></font><font color="000066">)</font><br>
<font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>Memoize2</b></font><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;</font><font color="000066">(</font><font color="7f0055"><b>val&nbsp;</b></font><font color="566874">func</font>:&nbsp;<font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="000066">)&nbsp;</font>:&nbsp;<font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">,&nbsp;</font>java<font color="333333">.</font>util<font color="333333">.</font>function<font color="333333">.</font><font color="3e7eff"><b>Function</b></font><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;</font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">cache&nbsp;</font><font color="333333">=&nbsp;</font><i><b>hashMapOf</b></i><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;</font><font color="000066">()</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>invoke</b></font><font color="000066">(</font><font color="000066"><i>p1</i></font>:&nbsp;<font color="000066"><i>A</i></font><font color="000066">)&nbsp;</font><font color="333333">=&nbsp;</font><font color="566874">cache</font><font color="333333">.</font><i><b>getOrPut</b></i><font color="000066">(</font><font color="000066"><i>p1</i></font><font color="333333">,&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="566874">func</font><font color="000066">(</font><font color="000066"><i>p1</i></font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>apply</b></font><font color="000066">(</font><font color="000066"><i>t</i></font>:&nbsp;<font color="000066"><i>A</i></font><font color="000066">)</font>:&nbsp;<font color="000066"><i>R&nbsp;</i></font><font color="333333">=&nbsp;</font><font color="170591">invoke</font><font color="000066">(</font><font color="000066"><i>t</i></font><font color="000066">)</font><br>
<font color="000066">}</font></code><br>
<br>
      serializeMessage, &nbsp;  &nbsp;     .         ,       .       ValueHolder,     &nbsp; (    - ,  AtomicReference).     ,   :<br>
<br>
<code><font color="7f0055"><b>inline&nbsp;fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;</font><font color="170591"><b>recursiveMemoize</b></font><font color="000066">(</font><font color="7f0055"><b>crossinline&nbsp;</b></font><font color="000066"><i>func</i></font>:&nbsp;<font color="000066">(</font><font color="000066"><i>A</i></font><font color="333333">,&nbsp;</font><font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="000066">)</font>:&nbsp;<font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R&nbsp;</i></font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="170591">ValueHolder</font><font color="333333">&lt;</font><font color="000066">(</font><font color="000066"><i>A</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;</font><font color="000066">()</font><font color="333333">.</font><i><b>apply&nbsp;</b></i><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="566874">value&nbsp;</font><font color="333333">=&nbsp;</font><i><b>memoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>a&nbsp;</i></font><font color="000066"><b>-&gt;&nbsp;</b></font><font color="3e7eff"><b>func</b></font><font color="000066">(</font><font color="000066"><i>a</i></font><font color="333333">,&nbsp;</font><font color="566874">value</font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;}</b></font><font color="333333">.</font><font color="566874">value</font></code><br>
<br>
       &nbsp; &nbsp;— ,    :-)<br>
<br>
     :<br>
<br>
<code><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>messages&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;forward&nbsp;&nbsp;reply</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allMessages&nbsp;</font><font color="333333">=&nbsp;</font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>asSequence</b></i><font color="000066">()</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>sequenceOf</b></i><font color="000066">(</font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">forwardFrom</font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">replyTo</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>filterNotNull</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">getUser&nbsp;</font><font color="333333">=&nbsp;</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()</font><font color="333333">.</font><font color="170591">distinct</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>chunked</b></i><font color="000066">(</font><font color="05314d"><b>userApiChunkLimit</b></font><font color="333333">,&nbsp;</font><font color="566874">userRepository</font>::getUsersByIds<font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>flatten</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"User&nbsp;</b><font color="333333"><b>$</b></font><font color="000066"><i>it</i></font><b>"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">getFile&nbsp;</font><font color="333333">=&nbsp;</font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="170591">allMessages</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">())</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"File&nbsp;</b><font color="333333"><b>$</b></font><b>it"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><i><b>recursiveMemoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>memoized</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="170591">getUser</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="170591">getFile</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="000066"><i>memoized</i></font><br>
<font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="000066">)</font></code><br>
<br>
   orThrow,   :<br>
<br>
<code><font color="395da1">/**&nbsp;&nbsp;&nbsp;</font><font color="3d3d3d"><i><b>[exception]</b></i></font><font color="395da1">,&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;*/</font><br>
<font color="7f0055"><b>fun&nbsp;</b></font><font color="333333">&lt;</font><font color="000066"><i>P</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>R</i></font><font color="333333">&gt;&nbsp;</font><font color="000066">((</font><font color="000066"><i>P</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R</i></font>?<font color="000066">)</font><font color="333333">.</font><font color="170591"><b>orThrow</b></font><font color="000066">(</font><font color="000066"><i>exception</i></font>:&nbsp;<font color="000066">(</font><font color="000066"><i>P</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>Exception</b></font><font color="000066">)</font>:&nbsp;<font color="000066">(</font><font color="000066"><i>P</i></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="000066"><i>R&nbsp;</i></font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>p&nbsp;</i></font><font color="000066"><b>-&gt;&nbsp;</b></font><font color="170591">invoke</font><font color="000066">(</font><font color="000066"><i>p</i></font><font color="000066">)</font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it&nbsp;</b>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="3e7eff"><b>exception</b></font><font color="000066">(</font><font color="000066"><i>p</i></font><font color="000066">)&nbsp;</font><font color="000066"><b>}&nbsp;}</b></font></code><br>
<br>
 &nbsp;    &nbsp; id &nbsp;   ,   &nbsp;- -.<br>
<br>
   ,    getLast  &nbsp; 300&nbsp;.     ,      &nbsp; &nbsp;  (    ). ,   -&nbsp;— 500&nbsp;, &nbsp;     250&nbsp;.</div></div><br>
<a name="Parallelism"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列処理</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
しかし、次に進む必要があります。</font><font style="vertical-align: inherit;">userRepositoryとfileRepositoryの呼び出しは完全に独立しており、理論的には200ミリ秒に近づくように簡単に並列化できます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、join関数を使用します。</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>messages&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;forward&nbsp;&nbsp;reply</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">allMessages&nbsp;</font><font color="333333">=&nbsp;</font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>asSequence</b></i><font color="000066">()</font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>sequenceOf</b></i><font color="000066">(</font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">forwardFrom</font><font color="333333">,&nbsp;</font><font color="000066"><i>message</i></font><font color="333333">.</font><font color="566874">replyTo</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>filterNotNull</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i><b>join</b></i><font color="000066">(</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3e7eff"><b>allMessages</b></font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">author&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><font color="170591">parallelStream</font><font color="000066">()</font><font color="333333">.</font><font color="170591">distinct</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>chunked</b></i><font color="000066">(</font><font color="05314d"><b>userApiChunkLimit</b></font><font color="333333">,&nbsp;</font><font color="566874">userRepository</font>::getUsersByIds<font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>flatten</b></i><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><font color="333333">,&nbsp;</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="3e7eff"><b>allMessages</b></font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">())</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><font color="000066">)</font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">users</font><font color="333333">,&nbsp;</font><font color="170591">files</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>messages</i></font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><i><b>recursiveMemoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>memoized</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="170591">users</font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"User&nbsp;</b><font color="333333"><b>$</b></font><b>it"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="170591">files</font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"File&nbsp;</b><font color="333333"><b>$</b></font><font color="000066"><i>it</i></font><b>"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="000066"><i>memoized</i></font><br>
<font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;}</b></font></code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実習で示されているように、実行には約200ミリ秒かかり、メッセージ数の増加に伴って時間が長くならないことが非常に重要です。</font></font><br>
<br>
<a name="Problems"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
一般に、コードはもちろん、最初のバージョンよりも読みにくくなりますが、シリアライゼーション自体（toFrontModelの実装）はあまり変更されておらず、完全に読みやすいままです。外部サービスとの狡猾な仕事の論理全体が1か所にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの欠点は、抽象化が進んでいることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
toFrontModelに変更を加える必要がある場合は、ほぼ確実に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Liskov代入原理に</font><font style="vertical-align: inherit;">違反するgetLast関数に変更を加える必要があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、メインメッセージのみで添付ファイルを復号化し、返信と転送（返信/転送）、または第1レベルの応答と転送でのみ復号化することに同意しました。</font><font style="vertical-align: inherit;">この場合、toFrontModelコードに変更を加えた後、ファイルのリクエストを収集するためにコードで対応する修正を行う必要があります。</font><font style="vertical-align: inherit;">さらに、修正は簡単ではありません。</font><font style="vertical-align: inherit;">
ここでは、前の問題と密接に関連する別の問題にスムーズに取り組んでいます。コード全体の正しい動作は、リバースエンジニアリングのリテラシーに依存します。</font><font style="vertical-align: inherit;">一部の複雑なケースでは、クエリコレクションが正しくないため、コードが正確に機能しない場合があります。</font><font style="vertical-align: inherit;">このようなトリッキーな状況すべてをカバーする単体テストをすぐに思い付くことができるという保証はありません。</font></font><br>
<br>
<code><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="3e7eff"><b>allMessages</b></font><font color="333333">.</font><i><b>flatMap&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">files&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">.</font><i><b>toSet</b></i><font color="000066">()</font><br>
<font color="000066">)</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
 <br>
<a name="Summary1"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メリット：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインコードから簡単に分離できる、リクエストを事前に受け取る明白な方法。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とにかく受信されるはずだったデータのみの使用に関連するメモリと時間のオーバーヘッドがほぼ完全になくなる。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部からのリクエストのサイズに関係なく、理論的には予測可能な時間を担当する、優れたスケーリングとサービスを構築する機能。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイナス：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッチ処理自体のためのかなり複雑なコード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存の実装での要求の分析に大きく責任を持つ作業。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抽象化の流れ、そして結果として、実装の変更に関連したスキーム全体の脆弱性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポートの難しさ：クエリ予測ブロックのエラーは、メインコードのエラーと区別するのが困難です。</font><font style="vertical-align: inherit;">理想的には、2倍のユニットテストを使用する必要があるため、本番環境でエラーのある手続きは2倍困難になります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを記述する際のSOLIDの原則への準拠：コードは、バッチ処理のロジックを引き離すように準備する必要があります。</font><font style="vertical-align: inherit;">これらの原則を導入するだけでいくつかの利点がもたらされるため、このマイナスは最も重要ではありません。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法は、リバースエンジニアリングを行わなくても使用できることに注意してください。</font><font style="vertical-align: inherit;">getLastコントラクトを取得する必要があります。これには、リクエストの事前計算（以下、プリフェッチ）のコントラクトが依存します。</font><font style="vertical-align: inherit;">この場合、getLast（リバースエンジニアリング）の実装を見ることでこれを実現しました。</font><font style="vertical-align: inherit;">ただし、このアプローチでは問題が発生します。これらの2つのコードの編集は常に同期的である必要があり、どのような方法でもこれを保証することは不可能です（hashCodeと等しいことを思い出してください。まったく同じものがあります）。</font><font style="vertical-align: inherit;">私がお見せしたい次のアプローチは、この問題を解決する（または少なくとも軽減する）ように設計されています。</font></font><br>
<br>
<a name="BusinessHeuristics"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスヒューリスティックス</font></font></h4><br>
<a name="ManagingContractProblem1"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">契約の問題の解決</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
正確な契約ではなく、したがって正確な一連の要求ではなく、おおよその契約で運用している場合はどうなりますか？</font><font style="vertical-align: inherit;">さらに、正確なセットを厳密に含み、対象領域の特性に基づいて、おおよそのセットを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、getLastに対するプリフェッチコントラクトの依存関係の代わりに、ユーザーによって指示されるいくつかの一般的なコントラクトに対する両方の依存関係を確立します。</font><font style="vertical-align: inherit;">主な困難は、この一般的な契約を何らかの形でコードの形で具体化することです。</font></font><br>
<br>
<a name="UsefulRestrictions"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">便利な制約を見つける</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
例を使用してこれを実行してみましょう。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの場合、次のビジネス機能があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャット参加者のリストは事前定義されています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャットは互いに完全に分離されています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返信/転送チェーンのネストは小さい（〜2-3メッセージ）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の制限から、メッセージを回避したり、そこにいるユーザーを調べたり、固有のユーザーを選択したり、それらのユーザーに要求をしたりする必要はありません。事前定義されたリストをクエリするだけです。あなたがこの声明に同意した場合、私はあなたを捕まえました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、すべてがそれほど単純ではありません。リストは事前定義できますが、数千のユーザーが存在する場合があります。そのようなことを明確にする必要があります。私たちの場合、チャットの参加者は通常2〜3人ですが、それ以上になることはめったにありません。したがって、それらすべてのデータを受信することは完全に許容できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、チャット・ユーザーのリストが事前に決定されているが、この情報がユーザー・サービスにない場合（非常に可能性が高い）、そのような情報からは意味がありません。チャットユーザーリストに対して追加のリクエストを行いますが、それでもユーザーサービスにリクエストを行う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーとチャットの接続に関する情報がユーザーサービスに格納されているとします。私たちの場合、接続はユーザーの権限によって決定されるため、これはそうです。次に、ユーザーに対して次のプリフェッチコードを取得します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。チャットIDを渡していないことは、ここでは意外に思われるかもしれません。これは、サンプルコードが乱雑にならないように意図的に行ったものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一見すると、2番目の制限から何も続きません。いずれにしても、私はまだ彼から何か役に立つものを得ることができませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに3番目の制限を使用しています。会話の保存と受信の方法に大きな影響を与える可能性があります。 RESTコントローラーやバッチ処理とは関係がないため、このトピックの開発は開始しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルをどうするか1つの簡単なリクエストですべてのチャットファイルのリストを取得したいのですが。 APIの条件では、ボディはなくファイルヘッダーのみが必要なため、これは呼び出し元にとってリソースを大量に消費する危険なタスクのようには見えません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、すべてのチャットメッセージを受信するのではなく、最後のNのみを受信することを覚えておく必要があります。これらのメッセージにはファイルがまったく含まれていないことが簡単にわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
普遍的な答えはありません。それはすべて、ビジネスの詳細とユースケースに依存します。</font><font style="vertical-align: inherit;">製品ソリューションを作成するときに、1つのユースケースのヒューリスティックを使用すると問題が発生する可能性があり、ユーザーは異なる方法で機能を操作します。</font><font style="vertical-align: inherit;">デモやプリセールスの場合、これは良い選択肢ですが、今は正直な制作サービスを書こうとしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、悲しいかな、ここでの操作と統計収集の結果のみに基づいて（または専門家の評価後に）ファイルのビジネスヒューリスティックを実行することが可能になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まだ何らかの方法でメソッドを適用したいので、統計が以下を示したとします。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な会話は、1つ以上のファイルを含むメッセージで始まり、ファイルのない返信メッセージが続きます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどすべてのメッセージは、通常の会話で送られます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1回のチャット内で予期される一意のファイルの数は、最大20です。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ほぼすべてのメッセージを表示するには、いくつかのファイルのヘッダーを取得する必要があります（ChatMessageUIはそのように配置されているため）。また、ファイルの総数は少ないです。</font><font style="vertical-align: inherit;">この場合、1回のリクエストですべてのチャットファイルを受信するのが妥当と思われます。</font><font style="vertical-align: inherit;">これを行うには、ファイルのAPIに以下を追加する必要があります</font><font style="vertical-align: inherit;">
。getHeadsByChatメソッドは、パフォーマンスを最適化したいという理由で、完全にフェッチされて作成されたようには見えません（これも十分な理由です）。</font><font style="vertical-align: inherit;">多くの場合、ファイルのあるチャットルームでは、ユーザーは使用されたすべてのファイルを、追加された順序で（したがって、リストを使用して）確認したいと考えます。</font></font><br>
<br>
<code><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getHeadsByChat</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような明示的な接続を実装するには、ファイルサービスまたはアプリケーションに追加情報を格納する必要があります。私たちの意見では、チャットとのファイルの接続に関するこの冗長な情報を保存する必要があるのは、誰の責任の領域に依存するかです。メッセージは既にファイルに関連付けられており、メッセージはチャットに関連付けられているため、冗長です。非正規化を使用することはできませんが、メッセージからその場で、つまりSQL内でこの情報を抽出し、チャット全体（これはアプリケーション内にあります）のすべてのファイルをすぐに取得して、ファイルサービスから一度にそれらすべてを要求します。チャットメッセージが多い場合、このオプションはうまく機能しませんが、非正規化は必要ありません。両方のオプションをgetHeadsByChatの背後に隠します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは次のとおりです。</font></font><br>
<br>
<code><font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font>getLast<font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;<font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>messages&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>join</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUsersByChat</font><font color="000066">()</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}&nbsp;}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByChat</font><font color="000066">()</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}&nbsp;}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;}</b></font></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のバージョンと比較して、ほとんど変更されておらず、プリフェッチ部分のみが影響を受けていることがわかります。これは素晴らしいことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プリフェッチコードが大幅に短く明確になりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストの数は同じであるため、実行時間は変更されていません。これは論理的です。理論的には、スケーリングが正直なリバースエンジニアリングよりも優れている場合があります（複雑な計算のリンクを削除することによってのみ）。ただし、反対の状況も同様に可能性が高くなります。ヒューリスティックの行が多すぎます。実践が示すように、適切なヒューリスティックを思いついた場合、実行時間に特別な変更はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、これだけではありません。ユーザーとファイルに関する詳細なデータの受信はメッセージの受信とは無関係であり、リクエストは並行して起動できることを考慮に入れていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このオプションでは、リクエストごとに安定した100ミリ秒が提供</font><font style="vertical-align: inherit;">され</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<a name="Mistakes"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒューリスティックエラーヒューリスティック</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を使用しているときに、クエリセットが大きくなくても、本来よりもわずかに小さい場合はどうなりますか？</font><font style="vertical-align: inherit;">ほとんどのオプションでは、このようなヒューリスティックが機能しますが、例外があり、別のリクエストを行う必要があります。</font><font style="vertical-align: inherit;">私の実践では、各例外がパフォーマンスに大きな影響を与え、最終的に一部のユーザーが完全に例外で構成される要求を行ったため、そのような決定は失敗しました。</font><font style="vertical-align: inherit;">このような状況では、クエリコレクションアルゴリズムが不気味で読めない場合でも、リバースエンジニアリングを使用する方が良いと思いますが、もちろん、すべてがサービスの重要度に依存します。</font></font><br>
<br>
<a name="Summary2"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メリット：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスヒューリスティックのロジックは読みやすく、通常は簡単です。</font><font style="vertical-align: inherit;">これは、適用範囲の制限を理解し、プリフェッチコントラクトを確認および変更するために役立ちます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーラビリティはリバースエンジニアリングと同じくらい優れています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データに応じたコードの一貫性が低下し、コードの並列化が向上します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリフェッチロジックとRESTコントローラのメインロジックは、要件に基づいています。</font><font style="vertical-align: inherit;">要件が頻繁に変更される場合、これは弱いプラスです。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイナス：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要件から、クエリ予測のヒューリスティックを導出することはそれほど簡単ではありません。</font><font style="vertical-align: inherit;">要件の明確化は、アジャイルとの互換性が低い程度まで必要になる場合があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加のデータを取得できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリフェッチコントラクトが効果的に機能するようにするには、おそらくデータストレージの非正規化が必要になります。</font><font style="vertical-align: inherit;">これらの最適化はビジネスロジックに基づいているため、これは弱いマイナスです。したがって、ほとんどの場合、さまざまなプロセスによって要求されます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例から、このアプローチを適用することは非常に困難であり、ゲームはキャンドルの価値がないと結論付けることができます。</font><font style="vertical-align: inherit;">実際、実際のビジネスプロジェクトでは、制限の数が膨大であり、このヒープから、データを分割したり統計を予測したりするのに役立つ何かを得ることがしばしば可能です。</font><font style="vertical-align: inherit;">このアプローチの主な利点は、使用される制限がビジネスによって解釈されるため、簡単に理解および検証できることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、このアプローチを使用しようとするときの最大の問題は、アクティビティの分離です。</font><font style="vertical-align: inherit;">開発者は、ビジネスロジックに十分に没頭し、特定のレベルのイニシアチブが必要な質問を明確にするアナリストの質問をする必要があります。</font></font><br>
<br>
<a name="DDDAgregates"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDDスタイルのユニット</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大規模なプロジェクトでは、コードを効率的に構造化できるため、DDDプラクティスの使用をよく目にすることがあります。</font><font style="vertical-align: inherit;">プロジェクトですべてのDDDテンプレートを使用する必要はありません-場合によっては、テンプレートを導入した場合でも、良いリターンが得られることがあります。</font><font style="vertical-align: inherit;">DDDの概念を集合体として考えます。</font><font style="vertical-align: inherit;">集合体は、論理的に関連するエンティティの結合であり、作業は集合体のルートを介してのみ実行されます（通常、これはエンティティ接続グラフの一番上にあるエンティティです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの取得という観点から見ると、集計の主なものは、エンティティリストを操作するロジック全体が1か所、つまり集計であるということです。</font><font style="vertical-align: inherit;">建設中にユニットに転送する必要があるものには2つのアプローチがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニットに関数を転送して外部データを取得します。</font><font style="vertical-align: inherit;">必要なデータを決定するロジックは、ユニット内にあります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なすべてのデータを転送します。</font><font style="vertical-align: inherit;">必要なデータを決定するためのロジックは、集計の外部にあります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプローチの選択は、プリフェッチを集合体の外にどれだけ簡単に移動できるかに大きく依存します。</font><font style="vertical-align: inherit;">プリフェッチロジックがビジネスヒューリスティックに基づいている場合、通常、プリフェッチロジックを集約から分離するのは簡単です。</font><font style="vertical-align: inherit;">論理的に関連するコードを異なるクラスに分散するため、その使用（リバースエンジニアリング）の分析に基づいてロジックを集約の範囲を超えて移動することは危険な場合があります。</font></font><br>
<br>
<a name="EnlargementInside"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集約内のクエリを拡大するロジック</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
「チャット」の概念に対応する集約をスケッチしてみましょう。 ChatMessage、UserReference、FileReferenceクラスはストレージモデルに対応しているため、適切なプレフィックスを付けて名前を変更できますが、小規模なプロジェクトがあるため、そのままにしておきます。アセンブリをチャットと呼び、そのコンポーネントはChatPageおよびChatPageMes​​sageです。</font><font style="vertical-align: inherit;">
これまでのところ、意味のない多くの重複が取得されています。これは、対象モデルがストレージモデルに似ており、どちらもフロントエンドモデルに似ているためです。</font><font style="vertical-align: inherit;">
FileHeadRemoteクラスとUserRemoteクラスを直接使用して、コードを記述しすぎないようにしますが、通常、ドメインで直接このようなクラスを使用することは避けてください。</font></font><br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>Chat&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getLastPage</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>ChatPage</b></font><br>
<font color="000066">}</font><br>
<br>
<font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>ChatPage&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">messages</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatPageMessage</b></font><font color="333333">&gt;</font><br>
<font color="000066">}</font><br>
<br>
<font color="7f0055"><b>data&nbsp;class&nbsp;</b></font><font color="3e7eff"><b>ChatPageMessage</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">id</font>:&nbsp;<font color="3e7eff"><b>Long</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">author</font>:&nbsp;<font color="3e7eff"><b>UserRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">message</font>:&nbsp;<font color="3e7eff"><b>String</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">files</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">replyTo</font>:&nbsp;<font color="3e7eff"><b>ChatPageMessage</b></font>?<font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="566874">forwardFrom</font>:&nbsp;<font color="3e7eff"><b>ChatPageMessage</b></font>?<br>
<font color="000066">)</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような集約を使用する場合、RESTコントローラーは次のように書き換えることができます。</font><font style="vertical-align: inherit;">
このオプションは、最初の単純な実装を大部分連想させますが、重要な利点があります。コントローラーは、データの直接受信に関与しなくなり、データストレージに関連付けられたクラスに依存しなくなりますが、インターフェースから設定されるユニットからのみ。</font><font style="vertical-align: inherit;">したがって、プリフェッチロジックはコントローラーにありません。</font><font style="vertical-align: inherit;">コントローラーはユニットのフロントエンドモデルへの変換のみを扱い、単一責任原則（SRP）に準拠します。</font><font style="vertical-align: inherit;">
残念ながら、集計に記述されているすべてのメソッドについて、実装を作成する必要があります。</font></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatRestController</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">chat</font>:&nbsp;<font color="3e7eff"><b>Chat</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">chat</font><font color="333333">.</font><font color="170591">getLastPage</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()</font><br>
<br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatPage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">messages</font><font color="333333">.</font><i><b>map&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><br>
<br>
<font color="000066"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatPageMessage</b></font><font color="333333">.</font><font color="170591"><b>toFrontModel</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatMessageUI&nbsp;</b></font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="170591">ChatMessageUI</font><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">author&nbsp;=&nbsp;</font><font color="566874">author</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">files&nbsp;=&nbsp;</font><font color="566874">files</font><font color="333333">.</font><i><b>toFrontReference</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>toFrontModel</b></i><font color="000066">()</font><br>
<font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;)</font><br>
<font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスヒューリスティックを使用するときに実装されたコントローラーロジックを保存してみましょう。</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatImpl</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>Chat&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLastPage</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=&nbsp;</font><font color="7f0055"><b>object&nbsp;</b></font>:&nbsp;<font color="3e7eff"><b>ChatPage&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;val&nbsp;</b></font><font color="566874">messages</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatPageMessage</b></font><font color="333333">&gt;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>get</b></font><font color="000066">()&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i><b>runBlocking</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="7f0055"><b>val&nbsp;</b></font><font color="170591">prefetch&nbsp;</font><font color="333333">=&nbsp;</font><i><b>async</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUsersByChat</font><font color="000066">()</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}&nbsp;}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByChat</font><font color="000066">()</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}&nbsp;}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i><b>withContext</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{&nbsp;</b></font><font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="3e7eff"><b>n</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="170591">prefetch</font><font color="333333">.</font><font color="170591">await</font><font color="000066">()</font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">users</font><font color="333333">,&nbsp;</font><font color="170591">files</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>recursiveMemoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>memoized</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatPageMessage&nbsp;</b></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toDomainModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="170591">users</font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"User&nbsp;</b><font color="333333"><b>$</b></font><font color="000066"><i>it</i></font><b>"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="170591">files</font>::get<font color="333333">.</font><i><b>orThrow&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="170591">IllegalArgumentException</font><font color="000066">(</font><b>"File&nbsp;</b><font color="333333"><b>$</b></font><font color="000066"><i>it</i></font><b>"</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="000066"><i>memoized</i></font><br>
<font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;</b></font><font color="000066">}</font><br>
<font color="000066">}</font><br>
<br>
<font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">.</font><font color="170591"><b>toDomainModel</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="000066"><i>getUser</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>UserReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>getFile</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>FileReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>serializeMessage</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatPageMessage</b></font><br>
<font color="000066">)&nbsp;</font><font color="333333">=&nbsp;</font><font color="170591">ChatPageMessage</font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="4a86e8">id&nbsp;=&nbsp;</font><font color="566874">id&nbsp;</font>?:&nbsp;<font color="7f0055"><b>throw&nbsp;</b></font><font color="170591">IllegalStateException</font><font color="000066">(</font><b>"</b><font color="333333"><b>$</b></font><font color="7f0055"><b>this</b></font><b>&nbsp;must&nbsp;be&nbsp;persisted"</b><font color="000066">)</font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="4a86e8">author&nbsp;=&nbsp;</font><font color="000066"><i>getUser</i></font><font color="000066">(</font><font color="566874">author</font><font color="000066">)</font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="4a86e8">message&nbsp;=&nbsp;</font><font color="566874">message</font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="4a86e8">files&nbsp;=&nbsp;</font><font color="566874">files</font><font color="333333">?.</font><i><b>map</b></i><font color="000066">(</font><font color="000066"><i>getFile</i></font><font color="000066">)&nbsp;</font>?:&nbsp;<i><b>listOf</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="4a86e8">forwardFrom&nbsp;=&nbsp;</font><font color="566874">forwardFrom</font><font color="333333">?.</font><i><b>let</b></i><font color="000066">(</font><font color="000066"><i>serializeMessage</i></font><font color="000066">)</font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="4a86e8">replyTo&nbsp;=&nbsp;</font><font color="566874">replyTo</font><font color="333333">?.</font><i><b>let</b></i><font color="000066">(</font><font color="000066"><i>serializeMessage</i></font><font color="000066">)</font><br>
<font color="000066">)</font><br>
</code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
getLastPage関数自体にプリフェッチを含むデータ取得戦略があり、toDomainModel関数は純粋に技術的であり、格納されたモデルをドメインモデルに変換する責任があることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kotlinでは、userRepository、fileRepository、およびmessageRepositoryへの並列呼び出しをより身近な形式に書き直しました。このため、コードのわかりやすさが損なわれないことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、このような方法はすでに完全に機能しており、そのパフォーマンスはリバースエンジニアリングやビジネスヒューリスティックスを単純に使用した場合と同じです。</font></font><br>
<br>
<a name="EnlargementOutside"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集計の外部でクエリを拡大するロジック集計</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を作成するプロセスでは、すぐに問題が発生します。ChatPageを作成するには、通常のように、ChatPageを作成するときにページサイズを定数として設定し、getLast（）に渡さないようにする必要があります。</font><font style="vertical-align: inherit;">
我々はよ</font><font style="vertical-align: inherit;">統合インターフェース自体を変更する必要があります。</font><font style="vertical-align: inherit;">我々は残りのメッセージの娘を持っており、私たちはしっかりと集計外のすべてのデータを取得したいので、我々は完全にチャットレベルの集計を放棄しChatPageルートにする必要があります：</font><font style="vertical-align: inherit;">
次に、我々は、集約とは別のプリフェッチコードを作成する必要があります。</font><font style="vertical-align: inherit;">
今、そのためにアグリゲートを作成するには、プリフェッチでドッキングする必要があります。 DDDでは、この種のオーケストレーションはアプリケーションサービスによって行われます。</font></font><br>
<br>
<code><font color="7f0055"><b>interface&nbsp;</b></font><font color="3e7eff"><b>Chat&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getPage</b></font><font color="000066">()</font>:&nbsp;<font color="3e7eff"><b>ChatPage</b></font><br>
<font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatPageImpl</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageData</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessage</b></font><font color="333333">&gt;,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userData</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">&gt;,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileData</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>FileHeadRemote</b></font><font color="333333">&gt;</font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatPage&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;val&nbsp;</b></font><font color="566874">messages</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatPageMessage</b></font><font color="333333">&gt;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>get</b></font><font color="000066">()&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="566874">messageData</font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><br>
<font color="000066">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</font><font color="566874">userData</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><b>it</b><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}&nbsp;</b></font><i><b>to&nbsp;</b></i><font color="566874">fileData</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">users</font><font color="333333">,&nbsp;</font><font color="170591">files</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>recursiveMemoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>self</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>ChatMessage</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>ChatPageMessage&nbsp;</b></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toDomainModel</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getUser&nbsp;=&nbsp;</font><font color="170591">users</font>::get<font color="333333">.</font><i><b>orThrow</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">getFile&nbsp;=&nbsp;</font><font color="170591">files</font>::get<font color="333333">.</font><i><b>orThrow</b></i><font color="000066">()</font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="4a86e8">serializeMessage&nbsp;=&nbsp;</font><font color="000066"><i>self</i></font><br>
<font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
<font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>chatPagePrefetch</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="000066"><i>pageSize</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>messageRepository</i></font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>userRepository</i></font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="000066"><i>fileRepository</i></font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;<i><b>runBlocking</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>async</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>userRepository</b></font><font color="333333">.</font><font color="170591">getUsersByChat</font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>fileRepository</b></font><font color="333333">.</font><font color="170591">getHeadsByChat</font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>messageRepository</b></font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="3e7eff"><b>pageSize</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
&nbsp;&nbsp;<font color="000066"><b>}</b></font></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatService</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;fun&nbsp;</b></font><font color="170591"><b>chatPagePrefetch</b></font><font color="000066">(</font><font color="000066"><i>pageSize</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)&nbsp;</font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<i><b>runBlocking</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><i><b>async</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="3e7eff"><b>pageSize</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUsersByChat</font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByChat</font><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><font color="333333">.</font><font color="170591">await</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<br>
<font color="000066"><b>&nbsp;&nbsp;</b></font><font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>getLastPage</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>ChatPage&nbsp;</b></font><font color="333333">=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="170591">chatPagePrefetch</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">messageData</font><font color="333333">,&nbsp;</font><font color="170591">userData</font><font color="333333">,&nbsp;</font><font color="170591">fileData</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="170591">ChatPageImpl</font><font color="000066">(</font><font color="170591">messageData</font><font color="333333">,&nbsp;</font><font color="170591">userData</font><font color="333333">,&nbsp;</font><font color="170591">fileData</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066">}</font></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、コントローラーはそれほど変化しません。Chat:: getLastPageの代わりにChatService :: getLastPageを使用する必要があるだけです。</font><font style="vertical-align: inherit;">つまり、コードは次のように変更されます。</font></font><br>
<br>
<code><font color="7f0055"><b>class&nbsp;</b></font>ChatRestController<font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">chat</font>:&nbsp;<font color="3e7eff"><b>ChatService</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi</b></font><br>
</code><br>
<br>
<a name="Summary3"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリフェッチロジックは、ユニット内または別の場所に配置できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリフェッチロジックがアグリゲートの内部ロジックに強く関連している場合は、カプセル化を中断させる可能性があるため、プリフェッチロジックを取り出さないようにすることをお勧めします。</font><font style="vertical-align: inherit;">個人的には、プリフェッチを集約の外に移動することにあまり意味がありません。これにより、可能性が大幅に制限され、コードの暗黙的な一貫性が高まるからです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大量のリクエストに対する制御が強化され、プリフェッチロジックの場所が非常に明確になるため、集約組織自体がバッチ処理のパフォーマンスにプラスの影響を与えます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の章では、メイン関数から分離して実装できないプリフェッチ実装について検討します。</font></font><br>
<br>
<a name="Proxying"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロキシと二重呼び出し</font></font></h4><br>
<a name="ManagingContractProblem2"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントラクトの問題の解決</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
これまでのパートで説明したように、プリフェッチコントラクトの主な問題は、データを準備する必要がある関数のコントラクトと強く結びついていることです。</font><font style="vertical-align: inherit;">より正確には、メイン関数が必要とするデータによって異なります。</font><font style="vertical-align: inherit;">予測するのではなく、コード自体を使用してリバースエンジニアリングを実行しようとするとどうなるでしょうか。</font><font style="vertical-align: inherit;">単純な状況では、テストで一般的に使用されるプロキシアプローチが役立ちます。</font><font style="vertical-align: inherit;">Mockitoなどのライブラリーは、インターフェース実装を備えたクラスを生成します。これは、呼び出しに関する情報も蓄積できます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのライブラリでも同様のアプローチが使用されています</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロキシされたリポジトリを使用してメイン関数を呼び出し、必要なデータに関する情報を収集すると、このデータをパッケージの形式で取得し、メイン関数を再度呼び出して最終結果を取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主な条件は次のとおりです。要求されたデータは後続の要求に影響を与えてはなりません。プロキシは実際のデータを返さず、一部のスタブのみを返すため、関連するデータの分岐と受信はすべて消えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回のケースでは、メッセージリクエストの結果に基づいてさらにリクエストが行われるため、messageRepositoryをプロキシすることは無意味です。 messageRepositoryに対する要求は1つしかないため、これは問題ではありません。したがって、ここではバッチ処理は必要ありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単純な関数UserReference-&gt; UserRemoteおよびFileReference-&gt; FileHeadRemoteをプロキシするので、引数の2つのリストを蓄積する必要があります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その結果、次の結果が得られます。</font></font></b><div class="spoiler_text"><code><font color="7f0055"><b>class&nbsp;</b></font><font color="3e7eff"><b>ChatRestController</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">messageRepository</font>:&nbsp;<font color="3e7eff"><b>ChatMessageRepository</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">userRepository</font>:&nbsp;<font color="3e7eff"><b>UserRemoteApi</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>private&nbsp;val&nbsp;</b></font><font color="566874">fileRepository</font>:&nbsp;<font color="3e7eff"><b>FileRemoteApi</b></font><br>
<font color="000066">)&nbsp;</font>:&nbsp;<font color="3e7eff"><b>ChatRestApi&nbsp;</b></font><font color="000066">{</font><br>
&nbsp;&nbsp;<font color="7f0055"><b>override&nbsp;fun&nbsp;</b></font><font color="170591"><b>getLast</b></font><font color="000066">(</font><font color="000066"><i>n</i></font>:&nbsp;<font color="3e7eff"><b>Int</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="333333">&gt;&nbsp;</font><font color="000066">{</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">messages&nbsp;</font><font color="333333">=&nbsp;</font><font color="566874">messageRepository</font><font color="333333">.</font><font color="170591">findLast</font><font color="000066">(</font><font color="000066"><i>n</i></font><font color="000066">)</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>fun&nbsp;</b></font><font color="170591"><b>transform</b></font><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><i>getUser</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>UserReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>UserRemote</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><i>getFile</i></font>:&nbsp;<font color="000066">(</font><font color="3e7eff"><b>FileReference</b></font><font color="000066">)&nbsp;-&gt;&nbsp;</font><font color="3e7eff"><b>FileHeadRemote</b></font><br>
<font color="3e7eff"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font>:&nbsp;<font color="3e7eff"><b>List</b></font><font color="333333">&lt;</font><font color="3e7eff"><b>ChatMessageUI</b></font><font color="333333">&gt;&nbsp;=</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="3e7eff"><b>messages</b></font><font color="333333">.</font><i><b>map</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i><b>recursiveMemoize&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>self&nbsp;</i></font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066"><i>message</i></font><font color="333333">.</font><i><b>toFrontModel</b></i><font color="000066">(</font><font color="000066"><i>getUser</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>getFile</i></font><font color="333333">,&nbsp;</font><font color="000066"><i>self</i></font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="3f7f5f">//&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">userIds&nbsp;</font><font color="333333">=&nbsp;</font><i><b>mutableSetOf</b></i><font color="333333">&lt;</font><font color="3e7eff"><b>UserReference</b></font><font color="333333">&gt;</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>val&nbsp;</b></font><font color="170591">fileIds&nbsp;</font><font color="333333">=&nbsp;</font><i><b>mutableSetOf</b></i><font color="333333">&lt;</font><font color="3e7eff"><b>FileReference</b></font><font color="333333">&gt;</font><font color="000066">()</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="170591">transform</font><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>userIds&nbsp;</b></font><font color="333333">+=&nbsp;</font><b>it</b><font color="333333">;&nbsp;</font><font color="170591">UserRemote</font><font color="000066">(</font><font color="333333"><b>0L</b></font><font color="333333">,&nbsp;</font><b>""</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="3e7eff"><b>fileIds&nbsp;</b></font><font color="333333">+=&nbsp;</font><font color="000066"><i>it</i></font><font color="333333">;&nbsp;</font><font color="170591">FileHeadRemote</font><font color="000066">(</font><font color="333333"><b>0L</b></font><font color="333333">,&nbsp;</font><b>""</b><font color="000066">)&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="7f0055"><b>return&nbsp;</b></font><i><b>runBlocking</b></i><font color="000066">(</font><font color="05314d"><b>IO</b></font><font color="000066">)&nbsp;</font><font color="000066"><b>{</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="3f7f5f">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i><b>async</b></i><font color="000066">(</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">userRepository</font><font color="333333">.</font><font color="170591">getUsersByIds</font><font color="000066">(</font><font color="3e7eff"><b>userIds</b></font><font color="000066">)</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><font color="333333">,</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>{&nbsp;</b></font><font color="566874">fileRepository</font><font color="333333">.</font><font color="170591">getHeadsByIds</font><font color="000066">(</font><font color="3e7eff"><b>fileIds</b></font><font color="000066">)</font><font color="333333">.</font><i><b>associateBy&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066"><i>it</i></font><font color="333333">.</font><font color="566874">id&nbsp;</font><font color="000066"><b>}</b></font>::get<font color="333333">.</font><i><b>orThrow</b></i><font color="000066">()&nbsp;</font><font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="000066">)</font><font color="333333">.</font><font color="170591">await</font><font color="000066">()</font><font color="333333">.</font><i><b>let&nbsp;</b></i><font color="000066"><b>{&nbsp;</b></font><font color="000066">(</font><font color="170591">getUser</font><font color="333333">,&nbsp;</font><font color="170591">getFile</font><font color="000066">)&nbsp;</font><font color="000066"><b>-&gt;</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font><font color="170591">transform</font><font color="000066">(</font><font color="170591">getUser</font><font color="333333">,&nbsp;</font><font color="170591">getFile</font><font color="000066">)</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="000066"><b>}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;}</b></font><br>
<font color="000066"><b>&nbsp;&nbsp;</b></font><font color="000066">}</font><br>
<font color="000066">}</font></code></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンスを測定する場合、このアプローチでは、関数を2回呼び出しますが、リバースエンジニアリング手法を使用するよりも悪くないことがわかります。</font><font style="vertical-align: inherit;">これは、外部クエリの実行時間と比較して、変換関数の実行時間を無視できるためです（この場合）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスヒューリスティックを使用する場合のパフォーマンスと比較すると、私たちの場合、クエリの累積はあまり効果的ではありません。</font><font style="vertical-align: inherit;">ただし、そのような優れたヒューリスティックを常に見つけることができるとは限らないことに注意してください。</font><font style="vertical-align: inherit;">たとえば、チャットのユーザー数が多く、ファイルの数も多く、ファイルがメッセージにほとんど添付されていない場合、ビジネスヒューリスティックのアルゴリズムはすぐに失われ、正直にリクエストのリストを受信します。</font></font><br>
<br>
<a name="Summary4"></a><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メリット：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリフェッチを実装するために、データ取得コードのリバースエンジニアリングは必要ありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの場合、メイン関数を変更してもプリフェッチには影響しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーラビリティはリバースエンジニアリングと同じくらい優れています。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイナス：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前のクエリの結果から次のクエリを独立させる必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはめったに使用されないため、ロジックはそれほど明白ではありません。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかな異国風にもかかわらず、プロキシとリコールによるリクエストの蓄積は、メイン機能のロジックが受信データに関連付けられていない状況で非常に適用できます。</font><font style="vertical-align: inherit;">ここでの主な問題は、リバースエンジニアリングの場合と同じです。現在の機能の実装に取り​​掛かっていますが、その程度ははるかに小さくなっています（次のクエリが以前のクエリの結果に依存しないという事実にのみ依存します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンスは少し低下しますが、プリフェッチコードでは、メイン関数の実装のすべてのニュアンスを考慮する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは、クエリ予測のための優れたビジネスヒューリスティックを構築できず、プリフェッチと関数の接続を削減したい場合に使用できます。</font></font><br>
<br>
<a name="Conclusion"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッチ処理の使用は、一見したところほど簡単ではありません。すべてのデザインパターンにこのプロパティがあると思います（キャッシュを覚えておいてください）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを効率的にバッチ処理するには、呼び出し元ができるだけ多くのリクエストを収集することが重要です。これは、アプリケーションの構造によって妨げられることがよくあります。データを効率的に処理できるようにアプリケーションを設計する（アプリケーションの反応性の高いデバイスにつながる可能性が非常に高い）か、よくあることですが、大幅な再構築を行わずに既存のアプリケーションにバッチ処理を実装してみます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリをまとめる最も明白な方法は、重いクエリを探すために既存のコードをリバースエンジニアリングすることです。</font><font style="vertical-align: inherit;">このアプローチの主な欠点は、暗黙的なコード接続の増加です。</font><font style="vertical-align: inherit;">別の方法は、データをチャンクに分割するためにビジネス機能に関する情報を使用することです。チャンクは、多くの場合共有され、全体です。</font><font style="vertical-align: inherit;">時々、そのような効果的な分離のために、ストレージを非正規化することが必要になるかもしれませんが、これが成功した場合、バッチ処理のロジックはサブジェクト領域によって決定され、これは良いことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての要求を取得するそれほど明白ではない方法は、2つのパスを実装することです。</font><font style="vertical-align: inherit;">最初の段階では、必要なリクエストをすべて収集し、2番目の段階では、すでに受信したデータを処理します。</font><font style="vertical-align: inherit;">このアプローチの適用性は、相互のリクエストの独立性の要件によって制限されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467903/index.html">IntelliJ IDEAのトップ20ナビゲーション機能。パート1</a></li>
<li><a href="../ja467909/index.html">iOSでのチャット：ソケットの使用</a></li>
<li><a href="../ja467913/index.html">「粗悪な鉱物」、またはソーラーパネルの新しいインターフェイスを改善する方法</a></li>
<li><a href="../ja467915/index.html">Openshift内のpostgresの監視</a></li>
<li><a href="../ja467917/index.html">管理テンプレート</a></li>
<li><a href="../ja467921/index.html">ほこりっぽいペンを取り出してください：手書きは脳に良いです</a></li>
<li><a href="../ja467923/index.html">あなたはネットワークセキュリティの分野のアナリストになりたいと思っています...</a></li>
<li><a href="../ja467925/index.html">開発者がダークテーマをそんなに好きな理由</a></li>
<li><a href="../ja467929/index.html">カオスを組織する、または組織にプロセスアプローチを実装する方法</a></li>
<li><a href="../ja467933/index.html">それでも、PositがIEE​​E 754に代わる価値のある理由</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>