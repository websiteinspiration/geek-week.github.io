<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👢 ⛔️ 🐃 Fantastiques écluses de conseil et où ils vivent 🔮 🏵️ 👩🏻‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL dispose d'un mécanisme très pratique pour les verrous consultatifs , ce sont également des verrous consultatifs . Chez Tensor, nous les uti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fantastiques écluses de conseil et où ils vivent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488024/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL dispose d'un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mécanisme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> très pratique </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pour les verrous consultatifs</font></a><font style="vertical-align: inherit;"> , ce sont également </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des verrous consultatifs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Chez Tensor, nous les utilisons à de nombreux endroits du système, mais peu de gens comprennent en détail comment ils fonctionnent exactement et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quels problèmes peuvent être obtenus s'ils sont maltraités</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/sc/ak/ziscak3l-89wfdsjqhytpmkjalg.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur les serrures</font></font></b><div class="spoiler_text">   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    PostgreSQL</a>.</div></div><br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avantages des verrous de recommandation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La différence fondamentale entre ce mécanisme et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les verrous «ordinaires» de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table / page / enregistrement est qu'il existe plusieurs fonctionnalités clés.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verrouillage ID personnalisé</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les verrous «normaux» dans PG sont toujours liés à un objet de base de données spécifique (table, enregistrement, page de données) et au processus desservant la connexion. </font><font style="vertical-align: inherit;">Les verrous consultatifs sont également un processus, mais au lieu d'un objet réel, un identifiant abstrait peut être défini comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bigint)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier, entier)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, attacher chaque verrou à un processus signifie qu'en le nommant via </font></font><code>pg_terminate_backend(pid)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou en complétant correctement la connexion du côté client, vous pouvez vous débarrasser de tous les verrous imposés par lui.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAS Check for Lock Capture</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CAS est une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comparaison et un ensemble</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">-à-</font></a><font style="vertical-align: inherit;"> dire que la vérification de la capacité de capture et la capture du verrou lui-même ont lieu comme une seule opération atomique, et évidemment personne ne peut «se caler» entre eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, si vous faites d'abord une demande de vérification à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , regardez le résultat, puis décidez de verrouiller ou non, alors personne ne peut garantir qu'entre ces opérations, personne n'arrivera à prendre l'objet dont vous avez besoin. </font><font style="vertical-align: inherit;">Mais si vous utilisez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_try_advisory_lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alors vous recevrez immédiatement ce verrou, ou la fonction reviendra simplement </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-capture sans exceptions et attentes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des verrous «normaux» existent dans le modèle </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Si vous avez déjà demandé un verrou, attendez. Si vous ne voulez pas attendre ( </font></font><code>NOWAIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>statement_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - est ici une exception "</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cette approche interfère considérablement dans la transaction, car vous devez alors implémenter un bloc </font></font><code>BEGIN-EXCEPTION-END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le traitement ou annuler ( </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) la transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La seule façon d'éviter ce comportement est d'utiliser la conception </font></font><code>SELECT ... SKIP LOCKED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournie avec la version 9.5. Malheureusement, avec cette méthode, les options «n’avaient pas du tout quoi bloquer» et «était, mais étaient déjà bloquées» deviennent indiscernables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les verrous recommandés causés par les </font><font style="vertical-align: inherit;">fonctions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reviennent simplement </font></font><code>TRUE/FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne confondez pas </font></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">- la première fonction </font><b><font style="vertical-align: inherit;">attendra</font></b><font style="vertical-align: inherit;"> jusqu'à ce qu'elle reçoive un verrou, et la seconde retournera immédiatement immédiatement </font><font style="vertical-align: inherit;">s'il est impossible de le capturer "maintenant".</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>FALSE</code><font style="vertical-align: inherit;"></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se verrouille pendant et après la transaction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai mentionné ci-dessus, les verrous d'objet sont «attachés» au processus et n'existent que dans le cadre de la transaction en cours. </font><font style="vertical-align: inherit;">Même juste pour imposer - ne réussira pas:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> tbl;
<span class="hljs-comment">-- ERROR:  LOCK TABLE can only be used in transaction blocks</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, à la fin de la transaction, tous les verrous qui lui sont imposés sont supprimés. </font><font style="vertical-align: inherit;">En revanche, les verrous consultatifs ont été initialement conçus avec la capacité de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenir des verrous et en dehors du champ d'une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">1</span>);
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> locktype = <span class="hljs-string">'advisory'</span>;</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+--------------<font></font>
locktype           | advisory<font></font>
database           | 263911484<font></font>
relation           |<font></font>
page               |<font></font>
tuple              |<font></font>
virtualxid         |<font></font>
transactionid      |<font></font>
classid            | 0 &lt;--  int4 #1    int8<font></font>
objid              | 1 &lt;--  int4 #2    int8<font></font>
objsubid           | 1<font></font>
virtualtransaction | 416/475768<font></font>
pid                | 29264<font></font>
mode               | ExclusiveLock<font></font>
granted            | t<font></font>
fastpath           | f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais déjà à partir de la version 9.1, des </font><font style="vertical-align: inherit;">versions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xact</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctions consultatives sont apparues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui vous permettent d'implémenter le comportement des verrous "ordinaires" qui sont automatiquement libérés lorsque la transaction qui les a imposés est terminée.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemples d'utilisation dans VLSI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, comme tout autre verrou, le conseil sert à garantir l'unicité du traitement d'une ressource. </font><font style="vertical-align: inherit;">Dans notre pays, ces ressources sont généralement soit la table entière, soit un enregistrement spécifique de la table, qui pour une raison quelconque ne veut pas être "verrouillé".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monotraitement du travailleur</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la nécessité de traiter certaines données dans la base de données est déclenchée par un événement externe, mais que le multitraitement est redondant ou peut conduire à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une condition de concurrence critique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il est raisonnable de faire fonctionner </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seul </font><b><font style="vertical-align: inherit;">processus</font></b><font style="vertical-align: inherit;"> sur ces données </font><b><font style="vertical-align: inherit;">à la fois</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, nous allons essayer de verrouiller avec l'identificateur de table comme premier paramètre et l'ID de traitement d'application spécifique comme deuxième:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(
  <span class="hljs-string">'processed_table'</span>::regclass::<span class="hljs-keyword">oid</span>
, <span class="hljs-number">-1</span> <span class="hljs-comment">--   worker'</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous revenons </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors quelqu'un d'autre détient déjà un tel verrou, et spécifiquement ce processus n'a rien à faire, mais il est préférable de terminer tranquillement. </font><font style="vertical-align: inherit;">C'est ainsi que fonctionne, par exemple, le processus de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calcul</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dynamique </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">du coût des marchandises dans un entrepôt</font></a><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de manière</font></a><font style="vertical-align: inherit;"> isolée pour chaque schéma client individuel.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement des files d'attente simultanées</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la tâche est «l'opposé» - nous voulons que les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tâches d'une table de file d'attente soient</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traitées aussi rapidement que possible, multithread, tolérantes aux pannes et même à partir de logiques métier différentes (enfin, nous n'en avons pas la puissance) - par exemple, comme le fait notre opérateur sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfert des rapports électroniques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux agences gouvernementales ou au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service OFD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les BL de «traitement» étant différents serveurs, aucun mutex ne peut plus être raccroché. Il n'est pas sûr de désigner un coordinateur de processus de distribution de tâches spéciales, de «mourir» lui - et tout augmentera. Et il s'avère donc qu'il est plus efficace de distribuer les tâches directement au niveau de la base de données, et il y a une telle façon - dans les temps anciens, le modèle a été honnêtement espionné par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Koterov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis modifié de manière créative.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous imposons un verrou sur l'ID de table et PK d'un enregistrement particulier:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  queue_table<font></font>
<span class="hljs-keyword">WHERE</span>
  pg_try_advisory_lock(<span class="hljs-string">'queue_table'</span>::regclass::<span class="hljs-keyword">oid</span>, pk_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk_id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le processus recevra de la table le premier record qui n'a pas encore été bloqué par ses frères concurrents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, si PK ne se compose pas de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier, entier)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (comme dans le même calcul de coût, par exemple), vous pouvez imposer un verrou directement sur cette paire - il est peu probable qu'une intersection avec le "concurrent" se produise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important! </font><font style="vertical-align: inherit;">N'oubliez pas d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entretenir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> régulièrement et </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">correctement votre table de file d'attente</font></a><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement exclusif des documents</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est utilisé partout dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les solutions de gestion de documents</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En effet, dans un système web distribué, un même document peut être ouvert pour être visualisé par différents utilisateurs en même temps, mais il ne peut être traité (changer son état, etc.) à tout moment que par un seul.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problèmes traditionnels</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où sans eux! </font><font style="vertical-align: inherit;">Presque tout se résume à une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chose</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">ils n'ont pas déverrouillé ce qu'ils ont verrouillé</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superposition multiple d'un verrou consultatif</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , comme on dit:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si plusieurs demandes de blocage sont reçues en même temps, elles s'accumulent, donc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si une ressource a été bloquée trois fois, elle doit être débloquée trois fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour être disponible dans d'autres sessions.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettez trop de verrous à la fois</font></font></h4><br>
<img src="https://habrastorage.org/webt/c-/q5/19/c-q519tdomjwjhoofqaljskvcxa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des milliers d'entre eux! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez le manuel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de nouveau </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les verrous consultatifs et réguliers sont stockés dans la zone de mémoire partagée, dont la taille est déterminée par les paramètres de configuration </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est important que cette mémoire soit suffisante, car </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinon le serveur ne pourra émettre </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucun</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verrou</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, le nombre de verrous recommandés qu'un serveur peut émettre est généralement limité à des dizaines ou des centaines de milliers, selon la configuration du serveur.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, si une situation survient lorsque vous souhaitez imposer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plusieurs milliers de verrous consultatifs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (même si vous les supprimez correctement plus tard) - réfléchissez bien où vous exécuterez lorsque le serveur se lèvera.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuites lors du filtrage des enregistrements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous prenons la demande précédente et ajoutons une condition inoffensive telle que le contrôle de parité ID - </font></font><code>AND pk_id % 2 = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les deux conditions</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour chaque inscription </font><font style="vertical-align: inherit;">seront vérifiées </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">En conséquence, il a été </font></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminé, le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrou a été superposé, puis l'enregistrement a été filtré</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par parité. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x1/vo/jc/x1vojcx77r-yh1i_j4ygddkfqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou une option du manuel:</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12345</span>; <span class="hljs-comment">-- ok</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">12345</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout - le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocage demeure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais nous n'en sommes pas conscients. </font><font style="vertical-align: inherit;">Il est traité avec les demandes correctes, dans le pire des cas - </font></font><code>pg_advisory_unlock_all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, confus!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des classiques du genre ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Confus </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">, et se demandent pourquoi ça marche depuis longtemps. </font><font style="vertical-align: inherit;">Mais parce que la version non-try </font><b><font style="vertical-align: inherit;">attend</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Confondre </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">, et se demander où est passé le verrou - et cela "s'est terminé" avec la transaction. </font><font style="vertical-align: inherit;">Et la transaction consistait en une seule demande, car nulle part elle n'a été déclarée "explicitement", oui.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_try_advisory_<i><b>xact</b></i>_lock</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travailler avec pgbouncer</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est une source de douleur distincte pour beaucoup lorsque, pour des raisons de performance, travailler avec la base de données passe par </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que deux de vos transactions voisines qui s'exécutent sur la même connexion à la base de données (qui passe par le pgbouncer) peuvent être exécutées </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans différentes connexions "physiques"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du côté de la base de données. </font><font style="vertical-align: inherit;">Et ils ont leurs propres serrures ... Chacun a </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/l6/h0/ecl6h02_l0hbh4kspdrba2g0a5c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
quelques options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou allez travailler via une connexion directe à la base de données</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou inventer un algorithme pour que tous les verrous consultatifs se trouvent uniquement dans la transaction (xact)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour le moment.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488010/index.html">Outils de conception pilotés par domaine</a></li>
<li><a href="../fr488012/index.html">Parking pour vos inconvénients</a></li>
<li><a href="../fr488014/index.html">9. Mise en route de Fortinet v6.0. Journalisation et rapports</a></li>
<li><a href="../fr488018/index.html">CAPTCHA, cas particulier: on casse un réseau neuronal avec trente lignes de code</a></li>
<li><a href="../fr488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../fr488026/index.html">Bijoux, imprimante 3D Formlabs et protection de l'environnement</a></li>
<li><a href="../fr488028/index.html">Comment commencer à créer un jeu dans UE4</a></li>
<li><a href="../fr488030/index.html">Comment organiser les skins dans Symfony</a></li>
<li><a href="../fr488034/index.html">Que peut-on faire en 48 heures? Entretien avec le vainqueur du hackathon bioinformatique BioHack 2019</a></li>
<li><a href="../fr488036/index.html">Le domaine corp.com est en vente. Il est dangereux pour des centaines de milliers d'ordinateurs d'entreprise exécutant Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>