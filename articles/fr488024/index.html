<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¢ â›”ï¸ ğŸƒ Fantastiques Ã©cluses de conseil et oÃ¹ ils vivent ğŸ”® ğŸµï¸ ğŸ‘©ğŸ»â€ğŸŒ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL dispose d'un mÃ©canisme trÃ¨s pratique pour les verrous consultatifs , ce sont Ã©galement des verrous consultatifs . Chez Tensor, nous les uti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fantastiques Ã©cluses de conseil et oÃ¹ ils vivent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488024/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL dispose d'un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mÃ©canisme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trÃ¨s pratique </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pour les verrous consultatifs</font></a><font style="vertical-align: inherit;"> , ce sont Ã©galement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des verrous consultatifs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Chez Tensor, nous les utilisons Ã  de nombreux endroits du systÃ¨me, mais peu de gens comprennent en dÃ©tail comment ils fonctionnent exactement et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quels problÃ¨mes peuvent Ãªtre obtenus s'ils sont maltraitÃ©s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/sc/ak/ziscak3l-89wfdsjqhytpmkjalg.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur les serrures</font></font></b><div class="spoiler_text">   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    PostgreSQL</a>.</div></div><br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avantages des verrous de recommandation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diffÃ©rence fondamentale entre ce mÃ©canisme et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les verrous Â«ordinairesÂ» de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table / page / enregistrement est qu'il existe plusieurs fonctionnalitÃ©s clÃ©s.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verrouillage ID personnalisÃ©</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les verrous Â«normauxÂ» dans PG sont toujours liÃ©s Ã  un objet de base de donnÃ©es spÃ©cifique (table, enregistrement, page de donnÃ©es) et au processus desservant la connexion. </font><font style="vertical-align: inherit;">Les verrous consultatifs sont Ã©galement un processus, mais au lieu d'un objet rÃ©el, un identifiant abstrait peut Ãªtre dÃ©fini comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bigint)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou comme </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier, entier)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, attacher chaque verrou Ã  un processus signifie qu'en le nommant via </font></font><code>pg_terminate_backend(pid)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou en complÃ©tant correctement la connexion du cÃ´tÃ© client, vous pouvez vous dÃ©barrasser de tous les verrous imposÃ©s par lui.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAS Check for Lock Capture</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CAS est une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comparaison et un ensemble</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">-Ã -</font></a><font style="vertical-align: inherit;"> dire que la vÃ©rification de la capacitÃ© de capture et la capture du verrou lui-mÃªme ont lieu comme une seule opÃ©ration atomique, et Ã©videmment personne ne peut Â«se calerÂ» entre eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, si vous faites d'abord une demande de vÃ©rification Ã  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , regardez le rÃ©sultat, puis dÃ©cidez de verrouiller ou non, alors personne ne peut garantir qu'entre ces opÃ©rations, personne n'arrivera Ã  prendre l'objet dont vous avez besoin. </font><font style="vertical-align: inherit;">Mais si vous utilisez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_try_advisory_lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alors vous recevrez immÃ©diatement ce verrou, ou la fonction reviendra simplement </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-capture sans exceptions et attentes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des verrous Â«normauxÂ» existent dans le modÃ¨le </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«Si vous avez dÃ©jÃ  demandÃ© un verrou, attendez. Si vous ne voulez pas attendre ( </font></font><code>NOWAIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>statement_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - est ici une exception "</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cette approche interfÃ¨re considÃ©rablement dans la transaction, car vous devez alors implÃ©menter un bloc </font></font><code>BEGIN-EXCEPTION-END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour le traitement ou annuler ( </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) la transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La seule faÃ§on d'Ã©viter ce comportement est d'utiliser la conception </font></font><code>SELECT ... SKIP LOCKED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournie avec la version 9.5. Malheureusement, avec cette mÃ©thode, les options Â«nâ€™avaient pas du tout quoi bloquerÂ» et Â«Ã©tait, mais Ã©taient dÃ©jÃ  bloquÃ©esÂ» deviennent indiscernables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les verrous recommandÃ©s causÃ©s par les </font><font style="vertical-align: inherit;">fonctions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reviennent simplement </font></font><code>TRUE/FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne confondez pas </font></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">- la premiÃ¨re fonction </font><b><font style="vertical-align: inherit;">attendra</font></b><font style="vertical-align: inherit;"> jusqu'Ã  ce qu'elle reÃ§oive un verrou, et la seconde retournera immÃ©diatement immÃ©diatement </font><font style="vertical-align: inherit;">s'il est impossible de le capturer "maintenant".</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>FALSE</code><font style="vertical-align: inherit;"></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se verrouille pendant et aprÃ¨s la transaction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai mentionnÃ© ci-dessus, les verrous d'objet sont Â«attachÃ©sÂ» au processus et n'existent que dans le cadre de la transaction en cours. </font><font style="vertical-align: inherit;">MÃªme juste pour imposer - ne rÃ©ussira pas:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> tbl;
<span class="hljs-comment">-- ERROR:  LOCK TABLE can only be used in transaction blocks</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consÃ©quence, Ã  la fin de la transaction, tous les verrous qui lui sont imposÃ©s sont supprimÃ©s. </font><font style="vertical-align: inherit;">En revanche, les verrous consultatifs ont Ã©tÃ© initialement conÃ§us avec la capacitÃ© de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenir des verrous et en dehors du champ d'une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">1</span>);
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> locktype = <span class="hljs-string">'advisory'</span>;</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+--------------<font></font>
locktype           | advisory<font></font>
database           | 263911484<font></font>
relation           |<font></font>
page               |<font></font>
tuple              |<font></font>
virtualxid         |<font></font>
transactionid      |<font></font>
classid            | 0 &lt;--  int4 #1    int8<font></font>
objid              | 1 &lt;--  int4 #2    int8<font></font>
objsubid           | 1<font></font>
virtualtransaction | 416/475768<font></font>
pid                | 29264<font></font>
mode               | ExclusiveLock<font></font>
granted            | t<font></font>
fastpath           | f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais dÃ©jÃ  Ã  partir de la version 9.1, des </font><font style="vertical-align: inherit;">versions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xact</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctions consultatives sont apparues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui vous permettent d'implÃ©menter le comportement des verrous "ordinaires" qui sont automatiquement libÃ©rÃ©s lorsque la transaction qui les a imposÃ©s est terminÃ©e.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemples d'utilisation dans VLSI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, comme tout autre verrou, le conseil sert Ã  garantir l'unicitÃ© du traitement d'une ressource. </font><font style="vertical-align: inherit;">Dans notre pays, ces ressources sont gÃ©nÃ©ralement soit la table entiÃ¨re, soit un enregistrement spÃ©cifique de la table, qui pour une raison quelconque ne veut pas Ãªtre "verrouillÃ©".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monotraitement du travailleur</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la nÃ©cessitÃ© de traiter certaines donnÃ©es dans la base de donnÃ©es est dÃ©clenchÃ©e par un Ã©vÃ©nement externe, mais que le multitraitement est redondant ou peut conduire Ã  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une condition de concurrence critique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il est raisonnable de faire fonctionner </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seul </font><b><font style="vertical-align: inherit;">processus</font></b><font style="vertical-align: inherit;"> sur ces donnÃ©es </font><b><font style="vertical-align: inherit;">Ã  la fois</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, nous allons essayer de verrouiller avec l'identificateur de table comme premier paramÃ¨tre et l'ID de traitement d'application spÃ©cifique comme deuxiÃ¨me:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(
  <span class="hljs-string">'processed_table'</span>::regclass::<span class="hljs-keyword">oid</span>
, <span class="hljs-number">-1</span> <span class="hljs-comment">--   worker'</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous revenons </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors quelqu'un d'autre dÃ©tient dÃ©jÃ  un tel verrou, et spÃ©cifiquement ce processus n'a rien Ã  faire, mais il est prÃ©fÃ©rable de terminer tranquillement. </font><font style="vertical-align: inherit;">C'est ainsi que fonctionne, par exemple, le processus de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calcul</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dynamique </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">du coÃ»t des marchandises dans un entrepÃ´t</font></a><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de maniÃ¨re</font></a><font style="vertical-align: inherit;"> isolÃ©e pour chaque schÃ©ma client individuel.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement des files d'attente simultanÃ©es</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la tÃ¢che est Â«l'opposÃ©Â» - nous voulons que les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tÃ¢ches d'une table de file d'attente soient</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traitÃ©es aussi rapidement que possible, multithread, tolÃ©rantes aux pannes et mÃªme Ã  partir de logiques mÃ©tier diffÃ©rentes (enfin, nous n'en avons pas la puissance) - par exemple, comme le fait notre opÃ©rateur sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfert des rapports Ã©lectroniques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux agences gouvernementales ou au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service OFD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les BL de Â«traitementÂ» Ã©tant diffÃ©rents serveurs, aucun mutex ne peut plus Ãªtre raccrochÃ©. Il n'est pas sÃ»r de dÃ©signer un coordinateur de processus de distribution de tÃ¢ches spÃ©ciales, de Â«mourirÂ» lui - et tout augmentera. Et il s'avÃ¨re donc qu'il est plus efficace de distribuer les tÃ¢ches directement au niveau de la base de donnÃ©es, et il y a une telle faÃ§on - dans les temps anciens, le modÃ¨le a Ã©tÃ© honnÃªtement espionnÃ© par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Koterov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis modifiÃ© de maniÃ¨re crÃ©ative.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous imposons un verrou sur l'ID de table et PK d'un enregistrement particulier:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  queue_table<font></font>
<span class="hljs-keyword">WHERE</span>
  pg_try_advisory_lock(<span class="hljs-string">'queue_table'</span>::regclass::<span class="hljs-keyword">oid</span>, pk_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk_id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le processus recevra de la table le premier record qui n'a pas encore Ã©tÃ© bloquÃ© par ses frÃ¨res concurrents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, si PK ne se compose pas de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entier, entier)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (comme dans le mÃªme calcul de coÃ»t, par exemple), vous pouvez imposer un verrou directement sur cette paire - il est peu probable qu'une intersection avec le "concurrent" se produise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important! </font><font style="vertical-align: inherit;">N'oubliez pas d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entretenir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rÃ©guliÃ¨rement et </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">correctement votre table de file d'attente</font></a><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement exclusif des documents</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est utilisÃ© partout dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les solutions de gestion de documents</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En effet, dans un systÃ¨me web distribuÃ©, un mÃªme document peut Ãªtre ouvert pour Ãªtre visualisÃ© par diffÃ©rents utilisateurs en mÃªme temps, mais il ne peut Ãªtre traitÃ© (changer son Ã©tat, etc.) Ã  tout moment que par un seul.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProblÃ¨mes traditionnels</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OÃ¹ sans eux! </font><font style="vertical-align: inherit;">Presque tout se rÃ©sume Ã  une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chose</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">ils n'ont pas dÃ©verrouillÃ© ce qu'ils ont verrouillÃ©</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superposition multiple d'un verrou consultatif</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , comme on dit:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si plusieurs demandes de blocage sont reÃ§ues en mÃªme temps, elles s'accumulent, donc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si une ressource a Ã©tÃ© bloquÃ©e trois fois, elle doit Ãªtre dÃ©bloquÃ©e trois fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour Ãªtre disponible dans d'autres sessions.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettez trop de verrous Ã  la fois</font></font></h4><br>
<img src="https://habrastorage.org/webt/c-/q5/19/c-q519tdomjwjhoofqaljskvcxa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des milliers d'entre eux! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez le manuel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de nouveau </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les verrous consultatifs et rÃ©guliers sont stockÃ©s dans la zone de mÃ©moire partagÃ©e, dont la taille est dÃ©terminÃ©e par les paramÃ¨tres de configuration </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est important que cette mÃ©moire soit suffisante, car </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinon le serveur ne pourra Ã©mettre </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucun</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verrou</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, le nombre de verrous recommandÃ©s qu'un serveur peut Ã©mettre est gÃ©nÃ©ralement limitÃ© Ã  des dizaines ou des centaines de milliers, selon la configuration du serveur.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En gÃ©nÃ©ral, si une situation survient lorsque vous souhaitez imposer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plusieurs milliers de verrous consultatifs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mÃªme si vous les supprimez correctement plus tard) - rÃ©flÃ©chissez bien oÃ¹ vous exÃ©cuterez lorsque le serveur se lÃ¨vera.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuites lors du filtrage des enregistrements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous prenons la demande prÃ©cÃ©dente et ajoutons une condition inoffensive telle que le contrÃ´le de paritÃ© ID - </font></font><code>AND pk_id % 2 = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les deux conditions</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour chaque inscription </font><font style="vertical-align: inherit;">seront vÃ©rifiÃ©es </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">En consÃ©quence, il a Ã©tÃ© </font></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminÃ©, le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrou a Ã©tÃ© superposÃ©, puis l'enregistrement a Ã©tÃ© filtrÃ©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par paritÃ©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x1/vo/jc/x1vojcx77r-yh1i_j4ygddkfqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou une option du manuel:</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12345</span>; <span class="hljs-comment">-- ok</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">12345</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout - le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocage demeure</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais nous n'en sommes pas conscients. </font><font style="vertical-align: inherit;">Il est traitÃ© avec les demandes correctes, dans le pire des cas - </font></font><code>pg_advisory_unlock_all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, confus!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des classiques du genre ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Confus </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">, et se demandent pourquoi Ã§a marche depuis longtemps. </font><font style="vertical-align: inherit;">Mais parce que la version non-try </font><b><font style="vertical-align: inherit;">attend</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Confondre </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">, et se demander oÃ¹ est passÃ© le verrou - et cela "s'est terminÃ©" avec la transaction. </font><font style="vertical-align: inherit;">Et la transaction consistait en une seule demande, car nulle part elle n'a Ã©tÃ© dÃ©clarÃ©e "explicitement", oui.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_try_advisory_<i><b>xact</b></i>_lock</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travailler avec pgbouncer</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est une source de douleur distincte pour beaucoup lorsque, pour des raisons de performance, travailler avec la base de donnÃ©es passe par </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en mode transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que deux de vos transactions voisines qui s'exÃ©cutent sur la mÃªme connexion Ã  la base de donnÃ©es (qui passe par le pgbouncer) peuvent Ãªtre exÃ©cutÃ©es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans diffÃ©rentes connexions "physiques"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du cÃ´tÃ© de la base de donnÃ©es. </font><font style="vertical-align: inherit;">Et ils ont leurs propres serrures ... Chacun a </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/l6/h0/ecl6h02_l0hbh4kspdrba2g0a5c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
quelques options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou allez travailler via une connexion directe Ã  la base de donnÃ©es</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou inventer un algorithme pour que tous les verrous consultatifs se trouvent uniquement dans la transaction (xact)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour le moment.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488010/index.html">Outils de conception pilotÃ©s par domaine</a></li>
<li><a href="../fr488012/index.html">Parking pour vos inconvÃ©nients</a></li>
<li><a href="../fr488014/index.html">9. Mise en route de Fortinet v6.0. Journalisation et rapports</a></li>
<li><a href="../fr488018/index.html">CAPTCHA, cas particulier: on casse un rÃ©seau neuronal avec trente lignes de code</a></li>
<li><a href="../fr488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../fr488026/index.html">Bijoux, imprimante 3D Formlabs et protection de l'environnement</a></li>
<li><a href="../fr488028/index.html">Comment commencer Ã  crÃ©er un jeu dans UE4</a></li>
<li><a href="../fr488030/index.html">Comment organiser les skins dans Symfony</a></li>
<li><a href="../fr488034/index.html">Que peut-on faire en 48 heures? Entretien avec le vainqueur du hackathon bioinformatique BioHack 2019</a></li>
<li><a href="../fr488036/index.html">Le domaine corp.com est en vente. Il est dangereux pour des centaines de milliers d'ordinateurs d'entreprise exÃ©cutant Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>