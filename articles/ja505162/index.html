<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆 😍 🏟️ ランタイムでのKotlinのコンパイル 🎎 🎻 📠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！
 

ランタイムですぐにコードを生成して実行すれば簡単に解決できるタスクをよく目にしたと思います。この方法は、コード生成を使用して場所を最適化したい場合に便利です。ただし、ライブラリを提供しているため、完成したコードは、アプリケーションが起動したときにのみわかります（そのため、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ランタイムでのKotlinのコンパイル</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dbtc/blog/505162/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイムですぐにコードを生成して実行すれば簡単に解決できるタスクをよく目にしたと思います。</font><font style="vertical-align: inherit;">この方法は、コード生成を使用して場所を最適化したい場合に便利です。</font><font style="vertical-align: inherit;">ただし、ライブラリを提供しているため、完成したコードは、アプリケーションが起動したときにのみわかります（そのため、アセンブリ手順は複雑になりません）。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、プログラムの実行中にコードを生成し、すぐに実行する方法を紹介します。本質的に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsr233に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はKotlinコンパイラを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">使用し</font></a><font style="vertical-align: inherit;">ます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクとして、あなたは比較的人気のあるものを取ることができます-私たちは</font><font style="vertical-align: inherit;">データベースからの応答を解析</font><font style="vertical-align: inherit;">するためにある種の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AOP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作り</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">したがって、プログラマーは自分のコードに属性でラベルを付けることができ、実行時に最適化された機能するコードを即座に生成してコンパイルします。</font><font style="vertical-align: inherit;">ただし、実際には、そのような戦術の範囲ははるかに広いです：プログラム可能な構成を作成でき、既存のコードを最適化できます（条件を変更されない事前計算された値で置き換えることにより）。</font><font style="vertical-align: inherit;">もちろん、一般化されたコードを強調するのに言語の表現力が十分でない場合でも、コピーアンドペーストを回避できます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">利用でき</font><font style="vertical-align: inherit;">、Java 11を実行する必要があります。この記事では、ログや診断などなしでコードの短縮バージョンを提供します。</font></font></p><a name="habracut"></a><br>
<h1 id="zadacha"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事</font></font></h1><br>
<p><strong> :            ,   ,  , .      Hibernate  Spring Data,      </strong>.</p><br>
<p>  :      ,  «    SQL   »      .</p><br>
<p>   :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">data</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DbUser</span></span>(
    <span class="hljs-meta">@SqlMapping(columnName = <span class="hljs-meta-string">"name"</span>)</span>
    <span class="hljs-keyword">val</span> name: UserName,
    <span class="hljs-meta">@SqlMapping(columnName1 = <span class="hljs-meta-string">"user_email_name"</span>, columnName2 = <span class="hljs-meta-string">"user_email_domain"</span>)</span>
    <span class="hljs-keyword">val</span> email: Email<font></font>
)</code></pre><br>
<p> ,     ,  Spring JDBC   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ResultSet</a>.</p><br>
<p>    ,       :</p><br>
<pre><code class="java hljs"><span class="hljs-function">String <span class="hljs-title">getString</span><span class="hljs-params">(<span class="hljs-keyword">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException</span>;<font></font>
<font></font>
<span class="hljs-function">String <span class="hljs-title">getString</span><span class="hljs-params">(String columnLabel)</span> <span class="hljs-keyword">throws</span> SQLException</span>;</code></pre><br>
<p>   :</p><br>
<ol>
<li>            (- :  ,      ,    ,       ,     <code>getString(String columnLabel)</code>  NxM     ,  N/M —  / ).</li>
<li>  -      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">reflection</a>.   —    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">BeanPropertyRowMapper</a>  , ,  ,     .</li>
<li>     ,  <code>String</code>, <code>Int</code>,     . , c  <code>NonEmptyText</code> (    <code>String</code>,     )</li>
</ol><br>
<p>   ,      ,            .          :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">extractData</span><span class="hljs-params">(rs: <span class="hljs-type">ResultSet</span>)</span></span>: List&lt;DbUser&gt; {
      <span class="hljs-keyword">val</span> queryMetadata = rs.metaData
      <span class="hljs-keyword">val</span> queryColumnCount = queryMetadata.columnCount
      <span class="hljs-keyword">val</span> mapperColumnCount = <span class="hljs-number">3</span><font></font>
<font></font>
      require(queryColumnCount == mapperColumnCount)<font></font>
<font></font>
      <span class="hljs-keyword">val</span> columnIndex0 = rs.findColumn(<span class="hljs-string">"name"</span>)
      <span class="hljs-keyword">val</span> columnIndex1 = rs.findColumn(<span class="hljs-string">"user_email_name"</span>)
      <span class="hljs-keyword">val</span> columnIndex2 = rs.findColumn(<span class="hljs-string">"user_email_domain"</span>)
      <span class="hljs-keyword">val</span> result = mutableListOf&lt;DbUser&gt;()
      <span class="hljs-keyword">while</span> (rs.next()) {<font></font>
          result.add(<font></font>
              DbUser(<font></font>
                  name = UserName(rs.getValue(columnIndex0)),<font></font>
                  email = Email(EmailName(rs.getValue(columnIndex1)), EmailDomain(rs.getValue(columnIndex2)))<font></font>
              )<font></font>
          )<font></font>
      }<font></font>
      <span class="hljs-keyword">return</span> result<font></font>
   }<font></font>
}</code></pre><br>
<p>  :         .          ,        Spring JDBC,      ,   Java/Kotlin    .   — - ,    (,  reflection  ..).</p><br>
<h1 id="vypolnyaem-kotlin-script"> Kotlin Script</h1><br>
<p>       <code>Kotlin</code>   :    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Kotlin Compiler</a>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">jsr233</a>.       ,     ,    .       ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Class Loader</a>. ,      ,        (, Kotlin Script Compiler      Class Loader', ,   -         ).</p><br>
<p>-   .        Sql ,      ,      .  ,   :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ResultSetMapper</span>&lt;<span class="hljs-type">TMappingType</span>&gt; : <span class="hljs-type">ResultSetExtractor</span>&lt;<span class="hljs-type">List&lt;TMappingType</span>&gt;&gt;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DynamicResultSetMapperFactory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;TMappingType : Any&gt;</span> <span class="hljs-title">createForType</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">TMappingType</span>&gt;)</span></span>: ResultSetMapper&lt;TMappingType&gt;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> TMappingType : Any&gt;</span> DynamicResultSetMapperFactory.<span class="hljs-title">createForType</span><span class="hljs-params">()</span></span>: ResultSetMapper&lt;TMappingType&gt; {
    <span class="hljs-keyword">return</span> createForType(TMappingType::<span class="hljs-class"><span class="hljs-keyword">class</span>)</span>
}</code></pre><br>
<p><code>inline</code>    ,       ,     generic.      <code>ResultSetMapper</code>    : <code>return mapperFactory.createMapper&lt;MyClass&gt;()</code>.</p><br>
<p><code>ResultSetMapper</code>     Spring:</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ResultSetExtractor</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-function">T <span class="hljs-title">extractData</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException, DataAccessException</span>;<font></font>
}</code></pre><br>
<p>    ,      ,      .    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;TMappingType : Any&gt;</span> <span class="hljs-title">createForType</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">TMappingType</span>&gt;)</span></span>: ResultSetMapper&lt;TMappingType&gt; {
    <span class="hljs-keyword">val</span> sourceCode = getMapperSourceCode(clazz) <span class="hljs-comment">//    </span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> compiler.compile(sourceCode) <span class="hljs-comment">// </span>
}</code></pre><br>
<p>   <code>ResultSetMapper&lt;TMappingType&gt;</code>. ,      generic'     .   JVM     ,      . , ,     :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">object</span> : ResultSetMapper&lt;DbUser&gt; { <span class="hljs-comment">// -,  </span>
   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">extractData</span><span class="hljs-params">(rs: <span class="hljs-type">java</span>.<span class="hljs-type">sql</span>.<span class="hljs-type">ResultSet</span>)</span></span>: List&lt;DbUser&gt; {
      <span class="hljs-comment">/* generated code */</span><font></font>
   }<font></font>
}</code></pre><br>
<p>      :</p><br>
<ol>
<li>    classpath</li>
<li>   Java,    </li>
<li>  <code>ScriptEngineManager</code>   (        Sql)</li>
</ol><br>
<p>       <code>gradle</code>:</p><br>
<pre><code class="kotlin hljs">implementation(kotlin(<span class="hljs-string">"reflect"</span>))<font></font>
implementation(kotlin(<span class="hljs-string">"script-runtime"</span>))<font></font>
implementation(kotlin(<span class="hljs-string">"compiler-embeddable"</span>))<font></font>
implementation(kotlin(<span class="hljs-string">"script-util"</span>))<font></font>
implementation(kotlin(<span class="hljs-string">"scripting-compiler-embeddable"</span>))</code></pre><br>
<p>      "src/main/resources/META-INF/services/javax.script.ScriptEngineFactory" c  :</p><br>
<pre><code class="plaintext hljs">org.jetbrains.kotlin.script.jsr223.KotlinJsr223JvmLocalScriptEngineFactory</code></pre><br>
<p>    —    runtime:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;TResult&gt;</span> <span class="hljs-title">compile</span><span class="hljs-params">(sourceCode: <span class="hljs-type">String</span>)</span></span>: TResult {
    <span class="hljs-keyword">val</span> scriptEngine = ScriptEngineManager()<font></font>
<font></font>
    <span class="hljs-keyword">val</span> factory = scriptEngine.getEngineByExtension(<span class="hljs-string">"kts"</span>).factory <span class="hljs-comment">// JVM ,    kts   KotlinJsr223JvmLocalScriptEngineFactory</span><font></font>
<font></font>
    <span class="hljs-keyword">val</span> engine = factory.scriptEngine <span class="hljs-keyword">as</span> KotlinJsr223JvmLocalScriptEngine<font></font>
<font></font>
    <span class="hljs-meta">@Suppress(<span class="hljs-meta-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">return</span> engine.eval(sourceCode) <span class="hljs-keyword">as</span> TResult<font></font>
}</code></pre><br>
<h1 id="podgotavlivaem-model"> </h1><br>
<p>   ,             ,    .  ,      .</p><br>
<p>,       ,         . :</p><br>
<ol>
<li>  <code>userName: String</code>    <code>userName: UserName</code>,   <code>UserName</code>    .</li>
<li><code>UserName</code>    ,        .</li>
<li>    ,  ,         .</li>
</ol><br>
<p>   ,      :</p><br>
<p>  <code>NonEmptyText</code>,        :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NonEmptyText</span></span>(<span class="hljs-keyword">val</span> value: String) {
    <span class="hljs-keyword">init</span> {<font></font>
        require(value.isNotBlank()) {<font></font>
            <span class="hljs-string">"Empty text is prohibited for <span class="hljs-subst">${this.javaClass.simpleName}</span>. Actual value: <span class="hljs-variable">$this</span>"</span><font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === other) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (javaClass != other?.javaClass) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><font></font>
<font></font>
        other <span class="hljs-keyword">as</span> NonEmptyText<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (value != other.value) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> value.hashCode()<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> value<font></font>
    }<font></font>
}</code></pre><br>
<p>     :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">NonEmptyTextConstructor</span>&lt;<span class="hljs-type">out TResult : NonEmptyText</span>&gt; </span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span>: TResult<font></font>
}</code></pre><br>
<p>         <code>UserName</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserName</span></span>(value: String) : NonEmptyText(value) {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : NonEmptyTextConstructor&lt;UserName&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span> = UserName(value)<font></font>
    }<font></font>
}</code></pre><br>
<p>,     <code>UserName</code>,   .   <code>companion object</code>         , ..  ,  <code>UserName</code>   :</p><br>
<pre><code class="kotlin hljs">UserName.create(<span class="hljs-string">"123"</span>)</code></pre><br>
<p>        ,      <code>fun &lt;TValue&gt; createText(input: String?, constructor: NonEmptyTextConstructor&lt;TValue&gt;): TValue?</code>   <code>createText("123", UserName)</code>,   .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">type classes</a>,     JVM.</p><br>
<p>Email    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailUser</span></span>(value: String) : NonEmptyText(value) {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : NonEmptyTextConstructor&lt;EmailUser&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span> = EmailUser(value)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailDomain</span></span>(value: String) : NonEmptyText(value) {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : NonEmptyTextConstructor&lt;EmailDomain&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(value: <span class="hljs-type">String</span>)</span></span> = EmailDomain(value)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">data</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Email</span></span>(<span class="hljs-keyword">val</span> user: EmailUser, <span class="hljs-keyword">val</span> domain: EmailDomain)</code></pre><br>
<p>      ,         .       ,        (  —  ),     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ORM</a>  .</p><br>
<p>   .        :</p><br>
<pre><code class="plaintext hljs">data class DbUser(val name: UserName, val email: Email)</code></pre><br>
<p> ,       , :</p><br>
<ol>
<li>,      .     <code>name</code>     .</li>
<li>  <code>email</code>     .</li>
<li> -      (  ,      -).</li>
</ol><br>
<p>     «  —  »,           :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SingleValueMapper</span>&lt;<span class="hljs-type">out TValue</span>&gt; </span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(resultSet: <span class="hljs-type">ResultSet</span>, columnIndex: <span class="hljs-type">Int</span>)</span></span>: TValue<font></font>
}</code></pre><br>
<p> ,        :</p><br>
<ol>
<li>  ,      </li>
<li>   —   <code>getValue</code>   .</li>
<li>   —      "2".</li>
</ol><br>
<p>    , ,     ,    « ».        <code>mapper</code>:</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NonEmptyTextValueMapper</span>&lt;<span class="hljs-type">out TResult : NonEmptyText</span>&gt;</span>(
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> textConstructor: NonEmptyTextConstructor&lt;TResult&gt;<font></font>
) : SingleValueMapper&lt;TResult&gt; {<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(resultSet: <span class="hljs-type">ResultSet</span>, columnIndex: <span class="hljs-type">Int</span>)</span></span>: TResult {
        <span class="hljs-keyword">return</span> textConstructor.create(resultSet.getString(columnIndex))<font></font>
    }<font></font>
}</code></pre><br>
<p> ,        .          <code>mapper</code>'   :</p><br>
<pre><code class="plaintext hljs">object UserNameMapper : NonEmptyTextValueMapper&lt;UserName&gt;(UserName) //         UserName</code></pre><br>
<p> ,  <code>Kotlin</code>   ,   mapper   -,   extension type.  Scala      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">implicit</a>,      .</p><br>
<p>,     ,      — <code>Email</code>.     .        .   —    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DoubleValuesMapper</span>&lt;<span class="hljs-type">out TValue</span>&gt; </span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(resultSet: <span class="hljs-type">ResultSet</span>, columnIndex1: <span class="hljs-type">Int</span>, columnIndex2: <span class="hljs-type">Int</span>)</span></span>: TValue<font></font>
}</code></pre><br>
<p>     ,     .    ,    ,          .</p><br>
<p>    mapper,   - :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TwoMappersValueMapper</span>&lt;<span class="hljs-type">out TResult, TParameter1, TParameter2</span>&gt;</span>(
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> parameterMapper1: SingleValueMapper&lt;TParameter1&gt;,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> parameterMapper2: SingleValueMapper&lt;TParameter2&gt;<font></font>
) : DoubleValuesMapper&lt;TResult&gt; {<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(resultSet: <span class="hljs-type">ResultSet</span>, columnIndex1: <span class="hljs-type">Int</span>, columnIndex2: <span class="hljs-type">Int</span>)</span></span>: TResult {
        <span class="hljs-keyword">return</span> create(<font></font>
                parameterMapper1.getValue(resultSet, columnIndex1),<font></font>
                parameterMapper2.getValue(resultSet, columnIndex2)<font></font>
        )<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(parameter1: <span class="hljs-type">TParameter1</span>, parameter2: <span class="hljs-type">TParameter2</span>)</span></span>: TResult<font></font>
}</code></pre><br>
<p>  <code>Email</code>    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">object</span> EmailUserMapper : NonEmptyTextValueMapper&lt;EmailUser&gt;(EmailUser)
<span class="hljs-keyword">object</span> EmailDomainMapper : NonEmptyTextValueMapper&lt;EmailDomain&gt;(EmailDomain)<font></font>
<font></font>
<span class="hljs-keyword">object</span> EmailMapper : TwoMappersValueMapper&lt;Email, EmailUser, EmailDomain&gt;(EmailUserMapper, EmailDomainMapper) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(parameter1: <span class="hljs-type">EmailUser</span>, parameter2: <span class="hljs-type">EmailDomain</span>)</span></span>: Email {
        <span class="hljs-keyword">return</span> Email(parameter1, parameter2)<font></font>
    }<font></font>
}</code></pre><br>
<p>     —       :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Target(AnnotationTarget.VALUE_PARAMETER)</span>
<span class="hljs-meta">@MustBeDocumented</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingleMappingValueAnnotation</span></span>(
        <span class="hljs-keyword">val</span> constructionClass: KClass&lt;<span class="hljs-keyword">out</span> SingleValueMapper&lt;*&gt;&gt;, <span class="hljs-comment">// mapper     ...</span>
        <span class="hljs-keyword">val</span> columnName: String                                   <span class="hljs-comment">// ...     </span><font></font>
)<font></font>
<font></font>
<span class="hljs-meta">@Target(AnnotationTarget.VALUE_PARAMETER)</span>
<span class="hljs-meta">@MustBeDocumented</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoubleMappingValuesAnnotation</span></span>(
        <span class="hljs-keyword">val</span> constructionClass: KClass&lt;<span class="hljs-keyword">out</span> DoubleValuesMapper&lt;*&gt;&gt;, <span class="hljs-comment">// mapper      ...</span>
        <span class="hljs-keyword">val</span> columnName1: String,                                  <span class="hljs-comment">// ...    </span>
        <span class="hljs-keyword">val</span> columnName2: String<font></font>
)</code></pre><br>
<h1 id="generaciya-koda-po-annotaciyam">   .</h1><br>
<p> ,     .    ,     :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">object</span> : ResultSetMapper&lt;DbUser&gt; {
   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">extractData</span><span class="hljs-params">(rs: <span class="hljs-type">java</span>.<span class="hljs-type">sql</span>.<span class="hljs-type">ResultSet</span>)</span></span>: List&lt;DbUser&gt; {
      <span class="hljs-keyword">val</span> queryMetadata = rs.metaData
      <span class="hljs-keyword">val</span> queryColumnCount = queryMetadata.columnCount
      <span class="hljs-keyword">val</span> mapperColumnCount = <span class="hljs-number">3</span><font></font>
<font></font>
      require(queryColumnCount == mapperColumnCount) {<font></font>
          <span class="hljs-keyword">val</span> queryColumns = (<span class="hljs-number">0</span>..queryColumnCount).joinToString { queryMetadata.getColumnName(it) }
          <span class="hljs-string">"Sql query has invalid columns: <span class="hljs-variable">$mapperColumnCount</span> is expected, however <span class="hljs-variable">$queryColumnCount</span> is returned. "</span> +
              <span class="hljs-string">"Query has: <span class="hljs-variable">$queryColumns</span>. Mapper has: name, user_email_name, user_email_domain"</span><font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">val</span> columnIndex0 = rs.findColumn(<span class="hljs-string">"name"</span>)
      <span class="hljs-keyword">val</span> columnIndex1 = rs.findColumn(<span class="hljs-string">"user_email_name"</span>)
      <span class="hljs-keyword">val</span> columnIndex2 = rs.findColumn(<span class="hljs-string">"user_email_domain"</span>)
      <span class="hljs-keyword">val</span> result = mutableListOf&lt;DbUser&gt;()
      <span class="hljs-keyword">while</span> (rs.next()) {
          <span class="hljs-keyword">val</span> name = UserNameMapper.getValue(rs, columnIndex0)
          <span class="hljs-keyword">val</span> email = EmailMapper.getValue(rs, columnIndex1, columnIndex2)<font></font>
<font></font>
          <span class="hljs-keyword">val</span> rowResult = DbUser(<font></font>
              name = name,<font></font>
              email = email<font></font>
          )<font></font>
          result.add(rowResult)<font></font>
      }<font></font>
      <span class="hljs-keyword">return</span> result<font></font>
   }<font></font>
}</code></pre><br>
<p>     (  ,   ),      :</p><br>
<ol>
<li>    N ,     <code>mapper</code>'.        (         mapper').</li>
<li>     ,      .       ,   ,       :         .</li>
<li>    Sql    <code>while(rs.next()) { do }</code>,   .       ,   ,        .</li>
<li>         ,    .</li>
</ol><br>
<p>    :</p><br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;TMappingType : Any&gt;</span> <span class="hljs-title">getMapperSourceCode</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">TMappingType</span>&gt;)</span></span>: String {
    <span class="hljs-keyword">return</span> buildString {
        <span class="hljs-keyword">val</span> className = clazz.qualifiedName!!
        <span class="hljs-keyword">val</span> resultSetClassName = ResultSet::<span class="hljs-keyword">class</span>.java.name<font></font>
<font></font>
        <span class="hljs-keyword">val</span> singleConstructor = clazz.constructors.single()
        <span class="hljs-keyword">val</span> parameters = singleConstructor.parameters<font></font>
<font></font>
        <span class="hljs-keyword">val</span> annotations = parameters.flatMap { it.annotations.toList() }<font></font>
<font></font>
        <span class="hljs-keyword">val</span> columnNames = annotations.flatMap { getColumnNames(it) }.toSet()
        <span class="hljs-keyword">val</span> columnNameToVariable = columnNames.mapIndexed { index, name -&gt; name to <span class="hljs-string">"columnIndex<span class="hljs-variable">$index</span>"</span> }.toMap()<font></font>
<font></font>
        appendln(<span class="hljs-string">"""
import com.github.imanushin.ResultSetMapper
object : com.github.imanushin.ResultSetMapper&lt;<span class="hljs-variable">$className</span>&gt; {
   override fun extractData(rs: <span class="hljs-variable">$resultSetClassName</span>): List&lt;<span class="hljs-variable">$className</span>&gt; {
      val queryMetadata = rs.metaData
      val queryColumnCount = queryMetadata.columnCount
      val mapperColumnCount = <span class="hljs-subst">${columnNameToVariable.size}</span>
      require(queryColumnCount == mapperColumnCount) {
          val queryColumns = (0..queryColumnCount).joinToString { queryMetadata.getColumnName(it) }
          "Sql query has invalid columns: \<span class="hljs-subst">${<span class="hljs-string">'$'</span>}</span>mapperColumnCount is expected, however \<span class="hljs-subst">${<span class="hljs-string">'$'</span>}</span>queryColumnCount is returned. " +
              "Query has: \<span class="hljs-subst">${<span class="hljs-string">'$'</span>}</span>queryColumns. Mapper has: <span class="hljs-subst">${columnNames.joinToString()}</span>"
      }

"""</span>)<font></font>
<font></font>
        columnNameToVariable.forEach { (columnName, variableName) -&gt;<font></font>
            appendln(<span class="hljs-string">"      val <span class="hljs-variable">$variableName</span> = rs.findColumn(\"<span class="hljs-variable">$columnName</span>\")"</span>)<font></font>
        }<font></font>
<font></font>
        appendln(<span class="hljs-string">"""
       val result = mutableListOf&lt;<span class="hljs-variable">$className</span>&gt;()
       while (rs.next()) {
"""</span>)<font></font>
<font></font>
        parameters.forEach { parameter -&gt;<font></font>
            fillParameterConstructor(parameter, columnNameToVariable)<font></font>
        }<font></font>
<font></font>
        appendln(<span class="hljs-string">"          val rowResult = <span class="hljs-variable">$className</span>("</span>)<font></font>
        appendln(<font></font>
                parameters.joinToString(<span class="hljs-string">","</span> + System.lineSeparator()) { parameter -&gt;
                    <span class="hljs-string">"              <span class="hljs-subst">${parameter.name}</span> = <span class="hljs-subst">${parameter.name}</span>"</span><font></font>
                }<font></font>
        )<font></font>
<font></font>
        appendln(<span class="hljs-string">"""
          )
          result.add(rowResult)
      }
      return result
   }
}
"""</span>)<font></font>
        }<font></font>
    }<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> StringBuilder.<span class="hljs-title">fillParameterConstructor</span><span class="hljs-params">(parameter: <span class="hljs-type">KParameter</span>, columnNameToVariable: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, String&gt;)</span></span> {<font></font>
    append(<span class="hljs-string">"              val <span class="hljs-subst">${parameter.name}</span> = "</span>)
    <span class="hljs-comment">// please note: double or missing annotations aren't covered here</span>
    parameter.annotations.forEach { <span class="hljs-keyword">annotation</span> -&gt;
        <span class="hljs-keyword">when</span> (<span class="hljs-keyword">annotation</span>) {
            <span class="hljs-keyword">is</span> DoubleMappingValuesAnnotation -&gt;<font></font>
                appendln(<span class="hljs-string">"<span class="hljs-subst">${annotation.constructionClass.qualifiedName}</span>.getValue("</span> +
                        <span class="hljs-string">"rs, "</span> +
                        <span class="hljs-string">"<span class="hljs-subst">${columnNameToVariable[annotation.columnName1]}</span>, "</span> +
                        <span class="hljs-string">"<span class="hljs-subst">${columnNameToVariable[annotation.columnName2]}</span>)"</span><font></font>
                )<font></font>
            <span class="hljs-keyword">is</span> SingleMappingValueAnnotation -&gt;<font></font>
                appendln(<span class="hljs-string">"<span class="hljs-subst">${annotation.constructionClass.qualifiedName}</span>.getValue("</span> +
                        <span class="hljs-string">"rs, "</span> +
                        <span class="hljs-string">"<span class="hljs-subst">${columnNameToVariable[annotation.columnName]}</span>)"</span><font></font>
                )<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<h1 id="zachem-zhe-nam-vsyo-eto">    ?</h1><br>
<p> ,       runtime  ,   .           (    ),       ,       .  ,   ,    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>,        . ,   ,     ,    .</p><br>
<p>Kotlin DSL       :      ,         json/xml/yaml,    DSL,      . , ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">TeamCity Build DSL</a> —     ,  / (   10      ),      IDE.         ,    ,   .</p><br>
<p>       .      ,      .          :       /,         ,   ?       JIT,       ,  ,      -    .</p><br>
<p>        :     , ,  ,            runtime.    ,    reflection    ,             .</p><br>
<p>:</p><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Kotlin DSL</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">,   -     </a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja505136/index.html">ニビル</a></li>
<li><a href="../ja505138/index.html">オンラインブロードキャストがバラバラにならないようにするには（まあ、少なくともしばらくは機能します）</a></li>
<li><a href="../ja505142/index.html">Amazonがパンデミックからのイノベーションを望んでいる方法</a></li>
<li><a href="../ja505146/index.html">インターネットの歴史、断片化の時代、パート3：エクストラ</a></li>
<li><a href="../ja505156/index.html">Django：すべてに対して1人のユーザー</a></li>
<li><a href="../ja505174/index.html">この製品開発者は誰ですか？</a></li>
<li><a href="../ja505176/index.html">パンデミック時に投資家がリソースを保護することを可能にしたのはどの資産ですか？</a></li>
<li><a href="../ja505178/index.html">単独でのDIY運動</a></li>
<li><a href="../ja505184/index.html">Quest Softwareの最長12か月間の無料トライアルライセンス</a></li>
<li><a href="../ja505186/index.html">プリント回路基板のグラウンドを組み合わせる3つの方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>