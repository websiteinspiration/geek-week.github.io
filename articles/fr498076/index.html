<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🔬 🚺 👨🏾‍🎤 Notre expérience de migration Cassandra entre les clusters Kubernetes sans perte de données 🤠 👂🏼 ↙️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Au cours des ~ six derniers mois, nous avons utilisé l' opérateur Rook pour travailler avec Cassandra à Kubernetes . Cependant, lorsque nous avions be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Notre expérience de migration Cassandra entre les clusters Kubernetes sans perte de données</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498076/"><img src="https://habrastorage.org/webt/bt/dz/eh/btdzeh5vf-wcqspevi_adr6exds.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des ~ six derniers mois, nous avons utilisé l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opérateur Rook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour travailler avec Cassandra à Kubernetes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cependant, lorsque nous avions besoin d'effectuer une opération très banale, il semblerait, opération: changer les paramètres dans la config Cassandra, il s'est avéré que l'opérateur ne fournissait pas une flexibilité suffisante. </font><font style="vertical-align: inherit;">Pour apporter des modifications, il était nécessaire de cloner le référentiel, d'apporter des modifications aux sources et de reconstruire l'opérateur (la configuration est intégrée à l'opérateur lui-même, donc la connaissance de Go est toujours utile). </font><font style="vertical-align: inherit;">Tout cela prend beaucoup de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déjà fait une</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> revue des opérateurs existants </font><font style="vertical-align: inherit;">, et cette fois nous nous sommes arrêtés chez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CassKop d'Orange</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui prend en charge les fonctionnalités nécessaires, en particulier, les configurations personnalisées et la surveillance </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">prête</font></a><font style="vertical-align: inherit;"> à l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">emploi</font></a><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tâche</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la réalité, qui sera discutée plus loin, il a été décidé de combiner le changement d'opérateur avec le besoin urgent de transférer l'ensemble de l'infrastructure client vers le nouveau cluster. </font><font style="vertical-align: inherit;">Après la migration des principales charges de travail à partir d'applications importantes, seule Cassandra est restée, la perte de données pour laquelle, bien sûr, était inacceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conditions pour sa migration:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le temps d'inactivité maximal est de 2 à 3 minutes pour effectuer ce transfert en même temps que l'application elle-même est transférée vers un nouveau cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transférez toutes les données sans perte ni mal de tête (c'est-à-dire sans aucune manipulation supplémentaire).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment réaliser une telle opération? Par analogie avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous avons décidé de lancer une nouvelle installation de Cassandra dans un nouveau cluster Kubernetes, puis de fusionner les deux Cassandra dans des clusters différents et de transférer les données, mettant fin à l'ensemble du processus en désactivant simplement l'installation d'origine.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, cela était compliqué par le fait que les réseaux à l'intérieur de Kubernetes se croisent, il n'était donc pas si facile de configurer la connexion. </font><font style="vertical-align: inherit;">Il était nécessaire d'enregistrer les itinéraires pour chaque pod sur chaque nœud, ce qui prend beaucoup de temps et n'est pas fiable du tout. </font><font style="vertical-align: inherit;">Le fait est que la communication sur les pods IP ne fonctionne qu'avec des maîtres, et Cassandra s'exécute sur des nœuds dédiés. </font><font style="vertical-align: inherit;">Ainsi, vous devez d'abord configurer la route vers le maître et déjà sur le maître - vers un autre cluster. </font><font style="vertical-align: inherit;">En plus de cela, le redémarrage du pod entraîne un changement d'IP, et c'est un autre problème ... Pourquoi? </font><font style="vertical-align: inherit;">Lisez à ce sujet plus tard dans l'article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la partie pratique suivante de l'article, trois notations pour les clusters Cassandra seront utilisées:</font></font><br>
<br>
<ul>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la nouvelle installation que nous lancerons dans le nouveau cluster Kubernetes;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une ancienne installation avec laquelle les applications fonctionnent actuellement;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une installation temporaire que nous exécutons à côté de Cassandra-current et nous l'utilisons uniquement pour le processus de migration lui-même.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment être?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilise le stockage local, une simple migration de ses données vers un nouveau cluster - cela pourrait être, par exemple, dans le cas des disques vSphere ... - est impossible. </font><font style="vertical-align: inherit;">Pour résoudre ce problème, nous allons créer un cluster temporaire, en l'utilisant comme une sorte de tampon pour la migration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La séquence générale des actions est réduite aux étapes suivantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Élevez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new avec un</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nouvel opérateur dans un nouveau cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échelle à 0 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveau</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><i><font style="vertical-align: inherit;">Cassandra</font></i><font style="vertical-align: inherit;"> .</font></font></li>
<li>  ,  PVC,    .</li>
<li>  <i>Cassandra-temporary</i>       <i>Cassandra-current</i> ,      <i>Cassandra-new</i>.</li>
<li>   <i>Cassandra-temporary</i>  0 (     )    <i>Cassandra-temporary</i> ,  <i>Cassandra-temporary</i>   <i>Cassandra-current</i>.      <b></b> Cassandra  <b></b> <i>-</i> (       Cassandra     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transférez des données entre les centres de données </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-actuel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettez à l'échelle les clusters </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-courant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à 0 et exécutez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le nouveau cluster, sans oublier de jeter les disques. </font><font style="vertical-align: inherit;">En parallèle, nous déployons les applications vers un nouveau cluster.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de telles manipulations, les temps d'arrêt seront minimes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En détail</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec les 3 premières étapes, il ne devrait y avoir aucun problème - tout se fait rapidement et facilement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, le cluster </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-actuel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ressemblera à ceci:</font></font><br>
<br>
<pre><code class="bash hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérifier que tout fonctionne comme prévu, créez un espace de clés dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cela se fait avant le lancement de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">create keyspace example with replication ={'class' : 'NetworkTopologyStrategy', 'x1':2};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, créez un tableau et remplissez-le de données:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">use</span> example;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> example(<span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span> PRIMARY <span class="hljs-keyword">KEY</span>, <span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>, phone varint);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'Masha'</span>, <span class="hljs-number">983123123</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>,<span class="hljs-string">'Sergey'</span>, <span class="hljs-number">912121231</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'Andrey'</span>, <span class="hljs-number">914151617</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en vous rappelant qu'avant cela, dans le nouveau cluster, nous avons déjà démarré </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (étape # 1) et maintenant il est désactivé (étape # 2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarques:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque nous démarrons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous devons spécifier le même nom (avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) du cluster. </font><font style="vertical-align: inherit;">Cela peut être fait via une variable </font></font><code>CASSANDRA_CLUSTER_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puisse voir le cluster actuel, vous devez définir les graines. </font><font style="vertical-align: inherit;">Cela se fait via une variable </font></font><code>CASSANDRA_SEEDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou via une configuration.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attention! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avant de commencer à déplacer des données, vous devez vous assurer que les types de cohérence en lecture et en écriture sont définis sur </font></font><code>LOCAL_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>LOCAL_QUORUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> démarrage </font><i><font style="vertical-align: inherit;">temporaire de Cassandra</font></i><font style="vertical-align: inherit;"> , le cluster devrait ressembler à ceci (notez l'apparition d'un deuxième centre de données avec 3 nœuds):</font></font><br>
<br>
<pre><code class="plaintext hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1<font></font>
<font></font>
Datacenter: x2<font></font>
===============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address       Load       Tokens       Owns (effective)  Host ID                               Rack<font></font>
UN  10.244.16.96  267.07 KiB  256          64.4%             3619841e-64a0-417d-a497-541ec602a996  rack1<font></font>
UN  10.244.18.67  248.29 KiB  256          65.8%             07a2f571-400c-4728-b6f7-c95c26fe5b11  rack1<font></font>
UN  10.244.16.95  265.85 KiB  256          69.8%             2f4738a2-68d6-4f9e-bf8f-2e1cfc07f791  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant effectuer le transfert. </font><font style="vertical-align: inherit;">Pour ce faire, transférez d'abord l'espace de touches de test - assurez-vous que tout va bien:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', x1: 2, x2: 2};</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, dans chaque module </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">exécutez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool rebuild -ks example x1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons à n'importe quel pod de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et vérifions que les données ont été transférées. </font><font style="vertical-align: inherit;">Vous pouvez également ajouter 1 entrée supplémentaire à </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour vérifier que les nouvelles données ont commencé à se répliquer:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> example;<font></font>
<font></font>
 id | name   | phone<font></font>
<span class="hljs-comment">----+--------+-----------</span><font></font>
  1 |  Masha | 983123123<font></font>
  2 | Sergey | 912121231<font></font>
  3 | Andrey | 914151617<font></font>
<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, vous pouvez faire </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les espaces clés dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l'exécuter </font></font><code>nodetool rebuild</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manque d'espace et de mémoire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, il est utile de se rappeler que lorsque la reconstruction est en cours d'exécution, des fichiers temporaires sont créés dont la taille est équivalente à la taille de l'espace clé! </font><font style="vertical-align: inherit;">Nous avons rencontré un problème selon lequel le plus grand espace de clés était de 350 Go et l'espace disque disponible était moindre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'a pas été possible d'étendre le disque, car le stockage local est utilisé. </font><font style="vertical-align: inherit;">La commande suivante est venue à la rescousse (exécutée dans chaque pod de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs">nodetool clearsnapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'endroit a donc été libéré: dans notre cas, 500 Go d'espace disque libre ont été obtenus au lieu des 200 Go précédemment disponibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, malgré le manque d'espace, l'opération de reconstruction a constamment provoqué le redémarrage des pods </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra temporaires</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec une erreur:</font></font><br>
<br>
<pre><code class="plaintext hljs">failed; error='Cannot allocate memory' (errno=12)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous l'avons décidé en créant DaemonSet, qui se déploie uniquement sur les nœuds avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et effectue:</font></font><br>
<br>
<pre><code class="bash hljs">sysctl -w vm.max_map_count=262144</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, toutes les données ont été migrées!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commutation de cluster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne restait plus qu'à changer la Cassandra, qui s'est déroulée en 5 étapes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échelle </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporaire</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-courant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (n'oubliez pas que l'opérateur fonctionne toujours ici!) À 0.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commutez les disques (cela revient à régler PV pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous démarrons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en vérifiant que les disques nécessaires sont connectés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous faisons </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toutes les tables pour supprimer l'ancien cluster:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', 'x2': 2};</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimez tous les nœuds de l'ancien cluster. </font><font style="vertical-align: inherit;">Pour ce faire, exécutez simplement cette commande dans l'un de ses modules:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool removenode 3619841e-64a0-417d-a497-541ec602a996</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le temps d'arrêt total de Cassandra était d'environ 3 minutes - c'est le moment où les conteneurs se sont arrêtés et ont démarré, car les disques ont été préparés à l'avance.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Touche finale avec Prometheus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cela ne s'arrête pas là. </font><font style="vertical-align: inherit;">Il existe </font><font style="vertical-align: inherit;">un exportateur intégré </font><font style="vertical-align: inherit;">avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(voir la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation du nouvel opérateur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous l'avons bien sûr utilisé. </font><font style="vertical-align: inherit;">Environ 1 heure après le lancement, des alertes concernant l'inaccessibilité de Prometheus ont commencé à arriver. </font><font style="vertical-align: inherit;">Après avoir vérifié la charge, nous avons vu que la consommation de mémoire sur les nœuds avec Prometheus a augmenté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une étude plus approfondie de la question a montré que le nombre de mesures collectées a augmenté de 2,5 fois (!). </font><font style="vertical-align: inherit;">La faute était Cassandra, avec laquelle un peu plus de 500 000 mesures ont été collectées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons effectué un audit des métriques et désactivé celles que nous n'avons pas jugées nécessaires - via ConfigMap (en l'occurrence, l'exportateur est configuré). </font><font style="vertical-align: inherit;">Le résultat est 120 000 métriques et une charge significativement réduite sur Prometheus (malgré le fait que des métriques importantes restent).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc réussi à transférer Cassandra vers un autre cluster, pratiquement sans affecter le fonctionnement de l'installation de production de Cassandra et sans interférer avec le travail des applications clientes. </font><font style="vertical-align: inherit;">En cours de route, nous sommes arrivés à la conclusion que l'utilisation du même réseau de pods n'est pas une bonne idée (nous sommes maintenant plus attentifs à la planification initiale de l'installation du cluster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin: pourquoi n'avons-nous pas utilisé l'outil </font></font><code>nodetool snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mentionné dans l'article précédent? </font><font style="vertical-align: inherit;">Le fait est que cette commande crée un instantané d'espace de clés dans l'état où elle se trouvait avant l'exécution de la commande. </font><font style="vertical-align: inherit;">Outre:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il faut beaucoup plus de temps pour prendre une photo et la transférer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout ce qui est écrit en ce moment à Cassandra sera perdu;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple dans notre cas serait d'environ une heure - au lieu de 3 minutes, ce qui s'est avéré être combiné avec succès avec le déploiement de l'application sur un nouveau cluster.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migration de Cassandra vers Kubernetes: fonctionnalités et solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une histoire avec l'opérateur Redis dans les K8 et un mini-aperçu des utilitaires pour analyser les données de cette base de données</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migration non obstruée de MongoDB vers Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migration sans obstacle de RabbitMQ vers Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de données et Kubernetes (revue et reportage vidéo)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ."</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498064/index.html">Émulateur de marché classique</a></li>
<li><a href="../fr498066/index.html">Comment SFP, SFP + et XFP nous facilitent la vie</a></li>
<li><a href="../fr498070/index.html">Hive - base locale rapide pour Flutter, Dart</a></li>
<li><a href="../fr498072/index.html">Effet raster pour Atari 65XE</a></li>
<li><a href="../fr498074/index.html">Mettez cet article en signet si vous débutez avec Python (surtout si vous apprenez vous-même Python)</a></li>
<li><a href="../fr498080/index.html">Expérience de migration vers SAP HANA 2.0 dans une grande distribution, projet de test automatisé pour Sberbank et autres cas</a></li>
<li><a href="../fr498084/index.html">Les ventes sont mortes. Que faire ensuite?</a></li>
<li><a href="../fr498086/index.html">Laissez fleurir une centaine de missiles réutilisables</a></li>
<li><a href="../fr498088/index.html">Comment fonctionnent les chercheurs Avito</a></li>
<li><a href="../fr498090/index.html">Les dunes de sable sont capables de "communiquer" entre elles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>