<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë§ üèùÔ∏è ü•Ö PyDERASN: as I added big-data support ü§õüèΩ üîº üîµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue the last article about PyDERASN - the free ASN.1 DER / CER / BER codec in Python. Over the past year, from the time of its writing, in addi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PyDERASN: as I added big-data support</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498014/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I continue the last article about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyDERASN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the free ASN.1 DER / CER / BER codec in Python. </font><font style="vertical-align: inherit;">Over the past year, from the time of its writing, in addition to all the little things, small corrections, and even more rigorous data verification (although before it was already the most stringent of free codecs known to me), a functionality for working with large volumes of data appeared in this library - not creeping into RAM. </font><font style="vertical-align: inherit;">I want to talk about this in this article.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/241/bae/4fc/241bae4fcfb5d7f0c3a605bf5f3211cb.png" alt="ASN.1 browser"></div><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problems / Tasks</font></font></h2><br>
<ul>
<li><strong> CRL</strong>:<br>
,      (CA)         X.509 .    ,    CRL (certificate revocation list). CRL  CACert.org,  8.72 MiB,   PyDERASN-  Python 3.6      (    <em>asn1crypto</em>  <em>pyasn1</em>   ).      416 .  .    ,           .  .<br>
</li>
<li><strong> CMS</strong>:<br>
CMS (Cryptographic Message Syntax)    <br>
// . ,<br>
<em>SignedData</em>     ,   ,<br>
  ,   - <em>EnvelopedData</em> <br>
 .<br>
<br>
                 CMS. , CMS   detached data,     - ,         .  10 GiB    20 GiB   :       10 GiB      . .<br>
</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What ASN.1 objects in practice can be resource intensive, take up a lot of memory space? Only </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEQUENCE OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> containing numerous objects (hundreds of thousands in the case of CACert.org), and all kinds of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRINGs</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (as in the second problematic case). Since one of the virtues of a programmer is laziness (according to Larry Wall), we will try to overcome the problems of resource consumption with a minimal change in the library code. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objects, from the point of view of the codec, almost do not differ from each other and are implemented in the library by one common class. What is encoding in </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OCTET STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in DER?</font></font><br>
<br>
<pre><code class="plaintext hljs">return tag + len_encode(len(value)) + value
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not have to be in RAM all this time. </font><font style="vertical-align: inherit;">It is required to be a bytes-like object from which you can find out the length. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoryview</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> satisfies these conditions. </font><font style="vertical-align: inherit;">And yet </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoryview</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be done by </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mmap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on any temporary file that is already reduced in the memory 20 GiB 10 GiB requirements for the CMS database copies in half: it is enough to specify as the value of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OCTET STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s (or any other </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s) similar to </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoryview</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To create it, PyDERASN has a helper function:</font></font><br>
<br>
<pre><code class="plaintext hljs">from pyderasn import file_mmaped<font></font>
with open("dump.sql.zst", "rb") as fd:<font></font>
    ... = OctetString(file_mmaped(fd))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we want to decode a huge amount of data, then </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoryview</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can </font><em><font style="vertical-align: inherit;">also</font></em><font style="vertical-align: inherit;"> be used for decode:</font></font><br>
<br>
<pre><code class="plaintext hljs">from pyderasn import file_mmaped<font></font>
with open("dump.sql.zst", "rb") as fd:<font></font>
    obj = Schema.decode(file_mmaped(fd))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We consider the problem with </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRING to</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be partially resolved. </font><font style="vertical-align: inherit;">Back to creating a huge CRL. </font><font style="vertical-align: inherit;">What is its structure like?</font></font><br>
<br>
<pre><code class="plaintext hljs">CertificateList SEQUENCE<font></font>
. tbsCertList: TBSCertList SEQUENCE<font></font>
. . version: Version INTEGER v2 (01) OPTIONAL<font></font>
. . signature: AlgorithmIdentifier SEQUENCE<font></font>
. . issuer: Name CHOICE rdnSequence<font></font>
. . thisUpdate: Time CHOICE utcTime<font></font>
. . nextUpdate: Time CHOICE utcTime OPTIONAL<font></font>
. . revokedCertificates: RevokedCertificates SEQUENCE OF OPTIONAL<font></font>
. . . 0: RevokedCertificate SEQUENCE<font></font>
. . . . userCertificate: CertificateSerialNumber INTEGER 17 (11)<font></font>
. . . . revocationDate: Time CHOICE utcTime UTCTime 2003-04-01T14:25:08<font></font>
. . . 1: RevokedCertificate SEQUENCE<font></font>
. . . . userCertificate: CertificateSerialNumber INTEGER 20 (14)<font></font>
. . . . revocationDate: Time CHOICE utcTime UTCTime 2002-10-01T02:18:01<font></font>
<font></font>
                                 [...]<font></font>
<font></font>
. . . 415753: RevokedCertificate SEQUENCE<font></font>
. . . . userCertificate: CertificateSerialNumber INTEGER 1341859 (14:79:A3)<font></font>
. . . . revocationDate: Time CHOICE utcTime UTCTime 2020-02-08T06:51:56<font></font>
. . . 415754: RevokedCertificate SEQUENCE<font></font>
. . . . userCertificate: CertificateSerialNumber INTEGER 1341860 (14:79:A4)<font></font>
. . . . revocationDate: Time CHOICE utcTime UTCTime 2020-02-08T06:53:01<font></font>
. . . 415755: RevokedCertificate SEQUENCE<font></font>
. . . . userCertificate: CertificateSerialNumber INTEGER 1341861 (14:79:A5)<font></font>
. . . . revocationDate: Time CHOICE utcTime UTCTime 2020-02-08T07:25:06<font></font>
. signatureAlgorithm: AlgorithmIdentifier SEQUENCE<font></font>
. signatureValue: BIT STRING 4096 bits<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A long list of small </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RevokedCertificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> structures. </font><font style="vertical-align: inherit;">In this case, containing only the serial number of the certificate and the time of its revocation. </font><font style="vertical-align: inherit;">What is its DER coding?</font></font><br>
<br>
<pre><code class="plaintext hljs">value = b"".join(revCert.encode() for revCert in revCerts)<font></font>
return tag + len_encode(len(value)) + value<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just concatenation of DER representations of each individual element of this list. </font><font style="vertical-align: inherit;">Do we need to have in advance all these hundreds of thousands of objects in the course of just being serialized into 15 bytes of DER representation? </font><font style="vertical-align: inherit;">Obviously not. </font><font style="vertical-align: inherit;">Therefore, we replace the list of objects with an iterator / generator. </font><font style="vertical-align: inherit;">Most likely, the creation of the CRL will be based on data from the DBMS:</font></font><br>
<br>
<pre><code class="plaintext hljs">def revCertsGenerator(...):<font></font>
    for row in db.cursor:<font></font>
        yield RevokedCertificate((<font></font>
            ("userCertificate", CertificateSerialNumber(row.serial)),<font></font>
            ("revocationDate", Time(("utcTime", UTCTime(row.revdate)))),<font></font>
        ))<font></font>
<font></font>
crl["tbsCertList"]["revokedCertificates"] = revCertsGenerator()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we almost do not consume memory when creating such a CRL - we only need a place to work with its DER representation: in this case, we are talking about a couple of tens of megabytes (as opposed to a half-gigabyte list of RevokedCertificate objects). </font><font style="vertical-align: inherit;">But there is a difference in behavior: the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEQUENCE OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> size check </font><font style="vertical-align: inherit;">occurs only after the iterator is exhausted, and not at the moment of assigning a value.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DER streaming coding</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is impossible. After all, this is DER - the lengths of all TLV (tag + length + value) elements must be known in advance! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I would like so much! After all, we still still need 10 GiB of memory to store the DER representation of the database copy: </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raw = cms.encode ()</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! Ideally, I want to convey a certain </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> where the serialized representation would be written. Maybe transfer the file descriptor, leave placeholders in the file at the place of lengths and then fill them out by doing seek? Unfortunately, the length length (respectively, and placeholder) is also not known in advance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PyDERASN has received the possibility of two-pass DER encoding. In the first pass, knowledge about the lengths of objects is collected, creating a temporary state. The second is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streaming</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DER encoding into a certain </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , already possible due to the knowledge of lengths. The implementation of this came out simple, just adding a bit of two-pass methods to each of the ASN.1 base types. Since the traversal of objects is strictly determinate (D - distinguished!), Then, to store the necessary lengths, a simple list is maintained, to which, as the entire tree of objects is traversed, length values ‚Äã‚Äãare added. For some types, the length is fixed. For some, it is needed only for reporting to an upstream container ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEQUENCE</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEQUENCE OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLICIT TAG</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). For example, the length state for a list of two revoked certificates looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">revCert = RevokedCertificate((<font></font>
    ("userCertificate", CertificateSerialNumber(123)),<font></font>
    ("revocationDate", Time(("utcTime", UTCTime(datetime.utcnow())))),<font></font>
))<font></font>
revs = RevokedCertificates([revCert, revCert])<font></font>
<font></font>
(42, [40, 18, 18])<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we need to know the length of the value only for each of the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RevokedCertificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the entire list as a whole. The length of integers and encoded time (in DER it is a fixed length) in the state is not stored as unnecessary. As a result, for our CACert.org CRL, such a list takes a little more than 3.5 MiB, and for the giant CMS, in which almost all the weight falls on one single field with a copy of the database, it takes about 0.5 KiB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two-pass encoding is performed by two calls:</font></font><br>
<br>
<pre><code class="plaintext hljs">fulllen, state = obj.encode1st()<font></font>
with open("result", "wb") as fd:<font></font>
    obj.encode2nd(fd.write, iter(state))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first pass also reports the full length of the data, which can be used to check the free space or allocate it by some </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">posix_fallocate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the helper function </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encode2pass (obj),</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can perform two-pass encoding into memory. What for? It can be significantly more economical in memory consumption, since it will not, in the case of CACert.org CRL, store 416k + small binary lines joined by a </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b "". Join ()</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call. However, this requires more processor time, because all the objects will have to be walked twice.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can encode an arbitrarily large CMS in DER, practically without consuming memory. </font><font style="vertical-align: inherit;">But in the case of CRL, we used the certificate revocation generator, which will run out after the end of the first pass. </font><font style="vertical-align: inherit;">What to do? </font><font style="vertical-align: inherit;">Just reinitialize it again!</font></font><br>
<br>
<pre><code class="plaintext hljs">_, state = crl.encode1st()<font></font>
crl["tbsCertList"]["revokedCertificates"] = revCertsGenerator()<font></font>
crl.encode2nd(writer, iter(state))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, we </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are obliged to</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ensure that the result of the iterator will be exactly the same, otherwise we will get a broken DER. </font><font style="vertical-align: inherit;">If data is taken from the DBMS cursor, then do not forget about </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REPEATABLE READ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> transaction isolation level and sorting.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Real Stream Encoding: CER</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, DER (distinguished encoding rules) is a subset of BER (basic encoding rules) that strictly regulates encoding rules in one and only one way. This allows it to be used in cryptographic tasks. But there is another noteworthy subset of BER: CER (canonical encoding rules). Like DER, it has only one possible representation of the data. CER differs from DER in several details, but they allow you to perform truly streaming encoding of data. Unfortunately, CER did not become as popular as DER. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Omitting not so noticeable differences (such as sorting tags in SET), CER has two fundamental differences from DER:</font></font><br>
<br>
<ul>
<li>    (constructed,  )  indefinite  (<em>LENINDEF</em>   PyDERASN).  ,  <em>SEQUENCE</em>/<em>SET</em>, <em>SEQUENCE OF</em>/<em>SET OF</em>, <em>EXPLICIT TAG</em>-  :<br>
<br>
<pre><code class="plaintext hljs">TAG_CONSTRUCTED || LEN(VALUE) || VALUE
</code></pre><br>
 <em>LENINDEF</em> (0x80)  EOC ( ,  )   :<br>
<br>
<pre><code class="plaintext hljs">TAG_CONSTRUCTED || 80 || VALUE || 00 00
</code></pre><br>
</li>
<li><em>*STRING</em>-,    1000-,  chunk-  1000-. ,      ,   DER. , 512          DER:<br>
<br>
<pre><code class="plaintext hljs">TAG_PRIMITIVE || LEN(512) || 512B
</code></pre><br>
 2048  :<br>
<br>
<pre><code class="plaintext hljs">TAG_CONSTRUCTED || 80 ||<font></font>
    TAG_PRIMITIVE || LEN(1000) || 1000B ||<font></font>
    TAG_PRIMITIVE || LEN(1000) || 1000B ||<font></font>
    TAG_PRIMITIVE || LEN(48) || 48B || 00 00<font></font>
</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this (plus a few little things) allows streaming (with 1000 bytes a buffer for strings) to encode any objects. Similarly, you can use </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mmap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and iterators. CER encoding is done simply by calling the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.encode_cer (writer)</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method. Unfortunately, PyDERASN is not yet able to verify the validity of CER during decoding, so we are forced to decode the data as BER. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The CMS standard, by the way, requires coding in BER (both DER and CER, automatic, are BER). Therefore, we can encode our huge copy of the database into CER CMS without a two-pass DER. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SignedData is</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> required to have a </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SignedAttributes</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> element encoded in DER, as is the X.509 </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certificates. </font><font style="vertical-align: inherit;">PyDERASN allows you to force the use of DER in given structures by simply adding the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der_forced = True</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream decoding: evgen mode</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We learned to encode, but only </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mmap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help with decoding </font><font style="vertical-align: inherit;">. A ‚Äúreal‚Äù stream decoder, which has control knobs in the form of ‚Äúgive me more data‚Äù, ‚Äúhere you are‚Äù, some kind of state - would require a radical alteration of PyDERASN. And, personally, I don‚Äôt see it would be more convenient than the current solution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the current solution is extremely simple. In the process of decoding, we have in our hands various decoded primitive objects in our hands, from them are assembled superior components (constructed), of which other components, etc. ... We accumulate objects to make them composite and, reaching the very top give us one big object. Why not immediately ‚Äúgive out‚Äù all kinds of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decoded</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objects, as soon as they appear on our hands? </font><font style="vertical-align: inherit;">That is, to return not a final object, but a generator that generates many decoded objects. </font><font style="vertical-align: inherit;">In fact, in PyDERASN now all decoding methods have become generators of such "events" (event generation, evgen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we enable the evgen-decoding mode of our huge CACert.org CRL, we will see the following picture:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ python -m pyderasn --schema tests.test_crl:CertificateList --evgen revoke.crl<font></font>
[][T,L,  V len]<font></font>
     10   [1,1,      1]   . . version: Version INTEGER v2 (01) OPTIONAL<font></font>
     15   [1,1,      9]   . . . algorithm: OBJECT IDENTIFIER 1.2.840.113549.1.1.13<font></font>
     26   [0,0,      2]   . . . parameters: [UNIV 5] ANY OPTIONAL<font></font>
     13   [1,1,     13]   . . signature: AlgorithmIdentifier SEQUENCE<font></font>
     34   [1,1,      3]   . . . . . . type: AttributeType OBJECT IDENTIFIER 2.5.4.10<font></font>
     39   [0,0,      9]   . . . . . . value: [UNIV 19] AttributeValue ANY<font></font>
     32   [1,1,     14]   . . . . . 0: AttributeTypeAndValue SEQUENCE<font></font>
     30   [1,1,     16]   . . . . 0: RelativeDistinguishedName SET OF<font></font>
<font></font>
                                 [...]<font></font>
<font></font>
    188   [1,1,      1]   . . . . userCertificate: CertificateSerialNumber INTEGER 17 (11)<font></font>
    191   [1,1,     13]   . . . . . utcTime: UTCTime UTCTime 2003-04-01T14:25:08<font></font>
    191   [0,0,     15]   . . . . revocationDate: Time CHOICE utcTime<font></font>
    191   [1,1,     13]   . . . . . utcTime: UTCTime UTCTime 2003-04-01T14:25:08<font></font>
    186   [1,1,     18]   . . . 0: RevokedCertificate SEQUENCE<font></font>
    208   [1,1,      1]   . . . . userCertificate: CertificateSerialNumber INTEGER 20 (14)<font></font>
    211   [1,1,     13]   . . . . . utcTime: UTCTime UTCTime 2002-10-01T02:18:01<font></font>
    211   [0,0,     15]   . . . . revocationDate: Time CHOICE utcTime<font></font>
    206   [1,1,     18]   . . . 1: RevokedCertificate SEQUENCE<font></font>
<font></font>
                                 [...]<font></font>
<font></font>
9144992   [0,0,     15]   . . . . revocationDate: Time CHOICE utcTime<font></font>
9144985   [1,1,     20]   . . . 415755: RevokedCertificate SEQUENCE<font></font>
    181   [1,4,9144821]   . . revokedCertificates: RevokedCertificates SEQUENCE OF OPTIONAL<font></font>
      5   [1,4,9144997]   . tbsCertList: TBSCertList SEQUENCE<font></font>
9145009   [1,1,      9]   . . algorithm: OBJECT IDENTIFIER 1.2.840.113549.1.1.13<font></font>
9145020   [0,0,      2]   . . parameters: [UNIV 5] ANY OPTIONAL<font></font>
9145007   [1,1,     13]   . signatureAlgorithm: AlgorithmIdentifier SEQUENCE<font></font>
9145022   [1,3,    513]   . signatureValue: BIT STRING 4096 bits<font></font>
      0   [1,4,9145534]  CertificateList SEQUENCE<font></font>
</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the beginning of decoding, we saw the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CertificateList </font></font></em> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEQUENCE</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tag, the data length, but the object is not yet known whether it can be decoded to the end. </font><font style="vertical-align: inherit;">So far we are only in the process of working on it.</font></font></li>
<li>    <em>SEQUENCE</em>:  <em>version</em>,     <em>INTEGER</em>.   .   ,      . ( <strong>10</strong>)</li>
<li>   <em>signature</em>,  <em>SEQUENCE</em>-   : <em>algorithm</em>  <em>parameters</em>.   <em>OBJECT IDENTIFIER</em>  <em>ANY</em>     . ( <strong>15</strong>, <strong>26</strong>)</li>
<li>   ,  ,   <em>signature</em> <em>SEQUENCE</em>    ,    ,    :  . ( <strong>13</strong>)</li>
<li>,   <em>RevokedCertificate</em>        . ( <strong>186</strong>, <strong>206</strong>,  ..)</li>
<li> <em>tbsCertList</em>       . ( <strong>5</strong>)</li>
<li> <em>CertificateList</em>,   <em>SEQUENCE</em>,  ,        ,         . ( <strong>0</strong>)</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, all </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and lists ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) do not carry real meaning. </font><font style="vertical-align: inherit;">In the case of DER, knowing </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.offset</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.vlen,</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can read the value of a line from a file (a piece of memory?). </font><font style="vertical-align: inherit;">Sequence objects can be collected and aggregated as you need, while receiving all events.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decoded path and evgen_mode_upto</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to understand what kind of object, what </font><font style="vertical-align: inherit;">kind of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INTEGER</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we have on hand? </font><font style="vertical-align: inherit;">Each object has its own so-called decode path, which uniquely identifies a specific object in the structure. </font><font style="vertical-align: inherit;">For example, for CACert.org CRL decode path events:</font></font><br>
<br>
<pre><code class="plaintext hljs">tbsCertList:version<font></font>
tbsCertList:signature:algorithm<font></font>
tbsCertList:signature:parameters<font></font>
tbsCertList:signature<font></font>
tbsCertList:issuer:rdnSequence:0:0:type<font></font>
                                 [...]<font></font>
tbsCertList:issuer:rdnSequence<font></font>
tbsCertList:issuer<font></font>
                                 [...]<font></font>
tbsCertList:revokedCertificates:0:userCertificate<font></font>
tbsCertList:revokedCertificates:0:revocationDate:utcTime<font></font>
tbsCertList:revokedCertificates:0:revocationDate<font></font>
tbsCertList:revokedCertificates:0<font></font>
tbsCertList:revokedCertificates:1:userCertificate<font></font>
tbsCertList:revokedCertificates:1:revocationDate:utcTime<font></font>
tbsCertList:revokedCertificates:1:revocationDate<font></font>
tbsCertList:revokedCertificates:1<font></font>
                                 [...]<font></font>
tbsCertList:revokedCertificates:415755:userCertificate<font></font>
tbsCertList:revokedCertificates:415755:revocationDate:utcTime<font></font>
tbsCertList:revokedCertificates:415755:revocationDate<font></font>
tbsCertList:revokedCertificates:415755<font></font>
tbsCertList:revokedCertificates<font></font>
tbsCertList<font></font>
signatureAlgorithm:algorithm<font></font>
signatureAlgorithm:parameters<font></font>
signatureAlgorithm<font></font>
signatureValue<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how we can print the list of certificate revocation serial numbers from this CRL:</font></font><br>
<br>
<pre><code class="plaintext hljs">raw = file_mmaped(open("....crl", "rb"))<font></font>
for decode_path, obj, tail in CertificateList().decode_evgen(raw):<font></font>
    if (len(decode_path) == 5) and (decode_path[-1] == "userCertificate"):<font></font>
        print(int(obj))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RevokedCertificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> structure </font><font style="vertical-align: inherit;">can contain a lot of information, including various extensions. </font><font style="vertical-align: inherit;">Purely technically, we get all the data about the revoked certificate in evgen mode, but aggregating events related to one </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">revokedCertificates</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> element </font><em><font style="vertical-align: inherit;">is</font></em><font style="vertical-align: inherit;"> not very convenient. </font><font style="vertical-align: inherit;">Since each final </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RevokedCertificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in practice, will not take up much space, it would be great to have it all the same, not all objects are so thoroughly ‚Äúsorted‚Äù into events. </font><font style="vertical-align: inherit;">PyDERASN allows the list to specify decoding paths at which the evgen mode is disabled. </font><font style="vertical-align: inherit;">So we can set the decode path (any element from the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">("tbsCertList", "revokedCertificates")</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list) on which we want to get the full </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RevokedCertificate</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object:</font></font><br>
<br>
<pre><code class="plaintext hljs">for decode_path, obj, _ in CertificateList().decode_evgen(raw, ctx={<font></font>
    "evgen_mode_upto": (<font></font>
        (("tbsCertList", "revokedCertificates", any), True),<font></font>
    ),<font></font>
}):<font></font>
    if (len(decode_path) == 3) and (decode_path[1] == "revokedCertificates"):<font></font>
        print(int(obj["userCertificate"]))<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aggregate strings: agg_octet_string</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have no problems decoding objects of any size. There is no problem decoding a DER-encoded CMS with a copy of the database either: we are waiting for an event with a decode path pointing to the signed / encrypted data in the CMS and processing the data from the file using offset + vlen. But what if the CMS was in CER format? Then offset + vlen will not help, since all our 10 GiBs are divided into pieces of 1000 bytes, between which by the DER header. But what if we have a BER in which the nesting of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRINGs</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be anything?</font></font><br>
<br>
<pre><code class="plaintext hljs">SOME STRING[CONSTRUCTED]<font></font>
    OCTET STRING[CONSTRUCTED]<font></font>
        OCTET STRING[PRIMITIVE]<font></font>
            DATA CHUNK<font></font>
        OCTET STRING[PRIMITIVE]<font></font>
            DATA CHUNK<font></font>
        OCTET STRING[PRIMITIVE]<font></font>
            DATA CHUNK<font></font>
    OCTET STRING[PRIMITIVE]<font></font>
        DATA CHUNK<font></font>
    OCTET STRING[CONSTRUCTED]<font></font>
        OCTET STRING[PRIMITIVE]<font></font>
            DATA CHUNK<font></font>
        OCTET STRING[PRIMITIVE]<font></font>
            DATA CHUNK<font></font>
    OCTET STRING[CONSTRUCTED]<font></font>
        OCTET STRING[CONSTRUCTED]<font></font>
            OCTET STRING[PRIMITIVE]<font></font>
                DATA CHUNK<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When decoding in evgen mode, for each piece we get the corresponding event and it is enough for us to collect only primitive (not constructed) </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* STRING</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> events, where offset + vlen contain real pieces of data. PyDERASN has a convenient helper </font><font style="vertical-align: inherit;">function </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agg_octet_string</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that performs this. It is enough for her to pass an event generator, the decode path ‚Äúbelow‚Äù of which it is necessary to aggregate a string, binary data (or </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memoryview</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a function that is called with each piece of data received. We want to calculate the SHA512 hash and at the same time save the contents of </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encapContentInfo.eContent</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CMS? Find the location of the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">content</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> field (in which </font><em><font style="vertical-align: inherit;">SignedData</font></em><font style="vertical-align: inherit;"> will be located</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), and then decode its CER contents, simultaneously writing to the FS and hashing:</font></font><br>
<br>
<pre><code class="plaintext hljs">fdIn = open("data.p7m", "rb")<font></font>
raw = file_mmaped(fdIn)<font></font>
for decode_path, obj, _ in ContentInfo().decode_evgen(raw, ctx={"bered": True}):<font></font>
    if decode_path == ("content",):<font></font>
        content = obj<font></font>
        break<font></font>
hasher_state = sha512()<font></font>
fdOut = open("dump.sql.zst", "wb")<font></font>
def hash_n_save(data):<font></font>
    write_full(fdOut, data)<font></font>
    hasher_state.update(data)<font></font>
    return len(data)<font></font>
evgens = SignedData().decode_evgen(<font></font>
    raw[content.offset:],<font></font>
    offset=content.offset,<font></font>
    ctx={"bered": True},<font></font>
)<font></font>
agg_octet_string(evgens, ("encapContentInfo", "eContent"), raw, hash_n_save)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, another </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_full</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility is </font><em><font style="vertical-align: inherit;">used</font></em><font style="vertical-align: inherit;"> , which calls </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> until all data is written, since, in general, when writing to a file, the OS is not required to process all transferred data and you need to continue the process until it is completely written.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A couple of affectionate about SET OF</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Purely technically, </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cannot be encoded on the fly in DER and CER encodings, since encoded representations of all elements must be sorted. </font><font style="vertical-align: inherit;">Neither CER nor a two-pass DER will help here. </font><font style="vertical-align: inherit;">The modern ASN.1 standard therefore does not recommend the use of both </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (requiring similar sorting in DER) and </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SET OF</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And what is this picture at the beginning of the article?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was in PyDERASN that an interactive, unpretentious </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASN.1 browser appeared</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which personally helped me several times to write handlers for complex structures. </font><font style="vertical-align: inherit;">Allows you to walk around the entire decoded structure, showing full detail about each object, its location in binary data, decode path. </font><font style="vertical-align: inherit;">In addition, any item can be saved in a separate file, such as certificates or CRLs included in the CMS. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sergey Matveev</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cipherpunk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Python / Go-developer, chief specialist of FSUE ‚ÄúScientific and Technical Center‚Äú Atlas ‚Äù.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498000/index.html">Things I would like to know before developing my own game</a></li>
<li><a href="../en498002/index.html">Pocket Guide to the Z3</a></li>
<li><a href="../en498004/index.html">Workstation in a docker container</a></li>
<li><a href="../en498006/index.html">Choosing a Patent Attorney</a></li>
<li><a href="../en498012/index.html">Mikrotik RouterOS in Docker with Qemu</a></li>
<li><a href="../en498018/index.html">On-line analytics in microservice architecture: help and suggest Postgres FDW Ã∂ –∏ Post Post Ã∂–øÃ∂—ÄÃ∂–æÃ∂—ÅÃ∂—ÇÃ∂–∏Ã∂—Ç –∏—åÃ∂</a></li>
<li><a href="../en498020/index.html">About one indicator applicable for the visual assessment of rapidly growing functions</a></li>
<li><a href="../en498022/index.html">The digest of interesting materials for the mobile # 341 developer (on April 13 - 19)</a></li>
<li><a href="../en498024/index.html">Building cities with a click of the mouse with Houdini and Python</a></li>
<li><a href="../en498026/index.html">FOSS News No. 12 - review of free and open source news for April 13-19, 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>