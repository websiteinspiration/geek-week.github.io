<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëéüèª üìÜ üêÉ Apache Kafka for Dummies üëÇüèΩ üéâ ü§±üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will be useful for those who have just started to get acquainted with microservice architecture and with the Apache Kafka service. The ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apache Kafka for Dummies</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article will be useful for those who have just started to get acquainted with microservice architecture and with the Apache Kafka service. </font><font style="vertical-align: inherit;">The material does not claim to be a detailed tutorial, but will help you quickly get started with this technology. </font><font style="vertical-align: inherit;">I will talk about how to install and configure Kafka on Windows 10. We will also create a project using Intellij IDEA and Spring Boot.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What for?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Difficulties in understanding certain tools are often associated with the fact that the developer has never encountered situations in which these tools may be needed. With Kafka, this is exactly the same. We describe the situation in which this technology will be useful. If you have a monolithic application architecture, then of course you do not need any Kafka. Everything changes with the transition to microservices. In fact, each microservice is a separate program that performs one or another function, and which can be launched independently of other microservices. Microservices can be compared with employees in the office, who sit at separate desks and independently solve their problem. The work of such a distributed team is unthinkable without central coordination.Employees should be able to exchange messages and results of their work with each other. Apache Kafka for microservices is designed to solve this problem.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka is a message broker. With it, microservices can interact with each other, sending and receiving important information. The question arises, why not use the regular POST - reqest for these purposes, in the body of which you can transfer the necessary data and get the answer in the same way? This approach has a number of obvious disadvantages. For example, a producer (a service sending a message) can send data only in the form of a response in response to a request from a consumer (a service that receives data). Suppose a consumer sends a POST request and the producer answers it. At this time, for some reason, the consumer cannot accept the answer. What will happen to the data? They will be lost. The consumer will again have to send a request and hope that the data that he wanted to receive has not changed during this time,and the producer is still ready to accept the request.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka solves this and many other problems that arise when exchanging messages between microservices. </font><font style="vertical-align: inherit;">It will not be amiss to recall that uninterrupted and convenient data exchange is one of the key problems that must be solved to ensure the stable operation of the microservice architecture.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install and configure ZooKeeper and Apache Kafka on Windows 10</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing you need to know to get started is that Apache Kafka runs on top of the ZooKeeper service. ZooKeeper is a distributed configuration and synchronization service, and that‚Äôs all we need to know about it in this context. We must download, configure and run it before we get started with Kafka. Before you start working with ZooKeeper, make sure that you have JRE installed and configured. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can download the latest version of ZooKeeper from the official website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We extract the files from the downloaded ZooKeeper archive to a folder on the disk. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the zookeeper folder with the version number, we find the conf folder and in it the file ‚Äúzoo_sample.cfg‚Äù.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy it and change the name of the copy to ‚Äúzoo.cfg‚Äù. Open the copy file and find the line dataDir = / tmp / zookeeper in it. In this line we write the full path to our zookeeper-x.x.x folder. It looks like this for me: dataDir = C: \\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we add the system environment variable: ZOOKEEPER_HOME = C: \ ZooKeeper \ zookeeper-3.4.9 and at the end of the system variable Path add the entry:;% ZOOKEEPER_HOME % \ bin; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the command line and write the command:</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 If everything is done correctly, you will see something like the following. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that ZooKeeper started normally. We proceed directly to the installation and configuration of the Apache Kafka server. Download the latest version from the official site and extract the contents of the archive: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kafka.apache.org/downloads</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the folder with Kafka we find the config folder, in it we find the server.properties file and open it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We find the line log.dirs = / tmp / kafka-logs and indicate in it the path where Kafka will save the logs: log.dirs = c: / kafka / kafka-logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same folder, edit the zookeeper.properties file. We change the line dataDir = / tmp / zookeeper to dataDir = c: / kafka / zookeeper-data, without forgetting to indicate the path to your Kafka folder after the disk name. If you did everything right, you can run ZooKeeper and Kafka.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For some, it may be an unpleasant surprise that there is no GUI to control Kafka. </font><font style="vertical-align: inherit;">Perhaps this is because the service is designed for harsh nerds working exclusively with the console. </font><font style="vertical-align: inherit;">One way or another, to run Kafka we need a command line. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to start ZooKeeper. </font><font style="vertical-align: inherit;">In the folder with the kafka we find the bin / windows folder, in it we find the file to start the zookeeper-server-start.bat service, click on it. </font><font style="vertical-align: inherit;">Nothing happens? </font><font style="vertical-align: inherit;">It should be so. </font><font style="vertical-align: inherit;">Open the console in this folder and write:</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Doesn't work again? </font><font style="vertical-align: inherit;">This is the norm. </font><font style="vertical-align: inherit;">This is because zookeeper-server-start.bat requires the parameters specified in the zookeeper.properties file, which, as we recall, lies in the config folder for its work. </font><font style="vertical-align: inherit;">We write to the console:</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now everything should start normally. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once again, open the console in this folder (do not close ZooKeeper!) And run kafka:</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to write commands every time on the command line, you can use the old proven method and create a batch file with the following contents:</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The timeout 10 line is needed to set a pause between starting zookeeper and kafka. </font><font style="vertical-align: inherit;">If you did everything right, when you click on the batch file, two consoles should open with zookeeper and kafka running. Now we can create a message producer and a consumer with the necessary parameters directly from the command line. </font><font style="vertical-align: inherit;">But, in practice, it may be needed unless for testing the service. </font><font style="vertical-align: inherit;">We will be much more interested in how to work with kafka from IDEA.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with kafka from IDEA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will write the simplest application possible, which will simultaneously be the producer and consumer of the message, and then add useful features to it. </font><font style="vertical-align: inherit;">Create a new spring project. </font><font style="vertical-align: inherit;">This is most conveniently done using a spring initializer. </font><font style="vertical-align: inherit;">Add the dependencies org.springframework.kafka and spring-boot-starter-web </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the pom.xml file should look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to send messages, we need the KafkaTemplate &lt;K, V&gt; object. </font><font style="vertical-align: inherit;">As we see the object is typed. </font><font style="vertical-align: inherit;">The first parameter is the type of key, the second is the message itself. </font><font style="vertical-align: inherit;">For now, we will indicate both parameters as String. </font><font style="vertical-align: inherit;">We will create the object in the class-controller. </font><font style="vertical-align: inherit;">Declare KafkaTemplate and ask Spring to initialize it by annotating</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autowired</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In principle, our producer is ready. All that remains to be done is to call the send () method on it. There are several overloaded versions of this method. We use in our project an option with 3 parameters - send (String topic, K key, V data). Since KafkaTemplate is typed by String, the key and data in the send method will be a string. The first parameter indicates the topic, that is, the topic to which messages will be sent, and which consumers can subscribe to in order to receive them. If the topic specified in the send method does not exist, it will be created automatically. The full class text looks like this.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The controller maps to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / msg, the key and the message itself are transmitted in the request body. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The message sender is ready, now create a listener. </font><font style="vertical-align: inherit;">Spring also allows you to do this without much effort. </font><font style="vertical-align: inherit;">It is enough to create a method and mark it with the @KafkaListener annotation, in the parameters of which you can specify only the topic to be listened to. </font><font style="vertical-align: inherit;">In our case, it looks like this.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method itself, marked with annotation, can specify one accepted parameter, which has the type of message transmitted by the producer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The class in which the consumer will be created must be marked with @EnableKafka annotation.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, in the application.property settings file, you must specify the concierge parameter groupe-id. </font><font style="vertical-align: inherit;">If this is not done, the application will not start. </font><font style="vertical-align: inherit;">The parameter is of type String and can be anything.</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our simplest kafka project is ready. </font><font style="vertical-align: inherit;">We have a sender and a recipient of messages. </font><font style="vertical-align: inherit;">It remains only to run. </font><font style="vertical-align: inherit;">First, launch ZooKeeper and Kafka using the batch file that we wrote earlier, then launch our application. </font><font style="vertical-align: inherit;">It is most convenient to send a request using Postman. </font><font style="vertical-align: inherit;">In the body of the request, do not forget to specify the parameters msgId and msg. </font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we see such a picture in IDEA, then everything works: the producer sent a message, the consumer received it and displayed it on the console.</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We complicate the project</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Real projects using Kafka are certainly more complicated than the one we created. Now that we‚Äôve figured out the basic functions of the service, consider what additional features it provides. To begin with, we will improve the producer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you opened the send () method, you might notice that all of its variants have a return value of ListenableFuture &lt;SendResult &lt;K, V &gt;&gt;. Now we will not consider in detail the capabilities of this interface. Here it will be enough to say that it is needed to view the result of sending a message.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The addCallback () method accepts two parameters - SuccessCallback and FailureCallback. </font><font style="vertical-align: inherit;">Both of them are functional interfaces. </font><font style="vertical-align: inherit;">From the name you can understand that the method of the first will be called as a result of successful sending of the message, the second - as a result of an error. Now, if we run the project, we will see something like the following on the console:</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look carefully at our producer again. </font><font style="vertical-align: inherit;">Interestingly, what happens if the key is not String, but, say, Long, but as the transmitted message, and even worse - some kind of complicated DTO? </font><font style="vertical-align: inherit;">First, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
let's </font><font style="vertical-align: inherit;">try to change the key to a numeric value ... </font><font style="vertical-align: inherit;">If we specify Long as the key in the producer, the application will start normally, but when you try to send a message, a ClassCastException will be thrown and it will be reported that the Long class cannot be cast to the String class.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we try to manually create the KafkaTemplate object, we will see that the ProducerFactory &lt;K, V&gt; interface object, for example, DefaultKafkaProducerFactory &lt;&gt;, is passed to the constructor as a parameter. In order to create a DefaultKafkaProducerFactory, we need to pass a Map containing its producer settings to its constructor. All the code for the configuration and creation of the producer will be placed in a separate class. To do this, create the config package and in it the KafkaProducerConfig class.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the producerConfigs () method, create a map with the configurations and specify LongSerializer.class as the serializer for the key. </font><font style="vertical-align: inherit;">We start, send a request from Postman and see that now everything works as it should: the producer sends a message, and the consumer receives it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's change the type of the transmitted value. </font><font style="vertical-align: inherit;">What if we do not have a standard class from the Java library, but some kind of custom DTO. </font><font style="vertical-align: inherit;">Let's say this.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To send DTO as a message, you need to make some changes to the producer configuration. </font><font style="vertical-align: inherit;">Specify JsonSerializer.class as the serializer of the message value and do not forget to change the String type to UserDto everywhere.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Send a message. The following line will be displayed in the console: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are going to complicate the consumer. Prior to this, our method public void msgListener (String msg), marked with the annotation @KafkaListener (topics = "msg") took String as a parameter and displayed it on the console. What if we want to get other parameters of the transmitted message, for example, a key or a partition? In this case, the type of the transmitted value must be changed.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the ConsumerRecord object we can get all the parameters we are interested in. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that instead of the key on the console, some kind of krakozyabry are displayed. This is because the StringDeserializer is used by default to deserialize the key, and if we want the key in the integer format to display correctly, we must change it to LongDeserializer. To configure the consumer in the config package, create the KafkaConsumerConfig class.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The KafkaConsumerConfig class is very similar to the KafkaProducerConfig we created earlier. There is also a Map that contains the necessary configurations, for example, such as a deserializer for the key and value. The created map is used to create the ConsumerFactory &lt;&gt;, which, in turn, is needed to create the KafkaListenerContainerFactory &lt;?&gt;. An important detail: the method returning KafkaListenerContainerFactory &lt;?&gt; Should be called kafkaListenerContainerFactory (), otherwise Spring will not be able to find the desired bean and the project will not compile. We start.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that now the key is displayed as it should, which means that everything works. </font><font style="vertical-align: inherit;">Of course, the capabilities of Apache Kafka go far beyond those described in this article, however, I hope that after reading it you will get an idea about this service and, most importantly, you can start working with it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wash your hands more often, wear masks, do not go outside without need, and be healthy.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496170/index.html">We are doomed # 1 // Udalenka in crisis and death of originality</a></li>
<li><a href="../en496174/index.html">Increased demand for analytics, product teams, Amazon, Israel, Singapore, remote work, etc. - discussed a lot.</a></li>
<li><a href="../en496176/index.html">Big virtual conference: Real-world experience in protecting data from modern digital companies</a></li>
<li><a href="../en496178/index.html">Swift 5.2. Overview of all changes</a></li>
<li><a href="../en496180/index.html">Take care of the shadow from youth</a></li>
<li><a href="../en496184/index.html">LED Display Technology: Micro-LED vs. Mini LED</a></li>
<li><a href="../en496186/index.html">Error back propagation algorithm using Word2Vec as an example</a></li>
<li><a href="../en496188/index.html">How to stop binge watching TV shows and start living</a></li>
<li><a href="../en496190/index.html">About Phrasal Verbs-2</a></li>
<li><a href="../en496192/index.html">Call Rust functions from Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>