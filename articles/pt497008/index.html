<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜñ üôå üßòüèæ Escrevemos no PostgreSQL em um sublight: 1 host, 1 dia, 1 TB üö∂üèæ üìí üßí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, falei sobre como usar as receitas padr√£o para aumentar o desempenho das consultas de "leitura" do SQL de um banco de dados PostgreSQL. H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Escrevemos no PostgreSQL em um sublight: 1 host, 1 dia, 1 TB</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/497008/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recentemente, falei sobre como usar as receitas padr√£o para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentar o desempenho das consultas de "leitura" do SQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de um banco de dados PostgreSQL. </font><font style="vertical-align: inherit;">Hoje falaremos sobre como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ pode tornar a grava√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no banco de dados </font><b><font style="vertical-align: inherit;">mais eficiente</font></b><font style="vertical-align: inherit;"> sem usar nenhuma ‚Äúreviravolta‚Äù na configura√ß√£o - simplesmente organizando corretamente os fluxos de dados.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lv/ir/or/lvirorsnhddruod1aggj8x4fgei.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1 </font><font style="vertical-align: inherit;">Particionamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um artigo sobre como e por que vale a pena organizar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particionamento aplicado ‚Äúem teoria‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j√° foi, aqui vamos nos concentrar na pr√°tica de usar algumas abordagens na estrutura do nosso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servi√ßo de monitoramento para centenas de servidores PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Casos de dias passados ‚Äã‚Äã..."</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, como qualquer MVP, nosso projeto come√ßou com uma carga bastante pequena - o monitoramento foi realizado apenas para os dez servidores mais cr√≠ticos, todas as tabelas eram relativamente compactas ... Mas o tempo passou, havia mais e mais hosts monitorados e mais uma vez tentamos fazer algo com uma das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabelas com um tamanho de 1,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , percebemos que, embora seja poss√≠vel viver assim, √© muito inconveniente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os tempos eram quase √©picos, diferentes variantes do PostgreSQL 9.x eram relevantes, portanto todas as parti√ß√µes tinham que ser feitas manualmente - por meio da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heran√ßa de tabelas e gatilhos de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> roteamento din√¢mico </font></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/-k/sv/tt-ksvme0jrmkz2qzkh8va95pjs.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o resultante acabou por ser universal o suficiente para poder traduzi-la em todas as tabelas:</font></font><br>
<br>
<ul>
<li>   ¬´¬ª  ,     <b>   </b>.</li>
<li>       ¬´¬ª ,     <b> </b> <code>BEFORE INSERT</code>  ¬´¬ª    .      ‚Äî     ...</li>
<li>‚Ä¶   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CREATE TABLE ... (LIKE ... INCLUDING ...)</code></a>      <b>     </b>,         .</li>
</ul><br>
<h4>PG10:  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o particionamento por heran√ßa n√£o tem sido historicamente adequado para trabalhar com um fluxo de grava√ß√£o ativo ou com um grande n√∫mero de se√ß√µes filho. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ deve se lembrar que o algoritmo para selecionar a se√ß√£o desejada tinha </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complexidade quadr√°tica</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que funciona com mais de 100 se√ß√µes, voc√™ entende como ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na PG10, essa situa√ß√£o foi bastante otimizada ao implementar o suporte ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particionamento nativo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, tentamos aplic√°-lo imediatamente ap√≥s a migra√ß√£o do armazenamento, mas ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se descobriu ap√≥s a escava√ß√£o do manual, a tabela particionada nativamente nesta vers√£o:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o suporta a descri√ß√£o de √≠ndices</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o suporta gatilhos nele</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o pode ser ele pr√≥prio "descendente"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o suporta </font></font><code>INSERT ... ON CONFLICT</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o pode gerar se√ß√£o automaticamente</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dolorosamente enfiando uma testa na nossa testa, percebemos que n√£o pod√≠amos ficar sem modificar o aplicativo e adiamos mais pesquisas por seis meses.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PG10: Segunda Chance</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, come√ßamos a resolver os problemas, por sua vez:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como os gatilhos </font></font><code>ON CONFLICT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foram necess√°rios em alguns lugares, criamos uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intermedi√°ria de </font><b><font style="vertical-align: inherit;">proxy</font></b><font style="vertical-align: inherit;"> para resolv√™-los </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s nos livramos do "roteamento"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos gatilhos - isto √©, de </font></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles tiraram uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela de modelo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> separada </font><b><font style="vertical-align: inherit;">com todos os √≠ndices</font></b><font style="vertical-align: inherit;"> para que nem estivessem presentes na tabela de proxy.</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sn/3h/ra/sn3hrac9yg0-hrifkjszy7fhih0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, depois de tudo isso, a tabela principal j√° foi particionada nativamente. </font><font style="vertical-align: inherit;">A cria√ß√£o de uma nova se√ß√£o permaneceu na consci√™ncia do aplicativo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dicion√°rios "Serrar"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como em qualquer sistema anal√≠tico, tamb√©m t√≠nhamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúfatos‚Äù e ‚Äúcortes‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (dicion√°rios). No nosso caso, nessa capacidade estavam, por exemplo, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corpo do ‚Äúmodelo‚Äù do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mesmo tipo de consultas lentas ou o texto da pr√≥pria consulta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os "fatos" foram particionados por dias por um longo tempo; portanto, exclu√≠mos calmamente as se√ß√µes obsoletas e elas n√£o nos incomodaram (os logs!). Mas com os dicion√°rios o problema </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
acabou </font><font style="vertical-align: inherit;">... </font><font style="vertical-align: inherit;">N√£o quer dizer que houvesse muitos deles, mas cerca de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100 TB de ‚Äúfatos‚Äù acabaram sendo um dicion√°rio para 2,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voc√™ n√£o pode excluir convenientemente nada de uma tabela, n√£o apert√°-la em tempo adequado, e escrever nela gradualmente se torna mais lento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece um dicion√°rio ... nele, cada entrada deve ser apresentada exatamente uma vez ... e isso mesmo, mas ... Ningu√©m nos incomoda ter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um dicion√°rio separado para todos os dias</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Sim, isso traz uma certa redund√¢ncia, mas permite:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grava√ß√£o / leitura mais r√°pida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devido ao tamanho menor da se√ß√£o</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consuma menos mem√≥ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trabalhando com √≠ndices mais compactos</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">armazene menos dados</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devido √† capacidade de remover rapidamente dados obsoletos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de todo o complexo de medidas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a carga da CPU diminuiu em ~ 30% e em disco - em ~ 50%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/re/uf/x0/reufx0_4pxhj6cci456x4eb6j8q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, continuamos a escrever exatamente a mesma coisa no banco de dados, apenas com menos carga.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">Evolu√ß√£o e refatora√ß√£o de banco de dados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, decidimos que, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada dia, temos nossa pr√≥pria se√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com dados. Na verdade, essa </font></font><code>CHECK (dt = '2018-10-12'::date)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© a chave de particionamento e a condi√ß√£o para o registro cair em uma se√ß√£o espec√≠fica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como todos os relat√≥rios em nosso servi√ßo s√£o criados de acordo com uma data espec√≠fica, os √≠ndices dos "hor√°rios n√£o particionados" eram todos os tipos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(servidor, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , modelo de plano)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(servidor, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√≥ do plano)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , classe de erro, Servidor)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas agora cada se√ß√£o tem </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suas pr√≥prias inst√¢ncias de</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada um desses √≠ndices ... E dentro de cada se√ß√£o a </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data √© constante</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... Acontece que agora estamos em cada um desses √≠ndices</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inserimos trivialmente uma constante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como um dos campos, o que aumenta tanto o volume quanto o tempo de pesquisa, mas n√£o gera nenhum resultado. </font><font style="vertical-align: inherit;">Eles deixaram um ancinho, oops ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rv/to/de/rvtodengrwqlkufq8ovxlp71xn4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A dire√ß√£o da otimiza√ß√£o √© √≥bvia - basta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remover o campo de data de todos os √≠ndices</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nas tabelas particionadas. </font><font style="vertical-align: inherit;">Com nossos volumes, o ganho √© de cerca de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 TB / semana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora vamos notar que esse terabyte ainda precisava ser anotado de alguma forma. </font><font style="vertical-align: inherit;">Ou seja, tamb√©m </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamos carregar menos disco agora</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Nesta imagem, o efeito obtido com a limpeza, a que dedicamos uma semana, √© claramente vis√≠vel:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/4d/dv/x04ddvnrw9ga5m5gt4fukn44vza.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3 </font><font style="vertical-align: inherit;">"Mancha" o pico de carga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos grandes problemas dos sistemas carregados √© a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sincroniza√ß√£o excessiva de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algumas opera√ß√µes que n√£o exigem isso. √Äs vezes "porque eles n√£o perceberam", √†s vezes "era mais f√°cil", mas mais cedo ou mais tarde voc√™ precisa se livrar dele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aproximamos a imagem anterior - e vemos que o disco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"treme" com uma carga com dupla amplitude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entre amostras adjacentes, o que obviamente n√£o deve ser "estatisticamente" com tantas opera√ß√µes: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p4/9v/bw/p49vbwkzasfbjhcnudcmsqaxgaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
conseguir isso √© bastante simples. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quase 1000 servidores</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j√° foram iniciados para monitoramento </font><font style="vertical-align: inherit;">, cada um √© processado por um fluxo l√≥gico separado e cada fluxo despeja as informa√ß√µes acumuladas para enviar ao banco de dados com uma certa frequ√™ncia, algo como isto:</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema aqui reside precisamente no fato de que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os threads iniciam aproximadamente ao mesmo tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , portanto os tempos de envio para eles quase sempre coincidem "ao ponto". </font><font style="vertical-align: inherit;">Ops, n√∫mero 2 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, isso √© corrigido facilmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adicionando um intervalo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tempo </font><b><font style="vertical-align: inherit;">"aleat√≥rio"</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval * (<span class="hljs-number">1</span> + <span class="hljs-number">0.1</span> * (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>)))</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4 </font><font style="vertical-align: inherit;">Armazenamento em cache, essa </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necessidade</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O terceiro problema tradicional de alta carga √© a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falta de cache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> onde </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poderia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, tornamos poss√≠vel analisar o detalhamento dos n√≥s do plano (todos esses </font></font><code>Seq Scan on users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas imediatamente pensamos que eles eram, em geral, o mesmo - esqueci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, √© claro, nada √© gravado no banco de dados repetidamente, isso interrompe o gatilho com </font></font><code>INSERT ... ON CONFLICT DO NOTHING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas os dados n√£o chegam √† base e voc√™ precisa </font><font style="vertical-align: inherit;">fazer </font><font style="vertical-align: inherit;">uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leitura</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> extra </font><b><font style="vertical-align: inherit;">para verificar o conflito</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ops, n√∫mero 3 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferen√ßa no n√∫mero de registros enviados ao banco de dados antes / depois da ativa√ß√£o do cache √© √≥bvia: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/ed/jm/nuedjmsij1za8mx-dhkcvg36baw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E isso √© uma queda concomitante na carga de armazenamento:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oc/bx/hz/ocbxhzmmplggqzowyekkkl2lsk0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terabyte por dia parece assustador. </font><font style="vertical-align: inherit;">Se voc√™ fizer tudo certo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apenas </font><b><font style="vertical-align: inherit;">2 ^ 40 bytes / 86400 segundos = ~ 12,5MB / s</font></b><font style="vertical-align: inherit;"> , que at√© os parafusos IDE da √°rea de trabalho mant√™m. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, </font><font style="vertical-align: inherit;">falando </font><font style="vertical-align: inherit;">s√©rio, mesmo com uma inclina√ß√£o dez vezes maior da carga durante o dia, voc√™ pode facilmente encontrar as possibilidades dos SSDs modernos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/7l/e5/in7le5modvgype2possbfitaqxy.jpeg"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496996/index.html">Caracter√≠sticas de dados orientados a petroqu√≠micos</a></li>
<li><a href="../pt496998/index.html">Como c√©rebros destreinados destroem o mundo na era do coronav√≠rus</a></li>
<li><a href="../pt497000/index.html">Aplicativos do Power Automate VS Logic. Recursos Aplicativos l√≥gicos</a></li>
<li><a href="../pt497004/index.html">Descartar ativa√ß√£o (TRIM) no Linux para SSD</a></li>
<li><a href="../pt497006/index.html">Ataques MITM do Dom.ru</a></li>
<li><a href="../pt497010/index.html">Investir em per√≠odos de desacelera√ß√£o do mercado: 3 estrat√©gias de comportamento na bolsa de valores</a></li>
<li><a href="../pt497014/index.html">Quem √© voc√™, engenheiro ou testador de controle de qualidade?</a></li>
<li><a href="../pt497016/index.html">13 de abril - Java Digest</a></li>
<li><a href="../pt497020/index.html">DocuSign, um popular servi√ßo de assinatura digital, agora suporta a infraestrutura GlobalSign</a></li>
<li><a href="../pt497022/index.html">Atualizando o acesso √† rede corporativa. Novos comutadores ExtremeSwitching X435 Gigabit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>