<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆖 🙌 🧘🏾 Escrevemos no PostgreSQL em um sublight: 1 host, 1 dia, 1 TB 🚶🏾 📒 🧒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, falei sobre como usar as receitas padrão para aumentar o desempenho das consultas de "leitura" do SQL de um banco de dados PostgreSQL. H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Escrevemos no PostgreSQL em um sublight: 1 host, 1 dia, 1 TB</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/497008/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recentemente, falei sobre como usar as receitas padrão para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentar o desempenho das consultas de "leitura" do SQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de um banco de dados PostgreSQL. </font><font style="vertical-align: inherit;">Hoje falaremos sobre como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">você pode tornar a gravação</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no banco de dados </font><b><font style="vertical-align: inherit;">mais eficiente</font></b><font style="vertical-align: inherit;"> sem usar nenhuma “reviravolta” na configuração - simplesmente organizando corretamente os fluxos de dados.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lv/ir/or/lvirorsnhddruod1aggj8x4fgei.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1 </font><font style="vertical-align: inherit;">Particionamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um artigo sobre como e por que vale a pena organizar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particionamento aplicado “em teoria”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> já foi, aqui vamos nos concentrar na prática de usar algumas abordagens na estrutura do nosso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serviço de monitoramento para centenas de servidores PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Casos de dias passados ​​..."</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, como qualquer MVP, nosso projeto começou com uma carga bastante pequena - o monitoramento foi realizado apenas para os dez servidores mais críticos, todas as tabelas eram relativamente compactas ... Mas o tempo passou, havia mais e mais hosts monitorados e mais uma vez tentamos fazer algo com uma das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabelas com um tamanho de 1,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , percebemos que, embora seja possível viver assim, é muito inconveniente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os tempos eram quase épicos, diferentes variantes do PostgreSQL 9.x eram relevantes, portanto todas as partições tinham que ser feitas manualmente - por meio da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herança de tabelas e gatilhos de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> roteamento dinâmico </font></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/-k/sv/tt-ksvme0jrmkz2qzkh8va95pjs.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solução resultante acabou por ser universal o suficiente para poder traduzi-la em todas as tabelas:</font></font><br>
<br>
<ul>
<li>   «»  ,     <b>   </b>.</li>
<li>       «» ,     <b> </b> <code>BEFORE INSERT</code>  «»    .      —     ...</li>
<li>…   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>CREATE TABLE ... (LIKE ... INCLUDING ...)</code></a>      <b>     </b>,         .</li>
</ul><br>
<h4>PG10:  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o particionamento por herança não tem sido historicamente adequado para trabalhar com um fluxo de gravação ativo ou com um grande número de seções filho. </font><font style="vertical-align: inherit;">Por exemplo, você deve se lembrar que o algoritmo para selecionar a seção desejada tinha </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complexidade quadrática</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que funciona com mais de 100 seções, você entende como ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na PG10, essa situação foi bastante otimizada ao implementar o suporte ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particionamento nativo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, tentamos aplicá-lo imediatamente após a migração do armazenamento, mas ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se descobriu após a escavação do manual, a tabela particionada nativamente nesta versão:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não suporta a descrição de índices</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não suporta gatilhos nele</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não pode ser ele próprio "descendente"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não suporta </font></font><code>INSERT ... ON CONFLICT</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não pode gerar seção automaticamente</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dolorosamente enfiando uma testa na nossa testa, percebemos que não podíamos ficar sem modificar o aplicativo e adiamos mais pesquisas por seis meses.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PG10: Segunda Chance</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, começamos a resolver os problemas, por sua vez:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como os gatilhos </font></font><code>ON CONFLICT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foram necessários em alguns lugares, criamos uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intermediária de </font><b><font style="vertical-align: inherit;">proxy</font></b><font style="vertical-align: inherit;"> para resolvê-los </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nós nos livramos do "roteamento"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos gatilhos - isto é, de </font></font><code>EXECUTE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles tiraram uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela de modelo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> separada </font><b><font style="vertical-align: inherit;">com todos os índices</font></b><font style="vertical-align: inherit;"> para que nem estivessem presentes na tabela de proxy.</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sn/3h/ra/sn3hrac9yg0-hrifkjszy7fhih0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, depois de tudo isso, a tabela principal já foi particionada nativamente. </font><font style="vertical-align: inherit;">A criação de uma nova seção permaneceu na consciência do aplicativo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dicionários "Serrar"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como em qualquer sistema analítico, também tínhamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“fatos” e “cortes”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (dicionários). No nosso caso, nessa capacidade estavam, por exemplo, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corpo do “modelo” do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mesmo tipo de consultas lentas ou o texto da própria consulta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os "fatos" foram particionados por dias por um longo tempo; portanto, excluímos calmamente as seções obsoletas e elas não nos incomodaram (os logs!). Mas com os dicionários o problema </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
acabou </font><font style="vertical-align: inherit;">... </font><font style="vertical-align: inherit;">Não quer dizer que houvesse muitos deles, mas cerca de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100 TB de “fatos” acabaram sendo um dicionário para 2,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Você não pode excluir convenientemente nada de uma tabela, não apertá-la em tempo adequado, e escrever nela gradualmente se torna mais lento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece um dicionário ... nele, cada entrada deve ser apresentada exatamente uma vez ... e isso mesmo, mas ... Ninguém nos incomoda ter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um dicionário separado para todos os dias</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Sim, isso traz uma certa redundância, mas permite:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gravação / leitura mais rápida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devido ao tamanho menor da seção</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consuma menos memória</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trabalhando com índices mais compactos</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">armazene menos dados</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devido à capacidade de remover rapidamente dados obsoletos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de todo o complexo de medidas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a carga da CPU diminuiu em ~ 30% e em disco - em ~ 50%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/re/uf/x0/reufx0_4pxhj6cci456x4eb6j8q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, continuamos a escrever exatamente a mesma coisa no banco de dados, apenas com menos carga.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">Evolução e refatoração de banco de dados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, decidimos que, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada dia, temos nossa própria seção</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com dados. Na verdade, essa </font></font><code>CHECK (dt = '2018-10-12'::date)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é a chave de particionamento e a condição para o registro cair em uma seção específica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como todos os relatórios em nosso serviço são criados de acordo com uma data específica, os índices dos "horários não particionados" eram todos os tipos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(servidor, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , modelo de plano)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(servidor, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nó do plano)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , classe de erro, Servidor)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas agora cada seção tem </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suas próprias instâncias de</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada um desses índices ... E dentro de cada seção a </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data é constante</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... Acontece que agora estamos em cada um desses índices</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inserimos trivialmente uma constante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como um dos campos, o que aumenta tanto o volume quanto o tempo de pesquisa, mas não gera nenhum resultado. </font><font style="vertical-align: inherit;">Eles deixaram um ancinho, oops ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rv/to/de/rvtodengrwqlkufq8ovxlp71xn4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A direção da otimização é óbvia - basta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remover o campo de data de todos os índices</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nas tabelas particionadas. </font><font style="vertical-align: inherit;">Com nossos volumes, o ganho é de cerca de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 TB / semana</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora vamos notar que esse terabyte ainda precisava ser anotado de alguma forma. </font><font style="vertical-align: inherit;">Ou seja, também </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamos carregar menos disco agora</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Nesta imagem, o efeito obtido com a limpeza, a que dedicamos uma semana, é claramente visível:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/4d/dv/x04ddvnrw9ga5m5gt4fukn44vza.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3 </font><font style="vertical-align: inherit;">"Mancha" o pico de carga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos grandes problemas dos sistemas carregados é a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sincronização excessiva de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algumas operações que não exigem isso. Às vezes "porque eles não perceberam", às vezes "era mais fácil", mas mais cedo ou mais tarde você precisa se livrar dele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aproximamos a imagem anterior - e vemos que o disco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"treme" com uma carga com dupla amplitude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entre amostras adjacentes, o que obviamente não deve ser "estatisticamente" com tantas operações: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p4/9v/bw/p49vbwkzasfbjhcnudcmsqaxgaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
conseguir isso é bastante simples. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quase 1000 servidores</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> já foram iniciados para monitoramento </font><font style="vertical-align: inherit;">, cada um é processado por um fluxo lógico separado e cada fluxo despeja as informações acumuladas para enviar ao banco de dados com uma certa frequência, algo como isto:</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema aqui reside precisamente no fato de que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os threads iniciam aproximadamente ao mesmo tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , portanto os tempos de envio para eles quase sempre coincidem "ao ponto". </font><font style="vertical-align: inherit;">Ops, número 2 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, isso é corrigido facilmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adicionando um intervalo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tempo </font><b><font style="vertical-align: inherit;">"aleatório"</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="javascript hljs">setInterval(sendToDB, interval * (<span class="hljs-number">1</span> + <span class="hljs-number">0.1</span> * (<span class="hljs-built_in">Math</span>.random() - <span class="hljs-number">0.5</span>)))</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4 </font><font style="vertical-align: inherit;">Armazenamento em cache, essa </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necessidade</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O terceiro problema tradicional de alta carga é a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falta de cache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> onde </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poderia</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, tornamos possível analisar o detalhamento dos nós do plano (todos esses </font></font><code>Seq Scan on users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas imediatamente pensamos que eles eram, em geral, o mesmo - esqueci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não, é claro, nada é gravado no banco de dados repetidamente, isso interrompe o gatilho com </font></font><code>INSERT ... ON CONFLICT DO NOTHING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas os dados não chegam à base e você precisa </font><font style="vertical-align: inherit;">fazer </font><font style="vertical-align: inherit;">uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leitura</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> extra </font><b><font style="vertical-align: inherit;">para verificar o conflito</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ops, número 3 ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferença no número de registros enviados ao banco de dados antes / depois da ativação do cache é óbvia: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/ed/jm/nuedjmsij1za8mx-dhkcvg36baw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E isso é uma queda concomitante na carga de armazenamento:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oc/bx/hz/ocbxhzmmplggqzowyekkkl2lsk0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terabyte por dia parece assustador. </font><font style="vertical-align: inherit;">Se você fizer tudo certo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serão</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apenas </font><b><font style="vertical-align: inherit;">2 ^ 40 bytes / 86400 segundos = ~ 12,5MB / s</font></b><font style="vertical-align: inherit;"> , que até os parafusos IDE da área de trabalho mantêm. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, </font><font style="vertical-align: inherit;">falando </font><font style="vertical-align: inherit;">sério, mesmo com uma inclinação dez vezes maior da carga durante o dia, você pode facilmente encontrar as possibilidades dos SSDs modernos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/7l/e5/in7le5modvgype2possbfitaqxy.jpeg"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496996/index.html">Características de dados orientados a petroquímicos</a></li>
<li><a href="../pt496998/index.html">Como cérebros destreinados destroem o mundo na era do coronavírus</a></li>
<li><a href="../pt497000/index.html">Aplicativos do Power Automate VS Logic. Recursos Aplicativos lógicos</a></li>
<li><a href="../pt497004/index.html">Descartar ativação (TRIM) no Linux para SSD</a></li>
<li><a href="../pt497006/index.html">Ataques MITM do Dom.ru</a></li>
<li><a href="../pt497010/index.html">Investir em períodos de desaceleração do mercado: 3 estratégias de comportamento na bolsa de valores</a></li>
<li><a href="../pt497014/index.html">Quem é você, engenheiro ou testador de controle de qualidade?</a></li>
<li><a href="../pt497016/index.html">13 de abril - Java Digest</a></li>
<li><a href="../pt497020/index.html">DocuSign, um popular serviço de assinatura digital, agora suporta a infraestrutura GlobalSign</a></li>
<li><a href="../pt497022/index.html">Atualizando o acesso à rede corporativa. Novos comutadores ExtremeSwitching X435 Gigabit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>