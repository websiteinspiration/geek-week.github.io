<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦀 🔏 🖼️ 领事+ iptables =：3 👍 👋🏽 🚖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在2010年，Wargaming拥有50台服务器和一个简单的网络模型：后端，前端和防火墙。服务器数量增加，模型变得更加复杂：分段，带有ACL的隔离VLAN，然后是带有VRF的VPN，带有ACL到L2的VLAN，从ACL到L3的VRF。头在旋转吗？更多会更有趣。
 
 当服务器开始运行16,000个不...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>领事+ iptables =：3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在2010年，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargaming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拥有50台服务器和一个简单的网络模型：后端，前端和防火墙。服务器数量增加，模型变得更加复杂：分段，带有ACL的隔离VLAN，然后是带有VRF的VPN，带有ACL到L2的VLAN，从ACL到L3的VRF。头在旋转吗？更多会更有趣。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当服务器开始运行16,000个不费吹灰之力的众多异构网段时，就变得不可能了。因此，他们提出了不同的解决方案。我们采用了Netfilter堆栈，并向其中添加了Consul作为数据源，并获得了快速分布式防火墙。他们替换了路由器上的ACL，并用作外部和内部防火墙。对于动态工具管理，我们开发了BEFW系统，该系统已广泛使用：从控制用户对食品杂货网络的访问到将网段彼此隔离。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切如何运作，以及为什么您应该仔细研究这个系统，告诉</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安穆尔</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）-明斯克公司开发中心维护部门基础设施安全小组的负责人。</font><font style="vertical-align: inherit;">Ivan是SELinux的狂热者，喜欢Perl，编写代码。</font><font style="vertical-align: inherit;">作为IB小组的负责人，他定期处理日志，备份和研发工作，以保护Wargaming免受黑客攻击并确保公司中所有游戏服务器的正常运行。</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历史参考</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在告诉我们如何做之前，我将告诉您我们是如何做到的以及为什么需要它。为此，我们在9年前转移：2010年，只有《战车世界》出现了。 Wargaming大约有50台服务器。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公司服务器的增长图。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
我们有一个网络模型。在那个时候，它是最佳的。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2010年的网络模型。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在前端，有坏蛋想破坏我们，但其中有防火墙。后端没有防火墙，但是那里有50台服务器，我们都知道。一切正常。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
四年来，服务器机队增长了100倍，达到5000台。出现了第一个隔离的网络-阶段：它们无法投入生产，而且可能会危险的事情在那儿旋转。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2014年的网络模型。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
惯性地，使用了所有相同的密封套，并且所有工作都在隔离的VLAN上进行：将ACL写入VLAN，以允许或禁止任何连接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2016年，服务器数量达到8000台。Wargaming吸收了其他工作室，出现了更多的会员网络。它们似乎是我们的，但不完全是：VLAN通常不适用于合作伙伴，您必须使用具有VRF的VPN，隔离变得更加复杂。混合了ACL分离株。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
年</font><em><font style="vertical-align: inherit;">采用网络模型。</font></em><font style="vertical-align: inherit;">到2018年初，汽车车队增加到16,000。有6个细分市场，我们不计算存储财务数据的其余部分（包括封闭部分）。有容器网络（Kubernetes），DevOps，通过VPN连接的云网络，例如，从IVS。有很多规则-很伤人。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018年的网络模型和隔离方法。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了进行隔离，我们使用了：L2上具有ACL的VLAN，L3上具有ACL的VRF，VPN等。</font><font style="vertical-align: inherit;">太多了。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个人都生活在ACL和VLAN中。</font><font style="vertical-align: inherit;">通常有什么问题？</font><font style="vertical-align: inherit;">哈罗德隐藏了痛苦，将回答这个问题。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
问题很多，但有五个大问题。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新规则的几何价格上涨</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">每个新规则的添加时间都比前一个规则长，因为您必须首先查看是否已经存在这样的规则。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网段内部没有防火墙</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">段之间以某种方式彼此分离，内部已经没有足够的资源。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该规则已经应用了很长时间。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个本地规则操作员可以在一个小时内完成手写。</font><font style="vertical-align: inherit;">全球花了几天时间。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审核规则有困难</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">更确切地说，这是不可能的。</font><font style="vertical-align: inherit;">最早的规则写于2010年，大多数作者不再在公司工作。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对基础设施的控制水平低</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是主要的问题-我们不知道发生了什么事。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是网络工程师在2018年听到的样子：“我们需要更多ACL。”</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在2018年初，决定对此做一些事情。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集成的价格在不断增长。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起点是大型数据中心不再支持隔离的VLAN和ACL，因为设备上的内存已用完。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解决方案：消除了人为因素，并自动提供了最大的访问权限。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新规则适用很长时间。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案：加快规则的应用，使其分布和并行。为此，您需要一个分布式系统，以便规则可以单独交付，而每千个系统中没有rsync或SFTP。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网段内部缺少防火墙。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当不同的服务出现在同一网络中时，网段内部的防火墙开始向我们飞来。解决方案：使用基于主机的防火墙。几乎到处都是Linux，而iptables到处都是，这不是问题。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">审核规则有困难。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案：将所有规则放在一个地方进行审查和管理，以便我们可以审核所有内容。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对基础架构的控制水平较低。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案：清点所有服务及其之间的访问。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这更多是一个管理过程，而不是技术过程。</font><font style="vertical-align: inherit;">有时我们每周有200-300个新版本，特别是在促销和节假日期间。</font><font style="vertical-align: inherit;">但是，这仅适用于我们的DevOps的一个团队。</font><font style="vertical-align: inherit;">有这么多版本，无法看到需要什么样的端口，IP和集成。</font><font style="vertical-align: inherit;">因此，我们需要经过专门培训的服务经理来采访团队：“那里有什么，为什么要举起呢？” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过我们的一切努力，2019年的网络工程师开始看起来像这样。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们决定将在服务经理的帮助下找到的所有内容都放在Consul中，然后从那里编写iptables规则。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们是如何决定这样做的？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们收集所有服务，网络和用户。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们根据它们创建iptables规则。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动化控制。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利润。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consul不是远程API；它可以在每个节点上工作并写入iptables。</font><font style="vertical-align: inherit;">仍然只有自动清除多余的东西，大多数问题都将得到解决！</font><font style="vertical-align: inherit;">我们将在此过程中完成其余的工作。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么要领事？</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完善的。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在2014-15年度，我们将其用作Vault的后端，我们在其中存储了密码。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不会丢失数据</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在使用过程中，领事在任何事故中均不会丢失数据。对于防火墙管理系统而言，这是一个巨大的优势。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2P通信加速了变化的传播</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。使用P2P，所有更改都可以很快完成，无需等待数小时。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">便捷的REST API。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们还考虑了Apache ZooKeeper，但它没有REST API，您将不得不cru着拐杖。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它用作密钥库（KV）和目录（服务发现）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。您可以立即存储服务，目录，数据中心。这不仅对我们方便，而且对附近的团队也很方便，因为在建立全球服务时，我们认为规模很大。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用Go语言编写，它是Wargaming堆栈的一部分。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们喜欢这种语言，我们有很多Go开发人员。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">强大的ACL系统。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Consul中，您可以使用ACL来管理写谁和写什么。</font><font style="vertical-align: inherit;">我们保证防火墙的规则不会与其他任何规则重叠，并且我们对此不会有任何问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是领事有其缺点。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您没有企业版，则它不会在数据中心内扩展。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它仅由联盟缩放。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常取决于网络质量和服务器负载。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果网络中存在任何滞后（例如速度不均匀），Consul将无法正常用作繁忙服务器上的服务器。</font><font style="vertical-align: inherit;">这是由于P2P连接和更新分发模型。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无障碍监控的困难</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在领事的地位可以说一切都很好，但是他早已死亡。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在领事馆运作期间解决了大多数此类问题，因此我们选择了它。</font><font style="vertical-align: inherit;">该公司已经制定了替代后端的计划，但是我们已经学会了如何处理问题，并且仍然与Consul合作。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事如何工作</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在条件数据中心中，我们安装了三到五台服务器。</font><font style="vertical-align: inherit;">一两个服务器将无法工作：当数据不匹配时，它们将无法组织仲裁并确定谁是对的，谁是错的。</font><font style="vertical-align: inherit;">超过五个没有意义，性能将会下降。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
客户端以任何顺序连接到服务器：相同的代理，仅带有标志</font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，客户端会收到一个P2P连接列表，并在它们之间建立连接。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在全球范围内，我们正在互连多个数据中心。</font><font style="vertical-align: inherit;">他们还连接P2P并进行通信。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当我们要从另一个数据中心收集数据时，请求将在服务器之间进行。</font><font style="vertical-align: inherit;">这种方案称为</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serf协议</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">像领事一样的农奴协议是由HashiCorp开发的。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于领事的一些重要事实</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
领事有描述他的工作的文件。</font><font style="vertical-align: inherit;">我只会给出一些值得了解的事实。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事服务器从选民中选择主人</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Consul从每个数据中心的服务器列表中选择向导，并且无论服务器数量如何，所有请求都只会发送给该向导。</font><font style="vertical-align: inherit;">挂起向导不会导致再次当选。</font><font style="vertical-align: inherit;">如果未选择向导，则任何人都无法满足请求。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您要水平缩放吗？</font><font style="vertical-align: inherit;">对不起，不行。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到另一个数据中心的请求都从主服务器发送到主服务器，而不管它是到达哪个服务器。</font><font style="vertical-align: inherit;">除转发请求上的负载外，所选主服务器将承受100％的负载。</font><font style="vertical-align: inherit;">所有数据中心服务器都具有数据的最新副本，但只有一个答案。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">扩展的唯一方法是在客户端上启用陈旧模式。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在陈旧模式下，您可以无仲裁地进行响应。在这种模式下，我们拒绝数据一致性，但是读取速度比平常快一点，并且任何服务器都会响应。自然地，录制仅通过母带进行。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事不会在数据中心之间复制数据</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。收集联盟时，每个服务器将只有其自己的数据。对于其他人，他总是求助于其他人。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作的原子性不能在事务之外得到保证</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。请记住，不仅您可以更改某些内容。如果您希望有所不同，请使用锁进行交易。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">阻塞操作不能保证阻塞</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。该请求从一个主服务器发送到另一个主服务器，而不是直接发送，因此无法保证例如在另一个数据中心中锁定时该锁定将起作用。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL也不保证访问（在许多情况下）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 ACL可能无法工作，因为它存储在联盟的一个数据中心内-ACL数据中心（主DC）中。如果DC无法回答您，则ACL将不起作用。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个悬停向导将冻结整个联盟</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。例如，在联盟中有10个数据中心，而在一个中有一个坏的网络，而一个主节点掉线了。与他交流的每个人都围成一个圈：正在发出请求，对此没有答案，线程挂起。仅在一两个小时内，整个联合会就将倒台，这是不可能的。您对此无能为力。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状态，法定人数和选举在单独的线程中处理。</font><font style="vertical-align: inherit;">重新选择不会发生，状态不会显示任何内容。</font><font style="vertical-align: inherit;">您问，您有一个现场领事，什么也没发生-没有答案。</font><font style="vertical-align: inherit;">而且，状态表明一切都很好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
面对这个问题，为了避免这种情况，我们不得不重建数据中心的特定部分。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul Enterprise的商业版本没有上述缺点</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它具有许多有用的功能：投票，分发，缩放。</font><font style="vertical-align: inherit;">只有一个“但是”-分布式系统的许可系统非常昂贵。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生活技巧：</font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-治愈所有疾病的药物。</font><font style="vertical-align: inherit;">如果您不满意，只需删除数据并从副本中下载数据即可。</font><font style="vertical-align: inherit;">领事很可能会工作。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">贝夫</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在让我们谈谈我们向领事添加的内容。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -的缩写</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">床和</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ACK </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ë</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在F</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的怒火</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有。</font><font style="vertical-align: inherit;">创建存储库时必须以某种方式命名产品，以便将第一个测试提交放入其中。</font><font style="vertical-align: inherit;">这个名字仍然存在。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">规则模板</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
规则以iptables语法编写。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P输入下降</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -m状态-状态已建立，已建立-j接受</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A输入-i lo -j接受</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A输入-j BEFW</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大家都去BEFW链，除了</font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和本地主机。</font><font style="vertical-align: inherit;">模板可以是任何东西，这只是一个例子。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW有什么用？</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们有一个服务，它总是有一个端口，即它在其上工作的节点。</font><font style="vertical-align: inherit;">从我们的节点，我们可以在本地询问代理并发现我们有某种服务。</font><font style="vertical-align: inherit;">您还可以放置标签。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Consul中运行并注册的任何服务都将变成iptables规则。</font><font style="vertical-align: inherit;">我们有SSH-打开端口22。bash脚本很简单：curl和iptables，不需要其他任何东西。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顾客</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如何不对所有人开放访问，而是对所有人开放？</font><font style="vertical-align: inherit;">通过服务名称，将IP列表添加到KV存储库。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，我们希望第十个网络中的每个人都能够访问SSH_TCP_22服务。</font><font style="vertical-align: inherit;">添加一个小的TTL字段？</font><font style="vertical-align: inherit;">现在我们有了临时权限，例如一天。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问权限</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将服务与客户联系起来：我们为每一个KV存储准备就绪提供服务。</font><font style="vertical-align: inherit;">现在，我们不让所有人访问，而是选择性地访问。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">团体</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果每次我们为访问编写数千个IP，我们都会感到厌倦。</font><font style="vertical-align: inherit;">让我们提出分组-KV中的一个单独子集。</font><font style="vertical-align: inherit;">我们将其称为Alias（或组），并根据相同的原理将组存储在此处。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
连接：现在，我们可以不专门在P2P上打开SSH，而可以在整个组或几个组上打开SSH。</font><font style="vertical-align: inherit;">同样，也有TTL-您可以添加到组中并暂时从组中删除。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">积分</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的问题是人为因素和自动化。到目前为止，我们已经这样解决了。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们使用Puppet，并将与系统（应用程序代码）相关的所有内容都传送给它。 Puppetdb（常规PostgreSQL）存储在此处运行的服务列表，您可以按资源类型找到它们。在那里您可以找到谁去哪里。我们也有一个拉取请求和合并请求系统。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们编写了befw-sync，这是帮助传输数据的最简单解决方案。首先，将同步cookie转到puppetdb。在此处配置HTTP API：我们询问我们拥有哪些服务，需要完成哪些工作。然后他们向领事提出请求。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有整合吗？</font><font style="vertical-align: inherit;">是的：他们编写了规则，允许接受拉取请求。</font><font style="vertical-align: inherit;">需要一些端口或将主机添加到某个组？</font><font style="vertical-align: inherit;">拉取请求，复查-不再“找到200个其他ACL并尝试对此做一些事情”。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用空规则链的本地主机ping需要0.075毫秒。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在此链中添加10,000个iptables。</font><font style="vertical-align: inherit;">结果，ping将增加5倍：iptables是完全线性的，处理每个地址都需要一些时间。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于将数千个ACL迁移到其中的防火墙，我们有很多规则，这会带来延迟。</font><font style="vertical-align: inherit;">对于游戏协议，这是不好的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果我们将</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,000个地址放入ipset</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping中，甚至会减少。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关键是，ipset的“ O”（算法复杂度）始终为1，无论有多少规则。</font><font style="vertical-align: inherit;">没错，这是有限制的-规则不能超过65535个，现在，我们可以忍受：您可以将它们组合，扩展它们，将两个ipset合并为一个。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
迭代过程的逻辑延续是在ipset中存储该服务的客户信息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们具有相同的SSH，并且我们不会立即写入100 IP，但是我们将名称ipset设置为与之通信，并遵循以下规则</font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您可以重做规则“谁不在这里，那就是DROP”，但更清楚。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们有了规则和集合。</font><font style="vertical-align: inherit;">主要任务是在编写规则之前进行设置，因为否则iptables将不会编写规则。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般方案</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以图表的形式，我所说的一切看起来都是这样。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提交给Puppet，一切都发送到主机，服务在这里，ipset在那，并且没有注册的人是不允许的。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许否认</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了快速拯救世界或迅速关闭某人，在所有链的开头，我们设置了两个ipset：</font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">怎么运行的？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，有机器人的人会在我们的网络上创建负载。</font><font style="vertical-align: inherit;">以前，有必要通过日志查找其IP，并将其提交给网络工程师，以便他们找到流量的来源并禁止它。</font><font style="vertical-align: inherit;">现在看起来不一样了。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们运送到领事，等待2.5 s，您就完成了。</font><font style="vertical-align: inherit;">由于领事通过P2P进行快速分发，因此它可以在世界上的任何地方工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一旦我完全停止了WOT，就对防火墙犯了错误。</font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-这是我们针对此类情况的保险。</font><font style="vertical-align: inherit;">如果我们在某处的防火墙上犯了一个错误，某处的某物被阻止了，我们总是可以发送一个条件</font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来快速提升一切。</font><font style="vertical-align: inherit;">然后，我们将动手修理所有东西。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他套</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以在space中添加任何其他集合</font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
做什么的？</font><font style="vertical-align: inherit;">例如，有时有人需要一个ipset来模拟集群某些部分的断开连接。</font><font style="vertical-align: inherit;">每个人都可以带上任何套服，叫他们，它们将从领事馆带走。</font><font style="vertical-align: inherit;">同时，这些集合既可以参与iptables规则，又可以像团队一样</font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：守护程序将支持一致性。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户数</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它曾经是这样的：一个用户连接到网络并通过域接收参数。</font><font style="vertical-align: inherit;">直到下一代防火墙，思科才能够了解用户在哪里以及IP在哪里。</font><font style="vertical-align: inherit;">因此，仅通过主机名计算机授予访问权限。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们做了什么？</font><font style="vertical-align: inherit;">收到地址时已楔入。</font><font style="vertical-align: inherit;">通常是dot1x，Wi-Fi或VPN-一切都通过RADIUS进行。</font><font style="vertical-align: inherit;">对于每个用户，请按用户名创建一个组，并在其中放入一个带有TTL的IP，该IP等于其dhcp.lease-一旦过期，该规则就会消失。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们可以通过用户名打开对服务以及其他组的访问。</font><font style="vertical-align: inherit;">当主机名更改时，我们摆脱了主机名的困扰，并减轻了网络工程师的负担，因为他们不再需要Cisco。</font><font style="vertical-align: inherit;">现在，工程师自己规定访问服务器的权限。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绝缘</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，我们开始拆卸绝缘材料。</font><font style="vertical-align: inherit;">服务经理进行了盘点，我们分析了所有网络。</font><font style="vertical-align: inherit;">我们将它们分解为相同的组，并在必要的服务器上添加了这些组，例如拒绝。</font><font style="vertical-align: inherit;">现在，生产中的rules_deny进入了相同的阶段隔离，但生产本身中没有。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该方案快速简便地工作：从服务器上删除所有ACL，卸载硬件，减少隔离VLAN的数量。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完整性控制</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前，有一个特殊的触发器对我们有用，它会在有人用手更改防火墙规则时通知。</font><font style="vertical-align: inherit;">我写了一个庞大的防火墙规则检查器，这很困难。</font><font style="vertical-align: inherit;">现在，完整性控制BEFW。</font><font style="vertical-align: inherit;">他热情地确保自己制定的规则不会改变。</font><font style="vertical-align: inherit;">如果有人更改了防火墙规则，他将把所有内容退回。</font><font style="vertical-align: inherit;">“我迅速在这里提出了一个代理，可以在家工作”-不再有这种选择。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW从服务中控制ipset，并在befw.conf中列出BEFW链中的服务规则。</font><font style="vertical-align: inherit;">但是不遵循其他链和规则以及其他ipset。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事故保护</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW总是将最后成功的状态直接保存在state.bin的二进制结构中。如果出了什么问题，它总是回滚到此state.bin。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当领事不发送数据或有人犯了错误并且使用了无法应用的规则时，这就是领事的不稳定保险。为了使我们没有防火墙，如果在某个阶段发生错误，BEFW将回滚到最后一个状态。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在紧急情况下，这保证了我们将继续使用有效的防火墙。我们打开所有灰色网络，希望管理员能来解决它​​。有一天，我将在配置中使用它，但现在我们只有三个灰色网络：10 / 8、172 / 12和192.168 / 16。作为我们领事的一部分，这是有助于进一步发展的重要功能。</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将告诉您我们遇到的错误。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset添加设置0.0.0.0/0。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果添加到ipset 0.0.0.0/0会发生什么？是否会添加所有IP？是否可以打开互联网？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不，我们遇到了一个错误，使我们损失了两个小时的停机时间。此外，该漏洞自2016年以来一直未起作用，它位于RedHat Bugzilla中，编号为1297092，但我们是偶然发现的-来自开发人员的报告。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在BEFW有了一条严格的规则，它</font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变成了两个地址：</font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset恢复集&lt;文件。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ipset告诉您什么</font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？您认为它像iptables一样起作用吗？恢复数据？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没什么-他会合并，并且旧地址不会消失，您也无法关闭访问权限。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
测试隔离时，我们发现了一个错误。现在有一个相当复杂的系统- </font><font style="vertical-align: inherit;">然后</font><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">而不是</font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行</font><font style="vertical-align: inherit;">该系统</font><font style="vertical-align: inherit;">。交换结束时：为了实现原子性，因为如果您先执行</font><font style="vertical-align: inherit;">该操作，然后此时有一些软件包到达，则它将被丢弃，并且会出问题。因此，有一点黑魔法。</font><strong><font style="vertical-align: inherit;">领事kv get -datacenter = other。</font></strong><font style="vertical-align: inherit;">就像我说的，我们认为我们正在请求一些数据，但是我们将得到数据或错误。我们可以在本地通过领事来完成此操作，但是在这种情况下，两者都会挂起。</font><font style="vertical-align: inherit;">
本地Consul客户端是HTTP API的包装器。但是它只是挂起，并且无论如何都不会回答Ctrl + C或Ctrl + Z</font></font><code>create temp</code><font style="vertical-align: inherit;"></font><code>restore flush temp</code><font style="vertical-align: inherit;"></font><code>restore temp</code><font style="vertical-align: inherit;"></font><code>flush</code><font style="vertical-align: inherit;"></font><br>
<br>
<strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在相邻的控制台中。</font><font style="vertical-align: inherit;">我们在构建大型集群时遇到了这一问题。</font><font style="vertical-align: inherit;">但是我们仍然没有解决方案，我们正在准备纠正领事中的错误。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事馆长没有回应。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们数据中心的主管没有回应，我们认为：“也许重新选择算法现在可以工作了？” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不，它不起作用，监视也不会显示任何内容：领事会说有一个承诺指标，已经找到一个领导者，一切都很好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们该如何应对？</font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每小时都有cron。</font><font style="vertical-align: inherit;">如果您有50台服务器-没什么大不了的。</font><font style="vertical-align: inherit;">当将有16,000时，您将了解它是如何工作的。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，我们获得了以下优势：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有Linux机器的100％覆盖率。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">速度。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动化</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使铁和网络工程师摆脱奴隶制。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集成机会几乎是无限的：即使使用Kubernetes，甚至使用Ansible，甚至使用Python。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">缺点</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：领事，我们现在和谁住在一起，而且犯错的代价很高。</font><font style="vertical-align: inherit;">例如，一次在下午6点（俄罗斯的黄金时段），我在网络列表中做出了某些裁定。</font><font style="vertical-align: inherit;">那时我们正在BEFW建造隔热材料。</font><font style="vertical-align: inherit;">我在某个地方弄错了，看来，我戴错了口罩，但是一切都在两秒钟后掉落。</font><font style="vertical-align: inherit;">监控点亮，值班人员进来：“一切都在我们身边！” </font><font style="vertical-align: inherit;">部门负责人向企业解释为什么会发生这种情况时，他变成了灰色。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误的代价很高，以至于我们想出了自己的复杂预防程序。</font><font style="vertical-align: inherit;">如果您要在大型生产中实施它，则不需要通过Consul向每个人提供主令牌。</font><font style="vertical-align: inherit;">结局很糟。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成本。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我独自编写了400个小时的代码。</font><font style="vertical-align: inherit;">为了支持我的4人团队，每个月要花费10个小时。</font><font style="vertical-align: inherit;">与任何新一代防火墙的价格相比，它是免费的。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计划。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">长期计划是寻找替代或替代领事的运输方式。</font><font style="vertical-align: inherit;">也许是卡夫卡之类的。</font><font style="vertical-align: inherit;">但是在未来的几年中，我们将继续担任领事。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
近期计划：与Fail2ban集成，与监视，与nftables集成，可能与其他发行版，指标，高级监视，优化。</font><font style="vertical-align: inherit;">Kubernetes的支持也在计划中，因为现在我们有几个集群和需求。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一个计划：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">搜索交通异常；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网络地图管理；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes支持；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组装所有系统的包装；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网页界面</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们一直在努力扩展配置，增加指标和优化。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加入项目。</font><font style="vertical-align: inherit;">该项目原来很酷，但是不幸的是，这仍然是一个人的项目。</font><font style="vertical-align: inherit;">来到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并尝试做一些事情：提交，测试，提供一些东西，进行评估。</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同时，我们正在为</font><font style="vertical-align: inherit;">将于4月6日至7日在圣彼得堡举行的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">做准备</font><font style="vertical-align: inherit;">，并且我们邀请高负载系统的开发人员</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提交报告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">经验丰富的演讲者已经知道该怎么做，我们建议演讲的新手至少应该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尝试</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以发言人身份参加会议有很多好处。</font><font style="vertical-align: inherit;">其中，你可以阅读，例如，在结束</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这篇文章</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN486842/">https://habr.com/ru/post/zh-CN486842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN486822/index.html">[在码头旁]颤抖。第4部分。对于Web开发人员</a></li>
<li><a href="../zh-CN486824/index.html">使用ANTLR时的坏建议</a></li>
<li><a href="../zh-CN486826/index.html">在Django 2和Viber REST API上创建完整的Viberbot。第一部分-Webhook</a></li>
<li><a href="../zh-CN486828/index.html">食品设计文摘，2020年1月</a></li>
<li><a href="../zh-CN486832/index.html">针叶林走了多少年-不懂</a></li>
<li><a href="../zh-CN486844/index.html">Facebook Webhook处理的演变：从零到每秒25,000</a></li>
<li><a href="../zh-CN486850/index.html">新预留的座位-如胶囊旅馆</a></li>
<li><a href="../zh-CN486858/index.html">创建一个成熟的Viberbot。第二部分-首次联系或“ conversion_started”</a></li>
<li><a href="../zh-CN486860/index.html">ATX12VO-吃一种新方法</a></li>
<li><a href="../zh-CN486862/index.html">运动设计可帮助您与人建立联系的5个原因</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>