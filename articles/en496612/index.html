<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèæ üßñüèæ üë©üèΩ‚Äçüè≠ Yes, my old laptop is several times more powerful than your production server üõÄ üöò üì∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="These are the claims I heard from our developers. The most interesting thing is that this turned out to be true, giving rise to a lengthy investigatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Yes, my old laptop is several times more powerful than your production server</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496612/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These are the claims I heard from our developers. </font><font style="vertical-align: inherit;">The most interesting thing is that this turned out to be true, giving rise to a lengthy investigation. </font><font style="vertical-align: inherit;">It will be about SQL servers, which spin on our VMware.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/cl/8y/jacl8ygi2_fl1yve83fuy1k6vyq.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, to ensure that the production server is hopelessly behind the laptop is easy. </font><font style="vertical-align: inherit;">Run (not on tempdb and not on a base with Delayed Durability enabled) the code:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">set</span> nocount <span class="hljs-keyword">on</span>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> _t (v <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>))
<span class="hljs-keyword">declare</span> @n <span class="hljs-built_in">int</span>=<span class="hljs-number">300000</span>
<span class="hljs-keyword">while</span> @n&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">begin</span> 
  <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> _t <span class="hljs-keyword">select</span> <span class="hljs-string">'What a slowpoke!'</span>
  <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> _t
  <span class="hljs-keyword">set</span> @n=@n<span class="hljs-number">-1</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">GO</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> _t
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On my desktop, it runs for 5 seconds, and on the production server - 28 seconds. </font><font style="vertical-align: inherit;">Because SQL must wait for the physical end of the transaction log entry, and here we are doing very short transactions. </font><font style="vertical-align: inherit;">Roughly speaking, we drove a large, powerful truck into city traffic, and we see how it is famously overtaken by pizza delivery scooters - throughput is not important here, only latency is important. </font><font style="vertical-align: inherit;">And not a single network storage, no matter how many zeros in its price, will be able to win latency against the local SSD.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(in the comments it turned out that I lied - I had delayed durability in both places. Without delayed durability it turns out: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desktop - 39 seconds, 15K tr / sec, 0.065ms / io roundtrip </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PROD - 360 seconds, 1600 tr / sec, 0.6ms </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I should have paid attention too soon)</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, in this case, we are dealing with the </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trivial zeros of the zeta Riemann function</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a trivial example. In the example that the developers brought me, there was another. I became convinced that they were right, and began to clear out from the example all their specifics related to business logic. At some point, I realized that I could completely throw away their code, and write my own - which demonstrates the same problem - it runs 3-4 times slower on production:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> dbo.isPrime (@n <span class="hljs-built_in">bigint</span>)
<span class="hljs-keyword">returns</span> <span class="hljs-built_in">int</span>
<span class="hljs-keyword">as</span>
  <span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">if</span> @n = <span class="hljs-number">1</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> @n = <span class="hljs-number">2</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> @n = <span class="hljs-number">3</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> @n % <span class="hljs-number">2</span> = <span class="hljs-number">0</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">declare</span> @sq <span class="hljs-built_in">int</span>
  <span class="hljs-keyword">set</span> @sq = <span class="hljs-keyword">sqrt</span>(@n)+<span class="hljs-number">1</span> <span class="hljs-comment">-- check odds up to sqrt</span>
  <span class="hljs-keyword">declare</span> @dv <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>
  <span class="hljs-keyword">while</span> @dv &lt; @sq 
    <span class="hljs-keyword">begin</span>
	<span class="hljs-keyword">set</span> @dv=@dv+<span class="hljs-number">2</span>
	<span class="hljs-keyword">if</span> @n % @dv = <span class="hljs-number">0</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
	<span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">GO</span>
<span class="hljs-keyword">declare</span> @dt datetime <span class="hljs-keyword">set</span> @dt=<span class="hljs-keyword">getdate</span>()
<span class="hljs-keyword">select</span> dbo.isPrime(<span class="hljs-number">1000000000000037</span>)
<span class="hljs-keyword">select</span> <span class="hljs-keyword">datediff</span>(ms,@dt,<span class="hljs-keyword">getdate</span>()) <span class="hljs-keyword">as</span> ms
<span class="hljs-keyword">GO</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything is fine with you, then the verification of the simplicity of the number will be performed 6-7-8 seconds. So it was on a number of servers. But on some, the check took 25-40 seconds. Interestingly, there were no servers where the execution would take, say, 14 seconds - the code worked either very fast or very slow, that is, the problem was, let's say, black and white. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What I've done? Useful in VMware metrics. Everything was fine there - there were plenty of resources, Ready time = 0, everything was enough, during the test on both fast and slow servers CPU = 100 on one vCPU. I took a test to calculate the number of Pi - the test showed the same results on any servers. It smelled of black magic more and more.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having got out on the DEV farm, I began to play as servers. It turned out that vMotion from host to host can "cure" the server, but can and vice versa, turn a "fast" server into a "slow" one. It seems like this - some hosts have a problem ... but ... no. Some virtual machine was slowing down on the host, for example, A but it was working fast on host B. And another virtual machine, on the contrary, was working fast on A and slowed down on B! The ‚Äúfast‚Äù and ‚Äúslow‚Äù cars were often spinning on the host!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From that moment on, the air distinctly smelled of sulfur. After all, the problem could not be attributed to any virtual machine (windows patches, for example) - because it turned into a ‚Äúfast‚Äù one with vMotion. But the problem also could not be attributed to the host - because it could have both ‚Äúfast‚Äù and ‚Äúslow‚Äù machines. It was also not connected with the load - I managed to get a ‚Äúslow‚Äù machine on the host, where there was nothing besides it at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Out of desperation, I launched Process Explorer from Sysinternals and looked at the SQL stack. On slow machines, the line immediately caught my eye: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntoskrnl.exe! KeSynchronizeExecution + 0x5bf6 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntoskrnl.exe! KeWaitForMultipleObjects + 0x109d </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntoskrnl.exe! KeWaitForMultipleObjects + 0xb3f </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntosKrnx3 0!</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntoskrnl.exe! KeQuerySystemTimePrecise + 0x881 &lt;- !!!</font></font><br>
</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ntoskrnl.exe! ObDereferenceObjectDeferDelete + 0x28a </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntoskrnl.exe! KeSynchronizeExecution + 0x2de2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sqllang.dll! CDiagThreadSafe :: PxlvlReplace + 0x1a20 </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... skipped</font></font><br>
</i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sqldk.dll! SystemThread :: MakeMiniSOSThread + 0xa54 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KERNEL32.DLL! BaseThreadInitThunk + 0x14 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll.dll! RtlUserThreadStart + 0x21</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It was already something. The program was written:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        [<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetSystemTimePreciseAsFileTime</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> FILE_TIME lpSystemTimeAsFileTime</span>)</span>;<font></font>
<font></font>
        [<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]
        <span class="hljs-keyword">struct</span> FILE_TIME<font></font>
        {<font></font>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ftTimeLow;
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> ftTimeHigh;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<font></font>
            {<font></font>
                <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;<font></font>
<font></font>
                <span class="hljs-keyword">var</span> stopwatch = Stopwatch.StartNew();<font></font>
<font></font>
                <span class="hljs-keyword">while</span> (stopwatch.ElapsedMilliseconds &lt; <span class="hljs-number">1000</span>)<font></font>
                {<font></font>
                    GetSystemTimePreciseAsFileTime(<span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> fileTime);<font></font>
                    counter++;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>)<font></font>
                {<font></font>
                    Console.WriteLine(<span class="hljs-string">"{0}"</span>, counter);<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This program showed even brighter deceleration - on ‚Äúfast‚Äù machines it shows 16-18 million cycles per second, while on slow ones it‚Äôs one and a half million, or even 700 thousand. That is, the difference is 10-20 times (!!!). This was already a small victory: in any case, there was no threat of getting stuck between Microsoft and VMware support so that they would transfer arrows to each other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, progress stopped - vacation, important matters, viral hysteria and a sharp increase in load. I often mentioned a magic problem to my colleagues, but at times it seemed that they didn‚Äôt always trust me - the statement that VMware slowed down the code 10-20 times was too monstrous.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried to unearth myself what was slowing down. </font><font style="vertical-align: inherit;">At times it seemed to me that I found a solution - turning on and off Hot plugs, changing the memory size or the number of processors often turned the machine into a ‚Äúfast‚Äù one. </font><font style="vertical-align: inherit;">But not forever. </font><font style="vertical-align: inherit;">But what turned out to be true is that it is enough to go out and knock on the wheel - that is, change </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">any</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter of the virtual machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, my American colleagues suddenly found the root cause. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/qd/5b/msqd5bixfzwfkbmd1fuiptjnwvq.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hosts differed in frequency!</font></font></i><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is usually not scary. </font><font style="vertical-align: inherit;">But: when moving from a 'native' host to a host with a 'different' frequency, VMware should adjust the result of GetTimePrecise.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a rule, this is not scary, unless there is an application that requests the exact time millions of times per second, like a SQL server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But this is not scary, since SQL server does not always do this (see the Conclusion)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there are cases when this rake painfully hits. </font><font style="vertical-align: inherit;">And yet, yes, by tapping the wheel (changing something in the VM settings) I forced VMware to 'recount' the configuration, and the frequency of the current host became the 'native' frequency of the machine.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.vmware.com/files/pdf/techpaper/Timekeeping-In-VirtualMachines.pdf</font></font></a><br>
<br>
<blockquote>When you disable virtualization of the TSC, reading the TSC from within the virtual machine returns the physical machine‚Äôs TSC value, and writing the TSC from within the virtual machine has no effect. Migrating the virtual machine to another host, resuming it from suspended state, or reverting to a snapshot causes the TSC to jump discontinuously. Some guest operating systems fail to boot, or exhibit other timekeeping problems, when TSC virtualization is disabled. <b>In the past, this feature has sometimes been recommended to improve performance of applications that read the TSC frequently</b>, but performance of the virtual TSC has been improved substantially in current products. The feature has also been recommended for use when performing measurements that require a precise source of real time in the virtual machine.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, add the parameter </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitor_control.virtual_rdtsc = FALSE</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You probably have a question: what for SQL call GetTimePrecise so often? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I do not have the SQL server source, but the logic says this. SQL is almost an OS with cooperative concurrency, where each thread has to give way from time to time. Where is it better to do it? Where there is a natural expectation - lock or IO. Well, what if we spin the computational cycles? Then the obvious and almost the only place is in the interpreter (this is not quite an interpreter), after the execution of the next operator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a rule, SQL server is not used for </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nailing</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clean calculations and this is not a problem. But cycles with working with all kinds of temporary tablets (which are immediately cached) turn the code into a sequence of very quickly executed statements.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, if you wrap the function in NATIVELY COMPILED, then it stops asking for time, and its speed increases by a factor of 10. But what about cooperative multitasking? </font><font style="vertical-align: inherit;">But for natively compiled code, I had to do PREEMPTIVE MULTITASKING in SQL.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496596/index.html">What is a payment gateway? Comparison of 5 payment gateways 2020</a></li>
<li><a href="../en496598/index.html">48k to 10 lines of code - GitHub JavaScript SDK story</a></li>
<li><a href="../en496600/index.html">As part of import substitution, Moscow buys Microsoft software for 90 million rubles</a></li>
<li><a href="../en496608/index.html">Food Design Digest, March 2020</a></li>
<li><a href="../en496610/index.html">Router Banana Pi R64 - Debian, Wireguard, ILV</a></li>
<li><a href="../en496614/index.html">How have the Habrachians changed in 5 years? Or "280 weeks later"</a></li>
<li><a href="../en496616/index.html">How do we count people using computer vision</a></li>
<li><a href="../en496620/index.html">Popular errors in English among IT professionals</a></li>
<li><a href="../en496626/index.html">Journeyman and Dragons: how to help the intern to adapt as a team</a></li>
<li><a href="../en496630/index.html">Interface Bikes Toxic Grandfather. ‚ÄúArtifacts my ass!‚Äù (s1 e5)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>