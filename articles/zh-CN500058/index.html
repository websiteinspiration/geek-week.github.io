<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶🏽 💳 🚴🏽 如何开始测试Ansible，将项目重构一年，而不是一团糟 🚣🏽 🤭 🤴🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是DevOps-40 2020-03-18上的性能记录：
 

从第二次提交开始，任何代码都将成为旧代码，因为 最初的想法开始脱离现实。这既不是好事也不是坏事，这是一个既难以争论又必须相处的前提。此过程的一部分是重构。将基础结构重构为代码。让故事开始如何在一年内重构Ansible，而不是一团糟。
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>如何开始测试Ansible，将项目重构一年，而不是一团糟</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500058/"><p><img src="https://habrastorage.org/webt/bk/vw/ds/bkvwdsdsfvgvjf_ein3uddyocbm.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">DevOps-40 2020-03-18</font></a><font style="vertical-align: inherit;">上</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">性能</font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">记录</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从第二次提交开始，任何代码都将成为旧代码，因为 </font><font style="vertical-align: inherit;">最初的想法开始脱离现实。</font><font style="vertical-align: inherit;">这既不是好事也不是坏事，这是一个既难以争论又必须相处的前提。</font><font style="vertical-align: inherit;">此过程的一部分是重构。</font><font style="vertical-align: inherit;">将基础结构重构为代码。</font><font style="vertical-align: inherit;">让故事开始如何在一年内重构Ansible，而不是一团糟。</font></font></p><a name="habracut"></a><br>
<h2 id="zarozhdenie-legacy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传统开始</font></font></h2><br>
<h3 id="den--1-nulevoy-pacient"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一天：零病人</font></font></h3><br>
<p><img src="https://habrastorage.org/webt/jm/mn/9q/jmmn9qcfnbprr8maq3k2zpp27ww.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从前有一个有条件的项目。</font><font style="vertical-align: inherit;">它有一个Dev开发团队和Ops工程师。</font><font style="vertical-align: inherit;">他们解决了相同的问题：如何部署服务器和运行应用程序。</font><font style="vertical-align: inherit;">问题是每个团队都以自己的方式解决了这个问题。</font><font style="vertical-align: inherit;">该项目决定使用Ansible在Dev和Ops团队之间同步知识。</font></font></p><br>
<h3 id="den--89-zarozhdenie-legacy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第89天：传统的诞生</font></font></h3><br>
<p><img src="https://habrastorage.org/webt/p1/gg/sr/p1ggsrxayo0fachydvmwhqtloek.png"></p><br>
<p>   ,     ,   legacy.   ?</p><br>
<ul>
<li>    ,    —  .</li>
<li>          .</li>
<li>  Ansible / Python / Bash / Terraform!     !</li>
<li> Full Stack Overflow Developer    stackoverflow,     ,      .</li>
</ul><br>
<p>      ,    ,    ,   ,    ,     , ,    ,     .</p><br>
<pre><code class="plaintext hljs">- hosts: localhost<font></font>
  tasks:<font></font>
    - shell: echo -n Z &gt;&gt; a.txt &amp;&amp; cat a.txt<font></font>
      register: output<font></font>
      delay: 1<font></font>
      retries: 5<font></font>
      until: not output.stdout.find("ZZZ")</code></pre><br>
<h3 id="den--109-osoznanie-problemy"> № 109:  </h3><br>
<p><img src="https://habrastorage.org/webt/52/-m/km/52-mkm0nvoywmsugy7gscnstjh0.png"></p><br>
<p>     IaC       /  /  ,        .     ,    .</p><br>
<h2 id="refaktoring-iac"> IaC</h2><br>
<h3 id="den--139-a-vam-tochno-nuzhen-refaktoring"> № 139:     ?</h3><br>
<p><img src="https://habrastorage.org/webt/ih/ty/rh/ihtyrh6qo2oufdjxheiflkp1erg.png"></p><br>
<p>          :</p><br>
<ol>
<li>   ?</li>
<li>    ?</li>
<li>  ?</li>
</ol><br>
<p>       ,            . ..  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  ,  200 000   </a>),            .</p><br>
<h3 id="den--149-podgotovka-refaktoringa"> № 149:  </h3><br>
<p><img src="https://habrastorage.org/webt/ml/58/cc/ml58ccbdsrcynuz6be0o76uw4tm.png"></p><br>
<p>e   .    .   ,        .   - ,    confluence,      " ?"  " ?"     .       <em>  </em>:      / .       ,    ,        - .</p><br>
<p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br>
<p>,             .   ,   ,   :         ,  ,       .</p><br>
<h4 id="popytki-testirovaniya-ansible">  Ansible</h4><br>
<p>       Ansible  ,        ,      .</p><br>
<h5 id="den---997-sds-provision"> № -997: SDS provision</h5><br>
<p><img src="https://habrastorage.org/webt/wb/sx/vi/wbsxviuyfwt5ngzmn92n6wpcs6a.png"></p><br>
<p>   Ansible      SDS (Software Defined Storage).      <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">        </a>,   ,            60-90    ,   .   e2e , ..    ,    .      .          .</p><br>
<h5 id="den---701-ansible-i-test-kitchen"> № -701: Ansible  test kitchen</h5><br>
<p><img src="https://habrastorage.org/webt/kj/la/wd/kjlawd4ptlxrpsoa9bhechz57jc.png"></p><br>
<p>   Ansible    ,   test kitchen / kitchen-ci  inspec.     Ruby (     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  YML    ansible?</a>)    40   10 .         .</p><br>
<p><img src="https://habrastorage.org/webt/jj/7i/ln/jj7ilnbd5gav6wmc9ls3qapduwq.png"></p><br>
<p>   ,    - .       13    2      ,      70 ,    2  .  XP (extreme programming)     ..     70 .      </p><br>
<h5 id="den---601-ansible-i-molecule"> № -601: Ansible  molecule</h5><br>
<p><img src="https://habrastorage.org/webt/_n/23/w3/_n23w3y7acelkugzgtt0hoqxmdc.png"></p><br>
<p>    testkitchen,       docker   . ,     20-25   7 .</p><br>
<p><img src="https://habrastorage.org/webt/u5/tb/n8/u5tbn8xgqjzbnvtlqjpdsa17mmc.png"></p><br>
<p>     17   45      28   2 jenkins slave.</p><br>
<h3 id="den--167-dobavlyaem-na-proekt-testy-ansible"> № 167:     Ansible</h3><br>
<p><img src="https://habrastorage.org/webt/di/zi/cz/diziczzal8qnxt6azdlyhptniho.png"></p><br>
<p>   ,     .    ,                .          ,    .</p><br>
<p><img src="https://habrastorage.org/webt/rp/hs/tb/rphstbmcna7nbyocuotat9hbwv0.png"></p><br>
<p>        ,    ,     ,     jira,    google docs     .    ,    ,     . ,  - ,        ,   .</p><br>
<p> :</p><br>
<ul>
<li>Eat.</li>
<li>Sleep.</li>
<li>Code.</li>
<li>IaC test.</li>
<li>Repeat</li>
</ul><br>
<p>       .</p><br>
<p><img src="https://habrastorage.org/webt/wf/h8/tg/wfh8tgcdwlkb60nb-kfsyqjrxgy.png"></p><br>
<p>      ,            . </p><br>
<h3 id="den--181-green-build-master"> № 181: Green Build Master</h3><br>
<p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br>
<p>      Green Build Master.     ,          jenkins.   ,      :</p><br>
<ul>
<li>  .</li>
<li>  -     ,     .</li>
</ul><br>
<h3 id="den--193-ot-lintovki-k-unit-testam"> № 193:    unit </h3><br>
<p><img src="https://habrastorage.org/webt/eq/v-/0b/eqv-0bs92a557nhsifvggktxmps.png"></p><br>
<p>           —     ,    .     ,   .</p><br>
<h3 id="den--211-ot-unit-k-integration-testam"> № 211:  unit  integration </h3><br>
<p><img src="https://habrastorage.org/webt/2c/xt/8a/2cxt8avymduqf-k8seavlobvvqa.png"></p><br>
<p> unit       ,      . ..      ,   ,    .</p><br>
<p><img src="https://habrastorage.org/webt/rh/_h/0w/rh_h0wompfe15rx5arn9afnna2w.png"></p><br>
<p> jenkins    ,      / ,          .</p><br>
<h4 id="jenkins--docker--ansible--tests">Jenkins + Docker + Ansible = Tests</h4><br>
<p><img src="https://habrastorage.org/webt/e6/3d/0s/e63d0sm28xvpn-hlhze5bo4c8jo.png"></p><br>
<ol>
<li>Checkout&nbsp;repo&nbsp;and generate build stages.</li>
<li>Run lint playbook stages in parallel.</li>
<li>Run lint role stages in parallel.</li>
<li>Run&nbsp;syntax check role stages in parallel.</li>
<li>Run&nbsp;test role stages in parallel.<br>
<ol>
<li>Lint role.</li>
<li>Check dependency on other roles.</li>
<li>Check syntax.</li>
<li>Create docker instance</li>
<li>Run molecule/default/playbook.yml.</li>
<li>Check&nbsp;idempotency.</li>
</ol></li>
<li>Run integration tests</li>
<li>Finish</li>
</ol><br>
<h3 id="den--271-bus-factor"> № 271: Bus Factor</h3><br>
<p><img src="https://habrastorage.org/webt/cj/tb/wg/cjtbwgo4xb1j7umm75vvpjph8wk.png"></p><br>
<p>        - .      e.           code review          .   ,      ,  , ..          .</p><br>
<p><img src="https://habrastorage.org/webt/mr/9n/f3/mr9nf3at9k4h1ishpfypwehqlqo.png"></p><br>
<p>    .   ,       ,  .   jenkins + bitbucket + jira.</p><br>
<p>     , -,      ,     :</p><br>
<pre><code class="plaintext hljs">- get_url:<font></font>
    url: "{{ actk_certs }}/{{ item.1 }}"<font></font>
    dest: "{{ actk_src_tmp }}/"<font></font>
    username: "{{ actk_mvn_user }}"<font></font>
    password: "{{ actk_mvn_pass }}"<font></font>
  with_subelements:<font></font>
    - "{{ actk_cert_list }}"<font></font>
    - "{{ actk_certs }}"<font></font>
  delegate_to: localhost<font></font>
<font></font>
- copy:<font></font>
    src: "{{ actk_src_tmp }}/{{ item.1 }}"<font></font>
    dest: "{{ actk_dst_tmp }}"<font></font>
  with_subelements:<font></font>
    - "{{ actk_cert_list }}"<font></font>
    - "{{ actk_certs }}"</code></pre><br>
<p>  ,   .</p><br>
<pre><code class="plaintext hljs">get_url:<font></font>
    url: "{{ actk_certs }}/{{ actk_item }}"<font></font>
    dest: "{{ actk_src_tmp }}/{{ actk_item }}"<font></font>
    username: "{{ actk_mvn_user }}"<font></font>
    password: "{{ actk_mvn_pass }}"<font></font>
  loop_control:<font></font>
    loop_var: actk_item<font></font>
  with_items: "{{ actk_cert_list }}"<font></font>
  delegate_to: localhost<font></font>
<font></font>
- copy:<font></font>
    src: "{{ actk_src_tmp }}/{{ actk_item }}"<font></font>
    dest: "{{ actk_dst_tmp }}"<font></font>
  loop_control:<font></font>
    loop_var: actk_item<font></font>
  with_items: "{{ actk_cert_list }}"</code></pre><br>
<h3 id="den--311-uskoryaem-testy"> № 311:  </h3><br>
<p><img src="https://habrastorage.org/webt/an/sq/6h/ansq6hsvm8jzb23p9fb6aowij1y.png"></p><br>
<p>    ,        .         "   ,   ".              docker,   .    testinfra  ansible verifier    -  .</p><br>
<p><img src="https://habrastorage.org/webt/hl/y5/ix/hly5ixtdz684mku874jgc2hb8su.png"></p><br>
<p>     :</p><br>
<ol>
<li>  docker.</li>
<li>  ,     .</li>
<li> - .</li>
<li>  .</li>
<li>  <strong></strong>   .</li>
</ol><br>
<p><img src="https://habrastorage.org/webt/0t/re/rf/0trerfuwmb5rigsb7ueykjyrbvg.png"></p><br>
<p>  Pipeline  jenkins  </p><br>
<ol>
<li>Generate build stages.</li>
<li>Lint all in parallel.</li>
<li>Run&nbsp;test role stages in parallel.</li>
<li>Finish.</li>
</ol><br>
<h2 id="lessons-learned">Lessons learned</h2><br>
<h3 id="avoid-global-variables">Avoid global variables</h3><br>
<p>Ansible   ,   workaround   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">private_role_vars</a>,    . </p><br>
<p> .     <code>role_a</code>  <code>role_b</code></p><br>
<pre><code class="plaintext hljs"># cat role_a/defaults/main.yml<font></font>
---<font></font>
msg: a<font></font>
<font></font>
# cat role_a/tasks/main.yml<font></font>
---<font></font>
- debug:<font></font>
    msg: role_a={{ msg }}</code></pre><br>
<pre><code class="plaintext hljs"># cat role_b/defaults/main.yml<font></font>
---<font></font>
msg: b<font></font>
<font></font>
# cat role_b/tasks/main.yml<font></font>
---<font></font>
- set_fact:<font></font>
    msg: b<font></font>
- debug:<font></font>
    msg: role_b={{ msg }}</code></pre><br>
<pre><code class="plaintext hljs">- hosts: localhost<font></font>
  vars:<font></font>
    msg: hello<font></font>
  roles:<font></font>
    - role: role_a<font></font>
    - role: role_b<font></font>
  tasks:<font></font>
    - debug:<font></font>
        msg: play={{msg}}</code></pre><br>
<p><img src="https://habrastorage.org/webt/yo/6j/mn/yo6jmnxymfxjseigrda7hcjkysk.png"></p><br>
<p> ,           ,    .      Ansible     ,   - ,          .</p><br>
<p><strong>BAD</strong>:   .</p><br>
<pre><code class="plaintext hljs"># cat roles/some_role/tasks/main.yml<font></font>
---<font></font>
debug:<font></font>
  var: java_home</code></pre><br>
<p><strong>GOOD</strong>:  <code>defaults</code>        .</p><br>
<pre><code class="plaintext hljs"># cat roles/some_role/defaults/main.yml<font></font>
---<font></font>
r__java_home:<font></font>
 "{{ java_home | default('/path') }}"<font></font>
<font></font>
# cat roles/some_role/tasks/main.yml<font></font>
---<font></font>
debug:<font></font>
  var: r__java_home<font></font>
</code></pre><br>
<h3 id="prefix-role-variables">Prefix role variables</h3><br>
<p><strong>BAD</strong>:   .</p><br>
<pre><code class="plaintext hljs"># cat roles/some_role/defaults/main.yml<font></font>
---<font></font>
db_port: 5432</code></pre><br>
<p><strong>GOOD</strong>:          ,    inventory     .</p><br>
<pre><code class="plaintext hljs"># cat roles/some_role/defaults/main.yml<font></font>
---<font></font>
some_role__db_port: 5432</code></pre><br>
<h3 id="use-loop-control-variable">Use loop control variable</h3><br>
<p><strong>BAD</strong>:      <code>item</code>,   /  -        </p><br>
<pre><code class="plaintext hljs">---<font></font>
- hosts: localhost<font></font>
  tasks:<font></font>
    - debug:<font></font>
        msg: "{{ item }}"<font></font>
      loop:<font></font>
        - item1<font></font>
        - item2<font></font>
</code></pre><br>
<p><strong>GOOD</strong>:      <code>loop_var</code>.</p><br>
<pre><code class="plaintext hljs">---<font></font>
- hosts: localhost<font></font>
  tasks:<font></font>
    - debug:<font></font>
        msg: "{{ item_name }}"<font></font>
      loop:<font></font>
        - item1<font></font>
        - item2<font></font>
      loop_control:<font></font>
        loop_var: item_name<font></font>
</code></pre><br>
<h3 id="check-input-variables">Check input variables</h3><br>
<p>    ,           , ,     </p><br>
<p><strong>GOOD</strong>:  .</p><br>
<pre><code class="plaintext hljs">- name: "Verify that required string variables are defined"<font></font>
  assert:<font></font>
    that: ahs_var is defined and ahs_var | length &gt; 0 and ahs_var != None<font></font>
    fail_msg: "{{ ahs_var }} needs to be set for the role to work "<font></font>
    success_msg: "Required variables {{ ahs_var }} is defined"<font></font>
  loop_control:<font></font>
    loop_var: ahs_var<font></font>
  with_items:<font></font>
    - ahs_item1<font></font>
    - ahs_item2<font></font>
    - ahs_item3</code></pre><br>
<h3 id="avoid-hashes-dictionaries-use-flat-structure">Avoid hashes dictionaries, use flat structure</h3><br>
<p>   hash/dictionary    ,         ,      hash/dictionary,    .</p><br>
<p><strong>BAD</strong>:  hash/dictionary.</p><br>
<pre><code class="plaintext hljs">---<font></font>
user:<font></font>
  name: admin<font></font>
  group: admin</code></pre><br>
<p><strong>GOOD</strong>:    .</p><br>
<pre><code class="plaintext hljs">---<font></font>
user_name: admin<font></font>
user_group: "{{ user_name }}"</code></pre><br>
<h3 id="create-idempotent-playbooks--roles">Create idempotent playbooks &amp; roles</h3><br>
<p>     , ..  configuration drift    -.     molecule,     .</p><br>
<h3 id="avoid-using-command-shell-modules">Avoid using command shell modules</h3><br>
<p> shell      ,  ,    Ansible.</p><br>
<h3 id="test-your-roles-via-molecule">Test your roles via molecule</h3><br>
<p>Molecule    ,    .</p><br>
<h4 id="molecule-multiple-instances">Molecule Multiple instances</h4><br>
<p> <code>molecule.yml</code>   <code>platforms</code>      .</p><br>
<pre><code class="plaintext hljs">---<font></font>
    driver:<font></font>
      name: docker<font></font>
    platforms:<font></font>
      - name: postgresql-instance<font></font>
        hostname: postgresql-instance<font></font>
        image: registry.example.com/postgres10:latest<font></font>
        pre_build_image: true<font></font>
        override_command: false<font></font>
        network_mode: host<font></font>
      - name: app-instance<font></font>
        hostname: app-instance<font></font>
        pre_build_image: true<font></font>
        image: registry.example.com/docker_centos_ansible_tests<font></font>
        network_mode: host</code></pre><br>
<p>  ,    <code>converge.yml</code> :</p><br>
<pre><code class="plaintext hljs">---<font></font>
- name: Converge all<font></font>
  hosts: all<font></font>
  vars:<font></font>
    ansible_user: root<font></font>
  roles:<font></font>
    - role: some_role<font></font>
<font></font>
- name: Converge db<font></font>
  hosts: db-instance<font></font>
  roles:<font></font>
    - role: some_db_role<font></font>
<font></font>
- name: Converge app<font></font>
  hosts: app-instance<font></font>
  roles:<font></font>
    - role: some_app_role</code></pre><br>
<h4 id="ansible-verifier">Ansible verifier</h4><br>
<p> molecule    ansible   ,     ,       3 .      testinfra/inspec,   ,      :</p><br>
<pre><code class="plaintext hljs">---<font></font>
- name: Verify<font></font>
  hosts: all<font></font>
  tasks:<font></font>
    - name: copy config<font></font>
      copy:<font></font>
        src: expected_standalone.conf<font></font>
        dest: /root/wildfly/bin/standalone.conf<font></font>
        mode: "0644"<font></font>
        owner: root<font></font>
        group: root<font></font>
      register: config_copy_result<font></font>
<font></font>
    - name: Certify that standalone.conf changed<font></font>
      assert:<font></font>
        that: not config_copy_result.changed</code></pre><br>
<p>  ,      smoke test:</p><br>
<pre><code class="plaintext hljs">---<font></font>
  - name: Verify<font></font>
    hosts: solr<font></font>
    tasks:<font></font>
      - command: /blah/solr/bin/solr start -s /solr_home -p 8983 -force<font></font>
      - uri:<font></font>
          url: http://127.0.0.1:8983/solr<font></font>
          method: GET<font></font>
          status_code: 200<font></font>
        register: uri_result<font></font>
        until: uri_result is not failed<font></font>
        retries: 12<font></font>
        delay: 10<font></font>
      - name: Post documents to solr<font></font>
        command: /blah/solr/bin/post -c master /exampledocs/books.csv</code></pre><br>
<h3 id="put-complex-logic-into-modules--plugins">Put complex logic into modules &amp; plugins</h3><br>
<p>Ansible   ,      ,  , shell ,     .           ,   ,        .</p><br>
<h3 id="summarize-tips--tricks">Summarize Tips &amp; Tricks</h3><br>
<ol>
<li>Avoid global variables.</li>
<li>Prefix role variables.</li>
<li>Use loop control variable.</li>
<li>Check input variables.</li>
<li>Avoid hashes dictionaries, use flat structure.</li>
<li>Create idempotent playbooks &amp; roles.</li>
<li>Avoid using command shell modules.</li>
<li>Test your roles via molecule.</li>
<li>Put complex logic into modules &amp; plugins.</li>
</ol><br>
<h2 id="zaklyuchenie"></h2><br>
<p><img src="https://habrastorage.org/webt/ih/ty/rh/ihtyrh6qo2oufdjxheiflkp1erg.png"></p><br>
<p>        ,     IaC.     ,   .</p><br>
<h2 id="links">Links</h2><br>
<ul>
<li>Slides <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">How to test Ansible and don't go nuts</a></li>
<li>Video <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">How to test Ansible and don't go nuts</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  ,  200 000   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ansible:   120 VM c Coreos  Centos  18 </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">        </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       YML    ansible?</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">A list of awesome IaC testing articles, speeches &amp; links</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">English version</a></li>
</ul><br>
<p><strong>UPD1 2020.05.01 20:30</strong> —       <code>callback_whitelist = profile_tasks</code>       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  ansible</a>.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">mitogen</a><br>
<strong>UPD2 2020.05.03 16:34</strong> — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">English version</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN500044/index.html">如何在symfony 5 bundle中重用代码？第6部分。测试</a></li>
<li><a href="../zh-CN500046/index.html">JetBrains骑士-现在用于虚幻引擎</a></li>
<li><a href="../zh-CN500048/index.html">关于您想要的统计测试系统</a></li>
<li><a href="../zh-CN500052/index.html">在德国担任产品经理等职位。第1/5部分。为什么选择德国 求职签证</a></li>
<li><a href="../zh-CN500054/index.html">另一辆自行车：一个用于处理HTTP请求的简单库</a></li>
<li><a href="../zh-CN500060/index.html">科技公司如何帮助医生抗击流行病</a></li>
<li><a href="../zh-CN500064/index.html">如何交朋友Electron和Webix</a></li>
<li><a href="../zh-CN500066/index.html">为什么在引入Wi-Fi 6时使用人工智能？</a></li>
<li><a href="../zh-CN500072/index.html">现代前端架构</a></li>
<li><a href="../zh-CN500074/index.html">您决定加入开源产品的开发。准备什么？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>