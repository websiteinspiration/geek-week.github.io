<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèº üôéüèæ üò§ Einmal bei einem Pentest oder wie man mit Hilfe eines Urologen und Roskomnadzors alles kaputt macht ü§æüèΩ ‚öΩÔ∏è ‚úçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel basiert auf einem sehr erfolgreichen Pentest, der vor einigen Jahren von Group-IB-Spezialisten durchgef√ºhrt wurde: Eine Geschichte, die...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Einmal bei einem Pentest oder wie man mit Hilfe eines Urologen und Roskomnadzors alles kaputt macht</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel basiert auf einem sehr erfolgreichen Pentest, der vor einigen Jahren von Group-IB-Spezialisten durchgef√ºhrt wurde: Eine Geschichte, die behauptet, eine Verfilmung in Bollywood zu sein. Nun wird wahrscheinlich die Reaktion des Lesers folgen: "Oh, ein weiterer PR-Artikel, wieder sind diese gezeichnet, wie gut sie sind, vergessen Sie nicht, einen Pentest zu kaufen." Einerseits ist es das. Es gibt jedoch eine Reihe von Gr√ºnden, warum dieser Artikel ver√∂ffentlicht wurde. Ich wollte zeigen, was genau Pentester tun, wie interessant und nicht trivial diese Arbeit sein kann, welche am√ºsanten Umst√§nde sich bei Projekten entwickeln k√∂nnen und vor allem Live-Material mit realen Beispielen zeigen.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Gleichgewicht der Bescheidenheit in der Welt wiederherzustellen, werden wir nach einer Weile √ºber das Pentest schreiben, das nicht gegangen ist. </font><font style="vertical-align: inherit;">Wir zeigen, wie gut etablierte Prozesse in einem Unternehmen vor einer ganzen Reihe von Angriffen sch√ºtzen k√∂nnen, auch vor gut vorbereiteten, einfach weil diese Prozesse existieren und wirklich funktionieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch dem Kunden aus diesem Artikel war im Allgemeinen alles in Ordnung, zumindest besser als 95% des Marktes in der Russischen F√∂deration, nach unseren Gef√ºhlen, aber es gab eine Reihe kleinerer Nuancen, die eine lange Kette von Ereignissen bildeten, die zun√§chst zu einem langen Bericht √ºber die Arbeit f√ºhrten und dann zu diesem Artikel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, tanken Sie Popcorn und hei√üen Sie den Detektiv willkommen. </font><font style="vertical-align: inherit;">Ich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erteile Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dem technischen Direktor der Audit and Consulting Group-IB </font><b><font style="vertical-align: inherit;">, das Wort</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 1. Pochkin Arzt </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018 Jahr. Es gibt einen Kunden - ein High-Tech-IT-Unternehmen, das selbst viele Kunden bedient. Er m√∂chte eine Antwort auf die Frage erhalten: Ist es m√∂glich, ohne anf√§ngliche Kenntnisse und Zugriff √ºber das Internet Administratorrechte f√ºr eine Active Directory-Dom√§ne zu erlangen? Kein Social Engineering ist von Interesse ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eh, aber vergebens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), sie werden die Arbeit nicht speziell st√∂ren, aber sie k√∂nnen beispielsweise versehentlich einen fremden Arbeitsserver neu laden. Eine zus√§tzliche Aufgabe besteht darin, so viele andere Angriffsvektoren wie m√∂glich in Bezug auf den Au√üenumfang zu identifizieren. Das Unternehmen f√ºhrt regelm√§√üig solche Tests durch und jetzt die Frist f√ºr einen neuen Test. Die Bedingungen sind fast typisch, angemessen, verst√§ndlich. Runter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt einen Kundennamen - sei es "Unternehmen" mit der Hauptseite </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nat√ºrlich wird der Kunde anders angerufen, aber in diesem Artikel wird alles entpers√∂nlicht. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich f√ºhre Netzwerkinformationen durch - Ich finde heraus, welche Adressen und Dom√§nen vom Kunden aufgelistet werden, zeichne ein Netzwerkdiagramm und wie Dienste an diese Adressen verteilt werden. Ich bekomme das Ergebnis: mehr als 4000 Live-IP-Adressen. Ich schaue mir die Dom√§nen in diesen Netzwerken an: Gl√ºcklicherweise handelt es sich bei der √ºberwiegenden Mehrheit um Netzwerke, die f√ºr Kundenkunden bestimmt sind, und sie interessieren uns formal nicht. Der Kunde glaubt das auch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt ein Netzwerk mit 256 Adressen √ºbrig, f√ºr das zu diesem Zeitpunkt bereits ein Verst√§ndnis f√ºr die Verteilung von Dom√§nen und Subdom√§nen nach IP-Adressen besteht. Es gibt Informationen zu den gescannten Ports, sodass Sie die Dienste mit Ihren Augen nach interessanten durchsuchen k√∂nnen. Parallel dazu werden alle Arten von Scannern unter zug√§nglichen IP-Adressen und separat auf Websites gestartet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viele Dienstleistungen. Dies ist normalerweise eine Freude f√ºr den Pentester und die Erwartung eines schnellen Sieges, denn je mehr Dienste, desto gr√∂√üer das Angriffsfeld und desto einfacher ist es, ein Artefakt zu finden. Ein kurzer Blick auf die Websites zeigte, dass die meisten von ihnen Webschnittstellen der bekannten Produkte gro√üer Unternehmen der Welt sind, die sagen, dass sie mit Ihnen nicht zufrieden sind. Sie fragen nach einem Benutzernamen und einem Kennwort. Ab dem Schwellenwert, an dem sie ein Feld f√ºr die Eingabe des zweiten Faktors sch√ºtteln, fragen sie nach einem TLS-Client-Zertifikat oder senden sie an Microsoft ADFS. Einige sind im Internet einfach nicht verf√ºgbar. F√ºr einige m√ºssen Sie offensichtlich einen speziell bezahlten Kunden f√ºr drei Geh√§lter haben oder die genaue URL kennen, die Sie eingeben m√ºssen. Wir werden eine weitere Woche nach und nach entmutigen, wenn wir versuchen, die Software nach bekannten Sicherheitsl√ºcken zu "durchbrechen", nach versteckten Inhalten in Webpfaden zu suchen und Konten von Drittanbieterdiensten wie LinkedIn zu verlieren.Versuche, Passw√∂rter f√ºr sie auszuw√§hlen und Schwachstellen in selbst beschriebenen Websites aufzudecken - laut Statistik ist dies √ºbrigens der vielversprechendste Vektor eines externen Angriffs bis heute. Sofort bemerke ich die Kinokanone, die anschlie√üend abgefeuert wurde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab also zwei Standorte, die sich von Hunderten von Diensten abheben. Diese Sites hatten eines gemeinsam: Wenn Sie keine sorgf√§ltige Netzwerkaufkl√§rung nach Dom√§nen durchf√ºhren, sondern ‚Äûauf der Vorderseite‚Äú nach offenen Ports suchen oder den Schwachstellenscanner √ºber einen bekannten IP-Bereich vergiften, werden diese Sites nicht mehr √ºberpr√ºft, sondern ohne Kenntnis des DNS-Namens einfach nicht sichtbar. Vielleicht wurden sie zumindest fr√ºher √ºbersehen, und unsere automatischen Tools fanden keine Probleme darin, selbst wenn sie direkt auf die Ressource eingestellt waren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úbrigens √ºber die Tatsache, dass zuvor eingef√ºhrte Scanner in der Regel gefunden wurden. Ich m√∂chte Sie daran erinnern: F√ºr manche Menschen ist ‚ÄûPentest‚Äú gleichbedeutend mit ‚Äûautomatisiertem Scannen‚Äú. Und die Scanner dieses Projekts sagten nichts. Nun, mittlere Sicherheitsl√ºcken zeigten das Maximum (3 von 5 in Bezug auf die Gefahr): Einige Dienste haben ein schlechtes TLS-Zertifikat oder veraltete Verschl√ºsselungsalgorithmen, und die meisten Websites verf√ºgen √ºber Clickjacking. Aber damit kommen Sie nicht zum Ziel. Wahrscheinlich w√§ren Scanner hier n√ºtzlicher, aber ich m√∂chte Sie daran erinnern: Der Kunde selbst kann solche Programme kaufen und sich mit ihnen testen, und nach den langweiligen Ergebnissen zu urteilen, hat er sie bereits √ºberpr√ºft.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur√ºck zu den "abnormalen" Stellen. Das erste ist so etwas wie ein lokales Wiki an einer nicht standardm√§√üigen Adresse, aber lassen Sie wiki.company [.] Ru in diesem Artikel sein. Sie forderte auch sofort einen Benutzernamen und ein Passwort an, jedoch bereits √ºber NTLM im Browser. F√ºr den Benutzer sieht dies wie ein asketisches Fenster aus, in dem Sie nach einem Benutzernamen und einem Kennwort gefragt werden. Und das ist schlechte Praxis.</font></font><br>
<br>
<blockquote> . NTLM  -      .   ‚Äî    Active Directory.       company.ru,   ¬´¬ª DNS-.  ,    - ,        ,    - .  ‚Äî        NTLM (, ?),     ¬´¬ª ,         .    ,      .         ‚Äî  ,    .  ‚Äî       .         ‚Äî , ,  .  ‚Äî   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine schlechte Funktion von Microsoft-Produkten: Selbst wenn Sie ein solches NTLM nicht speziell ver√∂ffentlicht haben, wird es zumindest in der Standardinstallation in OWA und Lync installiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úbrigens hat der Autor dieses Artikels einmal auf die gleiche Weise versehentlich in nur einer Stunde ungef√§hr 1000 Konten von Mitarbeitern einer gro√üen Bank gesperrt und hatte dann ein etwas blasses Aussehen. </font><font style="vertical-align: inherit;">Die IT-Services der Bank waren ebenfalls blass, aber alles endete gut und angemessen. Wir wurden sogar gelobt, dass wir die ersten waren, die dieses Problem fanden, und provozierten eine schnelle und entscheidende Korrektur.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die zweite Site hatte die Adresse "offensichtlich ein Nachname.company.ru". </font><font style="vertical-align: inherit;">Gefunden √ºber Google, so etwas auf Seite 10. </font><font style="vertical-align: inherit;">Das Design beginnt bis Mitte 2000, und eine angesehene Person sah von der Hauptseite aus wie folgt aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann nahm er einen Rahmen aus "Hundeherz", aber glauben Sie mir, es war im entferntesten √§hnlich, sogar das Farbschema in √§hnlichen Farben. Lassen Sie die Site </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hei√üen </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war eine pers√∂nliche Seite ... eines Urologen. Es wurde interessant, was der Standort des Urologen auf der Subdomain eines High-Tech-Unternehmens tut. Ein kurzer Blick auf Google zeigte, dass dieser Arzt Mitbegr√ºnder einer der juristischen Personen unseres Kunden war und sogar etwa 1000 Rubel eingetragenes Kapital beisteuerte. Die Site wurde wahrscheinlich vor vielen Jahren erstellt und die Serverressourcen des Kunden wurden als Hosting verwendet. Die Seite hat lange an Relevanz verloren, aber aus irgendeinem Grund funktioniert sie schon lange nicht mehr.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Bezug auf Schwachstellen war die Website selbst sicher. Mit Blick auf die Zukunft werde ich sagen, dass es sich um eine Reihe von statischen Daten handelte - einfache HTML-Seiten mit Beilagen von Abbildungen in Form von Nieren und Blasen. Das "Brechen" einer solchen Site ist nutzlos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber der Webserver darunter war interessanter. Dem HTTP-Server-Header nach zu urteilen, gab es IIS 6.0, was bedeutet, dass Windows 2003 als Betriebssystem verwendet wurde. Der Scanner hat zuvor festgestellt, dass diese bestimmte Website des Urologen im Gegensatz zu anderen virtuellen Hosts auf demselben Webserver auf den Befehl PROPFIND reagiert hat, dh, WebDAV hat dort gearbeitet. √úbrigens hat der Scanner diese Informationen mit der Markierung Info versehen (in der Sprache der Scannerberichte ist dies die geringste Gefahr) - solche Dinge werden normalerweise einfach √ºbersprungen. In Kombination ergab dies einen interessanten Effekt, der erst nach einem erneuten Einstieg in Google aufgedeckt wurde: eine seltene Sicherheitsanf√§lligkeit in Bezug auf Puffer√ºberlauf, die mit einer Reihe von Shadow Brokers verbunden ist, n√§mlich CVE-2017-7269, die bereits einen Exploit hatten. Mit anderen Worten, es wird eine Katastrophe sein, wenn Sie Windows 2003 haben und WebDAV unter IIS ausgef√ºhrt wird.Obwohl 2018 in der Produktion von Windows 2003 gearbeitet wird, ist dies an sich schon eine Katastrophe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Exploit endete in Metasploit und wurde sofort mit einer Last getestet, die eine DNS-Abfrage an einen kontrollierten Dienst sendete. Burp Collaborator wird traditionell zum Abfangen von DNS-Abfragen verwendet. √úberraschenderweise hat es beim ersten Mal funktioniert: In DNS wurde ein Ruck empfangen. Dann wurde versucht, eine Back-End-Verbindung √ºber Port 80 herzustellen (dh eine Netzwerkverbindung vom Server zum Angreifer mit Zugriff auf cmd.exe auf dem Host des Opfers), aber dann kam es zu einem Fiasko. Die Verbindung wurde nicht hergestellt, und nach dem dritten Operationsversuch verschwand die Site zusammen mit allen unterhaltsamen Bildern endg√ºltig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalerweise folgt ein Brief im Stil von "Kunde, wach auf, wir haben alles fallen lassen". Uns wurde jedoch mitgeteilt, dass die Site nichts mit Gesch√§ftsprozessen zu tun hat und dort im Allgemeinen funktioniert. Es ist nicht klar, warum, wie der gesamte Server, und dass wir diese Ressource nach Belieben verwenden k√∂nnen.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach ungef√§hr einem Tag begann die Site pl√∂tzlich von selbst zu arbeiten. Nachdem ich einen Stand von WebDAV auf IIS 6.0 erstellt hatte, stellte ich fest, dass die Standardeinstellung darin besteht, IIS-Workflows alle 30 Stunden neu zu starten. Das hei√üt, wenn das Steuerelement aus dem Shell-Code beendet wurde, wurde der IIS-Workflow beendet, dann selbst ein paar Mal neu gestartet und dann 30 Stunden lang angehalten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da das erste Mal die bekconnect auf tcp fehlgeschlagen ist, habe ich dieses Problem an einen geschlossenen Port abgeschrieben. </font><font style="vertical-align: inherit;">Das hei√üt, er schlug das Vorhandensein einer Firewall vor, die ausgehende Verbindungen nicht herauslie√ü. </font><font style="vertical-align: inherit;">Ich fing an, Shell-Codes auszuf√ºhren, die viele TCP- und UDP-Ports sortieren. Es gab keine Auswirkungen. </font><font style="vertical-align: inherit;">Das Laden der umgekehrten Verbindung √ºber http (s) von Metasploit - meterpreter / reverse_http (s) funktionierte nicht. </font><font style="vertical-align: inherit;">Pl√∂tzlich wurde die Verbindung zu demselben Port 80 hergestellt, aber sofort unterbrochen. </font><font style="vertical-align: inherit;">Er schrieb es an die Aktion des immer noch imagin√§ren IPS ab, das keinen Meterpreter-Verkehr mochte. </font><font style="vertical-align: inherit;">Angesichts der Tatsache, dass die Verbindung von reinem TCP zu Port 80 fehlschlug, http jedoch, kam ich zu dem Schluss, dass der http-Proxy irgendwie im System konfiguriert war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchte sogar Meterpreter √ºber DNS (danke</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºr seine Bem√ºhungen rettete er viele Projekte) und erinnerte sich an den allerersten Erfolg, aber er arbeitete nicht einmal am Stand - der Shell-Code war zu umfangreich f√ºr diese Sicherheitsanf√§lligkeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Wirklichkeit sah es so aus: 3-4 Versuche, innerhalb von 5 Minuten anzugreifen, dann 30 Stunden warten. Und so drei Wochen hintereinander. Ich habe sogar eine Erinnerung eingerichtet, um keine Zeit zu verschwenden. Dar√ºber hinaus gab es einen Unterschied im Verhalten der Test- und Kampfumgebungen: F√ºr diese Sicherheitsanf√§lligkeit gab es zwei √§hnliche Exploits, einen von Metasploit und einen vom Internet, der aus der Version von Shadow Brokers √ºberarbeitet wurde. Im Kampf hat also nur Metasploit am Stand geklappt - nur der zweite, was das Debuggen weiter erschwerte und das Gehirn brach.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende erwies sich der Shell-Code als effektiv, der eine exe-Datei von einem bestimmten Server √ºber http herunterlud und auf dem Zielsystem ausf√ºhrte. Der Shellcode war klein genug, um hinein zu passen, und zumindest funktionierte er. Da der TCP-Server √ºberhaupt keinen Datenverkehr mochte und http (s) auf Meterpreter √ºberpr√ºft wurden, entschied ich, dass der schnellste Weg darin besteht, die exe-Datei, die den DNS-Meterpreter enthielt, √ºber diesen Shellcode herunterzuladen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier trat das Problem auf: Beim Herunterladen der exe-Datei wurde, wie die Versuche zeigten, der Download unterbrochen, egal was passierte. </font><font style="vertical-align: inherit;">Wiederum mochte eine Art Schutzger√§t zwischen meinem Server und dem Urologen den http-Verkehr mit exe im Inneren nicht. </font><font style="vertical-align: inherit;">Es schien eine ‚Äûschnelle‚Äú L√∂sung zu sein, den Shellcode so zu √§ndern, dass der http-Verkehr im laufenden Betrieb verschleiert wurde und abstrakte Bin√§rdaten anstelle von exe √ºbertragen wurden. </font><font style="vertical-align: inherit;">Schlie√ülich war der Angriff erfolgreich, die Kontrolle kam √ºber den d√ºnnen DNS-Kanal:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde sofort klar, dass ich die einfachsten Rechte am IIS-Workflow hatte, mit denen ich nichts tun konnte. </font><font style="vertical-align: inherit;">So sah es auf der Metasploit-Konsole aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Pentest-Methoden empfehlen dringend, dass Sie die Rechte erh√∂hen m√ºssen, wenn Sie Zugriff erhalten. Normalerweise mache ich das nicht lokal, da der allererste Zugriff einfach als Netzwerkeintrittspunkt betrachtet wird und das Kompromittieren eines anderen Computers im selben Netzwerk normalerweise einfacher und schneller ist als das Erh√∂hen der Berechtigungen auf einem vorhandenen Host. Dies ist jedoch nicht der Fall, da der DNS-Kanal sehr eng ist und kein Roaming des Datenverkehrs zul√§sst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter der Annahme, dass dieser Server mit Windows 2003 nicht von der bekannten Sicherheitsanf√§lligkeit MS17-010 repariert wurde, tunnele ich den Datenverkehr √ºber den Meterpreter-DNS-Tunnel zum lokalen Host an Port 445 / TCP (ja, dies ist auch m√∂glich) und versuche, eine zuvor heruntergeladene Exe √ºber die Sicherheitsanf√§lligkeit auszuf√ºhren. Der Angriff funktioniert, ich bekomme eine zweite Verbindung, aber mit SYSTEM-Berechtigungen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interessanterweise versuchte der Server immer noch, sich vor MS17-010 zu sch√ºtzen - er hatte anf√§llige Netzwerkdienste auf der externen Schnittstelle deaktiviert. </font><font style="vertical-align: inherit;">Dies sch√ºtzt wirklich vor Angriffen √ºber das Netzwerk, aber der Angriff innerhalb des lokalen Hosts hat funktioniert, da Sie SMB auf localhost nicht einfach ausschalten und schnell deaktivieren k√∂nnen.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als n√§chstes werden neue interessante Details enth√ºllt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit SYSTEM-Berechtigungen k√∂nnen Sie Back-Connect problemlos √ºber TCP installieren. </font><font style="vertical-align: inherit;">Offensichtlich ist das Verbot von direktem TCP ausschlie√ülich ein IIS-beschr√§nktes Benutzerproblem. </font><font style="vertical-align: inherit;">Spoiler: Der IIS-Benutzerverkehr wurde in beide Richtungen irgendwie in den lokalen ISA-Proxy eingeschlossen. </font><font style="vertical-align: inherit;">Wie genau das funktioniert, wird nicht reproduziert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich bin in einer bestimmten "DMZ" (und dies ist keine Active Directory-Dom√§ne, sondern WORKGROUP) - das klingt logisch. </font><font style="vertical-align: inherit;">Aber anstelle der erwarteten privaten ("grauen") IP-Adresse bin ich ziemlich "wei√ü", genau so, wie ich es zuvor angegriffen habe. </font><font style="vertical-align: inherit;">Dies bedeutet, dass das Unternehmen f√ºr die Welt der IPv4-Adressierung so alt ist, dass es sich leisten kann, die DMZ-Zone gem√§√ü dem Schema auf 128 ‚Äûwei√üen‚Äú Adressen ohne NAT zu halten, wie in den Cisco-Handb√ºchern von 2005 dargestellt.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da der Server alt ist, funktioniert Mimikatz garantiert direkt aus dem Speicher:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich erhalte das Passwort des lokalen Administrators, tunnele RDP-Verkehr √ºber TCP und gehe auf einen gem√ºtlichen Desktop. </font><font style="vertical-align: inherit;">Da Sie mit dem Server alles tun k√∂nnen, l√∂sche ich das Antivirenprogramm. Ich stelle fest, dass der Server nur √ºber die TCP-Ports 80 und 443 √ºber das Internet erreichbar ist und 443 nicht ausgelastet war. </font><font style="vertical-align: inherit;">Ich erh√∂he den OpenVPN-Server auf 443, f√ºge die NAT-Funktionen f√ºr meinen VPN-Verkehr hinzu und erhalte √ºber mein OpenVPN unbegrenzten direkten Zugriff auf das DMZ-Netzwerk. </font><font style="vertical-align: inherit;">Es ist bemerkenswert, dass ISA mit einigen nicht deaktivierbaren IPS-Funktionen meinen Datenverkehr durch Port-Scanning blockierte, f√ºr das es durch ein einfacheres und flexibleres RRAS ersetzt werden musste. </font><font style="vertical-align: inherit;">So m√ºssen Pentester manchmal noch alles verwalten.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein aufmerksamer Leser wird fragen: "Und was ist die zweite Seite - ein Wiki mit NTLM-Authentifizierung, √ºber das so viel geschrieben wurde?" </font><font style="vertical-align: inherit;">Dar√ºber weiter.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 2. Verschl√ºsseln Sie immer noch nicht? </font><font style="vertical-align: inherit;">Dann </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gehen wir</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schon hier </font><s><font style="vertical-align: inherit;">zu dir</font></s></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es besteht also Zugriff auf das DMZ-Netzwerksegment. </font><font style="vertical-align: inherit;">Sie m√ºssen zum Dom√§nenadministrator gehen. </font><font style="vertical-align: inherit;">Das erste, was mir in den Sinn kommt, ist die automatische √úberpr√ºfung der Dienste innerhalb des DMZ-Segments, zumal sie jetzt viel offener f√ºr Forschung sind. </font><font style="vertical-align: inherit;">Ein typisches Bild bei einem Penetrationstest: Der externe Perimeter ist besser gesch√ºtzt als interne Dienste, und wenn Sie Zugriff auf eine gro√üe Infrastruktur erhalten, ist es viel einfacher, erweiterte Rechte in einer Dom√§ne zu erhalten, nur weil diese Dom√§ne f√ºr Tools zug√§nglich ist, und zweitens. Es gibt immer ein paar kritische Probleme in der Infrastruktur f√ºr mehrere tausend Hosts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich lade Scanner in DMZ √ºber den OpenVPN-Tunnel, ich warte. Ich √∂ffne den Bericht - wieder nichts Ernstes, anscheinend ging jemand auf die gleiche Weise zu mir. Der n√§chste Schritt besteht darin, zu untersuchen, wie Hosts innerhalb des DMZ-Netzwerks kommunizieren. Zu diesem Zweck wird zun√§chst ein regul√§rer Wireshark gestartet, der Broadcast-Anfragen abh√∂rt, haupts√§chlich ARP. ARP-Pakete wurden den ganzen Tag gesammelt. Es stellt sich heraus, dass in diesem Segment mehrere Gateways verwendet werden. Dies wird sp√§ter n√ºtzlich sein. Beim Kleben von Daten auf ARP-Anforderungs-Antwort- und Port-Scan-Daten fand ich die Ausgabepunkte des Benutzerverkehrs aus dem lokalen Netzwerk zus√§tzlich zu den zuvor bekannten Diensten wie Web und E-Mail.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ich im Moment keinen Zugriff auf andere Systeme hatte und es kein einziges Konto f√ºr Unternehmensdienste gab, wurde beschlossen, mit ARP Spoofing mindestens ein Konto aus dem Datenverkehr abzurufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel wurde auf dem Server des Urologen gestartet. </font><font style="vertical-align: inherit;">Unter Ber√ºcksichtigung der identifizierten Verkehrsstr√∂me wurden die vielversprechendsten Paare f√ºr den Angriff ‚ÄûMann in der Mitte‚Äú ausgew√§hlt. Bei einem kurzfristigen Start von 5 bis 10 Minuten und einem Timer zum Neustart des Servers im Falle eines ‚ÄûEinfrierens‚Äú wurde ein Teil des Netzwerkverkehrs empfangen. </font><font style="vertical-align: inherit;">Wie im Witz gab es zwei Neuigkeiten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gut: Es wurden viele Anmeldeinformationen abgefangen und der Angriff insgesamt hat funktioniert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlecht: Alle Anmeldeinformationen stammten von Kunden des Kunden selbst. </font><font style="vertical-align: inherit;">Kundenspezialisten bieten Support-Services an und sind mit Kundenservices verbunden, f√ºr die nicht immer die Verkehrsverschl√ºsselung konfiguriert war.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen erhielt ich viele Anmeldeinformationen, die im Rahmen des Projekts nutzlos waren, aber auf jeden Fall als Demonstration der Gefahr eines Angriffs interessant waren. Grenzrouter gro√üer Unternehmen mit Telnet, weitergeleitete Debugging-HTTP-Ports an das interne CRM mit allen Daten, direkter Zugriff auf RDP von Windows XP im lokalen Netzwerk und anderer Obskurantismus. Es stellte sich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach MITRE-Matrix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eine Art </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Supply-Chain-Kompromiss heraus</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch eine lustige Gelegenheit gefunden, E-Mails aus dem Verkehr zu sammeln, so etwas. Dies ist ein Beispiel f√ºr einen fertigen Brief, der ohne Verschl√ºsselung von unserem Kunden an den SMTP-Port seines Kunden gesendet wurde. Ein bestimmter Andrei bittet seinen Namensvetter, die Dokumentation erneut zu senden. Sie befindet sich auf einer Cloud-Festplatte mit einem Benutzernamen, einem Kennwort und einem Link in einem Antwortschreiben:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine weitere Erinnerung daran, dass Sie alle Dienste verschl√ºsseln m√ºssen. Es ist nicht bekannt, wer und wann Ihre Daten speziell lesen und anwenden wird - ein Anbieter, ein Systemadministrator eines anderen Unternehmens oder ein solcher Pentester. Ich schweige, dass viele einfach unverschl√ºsselten Datenverkehr abfangen k√∂nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz des offensichtlichen Erfolgs wurde dies dem Ziel nicht n√§her gebracht. Es war nat√ºrlich m√∂glich, lange zu sitzen und wertvolle Informationen herauszuholen, aber nicht die Tatsache, dass sie dort erschienen w√§ren, und der Angriff selbst ist im Hinblick auf die Integrit√§t des Netzwerks sehr riskant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einem weiteren Eingraben in die Dienste kam mir eine interessante Idee in den Sinn. Es gibt ein solches Dienstprogramm namens Responder (es ist leicht, Beispiele f√ºr Anwendungen mit diesem Namen zu finden), das durch "Vergiften" von Broadcast-Anforderungen Verbindungen √ºber eine Vielzahl von Protokollen wie SMB, HTTP, LDAP usw. hervorruft. Auf unterschiedliche Weise wird dann jede Person, die eine Verbindung herstellt, aufgefordert, sich zu authentifizieren, und passt sich an, sodass die Authentifizierung √ºber NTLM und in einem f√ºr das Opfer transparenten Modus erfolgt. In den meisten F√§llen sammelt ein Angreifer daher NetNTLMv2-Handshakes und stellt laut W√∂rterbuch schnell Kennw√∂rter f√ºr Benutzerdom√§nen wieder her. Ich wollte hier etwas √Ñhnliches, aber Benutzer sa√üen ‚Äûhinter der Wand‚Äú, oder besser gesagt, sie waren durch eine Firewall getrennt, und im WEB gingen sie durch den Blue Coat-Proxy-Cluster.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, dass ich angegeben habe, dass der Active Directory-Dom√§nenname mit der "externen" Dom√§ne √ºbereinstimmt, dh company.ru? Windows, genauer gesagt Internet Explorer (und Edge und Chrome), erm√∂glicht es dem Benutzer, sich transparent in HTTP √ºber NTLM zu authentifizieren, wenn er der Ansicht ist, dass sich die Site in einer ‚ÄûIntranetzone‚Äú befindet. Eines der Anzeichen f√ºr ‚ÄûIntranet‚Äú ist der Aufruf einer ‚Äûgrauen‚Äú IP-Adresse oder eines kurzen DNS-Namens, dh ohne Punkte. Da ein Server mit einem ‚Äûwei√üen‚Äú IP- und DNS-Namen preobrazhensky.company.ru zur Verf√ºgung stand und Dom√§nencomputer normalerweise das Active Directory-Dom√§nensuffix √ºber DHCP zur vereinfachten Namenseingabe erhalten, mussten sie lediglich die </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">preobrazhensky-</font></a><font style="vertical-align: inherit;"> URL in die Adressleiste schreiben</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">damit sie den richtigen Weg zu einem kompromittierten Urologen-Server finden, nicht zu vergessen, dass er jetzt "Intranet" hei√üt. </font><font style="vertical-align: inherit;">Das hei√üt, gleichzeitig gibt er mir den NTLM-Handshake-Benutzer ohne sein Wissen. </font><font style="vertical-align: inherit;">Es bleibt abzuwarten, ob Client-Browser √ºber die dringende Notwendigkeit nachdenken, auf diesen Server zuzugreifen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das wunderbare Dienstprogramm Intercepter-NG kam zur Rettung (danke</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intercepter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Sie konnten den Datenverkehr unterwegs √§ndern und funktionierten perfekt unter Windows 2003. Es gab sogar eine separate Funktion, mit der nur JavaScript-Dateien im Datenverkehr ge√§ndert werden konnten. Es war eine Art massives Cross-Site-Scripting geplant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blue Coat-Proxys, √ºber die Benutzer auf das globale WEB zugegriffen haben, haben regelm√§√üig statische Inhalte zwischengespeichert. Durch das Abfangen des Datenverkehrs wurde deutlich, dass sie rund um die Uhr arbeiten und h√§ufig verwendete Statiken endlos anfordern, um die Anzeige von Inhalten w√§hrend der Sto√üzeiten zu beschleunigen. Dar√ºber hinaus verf√ºgte BlueCoat √ºber einen speziellen User-Agent, der sich deutlich von einem lebenden Benutzer unterschied. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde Javascript erstellt, das mit Hilfe von Intercepter-NG nachts eine ganze Stunde damit verbrachte, jede Antwort mit JS-Dateien f√ºr Blue Coat zu implementieren. Das Skript hat Folgendes ausgef√ºhrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der aktuelle Browser wurde vom User-Agent erkannt. </font><font style="vertical-align: inherit;">Wenn es Internet Explorer, Edge oder Chrome war, hat es funktioniert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warten, bis das DOM der Seite gebildet ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe ein unsichtbares Bild mit dem Attribut src vom Typ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky in das DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eingef√ºgt </font><font style="vertical-align: inherit;">: 8080 / NNNNNNN.png, wobei NNN beliebige Ziffern sind, damit BlueCoat nicht zwischenspeichert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legen Sie eine globale Flag-Variable fest, f√ºr die die Injektion vorgenommen wurde und f√ºr die Sie keine Bilder mehr einf√ºgen m√ºssen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Browser hat versucht, dieses Bild auf Port 8080 des gef√§hrdeten Servers zu laden. Er hat auf den TCP-Tunnel zu meinem Laptop gewartet, auf dem derselbe Responder gestartet wurde, f√ºr den eine NTLM-Anmeldung vom Browser erforderlich ist.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den Responder-Protokollen zu urteilen, kamen die Leute am Morgen zur Arbeit, schalteten ihre Arbeitsstationen ein und begannen dann, den Server des Urologen massenhaft und unsichtbar zu besuchen, ohne zu vergessen, NTLM-Handshakes zusammenzuf√ºhren. </font><font style="vertical-align: inherit;">Handshakes regneten den ganzen Tag und sammelten deutlich Material f√ºr einen notorisch erfolgreichen Passwortwiederherstellungsangriff. </font><font style="vertical-align: inherit;">So sahen die Responder-Protokolle aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Massive geheime Besuche von Benutzern auf dem Server des Urologen</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sie haben wahrscheinlich bereits bemerkt, dass diese ganze Geschichte auf dem Prinzip basiert: "Alles war in Ordnung, aber es gab einen Mist, dann gab es √úberwindung und dann kam alles zum Erfolg." </font><font style="vertical-align: inherit;">Es gab also einen Mist. </font><font style="vertical-align: inherit;">Von den f√ºnfhundert einzigartigen Handshakes wurde keiner enth√ºllt. </font><font style="vertical-align: inherit;">Und dies ber√ºcksichtigt die Tatsache, dass diese NTLMv2-Handshakes selbst auf einem Laptop mit einem toten Prozessor mit einer Geschwindigkeit von mehreren hundert Millionen Versuchen pro Sekunde √ºberwunden werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich musste mich mit Passwortmutationstechniken, einer Grafikkarte und einem dickeren W√∂rterbuch ausr√ºsten und warten. </font><font style="vertical-align: inherit;">Nach langer Zeit wurden mehrere Konten mit Passw√∂rtern der Form ‚ÄûQ11111111 ... .1111111q‚Äú er√∂ffnet, was darauf hindeutet, dass alle Benutzer einmal gezwungen waren, ein sehr langes Passwort mit einem anderen Zeichenfall zu erstellen, was kompliziert sein sollte. </font><font style="vertical-align: inherit;">Aber Sie k√∂nnen einen erfahrenen Benutzer nicht einfach scheitern lassen, und auf diese Weise hat er es einfacher gemacht, sich zu erinnern. </font><font style="vertical-align: inherit;">Insgesamt wurden etwa 5 St√ºcke ge√∂ffnet, von denen nur eines wertvolle Rechte an den Dienstleistungen hatte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 3. Roskomnadzor schl√§gt zur√ºck</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So wurden die ersten Domain-Accounts empfangen. </font><font style="vertical-align: inherit;">Wenn Sie zu diesem Zeitpunkt nach einer langen Lekt√ºre nicht eingeschlafen sind, werden Sie sich wahrscheinlich daran erinnern, dass ich einen Dienst erw√§hnt habe, f√ºr den kein zweiter Authentifizierungsfaktor erforderlich war: Dies ist ein Wiki mit NTLM-Authentifizierung. </font><font style="vertical-align: inherit;">Das erste, was sie taten, war nat√ºrlich einzutreten. </font><font style="vertical-align: inherit;">Das Eingraben in die interne Wissensbasis brachte schnell Ergebnisse:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Unternehmen verf√ºgt √ºber ein WiFi-Netzwerk mit Dom√§nenkontoauthentifizierung und Zugriff auf ein lokales Netzwerk. </font><font style="vertical-align: inherit;">Mit dem aktuellen Datensatz ist dies bereits ein funktionierender Angriffsvektor, aber Sie m√ºssen mit Ihren F√º√üen ins B√ºro gehen und sich irgendwo im B√ºro des Kunden platzieren.</font></font></li>
<li> ,    , ‚Ä¶    ¬´ ¬ª ,              .    ¬´¬ª  ¬´¬ª        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nat√ºrlich wurde der ‚Äûzweite Faktor‚Äú sofort als Anwendung auf meinem Telefon zum gef√§hrdeten Konto hinzugef√ºgt. Es gab ein Programm, das entweder lautstark eine Push-Anfrage mit den Tasten "Genehmigen" / "Ablehnen" an das Telefon senden oder den OTP-Code f√ºr weitere unabh√§ngige Eingaben still auf dem Bildschirm anzeigen konnte. Dar√ºber hinaus sollte die erste Methode die einzig richtige Anweisung sein, funktionierte jedoch im Gegensatz zur OTP-Methode nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem defekten "zweiten Faktor" konnte ich mich bei Outlook Web Access-E-Mails anmelden und remote auf das Citrix Netscaler Gateway zugreifen. In Outlook wartete eine √úberraschung in der Mail:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In dieser seltenen Einstellung k√∂nnen Sie sehen, wie Roskomnadzor Pentestern hilft.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dies waren die ersten Monate nach der ber√ºhmten Telegramm- </font><i><font style="vertical-align: inherit;">L√ºftersperre</font></i><font style="vertical-align: inherit;"> , als ganze Netzwerke mit Tausenden von Adressen unaufhaltsam aus dem Zugriff verschwanden. Es wurde klar, warum Push nicht sofort funktionierte und warum mein "Opfer" keinen Alarm ausl√∂ste, weil sie ihr Konto in den √ñffnungszeiten nutzten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diejenigen, die mit Citrix Netscaler vertraut sind, stellen sich vor, dass es normalerweise so implementiert ist, dass es m√∂glich ist, dem Benutzer nur eine Bildschnittstelle zu √ºbermitteln, ohne ihm die Werkzeuge zum Starten von Anwendungen von Drittanbietern und zum √úbertragen von Daten zu geben, wodurch Aktionen durch Standard-Control-Shells auf jede m√∂gliche Weise eingeschr√§nkt werden. Durch meinen Beruf bekam ich nur 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein wenig auf der 1C-Schnittstelle gelaufen war, stellte ich fest, dass es dort externe Verarbeitungsmodule gibt. </font><font style="vertical-align: inherit;">Sie k√∂nnen von der Schnittstelle geladen werden und werden abh√§ngig von den Rechten und Einstellungen auf dem Client oder Server ausgef√ºhrt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich bat Freunde von 1C-Programmierern, eine solche Verarbeitung zu erstellen, die einen String ben√∂tigt und ausf√ºhrt. </font><font style="vertical-align: inherit;">In 1C sieht der Start des Prozesses ungef√§hr so ‚Äã‚Äãaus (aus dem Internet). </font><font style="vertical-align: inherit;">Stimmen Sie zu, die Syntax der 1C-Sprache trifft eine russischsprachige Person mit ihrer Unmittelbarkeit? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Verarbeitung wurde perfekt ausgef√ºhrt, es stellte sich heraus, was Pentester die "Shell" nennen - Internet Explorer wurde dadurch gestartet.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuvor wurde die Adresse eines Systems in der E-Mail gefunden, mit der Sie P√§sse f√ºr das Gebiet bestellen k√∂nnen. </font><font style="vertical-align: inherit;">Ich habe einen Pass bestellt, falls ich den Angriffsvektor √ºber WLAN verwenden muss.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Internet hei√üt es, dass es im B√ºro des Kunden immer noch ein leckeres kostenloses Catering gab, aber ich habe es immer noch vorgezogen, einen Angriff √ºber eine entfernte Site zu entwickeln, es ist ruhiger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AppLocker wurde auf dem Anwendungsserver mit Citrix aktiviert, aber umgangen. </font><font style="vertical-align: inherit;">Derselbe Meterpreter wurde √ºber DNS geladen und gestartet, da die http (s) -Versionen keine Verbindung herstellen wollten und ich die interne Proxy-Adresse damals nicht kannte. </font><font style="vertical-align: inherit;">√úbrigens verwandelte sich von diesem Moment an der √§u√üere Pentest im Wesentlichen in den inneren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 4. Administratorrechte f√ºr Benutzer - das ist schlecht, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was ein Pentester tut, wenn er die Kontrolle √ºber die Sitzung eines Dom√§nenbenutzers √ºbernimmt, ist, alle Informationen √ºber die Rechte in der Dom√§ne zu sammeln. </font><font style="vertical-align: inherit;">Es gibt ein solches Dienstprogramm BloodHound, mit dem Sie automatisch Informationen √ºber Benutzer, Computer, Sicherheitsgruppen √ºber das LDAP-Protokoll vom Dom√§nencontroller herunterladen und Informationen dar√ºber, welcher Benutzer sich k√ºrzlich angemeldet hat und wer der lokale Administrator √ºber SMB ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine typische Technik zum Erfassen von Dom√§nenadministratorrechten sieht vereinfacht aus wie ein Zyklus monotoner Aktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir gehen zu Dom√§nencomputern, auf denen lokale Administratorrechte vorhanden sind, basierend auf bereits erfassten Dom√§nenkonten.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"End of Cycle", wie 1C-Programmierer hier schreiben w√ºrden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass unser Benutzer ein lokaler Administrator auf nur einem Host mit Windows 7 war, dessen Name das Wort "VDI" oder "Virtual Desktop Infrastructure" (pers√∂nliche virtuelle Maschinen) war. </font><font style="vertical-align: inherit;">Wahrscheinlich hat der Entwickler des VDI-Dienstes impliziert, dass der Benutzer, da VDI das pers√∂nliche Betriebssystem des Benutzers ist, die Softwareumgebung nach Belieben √§ndern kann, der Host jedoch trotzdem "neu geladen" werden kann. </font><font style="vertical-align: inherit;">Ich dachte auch, dass die Idee im Allgemeinen gut ist. Ich ging zu diesem pers√∂nlichen VDI-Host und machte dort einen Socket:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe dort den OpenVPN-Client installiert, der einen Tunnel √ºber das Internet zu meinem Server hergestellt hat. </font><font style="vertical-align: inherit;">Der Client musste mit der Dom√§nenauthentifizierung durch den Blue Coat kommen, aber OpenVPN kam, wie es hei√üt, sofort fertig.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installiert auf VDI OpenSSH. </font><font style="vertical-align: inherit;">Was ist Windows 7 ohne SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sah es lebendig aus. </font><font style="vertical-align: inherit;">Ich erinnere Sie daran, dass dies alles √ºber Citrix und 1C erfolgen muss:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der Techniken zur F√∂rderung des Zugriffs auf benachbarte Computer besteht darin, die Kennw√∂rter lokaler Administratoren auf √úbereinstimmung zu √ºberpr√ºfen. </font><font style="vertical-align: inherit;">Hier wartete das Gl√ºck sofort: Der NTLM-Hash des lokalen Standardadministrators (der pl√∂tzlich als Administrator bezeichnet wurde) n√§herte sich durch den Pass-the-Hash-Angriff benachbarten VDI-Hosts, von denen es mehrere hundert gab. </font><font style="vertical-align: inherit;">Nat√ºrlich ging der Angriff sofort √ºber sie hinweg.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann haben sich die VDI-Administratoren zweimal in den Fu√ü geschossen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das erste Mal, dass VDI-Computer von LAPS nicht in Betrieb genommen wurden, wurde im Wesentlichen dasselbe lokale Administratorkennwort aus einem Image gespeichert, das massiv f√ºr VDI bereitgestellt wurde.</font></font></li>
<li>   ‚Äî   ,    pass-the-hash .          ,         ,   ‚Äî .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum SSH-Dienst unter Windows? Ganz einfach: Jetzt bot der OpenSSH-Server nicht nur eine praktische interaktive Befehlsshell, ohne die Arbeit des Benutzers zu beeintr√§chtigen, sondern auch einen socks5-Proxy auf VDI. √úber diese Socken stellte ich eine Verbindung √ºber SMB her, sammelte zwischengespeicherte Konten von all diesen Hunderten von VDI-Computern und suchte dann in den BloodHound-Diagrammen nach dem Pfad zum Dom√§nenadministrator. Mit Hunderten von Gastgebern, die mir zur Verf√ºgung standen, fand ich diesen Weg ziemlich schnell. Dom√§nenadministratorrechte wurden erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein Bild aus dem Internet, das eine √§hnliche Suche zeigt. Die Links zeigen, wer der Administrator ist und wer wo eingegeben hat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie √ºbrigens an die Bedingung von Beginn des Projekts an: "Wenden Sie kein Social Engineering an." </font><font style="vertical-align: inherit;">Also schlage ich vor, dar√ºber nachzudenken, wie viel dieser ganze Bollywood mit Spezialeffekten abgeschnitten w√ºrde, wenn man trotzdem banales Phishing anwenden k√∂nnte. </font><font style="vertical-align: inherit;">Aber ich pers√∂nlich war sehr daran interessiert. </font><font style="vertical-align: inherit;">Ich hoffe, Sie waren daran interessiert, dies zu lesen. </font><font style="vertical-align: inherit;">Nat√ºrlich sieht nicht jedes Projekt so faszinierend aus, aber die Arbeit insgesamt ist sehr r√§tselhaft und stagniert nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wahrscheinlich wird jemand eine Frage haben: Wie kann man sich sch√ºtzen? </font><font style="vertical-align: inherit;">Selbst in diesem Artikel werden viele Techniken beschrieben, von denen Windows-Administratoren nicht einmal viele kennen. </font><font style="vertical-align: inherit;">Ich schlage jedoch vor, sie aus der Perspektive abgedroschener Prinzipien und Ma√ünahmen der Informationssicherheit zu betrachten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie keine veraltete Software (erinnern Sie sich an Windows 2003 am Anfang?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie nicht unn√∂tige Systeme eingeschaltet (warum war der Standort des Urologen?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie die Benutzerpassw√∂rter selbst auf St√§rke (andernfalls tun </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soldaten ...</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pentester </font><font style="vertical-align: inherit;">dies </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haben Sie nicht die gleichen Passw√∂rter f√ºr verschiedene Konten (VDI-Kompromiss)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usw</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nat√ºrlich ist die Implementierung sehr schwierig, aber im n√§chsten Artikel werden wir in der Praxis zeigen, dass dies durchaus m√∂glich ist.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496702/index.html">PCI Express in FPGAs der Intel V-Serie: Schnittstellengrundlagen und Hardware-Kernfunktionen</a></li>
<li><a href="../de496704/index.html">Leiterplatte der Saturn-5-Rakete - Reverse Engineering mit Erl√§uterungen</a></li>
<li><a href="../de496706/index.html">Wochenendlesung: Eine Geschichte der Audioformate - Das Zeitalter der Kassetten und die Entwicklung von Sprachsynthesetechnologien</a></li>
<li><a href="../de496708/index.html">Raumkanone, Dampfrakete und Orbitalspiegel</a></li>
<li><a href="../de496710/index.html">Computerinformationen: Einfach und schnell</a></li>
<li><a href="../de496714/index.html">Power Automate VS Logic Apps. allgemeine Informationen</a></li>
<li><a href="../de496716/index.html">Power Automate VS Logic Apps. Power Automate-F√§lle</a></li>
<li><a href="../de496720/index.html">LLHD-Projekt - Universal Hardware Description Language</a></li>
<li><a href="../de496722/index.html">Tinkov API. Investition. Erste Schritte</a></li>
<li><a href="../de496726/index.html">Gent nach unten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>