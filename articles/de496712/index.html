<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👆🏼 🙎🏾 😤 Einmal bei einem Pentest oder wie man mit Hilfe eines Urologen und Roskomnadzors alles kaputt macht 🤾🏽 ⚽️ ✍🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel basiert auf einem sehr erfolgreichen Pentest, der vor einigen Jahren von Group-IB-Spezialisten durchgeführt wurde: Eine Geschichte, die...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Einmal bei einem Pentest oder wie man mit Hilfe eines Urologen und Roskomnadzors alles kaputt macht</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel basiert auf einem sehr erfolgreichen Pentest, der vor einigen Jahren von Group-IB-Spezialisten durchgeführt wurde: Eine Geschichte, die behauptet, eine Verfilmung in Bollywood zu sein. Nun wird wahrscheinlich die Reaktion des Lesers folgen: "Oh, ein weiterer PR-Artikel, wieder sind diese gezeichnet, wie gut sie sind, vergessen Sie nicht, einen Pentest zu kaufen." Einerseits ist es das. Es gibt jedoch eine Reihe von Gründen, warum dieser Artikel veröffentlicht wurde. Ich wollte zeigen, was genau Pentester tun, wie interessant und nicht trivial diese Arbeit sein kann, welche amüsanten Umstände sich bei Projekten entwickeln können und vor allem Live-Material mit realen Beispielen zeigen.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Gleichgewicht der Bescheidenheit in der Welt wiederherzustellen, werden wir nach einer Weile über das Pentest schreiben, das nicht gegangen ist. </font><font style="vertical-align: inherit;">Wir zeigen, wie gut etablierte Prozesse in einem Unternehmen vor einer ganzen Reihe von Angriffen schützen können, auch vor gut vorbereiteten, einfach weil diese Prozesse existieren und wirklich funktionieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch dem Kunden aus diesem Artikel war im Allgemeinen alles in Ordnung, zumindest besser als 95% des Marktes in der Russischen Föderation, nach unseren Gefühlen, aber es gab eine Reihe kleinerer Nuancen, die eine lange Kette von Ereignissen bildeten, die zunächst zu einem langen Bericht über die Arbeit führten und dann zu diesem Artikel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, tanken Sie Popcorn und heißen Sie den Detektiv willkommen. </font><font style="vertical-align: inherit;">Ich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erteile Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dem technischen Direktor der Audit and Consulting Group-IB </font><b><font style="vertical-align: inherit;">, das Wort</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 1. Pochkin Arzt </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018 Jahr. Es gibt einen Kunden - ein High-Tech-IT-Unternehmen, das selbst viele Kunden bedient. Er möchte eine Antwort auf die Frage erhalten: Ist es möglich, ohne anfängliche Kenntnisse und Zugriff über das Internet Administratorrechte für eine Active Directory-Domäne zu erlangen? Kein Social Engineering ist von Interesse ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eh, aber vergebens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), sie werden die Arbeit nicht speziell stören, aber sie können beispielsweise versehentlich einen fremden Arbeitsserver neu laden. Eine zusätzliche Aufgabe besteht darin, so viele andere Angriffsvektoren wie möglich in Bezug auf den Außenumfang zu identifizieren. Das Unternehmen führt regelmäßig solche Tests durch und jetzt die Frist für einen neuen Test. Die Bedingungen sind fast typisch, angemessen, verständlich. Runter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt einen Kundennamen - sei es "Unternehmen" mit der Hauptseite </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Natürlich wird der Kunde anders angerufen, aber in diesem Artikel wird alles entpersönlicht. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich führe Netzwerkinformationen durch - Ich finde heraus, welche Adressen und Domänen vom Kunden aufgelistet werden, zeichne ein Netzwerkdiagramm und wie Dienste an diese Adressen verteilt werden. Ich bekomme das Ergebnis: mehr als 4000 Live-IP-Adressen. Ich schaue mir die Domänen in diesen Netzwerken an: Glücklicherweise handelt es sich bei der überwiegenden Mehrheit um Netzwerke, die für Kundenkunden bestimmt sind, und sie interessieren uns formal nicht. Der Kunde glaubt das auch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt ein Netzwerk mit 256 Adressen übrig, für das zu diesem Zeitpunkt bereits ein Verständnis für die Verteilung von Domänen und Subdomänen nach IP-Adressen besteht. Es gibt Informationen zu den gescannten Ports, sodass Sie die Dienste mit Ihren Augen nach interessanten durchsuchen können. Parallel dazu werden alle Arten von Scannern unter zugänglichen IP-Adressen und separat auf Websites gestartet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viele Dienstleistungen. Dies ist normalerweise eine Freude für den Pentester und die Erwartung eines schnellen Sieges, denn je mehr Dienste, desto größer das Angriffsfeld und desto einfacher ist es, ein Artefakt zu finden. Ein kurzer Blick auf die Websites zeigte, dass die meisten von ihnen Webschnittstellen der bekannten Produkte großer Unternehmen der Welt sind, die sagen, dass sie mit Ihnen nicht zufrieden sind. Sie fragen nach einem Benutzernamen und einem Kennwort. Ab dem Schwellenwert, an dem sie ein Feld für die Eingabe des zweiten Faktors schütteln, fragen sie nach einem TLS-Client-Zertifikat oder senden sie an Microsoft ADFS. Einige sind im Internet einfach nicht verfügbar. Für einige müssen Sie offensichtlich einen speziell bezahlten Kunden für drei Gehälter haben oder die genaue URL kennen, die Sie eingeben müssen. Wir werden eine weitere Woche nach und nach entmutigen, wenn wir versuchen, die Software nach bekannten Sicherheitslücken zu "durchbrechen", nach versteckten Inhalten in Webpfaden zu suchen und Konten von Drittanbieterdiensten wie LinkedIn zu verlieren.Versuche, Passwörter für sie auszuwählen und Schwachstellen in selbst beschriebenen Websites aufzudecken - laut Statistik ist dies übrigens der vielversprechendste Vektor eines externen Angriffs bis heute. Sofort bemerke ich die Kinokanone, die anschließend abgefeuert wurde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab also zwei Standorte, die sich von Hunderten von Diensten abheben. Diese Sites hatten eines gemeinsam: Wenn Sie keine sorgfältige Netzwerkaufklärung nach Domänen durchführen, sondern „auf der Vorderseite“ nach offenen Ports suchen oder den Schwachstellenscanner über einen bekannten IP-Bereich vergiften, werden diese Sites nicht mehr überprüft, sondern ohne Kenntnis des DNS-Namens einfach nicht sichtbar. Vielleicht wurden sie zumindest früher übersehen, und unsere automatischen Tools fanden keine Probleme darin, selbst wenn sie direkt auf die Ressource eingestellt waren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Übrigens über die Tatsache, dass zuvor eingeführte Scanner in der Regel gefunden wurden. Ich möchte Sie daran erinnern: Für manche Menschen ist „Pentest“ gleichbedeutend mit „automatisiertem Scannen“. Und die Scanner dieses Projekts sagten nichts. Nun, mittlere Sicherheitslücken zeigten das Maximum (3 von 5 in Bezug auf die Gefahr): Einige Dienste haben ein schlechtes TLS-Zertifikat oder veraltete Verschlüsselungsalgorithmen, und die meisten Websites verfügen über Clickjacking. Aber damit kommen Sie nicht zum Ziel. Wahrscheinlich wären Scanner hier nützlicher, aber ich möchte Sie daran erinnern: Der Kunde selbst kann solche Programme kaufen und sich mit ihnen testen, und nach den langweiligen Ergebnissen zu urteilen, hat er sie bereits überprüft.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zurück zu den "abnormalen" Stellen. Das erste ist so etwas wie ein lokales Wiki an einer nicht standardmäßigen Adresse, aber lassen Sie wiki.company [.] Ru in diesem Artikel sein. Sie forderte auch sofort einen Benutzernamen und ein Passwort an, jedoch bereits über NTLM im Browser. Für den Benutzer sieht dies wie ein asketisches Fenster aus, in dem Sie nach einem Benutzernamen und einem Kennwort gefragt werden. Und das ist schlechte Praxis.</font></font><br>
<br>
<blockquote> . NTLM  -      .   —    Active Directory.       company.ru,   «» DNS-.  ,    - ,        ,    - .  —        NTLM (, ?),     «» ,         .    ,      .         —  ,    .  —       .         — , ,  .  —   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine schlechte Funktion von Microsoft-Produkten: Selbst wenn Sie ein solches NTLM nicht speziell veröffentlicht haben, wird es zumindest in der Standardinstallation in OWA und Lync installiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Übrigens hat der Autor dieses Artikels einmal auf die gleiche Weise versehentlich in nur einer Stunde ungefähr 1000 Konten von Mitarbeitern einer großen Bank gesperrt und hatte dann ein etwas blasses Aussehen. </font><font style="vertical-align: inherit;">Die IT-Services der Bank waren ebenfalls blass, aber alles endete gut und angemessen. Wir wurden sogar gelobt, dass wir die ersten waren, die dieses Problem fanden, und provozierten eine schnelle und entscheidende Korrektur.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die zweite Site hatte die Adresse "offensichtlich ein Nachname.company.ru". </font><font style="vertical-align: inherit;">Gefunden über Google, so etwas auf Seite 10. </font><font style="vertical-align: inherit;">Das Design beginnt bis Mitte 2000, und eine angesehene Person sah von der Hauptseite aus wie folgt aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann nahm er einen Rahmen aus "Hundeherz", aber glauben Sie mir, es war im entferntesten ähnlich, sogar das Farbschema in ähnlichen Farben. Lassen Sie die Site </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> heißen </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war eine persönliche Seite ... eines Urologen. Es wurde interessant, was der Standort des Urologen auf der Subdomain eines High-Tech-Unternehmens tut. Ein kurzer Blick auf Google zeigte, dass dieser Arzt Mitbegründer einer der juristischen Personen unseres Kunden war und sogar etwa 1000 Rubel eingetragenes Kapital beisteuerte. Die Site wurde wahrscheinlich vor vielen Jahren erstellt und die Serverressourcen des Kunden wurden als Hosting verwendet. Die Seite hat lange an Relevanz verloren, aber aus irgendeinem Grund funktioniert sie schon lange nicht mehr.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Bezug auf Schwachstellen war die Website selbst sicher. Mit Blick auf die Zukunft werde ich sagen, dass es sich um eine Reihe von statischen Daten handelte - einfache HTML-Seiten mit Beilagen von Abbildungen in Form von Nieren und Blasen. Das "Brechen" einer solchen Site ist nutzlos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber der Webserver darunter war interessanter. Dem HTTP-Server-Header nach zu urteilen, gab es IIS 6.0, was bedeutet, dass Windows 2003 als Betriebssystem verwendet wurde. Der Scanner hat zuvor festgestellt, dass diese bestimmte Website des Urologen im Gegensatz zu anderen virtuellen Hosts auf demselben Webserver auf den Befehl PROPFIND reagiert hat, dh, WebDAV hat dort gearbeitet. Übrigens hat der Scanner diese Informationen mit der Markierung Info versehen (in der Sprache der Scannerberichte ist dies die geringste Gefahr) - solche Dinge werden normalerweise einfach übersprungen. In Kombination ergab dies einen interessanten Effekt, der erst nach einem erneuten Einstieg in Google aufgedeckt wurde: eine seltene Sicherheitsanfälligkeit in Bezug auf Pufferüberlauf, die mit einer Reihe von Shadow Brokers verbunden ist, nämlich CVE-2017-7269, die bereits einen Exploit hatten. Mit anderen Worten, es wird eine Katastrophe sein, wenn Sie Windows 2003 haben und WebDAV unter IIS ausgeführt wird.Obwohl 2018 in der Produktion von Windows 2003 gearbeitet wird, ist dies an sich schon eine Katastrophe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Exploit endete in Metasploit und wurde sofort mit einer Last getestet, die eine DNS-Abfrage an einen kontrollierten Dienst sendete. Burp Collaborator wird traditionell zum Abfangen von DNS-Abfragen verwendet. Überraschenderweise hat es beim ersten Mal funktioniert: In DNS wurde ein Ruck empfangen. Dann wurde versucht, eine Back-End-Verbindung über Port 80 herzustellen (dh eine Netzwerkverbindung vom Server zum Angreifer mit Zugriff auf cmd.exe auf dem Host des Opfers), aber dann kam es zu einem Fiasko. Die Verbindung wurde nicht hergestellt, und nach dem dritten Operationsversuch verschwand die Site zusammen mit allen unterhaltsamen Bildern endgültig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalerweise folgt ein Brief im Stil von "Kunde, wach auf, wir haben alles fallen lassen". Uns wurde jedoch mitgeteilt, dass die Site nichts mit Geschäftsprozessen zu tun hat und dort im Allgemeinen funktioniert. Es ist nicht klar, warum, wie der gesamte Server, und dass wir diese Ressource nach Belieben verwenden können.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach ungefähr einem Tag begann die Site plötzlich von selbst zu arbeiten. Nachdem ich einen Stand von WebDAV auf IIS 6.0 erstellt hatte, stellte ich fest, dass die Standardeinstellung darin besteht, IIS-Workflows alle 30 Stunden neu zu starten. Das heißt, wenn das Steuerelement aus dem Shell-Code beendet wurde, wurde der IIS-Workflow beendet, dann selbst ein paar Mal neu gestartet und dann 30 Stunden lang angehalten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da das erste Mal die bekconnect auf tcp fehlgeschlagen ist, habe ich dieses Problem an einen geschlossenen Port abgeschrieben. </font><font style="vertical-align: inherit;">Das heißt, er schlug das Vorhandensein einer Firewall vor, die ausgehende Verbindungen nicht herausließ. </font><font style="vertical-align: inherit;">Ich fing an, Shell-Codes auszuführen, die viele TCP- und UDP-Ports sortieren. Es gab keine Auswirkungen. </font><font style="vertical-align: inherit;">Das Laden der umgekehrten Verbindung über http (s) von Metasploit - meterpreter / reverse_http (s) funktionierte nicht. </font><font style="vertical-align: inherit;">Plötzlich wurde die Verbindung zu demselben Port 80 hergestellt, aber sofort unterbrochen. </font><font style="vertical-align: inherit;">Er schrieb es an die Aktion des immer noch imaginären IPS ab, das keinen Meterpreter-Verkehr mochte. </font><font style="vertical-align: inherit;">Angesichts der Tatsache, dass die Verbindung von reinem TCP zu Port 80 fehlschlug, http jedoch, kam ich zu dem Schluss, dass der http-Proxy irgendwie im System konfiguriert war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchte sogar Meterpreter über DNS (danke</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für seine Bemühungen rettete er viele Projekte) und erinnerte sich an den allerersten Erfolg, aber er arbeitete nicht einmal am Stand - der Shell-Code war zu umfangreich für diese Sicherheitsanfälligkeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Wirklichkeit sah es so aus: 3-4 Versuche, innerhalb von 5 Minuten anzugreifen, dann 30 Stunden warten. Und so drei Wochen hintereinander. Ich habe sogar eine Erinnerung eingerichtet, um keine Zeit zu verschwenden. Darüber hinaus gab es einen Unterschied im Verhalten der Test- und Kampfumgebungen: Für diese Sicherheitsanfälligkeit gab es zwei ähnliche Exploits, einen von Metasploit und einen vom Internet, der aus der Version von Shadow Brokers überarbeitet wurde. Im Kampf hat also nur Metasploit am Stand geklappt - nur der zweite, was das Debuggen weiter erschwerte und das Gehirn brach.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende erwies sich der Shell-Code als effektiv, der eine exe-Datei von einem bestimmten Server über http herunterlud und auf dem Zielsystem ausführte. Der Shellcode war klein genug, um hinein zu passen, und zumindest funktionierte er. Da der TCP-Server überhaupt keinen Datenverkehr mochte und http (s) auf Meterpreter überprüft wurden, entschied ich, dass der schnellste Weg darin besteht, die exe-Datei, die den DNS-Meterpreter enthielt, über diesen Shellcode herunterzuladen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch hier trat das Problem auf: Beim Herunterladen der exe-Datei wurde, wie die Versuche zeigten, der Download unterbrochen, egal was passierte. </font><font style="vertical-align: inherit;">Wiederum mochte eine Art Schutzgerät zwischen meinem Server und dem Urologen den http-Verkehr mit exe im Inneren nicht. </font><font style="vertical-align: inherit;">Es schien eine „schnelle“ Lösung zu sein, den Shellcode so zu ändern, dass der http-Verkehr im laufenden Betrieb verschleiert wurde und abstrakte Binärdaten anstelle von exe übertragen wurden. </font><font style="vertical-align: inherit;">Schließlich war der Angriff erfolgreich, die Kontrolle kam über den dünnen DNS-Kanal:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde sofort klar, dass ich die einfachsten Rechte am IIS-Workflow hatte, mit denen ich nichts tun konnte. </font><font style="vertical-align: inherit;">So sah es auf der Metasploit-Konsole aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Pentest-Methoden empfehlen dringend, dass Sie die Rechte erhöhen müssen, wenn Sie Zugriff erhalten. Normalerweise mache ich das nicht lokal, da der allererste Zugriff einfach als Netzwerkeintrittspunkt betrachtet wird und das Kompromittieren eines anderen Computers im selben Netzwerk normalerweise einfacher und schneller ist als das Erhöhen der Berechtigungen auf einem vorhandenen Host. Dies ist jedoch nicht der Fall, da der DNS-Kanal sehr eng ist und kein Roaming des Datenverkehrs zulässt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter der Annahme, dass dieser Server mit Windows 2003 nicht von der bekannten Sicherheitsanfälligkeit MS17-010 repariert wurde, tunnele ich den Datenverkehr über den Meterpreter-DNS-Tunnel zum lokalen Host an Port 445 / TCP (ja, dies ist auch möglich) und versuche, eine zuvor heruntergeladene Exe über die Sicherheitsanfälligkeit auszuführen. Der Angriff funktioniert, ich bekomme eine zweite Verbindung, aber mit SYSTEM-Berechtigungen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interessanterweise versuchte der Server immer noch, sich vor MS17-010 zu schützen - er hatte anfällige Netzwerkdienste auf der externen Schnittstelle deaktiviert. </font><font style="vertical-align: inherit;">Dies schützt wirklich vor Angriffen über das Netzwerk, aber der Angriff innerhalb des lokalen Hosts hat funktioniert, da Sie SMB auf localhost nicht einfach ausschalten und schnell deaktivieren können.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als nächstes werden neue interessante Details enthüllt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit SYSTEM-Berechtigungen können Sie Back-Connect problemlos über TCP installieren. </font><font style="vertical-align: inherit;">Offensichtlich ist das Verbot von direktem TCP ausschließlich ein IIS-beschränktes Benutzerproblem. </font><font style="vertical-align: inherit;">Spoiler: Der IIS-Benutzerverkehr wurde in beide Richtungen irgendwie in den lokalen ISA-Proxy eingeschlossen. </font><font style="vertical-align: inherit;">Wie genau das funktioniert, wird nicht reproduziert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich bin in einer bestimmten "DMZ" (und dies ist keine Active Directory-Domäne, sondern WORKGROUP) - das klingt logisch. </font><font style="vertical-align: inherit;">Aber anstelle der erwarteten privaten ("grauen") IP-Adresse bin ich ziemlich "weiß", genau so, wie ich es zuvor angegriffen habe. </font><font style="vertical-align: inherit;">Dies bedeutet, dass das Unternehmen für die Welt der IPv4-Adressierung so alt ist, dass es sich leisten kann, die DMZ-Zone gemäß dem Schema auf 128 „weißen“ Adressen ohne NAT zu halten, wie in den Cisco-Handbüchern von 2005 dargestellt.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da der Server alt ist, funktioniert Mimikatz garantiert direkt aus dem Speicher:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich erhalte das Passwort des lokalen Administrators, tunnele RDP-Verkehr über TCP und gehe auf einen gemütlichen Desktop. </font><font style="vertical-align: inherit;">Da Sie mit dem Server alles tun können, lösche ich das Antivirenprogramm. Ich stelle fest, dass der Server nur über die TCP-Ports 80 und 443 über das Internet erreichbar ist und 443 nicht ausgelastet war. </font><font style="vertical-align: inherit;">Ich erhöhe den OpenVPN-Server auf 443, füge die NAT-Funktionen für meinen VPN-Verkehr hinzu und erhalte über mein OpenVPN unbegrenzten direkten Zugriff auf das DMZ-Netzwerk. </font><font style="vertical-align: inherit;">Es ist bemerkenswert, dass ISA mit einigen nicht deaktivierbaren IPS-Funktionen meinen Datenverkehr durch Port-Scanning blockierte, für das es durch ein einfacheres und flexibleres RRAS ersetzt werden musste. </font><font style="vertical-align: inherit;">So müssen Pentester manchmal noch alles verwalten.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein aufmerksamer Leser wird fragen: "Und was ist die zweite Seite - ein Wiki mit NTLM-Authentifizierung, über das so viel geschrieben wurde?" </font><font style="vertical-align: inherit;">Darüber weiter.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 2. Verschlüsseln Sie immer noch nicht? </font><font style="vertical-align: inherit;">Dann </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gehen wir</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schon hier </font><s><font style="vertical-align: inherit;">zu dir</font></s></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es besteht also Zugriff auf das DMZ-Netzwerksegment. </font><font style="vertical-align: inherit;">Sie müssen zum Domänenadministrator gehen. </font><font style="vertical-align: inherit;">Das erste, was mir in den Sinn kommt, ist die automatische Überprüfung der Dienste innerhalb des DMZ-Segments, zumal sie jetzt viel offener für Forschung sind. </font><font style="vertical-align: inherit;">Ein typisches Bild bei einem Penetrationstest: Der externe Perimeter ist besser geschützt als interne Dienste, und wenn Sie Zugriff auf eine große Infrastruktur erhalten, ist es viel einfacher, erweiterte Rechte in einer Domäne zu erhalten, nur weil diese Domäne für Tools zugänglich ist, und zweitens. Es gibt immer ein paar kritische Probleme in der Infrastruktur für mehrere tausend Hosts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich lade Scanner in DMZ über den OpenVPN-Tunnel, ich warte. Ich öffne den Bericht - wieder nichts Ernstes, anscheinend ging jemand auf die gleiche Weise zu mir. Der nächste Schritt besteht darin, zu untersuchen, wie Hosts innerhalb des DMZ-Netzwerks kommunizieren. Zu diesem Zweck wird zunächst ein regulärer Wireshark gestartet, der Broadcast-Anfragen abhört, hauptsächlich ARP. ARP-Pakete wurden den ganzen Tag gesammelt. Es stellt sich heraus, dass in diesem Segment mehrere Gateways verwendet werden. Dies wird später nützlich sein. Beim Kleben von Daten auf ARP-Anforderungs-Antwort- und Port-Scan-Daten fand ich die Ausgabepunkte des Benutzerverkehrs aus dem lokalen Netzwerk zusätzlich zu den zuvor bekannten Diensten wie Web und E-Mail.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ich im Moment keinen Zugriff auf andere Systeme hatte und es kein einziges Konto für Unternehmensdienste gab, wurde beschlossen, mit ARP Spoofing mindestens ein Konto aus dem Datenverkehr abzurufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel wurde auf dem Server des Urologen gestartet. </font><font style="vertical-align: inherit;">Unter Berücksichtigung der identifizierten Verkehrsströme wurden die vielversprechendsten Paare für den Angriff „Mann in der Mitte“ ausgewählt. Bei einem kurzfristigen Start von 5 bis 10 Minuten und einem Timer zum Neustart des Servers im Falle eines „Einfrierens“ wurde ein Teil des Netzwerkverkehrs empfangen. </font><font style="vertical-align: inherit;">Wie im Witz gab es zwei Neuigkeiten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gut: Es wurden viele Anmeldeinformationen abgefangen und der Angriff insgesamt hat funktioniert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlecht: Alle Anmeldeinformationen stammten von Kunden des Kunden selbst. </font><font style="vertical-align: inherit;">Kundenspezialisten bieten Support-Services an und sind mit Kundenservices verbunden, für die nicht immer die Verkehrsverschlüsselung konfiguriert war.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen erhielt ich viele Anmeldeinformationen, die im Rahmen des Projekts nutzlos waren, aber auf jeden Fall als Demonstration der Gefahr eines Angriffs interessant waren. Grenzrouter großer Unternehmen mit Telnet, weitergeleitete Debugging-HTTP-Ports an das interne CRM mit allen Daten, direkter Zugriff auf RDP von Windows XP im lokalen Netzwerk und anderer Obskurantismus. Es stellte sich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach MITRE-Matrix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eine Art </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Supply-Chain-Kompromiss heraus</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch eine lustige Gelegenheit gefunden, E-Mails aus dem Verkehr zu sammeln, so etwas. Dies ist ein Beispiel für einen fertigen Brief, der ohne Verschlüsselung von unserem Kunden an den SMTP-Port seines Kunden gesendet wurde. Ein bestimmter Andrei bittet seinen Namensvetter, die Dokumentation erneut zu senden. Sie befindet sich auf einer Cloud-Festplatte mit einem Benutzernamen, einem Kennwort und einem Link in einem Antwortschreiben:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine weitere Erinnerung daran, dass Sie alle Dienste verschlüsseln müssen. Es ist nicht bekannt, wer und wann Ihre Daten speziell lesen und anwenden wird - ein Anbieter, ein Systemadministrator eines anderen Unternehmens oder ein solcher Pentester. Ich schweige, dass viele einfach unverschlüsselten Datenverkehr abfangen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz des offensichtlichen Erfolgs wurde dies dem Ziel nicht näher gebracht. Es war natürlich möglich, lange zu sitzen und wertvolle Informationen herauszuholen, aber nicht die Tatsache, dass sie dort erschienen wären, und der Angriff selbst ist im Hinblick auf die Integrität des Netzwerks sehr riskant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einem weiteren Eingraben in die Dienste kam mir eine interessante Idee in den Sinn. Es gibt ein solches Dienstprogramm namens Responder (es ist leicht, Beispiele für Anwendungen mit diesem Namen zu finden), das durch "Vergiften" von Broadcast-Anforderungen Verbindungen über eine Vielzahl von Protokollen wie SMB, HTTP, LDAP usw. hervorruft. Auf unterschiedliche Weise wird dann jede Person, die eine Verbindung herstellt, aufgefordert, sich zu authentifizieren, und passt sich an, sodass die Authentifizierung über NTLM und in einem für das Opfer transparenten Modus erfolgt. In den meisten Fällen sammelt ein Angreifer daher NetNTLMv2-Handshakes und stellt laut Wörterbuch schnell Kennwörter für Benutzerdomänen wieder her. Ich wollte hier etwas Ähnliches, aber Benutzer saßen „hinter der Wand“, oder besser gesagt, sie waren durch eine Firewall getrennt, und im WEB gingen sie durch den Blue Coat-Proxy-Cluster.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, dass ich angegeben habe, dass der Active Directory-Domänenname mit der "externen" Domäne übereinstimmt, dh company.ru? Windows, genauer gesagt Internet Explorer (und Edge und Chrome), ermöglicht es dem Benutzer, sich transparent in HTTP über NTLM zu authentifizieren, wenn er der Ansicht ist, dass sich die Site in einer „Intranetzone“ befindet. Eines der Anzeichen für „Intranet“ ist der Aufruf einer „grauen“ IP-Adresse oder eines kurzen DNS-Namens, dh ohne Punkte. Da ein Server mit einem „weißen“ IP- und DNS-Namen preobrazhensky.company.ru zur Verfügung stand und Domänencomputer normalerweise das Active Directory-Domänensuffix über DHCP zur vereinfachten Namenseingabe erhalten, mussten sie lediglich die </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">preobrazhensky-</font></a><font style="vertical-align: inherit;"> URL in die Adressleiste schreiben</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">damit sie den richtigen Weg zu einem kompromittierten Urologen-Server finden, nicht zu vergessen, dass er jetzt "Intranet" heißt. </font><font style="vertical-align: inherit;">Das heißt, gleichzeitig gibt er mir den NTLM-Handshake-Benutzer ohne sein Wissen. </font><font style="vertical-align: inherit;">Es bleibt abzuwarten, ob Client-Browser über die dringende Notwendigkeit nachdenken, auf diesen Server zuzugreifen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das wunderbare Dienstprogramm Intercepter-NG kam zur Rettung (danke</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intercepter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Sie konnten den Datenverkehr unterwegs ändern und funktionierten perfekt unter Windows 2003. Es gab sogar eine separate Funktion, mit der nur JavaScript-Dateien im Datenverkehr geändert werden konnten. Es war eine Art massives Cross-Site-Scripting geplant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blue Coat-Proxys, über die Benutzer auf das globale WEB zugegriffen haben, haben regelmäßig statische Inhalte zwischengespeichert. Durch das Abfangen des Datenverkehrs wurde deutlich, dass sie rund um die Uhr arbeiten und häufig verwendete Statiken endlos anfordern, um die Anzeige von Inhalten während der Stoßzeiten zu beschleunigen. Darüber hinaus verfügte BlueCoat über einen speziellen User-Agent, der sich deutlich von einem lebenden Benutzer unterschied. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde Javascript erstellt, das mit Hilfe von Intercepter-NG nachts eine ganze Stunde damit verbrachte, jede Antwort mit JS-Dateien für Blue Coat zu implementieren. Das Skript hat Folgendes ausgeführt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der aktuelle Browser wurde vom User-Agent erkannt. </font><font style="vertical-align: inherit;">Wenn es Internet Explorer, Edge oder Chrome war, hat es funktioniert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warten, bis das DOM der Seite gebildet ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe ein unsichtbares Bild mit dem Attribut src vom Typ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky in das DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eingefügt </font><font style="vertical-align: inherit;">: 8080 / NNNNNNN.png, wobei NNN beliebige Ziffern sind, damit BlueCoat nicht zwischenspeichert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legen Sie eine globale Flag-Variable fest, für die die Injektion vorgenommen wurde und für die Sie keine Bilder mehr einfügen müssen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Browser hat versucht, dieses Bild auf Port 8080 des gefährdeten Servers zu laden. Er hat auf den TCP-Tunnel zu meinem Laptop gewartet, auf dem derselbe Responder gestartet wurde, für den eine NTLM-Anmeldung vom Browser erforderlich ist.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den Responder-Protokollen zu urteilen, kamen die Leute am Morgen zur Arbeit, schalteten ihre Arbeitsstationen ein und begannen dann, den Server des Urologen massenhaft und unsichtbar zu besuchen, ohne zu vergessen, NTLM-Handshakes zusammenzuführen. </font><font style="vertical-align: inherit;">Handshakes regneten den ganzen Tag und sammelten deutlich Material für einen notorisch erfolgreichen Passwortwiederherstellungsangriff. </font><font style="vertical-align: inherit;">So sahen die Responder-Protokolle aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Massive geheime Besuche von Benutzern auf dem Server des Urologen</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sie haben wahrscheinlich bereits bemerkt, dass diese ganze Geschichte auf dem Prinzip basiert: "Alles war in Ordnung, aber es gab einen Mist, dann gab es Überwindung und dann kam alles zum Erfolg." </font><font style="vertical-align: inherit;">Es gab also einen Mist. </font><font style="vertical-align: inherit;">Von den fünfhundert einzigartigen Handshakes wurde keiner enthüllt. </font><font style="vertical-align: inherit;">Und dies berücksichtigt die Tatsache, dass diese NTLMv2-Handshakes selbst auf einem Laptop mit einem toten Prozessor mit einer Geschwindigkeit von mehreren hundert Millionen Versuchen pro Sekunde überwunden werden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich musste mich mit Passwortmutationstechniken, einer Grafikkarte und einem dickeren Wörterbuch ausrüsten und warten. </font><font style="vertical-align: inherit;">Nach langer Zeit wurden mehrere Konten mit Passwörtern der Form „Q11111111 ... .1111111q“ eröffnet, was darauf hindeutet, dass alle Benutzer einmal gezwungen waren, ein sehr langes Passwort mit einem anderen Zeichenfall zu erstellen, was kompliziert sein sollte. </font><font style="vertical-align: inherit;">Aber Sie können einen erfahrenen Benutzer nicht einfach scheitern lassen, und auf diese Weise hat er es einfacher gemacht, sich zu erinnern. </font><font style="vertical-align: inherit;">Insgesamt wurden etwa 5 Stücke geöffnet, von denen nur eines wertvolle Rechte an den Dienstleistungen hatte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 3. Roskomnadzor schlägt zurück</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So wurden die ersten Domain-Accounts empfangen. </font><font style="vertical-align: inherit;">Wenn Sie zu diesem Zeitpunkt nach einer langen Lektüre nicht eingeschlafen sind, werden Sie sich wahrscheinlich daran erinnern, dass ich einen Dienst erwähnt habe, für den kein zweiter Authentifizierungsfaktor erforderlich war: Dies ist ein Wiki mit NTLM-Authentifizierung. </font><font style="vertical-align: inherit;">Das erste, was sie taten, war natürlich einzutreten. </font><font style="vertical-align: inherit;">Das Eingraben in die interne Wissensbasis brachte schnell Ergebnisse:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Unternehmen verfügt über ein WiFi-Netzwerk mit Domänenkontoauthentifizierung und Zugriff auf ein lokales Netzwerk. </font><font style="vertical-align: inherit;">Mit dem aktuellen Datensatz ist dies bereits ein funktionierender Angriffsvektor, aber Sie müssen mit Ihren Füßen ins Büro gehen und sich irgendwo im Büro des Kunden platzieren.</font></font></li>
<li> ,    , …    « » ,              .    «»  «»        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich wurde der „zweite Faktor“ sofort als Anwendung auf meinem Telefon zum gefährdeten Konto hinzugefügt. Es gab ein Programm, das entweder lautstark eine Push-Anfrage mit den Tasten "Genehmigen" / "Ablehnen" an das Telefon senden oder den OTP-Code für weitere unabhängige Eingaben still auf dem Bildschirm anzeigen konnte. Darüber hinaus sollte die erste Methode die einzig richtige Anweisung sein, funktionierte jedoch im Gegensatz zur OTP-Methode nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem defekten "zweiten Faktor" konnte ich mich bei Outlook Web Access-E-Mails anmelden und remote auf das Citrix Netscaler Gateway zugreifen. In Outlook wartete eine Überraschung in der Mail:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In dieser seltenen Einstellung können Sie sehen, wie Roskomnadzor Pentestern hilft.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dies waren die ersten Monate nach der berühmten Telegramm- </font><i><font style="vertical-align: inherit;">Lüftersperre</font></i><font style="vertical-align: inherit;"> , als ganze Netzwerke mit Tausenden von Adressen unaufhaltsam aus dem Zugriff verschwanden. Es wurde klar, warum Push nicht sofort funktionierte und warum mein "Opfer" keinen Alarm auslöste, weil sie ihr Konto in den Öffnungszeiten nutzten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diejenigen, die mit Citrix Netscaler vertraut sind, stellen sich vor, dass es normalerweise so implementiert ist, dass es möglich ist, dem Benutzer nur eine Bildschnittstelle zu übermitteln, ohne ihm die Werkzeuge zum Starten von Anwendungen von Drittanbietern und zum Übertragen von Daten zu geben, wodurch Aktionen durch Standard-Control-Shells auf jede mögliche Weise eingeschränkt werden. Durch meinen Beruf bekam ich nur 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein wenig auf der 1C-Schnittstelle gelaufen war, stellte ich fest, dass es dort externe Verarbeitungsmodule gibt. </font><font style="vertical-align: inherit;">Sie können von der Schnittstelle geladen werden und werden abhängig von den Rechten und Einstellungen auf dem Client oder Server ausgeführt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich bat Freunde von 1C-Programmierern, eine solche Verarbeitung zu erstellen, die einen String benötigt und ausführt. </font><font style="vertical-align: inherit;">In 1C sieht der Start des Prozesses ungefähr so ​​aus (aus dem Internet). </font><font style="vertical-align: inherit;">Stimmen Sie zu, die Syntax der 1C-Sprache trifft eine russischsprachige Person mit ihrer Unmittelbarkeit? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Verarbeitung wurde perfekt ausgeführt, es stellte sich heraus, was Pentester die "Shell" nennen - Internet Explorer wurde dadurch gestartet.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuvor wurde die Adresse eines Systems in der E-Mail gefunden, mit der Sie Pässe für das Gebiet bestellen können. </font><font style="vertical-align: inherit;">Ich habe einen Pass bestellt, falls ich den Angriffsvektor über WLAN verwenden muss.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Internet heißt es, dass es im Büro des Kunden immer noch ein leckeres kostenloses Catering gab, aber ich habe es immer noch vorgezogen, einen Angriff über eine entfernte Site zu entwickeln, es ist ruhiger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AppLocker wurde auf dem Anwendungsserver mit Citrix aktiviert, aber umgangen. </font><font style="vertical-align: inherit;">Derselbe Meterpreter wurde über DNS geladen und gestartet, da die http (s) -Versionen keine Verbindung herstellen wollten und ich die interne Proxy-Adresse damals nicht kannte. </font><font style="vertical-align: inherit;">Übrigens verwandelte sich von diesem Moment an der äußere Pentest im Wesentlichen in den inneren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil 4. Administratorrechte für Benutzer - das ist schlecht, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was ein Pentester tut, wenn er die Kontrolle über die Sitzung eines Domänenbenutzers übernimmt, ist, alle Informationen über die Rechte in der Domäne zu sammeln. </font><font style="vertical-align: inherit;">Es gibt ein solches Dienstprogramm BloodHound, mit dem Sie automatisch Informationen über Benutzer, Computer, Sicherheitsgruppen über das LDAP-Protokoll vom Domänencontroller herunterladen und Informationen darüber, welcher Benutzer sich kürzlich angemeldet hat und wer der lokale Administrator über SMB ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine typische Technik zum Erfassen von Domänenadministratorrechten sieht vereinfacht aus wie ein Zyklus monotoner Aktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir gehen zu Domänencomputern, auf denen lokale Administratorrechte vorhanden sind, basierend auf bereits erfassten Domänenkonten.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"End of Cycle", wie 1C-Programmierer hier schreiben würden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass unser Benutzer ein lokaler Administrator auf nur einem Host mit Windows 7 war, dessen Name das Wort "VDI" oder "Virtual Desktop Infrastructure" (persönliche virtuelle Maschinen) war. </font><font style="vertical-align: inherit;">Wahrscheinlich hat der Entwickler des VDI-Dienstes impliziert, dass der Benutzer, da VDI das persönliche Betriebssystem des Benutzers ist, die Softwareumgebung nach Belieben ändern kann, der Host jedoch trotzdem "neu geladen" werden kann. </font><font style="vertical-align: inherit;">Ich dachte auch, dass die Idee im Allgemeinen gut ist. Ich ging zu diesem persönlichen VDI-Host und machte dort einen Socket:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe dort den OpenVPN-Client installiert, der einen Tunnel über das Internet zu meinem Server hergestellt hat. </font><font style="vertical-align: inherit;">Der Client musste mit der Domänenauthentifizierung durch den Blue Coat kommen, aber OpenVPN kam, wie es heißt, sofort fertig.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installiert auf VDI OpenSSH. </font><font style="vertical-align: inherit;">Was ist Windows 7 ohne SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sah es lebendig aus. </font><font style="vertical-align: inherit;">Ich erinnere Sie daran, dass dies alles über Citrix und 1C erfolgen muss:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der Techniken zur Förderung des Zugriffs auf benachbarte Computer besteht darin, die Kennwörter lokaler Administratoren auf Übereinstimmung zu überprüfen. </font><font style="vertical-align: inherit;">Hier wartete das Glück sofort: Der NTLM-Hash des lokalen Standardadministrators (der plötzlich als Administrator bezeichnet wurde) näherte sich durch den Pass-the-Hash-Angriff benachbarten VDI-Hosts, von denen es mehrere hundert gab. </font><font style="vertical-align: inherit;">Natürlich ging der Angriff sofort über sie hinweg.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann haben sich die VDI-Administratoren zweimal in den Fuß geschossen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das erste Mal, dass VDI-Computer von LAPS nicht in Betrieb genommen wurden, wurde im Wesentlichen dasselbe lokale Administratorkennwort aus einem Image gespeichert, das massiv für VDI bereitgestellt wurde.</font></font></li>
<li>   —   ,    pass-the-hash .          ,         ,   — .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum SSH-Dienst unter Windows? Ganz einfach: Jetzt bot der OpenSSH-Server nicht nur eine praktische interaktive Befehlsshell, ohne die Arbeit des Benutzers zu beeinträchtigen, sondern auch einen socks5-Proxy auf VDI. Über diese Socken stellte ich eine Verbindung über SMB her, sammelte zwischengespeicherte Konten von all diesen Hunderten von VDI-Computern und suchte dann in den BloodHound-Diagrammen nach dem Pfad zum Domänenadministrator. Mit Hunderten von Gastgebern, die mir zur Verfügung standen, fand ich diesen Weg ziemlich schnell. Domänenadministratorrechte wurden erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein Bild aus dem Internet, das eine ähnliche Suche zeigt. Die Links zeigen, wer der Administrator ist und wer wo eingegeben hat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie übrigens an die Bedingung von Beginn des Projekts an: "Wenden Sie kein Social Engineering an." </font><font style="vertical-align: inherit;">Also schlage ich vor, darüber nachzudenken, wie viel dieser ganze Bollywood mit Spezialeffekten abgeschnitten würde, wenn man trotzdem banales Phishing anwenden könnte. </font><font style="vertical-align: inherit;">Aber ich persönlich war sehr daran interessiert. </font><font style="vertical-align: inherit;">Ich hoffe, Sie waren daran interessiert, dies zu lesen. </font><font style="vertical-align: inherit;">Natürlich sieht nicht jedes Projekt so faszinierend aus, aber die Arbeit insgesamt ist sehr rätselhaft und stagniert nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wahrscheinlich wird jemand eine Frage haben: Wie kann man sich schützen? </font><font style="vertical-align: inherit;">Selbst in diesem Artikel werden viele Techniken beschrieben, von denen Windows-Administratoren nicht einmal viele kennen. </font><font style="vertical-align: inherit;">Ich schlage jedoch vor, sie aus der Perspektive abgedroschener Prinzipien und Maßnahmen der Informationssicherheit zu betrachten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden Sie keine veraltete Software (erinnern Sie sich an Windows 2003 am Anfang?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie nicht unnötige Systeme eingeschaltet (warum war der Standort des Urologen?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Überprüfen Sie die Benutzerpasswörter selbst auf Stärke (andernfalls tun </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soldaten ...</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pentester </font><font style="vertical-align: inherit;">dies </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haben Sie nicht die gleichen Passwörter für verschiedene Konten (VDI-Kompromiss)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usw</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich ist die Implementierung sehr schwierig, aber im nächsten Artikel werden wir in der Praxis zeigen, dass dies durchaus möglich ist.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496702/index.html">PCI Express in FPGAs der Intel V-Serie: Schnittstellengrundlagen und Hardware-Kernfunktionen</a></li>
<li><a href="../de496704/index.html">Leiterplatte der Saturn-5-Rakete - Reverse Engineering mit Erläuterungen</a></li>
<li><a href="../de496706/index.html">Wochenendlesung: Eine Geschichte der Audioformate - Das Zeitalter der Kassetten und die Entwicklung von Sprachsynthesetechnologien</a></li>
<li><a href="../de496708/index.html">Raumkanone, Dampfrakete und Orbitalspiegel</a></li>
<li><a href="../de496710/index.html">Computerinformationen: Einfach und schnell</a></li>
<li><a href="../de496714/index.html">Power Automate VS Logic Apps. allgemeine Informationen</a></li>
<li><a href="../de496716/index.html">Power Automate VS Logic Apps. Power Automate-Fälle</a></li>
<li><a href="../de496720/index.html">LLHD-Projekt - Universal Hardware Description Language</a></li>
<li><a href="../de496722/index.html">Tinkov API. Investition. Erste Schritte</a></li>
<li><a href="../de496726/index.html">Gent nach unten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>