<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ñ üó£Ô∏è üë° Wie haben wir den Kern des auf Tarantool basierenden Investmentgesch√§fts der Alfa-Bank abgewickelt? üßìüèº üî≥ üò¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eine Aufnahme aus dem Film ‚ÄûUnser geheimes Universum: Das verborgene Leben der Zelle‚Äú Das
 
 Investmentgesch√§ft ist einer der schwierigsten Bereiche i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wie haben wir den Kern des auf Tarantool basierenden Investmentgesch√§fts der Alfa-Bank abgewickelt?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/495326/"><img src="https://habrastorage.org/webt/tc/or/26/tcor26cmqrsph9b0nioj_ic4cwa.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Aufnahme aus dem Film ‚ÄûUnser geheimes Universum: Das verborgene Leben der Zelle‚Äú Das</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Investmentgesch√§ft ist einer der schwierigsten Bereiche in der Bankenwelt, da es nicht nur Kredite, Kredite und Einlagen gibt, sondern auch Wertpapiere, W√§hrungen, Waren, Derivate und alle m√∂glichen Schwierigkeiten in Form von Strukturprodukten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In letzter Zeit hat die Finanzkompetenz der Bev√∂lkerung zugenommen. Immer mehr Menschen sind am Handel an den Wertpapierm√§rkten beteiligt. Einzelne Anlagekonten sind vor nicht allzu langer Zeit erschienen. Sie erm√∂glichen es Ihnen, an den Wertpapierm√§rkten zu handeln und gleichzeitig entweder Steuerabz√ºge zu erhalten oder keine Steuern zu zahlen. Und alle Kunden, die zu uns kommen, m√∂chten ihr Portfolio verwalten und Echtzeitberichte anzeigen. Dar√ºber hinaus besteht dieses Portfolio meist aus mehreren Produkten, dh Menschen sind Kunden verschiedener Gesch√§ftsbereiche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus steigen die Anforderungen der russischen und ausl√§ndischen Regulierungsbeh√∂rden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den aktuellen Anforderungen gerecht zu werden und den Grundstein f√ºr zuk√ºnftige Upgrades zu legen, haben wir den Kern des Investmentgesch√§fts auf Basis von Tarantool entwickelt.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige Statistiken. </font><font style="vertical-align: inherit;">Das Investmentgesch√§ft der Alfa-Bank bietet Maklerdienstleistungen f√ºr Einzelpersonen und juristische Personen, die die M√∂glichkeit bieten, auf verschiedenen Wertpapierm√§rkten zu handeln, Verwahrungsdienste f√ºr die Lagerung von Wertpapieren, Treuhandverwaltungsdienste f√ºr Einzelpersonen mit privatem und gro√üem Kapital sowie Wertpapieremissionsdienste f√ºr andere Unternehmen. </font><font style="vertical-align: inherit;">Das Investmentgesch√§ft der Alfa-Bank umfasst mehr als 3.000 Quotes pro Sekunde, die von verschiedenen Handelsplattformen heruntergeladen werden. </font><font style="vertical-align: inherit;">W√§hrend des Arbeitstages werden im Auftrag der Bank oder ihrer Kunden mehr als 300.000 Transaktionen auf den M√§rkten abgeschlossen. </font><font style="vertical-align: inherit;">Auf externen und internen Plattformen werden bis zu 5.000 Auftr√§ge pro Sekunde ausgef√ºhrt. </font><font style="vertical-align: inherit;">Gleichzeitig m√∂chten alle internen und externen Kunden ihre Positionen in Echtzeit sehen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Irgendwann seit Anfang der 2000er Jahre haben sich unsere Bereiche des Investmentgesch√§fts unabh√§ngig voneinander entwickelt: B√∂rsenhandel, Maklerdienstleistungen, Devisenhandel, au√üerb√∂rslicher Handel mit Wertpapieren und verschiedenen Derivaten. Infolgedessen sind wir in die Falle funktioneller Brunnen geraten. Was ist das? Jeder Gesch√§ftsbereich verf√ºgt √ºber eigene Systeme, die die Funktionen des jeweils anderen duplizieren. Jedes System verf√ºgt √ºber ein eigenes Datenmodell, obwohl es nach denselben Konzepten arbeitet: Transaktionen, Instrumente, Gegenparteien, Quotes und mehr. Und da sich jedes System unabh√§ngig entwickelte, entstand ein vielf√§ltiger Zoo von Technologien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus ist die Codebasis von Systemen bereits veraltet, da einige Produkte Mitte der neunziger Jahre entstanden sind. In einigen Bereichen wurde der Entwicklungsprozess verlangsamt, und es gab Probleme mit der Produktivit√§t.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neue L√∂sungsanforderungen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Unternehmen erkannte, dass die technologische Entwicklung f√ºr die weitere Entwicklung von entscheidender Bedeutung ist. </font><font style="vertical-align: inherit;">Uns wurden die Aufgaben zugewiesen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sammeln Sie alle Gesch√§ftsdaten in einem einzigen schnellen Speicher und in einem einzigen Datenmodell. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir d√ºrfen diese Informationen nicht verlieren oder √§ndern. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Daten m√ºssen versioniert werden, da die Regulierungsbeh√∂rde jederzeit Statistiken f√ºr fr√ºhere Jahre anfordern kann. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sollten nicht nur ein neues, modisches DBMS mitbringen, sondern eine Plattform zur L√∂sung von Gesch√§ftsproblemen schaffen. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus legen unsere Architekten ihre Bedingungen fest: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die neue L√∂sung sollte Enterprise-Klasse sein, dh sie sollte bereits in einigen gro√üen Unternehmen getestet werden. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Funktionsweise der L√∂sung muss gesch√§ftskritisch sein. </font><font style="vertical-align: inherit;">Dies bedeutet, dass wir gleichzeitig in mehreren Rechenzentren pr√§sent sein und ruhig die Trennung eines Rechenzentrums erleben m√ºssen.</font></font></li>
<li>    .   ,        ,       -    .   ,         . </li>
<li>    ,     . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gingen den Standardweg: formulierten Anforderungen und kontaktierten die Beschaffungsabteilung. Von dort haben wir eine Liste von Unternehmen erhalten, die im Allgemeinen dazu bereit sind. Sie erz√§hlten allen von der Aufgabe und sechs von ihnen erhielten eine Bewertung der L√∂sungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir bei der Bank glauben niemandem, wir lieben es, alles selbst zu testen. Voraussetzung f√ºr unseren Ausschreibungswettbewerb war daher das Bestehen von Stresstests. Wir haben Testaufgaben f√ºr die Last formuliert, und bereits drei von sechs Unternehmen haben auf eigene Kosten vereinbart, einen Prototyp der L√∂sung zu implementieren, der auf In-Memory-Technologien basiert, um sie zu testen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde nicht sagen, wie wir alles getestet haben und wie lange es gedauert hat. Ich fasse nur zusammen: Die beste Leistung bei Lasttests zeigte der Prototyp der Tarantool-basierten L√∂sung des Entwicklungsteams der Mail.ru Group. </font><font style="vertical-align: inherit;">Wir haben einen Vertrag unterschrieben und mit der Entwicklung begonnen. </font><font style="vertical-align: inherit;">Vier Mitarbeiter waren von der Mail.ru Group, und von der Alfa-Bank gab es drei Entwickler, drei Systemanalysten, einen L√∂sungsarchitekten, einen Product Owner und einen Scrum Master. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als n√§chstes werde ich dar√ºber sprechen, wie unser System gewachsen ist, wie es sich entwickelt hat, was wir getan haben und warum.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst haben wir uns gefragt, wie wir Daten von unseren aktuellen Systemen erhalten k√∂nnen. Wir haben entschieden, dass HTTP f√ºr uns gut geeignet ist, da alle aktuellen Systeme miteinander kommunizieren und XML oder JSON √ºber HTTP senden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verwenden den integrierten Tarantool-HTTP-Server, da wir keine SSL-Sitzungen beenden m√ºssen und die Leistung f√ºr uns ausreicht.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie ich bereits sagte, leben alle Systeme in unterschiedlichen Datenmodellen, und bei der Eingabe m√ºssen wir das Objekt zu dem Modell bringen, das wir zu Hause beschreiben werden. Eine Sprache wurde ben√∂tigt, um Daten zu transformieren. Wir haben den Imperativ Lua gew√§hlt. Wir f√ºhren den gesamten Code f√ºr die Datenkonvertierung in der Sandbox aus - dies ist ein sicherer Ort, √ºber den der laufende Code nicht hinausgeht. F√ºhren Sie dazu einfach einen Loadstring des erforderlichen Codes durch und erstellen Sie eine Umgebung mit Funktionen, die nichts blockieren oder l√∂schen k√∂nnen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e3/04c/45f/4e304c45ff56974d624be577ebb8258d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der Konvertierung m√ºssen die Daten auf √úbereinstimmung mit dem von uns erstellten Modell √ºberpr√ºft werden. </font><font style="vertical-align: inherit;">Wir haben lange dar√ºber diskutiert, was ein Modell sein sollte, mit welcher Sprache es beschrieben werden soll. </font><font style="vertical-align: inherit;">Wir haben bei Apache Avro angehalten, weil die Sprache einfach ist und von Tarantool unterst√ºtzt wird. </font><font style="vertical-align: inherit;">Neue Versionen des Modells und des Benutzercodes k√∂nnen mehrmals t√§glich in Betrieb genommen werden, auch unter Last, auch ohne, zu jeder Tageszeit, und sich sehr schnell an √Ñnderungen anpassen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d28/172/bea/d28172beab19e37ef1fd30597d21d321.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der √úberpr√ºfung m√ºssen die Daten gespeichert werden. </font><font style="vertical-align: inherit;">Wir machen das mit vshard (wir haben Geodaten-Repliken von Shards).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5a/619/7b4/d5a6197b44b2d8f1f43b33004241f221.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus sind die Besonderheiten so, dass es f√ºr die meisten Systeme, die uns Daten senden, keine Rolle spielt, ob wir sie erhalten haben oder nicht. Deshalb haben wir von Anfang an die Reparaturlinie implementiert. Was ist das? Wenn das Objekt aus irgendeinem Grund die Datentransformation oder -√ºberpr√ºfung nicht bestanden hat, best√§tigen wir den Empfang weiterhin, speichern das Objekt jedoch gleichzeitig in der Reparaturwarteschlange. Es ist konsistent und befindet sich im Haupt-Repository mit Gesch√§ftsdaten. Wir haben sofort eine Admin-Oberfl√§che daf√ºr geschrieben, verschiedene Metriken und Warnungen. Dadurch verlieren wir keine Daten. Selbst wenn sich etwas in der Quelle ge√§ndert hat, wenn sich das Datenmodell ge√§ndert hat, werden wir es sofort finden und k√∂nnen es anpassen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7ad/2a7/c23/7ad2a7c235467068ccec89b9eb025b12.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt m√ºssen Sie lernen, wie Sie gespeicherte Daten abrufen. Wir haben unsere Systeme sorgf√§ltig analysiert und festgestellt, dass es auf dem klassischen Stack von Java und Oracle immer eine Art ORM gibt, das Daten von einer relationalen Ansicht in eine Objektansicht konvertiert. Warum also nicht sofort Objekte in Form eines Graphen an Systeme weitergeben? Deshalb haben wir gerne GraphQL genommen, das alle unsere Anforderungen erf√ºllt. Sie k√∂nnen damit Daten in Form von Diagrammen empfangen und nur das herausholen, was Sie gerade ben√∂tigen. Sie k√∂nnen die API sogar mit ausreichender Flexibilit√§t versionieren.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d90/636/a7a/d90636a7ac34c91eefd299a88d902d44.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast sofort stellten wir fest, dass die extrahierten Daten f√ºr uns nicht ausreichten. </font><font style="vertical-align: inherit;">Wir haben Funktionen erstellt, die an Objekte im Modell angeh√§ngt werden k√∂nnen - tats√§chlich berechnete Felder. </font><font style="vertical-align: inherit;">Das hei√üt, wir f√ºgen dem Feld eine bestimmte Funktion hinzu, die beispielsweise den Durchschnittspreis eines Angebots ber√ºcksichtigt. </font><font style="vertical-align: inherit;">Und der externe Verbraucher, der die Daten anfordert, wei√ü nicht einmal, dass dieses Feld berechnet wird.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f77/51f/ce9/f7751fce9a424fa80aba0c701cb9295e.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementierte ein Authentifizierungssystem. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/768/d24/2f7/768d242f7825460594a79ff0c3e07449.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann bemerkten sie, dass in unserer L√∂sung mehrere Rollen kristallisierten. </font><font style="vertical-align: inherit;">Eine Rolle ist eine Art Aggregator von Funktionen. </font><font style="vertical-align: inherit;">Rollen haben in der Regel unterschiedliche Nutzungsprofile:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T-Connect: verarbeitet eingehende Verbindungen, die vom Prozessor begrenzt werden, verbraucht wenig Speicher und speichert den Status nicht.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IB-Core: transformiert die Daten, die es √ºber das Tarantool-Protokoll empf√§ngt, dh es arbeitet mit Tablets. </font><font style="vertical-align: inherit;">Speichert auch keinen Status und kann skaliert werden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speicher: Speichert nur Daten, verwendet keine Logik. </font><font style="vertical-align: inherit;">In dieser Rolle sind die einfachsten Schnittstellen implementiert. </font><font style="vertical-align: inherit;">Skalierbar dank vshard.</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/292/66e/613/29266e613da2a34c5df9463884873267.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das hei√üt, wir haben mithilfe von Rollen verschiedene Teile des Clusters voneinander getrennt, die unabh√§ngig voneinander skaliert werden k√∂nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher haben wir einen asynchronen Datensatz eines Transaktionsdatenstroms und eine Reparaturwarteschlange mit einer Administratorschnittstelle erstellt. </font><font style="vertical-align: inherit;">Die Aufzeichnung ist aus gesch√§ftlicher Sicht asynchron: Wenn wir garantiert Daten f√ºr uns selbst aufzeichnen, egal wo, werden wir dies best√§tigen. </font><font style="vertical-align: inherit;">Wenn nicht best√§tigt, ist ein Fehler aufgetreten. Die Daten m√ºssen gesendet werden. </font><font style="vertical-align: inherit;">Dies ist eine asynchrone Aufzeichnung.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Von Beginn des Projekts an wurde beschlossen, eine testgetriebene Entwicklung einzuf√ºhren. Wir schreiben Unit-Tests in Lua mit dem Tarantool / Tap-Framework, Integrationstests in Python mit dem Pytest-Framework. Gleichzeitig sind sowohl Entwickler als auch Analysten an der Erstellung von Integrationstests beteiligt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wenden wir testgetriebene Entwicklung an? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir eine neue Funktion w√ºnschen, versuchen wir zun√§chst, einen Test daf√ºr zu schreiben. Nachdem wir den Fehler entdeckt haben, m√ºssen wir zuerst in den Test schreiben und ihn dann beheben. Zun√§chst ist es schwierig, so zu arbeiten, es gibt ein Missverst√§ndnis seitens der Mitarbeiter, sogar Sabotage: "Lassen Sie es uns schnell beheben, etwas Neues tun und es dann mit Tests abdecken." Nur dieses "sp√§tere" tritt fast nie auf.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher m√ºssen Sie sich zuerst zwingen, Tests zu schreiben, und andere bitten, dies zu tun. Glauben Sie mir, eine testgetriebene Entwicklung ist auch kurzfristig von Vorteil. Sie werden das Gef√ºhl haben, dass es f√ºr Sie einfacher geworden ist zu leben. Nach unseren Einsch√§tzungen werden derzeit 99% des Codes durch Tests abgedeckt. Es scheint viel zu sein, aber wir haben keine Probleme: Bei jedem Commit werden Tests ausgef√ºhrt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor allem aber lieben wir Stresstests, wir halten sie f√ºr die wichtigsten und f√ºhren sie regelm√§√üig durch.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich erz√§hle Ihnen eine kurze Geschichte dar√ºber, wie wir die erste Phase des Lasttests einer der ersten Versionen durchgef√ºhrt haben. Wir haben das System auf den Laptop des Entwicklers gestellt, die Last eingeschaltet und 4.000 Transaktionen pro Sekunde empfangen. Gutes Ergebnis f√ºr einen Laptop. Wir haben einen virtuellen Laststand von vier Servern eingerichtet, der schw√§cher als in der Produktion ist. Auf ein Minimum bereitgestellt. Wir starten es und erzielen in einem Thread ein schlechteres Ergebnis als auf einem Laptop. Schockinhalt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir waren sehr traurig. Wir sehen uns die Serverlast an und sie erweisen sich als unt√§tig.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0b/eba/0fa/a0beba0fad0ba7e8f0cf333ef8366948.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir rufen die Entwickler an und sie erkl√§ren uns, die aus der Java-Welt gekommen sind, dass Tarantool Single-Threaded ist. </font><font style="vertical-align: inherit;">Es kann effektiv von nur einem Prozessorkern unter Last verwendet werden. </font><font style="vertical-align: inherit;">Dann haben wir die maximal m√∂gliche Anzahl von Tarantool-Instanzen auf jedem Server bereitgestellt, die Last eingeschaltet und bereits 14,5 Tausend Transaktionen pro Sekunde empfangen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/67f/8ca/e14/67f8cae14bea588f5018d4406f99c23c.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde es noch einmal erkl√§ren. </font><font style="vertical-align: inherit;">Aufgrund der Aufteilung in Rollen, die Ressourcen unterschiedlich verwenden, haben unsere Rollen, die f√ºr die Verarbeitung von Verbindungen und die Datentransformation verantwortlich waren, nur den Prozessor geladen und waren streng proportional zur Last.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9d1/822/cb3/9d1822cb3dcacd91f3f9fd7dbb7c9f7c.jpg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f0/566/1b4/1f05661b4e5b7806867849b060dc23b7.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus wurde der Speicher nur zur Verarbeitung eingehender Verbindungen und tempor√§rer Objekte verwendet.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/16e/e79/f9f/16ee79f9fbfd6157c7df6edd66b90535.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Gegenteil, auf Speicherservern stieg die Prozessorlast, jedoch viel langsamer als auf Servern, die Verbindungen verarbeiten. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/18b/0ad/d2d/18b0add2da6deda36388ca9b0f07594b.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und der Speicherverbrauch stieg direkt proportional zur geladenen Datenmenge. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e21/697/e05/e21697e0521f54530aa7c50227297af1.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dienstleistungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um unser neues Produkt speziell als Anwendungsplattform zu entwickeln, haben wir eine Komponente f√ºr die Bereitstellung von Diensten und Bibliotheken darauf erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Services sind nicht nur kleine Codeteile, die in einigen Bereichen ausgef√ºhrt werden. </font><font style="vertical-align: inherit;">Dies k√∂nnen sehr gro√üe und komplexe Designs sein, die Teil des Clusters sind, die Referenzdaten √ºberpr√ºfen, die Gesch√§ftslogik verdrehen und Antworten geben. </font><font style="vertical-align: inherit;">Wir exportieren das Serviceschema auch nach GraphQL, und der Verbraucher erh√§lt einen universellen Datenzugriffspunkt mit Introspektion im gesamten Modell. </font><font style="vertical-align: inherit;">Es ist sehr bequem.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da Dienste viel mehr Funktionen enthalten, haben wir beschlossen, dass es Bibliotheken geben sollte, in denen wir h√§ufig verwendeten Code herausnehmen. </font><font style="vertical-align: inherit;">Wir haben sie einer sicheren Umgebung hinzugef√ºgt, nachdem wir √ºberpr√ºft haben, dass dies f√ºr uns nichts bringt. </font><font style="vertical-align: inherit;">Und jetzt k√∂nnen wir Funktionen f√ºr zus√§tzliche Umgebungen in Form von Bibliotheken festlegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wollten, dass wir nicht nur eine Plattform f√ºr die Speicherung, sondern auch f√ºr die Datenverarbeitung haben. </font><font style="vertical-align: inherit;">Und da wir bereits eine Reihe von Replikaten und Shards hatten, haben wir einen Anschein von verteiltem Computing implementiert und es als Kartenreduzierung bezeichnet, da sich herausstellte, dass es sich um die urspr√ºngliche Kartenreduzierung handelt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alte Systeme</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nicht alle unsere alten Systeme k√∂nnen uns √ºber HTTP anrufen und GraphQL verwenden, obwohl sie dieses Protokoll unterst√ºtzen. </font><font style="vertical-align: inherit;">Aus diesem Grund haben wir einen Mechanismus zum Replizieren von Daten auf diese Systeme entwickelt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5d/6e5/e33/f5d6e5e33b10e605cf7c6c5befd4aa07.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn sich f√ºr uns etwas √§ndert, funktionieren bestimmte Ausl√∂ser in der Speicherrolle und die Nachricht mit den √Ñnderungen f√§llt in die Verarbeitungswarteschlange. </font><font style="vertical-align: inherit;">Es wird √ºber eine separate Replikatorrolle an ein externes System gesendet. </font><font style="vertical-align: inherit;">Diese Rolle speichert keinen Status.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neue Verbesserungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sich erinnern, haben wir aus gesch√§ftlicher Sicht asynchrone Aufzeichnungen gemacht. </font><font style="vertical-align: inherit;">Aber dann wurde ihnen klar, dass dies nicht ausreichen w√ºrde, da es eine Klasse von Systemen gibt, die sofort eine Antwort auf den Status der Operation erhalten m√ºssen. </font><font style="vertical-align: inherit;">Deshalb haben wir unser GraphQL erweitert und Mutationen hinzugef√ºgt. </font><font style="vertical-align: inherit;">Sie passen organisch in das bestehende Paradigma der Arbeit mit Daten. </font><font style="vertical-align: inherit;">Wir haben einen einzigen Punkt des Lesens und Schreibens f√ºr eine andere Klasse von Systemen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/395/562/ef7/395562ef7191842f4dc9526dae8c0661.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben auch festgestellt, dass Services allein f√ºr uns nicht ausreichen w√ºrden, da es ziemlich umfangreiche Berichte gibt, die einmal am Tag, in der Woche und im Monat erstellt werden m√ºssen. Dies kann lange dauern, und Berichte k√∂nnen sogar die Tarantool-Ereignisschleife blockieren. Aus diesem Grund haben wir separate Rollen erstellt: Scheduler und Runner. L√§ufer speichern den Status nicht. Sie starten schwierige Aufgaben, mit denen wir nicht im laufenden Betrieb rechnen k√∂nnen. Die Scheduler-Rolle √ºberwacht den Zeitplan f√ºr das Starten dieser Aufgaben, der in der Konfiguration beschrieben wird. Die Aufgaben selbst werden am selben Ort wie die Gesch√§ftsdaten gespeichert. Wenn der richtige Zeitpunkt gekommen ist, nimmt der Planer die Aufgabe an, gibt sie einem L√§ufer, ber√ºcksichtigt sie und speichert das Ergebnis.</font></font><br>
 <br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb1/bbf/123/fb1bbf12343d40bab27a87b5f1021f0d.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nicht alle Aufgaben m√ºssen planm√§√üig ausgef√ºhrt werden. </font><font style="vertical-align: inherit;">Einige Berichte m√ºssen auf Anfrage gelesen werden. </font><font style="vertical-align: inherit;">Sobald diese Anforderung eintrifft, wird eine Aufgabe in der Sandbox gebildet und zur Ausf√ºhrung an den L√§ufer gesendet. </font><font style="vertical-align: inherit;">Nach einer Weile erh√§lt der Benutzer asynchron eine Antwort, dass alles berechnet wurde, der Bericht ist fertig.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13f/27e/db0/13f27edb0711b735602d77c7c54c4d38.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst haben wir uns an das Paradigma gehalten, alle Daten zu speichern, zu versionieren und nicht zu l√∂schen. </font><font style="vertical-align: inherit;">Aber im Leben m√ºssen Sie von Zeit zu Zeit immer noch etwas l√∂schen, haupts√§chlich einige Roh- oder Zwischeninformationen. </font><font style="vertical-align: inherit;">Basierend auf expirationd haben wir einen Mechanismus zum Bereinigen der Speicherung veralteter Daten entwickelt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4d9/1aa/e8d/4d91aae8daf9c27437ca9ed57574e349.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verstehen auch, dass fr√ºher oder sp√§ter eine Situation eintreten wird, in der nicht gen√ºgend Speicherplatz zum Speichern von Daten im Speicher vorhanden ist, die Daten jedoch gespeichert werden m√ºssen. </font><font style="vertical-align: inherit;">Zu diesem Zweck werden wir in K√ºrze Festplattenspeicher erstellen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13a/10e/7da/13a10e7da6c77907d88504ee20fbb62c.jpg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir begannen mit der Aufgabe, Daten in ein einziges Modell zu laden, und verbrachten drei Monate mit dessen Entwicklung. Wir hatten sechs Datenanbietersysteme. Der gesamte Transformationscode in ein einzelnes Modell besteht in Lua aus etwa 30.000 Zeilen. Und der gr√∂√üte Teil der Arbeit steht noch bevor. Manchmal mangelt es den benachbarten Teams an Motivation, was die Arbeit der Umst√§nde erheblich erschwert. Wenn Sie jemals mit einem √§hnlichen Problem konfrontiert sind, multiplizieren Sie die Zeit, die Sie f√ºr normal halten, mit drei oder sogar vier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie auch daran, dass vorhandene Probleme in Gesch√§ftsprozessen nicht mit Hilfe eines neuen DBMS gel√∂st werden k√∂nnen, selbst wenn es sehr produktiv ist. Was ich meine? Zu Beginn unseres Projekts haben wir bei den Kunden den Eindruck erweckt, dass wir jetzt eine neue schnelle Datenbank bringen und leben werden! Die Prozesse werden schneller gehen, alles wird gut. Tats√§chlich l√∂st die Technologie nicht die Probleme, die in Gesch√§ftsprozessen bestehen, da Gesch√§ftsprozesse Menschen sind. Und Sie m√ºssen mit Menschen arbeiten, nicht mit Technologie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Entwicklung durch Tests in der Anfangsphase kann schmerzhaft und zeitaufw√§ndig sein. Der positive Effekt wird sich jedoch auch kurzfristig bemerkbar machen, wenn Sie nichts tun m√ºssen, um Regressionstests durchzuf√ºhren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist √§u√üerst wichtig, Lasttests in allen Entwicklungsstadien durchzuf√ºhren. Je fr√ºher Sie einen Fehler in der Architektur bemerken, desto einfacher ist es, ihn zu beheben. Dadurch sparen Sie in Zukunft viel Zeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist nichts falsch mit Lua. Jeder kann lernen, darauf zu schreiben: ein Java-Entwickler, ein JavaScript-Entwickler, ein Python-Entwickler, ein Front-End oder ein Back-End. Wir haben sogar Analysten, die dar√ºber schreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir √ºber die Tatsache sprechen, dass wir kein SQL haben, erschreckt dies die Menschen. "Wie erh√§lt man Daten ohne SQL?" Ist das m√∂glich? " Na sicher. Auf einem OLTP-Klassensystem wird SQL nicht ben√∂tigt. Es gibt eine Alternative in Form einer Sprache, die Ihnen sofort eine dokumentenorientierte Ansicht zur√ºckgibt. Zum Beispiel GraphQL. Und es gibt eine Alternative in Form von verteiltem Computing.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie verstehen, dass Sie skalieren m√ºssen, entwerfen Sie Ihre L√∂sung sofort auf Tarantool, damit sie auf Dutzenden von Tarantool-Instanzen parallel funktioniert. </font><font style="vertical-align: inherit;">Wenn Sie dies nicht tun, wird es schwierig und schmerzhaft sein, da Tarantool nur einen Prozessorkern effizient verwenden kann.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495310/index.html">Elektronischer Durchgang: Biometrie und Multiformat</a></li>
<li><a href="../de495312/index.html">Perimeter-Sicherheit - die Zukunft ist jetzt</a></li>
<li><a href="../de495314/index.html">Wie kann man Fehlinformationen filtern, wenn sie aus offiziellen Quellen stammen?</a></li>
<li><a href="../de495316/index.html">Lebensregeln des Habr Quarantine Career Teams</a></li>
<li><a href="../de495324/index.html">Schreiben eines zuf√§lligen Aktiengenerators von Mosbirzhe in JavaScript</a></li>
<li><a href="../de495328/index.html">So bereinigen Sie den Verlauf Ihrer Commits in Git</a></li>
<li><a href="../de495330/index.html">Verdiente Popularit√§t in Zahlen</a></li>
<li><a href="../de495332/index.html">Quartett 9: Allegro | Typoskript</a></li>
<li><a href="../de495336/index.html">Zwietracht als Corporate Messenger und nicht nur</a></li>
<li><a href="../de495338/index.html">Best Practices und Richtlinien zum Starten von Containern und Kubernetes in Produktionsumgebungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>