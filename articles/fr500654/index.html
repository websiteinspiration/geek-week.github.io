<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🎤 💊 🏺 WebRTC sur Android: comment activer l'encodage matériel sur plusieurs appareils 🤟 🎅 👵🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pour les appels vidéo dans Badoo, nous utilisons la norme WebRTC et le codec H.264. Si vous croyez à la documentation, ce codec devrait fonctionner sa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebRTC sur Android: comment activer l'encodage matériel sur plusieurs appareils</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/500654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les appels vidéo dans Badoo, nous utilisons la norme WebRTC et le codec H.264. </font><font style="vertical-align: inherit;">Si vous croyez à la documentation, ce codec devrait fonctionner sans problème sur n'importe quel appareil Android depuis Android 5.0. </font><font style="vertical-align: inherit;">Mais dans la pratique, tout s'est avéré ne pas l'être. </font><font style="vertical-align: inherit;">Dans cet article, je vais parler des fonctionnalités de l'implémentation du codage matériel pour le codec H.264 dans WebRTC et comment le faire fonctionner sur plus d'appareils.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tu/lt/w1/tultw1tnly1q-hovglpxdkzaax8.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi H.264?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'il est connecté via WebRTC, tous les appareils participant à la session transmettent divers paramètres de communication, y compris les codecs vidéo et audio. Si les périphériques prennent en charge plusieurs codecs (par exemple, VP8 et H.264), les codecs prioritaires pour la plate-forme sont répertoriés en premier. Ces données sont utilisées au stade de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réconciliation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans WebRTC, après quoi seuls les codecs pris en charge par tous les appareils restent. Un exemple de telles données avec décryptage peut être vu dans ce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">document</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas d'appels vidéo, si l'un des appareils ne prend pas en charge le codec H.264, les deux appareils peuvent passer, par exemple, au codec VP8, qui ne dépend pas de l'implémentation matérielle de l'appareil. </font><font style="vertical-align: inherit;">Mais notre application est disponible sur une variété de gadgets, y compris les smartphones des générations précédentes. </font><font style="vertical-align: inherit;">Par conséquent, pour les communications vidéo, nous voulions utiliser l'encodage matériel autant que possible: il réduit la charge sur le processeur et ne consomme pas beaucoup la batterie, ce qui est essentiel pour les gadgets obsolètes. </font><font style="vertical-align: inherit;">La prise en charge du codage matériel H.264 est implémentée sur un grand nombre d'appareils, contrairement au même </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VP8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge H.264 sur Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous pensez que la description de la prise en charge </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des formats multimédias</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le décodage du profil de base H.264 devrait fonctionner sur tous les appareils Android et l'encodage - à commencer par Android 3.0. Dans Badoo, nous prenons en charge les appareils commençant par Android 5.0, nous ne devrions donc pas avoir de problèmes. Mais ce n'était pas si simple: même dans les gadgets avec la cinquième version, nous avons trouvé un grand nombre de fonctionnalités. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec quoi peut-il être connecté? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, lors du développement d'un nouvel appareil sur Android, tout fabricant doit réussir la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suite de tests de compatibilité</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il fonctionne sur un PC connecté à l'appareil et ses résultats doivent être envoyés à Google pour confirmer que l'appareil répond aux exigences du système d'exploitation Android de la version spécifiée. Ce n'est qu'après que le gadget peut être mis sur le marché. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous intéressons aux tests multimédias de cette suite de tests, et plus spécifiquement aux tests d'encodage et de décodage vidéo. J'ai décidé de m'attarder sur les tests </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncodeDecodeTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DecoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car ils sont présents sur toutes les versions d'Android depuis la 4.3. Le graphique du nombre de lignes de code dans ces tests ressemble à ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/td/g_/4p/tdg_4prrdcocytay8z7df_igw0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant la version 4.3, la plupart de ces tests n'existaient tout simplement pas, et leur augmentation significative est tombée sur les versions 5 et 7. Par conséquent, nous pouvons dire qu'avant la version Android 4.3, Google ne vérifiait pas la conformité des appareils avec ses spécifications d'encodage et de décodage vidéo, mais en version 5.0 a grandement amélioré cette vérification. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait que cela indique qu'à partir de la version 5.0 avec encodage, tout devrait être en ordre. Mais, compte tenu de mon expérience précédente avec le décodage de vidéos en streaming sur Android, j'étais sûr que ce n'était pas le cas. Il suffisait de regarder le nombre de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le codage dans le groupe Google </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discuter-webrtc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fichiers source WebRTC, qui sont dans le domaine public, nous ont aidés à rechercher les pièges. Examinons-les plus en détail.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge H.264 dans WebRTC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HardwareVideoEncoderFactory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une méthode avec le nom parlant isHardwareSupportedInCurrentSdkH264:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHardwareSupportedInCurrentSdkH264</span><span class="hljs-params">(MediaCodecInfo info)</span> </span>{
  <span class="hljs-comment">// First, H264 hardware might perform poorly on this model.</span>
  <span class="hljs-keyword">if</span> (H264_HW_EXCEPTION_MODELS.contains(Build.MODEL)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
  }<font></font>
  String name = info.getName();<font></font>
  <span class="hljs-comment">// QCOM H264 encoder is supported in KITKAT or later.</span>
  <span class="hljs-keyword">return</span> (name.startsWith(QCOM_PREFIX) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)
      <span class="hljs-comment">// Exynos H264 encoder is supported in LOLLIPOP or later.</span><font></font>
      || (name.startsWith(EXYNOS_PREFIX)<font></font>
             &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous pouvons le voir, la prise en charge du codage matériel sur Android n'est implémentée que pour les chipsets Qualcomm et Exynos. Pourquoi les autres chipsets ne sont-ils pas pris en charge dans l'implémentation WebRTC standard? Cela est probablement dû aux particularités de la mise en œuvre des fabricants de codecs matériels. Et il est souvent possible d'identifier ces fonctionnalités uniquement en production, car il n'est pas toujours possible de trouver des appareils particuliers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les descriptions de codec sur l'appareil sont stockées dans le fichier media_codecs.xml. Voici, par exemple, ce fichier pour le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pixel XL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et pour le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HUAWEI P8 lite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Lorsque vous obtenez une liste de codecs à l'aide de la méthode getCodecInfos () de l'objet MediaCodecList, ce fichier est analysé - et les codecs qui y sont stockés sont retournés. Cette opération et le remplissage correct de ce fichier par le constructeur sont couverts par le test CTS.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecListTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est également passé de 160 lignes de code dans Android 4.3 à 740 lignes dans Android 10. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Badoo, nous avons changé le code de méthode isHardwareSupportedInCurrentSdkH264, rejetant la liste de codecs «blanche» et la remplaçant par une liste «noire» de préfixes de codec de programme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">répertoriés</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans WebRTC:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] SOFTWARE_IMPLEMENTATION_PREFIXES = {<span class="hljs-string">"OMX.google."</span>, <span class="hljs-string">"OMX.SEC."</span>};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais vous ne pouvez pas simplement prendre et implémenter la prise en charge de tous les codecs sans prêter attention aux fonctionnalités des fabricants. </font><font style="vertical-align: inherit;">D'après les noms des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consacrés au codage matériel sur Android dans le groupe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discuter-webrtc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous pouvons comprendre que dans ce cas, nous rencontrerons certainement des erreurs. </font><font style="vertical-align: inherit;">Fondamentalement, ils apparaissent au stade de la configuration du codec.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Options de configuration du codec</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'initialisation du codec pour l'encodage est la suivante:</font></font><br>
<br>
<pre><code class="java hljs">MediaCodec mediaCodec = createByCodecName(codecName);<font></font>
MediaFormat format = MediaFormat.createVideoFormat(mime, width, height);<font></font>
format.setInteger(MediaFormat.KEY_BIT_RATE, targetBitrateBps);<font></font>
format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateConstant);<font></font>
format.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);<font></font>
format.setInteger(MediaFormat.KEY_FRAME_RATE, targetFps);<font></font>
format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, keyFrameIntervalSec);<font></font>
mediaCodec.configure(format, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est facile de faire une erreur dans certains de ces paramètres, ce qui lèvera une exception lors de la configuration du codec et perturbera l'application. </font><font style="vertical-align: inherit;">De plus, lorsque vous travaillez avec un codec, vous devrez peut-être ajuster son débit binaire en fonction de divers facteurs, car le codec lui-même le fait mal. </font><font style="vertical-align: inherit;">Pour cela, dans WebRTC, la classe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">responsable</font></a><font style="vertical-align: inherit;"> , qui a deux descendants:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DynamicBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ajuste le débit en fonction de la quantité de données</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramerateBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ajuste le débit en fonction de la fréquence d'images.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, pour chaque codec, vous devez choisir votre propre mécanisme de réglage du débit binaire. </font><font style="vertical-align: inherit;">Examinons plus en détail les fonctionnalités de définition des paramètres d'initialisation pour les codecs matériels.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résolution de flux</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir reçu l'objet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecInfo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour le codec, </font><font style="vertical-align: inherit;">vous pouvez examiner le codec plus en détail en obtenant ses capacités dans la classe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CodecCapabilities</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">À partir d'eux, vous pouvez savoir si le codec prend en charge la résolution et la fréquence d'images sélectionnées. </font><font style="vertical-align: inherit;">S'il prend en charge ces paramètres, ils peuvent être définis en toute sécurité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, parfois cette règle ne fonctionne pas. </font><font style="vertical-align: inherit;">Nous sommes confrontés au fait que les codecs avec le préfixe «OMX.MARVELL». </font><font style="vertical-align: inherit;">encodé incorrectement, montrant des bandes vertes sur les bords de l'écran si la résolution du flux était différente de 4: 3. </font><font style="vertical-align: inherit;">Dans le même temps, le codec lui-même a affirmé que la résolution et la fréquence d'images sélectionnées étaient prises en charge.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mode débit binaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mode standard pour tous les codecs vidéo est un débit binaire constant. </font><font style="vertical-align: inherit;">Cependant, une fois que nous devions utiliser un débit binaire variable:</font></font><br>
<br>
<pre><code class="java hljs">format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateVariable);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela s'est produit sur un appareil Lenovo A1000 avec le chipset Spreadtrum (maintenant Unisoc) commençant par le préfixe «OMX.sprd». </font><font style="vertical-align: inherit;">Une recherche sur Internet nous a </font><font style="vertical-align: inherit;">conduit à un </font><font style="vertical-align: inherit;">enfant de </font><font style="vertical-align: inherit;">six ans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">après</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur Firefox OS qui décrit ce problème et comment le </font><font style="vertical-align: inherit;">résoudre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Format de couleur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous utilisez le codec en mode tampon d'octets, vous devez sélectionner le format correct. </font><font style="vertical-align: inherit;">Cela se fait généralement en utilisant une fonction de la forme suivante:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Nullable</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> Integer <span class="hljs-title">selectColorFormat</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] supportedColorFormats, CodecCapabilities capabilities)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> supportedColorFormat : supportedColorFormats) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> codecColorFormat : capabilities.colorFormats) {
      <span class="hljs-keyword">if</span> (codecColorFormat == supportedColorFormat) {
        <span class="hljs-keyword">return</span> codecColorFormat;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En gros, le premier des formats de couleurs pris en charge est toujours sélectionné. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, dans le cas des codecs HUAWEI commençant par les préfixes "OMX.IMG.TOPAZ.", "OMX.hisi". </font><font style="vertical-align: inherit;">et "OMX.k3.", cela n'a pas fonctionné, et après une longue recherche, nous avons trouvé une solution: quel que soit le format retourné par ces codecs, vous devez utiliser le format </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLOR_FormatYUV420SemiPlanar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fil</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous a aidés à </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;">comprendre cela</font></a><font style="vertical-align: inherit;"> dans un forum chinois.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réglage du débit binaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code WebRTC standard contient les éléments </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suivants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> BitrateAdjuster <span class="hljs-title">createBitrateAdjuster</span><span class="hljs-params">(VideoCodecMimeType type, String codecName)</span> </span>{
  <span class="hljs-keyword">if</span> (codecName.startsWith(EXYNOS_PREFIX)) {
    <span class="hljs-keyword">if</span> (type == VideoCodecMimeType.VP8) {
        <span class="hljs-comment">// Exynos VP8 encoders need dynamic bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DynamicBitrateAdjuster();<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Exynos VP9 and H264 encoders need framerate-based bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FramerateBitrateAdjuster();<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">// Other codecs don't need bitrate adjustment.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseBitrateAdjuster();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir dans ce code, pour tous les chipsets sauf Exynos, le réglage du débit binaire est désactivé. Mais cela ne s'applique qu'à Qualcomm, car seuls Exynos et Qualcomm sont pris en charge dans le code standard. L'expérimentation de diverses valeurs de ce paramètre, ainsi que la recherche sur Internet, nous avons découvert que pour les codecs avec préfixes «OMX.MTK». il doit également être activé. Il est également nécessaire de le faire pour les codecs HUAWEI commençant par le préfixe "OMX.IMG.TOPAZ.", "OMX.hisi". ou "OMX.k3". Cela est dû au fait que ces codecs n'utilisent pas d'horodatage des trames pour ajuster le débit binaire, en supposant que toutes les trames sont livrées avec le même ensemble de fréquences lors de la configuration du codec.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusion, je vais donner une liste des codecs que nous avons reçus pour les appareils sur Android 5.0 et 5.1. </font><font style="vertical-align: inherit;">Ils nous intéressaient principalement parce que sur les nouvelles versions d'Android, la situation s'améliore et les codecs non standard deviennent plus petits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut être vu dans le graphique ci-dessous. </font><font style="vertical-align: inherit;">L'échelle logarithmique pour mieux montrer les cas rares. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/ng/ws/lengwsark1w8mgc0jmg95pptv_k.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous pouvons le voir, la plupart des appareils avaient des chipsets Spreadtrum, MediaTek, HUAWEI et MARVELL - par conséquent, nos modifications ont permis d'activer l'encodage matériel sur ces gadgets.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que nous pensions que certains appareils auraient des problèmes de fonctionnement avec H.264, Android a de nouveau pu nous surprendre. Comme nous pouvons le voir dans les statistiques des utilisateurs de Badoo, il y a encore beaucoup d'appareils entre les mains des utilisateurs en 2014-2016, qu'ils ne veulent pas ou ne peuvent pas mettre à jour. Et bien que la situation avec la sortie des mises à jour Android pour les nouveaux appareils soit déjà bien meilleure qu'il y a quelques années, la part des gadgets de la génération précédente diminue assez lentement et devra être maintenue pendant un certain temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant WebRTC est activement développé par Google en raison de son utilisation dans le projet Stadia (voici la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vidéo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec des détails sur ce sujet), il deviendra donc de mieux en mieux et, très probablement, deviendra la norme pour la mise en œuvre des communications vidéo. </font><font style="vertical-align: inherit;">J'espère que cet article vous aidera à comprendre les fonctionnalités de l'utilisation de H.264 dans WebRTC et à l'utiliser dans vos projets.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500640/index.html">Comment faire une entreprise d'externalisation réussie</a></li>
<li><a href="../fr500642/index.html">Igrostroy: seuil d'entrée dans l'industrie, spécialités et revenus possibles</a></li>
<li><a href="../fr500644/index.html">Random Coffee Habr Edition - réseautage pour la communauté informatique</a></li>
<li><a href="../fr500646/index.html">Bytecode de cuisson dans la cuisine JVM</a></li>
<li><a href="../fr500648/index.html">Qu'est-ce qu'un modèle architectural de maturité d'entreprise?</a></li>
<li><a href="../fr500656/index.html">Journalisation hiérarchique de l'application dans la base de données</a></li>
<li><a href="../fr500660/index.html">Une histoire simplifiée et très courte du développement des "nuages"</a></li>
<li><a href="../fr500666/index.html">Certification en ligne Microsoft - vous, votre espace et votre ordinateur</a></li>
<li><a href="../fr500668/index.html">Commande de moteur sans fil de Lego à l'aide de Steam Controller</a></li>
<li><a href="../fr500670/index.html">Comment nous créons notre produit. Première partie, Recherche</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>