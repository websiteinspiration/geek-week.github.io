<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤲🏿 ❕ 🤮 Project Loom: Java Virtual Threads sind geschlossen 🤧 🔞 👨‍👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einigen Tagen brachte Ron Pressler in State of Loom einen Artikel zur Welt , den nur der faulste Javist nicht finden konnte. Der Artikel ist wirkl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Project Loom: Java Virtual Threads sind geschlossen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503412/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vor einigen Tagen brachte Ron Pressler in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State of Loom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einen Artikel zur Welt </font><font style="vertical-align: inherit;">, den nur der faulste Javist nicht finden konnte. </font><font style="vertical-align: inherit;">Der Artikel ist wirklich gut, es gibt viele interessante Metaphern, die ich jetzt ohne Bezugnahme auf die Quelle schamlos verwenden möchte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich für meinen Teil habe mir versehentlich erlaubt, etwas Skepsis auszudrücken, aber wenn mit diesem Projekt Loom endlich wirklich gearbeitet werden kann. </font><font style="vertical-align: inherit;">Buchstäblich eine Stunde später kam eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antwort von Ron selbst - "und du versuchst es!" </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nun, ich musste es versuchen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was war für das Experiment erforderlich:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDK15 einschließlich Project Loom</font></font></a> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminal, da IntelliJ und Gradle sich rundweg weigerten, mit einem solchen Spiel zu arbeiten</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst habe ich mich entschlossen, mir anzusehen, wie ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klassisches Beispiel mit Streams aus der Dokumentation für Kotlin Coroutine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aussehen würde </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das Beispiel ist in Kotlin geschrieben, aber das Umschreiben in Java ist nicht schwierig:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        <span class="hljs-keyword">var</span> c = <span class="hljs-keyword">new</span> AtomicLong();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {<font></font>
                c.incrementAndGet();<font></font>
            }).start();<font></font>
        }<font></font>
<font></font>
        System.out.println(c.get());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir beginnen und stellen sicher, dass das Beispiel nach wie vor hängt:</font></font><br>
<br>
<pre><code class="bash hljs">javac Main.java &amp;&amp; java Main
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schreiben Sie nun das Beispiel mit den virtuellen Threads neu, die Project Loom uns zur Verfügung stellt:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {<font></font>
    Thread.startVirtualThread(() -&gt; {<font></font>
        c.incrementAndGet();<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis lässt nicht lange auf sich warten:</font></font><br>
<br>
<pre><code class="bash hljs">1000000
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie lang?</font></font></b>
                        <div class="spoiler_text">     ,    . <br>
-,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">Gil Tene,   —    </a>. <br>
-,       Project Loom,     . ,     —  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber an sich hat es mich nicht allzu sehr beeindruckt. </font><font style="vertical-align: inherit;">Am Ende wird mit Coroutinen in Kotlin das gleiche Ergebnis leicht erzielt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ron bemerkt in seinem Artikel richtig, dass Kotlin die delay () -Funktion einführen musste, die es der Coroutine ermöglicht, einzuschlafen, da Thread.sleep () die aktuelle Coroutine nicht in den Ruhezustand versetzt, sondern den aktuellen Scheduler-Thread, der normalerweise nicht viele ist, normalerweise nach Menge Zentralprozessor </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist mit Project Loom?</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {<font></font>
  Thread.startVirtualThread(() -&gt; {<font></font>
    c.incrementAndGet();<font></font>
    <span class="hljs-keyword">try</span> {<font></font>
        Thread.sleep(<span class="hljs-number">1_000</span>);<font></font>
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<font></font>
        e.printStackTrace();<font></font>
    }<font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ergebnis:</font></font><br>
<br>
<pre><code class="bash hljs">- 400K
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist aber schon interessant! </font><font style="vertical-align: inherit;">Mit Project Loom kann der Aufruf von Thread.sleep () unterscheiden, ob es sich um einen regulären Thread oder einen virtuellen Thread handelt, und es funktioniert anders. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das an sich ist sehr cool. </font><font style="vertical-align: inherit;">Aber lassen Sie uns etwas tiefer graben:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> threads = <span class="hljs-keyword">new</span> ArrayList&lt;Thread&gt;();
<span class="hljs-keyword">var</span> cores = <span class="hljs-number">10</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
    <span class="hljs-keyword">var</span> t = Thread.startVirtualThread(() -&gt; {
        <span class="hljs-keyword">var</span> bestUUID = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1_000_000</span>; j++) {
            <span class="hljs-keyword">var</span> currentUUID = UUID.randomUUID().toString();
            <span class="hljs-keyword">if</span> (currentUUID.compareTo(bestUUID) &gt; <span class="hljs-number">0</span>) {<font></font>
                bestUUID = currentUUID;<font></font>
            }<font></font>
        }<font></font>
        System.out.println(<span class="hljs-string">"Best slow UUID is "</span> + bestUUID);<font></font>
    });<font></font>
    threads.add(t);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
    <span class="hljs-keyword">var</span> t = Thread.startVirtualThread(() -&gt; {
        <span class="hljs-keyword">var</span> bestUUID = UUID.randomUUID().toString();<font></font>
        System.out.println(<span class="hljs-string">"Best fast UUID is "</span> + bestUUID);<font></font>
    });<font></font>
    threads.add(t);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">for</span> (Thread t : threads) {<font></font>
    t.join();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier führen wir 10 langsame und 10 schnelle Aufgaben aus. Schnelle Aufgaben sind millionenfach schneller als langsame, daher wäre es logisch anzunehmen, dass sie früher erledigt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber es war nicht da:</font></font><br>
<br>
<pre><code class="bash hljs">Best slow UUID is fffffde4-8c70-4ce6-97af-6a1779c206e1<font></font>
Best slow UUID is ffffe33b-f884-4206-8e00-75bd78f6d3bd<font></font>
Best slow UUID is fffffeb8-e972-4d2e-a1f8-6ff8aa640b70<font></font>
Best fast UUID is e13a226a-d335-4d4d-81f5-55ddde69e554<font></font>
Best fast UUID is ec99ed73-23b8-4ab7-b2ff-7942442a13a9<font></font>
Best fast UUID is c0cbc46d-4a50-433c-95e7-84876a338212<font></font>
Best fast UUID is c7672507-351f-4968-8cd2-2f74c754485c<font></font>
Best fast UUID is d5ae642c-51ce-4b47-95db-abb6965d21c2<font></font>
Best fast UUID is f2f942e3-f475-42b9-8f38-93d89f978578<font></font>
Best fast UUID is 469691ee-da9c-4886-b26e-dd009c8753b8<font></font>
Best fast UUID is 0ceb9554-a7e1-4e37-b477-064c1362c76e<font></font>
Best fast UUID is 1924119e-1b30-4be9-8093-d5302b0eec5f<font></font>
Best fast UUID is 94fe1afc-60aa-43ce-a294-f70f3011a424<font></font>
Best slow UUID is fffffc24-28c5-49ac-8e30-091f1f9b2caf<font></font>
Best slow UUID is fffff303-8ec1-4767-8643-44051b8276ca<font></font>
Best slow UUID is ffffefcb-614f-48e0-827d-5e7d4dea1467<font></font>
Best slow UUID is fffffed1-4348-456c-bc1d-b83e37d953df<font></font>
Best slow UUID is fffff6d6-6250-4dfd-8d8d-10425640cc5a<font></font>
Best slow UUID is ffffef57-c3c3-46f5-8ac0-6fad83f9d4d6<font></font>
Best slow UUID is fffff79f-63a6-4cfa-9381-ee8959a8323d<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intuition funktioniert nur, solange die Anzahl der langsamen Aufgaben geringer ist als die Anzahl der Kerne Ihrer CPU. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Grund ist einfach - im Moment verwendet Project Loom den üblichen ForkJoinPool. Trotz der Tatsache, dass die Dokumentation und die Idee darauf hinweisen, dass virtuelle Streams „präemtiv“ sind, verhalten sie sich derzeit „kooperativ“. Eigentlich wie die Coroutinen in Kotlin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sollte beachtet werden, dass Ron in dem oben genannten Artikel erwähnt, dass er auch über erzwungenes Präemtionsverhalten nachdenkt, wie in normalen Threads. Bisher wurde dies jedoch nicht implementiert, da nicht ganz klar ist, wie nützlich ein solches Verhalten ist, wenn es Zehntausende von Threads geben kann. In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go 1.14 wurde jedoch leise eine erzwungene Prävention eingeführt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Funktionsaufruf führt im Gegensatz zu Go nicht zu einem Kontextwechsel. </font><font style="vertical-align: inherit;">Suspend wurde wie in Kotlin ebenfalls nicht ausgeliefert. </font><font style="vertical-align: inherit;">Sie können dies jedoch mit Thread.yield () oder durch Aufrufen einer beliebigen Java-E / A-Funktion tun: System.out.println (""). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Berechnung ist einfach - die meisten realen Programme verwenden häufig blockierende E / A. </font><font style="vertical-align: inherit;">Und es ist seine Verwendung von Project Loom, die in erster Linie zu lösen versucht.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einige Schlussfolgerungen:</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich muss zugeben, dass mich Project Loom trotz meiner anfänglichen Skepsis positiv beeindruckt hat. </font><font style="vertical-align: inherit;">Für normale Java-Benutzer verspricht es leichtes Multithreading, ohne dass mithilfe einer Bibliothek oder eines Frameworks in eine andere Sprache gewechselt werden muss. </font><font style="vertical-align: inherit;">Was sich schon gut anhört. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber die Hauptrevolution, wie ich erwarte, wird dieses Projekt unter Bibliotheksentwicklern durchgeführt, die das Parallelitätsproblem immer wieder und immer wieder lösen müssen. </font><font style="vertical-align: inherit;">Mit der Verteilung von JDK15 kann dieses Problem nun auf die JVM übertragen werden, da sie zur Übertragung der Speicher- (GC) und Codeoptimierung (JIT) an die JVM verwendet wurden. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link zu meinem Originalartikel,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Sie lieber auf Englisch lesen möchten.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503402/index.html">Wie man sich an jeden persönlich erinnert oder wie man effektiv nach Gesichtern in einer großen Datenbank sucht</a></li>
<li><a href="../de503404/index.html">Semantische digitale Systeme</a></li>
<li><a href="../de503406/index.html">Semantik und Aktivität</a></li>
<li><a href="../de503408/index.html">Blazor Client Side Online Store: Teil 7 - Auf Version 3.2.0 aktualisiert und Bildanzeige hinzugefügt</a></li>
<li><a href="../de503410/index.html">Polygone Eine andere Welt: Sega Genesis</a></li>
<li><a href="../de503414/index.html">Hack The Box. Walkthrough-Seil. PWN. Formatieren Sie Strings und ROP mit pwntools</a></li>
<li><a href="../de503420/index.html">Lemmatisiere es schneller (PyMorphy2, PyMystem3 und etwas Magie)</a></li>
<li><a href="../de503426/index.html">44,2 Tb / s über Faser - wie funktioniert das?</a></li>
<li><a href="../de503428/index.html">So verbessern Sie das schriftliche Englisch für die Kommunikation im Ausland: Linguix Business Project</a></li>
<li><a href="../de503430/index.html">MS Remote Desktop Gateway, HAProxy und Kennwortraten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>