<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüî¨ üëÇüèº üëê MVCC as one way to ensure transaction isolation ‚öóÔ∏è ü§≤üèΩ üòì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. My name is Vladislav Rodin. Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software archite...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MVCC as one way to ensure transaction isolation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/504190/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, Habr. </font><font style="vertical-align: inherit;">My name is Vladislav Rodin. </font><font style="vertical-align: inherit;">Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software architecture. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especially for the start of a new set for the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Architect of high loads"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I wrote a little material, which I gladly share with you.</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/hv/fy/ll/hvfyllpmp4nnso0wztz_u0ju278.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Last time,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we talked with you about the consequences of weakening transaction isolation in databases. </font><font style="vertical-align: inherit;">Today we will discuss in more detail one of the ways to ensure this isolation and avoidance of the considered anomalies. </font><font style="vertical-align: inherit;">As you may have noticed, in the last article two approaches were often distinguished: one was based on the fact that the records have some </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the second on the fact that we will </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">block the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recording in one way or another </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Thus, two classes of databases are distinguished: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versioned and blockers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Today we‚Äôll talk about what version controllers are, and let‚Äôs leave the consideration of blockers next time.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versionioners</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I said, one of the approaches is based on versioning. </font><font style="vertical-align: inherit;">It is also called the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimistic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approach or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVCC (multiversion concurrency control)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In fact, version storage for active transactions occurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where are the versions stored?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The implementation of the mechanism depends on the database. </font><font style="vertical-align: inherit;">I will give examples of some of them.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each transaction is characterized by some id-shnik. Id-shnik transactions grow monotonously. Any line has 2 attributes that represent meta-information for providing the mechanism: updated_by_id - id of the transaction that last updated this record and deleted_by_id - id of the transaction that deleted this record. When a new transaction arrives, the database determines the id-nicknames of the transactions currently being performed, the changes made by these transactions will be ignored within the incoming transaction. It turns out that the incoming transaction works as if with its version of the data. Old versions of data are stored in the same place as current ones. If Update arrives, then another line is added and this record becomes active. It is also clear that for the correct operation of this scheme, a "garbage collector" is required:if some record has deleted_by_id = 100, and the minimum id-shnik among the current transactions is 150, then this record must be deleted.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL (InnoDB engine)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only the current version is stored in the MySQL database. </font><font style="vertical-align: inherit;">When Update arrives, the data inside the table file is corrected. </font><font style="vertical-align: inherit;">After adjusting the data, the previous version is in the rollback log. </font><font style="vertical-align: inherit;">There are several rollback logs in MySQL (they are different for insert'ov and update'ov). </font><font style="vertical-align: inherit;">If a transaction needs a previous version of the line, the system goes to undo log and restores the necessary version. </font><font style="vertical-align: inherit;">The version is also determined by the transaction id.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The scheme is similar to MySQL: the current versions are stored in the data file, old versions are restored thanks to undo log. </font><font style="vertical-align: inherit;">The undo log in Oracle is cyclically rewritten. </font><font style="vertical-align: inherit;">Therefore, a situation is possible when a transaction needs a very old version of the record, but in the undo log it is no longer there. </font><font style="vertical-align: inherit;">If this situation occurs, the transaction will fail.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS SQL allows the inclusion of both versionioner and blocker modes. To enable versioned mode in the database settings, you must enable snapshots. In MS SQL there is a system table (tempdb), which is designed to store temporary tables. It is tempdb that is used to store old versions, while the table contains the current versions. The system process monitors that in tempdb there are versions that no one refers to, they can be deleted. If the transaction is long-playing, then versions will be saved for it. Tempdb grows, reaches its maximum size, MS SQL allocates a little disk space. If it ends, then transactions with snapshot isolation cannot be performed. If this mode of operation is used, it is necessary to monitor long transactions,because the rollback of such a transaction in time may cost as much as it works, and maybe a little more.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conflicts</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach is called optimistic, because we hope that there will be no conflict if parallel data-changing transactions are executed. </font><font style="vertical-align: inherit;">What happens in case of conflict? </font><font style="vertical-align: inherit;">Suppose transaction T1 changes 10,000 records, and transaction T2 changes 1 record in parallel. </font><font style="vertical-align: inherit;">If it so happened that this 1 record is included in those 10,000, then one of the transactions will be rolled back: if T1 is executed first, then T2 will be rolled back, otherwise it will be vice versa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rollback mechanism</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The mechanism of transaction rollback in versioned versions depends on the implementation. </font><font style="vertical-align: inherit;">For example, in PostgreSQL, a transaction is marked as evacuated and vacuum frees up disk space. </font><font style="vertical-align: inherit;">Such a mechanism is fast enough. </font><font style="vertical-align: inherit;">In Oracle, for the rollback, data is restored from the undo log. </font><font style="vertical-align: inherit;">In this case, the operating time increases, however, it is still much faster than in lockers. </font><font style="vertical-align: inherit;">MySQL works in the same way as Oracle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The optimistic approach is good because the writer does not block the reader, the reader simply reads his version of the data. </font><font style="vertical-align: inherit;">Therefore, versioning is beneficial if the main burden is on reading rather than writing (blog, reporting, and other cases where you need to read often and a lot).</font></font><br>
<br>
<hr><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course here.</font></font></a></b><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504180/index.html">The tale of how we tamed BigQuery</a></li>
<li><a href="../en504182/index.html">Reviewix Solution500 C500 3D Scanner</a></li>
<li><a href="../en504184/index.html">Creating a trading bot using machine learning in time series analysis</a></li>
<li><a href="../en504186/index.html">Paul Graham: How to Write Useful Texts (Full)</a></li>
<li><a href="../en504188/index.html">Quarantine, online systems and data science. Who thinks about customer retention?</a></li>
<li><a href="../en504194/index.html">The result of a survey of developers on Stack Overflow 2020 (+ habraopros)</a></li>
<li><a href="../en504196/index.html">NFC: Parsing Near Field Communication Technology</a></li>
<li><a href="../en504198/index.html">SwiftUI on the shelves: Animation. Part 1</a></li>
<li><a href="../en504204/index.html">IBM Workshops: Quarkus (Ultrafast Java for Microservices), Jakarta EE, and OpenShift</a></li>
<li><a href="../en504208/index.html">How to Automate a Shared Service Center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>