<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏳️ 🈶 🍞 クラウドスマートホーム。パート1：コントローラーとセンサー 👆🏾 🍈 🐭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今日、マイクロエレクトロニクス、通信チャネル、インターネット技術、人工知能の急速な発展のおかげで、スマートホームのトピックはますます関連性を増しています。人間の住居は、石器時代以降、産業革命4.0の時代に大きな変化を遂げ、モノのインターネットは便利で機能的かつ安全になりました。アパートやカントリーハ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>クラウドスマートホーム。パート1：コントローラーとセンサー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467219/"><img src="https://habrastorage.org/webt/q6/ni/9k/q6ni9k05gsedjwzqbsyfr_zc7sc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日、マイクロエレクトロニクス、通信チャネル、インターネット技術、人工知能の急速な発展のおかげで、スマートホームのトピックはますます関連性を増しています。人間の住居は、石器時代以降、産業革命4.0の時代に大きな変化を遂げ、モノのインターネットは便利で機能的かつ安全になりました。アパートやカントリーハウスを、スマートフォンを使用して世界中のどこからでも管理できる高度な情報システムに変えるソリューションが市場に登場します。さらに、人間と機械の相互作用にプログラミング言語の知識は必要ありません-音声認識と音声合成アルゴリズムのおかげで、人はスマートホームで母国語を話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在市場に出ているいくつかのスマートホームシステムは、クラウドベースのビデオ監視システムの論理的な開発です。その開発者は、監視だけでなくリモートオブジェクトの管理のための包括的なソリューションの必要性を認識しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
執筆者が独自に開発し、運用を開始したクラウドスマートホームシステムのすべての主要コンポーネントについて説明する3つのシリーズの記事を提供します。</font><font style="vertical-align: inherit;">最初の記事はスマートホーム内にインストールされたターミナルクライアント機器に向けられ、2番目はクラウドストレージおよびデータ処理システムのアーキテクチャに向けられ、最後に3番目はモバイルおよび固定デバイスでシステムを管理するためのクライアントアプリケーションに向けられます。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホーム機器</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、普通のアパート、コテージ、またはコテージからスマートホームを作る方法について話しましょう。</font><font style="vertical-align: inherit;">このため、原則として、以下の機器を家庭に設置する必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな環境パラメータを測定するセンサー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部オブジェクトに作用するアクチュエータ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センサー測定と組み込みロジックに従って計算を実行し、アクチュエーターにコマンドを発行するコントローラー。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の図は、バスルームの漏水センサー（1）、寝室の温度（2）および照明（3）、キッチンのスマートソケット（4）、廊下のビデオ監視カメラ（5）があるスマートホームの図を示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/en/f-/nqenf-epwiuqhsimy3ft2wbyvpo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、RF433、Z-Wave、ZigBee、Bluetooth、WiFiプロトコルで動作するワイヤレスセンサーが広く使用されています。それらの主な利点は、設置と使用が容易であるだけでなく、低コストと信頼性です。メーカーは自社のデバイスをマスマーケットに持ち込み、平均的なユーザーが利用できるようにすることを目指しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
センサーとアクチュエーターは通常、ワイヤレスインターフェイスを介してスマートホームコントローラー（6）に接続されます。これは、これらすべてのデバイスを1つのネットワークに統合して制御する特殊なマイクロコンピューターです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、一部のソリューションでは、センサー、アクチュエーター、コントローラーを同時に組み合わせることができます。たとえば、スマートソケットをスケジュールに従ってオンまたはオフにするようにプログラムしたり、クラウドベースのビデオ監視カメラでモーション検出器の信号に基づいてビデオを記録したりできます。最も単純なケースでは、個別のコントローラーなしで実行できますが、多くのシナリオで柔軟なシステムを作成するには、それが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーをグローバルネットワークに接続するには、従来から家庭でよく知られている家電製品である従来のインターネットルーター（7）を使用できます。スマートホームコントローラーを支持するもう1つの議論があります。インターネットへの接続が失われた場合、スマートホームは、クラウドサービスではなく、コントローラー内に格納されているロジックブロックにより、通常どおり動作し続けます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームコントローラー</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事で説明するクラウドスマートホームシステムのコントローラーは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raspberry Pi 3モデルB +</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シングルボードマイクロコンピューター</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">基づいて開発されました。これは、</font><font style="vertical-align: inherit;">2018年3月にリリースされ、スマートホームタスクに十分なリソースとパフォーマンスを備えています。</font><font style="vertical-align: inherit;">これには、1.4 GHzでクロックされる64ビットARMv8-Aアーキテクチャを備えた4コアのCortex-A53プロセッサ、1 GBのRAM、Wi-Fi 802.11ac、Bluetooth 4.2、USB 2.0バスを介して機能するギガビットイーサネットアダプターが含まれます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ki/di/-_/kidi-_hdoclhmawxeqcgxvjxnwm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラーの組み立ては非常に簡単です。マイクロコンピューター（1）はプラスチックケース（2）にインストールされ、ソフトウェア付きの8 GB microSDカード（3）とUSB Z-Waveネットワークコントローラー（4）が対応するスロットに挿入されます。</font><font style="vertical-align: inherit;">スマートホームコントローラーは、5V、2.1A（5）の電源アダプターとマイクロUSBケーブル（6）を介して主電源に接続されています。</font><font style="vertical-align: inherit;">各コントローラーには一意の識別番号があり、これは最初の起動時に構成ファイルに記録され、クラウドスマートホームサービスとの対話に必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーソフトウェアは、この記事の作成者によって</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Raspbian Stretch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーティングシステムに基づいて開発されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次のメインサブシステムで構成されています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホーム機器およびクラウドと対話するためのサーバープロセス。</font></font></li>
<li>         ;</li>
<li>     .</li>
</ul><br>
<img src="https://habrastorage.org/webt/s6/lx/k-/s6lxk-xr0gnx8cy5wohn6u8pgqo.png"><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームコントローラー</font><b><font style="vertical-align: inherit;">のデータベースは、</font></b><font style="vertical-align: inherit;">組み込み</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMSに基づいており、</font><font style="vertical-align: inherit;">システムソフトウェアを含むSDカード上のファイルです。これは、コントローラー構成のリポジトリーとして機能します-接続された機器とその現在の状態に関する情報、論理的な制作ルールのブロック、およびインデックス付けが必要な情報（ローカルビデオアーカイブのファイル名など）。コントローラーを再起動すると、この情報が保存され、停電時にコントローラーの操作性を回復することができます。</font><font style="vertical-align: inherit;">スマートホームコントローラー</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のグラフィカルインターフェイスは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スリム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロフレームワークを使用してPHP 7で開発されています</font><font style="vertical-align: inherit;">。 Webサーバー</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.lig"><font style="vertical-align: inherit;">lighttpd</font></a><font style="vertical-align: inherit;">がアプリケーションを担当します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.lig"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスが高く、リソース要件が低いため、組み込みデバイスでよく使用されます。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font><font style="vertical-align: inherit;"> 
グラフィカルインターフェイスの主な機能は、スマートホーム機器（IPカメラとセンサー）をコントローラーに接続することです。</font><font style="vertical-align: inherit;">Webアプリケーションは、SQLiteデータベースから、コントローラーとそれに接続されているデバイスの構成と現在のステータスを読み取ります。</font><font style="vertical-align: inherit;">コントローラーの構成を変更するには、サーバープロセスのRESTful APIを介してJSON形式で制御コマンドを送信します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/p6/jh/w0/p6jhw0khe-pnljdtzf54qjrtgna.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバープロセス</font></font></h1><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバープロセス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、スマートホームの基盤を構成する情報処理を自動化する基本的な作業をすべて</font><b><font style="vertical-align: inherit;">実行</font></b><font style="vertical-align: inherit;">する主要コンポーネントです。センサーデータの受信と処理、適切なロジックに応じた制御アクションの発行などです。</font><font style="vertical-align: inherit;">サーバープロセスの目的は、スマートホーム機器とのやり取り、生産ロジックルールの遵守、グラフィカルインターフェイスとクラウドからのコマンドの受信と処理です。</font><font style="vertical-align: inherit;">このスマートホームコントローラーのサーバープロセスは、C ++で開発されたマルチスレッドアプリケーションとして実装され</font><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">Linux Raspbian</font></b><font style="vertical-align: inherit;">オペレーティングシステムの</font><font style="vertical-align: inherit;">個別の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスとして起動され</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
サーバープロセスの主なブロックは次のとおりです。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージマネージャー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPカメラサーバー;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Waveデバイスサーバー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの生産ロジックのルール。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラ構成のデータベースと論理ルールのブロック。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラフィカルインターフェイスと対話するためのRESTful APIサーバー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドと対話するためのMQTTクライアント。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバープロセスのブロックは個別のストリームとして実装され、その間の情報はJSON形式のメッセージ（またはプロセスメモリ内のこの形式を表すデータ構造）の形式で送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/vm/md/vlvmmduxt7nsh-bjkpshrywrcqa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバープロセスの主要コンポーネントは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージマネージャーで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、JSONメッセージをサーバープロセスのすべてのブロックにルーティングします。</font><font style="vertical-align: inherit;">JSONメッセージ情報フィールドのタイプとそれらが受け入れることができる値が表にリストされています：</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバイスタイプ</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコル</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messageType</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deviceState</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カメラ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onvif</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sensorData</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オン</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミング（オン/オフ）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センサー</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zwave</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オフ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記録（オン/オフ）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エフェクター</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mqtt</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">businessLogicRule</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミング（オン/オフ）</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">evice（追加/削除）</font></font></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスの論理</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定データ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記録（オン/オフ）</font></font></td>
<td></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブルートゥース</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deviceState</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー</font></font></td>
<td></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wi-Fi</font></font></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RF</font></font></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、カメラのモーション検出器からのメッセージは次のようになります。</font></font><br>
<br>
<pre><code class="json hljs">{
	<span class="hljs-attr">"vendor"</span>: <span class="hljs-string">"*****"</span>,
	<span class="hljs-attr">"version"</span>: <span class="hljs-string">"3.0.0"</span>,
	<span class="hljs-attr">"timestampMs"</span>: <span class="hljs-string">"1566293475475"</span>,
	<span class="hljs-attr">"clientType"</span>: <span class="hljs-string">"gateway"</span>,
	<span class="hljs-attr">"deviceId"</span>: <span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span>,
	<span class="hljs-attr">"deviceType"</span>: <span class="hljs-string">"camera"</span>,
	<span class="hljs-attr">"protocol"</span>: <span class="hljs-string">"onvif"</span>,
	<span class="hljs-attr">"messageType"</span>: <span class="hljs-string">"sensorData"</span>,
	<span class="hljs-attr">"sensorType"</span>: <span class="hljs-string">"camera"</span>,
	<span class="hljs-attr">"label"</span>: <span class="hljs-string">"motionDetector"</span>,
	<span class="hljs-attr">"sensorData"</span>: <span class="hljs-string">"on"</span><font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生産ロジック</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスパッチャーからメッセージを受信または送信するために、サーバープロセスブロックは特定のタイプのメッセージをサブスクライブします。</font><font style="vertical-align: inherit;">サブスクリプションは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「If ...、then ...」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプのプロダクション論理ルールであり</font><font style="vertical-align: inherit;">、JSON形式で提示され、サーバープロセスブロック内のメッセージハンドラーへのリンクです。</font><font style="vertical-align: inherit;">たとえば、IPカメラサーバーがGUIとクラウドからコマンドを受信できるようにするには、次のルールを追加する必要があります。</font></font><br>
<br>
<pre><code class="json hljs">{
	<span class="hljs-attr">"if"</span>: {
	    <span class="hljs-attr">"and"</span>: [{
		<span class="hljs-attr">"equal"</span>: {
		    <span class="hljs-attr">"deviceId"</span>: <span class="hljs-string">"1616453d-30cd-44b7-9bf0-************"</span><font></font>
		}<font></font>
	    },<font></font>
	    {<font></font>
		<span class="hljs-attr">"equal"</span>: {
		    <span class="hljs-attr">"messageType"</span>: <span class="hljs-string">"command"</span><font></font>
		}<font></font>
	    }<font></font>
	    ]<font></font>
	},<font></font>
	<span class="hljs-attr">"then"</span>: {
	    <span class="hljs-attr">"result"</span>: <span class="hljs-string">"true"</span><font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルール</font><font style="vertical-align: inherit;">
の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前件</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（左側）に</font><font style="vertical-align: inherit;">示されている条件</font><font style="vertical-align: inherit;">がtrueの場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルールのルール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（右側）</font><font style="vertical-align: inherit;">が実行され</font><font style="vertical-align: inherit;">、ハンドラーがJSONメッセージの本文にアクセスします。</font><font style="vertical-align: inherit;">前件は、JSONキーと値のペアの比較を実行する論理演算子をサポートしています。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「等しい」に等しい。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「not_equal」と等しくない。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少ない「少ない」;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より「より大きな」;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「less_or_equal」以下。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">greater_or_equal以上。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブール代数の演算子を使用して、比較結果をリンクできます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして「そして」;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または「または」;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ない」ではない。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、演算子とオペランドをポーランド語表記で記述すると、多数のパラメーターを持つかなり複雑な条件を形成することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JSONメッセージとJSON形式のプロダクションルールに基づくまったく同じメカニズムが、プロダクションロジックサーバーブロックで使用され、スマートホームセンサーからの感覚データを使用して知識を表現し、論理的に推論します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーはモバイルアプリケーションを使用して、スマートホームを機能させるためのスクリプトを作成します。例：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「玄関のドアを開くセンサーが機能している場合は、廊下のライトをオンにします」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。アプリケーションは、センサー（オープニングセンサー）とアクチュエーター（スマートソケットまたはスマートランプ）の識別子をデータベースから読み取り、JSON形式の論理ルールを生成して、スマートホームコントローラーに送信します。このメカニズムについては、連載の第3回で詳しく説明します。この記事では、スマートホームを管理するためのクライアントアプリケーションについて説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のプロダクションロジックメカニズムは</font><font style="vertical-align: inherit;">、C ++のJSON形式のSAXパーサーである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RapidJSON</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリを使用して実装され</font><font style="vertical-align: inherit;">ます。一連のプロダクションルールを順次読み取り、解析することで、前提条件内でデータマッチング機能を簡単に実装できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CRuleEngine::Process</span><span class="hljs-params">(PProperties pFact)</span>
</span>{<font></font>
    m_pActions-&gt;clear();<font></font>
<font></font>
    rapidjson::Reader   reader;<font></font>
    <span class="hljs-keyword">for</span>(TStringMap::value_type&amp; rRule : m_Rules)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> sRuleId   = rRule.first;
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> sRuleBody = rRule.second;<font></font>
<font></font>
        <span class="hljs-function">CRuleHandler            <span class="hljs-title">ruleHandler</span><span class="hljs-params">(pFact)</span></span>;
        <span class="hljs-function">rapidjson::StringStream <span class="hljs-title">ruleStream</span><span class="hljs-params">(sRuleBody.c_str())</span></span>;<font></font>
        rapidjson::ParseResult  parseResult = reader.Parse(ruleStream, ruleHandler);<font></font>
        <span class="hljs-keyword">if</span>(!parseResult)<font></font>
        {<font></font>
            m_Logger.LogMessage(<font></font>
                        NLogger2::ePriorityLevelError,<font></font>
                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"JSON parse error"</span>),
                        <span class="hljs-string">"CRuleEngine::Process()"</span>,
                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"RuleId: "</span>) + sRuleId);<font></font>
        }<font></font>
<font></font>
        PProperties pAction = ruleHandler.GetAction();<font></font>
        <span class="hljs-keyword">if</span>(pAction)<font></font>
        {<font></font>
            pAction-&gt;Set(<span class="hljs-string">"ruleId"</span>, sRuleId);<font></font>
            m_pActions-&gt;push_back(pAction);<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFactは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> JSONメッセージからのキーと値のペアを含む構造であり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_Rulesは、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロダクションルールの文字列配列です。着信メッセージとプロダクションルールの比較は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reader.Parse（ruleStream、ruleHandler）関数</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">実行され</font><font style="vertical-align: inherit;">ます</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ruleHandler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ブール演算子と比較演算子のロジックを含むオブジェクトです。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sRuleId</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は一意のルールIDです。これにより、スマートホームコントローラーのデータベース内でルールを保存および編集できます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_pActions-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">論理推論の結果を含む配列：ルールベースからの整合性を含むJSONメッセージであり、メッセージマネージャーに転送されるため、サブスクライバーストリームで処理できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RapidJSONのパフォーマンスは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">匹敵し、</font><font style="vertical-align: inherit;">最小システムリソース要件により、組み込みデバイスでこのライブラリを使用できます。</font><font style="vertical-align: inherit;">JSON形式のメッセージと論理ルールを使用すると、スマートホームコントローラーのすべてのコンポーネント間で柔軟な情報交換システムを実装できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センサーおよびアクチュエーターZ-Wave</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームの主な利点は、さまざまな環境パラメータを個別に測定し、状況に応じて有用な機能を実行できることです。これを行うには、センサーとアクチュエーターをスマートホームコントローラーに接続します。現在のバージョンでは、これらは</font><font style="vertical-align: inherit;">ロシアに</font><font style="vertical-align: inherit;">特別に割り当てられた</font><b><font style="vertical-align: inherit;">869 MHzの</font></b><font style="vertical-align: inherit;">周波数で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Wave</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルに従って動作するワイヤレスデバイス</font><font style="vertical-align: inherit;">です。彼らの仕事のために、それらは、カバレッジエリアを増やすために信号リピーターが存在するメッシュネットワークに結合されます。これらのデバイスには特別な省エネモードもあります。ほとんどの時間はスリープモードで過ごし、状態が変化したときにのみ情報を送信するため、内蔵バッテリーの寿命を大幅に延ばすことができます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/d8/ur/dp/d8urdpbsw6yxxxxqov8uj-hphzs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、市場にはかなり多数のさまざまなZ-Waveデバイスがあります。</font><font style="vertical-align: inherit;">例として、いくつか考えてみます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zipato PAN16スマートソケットは、電源の電力消費（kW / h）、電力（W）、電圧（V）、電流（A）のパラメーターを測定できます。</font><font style="vertical-align: inherit;">また、内蔵のスイッチを使用して、接続された電気機器を制御できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neo Coolcam漏れセンサーは、リモートプローブの接点を閉じることにより、こぼれた液体の存在を検出します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zipato PH-PSG01煙検知器は、煙粒子がガス分析チャンバーに入るとトリガーされます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neo Coolcamモーションセンサーは、人体からの赤外線を分析します。</font><font style="vertical-align: inherit;">さらに、光センサー（Lx）があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Philio PST02-Aマルチセンサーは、温度（°C）、光への露出（％）、ドアの開閉、室内の人の存在を測定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センサーが接続されているZ-Wave USBスティックZME E UZB1ネットワークコントローラー。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバイスとコントローラーが同じ周波数で動作することは非常に重要です。そうしないと、接続時に単純にお互いを認識できなくなります。</font><font style="vertical-align: inherit;">最大232台のデバイスを1つのZ-Waveネットワークコントローラーに接続できます。これは、アパートやカントリーハウスには十分です。</font><font style="vertical-align: inherit;">屋内でネットワークのカバレッジエリアを拡大するには、スマートソケットを信号リピーターとして使用できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/q2/oa/o_q2oa4n9w7hpqzr2vihyois9he.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の段落で説明したスマートホームコントローラーのサーバープロセスでは、Z-WaveサーバーがZ-Waveデバイスとの対話を担当します。</font><font style="vertical-align: inherit;">センサーから情報を取得するには、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">OpenZWave</font></a><font style="vertical-align: inherit;">ライブラリを使用します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++では、Z-WaveネットワークのUSBコントローラーと対話するためのインターフェースを提供し、多くのセンサーおよびアクチュエーターと連携します。センサーによって測定された環境パラメーターの値は、Z-WaveサーバーによってJSONメッセージの形式で記録されます。</font></font><br>
<br>
<pre><code class="json hljs">{
	<span class="hljs-attr">"vendor"</span>: <span class="hljs-string">"*****"</span>,
	<span class="hljs-attr">"version"</span>: <span class="hljs-string">"3.0.0"</span>,
	<span class="hljs-attr">"timestampMs"</span>: <span class="hljs-string">"1566479791290"</span>,
	<span class="hljs-attr">"clientType"</span>: <span class="hljs-string">"gateway"</span>,
	<span class="hljs-attr">"deviceId"</span>: <span class="hljs-string">"20873eb0-dd5e-4213-a175-************"</span>,
	<span class="hljs-attr">"deviceType"</span>: <span class="hljs-string">"sensor"</span>,
	<span class="hljs-attr">"protocol"</span>: <span class="hljs-string">"zwave"</span>,
	<span class="hljs-attr">"messageType"</span>: <span class="hljs-string">"sensorData"</span>,
	<span class="hljs-attr">"homeId"</span>: <span class="hljs-string">"0xefa0cfa7"</span>,
	<span class="hljs-attr">"nodeId"</span>: <span class="hljs-string">"20"</span>,
	<span class="hljs-attr">"sensorType"</span>: <span class="hljs-string">"METER"</span>,
	<span class="hljs-attr">"label"</span>: <span class="hljs-string">"Voltage"</span>,
	<span class="hljs-attr">"sensorData"</span>: <span class="hljs-string">"229.3"</span>,
	<span class="hljs-attr">"units"</span>: <span class="hljs-string">"V"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、サブスクライバースレッドが受信できるように、サーバープロセスメッセージマネージャーに転送されます。主なサブスクライバーは、論理ルールの前件のメッセージフィールドの値を比較するプロダクションロジックサーバーです。制御コマンドを含む推論結果はメッセージマネージャーに送り返され、そこからZ-Waveサーバーに送られます。サーバーはそれらをデコードし、Z-WaveネットワークのUSBコントローラーに送ります。次に、それらは環境の状態を変更する実行デバイスに入り、スマートホームは、したがって、有用な仕事をします。</font><font color="grey"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/_s/1m/wk/_s1mwk6ysdi5l9ynhtawcbaolfg.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Z-Waveデバイスは、スマートホームコントローラーのグラフィカルインターフェイスに接続されます。これを行うには、デバイスのリストのページに移動して、[追加]ボタンをクリックします。 RESTful APIインターフェースを介したaddコマンドはサーバープロセスに入り、メッセージマネージャーによってZ-Waveサーバーに送信され、Z-Wave USBコントローラーが特別なデバイス追加モードになります。次に、Z-Waveデバイスで、サービスボタンを連続してすばやく押す（1.5秒以内に3回押す）必要があります。 USBコントローラーはデバイスをネットワークに接続し、それに関する情報をZ-Waveサーバーに送信します。次に、SQLiteデータベースに新しいデバイスのパラメーターを使用して新しいレコードを作成します。指定された時間間隔の後、グラフィカルインターフェイスはZ-Waveデバイスのリストのページに戻ります。データベースから情報を読み取り、リストに新しいデバイスを表示します。同時に、各デバイスは独自の一意の識別子を受け取ります。この識別子は、本番環境の推論のルールで使用され、クラウドで作業するときに使用されます。このアルゴリズムの動作をUMLダイアグラムに示します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/np/01/lc/np01lc-tc4xbqzxccv18tfuxuz4.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（画像をクリックして、より高い解像度で開きます）</font></font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPカメラ接続</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事で説明するクラウドスマートホームシステムは、同じく筆者が開発したクラウドビデオ監視システムの近代化であり、数年間市場に出回っており、ロシアに多くの設備が設置されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドビデオ監視システムの場合、深刻な問題の1つは、統合が可能な機器の選択の制限です。クラウドへの接続を担当するソフトウェアはカムコーダー内にインストールされ、すぐにハードウェア、つまりプロセッサーと空きメモリの量に深刻な要求を出します。これは主に、従来のIPカメラと比較して、クラウドベースの監視カメラの価格が高いことを説明しています。さらに、カメラのファイルシステムと必要なすべての開発ツールにアクセスするには、CCTVカメラのメーカーとの長い交渉段階が必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/c-/sq/zxc-sqnecsbismwgwmztyclcg9k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、最近のすべてのIPカメラには、他の機器（特にDVR）と対話するための標準プロトコルがあります。したがって、標準プロトコルを使用して接続し、IPカメラからクラウドにビデオストリームをブロードキャストする別のコントローラーを使用すると、クラウドベースのビデオ監視システムに大きな競争上の優位性がもたらされます。さらに、クライアントがシンプルなIPカメラに基づくビデオ監視システムを既にインストールしている場合は、それを拡張して、本格的な曇りのあるスマートホームに変えることが可能になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IPビデオ監視システムで最も人気のあるプロトコルは、現在IPカメラのすべてのメーカーでサポートされています</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ONVIFプロファイルSです</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。その仕様は、Webサービスを記述するための言語で存在します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WSDL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gSOAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールキットのユーティリティを使用</font><font style="vertical-align: inherit;">すると、IPカメラで動作するサービスのソースコードを生成できます。</font></font><br>
<br>
<pre><code class="bash hljs">$ wsdl2h -o onvif.h \<font></font>
	https://www.onvif.org/ver10/device/wsdl/devicemgmt.wsdl \<font></font>
	https://www.onvif.org/ver10/events/wsdl/event.wsdl \<font></font>
	https://www.onvif.org/ver10/media/wsdl/media.wsdl \<font></font>
	https://www.onvif.org/ver20/ptz/wsdl/ptz.wsdl<font></font>
<font></font>
$ soapcpp2 -Cwvbj -c++11 -d cpp_files/onvif -i onvif.h<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、ヘッダー「* .h」とソース「* .cpp」ファイルのセットがC ++で取得されます。これらは、アプリケーションまたは個別のライブラリに直接配置し、GCCコンパイラを使用してコンパイルできます。多くの関数があるため、コードは大きく、追加の最適化が必要です。マイコンRaspberry Pi 3モデルB +は、このコードを実行するのに十分なパフォーマンスを備えていますが、コードを別のプラットフォームに移植する必要がある場合は、プロセッサアーキテクチャとシステムリソースを正しく選択する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ONVIF標準をサポートするIPカメラは、ローカルネットワークで動作している場合、アドレスが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">239.255.255.250の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特別なマルチキャストグループに接続されます</font><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">WS-Discovery</font></a><font style="vertical-align: inherit;">プロトコルがあります</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ローカルネットワーク上のデバイスの検索を自動化できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーのスマートインターフェイスは、PHP言語でIPカメラの検索機能を実装します。これは、XMLメッセージを介してWebサービスとやり取りする場合に非常に便利です。メニュー項目の[ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバイス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ] </font><i><font style="vertical-align: inherit;">&gt; [IPカメラ]&gt; [スキャン</font></i><font style="vertical-align: inherit;"> ]を選択する</font><font style="vertical-align: inherit;">と、IPカメラの検索アルゴリズムが開始され、結果が表形式で表示され</font><font color="grey"><font style="vertical-align: inherit;">ます（画像をクリックしてより高い解像度で開きます）。</font></font><font style="vertical-align: inherit;"> 
カメラをコントローラーに追加するときに、設定に応じて設定を指定できますクラウドと対話します。また、この段階で、デバイスに一意の識別子が自動的に割り当てられます。これにより、後でクラウド内で簡単に識別できます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/ew/xk/m6/ewxkm6g2tl7-2nqvjeyzfed8ees.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/uq/al/jpuqalxe9cryxzzg2dpynptjjmy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、追加されたカメラのすべてのパラメーターを含むメッセージがJSON形式で生成され、RESTful APIコマンドを介してスマートホームコントローラーのサーバープロセスに送信されます。カメラパラメーターはデコードされ、内部SQLiteデータベースに格納されます。また、次の処理スレッドの開始にも使用されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビデオおよびオーディオストリームを受信するためのRTSP接続を確立します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G.711 mu-Law、G.711 A-Law、G.723などの形式からのオーディオのトランスコーディング </font><font style="vertical-align: inherit;">AAC形式に;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H.264ビデオとAACオーディオストリームをFLVコンテナーにトランスコードし、RTMPを使用してクラウドに送信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ONVIFプロトコルとその定期的なポーリングを介してIPカメラモーション検出器のエンドポイントとの接続を確立します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定期的にサムネイルプレビュー画像を生成し、MQTTプロトコルを使用してクラウドに送信します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートホームコントローラーのSDカードまたはフラッシュカードに、MP4形式の個別のファイルの形式でビデオおよびオーディオストリームをローカルに記録します。</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/4m/yc/yb/4mycybe00ye3dxglny-fcgsohua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カメラとの接続を確立し、サーバープロセスでビデオストリームをトランスコーディング、処理、記録するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.1.0 </font><font style="vertical-align: inherit;">ライブラリの関数を使用し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パフォーマンステスト実験では、3台のカメラをコントローラーに接続しました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HiWatch DS-I114W（解像度-720p、圧縮フォーマット-H.264、ビットレート-1 Mb / s、サウンドG.711 mu-Law）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microdigital MDC-M6290FTD-1（解像度-1080p、圧縮形式-H.264、ビットレート-1 Mb /秒、音声なし）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dahua DH-IPC-HDW4231EMP-AS-0360B（解像度-1080p、圧縮フォーマット-H.264、ビットレート-1.5 Mb / s、AACサウンド）。</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/h2/dv/mk/h2dvmkujuqu4sdp6daccgdimnre.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのストリームすべてが同時にクラウドに出力され、音声トランスコーディングは1台のカメラからのみ実行され、ローカルアーカイブの記録は無効にされました。</font><font style="vertical-align: inherit;">CPU使用率は約5％、RAM使用率は32 MB（プロセスあたり）、56 MB（OSと合わせて）でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、約20〜30台のカメラ（解像度とビットレートによって異なります）をスマートホームコントローラーに接続できます。これは、3階建てのコテージまたは小さな倉庫のビデオ監視システムには十分です。</font><font style="vertical-align: inherit;">高いパフォーマンスが必要なタスクでは、IntelマルチコアプロセッサとLinux Debian Sarge OSを備えたネットトップを使用できます。</font><font style="vertical-align: inherit;">現在、コントローラーは試験運用中であり、そのパフォーマンスに関するデータが更新されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドの相互作用</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラウドスマートホームは、ユーザーデータ（ビデオとセンサーの測定値）をクラウドに保存します。</font><font style="vertical-align: inherit;">クラウドストレージアーキテクチャについては、シリーズの次の記事で詳しく説明します。</font><font style="vertical-align: inherit;">次に、スマートホームコントローラーからクラウドに情報メッセージを送信するためのインターフェイスについて説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続されたデバイスの状態とセンサー測定値は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルを使用して送信されます</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。MQTT</font></a><font style="vertical-align: inherit;">プロトコル</font><font style="vertical-align: inherit;">は、シンプルさとエネルギー効率のため、IoTプロジェクトでよく使用されます。</font><font style="vertical-align: inherit;">MQTTは、クライアントがブローカー内の特定のトピックにサブスクライブしてメッセージを発行するときに、クライアントサーバーモデルを使用します。</font><font style="vertical-align: inherit;">ブローカーは、QoS（サービス品質）レベルで決定されたルールに従って、すべてのサブスクライバーにメッセージを送信します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QoS 0-最大1回（配信保証なし）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QoS 1-少なくとも1回（配信確認あり）</font></font></li>
<li>QoS 2 —    (   ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのケースでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eclipse Mosquittoが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MQTTブローカーとして使用されてい</font><font style="vertical-align: inherit;">ます。トピック名は、スマートホームコントローラーの一意の識別子です。サーバープロセス内のMQTTクライアントはこのトピックにサブスクライブし、メッセージマネージャーからのJSONメッセージをそれに変換します。逆に、MQTTブローカーからのレポートはメッセージマネージャーに送信し、サーバープロセス内のサブスクライバーにそれらを多重化します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/ao/ea/zxaoeaqetsr7odlbfsx2xtn35fy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートホームコントローラーのステータスに関するメッセージを送信するために、メカニズム</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はメッセージ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルMQTTを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">保持するメッセージを</font></a><font style="vertical-align: inherit;">保存し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。これにより、停電時の再接続の瞬間を正しく監視できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MQTTクライアントは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Eclipse Paho</font></a><font style="vertical-align: inherit;">ライブラリーの実装に基づいて開発されました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++で。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H.264 + AACメディアストリームは、RTMPプロトコルを使用してクラウドに送信されます。メディアサーバーのクラスターは、その処理とストレージを担当します。</font><font style="vertical-align: inherit;">クラスター内の負荷を最適に分散し、最も負荷の少ないメディアサーバーを選択するために、スマートホームコントローラーはクラウドロードバランサーに事前リクエストを行い、その後メディアストリームを送信します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事では、R-Waveプロトコルを使用して情報を受信、処理、管理し、ONVIFプロトコルを使用してIPカメラとやり取りし、クラウドとデータやコマンドを交換できる、Raspberry Pi 3 B +マイクロコンピューターに基づくスマートホームコントローラーの特定の実装について検討しましたMQTTおよびRTMPプロトコルサービス。プロダクションロジックエンジンは、JSON形式で提示された論理ルールとファクトの比較に基づいて開発されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、スマートホームコントローラーはモスクワとモスクワ地域のいくつかの施設でテストされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラの次のバージョンでは、他のタイプ（RF、Bluetooth、WiFi、有線）のデバイスを接続する予定です。</font><font style="vertical-align: inherit;">ユーザーの便宜のために、センサーとIPカメラを接続するための手順は、モバイルアプリケーションに転送されます。</font><font style="vertical-align: inherit;">サーバープロセスコードを最適化し、ソフトウェアを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenWrt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーティングシステムに移植するためのアイデアもあります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これにより、別のコントローラーが節約され、スマートホームの機能が通常の家庭用ルーターに転送されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467203/index.html">ただの除算、または数学理論を作成し、それに40万ドルを稼ぐ方法。シリーズ2、最後から2番目</a></li>
<li><a href="../ja467205/index.html">他のアプリにデータを送るアプリ（エコシステムアプリ）を開発</a></li>
<li><a href="../ja467207/index.html">明るい未来（3年後）を持つ5つの有望なプログラミング言語</a></li>
<li><a href="../ja467209/index.html">「自律エージェント」またはオープン暗号プラットフォームObyteでコードを実行</a></li>
<li><a href="../ja467215/index.html">22コンピュータ博物館：ヨーロッパを旅するエンジニアのためのガイド</a></li>
<li><a href="../ja467223/index.html">JavaScript Meetup SuperJobへようこそ10月10日</a></li>
<li><a href="../ja467227/index.html">通常のデプロイメント、CI、およびデモ（人生の喜びを失うことなく）でnpmパッケージを開く方法</a></li>
<li><a href="../ja467231/index.html">iOSアプリでのAppleでのサインインの紹介</a></li>
<li><a href="../ja467237/index.html">DNS-over-HTTPSサーバーを上げる</a></li>
<li><a href="../ja467239/index.html">スポーツカーにおけるデータサイエンティストとティーンエイジャーの違い</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>