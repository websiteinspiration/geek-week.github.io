<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∫ üìì üåî Combatir p√©rdidas de memoria en aplicaciones web üöä üë∞üèª üë©‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando pasamos del desarrollo de sitios web cuyas p√°ginas se forman en el servidor a la creaci√≥n de aplicaciones web de una sola p√°gina que se represe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Combatir p√©rdidas de memoria en aplicaciones web</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/490622/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando pasamos del desarrollo de sitios web cuyas p√°ginas se forman en el servidor a la creaci√≥n de aplicaciones web de una sola p√°gina que se representan en el cliente, adoptamos ciertas reglas del juego. Uno de ellos es el manejo preciso de los recursos en el dispositivo del usuario. Esto significa: no bloquee la transmisi√≥n principal, no "gire" el ventilador de la computadora port√°til, no coloque la bater√≠a del tel√©fono. Intercambiamos una mejora en la interactividad de los proyectos web, y el hecho de que su comportamiento se parec√≠a m√°s al comportamiento de las aplicaciones ordinarias, una nueva clase de problemas que no exist√≠an en el mundo del renderizado de servidores.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/wv/_c/nl/wv_cnlo46dgs8op0yzhybzgkpw8.jpeg"></a><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de esos problemas es la p√©rdida de memoria. </font><font style="vertical-align: inherit;">Una aplicaci√≥n de una p√°gina mal dise√±ada puede engullir f√°cilmente megabytes o incluso gigabytes de memoria. </font><font style="vertical-align: inherit;">Es capaz de tomar m√°s y m√°s recursos incluso cuando se encuentra en silencio en la pesta√±a de fondo. </font><font style="vertical-align: inherit;">La p√°gina de dicha aplicaci√≥n, despu√©s de capturar una cantidad exorbitante de recursos, puede comenzar a "ralentizarse" en gran medida. </font><font style="vertical-align: inherit;">Adem√°s, el navegador simplemente puede cerrar la pesta√±a y decirle al usuario: "Algo sali√≥ mal".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34b/e9d/da8/34be9dda87ca7f35d70a1a934816ce78.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algo sali√≥ mal</font></font></font></i><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, los sitios que se representan en el servidor tambi√©n pueden sufrir un problema de p√©rdida de memoria. Pero aqu√≠ estamos hablando de la memoria del servidor. Al mismo tiempo, es altamente improbable que tales aplicaciones causen una p√©rdida de memoria en el cliente, ya que el navegador borra la memoria despu√©s de cada transici√≥n de usuario entre p√°ginas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tema de las p√©rdidas de memoria no est√° bien cubierto en las publicaciones de desarrollo web. Y a pesar de esto, estoy casi seguro de que la mayor√≠a de las aplicaciones de una sola p√°gina no triviales sufren p√©rdidas de memoria, a menos que los equipos que se ocupan de ellas tengan herramientas confiables para detectar y solucionar este problema. El punto aqu√≠ es que en JavaScript es extremadamente f√°cil asignar aleatoriamente una cierta cantidad de memoria, y luego simplemente olvidar liberar esta memoria.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El autor del art√≠culo, cuya traducci√≥n publicamos hoy, compartir√° con los lectores su experiencia en la lucha contra las p√©rdidas de memoria en las aplicaciones web, y tambi√©n quiere dar ejemplos de su detecci√≥n efectiva.</font></font><br>
<cut></cut><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© se escribe tan poco sobre esto?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, quiero hablar sobre por qu√© se escribe tan poco sobre las p√©rdidas de memoria. </font><font style="vertical-align: inherit;">Supongo que aqu√≠ puedes encontrar varias razones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de quejas de los usuarios: la mayor√≠a de los usuarios no est√°n ocupados monitoreando de cerca el administrador de tareas mientras navegan por la web. </font><font style="vertical-align: inherit;">Por lo general, el desarrollador no encuentra quejas de los usuarios hasta que la p√©rdida de memoria es tan grave que provoca la incapacidad de trabajar o ralentiza la aplicaci√≥n.</font></font></li>
<li>  :   Chrome   -   ,     .          .</li>
<li> :            .</li>
<li>      :       ¬´¬ª     .   ,     ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>,   -.</li>
</ul><br>
<h2><font color="#3AC1EF">  </font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las bibliotecas y marcos modernos para desarrollar aplicaciones web, como React, Vue y Svelte, utilizan el modelo de componente de la aplicaci√≥n. Dentro de este modelo, la forma m√°s com√∫n de causar una p√©rdida de memoria es algo como esto:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.onMessage.bind(<span class="hljs-keyword">this</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo. </font><font style="vertical-align: inherit;">Esto es todo lo que se necesita para "equipar" un proyecto con una p√©rdida de memoria. </font><font style="vertical-align: inherit;">Para hacer esto, simplemente llame al m√©todo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addEventListener</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><font style="vertical-align: inherit;">alg√∫n objeto global (como </font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o </font></font><code>&lt;body&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o algo similar), y luego, al desmontar el componente, olvide eliminar el detector de eventos utilizando el m√©todo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">removeEventListener</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero las consecuencias de esto son a√∫n peores, ya que se produce la fuga de todo el componente. </font><font style="vertical-align: inherit;">Esto se debe al hecho de que el m√©todo est√° </font></font><code>this.onMessage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asociado </font></font><code>this</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Junto con este componente, se produce una fuga de sus componentes secundarios. </font><font style="vertical-align: inherit;">Es muy probable que todos los nodos DOM asociados con este componente tengan fugas. </font><font style="vertical-align: inherit;">La situaci√≥n, como resultado, puede salirse de control muy r√°pidamente y tener consecuencias muy malas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ se explica c√≥mo resolver este problema:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   </span>
<span class="hljs-keyword">this</span>.onMessage = <span class="hljs-keyword">this</span>.onMessage.bind(<span class="hljs-keyword">this</span>);
<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.onMessage);<font></font>
&nbsp;<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>.onMessage);</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Situaciones en las que ocurren p√©rdidas de memoria con mayor frecuencia</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La experiencia me dice que las p√©rdidas de memoria ocurren con mayor frecuencia cuando se usan las siguientes API:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todo </font></font><code>addEventListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Aqu√≠ es donde ocurren las p√©rdidas de memoria con mayor frecuencia. </font><font style="vertical-align: inherit;">Para resolver el problema, es suficiente llamar en el momento adecuado </font></font><code>removeEventListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setTimeout</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setInterval</a>.   ,        (,  30 ),  ,   ,      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">clearTimeout</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">clearInterval</a>. ,    <code>setTimeout</code>,  ¬´¬ª   ,    ,     <code>setInterval</code>-.  ,    <code>setTimeout</code>       .</li>
<li>API <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">IntersectionObserver</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ResizeObserver</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MutationObserver</a>   .  ,  ,  .         .     -         ,  ,   ,     ,   ,   <code>disconnect</code>  .    ,     DOM    ,           ,  -.        -,     .  ‚Äî  <code>&lt;body&gt;</code>,  <code>document</code>,   <code>header</code>  <code>footer</code>,     .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Promise-</a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>      .   ,    ,     ‚Äî   ,      . , ,  ¬´¬ª   ,        .    ¬´¬ª     <code>.then()</code>-.</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorios representados por objetos globales. </font><font style="vertical-align: inherit;">Cuando usa algo como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para controlar el estado de una aplicaci√≥n </font><font style="vertical-align: inherit;">, el almac√©n de estado est√° representado por un objeto global. </font><font style="vertical-align: inherit;">Como resultado, si maneja ese almacenamiento descuidadamente, no se eliminar√°n datos innecesarios, por lo que su tama√±o aumentar√° constantemente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infinito crecimiento del DOM. </font><font style="vertical-align: inherit;">Si la p√°gina implementa un desplazamiento sin fin sin el uso de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">virtualizaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , esto significa que el n√∫mero de nodos DOM en esta p√°gina puede crecer de forma ilimitada.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba, examinamos situaciones en las que las p√©rdidas de memoria ocurren con mayor frecuencia, pero, por supuesto, hay muchos otros casos que nos causan el problema que nos interesa.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identificaci√≥n de fuga de memoria</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora hemos pasado al desaf√≠o de identificar fugas de memoria. Para empezar, no creo que ninguna de las herramientas existentes sea muy adecuada para esto. Prob√© las herramientas de an√°lisis de memoria de Firefox, prob√© las herramientas de Edge e IE. Probado incluso Windows Performance Analyzer. Pero las mejores de estas herramientas siguen siendo las Herramientas para desarrolladores de Chrome. Es cierto que en estas herramientas hay muchas "esquinas afiladas" que vale la pena conocer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre las herramientas que ofrece el desarrollador de Chrome, estamos m√°s interesados ‚Äã‚Äãen el generador </font></font><code>Heap snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font><font style="vertical-align: inherit;">perfiles </font><font style="vertical-align: inherit;">de la pesta√±a </font></font><code>Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que le permite crear instant√°neas de mont√≥n. Hay otras herramientas para analizar la memoria en Chrome, pero no he podido extraer beneficios especiales de ellas para detectar p√©rdidas de memoria.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e7d/e42/63a/e7de4263abd59eecce420c4bcbfc55ea.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La herramienta de instant√°neas de mont√≥n le permite tomar instant√°neas de la memoria de la transmisi√≥n principal, los trabajadores web o los elementos de iframe.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Si la ventana de la herramienta de Chrome se parece a la que se muestra en la figura anterior, cuando hace clic en el bot√≥n</font></font><code>Take snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se captura informaci√≥n sobre todos los objetos en la memoria de la m√°quina virtual seleccionada JavaScript de la p√°gina investigada. Esto incluye los objetos a los que se hace referencia</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, los objetos a los que hacen referencia las devoluciones de llamada utilizadas en la llamada</font></font><code>setInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc. Una instant√°nea de la memoria se puede percibir como un "momento congelado" del trabajo de la entidad investigada, representando informaci√≥n sobre toda la memoria utilizada por esta entidad.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de tomar la fotograf√≠a, llegamos al siguiente paso para encontrar fugas. Consiste en reproducir un escenario en el que, seg√∫n el desarrollador, puede producirse una p√©rdida de memoria. Por ejemplo, est√° abriendo y cerrando una determinada ventana modal. Despu√©s de cerrar la ventana similar, se espera que la cantidad de memoria asignada vuelva al nivel que exist√≠a antes de que se abriera la ventana. Por lo tanto, toman otra foto y luego la comparan con la foto tomada anteriormente. De hecho, la comparaci√≥n de im√°genes es la caracter√≠stica m√°s importante que nos interesa </font></font><code>Heap snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/92d/776/4c7/92d7764c7fbe5d561032c3bc092e1541.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomamos la primera instant√°nea, luego tomamos acciones que pueden causar una p√©rdida de memoria y luego tomamos otra instant√°nea. </font><font style="vertical-align: inherit;">Si no hay fugas, el tama√±o de la memoria asignada ser√° igual.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Verdadero, esto</font></font><code>Heap snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° lejos de ser una herramienta ideal. </font><font style="vertical-align: inherit;">Tiene algunas limitaciones que vale la pena conocer:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incluso si hace clic en el peque√±o bot√≥n en el panel </font></font><code>Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que inicia la recolecci√≥n de basura ( </font></font><code>Collect garbage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), para asegurarse de que la memoria est√© realmente limpia, es posible que deba tomar varias fotos consecutivas. </font><font style="vertical-align: inherit;">Por lo general tengo tres disparos. </font><font style="vertical-align: inherit;">Aqu√≠ vale la pena centrarse en el tama√±o total de cada imagen; al final, deber√≠a estabilizarse.</font></font></li>
<li>    -, -,  <code>iframe</code>,      ,   ,          .   ,        JavaScript.   ‚Äî      ,       ,    .</li>
<li>           ¬´¬ª.             .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, si su aplicaci√≥n es bastante compleja, es posible que observe muchos objetos "con fugas" al comparar instant√°neas. </font><font style="vertical-align: inherit;">Aqu√≠ la situaci√≥n es algo complicada, ya que lo que puede confundirse con una p√©rdida de memoria no siempre es el caso. </font><font style="vertical-align: inherit;">Gran parte de lo sospechoso son procesos normales para trabajar con objetos. </font><font style="vertical-align: inherit;">La memoria ocupada por algunos objetos se borra para colocar otros objetos en esta memoria, algo se vac√≠a en la memoria cach√© y la memoria correspondiente no se borra de inmediato, y as√≠ sucesivamente.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos abrimos paso a trav√©s del ruido de la informaci√≥n</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descubr√≠ que la mejor manera de romper el ruido de la informaci√≥n es repetir las acciones que se supone que causan una p√©rdida de memoria. Por ejemplo, en lugar de abrir y cerrar la ventana modal solo una vez despu√©s de capturar el primer disparo, esto se puede hacer 7 veces. ¬øPor qu√© 7? S√≠, aunque solo sea porque 7 es un primo notable. Luego, debe realizar un segundo disparo y, compar√°ndolo con el primero, averiguar si cierto objeto "se filtr√≥" 7 veces (o 14 veces, o 21 veces).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a7/ac2/243/2a7ac2243dc82f0e7887b23098e7c893.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare las instant√°neas de mont√≥n. Tenga en cuenta que estamos comparando la imagen n. ¬∞ 3 con la imagen n. ¬∞ 6. El hecho es que tom√© tres fotos seguidas para que Chrome tuviera m√°s sesiones de recolecci√≥n de basura. Adem√°s, tenga en cuenta que algunos objetos "se filtraron" 7 veces.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Otro truco √∫til es que, al comienzo del estudio, antes de crear la primera imagen, realice el procedimiento una vez, durante el cual, como se esperaba, p√©rdida de memoria. Esto se recomienda especialmente si se utiliza la divisi√≥n de c√≥digo en el proyecto. En tal caso, es muy probable que tras la primera ejecuci√≥n de la acci√≥n sospechosa, se carguen los m√≥dulos JavaScript necesarios, lo que afectar√° la cantidad de memoria asignada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puede tener una pregunta sobre por qu√© debe prestar especial atenci√≥n a la cantidad de objetos y no a la cantidad total de memoria. Aqu√≠ podemos decir que nos esforzamos intuitivamente por reducir la cantidad de "p√©rdida" de memoria. En este sentido, puede pensar que debe controlar la cantidad total de memoria utilizada. Pero este enfoque, por una raz√≥n importante, no nos conviene particularmente bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si algo "se escapa", sucede porque (volviendo a contar a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Joe Armstrong</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) necesitas un pl√°tano, pero terminas con un pl√°tano, el gorila que lo sostiene y, adem√°s, toda la jungla. Si nos centramos en la cantidad total de memoria, ser√° lo mismo que "medir" la jungla, y no el pl√°tano que nos interesa.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e8/af8/847/7e8af8847ab7e8689e1638ac218582d6.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gorila comiendo un pl√°tano.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ahora volvamos al ejemplo anterior con</font></font><code>addEventListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Una fuente de fuga es un detector de eventos que hace referencia a una funci√≥n. Y esta funci√≥n, a su vez, se refiere a un componente que, posiblemente, almacena enlaces a un mont√≥n de cosas buenas como matrices, cadenas y objetos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si analiza la diferencia entre las im√°genes, ordenando las entidades por la cantidad de memoria que ocupan, esto le permitir√° ver muchas matrices, l√≠neas, objetos, la mayor√≠a de los cuales probablemente no est√©n relacionados con la fuga. Y despu√©s de todo, necesitamos encontrar el oyente del evento desde el cual todo comenz√≥. √âl, en comparaci√≥n con lo que se refiere, ocupa muy poca memoria. Para arreglar la fuga, necesitas encontrar un pl√°tano, no la jungla.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, si ordena los registros por el n√∫mero de objetos "filtrados", notar√° 7 oyentes de eventos. </font><font style="vertical-align: inherit;">Y tal vez 7 componentes y 14 subcomponentes, y tal vez algo m√°s como eso. </font><font style="vertical-align: inherit;">Este n√∫mero 7 debe sobresalir del panorama general, ya que es, sin embargo, un n√∫mero bastante notable e inusual. </font><font style="vertical-align: inherit;">En este caso, no importa cu√°ntas veces se repita la acci√≥n sospechosa. </font><font style="vertical-align: inherit;">Cuando se examinan im√°genes, si las sospechas est√°n justificadas, se registrar√°n tantos objetos "filtrados". </font><font style="vertical-align: inherit;">As√≠ es como puede identificar r√°pidamente la fuente de una p√©rdida de memoria.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lisis de √°rbol de enlaces</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La herramienta para crear instant√°neas proporciona la capacidad de ver "cadenas de enlaces" que lo ayudan a descubrir a qu√© objetos hacen referencia otros objetos. </font><font style="vertical-align: inherit;">Esto es lo que permite que la aplicaci√≥n funcione. </font><font style="vertical-align: inherit;">Al analizar tales "cadenas" o "√°rboles" de enlaces, puede averiguar exactamente d√≥nde se asign√≥ la memoria para el objeto "con fugas".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bf/77a/07d/7bf77a07dd2d15e479f77c2279b9942d.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cadena de enlaces le permite averiguar qu√© objeto se refiere al objeto "con fugas". </font><font style="vertical-align: inherit;">Al leer estas cadenas, es necesario tener en cuenta que los objetos ubicados en ellas a continuaci√≥n se refieren a los objetos ubicados arriba.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En el ejemplo anterior, hay una variable llamada</font></font><code>someObject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referenciada en el cierre (</font></font><code>context</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) al que hace referencia el detector de eventos. </font><font style="vertical-align: inherit;">Si hace clic en el enlace que conduce al c√≥digo fuente, se mostrar√° un texto bastante comprensible del programa:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeObject</span> () </span>{ <span class="hljs-comment">/* ... */</span> }<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">const</span> someObject = <span class="hljs-keyword">new</span> SomeObject();
<span class="hljs-keyword">const</span> onMessage = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { <span class="hljs-comment">/* ... */</span> };
<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, onMessage);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si comparamos este c√≥digo con la figura anterior, resulta que </font></font><code>context</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la figura es un cierre al </font></font><code>onMessage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que se refiere </font></font><code>someObject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este es un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejemplo artificial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Las p√©rdidas reales de memoria pueden ser mucho menos obvias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena se√±alar que la herramienta de instant√°nea del mont√≥n tiene algunas limitaciones:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si guarda un archivo de instant√°nea y luego lo carga de nuevo, se pierden los enlaces a archivos con c√≥digo. </font><font style="vertical-align: inherit;">Es decir, despu√©s de haber descargado una instant√°nea, no ser√° posible descubrir que el c√≥digo de cierre del detector de eventos est√° en la l√≠nea 22 del archivo </font></font><code>foo.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dado que esta informaci√≥n es extremadamente importante, guardar archivos de instant√°neas de almacenamiento din√°mico o, por ejemplo, transferirlos a alguien, es casi in√∫til.</font></font></li>
<li>     <code>WeakMap</code>,  Chrome       ,      . ,   ,     ,    ,   .    <code>WeakMap</code> ‚Äî     .</li>
<li>Chrome  ,    .  ,        ,     ,     ,     .      ,       <code>object</code>,    <code>EventListener</code>.   <code>object</code> ‚Äî     ,  ,   ,  ¬´¬ª   7  .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una descripci√≥n de mi estrategia b√°sica para identificar p√©rdidas de memoria. </font><font style="vertical-align: inherit;">He utilizado con √©xito esta t√©cnica para detectar docenas de fugas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es cierto que debo decir que esta gu√≠a para encontrar p√©rdidas de memoria cubre solo una peque√±a parte de lo que sucede en la realidad. </font><font style="vertical-align: inherit;">Esto es solo el comienzo del trabajo. </font><font style="vertical-align: inherit;">Adem√°s, debe poder manejar la instalaci√≥n de puntos de interrupci√≥n, el registro y las correcciones de prueba para determinar si resuelven el problema. </font><font style="vertical-align: inherit;">Y, desafortunadamente, todo esto, en esencia, se traduce en una seria inversi√≥n de tiempo.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lisis automatizado de fugas de memoria</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiero comenzar esta secci√≥n con el hecho de que no pude encontrar un buen enfoque para automatizar la detecci√≥n de p√©rdidas de memoria. Chrome tiene su propia API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performance.memory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero por razones de privacidad, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no le permite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recopilar datos suficientemente detallados. Como resultado, esta API no se puede usar en producci√≥n para detectar fugas. El Grupo de trabajo de rendimiento web del W3C discuti√≥ anteriormente las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herramientas de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memoria, pero sus miembros a√∫n no han acordado un nuevo est√°ndar dise√±ado para reemplazar esta API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En entornos de prueba, puede aumentar la granularidad de la salida de datos </font></font><code>performance.memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilizando el indicador de Chrome </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--enable-precision-memory-info</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Las instant√°neas de mont√≥n todav√≠a se pueden crear utilizando el propio equipo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chromedriver: takeHeapSnapshot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este equipo tiene las mismas limitaciones que ya hemos discutido. Es probable que si usa este comando, entonces, por las razones descritas anteriormente, tenga sentido llamarlo tres veces, y luego tomar solo lo que recibi√≥ como resultado de su √∫ltima llamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como los oyentes de eventos son la fuente m√°s com√∫n de p√©rdidas de memoria, hablar√© sobre otra t√©cnica de detecci√≥n de p√©rdidas que uso. Consiste en crear parches de mono para la API </font></font><code>addEventListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>removeEventListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en contar los enlaces para verificar que su n√∫mero vuelva a cero. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un ejemplo de c√≥mo se hace esto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En las Herramientas para desarrolladores de Chrome, tambi√©n puede usar la API nativa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getEventListeners</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para averiguar qu√© escuchas de eventos est√°n conectados a un elemento en particular. </font><font style="vertical-align: inherit;">Sin embargo, este comando solo est√° disponible en la barra de herramientas del desarrollador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiero agregar que Matthias Binens me habl√≥ de otra API √∫til de herramientas de Chrome. </font><font style="vertical-align: inherit;">Estos son </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queryObjects</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Con √©l, puede obtener informaci√≥n sobre todos los objetos creados con un determinado constructor. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un buen material sobre este tema sobre la automatizaci√≥n de la detecci√≥n de p√©rdidas de memoria en Puppeteer.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La b√∫squeda y reparaci√≥n de p√©rdidas de memoria en aplicaciones web todav√≠a est√° en pa√±ales. Aqu√≠ habl√© sobre algunas t√©cnicas que, en mi caso, funcionaron bien. Pero debe reconocerse que la aplicaci√≥n de estas t√©cnicas todav√≠a est√° llena de ciertas dificultades y consume mucho tiempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como con cualquier problema de rendimiento, como dicen, una pizca por adelantado vale una libra. Quiz√°s alguien encuentre √∫til preparar las pruebas sint√©ticas apropiadas en lugar de analizar la fuga despu√©s de que ya ha ocurrido. Y si no se trata de una fuga, sino de varias, entonces el an√°lisis del problema puede convertirse en algo as√≠ como pelar cebollas: despu√©s de que se soluciona un problema, se descubre otro y luego este proceso se repite (y todo este tiempo, como las cebollas). , l√°grimas en los ojos). Las revisiones de c√≥digo tambi√©n pueden ayudar a identificar patrones de fuga comunes. Pero esto, si sabes, d√≥nde buscar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScript es un lenguaje que proporciona un trabajo seguro con memoria. </font><font style="vertical-align: inherit;">Por lo tanto, existe cierta iron√≠a en la facilidad con que se producen p√©rdidas de memoria en las aplicaciones web. </font><font style="vertical-align: inherit;">Es cierto que esto se debe en parte a las caracter√≠sticas de las interfaces de usuario del dispositivo. </font><font style="vertical-align: inherit;">Necesita escuchar muchos eventos: eventos de mouse, eventos de desplazamiento, eventos de teclado. </font><font style="vertical-align: inherit;">La aplicaci√≥n de todos estos patrones puede conducir f√°cilmente a p√©rdidas de memoria. </font><font style="vertical-align: inherit;">Pero, esforz√°ndonos por garantizar que nuestras aplicaciones web utilicen la memoria con moderaci√≥n, podemos aumentar su rendimiento y protegerlas de "bloqueos". </font><font style="vertical-align: inherit;">Adem√°s, demostramos respeto por los l√≠mites de recursos de los dispositivos de los usuarios. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Queridos lectores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øHa encontrado p√©rdidas de memoria en sus proyectos web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490610/index.html">Baidu vence a Waymo en California Robomobile Autonomy Rating</a></li>
<li><a href="../es490612/index.html">Enfoque funcional para transacciones en Scala o escriba su propia m√≥nada √∫til</a></li>
<li><a href="../es490616/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 404 (24 de febrero - 1 de marzo de 2020)</a></li>
<li><a href="../es490618/index.html">Tampones de pila de goroutina</a></li>
<li><a href="../es490620/index.html">Cuando escucho las palabras "restaur√≥ la red neuronal", subo para verificar las copias de seguridad</a></li>
<li><a href="../es490624/index.html">Encabezado HTTP de caracter√≠stica-pol√≠tica y control del navegador web</a></li>
<li><a href="../es490626/index.html">Una gu√≠a completa de datos- * atributos HTML</a></li>
<li><a href="../es490628/index.html">¬øQu√© hacer cuando CSS bloquea el an√°lisis de p√°ginas?</a></li>
<li><a href="../es490630/index.html">Carga de matrices NumPy desde disco: comparaci√≥n de memmap () y Zarr / HDF5</a></li>
<li><a href="../es490634/index.html">Eventos digitales en Mosc√∫ del 2 al 8 de marzo.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>