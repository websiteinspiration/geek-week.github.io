<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚úàÔ∏è ‚ô®Ô∏è ‚èèÔ∏è Dan lagi tentang tertanam: mencari bug di proyek Embox üî© ‚ôæ ü•â</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Embox adalah sistem operasi real-time lintas platform, multi-tasking untuk sistem embedded. Ini dirancang untuk bekerja dalam sumber daya komputasi re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Dan lagi tentang tertanam: mencari bug di proyek Embox</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="Gambar 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embox adalah sistem operasi real-time lintas platform, multi-tasking untuk sistem embedded. Ini dirancang untuk bekerja dalam sumber daya komputasi rendah dan memungkinkan Anda untuk menjalankan aplikasi berbasis Linux pada mikrokontroler tanpa menggunakan Linux itu sendiri. Tentu saja, seperti aplikasi lain, bug Embox juga tidak terhindar. Artikel ini dikhususkan untuk analisis kesalahan yang ditemukan dalam kode proyek Embox.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa bulan yang lalu, saya sudah menulis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tentang memeriksa FreeRTOS, OS lain untuk sistem embedded. </font><font style="vertical-align: inherit;">Saya tidak menemukan kesalahan di dalamnya saat itu, tetapi saya menemukannya di perpustakaan yang ditambahkan oleh orang-orang dari Amazon ketika mengembangkan versi FreeRTOS mereka sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel yang Anda lihat sekarang di depan Anda, dalam arti tertentu, melanjutkan tema yang sebelumnya. </font><font style="vertical-align: inherit;">Kami sering menerima permintaan untuk memeriksa FreeRTOS, dan kami melakukannya. </font><font style="vertical-align: inherit;">Kali ini, tidak ada permintaan untuk memeriksa proyek tertentu, tetapi saya mulai menerima surat dan komentar dari pengembang yang menyertainya dan yang menginginkan lebih. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nah, edisi baru PVS-Studio untuk majalah Embedded telah matang dan ada di hadapan Anda. </font><font style="vertical-align: inherit;">Selamat menonton!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analisis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analisis dilakukan dengan menggunakan PVS-Studio - penganalisa kode statis untuk C, C ++, C # dan Java. Sebelum analisis, proyek perlu dirakit - jadi kami akan yakin bahwa kode proyek berfungsi, dan kami juga akan memberikan kesempatan kepada penganalisa untuk mengumpulkan informasi perakitan yang dapat berguna untuk verifikasi kode yang lebih baik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instruksi dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositori resmi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox menawarkan kemampuan untuk membangun di bawah sistem yang berbeda (Arch Linux, macOS, Debian) dan menggunakan Docker. Saya memutuskan untuk menambahkan beberapa variasi dalam hidup saya dan membangun serta menganalisis dari bawah Debian, yang baru-baru ini saya instal di mesin virtual saya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perakitan berjalan lancar. </font><font style="vertical-align: inherit;">Sekarang perlu untuk melakukan analisis. </font><font style="vertical-align: inherit;">Debian adalah salah satu sistem berbasis PVS-Studio Linux yang didukung. </font><font style="vertical-align: inherit;">Cara mudah untuk memeriksa proyek dari Linux adalah dengan mengkompilasi jejak. </font><font style="vertical-align: inherit;">Ini adalah mode khusus di mana penganalisa mengumpulkan semua informasi yang diperlukan tentang perakitan sehingga Anda dapat memulai analisis dengan satu klik. </font><font style="vertical-align: inherit;">Yang perlu saya lakukan adalah: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Unduh dan instal PVS-Studio; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Luncurkan pelacakan perakitan dengan membuka folder dengan Embox dan mengetik di terminal</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Setelah menunggu perakitan selesai, jalankan perintah:</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Konversi laporan mentah ke format apa pun yang nyaman bagi Anda. </font><font style="vertical-align: inherit;">Alat analisis dilengkapi dengan utilitas khusus PlogConverter, yang dengannya Anda dapat melakukan ini. </font><font style="vertical-align: inherit;">Misalnya, perintah untuk mengonversi laporan ke daftar tugas (untuk dilihat, misalnya, di QtCreator) akan terlihat seperti ini:</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua! </font><font style="vertical-align: inherit;">Butuh waktu tidak lebih dari 15 menit untuk menyelesaikan poin ini. </font><font style="vertical-align: inherit;">Laporan sudah siap, sekarang Anda dapat melihat kesalahan. </font><font style="vertical-align: inherit;">Baiklah, mari kita mulai :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siklus aneh</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu kesalahan yang ditemukan oleh penganalisis adalah loop while aneh:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">V715 Operator</font></a><font style="vertical-align: inherit;"> 'while' memiliki tubuh kosong. </font><font style="vertical-align: inherit;">Pola mencurigakan terdeteksi: 'while (expr) {...} while (dp.skip! = 0);'. </font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Lingkaran yang sangat aneh. </font><font style="vertical-align: inherit;">Ekspresi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while (dp.skip! = 0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditulis dua kali, sekali tepat di atas loop, dan yang kedua tepat di bawahnya. </font><font style="vertical-align: inherit;">Sebenarnya, sekarang ini adalah dua siklus yang berbeda: satu berisi ekspresi dalam kurung kurawal, dan yang kedua kosong. </font><font style="vertical-align: inherit;">Dalam hal ini, siklus kedua tidak akan pernah dieksekusi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di bawah ini adalah ... do loop sementara dengan kondisi yang sama, yang membuat saya berpikir: loop aneh awalnya dimaksudkan sebagai do ... sementara, tetapi ada sesuatu yang salah. </font><font style="vertical-align: inherit;">Saya pikir ini bagian dari kode dengan probabilitas tinggi mengandung kesalahan logis.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memori bocor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya, bukan tanpa mereka.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsi ini menciptakan variabel lokal </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di dalam dirinya sendiri </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pointer ini diberikan alamat lokasi memori baru yang dialokasikan secara internal menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika masalah terjadi ketika mengalokasikan memori, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mengembalikan pointer nol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana jika hanya satu blok memori yang dialokasikan? </font><font style="vertical-align: inherit;">Fungsi akan macet tanpa ada memori yang dibebaskan. </font><font style="vertical-align: inherit;">Situs yang kebetulan dialokasikan akan tetap berada dalam memori tanpa ada kesempatan untuk mengaksesnya lagi dan membebaskannya untuk digunakan lebih lanjut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh lain dari kebocoran memori sedikit lebih cerah:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini, programmer telah menunjukkan keakuratan dan memproses kasus dengan benar yang memungkinkan hanya mengalokasikan satu memori. </font><font style="vertical-align: inherit;">Diproses dengan benar ... dan secara harfiah dalam ekspresi berikutnya membuat kesalahan lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berkat cek yang ditulis dengan benar, kami dapat memastikan bahwa pada saat ekspresi dieksekusi, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kembali -EINVAL; </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami pasti akan memiliki memori yang dialokasikan untuk </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jadi, dengan kembalinya fungsi, kita akan mengalami dua kebocoran sekaligus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya pikir mendapatkan kebocoran memori pada perangkat yang disematkan bisa lebih menyakitkan daripada pada PC klasik. </font><font style="vertical-align: inherit;">Dalam kondisi ketika sumber daya sangat terbatas, Anda perlu memantaunya dengan cermat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pointer salah penanganan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode kesalahan berikut singkat dan cukup sederhana:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 Pointer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 'sdev' digunakan sebelum diverifikasi terhadap nullptr. Periksa baris: 116, 118. scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><i><font style="vertical-align: inherit;">adalah</font></i><font style="vertical-align: inherit;"> dereferenced sebelum itu diperiksa NULL. Adalah logis untuk berasumsi bahwa jika seseorang menulis cek semacam itu, maka penunjuk ini mungkin nol. Dalam kasus ini, kita memiliki potensi referensi dari pointer nol di string </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahannya adalah bahwa cek tidak terletak di tempat yang diperlukan. Seharusnya muncul setelah baris " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", tetapi sebelum baris " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Maka potensi banding ke alamat nol dapat dihindari.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio menemukan dua kesalahan lagi dalam kode berikut:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769 Pointer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 'xs-&gt; extra.rec.in_base' dalam ekspresi 'xs-&gt; extra.rec.in_base + recvsz' bisa berupa nullptr. </font><font style="vertical-align: inherit;">Dalam kasus seperti itu, nilai yang dihasilkan akan menjadi tidak masuk akal dan tidak boleh digunakan. </font><font style="vertical-align: inherit;">Periksa baris: 56, 48. xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pointer 'buff' di ekspresi 'buff + recvsz' bisa berupa nullptr. </font><font style="vertical-align: inherit;">Dalam kasus seperti itu, nilai yang dihasilkan akan menjadi tidak masuk akal dan tidak boleh digunakan. </font><font style="vertical-align: inherit;">Periksa baris: 61, 48. xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pointer buf diinisialisasi dengan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan kemudian nilainya digunakan untuk menginisialisasi pointer lain. Fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat mengembalikan pointer nol, dan ini harus selalu diperiksa. Akan terlihat bahwa di sini adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menegaskan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memeriksa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan segala sesuatu harus bekerja dengan baik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi tidak! Faktanya adalah bahwa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menegaskan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 's digunakan untuk debugging, dan ketika membangun proyek dalam konfigurasi Rilis, ini </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menegaskan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan dihapus. Ternyata ketika bekerja di Debug, program akan bekerja dengan benar, dan ketika membangun dalam Release, null pointer "berjalan" lebih jauh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam operasi aritmatika salah, karena hasil operasi semacam itu tidak masuk akal, dan hasil seperti itu tidak dapat digunakan. </font><font style="vertical-align: inherit;">Inilah yang diperingatkan oleh penganalisa kita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa orang mungkin berpendapat bahwa tidak memeriksa pointer setelah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tidak kenal takut. </font><font style="vertical-align: inherit;">Seperti, pada akses pertama oleh pointer nol, sinyal / pengecualian akan terjadi dan tidak akan ada yang salah. </font><font style="vertical-align: inherit;">Dalam praktiknya, semuanya jauh lebih rumit, dan jika kurangnya verifikasi tampaknya tidak berbahaya bagi Anda, saya sarankan Anda melihat artikel " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa penting untuk memeriksa apa fungsi malloc dikembalikan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penanganan array yang salah</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahan berikut ini sangat mirip dengan contoh sebelum terakhir:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nilai indeks 'offt' diperiksa setelah digunakan. </font><font style="vertical-align: inherit;">Mungkin ada kesalahan dalam logika program. </font><font style="vertical-align: inherit;">fat_common.c 1813 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Variabel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pertama kali digunakan di dalam operasi pengindeksan, dan hanya kemudian diperiksa bahwa nilainya lebih besar dari nol. </font><font style="vertical-align: inherit;">Tetapi apa yang terjadi jika </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nama</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ternyata berupa string kosong? </font><font style="vertical-align: inherit;">Fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan mengembalikan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kemudian bidikan keras di kaki. </font><font style="vertical-align: inherit;">Program akan mengakses pada indeks negatif, yang akan mengarah pada perilaku yang tidak terdefinisi. </font><font style="vertical-align: inherit;">Apa pun bisa terjadi, termasuk crash program. </font><font style="vertical-align: inherit;">Kekacauan!</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="Gambar 1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kondisi mencurigakan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di mana tanpa mereka? </font><font style="vertical-align: inherit;">Kami menemukan kesalahan seperti itu di setiap proyek yang kami periksa.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pertimbangkan untuk memeriksa kondisi. Argumen '0x0010' dari '|' operasi bitwise mengandung nilai bukan nol. index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memahami apa kesalahannya, lihat definisi konstanta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata dalam ekspresi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (cloexec | FD_CLOEXEC) di</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebelah kanan bitwise ‚Äúatau‚Äù selalu ada konstanta bukan nol. </font><font style="vertical-align: inherit;">Hasil dari operasi semacam itu akan selalu berupa angka yang bukan nol. </font><font style="vertical-align: inherit;">Dengan demikian, ungkapan ini akan selalu setara dengan ekspresi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (true)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan kami akan selalu memproses hanya cabang if-expression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menduga bahwa konstanta makro ini digunakan untuk pra-konfigurasi sistem operasi Embox, tetapi meskipun demikian kondisi yang selalu benar ini terlihat aneh. </font><font style="vertical-align: inherit;">Mungkin mereka ingin menggunakan operator </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp; di</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sini </font><font style="vertical-align: inherit;">, tetapi mereka membuat kesalahan ketik.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divisi integer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahan berikut ini terkait dengan satu fitur bahasa C:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">V636 Ekspresi</font></a><font style="vertical-align: inherit;"> '1024 / dev_bsize' secara implisit dilemparkan dari tipe 'int' ke tipe 'float'. Pertimbangkan untuk menggunakan pemeran tipe eksplisit untuk menghindari hilangnya bagian fraksional. Contoh: double A = (double) (X) / Y; ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fitur ini adalah sebagai berikut: jika kita membagi dua nilai integer, maka hasil pembagian akan menjadi integer. Dengan demikian, pembagian akan terjadi tanpa sisa, atau, dengan kata lain, bagian fraksional akan dibuang dari hasil pembagian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terkadang programmer melupakannya, dan kesalahan seperti ini terjadi. SBSIZE konstan dan variabel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize masing</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">masing</font></i><font style="vertical-align: inherit;"> memiliki tipe integer (int, dan size_t). Oleh karena itu, hasil dari </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ekspresi SBSIZE / dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">juga akan bertipe integer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi tunggu sebentar. </font><font style="vertical-align: inherit;">Variabel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah tipe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Jelas, programmer diharapkan mendapatkan hasil pembagian fraksional. </font><font style="vertical-align: inherit;">Ini dapat diverifikasi lebih lanjut jika Anda memperhatikan penggunaan lebih lanjut dari variabel ini. </font><font style="vertical-align: inherit;">Misalnya, fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di mana </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dilewatkan sebagai parameter ketiga, memiliki tanda tangan berikut:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demikian pula, di tempat lain di mana variabel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor digunakan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : semuanya menunjukkan bahwa angka floating-point diharapkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memperbaiki kesalahan ini, cukup dengan melemparkan salah satu operan divisi ke tipe nyata. </font><font style="vertical-align: inherit;">Contohnya:</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maka hasil pembagian akan menjadi angka pecahan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Input tidak terverifikasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahan berikut ini terkait dengan penggunaan data yang tidak diverifikasi yang diterima dari luar program.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Data tercemar yang tidak dicentang digunakan dalam indeks: 'strlen (&amp; teks [0])'. </font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, pertimbangkan apa fungsi pengembalian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika berhasil membaca suatu baris, fungsi mengembalikan sebuah pointer ke baris ini. </font><font style="vertical-align: inherit;">Jika pembacaan menemui </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akhir-file</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebelum setidaknya satu elemen dibaca, atau jika terjadi kesalahan input, fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mengembalikan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi ungkapannya adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets (....)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memeriksa apakah input yang diterima benar. Tapi ada satu peringatan. Jika Anda mentransfer terminal nol sebagai karakter pertama yang akan dibaca (ini dapat dilakukan, misalnya, dengan menekan Ctrl + 2 dalam mode Legacy dari baris perintah Windows), fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gadget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menganggapnya tanpa mengembalikan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dalam hal ini, garis tempat rekaman dibuat hanya akan memiliki satu elemen - ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang akan terjadi selanjutnya? Ekspresi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen (&amp; teks [0])</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan mengembalikan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Akibatnya, kami mendapat panggilan indeks negatif:</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, kita dapat "membalikkan" program dengan hanya meneruskan karakter terminasi baris ke input. </font><font style="vertical-align: inherit;">Ini aneh, dan berpotensi digunakan untuk menyerang sistem menggunakan Embox. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kolega saya, yang mengembangkan aturan diagnostik ini, bahkan membuat catatan dengan contoh serangan seperti itu pada proyek NcFTP:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sarankan untuk melihat apakah Anda masih tidak percaya pada kesempatan seperti itu :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga, penganalisa menemukan dua tempat lagi dengan kesalahan yang sama:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Data tercemar yang tidak diperiksa digunakan dalam indeks: 'strlen (&amp; from [0])'. </font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Data tercemar yang tidak dicentang digunakan dalam indeks: 'strlen (&amp; to [0])'. </font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA adalah seperangkat pedoman dan pedoman untuk menulis kode C dan C ++ yang aman untuk sistem tertanam yang sangat bertanggung jawab. </font><font style="vertical-align: inherit;">Dalam arti tertentu, ini adalah manual pelatihan, yang mengikuti yang akan memungkinkan Anda untuk menyingkirkan tidak hanya apa yang disebut "bau kode", tetapi juga melindungi program Anda dari kerentanan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA digunakan di mana kehidupan manusia bergantung pada kualitas sistem tertanam Anda: dalam industri medis, otomotif, pesawat terbang, dan militer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio memiliki </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seperangkat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aturan diagnostik yang </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">luas</font></a><font style="vertical-align: inherit;"> yang memungkinkan Anda memeriksa kode Anda untuk kesesuaian dengan standar MISRA C dan MISRA C ++. </font><font style="vertical-align: inherit;">Secara default, mode dengan diagnostik ini dimatikan, tetapi karena kami mencari kesalahan dalam proyek untuk sistem embedded, saya tidak bisa melakukannya tanpa MISRA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inilah yang berhasil saya temukan:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] Alamat dari array lokal 'namebuf' tidak boleh disimpan di luar lingkup array ini. ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analyzer mendeteksi tugas mencurigakan yang berpotensi menyebabkan perilaku tidak terdefinisi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat lebih dekat kode ini. Di sini, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah array yang dibuat dalam lingkup fungsi lokal, dan pointer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diteruskan ke fungsi dengan pointer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menurut sintaks C, nama array adalah penunjuk ke elemen pertama di area memori di mana array disimpan. Ternyata ekspresi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf akan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menetapkan alamat array </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ke variabel yang ditunjukkan oleh </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Karena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dilewatkan ke fungsi oleh pointer, perubahan nilai yang ditunjukkannya akan tercermin di tempat di mana fungsi dipanggil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata setelah fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink menyelesaikan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pekerjaannya, parameter ketiga akan menunjukkan area yang pernah ditempati array </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hanya ada satu "tetapi": karena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah array yang dicadangkan di stack, itu akan dihapus ketika fungsi keluar. Dengan demikian, pointer yang ada di luar fungsi akan menunjuk ke memori yang dibebaskan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang akan ada di alamat itu? </font><font style="vertical-align: inherit;">Tidak mungkin untuk diprediksi. </font><font style="vertical-align: inherit;">Ada kemungkinan bahwa untuk beberapa waktu isi array akan terus berada dalam memori, atau ada kemungkinan bahwa program akan segera menghapus area ini dengan sesuatu yang lain. </font><font style="vertical-align: inherit;">Secara umum, mengakses alamat seperti itu akan mengembalikan nilai yang tidak ditentukan, dan menggunakan nilai seperti itu adalah kesalahan besar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penganalisa juga menemukan kesalahan lain dengan peringatan yang sama:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] Alamat variabel lokal 'dst_haddr' tidak boleh disimpan di luar ruang lingkup variabel ini. </font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="Gambar 6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya suka bekerja dengan proyek Embox. Terlepas dari kenyataan bahwa saya tidak menuliskan semua kesalahan yang ditemukan dalam artikel, jumlah total peringatan relatif kecil, dan secara umum, kode proyek ditulis dengan kualitas tinggi. Oleh karena itu, saya mengucapkan terima kasih kepada para pengembang, serta kepada mereka yang berkontribusi pada proyek atas nama komunitas. Kamu hebat! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mengambil kesempatan ini untuk menyampaikan salam kepada para pengembang dari Tula. Saya akan percaya bahwa di St. Petersburg saat ini tidak terlalu dingin :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sinilah artikel saya berakhir. Saya harap Anda menikmati membacanya, dan Anda menemukan sesuatu yang baru untuk diri Anda sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda tertarik pada PVS-Studio dan ingin memverifikasi sendiri beberapa proyek yang menggunakannya, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unduh dan coba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ini akan memakan waktu tidak lebih dari 15 menit.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda ingin berbagi artikel ini dengan audiens yang berbahasa Inggris, silakan gunakan tautan ke terjemahan: George Gribkov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang tertanam lagi: mencari bug di proyek Embox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id499970/index.html">Kami mempelajari mesin VoIP Mediastreamer2. Bagian 12</a></li>
<li><a href="../id499972/index.html">Semoga acara online dicerna</a></li>
<li><a href="../id499974/index.html">Game 3D di Instagram Javascript, atau jalur penerbangan sosis</a></li>
<li><a href="../id499978/index.html">Terjemahan buku Andrew Un, Passion for Machine Learning, Bab 36 dan 37</a></li>
<li><a href="../id499982/index.html">Rencana Penguji Pemula: Dari "Masukkan TI" ke "Saya Seorang Insinyur!"</a></li>
<li><a href="../id499988/index.html">Gula dan COVID-19</a></li>
<li><a href="../id499990/index.html">Geocoding Bagaimana cara mengikat 250 ribu alamat ke koordinat dalam 10 menit?</a></li>
<li><a href="../id499992/index.html">Desain teknologi untuk implementasi sistem penagihan untuk klien korporat (bagian 2)</a></li>
<li><a href="../id499994/index.html">Kapan coronavirus akan berakhir</a></li>
<li><a href="../id500000/index.html">Untuk Radio Day. Komunikasi - saraf perang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>