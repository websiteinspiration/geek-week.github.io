<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùï ü§∏üèæ ü•Å Ligue para bibliotecas compartilhadas do Similink üíáüèø üë®üèº‚Äçüè≠ üêâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr! 
 Apresento a voc√™ a tradu√ß√£o de um artigo do meu colega Mikhail sobre m√©todos para chamar bibliotecas compartilhadas no Simulink. Por que fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ligue para bibliotecas compartilhadas do Similink</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oi Habr! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apresento a voc√™ a tradu√ß√£o de um artigo do meu colega Mikhail sobre m√©todos para chamar bibliotecas compartilhadas no Simulink. Por que foi criado? O fato √© que muitas empresas j√° possuem muitos modelos legados que gostar√≠amos de reutilizar e muitas vezes nos perguntam: ‚ÄúComo posso integrar o legado ao Simulink? E se meu legado estiver na forma de uma DLL? ‚Äù Portanto, o artigo original foi escrito. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debaixo do gato, s√£o discutidas v√°rias maneiras de chamar bibliotecas compartilhadas no Simulink. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as altera√ß√µes no c√≥digo foram feitas com a permiss√£o de Mikhail e feitas para n√£o sobrecarregar o artigo.</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo mostra como usar fun√ß√µes de bibliotecas compartilhadas nos modelos do Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que precisamos incorporar a biblioteca exlib no Simulink. </font><font style="vertical-align: inherit;">Seu c√≥digo est√° contido nas fontes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esta √© uma biblioteca muito simples, contendo tr√™s fun√ß√µes: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_init (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - abre um arquivo para grava√ß√£o. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print (dados flutuantes)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - grava dados em um arquivo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fecha o arquivo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montagem da biblioteca</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, compile a biblioteca. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta etapa n√£o √© necess√°ria se a biblioteca for pr√©-compilada e entregue como um arquivo bin√°rio. Nesse caso, voc√™ pode ir imediatamente para a etapa 3, mas lembre-se de que, para trabalhar com a biblioteca, √© necess√°rio obter o arquivo .dll (ou .so para Linux) e o arquivo de cabe√ßalho correspondente (.h) do provedor da biblioteca. Para o Windows, voc√™ tamb√©m precisar√° de um arquivo .lib, que n√£o √© uma biblioteca est√°tica, mas a chamada biblioteca de importa√ß√£o. Essa biblioteca de importa√ß√£o √© necess√°ria para vincula√ß√£o impl√≠cita. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, usaremos o comando mex MATLAB, que chama o compilador de host ativo atual para compilar a biblioteca compartilhada (exlib.dll no Windows e exlib.so no Linux). √â importante garantir que o comando tenha sido executado primeiro.</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para selecionar um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilador suportado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora use mex para compilar a biblioteca:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para construir uma biblioteca</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificando a biblioteca compilada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a compila√ß√£o, voc√™ precisa garantir que a biblioteca resultante possa ser carregada e usada no MATLAB:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para verificar a biblioteca</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora que garantimos que tudo funcione, vamos come√ßar com o Simulink!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocando uma Biblioteca Compartilhada Usando Fun√ß√µes S</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As fun√ß√µes S permitem usar o c√≥digo C no Simulink. </font><font style="vertical-align: inherit;">Essa abordagem permite ao usu√°rio desenvolver qualquer c√≥digo C necess√°rio para carregar a biblioteca e chamar suas fun√ß√µes. </font><font style="vertical-align: inherit;">Em seguida, esse c√≥digo √© compilado em um arquivo bin√°rio reconhecido pelo Simulink e vinculado a uma biblioteca compartilhada. </font><font style="vertical-align: inherit;">Esse bin√°rio √© chamado de fun√ß√£o S. </font><font style="vertical-align: inherit;">O Simulink possui um bloco para chamar essa fun√ß√£o S. </font><font style="vertical-align: inherit;">Existem v√°rias abordagens para criar fun√ß√µes S no Simulink.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando a ferramenta Legacy Code</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira abordagem √© usar a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ferramenta Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma ferramenta que ajuda a criar automaticamente fun√ß√µes S de acordo com as especifica√ß√µes criadas usando o MATLAB. </font><font style="vertical-align: inherit;">Neste exemplo, a fun√ß√£o S est√° vinculada √† biblioteca de importa√ß√£o (no Windows, precisamos do arquivo * .lib correspondente) e as fun√ß√µes da biblioteca s√£o chamadas. </font><font style="vertical-align: inherit;">Essa abordagem √© chamada de liga√ß√£o impl√≠cita. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa inicializar a estrutura da Ferramenta de C√≥digo Legado</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para inicializar a estrutura da Ferramenta de C√≥digo Legado</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crie uma fun√ß√£o S, compile e vincule-a:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim, crie o bloco Simulink:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escrevendo fun√ß√µes S manualmente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda abordagem √© escrever suas pr√≥prias fun√ß√µes S para carregar uma biblioteca compartilhada e chamar fun√ß√µes dessa biblioteca. </font><font style="vertical-align: inherit;">Essa abordagem usar√° vincula√ß√£o expl√≠cita, tamb√©m chamada de vincula√ß√£o em tempo de execu√ß√£o. </font><font style="vertical-align: inherit;">A solu√ß√£o mais f√°cil √© adaptar a fun√ß√£o S que foi gerada automaticamente anteriormente pela Legacy Code Tool. </font><font style="vertical-align: inherit;">Neste exemplo, as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes mdlStart</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">s√£o </font></i><i><font style="vertical-align: inherit;">modificadas</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veja como essas fun√ß√µes cuidam da modifica√ß√£o:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compile a fun√ß√£o S resultante:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o S-Function Builder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra abordagem √© usar o bloco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Essa √© uma unidade especial que pode ser vista como um cruzamento entre a Legacy Code Tool e as fun√ß√µes S escritas √† m√£o em termos de complexidade. </font><font style="vertical-align: inherit;">O S-Function Builder fornece uma interface gr√°fica que descreve as caracter√≠sticas da sua fun√ß√£o S, e a fun√ß√£o S √© criada automaticamente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem algumas limita√ß√µes de desempenho e problemas com o uso do S-Function Builder. </font><font style="vertical-align: inherit;">Atualmente, isso √© considerado uma abordagem obsoleta para a cria√ß√£o de fun√ß√µes S. </font><font style="vertical-align: inherit;">Recomenda-se usar o bloco de fun√ß√µes C, que apareceu no release do R2020a e ser√° discutido posteriormente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocando uma Biblioteca Compartilhada Usando a Fun√ß√£o MATLAB </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O bloco de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite usar a linguagem MATLAB para descrever um algoritmo personalizado no Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para chamar a biblioteca compartilhada da fun√ß√£o MATLAB, use a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que s√≥ pode ser usada no corpo da fun√ß√£o MATLAB (e n√£o no MATLAB). </font><font style="vertical-align: inherit;">O Coder.ceval n√£o requer o codificador do MATLAB para funcionar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥digo para o bloco de fun√ß√£o MATLAB chamando a biblioteca compartilhada:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa abordagem tem uma desvantagem - a falta de uma boa maneira de chamar a fun√ß√£o de conclus√£o no final da simula√ß√£o (em compara√ß√£o com o bloco do sistema MATLAB). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode definir a fun√ß√£o de conclus√£o para o modelo configurando exlib_term (); nas configura√ß√µes do modelo na categoria </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alvo de simula√ß√£o -&gt; C√≥digo personalizado -&gt; Fun√ß√£o Terminar</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOTA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se o par√¢metro ‚ÄúImport custom code‚Äù estiver definido nas configura√ß√µes do modelo, ser√° necess√°rio especificar todas as depend√™ncias de c√≥digo no painel ‚ÄúSimulation Target‚Äù (em vez de usar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Se esse par√¢metro n√£o estiver definido, voc√™ poder√° combinar as configura√ß√µes do Simulation Target, coder.cinclude e coder.updateBuildInfo.</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Outra maneira √© manter depend√™ncias usando</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e chame </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por conven√ß√£o, conforme demonstrado no exemplo acima. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocando uma Biblioteca Compartilhada do Stateflow </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ quiser usar as fun√ß√µes da biblioteca compartilhada nos diagramas do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , essas fun√ß√µes dever√£o ser chamadas diretamente do Stateflow. A documenta√ß√£o do Stateflow tem exemplos que mostram como fazer isso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chamar uma fun√ß√£o externa no Stateflow √© muito simples - voc√™ precisa especificar o nome da fun√ß√£o no diagrama do Stateflow: </font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, voc√™ precisa configurar os par√¢metros do modelo para que o Stateflow saiba onde procurar essas fun√ß√µes externas. Nas configura√ß√µes de </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simula√ß√£o de destino -&gt; C√≥digo personalizado -&gt; Bibliotecas, √©</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necess√°rio inserir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.lib (ou exlib.so no Linux)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Destino da Simula√ß√£o -&gt; C√≥digo Personalizado -&gt; Arquivo de Cabe√ßalho, √©</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necess√°rio inserir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tamb√©m √© importante n√£o esquecer de especificar a fun√ß√£o de conclus√£o. AT</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o Target Simulation -&gt; Custom Code -&gt; Terminate</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve especificar</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exlib_term (); </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note-se que as informa√ß√µes nesta se√ß√£o se aplica a diagramas Stateflow que usam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a linguagem de a√ß√£o C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se o diagrama Stateflow usar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a linguagem de a√ß√£o MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° necess√°rio coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como √© o caso da Fun√ß√£o MATLAB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamando uma Biblioteca Compartilhada Usando o Bloco Sistema MATLAB </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O bloco Sistema MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite usar objetos do sistema no Simulink. </font><font style="vertical-align: inherit;">Mais informa√ß√µes sobre este bloco podem ser encontradas na documenta√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O suporte para objetos do sistema apareceu no Simulink no lan√ßamento do R2013b. </font><font style="vertical-align: inherit;">Muitas pessoas usam objetos do sistema porque facilitam a defini√ß√£o das fun√ß√µes de inicializa√ß√£o, simula√ß√£o e conclus√£o. </font><font style="vertical-align: inherit;">Al√©m disso, os objetos do sistema podem usar o c√≥digo MATLAB auxiliar para essas fun√ß√µes - por exemplo, para dados de pr√© e p√≥s-processamento de uma fun√ß√£o step - tudo sem escrever o c√≥digo C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° a apar√™ncia do objeto do sistema usado no bloco MATLAB System:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de Objeto do Sistema</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chame bibliotecas compartilhadas usando o bloco C Caller </font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O bloco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite chamar fun√ß√µes C diretamente do Simulink. Mais informa√ß√µes sobre este bloco podem ser encontradas na documenta√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© uma abordagem relativamente nova que apareceu pela primeira vez no MATLAB R2018b. Seu principal objetivo √© tornar chamadas de fun√ß√£o e bibliotecas C no Simulink extremamente simples. Mas tem limita√ß√µes, sobre as quais voc√™ pode ler na documenta√ß√£o deste bloco. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foi adicionado ao </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Bibliotecas</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Header</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nas configura√ß√µes do modelo, basta clicar no bot√£o "Atualizar c√≥digo personalizado" no bloco C Caller, para ver todas as fun√ß√µes contidas na biblioteca.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de selecionar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_print</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fun√ß√£o </font><font style="vertical-align: inherit;">, o di√°logo de especifica√ß√£o de porta √© preenchido automaticamente: </font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, novamente, voc√™ precisa adicionar os </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chamadas de fun√ß√£o </font><font style="vertical-align: inherit;">para o destino da simula√ß√£o. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode adicionar outros blocos do C Caller para chamar diretamente as fun√ß√µes de inicializa√ß√£o e finaliza√ß√£o. </font><font style="vertical-align: inherit;">Esses blocos C Caller precisam ser colocados nos subsistemas Initialize Function e Terminate Function. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode considerar o seguinte exemplo no Stateflow: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agendar subsistemas para execu√ß√£o em hor√°rios espec√≠ficos</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Execute a simula√ß√£o:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocando Bibliotecas Compartilhadas Usando o Bloco de Fun√ß√£o C</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima adi√ß√£o √† integra√ß√£o de c√≥digo externo no Simulink √© o bloco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele apareceu no R2020a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele se parece com o bloco C Caller em termos de facilidade de uso, mas permite criar um wrapper C em torno de fun√ß√µes importadas (portanto, esse bloco se assemelha ao S-Function Builder). Mas, provavelmente, o cen√°rio principal para o uso do bloco C Function n√£o √© chamar fun√ß√µes C existentes, mas escrever pequenos peda√ßos de c√≥digo C, se esse c√≥digo for necess√°rio no aplicativo. Por exemplo, voc√™ pode precisar acessar registros de hardware ou as fun√ß√µes internas do compilador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o esque√ßa de adicionar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nas configura√ß√µes </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulation Target -&gt; Libraries"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nas configura√ß√µes </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Destino da simula√ß√£o -&gt; arquivo de cabe√ßalho"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nas configura√ß√µes do modelo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, nas configura√ß√µes do bloco de fun√ß√µes C, √© necess√°rio adicionar um caractere para os dados de entrada com o tipo de dado √∫nico e especificar o c√≥digo de sa√≠da, in√≠cio e fim:</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamando bibliotecas compartilhadas geradas usando o Embedded Coder </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos cen√°rios para o uso do Embedded Coder √© a gera√ß√£o autom√°tica de c√≥digo C a partir do modelo Simulink e o empacotamento desse c√≥digo em uma biblioteca compartilhada. A documenta√ß√£o tamb√©m possui um exemplo que mostra como gerar automaticamente uma biblioteca compartilhada e cham√°-la a partir de um aplicativo externo escrito em C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que, se voc√™ precisar executar o algoritmo ou parte do algoritmo como c√≥digo C no mesmo modelo do Simulink, √© melhor usar Fun√ß√µes S do Simulink Coder ou simula√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">software no loop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No entanto, se a biblioteca compartilhada gerada pelo Embedded Coder for usada para modelagem semi-natural, talvez seja necess√°rio integrar a mesma biblioteca ao modelo maior usado por outros desenvolvedores e, assim, proteger sua propriedade intelectual. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhar com uma biblioteca compartilhada gerada pelo Embedded Coder n√£o √© diferente de trabalhar com uma biblioteca compartilhada, que foi usada no artigo. </font><font style="vertical-align: inherit;">Considere um modelo simples que possui duas entradas e uma sa√≠da:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a montagem do modelo, obtemos um arquivo .dll (.so no Linux), um arquivo .lib (uma biblioteca de importa√ß√£o para .dll) e um arquivo .exp (um arquivo de exporta√ß√£o para se comunicar com .dll).</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A biblioteca compartilhada gerada exporta os seguintes caracteres:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por padr√£o, entradas e sa√≠das s√£o exportadas como caracteres globais, e as fun√ß√µes de inicializa√ß√£o, etapa e conclus√£o seguem a conven√ß√£o de nomenclatura do modelo. </font><font style="vertical-align: inherit;">Se necess√°rio, voc√™ pode configurar prot√≥tipos de fun√ß√µes, nomes de s√≠mbolos e muito mais (a discuss√£o dessas configura√ß√µes est√° al√©m do escopo deste artigo). </font><font style="vertical-align: inherit;">Nesse modelo, o prot√≥tipo da fun√ß√£o step do modelo √© definido como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step (In1, In2)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para chamar essas fun√ß√µes, voc√™ precisa usar um dos m√©todos listados acima. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode usar a fun√ß√£o MATLAB (para simplificar, chamamos apenas a fun√ß√£o step):</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute a simula√ß√£o e veja seus resultados:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">achados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo descreve v√°rias abordagens para chamar bibliotecas compartilhadas dos modelos Simulink. </font><font style="vertical-align: inherit;">Links impl√≠citos e expl√≠citos foram considerados. </font><font style="vertical-align: inherit;">Todos os m√©todos t√™m seus pr√≥s e contras, e sua adequa√ß√£o depende do fluxo de trabalho, requisitos e metas espec√≠ficos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><font style="vertical-align: inherit;">abordagem da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona melhor ao implementar um link impl√≠cito com uma biblioteca compartilhada, porque nesse caso podemos simplesmente chamar fun√ß√µes diretamente da biblioteca, e o vinculador cuidar√° do resto. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O bloco do sistema MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© outra abordagem que oferece os seguintes benef√≠cios:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excelente conformidade com o paradigma das fun√ß√µes de inicializa√ß√£o, etapa e conclus√£o, permitindo manter todas essas fun√ß√µes dentro do pr√≥prio bloco, e n√£o na escala do modelo</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A desvantagem de usar o bloco de fun√ß√£o MATLAB √© que seu uso pode levar a uma sobrecarga adicional durante a gera√ß√£o do c√≥digo. Portanto, a ferramenta Legacy Code Tool e S ainda s√£o preferidas para gerar c√≥digo de produ√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma fun√ß√£o S escrita √† m√£o √© mais adequada para implementar um link expl√≠cito para uma biblioteca compartilhada. Nesse caso, voc√™ precisa usar fun√ß√µes como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para poder chamar fun√ß√µes. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O bloco C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> introduzido no R2018b √© de longe a maneira mais f√°cil de chamar fun√ß√µes C, mas tem suas limita√ß√µes. O mesmo pode ser dito para o bloco </font><b><font style="vertical-align: inherit;">C Function</font></b><font style="vertical-align: inherit;"> .</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que √© a mais nova adi√ß√£o ao R2020a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baixe fontes e modelos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt503894/index.html">An√∫ncio da reuni√£o on-line NskTechTalks # 12: onde o desenvolvedor de front-end pode crescer e se nada der?</a></li>
<li><a href="../pt503898/index.html">Front-end remoto de um dia</a></li>
<li><a href="../pt503902/index.html">Como fazer com que os vizinhos trabalhem em seu projeto, ou InnerSource para um banco</a></li>
<li><a href="../pt503904/index.html">O mundo en mundos, ou matem√°tica para as humanidades</a></li>
<li><a href="../pt503906/index.html">LabVIEW NXG - Tipos de dados simples e coer√ß√£o de tipos</a></li>
<li><a href="../pt503910/index.html">Experi√™ncias com pessoas que foram para "udalenka"</a></li>
<li><a href="../pt503916/index.html">Aprendendo a negociar na bolsa. Parte um: configurando um ambiente de teste</a></li>
<li><a href="../pt503918/index.html">Gerenciando pacotes com m√≥dulos Go: um guia pragm√°tico</a></li>
<li><a href="../pt503920/index.html">Como testamos os sistemas de microfone no STM32: a experi√™ncia dos desenvolvedores de dispositivos Yandex</a></li>
<li><a href="../pt503922/index.html">Por que a UE erradica paredes de biscoitos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>