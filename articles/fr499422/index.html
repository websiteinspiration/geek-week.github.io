<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜñ üè° üòº T√©l√©portez le processus sur un autre ordinateur!‚Äâ üë®üèº‚Äçüç≥ ‚úÖ üë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois, un coll√®gue a partag√© ses r√©flexions sur l'API pour les clusters de calcul distribu√©, et j'ai r√©pondu en plaisantant: "De toute √©vidence, un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>T√©l√©portez le processus sur un autre ordinateur!‚Äâ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/499422/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une fois, un coll√®gue a partag√© ses r√©flexions sur l'API pour les clusters de calcul distribu√©, et j'ai r√©pondu en plaisantant: "De toute √©vidence, une API id√©ale serait un simple appel </font></font><code>telefork()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour que votre processus se r√©veille sur chaque machine du cluster, renvoyant la valeur de l'ID d'instance." Mais au final, cette id√©e a pris possession de moi. Je ne pouvais pas comprendre pourquoi il est si stupide et simple, beaucoup plus simple que n'importe quelle API pour le travail √† distance, et pourquoi les syst√®mes informatiques ne semblent pas en √™tre capables. J'ai √©galement sembl√© comprendre comment cela peut √™tre mis en ≈ìuvre, et j'avais d√©j√† un bon nom, qui est la partie la plus difficile de tout projet. J'ai donc commenc√© √† travailler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours du premier week-end, il a fait un prototype de base, et le deuxi√®me week-end a apport√© une d√©mo qui pourrait</font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processus vers une machine virtuelle g√©ante dans le cloud, d√©sactivez le rendu du suivi de chemin sur plusieurs c≈ìurs, puis t√©l√©op√©rez le processus. </font><font style="vertical-align: inherit;">Tout cela est envelopp√© dans une API simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vid√©o montre que le rendu sur une machine virtuelle 64 c≈ìurs dans le cloud se termine en 8 secondes (plus 6 secondes pour le va-et-vient telefork). </font><font style="vertical-align: inherit;">Le m√™me rendu local dans un conteneur sur mon ordinateur portable prend 40 secondes:</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votre navigateur ne prend pas en charge la vid√©o HTML5.</font></font><source src="https://thume.ca/assets/postassets/telefork/telefork-small.mp4" type="video/mp4"></video></div></div></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment est-il possible de t√©l√©porter le processus? </font><font style="vertical-align: inherit;">Voici ce que cet article devrait expliquer! </font><font style="vertical-align: inherit;">L'id√©e de base est qu'√† un niveau bas, le processus Linux n'a que quelques composants. </font><font style="vertical-align: inherit;">Vous avez juste besoin d'un moyen de restaurer chacun d'eux √† partir du donateur, de le transf√©rer sur le r√©seau et de le copier dans le processus clon√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pourriez penser: "Mais comment r√©pliquer [quelque chose de difficile, comme une connexion TCP]?" </font><font style="vertical-align: inherit;">Vraiment. </font><font style="vertical-align: inherit;">En fait, nous ne tol√©rons pas des choses aussi compliqu√©es pour garder le code simple. </font><font style="vertical-align: inherit;">Autrement dit, c'est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">juste une d√©monstration technique amusante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui ne devrait probablement pas √™tre utilis√©e en production. </font><font style="vertical-align: inherit;">Mais elle sait toujours comment t√©l√©porter une large classe de t√¢ches principalement informatiques!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä quoi cela ressemble-t-il</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai impl√©ment√© le code en tant que biblioth√®que Rust, mais th√©oriquement, vous pouvez envelopper le programme dans l'API C, puis ex√©cuter les liaisons FFI pour t√©l√©porter m√™me le processus Python. </font><font style="vertical-align: inherit;">L'impl√©mentation ne comprend que 500 lignes de code (plus 200 lignes de commentaires):</font></font><br>
<br>
<pre><code class="rust hljs"><span class="hljs-keyword">use</span> telefork::{telefork, TeleforkLocation};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> args: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">String</span>&gt; = std::env::args().collect();
    <span class="hljs-keyword">let</span> destination = args.get(<span class="hljs-number">1</span>).expect(<span class="hljs-string">"expected arg: address of teleserver"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> stream = std::net::TcpStream::connect(destination).unwrap();
    <span class="hljs-keyword">match</span> telefork(&amp;<span class="hljs-keyword">mut</span> stream).unwrap() {<font></font>
        TeleforkLocation::Child(val) =&gt; {<font></font>
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"I teleported to another computer and was passed {}!"</span>, val);<font></font>
        }<font></font>
        TeleforkLocation::Parent =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Done sending!"</span>),<font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai √©galement √©crit une aide appel√©e </font></font><code>yoyo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©forks au serveur, effectue la fermeture transmise, puis t√©l√©fonctionne. </font><font style="vertical-align: inherit;">Cela cr√©e l'illusion que vous pouvez facilement ex√©cuter un morceau de code sur un serveur distant, par exemple, avec une puissance de traitement beaucoup plus grande.</font></font><br>
<br>
<pre><code class="rust hljs"><span class="hljs-comment">// load the scene locally, this might require loading local scene files to memory</span>
<span class="hljs-keyword">let</span> scene = create_scene();
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> backbuffer = <span class="hljs-built_in">vec!</span>[Vec3::new(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>); width * height];<font></font>
telefork::yoyo(destination, || {<font></font>
  <span class="hljs-comment">// do a big ray tracing job on the remote server with many cores!</span>
  render_scene(&amp;scene, width, height, &amp;<span class="hljs-keyword">mut</span> backbuffer);<font></font>
});<font></font>
<span class="hljs-comment">// write out the result to the local file system</span>
save_png_file(width, height, &amp;backbuffer);</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anatomie du processus Linux</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons √† quoi ressemble le processus sous Linux (sur lequel le syst√®me d'exploitation h√¥te m√®re s'ex√©cute </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42c/a2e/366/42ca2e366497bb88024cb351a0cb9e62.png"><br>
<br>
<ul>
<li><b> </b> (memory mappings):         ,    .    ¬´¬ª  4 .         <code>/proc/&lt;pid&gt;/maps</code>.        ,   ,    .<br>
<br>
<ul>
<li>     ,         ,          (   ).</li>
</ul></li>
<li><b></b>:      ,       .     , , -  ,    ,      ,   .              ,    .<br>
</li>
<li><b> </b>:     ,         .   -    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>.      ,       ,    ,  TCP-,  .<br>
<ul>
<li>          .      stdin/stdout/stderr,       0, 1  2.<br>
</li>
<li>  ,     ,    ,     .</li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : certaines autres parties de l'√©tat du processus varient en termes de complexit√© de r√©plication. </font><font style="vertical-align: inherit;">Mais dans la plupart des cas, ils n'ont pas d'importance, par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (pointeur de tas). </font><font style="vertical-align: inherit;">Certains d'entre eux ne peuvent √™tre restaur√©s qu'√† l'aide de trucs √©tranges ou d'appels syst√®me sp√©ciaux comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR_SET_MM_MAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ce qui complique la r√©cup√©ration.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, l'impl√©mentation de base </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut se faire avec un simple mappage de la m√©moire et des registres des threads principaux. </font><font style="vertical-align: inherit;">Cela devrait √™tre suffisant pour les programmes simples qui effectuent principalement des calculs sans interagir avec les ressources du syst√®me d'exploitation, tels que les fichiers (en principe, pour la t√©l√©portation, il suffit d'ouvrir le fichier dans le syst√®me et de le fermer avant d'appeler </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment t√©l√©-ex√©cuter un processus</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'√©tais pas le premier √† penser √† recr√©er des processus sur une autre machine. Ainsi, le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©bogueur d'enregistrement et de d√©bogage rr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait des choses tr√®s similaires </font><font style="vertical-align: inherit;">. J'ai envoy√© </font><font style="vertical-align: inherit;">quelques questions </font><font style="vertical-align: inherit;">√† l'auteur de ce programme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@rocallahan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et il m'a parl√© du syst√®me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRIU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la migration ¬´√† chaud¬ª de conteneurs entre h√¥tes. CRIU peut transf√©rer le processus Linux vers un autre syst√®me, prend en charge la r√©cup√©ration de toutes sortes de descripteurs de fichiers et d'autres √©tats, cependant, le code est vraiment complexe et utilise de nombreux appels syst√®me qui n√©cessitent des assemblages de noyau sp√©ciaux et des autorisations root. En utilisant le lien de la page wiki CRIU, j'ai trouv√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMTCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cr√©√© pour des instantan√©s de t√¢ches distribu√©es sur des superordinateurs afin qu'elles puissent √™tre red√©marr√©es plus tard, et ce programme</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code s'est av√©r√© plus simple</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces exemples ne m'ont pas forc√© √† abandonner les tentatives d'impl√©mentation de mon propre syst√®me, car ce sont des programmes extr√™mement complexes qui n√©cessitent des ex√©cuteurs et une infrastructure sp√©ciaux, et je voulais impl√©menter la t√©l√©portation de processus la plus simple possible en tant qu'appel de biblioth√®que. J'ai donc √©tudi√© les fragments du code source </font></font><code>rr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, CRIU, DMTCP, et quelques exemples de ptrace - et mis au point ma propre proc√©dure </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ma m√©thode fonctionne √† sa mani√®re, c'est un m√©li-m√©lo de techniques diverses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour t√©l√©porter un processus, vous devez effectuer certains travaux dans le processus d'origine qui appelle </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et certains travaux du c√¥t√© de l'appel de fonction, qui re√ßoit le processus de streaming sur le serveur et le recr√©e √† partir du flux (fonction</font></font><code>telepad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Ils peuvent se produire en m√™me temps, mais toute s√©rialisation peut √©galement √™tre effectu√©e avant le t√©l√©chargement, par exemple, en le d√©posant dans un fichier, puis en le t√©l√©chargeant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un aper√ßu simplifi√© des deux processus. </font><font style="vertical-align: inherit;">Si vous voulez comprendre en d√©tail, je vous sugg√®re de lire le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il est contenu dans un fichier et √©troitement comment√© pour √™tre lu dans l'ordre et comprendre comment tout fonctionne.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soumettre un processus en utilisant </font></font><code>telefork</code></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction </font></font><code>telefork</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">re√ßoit un flux avec une capacit√© d'√©criture, par lequel elle transf√®re la totalit√© de l'√©tat de son processus.</font></font><br>
<br>
<ol>
<li><b> </b>  ¬´¬ª .       ,        ,   .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fork</a>       .<br>
</li>
<li><b>   </b>.  <code>/proc/&lt;pid&gt;/maps</code> ,    .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proc_maps crate</a>.<br>
</li>
<li><b>     </b>.    DMTCP,         ,        ,       .   ,   <code>[vdso]</code>,      , ,    .<br>
</li>
<li><b>         </b>   .    ,    ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">process_vm_readv</a>        ,       .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registres de transfert</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">J'utilise l'option </font></font><code>PTRACE_GETREGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour l'appel syst√®me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ptrace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il vous permet d'obtenir toutes les valeurs du registre du processus enfant. </font><font style="vertical-align: inherit;">Ensuite, je les √©cris simplement dans un message sur la cha√Æne.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cution d'appels syst√®me dans un processus enfant</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour transformer le processus cible en une copie du processus entrant, vous devrez forcer le processus √† ex√©cuter un tas d'appels syst√®me sur lui-m√™me, sans acc√®s √† aucun code, car nous avons tout supprim√©. </font><font style="vertical-align: inherit;">Nous effectuons des appels syst√®me √† distance √† l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ptrace</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un appel syst√®me universel pour manipuler et v√©rifier d'autres processus:</font></font><br>
<br>
<ol>
<li><b>  syscall</b>.        syscall   ,      .    ,      <code>process_vm_readv</code>      <code>[vdso]</code> , ,   ,      syscall    Linux,       .         ,    <code>[vdso]</code>.<br>
</li>
<li><b> </b>    ,  <code>PTRACE_SETREGS</code>.      syscall,  <code>rax</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    Linux</a>,      <code>rdi, rsi, rdx, r10, r8, r9</code>.<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faites un pas en</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilisant le param√®tre </font></font><code>PTRACE_SINGLESTEP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour ex√©cuter la commande syscall.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez les registres</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec </font></font><code>PTRACE_GETREGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour restaurer la valeur de retour syscall et voyez si elle a r√©ussi.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acceptation du processus dans </font></font><code>telepad</code></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant ceci et les primitives d√©j√† d√©crites, nous pouvons recr√©er le processus:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©marrez un processus enfant fig√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Semblable √† l'envoi, mais cette fois, nous avons besoin d'un processus enfant que nous pouvons manipuler pour le transformer en un clone du processus transf√©r√©.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rifiez les cartes d'allocation de m√©moire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cette fois, nous devons conna√Ætre toutes les cartes d'allocation de m√©moire existantes afin de les supprimer et faire de la place pour le processus entrant.</font></font><br>
</li>
<li><b>  </b>.         ,    <code>munmap</code>.<br>
</li>
<li><b>   </b>.        <code>mremap</code>,      .<br>
</li>
<li><b>    </b>.   <code>mmap</code>   ,   <code>process_vm_writev</code>      .<br>
</li>
<li><b> </b>.  <code>PTRACE_SETREGS</code>     ,   ,   <code>rax</code>.     <code>raise(SIGSTOP)</code>,    .     ,    <code>telepad</code>.<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une valeur arbitraire est utilis√©e pour que le serveur telefork puisse transf√©rer le descripteur de fichier de la connexion TCP que le processus a entr√© et peut renvoyer des donn√©es ou, dans le cas </font></font><code>yoyo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se t√©l√©porter vers la m√™me connexion.</font></font></li>
</ul></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Red√©marrez le processus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec le nouveau contenu √† l'aide de </font></font><code>PTRACE_DETACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une mise en ≈ìuvre plus comp√©tente</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certaines parties de mon impl√©mentation telefork ne sont pas parfaitement con√ßues. </font><font style="vertical-align: inherit;">Je sais comment les r√©parer, mais dans la forme actuelle, j'aime le syst√®me, et parfois ils sont vraiment difficiles √† r√©parer. </font><font style="vertical-align: inherit;">Voici quelques exemples int√©ressants:</font></font><br>
<br>
<ul>
<li>      (vDSO).   <code>mremap</code>  vDSO   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> DMTCP</a>,  ,            .      vDSO,            .        -  ,      CPU  glibc      vDSO   .      ,      vDSO,     syscall,    <code>rr</code>,     vDSO     vDSO   .<br>
</li>
<li> <code>brk</code>   .      DMTCP,       ,   <code>brk</code> ,  <code>brk</code> .  ,      ,&nbsp;‚Äî  <code>PR_SET_MM_MAP</code>,          .<br>
</li>
<li>   .     Rust ¬´ ¬ª, ,     FS  GS, ,   ,  -  <code>glibc</code>  pid  tid,         .    CRIU,        PID  TID    .<br>
</li>
<li>   .             , , ,       /   ,     /       FUSE.           ,    TCP-,  DMTCP  CRIU          ,    <code>perf_event_open</code>.<br>
</li>
<li>  .  <code>fork()</code>  Unix   ,           ,           .</li>
</ul><br>
<h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que vous avez d√©j√† compris qu'avec les bonnes interfaces de bas niveau, vous pouvez impl√©menter des choses folles qui semblaient impossibles √† quelqu'un. </font><font style="vertical-align: inherit;">Voici quelques r√©flexions sur la fa√ßon de d√©velopper les id√©es de base de la t√©l√©fonction. </font><font style="vertical-align: inherit;">Bien qu'une grande partie de ce qui pr√©c√®de puisse probablement √™tre enti√®rement impl√©ment√©e uniquement sur un noyau compl√®tement nouveau ou fixe:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telfork de cluster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La premi√®re source d'inspiration pour la t√©l√©forche a √©t√© l'id√©e de diffuser un processus sur toutes les machines d'un cluster informatique. </font><font style="vertical-align: inherit;">Il peut m√™me s'av√©rer impl√©menter des m√©thodes de multidiffusion UDP ou d'√©gal √† √©gal pour acc√©l√©rer la distribution sur l'ensemble du cluster. </font><font style="vertical-align: inherit;">Vous souhaitez probablement √©galement disposer de primitives de communication.</font></font><br>
</li>
<li><b>  </b>. CRIU    ,   -   <code>userfaultfd</code>.              ,   <code>SIGSEGV</code>  <code>mmap</code>.        ,    ,        &nbsp;‚Äî     .<br>
</li>
<li><b> !</b>      ,        .    <code>userfaultfd</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">      userfaultfd,       </a>,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MESI</a>,        .         ,     ,          .  &nbsp;‚Äî    ,            .    ,       ,    ,    .      :     syscall,     -,   syscall,     .      ,           .    ,      ,     ,    .  ,       ,         .          ,     ,  (   ,      )        ,       .</li>
</ul><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je l'aime beaucoup, car voici un exemple de l'une de mes techniques pr√©f√©r√©es - plonger dans une couche d'abstraction moins connue, qui remplit relativement facilement ce que nous pensions √™tre presque impossible. La t√©l√©portation de calculs peut sembler impossible ou tr√®s difficile. Vous pourriez penser que cela n√©cessiterait des m√©thodes telles que la s√©rialisation de l'√©tat entier, la copie de l'ex√©cutable binaire sur la machine distante et son lancement √† cet endroit avec des indicateurs de ligne de commande sp√©ciaux pour recharger l'√©tat. Mais non, tout est beaucoup plus simple. Sous votre langage de programmation pr√©f√©r√© se trouve une couche d'abstraction o√π vous pouvez choisir un sous-ensemble assez simple de fonctions - et au cours du week-end, impl√©mentez la t√©l√©portation de la plupart des calculs purs dans n'importe quel langage de programmation dans 500 lignes de code. je pensequ'une telle plong√©e √† un autre niveau d'abstraction m√®ne souvent √† des solutions plus simples et plus universelles. Un autre de mes projets comme celui-ci est</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numderline</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä premi√®re vue, ces projets semblent √™tre des hacks extr√™mes, et dans une large mesure, ils le sont. Ils font des choses comme personne ne s'y attend, et quand ils cassent, ils le font au niveau d'abstraction, auquel des programmes similaires ne devraient pas fonctionner - par exemple, vos descripteurs de fichiers disparaissent myst√©rieusement. Mais parfois, vous pouvez d√©finir correctement le niveau d'abstraction et encoder toutes les situations possibles, de sorte qu'√† la fin, tout fonctionnera de mani√®re fluide et magique. Je pense que les bons exemples ici sont </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (bien que telefork ait r√©ussi √† le mettre √† sac) et la migration vers le cloud des machines virtuelles en temps r√©el (en fait, telefork au niveau de l'hyperviseur).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'aime aussi pr√©senter ces choses comme des id√©es de fa√ßons alternatives de travailler sur les syst√®mes informatiques. </font><font style="vertical-align: inherit;">Pourquoi nos API de calcul en cluster sont-elles tellement plus compliqu√©es qu'un simple programme qui traduit des fonctions en cluster? </font><font style="vertical-align: inherit;">Pourquoi la programmation du syst√®me r√©seau est-elle tellement plus compliqu√©e que le multithread? </font><font style="vertical-align: inherit;">Bien s√ªr, vous pouvez donner toutes sortes de bonnes raisons, mais elles sont g√©n√©ralement bas√©es sur la difficult√© de faire un exemple de syst√®mes existants. </font><font style="vertical-align: inherit;">Ou peut-√™tre avec la bonne abstraction ou avec un effort suffisant, tout fonctionnera facilement et de mani√®re transparente? </font><font style="vertical-align: inherit;">Fondamentalement, il n'y a rien d'impossible.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499404/index.html">Gestion de la charge PostgreSQL, lorsqu'un seul serveur ne suffit pas. Andrey Salnikov</a></li>
<li><a href="../fr499408/index.html">Les pi√®ges des tests de Kafka Streams</a></li>
<li><a href="../fr499410/index.html">Cr√©ation automatis√©e de fichiers de configuration MySQL optimis√©s pour les performances</a></li>
<li><a href="../fr499412/index.html">La meilleure assurance sant√© est de penser avec la t√™te. Id√©e d'application</a></li>
<li><a href="../fr499418/index.html">Le futurisme que nous m√©ritons</a></li>
<li><a href="../fr499426/index.html">Il me semble que l'h√©bergement VPS / VDS russe vient de l'enfer (et oui, nous tondons aussi)</a></li>
<li><a href="../fr499428/index.html">Morpheus Red Cloud Management Tablet</a></li>
<li><a href="../fr499430/index.html">Googl√© aussi?</a></li>
<li><a href="../fr499432/index.html">Autonomie des tests unitaires dans PHPUnit</a></li>
<li><a href="../fr499434/index.html">Comment mettre en ≈ìuvre la gestion des connaissances: b√©n√©ficiez de ¬´poches¬ª, de ¬´fines perroquets¬ª et de la r√©flexion sur les clips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>