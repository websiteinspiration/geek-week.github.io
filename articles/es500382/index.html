<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥄 🕙 🙋🏿 Integración API de Aviasales con Amazon Kinesis y simplicidad sin servidor 🚆 ☸️ 🙎🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 
 
 ¿Te gusta volar aviones? Me encanta, pero en el autoaislamiento también me gustaba analizar los datos de tarifas aéreas de un recurso c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Integración API de Aviasales con Amazon Kinesis y simplicidad sin servidor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Te gusta volar aviones? </font><font style="vertical-align: inherit;">Me encanta, pero en el autoaislamiento también me gustaba analizar los datos de tarifas aéreas de un recurso conocido: Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy analizaremos el trabajo de Amazon Kinesis, crearemos un sistema de transmisión con análisis en tiempo real, colocaremos la base de datos Amazon DynamoDB NoSQL como el almacén de datos principal y configuraremos alertas por SMS para tickets interesantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Todos los detalles debajo del corte! </font><font style="vertical-align: inherit;">¡Vamos!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducción</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, necesitamos acceso a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la API de Aviasales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El acceso a él se proporciona de forma gratuita y sin restricciones, solo necesita registrarse en la sección "Desarrolladores" para obtener su token API para acceder a los datos.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El objetivo principal de este artículo es proporcionar una comprensión general del uso de la información de transmisión en AWS, lo que hace que la información devuelta por la API utilizada no sea estrictamente relevante y se transfiera desde la memoria caché, que se genera en base a búsquedas de usuarios de los sitios Aviasales.ru y Jetradar.com para últimas 48 horas </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los datos de los boletos de avión de Kinesis-agent recibidos a través de la API instalada en la máquina del productor se analizarán automáticamente y se transferirán a la transmisión deseada a través de Kinesis Data Analytics. </font><font style="vertical-align: inherit;">Una versión no procesada de esta secuencia se escribirá directamente en el repositorio. </font><font style="vertical-align: inherit;">Implementado en el almacenamiento de datos sin procesar de DynamoDB permitirá un análisis más profundo de los tickets a través de herramientas de BI, como AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideraremos dos opciones para implementar toda la infraestructura:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual: a través de la consola de administración de AWS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infraestructura del código Terraform - para ingenieros de automatización perezosos;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitectura del sistema en desarrollo.</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Componentes utilizados:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API de Aviasales</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : los datos devueltos por esta API se utilizarán para todo el trabajo posterior;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instancia de productor EC2</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : una máquina virtual normal en la nube en la que se generará el flujo de datos de entrada:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una aplicación Java instalada localmente que proporciona una forma sencilla de recopilar y enviar datos a Kinesis (Kinesis Data Streams o Kinesis Firehose). </font><font style="vertical-align: inherit;">El agente monitorea constantemente un conjunto de archivos en los directorios especificados y envía nuevos datos a Kinesis;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caller API Script</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : un script de Python que realiza solicitudes de API y coloca la respuesta en una carpeta que Kinesis Agent monitorea;</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entrenamiento inicial</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para emular el flujo de datos, decidí usar la información de la tarifa aérea devuelta por la API de Aviasales. </font><font style="vertical-align: inherit;">La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentación tiene una</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lista bastante extensa de diferentes métodos, tome uno de ellos: el "Calendario de precios para el mes", que devuelve los precios para cada día del mes, agrupados por la cantidad de transferencias. </font><font style="vertical-align: inherit;">Si no transmite el mes de búsqueda en la solicitud, se devolverá la información del mes siguiente al actual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, regístrese, obtenga su token. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo de solicitud a continuación:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El método anterior de recibir datos de la API con el token en la solicitud funcionará, pero prefiero pasar el token de acceso a través del encabezado, por lo que utilizaremos este método en el script api_caller.py. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejemplo de respuesta:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ejemplo de respuesta API anterior muestra un boleto de San Petersburgo a Phuk ... Oh, con qué soñar ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya que soy de Kazan, y Phuket "solo está soñando con nosotros" ahora, buscaremos boletos de San Petersburgo a Kazan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se supone que ya tiene una cuenta de AWS. </font><font style="vertical-align: inherit;">Quiero prestar especial atención de inmediato para que Kinesis y el envío de notificaciones por SMS no estén incluidos en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nivel gratuito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anual </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">(uso gratuito)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pero incluso a pesar de esto, teniendo en cuenta un par de dólares, es muy posible construir el sistema propuesto y jugar con él. </font><font style="vertical-align: inherit;">Y, por supuesto, no olvide eliminar todos los recursos después de que sean innecesarios.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afortunadamente, las funciones de DynamoDb y lambda serán shareware para nosotros si se mantiene dentro de los límites gratuitos mensuales. </font><font style="vertical-align: inherit;">Por ejemplo, para DynamoDB: 25 GB de almacenamiento, 25 WCU / RCU y 100 millones de solicitudes. </font><font style="vertical-align: inherit;">Y un millón de llamadas a funciones lambda por mes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistema de despliegue manual</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar flujos de datos de Kinesis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vaya al servicio Kinesis Data Streams y cree dos nuevas transmisiones, un fragmento para cada una.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué es un fragmento?</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuantos más fragmentos haya en su transmisión, mayor será su rendimiento. </font><font style="vertical-align: inherit;">En principio, las secuencias se escalan de esta manera agregando fragmentos. </font><font style="vertical-align: inherit;">Pero cuantos más fragmentos tenga, mayor será el precio. </font><font style="vertical-align: inherit;">Cada fragmento cuesta 1,5 centavos por hora y 1,4 centavos adicionales por cada millón de unidades de carga PUT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree un nuevo hilo con el nombre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">airline_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , 1 fragmento será suficiente para ello:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora cree otra secuencia llamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuración del productor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como productor de datos para analizar una tarea, es suficiente usar una instancia EC2 normal. </font><font style="vertical-align: inherit;">No tiene que ser una máquina virtual poderosa y costosa; spot t2.micro es bastante adecuado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota importante: por ejemplo, debe usar la imagen: Amazon Linux AMI 2018.03.0, ya que hay menos configuraciones para iniciar rápidamente el Agente Kinesis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vaya al servicio EC2, cree una nueva máquina virtual, seleccione la AMI deseada con el tipo t2.micro, que se incluye en el nivel gratuito:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que la máquina virtual recién creada pueda interactuar con el servicio de Kinesis, debe otorgarle el derecho de hacerlo. </font><font style="vertical-align: inherit;">La mejor manera de hacerlo es asignar un rol de IAM. </font><font style="vertical-align: inherit;">Por lo tanto, en el Paso 3: pantalla Configurar detalles de instancia, seleccione </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear nuevo rol de IAM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creación de roles de IAM para EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede dejar los parámetros del disco duro de forma predeterminada, también las etiquetas (aunque es una buena práctica usar etiquetas, al menos dé el nombre de la instancia y especifique el entorno). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora estamos en el Paso 6: pestaña Configurar grupo de seguridad, donde debe crear uno nuevo o especificar su grupo de seguridad existente, que le permite conectarse a través de ssh (puerto 22) a la instancia. </font><font style="vertical-align: inherit;">Seleccione Fuente -&gt; Mi IP allí y puede ejecutar la instancia.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez que ingresa al estado de ejecución, puede intentar conectarse a través de ssh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para poder trabajar con Kinesis Agent, después de una conexión exitosa a la máquina, debe ingresar los siguientes comandos en el terminal:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree una carpeta para guardar las respuestas de la API:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de iniciar el agente, debe configurar su configuración:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El contenido del archivo agent.json debería verse así:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver en el archivo de configuración, el agente supervisará los archivos con la extensión .log en el directorio / var / log / airline_tickets /, los analizará y los transferirá a la secuencia airline_tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos el servicio y nos aseguramos de que se inicie y funcione:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora descargue el script de Python que solicitará datos de la API:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El script api_caller.py solicita datos de Aviasales y guarda la respuesta recibida en el directorio que escanea el agente de Kinesis. </font><font style="vertical-align: inherit;">La implementación de este script es bastante estándar, hay una clase TicketsApi, le permite extraer la API de forma asincrónica. </font><font style="vertical-align: inherit;">En esta clase, pasamos el encabezado con el token y los parámetros de solicitud:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para probar la configuración correcta y la operatividad del agente, haremos una prueba de ejecución del script api_caller.py:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y observamos el resultado del trabajo en los registros del Agente y en la pestaña Monitoreo en el flujo de datos de airline_tickets:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, todo funciona y el Agente Kinesis envía con éxito los datos a la transmisión. </font><font style="vertical-align: inherit;">Ahora configure el consumidor.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasemos al componente central de todo el sistema: cree una nueva aplicación en Kinesis Data Analytics llamada kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics permite el análisis en tiempo real de los datos de Kinesis Streams utilizando SQL. </font><font style="vertical-align: inherit;">Este es un servicio totalmente autoescalable (a diferencia de Kinesis Streams), que:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le permite crear nuevas secuencias (secuencia de salida) basadas en consultas a los datos de origen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proporciona una secuencia con errores que ocurrieron durante el funcionamiento de la aplicación (secuencia de errores);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede determinar automáticamente el esquema de datos de entrada (puede redefinirse manualmente si es necesario).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un servicio costoso: 0,11 USD por hora, por lo que debe usarlo con cuidado y eliminarlo cuando complete el trabajo.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conecte la aplicación a la fuente de datos:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seleccione la transmisión a la que desea conectarse (airline_tickets):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación, debe adjuntar el nuevo rol de IAM para que la aplicación pueda leer de la transmisión y escribir en ella. </font><font style="vertical-align: inherit;">Para hacer esto, es suficiente no cambiar nada en el bloque de permisos de acceso:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora solicitamos el descubrimiento del esquema de datos en la secuencia, para esto hacemos clic en el botón "Descubrir esquema". </font><font style="vertical-align: inherit;">Como resultado, se actualizará el rol de IAM (se creará uno nuevo) y se lanzará el descubrimiento del esquema a partir de los datos que ya han llegado a la secuencia:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora debe ir al editor de SQL. </font><font style="vertical-align: inherit;">Cuando haga clic en este botón, aparecerá una ventana con una pregunta sobre el inicio de la aplicación: elija lo que queremos ejecutar:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la ventana del editor de SQL, inserte una consulta tan simple y haga clic en Guardar y ejecutar SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En las bases de datos relacionales, trabaja con tablas utilizando instrucciones INSERT para agregar registros y una instrucción SELECT para consultar datos. </font><font style="vertical-align: inherit;">En Amazon Kinesis Data Analytics, usted trabaja con flujos (STREAM) y "bombas" (PUMP): solicitudes de inserción continua que insertan datos de un flujo en una aplicación a otro flujo.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la consulta SQL anterior, los boletos de Aeroflot se buscan a precios inferiores a cinco mil rublos. </font><font style="vertical-align: inherit;">Todos los registros que se encuentren en estas condiciones se colocarán en la secuencia DESTINATION_SQL_STREAM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el bloque Destino, seleccione la secuencia de flujo especial, y en la lista desplegable Nombre del flujo en la aplicación DESTINATION_SQL_STREAM:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de todas las manipulaciones, debería resultar algo similar a la imagen a continuación:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear y suscribirse al tema SNS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vaya al Servicio de notificación simple y cree un nuevo tema llamado Aerolíneas:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos suscribimos a este tema, en él indicamos el número de teléfono móvil al que llegarán las notificaciones por SMS:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear una tabla en DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para almacenar los datos sin procesar de su flujo de airline_tickets, cree una tabla en DynamoDB con el mismo nombre. </font><font style="vertical-align: inherit;">Como clave principal, usaremos record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear una función de colector lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creemos una función lambda llamada Collector, cuya tarea es sondear el flujo de airline_tickets y, si hay nuevos registros allí, insertar estos registros en la tabla DynamoDB. </font><font style="vertical-align: inherit;">Obviamente, además de los derechos predeterminados, esta lambda debe tener acceso para leer el flujo de datos de Kinesis y escribir en DynamoDB.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un rol de IAM para una función de recopilador lambda</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta lambda debe ser activada por un activador de Kinesis cuando nuevas entradas lleguen a la línea stream_stream, por lo que debe agregar un nuevo activador:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por insertar el código y guardar la lambda.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un notificador de función lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda función lambda, que supervisará la segunda secuencia (special_stream) y enviará una notificación a SNS, se crea de la misma manera. </font><font style="vertical-align: inherit;">Por lo tanto, esta lambda debe tener acceso de lectura desde Kinesis y enviar mensajes al tema SNS especificado, que luego es enviado por el servicio SNS a todos los suscriptores de este tema (correo electrónico, SMS, etc.).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear roles de IAM</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta lambda debería funcionar de acuerdo con el activador para que nuevas entradas ingresen a special_stream, por lo que debe configurar el activador de la misma manera que lo hicimos para el recopilador lambda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la conveniencia de configurar este lambda, presentamos una nueva variable de entorno: TOPIC_ARN, donde colocamos el tema ANR (Nombres de recurso de Amazon) de Aerolíneas:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E inserte el código lambda, es muy simple:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que esto completa la configuración manual del sistema. </font><font style="vertical-align: inherit;">Solo queda probar y asegurarnos de que configuramos todo correctamente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementar desde código Terraform</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparación necesaria</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una herramienta de código abierto muy conveniente para implementar infraestructura desde el código. </font><font style="vertical-align: inherit;">Tiene su propia sintaxis que es fácil de aprender y muchos ejemplos de cómo y qué implementar. </font><font style="vertical-align: inherit;">Hay muchos complementos convenientes en el editor de Atom o Visual Studio Code que hacen que sea más fácil trabajar con Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede descargar el kit de distribución </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desde aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Un análisis detallado de todas las características de Terraform está más allá del alcance de este artículo, por lo que nos limitaremos a los puntos principales.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo empezar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código completo del proyecto está </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mi repositorio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Clonamos un repositorio para nosotros mismos. </font><font style="vertical-align: inherit;">Antes de comenzar, debe asegurarse de haber instalado y configurado AWS CLI, como </font><font style="vertical-align: inherit;">Terraform buscará credenciales en el archivo ~ / .aws / credentials. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es una buena práctica implementar toda la infraestructura antes de iniciar el comando de plan para ver qué nos está creando Terraform en la nube:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se le pedirá que ingrese un número de teléfono para enviarle notificaciones. </font><font style="vertical-align: inherit;">En esta etapa, es opcional.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de analizar el plan de trabajo del programa, podemos comenzar la creación de recursos:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de enviar este comando, nuevamente se le pedirá que ingrese un número de teléfono, escriba "sí" cuando aparezca la pregunta sobre la ejecución real de las acciones. </font><font style="vertical-align: inherit;">Esto le permitirá elevar toda la infraestructura, llevar a cabo todas las configuraciones necesarias para EC2, implementar funciones lambda, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de que todos los recursos se hayan creado con éxito a través del código Terraform, debe entrar en los detalles de la aplicación Kinesis Analytics (desafortunadamente, no encontré cómo hacerlo directamente desde el código). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciar la aplicacion:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de eso, debe establecer explícitamente el nombre del flujo en la aplicación eligiendo de la lista desplegable:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora todo está listo para funcionar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba de aplicación</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Independientemente de cómo haya implementado el sistema, manualmente o mediante el código Terraform, funcionará igual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasamos por SSH a la máquina virtual EC2 donde está instalado Kinesis Agent y ejecutamos el script api_caller.py</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por esperar un SMS a su número: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS: el mensaje llega al teléfono en casi 1 minuto: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por ver si los registros se guardan en la base de datos DynamoDB para su posterior análisis más detallado. </font><font style="vertical-align: inherit;">La tabla airline_tickets contiene algo como esto:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el curso del trabajo realizado, se creó un sistema de procesamiento de datos en línea basado en Amazon Kinesis. </font><font style="vertical-align: inherit;">Examinamos las opciones para usar Kinesis Agent junto con Kinesis Data Streams y análisis en tiempo real de Kinesis Analytics usando comandos SQL, así como la interacción de Amazon Kinesis con otros servicios de AWS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementamos el sistema anterior de dos maneras: lo suficientemente manual y rápido desde el código Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código fuente completo del proyecto está disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mi repositorio en GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le sugiero que se familiarice con él. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estoy listo para discutir el artículo con gusto, espero sus comentarios. </font><font style="vertical-align: inherit;">Espero una crítica constructiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Le deseo éxito!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es500364/index.html">Expandir el portal de aprendizaje escolar en Moodle y BigBlueButton</a></li>
<li><a href="../es500368/index.html">Generando secuencias aleatorias predecibles: un enfoque diferente para la permutación</a></li>
<li><a href="../es500370/index.html">10 podcasts útiles en inglés para programadores a los que vale la pena suscribirse en 2020</a></li>
<li><a href="../es500378/index.html">Búsqueda efectiva de información en el trabajo</a></li>
<li><a href="../es500380/index.html">Procesamiento de datos personales de forma remota: riesgos y posibles consecuencias</a></li>
<li><a href="../es500384/index.html">Pioneros de Pixar Studio recibieron el premio Turing y $ 1 millón</a></li>
<li><a href="../es500386/index.html">Adaptando su solución comercial existente para SwiftUI. Parte 2</a></li>
<li><a href="../es500390/index.html">Modelos reales de localización lingüística en el campo de la informática y las comunicaciones digitales. Parte 1</a></li>
<li><a href="../es500396/index.html">Problemas de los sistemas de control de acceso autónomo: donde no esperaban</a></li>
<li><a href="../es500398/index.html">Maratón remoto Semana 3: Procesos inoperantes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>