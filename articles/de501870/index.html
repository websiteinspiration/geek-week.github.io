<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛩️ ♌️ 🌾 Maximale Anzahl von Werten in Aufzählung Teil II 🙏🏿 ♨️ 🚣🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Erster Teil, Theoretisch  | Teil zwei, praktisch
 
 
 Wir suchen weiterhin nach der maximal möglichen Anzahl von Werten in der Aufzählung. 
 Dieses Ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Maximale Anzahl von Werten in Aufzählung Teil II</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501870/"><nobr><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erster Teil, Theoretisch</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;|&nbsp;</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil zwei, praktisch</font></font></b></nobr><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir suchen weiterhin nach der maximal möglichen Anzahl von Werten in der Aufzählung. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Mal werden wir uns auf die praktische Seite des Problems konzentrieren und sehen, wie die IDE, der Compiler und die JVM auf unsere Erfolge reagieren werden.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inhalt</font></font></h1><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Tools </font></a></font><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extraktionsmethode </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamische </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Klassendateikonstanten </font></a></font><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plötzliche Schwierigkeiten </font></font></a><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helle Zukunft </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsicherer </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test </font></font></a><br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac- und Switch- </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Leistung </font></a></font><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung </font></font></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusätzliche Ressourcen</font></font></a><br>
<br>
<a name="Tools"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Werkzeuge</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javac kümmert sich um uns: Es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schneidet Zeichen, die es nicht mag, aus Bezeichnern aus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und verbietet das Erben davon </font></font><code>java.lang.Enum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Für Experimente benötigen wir daher andere Werkzeuge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden Hypothesen mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asmtools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dem Assembler und Disassembler für die JVM, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">testen</font></a><font style="vertical-align: inherit;"> und mithilfe der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASM-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek Klassendateien im industriellen Maßstab generieren </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Vereinfachung des Verständnisses wird die Essenz des Geschehens in einem Java-ähnlichen Pseudocode dupliziert.</font></font><br>
<br>
<a name="Javac"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ausgangspunkt ist es logisch, mit nur einem das beste Ergebnis zu erzielen, das ohne Tricks erzielt werden kann </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hier ist alles einfach - wir erstellen die Quelldatei mit der Aufzählung und fügen ihr Elemente hinzu, bis javac sich weigert, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sie</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit dem Fluch „Code zu groß“ </font><font style="vertical-align: inherit;">zu kompilieren </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seit Java 1.7 wurde diese Zahl ziemlich lange auf dem Niveau von 2_746 Elementen gehalten. </font><font style="vertical-align: inherit;">Aber irgendwo nach Java 11 gab es Änderungen im Algorithmus zum Speichern von Werten im konstanten Pool und die maximale Anzahl verringerte sich auf 2_743. </font><font style="vertical-align: inherit;">Ja, ja, nur weil sich die Reihenfolge der Elemente im Konstantenpool geändert hat! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden uns auf die besten Werte konzentrieren.</font></font><br>
<br>
<a name="ExtractMethod"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methode extrahieren</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da einer der einschränkenden Faktoren mit der Größe des Bytecodes im statischen Initialisierungsblock zusammenhängt, werden wir versuchen, letzteres so einfach wie möglich zu gestalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erinnern Sie sich daran, wie es am Beispiel der Aufzählung </font></font><code>FizzBuzz</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus dem ersten Teil </font><font style="vertical-align: inherit;">aussieht </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kommentare enthalten entsprechende Montageanleitungen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statisch {}</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Fizz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-comment">//  0: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">//  3: dup</span>
    <span class="hljs-comment">//  4: ldc           #22                 // String Fizz</span>
    <span class="hljs-comment">//  6: iconst_0</span>
    <span class="hljs-comment">//  7: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 10: putstatic     #25                 // Field Fizz:LFizzBuzz;</span>
    Buzz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>);
    <span class="hljs-comment">// 13: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">// 16: dup</span>
    <span class="hljs-comment">// 17: ldc           #28                 // String Buzz</span>
    <span class="hljs-comment">// 19: iconst_1</span>
    <span class="hljs-comment">// 20: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 23: putstatic     #30                 // Field Buzz:LFizzBuzz;</span>
    FizzBuzz = <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>);
    <span class="hljs-comment">// 26: new           #2                  // class FizzBuzz</span>
    <span class="hljs-comment">// 29: dup</span>
    <span class="hljs-comment">// 30: ldc           #32                 // String FizzBuzz</span>
    <span class="hljs-comment">// 32: iconst_2</span>
    <span class="hljs-comment">// 33: invokespecial #24                 // Method "&lt;init&gt;":(Ljava/lang/String;I)V</span>
    <span class="hljs-comment">// 36: putstatic     #33                 // Field FizzBuzz:LFizzBuzz;</span><font></font>
<font></font>
    $VALUES = <span class="hljs-keyword">new</span> FizzBuzz[] {
    <span class="hljs-comment">// 39: iconst_3</span>
    <span class="hljs-comment">// 40: anewarray     #2                  // class FizzBuzz</span><font></font>
        Fizz, <font></font>
    <span class="hljs-comment">// 43: dup</span>
    <span class="hljs-comment">// 44: iconst_0</span>
    <span class="hljs-comment">// 45: getstatic     #25                 // Field Fizz:LFizzBuzz;</span>
    <span class="hljs-comment">// 48: aastore</span><font></font>
        Buzz, <font></font>
    <span class="hljs-comment">// 49: dup</span>
    <span class="hljs-comment">// 50: iconst_1</span>
    <span class="hljs-comment">// 51: getstatic     #30                 // Field Buzz:LFizzBuzz;</span>
    <span class="hljs-comment">// 54: aastore</span><font></font>
        FizzBuzz<font></font>
    <span class="hljs-comment">// 55: dup</span>
    <span class="hljs-comment">// 56: iconst_2</span>
    <span class="hljs-comment">// 57: getstatic     #33                 // Field FizzBuzz:LFizzBuzz;</span>
    <span class="hljs-comment">// 60: aastore</span><font></font>
    };<font></font>
    <span class="hljs-comment">// 61: putstatic     #1                  // Field $VALUES:[LFizzBuzz;</span>
    <span class="hljs-comment">// 64: return</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was mir in den Sinn kommt, ist, die Erstellung und Füllung des Arrays </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in eine separate Methode zu integrieren.</font></font><br>
<br>
<pre><code class="java hljs">$VALUES = createValues();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Entwicklung dieser Idee kann die Erstellung von Instanzen von Aufzählungselementen auf dieselbe Methode übertragen werden:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    FizzBuzz[] localValues = createValues();<font></font>
<font></font>
    <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;<font></font>
    Fizz = localValues[index++];<font></font>
    Buzz = localValues[index++];<font></font>
    FizzBuzz = localValues[index++];<font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FizzBuzz[] {
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>), 
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>), 
        <span class="hljs-keyword">new</span> FizzBuzz(<span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>)<font></font>
    };<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schon besser, aber jede Erfassung eines Array-Elements und das anschließende Indexinkrement kosten 6 Bytes, was für uns zu teuer ist. </font><font style="vertical-align: inherit;">Setzen Sie sie in einer separaten Methode aus.</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> valueIndex;<font></font>
<font></font>
<span class="hljs-keyword">static</span>  {<font></font>
    $VALUES = createValues();<font></font>
<font></font>
    valueIndex = <span class="hljs-number">0</span>;<font></font>
    Fizz = nextValue();<font></font>
    Buzz = nextValue();<font></font>
    FizzBuzz = nextValue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz <span class="hljs-title">nextValue</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> $VALUES[valueIndex++];<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es </font><font style="vertical-align: inherit;">dauert 11 Bytes, </font><font style="vertical-align: inherit;">um </font><font style="vertical-align: inherit;">zu </font><font style="vertical-align: inherit;">initialisieren </font><font style="vertical-align: inherit;">und vom statischen Initialisierungsblock zurückzukehren </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>valueIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und 65_524 weitere Bytes verbleiben, um die Felder zu initialisieren. </font><font style="vertical-align: inherit;">Die Initialisierung jedes Feldes erfordert 6 Bytes, wodurch wir eine Aufzählung von 10_920 Elementen erstellen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast das Vierfache des Wachstums im Vergleich zu Javac muss definitiv durch Codegenerierung gefeiert werden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generator-Quellcode: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExtractMethodHugeEnumGenerator.java</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Beispiel für </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">eine generierte</font></a><font style="vertical-align: inherit;"> Klasse: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExtractMethodHugeEnum.class</font></font></a><br>
<a name="ConDy"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamische Klassendateikonstanten</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist Zeit, sich an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JEP 309</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und seine mysteriösen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dynamischen Konstanten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu erinnern </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Wesentliche an Innovation auf den Punkt gebracht: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu bereits vorhandenen Typen, die von einem Konstantenpool unterstützt werden, wurde ein weiterer hinzugefügt </font></font><code>CONSTANT_Dynamic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Beim Laden einer Klasse ist der Typ einer solchen Konstante bekannt, ihr Wert ist jedoch unbekannt. Das erste Laden einer Konstante führt zu einem Aufruf der in ihrer Deklaration angegebenen Bootstrap-Methode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis dieser Methode wird zu einem konstanten Wert. Es gibt keine Möglichkeit, den Wert zu ändern, der einer bereits initialisierten Konstante zugeordnet ist. Was für eine Konstante ziemlich logisch ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie auch an Singleton gedacht haben, vergessen Sie es sofort. </font><font style="vertical-align: inherit;">In der Spezifikation wird separat hervorgehoben, dass in diesem Fall keine Garantie für die Thread-Sicherheit besteht und die Initialisierungsmethode in Multithread-Code mehrmals aufgerufen werden kann. </font><font style="vertical-align: inherit;">Es ist nur garantiert, dass bei mehreren Aufrufen der Bootstrap-Methode für dieselbe Konstante die JVM eine Münze wirft und einen der berechneten Werte für die Rolle des konstanten Werts auswählt, während die anderen dem Garbage Collector geopfert werden.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verhaltensmäßig wird eine CONSTANT_Dynamic-Konstante aufgelöst, indem ihre Bootstrap-Methode für die folgenden Parameter ausgeführt wird: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein lokales Suchobjekt,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der String, der die Namenskomponente der Konstante darstellt,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Klasse, die den erwarteten Konstantentyp darstellt, und</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alle verbleibenden Bootstrap-Argumente.</font></font></li>
</ol><br>
As with invokedynamic, multiple threads can race to resolve, but a unique winner will be chosen and any other contending answers discarded.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Werte aus dem Pool der Konstanten in der Bytecode zu laden, Befehle werden zur </font><font style="vertical-align: inherit;">Verfügung gestellt </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>ldc_w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>ldc2_w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Von Interesse für uns ist der erste von ihnen - </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Gegensatz zu den anderen kann es nur Werte aus den ersten 255 Slots des konstanten Pools laden, benötigt jedoch 1 Byte weniger Bytecode. All dies gibt uns Einsparungen von bis zu 255 Bytes und ein </font></font><code>255 + ((65_524 - (255 * 5)) / 6) = 10_963</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Element in der Aufzählung. Dieses Mal ist das Wachstum nicht so beeindruckend, aber es ist immer noch da. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Wissen können wir loslegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im statischen Initialisierungsblock </font></font><code>nextValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laden wir jetzt </font><font style="vertical-align: inherit;">anstelle von Methodenaufrufen </font><font style="vertical-align: inherit;">den Wert der dynamischen Konstante. Der Wert des </font></font><code>ordinal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ordnungsindex des Aufzählungselements wird explizit übergeben, wodurch das Feld </font></font><code>valueIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die Factory-Methode, entfernt wird</font></font><code>nextValue()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und Zweifel an der Thread-Sicherheit unserer Implementierung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Bootstrap-Methode verwenden wir einen speziellen Subtyp von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MethodHandle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der das Verhalten eines Operators </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in Java </font><font style="vertical-align: inherit;">imitiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die Standardbibliothek bietet eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MethodHandles.Lookup :: findConstructor ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Methode zum </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Abrufen</font></a><font style="vertical-align: inherit;"> eines solchen Methodenhandles. </font><font style="vertical-align: inherit;">In unserem Fall kümmert sich die JVM jedoch um die Erstellung des erforderlichen Methodenhandles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Konstruktor unserer Aufzählung als Bootstrap-Methode zu verwenden, muss er durch Ändern der Signatur geringfügig geändert werden. </font><font style="vertical-align: inherit;">Die für die Bootstrap-Methode erforderlichen Parameter werden dem traditionellen Konstruktor des Namensaufzählungselements und der Seriennummer hinzugefügt:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">FizzBuzz</span><span class="hljs-params">(MethodHandles.Lookup lookup, String name, Class&lt;?&gt; enumClass, <span class="hljs-keyword">int</span> ordinal)</span> </span>{
    <span class="hljs-keyword">super</span>(name, ordinal);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Form von Pseudocode sieht die Initialisierung folgendermaßen aus:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Fizz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"Fizz"</span>, <span class="hljs-number">0</span>);<font></font>
    Buzz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"Buzz"</span>, <span class="hljs-number">1</span>);<font></font>
    FizzBuzz = JVM_ldc(FizzBuzz::<span class="hljs-keyword">new</span>, <span class="hljs-string">"FizzBuzz"</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
    $VALUES = createValues();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im obigen Beispiel werden die Anweisungen </font></font><code>ldc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als Methodenaufrufe bezeichnet </font></font><code>JVM_ldc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Im Bytecode an ihrer Stelle befinden sich die entsprechenden JVM-Anweisungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir jetzt für jedes Element der Aufzählung eine eigene Konstante haben, kann das Erstellen und Füllen des Arrays </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auch über eine dynamische Konstante implementiert werden. </font><font style="vertical-align: inherit;">Die Bootstrap-Methode ist sehr einfach:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues(MethodHandles.Lookup lookup, String name, Class&lt;?&gt; clazz, FizzBuzz... elements) {
    <span class="hljs-keyword">return</span> elements;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Tricks in der Liste der statischen Parameter für diese dynamische Konstante, dort werden wir alle Elemente auflisten, die wir einfügen möchten </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BootstrapMethods:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  1: # 54 REF_invokeStatic FizzBuzz.createValues: (Ljava / lang / invoke / MethodHandles $ Lookup; Ljava / lang / String; Ljava / lang / Class; [LFizzBuzz;) [LFizzBuzz;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    Methodenargumente:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 1 # 0: Fizz: LFizzBuzz;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 2 # 0: Buzz: LFizzBuzz;</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      # 3 # 0: FizzBuzz: LFizzBuzz;</font></font><font></font>
</pre><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die JVM verwöhnt das Array mit diesen statischen Parametern und übergibt es als vararg-Parameter an unsere Bootstrap-Methode </font></font><code>elements</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die maximale Anzahl statischer Parameter beträgt traditionell 65_535, sodass sie garantiert für alle Elemente der Aufzählung ausreichen, unabhängig davon, wie viele es gibt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei Übertragungen mit einer großen Anzahl von Elementen wird durch diese Änderung die Größe der resultierenden Klassendatei verringert. Wenn die Methode aufgrund der großen Anzahl von Elementen </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in mehrere Teile aufgeteilt werden musste, werden auch Slots im konstanten Pool </font><font style="vertical-align: inherit;">gespeichert </font><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und am Ende ist es einfach wunderschön.</font></font><br>
<br>
<a name="Surprise"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plötzliche Schwierigkeiten</font></font></h1><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was wir heldenhaft überwinden, indem wir Klassen manuell generieren. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hochrangige Bibliotheken bieten eine bequeme Schnittstelle im Austausch für eine gewisse Einschränkung der Handlungsfreiheit. </font><font style="vertical-align: inherit;">Die ASM-Bibliothek, mit der wir Klassendateien generieren, ist keine Ausnahme. </font><font style="vertical-align: inherit;">Es bietet keine Mechanismen zur direkten Steuerung des Inhalts des Konstantenpools. </font><font style="vertical-align: inherit;">Dies ist normalerweise nicht sehr wichtig, aber in unserem Fall nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sich erinnern, benötigen wir die ersten 255 Elemente des konstanten Pools, um wertvolle Bytes im statischen Initialisierungsblock zu speichern. </font><font style="vertical-align: inherit;">Wenn dynamische Konstanten auf standardmäßige Weise hinzugefügt werden, werden sie an zufälligen Indizes lokalisiert und mit anderen Elementen gemischt, die für uns nicht so kritisch sind. </font><font style="vertical-align: inherit;">Dies verhindert, dass wir das Maximum erreichen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment eines auf traditionelle Weise gebildeten Konstantenpools</font></font></b>
                        <div class="spoiler_text"><blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konstanter Pool:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   # 1 = Utf8 FizzBuzz</font></font><font></font>
   #2 = Class              #1             // FizzBuzz<font></font>
   #3 = Utf8               java/lang/Enum<font></font>
   #4 = Class              #3             // java/lang/Enum<font></font>
   #5 = Utf8               $VALUES<font></font>
   #6 = Utf8               [LFizzBuzz;<font></font>
   #7 = Utf8               valueIndex<font></font>
   #8 = Utf8               I<font></font>
   #9 = Utf8               Fizz<font></font>
  #10 = Utf8               LFizzBuzz;<font></font>
  #11 = Utf8               Buzz<font></font>
  #12 = Utf8               FizzBuzz<font></font>
  #13 = Utf8               values<font></font>
  #14 = Utf8               ()[LFizzBuzz;<font></font>
  #15 = NameAndType        #5:#6          // $VALUES:[LFizzBuzz;<font></font>
  #16 = Fieldref           #2.#15         // FizzBuzz.$VALUES:[LFizzBuzz;<font></font>
  #17 = Class              #6             // "[LFizzBuzz;"<font></font>
  #18 = Utf8               clone<font></font>
  #19 = Utf8               ()Ljava/lang/Object;<font></font>
  #20 = NameAndType        #18:#19        // clone:()Ljava/lang/Object;<font></font>
  #21 = Methodref          #17.#20        // "[LFizzBuzz;".clone:()Ljava/lang/Object;<font></font>
  ...<font></font>
  #40 = NameAndType        #9:#10         // Fizz:LFizzBuzz;<font></font>
  #41 = Dynamic            #0:#40         // #0:Fizz:LFizzBuzz;<font></font>
  #42 = Fieldref           #2.#40         // FizzBuzz.Fizz:LFizzBuzz;<font></font>
  #43 = NameAndType        #11:#10        // Buzz:LFizzBuzz;<font></font>
  #44 = Dynamic            #0:#43         // #0:Buzz:LFizzBuzz;<font></font>
  #45 = Fieldref           #2.#43         // FizzBuzz.Buzz:LFizzBuzz;<font></font>
  #46 = NameAndType        #12:#10        // FizzBuzz:LFizzBuzz;<font></font>
  #47 = Dynamic            #0:#46         // #0:FizzBuzz:LFizzBuzz;<font></font>
  #48 = Fieldref           #2.#46         // FizzBuzz.FizzBuzz:LFizzBuzz;<font></font>
</pre><br>
</blockquote><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Glücklicherweise gibt es eine Problemumgehung: Beim Erstellen einer Klasse können Sie eine Beispielklasse angeben, aus der ein Pool von Konstanten und ein Attribut mit einer Beschreibung der Bootstrap-Methoden kopiert werden. </font><font style="vertical-align: inherit;">Erst jetzt müssen wir es manuell generieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Tat ist es nicht so schwierig, wie es auf den ersten Blick scheinen mag. </font><font style="vertical-align: inherit;">Das Format der Klassendatei ist recht einfach und die manuelle Generierung ist ein etwas langwieriger Prozess, aber keineswegs kompliziert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Wichtigste hier ist ein klarer Plan. </font><font style="vertical-align: inherit;">Um aus den </font></font><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elementen </font><font style="vertical-align: inherit;">aufzuzählen, die </font><font style="vertical-align: inherit;">wir brauchen:</font></font><br>
<br>
<ul>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typdatensätze </font></font><code>CONSTANT_Dynamic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- unsere dynamischen Konstanten</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typdatensätze </font></font><code>CONSTANT_NameAndType</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Verknüpfungspaare mit dem Namen des Aufzählungselements und seinem Typ. </font><font style="vertical-align: inherit;">Der Typ ist für alle gleich, dies ist der Klassentyp unserer Aufzählung.</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typdatensätze </font></font><code>CONSTANT_Utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- direkt die Namen der Aufzählungselemente</font></font></li>
<li><code>COUNT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datensätze vom Typ </font></font><code>CONSTANT_Integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Seriennummern von Aufzählungselementen, die als Parameterwert an den Konstruktor übergeben wurden</font></font><code>ordinal</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namen der aktuellen und Basisklassen, Attribute, Methodensignaturen und andere langweilige Implementierungsdetails. </font><font style="vertical-align: inherit;">Interessenten können im Quellcode des Generators nachsehen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viele konstituierende Elemente im Pool von Konstanten, die sich nach Index auf andere Elemente des Pools beziehen. Daher sollten alle Indizes, die wir im Voraus berechnen müssen, </font></font><code>elementNames</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Liste der Namen der Elemente unserer Aufzählung enthalten:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">int</span> elementCount = elementNames.size();<font></font>
<font></font>
<span class="hljs-keyword">int</span> baseConDy = <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> baseNameAndType = baseConDy + elementCount;
<span class="hljs-keyword">int</span> baseUtf8 = baseNameAndType + elementCount;
<span class="hljs-keyword">int</span> baseInteger = baseUtf8 + elementCount;
<span class="hljs-keyword">int</span> indexThisClass = baseInteger + elementCount;
<span class="hljs-keyword">int</span> indexThisClassUtf8 = indexThisClass + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexSuperClass = indexThisClassUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexSuperClassUtf8 = indexSuperClass + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodsUtf8 = indexSuperClassUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexConDyDescriptorUtf8 = indexBootstrapMethodsUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodHandle = indexConDyDescriptorUtf8 + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodRef = indexBootstrapMethodHandle + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodNameAndType = indexBootstrapMethodRef + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodName = indexBootstrapMethodNameAndType + <span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> indexBootstrapMethodDescriptor = indexBootstrapMethodName + <span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-keyword">int</span> constantPoolSize = indexBootstrapMethodDescriptor + <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach fangen wir an zu schreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu Beginn - die Signatur der Klassendatei, die vier allen bekannten Bytes </font></font><nobr><code>0xCA 0xFE 0xBA 0xBE</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Dateiformatversion:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Class file header</span><font></font>
u4(CLASS_FILE_SIGNATURE);<font></font>
u4(version);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann - ein Pool von Konstanten:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pool von Konstanten</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">// Constant pool</span><font></font>
u2(constantPoolSize);<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Dynamic</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1u2u2(CONSTANT_Dynamic, i, baseNameAndType + i);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_NameAndType</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1u2u2(CONSTANT_NameAndType, baseUtf8 + i, indexConDyDescriptorUtf8);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Utf8</span>
<span class="hljs-comment">//noinspection ForLoopReplaceableByForEach</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1(CONSTANT_Utf8);<font></font>
    utf8(elementNames.get(i));<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// N * CONSTANT_Integer</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {<font></font>
    u1(CONSTANT_Integer);<font></font>
    u4(i);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ThisClass</span><font></font>
u1(CONSTANT_Class);<font></font>
u2(indexThisClassUtf8);<font></font>
<font></font>
<span class="hljs-comment">// ThisClassUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(enumClassName);<font></font>
<font></font>
<span class="hljs-comment">// SuperClass</span><font></font>
u1(CONSTANT_Class);<font></font>
u2(indexSuperClassUtf8);<font></font>
<font></font>
<span class="hljs-comment">// SuperClassUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(JAVA_LANG_ENUM);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodsUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(ATTRIBUTE_NAME_BOOTSTRAP_METHODS);<font></font>
<font></font>
<span class="hljs-comment">// ConDyDescriptorUtf8</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(binaryEnumClassName);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodHandle</span><font></font>
u1(CONSTANT_MethodHandle);<font></font>
u1(REF_newInvokeSpecial);<font></font>
u2(indexBootstrapMethodRef);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodRef</span><font></font>
u1u2u2(CONSTANT_Methodref, indexThisClass, indexBootstrapMethodNameAndType);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodNameAndType</span><font></font>
u1u2u2(CONSTANT_NameAndType, indexBootstrapMethodName, indexBootstrapMethodDescriptor);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodName</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(BOOTSTRAP_METHOD_NAME);<font></font>
<font></font>
<span class="hljs-comment">// BootstrapMethodDescriptor</span><font></font>
u1(CONSTANT_Utf8);<font></font>
utf8(BOOTSTRAP_METHOD_DESCRIPTOR);<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem der Pool konstant sprechen über Zugriffsmodifikatoren und Flaggen ( </font></font><code>public</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>enun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, usw.), der Klassenname und seine Vorfahren:</font></font><br>
<br>
<pre><code class="java hljs">u2(access);<font></font>
u2(indexThisClass);<font></font>
u2(indexSuperClass);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die von uns generierte Dummy-Klasse hat keine Schnittstellen, keine Felder, keine Methoden, aber es gibt ein Attribut mit einer Beschreibung der Bootstrap-Methoden:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Interfaces count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Fields count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Methods count</span>
u2(<span class="hljs-number">0</span>);
<span class="hljs-comment">// Attributes count</span>
u2(<span class="hljs-number">1</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier ist der Hauptteil des Attributs selbst:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// BootstrapMethods attribute</span><font></font>
u2(indexBootstrapMethodsUtf8);<font></font>
<span class="hljs-comment">// BootstrapMethods attribute size</span>
u4(<span class="hljs-number">2</span> <span class="hljs-comment">/* num_bootstrap_methods */</span> + <span class="hljs-number">6</span> * elementCount);
<span class="hljs-comment">// Bootstrap method count</span><font></font>
u2(elementCount);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {
    <span class="hljs-comment">// bootstrap_method_ref</span><font></font>
    u2(indexBootstrapMethodHandle);<font></font>
    <span class="hljs-comment">// num_bootstrap_arguments</span>
    u2(<span class="hljs-number">1</span>);
    <span class="hljs-comment">// bootstrap_arguments[1]</span><font></font>
    u2(baseInteger + i);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles, die Klasse ist gebildet. </font><font style="vertical-align: inherit;">Wir nehmen diese Bytes und erstellen daraus </font></font><code>ClassReader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> ClassReader <span class="hljs-title">getBootstrapClassReader</span><span class="hljs-params">(<span class="hljs-keyword">int</span> version, <span class="hljs-keyword">int</span> access, String enumClassName, List&lt;String&gt; elementNames)</span> </span>{
    <span class="hljs-keyword">byte</span>[] bootstrapClassBytes = <span class="hljs-keyword">new</span> ConDyBootstrapClassGenerator(<font></font>
        version,<font></font>
        access,<font></font>
        enumClassName,<font></font>
        elementNames<font></font>
    )<font></font>
    .generate();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (bootstrapClassBytes == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClassReader(bootstrapClassBytes);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war nicht so schwierig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generator-Quellcode: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConDyBootstrapClassGenerator.java</font></font></a><br>
<a name="Future"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strahlende Zukunft</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir schweifen kurz von unseren Auflistungen ab:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscoverConstantValueAttribute</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String STRING = <span class="hljs-string">"Habrahabr, world!"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object OBJECT = <span class="hljs-keyword">new</span> Object();<font></font>
<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im statischen Initialisierungsblock dieser Klasse gibt es plötzlich nur noch eine Schreiboperation im Feld </font></font><code>OBJECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">static</span> {<font></font>
    OBJECT = <span class="hljs-keyword">new</span> Object();
    <span class="hljs-comment">//  0: new           #2                  // class java/lang/Object</span>
    <span class="hljs-comment">//  3: dup</span>
    <span class="hljs-comment">//  4: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span>
    <span class="hljs-comment">//  7: putstatic     #7                  // Field OBJECT:Ljava/lang/Object;</span>
    <span class="hljs-comment">// 10: return</span><font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber was ist mit </font></font><code>STRING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Team wird helfen, Licht in dieses Rätsel zu bringen </font></font><nobr><code>javap -c -s -p -v DiscoverConstantValueAttribute.class</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hier ist das Fragment, das uns interessiert:</font></font><br>
<br>
<pre><code class="java hljs">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.lang.String STRING;<font></font>
  descriptor: Ljava/lang/String;<font></font>
  flags: (<span class="hljs-number">0x0019</span>) ACC_PUBLIC, ACC_STATIC, ACC_FINAL<font></font>
  ConstantValue: String Habrahabr, world!<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Wert des statischen Endfelds wurde vom Initialisierungsblock in ein separates Attribut verschoben </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folgendes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schreiben sie über dieses Attribut in </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">JVMS11 §4.7.2</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein ConstantValue-Attribut stellt den Wert eines konstanten Ausdrucks dar (JLS §15.28) und wird wie folgt verwendet:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn das ACC_STATIC-Flag im Element access_flags der Struktur field_info gesetzt ist, wird dem durch die Struktur field_info dargestellten Feld der Wert zugewiesen, der durch das Attribut ConstantValue im Rahmen der Initialisierung der Klasse oder Schnittstelle dargestellt wird, die das Feld deklariert (§5.5). </font><font style="vertical-align: inherit;">Dies erfolgt vor dem Aufruf der Klassen- oder Schnittstelleninitialisierungsmethode dieser Klasse oder Schnittstelle (§2.9.2).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andernfalls muss die Java Virtual Machine das Attribut stillschweigend ignorieren.</font></font></li>
</ul><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ein solches Attribut gleichzeitig </font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(obwohl letzteres hier nicht explizit angegeben ist) in einem Feld </font><font style="vertical-align: inherit;">auftritt </font><font style="vertical-align: inherit;">, wird ein solches Feld mit dem Wert aus diesem Attribut initialisiert. </font><font style="vertical-align: inherit;">Dies geschieht bereits vor dem Aufruf der statischen Initialisierungsmethode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wäre verlockend, dieses Attribut zu verwenden, um die Elemente der Aufzählung zu initialisieren. In unserem vorletzten Kapitel gab es nur Konstanten, wenn auch dynamische. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wir sind nicht die ersten, die in diese Richtung denken, es gibt eine Erwähnung in JEP 309 </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Leider ist diese Erwähnung im zukünftigen Arbeitskapitel enthalten:</font></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zukünftige Arbeiten</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mögliche zukünftige Erweiterungen umfassen: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anhängen dynamischer Konstanten an das ConstantValue-Attribut statischer Felder</font></font></li>
</ul><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Zwischenzeit können wir nur von den Zeiten träumen, in denen diese Funktion vom Status „Gut zu tun“ zu „Bereit“ wechselt. </font><font style="vertical-align: inherit;">Dann verlieren die Einschränkungen für die Größe des Codes im Initialisierungsblock ihren Einfluss und die maximale Anzahl von Elementen in der Aufzählung bestimmt die Einschränkungen des konstanten Pools. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach groben Schätzungen können wir in diesem Fall auf ein </font></font><code>65&nbsp;489 / 4 = 16_372</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Element </font><font style="vertical-align: inherit;">hoffen </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hier </font></font><code>65_489</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist die Anzahl der nicht besetzten Slots des konstanten Pools, 46 der theoretisch möglichen 65_535 gingen an den Overhead. </font></font><code>4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- die Anzahl der für die Deklaration eines Feldes erforderlichen Slots und die entsprechende dynamische Konstante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die genaue Anzahl kann natürlich erst nach der Veröffentlichung der JDK-Version mit Unterstützung für diese Funktion ermittelt werden.</font></font><br>
<br>
<a name="Unsafe"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsicher</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Feind ist das lineare Wachstum des Initialisierungsblocks mit einer Zunahme der Anzahl von Aufzählungselementen. </font><font style="vertical-align: inherit;">Wenn wir einen Weg gefunden hätten, die Initialisierung in einer Schleife einzuschränken und dadurch die Beziehung zwischen der Anzahl der Elemente in der Aufzählung und der Größe des Initialisierungsblocks zu entfernen, würden wir einen weiteren Durchbruch erzielen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider erlaubt keine der öffentlichen Standard-APIs das Schreiben in </font></font><code>static final</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Felder, selbst innerhalb eines statischen Initialisierungsblocks. </font><font style="vertical-align: inherit;">Weder Reflection noch VarHandles helfen hier. </font><font style="vertical-align: inherit;">Unsere einzige Hoffnung ist groß und schrecklich </font></font><code>sun.misc.Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine unsichere Ausführung von FizzBuzz könnte ungefähr so ​​aussehen:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsicheres FizzBuzz</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">import</span> java.lang.reflect.Field;
<span class="hljs-keyword">import</span> sun.misc.Unsafe;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> FizzBuzz {<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz[] $VALUES;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz Fizz;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz Buzz;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FizzBuzz FizzBuzz;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FizzBuzz[] values() {
        <span class="hljs-keyword">return</span> (FizzBuzz[]) $VALUES.clone();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FizzBuzz <span class="hljs-title">valueOf</span><span class="hljs-params">(String name)</span> </span>{
        <span class="hljs-keyword">return</span> (FizzBuzz) Enum.valueOf(FizzBuzz.class, name);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">FizzBuzz</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> ordinal)</span> </span>{
        <span class="hljs-keyword">super</span>(name, ordinal);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FizzBuzz[] createValues() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FizzBuzz[] {<font></font>
            Fizz,<font></font>
            Buzz,<font></font>
            FizzBuzz<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">static</span>  {<font></font>
        Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
        unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
        Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
        String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
            String fieldName = fieldNames[i];<font></font>
            Field field = FizzBuzz.class.getDeclaredField(fieldName);<font></font>
            <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
            unsafe.putObject(FizzBuzz.class, fieldOffset, <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i));<font></font>
        }<font></font>
<font></font>
        $VALUES = createValues();<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Ansatz ermöglicht es uns, eine Aufzählung mit ungefähr 21.000 Elementen zu erstellen, für mehr reicht die Kapazität des Konstantenpools nicht aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Dokumentation zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enum :: ordinal ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erfordert, dass sein Wert mit der Sequenznummer des entsprechenden Elements in der Aufzählungsdeklaration übereinstimmt. Daher müssen Sie die Liste der Feldnamen explizit in der richtigen Reihenfolge speichern, wodurch sich die Größe der Klassendatei fast verdoppelt.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public final int ordinal () </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gibt die Ordnungszahl dieser Aufzählungskonstante zurück (ihre Position in ihrer Aufzählungsdeklaration, wobei der Anfangskonstante eine Ordnungszahl von Null zugewiesen wird).</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier könnte die öffentliche API zum Inhalt des Konstantenpools helfen. Wir wissen bereits, wie man sie in der von uns benötigten Reihenfolge ausfüllt, aber es gibt keine solche API und es ist unwahrscheinlich, dass dies jemals der Fall sein wird. Die in OpenJDK verfügbare </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class :: getConstantPool ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Methode wird </font><font style="vertical-align: inherit;">als </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">paketprivat</font></a><font style="vertical-align: inherit;"> deklariert, und es wäre unüberlegt, sich im Benutzercode darauf zu verlassen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Initialisierungsblock ist jetzt ziemlich kompakt und nahezu unabhängig von der Anzahl der Elemente in der Aufzählung. Sie </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können ihn also ablehnen, indem Sie seinen Körper in die Schleife einbetten:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
    unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
    Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
    String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
    FizzBuzz[] localValues = <span class="hljs-keyword">new</span> FizzBuzz[fieldNames.length];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
        String fieldName = fieldNames[i];<font></font>
        Field field = FizzBuzz.class.getDeclaredField(fieldName);<font></font>
        <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
        unsafe.putObject(<font></font>
            FizzBuzz.class,<font></font>
            fieldOffset,<font></font>
            (localValues[i] = <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i))<font></font>
        );<font></font>
    }<font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier geschieht ein Lawinen-ähnlicher Prozess: Zusammen mit der Methode </font></font><code>createValues()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verschwinden Anweisungen zum Lesen von Feldern von Aufzählungselementen, Typdatensätze </font></font><code>Fieldref</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für diese Felder </font><font style="vertical-align: inherit;">werden unnötig </font><font style="vertical-align: inherit;">und </font></font><code>NameAndType</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typdatensätze für Typdatensätze </font></font><code>Fieldref</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Im konstanten Pool werden </font></font><code>2 * &lt;   &gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slots </font><font style="vertical-align: inherit;">freigegeben </font><font style="vertical-align: inherit;">, mit denen zusätzliche Aufzählungselemente deklariert werden können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber nicht alles ist so rosig, Tests zeigen einen signifikanten Leistungsabfall: Das Initialisieren einer Aufzählungsklasse mit 65.000 Elementen dauert eineinhalb Minuten undenkbar. Wie sich ziemlich schnell herausstellte, "verlangsamt sich der Reflex". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Implementierung von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class :: getDeclaredField ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in OpenJDK hat ein lineares asymptotisches Verhalten der Anzahl der Felder in der Klasse, und unser Initialisierungsblock ist aus diesem Grund quadratisch.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Hinzufügen von Caching verbessert die Situation etwas, löst es jedoch nicht vollständig:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span>  {<font></font>
    Field unsafeField = Unsafe.class.getDeclaredField("theUnsafe");<font></font>
    unsafeField.setAccessible(<span class="hljs-keyword">true</span>);<font></font>
    Unsafe unsafe = (Unsafe) unsafeField.get(<span class="hljs-keyword">null</span>);<font></font>
<font></font>
    String[] fieldNames = "Fizz,Buzz,FizzBuzz".split(",");<font></font>
    Field[] fields = FizzBuzz.class.getDeclaredFields();<font></font>
    HashMap&lt;String, Field&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(fields.length);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(Field field : fields) {<font></font>
        cache.put(field.getName(), field);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fieldNames.length; i++) {<font></font>
        String fieldName = fieldNames[i];<font></font>
        Field field = cache.get(fieldName);<font></font>
        <span class="hljs-keyword">long</span> fieldOffset = unsafe.staticFieldOffset(field);<font></font>
        unsafe.putObject(<font></font>
            FizzBuzz.class,<font></font>
            fieldOffset,<font></font>
            (localValues[i] = <span class="hljs-keyword">new</span> FizzBuzz(fieldName, i))<font></font>
        );<font></font>
    }    <font></font>
<font></font>
    $VALUES = localValues;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem in diesem Kapitel beschriebenen unsicheren Ansatz können Sie Übertragungen mit einer Anzahl von Elementen bis zu 65_410 erstellen. Dies ist fast das 24-fache des mit javac erzielbaren Ergebnisses und liegt ziemlich nahe an der theoretischen Grenze von 65_505 Elementen, die wir in der vorherigen Veröffentlichung des Zyklus berechnet haben.</font></font><br>
<br>
<a name="Testing"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Überprüfen Sie die Leistung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für Tests nehmen wir die größte Aufzählung und generieren sie mit dem Befehl </font></font><nobr><code>java -jar HugeEnumGen.jar -a Unsafe UnsafeHugeEnum</code></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Als Ergebnis erhalten wir eine Klassendatei mit einer Größe von 2 Megabyte und 65_410 Elementen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie ein neues Java-Projekt in IDEA und fügen Sie die generierte Klasse als externe Bibliothek hinzu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast sofort fällt auf, dass IDEA für einen solchen Stresstest nicht bereit ist: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/su/-6/m4su-6bvdkkqmf3pypqrmpzntnw.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
automatische Vervollständigung eines Aufzählungselements dauert sowohl auf dem alten mobilen i5 als auch auf dem moderneren i7 8700K mehrere zehn Sekunden. Wenn Sie versuchen, die fehlenden Elemente mithilfe der Schnellkorrektur zum Switch hinzuzufügen, hört IDEA sogar auf, die Fenster neu zu zeichnen. Ich vermute das vorübergehend, konnte aber nicht auf die Fertigstellung warten. Die Reaktionsfähigkeit beim Debuggen lässt ebenfalls zu wünschen übrig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit einer kleinen Anzahl von Elementen in </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestFew</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String... args)</span> </span>{
        <span class="hljs-keyword">for</span>(String arg : args) {<font></font>
            System.out.print(arg + <span class="hljs-string">" : "</span>);<font></font>
<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                UnsafeHugeEnum value = UnsafeHugeEnum.valueOf(arg);<font></font>
<font></font>
                doSwitch(value);<font></font>
            } <span class="hljs-keyword">catch</span>(Throwable e) {<font></font>
                e.printStackTrace(System.out);<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSwitch</span><span class="hljs-params">(UnsafeHugeEnum value)</span> </span>{
        <span class="hljs-keyword">switch</span>(value) {
            <span class="hljs-keyword">case</span> VALUE_00001:<font></font>
                System.out.println(<span class="hljs-string">"First"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VALUE_31415:<font></font>
                System.out.println(<span class="hljs-string">"(int) (10_000 * Math.PI)"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> VALUE_65410:<font></font>
                System.out.println(<span class="hljs-string">"Last"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:<font></font>
                System.out.println(<span class="hljs-string">"Unexpected value: "</span> + value);
                <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier gibt es keine Überraschungen, Zusammenstellung und Start sind regelmäßig:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ java TestFew VALUE_00001 VALUE_00400 VALUE_31415 VALUE_65410<font></font>
VALUE_00001 : First<font></font>
VALUE_00400 : Unexpected value: VALUE_00400<font></font>
VALUE_31415 : (int) (10_000 * Math.PI)<font></font>
VALUE_65410 : Last<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist mit mehr Artikeln in </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Können wir zum Beispiel </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alle unsere 65.000 Elemente gleichzeitig verarbeiten?</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">switch</span>(value) {
    <span class="hljs-keyword">case</span> VALUE_00001:
    <span class="hljs-keyword">case</span> VALUE_00002:<font></font>
        ...<font></font>
    <span class="hljs-keyword">case</span> VALUE_65410:<font></font>
        System.out.println(<span class="hljs-string">"One of known values: "</span> + value);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
        System.out.println(<span class="hljs-string">"Unexpected value: "</span> + value);
        <span class="hljs-keyword">break</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ach nein. </font><font style="vertical-align: inherit;">Wenn wir versuchen zu kompilieren, erhalten wir eine ganze Reihe von Fehlermeldungen:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ javac -fullversion<font></font>
javac full version "14.0.1+7"<font></font>
<font></font>
$ javac TestAll.java<font></font>
TestAll.java:18: error: code too large for try statement<font></font>
        switch(value) {<font></font>
        ^<font></font>
TestAll.java:65433: error: too many constants<font></font>
                break;<font></font>
                ^<font></font>
TestAll.java:17: error: code too large<font></font>
    private static void doSwitch(UnsafeHugeEnum value) {<font></font>
                        ^<font></font>
TestAll.java:1: error: too many constants<font></font>
public class TestAll {<font></font>
       ^<font></font>
4 errors<font></font>
</code></pre><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testfew.java</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestAll.java</font></font></a></li>
</ul><br>
<a name="JavacSwitchTranslation"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javac und wechseln</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, was passiert, müssen wir herausfinden, wie die Übersetzung </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Elemente der Aufzählung </font><font style="vertical-align: inherit;">erfolgt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die JVM-Spezifikation enthält ein separates Kapitel in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JVMS11 §3.10 Kompilieren von Switches</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dessen Empfehlungen sich auf die </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendung einer der beiden Bytecode-Anweisungen beschränken, </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder </font></font><code>lookupswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Kapitel finden wir </font><font style="vertical-align: inherit;">keine Verweise </font><font style="vertical-align: inherit;">auf Zeichenfolgen oder Aufzählungselemente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die beste Dokumentation ist Code, also ist es Zeit, in die Quelle einzutauchen </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Wahl zwischen </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>lookupswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erfolgt in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen :: visitSwitch ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und hängt von der Anzahl der Optionen in ab </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In den meisten Fällen gewinnt </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// Determine whether to issue a tableswitch or a lookupswitch</span>
<span class="hljs-comment">// instruction.</span>
<span class="hljs-keyword">long</span> table_space_cost = <span class="hljs-number">4</span> + ((<span class="hljs-keyword">long</span>) hi - lo + <span class="hljs-number">1</span>); <span class="hljs-comment">// words</span>
<span class="hljs-keyword">long</span> table_time_cost = <span class="hljs-number">3</span>; <span class="hljs-comment">// comparisons</span>
<span class="hljs-keyword">long</span> lookup_space_cost = <span class="hljs-number">3</span> + <span class="hljs-number">2</span> * (<span class="hljs-keyword">long</span>) nlabels;
<span class="hljs-keyword">long</span> lookup_time_cost = nlabels;
<span class="hljs-keyword">int</span> opcode =<font></font>
    nlabels &gt; <span class="hljs-number">0</span> &amp;&amp;<font></font>
    table_space_cost + <span class="hljs-number">3</span> * table_time_cost &lt;=<font></font>
    lookup_space_cost + <span class="hljs-number">3</span> * lookup_time_cost<font></font>
    ?<font></font>
    tableswitch : lookupswitch;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Header </font></font><code>tableswitch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besteht aus ungefähr 16 Bytes plus 4 Bytes pro Wert. </font><font style="vertical-align: inherit;">Somit </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kann es unter keinen Umständen mehr </font></font><code>( 65_535 - 16 ) / 4 = 16_379</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elemente geben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Tat </font><font style="vertical-align: inherit;">bleibt </font><font style="vertical-align: inherit;">nach der Reduzierung der Anzahl der Zweige </font></font><code>case</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Körper </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf 16.000 nur ein Kompilierungsfehler übrig, der mysteriöseste:</font></font><br>
<br>
<pre><code class="plaintext hljs">TestAll.java:18: error: code too large for try statement<font></font>
        switch(value) {<font></font>
        ^<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Suche nach der Fehlerquelle werden wir etwas früher zum Stadium der Beseitigung des syntaktischen Zuckers zurückkehren. </font><font style="vertical-align: inherit;">Die </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methoden sind für die </font><font style="vertical-align: inherit;">Übersetzung </font></font><code>visitEnumSwitch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>mapForEnum()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Klasse </font></font><code>EnumMapping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lower.java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dort finden wir auch einen kleinen dokumentarischen Kommentar:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EnumMapping JavaDoc</font></font></b>
                        <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">/** This map gives a translation table to be used for enum
 *  switches.
 *
 *  &lt;p&gt;For each enum that appears as the type of a switch
 *  expression, we maintain an EnumMapping to assist in the
 *  translation, as exemplified by the following example:
 *
 *  &lt;p&gt;we translate
 *  &lt;pre&gt;
 *          switch(colorExpression) {
 *          case red: stmt1;
 *          case green: stmt2;
 *          }
 *  &lt;/pre&gt;
 *  into
 *  &lt;pre&gt;
 *          switch(Outer$0.$EnumMap$Color[colorExpression.ordinal()]) {
 *          case 1: stmt1;
 *          case 2: stmt2
 *          }
 *  &lt;/pre&gt;
 *  with the auxiliary table initialized as follows:
 *  &lt;pre&gt;
 *          class Outer$0 {
 *              synthetic final int[] $EnumMap$Color = new int[Color.values().length];
 *              static {
 *                  try { $EnumMap$Color[red.ordinal()] = 1; } catch (NoSuchFieldError ex) {}
 *                  try { $EnumMap$Color[green.ordinal()] = 2; } catch (NoSuchFieldError ex) {}
 *              }
 *          }
 *  &lt;/pre&gt;
 *  class EnumMapping provides mapping data and support methods for this translation.
 */</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Geheimnisvolle </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entpuppt sich als Teil einer automatisch generierten Helferklasse </font></font><code>TestAll$0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Inside - eine Deklaration eines statischen Arrays und Codes zum Initialisieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Array korrigiert die Entsprechung zwischen den Namen der Aufzählungselemente und den ihnen beim Kompilieren zugewiesenen </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">numerischen Werten und schützt so den kompilierten Code vor den schädlichen Auswirkungen des Refactorings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Neuanordnen, Hinzufügen neuer oder Löschen vorhandener Aufzählungselemente können einige von ihnen den Wert ändern, </font></font><code>ordinal()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und dies ist es, wovor eine zusätzliche Indirektionsebene schützt.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    $SwitchMap$UnsafeHugeEnum[UnsafeHugeEnum.VALUE_00001.ordinal()] = <span class="hljs-number">1</span>;
    <span class="hljs-comment">//  9: getstatic     #2                  // Field $SwitchMap$UnsafeHugeEnum:[I</span>
    <span class="hljs-comment">// 12: getstatic     #3                  // Field UnsafeHugeEnum.VALUE_00001:LUnsafeHugeEnum;</span>
    <span class="hljs-comment">// 15: invokevirtual #4                  // Method UnsafeHugeEnum.ordinal:()I</span>
    <span class="hljs-comment">// 18: iconst_1</span>
    <span class="hljs-comment">// 19: iastore</span><font></font>
}<font></font>
<span class="hljs-comment">// 20: goto          24</span>
<span class="hljs-keyword">catch</span>(NoSuchFieldError e) { }
<span class="hljs-comment">// 23: astore_0</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Initialisierungscode ist einfach und verbraucht 15 bis 17 Bytes pro Element. </font><font style="vertical-align: inherit;">Infolgedessen nimmt der statische Initialisierungsblock die Initialisierung von nicht mehr als 3_862 Elementen auf. </font><font style="vertical-align: inherit;">Diese Anzahl stellt sich als die maximale Anzahl von Aufzählungselementen heraus, die wir </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit der aktuellen Implementierung </font><font style="vertical-align: inherit;">in einem verwenden können </font></font><code>javac</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="Conclusion"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben gesehen, dass Sie mit einer so einfachen Technik wie dem Zuweisen der Erstellung von Aufzählungselementen und dem Initialisieren eines Arrays </font></font><code>$VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einer separaten Methode die maximale Anzahl von Elementen in einer Aufzählung von 2_746 auf 10_920 erhöhen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die konstanten dynamischen Ergebnisse vor dem Hintergrund früherer Erfolge sehen nicht sehr beeindruckend aus und ermöglichen es Ihnen, nur 43 Elemente mehr zu erhalten. Bei diesem Ansatz ist es jedoch viel eleganter, der Aufzählung neue Eigenschaften hinzuzufügen. Ändern Sie einfach den Konstruktor und übergeben Sie die erforderlichen Werte an die statischen Parameter der dynamischen Konstante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn irgendwann in der Zukunft das Attribut </font></font><code>ConstantValue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gelehrt wird, die dynamischen Konstanten zu verstehen, könnte diese Zahl auf 10 Tausend bis 16 ansteigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwendung</font></font><code>sun.misc.Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ermöglicht es Ihnen, einen riesigen Sprung zu machen und die maximale Anzahl von Elementen auf 65_410 zu erhöhen. Vergessen Sie jedoch nicht, dass </font></font><code>Unsafe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dies eine proprietäre API ist, die im Laufe der Zeit verschwinden kann und deren Verwendung ein erhebliches Risiko darstellt, da javac direkt warnt:</font></font><br>
<br>
<pre><code class="plaintext hljs">Test.java:3: warning: Unsafe is internal proprietary API and may be removed in a future release<font></font>
import sun.misc.Unsafe;<font></font>
               ^<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sich herausstellte, reicht es jedoch nicht aus, eine riesige Aufzählung zu generieren, sondern Sie müssen sie auch verwenden können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derzeit gibt es Probleme mit der Unterstützung solcher Aufzählungen sowohl von der IDE als auch auf der Java-Compilerebene. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine große Anzahl von Feldern in der Klasse kann die Reaktionsfähigkeit der IDE sowohl während der Bearbeitung als auch während des Debuggens beeinträchtigen. </font><font style="vertical-align: inherit;">Manchmal bis zu einem kompletten Hang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die durch das Klassendateiformat und die Implementierungsdetails von javac auferlegten Einschränkungen machen es unmöglich, </font></font><code>switch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehr als 3_862 Elemente gleichzeitig </font><font style="vertical-align: inherit;">im Code </font><font style="vertical-align: inherit;">zu verwenden. </font><font style="vertical-align: inherit;">Von den positiven Aspekten ist zu erwähnen, dass dies beliebige 3_862 Elemente sein können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine weitere Verbesserung der Ergebnisse ist nur durch die Verfeinerung des Java-Compilers möglich, aber das ist eine ganz andere Geschichte.</font></font><br>
<br>
<a name="Appendix"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusätzliche Materialien</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitHub-Quellcode: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Maccimo/HugeEnumGeneratorArticle</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Gesammelte JAR-Datei: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Maccimo/HugeEnumGeneratorArticle/releases/tag/v1.0</font></font></a><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unterstützte Starthilfe</font></font></b>
                        <div class="spoiler_text"><pre><font></font>
Huge enumeration generator<font></font>
<font></font>
    https://github.com/Maccimo/HugeEnumGeneratorArticle<font></font>
<font></font>
Additional information (in Russian):<font></font>
<font></font>
    https://habr.com/ru/post/483392/<font></font>
    https://habr.com/ru/post/501870/<font></font>
<font></font>
Usage:<font></font>
    java -jar HugeEnumGen.jar [ &lt;options&gt; ] &lt;enum name&gt;<font></font>
<font></font>
    &lt;enum name&gt;<font></font>
        An enumeration class name.<font></font>
        Should be a valid Java identifier. May contain package name.<font></font>
<font></font>
Options:<font></font>
<font></font>
    -d &lt;directory&gt;<font></font>
        Output directory path.<font></font>
        Current working directory by default.<font></font>
<font></font>
    -e &lt;item list file&gt;<font></font>
        Path to UTF8-encoded text file with list of enumeration item names.<font></font>
        Item names will be autogenerated if absent.<font></font>
        Mutually exclusive with the -c option.<font></font>
<font></font>
    -c &lt;count&gt;<font></font>
        Count of autogenerated enumeration item names.<font></font>
        Mutually exclusive with the -e option.<font></font>
        Default value: Algorithm-depended<font></font>
<font></font>
    -a &lt;algorithm&gt;<font></font>
        Enumeration generation algorithm.<font></font>
        Supported algorithms:<font></font>
          ConDy          - Employ Constant Dynamic (JEP 309) for enum elements initialization<font></font>
          ExtractMethod  - Extract enum elements initialization code to separate method<font></font>
          Unsafe         - Employ sun.misc.Unsafe for enum elements initialization<font></font>
<font></font>
        Default algorithm: ExtractMethod<font></font>
<font></font>
    -h / -?<font></font>
        Show this help page.<font></font>
<font></font>
Example:<font></font>
<font></font>
    java -jar HugeEnumGen.jar -d ./bin -c 2020 com.habr.maccimo.HugeEnum2020<font></font>
<font></font>
</pre><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de501860/index.html">15. Mai RU-Center kann Ihnen ohne Ihre Teilnahme einen kostenpflichtigen Service hinzufügen</a></li>
<li><a href="../de501862/index.html">Flattern unter der Haube</a></li>
<li><a href="../de501864/index.html">Assistent oder Inspektor: Für wen ruft der Roboter?</a></li>
<li><a href="../de501866/index.html">Wie viele Jobs werden Roboter zerstören?</a></li>
<li><a href="../de501868/index.html">Wie man den Buchhalter sich nicht werfen lässt oder Wir übertragen 1C in die Cloud. Schritt-für-Schritt-Anleitung</a></li>
<li><a href="../de501872/index.html">Studienort in kybernetischen Systemen</a></li>
<li><a href="../de501874/index.html">Moderne Frontend-Architekturen (Teil 2)</a></li>
<li><a href="../de501880/index.html">Über die Übersetzung von "Anfängen" und "Anfängen" ohne Anfang, Anfang und zuerst</a></li>
<li><a href="../de501882/index.html">Wie wir Computer-Vision-Algorithmen verwenden: Videoverarbeitung in einem mobilen Browser mit OpenCV.js</a></li>
<li><a href="../de501884/index.html">Wie elektronische medizinische Informationsarchive helfen, Krankheiten effektiver zu diagnostizieren</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>