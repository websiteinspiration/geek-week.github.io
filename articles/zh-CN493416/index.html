<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👭 🏬 🌛 IDA Pro和逆向工程技术 🤵🏼 👧🏼 🙋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0x00开始
 

; {EN} entry point, do nothing, just run _main {EN}
 

针对“黑暗勇士”的初学者的文章，那些想跳入权力黑暗面的人：逆向工程。在我们的“手术台”上，将有一个通过TCP / IP运行的小型手工服务器。为了分析数据交换协议，我们将使...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IDA Pro和逆向工程技术</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/493416/"><h2 id="0x00-start"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x00开始</font></font></h2><br>
<p><code>; {EN} entry point, do nothing, just run _main {EN}</code></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">针对“黑暗勇士”的初学者的文章，那些想跳入权力黑暗面的人：逆向工程。</font><font style="vertical-align: inherit;">在我们的“手术台”上，将有一个通过TCP / IP运行的小型手工服务器。</font><font style="vertical-align: inherit;">为了分析数据交换协议，我们将使用反向领域的事实上的标准-IDA Pro来帮助我们。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经有很多关于逆向工程和IDA Pro的文章（尽管在PHP上不多），但是由于逆向过程是研究工作，因此如何从``另一端''着手进行逆向开发任务的想法对于初学者很有用。</font><font style="vertical-align: inherit;">至少作为作者，我受到这样一种思想的指导：将我早年向所有实习生以及大学逆向工程课程的前几对讲到的基本实践和技术加以阐述。</font></font></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文章中将没有什么内容？</font></font></b><div class="spoiler_text"><p>      Google Chrome  Apple iPhone…           CVE  , ,      - . </p></div></div><br>
<p><img src="https://habrastorage.org/webt/6t/km/_2/6tkm_2r_gulckeqjxzls8ah3g-w.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“一旦你走上了黑暗的道路，它将永远统治你的命运。”</font></font></em></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主题：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的crackme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不运行主系统上的二进制文件，这是更好地做到这一点在虚拟机上！</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统要求：安装了Windows 7 / 0xA的虚拟机</font></font></p><br>
<h3 id="0x01-mov-eax-ds__stack_chk_guard"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x01 mov eax，ds：__ stack_chk_guard</font></font></h3><br>
<p><code>; {EN} Disclaimer {EN}</code></p><br>
<p>      , ,  x86,    ,   (),   ..        .     ,      .</p><br>
<p><img src="https://habrastorage.org/webt/pr/lw/bo/prlwbor_myuddgm_4d249est5q0.jpeg"></p><br>
<h2 id="0x10-chto-nam-nuzhno-chtoby-ponyat-o-chyom-poydet-rech">0x10   ,      ?</h2><br>
<p><code>; {EN} Setups prerequisites for the consequent execution {EN}</code></p><br>
<p>     , ,   :</p><br>
<ul>
<li>  C  C++;</li>
<li>   x86;</li>
<li>     (PE, ELF);</li>
<li>   ,  — ;</li>
<li>   ;</li>
<li><del> </del>;</li>
<li><del>  </del>.</li>
</ul><br>
<p> <strong></strong>,    —  IDA Pro   Hex-Rays (  ,  “ ”   “”,  ,       “  ”,       ).       ,    -,      ,  :    (  IDA —  )     x86.</p><br>
<p><strong></strong>,    — .     (  ,      *.exe  Windows),    ,    .     ,  ,      x86  (        x64 —    ).</p><br>
<p><strong></strong> —  ,       x86 (assembler language).</p><br>
<p><img src="https://habrastorage.org/webt/gr/k6/jk/grk6jk1e6xopgtwpvfjly_sugim.jpeg"></p><br>
<p>       ,      x86:  (<strong>mov</strong>, <strong>lea</strong>, <strong>push</strong>/<strong>pop</strong>, <strong>call</strong>, <strong>jmp</strong>,    ),     .    ,      , :</p><br>
<ul>
<li>,  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">.  2011</a> (  ,    90-);</li>
<li>  ,  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Guide to x86 Assembly</a>;</li>
<li>,      ,  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">A Guide To x86 Assembly</a>.</li>
</ul><br>
<p> ,    .       10 ,    .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>         ().</p><br>
<p><strong><em> .</em></strong> <em> ,       ,  ,     regexp ( ) —    ,     .    ,        .</em></p><br>
<p><strong></strong> — 30   (,  , 30 )   .</p><br>
<h2 id="0x20-minutka-filosofii-ili-chto-takoe-ida-pro-i-pochemu">0x20      IDA Pro  ?</h2><br>
<p><code>; {EN} Whatta hell? {EN}</code></p><br>
<p><img src="https://habrastorage.org/webt/ln/2x/ls/ln2xlsujoswxw2kkvd8chq_mjg0.jpeg"></p><br>
<blockquote>- (  ) — “     ,  -   … , - —  ( ),    ,    ,     ,  - ” — Reversing: Secrets of Reverse Engineering, Eldad Eilam.</blockquote><p>      ?   ,      . ,     IDA? IDA — ,    “ “.         “”.  ,           ,  -,      ,       ,      “  ”,       .          IDE —     ,   ,  —   ..     —                 .   IDA Pro      ,          .</p><br>
<p>   ,          <del>    </del>,           . -       ,     — radare2 (     r2,   Cutter   ,   IDA Pro).  , IDA Pro           Python  API  .</p><br>
<p> -,       ,   ,      100%            . ,    - ,    IDA Pro!      .</p><br>
<p><img src="https://habrastorage.org/webt/dh/u4/64/dhu4649l7k5lo8m3xgklfy9gcao.jpeg"></p><br>
<h2 id="0x30-smotrim-na-ida-pro-i-poznaem-osnovy-eyo-interfeysa">0x30   IDA Pro     </h2><br>
<pre><code class="plaintext hljs">; {EN}<font></font>
; This function is too complex.<font></font>
; Perhaps it interacts with user.<font></font>
; But currently I am not sure about it.<font></font>
; A lot of calls to Qt-framework.<font></font>
; {EN}</code></pre><br>
<h3 id="0x31-zagruzka-binarnika-v-ida-pro">0x31    IDA Pro</h3><br>
<p> IDA Pro.       (    ),    . ,   , —     .        “”.</p><br>
<p><img src="https://habrastorage.org/webt/we/ah/ie/weahierpwadwc3adccph1oxnxzs.png"><br>
<em>  IDA Pro   </em></p><br>
<p>   (     exe-  IDA,    )     , IDA Pro      (PE, portable execute),            , , ,    .</p><br>
<p>-    ,  , .         ,      -,  ,    ,     .</p><br>
<p>    ,              .     —  ,   .</p><br>
<p>    ,            “” (   -    ).          .    ,    .</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>,      (. ).      “” ,             - .</p><br>
<p><img src="https://habrastorage.org/webt/fe/f3/up/fef3upsfi7vt9kqnjhdb3bpjvcy.png"><br>
<em>     </em></p></div></div><br>
<h3 id="0x32-chto-nam-ida-pro-pokazala">0x32   IDA Pro ?</h3><br>
<p>   IDA Pro     :  ,  ,  — ,       .     IDA Pro (    ).     IDA Pro (      Python  C++).    IDA    Meta PC —  x86/x64,   ,       Intel  AMD.        ,      ,     IDA,      Portable Executable.         ,      ,    ,      (   ).  ,             (   loader-  IDA,   «»     ,     IDA    ).</p><br>
<p>      ,        :</p><br>
<ul>
<li>       (analyze);</li>
<li>       (emulate —    , , ,  QEMU);</li>
<li>     .</li>
</ul><br>
<p>      “”   IDA      ,    “”     .   ,           (          ), IDA     .</p><br>
<p> ,      ,     .     ,    ,    ,   IDA.</p><br>
<p>   ,  IDA Pro   .       “”   (, ,    ). IDA            (,    MongoDB)   .        .idb ( .i64).</p><br>
<p>     ,   ,  ,    .  ,       ,    .        <strong>AU: Idle</strong>     IDA Pro.</p><br>
<div class="spoiler"><b class="spoiler_title">UX/UI IDA Pro</b><div class="spoiler_text"><p>GUI IDA Pro   Qt, ,   -   ,   Qt,      :</p><br>
<ul>
<li> drag&amp;drop ;</li>
<li>    ,      .          ,    .</li>
</ul></div></div><br>
<p><img src="https://habrastorage.org/webt/cl/al/0o/clal0o6ags5zcvanu7grv5os6v0.png"><br>
<em>    <strong>main</strong></em></p><br>
<p>   ,     IDA Pro.</p><br>
<ul>
<li>   —    ( ,    -  ).     ,      .       .              (  —  ,  —  ).      ,        .</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">Proximity View</b><div class="spoiler_text"><p>    ,   Proximity View.        .</p></div></div><br>
<p><em> .   ,      ,       .</em></p><br>
<ul>
<li>  — ,    ,    .    ,        (  ).         ( gcc   <strong>-s</strong>)       <strong>-g</strong>,           ,   .  IDA Pro     <strong>sub_&lt;_ _&gt;</strong>;</li>
<li>  (<strong>Strings</strong>) —  ,   ,   <strong>SHIFT+F12</strong>.      IDA Pro —     ,    .      ,     .</li>
</ul><br>
<h3 id="0x33-trogaem-lapoy-ida-pro">0x33  “” IDA Pro</h3><br>
<p>-    ,    .          ?         , IDA Pro?  —   <del></del>  .      - ,               .</p><br>
<p><img src="https://habrastorage.org/webt/-g/fg/48/-gfg48wnj1tqk02smxzu0kbbyjk.png"></p><br>
<p>     IDA Pro       (-, cheatsheet)   .     -.    -     IDA Pro — Hexrays.  -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>,     , ,   ,      ,    - .</p><br>
<p><img src="https://habrastorage.org/webt/3g/wm/lb/3gwmlbsn8obbaqndh6xxt-z3cgm.png"></p><br>
<div class="spoiler"><b class="spoiler_title"> CTRL+S  CTRL+Z?</b><div class="spoiler_text"><p>   ,         .  —      (CTRL+W,      ),  — undo.  ,   undo —  .  -  ,     CTRL+Z.  ,   undo     7.3 ( — 7.0),      undo —    .   ,  -     IDA,  ,       . ,   (make code)       .</p></div></div><br>
<p> ,      ,         IDA Pro.     ,   -    " ",      .     ,  IDA Pro       .</p><br>
<p>       IDA Pro.</p><br>
<h4 id="0x33a-navigaciya-po-grafu-i-listingu">0x33a     </h4><br>
<p> —       , ,     IDA Pro,    :</p><br>
<ul>
<li>      ;</li>
<li>        ,     <strong>ESC</strong>      <strong>CTRL+ENTER</strong> (  - —  );</li>
<li>     — <strong>SPACE</strong>,        ();</li>
<li>   :       (  )   <strong>X</strong>.        ,      (     );</li>
<li>      (<strong>g</strong>):            (  0x)     IDA Pro —       (),    .</li>
</ul><br>
<h4 id="0x33b-imenovanie-i-zametki-na-polyah">0x33b     </h4><br>
<p>   ()      :</p><br>
<ul>
<li>  (          <strong>N</strong>): ,  (  ),   .  ,   ,   .</li>
<li>   .    :  ,     ,   <code>;</code>.</li>
</ul><br>
<h4 id="0x33c-predstavlenie-dannyh-data-representation">0x33c   (data representation)</h4><br>
<p>         : </p><br>
<ul>
<li> (<strong>byte</strong>);</li>
<li> (<strong>word</strong>);</li>
<li>  (<strong>dword</strong>);</li>
<li> (<strong>offset</strong>);</li>
<li> (<strong>undefined</strong>);</li>
<li>  (<strong>code</strong>).</li>
</ul><br>
<p> ,       ,   —  ,    (,   ..).  ,      (    ),    IDA Pro  <strong>undefined</strong>.  ,          ,       . ,        (   ),    ,   IDA Pro.</p><br>
<h4 id="0x33d-otlichie-koda-ot-funkcii">0x33d    </h4><br>
<p>     : </p><br>
<ul>
<li>   (   IDA Pro    );</li>
<li> (    ,   <strong>P</strong>).<br>
        IDA Pro  ,    .  ?   ,         (<strong>call</strong>),     ,  ,      , —   . </li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">  ,     </b><div class="spoiler_text"><p>            - ,     IDA Pro    ,     , IDA Pro       .    ,     <strong>call</strong>,     ,   "" <strong>call</strong>      .  , - ,    ,   ,    —  .</p></div></div><br>
<h4 id="0x33e-predstavlenie-argumentov-instrukciy">0x33e   </h4><br>
<p>         ,        . ,       <code>mov eax, 0xFFFFFFFF</code>     ,    ,   <code>mov eax, -1</code>.  ,      ,       ,  IDA Pro    . </p><br>
<h4 id="0x33f-vspomogatelnye-okna-ida-pro">0x33f   IDA Pro</h4><br>
<p>       <strong>Strings</strong>, <strong>Names</strong>, <strong>Functions</strong>, <strong>Hex Dump</strong>.          <code>View-&gt;Open Subviews</code>.</p><br>
<h2 id="0x40-vsego-tak-mnogo-i-kak-s-etim-rabotat">0x40        ?</h2><br>
<pre><code class="plaintext hljs">; {EN}<font></font>
; I think I found actual protocol parsing in function sub_401D3C<font></font>
;<font></font>
; But this function just chases bytes from corner to corner<font></font>
; before actual parsing... we need to go deeper<font></font>
; {EN}</code></pre><br>
<h3 id="0x41-chto-zhe-my-budem-delat">0x41     ?</h3><br>
<p>,             " "  IDA Pro,           ,         .</p><br>
<p>       ,  ,  IDA      76 ,      .   ,   ,      .       «»      100% (         ).      :</p><br>
<ul>
<li>   .       ,     ;</li>
<li>   , , ,   API;</li>
<li>       (,     );</li>
<li>- ...</li>
</ul><br>
<p> ,  ,    , —     .  ,       ,      .   ,       ,    .</p><br>
<h3 id="0x42-igolka-v-stoge-bayt">0x42    </h3><br>
<pre><code class="plaintext hljs">; {RU}<font></font>
;     ;<font></font>
;    ;<font></font>
;   ,     ( .1-3);<font></font>
; {RU}</code></pre><br>
<p>      ?   ,    ,      API  OpenSource-,        "doxygen":          API  .</p><br>
<div class="spoiler"><b class="spoiler_title">    doxygen?</b><div class="spoiler_text"><p>   doxygen —  . ,    ,            .  , ,  , —  HTML        ( ).</p></div></div><br>
<p>  ,   TCP/IP-,  ,    “”    <strong>recv</strong>,         . , <strong>recvfrom</strong>,  API    —   ( Linux — <strong>read</strong>).</p><br>
<p><em><strong></strong>:   /      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Socket programming in c using TCP/IP</a>.</em></p><br>
<p><img src="https://habrastorage.org/webt/ud/r5/8u/udr58uxngkb0ntarrlf9hrawoy4.png"></p><br>
<p>    IDA Pro?     <strong></strong>  (   ,       ).      SHIFT+F4.       (Names).</p><br>
<p>      ,   (  ,            ).  ,   , ,     ,    CTRL+F.        (   ).       ,     (     recv),  ,       ,       (   ).</p><br>
<p>      .             ( ENTER).</p><br>
<p><em><strong></strong>:         ESC.</em></p><br>
<p><img src="https://habrastorage.org/webt/8n/xq/uf/8nxqufiule2e6aphjdiiosshshi.png"><br>
<em>   </em></p><br>
<p>      .      recv (,  recv    —  ,       ).</p><br>
<p>       ,      recv.      IDA Pro        (    )   .   ,   ,      ( ),       ,    <strong>X</strong>.     ,    .        .    type   :</p><br>
<ul>
<li><strong>p</strong>[rocedure] —   “ ”,    ()    <strong>call</strong>;</li>
<li><strong>r</strong>[ead] —    ;          ();</li>
<li><strong>w</strong>[rite] —    ;          ().</li>
</ul><br>
<p>     : </p><br>
<ol>
<li>   <strong>recv</strong>   ( <strong>r</strong>), </li>
<li>  <strong>recv</strong> ( <strong>p</strong>).<br>
 ,       recv    .     :</li>
</ol><br>
<pre><code class="plaintext hljs">push    0<font></font>
push    1000h   ; len<font></font>
push    ebx     ; buf<font></font>
push    edi     ; s<font></font>
call    esi     ; recv   &lt;----   recv </code></pre><br>
<p>    ,  <strong>call</strong>       <strong>esi</strong>.     IDA ,       <strong>esi</strong>,   ,    <strong>call</strong>   <strong>esi</strong>    <strong>recv</strong>.   IDA     <strong>recv</strong>   .</p><br>
<p><img src="https://habrastorage.org/webt/6d/1w/37/6d1w370mx79d5zmogje5t5tazrk.png"><br>
<em>   <strong>recv</strong></em></p><br>
<p>      <strong>p</strong>,  IDA     ( ),     <strong>recv</strong>.    —  IDA.    ,  <strong>recv</strong>: <strong>sub_401D3C</strong>.</p><br>
<p>? .   .     ,    ,   <strong>recv</strong>   ,      -   ,      (    —  ).</p><br>
<h3 id="0x43-delaem-zametki-na-polyah-sub_401d3c">0x43  “  ”: sub_401D3C</h3><br>
<p><code>; {EN} x_vserv_protocol {EN}</code></p><br>
<div class="spoiler"><b class="spoiler_title">  x_?</b><div class="spoiler_text"><p>      <strong>x_</strong>    (  eXecutable),         IDA Pro.<br>
<strong>ax_</strong> —     (IDAPython);<br>
<strong>v_</strong> —    (  Variable);<br>
<strong>av_</strong> — ,    (IDAPython).</p></div></div><br>
<p> <strong>sub_401D3C</strong>    <strong>recv</strong>    .   ,      «».</p><br>
<p><em><strong></strong>:         :    .  ,         (  ),  —      .</em></p><br>
<p>          (. «debug» — )      ,    . , -,       : --         . -,   -    ,   ,     </p><br>
<p> ,    ,     ,  ,    ,          .     ,    ,  ,      ,   ,    ,    ,   .</p><br>
<p><img src="https://habrastorage.org/webt/zg/zi/qk/zgziqkawpljptoqlgi2du93vaii.png"><br>
<em>   <strong>recv</strong></em></p><br>
<p>  “  ”.     <strong>sub_401D3C</strong>,    ,          : <strong>sub_401CF0</strong>  <strong>sub_401BFD</strong>.  ,      puts —     libc.        (stdout).   -   , ,    ,     - !</p><br>
<p><img src="https://habrastorage.org/webt/uj/uk/7t/ujuk7td6k0bfdtiisxf_lnenfx8.png"></p><br>
<p><em><strong></strong>:            recv.  “ ”  .        Strings (<strong>SHIFT+F12</strong>)       ,             ,    -      -.       ,    .</em></p><br>
<p>     ,   ,     puts.     <em>0x00401D64</em> (    ,    <strong>g</strong>      )    “Received failed",     <em>0x00401D7A</em> — "Client disconnected",    <em>0x00401D9C</em> — “VSERV protocol error…”.       ,       VSERV (       ).        :</p><br>
<ul>
<li><em>0x00401D76</em>  RECV_SUCCESS;</li>
<li><em>0x00401D8C</em>  CLIENT_NOT_DISCONNECTED.</li>
</ul><br>
<p><em><strong></strong>:       -.             ,    , —  .  ,      ,    ,   ,      ,   -    .          .        : “ ”, ,   .</em></p><br>
<p><img src="https://habrastorage.org/webt/a3/sm/ji/a3smji-z1irduackgnndpluxdm4.png"></p><br>
<p> ,   <em>0x00401D54</em> —  ,     “”     .     “RECV_LOOP”.   IDA Pro      :      ( )   ( )  .</p><br>
<p>       <em>0x00401D3C</em>,    , , , <strong>x_vserv_protocol</strong>. ,        ,      —       ,    (    TCP  “”).  ,     <strong>x_vserv_protocol</strong>,    ,      <strong>sub_401CF0</strong>  <strong>sub_401BFD</strong>,               (    ESC).</p><br>
<p><img src="https://habrastorage.org/webt/jz/ty/aw/jztyawfpvn1ydci0xp5jemcbsay.png"><br>
<em>      </em></p><br>
<h3 id="0x44-delaem-zametki-na-polyah-sub_401cf0">0x44  “  ”: sub_401CF0</h3><br>
<pre><code class="plaintext hljs">; {EN} x_vserv_parse_header {EN}</code></pre><br>
<p>, ,  <strong>sub_401CF0</strong>,        .    ,      ,          <strong>sub_401CF0</strong>.        .       (    ),    ,   :</p><br>
<ul>
<li>      (,  ,    <strong>recv</strong>   TCP-);</li>
<li>       (<strong>if-else</strong>);</li>
<li>    <strong>memcmp</strong>  <strong>atoi</strong>;</li>
<li>     <em>0xFFFFFFFF</em> (-1)   ;</li>
<li>    .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/vm/x8/r-/vmx8r-chhl9nhifxb371kn2hon0.png"><br>
_  <strong>sub_401CF0</strong>   <strong>x_vserv_parse_header</strong>_</p><br>
<p>  ,   .</p><br>
<h4 id="0x44a-odin-argument-i-ego-naznachenie-v-funkcii-sub_401cf0">0x44a        sub_401CF0</h4><br>
<p> IDA    (  ,     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">calling convention</a> (  )    ,   ).     ,     ( x86     <strong>cdecl</strong>,    ,   ),      IDA Pro     <strong>arg_</strong>.</p><br>
<p><em><strong></strong>:                  (calling convention).    ,       (   ,      ). ,     , — x86-    (   <strong>push</strong>),      <strong>eax</strong> (,      <strong>return</strong>).</em></p><br>
<p> .       <strong>packet_buffer</strong>?    ,    ,    ,      .          <strong>x_vserv_protocol</strong>.        <strong>ebx</strong>.    <strong>ebx</strong> , IDA    ,          .      <strong>recv</strong> (,   )   (,             « »).</p><br>
<p><img src="https://habrastorage.org/webt/gi/ld/gz/gildgz52x_djy8xuynbgj--0xpa.png"><br>
_  <strong>x_vserv_parse_header</strong>_</p><br>
<p>  ( ,     <strong>recv</strong>)    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  recv</a>.    ,    —  ,   <strong>recv</strong>   . ,  ,     <strong>sub_401CF0</strong>        TCP- .</p><br>
<h4 id="0x44b-funkciya-sub_401cf0-ne-imeet-ciklov-i-soderzhit-odno-vetvlenie">0x44b  sub_401CF0       </h4><br>
<p>,   IDA Pro  ,        (     ).      <strong>sub_401CF0</strong>   ,   <strong>sub_401CF0</strong>  .</p><br>
<p>,   ,         IDA Pro ,       <strong>if-else</strong>   .    :</p><br>
<ul>
<li> —   ,    ;</li>
<li> —  .</li>
</ul><br>
<p> ,   ,    .    <strong>sub_401CF0</strong>    ,     ,      .</p><br>
<p><strong></strong>:   <strong>if-else</strong>       ( ):</p><br>
<ol>
<li>  (    );</li>
<li>     .</li>
</ol><br>
<h4 id="0x44c-funkciya-sub_401cf0-vyzyvaet-dve-bibliotechnye-memcmp-i-atoi">0x44c  sub_401CF0    memcmp  atoi</h4><br>
<p>         ,   ,       ,    .   API-         ,       ,    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">,     memcmp</a>.</p><br>
<p><em> :  “fear … leads to suffering”, -,    ,    ,       ,     reboot.   ,        ,      ,   .        .       reboot,   : «or enables/disables the reboot keystroke».  «»    F8,    reboot,  ,    ,   … RTFM!</em></p><br>
<p>   ,  <strong>memcmp</strong>               ,   «» .     ,         ,       . ,  0 —  ,  1 —  .         0,    ,   &gt; 0,  &lt; 0.</p><br>
<p> API- <strong>atoi</strong>  ,   ascii-,  integer. ,      ,    —  .</p><br>
<h4 id="0x44d-sobiraem-vsyo-vmeste-i-otvechaem-na-dva-ostavshihsya-voprosa">0x44d         </h4><br>
<p>         API-   ?</p><br>
<p>-, <strong>memcmp</strong>    (  ,  «»,       ).       ,    <strong>memcmp</strong>       (   ),   "VMES"   4 (  <strong>VMES</strong>).  ,    ,     ,    <strong>eax</strong>   <em>0xFFFFFFFF</em> (-1),     <strong>atoi</strong>.</p><br>
<p>     <strong>memcmp</strong>,   <strong>strcmp</strong>,     , - ,      , 4 .  <strong>strcmp</strong>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-</a>.    "VMES" -  ,  ,    — -    . - ,         , <strong>strcmp</strong>     .</p><br>
<p>-, <strong>atoi</strong>,  ,   - (          ).     ,  <strong>atoi</strong>       —     <strong>VMES</strong> (  ,        <em>0x00401D19</em>) —     .   atoi   eax.  ,  <strong>eax</strong>       ,    ,  -1.  ,       x86       <strong>eax</strong>,        ,       —  -1,            .    ,      ? ,   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> tmp[<span class="hljs-number">5</span>] = { <span class="hljs-number">0</span> };
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(&amp;buf[<span class="hljs-number">0</span>], <span class="hljs-string">"VMES"</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
*(<span class="hljs-keyword">int</span>*) tmp = *(<span class="hljs-keyword">int</span>*)(&amp;buf[<span class="hljs-number">4</span>]);
<span class="hljs-keyword">return</span> atoi(tmp);</code></pre><br>
<p>     .    , :    5 ?    ?      <strong>atoi(buf + 4)</strong>?             <strong>atoi</strong>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  strtol</a> (    <strong>atoi</strong>,     <strong>strtol</strong>     10).   ,   ,     ,       .  ,  10-         0  9.      ,  ,  <em></em>     ,        ,      - .    (  )   .  :      -      ascii-. </p><br>
<p>   5   ,      (      ):       <strong>buffer_length</strong>   <strong>var_D</strong> (       ).    0    ,       .  <strong>var_D</strong>   -. </p><br>
<p>        <strong>x_vserv_parse_header</strong> (    ).</p><br>
<h3 id="0x45-delaem-zametki-na-polyah-sub_401bfd">0x45  “  ”: sub_401BFD</h3><br>
<pre><code class="plaintext hljs">; {EN} x_vserv_parse_body {EN}</code></pre><br>
<h4 id="0x45a-nemnogo-o-steke-i-ego-kadre">0x45a      </h4><br>
<p>,      ,    «»   ,     .      ,     .     <strong>x_vserv_protocol</strong>,      <strong>PARSE_BODY</strong> ( ,  ,   <strong>g</strong>,       <strong>ENTER</strong>).        push, , ,       <strong>sub_401BFD</strong> (      <strong>x_vserv_protocol_body</strong>).      ,  . </p><br>
<p><img src="https://habrastorage.org/webt/-3/68/su/-368su8_4xhsb5wod7jfyxayesi.png"><br>
_  <strong>body_buffer</strong>?_</p><br>
<p>    (    <strong>lea</strong>)   (   <strong>body_buffer</strong>).   — ,      <strong>x_vserv_protocol_header</strong> (   eax    <strong>push</strong>  ).       —   <strong>atoi</strong>-,     .</p><br>
<p> ,   <strong>body_buffer</strong>,      :</p><br>
<ul>
<li>     ,    <strong>recv</strong>;</li>
<li>   <strong>x_vserv_protocol</strong>.</li>
</ul><br>
<p>  ,   <strong>recv</strong>,   .      <strong>recv</strong> , ,      <strong>ebx</strong>    <strong>recv</strong> (.  <strong>RECV_LOOP</strong>).    <strong>ebx</strong>  ,       ,  ,     <strong>esp</strong>.  <strong>esp</strong>    (   ) ,        ,  ,    <strong>push</strong>/<strong>pop</strong>.      <strong>esp</strong>    ,      :</p><br>
<p><code>char buffer[0x1000];</code></p><br>
<p><em><strong></strong>:  ?  ,    ,    ,     ,     .  ,              ,           .      Wikipedia.</em></p><br>
<p>   (  )  <strong>x_vserv_protocol</strong>.      IDA Pro         ,    (  — «»     ).     ,    .</p><br>
<p><img src="https://habrastorage.org/webt/ye/_q/bp/ye_qbpsfafr80erlvdrogs38yge.png"><br>
<em>  </em></p><br>
<p>   ,      <strong>recv</strong>      (  esp   ).       (  —  <strong>N</strong>)   <strong>vmes_sign</strong> (      "VMES").</p><br>
<p>   —  ,    <strong>atoi</strong>   <strong>x_vserv_parse_header</strong>.      ,         <strong>x_vserv_parse_header</strong> ( <em>0x00401D19</em>).  <strong>mov</strong>      <strong>[ebx+4]</strong>   <strong>eax</strong>     <strong>atoi</strong>.   ,     ,    <strong>vmes_body_len</strong>.</p><br>
<p>  ,          TCP-.    - ,  ,     —  ,    (),  ,   ,    <strong>x_vserv_parse_header</strong>. ,           <strong>x_vserv_parse_body</strong>.</p><br>
<h4 id="0x45b-razbiraem-funkciyu-razbora-tela-paketa">0x45b     </h4><br>
<p>     ( <strong>ESC</strong>)    .     <strong>sub_401BFD</strong> (<strong>x_vserv_protocol_body</strong> —   ) —  , ,   TCP-   <strong>recv</strong>,     (  ,   —  ).   – ,    +4    (,   )  «»  <strong>atoi</strong>,     .</p><br>
<p><em><strong></strong>:  -   Stack BOF (  Stack Buffer Overflow,      )   ,            .     ,    .      ,   .</em></p><br>
<p>      <strong>x_vserv_protocol_body</strong>,      .</p><br>
<p><img src="https://habrastorage.org/webt/hu/ya/ak/huyaaknpousidzdxvrlwnpcmbgm.png"><br>
_  <strong>x_vserv_protocol_body</strong>_</p><br>
<p>     -     «»     ,        <strong>if-else-if-else-if-else</strong> (,   <strong>switch</strong>).  ,     ,   ,               “HEXDUMP”, “TALK2ME”, “B64DECO”, “DISCONN”, “STOP!!!”.      ,      «Unknown command».  , ,     —  .          .     : <strong>x_vserv_hexdump</strong>, <strong>x_vserv_talk2me</strong>, <strong>x_vserv_b64deco</strong>, <strong>x_vserv_disconn</strong>, <strong>x_vserv_stop</strong>.      .</p><br>
<h4 id="0x45c-poschupaem-nekotorye-obrabotchiki-komand-vserv">0x45c     vserv</h4><br>
<p> ,  ,    ,       ,        .  ,      ,    ,         15  (      ).  - ,   ,   <strong>len</strong>,   ,    ,      <strong>x_vserv_hexdump</strong>.        .</p><br>
<p><img src="https://habrastorage.org/webt/2s/bd/7s/2sbd7shspnys599lncmtu8r_9ea.png"><br>
_  <strong>x_vserv_hexdump</strong>_</p><br>
<p>   ,      ,    ebp (,      ,  ebp     ).     ,   ,     ,  ,      ,      .</p><br>
<h3 id="0x45d-zakruglyaemsya-na-segodnya">0x45d   </h3><br>
<p><img src="https://habrastorage.org/webt/pd/4k/6m/pd4k6m-ucpwhyizp5gfvngk32em.png"></p><br>
<h2 id="0x50-is-this-the-end">0x50 Is this the end?</h2><br>
<pre><code class="plaintext hljs">; {EN} x_vserv_parse_body {EN}</code></pre><br>
<p>   ,       -,             . ,     ,    ,          ,     IDA Pro.</p><br>
<p>      9-   -,       <strong>VSERV</strong>  IDA Pro,            RCE (      )   .</p><br>
<p><img src="https://habrastorage.org/webt/0o/wi/35/0owi35rcyborkmvkyhuhkqbmlco.png"></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493402/index.html">Rostelecom广告横幅以及如何处理</a></li>
<li><a href="../zh-CN493404/index.html">如何找到艺术家来开发网站</a></li>
<li><a href="../zh-CN493406/index.html">磁盘子系统在OpenNebula中的工作方式</a></li>
<li><a href="../zh-CN493408/index.html">DJI Mavic迷你直升飞机像撬棍一样掉落</a></li>
<li><a href="../zh-CN493412/index.html">在ESP32上使用Wifi玩游戏</a></li>
<li><a href="../zh-CN493418/index.html">为什么机器学习使用“合成”数据</a></li>
<li><a href="../zh-CN493420/index.html">向初中生介绍Python的方式</a></li>
<li><a href="../zh-CN493424/index.html">我们实现Python代码转换</a></li>
<li><a href="../zh-CN493426/index.html">微服务中的代码组织以及我使用六角形体系结构和DDD的方法</a></li>
<li><a href="../zh-CN493428/index.html">“我们不会产生阴谋论。” 与来自科学和IT公司的人讨论ML会议</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>