<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃🏾 🤹 🕒 embeddのマスクされたバグ 🥉 👨🏿 👨🏾‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ソフトウェアを開発する場合、プラグは避けられません。埋め込みでは、彼らの寛大な5つのコペックもハードウェアの問題を引き起こす可能性がありますが、これは別の曲です。しかし、純粋にプログラムされた待ち伏せ、一見空っぽな場所で立ち往生するとき...私にはそれらの3種類があります。
 
 最も簡単な方法は、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>embeddのマスクされたバグ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453944/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソフトウェアを開発する場合、プラグは避けられません。埋め込みでは、彼らの寛大な5つのコペックもハードウェアの問題を引き起こす可能性がありますが、これは別の曲です。しかし、純粋にプログラムされた待ち伏せ、一見空っぽな場所で立ち往生するとき...私にはそれらの3種類があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も簡単な方法は、マニュアル、標準、または、たとえば、ironのライブラリーを構成する手順が完全に理解されていない場合です。それはここで明らかです：すべての動きが使い果たされたわけではなく、忍耐と作業、さらに5、2回の実験があり、それは実現します。オシロスコープと科学のtykが役立ちます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uy/nn/ia/uynniacpwibqxoyroe7zgfjijjy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CANバスを構成するための分周器の選択</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
問題がロジックのタイプミスまたはミスである場合、目とステップバイステップのデバッグでこの場所を20回歩くまでポイントブランクが表示されないのはさらに悪いことです。それから、それは夜明け、額への激しい音、叫び、「まあ、あなたは一種のババイ！」、編集中です。動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、悲観的な3番目のビュー：外国の図書館に定着してグリッチが鉄のジャンクションで這い出て行くグリッチ。</font><font style="vertical-align: inherit;">シェークスピアの情熱は、モニターの安定した光を生み出します。</font><font style="vertical-align: inherit;">「それができないので、システムがこのように動作することはできません。</font><font style="vertical-align: inherit;">まあ、本当に！</font><font style="vertical-align: inherit;">そして？！" </font><font style="vertical-align: inherit;">いいえ。</font><font style="vertical-align: inherit;">受け取り、署名します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局、現実は</font><font style="vertical-align: inherit;">予想よりも広い</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shirshov </font></font></s> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shiree</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">いくつかの例：</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史第1号 </font><font style="vertical-align: inherit;">MicroSDフラッシュドライブとDMA作業</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既往</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカードのファイルにデータをダンプする必要があります。</font><font style="vertical-align: inherit;">もちろん、自分でファイルシステムとSDIOドライバーを作成する時間も欲しもないので、完成したライブラリーを持ちます。</font><font style="vertical-align: inherit;">私はそれを鉄に設定しました、そしてすべてがうまくいきます。</font><font style="vertical-align: inherit;">最初は。</font><font style="vertical-align: inherit;">そして、データは乱暴に書き込まれていることがわかります。ボリュームは正確ですが、ファイル自体では、バイトの個別のペアが複製され、規則性を失うことなく消えます。</font><font style="vertical-align: inherit;">良くない！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験が始まります。</font><font style="vertical-align: inherit;">私はテストデータを書き込んでいます-すべて問題ありません。</font><font style="vertical-align: inherit;">私は戦闘を書いています-ある種の悪魔。</font><font style="vertical-align: inherit;">データバッファーのサイズ、それらのダンプの頻度を変更します。データテンプレートは役に立ちません。</font><font style="vertical-align: inherit;">バッファ自体では、すべてが常に優れており、メモリ内のデータは必要な場所にあります。</font><font style="vertical-align: inherit;">そして、それにもかかわらず、フラッシュドライブの不具合-ここにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
犬を掘るのに数日かかりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">診断</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、ライブラリと</font></font><abbr title="ダイレクトメモリアクセス。 RAMから周辺機器へのデータ転送、またはプロセッサの関与なしのデータ転送。"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMA</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機器の相互作用にありました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカードには、512バイトのブロックでのみ書き込まれるという特異点があります。これを行うために、ライブラリーはデータを512バイトの配列にバッファーし、データがいっぱいになると、そこからDMA経由でフラッシュにフラッシュします。だが！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;512xN +ライブラリバッファーの空きスペース&gt;バイトより大きいフラグメントをレコードに転送すると、ライブラリは（明らかに、メモリを前後に移動しないように）これを行います：バッファーを補充し、フラッシュに書き込みます、そして次の512xNバイトが私のバッファからDMAに直接スローされます！まあ、何かが未完成のままになっている場合-次回まで、それは再びそれ自体にコピーされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すべてがうまくいくでしょうが、DMAコントローラは、データが4バイト境界で整列されたメモリに配置されることを要求します。</font><font style="vertical-align: inherit;">ライブラリー・バッファーは常にそのように調整されており、言語はこれを保証しています。</font><font style="vertical-align: inherit;">しかし、どのアドレスで、データの一部をコピーした後、小さいバイトで512xNの残りが私から始まります-神は知っています。</font><font style="vertical-align: inherit;">ライブラリはこれをまったくチェックしません。アドレスはそのままDMAコントローラに渡されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「彼らは不器用なものを送りました...彼と一緒に犬を。」</font><font style="vertical-align: inherit;">コントローラは送信されたアドレスの下位2ビットを警告なしにリセットします。</font><font style="vertical-align: inherit;">そして、転送を開始します。</font></font><br>
<img src="https://habrastorage.org/webt/cj/vt/eg/cjvtegekkqclanfzdkv8v0xhfsy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は4の倍数ではないアドレスが倍数に置き換えられます-ほら、ライブラリバッファーの最後の3バイトまでは私のファイルに書き直され、私のバッファーからの同じバイト数はトレースなしで失われます。</font><font style="vertical-align: inherit;">その結果、データの総量は正しく、操作はスムーズに進みますが、ディスクは無意味です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハードウェアのレコーディング機能を呼び出す直前に、別のバッファーを追加する必要がありました。</font><font style="vertical-align: inherit;">書き込みアドレスが4の倍数でない場合、データは最初にそこにコピーされます。</font><font style="vertical-align: inherit;">同時に、バッファーサイズを適切に選択したため、平均速度が向上しました。</font><font style="vertical-align: inherit;">もちろん、それはメモリを必要としましたが、あなたが自由に使えるとき、良い行為のために4キロバイトは何ですか-無限の192！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">歴史第2号 </font><font style="vertical-align: inherit;">ランタイムと束</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロローグ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の変更後、プログラムは落ち始め、どういうわけかそれは非常に激しく落ち、プロセッサーを</font></font><abbr title="重大な障害。 何か実際に問題が発生した後のプロセッサの状態。たとえば、ハードウェア割り込みが発生し、プロセッサが対応するハンドラー関数のアドレスを読み取れなかった。"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハードフォールト</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラーに投入しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、彼は、開始直後に、実行がmain（）に到達する前でさえ、それをそこに投げました。つまり、私のコードの1行も実行する時間がありませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一印象は「ビーバーは死んでいる、チップは交換用だ」というものだ。</font><font style="vertical-align: inherit;">そして、プログラマーはオークを与えました。</font><font style="vertical-align: inherit;">しかし、いいえ、古いバージョンのファームウェアは安定して動作しますが、新しいバージョンは、起動と私のコードの間のあいまいなアセンブリの深さで着実に落ちます。</font><font style="vertical-align: inherit;">私はこれがどんな異端であるかを想定していませんでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1章</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターネットが少なくともいくつかの追加情報を取得する方法を監視するのに役立ちました。</font><font style="vertical-align: inherit;">ハードデフォルトの結果を解析する手順はグーグルでした：レジスターの状態、スタックのダンプ。</font><font style="vertical-align: inherit;">ドピリル。</font><font style="vertical-align: inherit;">それを使用しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バスの操作エラーでクラッシュすることがわかりました。</font><font style="vertical-align: inherit;">私はこれが再び不均衡なアクセスであると判断しました-最初のストーリーと同じタイプの問題ですが、異なる観点からです。</font><font style="vertical-align: inherit;">しかし、最も反対はエラーが発生した場所です。</font><font style="vertical-align: inherit;">そしてそれはランタイムライブラリ内、つまり理論的には晴れた日の猫のあざのようになめられたコード内で発生しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析を続けると、グリッチはローカルの静的変数を初期化しようとした結果であることがわかりました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">叙情的な余談</font></font></b><div class="spoiler_text">,   ,      ,    ,    ,   :   ,        2   . ,        , ,         ,   ,   . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  ,   ++11.</a>  ?  — .</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2章</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランタイムが変数の構築に従事したら、プログラムの完了時にデストラクタを呼び出すことも必要です（プログラムが実際に作業を完了しない場合でも、これはマイクロコントローラーの絶対的な規範です）。これを行うには、初期化に成功したすべての変数に関する情報をどこかに保存する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そういう情報がなんらかの内部リストに保存されている場所で、ランタイムが落ちました。メモリがこのリストの要素に割り当てられ、標準に従って</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、少なくとも8バイトの境界に沿って</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置されることが保証されているブロックを生成するmalloc（）関数は</font><font style="vertical-align: inherit;">、n番目の数の呼び出しが成功した後、この境界に配置されていないピースを生成します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sx/0c/bw/sx0cbwlau__vlj2kwrdznxmehew.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいファームウェアコードの変更により、mallocが壊れました！</font><font style="vertical-align: inherit;">しかし、これはどのようにして可能でしょうか？</font><font style="vertical-align: inherit;">私はmallocを正確に再定義しなかった;私自身は他のどこにもそれを必要としない！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラオプションで、いくつかのキーワードやヘルプを探すのに役立ちますが、どこにでも明確に述べられています</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。malloc（）は、基本的な境界に沿って配置されたメモリの出力を保証します。</font><font style="vertical-align: inherit;">または、十分なメモリがない場合はnullポインタ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3章</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長い間、コードを無意味に突き刺し、ブレークポイントを設定し、苦しみ、何も理解していませんでした。ある時点でそれを突くことができず、mallocによって返されたアドレスを注意深く調べました。これ以前は、全体の分析では、アドレスの最後の桁が0x4かどうかを確認していました。そして今度は、mallocの連続呼び出しによって発行された他の各アドレスを完全に比較し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ああ、奇跡！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功したすべての呼び出しは、RAM空間（この石では0x20000000以前）からアドレスを発行し、呼び出しごとに順次増加しました。そして、最初に失敗したものは0x00000036を返しました。つまり、アドレスはアライメントされていないだけでなく、RAMのアドレス空間にもまったくありませんでした。プロセッサーはそこで何かを書き込もうとしたが、自然に落ちた。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして驚くべきことに、malloc（）が標準に従って動作し、十分なスペースがない場合に0を返したとしても、プログラムのクラッシュという意味ではこれは何も変更しません（バグの原因が以前に明らかにされていなかった場合）。</font><font style="vertical-align: inherit;">mallocによって返された値はまだチェックされていませんが、すぐに実行されます。</font><font style="vertical-align: inherit;">これは実行時です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エピローグ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定ファイルのヒープサイズを増やし、すべて修正されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、その前は、そのボリュームについてさえ考えていませんでした。</font><font style="vertical-align: inherit;">地獄が私に降伏したかどうか、私は思いました。</font><font style="vertical-align: inherit;">とにかく、私はすべての変数とオブジェクトを静的またはスタックに持っています。</font><font style="vertical-align: inherit;">したがって、ヒープの下にあるボリュームがすべてのテンプレートプロジェクトに割り当てられているため、慣性によって、0x300バイトを残しました。</font><font style="vertical-align: inherit;">しかし、いいえ、C ++ランタイムには動的に割り当てられたメモリが必要であり、コントローラの標準ではかなりの量が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生活し、学びます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453930/index.html">データ移行システムの比較と選択</a></li>
<li><a href="../ja453932/index.html">一枚岩を守る言葉</a></li>
<li><a href="../ja453934/index.html">仕事を始める前に話し合う11の質問</a></li>
<li><a href="../ja453938/index.html">NB-IoT盗難自転車追跡</a></li>
<li><a href="../ja453942/index.html">PMI Codexの例による倫理について</a></li>
<li><a href="../ja453950/index.html">あなたはここにいるはずです！伝説のゲームDuke Nukem 3Dのリリースから22年</a></li>
<li><a href="../ja453952/index.html">「要求は成熟しました」：分散システムに関する新しい会議についてのAlexey Fedorov</a></li>
<li><a href="../ja453956/index.html">ミュージアムデータアート。ビデオ端子ADM-3A。車は重く、信頼でき、虐殺されています</a></li>
<li><a href="../ja453958/index.html">単一リポジトリ：ください</a></li>
<li><a href="../ja453960/index.html">モスクワでのグローバルDevOps Bootcamp 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>