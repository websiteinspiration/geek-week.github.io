<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêú üë®üèº‚Äçü§ù‚Äçüë®üèª ‚ù§Ô∏è Uma vez em um pentest, ou Como quebrar tudo com a ajuda de um urologista e Roskomnadzor üë®üèø‚Äç‚öñÔ∏è ü§∑üèª üìè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo √© baseado em um testemunho de muito sucesso, realizado por especialistas do Grupo-IB h√° alguns anos: aconteceu uma hist√≥ria que afirma ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Uma vez em um pentest, ou Como quebrar tudo com a ajuda de um urologista e Roskomnadzor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo √© baseado em um testemunho de muito sucesso, realizado por especialistas do Grupo-IB h√° alguns anos: aconteceu uma hist√≥ria que afirma ser uma adapta√ß√£o cinematogr√°fica em Bollywood. Agora, provavelmente, a rea√ß√£o do leitor se seguir√°: "Ah, outro artigo de RP, mais uma vez, eles s√£o desenhados, qu√£o bons s√£o, n√£o se esque√ßa de comprar um penteado". Bem, por um lado, √©. No entanto, existem v√°rias raz√µes pelas quais este artigo apareceu. Eu queria mostrar o que exatamente os pentesters est√£o fazendo, o qu√£o interessante e n√£o trivial esse trabalho pode ser, quais circunst√¢ncias divertidas podem se desenvolver nos projetos e, o mais importante, mostrar o material ao vivo com exemplos reais.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para restaurar o equil√≠brio da mod√©stia no mundo, depois de um tempo escreveremos sobre o pentest, que n√£o foi. </font><font style="vertical-align: inherit;">Mostramos como processos bem estabelecidos em uma empresa podem proteger contra toda uma gama de ataques, mesmo que bem preparados, simplesmente porque esses processos existem e realmente funcionam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cliente deste artigo tamb√©m estava bem em geral, pelo menos melhor que 95% do mercado na Federa√ß√£o Russa, de acordo com nossos sentimentos, mas havia v√°rias nuances menores que formaram uma longa cadeia de eventos, o que levou a um longo relat√≥rio sobre o trabalho. e depois para este artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, estoca pipoca e bem-vindo ao detetive. </font><font style="vertical-align: inherit;">Estou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dando a palavra a Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Diretor T√©cnico do Grupo de Auditoria e Consultoria-IB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1. M√©dico de Pochkin </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018 ano. Existe um cliente - uma empresa de TI de alta tecnologia, que por si s√≥ atende muitos clientes. Ele deseja obter uma resposta para a pergunta: √© poss√≠vel, sem nenhum conhecimento e acesso inicial, trabalhando atrav√©s da Internet, obter direitos de administrador para um dom√≠nio do Active Directory? Nenhuma engenharia social √© de interesse ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eh, mas em v√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), elas n√£o interferem especificamente no trabalho, mas podem recarregar acidentalmente um servidor de trabalho estranho, por exemplo. Uma tarefa adicional √© identificar o maior n√∫mero poss√≠vel de vetores de ataque em rela√ß√£o ao per√≠metro externo. A empresa realiza regularmente esses testes, e agora o prazo para um novo teste. As condi√ß√µes s√£o quase t√≠picas, adequadas, compreens√≠veis. Descer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe um nome de cliente - seja "Empresa", com o site principal </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Obviamente, o cliente √© chamado de maneira diferente, mas neste artigo tudo ser√° despersonalizado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conduzo intelig√™ncia de rede - descubro quais endere√ßos e dom√≠nios est√£o listados pelo cliente, desenho um diagrama de rede, como os servi√ßos s√£o distribu√≠dos para esses endere√ßos. Eu recebo o resultado: mais de 4000 endere√ßos IP ao vivo. Examino os dom√≠nios nessas redes: felizmente, a grande maioria s√£o redes destinadas a clientes, e elas n√£o nos interessam formalmente. O cliente acredita no mesmo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta uma rede com 256 endere√ßos, para a qual, neste momento, j√° existe um entendimento da distribui√ß√£o de dom√≠nios e subdom√≠nios por endere√ßos IP, h√° informa√ß√µes sobre as portas digitalizadas, o que significa que voc√™ pode procurar os servi√ßos por outros interessantes com seus olhos. Paralelamente, todos os tipos de scanners s√£o lan√ßados em endere√ßos IP acess√≠veis e separadamente - em sites.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos servi√ßos. Isso geralmente √© uma alegria para o pentester e a antecipa√ß√£o de uma vit√≥ria r√°pida, pois quanto mais servi√ßos, maior o campo de ataque e mais f√°cil √© encontrar um artefato. Uma r√°pida olhada nos sites mostrou que a maioria deles s√£o interfaces da web dos produtos conhecidos de grandes empresas do mundo que afirmam que n√£o est√£o felizes com voc√™. Eles solicitam um nome de usu√°rio e senha; no limite, eles agitam o campo para inserir o segundo fator, solicitam um certificado de cliente TLS ou os enviam para o Microsoft ADFS. Alguns simplesmente n√£o est√£o dispon√≠veis na Internet. Para alguns, voc√™ obviamente precisa ter um cliente pago especial por tr√™s sal√°rios ou saber o URL exato para inserir. Omitiremos mais uma semana de des√¢nimo gradual no processo de tentar "romper" o software por vers√£o em busca de vulnerabilidades conhecidas, procurar conte√∫do oculto nos caminhos da Web e contas vazadas de servi√ßos de terceiros, como o LinkedIn,tenta selecionar senhas para eles, bem como escavar vulnerabilidades em sites auto-descritos - a prop√≥sito, segundo as estat√≠sticas, esse √© o vetor mais promissor de um ataque externo at√© hoje. Imediatamente noto a arma do cinema, que subseq√ºentemente disparou.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, havia dois sites que se destacam em centenas de servi√ßos. Esses sites tinham uma coisa em comum: se voc√™ n√£o se envolver em um reconhecimento meticuloso da rede por dom√≠nio, mas procurar "de frente" por portas abertas ou envenenar o scanner de vulnerabilidades em um intervalo de IP conhecido, esses sites sair√£o da verifica√ß√£o, eles simplesmente n√£o ser√£o vis√≠veis sem saber o nome DNS. Talvez eles tenham sido perdidos mais cedo, pelo menos, e nossas ferramentas autom√°ticas n√£o tenham encontrado problemas, mesmo que tenham sido definidas diretamente no recurso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, sobre o fato de que scanners lan√ßados anteriormente foram geralmente encontrados. Deixe-me lembr√°-lo: para algumas pessoas, ‚Äúpentest‚Äù √© equivalente a ‚Äúvarredura automatizada‚Äù. E os scanners deste projeto n√£o disseram nada. Bem, as vulnerabilidades m√©dias mostraram o m√°ximo (3 em 5 em termos de perigo): alguns servi√ßos t√™m um certificado TLS ruim ou algoritmos de criptografia desatualizados, e a maioria dos sites possui Clickjacking. Mas com isso voc√™ n√£o chegar√° √† meta. Provavelmente, os scanners seriam mais √∫teis aqui, mas deixe-me lembr√°-lo: o pr√≥prio cliente pode comprar esses programas e testar-se com eles, e, a julgar pelos resultados sem gra√ßa, ele j√° verificou.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voltar para os sites "anormais". O primeiro √© algo como um Wiki local em um endere√ßo n√£o padr√£o, mas deixe wiki.company [.] Ru estar neste artigo. Ela tamb√©m solicitou imediatamente um nome de usu√°rio e senha, mas j√° atrav√©s do NTLM no navegador. Para o usu√°rio, isso parece uma janela asc√©tica solicitando um nome de usu√°rio e senha. E isso √© uma pr√°tica ruim.</font></font><br>
<br>
<blockquote> . NTLM  -      .   ‚Äî    Active Directory.       company.ru,   ¬´¬ª DNS-.  ,    - ,        ,    - .  ‚Äî        NTLM (, ?),     ¬´¬ª ,         .    ,      .         ‚Äî  ,    .  ‚Äî       .         ‚Äî , ,  .  ‚Äî   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° um recurso ruim dos produtos da Microsoft: mesmo que voc√™ n√£o tenha publicado especificamente esse NTLM, ele estar√° na instala√ß√£o padr√£o no OWA e no Lync, pelo menos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, o autor deste artigo bloqueou acidentalmente aproximadamente 1000 contas de funcion√°rios de um grande banco em apenas uma hora e depois teve uma apar√™ncia um tanto p√°lida. </font><font style="vertical-align: inherit;">Os servi√ßos de TI do banco tamb√©m estavam fracos, mas tudo terminou bem e adequadamente, at√© fomos elogiados por termos sido os primeiros a encontrar esse problema e provocamos uma corre√ß√£o r√°pida e decisiva.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O segundo site tinha o endere√ßo "obviamente algum sobrenome.company.ru". </font><font style="vertical-align: inherit;">Encontrado no Google, algo parecido com isto na p√°gina 10. </font><font style="vertical-align: inherit;">O design est√° come√ßando em meados de 2000, e uma pessoa respeit√°vel olhou da p√°gina principal, algo como isto:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o ele tirou uma moldura do "Cora√ß√£o de cachorro", mas acredite, era remotamente semelhante, at√© o esquema de cores em cores semelhantes. Deixe o site ser chamado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era um site pessoal ... de um urologista. Tornou-se interessante o que o site do urologista faz no subdom√≠nio de uma empresa de alta tecnologia. Uma r√°pida pesquisa no Google mostrou que esse m√©dico era co-fundador de uma das entidades legais de nosso cliente e at√© contribuiu com cerca de 1000 rublos de capital registrado. Provavelmente, o site foi criado h√° muitos anos e os recursos do servidor do cliente foram usados ‚Äã‚Äãcomo hospedagem. O site perdeu a relev√¢ncia h√° muito tempo, mas, por algum motivo, ficou trabalhando por um longo tempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em termos de vulnerabilidades, o site em si era seguro. Olhando para o futuro, direi que era um conjunto de est√°tica - p√°ginas html simples com inser√ß√µes de ilustra√ß√µes na forma de rins e bexigas. "Quebrar" esse site √© in√∫til.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o servidor da web era mais interessante. A julgar pelo cabe√ßalho do servidor HTTP, havia o IIS 6.0, o que significa que o Windows 2003 foi usado como sistema operacional. O scanner revelou anteriormente que esse site espec√≠fico do urologista, ao contr√°rio de outros hosts virtuais no mesmo servidor da web, respondia ao comando PROPFIND, ou seja, o WebDAV trabalhava l√°. A prop√≥sito, o scanner emitiu essas informa√ß√µes com a marca Info (no idioma dos relat√≥rios do scanner, esse √© o menor perigo) - essas coisas geralmente s√£o simplesmente ignoradas. Em conjunto, isso deu um efeito interessante, que foi revelado apenas ap√≥s outra pesquisa no Google: uma rara vulnerabilidade de estouro de buffer associada a um conjunto de Shadow Brokers, a saber, o CVE-2017-7269, que j√° tinha uma explora√ß√£o pronta. Em outras palavras, ser√° um desastre se voc√™ tiver o Windows 2003 e o WebDAV em execu√ß√£o no IIS.Embora trabalhe na produ√ß√£o do Windows 2003 em 2018, isso √© um desastre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A explora√ß√£o terminou no Metasploit e foi imediatamente testada com uma carga que enviou uma consulta DNS para um servi√ßo controlado - o Burp Collaborator √© tradicionalmente usado para interceptar consultas DNS. Surpreendentemente, funcionou pela primeira vez: um idiota foi recebido no DNS. Houve uma tentativa de criar uma conex√£o de back-end atrav√©s da porta 80 (ou seja, uma conex√£o de rede do servidor para o invasor, com acesso ao cmd.exe no host da v√≠tima), mas ocorreu um fiasco. A conex√£o n√£o chegou e, ap√≥s a terceira tentativa de opera√ß√£o, o site, juntamente com todas as imagens divertidas, desapareceu completamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, isso √© seguido por uma carta no estilo de "cliente, acorde, deixamos cair tudo". Mas fomos informados de que o site n√£o tem nada a ver com processos de neg√≥cios e funciona l√° em geral, n√£o est√° claro por que, como todo o servidor, e que podemos usar esse recurso como quisermos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s cerca de um dia, o site come√ßou a funcionar de repente por conta pr√≥pria. Depois de criar um suporte a partir do WebDAV no IIS 6.0, descobri que a configura√ß√£o padr√£o √© reiniciar os fluxos de trabalho do IIS a cada 30 horas. Ou seja, quando o controle saiu do c√≥digo do shell, o fluxo de trabalho do IIS foi encerrado, ele foi reiniciado algumas vezes e depois foi interrompido por 30 horas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde a primeira vez que o bekconnect no tcp falhou, escrevi esse problema para uma porta fechada. </font><font style="vertical-align: inherit;">Ou seja, ele sugeriu a presen√ßa de algum firewall que n√£o permitia a sa√≠da de conex√µes de sa√≠da. </font><font style="vertical-align: inherit;">Comecei a executar c√≥digos de shell que classificavam muitas portas TCP e UDP, n√£o havia efeito. </font><font style="vertical-align: inherit;">A conex√£o reversa carrega atrav√©s de http (s) do Metasploit - meterpreter / reverse_http (s) n√£o funcionou. </font><font style="vertical-align: inherit;">De repente, a conex√£o com a mesma porta 80 foi estabelecida, mas imediatamente quebrou. </font><font style="vertical-align: inherit;">Ele escreveu isso para a a√ß√£o do IPS ainda imagin√°rio, que n√£o gostava de tr√°fego com menos metros. </font><font style="vertical-align: inherit;">Considerando que a conex√£o do tcp puro √† porta 80 falhou, mas o http falhou, conclu√≠ que o proxy http estava de alguma forma configurado no sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentei at√© meterpreter atrav√©s do DNS (obrigado</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por seus esfor√ßos, salvou muitos projetos), lembrando o primeiro sucesso, mas ele nem trabalhou no estande - o c√≥digo do shell era muito volumoso para esta vulnerabilidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na realidade, ficou assim: 3-4 tenta atacar em 5 minutos e aguarda 30 horas. E assim por tr√™s semanas seguidas. Eu at√© configurei um lembrete para n√£o perder tempo. Al√©m disso, havia uma diferen√ßa no comportamento dos ambientes de teste e combate: para essa vulnerabilidade, havia duas explora√ß√µes semelhantes, uma do Metasploit, a segunda da Internet, refeita na vers√£o do Shadow Brokers. Assim, no combate apenas o Metasploit funcionou, no estande - apenas o segundo, o que complicou ainda mais a depura√ß√£o e quebrou o c√©rebro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, o c√≥digo do shell provou ser eficaz, que baixou um arquivo exe de um determinado servidor via http e o executou no sistema de destino. O c√≥digo da shell era pequeno o suficiente para caber e, pelo menos, funcionava. Como o servidor TCP n√£o gostou muito do tr√°fego e o http (s) foi inspecionado quanto ao meterpreter, decidi que a maneira mais r√°pida era fazer o download do arquivo exe que continha o DNS-meterpreter por esse c√≥digo de shell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, novamente, surgiu o problema: ao baixar o arquivo exe e, como as tentativas mostraram, n√£o importa como, o download foi interrompido. </font><font style="vertical-align: inherit;">Mais uma vez, algum tipo de dispositivo de prote√ß√£o entre o meu servidor e o urologista n√£o gostou do tr√°fego http com exe dentro. </font><font style="vertical-align: inherit;">Parecia uma solu√ß√£o "r√°pida" alterar o c√≥digo de shell para ofuscar o tr√°fego http em tempo real, para que dados bin√°rios abstratos fossem transferidos em vez de exe. </font><font style="vertical-align: inherit;">Finalmente, o ataque foi bem-sucedido, o controle veio atrav√©s do canal DNS fino:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imediatamente ficou claro que eu tinha os direitos mais simples do fluxo de trabalho do IIS que me permitiam fazer nada. </font><font style="vertical-align: inherit;">√â assim que parecia no console do Metasploit:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as metodologias pentest sugerem fortemente que voc√™ precisa aumentar os direitos ao obter acesso. Normalmente, eu n√£o fa√ßo isso localmente, pois o primeiro acesso √© considerado simplesmente como um ponto de entrada na rede, e geralmente √© mais f√°cil e r√°pido comprometer outra m√°quina na mesma rede do que aumentar os privil√©gios em um host existente. Mas esse n√£o √© o caso, j√° que o canal DNS √© muito estreito e n√£o permitir√° que o tr√°fego circule. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supondo que este servidor com Windows 2003 n√£o tenha sido reparado a partir da conhecida vulnerabilidade MS17-010, estou encapsulando o tr√°fego para a porta 445 / TCP atrav√©s do t√∫nel DNS meterpreter para localhost (sim, isso tamb√©m √© poss√≠vel) e tentando executar um exe baixado anteriormente atrav√©s da vulnerabilidade. O ataque funciona, eu recebo uma segunda conex√£o, mas com privil√©gios de SISTEMA.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, o servidor ainda estava tentando se proteger do MS17-010 - desativou os servi√ßos de rede vulner√°veis ‚Äã‚Äãna interface externa. </font><font style="vertical-align: inherit;">Isso realmente protege contra ataques pela rede, mas o ataque de dentro do host local funcionou, pois voc√™ n√£o pode simplesmente pegar e desligar rapidamente o SMB no host local.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, novos detalhes interessantes s√£o revelados:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com permiss√µes de sistema, voc√™ pode instalar facilmente a conex√£o traseira via TCP. </font><font style="vertical-align: inherit;">Obviamente, a proibi√ß√£o do TCP direto √© exclusivamente um problema de usu√°rio limitado do IIS. </font><font style="vertical-align: inherit;">Desmancha prazeres: o tr√°fego de usu√°rios do IIS foi de alguma forma envolvido no ISA Proxy local em ambas as dire√ß√µes. </font><font style="vertical-align: inherit;">Como exatamente isso funciona n√£o √© reproduzido.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estou em uma certa "DMZ" (e este n√£o √© um dom√≠nio do Active Directory, mas um GRUPO DE TRABALHO) - parece l√≥gico. </font><font style="vertical-align: inherit;">Mas, em vez do endere√ßo IP privado ("cinza") esperado, sou bastante "branco", exatamente o mesmo que ataquei anteriormente. </font><font style="vertical-align: inherit;">Isso significa que a empresa √© t√£o antiga para o mundo do endere√ßamento IPv4 que pode manter a zona DMZ em 128 endere√ßos "brancos" sem NAT, conforme o esquema, conforme ilustrado nos manuais da Cisco de 2005.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o servidor √© antigo, √© garantido que o Mimikatz funcione diretamente da mem√≥ria:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recebo a senha do administrador local, encapsulo o tr√°fego RDP atrav√©s do TCP e entro em uma √°rea de trabalho aconchegante. </font><font style="vertical-align: inherit;">Como voc√™ pode fazer qualquer coisa com o servidor, excluo o antiv√≠rus, acho que o servidor s√≥ pode ser acessado pela Internet nas portas TCP 80 e 443 e 443 n√£o estava ocupado. </font><font style="vertical-align: inherit;">Eu elevo o servidor OpenVPN para 443, adiciono as fun√ß√µes NAT ao meu tr√°fego VPN e obtenho acesso direto √† rede DMZ de forma ilimitada atrav√©s do meu OpenVPN. </font><font style="vertical-align: inherit;">Vale ressaltar que o ISA, com alguns recursos IPS n√£o desativados, bloqueou meu tr√°fego com a varredura de portas, pela qual teve que ser substitu√≠do por um RRAS mais simples e flex√≠vel. </font><font style="vertical-align: inherit;">Ent√£o, os padres ainda precisam administrar tudo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um leitor atento perguntar√°: "E qual √© o segundo site - um wiki com autentica√ß√£o NTLM, sobre o qual tanto foi escrito?" </font><font style="vertical-align: inherit;">Sobre isso mais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2. Voc√™ ainda n√£o est√° criptografado? </font><font style="vertical-align: inherit;">Ent√£o vamos </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at√© voc√™</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j√° aqui</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, h√° acesso ao segmento de rede DMZ. </font><font style="vertical-align: inherit;">Voc√™ precisa ir ao administrador do dom√≠nio. </font><font style="vertical-align: inherit;">A primeira coisa que vem √† mente √© verificar automaticamente a seguran√ßa dos servi√ßos dentro do segmento DMZ, ainda mais porque agora eles est√£o muito mais abertos para pesquisas. </font><font style="vertical-align: inherit;">Uma imagem t√≠pica de um teste de penetra√ß√£o: o per√≠metro externo √© mais protegido do que os servi√ßos internos e, quando voc√™ obt√©m acesso a uma grande infraestrutura, √© muito mais f√°cil obter direitos estendidos em um dom√≠nio apenas porque esse dom√≠nio come√ßa a ser acess√≠vel para ferramentas e, em segundo lugar, sempre h√° algumas quest√µes cr√≠ticas na infraestrutura para v√°rios milhares de hosts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carrego scanners na DMZ atrav√©s do t√∫nel OpenVPN, espero. Abro o relat√≥rio - novamente nada s√©rio, aparentemente algu√©m andou da mesma maneira para mim. O pr√≥ximo passo √© examinar como os hosts se comunicam na rede DMZ. Para fazer isso, para iniciantes, um Wireshark regular √© iniciado com a escuta de solicita√ß√µes de transmiss√£o, principalmente ARP. Os pacotes ARP foram coletados o dia todo. Acontece que v√°rios gateways s√£o usados ‚Äã‚Äãnesse segmento. Isso ser√° √∫til mais tarde. Ao colar dados nos dados de resposta a solicita√ß√µes e de varredura de porta do ARP, encontrei os pontos de sa√≠da do tr√°fego do usu√°rio na rede local, al√©m dos servi√ßos que eram conhecidos anteriormente, como Web e correio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no momento eu n√£o tinha acesso a outros sistemas e n√£o havia uma √∫nica conta para servi√ßos corporativos, foi decidido buscar pelo menos alguma conta do tr√°fego usando o ARP Spoofing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel foi lan√ßado no servidor do urologista. </font><font style="vertical-align: inherit;">Levando em considera√ß√£o os fluxos de tr√°fego identificados, os pares mais promissores foram selecionados para o ataque "homem no meio" e, em seguida, por um lan√ßamento de curto prazo por 5 a 10 minutos, com um temporizador para reiniciar o servidor em caso de "congelamento", algum tr√°fego de rede foi recebido. </font><font style="vertical-align: inherit;">Como na piada, havia duas not√≠cias:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bom: muitas credenciais foram capturadas e o ataque como um todo funcionou.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruim: todas as credenciais eram de clientes do pr√≥prio cliente. </font><font style="vertical-align: inherit;">Fornecendo servi√ßos de suporte, os especialistas do cliente est√£o conectados aos servi√ßos ao cliente que nem sempre t√™m a criptografia de tr√°fego configurada.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtive muitas credenciais que eram in√∫teis no contexto do projeto, mas definitivamente interessantes como uma demonstra√ß√£o do perigo de um ataque. Roteadores de fronteira de grandes empresas com telnet, encaminharam a depura√ß√£o de portas http para o CRM interno com todos os dados, acesso direto ao RDP do Windows XP na rede local e outros obscurantismos. O resultado foi uma esp√©cie de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compromisso da cadeia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">suprimentos, de acordo com a matriz do MITRE</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m encontrou uma oportunidade divertida de coletar e-mails do tr√°fego, algo assim. Este √© um exemplo de uma carta finalizada que foi do nosso cliente para a porta SMTP do cliente, novamente, sem criptografia. Um certo Andrei pede que seu hom√¥nimo reenvie a documenta√ß√£o, que √© apresentada em um disco na nuvem com um nome de usu√°rio, senha e link em uma carta de resposta:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse √© outro lembrete de que voc√™ precisa criptografar todos os servi√ßos. N√£o se sabe quem e quando ler√° e aplicar√° especificamente seus dados - um provedor, um administrador de sistemas de outra empresa ou um fornecedor desse tipo. Fico calado ao saber que muitos podem simplesmente interceptar tr√°fego n√£o criptografado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar do aparente sucesso, isso n√£o foi aproximado da meta. Era poss√≠vel, √© claro, ficar sentado por um longo tempo e obter informa√ß√µes valiosas, mas n√£o o fato de que elas apareceriam l√°, e o ataque em si √© muito arriscado em termos de integridade da rede.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de mais uma escava√ß√£o nos servi√ßos, uma ideia interessante veio √† minha mente. Existe um utilit√°rio chamado Respondente (√© f√°cil encontrar exemplos de aplicativos com esse nome) que, por "envenenar" solicita√ß√µes de transmiss√£o, provoca conex√µes atrav√©s de uma variedade de protocolos como SMB, HTTP, LDAP, etc. de maneiras diferentes, cada pessoa que se conectar √© solicitada a autenticar e ajustar, para que a autentica√ß√£o passe pelo NTLM e em um modo transparente para a v√≠tima. Na maioria das vezes, um invasor coleta os apertos de m√£o NetNTLMv2 e deles, de acordo com o dicion√°rio, recupera rapidamente as senhas de dom√≠nio do usu√°rio. Eu queria algo semelhante aqui, mas os usu√°rios estavam sentados "atr√°s do muro", ou melhor, eles foram separados por um firewall e, na WEB, passaram pelo cluster de proxy do Blue Coat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se, especifiquei que o nome de dom√≠nio do Active Directory coincidia com o dom√≠nio "externo", ou seja, era company.ru? Portanto, o Windows, mais precisamente o Internet Explorer (e Edge e Chrome), permite que o usu√°rio se autentique de forma transparente no HTTP via NTLM, se considerar que o site est√° em alguma "Zona da Intranet". Um dos sinais de "Intranet" √© uma chamada para um endere√ßo IP "cinza" ou um nome DNS curto, ou seja, sem pontos. Como um servidor com um nome IP e DNS ‚Äúbranco‚Äù preobrazhensky.company.ru estava √† sua disposi√ß√£o e as m√°quinas de dom√≠nio geralmente obt√™m o sufixo de dom√≠nio do Active Directory via DHCP para entrada simplificada de nomes, eles apenas precisavam escrever </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">um</font></a><font style="vertical-align: inherit;"> URL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">preobrazhensky</font></a><font style="vertical-align: inherit;"> na barra de endere√ßos</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que eles encontrem o caminho certo para um servidor de urologista comprometido, sem esquecer que agora √© chamado de "Intranet". </font><font style="vertical-align: inherit;">Ou seja, ao mesmo tempo, fornece-me o usu√°rio NTLM-handshake sem o seu conhecimento. </font><font style="vertical-align: inherit;">Resta fazer os navegadores clientes pensarem na necessidade urgente de acessar este servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O maravilhoso utilit√°rio Intercepter-NG veio em socorro (obrigado</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Permitia alterar o tr√°fego em movimento e funcionava perfeitamente no Windows 2003. Havia at√© uma funcionalidade separada para modificar apenas arquivos JavaScript no fluxo de tr√°fego. Foi planejado uma esp√©cie de script entre sites massivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proxies do Blue Coat por meio dos quais os usu√°rios acessavam o conte√∫do est√°tico em cache da WEB global periodicamente. Ao interceptar o tr√°fego, ficou claro que eles trabalham 24 horas por dia, solicitando incessantemente as estat√≠sticas frequentemente usadas para acelerar a exibi√ß√£o do conte√∫do durante o hor√°rio de pico. Al√©m disso, a BlueCoat tinha um User-Agent espec√≠fico, que o distinguia claramente de um usu√°rio vivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Javascript foi preparado, que com a ajuda do Intercepter-NG durante a noite passou uma hora inteira implementando cada resposta com arquivos JS do Blue Coat. O script fez o seguinte:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detectou o navegador atual pelo User-Agent. </font><font style="vertical-align: inherit;">Se fosse o Internet Explorer, Edge ou Chrome - funcionou.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguarde at√© que o DOM da p√°gina seja formado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inseri uma imagem invis√≠vel com o atributo src do tipo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky no DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / NNNNNNN.png, em que NNN s√£o d√≠gitos arbitr√°rios para que o BlueCoat n√£o fa√ßa cache.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina uma vari√°vel de flag global que a inje√ß√£o foi feita e que voc√™ n√£o precisa mais inserir imagens.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O navegador tentou carregar esta imagem, na porta 8080 do servidor comprometido, aguardava o t√∫nel TCP no meu laptop, onde o mesmo Respondente foi iniciado, o que requer login NTLM no navegador.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A julgar pelos logs do Respondente, pela manh√£ as pessoas come√ßaram a trabalhar, ligaram as esta√ß√µes de trabalho e come√ßaram a visitar o servidor do urologista em massa e imperceptivelmente, sem esquecer de "mesclar" os handshakes NTLM. </font><font style="vertical-align: inherit;">Os handshakes choveram o dia todo e claramente acumularam material para um ataque de recupera√ß√£o de senha notoriamente bem-sucedido. </font><font style="vertical-align: inherit;">√â assim que os logs do Respondente eram:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visitas secretas maci√ßas ao servidor do urologista por usu√°rios</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ provavelmente j√° percebeu que toda essa hist√≥ria se baseia no princ√≠pio "tudo estava bem, mas havia uma chatice, depois houve supera√ß√£o e tudo deu certo". </font><font style="vertical-align: inherit;">Ent√£o, houve uma chatice. </font><font style="vertical-align: inherit;">Dos quinhentos apertos de m√£o √∫nicos, nenhum foi revelado. </font><font style="vertical-align: inherit;">E isso leva em considera√ß√£o o fato de que, mesmo em um laptop com um processador inoperante, esses handshakes NTLMv2 superam a velocidade de v√°rias centenas de milh√µes de tentativas por segundo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tive que me armar com t√©cnicas de muta√ß√£o de senha, uma placa gr√°fica, um dicion√°rio mais grosso e esperar. </font><font style="vertical-align: inherit;">Depois de muito tempo, v√°rias contas com senhas no formato "Q11111111 ... .1111111q" foram abertas, o que sugere que todos os usu√°rios foram for√ßados a criar uma senha muito longa com um caso diferente de caracteres, que deveria ser complicado. </font><font style="vertical-align: inherit;">Mas voc√™ n√£o pode simplesmente deixar um usu√°rio experiente e, dessa maneira, ele facilitou a lembran√ßa. </font><font style="vertical-align: inherit;">No total, foram abertas cerca de 5 pe√ßas, e apenas uma delas tinha direitos valiosos sobre os servi√ßos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3. Roskomnadzor revida</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, as primeiras contas de dom√≠nio foram recebidas. </font><font style="vertical-align: inherit;">Se nesse momento voc√™ n√£o adormeceu ap√≥s uma longa leitura, provavelmente se lembrar√° de que mencionei um servi√ßo que n√£o exigia um segundo fator de autentica√ß√£o: este √© um wiki com autentica√ß√£o NTLM. </font><font style="vertical-align: inherit;">Claro, a primeira coisa que eles fizeram foi entrar. </font><font style="vertical-align: inherit;">Entrar na base de conhecimento interna rapidamente trouxe resultados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A empresa possui uma rede Wi-Fi com autentica√ß√£o de conta de dom√≠nio com acesso a uma rede local. </font><font style="vertical-align: inherit;">Com o conjunto de dados atual, esse j√° √© um vetor de ataque ativo, mas voc√™ precisa ir ao escrit√≥rio com os p√©s e se colocar em algum lugar no escrit√≥rio do cliente.</font></font></li>
<li> ,    , ‚Ä¶    ¬´ ¬ª ,              .    ¬´¬ª  ¬´¬ª        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, o "segundo fator" foi imediatamente adicionado √† conta comprometida como um aplicativo no meu telefone. Havia um programa que pode enviar em voz alta uma solicita√ß√£o push para o telefone com os bot√µes "aprovar" / "desaprovar" ou mostrar silenciosamente o c√≥digo OTP na tela para uma entrada independente adicional. Al√©m disso, o primeiro m√©todo deveria ser a √∫nica instru√ß√£o correta, mas n√£o funcionou, diferentemente do m√©todo OTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o "segundo fator" quebrado, consegui acessar o correio do Outlook Web Access e acessar remotamente o Citrix Netscaler Gateway. No Outlook, uma surpresa estava esperando pelo correio:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesta cena rara, voc√™ pode ver como Roskomnadzor ajuda os pentesters:</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
estes foram os primeiros meses ap√≥s o famoso bloqueio do ventilador do Telegram, quando redes inteiras com milhares de endere√ßos desapareceram inexoravelmente do acesso. Ficou claro por que o push n√£o funcionou imediatamente e por que minha "v√≠tima" n√£o tocou o alarme porque eles come√ßaram a usar a conta dela em hor√°rio aberto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqueles que est√£o familiarizados com o Citrix Netscaler imaginam que geralmente √© implementado de tal maneira que √© poss√≠vel transmitir ao usu√°rio apenas uma interface de imagem, tentando n√£o fornecer as ferramentas para iniciar aplicativos de terceiros e transferir dados, restringindo de maneira alguma as a√ß√µes por meio de shells de controle padr√£o. Pela minha ocupa√ß√£o, eu s√≥ tenho 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo andado um pouco na interface 1C, descobri que existem m√≥dulos de processamento externos l√°. </font><font style="vertical-align: inherit;">Eles podem ser carregados a partir da interface e ser√£o executados no cliente ou servidor, dependendo dos direitos e configura√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pedi aos programadores 1C dos amigos que criassem esse processamento que pegaria uma string e a executasse. </font><font style="vertical-align: inherit;">Em 1C, o lan√ßamento do processo √© mais ou menos assim (retirado da Internet). </font><font style="vertical-align: inherit;">Concordo, a sintaxe da linguagem 1C atinge uma pessoa de l√≠ngua russa com seu imediatismo? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processamento foi perfeitamente executado, resultando no que os Pentesters chamam de "shell" - o Internet Explorer foi lan√ßado por meio dele.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, o endere√ßo do sistema foi encontrado no correio, o que permite solicitar passes para o territ√≥rio. </font><font style="vertical-align: inherit;">Eu pedi um passe para o caso de precisar usar o vetor de ataque via WiFi.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na Internet, eles dizem que no escrit√≥rio do cliente ainda havia um saboroso servi√ßo de catering gratuito, mas eu ainda preferia desenvolver um ataque atrav√©s de um site remoto, √© mais calmo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O AppLocker foi ativado no servidor de aplicativos com o Citrix, mas foi ignorado. </font><font style="vertical-align: inherit;">O mesmo Meterpreter foi carregado e iniciado via DNS, porque as vers√µes http (s) n√£o desejavam se conectar e, ent√£o, eu n√£o sabia o endere√ßo proxy interno. </font><font style="vertical-align: inherit;">Ali√°s, a partir deste momento, o pentesto externo se transformou essencialmente no interno.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 4. Direitos de administrador para usu√°rios - isso √© ruim, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que um Pentester faz quando assume o controle da sess√£o de um usu√°rio do dom√≠nio √© coletar todas as informa√ß√µes sobre os direitos no dom√≠nio. </font><font style="vertical-align: inherit;">Existe um utilit√°rio BloodHound, que permite baixar automaticamente informa√ß√µes sobre usu√°rios, computadores, grupos de seguran√ßa atrav√©s do protocolo LDAP do controlador de dom√≠nio e informa√ß√µes sobre qual usu√°rio efetuou login recentemente e quem √© o administrador local atrav√©s do SMB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma t√©cnica t√≠pica para capturar privil√©gios de administrador de dom√≠nio parece simplificada como um ciclo de a√ß√µes mon√≥tonas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos para computadores de dom√≠nio, onde existem direitos de administrador local, com base em contas de dom√≠nio j√° capturadas.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Fim do ciclo"; como os programadores da 1C escreveriam aqui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, nosso usu√°rio acabou sendo um administrador local em apenas um host com o Windows 7, cujo nome era a palavra "VDI" ou "Virtual Desktop Infrastructure", m√°quinas virtuais pessoais. </font><font style="vertical-align: inherit;">Provavelmente, o projetista do servi√ßo VDI sugeriu que, como o VDI √© o sistema operacional pessoal do usu√°rio, permita que o usu√°rio altere o ambiente de software, como desejar, de qualquer maneira que o host possa ser "recarregado". </font><font style="vertical-align: inherit;">Eu tamb√©m pensei que, em geral, a id√©ia √© boa, fui a esse host pessoal de VDI e fiz um soquete l√°:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu instalei o cliente OpenVPN l√°, que fez um t√∫nel atrav√©s da Internet para o meu servidor. </font><font style="vertical-align: inherit;">O cliente teve que passar pelo pr√≥prio Blue Coat com autentica√ß√£o de dom√≠nio, mas o OpenVPN lidou, como eles dizem, fora da caixa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalado no VDI OpenSSH. </font><font style="vertical-align: inherit;">Bem, realmente, o que √© esse Windows 7 sem SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que parecia vivo. </font><font style="vertical-align: inherit;">Lembro que tudo isso deve ser feito atrav√©s do Citrix e 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das t√©cnicas para promover o acesso a computadores vizinhos √© verificar as senhas dos administradores locais em busca de uma correspond√™ncia. </font><font style="vertical-align: inherit;">Aqui a sorte estava esperando imediatamente: o hash NTLM do administrador local padr√£o (que de repente se chamava Administrator) aproximou-se dos hosts VDI vizinhos, dos quais havia v√°rias centenas, atrav√©s do ataque do tipo passe-a-hash. </font><font style="vertical-align: inherit;">Claro, o ataque imediatamente os atacou.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, os administradores da VDI deram um tiro no p√© duas vezes:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira vez que m√°quinas VDI n√£o foram acionadas pelo LAPS, salvando essencialmente a mesma senha de administrador local de uma imagem que foi implantada em massa no VDI.</font></font></li>
<li>   ‚Äî   ,    pass-the-hash .          ,         ,   ‚Äî .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que o servi√ßo SSH nesse Windows? Muito simples: agora o servidor OpenSSH n√£o apenas forneceu um shell de comando interativo conveniente, sem interferir no trabalho do usu√°rio, mas tamb√©m um proxy socks5 no VDI. Com essas meias, eu me conectei via SMB e coletei contas em cache de todas essas centenas de m√°quinas VDI, depois procurei o caminho para o administrador do dom√≠nio nos gr√°ficos do BloodHound. Com centenas de hosts √† minha disposi√ß√£o, encontrei esse caminho rapidamente. Direitos de administrador de dom√≠nio foram obtidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° uma foto da Internet, mostrando uma pesquisa semelhante. Os links mostram quem √© o administrador e quem entrou onde.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, lembre-se da condi√ß√£o desde o in√≠cio do projeto - "n√£o aplique engenharia social". </font><font style="vertical-align: inherit;">Ent√£o, proponho ponderar quanto esse Bollywood inteiro seria cortado com efeitos especiais, se fosse poss√≠vel aplicar phishing banal. </font><font style="vertical-align: inherit;">Mas, pessoalmente, eu estava muito interessado em fazer tudo isso. </font><font style="vertical-align: inherit;">Espero que voc√™ esteja interessado em ler isso. </font><font style="vertical-align: inherit;">Obviamente, nem todo projeto parece t√£o intrigante, mas o trabalho como um todo √© muito intrigante e n√£o fica estagnado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provavelmente, algu√©m ter√° uma pergunta: como se proteger? </font><font style="vertical-align: inherit;">Mesmo neste artigo, muitas t√©cnicas s√£o descritas, os administradores do Windows nem conhecem muitas delas. </font><font style="vertical-align: inherit;">No entanto, proponho olhar para eles da perspectiva de princ√≠pios e medidas de seguran√ßa da informa√ß√£o:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o use software desatualizado (lembra do Windows 2003 no in√≠cio?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o mantenha sistemas desnecess√°rios ligados (por que o site do urologista?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifique as senhas dos usu√°rios para se fortalecer (caso contr√°rio, </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soldados ...</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pentesters </font><font style="vertical-align: inherit;">far√£o isso </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o possui as mesmas senhas para contas diferentes (comprometimento da VDI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e outro</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, √© muito dif√≠cil de implementar, mas no pr√≥ximo artigo mostraremos na pr√°tica que isso √© bem poss√≠vel.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496702/index.html">PCI Express em FPGAs da s√©rie V da Intel: recursos b√°sicos de interface e recursos principais de hardware</a></li>
<li><a href="../pt496704/index.html">PCB do foguete Saturn-5 - engenharia reversa com explica√ß√µes</a></li>
<li><a href="../pt496706/index.html">Leitura de fim de semana: uma hist√≥ria dos formatos de √°udio - a era das cassetes e o desenvolvimento das tecnologias de s√≠ntese de fala</a></li>
<li><a href="../pt496708/index.html">Pistola espacial, foguete a vapor e espelho orbital</a></li>
<li><a href="../pt496710/index.html">Informa√ß√µes sobre o computador: simples e r√°pido</a></li>
<li><a href="../pt496714/index.html">Aplicativos do Power Automate VS Logic. informa√ß√£o geral</a></li>
<li><a href="../pt496716/index.html">Aplicativos do Power Automate VS Logic. Casos do Power Automat</a></li>
<li><a href="../pt496720/index.html">Projeto LLHD - Linguagem de descri√ß√£o de hardware universal</a></li>
<li><a href="../pt496722/index.html">API de Tinkov, investimento. Primeiros passos</a></li>
<li><a href="../pt496726/index.html">Gent para o fundo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>