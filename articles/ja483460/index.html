<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎵 ⏩ 🎵 SQLハウツー：ウィンドウ関数を使用したチェーンの構築 🌴 🤾 ☃️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="場合によっては、データを分析するときに、サンプル内の「チェーン」、つまり、特定の条件を満たす各レコードの順序付けされたシーケンスを区別するという問題が発生することがあります。 これは、レコード自体のデータの条件、または1つ以上の以前のレコードに関する複雑な式（たとえば、近い時間のサンプル間の間隔の長...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SQLハウツー：ウィンドウ関数を使用したチェーンの構築</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/483460/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合によっては、データを分析するとき</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、サンプル内の「チェーン」、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり</font><u><font style="vertical-align: inherit;">、特定の条件を満たす</font></u><font style="vertical-align: inherit;">各レコードの</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">順序付けされたシーケンスを</font></font></u><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">区別する</font></b><font style="vertical-align: inherit;">という</font><b><font style="vertical-align: inherit;">問題が</font></b><font style="vertical-align: inherit;">発生する</font><font style="vertical-align: inherit;">ことがあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">
これは、レコード自体のデータの条件、または1つ以上の以前のレコードに関する複雑な式（たとえば、近い時間のサンプル間の間隔の長さ）のいずれかです。</font><font style="vertical-align: inherit;">
従来のソリューションでは、サンプルがそれ自体に接続する場合、または「データの外」で特定のファクトを使用する場合の「自己結合」のさまざまなオプションが提供されます。たとえば、レコードには厳密に定義されたステップ（N + 1、「毎日」など）が必要です。 ）</font><font style="vertical-align: inherit;">
最初のオプションは、多くの場合、</font><b><font style="vertical-align: inherit;">二次の複雑さに</font></b><font style="vertical-align: inherit;">つながります</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/nc/ld/fxncldmr0bpfaufpa2tosjozqy8.png"><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大量のサンプル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">受け入れられない</font></a><font style="vertical-align: inherit;">レコード数のアルゴリズム</font><font style="vertical-align: inherit;">。2番目</font><font style="vertical-align: inherit;">のレコード</font><font style="vertical-align: inherit;">は、ソースデータのサンプルが突然表示されない場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単に「バラバラ」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、このタスクは</font><font style="vertical-align: inherit;">PostgreSQLの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウ関数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を効果的に解決するのに役立ち</font><font style="vertical-align: inherit;">ます。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク：他の人のお金を数える</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェーンの最も単純なケースを考えてください。連続性の条件は、レコード自体のデータによって決定される場合です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以降のすべての操作を個別に行う必要はありません。しかし、アルゴリズムを明確にするために、アルゴリズムを連続するステップに分割</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、最後に何をどのように最適化するかを示し</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルに顧客口座の残高を維持する小さな銀行があるとしましょう。入出金トランザクションが発生するとすぐに、この日付はその日の終わりに請求書の合計金額も確定します。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長い新年の休暇の後、銀行は顧客に報いることを決めた-との1％+のアカウントを開設した一人一人が今年さらにACCRUE </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">毎日の平均残高</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のための</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も長い連続期間</font></font></b><font style="vertical-align: inherit;"></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のアカウントは「リセット」はなかったです</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで、それは「チェーン」の継続性に対する私たちの基準です。</font><font style="vertical-align: inherit;">まあ、データの順序は残高の日付によって決まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは私たちにそのようなCSVをもたらし、銀行からのそのような寛大さが誰にどれだけ得られるかをすばやく計算するように求めました：</font></font><br>
<br>
<pre><code class="plaintext hljs">date;client;balance<font></font>
01.01.2020;;150<font></font>
01.01.2020;;100<font></font>
02.01.2020;;100<font></font>
02.01.2020;;150<font></font>
03.01.2020;;200<font></font>
05.01.2020;;0<font></font>
06.01.2020;;50<font></font>
08.01.2020;;0<font></font>
08.01.2020;;200<font></font>
09.01.2020;;0<font></font>
09.01.2020;;0<font></font>
10.01.2020;;5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータで目立ついくつかの事実に注意してください。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01.01は休日で、銀行は機能しませんでした。</font><font style="vertical-align: inherit;">したがって、この日の残高変更に関する記録を持っているクライアントはありませんが、口座にはお金があります。</font><font style="vertical-align: inherit;">つまり、日ごとに繰り返される「ブルートフォース」アルゴリズムは正常に機能しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04.01アリスは操作を実行しなかったため、エントリはありません。</font><font style="vertical-align: inherit;">しかし、05.01まで、彼女のアカウントの金額はゼロではありませんでした-これは分析で考慮に入れる必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析は01.01-12.01で行いますが、この期間の終わりのアリスの口座残高はゼロではありません。</font><font style="vertical-align: inherit;">また、期間を制限する必要性も考慮しています。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSVからテーブル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CSVからインポートする最良の方法は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、COPY演算子</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">使用すること</font></a><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">しかし、ウォームアップするために正規表現を通じてこれを実行しようとします：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">to_date</span>(prt[<span class="hljs-number">1</span>], <span class="hljs-string">'DD.MM.YYYY'</span>) dt<font></font>
, prt[<span class="hljs-number">2</span>] <span class="hljs-keyword">client</span>
, prt[<span class="hljs-number">3</span>]::<span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>) balance
<span class="hljs-keyword">FROM</span><font></font>
  (<font></font>
    <span class="hljs-keyword">SELECT</span>
      regexp_split_to_array(<span class="hljs-keyword">str</span>, <span class="hljs-string">';'</span>) prt
    <span class="hljs-keyword">FROM</span><font></font>
      (<font></font>
        <span class="hljs-keyword">SELECT</span><font></font>
          regexp_split_to_table(<font></font>
$$<font></font>
<span class="hljs-built_in">date</span>;client;balance<font></font>
01.01.2020;;150<font></font>
01.01.2020;;100<font></font>
02.01.2020;;100<font></font>
02.01.2020;;150<font></font>
03.01.2020;;200<font></font>
05.01.2020;;0<font></font>
06.01.2020;;50<font></font>
08.01.2020;;0<font></font>
08.01.2020;;200<font></font>
09.01.2020;;0<font></font>
09.01.2020;;0<font></font>
10.01.2020;;5<font></font>
$$<font></font>
        , E'\\n') str<font></font>
      ) T<font></font>
    WHERE<font></font>
      str &lt;&gt; ''<font></font>
    OFFSET 1<font></font>
  ) T;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、フィールドの本文のセパレーターをシールドするなど、正しく消化されないという意味で「不誠実な」方法です。</font><font style="vertical-align: inherit;">しかし、ほとんどの単純なアプリケーションでは-適切です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ1：アプリケーション条件を修正する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、チェーンの連続性の条件はゼロ以外のバランスです。</font><font style="vertical-align: inherit;">明確にするために、クライアントごとに時系列順に並べて、別のフィールドとして表示します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
, balance &gt; <span class="hljs-number">0</span> cond
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">client</span>, dt;
</code></pre><br>
<pre><code class="plaintext hljs">dt         | client | balance | cond<font></font>
------------------------------------<font></font>
2020-01-01 |   |  150.00 | t<font></font>
2020-01-02 |   |  100.00 | t<font></font>
2020-01-03 |   |  200.00 | t<font></font>
2020-01-05 |   |    0.00 | f<font></font>
2020-01-06 |   |   50.00 | t<font></font>
2020-01-08 |   |    0.00 | f<font></font>
2020-01-09 |   |    0.00 | f<font></font>
2020-01-10 |   |    5.00 | t<font></font>
2020-01-01 |     |  100.00 | t<font></font>
2020-01-02 |     |  150.00 | t<font></font>
2020-01-08 |     |  200.00 | t<font></font>
2020-01-09 |     |    0.00 | f<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2：行方不明を計算する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボブからの金額が02.01から08.01に変更されていないことに注意してください。そして、問題の条件に応じて、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1日</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><u><font style="vertical-align: inherit;">平均</font></u><font style="vertical-align: inherit;">残高を</font><font style="vertical-align: inherit;">計算する</font><font style="vertical-align: inherit;">必要があります。つまり、これらの「欠落した」日の情報が必要です。または、少なくとも値が同じままの日数：</font></font><br>
<br>
<pre><code class="sql hljs">coalesce(lead(dt) OVER(PARTITION BY client ORDER BY dt), '2020-01-12') - dt days</code></pre><br>
<pre><code class="plaintext hljs">dt         | client | balance | cond | days<font></font>
-------------------------------------------<font></font>
2020-01-01 |   |  150.00 | t    |    1<font></font>
2020-01-02 |   |  100.00 | t    |    1<font></font>
2020-01-03 |   |  200.00 | t    |    2<font></font>
2020-01-05 |   |    0.00 | f    |    1<font></font>
2020-01-06 |   |   50.00 | t    |    2<font></font>
2020-01-08 |   |    0.00 | f    |    1<font></font>
2020-01-09 |   |    0.00 | f    |    1<font></font>
2020-01-10 |   |    5.00 | t    |    2<font></font>
2020-01-01 |     |  100.00 | t    |    1<font></font>
2020-01-02 |     |  150.00 | t    |    6<font></font>
2020-01-08 |     |  200.00 | t    |    1<font></font>
2020-01-09 |     |    0.00 | f    |    3<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lead（）ウィンドウ関数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レコードから順番に</font><font style="vertical-align: inherit;">日付を学習し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合体</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって後者の間隔</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">制限しました。</font><font style="vertical-align: inherit;">同時に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLの2つの日付</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">差が</font></b><font style="vertical-align: inherit;">それらの間</font><b><font style="vertical-align: inherit;">の日数を整数で返すという</font></b><font style="vertical-align: inherit;">便利なプロパティを使用し</font><font style="vertical-align: inherit;">ました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんど無料のボーナスとして、残高がゼロのレコードについてすべて同じ情報を取得しました。</font><font style="vertical-align: inherit;">しかし、私たちにとって興味のない、満たされていない状態の行がたくさんある場合は、</font><font style="vertical-align: inherit;">サーバーのリソースを節約するために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CASE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">そのような</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">計算を実行する</font></a><font style="vertical-align: inherit;">ことは理にかなっ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">てい</font></a><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ3：ブレークポイントを見つける</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関心のある各チェーンの始まりは、前に計算された条件の値が</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レコードと</font><font style="vertical-align: inherit;">比較して変化するポイント</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">そのようなポイントを見つけるために</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lag（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">します：</font></font><br>
<br>
<pre><code class="sql hljs">lag(cond) OVER(PARTITION BY client ORDER BY dt) IS DISTINCT FROM cond chain_start</code></pre><br>
<pre><code class="plaintext hljs">dt         | client | balance | cond | days | chain_start<font></font>
---------------------------------------------------------<font></font>
2020-01-01 |   |  150.00 | t    |    1 | t<font></font>
2020-01-02 |   |  100.00 | t    |    1 | f<font></font>
2020-01-03 |   |  200.00 | t    |    2 | f<font></font>
2020-01-05 |   |    0.00 | f    |    1 | t<font></font>
2020-01-06 |   |   50.00 | t    |    2 | t<font></font>
2020-01-08 |   |    0.00 | f    |    1 | t<font></font>
2020-01-09 |   |    0.00 | f    |    1 | f<font></font>
2020-01-10 |   |    5.00 | t    |    2 | t<font></font>
2020-01-01 |     |  100.00 | t    |    1 | t<font></font>
2020-01-02 |     |  150.00 | t    |    6 | f<font></font>
2020-01-08 |     |  200.00 | t    |    1 | f<font></font>
2020-01-09 |     |    0.00 | f    |    3 | t<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&gt;の代わりに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IS DISTINCT FROM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
演算子を使用して、</font><font style="vertical-align: inherit;">各クライアントの最初のレコードをNULLと比較する問題を回避しました。</font><font style="vertical-align: inherit;">したがって、値がTRUEであるすべての行は新しいチェーンの始まりであり、FALSEはその継続です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ4：リンクをつなぐ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
個々のチェーン内のデータをグループ化するに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのレコードに</font><b><font style="vertical-align: inherit;">同じ識別子</font></b><font style="vertical-align: inherit;">を割り当てるのが最も簡単</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">チェーン自体のシリアル番号はそれに最適です。</font><font style="vertical-align: inherit;">そして、それは</font><font style="vertical-align: inherit;">サンプルで上位に検出された</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェーンの「始まり」の数</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とまったく同じ</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらは、ブール値の合計の「ウィンドウ」合計（{boolean} ::整数）、またはカウント（*）FILTER（WHERE {boolean}条件に一致するレコードの数をカウントすることによって計算できます。</font><font style="vertical-align: inherit;">2番目のオプションを使用します。</font></font><br>
<br>
<pre><code class="sql hljs">count(*) FILTER(WHERE chain_start) OVER(PARTITION BY client ORDER BY dt) grpid</code></pre><br>
<pre><code class="plaintext hljs">dt         | client | balance | cond | days | chain_start | grpid<font></font>
-----------------------------------------------------------------<font></font>
2020-01-01 |   |  150.00 | t    |    1 | t           |     1<font></font>
2020-01-02 |   |  100.00 | t    |    1 | f           |     1<font></font>
2020-01-03 |   |  200.00 | t    |    2 | f           |     1<font></font>
2020-01-06 |   |   50.00 | t    |    2 | t           |     2<font></font>
2020-01-10 |   |    5.00 | t    |    2 | t           |     3<font></font>
2020-01-01 |     |  100.00 | t    |    1 | t           |     1<font></font>
2020-01-02 |     |  150.00 | t    |    6 | f           |     1<font></font>
2020-01-08 |     |  200.00 | t    |    1 | f           |     1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このステップでは、各チェーンのすべてのリンクの長さがわかっているので、「興味のない」レコードは不要なので、フィルターで除外します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ5：チェーンを置く</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェーン内のすべての日の平均を計算するには、合計日数と「積分」残高が必要です。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">client</span>
, <span class="hljs-keyword">min</span>(dt) chain_dt<font></font>
, <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">days</span> * balance) balance<font></font>
, <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">days</span>) <span class="hljs-keyword">days</span>
<span class="hljs-keyword">FROM</span><font></font>
  ...<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>, grpid
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>, grpid;</code></pre><br>
<pre><code class="plaintext hljs">client | chain_dt   | balance | days<font></font>
-------------------------------------<font></font>
  | 2020-01-01 |  650.00 |    4<font></font>
  | 2020-01-06 |  100.00 |    2<font></font>
  | 2020-01-10 |   10.00 |    2<font></font>
    | 2020-01-01 | 1200.00 |    8<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ6：適用される高値を探す</font></font></h2><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISTINCT ON</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を使用</font><font style="vertical-align: inherit;">して、クライアントごとに単一のレコード（最大日数）を残します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(<span class="hljs-keyword">client</span>)<font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ...<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">client</span>, <span class="hljs-keyword">days</span> <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs">client | chain_dt   | balance | days<font></font>
-------------------------------------<font></font>
  | 2020-01-01 |  650.00 |    4<font></font>
    | 2020-01-01 | 1200.00 |    8<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実はそれだけです、残っているのは...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組み合わせて最適化</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約リクエスト</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> step123 <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> cond <span class="hljs-keyword">THEN</span>
        lag(cond) <span class="hljs-keyword">OVER</span>(w) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> cond
    <span class="hljs-keyword">END</span> chain_start<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> cond <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">coalesce</span>(<span class="hljs-keyword">lead</span>(dt) <span class="hljs-keyword">OVER</span>(w), <span class="hljs-string">'2020-01-12'</span>) - dt
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">days</span>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  , <span class="hljs-keyword">LATERAL</span>(<span class="hljs-keyword">SELECT</span> balance &gt; <span class="hljs-number">0</span> cond) T
  <span class="hljs-keyword">WINDOW</span>
    w <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">client</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> dt)<font></font>
)<font></font>
, step4 <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  , <span class="hljs-keyword">count</span>(*) FILTER(<span class="hljs-keyword">WHERE</span> chain_start) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">client</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> dt) grpid
  <span class="hljs-keyword">FROM</span><font></font>
    step123<font></font>
  <span class="hljs-keyword">WHERE</span><font></font>
    cond<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(<span class="hljs-keyword">client</span>)
    <span class="hljs-keyword">client</span>
  , <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">days</span>) <span class="hljs-keyword">OVER</span>(w) <span class="hljs-keyword">days</span>
  , <span class="hljs-keyword">min</span>(dt) <span class="hljs-keyword">OVER</span>(w) chain_dt<font></font>
  , <span class="hljs-keyword">sum</span>(<span class="hljs-keyword">days</span> * balance) <span class="hljs-keyword">OVER</span>(w) balance
<span class="hljs-keyword">FROM</span><font></font>
  step4<font></font>
<span class="hljs-keyword">WINDOW</span>
  w <span class="hljs-keyword">AS</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">client</span>, grpid)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>, <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span>;
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、最初の3つのステップを組み合わせて最適化しました。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LATERALサブクエリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により、選択を不必要にパスすることなく追加のフィールドを計算し、関数ですぐに使用することができました</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WINDOWの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下での一般的な定義の削除により、</font><font style="vertical-align: inherit;">PostgreSQLが「ウィンドウ」を形成するために二重ソートを行わず、1つのWindowAggノードで両方の関数を計算することがなくなります。</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CASEでの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「レイジー」</font><b><font style="vertical-align: inherit;">関数の計算</font></b><font style="vertical-align: inherit;">により、実行される操作の数が減少します</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、次の2つのステップを組み合わせました。</font><font style="vertical-align: inherit;">しかし、集計（クライアント、grpid）と一意化（クライアント、合計（日））を計算するための「ウィンドウ」の順序は一致しなかったため、最後のブロックにはWindowAggの前とUniqueの前に2つのSortノードが残っています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8h/nq/2_/8hnq2_rny7scq8l_lo0qml_oayc.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
チェーンに番号を付ける場合</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、WHERE条件が最初に満たされる</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウ関数</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって生成される</font><font style="vertical-align: inherit;">番号</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">連続していることが</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">わかり</font></a><u><font style="vertical-align: inherit;">ます</font></u><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483444/index.html">2019 DORAレポート：DevOpsパフォーマンスを改善する方法</a></li>
<li><a href="../ja483446/index.html">科学者たちは飲料水中の鉄分を下げる新しい方法を発見しました</a></li>
<li><a href="../ja483452/index.html">ディザリング2：ゴールデンセクション行、ブルーノイズ、ハイパスおよびリマップ</a></li>
<li><a href="../ja483454/index.html">キリル文字でファイルを保存して、Atlassian BitbucketでMercurialからGITに切り替える</a></li>
<li><a href="../ja483458/index.html">GreenPigデータベースアシスタント</a></li>
<li><a href="../ja483462/index.html">黙ってお金を取って</a></li>
<li><a href="../ja483466/index.html">逆伝播法の紹介</a></li>
<li><a href="../ja483468/index.html">Flutter統合テスト-簡単です</a></li>
<li><a href="../ja483470/index.html">タイルを効率的に配置（Pro CSS、SVG、パターンなど）</a></li>
<li><a href="../ja483472/index.html">すべてを削除：データを消去してNVMe SSDを工場出荷時の設定に復元する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>