<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòá üë©üèª‚Äçü§ù‚Äçüë®üèæ üßëüèª N√≥s bombeamos a esteira üë®‚Äçüë®‚Äçüë¶ ‚åöÔ∏è üëä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, eu decidi fazer uma compra muito estranha para mim. Sim, eu comprei uma esteira. 
 
 
 
 E logo percebi que n√£o havia estat√≠sticas detal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>N√≥s bombeamos a esteira</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recentemente, eu decidi fazer uma compra muito estranha para mim. </font><font style="vertical-align: inherit;">Sim, eu comprei uma esteira. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E logo percebi que n√£o havia estat√≠sticas detalhadas suficientes ao andar de bicicleta. </font><font style="vertical-align: inherit;">No caso de uma bicicleta, o aplicativo no telefone grava minha velocidade, frequ√™ncia card√≠aca, cad√™ncia e eleva√ß√£o. </font><font style="vertical-align: inherit;">√â muito curioso controlar todos esses par√¢metros durante o treinamento, para poder visualizar gr√°ficos e comparar seus resultados periodicamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi fazer algo semelhante com a esteira: conecte-a a um smartphone ou tablet para coletar e exibir estat√≠sticas.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como sempre, minha hist√≥ria est√° na forma de um artigo de texto tradicional e por meio de v√≠deo. </font><font style="vertical-align: inherit;">Como voc√™ gosta mais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√≠deo</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artigo</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projeto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo no momento em que eu estava coletando a esteira, notei que o controle remoto e a pr√≥pria esteira conectavam apenas quatro fios. Aparentemente, alguns deles s√£o usados ‚Äã‚Äãpara alimentar o console, porque a tela em si est√° conectada √† rede de 220 volts e os fios restantes s√£o necess√°rios para transmitir sinais de controle na dire√ß√£o oposta - do console para a tela, eles controlam a velocidade e o √¢ngulo da pista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liguei o oscilosc√≥pio paralelo a esses fios, tentando diferentes combina√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, descobri que tudo era o mesmo que eu esperava. Um dos fios √© aterrado e o outro √© de 12 volts. O restante transmite dados digitais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um deles, o sinal muda ao alternar velocidade e √¢ngulo. </font><font style="vertical-align: inherit;">√â exatamente disso que eu preciso! </font><font style="vertical-align: inherit;">A amplitude do sinal √© de cerca de quatro volts. </font><font style="vertical-align: inherit;">Mas o protocolo n√£o parece algo padr√£o, e o sinal √© muito barulhento, quando a faixa est√° ligada, voc√™ precisa filtr√°-lo de alguma forma. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O √∫ltimo fio √© apenas pulsos com uma frequ√™ncia constante. </font><font style="vertical-align: inherit;">Aparentemente, para o console ver a conex√£o com o cinto de corrida. </font><font style="vertical-align: inherit;">Se voc√™ desconectar esse fio, o controle remoto emitir√° um erro imediatamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As indica√ß√µes do sensor de pulso nesses fios n√£o s√£o claramente transmitidas, mas n√£o s√£o necess√°rias. </font><font style="vertical-align: inherit;">√â melhor conectar um sensor tor√°cico separado, que uso h√° muito tempo ao andar de bicicleta. </font><font style="vertical-align: inherit;">Al√©m disso, descobriu-se que o sensor de frequ√™ncia card√≠aca na pr√≥pria esteira est√° mentindo bastante, subestimando as leituras.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montagem do dispositivo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a pr√≥xima tarefa √© montar uma placa que se conecte paralelamente a esses fios, leia a velocidade e o √¢ngulo atuais e, de alguma forma, os transfira sem fio para um tablet ou smartphone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais uma vez, decidi usar o computador de bordo √∫nico Onion Omega2. Ele deve fazer um excelente trabalho. S√≥ √© necess√°rio baixar a tens√£o de alimenta√ß√£o para 3,3 volts e filtrar os dados contra interfer√™ncias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reduzir a tens√£o, agora uso essas placas prontas com um conversor DC-DC. Eles custam um centavo, podem suportar at√© dois amperes e a tens√£o de sa√≠da √© ajustada com um toque. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, este painel tem conclus√µes para soldar diretamente para outro painel, √© muito conveniente. O principal √© n√£o torcer a tor√ß√£o de tens√£o ap√≥s a instala√ß√£o no circuito.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para filtrar o ru√≠do na linha de dados, criei um filtro RC comum: um resistor de 2,2 kg-ohm e um capacitor de 22 picofarad. </font><font style="vertical-align: inherit;">Isso deve filtrar o ru√≠do de alta frequ√™ncia, deixando um sinal de baixa frequ√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acabou um cachecol bem pequeno. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectei-o aos fios da esteira para ver qu√£o bem o sinal √© filtrado quando √© ligado e, aparentemente, a forma de onda se tornou quase perfeita.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo Kernel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, n√£o √© t√£o f√°cil verificar o desempenho do ferro. Como vimos </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
anteriormente no oscilosc√≥pio, os sinais passam muito rapidamente e n√£o usamos um microcontrolador, mas um computador Omega2 de placa √∫nica com Linux a bordo. No Linux, n√£o conseguiremos processar sinais do espa√ßo do usu√°rio t√£o rapidamente. Mas a partir do n√∫cleo, podemos! Portanto, √© hora de escrever um m√≥dulo do kernel Linux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, voc√™ precisa fazer o download das fontes do kernel Linux, no nosso caso, este √© um assembly OpenWRT para Omega2 e criar um diret√≥rio com o c√≥digo-fonte do nosso m√≥dulo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrever c√≥digo de m√≥dulo √© muito parecido com programar um microcontrolador. Tamb√©m escrevemos em C, tamb√©m tudo √© de baixo n√≠vel, tamb√©m trabalhamos com interrup√ß√µes e tamb√©m chegamos √†s conclus√µes do GPIO. Somente aqui, al√©m de todos os itens acima, ainda estamos interagindo com o espa√ßo do usu√°rio por meio de um pseudo-arquivo. Assim, nosso m√≥dulo do kernel se torna um tipo de adaptador entre o hardware e os aplicativos comuns. Na verdade, isso √© chamado de driver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, eu n√£o sabia como decodificar os sinais, ent√£o deduzi sua dura√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logo ficou claro que os sinais eram codificados com dura√ß√£o de alto n√≠vel. Tem 600 microssegundos de comprimento ou 1200 microssegundos de comprimento. O n√≠vel baixo √© sempre de 600 microssegundos, exceto para a sequ√™ncia inicial.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um total de 17 desses cai para cima e para baixo. </font><font style="vertical-align: inherit;">Aparentemente, s√£o 16 bits de dados mais a sequ√™ncia inicial. </font><font style="vertical-align: inherit;">Fiz a decodifica√ß√£o deles, tendo como base que diferen√ßas longas e altas s√£o um zero l√≥gico, e pequenas s√£o uma unidade l√≥gica e entendi o que aconteceu. </font><font style="vertical-align: inherit;">Vi imediatamente os dados que precisava! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16 bits s√£o, como voc√™ sabe, dois bytes. </font><font style="vertical-align: inherit;">O primeiro byte indica o tipo de dados que est√° sendo transmitido: o √¢ngulo de inclina√ß√£o ou velocidade e o segundo byte, os dados em si. </font><font style="vertical-align: inherit;">O motorista √© extremamente simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O √∫nico par√¢metro do driver √© o n√∫mero da porta.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao inicializar, configure-o para entrada e defina a interrup√ß√£o, que ser√° acionada toda vez que o n√≠vel for alterado.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta interrup√ß√£o, primeiro olhamos para a hora atual. Em seguida, usamos esse valor para calcular quanto tempo se passou desde a √∫ltima interrup√ß√£o acionada e coloc√°-lo em uma matriz. Obviamente, lembramos da hora atual para o c√°lculo da pr√≥xima vez. Al√©m disso, voc√™ deve reiniciar o cron√¥metro especial.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O truque √© que, se o cron√¥metro ainda funcionar, isso significa que n√£o houve queda de n√≠vel no pino por muito tempo e, portanto, √© hora de processar as informa√ß√µes coletadas. </font><font style="vertical-align: inherit;">Na fun√ß√£o que o timer chama, verifica-se que houve exatamente 34 quedas, ap√≥s as quais examinamos quanto tempo cada intervalo durou. </font><font style="vertical-align: inherit;">Se houver 600 microssegundos, depois 1200 microssegundos, levaremos 900 para o exterior. Se o intervalo for menor, escreveremos um no resultado, deslocando-o um pouco. </font><font style="vertical-align: inherit;">Ap√≥s o processamento de cada intervalo, enviamos o resultado para abrir pseudo-arquivos, transferindo dados para o espa√ßo do usu√°rio.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor Python e detec√ß√£o de velocidade</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta ent√£o escrever um script Python que os leia do pseudo-arquivo e os envie pela rede como seq√º√™ncias JSON. Parece que tudo √© bastante direto. No entanto, se tudo √© simples com o √¢ngulo de inclina√ß√£o e o valor no segundo byte corresponde exatamente ao √¢ngulo de inclina√ß√£o como porcentagem, ent√£o com a velocidade tudo se tornou muito mais confuso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um valor de 9 corresponde a um quil√¥metro por hora e um valor de 160 corresponde a 18 quil√¥metros por hora. Ou seja, a depend√™ncia dos dados na velocidade real n√£o √© de todo √≥bvia. Escrevi todos os valores manualmente, os levei ao Excel, plotados e obtive uma curva muito desigual.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E h√° velocidades quando as leituras no controle remoto s√£o diferentes, mas os dados e a velocidade da pista permanecem os mesmos! Por exemplo, 5,2 km / he 5,3 km / h s√£o realmente as mesmas velocidades. Em todos os lugares trapaceando. Gostaria de saber que velocidade realmente existe? Me√ßa de alguma forma, mas deixe para depois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m dessa transfer√™ncia de papagaios para quil√¥metros por hora, o script acabou sendo extremamente simples. Lemos os dados do pseudo-arquivo do Linux, decodificamos, aceitamos conex√µes de rede e transferimos os dados para os clientes conectados pela rede como uma string JSON.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acho que nenhuma autoriza√ß√£o e seguran√ßa s√£o necess√°rias aqui. </font><font style="vertical-align: inherit;">O estado da esteira n√£o √© o tipo de dados que eu gostaria de proteger dos hackers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colocamos esse script na inicializa√ß√£o e removemos a placa dentro da esteira. </font><font style="vertical-align: inherit;">Infelizmente, ele se encaixa apenas em um tubo de metal que conecta o console ao tapete rolante. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ sabe, o metal protege o sinal de r√°dio, ent√£o tirei a antena Wi-Fi do cano, mas por baixo de uma caixa de pl√°stico que oculta os fios. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta esteira diretamente "inteligente" est√° pronta. </font><font style="vertical-align: inherit;">Ela j√° sabe como distribuir estat√≠sticas pela rede. </font><font style="vertical-align: inherit;">Resta apenas escrever um cliente para ela!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente Android</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que, na minha opini√£o, deveria ser esse cliente. </font><font style="vertical-align: inherit;">Este √© um aplicativo Android que executarei em um tablet ou smartphone e o colocarei no topo da tela da esteira, respectivamente, deve exibir todas as informa√ß√µes sobre os exerc√≠cios na tela, substituindo a tela da pr√≥pria esteira. </font><font style="vertical-align: inherit;">O aplicativo deve poder trabalhar em segundo plano para que eu possa assistir ao v√≠deo enquanto corro sem problemas. </font><font style="vertical-align: inherit;">Al√©m disso, ele deve manter estat√≠sticas detalhadas das corridas, sincronizando tudo com a nuvem e desenhando gr√°ficos da depend√™ncia do pulso na velocidade e no √¢ngulo de inclina√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cora√ß√£o de tal aplicativo deve ser um servi√ßo que √© executado em segundo plano, se conecta √† esteira em um loop sem fim, recebe dados e os decodifica. </font><font style="vertical-align: inherit;">N√£o h√° dificuldades particulares nisso.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor de frequ√™ncia card√≠aca</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A coisa mais dif√≠cil foi trabalhar de repente com um sensor de frequ√™ncia card√≠aca. </font><font style="vertical-align: inherit;">Muitas armadilhas foram descobertas. </font><font style="vertical-align: inherit;">Eu tenho um monitor card√≠aco no peito aqui: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
uso-o h√° muito tempo quando ando de bicicleta. </font><font style="vertical-align: inherit;">√â bastante padr√£o, funciona no BLE √† Bluetooth Low Enegy, pode ser emparelhado com um telefone e um navegador Garmin sem problemas. </font><font style="vertical-align: inherit;">Eu n√£o conseguia nem pensar que trabalhar com ele a partir do meu aplicativo seria t√£o √≥bvio. </font><font style="vertical-align: inherit;">Esses sensores possuem GUIDs padr√£o para diferentes leituras. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar a receber uma frequ√™ncia card√≠aca, voc√™ deve primeiro configurar seu monitor de freq√º√™ncia card√≠aca para enviar periodicamente leituras. </font><font style="vertical-align: inherit;">Eu poderia fazer isso apenas estudando exemplos n√£o √∫teis e digitando.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, escrevi uma aula para trabalhar com um sensor de frequ√™ncia card√≠aca, que automaticamente tenta se conectar a ele e relata periodicamente a freq√º√™ncia card√≠aca atual.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto a estat√≠sticas e gr√°ficos. </font><font style="vertical-align: inherit;">Decidi n√£o reinventar o volante, mas usar o que j√° uso ao andar de bicicleta, ou seja, de alguma forma fazer amizade com o maravilhoso aplicativo Samsung Health. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora provavelmente parecer√° que estou anunciando a Samsung novamente. </font><font style="vertical-align: inherit;">Mas em uma bicicleta, esse aplicativo realmente se provou muito bem. </font><font style="vertical-align: inherit;">Para minha surpresa, ele se conecta a todos os sensores sem problemas, mostra a cad√™ncia e a velocidade das rodas e dita as estat√≠sticas nos fones de ouvido, mostra as mesmas estat√≠sticas nos gr√°ficos e fornece realiza√ß√µes e armazena tudo na nuvem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesquisa mostrou que o Samsung Health possui seu pr√≥prio SDK, que, embora n√£o seja totalmente intelig√≠vel, ainda est√° documentado: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhar com ele √© essencialmente trabalhar com um banco de dados que armazena uma variedade de leituras, desde as etapas realizadas e as medi√ß√µes da freq√º√™ncia card√≠aca at√© as fases do a√ß√∫car no sangue e do sono. </font><font style="vertical-align: inherit;">Mas agora estamos interessados ‚Äã‚Äãem registros de exerc√≠cios, que incluem valores escalares, como tipo de exerc√≠cio, tempo, dist√¢ncia, dura√ß√£o, calorias queimadas e matrizes de dados ao vivo, como hist√≥rico de freq√º√™ncia card√≠aca, velocidade e coordenadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos esses dados devem ser armazenados e preparados corretamente. </font><font style="vertical-align: inherit;">Alguns precisam ser calculados.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√°lculo da altura</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, altura de eleva√ß√£o. </font><font style="vertical-align: inherit;">Na esteira, sabemos o √¢ngulo de subida em cada ponto no tempo, medido em porcentagem. </font><font style="vertical-align: inherit;">A porcentagem do √¢ngulo de eleva√ß√£o √© a raz√£o da dist√¢ncia percorrida at√© a subida. </font><font style="vertical-align: inherit;">Acontece que a velocidade vertical √© igual √† velocidade usual multiplicada pela inclina√ß√£o em porcentagem e dividida por cem. </font><font style="vertical-align: inherit;">Conhecendo a velocidade vertical, podemos calcular a altura atual a cada momento no tempo. </font><font style="vertical-align: inherit;">Como resultado, ele deve ser inserido nas coordenadas atuais, apesar do fato de que durante o exerc√≠cio elas n√£o mudam e n√£o s√£o levadas em considera√ß√£o. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resposta a esses dados, o aplicativo Samsung Health mostrar√° o quanto supostamente subi, bem como a velocidade vertical em cada momento do treinamento.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contagem de calorias</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas como contar calorias? Al√©m disso, a contagem de calorias √© uma obriga√ß√£o para a Samsung Health. Ao mesmo tempo, as calorias queimadas s√£o um indicador muito impreciso, que depende de muitos fatores diferentes. N√£o tenho certeza se faz sentido cont√°-los. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu n√£o criei algo pr√≥prio e apenas pesquisei na calculadora (https://42.195km.net/e/treadsim/) e copiei o algoritmo do meu javascript (https://42.195km.net/e/treadsim/treadsim107 .js). Na entrada, ele mede a dist√¢ncia percorrida, o √¢ngulo de eleva√ß√£o e ... o peso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu poderia definir meu peso manualmente, mas, como estamos trabalhando com a Samsung Health, posso tirar meu peso atual de l√°. </font><font style="vertical-align: inherit;">Afinal, eu uso escalas inteligentes da Xiaomi, que s√£o sincronizadas com o Google Fit no meu telefone, o Google FIt atrav√©s de um aplicativo separado √© sincronizado com o Samsung Health, o Samsung Health atrav√©s da nuvem √© sincronizado consigo mesmo no tablet, onde meu aplicativo j√° o est√° recebendo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apar√™ncia do aplicativo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visualmente, a tarefa do aplicativo √© exibir em larga escala as principais indica√ß√µes: velocidade, √¢ngulo, frequ√™ncia card√≠aca, dist√¢ncia, calorias. √â melhor fazer isso em branco sobre fundo preto, para que o consumo da bateria ao usar a tela AMOLED seja m√≠nimo, porque √© claro que indicamos que, ao exibir nossa atividade, a tela deve ser ligada constantemente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os bot√µes s√£o ocultados automaticamente quando a esteira est√° ativa. Voc√™ pode iniciar e parar o treinamento apenas na velocidade zero.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, claro, voc√™ precisa dar suporte ao modo "imagem na imagem". Isso √© feito em apenas algumas linhas. Voc√™ s√≥ precisa indicar no manifesto que a atividade suporta esse modo e, no c√≥digo, entrar nele ao minimizar o aplicativo. Como resultado, voc√™ pode assistir, por exemplo, ao YouTube e ver as leituras da esteira em um canto da tela. Descobriu-se muito conveniente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, nessa fase, finalmente fui surpreendido pela dor do desenvolvedor do Android, porque j√° tenho quatro tamanhos de tela diferentes: o telefone e o tablet no modo normal e eles tamb√©m est√£o no modo "imagem na imagem". E aconteceu que, se eu selecionar o tamanho da fonte normal para um tamanho de tela, em outros casos tudo ser√° muito pequeno e muito grande.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao desenvolver para Android, existem v√°rias categorias de telas e voc√™ pode fazer configura√ß√µes diferentes se aplicarem automaticamente a elas, mas no meu caso isso n√£o foi suficiente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, tive que calcular e definir os tamanhos das fontes no c√≥digo, o que acho muito errado. </font><font style="vertical-align: inherit;">No entanto, funciona perfeitamente como resultado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui est√° o resultado. </font><font style="vertical-align: inherit;">Abrimos o aplicativo, aguardamos a conex√£o com a esteira e o sensor de frequ√™ncia card√≠aca, iniciamos o treinamento e usamos a esteira como de costume. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final do treino, paramos a esteira. </font><font style="vertical-align: inherit;">Ao atingir a velocidade zero, o bot√£o "concluir treinamento" ser√° exibido. </font><font style="vertical-align: inherit;">Clique nele e as estat√≠sticas s√£o enviadas para o Samsung Health. </font><font style="vertical-align: inherit;">Abra-o e veja todos os dados. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ver o gr√°fico do pulso, velocidade e aumento, comparar seu progresso em diferentes intervalos de tempo, tudo isso √© armazenado na nuvem e acess√≠vel a partir de todos os dispositivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode sincroniz√°-lo com o Google Fit. </font><font style="vertical-align: inherit;">A beleza. </font><font style="vertical-align: inherit;">Estou satisfeito com o resultado. </font><font style="vertical-align: inherit;">Agora, o principal n√£o √© dar aulas. </font><font style="vertical-align: inherit;">Voc√™ pode adicionar √† funcionalidade do aplicativo para que ele se assemelhe ao treinamento, se eu for pregui√ßoso por um longo tempo. </font><font style="vertical-align: inherit;">Mas j√° estou com pregui√ßa de fazer essa fun√ß√£o.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt502354/index.html">Os provedores de IaaS est√£o lutando pelo mercado europeu - discutindo a situa√ß√£o e os eventos do setor</a></li>
<li><a href="../pt502358/index.html">Implementa√ß√£o do MVP com base em ApplicationController e IoC em um aplicativo WinForms</a></li>
<li><a href="../pt502360/index.html">Descargas pardas ou Super Drill</a></li>
<li><a href="../pt502362/index.html">Rastreamento de eventos de aprendizagem para Windows: teoria e pr√°tica</a></li>
<li><a href="../pt502366/index.html">Compare o trabalho do Python de c√≥digo aberto - bibliotecas para o reconhecimento de entidades nomeadas</a></li>
<li><a href="../pt502370/index.html">Colocando o jogo "Cobra" na t√°bua de p√£o. Parte 1: m√°quinas de estado</a></li>
<li><a href="../pt502372/index.html">Problemas e princ√≠pios de personaliza√ß√£o da vers√£o em caixa do Bitrix24</a></li>
<li><a href="../pt502374/index.html">Protocolo de Comunica√ß√£o FT8 - Como funciona</a></li>
<li><a href="../pt502380/index.html">Aipo + asyncio</a></li>
<li><a href="../pt502382/index.html">Interface Bikes Toxic Grandfather. "Mentiras, amea√ßas e chantagem." (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>