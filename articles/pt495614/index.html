<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥ üé∑ ‚ñ´Ô∏è Manual do FFmpeg libav üÜï üëå ‚ò£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Longo Procurei um livro que iria ser mastigados usar FFmpeg -como biblioteca conhecido como libav (o nome significa lib rary um udio v ideo ). Encontr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Manual do FFmpeg libav</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/edison/blog/495614/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><div style="text-align:center;"><img width="779" height="232" src="https://habrastorage.org/webt/yn/ed/vp/ynedvpoyntkab2ppkqxuqtrbwma.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Longo Procurei um livro que iria ser mastigados usar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -como biblioteca conhecido como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o nome significa </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rary </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> udio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Encontrou um livro " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como escrever um player de v√≠deo e caber em menos de mil linhas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Infelizmente, as informa√ß√µes est√£o desatualizadas, ent√£o tive que criar um manual por conta pr√≥pria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maior parte do c√≥digo estar√° em C, mas n√£o se preocupe: voc√™ pode entender e aplic√°-lo facilmente no seu idioma favorito. O libF do FFmpeg possui muitas liga√ß√µes para v√°rios idiomas (incluindo Python e Go). Mas mesmo que seu idioma n√£o tenha compatibilidade direta, voc√™ ainda pode </font><font style="vertical-align: inherit;">se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conectar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> via </font><b><font style="vertical-align: inherit;">ffi</font></b><font style="vertical-align: inherit;"> (aqui est√° um exemplo com</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com uma breve digress√£o sobre o que s√£o v√≠deo, √°udio, codecs e cont√™ineres. </font><font style="vertical-align: inherit;">Em seguida, prosseguimos para o curso intensivo sobre o uso da linha de comando FFmpeg e, finalmente, escrevemos o c√≥digo. </font><font style="vertical-align: inherit;">Sinta-se √† vontade para ir direto para a se√ß√£o "O caminho espinhoso para aprender o libav do FFmpeg". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° uma opini√£o (e n√£o apenas a minha) de que o streaming de v√≠deo na Internet j√° tomou o bast√£o da televis√£o tradicional. </font><font style="vertical-align: inherit;">Seja como for, vale a pena explorar o libav do FFmpeg.</font></font><a name="menu"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√çndice</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√≠deo √© o que voc√™ v√™!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Åudio √© o que voc√™ ouve!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - Compacta√ß√£o de dados</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um cont√™iner √© uma maneira conveniente de armazenar √°udio / v√≠deo</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linha de comando ffmpeg</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramenta de linha de comando FFmpeg 101</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opera√ß√µes b√°sicas em v√≠deo</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodifica√ß√£o</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexa√ß√£o</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transizing</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√¥nus: streaming adapt√°vel</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indo al√©m</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   FFmpeg libav</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> 0 ‚Äî  ¬´Hello World¬ª</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FFmpeg libav </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, </a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> 1 ‚Äî    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> 2 ‚Äî </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> 3 ‚Äî </a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
</ul></li>
</ul></li>
</ul><a name="intro"></a><a name="video"></a><a name="habracut"></a><blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" title="EDISON Software - desenvolvimento web"><img align="left" width="153" height="75" src="https://habrastorage.org/webt/w0/zl/to/w0zltoxvysbr0yeinstkfvw1wbg.png" alt="EDISON Software - desenvolvimento web"></a><br clear="right">
     EDISON.<br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  ,  </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   </a>.<br>
<br>
     ! ;-)</blockquote><img align="right" width="210" height="280" src="https://habrastorage.org/webt/5k/lz/nu/5klznusfiwgawobmtbcrpdboscw.jpeg"><br clear="left">
<h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a></h2><br>
<h3> ‚Äî  ,   ! <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚Üë</a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a sequ√™ncia de imagens for alterada em uma determinada frequ√™ncia (digamos, 24 imagens por segundo), √© criada uma ilus√£o de movimento. </font><font style="vertical-align: inherit;">Esta √© a id√©ia principal do v√≠deo: uma s√©rie de imagens (quadros) movendo-se a uma determinada velocidade. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ilustra√ß√£o de 1886.</font></font></i><br>
<br>
<a name="audio"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Åudio √© o que voc√™ ouve! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o v√≠deo silencioso possa causar uma grande variedade de sentimentos, a adi√ß√£o de som aumenta drasticamente o grau de prazer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O som √© ondas vibracionais que se propagam no ar ou em qualquer outro meio de transmiss√£o (como g√°s, l√≠quido ou s√≥lido). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um sistema de √°udio digital, um microfone converte o som em um sinal el√©trico anal√≥gico. </font><font style="vertical-align: inherit;">Ent√£o, um conversor anal√≥gico-digital ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - geralmente usando modula√ß√£o por c√≥digo de pulso ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - converte um sinal anal√≥gico em digital.</font></font><br>
<br>
<div style="text-align:center;"><img width="640" height="220" src="https://habrastorage.org/webt/eu/gb/_m/eugb_mwqa5x5yctawseum7qdtss.png"></div><br>
<a name="codec"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - compacta√ß√£o de dados </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um codec √© um circuito eletr√¥nico ou software que comprime ou descomprime o √°udio / v√≠deo digital. </font><font style="vertical-align: inherit;">Ele converte √°udio / v√≠deo digital bruto (n√£o compactado) em um formato compactado (ou vice-versa). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se decidirmos agrupar milh√µes de imagens em um arquivo e cham√°-lo de filme, podemos obter um arquivo enorme. </font><font style="vertical-align: inherit;">Vamos calcular: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
digamos que criamos um v√≠deo com uma resolu√ß√£o de 1080 √ó 1920 (altura √ó largura). </font><font style="vertical-align: inherit;">Gastamos 3 bytes por pixel (o ponto m√≠nimo na tela) para codifica√ß√£o de cores (cores de 24 bits, o que nos d√° </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16.777.216</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cores diferentes). </font><font style="vertical-align: inherit;">Este v√≠deo funciona a uma velocidade de 24 quadros por segundo, a dura√ß√£o total de 30 minutos.</font></font><br>
<br>
<pre><code class="cpp hljs">toppf = <span class="hljs-number">1080</span> * <span class="hljs-number">1920</span> <span class="hljs-comment">//    </span>
cpp = <span class="hljs-number">3</span> <span class="hljs-comment">//  </span>
tis = <span class="hljs-number">30</span> * <span class="hljs-number">60</span> <span class="hljs-comment">//   </span>
fps = <span class="hljs-number">24</span> <span class="hljs-comment">//   </span><font></font>
<font></font>
required_storage = tis * fps * toppf * cpp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este v√≠deo exigir√° aproximadamente 250,28 GB de mem√≥ria ou 1,11 Gb / s! </font><font style="vertical-align: inherit;">√â por isso que voc√™ precisa usar um codec.</font></font><br>
<br>
<a name="container"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um cont√™iner √© uma maneira conveniente de armazenar √°udio / v√≠deo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O formato do cont√™iner (wrapper) √© um formato de metarquivo cuja especifica√ß√£o descreve como v√°rios elementos de dados e metadados coexistem em um arquivo de computador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um arquivo √∫nico que cont√©m todos os fluxos (principalmente √°udio e v√≠deo), fornecendo sincroniza√ß√£o, contendo metadados comuns (como t√≠tulo, resolu√ß√£o) etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, o formato do arquivo √© determinado por sua extens√£o: por exemplo, video.webm √© provavelmente um v√≠deo usando o cont√™iner de webm.</font></font><br>
<br>
<div style="text-align:center;"><img width="621" height="328" src="https://habrastorage.org/webt/ay/du/qa/ayduqaajbhuh59tah4vdgcu2sj0.png"></div><br>
<a name="command_line"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linha de comando FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solu√ß√£o independente de plataforma cruzada para grava√ß√£o, convers√£o e streaming de √°udio / v√≠deo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para trabalhar com multim√≠dia, temos uma ferramenta incr√≠vel - uma biblioteca chamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mesmo se voc√™ n√£o o usar no c√≥digo do programa, ainda o usar√° (voc√™ est√° usando o Chrome?). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A biblioteca possui um programa de console para inserir uma linha de comando chamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (em letras min√∫sculas, em contraste com o nome da pr√≥pria biblioteca). </font><font style="vertical-align: inherit;">Este √© um bin√°rio simples e poderoso. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode converter de mp4 para avi digitando este comando:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg -i input.mp4 output.avi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s apenas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remixamos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - convertidos de um cont√™iner para outro. </font><font style="vertical-align: inherit;">Tecnicamente, o FFmpeg tamb√©m pode transcodificar, mas mais sobre isso posteriormente.</font></font><br>
<br>
<a name="101"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramenta de linha de comando FFmpeg 101 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O FFmpeg possui </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> onde tudo √© perfeitamente explicado como o que funciona. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esquematicamente, o programa de linha de comando FFmpeg espera que o seguinte formato de argumento fa√ßa seu trabalho - </font></font><code><b>ffmpeg {1} {2} -i {3} {4} {5}</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onde: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{1}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - par√¢metros globais </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{2}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - par√¢metros do arquivo de entrada </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{3}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - URL de entrada </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{4}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - par√¢metros do arquivo de sa√≠da </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{5}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - de sa√≠da As </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
partes do </font><font style="vertical-align: inherit;">URL </font><font style="vertical-align: inherit;">{2}, {3}, {4}, {5} especificam quantos argumentos s√£o necess√°rios. </font><font style="vertical-align: inherit;">√â mais f√°cil entender o formato de passar argumentos usando um exemplo: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVISO: um arquivo por refer√™ncia pesa 300 MB</font></font></b><br>
<br>
<pre><code class="bash hljs">$ wget -O bunny_1080p_60fps.mp4 http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4<font></font>
<font></font>
$ ffmpeg \<font></font>
-y \ <span class="hljs-comment">#  </span>
-c: libfdk_aac -c: v libx264 \ <span class="hljs-comment">#  </span>
-i bunny_1080p_60fps.mp4 \ <span class="hljs-comment">#  URL</span>
-c: v libvpx-vp9 -c: libvorbis \ <span class="hljs-comment">#  </span>
bunny_1080p_60fps_vp9.webm <span class="hljs-comment">#  URL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse comando pega um arquivo mp4 de entrada contendo dois fluxos (√°udio codificado usando o codec aac e v√≠deo codificado usando o codec h264) e o converte em webm, alterando tamb√©m os codecs de √°udio e v√≠deo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ simplificar o comando acima, considere que o FFmpeg aceitar√° os valores padr√£o em vez de voc√™. </font><font style="vertical-align: inherit;">Por exemplo, se voc√™ simplesmente digitar</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i input.avi output.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
qual codec de √°udio / v√≠deo ele usa para criar output.mp4? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werner Robitz escreveu um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guia de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> codifica√ß√£o e edi√ß√£o para leitura / execu√ß√£o com o FFmpeg.</font></font><br>
<br>
<a name="operations"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opera√ß√µes b√°sicas de v√≠deo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao trabalhar com √°udio / v√≠deo, geralmente executamos v√°rias tarefas relacionadas √† multim√≠dia.</font></font><br>
<br>
<a name="transcoding"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodifica√ß√£o (transcodifica√ß√£o) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<br>
<div style="text-align:center;"><img width="494" height="225" src="https://habrastorage.org/webt/uf/fl/cr/ufflcrik3ha4z6tt5axevtdfv9u.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© isso? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O processo de convers√£o de streaming ou √°udio ou v√≠deo (ou ambos ao mesmo tempo) de um codec para outro. </font><font style="vertical-align: inherit;">O formato do arquivo (cont√™iner) n√£o muda. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para qu√™? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ocorre que alguns dispositivos (TVs, smartphones, consoles etc.) n√£o suportam o formato de √°udio / v√≠deo X, mas suportam o formato de √°udio / v√≠deo Y. Ou ent√£o, os codecs mais recentes s√£o prefer√≠veis porque oferecem uma melhor taxa de compacta√ß√£o. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Converta, por exemplo, v√≠deo H264 (AVC) em H265 (HEVC):</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c:v libx265 \<font></font>
bunny_1080p_60fps_h265.mp4</code></pre><br>
<a name="transmuxing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexa√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="492" height="231" src="https://habrastorage.org/webt/es/vp/gm/esvpgmlkjcj38alzp2sbrdckpne.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© isso? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Converta de um formato (cont√™iner) para outro. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para qu√™? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ocorre que alguns dispositivos (TVs, smartphones, consoles etc.) n√£o oferecem suporte ao formato de arquivo X, mas ao formato de arquivo Y. Ou, cont√™ineres mais novos, diferentemente dos mais antigos, fornecem as fun√ß√µes modernas necess√°rias. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Converta um mp4 para webm:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c copy \ <span class="hljs-comment"># just saying to ffmpeg to skip encoding</span>
bunny_1080p_60fps.webm</code></pre><br>
<a name="transrating"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="437" height="235" src="https://habrastorage.org/webt/ev/hx/cp/evhxcp7a6y5fkjjq9s53hyfs3iq.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© isso? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Altere a taxa de dados ou crie outra vis√£o. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para qu√™? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O usu√°rio pode assistir ao seu v√≠deo em uma rede 2G em um smartphone de baixa pot√™ncia e via conex√£o de Internet de fibra √≥ptica em uma TV 4K. </font><font style="vertical-align: inherit;">Portanto, voc√™ deve oferecer mais de uma op√ß√£o para reproduzir o mesmo v√≠deo com taxas de dados diferentes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produz reprodu√ß√£o a uma taxa de bits entre 3856K e 2000K.</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-minrate 964K -maxrate 3856K -bufsize 2000K \<font></font>
bunny_1080p_60fps_transrating_964_3856.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalmente, o transrating √© feito em conjunto com a recalibra√ß√£o. </font><font style="vertical-align: inherit;">Werner Robitz escreveu outro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo obrigat√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre controle de velocidade FFmpeg.</font></font><br>
<br>
<a name="transsizing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transizing (recalibra√ß√£o) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="515" height="277" src="https://habrastorage.org/webt/gj/c2/4k/gjc24kcqli3iwwdkzbb70pbue-k.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© isso? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Altera√ß√£o de resolu√ß√£o. </font><font style="vertical-align: inherit;">Como afirmado acima, o transsizing √© frequentemente realizado simultaneamente com o transrating. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para qu√™? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelas mesmas raz√µes que com transrating. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduza a resolu√ß√£o de 1080 para 480:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-vf scale=480:-1 \<font></font>
bunny_1080p_60fps_transsizing_480.mp4</code></pre><br>
<a name="bonus"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√¥nus: streaming adapt√°vel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="750" height="134" src="https://habrastorage.org/webt/3z/az/lg/3zazlgpe3wjx3zvvhapi0z3ur68.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© isso? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cria√ß√£o de muitas permiss√µes (taxas de bits) e divis√£o da m√≠dia em partes e sua transmiss√£o atrav√©s do protocolo http. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para qu√™? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com o objetivo de fornecer multim√≠dia flex√≠vel que pode ser visualizada mesmo em um smartphone econ√¥mico, mesmo em um plasma 4K, para que possa ser facilmente dimensionado e implantado (mas isso pode adicionar um atraso). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√£o? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie WebM responsivo usando DASH:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># video streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 160x90 -b:v 250k -keyint_min 150 -g 150 -an -f webm -dash 1 video_160x90_250k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 320x180 -b:v 500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_320x180_500k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 750k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_750k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 1000k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_1000k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 1280x720 -b:v 1500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_1280x720_1500k.webm<font></font>
<font></font>
<span class="hljs-comment"># audio streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:a libvorbis -b:a 128k -vn -f webm -dash 1 audio_128k.webm<font></font>
<font></font>
<span class="hljs-comment"># the DASH manifest</span><font></font>
$ ffmpeg \<font></font>
 -f webm_dash_manifest -i video_160x90_250k.webm \<font></font>
 -f webm_dash_manifest -i video_320x180_500k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_750k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_1000k.webm \<font></font>
 -f webm_dash_manifest -i video_1280x720_500k.webm \<font></font>
 -f webm_dash_manifest -i audio_128k.webm \<font></font>
 -c copy -map 0 -map 1 -map 2 -map 3 -map 4 -map 5 \<font></font>
 -f webm_dash_manifest \<font></font>
 -adaptation_sets <span class="hljs-string">"id=0,streams=0,1,2,3,4 id=1,streams=5"</span> \<font></font>
 manifest.mpd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS: Peguei este exemplo das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instru√ß√µes para reproduzir o Adaptive WebM usando DASH</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="beyond"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indo al√©m </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° outros usos para o FFmpeg. </font><font style="vertical-align: inherit;">Eu o uso com o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iMovie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para criar / editar alguns v√≠deos do YouTube. </font><font style="vertical-align: inherit;">E, √© claro, nada impede voc√™ de us√°-lo profissionalmente.</font></font><br>
<br>
<a name="hard_way"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O caminho espinhoso de aprender libf FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o √© surpreendente, de tempos em tempos, percebido atrav√©s da audi√ß√£o e da vis√£o? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bi√≥logo David Robert Jones</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O FFmpeg √© extremamente √∫til como uma ferramenta de linha de comando para executar opera√ß√µes importantes com arquivos multim√≠dia. </font><font style="vertical-align: inherit;">Talvez tamb√©m possa ser usado em programas? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O FFmpeg consiste em v√°rias bibliotecas que podem ser integradas em nossos pr√≥prios programas. </font><font style="vertical-align: inherit;">Normalmente, quando voc√™ instala o FFmpeg, todas essas bibliotecas s√£o instaladas automaticamente. </font><font style="vertical-align: inherit;">Vou me referir a um conjunto dessas bibliotecas como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O t√≠tulo da se√ß√£o √© uma homenagem √† s√©rie de Zed Shaw, The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thorny Path of Learning, [...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em particular seu livro The Thorny Path of Learning C.</font></font><br>
<br>
<a name="chapter_0"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 0 - O Mundo Simples do Ol√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello World</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , voc√™ realmente n√£o aceita o mundo no idioma do console. </font><font style="vertical-align: inherit;">Em vez disso, imprima as seguintes informa√ß√µes sobre o v√≠deo: formato (cont√™iner), dura√ß√£o, resolu√ß√£o, canais de √°udio e, por fim, decodifique alguns quadros e salve-os como arquivos de imagem.</font></font><br>
<br>
<a name="architecture"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura de libav FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas antes de come√ßarmos a escrever o c√≥digo, vamos ver como a arquitetura libav do FFmpeg funciona em geral e como seus componentes interagem com os outros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um diagrama do processo de decodifica√ß√£o de v√≠deo:</font></font><br>
<div style="text-align:center;"><img width="750" height="424" src="https://habrastorage.org/webt/ej/1d/ek/ej1deksvwwqdctppaujla5v5tog.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, o arquivo de m√≠dia √© carregado em um componente chamado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o cont√™iner de v√≠deo tamb√©m √© um formato). De fato, ele n√£o faz o download completo do arquivo inteiro: geralmente apenas o cabe√ßalho √© lido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de baixar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cabe√ßalho m√≠nimo do nosso cont√™iner</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , voc√™ pode acessar seus fluxos (eles podem ser representados como dados elementares de √°udio e v√≠deo). Cada fluxo estar√° dispon√≠vel no componente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que nosso v√≠deo tenha dois fluxos: √°udio codificado usando o codec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e v√≠deo codificado usando o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codec H264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). De cada fluxo, podemos extrair peda√ßos de dados chamados </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pacotes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carregados em componentes chamados </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados dentro dos pacotes ainda est√£o codificados (compactados) e, para decodificar os pacotes, precisamos pass√°-los para um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espec√≠fico </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O AVCodec os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decodifica em um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como resultado desse componente nos fornece um quadro n√£o compactado. </font><font style="vertical-align: inherit;">Observe que a terminologia e o processo s√£o os mesmos para os fluxos de √°udio e v√≠deo.</font></font><br>
<br>
<a name="requirements"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requisitos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como √†s vezes h√° problemas ao compilar ou executar exemplos, usaremos o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como um ambiente de desenvolvimento / tempo de execu√ß√£o. </font><font style="vertical-align: inherit;">Tamb√©m usaremos um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo com um coelho grande</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; portanto, se voc√™ n√£o o tiver no computador local, basta executar o comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make fetch_small_bunny_video</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no console </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="code"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na verdade, o c√≥digo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">mostre-me um exemplo de c√≥digo execut√°vel, mano:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_hello</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Omitiremos alguns detalhes, mas n√£o se preocupe: o c√≥digo fonte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° dispon√≠vel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos alocar mem√≥ria para o componente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que conter√° informa√ß√µes sobre o formato (cont√™iner).</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *pFormatContext = avformat_alloc_context();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos abrir o arquivo, ler o cabe√ßalho e preencher o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informa√ß√µes m√≠nimas sobre o formato (observe que os codecs geralmente n√£o abrem). </font><font style="vertical-align: inherit;">Para fazer isso, use a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_open_input</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Espera </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um nome de arquivo e dois argumentos opcionais: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVInputFormat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (se voc√™ passar NULL, FFmpeg determinar√° o formato) e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVDictionary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (que s√£o op√ß√µes de desmultiplexador).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_open_input(&amp;pFormatContext, filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m pode imprimir o nome do formato e a dura√ß√£o da m√≠dia:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Format %s, duration %lld us"</span>, pFormatContext-&gt;iformat-&gt;long_name, pFormatContext-&gt;duration);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para acessar os fluxos, precisamos ler os dados da m√≠dia. </font><font style="vertical-align: inherit;">Isso √© feito pela fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_find_stream_info</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Agora </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; nb_streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conter√° o n√∫mero de threads, e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; streams [i]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos fornecer√° o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©simo fluxo em sequ√™ncia ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_find_stream_info(pFormatContext,  <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos percorrer o loop em todos os threads:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pFormatContext-&gt;nb_streams; i++) {
  <span class="hljs-comment">//</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada fluxo, salvaremos o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecParameters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que descreve as propriedades do codec usado pelo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©simo fluxo:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecParameters *pLocalCodecParameters = pFormatContext-&gt;streams[i]-&gt;codecpar;</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando as propriedades dos codecs, podemos encontrar o correspondente solicitando a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_decoder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tamb√©m podemos encontrar o decodificador registrado para o identificador de codec e retornar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um componente que sabe como codificar e decodificar o fluxo:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec *pLocalCodec = avcodec_find_decoder(pLocalCodecParameters-&gt;codec_id);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos imprimir as informa√ß√µes do codec:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// specific for video and audio</span>
<span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Video Codec: resolution %d x %d"</span>, pLocalCodecParameters-&gt;width, pLocalCodecParameters-&gt;height);<font></font>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Audio Codec: %d channels, sample rate %d"</span>, pLocalCodecParameters-&gt;channels, pLocalCodecParameters-&gt;sample_rate);<font></font>
}<font></font>
<span class="hljs-comment">// general</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\tCodec %s ID %d bit_rate %lld"</span>, pLocalCodec-&gt;long_name, pLocalCodec-&gt;id, pCodecParameters-&gt;bit_rate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando o codec, alocamos mem√≥ria para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que conter√° o contexto para o nosso processo de decodifica√ß√£o / codifica√ß√£o. </font><font style="vertical-align: inherit;">Mas voc√™ precisa preencher esse contexto de codec com par√¢metros </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CODEC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fazemos isso usando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_to_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de preencher o contexto do codec, voc√™ precisa abrir o codec. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamamos a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fun√ß√£o </font><b><font style="vertical-align: inherit;">avcodec_open2</font></b><font style="vertical-align: inherit;"> e podemos us√°-la:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecContext *pCodecContext = avcodec_alloc_context3(pCodec);<font></font>
avcodec_parameters_to_context(pCodecContext, pCodecParameters);<font></font>
avcodec_open2(pCodecContext, pCodec, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos ler pacotes do fluxo e decodific√°-los em quadros, mas primeiro precisamos alocar mem√≥ria para os dois componentes ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">AVPacket *pPacket = av_packet_alloc();<font></font>
AVFrame *pFrame = av_frame_alloc();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos alimentar nossos pacotes a partir dos fluxos da fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enquanto ela tiver os pacotes:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(av_read_frame(pFormatContext, pPacket) &gt;= <span class="hljs-number">0</span>) {
  <span class="hljs-comment">//...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora enviaremos o pacote de dados brutos (quadro compactado) para o decodificador atrav√©s do contexto do codec usando a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_send_packet(pCodecContext, pPacket);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E vamos obter um quadro de dados brutos (um quadro n√£o compactado) do decodificador atrav√©s do mesmo contexto de codec usando a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_receive_frame(pCodecContext, pFrame);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos imprimir o n√∫mero do quadro, PTS, DTS, tipo de quadro, etc.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(
    <span class="hljs-string">"Frame %c (%d) pts %d dts %d key_frame %d [coded_picture_number %d, display_picture_number %d]"</span>,<font></font>
    av_get_picture_type_char(pFrame-&gt;pict_type),<font></font>
    pCodecContext-&gt;frame_number,<font></font>
    pFrame-&gt;pts,<font></font>
    pFrame-&gt;pkt_dts,<font></font>
    pFrame-&gt;key_frame,<font></font>
    pFrame-&gt;coded_picture_number,<font></font>
    pFrame-&gt;display_picture_number<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, finalmente, podemos salvar nosso quadro decodificado em uma simples imagem cinza. </font><font style="vertical-align: inherit;">O processo √© muito simples: usaremos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFrame-&gt; data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde o √≠ndice est√° associado aos espa√ßos de cores </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Basta selecionar 0 (Y) para salvar nossa imagem cinza:</font></font><br>
<br>
<pre><code class="cpp hljs">save_gray_frame(pFrame-&gt;data[<span class="hljs-number">0</span>], pFrame-&gt;linesize[<span class="hljs-number">0</span>], pFrame-&gt;width, pFrame-&gt;height, frame_filename);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save_gray_frame</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> wrap, <span class="hljs-keyword">int</span> xsize, <span class="hljs-keyword">int</span> ysize, <span class="hljs-keyword">char</span> *filename)</span>
</span>{<font></font>
    FILE *f;<font></font>
    <span class="hljs-keyword">int</span> i;<font></font>
    f = fopen(filename,<span class="hljs-string">"w"</span>);
    <span class="hljs-comment">// writing the minimal required header for a pgm file format</span>
    <span class="hljs-comment">// portable graymap format -&gt; https://en.wikipedia.org/wiki/Netpbm_format#PGM_example</span>
    <span class="hljs-built_in">fprintf</span>(f, <span class="hljs-string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="hljs-number">255</span>);<font></font>
<font></font>
    <span class="hljs-comment">// writing line by line</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ysize; i++)<font></font>
        fwrite(buf + i * wrap, <span class="hljs-number">1</span>, xsize, f);<font></font>
    fclose(f);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E pronto! </font><font style="vertical-align: inherit;">Agora temos uma imagem em escala de cinza de 2 MB:</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="413" src="https://habrastorage.org/webt/gk/tf/i9/gktfi9xb3ylqmmzu927uc7aon9w.png"></div><br>
<a name="chapter_1"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 1 - Sincronizar √°udio e v√≠deo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estar no jogo √© quando um jovem desenvolvedor de JS grava um novo player de v√≠deo MSE.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de come√ßarmos a escrever o c√≥digo de transcodifica√ß√£o, vamos falar sobre sincroniza√ß√£o ou como o player de v√≠deo encontra o momento certo para reproduzir um quadro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No exemplo anterior, salvamos v√°rios quadros: </font></font><br>
<img width="194" height="110" src="https://habrastorage.org/webt/gj/yz/7h/gjyz7h4agcr6n2hdkmt9w9ko5ho.png"> <img width="194" height="110" src="https://habrastorage.org/webt/is/cl/yy/isclyy5ckz1_4w2mepv4msr2dba.png"> <img width="194" height="110" src="https://habrastorage.org/webt/7z/tr/mu/7ztrmukulalxo5qihbly0cpm_5w.png"> <img width="194" height="110" src="https://habrastorage.org/webt/u3/q8/pq/u3q8pqb2qxhroy1ycatplyeveco.png"> <img width="194" height="110" src="https://habrastorage.org/webt/uu/lh/ih/uulhihectxop1sphmmss_ipvfpc.png"> <img width="194" height="110" src="https://habrastorage.org/webt/9x/ss/bm/9xssbmfyxzra5frtcob9dirkxt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando projetamos um player de v√≠deo, precisamos reproduzir cada quadro em um determinado ritmo, caso contr√°rio, √© dif√≠cil apreciar o v√≠deo porque ele √© reproduzido muito r√°pido ou muito lentamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, precisamos definir alguma l√≥gica para uma reprodu√ß√£o suave de cada quadro. A este respeito, cada trama tem uma marca de representa√ß√£o de tempo ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a partir de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resenta√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ime </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tampo), que √© um n√∫mero crescente tidas em conta na vari√°vel</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© um n√∫mero racional (onde o denominador √© conhecido como escala de tempo - escala de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dividido pela </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taxa de quadros</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â mais f√°cil entender com exemplos. </font><font style="vertical-align: inherit;">Vamos simular alguns cen√°rios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 60/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/60000,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aumentar√° a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escala de tempo / fps = 1000</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para que o tempo real de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para cada quadro possa ser (desde que comece em 0):</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quase o mesmo cen√°rio, mas com </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escala de tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> igual a 1/60:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.050</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 25/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/75,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aumentar√° a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escala de tempo / fps = 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o tempo do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.04</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">6</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.08</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">9</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.12</span><font></font>
...<font></font>
frame=<span class="hljs-number">24</span>, PTS = <span class="hljs-number">72</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.96</span><font></font>
...<font></font>
frame=<span class="hljs-number">4064</span>, PTS = <span class="hljs-number">12192</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">162.56</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, com </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , podemos encontrar uma maneira de visualizar isso em sincronia com o som de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou com o rel√≥gio do sistema. </font><font style="vertical-align: inherit;">O libF do FFmpeg fornece essas informa√ß√µes por meio de sua API:</font></font><br>
<br>
<pre><code class="cpp hljs">fps = AVStream-&gt;avg_frame_rate<font></font>
tbr = AVStream-&gt;r_frame_rate<font></font>
tbn = AVStream-&gt;time_base</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por curiosidade, os quadros que salvamos foram enviados em ordem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (quadros: 1, 6, 4, 2, 3, 5), mas reproduzidos em ordem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (quadros: 1, 2, 3, 4, 5). </font><font style="vertical-align: inherit;">Observe tamb√©m quanto </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quadros </font><b><font style="vertical-align: inherit;">B</font></b><font style="vertical-align: inherit;"> mais baratos </font><font style="vertical-align: inherit;">s√£o comparados aos </font><font style="vertical-align: inherit;">quadros </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">LOG: AVStream-&gt;r_frame_rate <span class="hljs-number">60</span>/<span class="hljs-number">1</span>
LOG: AVStream-&gt;time_base <span class="hljs-number">1</span>/<span class="hljs-number">60000</span><font></font>
...<font></font>
LOG: Frame <span class="hljs-number">1</span> (type=I, size=<span class="hljs-number">153797</span> bytes) pts <span class="hljs-number">6000</span> key_frame <span class="hljs-number">1</span> [DTS <span class="hljs-number">0</span>]<font></font>
LOG: Frame <span class="hljs-number">2</span> (type=B, size=<span class="hljs-number">8117</span> bytes) pts <span class="hljs-number">7000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">3</span>]<font></font>
LOG: Frame <span class="hljs-number">3</span> (type=B, size=<span class="hljs-number">8226</span> bytes) pts <span class="hljs-number">8000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">4</span>]<font></font>
LOG: Frame <span class="hljs-number">4</span> (type=B, size=<span class="hljs-number">17699</span> bytes) pts <span class="hljs-number">9000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">2</span>]<font></font>
LOG: Frame <span class="hljs-number">5</span> (type=B, size=<span class="hljs-number">6253</span> bytes) pts <span class="hljs-number">10000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">5</span>]<font></font>
LOG: Frame <span class="hljs-number">6</span> (type=P, size=<span class="hljs-number">34992</span> bytes) pts <span class="hljs-number">11000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">1</span>]</code></pre><br>
<a name="chapter_2"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 2 - Remultiplexa√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remultiplexagem (rearranjo, remuxing) - a transi√ß√£o de um formato (cont√™iner) para outro. </font><font style="vertical-align: inherit;">Por exemplo, podemos substituir facilmente o v√≠deo MPEG-4 pelo MPEG-TS usando o FFmpeg:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo MP4 ser√° desmultiplexado, enquanto o arquivo n√£o ser√° decodificado ou codificado ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥pia -c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e, no final, obteremos o arquivo mpegts. </font><font style="vertical-align: inherit;">Se voc√™ n√£o especificar o formato </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-f</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o ffmpeg tentar√° adivinhar com base na extens√£o do arquivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O uso geral de FFmpeg ou libav segue esse padr√£o / arquitetura ou fluxo de trabalho:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√≠vel de protocolo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aceitando dados de entrada (por exemplo, um arquivo, mas tamb√©m pode ser download rtmp ou HTTP)</font></font></li>
<li><b> </b> ‚Äî  , ,  ,   </li>
<li><b> </b> ‚Äî       </li>
<li><b> </b> ‚Äî         (,  ),  </li>
<li>‚Ä¶        :</li>
<li><b> </b> ‚Äî  (    )  </li>
<li><b> </b> ‚Äî  ( )   ( )</li>
<li><b> </b> ‚Äî , ,      (   , ,    )</li>
</ul><br>
<img src="https://habrastorage.org/webt/u6/x4/g3/u6x4g3oijeetm1lpdvxnjo9hwls.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Este gr√°fico √© fortemente inspirado no trabalho de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leixiaohua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slhck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Agora vamos criar um exemplo usando libav para fornecer o mesmo efeito que ao executar este comando:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ler da entrada ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e alter√°-la para outra sa√≠da ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *input_format_context = <span class="hljs-literal">NULL</span>;<font></font>
AVFormatContext *output_format_context = <span class="hljs-literal">NULL</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, come√ßamos alocando mem√≥ria e abrindo o formato de entrada. </font><font style="vertical-align: inherit;">Para este caso espec√≠fico, vamos abrir o arquivo de entrada e alocar mem√≥ria para o arquivo de sa√≠da:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> ((ret = avformat_open_input(&amp;input_format_context, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open input file '%s'"</span>, in_filename);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<span class="hljs-keyword">if</span> ((ret = avformat_find_stream_info(input_format_context, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to retrieve input stream information"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<font></font>
avformat_alloc_output_context2(&amp;output_format_context, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);
<span class="hljs-keyword">if</span> (!output_format_context) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create output context\n"</span>);<font></font>
  ret = AVERROR_UNKNOWN;<font></font>
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remultiplexaremos apenas fluxos de v√≠deo, √°udio e legendas. </font><font style="vertical-align: inherit;">Portanto, corrigimos quais fluxos usaremos em uma matriz de √≠ndices:</font></font><br>
<br>
<pre><code class="cpp hljs">number_of_streams = input_format_context-&gt;nb_streams;<font></font>
streams_list = av_mallocz_array(number_of_streams, <span class="hljs-keyword">sizeof</span>(*streams_list));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imediatamente ap√≥s alocarmos a mem√≥ria necess√°ria, precisamos percorrer todos os fluxos e, para cada um deles, precisamos criar um novo fluxo de sa√≠da em nosso contexto do formato de sa√≠da usando a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Observe que sinalizamos todos os fluxos que n√£o s√£o de v√≠deo, √°udio ou legendas para que possamos ignor√°-los.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; input_format_context-&gt;nb_streams; i++) {<font></font>
  AVStream *out_stream;<font></font>
  AVStream *in_stream = input_format_context-&gt;streams[i];<font></font>
  AVCodecParameters *in_codecpar = in_stream-&gt;codecpar;<font></font>
  <span class="hljs-keyword">if</span> (in_codecpar-&gt;codec_type != AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) {<font></font>
    streams_list[i] = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  streams_list[i] = stream_index++;<font></font>
  out_stream = avformat_new_stream(output_format_context, <span class="hljs-literal">NULL</span>);
  <span class="hljs-keyword">if</span> (!out_stream) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed allocating output stream\n"</span>);<font></font>
    ret = AVERROR_UNKNOWN;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to copy codec parameters\n"</span>);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora crie o arquivo de sa√≠da:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (!(output_format_context-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) {<font></font>
  ret = avio_open(&amp;output_format_context-&gt;pb, out_filename, AVIO_FLAG_WRITE);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open output file '%s'"</span>, out_filename);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}<font></font>
<font></font>
ret = avformat_write_header(output_format_context, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error occurred when opening output file\n"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, voc√™ pode copiar fluxos, pacote por pacote, de nossa entrada para nossos fluxos de sa√≠da. </font><font style="vertical-align: inherit;">Isso acontece em um loop, desde que haja pacotes ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), para cada pacote voc√™ precisa recalcular o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para finalmente grav√°-lo ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) em nosso contexto do formato de sa√≠da.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
  AVStream *in_stream, *out_stream;<font></font>
  ret = av_read_frame(input_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">break</span>;<font></font>
  in_stream  = input_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-keyword">if</span> (packet.stream_index &gt;= number_of_streams || streams_list[packet.stream_index] &lt; <span class="hljs-number">0</span>) {<font></font>
    av_packet_unref(&amp;packet);<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  packet.stream_index = streams_list[packet.stream_index];<font></font>
  out_stream = output_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-comment">/* copy packet */</span><font></font>
  packet.pts = av_rescale_q_rnd(packet.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.dts = av_rescale_q_rnd(packet.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.duration = av_rescale_q(packet.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);<font></font>
  <span class="hljs-comment">// https://ffmpeg.org/doxygen/trunk/structAVPacket.html#ab5793d8195cf4789dfb3913b7a693903</span>
  packet.pos = <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">//https://ffmpeg.org/doxygen/trunk/group__lavf__encoding.html#ga37352ed2c63493c38219d935e71db6c1</span><font></font>
  ret = av_interleaved_write_frame(output_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error muxing packet\n"</span>);
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  av_packet_unref(&amp;packet);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para concluir, precisamos gravar o trailer do fluxo no arquivo de m√≠dia de sa√≠da usando a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_write_trailer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">av_write_trailer(output_format_context);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora estamos prontos para testar o c√≥digo. </font><font style="vertical-align: inherit;">E o primeiro teste ser√° a convers√£o do formato (cont√™iner de v√≠deo) de MP4 para arquivo de v√≠deo MPEG-TS. </font><font style="vertical-align: inherit;">Basicamente, criamos uma linha de comando ffmpeg input.mp4 -c para copiar output.ts usando o libav.</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona! </font><font style="vertical-align: inherit;">N√£o acredite em mim ?! </font><font style="vertical-align: inherit;">Verifique com </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffprobe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">ffprobe -i remuxed_small_bunny_1080p_60fps.ts<font></font>
<font></font>
Input <span class="hljs-comment">#0, mpegts, from 'remuxed_small_bunny_1080p_60fps.ts':</span><font></font>
  Duration: 00:00:10.03, start: 0.000000, bitrate: 2751 kb/s<font></font>
  Program 1<font></font>
    Metadata:<font></font>
      service_name    : Service01<font></font>
      service_provider: FFmpeg<font></font>
    Stream <span class="hljs-comment">#0:0[0x100]: Video: h264 (High) ([27][0][0][0] / 0x001B), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 60 fps, 60 tbr, 90k tbn, 120 tbc</span>
    Stream <span class="hljs-comment">#0:1[0x101]: Audio: ac3 ([129][0][0][0] / 0x0081), 48000 Hz, 5.1(side), fltp, 320 kb/s</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir o que fizemos, agora podemos retornar √† nossa id√©ia original de como o libav funciona. </font><font style="vertical-align: inherit;">Mas perdemos parte do codec, que √© exibido no diagrama.</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="415" src="https://habrastorage.org/webt/_i/vz/yw/_ivzywrkd4le_hfwqyf-7hhrcb8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de terminar este cap√≠tulo, eu gostaria de mostrar uma parte t√£o importante do processo de remultiplexa√ß√£o, onde voc√™ pode passar par√¢metros para o multiplexador. </font><font style="vertical-align: inherit;">Suponha que voc√™ deseje fornecer o formato MPEG-DASH, portanto, √© necess√°rio usar mp4 fragmentado (√†s vezes chamado de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fmp4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) em vez de MPEG-TS ou MPEG-4 comum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â f√°cil usar a linha de comando:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i non_fragmented.mp4 -movflags frag_keyframe+empty_moov+default_base_moof fragmented.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â quase t√£o simples quanto isso na vers√£o libav, simplesmente passamos as op√ß√µes ao escrever o cabe√ßalho de sa√≠da, imediatamente antes de copiar os pacotes:</font></font><br>
<br>
<pre><code class="cpp hljs">AVDictionary* opts = <span class="hljs-literal">NULL</span>;<font></font>
av_dict_set(&amp;opts, <span class="hljs-string">"movflags"</span>, <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>, <span class="hljs-number">0</span>);<font></font>
ret = avformat_write_header(output_format_context, &amp;opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos gerar esse arquivo mp4 fragmentado:</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_fragmented_mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que tudo esteja correto, voc√™ pode usar o incr√≠vel </font><font style="vertical-align: inherit;">site de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ferramentas gpac / mp4box.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://mp4parser.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para ver as diferen√ßas - primeiro fa√ßa o download do mp4.</font></font><br>
<br>
<img align="left" width="212" height="81" src="https://habrastorage.org/webt/x5/hw/9u/x5hw9uxcdgvl36yvns8hkquzlca.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ pode ver, ele possui um bloco </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indivis√≠vel </font><font style="vertical-align: inherit;">- este √© o local onde os quadros de v√≠deo e √°udio est√£o localizados. </font><font style="vertical-align: inherit;">Agora baixe o mp4 fragmentado para ver como ele estende os blocos mdat:</font></font><br>
<br>
<img align="left" width="184" height="140" src="https://habrastorage.org/webt/pu/bv/mm/pubvmm5ogancxewrdxfgdth1d34.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><a name="chapter_3"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 3 - Transcodifica√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">mostre-me o c√≥digo e a execu√ß√£o:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_transcoding</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iremos pular alguns detalhes, mas n√£o se preocupe: o c√≥digo fonte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° dispon√≠vel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste cap√≠tulo, criaremos um transcodificador minimalista escrito em C, que pode converter v√≠deos do H264 para o H265 usando as bibliotecas Favmpeg libav, em particular </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavcodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavformat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavutil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="396" src="https://habrastorage.org/webt/pw/zj/ys/pwzjys-eok7ggnpkztlv7n60njm.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma abstra√ß√£o para o formato do arquivo de m√≠dia, ou seja, </font><font style="vertical-align: inherit;">para um cont√™iner (MKV, MP4, Webm, TS) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> representa cada tipo de dado para um determinado formato (por exemplo: √°udio, v√≠deo, legendas, metadados) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um fragmento de dados compactados recebidos do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que podem ser decodificados usando o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (por exemplo : av1, h264, vp9, hevc) gerando dados brutos chamados </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="cahpter_3_transmuxing"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexa√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com uma convers√£o simples e carregar o arquivo de entrada.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Allocate an AVFormatContext</span><font></font>
avfc = avformat_alloc_context();<font></font>
<span class="hljs-comment">// Open an input stream and read the header.</span>
avformat_open_input(avfc, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
<span class="hljs-comment">// Read packets of a media file to get stream information.</span>
avformat_find_stream_info(avfc, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora configure o decodificador. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos dar√° acesso a todos os componentes do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e para cada um dos quais podemos obter seu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e criar um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espec√≠fico </font><font style="vertical-align: inherit;">. E, finalmente, podemos abrir esse codec para ir para o processo de decodifica√ß√£o. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cont√©m dados de configura√ß√£o de m√≠dia, como taxa de dados, taxa de quadros, taxa de amostragem, canais, afina√ß√£o e muitos outros.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; avfc-&gt;nb_streams; i++) {<font></font>
  AVStream *avs = avfc-&gt;streams[i];<font></font>
  AVCodec *avc = avcodec_find_decoder(avs-&gt;codecpar-&gt;codec_id);<font></font>
  AVCodecContext *avcc = avcodec_alloc_context3(*avc);<font></font>
  avcodec_parameters_to_context(*avcc, avs-&gt;codecpar);<font></font>
  avcodec_open2(*avcc, *avc, <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m precisa preparar o arquivo de m√≠dia de sa√≠da para convers√£o. </font><font style="vertical-align: inherit;">Primeiro, aloque mem√≥ria para a sa√≠da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Crie cada fluxo no formato de sa√≠da. </font><font style="vertical-align: inherit;">Para compactar adequadamente o fluxo, copie os par√¢metros do codec do decodificador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Defina o sinalizador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV_CODEC_FLAG_GLOBAL_HEADER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que informa ao codificador que ele pode usar cabe√ßalhos globais e, finalmente, abra o arquivo de sa√≠da para gravar e salvar os cabe√ßalhos:</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_alloc_output_context2(&amp;encoder_avfc, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);<font></font>
<font></font>
AVStream *avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_copy(avs-&gt;codecpar, decoder_avs-&gt;codecpar);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (encoder_avfc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<font></font>
  encoder_avfc-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<font></font>
<font></font>
avio_open(&amp;encoder_avfc-&gt;pb, encoder-&gt;filename, AVIO_FLAG_WRITE);<font></font>
avformat_write_header(encoder-&gt;avfc, &amp;muxer_opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do descodificador, ajustar a data e hora e escrever o pacote corretamente para o arquivo de sa√≠da. </font><font style="vertical-align: inherit;">Apesar de a fun√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> relatar " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quadro de grava√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", salvamos o pacote. </font><font style="vertical-align: inherit;">Conclu√≠mos o processo de permuta√ß√£o gravando o trailer do fluxo em um arquivo.</font></font><br>
<br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span>(av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>) {<font></font>
  av_packet_rescale_ts(input_packet, decoder_video_avs-&gt;time_base, encoder_video_avs-&gt;time_base);<font></font>
  av_interleaved_write_frame(*avfc, input_packet) &lt; <span class="hljs-number">0</span>));<font></font>
}<font></font>
<font></font>
av_write_trailer(encoder_avfc);</code></pre><br>
<a name="cahpter_3_transcoding"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodifica√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na se√ß√£o anterior, havia um programa simples para convers√£o, agora adicionaremos a capacidade de codificar arquivos, em particular, a transcodifica√ß√£o de v√≠deo de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que o decodificador estiver preparado, mas antes de organizar o arquivo de m√≠dia de sa√≠da, configure o codificador.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v√≠deo </font><font style="vertical-align: inherit;">no codificador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usamos o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o nome </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libx265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_encoder_by_name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> base no codec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_alloc_context3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> criado </font><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina os atributos b√°sicos para uma sess√£o de transcodifica√ß√£o e ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... abra o codec e copie os par√¢metros do contexto para o fluxo ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_from_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVRational input_framerate = av_guess_frame_rate(decoder_avfc, decoder_video_avs, <span class="hljs-literal">NULL</span>);<font></font>
AVStream *video_avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
<span class="hljs-keyword">char</span> *codec_name = <span class="hljs-string">"libx265"</span>;
<span class="hljs-keyword">char</span> *codec_priv_key = <span class="hljs-string">"x265-params"</span>;
<span class="hljs-comment">// we're going to use internal options for the x265</span>
<span class="hljs-comment">// it disables the scene change detection and fix then</span>
<span class="hljs-comment">// GOP on 60 frames.</span>
<span class="hljs-keyword">char</span> *codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
AVCodec *video_avc = avcodec_find_encoder_by_name(codec_name);<font></font>
AVCodecContext *video_avcc = avcodec_alloc_context3(video_avc);<font></font>
<span class="hljs-comment">// encoder codec params</span>
av_opt_set(sc-&gt;video_avcc-&gt;priv_data, codec_priv_key, codec_priv_value, <span class="hljs-number">0</span>);<font></font>
video_avcc-&gt;height = decoder_ctx-&gt;height;<font></font>
video_avcc-&gt;width = decoder_ctx-&gt;width;<font></font>
video_avcc-&gt;pix_fmt = video_avc-&gt;pix_fmts[<span class="hljs-number">0</span>];
<span class="hljs-comment">// control rate</span>
video_avcc-&gt;bit_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_buffer_size = <span class="hljs-number">4</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_max_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_min_rate = <span class="hljs-number">2.5</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;
<span class="hljs-comment">// time base</span><font></font>
video_avcc-&gt;time_base = av_inv_q(input_framerate);<font></font>
video_avs-&gt;time_base = sc-&gt;video_avcc-&gt;time_base;<font></font>
<font></font>
avcodec_open2(sc-&gt;video_avcc, sc-&gt;video_avc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_from_context(sc-&gt;video_avs-&gt;codecpar, sc-&gt;video_avcc);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â necess√°rio expandir o ciclo de decodifica√ß√£o para transcodificar um fluxo de v√≠deo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviamos um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vazio </font><b><font style="vertical-align: inherit;">para o</font></b><font style="vertical-align: inherit;"> decodificador ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenha o AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descompactado </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßamos a recodificar o quadro bruto.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviamos o quadro bruto ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtemos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compacta√ß√£o com base em nosso codec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><b><font style="vertical-align: inherit;">avcodec_receive_packet</font></b><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina o carimbo de data / hora ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_packet_rescale_ts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escrevemos no arquivo de sa√≠da ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span> (av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_packet(decoder_video_avcc, input_packet);
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_frame(decoder_video_avcc, input_frame);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
      encode(encoder_avfc, decoder_video_avs, encoder_video_avs, decoder_video_avcc, input_packet-&gt;stream_index);<font></font>
    }<font></font>
    av_frame_unref(input_frame);<font></font>
  }<font></font>
  av_packet_unref(input_packet);<font></font>
}<font></font>
av_write_trailer(encoder_avfc);<font></font>
<font></font>
<span class="hljs-comment">// used function</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">encode</span><span class="hljs-params">(AVFormatContext *avfc, AVStream *dec_video_avs, AVStream *enc_video_avs, AVCodecContext video_avcc <span class="hljs-keyword">int</span> index)</span> </span>{<font></font>
  AVPacket *output_packet = av_packet_alloc();<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_frame(video_avcc, input_frame);<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_packet(video_avcc, output_packet);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    output_packet-&gt;stream_index = index;<font></font>
    output_packet-&gt;duration = enc_video_avs-&gt;time_base.den / enc_video_avs-&gt;time_base.num / dec_video_avs-&gt;avg_frame_rate.num * dec_video_avs-&gt;avg_frame_rate.den;<font></font>
<font></font>
    av_packet_rescale_ts(output_packet, dec_video_avs-&gt;time_base, enc_video_avs-&gt;time_base);<font></font>
    response = av_interleaved_write_frame(avfc, output_packet);<font></font>
  }<font></font>
  av_packet_unref(output_packet);<font></font>
  av_packet_free(&amp;output_packet);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Convertemos o fluxo de m√≠dia de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Como esperado, a vers√£o do arquivo de m√≠dia h265 √© menor que o h264, enquanto o programa tem amplas oportunidades:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">/*
   * H264 -&gt; H265
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx265"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x265-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - fragmented MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.muxer_opt_key = <span class="hljs-string">"movflags"</span>;<font></font>
  sp.muxer_opt_value = <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; AAC
   * MP4 - MPEG-TS
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">0</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.audio_codec = <span class="hljs-string">"aac"</span>;<font></font>
  sp.output_extension = <span class="hljs-string">".ts"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/* WIP :P  -&gt; it's not playing on VLC, the final bit rate is huge
   * H264 -&gt; VP9
   * Audio -&gt; Vorbis
   * MP4 - WebM
   */</span>
  <span class="hljs-comment">//StreamingParams sp = {0};</span>
  <span class="hljs-comment">//sp.copy_audio = 0;</span>
  <span class="hljs-comment">//sp.copy_video = 0;</span>
  <span class="hljs-comment">//sp.video_codec = "libvpx-vp9";</span>
  <span class="hljs-comment">//sp.audio_codec = "libvorbis";</span>
  <span class="hljs-comment">//sp.output_extension = ".webm";</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De cora√ß√£o, confesso que foi um pouco mais complicado do que parecia no come√ßo. </font><font style="vertical-align: inherit;">Eu tive que escolher o c√≥digo fonte da linha de comando do FFmpeg e testar bastante. </font><font style="vertical-align: inherit;">Provavelmente perdi algo em algum lugar, porque tive que usar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force-cfr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e algumas mensagens de aviso ainda aparecem, por exemplo, de que o tipo de quadro (5) foi for√ßado a ser alterado para o tipo de quadro (3).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tradu√ß√µes no Blog Edison:</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/fr/yz/q7/fryzq72v0ik0irt2q4orchflxvs.jpeg"></a></td>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/jv/3k/-f/jv3k-f5vi9drztohsh-e0t-puru.jpeg"></a></td>
</tr>
<tr>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As 50 maiores franquias de jogos </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
com mais de um bilh√£o de receita</font></font></a></th>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  Airbnb ?<br>
[: ]</a></th>
</tr>
</tbody></table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495604/index.html">Localiza√ß√£o tempor√°ria no Symfony 4 + Twig</a></li>
<li><a href="../pt495606/index.html">"Monitoramento social". Pontua√ß√£o 1: 0 a nosso favor</a></li>
<li><a href="../pt495608/index.html">[Infogr√°fico] Visualiza√ß√£o de pandemias na hist√≥ria da humanidade</a></li>
<li><a href="../pt495610/index.html">Por que o futuro n√£o √© para Python</a></li>
<li><a href="../pt495612/index.html">O Airbnb sobreviver√° ao coronav√≠rus? [spoiler: sim]</a></li>
<li><a href="../pt495618/index.html">A quarentena leva a perdas. Como viver sem quarentena?</a></li>
<li><a href="../pt495620/index.html">Montou uma colheitadeira de videoconfer√™ncia em Jabra Panacast, vantagens e desvantagens de escrit√≥rio e casa</a></li>
<li><a href="../pt495622/index.html">Aeronaves do sistema digital de ar condicionado duplo (SLE)</a></li>
<li><a href="../pt495624/index.html">Por que o Xbox Series X ser√° a principal compra de 2020</a></li>
<li><a href="../pt495634/index.html">Todo mundo faz: por que os funcion√°rios s√£o a principal amea√ßa √† seguran√ßa da informa√ß√£o corporativa e como lidar com ela</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>