<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úâÔ∏è üÖ∞Ô∏è üíâ Xiaomi Gateway 2 can not be soldered ü§≠ üõèÔ∏è üå´Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! In previous series, I:
 
 

- I bought devices from Xiaomi for a smart home and, through a soldering iron, made them work in an exciting way ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Xiaomi Gateway 2 can not be soldered</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503570/"><img src="https://habrastorage.org/webt/6f/79/sz/6f79szfjlnffm-47atgwsj0c0kg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hi Habr! </font><font style="vertical-align: inherit;">In previous series, I:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I bought devices from Xiaomi for a smart home and, through a soldering iron, made them work in an exciting way without native servers via the home assistant ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link to post</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrapped the web interface from the home assistant in electron ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link to the post</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) with support for notifications, menus, dotbar, etc. ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But as more and more devices appeared, a strange thing began to open up ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, that Aqara Wireless Relay 2ch (LLKZMK11LM) did not support xiaomi_aqara integration, and when the Issues were launched on GitHub, the code owners replied that it was impossible to support this relay without updating the device firmware. </font><font style="vertical-align: inherit;">‚ÄúSomething is wrong here,‚Äù I thought, and went to understand the code, how it happened. </font><font style="vertical-align: inherit;">And so I got carried away that I washed down the integration first to work with the relay via xiaomi_miio ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and then I implemented support for the cube and Xiaomi button for this integration ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and now I will tell you why and how.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Developer API</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time, Xiaomi releasing a gateway (lumi.gateway.v3) was equipped with its developer api and even documentation for it. The Developer API is the thing that communicates over UDP on ports 4321 and 9898. The community really liked this move and it responded with a bunch of repositories that integrate the device into everything that is possible. Working with this developer api formed the basis of the home assistant xiaomi_aqara integration ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and everything was great so far ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While Xiaomi did not override and they did not hammer out developer api support, identifiers of new devices stopped appearing in it. </font><font style="vertical-align: inherit;">The desired relay is in the list of devices connected via gateway to zigbee, but there the relay appears with an empty model identifier, without which it is impossible to do anything. </font><font style="vertical-align: inherit;">Then, more recently, Xiaomi rolled out a gateway firmware update after installing which it was impossible to turn on developer api without a soldering iron (if it was not turned on before the update), </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once in the heart of this Santa Barbara, I burst into tears and went to order the German ZigBee ConBee2 dongle on Amazon to work with zigbee devices without a gateway. </font><font style="vertical-align: inherit;">But while the Germans in the conditions of the apocalypse were preparing to send my order, I, tired of waiting, began to dig deeper ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More native MIIO protocol</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Miio is a newer protocol for working with Xiaomi devices connected to the network via wi-fi. The native Mi Home application communicates via this protocol with wi-fi sockets, and with IR Remote, and vacuum cleaners, and with everyone else, and even with my xiaomi gateway v2. This is also a UDP protocol, but this time it is not port 4321 that is involved, but port 54321 (I consider a great method for selecting ports). ‚ÄúGoofy,‚Äù I thought: ‚ÄúSo she also knows another protocol, but should I try to connect the relay using this new protocol?‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The miio protocol encrypts all messages with a token, but, fortunately, the methods for extracting the token and encryption / decryption have already been opened and work with them has been implemented in several libraries (link </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">once</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , link </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">I am not the first to integrate the new device using the miio protocol, so the path was known and I followed it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The way is this:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get security token devices by extracting them from the logs ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) or from a modified application ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We remove traffic between the mobile application and the device</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We decrypt UDP packets with security token received at the beginning</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learning code to create similar packages</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I took traffic directly from my wi-fi router, fortunately there is a custom asuswrt-merlin firmware for it, in which tcpdump can be installed using Entware. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The utility is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fine, but it does not understand dumps from tcpdump, but it understands the json-dump generated by Wireshark. </font><font style="vertical-align: inherit;">To override the binary dump from tcpdump to json, I used the tshark utility. </font><font style="vertical-align: inherit;">After that I saw which commands the mi home application controls the relay. I generated PR with the addition of relay support ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I canceled the order for ConBee2, because the software method is both faster and more fun ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do we need a blacksmith?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so it means that I, with a dash bare, find myself in a situation where everything seems to work, but now in my home assistant my Xiamo Gateway 2 is represented by two entities, one under the developer api protocol (xiaomi_aqara integration) and another one under the miio puncture ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xiaomi_miio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> integration </font><font style="vertical-align: inherit;">) . </font><font style="vertical-align: inherit;">And I do not like to solder, I wanted to simplify my life and myself. </font><font style="vertical-align: inherit;">It was necessary to implement the missing part of the devices in xiaomi_miio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the most part, after creating the software strapping, this is a mechanical job:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enabled tcpdump</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">created an automation action in the Mi Home application that I want to track</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initiated this automation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decrypted the dump</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copy-paste from decryption to code</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send commands from the console</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file finishing to shine</font></font></li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But hands itch, and adventure calls ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fake miio device</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 An autopsy showed that there is no callback mechanism in the miio protocol. Sensors can be pulled once every 20 seconds, but for the correct operation of buttons and cubes it was a bad idea to interrogate the device 10 times per second. In this paradox, I saw an interesting activity, but I did not really want to deal with the mechanical encoding of the captured packets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A study of another library working with the miio protocol ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) surprised me to the core. The authors have assembled a harvester that communicates with the device via the miio protocol, but uses developer-api to intercept events from cubes and buttons. This approach thoroughly strained me, it leads to the fact that part of the functionality starts working immediately, but for part it is necessary to solder the device ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armed again with tcpdump and, having modified the decoder with the decryption function from all the devices in one run, I began to listen to everything that flies over the network to UDP port 54321. And I see a rather interesting picture. When I create automation like ‚ÄúIf you turned the zigbee cube, turn on the wi-fi socket‚Äù, json is sent from the application to the gateway using the miio protocol inside the data field whose json is encoded in a string; ‚ÄúDSL‚Äù - thought Stirlitz, for some reason, from time immemorial, everyone has been packing this way ... Details are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viewing the contents of this line showed that the reaction to the action is not transmitted somewhere to the clouds, directly in this json program appeared the ip address and encryption token of the wi-fi socket (this paragraph contradicts the paragraph from the first series, I was wrong there; (gate he communicates with friendly devices himself - without the help of clouds.) Yes, and the script itself resembles automation from the home assistant, there are trigger parameters, there is ip where to send a reaction. That is, no pub / sub protocol could be found in the dumps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the idea was born of everything to catch all necessary events from buttons and cubes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We emulate a miio device in the application, respond to PING applications and requests from gateway</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write a script generator for the gateway to generate one per pair ~ (device, event)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We send scripts so that when an event occurs, a miio request comes to the emulator </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It took a couple of days to realize this and bring it into a divine form. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, the python-miio library can work with relays and with a cube and with a button, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to attach this update to the home assistant and it will be possible to work with Xiaomi gateway 2 without soldering and developer api. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If anyone is ready to test on their devices and / or add support for new ones - join :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Still on sale is the glorious Xiaomi 1C vacuum cleaner here and such a shortcoming ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) for its integration into the home assistant. </font><font style="vertical-align: inherit;">I think to take ... Do you need it?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503552/index.html">DIT Moscow when checking the pass receives permission to send advertising for the next 10 years</a></li>
<li><a href="../en503556/index.html">Everything you need to know about std :: any</a></li>
<li><a href="../en503560/index.html">Learning Scala: Part 1 - The Snake Game</a></li>
<li><a href="../en503562/index.html">The digest of interesting materials for the mobile developer # 345 (May 18 - 24)</a></li>
<li><a href="../en503566/index.html">Is it possible to use Linux Desktop in a Windows infrastructure?</a></li>
<li><a href="../en503572/index.html">Udalenka. another self-isolation VPN deployment story</a></li>
<li><a href="../en503574/index.html">Analysis of the contents of QR codes in documents of the electronic government of the Republic of Kazakhstan in the frontend</a></li>
<li><a href="../en503576/index.html">"Passed by": topics that you forgot to discuss on Russian-speaking sites about startups and technologies</a></li>
<li><a href="../en503578/index.html">Good programmers copy, great programmers steal</a></li>
<li><a href="../en503580/index.html">What is Big Data?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>