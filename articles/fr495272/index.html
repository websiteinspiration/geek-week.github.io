<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∫ üïµüèª ü§≤ Emulateurs SNES √† quelques pixels de la perfection absolue üêπ üèß üñêüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous sommes si pr√®s de cr√©er un √©mulateur capable de recr√©er parfaitement toutes les fonctions du vrai mat√©riel et des logiciels SNES. 
 
 Au cours de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Emulateurs SNES √† quelques pixels de la perfection absolue</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495272/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/f3b/e14/44bf3be14304180044d2e7deb216f07d.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous sommes si pr√®s de cr√©er un √©mulateur capable de recr√©er parfaitement toutes les fonctions du vrai mat√©riel et des logiciels SNES. </font></font></i><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au cours des 15 derni√®res ann√©es, en</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tant que codeur pour l'√©mulateur </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bsnes,</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai essay√© de perfectionner l'√©mulation Super Nintendo, mais maintenant nous sommes confront√©s au dernier probl√®me: la synchronisation pr√©cise des cycles d'horloge des processeurs vid√©o SNES. </font><font style="vertical-align: inherit;">Pour atteindre cette derni√®re √©tape de la pr√©cision de l'√©mulation, l'aide de toute la communaut√© est n√©cessaire, et j'esp√®re pour votre soutien. </font><font style="vertical-align: inherit;">Mais d'abord, je vais vous dire ce que nous avons d√©j√† accompli.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtat actuel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, la situation avec l'√©mulation SNES est tr√®s bonne. Mis √† part les p√©riph√©riques inhabituels qui r√©sistent √† l'√©mulation (par exemple, un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">club de golf avec un capteur de lumi√®re</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simulateur de v√©lo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et un modem t√©l√©phonique, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilis√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au Japon </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">pour les paris hippiques au</font></a><font style="vertical-align: inherit;"> Japon), tous les jeux SNES sous licence officielle sont enti√®rement jouables, et aucun jeu n'a de probl√®mes √©vidents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©mulation SNES est devenue si pr√©cise que j'ai m√™me d√ª diviser l'√©mulateur en deux versions: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">higan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui vise une pr√©cision et une coh√©rence absolues avec la documentation mat√©rielle, et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bsnes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui vise la vitesse, les capacit√©s √©tendues et la facilit√© d'utilisation.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©cemment, dans le domaine de l'√©mulation SNES, de nombreuses r√©alisations int√©ressantes ont √©t√© re√ßues, notamment:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âmulation de bas niveau de tous les coprocesseurs SNES</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge du mode HD 7</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©pose des freins</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge d'un √©cran large</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSU1 pour CD-audio et FMV</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cution pr√©liminaire pour r√©duire les retards</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contr√¥le dynamique du d√©bit de donn√©es pour une synchronisation audio et vid√©o parfaite</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¶ et beaucoup plus! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, c'est fait? Tout le monde a bien fonctionn√©, au revoir, et merci pour le poisson? Enfin, pas tout √† fait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous avons atteint la pr√©cision au rythme de presque tous les composants SNES. Les seules exceptions √©taient le PPU (unit√© de traitement d'image, modules de traitement d'image) utilis√© pour g√©n√©rer des images vid√©o transmises √† l'√©cran. Nous </font><font style="vertical-align: inherit;">savons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">surtout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comment fonctionnent les PPU, mais pour certaines fonctions, nous devons utiliser des hypoth√®ses, ce qui conduit √† une pr√©cision imparfaite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'une mani√®re g√©n√©rale, les probl√®mes restants sont assez mineurs. Si vous ne cherchez pas l'id√©alit√© absolument parfaite de l'√©mulation pour l'amour de l'art, je ne peux pas vous convaincre de la n√©cessit√© d'am√©liorer encore l'√©mulation PPU. Comme dans n'importe quel domaine, plus nous sommes proches de l'id√©al, plus le rendement est faible.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais je peux dire pourquoi cela est important pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : c'est le travail de toute ma vie, et je ne veux pas que je dise que je suis </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√®s de l'ach√®vement sans faire le dernier pas. </font><font style="vertical-align: inherit;">Je vieillis et je ne suis pas √©ternel. </font><font style="vertical-align: inherit;">Je veux que la derni√®re pi√®ce du puzzle soit r√©solue, de sorte que, ayant pris sa retraite, j'√©tais s√ªr que l'h√©ritage SNES est fiable et enti√®rement pr√©serv√© gr√¢ce √† l'√©mulation. </font><font style="vertical-align: inherit;">Je veux dire que le probl√®me est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©solu</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes toujours intrigu√©, continuez √† lire pour vous familiariser avec le contexte d'un probl√®me et les solutions que je propose.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√©lisation de l'architecture SNES</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par √©num√©rer les composants qui composent SNES:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c3c/f4f/e25/c3cf4fe250fbbed2b897e46ef58628bd.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sch√©ma du syst√®me Super NES. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fl√®ches indiquent les directions dans lesquelles les diff√©rents processeurs SNES peuvent √©changer des donn√©es et les lignes en pointill√©s indiquent les connexions aux puces de m√©moire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chose la plus importante pour nous maintenant est de remarquer que la sortie de la vid√©o et du son est transmise directement depuis PPU et DSP. </font><font style="vertical-align: inherit;">Cela signifie qu'ils agissent comme des "bo√Ætes noires", et nous ne pouvons pas voir ce qui se passe √† l'int√©rieur. </font><font style="vertical-align: inherit;">Plus tard, cela deviendra important pour nous.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exactitude</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez que nous √©mulions la commande CPU "multiplier", qui prend deux registres (variables), les multiplie, re√ßoit le r√©sultat et plusieurs drapeaux indiquant l'√©tat du r√©sultat (par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©bordement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons √©crire un programme qui multiplie toute valeur possible de 0 √† 255 en tant que facteur et multiplicateur. Ensuite, nous pouvons d√©river les r√©sultats de multiplication num√©rique et indicateur. Ainsi, nous obtenons deux tables de 65 536 √©l√©ments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En analysant ces tableaux, nous pouvons d√©terminer avec pr√©cision comment et o√π les r√©sultats des calculs CPU sont d√©finis d'une certaine mani√®re. Ensuite, nous pouvons modifier les √©mulateurs afin que lors de l'ex√©cution du m√™me test, nous obtenions exactement les m√™mes tables en m√™me temps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons maintenant que le processeur puisse effectuer une multiplication 16 bits x 16 bits. Lors du test de chaque valeur possible, 4 milliards de r√©sultats seront g√©n√©r√©s, ce qui est presque impossible √† tester dans un d√©lai raisonnable. Si le CPU a des multiplications de 32 bits x 32 bits, dans la pratique, il ne sera pas possible de tester toutes les combinaisons de valeurs d'entr√©e avant la mort thermique de l'Univers (au moins au niveau actuel de la technologie). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans de tels cas, nous agissons de mani√®re plus s√©lective dans les tests et essayons de d√©terminer quand les indicateurs peuvent changer exactement, quand les r√©sultats peuvent d√©border, etc. Sinon, nous devions ex√©cuter des tests qui ne se termineraient jamais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La multiplication est une op√©ration assez banale, mais le m√™me principe peut √™tre √©tendu √† l'ensemble du processus de r√©tro-ing√©nierie, y compris les op√©rations plus complexes, par exemple, la transmission de donn√©es via DMA (acc√®s direct √† la m√©moire) lors du retour horizontal du faisceau. </font><font style="vertical-align: inherit;">Nous cr√©ons des tests qui tentent de d√©terminer ce qui se passe dans les cas limites, puis v√©rifions si notre √©mulation se comporte de mani√®re identique au comportement du vrai SNES.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rateurs de signaux et battements</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNES poss√®de deux g√©n√©rateurs de signaux (oscillateurs): un oscillateur √† cristal fonctionnant √† une fr√©quence d'environ 21 MHz (il contr√¥le les modules CPU et PPU), et un r√©sonateur en c√©ramique fonctionnant √† une fr√©quence d'environ 24 MHz, qui contr√¥le SMP et DSP. </font><font style="vertical-align: inherit;">Dans les coprocesseurs √† cartouche, parfois un oscillateur √† cristal de 21 MHz est utilis√©, et parfois ses propres g√©n√©rateurs de signaux fonctionnant avec d'autres fr√©quences.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97d/ecb/bc1/97decbbc1161fcf170f063d2fd42795d.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recr√©er ce circuit imprim√© Super Famicom en code est plus difficile qu'il n'y para√Æt.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'horloge est l'√©l√©ment de base de la synchronisation de tout syst√®me, et SNES est con√ßu pour effectuer diverses t√¢ches avec certaines fr√©quences et intervalles de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous imaginez une horloge de 100 hertz, ce sera un appareil avec une sortie binaire passant √† un √©tat logique √©lev√© du signal (par exemple, +5 V), puis √† un √©tat bas du signal (0 V, ou masse) 100 fois par seconde. C'est-√†-dire que chaque seconde la tension √† la sortie fluctuera 200 fois: en augmentant 100 fois et en abaissant 100 fois le front du signal d'horloge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un cycle d'horloge est g√©n√©ralement consid√©r√© comme une transition compl√®te, c'est-√†-dire qu'un cycle de 100 Hz g√©n√®re 100 cycles d'horloge par seconde. </font><font style="vertical-align: inherit;">Certains syst√®mes n√©cessitent une distinction entre les fronts montants et descendants, et pour eux, nous divisons le cycle en demi-cycles pour indiquer chaque phase (haute ou basse) du signal d'horloge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che la plus importante d'un √©mulateur pr√©cis consiste √† effectuer des t√¢ches exactement de la m√™me mani√®re et exactement en m√™me temps que sur un √©quipement r√©el. </font><font style="vertical-align: inherit;">Cependant, la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fa√ßon dont les</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√¢ches sont effectu√©es </font><font style="vertical-align: inherit;">n'est pas tr√®s importante </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La seule chose importante est que l'√©mulateur, recevant les m√™mes signaux d'entr√©e, g√©n√®re les m√™mes signaux de sortie en m√™me temps que sur du mat√©riel r√©el.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timings</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, les op√©rations prennent du temps. Prenons par exemple la multiplication dans le CPU SNES. Au lieu de faire une pause et d'attendre la fin de la multiplication, la CPU SNES calcule le r√©sultat de la multiplication un bit √† la fois en arri√®re-plan pendant huit cycles d'horloge des opcodes CPU. Cela permet potentiellement au code d'effectuer d'autres t√¢ches en attendant la fin de la multiplication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tr√®s probablement, tout logiciel commercial attendra ces huit cycles, car si vous essayez de lire le r√©sultat avant qu'il ne soit pr√™t, nous obtiendrons un r√©sultat partiellement termin√©. Cependant, avant que les √©mulateurs SNES ne donnent </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instantan√©ment des</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√©sultats corrects </font><font style="vertical-align: inherit;">, sans attendre ces cycles d'horloge suppl√©mentaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque les fans de consoles ont commenc√© √† cr√©er et √† tester des logiciels auto-√©crits dans des √©mulateurs, cette divergence a commenc√© √† poser certains probl√®mes. Une partie du logiciel, par exemple, bon nombre des premiers hacks ROM de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Super Mario World</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ne fonctionnait correctement que dans ces anciens √©mulateurs, mais pas sur du vrai mat√©riel SNES. Cela est d√ª au fait qu'ils ont √©t√© d√©velopp√©s en tenant compte de l'instant (peu fiable du point de vue des √©quipements r√©els) d'obtention des r√©sultats de multiplication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le processus d'am√©lioration des √©mulateurs, la compatibilit√© des anciens logiciels a √©t√© rompue, et nous avons donc d√ª ajouter des options de compatibilit√© aux nouveaux √©mulateurs afin de ne pas perdre ces programmes. Oui, peu importe √† quel point cela semble surr√©aliste, mais aujourd'hui, les √©mulateurs doivent √©muler d'autres √©mulateurs!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La commodit√© de ce retard de multiplication dans le CPU r√©side dans le fait qu'il est tr√®s pr√©visible: huit cycles d'horloge de calculs commencent imm√©diatement apr√®s la demande de l'op√©ration de multiplication. </font><font style="vertical-align: inherit;">En √©crivant du code qui lit les r√©sultats apr√®s chaque cycle, nous avons pu v√©rifier que le CPU SNES utilise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'algorithme Booth</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour la multiplication </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronisation d'horloge</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les autres op√©rations ne sont pas faciles √† mod√©liser car elles sont ex√©cut√©es de mani√®re asynchrone en arri√®re-plan. Un tel cas est la mise √† jour DRAM du processeur SNES central. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant le rendu de chaque ligne raster, l'ensemble du processeur SNES √† un certain stade suspend son fonctionnement pendant une courte p√©riode de temps pendant que le contenu de la puce RAM est mis √† jour. Cela est n√©cessaire car pour r√©duire le co√ªt dans SNES, la RAM dynamique (plut√¥t que statique) a √©t√© utilis√©e comme m√©moire principale du CPU. Pour enregistrer le contenu de la RAM dynamique, elle doit √™tre mise √† jour p√©riodiquement.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d61/cb1/ab9/d61cb1ab914186314069b09f88218fcf.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour cr√©er un √©mulateur vraiment parfait, il ne suffit pas d'assurer la jouabilit√© des trois mille cinq cents jeux SNES. Il est √©galement n√©cessaire de r√©aliser la simulation de chaque fonction du syst√®me avec une pr√©cision de toucher parfaite.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Le facteur cl√© dans l'analyse des d√©lais exacts de ces op√©rations a √©t√© la possibilit√© d'utiliser des compteurs PPU horizontaux et verticaux. Ces compteurs effectuent des incr√©ments et sont r√©initialis√©s apr√®s chaque d√©placement inverse horizontal et vertical du faisceau. Cependant, leur pr√©cision n'est que d'un quart de la fr√©quence du g√©n√©rateur de signal CPU SNES; en d'autres termes, le compteur horizontal incr√©mente tous les quatre cycles d'horloge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En lisant plusieurs fois les valeurs des compteurs, j'ai pu d√©terminer √† quel quart du cycle d'horloge le compteur est align√©. En combinant ces connaissances avec des fonctions sp√©cialement cr√©√©es qui peuvent faire un pas vers le nombre exact de cycles d'horloge indiqu√© par l'utilisateur, j'ai pu parfaitement adapter le processeur SNES √† n'importe quelle position exacte du cycle d'horloge dont j'ai besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gr√¢ce √† une travers√©e it√©rative de nombreux cycles d'horloge, j'ai pu d√©terminer quand certaines op√©rations se produisent exactement (par exemple, mise √† jour de DRAM, transmission HDMA, interruption d'interrogation, etc.). Apr√®s cela, j'ai pu recr√©er exactement tout cela dans l'√©mulation. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puce SMP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La console SNES poss√®de √©galement ses propres temporisateurs et une r√©tro-ing√©nierie r√©ussie a √©galement √©t√© effectu√©e pour ce processeur. </font><font style="vertical-align: inherit;">Je peux consacrer un article entier uniquement au registre SMP TEST, ce qui permet aux programmeurs de contr√¥ler le diviseur de fr√©quence SMP et sa minuterie, sans parler d'autres choses terribles. </font><font style="vertical-align: inherit;">Il suffira de dire que ce n'√©tait pas un processus facile et rapide, mais finalement nous avons gagn√©.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous collectons des coprocesseurs</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ce/8ec/80c/1ce8ec80c157a980c0222eb7462679e9.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La puce SuperFX n'est qu'un des nombreux coprocesseurs √† cartouche que l'√©mulateur SNES peut g√©rer.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il y a tout un tas de coprocesseurs SNES utilis√©s dans diverses cartouches de jeu que nous devions √©galement apprivoiser. Des processeurs individuels √† usage g√©n√©ral comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SuperFX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SA-1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les processeurs de signaux num√©riques comme DSP-1 et Cx4 aux acc√©l√©rateurs de d√©compression comme S-DD1 et SPC7110, ou les horloges temps r√©el Sharp et Epson, et bien plus encore ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que l'√©mulateur SNES doit g√©rer les instructions SuperFX et les caches de pixels; avec le sch√©ma de r√©solution des conflits du bus m√©moire SA-1 (permettant aux CPU SNES et SA-1 d'utiliser simultan√©ment les m√™mes puces ROM et RAM); avec firmware int√©gr√© DSP-1 et Cx4; avec codeurs arithm√©tiques bas√©s sur la pr√©diction S-DD1 et SPC7110; ainsi qu'avec des cas limites bizarres de BCD (d√©cimal cod√© binaire) dans des g√©n√©rateurs en temps r√©el. Lentement mais s√ªrement, en utilisant toutes les techniques de d√©termination de l'exactitude et des temporisations d√©crites ci-dessus, nous avons r√©ussi √† √©muler presque parfaitement toutes ces puces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a fallu beaucoup d'efforts et des milliers de dollars pour retirer les capots des puces et retirer le firmware des processeurs de signaux num√©riques utilis√©s dans les diff√©rents jeux. Dans un cas, l'√©mulation NEC uPD772x autoris√©e</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisez le code de higan pour sauver la voix de feu Stephen Hawking! </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un autre cas, nous avons d√ª proc√©der au reverse engineering d'un ensemble d'instructions pour l'architecture Hitachi HG51B, car personne n'avait jamais publi√© la documentation de cette architecture. </font><font style="vertical-align: inherit;">Dans un autre cas, il s'est av√©r√© qu'un jeu ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hayazashi Nidan Morita Shougi 2</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) poss√®de un puissant processeur ARM6 32 bits avec une fr√©quence de 21 MHz, ce qui acc√©l√®re le jeu de shogi japonais! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La simple sauvegarde de tous les coprocesseurs SNES s'est av√©r√©e √™tre un processus √† long terme, plein de difficult√©s et de surprises.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement des signaux num√©riques</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La puce Sony S-DSP (Digital Signal Processor), qui ne doit pas √™tre confondue avec le coprocesseur √† cartouche DSP-1, a g√©n√©r√© un son SNES unique. Dans cette puce, huit canaux audio avec codage ADPCM 4 bits ont √©t√© connect√©s, ce qui a permis de cr√©er un signal st√©r√©o 16 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ext√©rieurement, et √† partir du sch√©ma du syst√®me pr√©sent√© ci-dessus, il semble d'abord que le DSP soit une ¬´bo√Æte noire¬ª: nous ajustons les canaux sonores et les param√®tres de mixage, apr√®s quoi la puce g√©n√®re du son transmis aux haut-parleurs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une fonction importante a permis au d√©veloppeur sous le surnom de blargg d'effectuer une r√©tro-ing√©nierie compl√®te de cette puce: c'√©tait un tampon d'√©cho. </font><font style="vertical-align: inherit;">Le SNES DSP a une fonction qui m√©lange la sortie des √©chantillons pr√©c√©dents pour cr√©er un effet d'√©cho. </font><font style="vertical-align: inherit;">Cela se produit √† la toute fin du processus de g√©n√©ration du son (√† l'exception du dernier indicateur de blocage du son, qui peut √™tre utilis√© pour d√©sactiver la sortie audio enti√®re.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En √©crivant du code avec le bon timing des mesures et en suivant l'√©cho r√©sultant, nous avons pu d√©terminer l'ordre exact des op√©rations effectu√©es par le DSP pour g√©n√©rer de chaque √©chantillon et cr√©ant un son parfait et une pr√©cision de battement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sauvegarde PPU</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela nous a conduits √† la derni√®re partie du sch√©ma architectural SNES: les puces PPU-1 et PPU-2. </font><font style="vertical-align: inherit;">Gr√¢ce √† John McMaster, nous avons scann√© les puces S-PPU1 (r√©vision 1) et S-PPU2 (r√©vision 3) avec une multiplication par vingt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/678/641/68e/67864168e9f383375b8e081ffff1606f.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scanner vingt fois le cristal du premier PPU SNES ...</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fad/524/a23/fad524a235729831ae880c3edf1bb4b8.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... et le deuxi√®me PPU.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Les deux analyses de cristal nous font savoir que les puces ne sont √©videmment pas des CPU √† usage g√©n√©ral, ni des architectures sp√©cialis√©es qui ex√©cutent des codes de fonctionnement √† partir de la ROM interne du programme du firmware. Ce sont des circuits logiques s√©par√©s avec une logique cod√©e en dur qui re√ßoivent les signaux entrants de diff√©rents registres et de la m√©moire et cr√©ent un signal vid√©o vers le moniteur une ligne raster √† la fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les PPU restent le dernier obstacle √† l'√©mulation de SNES car, contrairement √† tous les composants d√©crits ci-dessus, les PPU </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sont en fait</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une bo√Æte noire. Nous pouvons les configurer dans n'importe quel √©tat, mais le processeur SNES ne peut pas surveiller directement ce qu'ils g√©n√®rent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous utilisons notre exemple pr√©c√©dent avec multiplication comme analogie, imaginez que vous avez demand√© le r√©sultat 3 * 7, mais au lieu de la r√©ponse binaire, vous obtenez une image analogique floue des nombres ¬´21¬ª √† l'√©cran. Toute personne qui ex√©cute votre logiciel pourra </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voir</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 21, mais vous ne pouvez pas √©crire un programme de test pour v√©rifier automatiquement s'il voit la bonne r√©ponse. La v√©rification manuelle par une personne de ces r√©sultats ne peut pas √™tre √©tendue √† plus de plusieurs milliers de tests, et des millions seront n√©cessaires pour maximiser le comportement PPU. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je sais ce que vous pensiez: "Mais est-il plus facile d'utiliser une carte de capture, d'effectuer un traitement d'image, de les comparer approximativement avec l'image sur l'√©cran num√©rique de l'√©mulateur, et d'effectuer des tests bas√©s sur cela?"</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien oui, c'est possible! </font><font style="vertical-align: inherit;">Surtout si le test consiste √† v√©rifier deux √©normes nombres qui occupent tout l'√©cran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que se passe-t-il si le test a de nombreuses nuances et que nous essayons de reconna√Ætre la diff√©rence de couleur d'une demi-teinte d'un pixel? </font><font style="vertical-align: inherit;">Et si nous voulons ex√©cuter un million de tests dans l‚Äôordre et que nous ne savons pas toujours ce que nous allons g√©n√©rer, mais que nous voulons toujours comparer le r√©sultat avec la sortie de notre √©mulation? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rien ne vaut la commodit√© et la pr√©cision avec les donn√©es num√©riques - un flux pr√©cis de bits qui ne peuvent que correspondre ou ne pas correspondre. </font><font style="vertical-align: inherit;">La nature analogique d'un signal CRT ne peut pas nous fournir cela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi c'est important?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'exception d'un jeu ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), tous les logiciels SNES sous licence officielle (auraient d√ª √™tre) bas√©s sur des cha√Ænes raster. Ces jeux n'essaient pas de changer l'√©tat du rendu PPU au milieu de la ligne de raster rendue actuelle (une telle astuce par les programmeurs est appel√©e "l'effet raster"). Cela signifie que les d√©lais d'ex√©cution de la grande majorit√© des jeux n'ont pas √† √™tre particuli√®rement pr√©cis; si vous avez le temps pour la prochaine ligne de trame compl√®te, alors tout est en ordre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cela est important pour un seul match.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/349/c75/08c/349c7508c9724e946a687c60881e77fc.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a4/7ee/5b2/3a47ee5b2b9ceacabcf2c4f1c34a1fe3.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/149/23c/77e14923ce342dc49287fa908aea5b93.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette s√©rie d'images montre un effet d'√©mulation complexe utilis√© dans le message ¬´Good Luck¬ª d' </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dans les images ci-dessus, vous voyez le texte image par image ¬´Good Luck¬ª de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le jeu l'impl√©mente en changeant la position de d√©filement vertical du calque d'arri√®re-plan 3 (BG3). Cependant, l'affichage du tableau de bord √† gauche (o√π vous pouvez voir que le joueur a 39 missiles) est √©galement sur le m√™me calque d'arri√®re-plan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le jeu parvient √† effectuer cette s√©paration en modifiant la position du d√©filement BG3 dans chaque ligne raster apr√®s avoir rendu le tableau de bord gauche, mais avant que le texte ¬´Good Luck¬ª commence √† √™tre rendu. Cela peut √™tre fait car en dehors du tableau de bord et du texte, BG3 est transparent et il n'y a rien √† dessiner entre ces deux points, quelle que soit la valeur du registre de d√©filement vertical. Ce comportement nous montre que les registres de d√©filement </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peuvent √™tre</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modifi√©s √† n'importe quelle √©tape du rendu.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/880/658/047/8806580479dcbbaf6671fc971c12ba8b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette petite ombre sous l'avion a provoqu√© un tas de maux de t√™te pour le d√©veloppeur d'√©mulateur obs√©d√© par la pr√©cision. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'image ci-dessus montre la tristement c√©l√®bre ombre d'un avion. Cet effet est rendu en modifiant le registre de luminosit√© de l'√©cran avec de courtes ondulations sur cinq lignes raster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant le jeu, vous pouvez voir que cette ombre est plut√¥t chaotique. Dans l'image ci-dessus, elle ressemble un peu √† la lettre ¬´c¬ª, mais sa forme dans chaque ligne raster change de longueur et de point de d√©part √† chaque image. Les d√©veloppeurs d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol ont</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> juste d√©crit approximativement o√π l'ombre devait appara√Ætre et ont r√©solu ce probl√®me directement. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la plupart des cas,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cela fonctionne.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une √©mulation correcte d'un tel comportement n√©cessite un timing parfait, ce qui est absolument </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">extr√™mement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> difficile √† </font><font style="vertical-align: inherit;">obtenir dans l'√©mulateur </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c5/b7f/fa2/1c5b7ffa2601b6480209321b60a131a1.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur l'√©cran de pause d' </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , des effets raster sont utilis√©s qui n'ont pas √©t√© intentionnellement utilis√©s dans aucun autre jeu SNES.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Parlons maintenant de l'√©cran de pause. Il active BG3 tout en dessinant une bordure jaune-noir √† gauche et le d√©sactive √† nouveau pendant la m√™me bordure √† droite pour tracer des lignes grises sur l'√©cran. Il passe √©galement alternativement √† travers le cadre les lignes raster dans lesquelles ces lignes grises sont affich√©es pour cr√©er l'effet d'une gigue de superposition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous agrandissez l'image √©mul√©e ci-dessus, vous remarquerez que pendant la paire de lignes raster dans le coin gauche de ces lignes grises, il manque plusieurs pixels. Cela est arriv√© parce que mon √©mulation PPU est imparfaite √† 100% dans les cycles d'horloge. Dans ce cas, cela provoque l'effet d'activer BG3 un peu plus tard qu'il ne le devrait.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je peux tr√®s facilement changer les timings pour que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cette</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> image s'affiche correctement. Mais un tel changement est susceptible d'affecter n√©gativement d' </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autres</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeux qui modifient les registres d'affichage PPU au milieu de la ligne raster. Bien </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> soit le seul jeu qui le fasse expr√®s, il y a au moins une douzaine de jeux dans lesquels cela se produit par hasard (peut-√™tre que l'IRQ les tire trop t√¥t ou plus tard). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, cela provoque de br√®ves dommages visibles √† l'image, auxquels il n'est pas fait attention pendant le d√©veloppement (par exemple, dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Throttle Racing</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lors de la transition entre le magasin et le jeu). Parfois, l'enregistrement est effectu√© alors que l'√©cran est par ailleurs transparent et ne provoque donc pas d'anomalies visuelles (par exemple, comme dans le cas de l'affichage du statut HP dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dai Kaijuu Monogatari II</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .) Mais m√™me de tels cas de bordure ¬´invisibles¬ª peuvent causer des probl√®mes dans le rendu moins pr√©cis des lignes raster qui sont utilis√©s dans les √©mulateurs les plus productifs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√™me si vous ignorez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tous ces effets raster al√©atoires (mais valides) dans le logiciel SNES ne vous permettent pas de concevoir fonctionnellement un moteur de rendu PPU qui g√©n√®re la ligne raster enti√®re avec une pr√©cision d'horloge parfaite.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de bsnes au cours des ann√©es d'essais et d'erreurs, nous avons cr√©√© une liste de ces jeux avec des ¬´effets raster¬ª. </font><font style="vertical-align: inherit;">Nous avons √©galement cr√©√© des positions de rendu individuelles qui permettent un rendu beaucoup plus rapide bas√© sur des lignes raster pour afficher correctement tous ces jeux (√† l'exception d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bien s√ªr). </font><font style="vertical-align: inherit;">Mais en substance, il s'agit d'un tas de hacks d√©sagr√©ables pour nous, con√ßus pour des jeux sp√©cifiques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai √©galement un rendu PPU bas√© sur une horloge qui n'a pas besoin de tous ces hacks, mais de temps en temps il cr√©e de petites diff√©rences (un √† quatre pixels) avec le rendu de cet √©quipement, comme dans la capture d'√©cran ci-dessus d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registres de verrouillage internes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La raison de tous ces petits √©checs se r√©sume √† des instantan√©s instantan√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disons que SNES rend son </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√©l√®bre mode 7</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est une transformation de texture affine avec des changements de param√®tres dans chaque ligne raster. </font><font style="vertical-align: inherit;">Pour d√©terminer n'importe quel pixel d'√©cran, vous devez effectuer des calculs similaires:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">px = a * clip (hoffset - hcenter) + b * clip (voffset - vcenter) +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
b * y + (hcenter &lt;&lt; 8)</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
py = c * clip (hoffset - hcenter) + d * clip (voffset - vcenter) +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d * y + (vcenter &lt;&lt; 8)</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le vrai SNES ne pourra pas terminer toutes ces six multiplications assez rapidement pour chaque pixel rendu dans le cadre. </font><font style="vertical-align: inherit;">Mais aucune de ces valeurs ne change pour chaque pixel (ou, du moins, ne devrait pas changer), nous avons donc juste besoin de calculer px et py une fois au d√©but de chaque ligne raster. </font><font style="vertical-align: inherit;">Autrement dit, PPU met en cache les r√©sultats statiques dans les verrous, qui sont essentiellement des copies des registres PPU. </font><font style="vertical-align: inherit;">√Ä l'avenir, ils peuvent √™tre transform√©s ou rester inchang√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, les coordonn√©es x, y sont transform√©es par le mode 7 comme suit:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b≈ìuf = (px + a * x) &gt;&gt; 8</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
oy = (py + c * x) &gt;&gt; 8</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que x varie pour chaque pixel, nous savons que l'incr√©mentation est effectu√©e par un √† chaque fois. Gr√¢ce au stockage des disques internes, nous pouvons simplement ajouter des valeurs constantes a et c √† ox et oy pour chaque pixel, plut√¥t que d'effectuer deux multiplications pour chaque pixel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, la question se pose devant nous: √† quelle position particuli√®re du cycle d'horloge le PPU lit-il les valeurs de a et c √† partir des registres PPU externes auxquels le CPU a acc√®s? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous les prenons trop t√¥t, cela peut casser certains jeux. Si nous le prenons trop tard, cela peut casser d'autres jeux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le moyen le plus simple est d'attendre les rapports de bogues et d'ajuster ces positions afin de r√©soudre les probl√®mes dans chaque jeu sp√©cifique. Mais dans ce cas, nous ne trouverons jamais les </font><font style="vertical-align: inherit;">positions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , seulement leurs approximations.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et chaque fois que nous modifions l'une de ces variables, il est irr√©aliste pour nous de retester les trois mille et demi jeux de la biblioth√®que SNES pour d√©tecter la d√©t√©rioration que nos changements pourraient apporter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la po√™le dans le feu</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0a/741/b84/c0a741b84071dd0252021ae422277c1a.jpg"></div> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interpr√©tation artistique du processus d'√©limination des erreurs d'√©mulation.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Un style similaire de m√©thodologie de test, "nous ferons juste le jeu que nous voulons travailler √† tout prix" a conduit au ph√©nom√®ne, que j'appelle l'√©mulation "du feu, mais dans le feu". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au tout d√©but du d√©veloppement de l'√©mulation SNES, lorsque des probl√®mes sont survenus dans le jeu, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toute</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correction dans ce jeu qui lui permettait de fonctionner a √©t√© accept√©e et ajout√©e √† l'√©mulateur. Cette correction a forc√©ment cass√© un autre jeu. Et puis ils ont corrig√© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeu, apr√®s quoi le troisi√®me s'est cass√©. Fixer √† nouveau le troisi√®me match a cass√© le premier. Cela a dur√© de nombreuses ann√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur ici √©tait que les d√©veloppeurs ont essay√© de ne prendre en compte qu'une seule variable √† la fois. Supposons que nous ayons un jeu, et pour que cela fonctionne, les √©v√©nements doivent se produire entre les mesures 20 et 120. Nous ne connaissons pas la mesure exacte, alors choisissez simplement 70, exactement au milieu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, nous obtenons un rapport de bogue dans un autre jeu et d√©terminons que pour que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeu </font><font style="vertical-align: inherit;">fonctionne </font><font style="vertical-align: inherit;">, la valeur de la mesure doit √™tre comprise entre 10 et 60. Alors maintenant, nous le changeons en 40, ce qui fonctionne pour les deux jeux. Cela semble logique! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais alors le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">troisi√®me</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jeu </font><font style="vertical-align: inherit;">appara√Æt </font><font style="vertical-align: inherit;">, dans lequel l'√©v√©nement devrait fonctionner entre les mesures 80 et 160! Maintenant, nous ne pouvons pas faire fonctionner les trois jeux en m√™me temps avec la m√™me valeur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela a oblig√© les d√©veloppeurs d'√©mulateurs √† cr√©er des hacks pour des jeux sp√©cifiques. </font><font style="vertical-align: inherit;">Les codeurs ne veulent pas lib√©rer d'√©mulateur dans lequel vous ne pouvez pas ex√©cuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mario</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zelda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metroid</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par cons√©quent, dans le cas g√©n√©ral, le cycle d'horloge 40 est utilis√©, mais lors du chargement de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metroid,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous for√ßons la valeur de synchronisation √† 100. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment est-ce possible, pourquoi deux jeux ont-ils besoin de valeurs diff√©rentes? </font><font style="vertical-align: inherit;">Cela se produit car non seulement une variable est impliqu√©e ici. </font><font style="vertical-align: inherit;">La synchronisation que vous avez pr√©c√©demment utilis√©e pour d√©clencher un autre √©v√©nement peut affecter la valeur de synchronisation requise pour l' </font><font style="vertical-align: inherit;">√©v√©nement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suivant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez ceci sous la forme d'une simple expression alg√©brique:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2x + y = 120</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez le r√©soudre en prenant x = 10, y = 100. Ou x = 20, y = 80. Ou x = 30, y = 60. Si nous ne pensons qu'√† la valeur de x, qui vous permet d'ex√©cuter simultan√©ment un ensemble de jeux, alors nous manquons le fait qu'en fait le probl√®me peut √™tre dans le mauvais y! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les premi√®res versions d'√©mulateurs pour augmenter la compatibilit√© ont simplement red√©fini la valeur de x en fonction du jeu en cours. De tels hacks de jeu individuels ont persist√©, m√™me si la valeur unique correcte de x a √©t√© d√©couverte plus tard. Ainsi , </font><font style="vertical-align: inherit;">le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> probl√®me </font><font style="vertical-align: inherit;">ne serait jamais r√©solu!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, dans le cas de SNES, pas une ou deux variables ne sont impliqu√©es simultan√©ment. La console SNES PPU poss√®de √† elle seule 52 registres externes, soit environ 130 param√®tres. Dans le processus de rendu d'une seule ligne raster, tous les 130 de ces param√®tres et un nombre inconnu de registres internes et de verrous sont impliqu√©s. C'est trop d'informations pour que quelqu'un √† l'ext√©rieur puisse r√©aliser l'√©tat complet du PPU √† un moment donn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet aspect de l'√©mulation n'est pas √©vident pour les non-initi√©s, mais il est tr√®s juste: la </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©cision n'est</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas √©gale √† la </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compatibilit√©</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous pouvons cr√©er un √©mulateur avec une pr√©cision de 99%, capable d'ex√©cuter 10% des jeux. </font><font style="vertical-align: inherit;">Et vous pouvez √©crire un √©mulateur pr√©cis √† 80% qui ex√©cute 98% des jeux. </font><font style="vertical-align: inherit;">Parfois, une mise en ≈ìuvre correcte √† court terme brise les jeux populaires. </font><font style="vertical-align: inherit;">Ceci est un sacrifice n√©cessaire si vous essayez d'obtenir √† la </font><font style="vertical-align: inherit;">fois une </font><font style="vertical-align: inherit;">pr√©cision de </font><font style="vertical-align: inherit;">100% </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une compatibilit√© √† </font><font style="vertical-align: inherit;">100%.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©soudre le probl√®me</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes arriv√©s au stade actuel de l'√©mulation PPU gr√¢ce au raisonnement d√©ductif et aux r√©sultats dans le monde r√©el. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous savons que deux PPU ont acc√®s √† deux puces VRAM. </font><font style="vertical-align: inherit;">Nous savons qu'ils peuvent lire sur chaque puce un nombre connu d'octets de donn√©es par ligne raster. </font><font style="vertical-align: inherit;">Nous connaissons les d√©tails approximatifs du fonctionnement de chacun des modes vid√©o SNES. </font><font style="vertical-align: inherit;">Et sur cette base, nous pouvons esquisser un mod√®le g√©n√©ralis√© de l'apparence de l'architecture. </font><font style="vertical-align: inherit;">Par exemple, voici un bref exemple du fonctionnement des trois premiers modes vid√©o SNES:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (io.bgMode == 0) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg4.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg4.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (io.bgMode == 1) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (1);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (1);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (io.bgMode == 2) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font>
bg3.fetchOffset(0);<font></font>
<font></font>
bg3.fetchOffset(8);<font></font>
<font></font>
bg2.fetchCharacter(0);<font></font>
<font></font>
bg2.fetchCharacter(1);<font></font>
<font></font>
bg1.fetchCharacter(0);<font></font>
<font></font>
bg1.fetchCharacter(1);<font></font>
<font></font>
}</pre></blockquote><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPU ne r√©v√®le √† un observateur tiers qu'une petite partie de son √©tat: drapeaux horizontaux et verticaux en arri√®re (suppression horizontale / verticale), nombre de pixels horizontaux et verticaux et drapeaux de superposition de tuiles dans l'intervalle des sprites. Ce n'est pas tant que √ßa, mais je le r√©p√®te - chaque petit √©l√©ment de l'√©tat accessible √† l'observateur nous aide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La VRAM (RAM vid√©o, m√©moire vid√©o) de la puce PPU pendant le rendu est ferm√©e aux processeurs SNES, m√™me pour la lecture. Mais il s'est av√©r√© que OAM (m√©moire de sprite) et CGRAM (m√©moire de palette) sont ouverts. L'astuce est qu'√† ce moment, le PPU contr√¥le le bus d'adresse. Par cons√©quent, en lisant OAM et CGRAM pendant le rendu d'√©cran, je peux observer ce que le PPU obtient de ces deux blocs de m√©moire √† un moment aussi critique.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce ne sont pas toutes des pi√®ces du puzzle, mais elles me suffisent pour pouvoir mettre en ≈ìuvre les mod√®les pratiquement corrects pour obtenir des sprites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant des mod√®les d'acc√®s pour OAM et CGRAM ouverts, des indicateurs PPU, des observations g√©n√©rales (c'est-√†-dire des suppositions) √† partir de rapports d'erreur pour diff√©rents jeux et un raisonnement d√©ductif, nous avons pu cr√©er des moteurs de rendu PPU bas√©s sur une horloge qui peuvent </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presque</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parfaitement </font><font style="vertical-align: inherit;">lancer tous les jeux publi√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la situation est toujours pr√©caire: si quelqu'un commence √† cr√©er des jeux homebrew en utilisant un timing pr√©cis des ticks et des effets raster, alors tous nos √©mulateurs modernes ne seront pas en mesure de g√©rer cela. Y compris les impl√©mentations logicielles et mat√©rielles bas√©es sur FPGA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dois dire clairement: aujourd'hui </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ils ne connaissent que l'ordre interne des op√©rations et le comportement d'accrochage des puces PPU de la console SNES. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personne</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne sait comment les imiter parfaitement. </font><font style="vertical-align: inherit;">Au moins pour l'instant.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solutions possibles</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'allons-nous en faire? </font><font style="vertical-align: inherit;">Comment d√©terminer l'ordre exact des op√©rations dans un PPU si, du point de vue du CPU SNES, il s'agit d'une "bo√Æte noire"? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vois quatre options possibles: analyseurs logiques, sortie vid√©o num√©rique en mode test, contremarches et retrait des couvercles des puces.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyseurs logiques</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous regardez les scans de cristaux PPU illustr√©s ci-dessus, vous remarquerez des zones noires sur les bords de la puce. Ce sont les plates-formes se connectant aux contacts des puces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces broches stockent l'√©tat des puces PPU pendant chaque cycle d'horloge. Ici, vous pouvez trouver l'adresse actuelle √† laquelle les puces acc√®dent √† la puce de m√©moire vid√©o, les valeurs des donn√©es transf√©r√©es d'un PPU au second, et bien plus encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces informations ne sont pas disponibles pour le code ex√©cut√© sur le processeur SNES, mais elles fournissent des observations pr√©cieuses sur l'ordre interne des op√©rations PPU.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c8/157/c0d/2c8157c0df8caaebd7e24f620bf2c60f.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La connexion de PPU de console Super NES √† un analyseur logique similaire peut √™tre la cl√© de la bo√Æte noire. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me critique des analyseurs logiques est qu'ils ne sont pas tr√®s pratiques √† g√©rer: si vous essayez d'√©chantillonner des donn√©es en direct √† partir d'un syst√®me qui fonctionne, nous obtiendrons un flux de r√©sultats qui est assez difficile √† d√©chiffrer. </font><font style="vertical-align: inherit;">Vous rencontrerez le m√™me probl√®me si vous essayez d'analyser la sortie RVB analogique du syst√®me: pour capturer ces donn√©es, vous devrez effectuer manuellement chacun des tests. </font><font style="vertical-align: inherit;">Un tel syst√®me n'est pas tr√®s bon pour cr√©er des tests de r√©gression automatis√©s reproductibles.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie vid√©o num√©rique en mode test</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©cemment, gr√¢ce √† un balayage de tranches de cristal avec un grossissement de 20x, un mode de test secret a √©t√© d√©couvert dans les puces PPU de la console SNES. Si vous apportez une petite modification mat√©rielle, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le PPU commencera √† √©mettre un signal RVB num√©rique 15 bits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est presque ce dont nous avons besoin! Cependant, ce mode a des probl√®mes, car le c√©l√®bre mode 7 ne peut pas y afficher l'image correcte. Il semble que cette fonction ne soit pas compl√®tement remplie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, pour mettre en ≈ìuvre cette m√©thode, une modification manuelle des consoles SNES et un m√©canisme appropri√© pour capturer et analyser la sortie en mode test sont encore n√©cessaires. </font><font style="vertical-align: inherit;">N√©anmoins, contrairement √† la solution de capture d'un signal RVB analogique, un tel signal num√©rique peut √™tre soumis √† des tests automatiques, ce qui peut nous permettre d'achever rapidement un grand nombre de travaux sur la r√©tro-ing√©nierie PPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Risers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que les PPU sont statiques, nous pourrions extraire les puces PPU d'une console SNES fonctionnelle et les connecter √† une carte de prototypage ou √† une carte de circuit imprim√© personnalis√©e avec deux puces VRAM. </font><font style="vertical-align: inherit;">Apr√®s cela, vous pouvez placer un microcontr√¥leur entre le PPU et l'interface USB et connecter l'interface au PC, ce qui permettra √† l'encodeur de programmer tous les registres de m√©moire vid√©o externes et PPU. </font><font style="vertical-align: inherit;">De plus, l'encodeur pourra contr√¥ler manuellement les cycles d'horloge PPU et lire les signaux r√©sultants sur les connecteurs d'E / S, les registres et dans la m√©moire PPU √† chaque cycle d'horloge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En modifiant l'√©mulateur logiciel pour qu'il g√©n√®re les m√™mes valeurs internes des connecteurs d'E / S, nous pourrions directement comparer le mat√©riel r√©el avec l'√©mulation, m√™me en temps r√©el. </font><font style="vertical-align: inherit;">Cependant, ce sera un travail tr√®s dur car nous ne pouvons pas encore voir les op√©rations internes du PPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retrait du couvercle</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, la solution la plus extr√™me consiste √† poursuivre l'√©tude du cristal en retirant le couvercle de la puce. </font><font style="vertical-align: inherit;">Nous avons d√©j√† des scans cristallins avec un grossissement de 20x, mais leur r√©solution n'est pas suffisante pour analyser et recr√©er des circuits logiques individuels, comme cela a √©t√© fait dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le projet Visual 6502</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si nous pouvons obtenir les analyses cristallines des deux PPU avec un grossissement de 100x, alors nous pouvons commencer le dur travail de compilation des circuits PPU et de les convertir en tables de connexion ou en code VHDL. </font><font style="vertical-align: inherit;">Ensuite, ils peuvent √™tre utilis√©s directement dans FPGA, ainsi que port√©s sur C ++ ou un autre langage de programmation, applicable pour cr√©er des √©mulateurs logiciels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un sp√©cialiste qui l'avait fait auparavant m'a donn√© une estimation approximative: il faudrait environ 600 heures pour cartographier les deux PPU. </font><font style="vertical-align: inherit;">Cette t√¢che est beaucoup plus √©lev√©e que le niveau de ¬´collectons de l'argent en collectant des fonds et payons quelqu'un¬ª, et tombe id√©alement dans la cat√©gorie ¬´esp√©rons que quelqu'un de tr√®s talentueux avec un ensemble unique de comp√©tences voudra nous aider volontairement¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, cela ne signifie pas que je ne serais pas heureux de r√©compenser financi√®rement quelqu'un pour son aide, je peux payer les d√©tails et le travail n√©cessaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande d'aide</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©sumer: je suis all√© le plus loin possible dans mon projet d'√©mulateur SNES, et j'ai besoin d'aide pour mener √† bien cette t√¢che finale. </font><font style="vertical-align: inherit;">Si vous avez lu jusqu'√† la fin, vous voudrez peut-√™tre aider! </font><font style="vertical-align: inherit;">Tout soutien, y compris la participation au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet bsnes sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou toute documentation de recherche sur le fonctionnement interne des puces PPU, nous sera d'une valeur inestimable! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci d'avoir lu et de votre soutien! </font><font style="vertical-align: inherit;">Ce fut un honneur pour moi depuis quinze ans d'√™tre membre de la communaut√© d'√©mulation SNES.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495256/index.html">√Ä propos des ports et du chiffrement dans les serveurs de messagerie</a></li>
<li><a href="../fr495258/index.html">Comment Zoom est devenu l'entreprise la plus importante √† l'√®re des coronavirus</a></li>
<li><a href="../fr495262/index.html">Pratique de mise √† niveau de la version PostgreSQL. Andrey Salnikov</a></li>
<li><a href="../fr495266/index.html">E-learning de la Renaissance. Pourquoi 2020 montrera tous les avantages de l'enseignement √† distance</a></li>
<li><a href="../fr495268/index.html">Cas UI / UX: automatisation du stationnement dans les a√©roports</a></li>
<li><a href="../fr495274/index.html">Comment r√©parer les fuites de route</a></li>
<li><a href="../fr495276/index.html">Et d√©montrer, ou comment nous avons r√©ussi l'audit de durabilit√© op√©rationnelle √† l'Uptime Institute</a></li>
<li><a href="../fr495278/index.html">Bases de donn√©es, cartes, listes de contr√¥le ou Pourquoi un gestionnaire de connaissances commerciales</a></li>
<li><a href="../fr495280/index.html">Max Patrol SIEM. Pr√©sentation du syst√®me de gestion des √©v√©nements de s√©curit√© de l'information</a></li>
<li><a href="../fr495282/index.html">Validation XML √† l'aide de XSD, JAXB et Spring Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>