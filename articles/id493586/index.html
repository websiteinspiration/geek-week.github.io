<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš¼ â›ï¸ ğŸ˜‰ Optimalisasi Kompiler JIT untuk .NET 5 ğŸ‘¨ğŸ¿â€ğŸ’» ğŸšˆ ğŸ±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beberapa waktu yang lalu, saya memulai perjalanan yang luar biasa ke dunia kompiler JIT untuk menemukan tempat di mana Anda dapat memasukkan tangan An...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimalisasi Kompiler JIT untuk .NET 5</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493586/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa waktu yang lalu, saya memulai perjalanan yang luar biasa ke dunia kompiler JIT untuk menemukan tempat di mana Anda dapat memasukkan tangan Anda dan mempercepat sesuatu, karena Dalam perjalanan pekerjaan utama, sejumlah kecil pengetahuan dalam LLVM dan pengoptimalannya telah terakumulasi. Dalam artikel ini, saya ingin berbagi daftar peningkatan saya di JIT (dalam. NET disebut RyuJIT untuk menghormati beberapa naga atau anime - Saya tidak mengetahuinya), yang sebagian besar telah mencapai master dan akan tersedia di .NET (Core) 5 Optimalisasi saya memengaruhi berbagai fase JIT, yang dapat ditampilkan secara sangat skematis sebagai berikut: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/ao/qk/diaoqktgwhzremeu8qd8inutrak.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang dapat dilihat dari diagram, JIT adalah modul terpisah yang terkait dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jit-Interface</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sempit </font><font style="vertical-align: inherit;">, di mana JIT berkonsultasi tentang beberapa hal, misalnya, apakah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mungkin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">melemparkan satu kelas ke kelas lain. </font><font style="vertical-align: inherit;">Semakin lama JIT mengkompilasi metode ke Tier1, semakin banyak informasi yang dapat diberikan runtime, misalnya, bahwa </font></font><code>static readonly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bidang dapat diganti dengan konstanta, karena </font><font style="vertical-align: inherit;">kelas sudah diinisialisasi secara statis.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, mari kita mulai dengan daftarnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1817</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Optimasi tinju / unboxing dalam pencocokan pola</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Importir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Banyak fitur C # baru sering berdosa dengan memasukkan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kotak / unbox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opcode CIL </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini adalah operasi yang sangat mahal, yang pada dasarnya adalah alokasi objek baru pada heap, menyalin nilai dari stack ke dalamnya, dan kemudian juga memuat GC pada akhirnya. </font><font style="vertical-align: inherit;">Sudah ada sejumlah optimasi dalam JIT untuk kasus ini, tetapi saya menemukan pencocokan pola yang hilang di C # 8, misalnya:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case1&lt;T&gt;(T o)<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">is</span> <span class="hljs-keyword">int</span> x)
        <span class="hljs-keyword">return</span> x;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case2&lt;T&gt;(T o) =&gt; o <span class="hljs-keyword">is</span> <span class="hljs-keyword">int</span> n ? n : <span class="hljs-number">42</span>;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case3&lt;T&gt;(T o)<font></font>
{<font></font>
    <span class="hljs-keyword">return</span> o <span class="hljs-keyword">switch</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> n =&gt; n,
        <span class="hljs-keyword">string</span> str =&gt; str.Length,<font></font>
        _ =&gt; <span class="hljs-number">0</span><font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan mari kita lihat asm-codegen sebelum optimasi saya (misalnya, untuk spesialisasi int) untuk ketiga metode: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/5m/8h/iv5m8hqdrwqazfpztoh_n0o0lho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang setelah peningkatan saya: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-t/f7/bx/-tf7bxj9jip9xzpa9nr3ccelv9w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faktanya adalah optimasi telah menemukan pola kode IL</font></font><br>
<br>
<pre><code class="plaintext hljs">box !!T<font></font>
isinst Type1<font></font>
unbox.any Type2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ketika mengimpor dan memiliki informasi tentang jenis, saya bisa mengabaikan opcodes ini dan tidak memasukkan tinju-anbox. </font><font style="vertical-align: inherit;">Omong-omong, saya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menerapkan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimasi yang sama </font><font style="vertical-align: inherit;">di Mono juga. </font><font style="vertical-align: inherit;">Selanjutnya, tautan ke Tarik-Permintaan terdapat di header deskripsi optimisasi.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1157</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> typeof (T) .IsValueType â‡¨ benar / salah</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Importir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini saya melatih JIT untuk segera mengganti </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type.IsValueType</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan konstanta jika memungkinkan. </font><font style="vertical-align: inherit;">Ini adalah minus tantangan dan kemampuan untuk memotong seluruh kondisi dan cabang di masa depan, contohnya:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">void</span> Foo&lt;T&gt;()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">typeof</span>(T).IsValueType)<font></font>
        Console.WriteLine(<span class="hljs-string">"not a valuetype"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan mari kita lihat codegen untuk </font><font style="vertical-align: inherit;">spesialisasi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;int&gt; Foo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebelum perbaikan: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oa/28/lc/oa28lcmskvzitsjlpqr5dlh8uv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan setelah perbaikan: Hal yang </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zw/db/n_/zwdbn_ukemjzxf9qbkato_ptblm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sama dapat dilakukan dengan properti Type lainnya jika perlu.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1157</font></font></a> <code>typeof(T1).IsAssignableFrom(typeof(T2)) â‡¨ true/false</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Importir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hampir sama - sekarang Anda dapat memeriksa hierarki dalam metode generik tanpa takut ini tidak dioptimalkan, misalnya:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">void</span> Foo&lt;T1, T2&gt;()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">typeof</span>(T1).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T2)))<font></font>
        Console.WriteLine(<span class="hljs-string">"T1 is not assignable from T2"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan cara yang sama, itu akan digantikan oleh konstanta </font></font><code>true/false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan kondisinya dapat dihapus seluruhnya. </font><font style="vertical-align: inherit;">Dalam optimasi seperti itu, tentu saja, ada beberapa kasus sudut yang harus selalu Anda ingat: Sistem .__ Canon berbagi generik, array, variabilitas co (ntr), nullables, objek COM, dll.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1378</font></font></a> <code>"Hello".Length â‡¨ 5</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Importir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa optimasi sejelas dan sesederhana mungkin, saya harus banyak berkeringat untuk mengimplementasikannya di JIT-e. Masalahnya adalah bahwa JIT tidak tahu tentang isi string, ia melihat string literal ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GT_CNS_STR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), tetapi tidak tahu apa-apa tentang konten spesifik dari string. Saya harus membantunya dengan menghubungi VM (untuk memperluas JIT-Interface yang disebutkan sebelumnya), dan optimasi itu sendiri pada dasarnya adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa baris kode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ada banyak kasus pengguna, selain yang jelas, seperti: </font></font><b><code>str.IndexOf("foo") + "foo".Length</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk yang tidak jelas yang melibatkan inlining (saya ingatkan Anda: Roslyn tidak berurusan dengan inlining, jadi pengoptimalan ini tidak akan efektif di dalamnya, selain itu, seperti yang lainnya), misalnya:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Validate</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> str</span>)</span> =&gt; str.Length &gt; <span class="hljs-number">0</span> &amp;&amp; str.Length &lt;= <span class="hljs-number">100</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Test</span>(<span class="hljs-params"></span>)</span> =&gt; Validate(<span class="hljs-string">"Hello"</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat codegen untuk </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Validate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inline): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sl/kl/dz/slkldz4tb8stxhrq_bhz7cmqkdm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan sekarang codegen setelah menambahkan optimasi: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4p/ao/f5/4paof5hshv_gsogtwqsocahc6vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
i.e. </font><font style="vertical-align: inherit;">sebaris metode, ganti variabel dengan string literal, ganti .Panjang dari literal dengan panjang string nyata, lipat konstanta, hapus kode mati. </font><font style="vertical-align: inherit;">Omong-omong, karena JIT sekarang dapat memeriksa isi string, pintu telah terbuka untuk optimisasi lain yang terkait dengan string string. </font><font style="vertical-align: inherit;">Optimasi itu sendiri disebutkan dalam pengumuman pratinjau pertama. NET 5.0: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devblogs.microsoft.com/dotnet/announcing-net-5-0-preview-1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di bagian </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peningkatan kualitas Kode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bagian </font><b><font style="vertical-align: inherit;">di RyuJIT</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1644:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mengoptimalkan Cek Terikat.</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Batas Memeriksa Penghapusan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagi banyak orang, itu tidak akan menjadi rahasia bahwa setiap kali Anda mengakses array dengan indeks, JIT menyisipkan cek untuk Anda bahwa array tidak melampaui dan melempar pengecualian jika ini terjadi - dalam kasus logika yang salah, Anda tidak bisa untuk membaca memori acak, dapatkan nilai dan lanjutkan.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Foo</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>[] array, <span class="hljs-keyword">int</span> index</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">// if ((uint) array.Length &lt;= (uint) index)</span>
    <span class="hljs-comment">//     throw new IndexOutOfRangeException();</span>
    <span class="hljs-keyword">return</span> array[index];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemeriksaan semacam itu bermanfaat, tetapi dapat sangat memengaruhi kinerja: pertama, ia menambah operasi perbandingan dan membuat kode Anda tidak bercabang, dan kedua, itu menambahkan kode panggilan pengecualian ke metode Anda dengan semua konsekuensinya. Namun, dalam banyak kasus, JIT dapat menghapus cek ini jika dapat membuktikan kepada dirinya sendiri bahwa indeks tidak akan pernah melampaui itu, atau bahwa sudah ada beberapa cek lainnya dan Anda tidak perlu menambahkan satu lagi - Batas (Rentang) Eliminasi Batas. Saya menemukan beberapa kasus di mana dia tidak bisa mengatasi dan memperbaikinya (dan di masa depan saya merencanakan beberapa perbaikan lebih lanjut dari fase ini).</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> item = array[index &amp; mask];</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini, dalam kode ini, saya memberi tahu JIT bahwa </font></font><code>&amp; mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada dasarnya membatasi indeks dari atas ke nilai </font></font><code>mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mis. </font><font style="vertical-align: inherit;">jika nilai </font></font><code>mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan panjang array </font><font style="vertical-align: inherit;">diketahui oleh JIT </font><font style="vertical-align: inherit;">, Anda tidak bisa memasukkan cek terikat. </font><font style="vertical-align: inherit;">Hal yang sama berlaku untuk operasi%, (&amp; x &gt;&gt; y). </font><font style="vertical-align: inherit;">Contoh menggunakan optimasi ini di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aspnetcore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga, jika kita tahu bahwa dalam array kita, misalnya, ada 256 elemen atau lebih, maka jika pengindeks tidak dikenal kita adalah tipe byte, tidak peduli seberapa keras ia mencoba, itu tidak akan pernah bisa keluar dari batas. </font><font style="vertical-align: inherit;">PR: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/dotnet/coreclr/pull/25912</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 24584:</font></font></a> <code>x / 2 â‡¨ x * 0.5</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Morph </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C PR ini dan memulai penyelaman menakjubkan saya ke dunia optimasi JIT. </font><font style="vertical-align: inherit;">Operasi "divisi" lebih lambat dari operasi "perkalian" (dan jika untuk bilangan bulat dan secara umum - urutan besarnya). </font><font style="vertical-align: inherit;">Bekerja untuk konstanta hanya setara dengan kekuatan dua, contoh:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">DivideBy2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; x / <span class="hljs-number">2</span>; <span class="hljs-comment">// = x * 0.5; </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen sebelum optimasi: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/vo/mf/dfvomfc6foisqpk9uvq8nfihfzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan setelah: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/xk/u5/ijxku5zq0hhxmltazwxgfq1tvss.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita membandingkan dua instruksi ini untuk Haswell, maka semuanya akan menjadi jelas:</font></font><br>
<br>
<pre><code class="plaintext hljs">vdivss (Latency: 10-20,  R.Throughput: 7-14)<font></font>
vmulss (Latency:     5,  R.Throughput:  0.5)<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini akan diikuti oleh optimisasi yang masih dalam tahap tinjauan kode dan bukan fakta bahwa mereka akan diterima.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 31978:</font></font></a> <code>Math.Pow(x, 2) â‡¨ x * x</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Importir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya sederhana di sini: alih-alih memanggil pow (f) untuk kasus yang agak populer, ketika derajatnya konstan 2 (well, gratis untuk 1, -1, 0), Anda dapat mengembangkannya menjadi x * x sederhana. </font><font style="vertical-align: inherit;">Anda dapat memperluas derajat lainnya, tetapi untuk ini Anda harus menunggu implementasi mode "matematika cepat" di .NET, di mana spesifikasi IEEE-754 dapat diabaikan untuk kinerja. </font><font style="vertical-align: inherit;">Contoh:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">Pow2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; MathF.Pow(x, <span class="hljs-number">2</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen sebelum optimasi: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/7m/zw/1o7mzwatkp3kritfyahj_zjhija.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan setelah:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/el/9g/19/el9g19y1rul_r4sej7fx7sixiso.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 33024:</font></font></a> <code>x * 2 â‡¨ x + x</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menurunkan </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga optimisasi piphol mikro (nano) yang cukup sederhana, memungkinkan Anda untuk mengalikan 2 tanpa memuat konstanta ke dalam register.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">MultiplyBy2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; x * <span class="hljs-number">2</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen sebelum optimisasi: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e7/4s/-r/e74s-rigvhc6eh14gl7ygnbeqva.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d5/wg/ru/d5wgrutrxfvbsccck-hhjdvw37w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, instruksi </font></font><code>mul(ss/sd/ps/pd)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sama dalam latensi dan throughput </font></font><code>add(ss/sd/ps/pd)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi kebutuhan untuk memuat konstanta "2" dapat sedikit memperlambat pekerjaan. </font><font style="vertical-align: inherit;">Di sini, dalam contoh codegen di atas, saya </font></font><code>vaddss</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">melakukan semuanya dalam register yang sama.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 32368:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimalisasi Array. Panjang / c (atau% s)</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Morph </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kebetulan bidang Panjang Array adalah tipe yang ditandatangani, dan pembagian dan sisanya oleh konstanta jauh lebih efisien untuk dilakukan dari tipe yang tidak ditandatangani (dan bukan hanya kekuatan dua), bandingkan saja codegen ini: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7u/cf/0a/7ucf0a2z26ew1ndszgycipb4dxw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PR saya hanya mengingatkan JIT bahwa </font></font><code>Array.Length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meskipun signifikan, tetapi pada kenyataannya, panjang array TIDAK PERNAH ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kecuali Anda seorang anarkis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) bisa kurang dari nol, yang berarti Anda dapat melihatnya sebagai angka yang tidak ditandatangani dan menerapkan beberapa optimasi seperti untuk uint.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 32716:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimalisasi perbandingan sederhana dalam kode tanpa cabang</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Analisis aliran </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah kelas optimisasi lain yang beroperasi dengan blok dasar alih-alih ekspresi dalam satu. </font><font style="vertical-align: inherit;">Di sini JIT agak konservatif dan memiliki ruang untuk perbaikan, misalnya memasukkan cmove jika memungkinkan. </font><font style="vertical-align: inherit;">Saya mulai dengan optimasi sederhana untuk kasus ini:</font></font><br>
<br>
<pre><code class="cs hljs">x = condition ? A : B;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
jika A dan B adalah konstanta dan perbedaannya adalah satu, misalnya, </font></font><code>condition ? 1 : 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maka kita, mengetahui bahwa operasi perbandingan itu sendiri mengembalikan 0 atau 1, dapat menggantikan lompatan dengan add. </font><font style="vertical-align: inherit;">Dalam hal RyuJIT, tampilannya seperti ini: Saya </font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/y8/rv/amy8rv0tjz3vxzelpbz1lhgqr6a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sarankan untuk melihat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deskripsi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PR itu sendiri, saya harap semuanya dijelaskan dengan jelas di sana.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak semua optimasi sama-sama bermanfaat.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optimalisasi memerlukan biaya yang agak tinggi: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Meningkatkan = kompleksitas kode yang ada untuk dukungan dan membaca </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Potensi bug: menguji optimisasi kompiler gila-gilaan sulit dan mudah ketinggalan sesuatu dan mendapatkan semacam segfault dari pengguna. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Kompilasi yang lambat </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Meningkatkan ukuran binar JIT </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang sudah Anda pahami, tidak semua ide dan prototipe optimasi diterima dan perlu untuk membuktikan bahwa mereka memiliki hak untuk hidup. Salah satu cara yang diterima untuk membuktikan hal ini di .NET adalah dengan menjalankan utilitas jit-utils, yang akan AOT mengkompilasi seperangkat pustaka (semua BCL dan corelib) dan membandingkan kode assembler untuk semua metode sebelum dan setelah optimisasi, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini adalah cara laporan ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mencari pengoptimalan</font></font><code>"str".Length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Selain laporan tersebut, ada juga lingkaran orang-orang tertentu (seperti </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jkotas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) yang, sekilas, dapat mengevaluasi kegunaan dan meretas segala sesuatu dari puncak pengalaman mereka dan memahami tempat-tempat mana di .NET bisa menjadi hambatan dan mana yang tidak bisa. </font><font style="vertical-align: inherit;">Dan satu hal lagi: jangan menilai optimasi dengan argumen "tidak ada yang menulis", "akan lebih baik untuk hanya menampilkan peringatan di Roslyn" - Anda tidak pernah tahu bagaimana kode Anda akan menjaga JIT menguraikan segala sesuatu yang mungkin dan mengisi konstanta.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id493574/index.html">Proxy lokal untuk memfilter lalu lintas browser</a></li>
<li><a href="../id493578/index.html">Intisari bahan-bahan segar dari dunia front-end untuk minggu terakhir No. 407 (16 - 22 Maret 2020)</a></li>
<li><a href="../id493580/index.html">Belajar untuk menggunakan layanan microser. Bagian 4. Jenkins</a></li>
<li><a href="../id493582/index.html">Musim panas buatan: ultraviolet jauh melawan coronavirus</a></li>
<li><a href="../id493584/index.html">Berita dari dunia OpenStreetMap No. 503 (03.03.2020-09.03.2020)</a></li>
<li><a href="../id493590/index.html">Mengapa Cisco AnyConnect Bukan Hanya Klien VPN</a></li>
<li><a href="../id493594/index.html">PHP Digest No. 176 (11-23 Maret 2020)</a></li>
<li><a href="../id493596/index.html">Pria yang tidak terburu-buru</a></li>
<li><a href="../id493598/index.html">Sembunyikan bagian dari nomor telepon</a></li>
<li><a href="../id493604/index.html">Acara digital di Moskow dari tanggal 23 hingga 29 Maret</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>