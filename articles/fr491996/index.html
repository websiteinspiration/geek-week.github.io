<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÇ üßü üëµüèº En savoir plus sur Coroutines en C ++ ü§∂üèø ü•ú üë©üèª‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour chers coll√®gues. 
 
 Dans le cadre du d√©veloppement du th√®me C ++ 20, nous sommes tomb√©s √† un moment sur un article assez ancien (septembre 20...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>En savoir plus sur Coroutines en C ++</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/491996/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour chers coll√®gues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre du d√©veloppement du th√®me C ++ 20, nous sommes tomb√©s √† un moment sur un article assez ancien (septembre 2018) du journal de bord de Yandex, qui s'appelle ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se pr√©parer pour C ++ 20. Coroutines TS avec un exemple r√©el</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª. Il se termine par le vote tr√®s expressif suivant: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a-/m4/xn/a-m4xn5j3yjfy-yl2et7aeek7sc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬´Pourquoi pas¬ª, nous avons d√©cid√© et traduit un article de David Pilarski sous le titre ¬´Coroutines introduction¬ª. L'article a √©t√© publi√© il y a un peu plus d'un an, mais j'esp√®re que vous le trouverez de toute fa√ßon tr√®s int√©ressant.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors c'est arriv√©. Apr√®s beaucoup de doutes, de controverses et de pr√©paration de cette fonctionnalit√©, le WG21 est parvenu √† une opinion commune sur ce √† quoi les coroutines devraient ressembler en C ++ - et il est tr√®s probable qu'elles seront incluses en C ++ 20. √âtant donn√© qu'il s'agit d'une fonctionnalit√© majeure, je pense qu'il est temps de la pr√©parer et de l'√©tudier d√©j√† maintenant (comme vous vous en souvenez, il y a encore plus de modules, de concepts, de gammes √† apprendre ...) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup s'opposent encore √† la coroutine. Souvent, ils se plaignent de la complexit√© de leur d√©veloppement, de nombreux points de personnalisation et, √©ventuellement, de performances sous-optimales en raison, √©ventuellement, d'une allocation sous-optimis√©e de la m√©moire dynamique (peut-√™tre;)).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parall√®lement au d√©veloppement de sp√©cifications techniques (TS) approuv√©es (officiellement publi√©es), m√™me des tentatives ont √©t√© faites pour d√©velopper en parall√®le un autre m√©canisme de la corutine. </font><font style="vertical-align: inherit;">Nous parlerons ici des coroutines d√©crites dans TS ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sp√©cifications techniques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Une approche alternative, √† son tour, appartient √† Google. </font><font style="vertical-align: inherit;">En cons√©quence, il s'est av√©r√© que l'approche de Google souffre de nombreux probl√®mes, dont la solution n√©cessite souvent d'√©tranges fonctionnalit√©s suppl√©mentaires de C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au final, il a √©t√© d√©cid√© d'adopter une version de Corutin d√©velopp√©e par Microsoft (sponsoris√©e par TS). </font><font style="vertical-align: inherit;">C'est √† propos de ces coroutines qui seront discut√©es dans cet article. </font><font style="vertical-align: inherit;">Commen√ßons donc par la question de ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que sont les coroutines?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les coroutines existent d√©j√† dans de nombreux langages de programmation, par exemple en Python ou C #. </font><font style="vertical-align: inherit;">Les coroutines sont une autre fa√ßon de cr√©er du code asynchrone. </font><font style="vertical-align: inherit;">En quoi ils diff√®rent des flux, pourquoi les coroutines doivent √™tre impl√©ment√©es en tant que fonctionnalit√© de langage d√©di√© et, enfin, quelle est leur utilisation sera expliqu√©e dans cette section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un grave malentendu concernant ce que sont les coroutines. </font><font style="vertical-align: inherit;">Selon l'environnement dans lequel ils sont utilis√©s, ils peuvent √™tre appel√©s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutines sans pile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empiler les coroutines</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruisseaux verts</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les fibres</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gorutins</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La bonne nouvelle: les corutines empil√©es, les ruisseaux verts, les fibres et les gorutines sont une seule et m√™me chose (mais ils sont parfois utilis√©s de diff√©rentes mani√®res). Nous en parlerons plus loin dans cet article et nous les appellerons fibres ou empiler coroutines. Mais la coroutine sans pile poss√®de certaines fonctionnalit√©s qui doivent √™tre discut√©es s√©par√©ment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre les coroutines, y compris au niveau intuitif, apprenons bri√®vement les fonctions et (disons-le ainsi) ¬´leur API¬ª. La fa√ßon standard de travailler avec eux est d'appeler et d'attendre la fin:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span>{
     <span class="hljs-keyword">return</span>; <span class="hljs-comment">//     </span><font></font>
}	<font></font>
foo(); <span class="hljs-comment">//   / </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir appel√© la fonction, il est d√©j√† impossible de faire une pause ou de reprendre son travail. Vous ne pouvez effectuer que deux op√©rations sur les fonctions: </font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>finish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lorsque la fonction est lanc√©e, vous devez attendre qu'elle soit termin√©e. Si la fonction est appel√©e √† nouveau, son ex√©cution se poursuivra d√®s le d√©but. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec les coroutines, la situation est diff√©rente. Vous pouvez non seulement les d√©marrer et les arr√™ter, mais √©galement les suspendre et les reprendre. Ils sont toujours diff√©rents des flux principaux, car les coroutines elles-m√™mes ne sont pas √©vinc√©es (d'un autre c√¥t√©, les coroutines se r√©f√®rent g√©n√©ralement au flux et le flux est √©vinc√©). Pour comprendre cela, consid√©rons un g√©n√©rateur d√©fini en Python. Qu'une telle chose soit appel√©e g√©n√©rateur en Python, en C ++ ce serait appel√© coroutine. Un exemple est tir√© de ce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_nums</span>():</span>
     num = <span class="hljs-number">0</span>
     <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
          <span class="hljs-keyword">yield</span> num<font></font>
          num = num + <span class="hljs-number">1</span>	<font></font>
<font></font>
nums = generate_nums()<font></font>
	<font></font>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> nums:<font></font>
     print(x)<font></font>
	<font></font>
     <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">9</span>:
          <span class="hljs-keyword">break</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici comment ce code fonctionne: un appel de fonction </font></font><code>generate_nums</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conduit √† la cr√©ation d'un objet coroutine. </font><font style="vertical-align: inherit;">√Ä chaque √©tape de l'√©num√©ration d'un objet coroutine, la coroutine elle-m√™me reprend le travail et ne l'interrompt qu'apr√®s un mot cl√© </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le code; </font><font style="vertical-align: inherit;">puis l'entier suivant de la s√©quence est retourn√© (la boucle for est du sucre syntaxique pour appeler une fonction </font></font><code>next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui reprend coroutine). </font><font style="vertical-align: inherit;">Le code termine la boucle en rencontrant une instruction break. </font><font style="vertical-align: inherit;">Dans ce cas, la corutine ne se termine jamais, mais il est facile d'imaginer une situation dans laquelle la corutine atteint la fin et se termine. </font><font style="vertical-align: inherit;">Comme on peut le </font><font style="vertical-align: inherit;">voir, √† une op√©ration applicable korutine </font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>suspend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>resume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et enfin,</font></font><code>finish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">[Remarque: C ++ fournit √©galement des op√©rations de cr√©ation et de destruction, mais elles ne sont pas importantes dans le contexte d'une compr√©hension intuitive de coroutine].</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutines comme biblioth√®que</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, maintenant, il est √† peu pr√®s clair ce que sont les coroutines. </font><font style="vertical-align: inherit;">Vous savez peut-√™tre qu'il existe des biblioth√®ques pour cr√©er des objets en fibre. </font><font style="vertical-align: inherit;">La question est, pourquoi avons-nous besoin de coroutines sous la forme d'une fonctionnalit√© de langage d√©di√©e, et pas seulement d'une biblioth√®que qui fonctionnerait avec des coroutines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous essayons de r√©pondre √† cette question et de d√©montrer la diff√©rence entre les coroutines empil√©es et sans pile. </font><font style="vertical-align: inherit;">Cette diff√©rence est essentielle pour comprendre la corutine comme faisant partie du langage.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empiler les coroutines</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons d'abord ce que sont les coroutines de pile, comment elles fonctionnent et pourquoi elles peuvent √™tre impl√©ment√©es en tant que biblioth√®que. </font><font style="vertical-align: inherit;">Les expliquer est relativement simple, car ils ressemblent √† des flux en termes de conception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La corutine de fibre ou de pile a une pile distincte qui peut √™tre utilis√©e pour g√©rer les appels de fonction. </font><font style="vertical-align: inherit;">Afin de comprendre exactement comment fonctionnent les coroutines de ce type, nous consid√©rons bri√®vement les cadres de fonction et les appels de fonction d'un point de vue de bas niveau. </font><font style="vertical-align: inherit;">Mais d'abord, parlons des propri√©t√©s des fibres.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils ont leur propre pile,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La dur√©e de vie des fibres ne d√©pend pas du code qui les appelle (g√©n√©ralement elles ont un ordonnanceur d√©fini par l'utilisateur),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les fibres peuvent √™tre d√©tach√©es d'un fil et attach√©es √† un autre,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planification coop√©rative (la fibre doit d√©cider de passer √† une autre fibre / ordonnanceur),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ne peut pas fonctionner simultan√©ment dans le m√™me thread.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les effets suivants r√©sultent des propri√©t√©s ci-dessus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le changement de contexte des fibres doit √™tre effectu√© par l'utilisateur des fibres, et non par l'OS (en outre, l'OS peut lib√©rer la fibre, lib√©rant le fil dans lequel il fonctionne),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'y a pas de v√©ritable course aux donn√©es entre les deux fibres, car √† tout moment une seule d'entre elles peut √™tre active,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le concepteur de fibres doit √™tre en mesure de choisir le bon endroit et l'heure, o√π et quand il convient de restituer la puissance de calcul √† un ordonnanceur ou √† un appelant √©ventuel.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les op√©rations d'entr√©e / sortie dans la fibre doivent √™tre asynchrones, afin que d'autres fibres puissent effectuer leurs t√¢ches sans se bloquer.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons maintenant de plus pr√®s le fonctionnement des fibres et expliquons d'abord comment la pile participe aux appels de fonction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la pile est un bloc de m√©moire continu n√©cessaire pour stocker des variables locales et des arguments de fonction. Mais, plus important encore, apr√®s chaque appel de fonction (√† quelques exceptions pr√®s), des informations suppl√©mentaires sont ins√©r√©es dans la pile qui indiquent √† la fonction appel√©e comment retourner √† l'appelant et restaurer les registres du processeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains de ces registres ont des affectations sp√©ciales et lors de l'appel de fonctions, ils sont stock√©s sur la pile. Ce sont les registres (dans le cas de l'architecture ARM): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SP - pointeur de pile </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LR - registre de communication </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PC - </font><b><font style="vertical-align: inherit;">pointeur de pile de</font></b><font style="vertical-align: inherit;"> compteur de programme</font></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(SP) est un registre qui contient l'adresse du d√©but de la pile li√©e √† l'appel de fonction en cours. Gr√¢ce √† la valeur existante, vous pouvez facilement vous r√©f√©rer aux arguments et aux variables locales stock√©s sur la pile. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le registre de communication</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (LR) est tr√®s important lors de l'appel de fonctions. Il stocke l'adresse de retour (l'adresse de l'appelant), o√π le code sera ex√©cut√© une fois l'ex√©cution de la fonction en cours termin√©e. Lorsque la fonction est appel√©e, le PC est enregistr√© dans LR. Lorsque la fonction revient, le PC est restaur√© √† l'aide de LR. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le compteur de programme</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (PC) est l'adresse de l'instruction en cours d'ex√©cution. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque fois qu'une fonction est appel√©e, la liste des liens est enregistr√©e, afin que la fonction sache o√π le programme doit retourner une fois termin√©.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/r2/yk/njr2ykw0o6hrsww5-uq3ybjjddg.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le comportement des registres PC et LR lors de l'appel et du retour d'une fonction</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Lors de l'ex√©cution d'une coroutine de pile, les fonctions appel√©es utilisent la pile pr√©c√©demment allou√©e pour stocker ses arguments et ses variables locales. </font><font style="vertical-align: inherit;">√âtant donn√© que toutes les informations sur chaque fonction appel√©e dans la corutine de pile sont stock√©es sur la pile, la fibre peut suspendre toute fonction au sein de cette corutine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/r2/yk/njr2ykw0o6hrsww5-uq3ybjjddg.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qui se passe sur cette image. </font><font style="vertical-align: inherit;">Tout d'abord, chaque fibre et chaque fil a sa propre pile distincte. </font><font style="vertical-align: inherit;">La couleur verte indique les num√©ros de s√©rie indiquant la s√©quence d'actions.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un appel de fonction r√©gulier √† l'int√©rieur d'un thread. </font><font style="vertical-align: inherit;">La m√©moire est allou√©e sur la pile.</font></font></li>
<li><b>   </b>.      .     ,      .    .       ,              . </li>
<li>  .</li>
<li><b> </b>.       .</li>
<li>    .</li>
<li>    .</li>
<li><b> </b>.    ,    , ,      .</li>
<li>    .</li>
<li>    .</li>
<li><b> </b> ‚Äì     ,     . </li>
<li>        ,      .</li>
<li>    .      . </li>
<li>       .    :   ,    . ,          (  ) .</li>
<li>  ,   .</li>
<li>  .</li>
<li><b> </b>.   .     .    ,      .</li>
<li>     .</li>
<li>      , ,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous travaillez avec des coroutines de pile, il n'est pas n√©cessaire de disposer d'une fonction de langue d√©di√©e qui garantirait leur utilisation. </font><font style="vertical-align: inherit;">L'int√©gralit√© du korutiny de la pile doit √™tre impl√©ment√©e √† l'aide de biblioth√®ques, et il existe d√©j√† des biblioth√®ques con√ßues sp√©cifiquement √† cet effet: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swtch.com/libtask </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code.google.com/archive/p/libconcurrency </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.boost.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Boost.Fiber </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.boost.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the Boost .Coroutine </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toutes ces biblioth√®ques, seul Boost est C ++, et tous les autres sont C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une description d√©taill√©e du fonctionnement de ces biblioth√®ques, </font><font style="vertical-align: inherit;">voir la </font><font style="vertical-align: inherit;">documentation. </font><font style="vertical-align: inherit;">Mais, en g√©n√©ral, toutes ces biblioth√®ques vous permettent de cr√©er une pile distincte pour la fibre et offrent la possibilit√© de reprendre la coroutine (√† l'initiative de l'appelant) et de la mettre en pause (de l'int√©rieur).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons un exemple </font></font><code>Boost.Fiber</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
	<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;boost/intrusive_ptr.hpp&gt;</span></span><font></font>
	<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;boost/fiber/all.hpp&gt;</span></span><font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword">inline</span>
<span class="hljs-keyword">void</span> <span class="hljs-title">fn</span><span class="hljs-params">( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-keyword">const</span>&amp; str, <span class="hljs-keyword">int</span> n)</span> </span>{
     <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; str &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
               boost::this_fiber::yield();<font></font>
     }<font></font>
}<font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
     <span class="hljs-keyword">try</span> {<font></font>
          boost::<span class="hljs-function">fibers::fiber <span class="hljs-title">f1</span><span class="hljs-params">( fn, <span class="hljs-string">"abc"</span>, <span class="hljs-number">5</span>)</span></span>;
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"f1 : "</span> &lt;&lt; f1.get_id() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
          f1.join();<font></font>
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"done."</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
	<font></font>
          <span class="hljs-keyword">return</span> EXIT_SUCCESS;<font></font>
     } <span class="hljs-keyword">catch</span> ( <span class="hljs-built_in">std</span>::exception <span class="hljs-keyword">const</span>&amp; e) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"exception: "</span> &lt;&lt; e.what() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
     } <span class="hljs-keyword">catch</span> (...) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"unhandled exception"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
     }<font></font>
     <span class="hljs-keyword">return</span> EXIT_FAILURE;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boost.Fiber</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la biblioth√®que a un planificateur int√©gr√© pour coroutine. </font><font style="vertical-align: inherit;">Toutes les fibres passent dans le m√™me fil. </font><font style="vertical-align: inherit;">Comme la planification de la corutine est coop√©rative, la fibre doit d'abord d√©cider quand rendre le contr√¥le au programmateur. </font><font style="vertical-align: inherit;">Dans cet exemple, cela se produit lorsque la fonction yield est appel√©e, ce qui interrompt la coroutine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisqu'il n'y a pas d'autre fibre, le planificateur de fibres d√©cide toujours de reprendre la coroutine.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutines sans pile</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les coroutines sans pile diff√®rent l√©g√®rement en propri√©t√©s de celles en pile. </font><font style="vertical-align: inherit;">Cependant, ils ont les m√™mes caract√©ristiques de base, car les coroutines non empil√©es peuvent √©galement √™tre d√©marr√©es, et apr√®s leur suspension peut √™tre reprise. </font><font style="vertical-align: inherit;">Des coroutines de ce type que nous trouverons probablement en C ++ 20. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons des propri√©t√©s similaires de la corutine - les coroutines peuvent:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corutin est √©troitement li√©e √† son appelant: lorsqu'une coroutine est appel√©e, l'ex√©cution lui est transf√©r√©e et le r√©sultat de la coroutine est retransf√©r√© √† l'appelant.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La dur√©e de vie d'une pile de corutine est √©gale √† la dur√©e de vie de sa pile. </font><font style="vertical-align: inherit;">La dur√©e de vie d'une coroutine sans pile est √©gale √† la dur√©e de vie de son objet.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, dans le cas de coroutines sans pile, il n'est pas n√©cessaire d'allouer une pile enti√®re. Ils consomment beaucoup moins de m√©moire que ceux de la pile, mais cela est pr√©cis√©ment d√ª √† certaines de leurs limitations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, s'ils n'allouent pas de m√©moire √† la pile, comment fonctionnent-ils? O√π, dans leur cas, toutes les donn√©es doivent √™tre stock√©es sur la pile lorsque vous travaillez avec des coroutines de pile. R√©ponse: sur la pile de l'appelant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le secret des coroutines sans pile est qu'elles ne peuvent se suspendre qu'√† la fonction la plus √©lev√©e. Pour toutes les autres fonctions, leurs donn√©es sont situ√©es sur la pile du c√¥t√© appel√©, donc toutes les fonctions appel√©es √† partir de la corutine doivent √™tre termin√©es avant que le travail de la corutine ne soit suspendu. Toutes les donn√©es n√©cessaires √† la coroutine pour maintenir son √©tat sont allou√©es dynamiquement sur le tas. Cela n√©cessite g√©n√©ralement quelques variables et arguments locaux, qui sont beaucoup plus compacts qu'une pile enti√®re qui devrait √™tre allou√©e √† l'avance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetez un ≈ìil au fonctionnement des corutines </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/vc/nw/owvcnwldgczpxdmjorsjlrh3yvm.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sans pile</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, il n'y a maintenant qu'une seule pile - c'est la pile principale du thread. </font><font style="vertical-align: inherit;">Examinons pas √† pas ce qui est montr√© dans cette image (le cadre d'activation de la coroutine est ici bicolore - le noir montre ce qui est stock√© sur la pile et le bleu - ce qui est stock√© sur le tas).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un appel de fonction r√©gulier dont la trame est stock√©e sur la pile</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fonction cr√©e une coroutine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Autrement dit, il lui alloue une trame d'activation quelque part sur le tas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de fonction normale.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appelez Corutin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le corps de Corutin se d√©marque dans une pile r√©guli√®re. </font><font style="vertical-align: inherit;">Le programme est ex√©cut√© de la m√™me mani√®re que dans le cas d'une fonction r√©guli√®re.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un appel de fonction r√©gulier de coroutine. </font><font style="vertical-align: inherit;">Encore une fois, tout se passe toujours sur la pile [Remarque: vous ne pouvez pas suspendre la coroutine √† partir de ce point, car ce n'est pas la fonction la plus √©lev√©e de la coroutine]</font></font></li>
<li>       [:     .]</li>
<li>  ‚Äì  ,        ,     .</li>
<li>  </li>
<li><b>  </b> ‚Äì      ,        +     .</li>
<li>     5.</li>
<li>     6.</li>
<li><b> </b>.        .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, il est √©vident que dans le deuxi√®me cas, il est n√©cessaire de se souvenir de beaucoup moins de donn√©es pour toutes les op√©rations de suspension et de reprise du travail de coroutine, cependant, la coroutine peut reprendre et suspendre uniquement elle-m√™me, et uniquement √† partir de la fonction la plus √©lev√©e. Tous les appels de fonction et la coroutine se d√©roulent de la m√™me mani√®re, cependant, entre les appels, il est n√©cessaire d'enregistrer des donn√©es suppl√©mentaires, et la fonction doit √™tre capable de sauter au point de suspension et de restaurer l'√©tat des variables locales. Il n'y a pas d'autres diff√©rences entre le cadre coroutine et le cadre fonction.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La corutine peut √©galement provoquer d'autres coroutines (non repr√©sent√©es dans cet exemple). </font><font style="vertical-align: inherit;">Dans le cas de coroutines sans pile, chaque appel entra√Æne l'allocation d'un nouvel espace pour de nouvelles donn√©es de coroutine (avec un appel r√©p√©t√© de coroutine, la m√©moire dynamique peut √©galement √™tre allou√©e plusieurs fois). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La raison pour laquelle les coroutines doivent fournir une fonctionnalit√© de langage d√©di√©e est que le compilateur doit d√©cider quelles variables d√©crivent l'√©tat de la coroutine et cr√©er du code st√©r√©otyp√© pour passer aux points de suspension.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation pratique de la corutine</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les coroutines en C ++ peuvent √™tre utilis√©es de la m√™me mani√®re que dans d'autres langages. </font><font style="vertical-align: inherit;">Coroutines simplifiera l'orthographe:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g√©n√©rateurs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code d'entr√©e / sortie asynchrone </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informatique paresseuse</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applications pilot√©es par les √©v√©nements</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re qu'en lisant cet article vous d√©couvrirez:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourquoi en C ++ vous devez impl√©menter des coroutines en tant que fonctionnalit√© de langage d√©di√©e</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle est la diff√©rence entre les coroutines empil√©es et sans pile?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourquoi les coroutines sont n√©cessaires</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491986/index.html">RemoteLoRa - Plus que ON / OFF</a></li>
<li><a href="../fr491988/index.html">Quoi de neuf dans Red Hat OpenShift 4.2 et 4.3?</a></li>
<li><a href="../fr491990/index.html">Travailler avec la puce chinoise ADC Hx711 (conclusion)</a></li>
<li><a href="../fr491992/index.html">D√©veloppement des analystes</a></li>
<li><a href="../fr491994/index.html">Migration de Cocoapods vers Swift Package Manager</a></li>
<li><a href="../fr492000/index.html">Produit tr√®s premier. Burnout</a></li>
<li><a href="../fr492002/index.html">Ailes absorbant la lumi√®re: le secret des papillons super noirs</a></li>
<li><a href="../fr492004/index.html">Comment passer d'un programmeur √† un manager (¬´Je veux √™tre la ma√Ætresse de la mer¬ª)</a></li>
<li><a href="../fr492006/index.html">La puissance de PWA: un syst√®me de vid√©osurveillance avec un code JS de r√©seau neuronal de 300 lignes</a></li>
<li><a href="../fr492008/index.html">R√©sultats de la recherche sur la motivation informatique: les d√©veloppeurs sont-ils satisfaits de leur travail?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>