<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐈 🤪 💪🏼 Atualização do processo de CI / CD: teamcity 👩🏿‍🤝‍👨🏽 🐂 🌇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este é o segundo artigo de uma série sobre a atualização de processos de CI / CD. Até esse momento, estavam sendo feitos preparativos para a criação d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Atualização do processo de CI / CD: teamcity</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496342/"><img src="https://habrastorage.org/webt/cu/y-/hg/cuy-hgxvywohqkg_tbyr2wn268c.png" alt="imagem" align="left" width="300"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este é o segundo artigo de uma série sobre a atualização de processos de CI / CD. Até esse momento, estavam sendo feitos preparativos para a criação de novas ferramentas, a saber: planejamento, comícios diários, resolução de divergências, em geral, tudo sem o qual não seria possível construir um processo de trabalho com competência. E agora, todas as questões foram resolvidas, estamos confiantes de que podemos continuar o desenvolvimento e nosso código não afundará no buraco negro no início do verão.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembrá-lo do índice da lista de artigos, bem como dos breves resultados da parte anterior. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: o que é, por que não é, como planejar, um pouco de festa.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu chamaria essa parte de quase técnica. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: cidade da equipe. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3: implantação do polvo.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Parte 4: nos bastidores. Momentos desagradáveis, planos para o futuro, possivelmente FAQ. Provavelmente, também pode ser chamado de quase técnico.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fornecemos ao cliente uma prova de conceito de um novo sistema de entrega de atualizações, identificamos as deficiências do sistema existente, selecionamos a base para o novo, fizemos um plano de transição e convertemos nosso repositório mercurial em git. Além disso, na parte anterior, descrevemos os recursos do projeto que afetarão todo o processo subsequente.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencionado anteriormente, a solução existente não atendia aos requisitos modernos. Inicialmente, muito provavelmente, uma compilação foi configurada no ccnet. A primeira compilação com a qual tudo começou (como um big bang, sim). Aparentemente, a pessoa que configurou tudo, pressionou ctrl + c, ctrl + v, corrigiu algumas linhas e recebeu uma nova configuração. E durante todo o tempo subsequente, isso foi feito um número suficiente de vezes, para que o código-fonte no servidor de construção ocupasse mais de 60G. E estas são apenas a fonte! E há logs, compilação de artefatos, arquivos temporários e assim por diante. Só isso me fez pensar. Observando o sistema antigo, era possível ver o seguinte: uma etapa de construção foi executada para cada módulo. De fato, o mesmo núcleo foi montado. E esse assembly foi armazenado para cada módulo (junto com a origem) no servidor.Os resultados da compilação (90% idênticos) foram inseridos nos repositórios locais (implantação do git) e, é claro, também foram substituídos. Era possível e necessário deixar isso.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurações Gerais&nbsp;</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse estágio, supõe-se que já haja uma cidade e um polvo configurados. </font><font style="vertical-align: inherit;">No estágio de instalação e configuração, não paramos em detalhes. </font><font style="vertical-align: inherit;">Por conveniência, anotamos o URL e o token de API do polvo na env teamcity, que, a propósito, para o projeto raiz tem a seguinte aparência: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/vw/ir/savwiryxdsw8fpgrgvdzavejho0.png" alt="imagem"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserPassword</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> são acessos api ao usuário da teamcity (serão necessários mais tarde), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.buildPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env .sourcePath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o caminho padrão para os arquivos de compilação e de origem, respectivamente, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoApiKey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o token e o URL do polvo. </font><font style="vertical-align: inherit;">Eles ainda </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.teamcityUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acrescentou. </font><font style="vertical-align: inherit;">Bem, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tt.exe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- caminho para o utilitário de transformação de texto. </font><font style="vertical-align: inherit;">Este utilitário gera todas as configurações. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos plugins de terceiros, apenas a integração do Octopus Deploy está instalada.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para não sobrecarregar a enorme quantidade de texto, apenas as etapas em que há algo que vale a pena atenção serão examinadas em detalhes. </font><font style="vertical-align: inherit;">Supõe-se que tudo o mais seja compreensível com base nos dados apresentados e no conhecimento do leitor. </font><font style="vertical-align: inherit;">De qualquer forma, se você tiver alguma dúvida, ficarei feliz em respondê-las.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detalhamento do projeto, controle de versão, nomes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado foi um esquema de projeto (como uma imagem, porque há um problema com a exibição de uma lista multinível): </font></font><br>
<img src="https://habrastorage.org/webt/-4/oq/gh/-4oqghadht5sr4rdpk7f3igz5do.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versão dos pacotes da seguinte forma: major.minor.patch, em que major ainda é 1, menor - contador de compilação na configuração de compilação, contador de compilação de patch para a configuração Implantar (não necessário para a configuração Build, portanto, sempre 0). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> versão antiga é descrita aqui. Estamos redesenhando-o para que seja baseado na tag git. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3v/kl/ov/3vklovvjqjnhwa8yg0b3lxtduns.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, aqui 1 é maior, 95 é menor e 1 é patch.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No novo processo para módulos, haverá uma construção que será implantada em cada módulo. Ou seja, o código-fonte é armazenado em uma única cópia para cada ambiente, o resultado da compilação também é, pois é comum a todos os módulos. Configurações e bibliotecas exclusivas são empacotadas em um pacote individual no estágio de implantação. Isso usará efetivamente o espaço em disco e reduzirá o tempo de entrega de cada pacote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No estágio de preparação, houve uma breve reunião separada sobre a convenção de nomeação de arquivos de configuração. Costumava ser (era apenas), mas nem sempre o mesmo. Além disso, o nome da configuração nem sempre contém informações suficientes. Como resultado, todos os nomes de configuração foram os seguintes: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigurationType.Environment.ModName.config</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onde ConfigurationType pode ser AppSettings, Web etc. </font><font style="vertical-align: inherit;">Ambiente - desenvolvimento, teste, preparação, produção. </font><font style="vertical-align: inherit;">ModName é o nome exclusivo do módulo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Módulos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os projetos de módulos funcionam com o mesmo princípio.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo ambiente possui uma configuração de compilação que:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Executa restauração de nuget (instalador do NuGet, restauração de nuget)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gera configurações (linha de comando, transformação de texto)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solução Buildit (Visual studio sln)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pega os arquivos do env.buildPath no zip e os envia para o polvo (Octopus deploy: push packages)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criação de versão (sem implantação) (Octopus deploy create release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redefine a versão do patch (PowerShell)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Também existem configurações de implantação que funcionam com base no modelo e fazem o seguinte:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pega as configurações geradas no estágio de compilação (etapa 2) (Octopus implementa pacotes push)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implantar a versão principal (criada na etapa 6 da compilação) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versão individual de implantação (criada na etapa 1 da configuração atual) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exibe uma lista de todos os domínios deste módulo no log (etapa para a conveniência do testador e desenvolvedor). </font><font style="vertical-align: inherit;">(Powershell).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada configuração de implantação, a configuração de compilação é adicionada à dependência. </font><font style="vertical-align: inherit;">Isso possibilita iniciar automaticamente a compilação quando for implantada, se não for relevante, além da capacidade de redefinir a versão do patch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deploy_all configuration. </font><font style="vertical-align: inherit;">De fato, essa é uma cadeia de construção que descreve que você primeiro precisa executar a construção, se não for relevante, e depois instalar simultaneamente todos os modos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É algo parecido com isto: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ps/ck/rqpsckl2g8rrt9voltbt082itcu.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejamos algumas das etapas com mais detalhes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurações gerais</font></font></h3><br>
<img src="https://habrastorage.org/webt/g_/5j/b9/g_5jb95h7ei6qexbvckqd8sxs7e.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De incomum formato de número apenas compilação </font><font style="vertical-align: inherit;">Será explicado mais tarde.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.env</font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/nr/bx/a4nrbxt_8ol6yjuo64npqfxuota.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
interesse aqui são: </font><i><font style="vertical-align: inherit;">env.coreProjectName</font></i><font style="vertical-align: inherit;"> - definido para todo o projeto. </font><font style="vertical-align: inherit;">Necessário para identificar o projeto no polvo. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.Environment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - definido para o subprojeto Módulos. </font><font style="vertical-align: inherit;">É necessário selecionar as configurações corretas, dependendo do ambiente. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoChannel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o canal no polvo no qual o pacote cai. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mesmo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que </font><i><font style="vertical-align: inherit;">ambiente</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.serviceName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é o nome da solução. </font><font style="vertical-align: inherit;">Basicamente, a variável é adicionada para facilitar a visualização. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantRoleTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tag de </font><i><font style="vertical-align: inherit;">inquilino</font></i><font style="vertical-align: inherit;"> no polvo. </font><font style="vertical-align: inherit;">Mais detalhes na seção de polvo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.4 </font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/da/r1/a4dar1z6_kawzfttqbuvoivu_mm.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione ao arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o nome </font><i><font style="vertical-align: inherit;">% env.serviceName%.% Build.number% .zip</font></i><font style="vertical-align: inherit;"> arquivos do diretório com o resultado da construção, excluindo todas as configurações e DLL da pasta bin / native. </font><font style="vertical-align: inherit;">Os últimos foram adicionados manualmente ao servidor da Web uma vez e ninguém os tocará novamente. </font><font style="vertical-align: inherit;">Se necessário, eles também serão atualizados manualmente (para isso, está planejado escrever um script separado, mas seremos honestos). </font><font style="vertical-align: inherit;">Isso se deve ao fato de essas bibliotecas serem "mantidas" pelo pool do IIS e, para uma implantação bem-sucedida, ela deve ser interrompida e iniciada, o que leva algum tempo. </font><font style="vertical-align: inherit;">Ao excluir essas bibliotecas da implantação, podemos pular a etapa de parar o pool, o que reduzirá o tempo da implantação e, consequentemente, o tempo de inatividade.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.5</font></font></h3><br>
<img src="https://habrastorage.org/webt/us/hu/zx/ushuzxwer8u3iwqnuuqpjbuoodo.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acho que tudo está claro aqui, exceto por que o campo Ambiente está vazio. </font><font style="vertical-align: inherit;">Em que ambiente o pacote fica, o polvo toma uma decisão com base na tag de pré-lançamento (configurada nos canais). </font><font style="vertical-align: inherit;">Essa tag está contida em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.number%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o mesmo estágio na tela em Build.General). </font><font style="vertical-align: inherit;">Portanto, neste caso, acabou sendo mais conveniente. </font><font style="vertical-align: inherit;">Também vale a pena prestar atenção na caixa de seleção </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Mostrar processo de implantação"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se não estiver instalado, o timsity considerará a compilação bem-sucedida assim que o polvo começar (mas não terminar!) O trabalho. </font><font style="vertical-align: inherit;">Ou seja, se a caixa de seleção não estiver instalada e algo der errado durante a fase de implantação - sem olhar para a interface do polvo, não saberemos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.6</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nada incomum, apenas um script do PowerShell e informações da documentação da equipe da cidade.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$pair</span> = <span class="hljs-string">"%env.apiUserName%:%env.apiUserPassword%"</span>
<span class="hljs-variable">$encodedCreds</span> = [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::ASCII.GetBytes(<span class="hljs-variable">$pair</span>))
<span class="hljs-variable">$basicAuthValue</span> = <span class="hljs-string">"Basic <span class="hljs-variable">$encodedCreds</span>"</span>
<span class="hljs-variable">$depUri</span>=<span class="hljs-string">"%env.teamcityUrl%/app/rest/buildTypes?locator=snapshotDependency:(from:(build:(id:%teamcity.build.id%)),includeInitial:false)"</span>
<span class="hljs-comment"># Get all dependencies of main build</span>
<span class="hljs-variable">$result</span> = (<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$depUri</span>)
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$i</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$result</span>.buildTypes.buildType.Count) { <span class="hljs-variable">$buildId</span> += <span class="hljs-variable">$result</span>.buildTypes.buildType.id }
<span class="hljs-variable">$buildId</span> = <span class="hljs-variable">$buildId</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">'Module_DeployAll'</span> }
<span class="hljs-comment"># Reset all child build counters to 1. This build counters are patch versions in every build. (1.build.patch)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buildId</span>.Count; <span class="hljs-variable">$i</span>++) {
  <span class="hljs-variable">$buildCounterUri</span> = <span class="hljs-string">"%env.teamcityUrl%/httpAuth/app/rest/buildTypes/"</span>+<span class="hljs-variable">$buildId</span>[<span class="hljs-variable">$i</span>]+<span class="hljs-string">"/settings/buildNumberCounter"</span>
  <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Method</span> Put <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'accept'</span>=<span class="hljs-string">'text/plain'</span>; <span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$buildCounterUri</span> <span class="hljs-literal">-ContentType</span> <span class="hljs-string">"text/plain"</span> <span class="hljs-literal">-Body</span> <span class="hljs-number">1</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui precisamos de um usuário da API no teamcity (o ambiente é criado para ele). </font><font style="vertical-align: inherit;">Efetuamos login, pegamos todas as configurações que dependem da configuração Build e redefinimos seu contador de build para 1. Isso é, de fato, para cada versão de patch, este é um indicador de quantas vezes a mesma build foi implantada para um módulo específico. </font><font style="vertical-align: inherit;">Se não houver 1, significa que algo deu errado no processo de implantação ou funcionamento do módulo na versão atual e requer atenção.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.General</font></font></h3><br>
<img src="https://habrastorage.org/webt/aa/lx/p4/aalxp4uzeiofjnfo0tfdx57z0cs.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formato da versão: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.% dep.Module_Build.build.counter%.% Build.counter% -staging</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , em que </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é a variável de sistema teamcity cujo valor corresponde ao contador de compilação da configuração de compilação correspondente (deve ser adicionado a dependências). </font><font style="vertical-align: inherit;">De fato, aqui 1 é a versão principal, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é menor e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é patch. </font><font style="vertical-align: inherit;">a preparação é uma tag de pré-lançamento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.Env</font></font></h3><br>
<img src="https://habrastorage.org/webt/wl/lc/sv/wllcsv3zxji40gzu-p1ef-vlgu4.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao adicionar um novo módulo, apenas a configuração para sua implementação é adicionada e o valor da variável </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> é </font><i><font style="vertical-align: inherit;">indicado</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Todas as outras variáveis ​​são herdadas dos projetos pais. </font><font style="vertical-align: inherit;">A variável </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantModTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um polvo é formada a partir de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.2</font></font></h3><br>
<img src="https://habrastorage.org/webt/zt/yx/2q/ztyx2q7ffqxfpwxtsrrol6ojfqy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implante o pacote principal.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Número da versão mais recente - use a versão mais recente disponível para este ambiente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Etiqueta do inquilino - etiqueta do cliente / organização. </font><font style="vertical-align: inherit;">Mais detalhes na seção de polvo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parâmetros cli adicionais. </font><font style="vertical-align: inherit;">Aqui, indicamos o canal em que nosso pacote cairá, bem como parâmetros adicionais. </font><font style="vertical-align: inherit;">Isso também será discutido separadamente na seção de polvos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implantar.3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como Deploy.2, apenas um pacote de módulo individual é implantado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implantar.4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta etapa também será descrita em detalhes abaixo, porque recebe dados do polvo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As configurações para o site da empresa e o módulo Especial são construídas com o mesmo princípio, e os principais pontos nelas são os mesmos, portanto, não vejo o objetivo de descrevê-las nos mesmos detalhes. Eles são um, eles não precisam ser implantados muitas vezes e, de fato, há restauração de pepitas, transformação de texto, msbuild, envio de polvo, lançamento de polvo, lançamento de polvo + implantação.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saiba mais sobre configurações exclusivas. </font><font style="vertical-align: inherit;">Para alguns mods, pode não haver ambientes (por exemplo, teste), eles devem ser implantados em outros servidores ou você deve definir manualmente o identificador do cliente (faça a configuração básica e altere alguns campos usando o PowerShell). </font><font style="vertical-align: inherit;">Ou seja, eles funcionam com o mesmo princípio que os módulos principais. </font><font style="vertical-align: inherit;">Sua singularidade reside no fato de que as etapas são adicionadas / alteradas para eles ou o servidor de implantação é alterado e elas não se encaixam no modelo, portanto, leva um pouco mais de tempo para criá-las. </font><font style="vertical-align: inherit;">Felizmente, existem alguns deles.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teamcity: Resumo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementação do teamcity permitiu uma abordagem mais otimizada para o processo de montagem do aplicativo. Agora, leva muito menos tempo: em vez de criar o mesmo código a cada vez, criamos uma vez. Também fazemos melhor uso do espaço em disco, tráfego de rede e tempo de computação. Anteriormente, o número de pacotes para implementação (repositórios com artefatos) era igual ao número de módulos. Cada embalagem pesava aproximadamente 100M na forma compactada. Agora temos o número de pacotes um a mais que o número de módulos, com um pacote pesando aproximadamente os mesmos 100M e o restante cerca de 500K. Além de uma interface mais amigável, logs convenientes e, o mais importante - reduzindo o tempo para manter o sistema de compilação e adicionar configurações. Agora, a adição de um novo módulo leva de 15 minutos a meia hora.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Separadamente, deve-se dizer sobre os modelos, pois é a padronização que nos permite economizar tempo na criação de novas configurações e em sua manutenção posterior. Todas as configurações para interagir com o polvo (implantar) são construídas com base em um único modelo. Em primeiro lugar, permite unificar e, portanto, simplificar o processo. Em segundo lugar, como já mencionado, economiza tempo adicionando novas configurações: conectamos um modelo, alteramos uma variável e é isso. E o mais importante, os modelos simplificam a manutenção. Todas as alterações feitas no modelo são herdadas por configurações baseadas nele. Portanto, se precisarmos adicionar uma etapa a todas as configurações de uma só vez, não precisamos clicar em todas, basta adicionar essa etapa ao modelo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturalmente, o processo de configuração da cidade da equipe andava de mãos dadas com a configuração do polvo. </font><font style="vertical-align: inherit;">É simplesmente impossível descrever em paralelo no texto, pois há uma grande chance de confusão. </font><font style="vertical-align: inherit;">Portanto, a descrição foi compartilhada e, nesta parte, apenas as etapas para o fornecimento de IC são descritas. </font><font style="vertical-align: inherit;">O processo de instalação do polvo será descrito a seguir.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496332/index.html">Antidron: reflexão de ataques de UAV e quadrocopter</a></li>
<li><a href="../pt496334/index.html">Dell U4919DW Review: Monitor de tela curvada ultra-larga de 49 polegadas</a></li>
<li><a href="../pt496336/index.html">Para que servem os medidores inteligentes?</a></li>
<li><a href="../pt496338/index.html">Crise e é isso</a></li>
<li><a href="../pt496340/index.html">Treinamos uma rede competitiva entre gerações para desenhar imagens no Azure ML</a></li>
<li><a href="../pt496344/index.html">Os hackathons online de quarentena são o momento certo?</a></li>
<li><a href="../pt496346/index.html">Adicionamos uma verificação de hash do rootkit hunter no script diário</a></li>
<li><a href="../pt496348/index.html">Estudos de caso da API de armazenamento na Web</a></li>
<li><a href="../pt496350/index.html">Você não passará! - Impressoras 3D respondem ao coronavírus</a></li>
<li><a href="../pt496354/index.html">Programação ternária: brinque com o emulador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>