<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèΩ üÜë ü§∞üèΩ Apprentissage du tra√ßage d'√©v√©nements pour Windows: th√©orie et pratique üåª ‚õΩÔ∏è üëµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne apr√®s-midi. R√©cemment, j'ai d√ª g√©rer le service de trace de Windows. Ce service est apparu dans Windows 2000. Cependant, il y avait tr√®s peu d'a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apprentissage du tra√ßage d'√©v√©nements pour Windows: th√©orie et pratique</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502362/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonne apr√®s-midi. </font><font style="vertical-align: inherit;">R√©cemment, j'ai d√ª g√©rer le service de trace de Windows. </font><font style="vertical-align: inherit;">Ce service est apparu dans Windows 2000. Cependant, il y avait tr√®s peu d'articles sur ce service sur Internet. L'id√©e d'√©crire cet article est donc apparue. </font><font style="vertical-align: inherit;">Commen√ßons donc! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, je vais essayer de parler de:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Th√©orie du service de tra√ßage Windows</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ation de votre session ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilisation de l'API de suivi des √©v√©nements pour travailler avec ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Utilisation de tracerpt et xperf pour travailler avec ETW</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Th√©orie du service de tra√ßage Windows</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le suivi des √©v√©nements pour Windows (ETW) est un service qui vous permet de recevoir des √©v√©nements d'un ou plusieurs fournisseurs d'√©v√©nements en temps r√©el ou d'un fichier * .etl pendant une certaine p√©riode. </font><font style="vertical-align: inherit;">Pas clair? </font><font style="vertical-align: inherit;">Voyons maintenant! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre le fonctionnement d'ETW, vous devez comprendre la structure de ce service. L' </font></font><br>
<br>
<img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
architecture ETW comprend 4 √©l√©ments</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournisseurs d'√©v√©nements</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consommateurs d'√©v√©nements</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contr√¥leurs ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sessions ETW (sessions de suivi d'√©v√©nements)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principe de fonctionnement est le suivant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un certain nombre de fournisseurs d'√©v√©nements sont enregistr√©s dans le syst√®me, c'est-√†-dire </font><font style="vertical-align: inherit;">des applications qui peuvent partager leurs exp√©riences avec les sessions ETW. </font><font style="vertical-align: inherit;">Dans ce syst√®me, il existe √©galement un certain nombre de sessions ETW actives qui peuvent consommer les √©v√©nements d'un ou plusieurs fournisseurs et les fournir √† l'utilisateur en temps r√©el ou √©crire tous les √©v√©nements des fournisseurs dans un fichier journal (* .etl). </font><font style="vertical-align: inherit;">Et les contr√¥leurs contr√¥lent tout ce mouvement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous allons examiner chaque √©l√©ment de l'architecture consid√©r√© ci-dessus plus en d√©tail pour enfin comprendre le principe du travail!</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fournisseurs d'√©v√©nements</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fournisseurs d'√©v√©nements sont des applications qui contiennent des outils de suivi des √©v√©nements. Une fois le fournisseur enregistr√©, le contr√¥leur peut activer ou d√©sactiver le suivi des √©v√©nements dans le fournisseur. Le fournisseur d√©termine son interpr√©tation de marche ou arr√™t. En r√®gle g√©n√©rale, un fournisseur activ√© g√©n√®re des √©v√©nements, mais pas un fournisseur d√©sactiv√©. Cela vous permet d'ajouter le suivi des √©v√©nements √† notre application sans qu'il soit n√©cessaire de g√©n√©rer des √©v√©nements tout le temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un fournisseur peut partager ses √©v√©nements avec plusieurs sessions ETW √† la fois.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque √©v√©nement se compose de deux √©l√©ments: un en-t√™te et des donn√©es! </font><font style="vertical-align: inherit;">L'en-t√™te d'√©v√©nement comprend des informations sur l'√©v√©nement: identifiant du fournisseur, identifiant d'√©v√©nement, horodatage, etc. </font><font style="vertical-align: inherit;">Le reste des donn√©es est d√©termin√© par un fournisseur sp√©cifique: ETW re√ßoit toutes les donn√©es et les √©crit dans le tampon, et leur interpr√©tation est attribu√©e aux consommateurs d'informations. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe quatre principaux types de fournisseurs: les fournisseurs </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MOF (classiques) les </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fournisseurs WPP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bas√©s sur les </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fournisseurs de </font><font style="vertical-align: inherit;">manifeste </font><font style="vertical-align: inherit;">TraceLogging. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fournisseurs d'√©v√©nements diff√®rent dans les types de champs qu'ils stockent dans les charges utiles des √©v√©nements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fournisseurs d'√©v√©nements semblent √™tre tri√©s. </font><font style="vertical-align: inherit;">Passez!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contr√¥leurs </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un contr√¥leur est une application qui est responsable du fonctionnement d'une ou plusieurs sessions ETW. </font><font style="vertical-align: inherit;">C'est le contr√¥leur qui d√©termine la taille et l'emplacement du fichier journal, d√©marre et arr√™te les sessions de suivi des √©v√©nements (sessions ETW) et permet aux fournisseurs d'enregistrer des √©v√©nements dans la session. </font><font style="vertical-align: inherit;">Comme mentionn√© pr√©c√©demment, c'est le contr√¥leur qui permet au fournisseur de partager ses √©v√©nements!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les consommateurs </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les consommateurs sont des applications qui re√ßoivent et traitent des √©v√©nements d'une ou plusieurs sessions de trace en m√™me temps. </font><font style="vertical-align: inherit;">Les consommateurs peuvent recevoir des √©v√©nements stock√©s dans des fichiers journaux ou √† partir de sessions qui fournissent des √©v√©nements en temps r√©el. </font><font style="vertical-align: inherit;">Comme nous le savons d√©j√†, une session ETW peut avoir plusieurs fournisseurs. </font><font style="vertical-align: inherit;">La question se pose: y aura-t-il de la confusion? </font><font style="vertical-align: inherit;">Comment les √©v√©nements des diff√©rentes sessions ETW seront-ils li√©s les uns aux autres? </font><font style="vertical-align: inherit;">Les √©v√©nements sont tri√©s selon le moment o√π ils se produisent, c'est-√†-dire </font><font style="vertical-align: inherit;">le syst√®me d√©livre les √©v√©nements par ordre chronologique!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sessions ETW</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les sessions de suivi des √©v√©nements (sessions ETW) enregistrent les √©v√©nements d'un ou plusieurs fournisseurs autoris√©s par le contr√¥leur. </font><font style="vertical-align: inherit;">La session est √©galement responsable de la gestion et du vidage des tampons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le suivi des √©v√©nements prend en charge jusqu'√† 64 sessions de suivi des √©v√©nements qui s'ex√©cutent simultan√©ment. </font><font style="vertical-align: inherit;">De ces sessions, il y a deux sessions sp√©ciales. </font><font style="vertical-align: inherit;">Les sessions restantes sont disponibles pour une utilisation g√©n√©rale. </font><font style="vertical-align: inherit;">Deux sessions sp√©ciales:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Session d'enregistrement global</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Session d'enregistrement du noyau NT</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une session de trace d'√©v√©nement Global Logger enregistre les √©v√©nements qui se produisent au d√©but du processus de d√©marrage du syst√®me d'exploitation, tels que ceux g√©n√©r√©s par les pilotes de p√©riph√©rique. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un enregistreur de noyau de session de suivi des √©v√©nements NT enregistre les √©v√©nements syst√®me pr√©d√©finis g√©n√©r√©s par le syst√®me d'exploitation, tels que les √©v√©nements d'E / S disque ou les √©checs de page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors maintenant, allons nous entra√Æner !!!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation de votre session ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer √† travailler, nous avons besoin de conna√Ætre plusieurs utilitaires, √† savoir: une </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
liste de fournisseurs disponibles sur un syst√®me d'exploitation particulier</font></font><br>
<br>
<pre><code class="bash hljs">logman query providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
obtenir des informations compl√®tes sur le fournisseur</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp &lt; &gt; /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
liste de toutes les sessions ETW actives</font></font><br>
<br>
<pre><code class="bash hljs">xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, pour visualiser des fichiers, il est conseill√© d'avoir Notepad ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir regard√© la liste des fournisseurs sur votre ordinateur (et il y en a plus de 1000 sur Windows 10), nous en choisirons un pour notre session: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/6e/wm/hl6ewmoxww9guutq7rt9m_rnfug.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
j'ai choisi Microsoft-Windows-WinINet (ce service enregistre toutes nos actions lorsque l'on travaille dans le navigateur Microsoft Edge). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Win + R -&gt; compmgmt.msc </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. ¬´Performance¬ª </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. ¬´Data Collector Sets¬ª </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. ¬´Event Trace Sessions¬ª </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. "Nouveau" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. "Ensemble de collecteurs de donn√©es" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Sp√©cifiez le nom du collecteur de donn√©es </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. "Cr√©er manuellement (avanc√©)" ("Cr√©er manuellement (pour exp√©riment√©)") </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/ec/_w/gkec_w2zlyy-m_jo25bm2bfgx38.png" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9. Ajouter des informations int√©ressantes fournisseurs am√©ricains par session</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10. Sp√©cifiez les mots-cl√©s qui nous int√©ressent dans le champ "Mots-cl√©s (Tout)" - 0xFFFFFFFFFFFFFFFFFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11. Sp√©cifiez le niveau de journalisation 0xFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= </font></font><img src="https://habrastorage.org/webt/d7/yw/3w/d7yw3w3ondmdrmeb_avfvnafa7y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12. S√©lectionnez le chemin o√π le fichier journal de session sera enregistr√© </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13. S√©lectionnez le " D√©marrez cet ensemble de collecteurs de donn√©es maintenant ¬ª(¬´ Ex√©cuter le groupe de collecteurs de donn√©es maintenant ¬ª) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la session que nous avons cr√©√©e fonctionne. Microsoft Edge a besoin d'un peu de travail pour que la session collecte des informations sur nous! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s un certain temps, nous allons √† l'endroit o√π nous avons enregistr√© le fichier journal. Nous y ex√©cutons la commande suivante.</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">"   .etl"</span> -o -report -summary -lr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir ex√©cut√© cette commande, 4 fichiers seront g√©n√©r√©s. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/e_/rp/upe_rph8_bnkvfuemiai0lquv0w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes actuellement int√©ress√©s par dumpfile.xml. </font><font style="vertical-align: inherit;">Vous pouvez ouvrir ce fichier via notepad ++, vous pouvez √©galement le faire dans Excel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir soigneusement √©tudi√© ce dossier, vous pouvez voir que cette session a rassembl√© presque toutes les informations sur notre mouvement sur Internet !!! </font><font style="vertical-align: inherit;">Vous pouvez en savoir plus ici: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous √©tudions ETW et en tirons des b√©n√©fices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, et nous continuons. </font><font style="vertical-align: inherit;">Nous venons de cr√©er une session avec un seul fournisseur d'√©v√©nements. </font><font style="vertical-align: inherit;">Donn√©es de session re√ßues du fichier journal. </font><font style="vertical-align: inherit;">Il est temps de coder!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de l'API de suivi des √©v√©nements pour travailler avec ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur habr il y a un article int√©ressant, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pire API jamais cr√©√©e</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, vous trouverez des r√©ponses √† de nombreuses questions que vous vous poserez probablement lors de la r√©daction des candidatures! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons coder en C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par le plus simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurer et d√©marrer une session de suivi des √©v√©nements</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rons d'abord l'id√©e g√©n√©rale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©marrer une session de trace: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) D√©finissez la structure EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) D√©marrez la session √† l'aide de StartTrace </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, activez les fournisseurs d'√©v√©nements </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Activez les fournisseurs √† l'aide de EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour arr√™ter la session de trace, vous devez: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Avant d'arr√™ter la session de trace, vous devez d√©sactiver les fournisseurs √† l'aide de EnableTrace | EnableTraceEx | EnableTraceEx2, en passant EVENT_CONTROL_CODE_DISABLE_PROVIDER </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Appelez la fonction ControlTrace et passez-la EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple ci-dessous, je cr√©e une session appel√©e MyEventTraceSession. </font><font style="vertical-align: inherit;">Le fichier journal du r√©pertoire en cours s'appelle WriteThePuth.etl. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fournisseur d'√©v√©nements est Microsoft-Windows-Kernel-Process. </font><font style="vertical-align: inherit;">Vous pouvez d√©couvrir son GUID en utilisant</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp Microsoft-Windows-Kernel-Process /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Coder directement:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#include &lt;windows.h&gt;</span>
<span class="hljs-meta">#include &lt;stdio.h&gt;</span>
<span class="hljs-meta">#include &lt;conio.h&gt;</span>
<span class="hljs-meta">#include &lt;strsafe.h&gt;</span>
<span class="hljs-meta">#include &lt;wmistr.h&gt;</span>
<span class="hljs-meta">#include &lt;evntrace.h&gt;</span>
<span class="hljs-meta">#include &lt;iostream&gt;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGFILE_PATH L"WriteThePuth.etl"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGSESSION_NAME L"MyEventTraceSession"</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,     .</span>
<span class="hljs-comment">//      GUID .</span><font></font>
<font></font>
<span class="hljs-comment">// {AE44CB98-BD11-4069-8093-770EC9258A12}</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID SessionGuid =<font></font>
{ <span class="hljs-number">0xae44cb98</span>, <span class="hljs-number">0xbd11</span>, <span class="hljs-number">0x4069</span>, { <span class="hljs-number">0x80</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xe</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x12</span> } };<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,   ,   </span>
<span class="hljs-comment">//    .</span><font></font>
<font></font>
<span class="hljs-comment">//{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} Microsoft-Windows-Kernel-Process</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID ProviderGuid =<font></font>
{ <span class="hljs-number">0xd22FB2CD6</span>, <span class="hljs-number">0x0E7B</span>, <span class="hljs-number">0x422B</span>, {<span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x16</span> } };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wmain</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span><font></font>
{<font></font>
    setlocale(LC_ALL, <span class="hljs-string">"ru"</span>);<font></font>
    ULONG status = ERROR_SUCCESS;<font></font>
    TRACEHANDLE SessionHandle = <span class="hljs-number">0</span>;<font></font>
    EVENT_TRACE_PROPERTIES* pSessionProperties = NULL;<font></font>
    ULONG BufferSize = <span class="hljs-number">0</span>;<font></font>
    BOOL TraceOn = TRUE;<font></font>
<font></font>
    <font></font>
    BufferSize = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    pSessionProperties = (EVENT_TRACE_PROPERTIES*)malloc(BufferSize);<font></font>
    <span class="hljs-keyword">if</span> (NULL == pSessionProperties)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"Unable to allocate %d bytes for properties structure.\n"</span>, BufferSize);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    ZeroMemory(pSessionProperties, BufferSize);<font></font>
    pSessionProperties-&gt;Wnode.BufferSize = BufferSize;<font></font>
    pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;<font></font>
    pSessionProperties-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>; <span class="hljs-comment">//QPC clock resolution</span><font></font>
    pSessionProperties-&gt;Wnode.Guid = SessionGuid;<font></font>
    pSessionProperties-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;<font></font>
    pSessionProperties-&gt;MaximumFileSize = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1024 MB</span>
    pSessionProperties-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);<font></font>
    pSessionProperties-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    StringCbCopy((LPWSTR)((<span class="hljs-keyword">char</span>*)pSessionProperties + pSessionProperties-&gt;LogFileNameOffset), <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH), LOGFILE_PATH);<font></font>
    <font></font>
<font></font>
    status = StartTrace((PTRACEHANDLE)&amp;SessionHandle, LOGSESSION_NAME, pSessionProperties);<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"StartTrace() failed with %lu\n"</span>, status);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ,   ,      .</span><font></font>
<font></font>
    status = EnableTraceEx2(<font></font>
        SessionHandle,<font></font>
        (LPCGUID)&amp;ProviderGuid,<font></font>
        EVENT_CONTROL_CODE_ENABLE_PROVIDER,<font></font>
        TRACE_LEVEL_INFORMATION,<font></font>
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,<font></font>
        NULL<font></font>
        );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"EnableTrace() failed with %lu\n"</span>, status);<font></font>
        TraceOn = FALSE;<font></font>
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   .    ,   </span>
    wprintf(L<span class="hljs-string">"Run the provider application. Then hit any key to stop the session.\n"</span>);<font></font>
    _getch();<font></font>
   <font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-keyword">if</span> (SessionHandle)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (TraceOn)<font></font>
        {<font></font>
            status = EnableTraceEx2(<font></font>
                SessionHandle,<font></font>
                (LPCGUID)&amp;ProviderGuid,<font></font>
                EVENT_CONTROL_CODE_DISABLE_PROVIDER,<font></font>
                TRACE_LEVEL_INFORMATION,<font></font>
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,<font></font>
                NULL<font></font>
                );<font></font>
        }<font></font>
<font></font>
        status = ControlTrace(SessionHandle, LOGSESSION_NAME, pSessionProperties, EVENT_TRACE_CONTROL_STOP);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
        {<font></font>
            wprintf(L<span class="hljs-string">"ControlTrace(stop) failed with %lu\n"</span>, status);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pSessionProperties)<font></font>
    {<font></font>
        free(pSessionProperties);<font></font>
        pSessionProperties = NULL;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous analyserons le programme ci-dessus plus en d√©tail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) D√©finissez la structure EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour configurer une session de </font><font style="vertical-align: inherit;">suivi </font><font style="vertical-align: inherit;">d'√©v√©nements, vous devez utiliser la structure EVENT_TRACE_PROPERTIES pour sp√©cifier les propri√©t√©s de la session. La m√©moire que vous allouez √† la structure EVENT_TRACE_PROPERTIES doit √™tre suffisamment grande pour contenir √©galement les noms des fichiers de session et de journal qui suivent la structure en m√©moire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) D√©marrer la session √† l'aide de StartTrace </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir sp√©cifi√© les propri√©t√©s de la session, appelez la fonction StartTrace pour d√©marrer la session. Si la fonction r√©ussit, le param√®tre SessionHandle contiendra le descripteur de session et la propri√©t√© LoggerNameOffset contiendra le d√©calage de nom de session.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Activez les fournisseurs √† l'aide de EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour activer les fournisseurs auxquels vous souhaitez autoriser l'enregistrement d'√©v√©nements dans votre session, appelez la fonction EnableTrace pour activer les fournisseurs classiques et la fonction EnableTraceEx pour activer les fournisseurs bas√©s sur des manifestes. Dans d'autres cas - EnableTraceEx2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Avant d'arr√™ter la session de trace, vous devez d√©sactiver les fournisseurs √† l'aide de EnableTrace | EnableTraceEx | EnableTraceEx2 en passant EVENT_CONTROL_CODE_DISABLE_PROVIDER</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour arr√™ter la session de trace apr√®s la collecte des √©v√©nements, appelez la fonction ControlTrace et passez EVENT_TRACE_CONTROL_STOP comme code de contr√¥le. Pour sp√©cifier une session √† arr√™ter, vous pouvez transmettre le descripteur de session de trace d'√©v√©nement obtenu √† partir d'un appel ant√©rieur √† la fonction StartTrace, ou le nom d'une session pr√©c√©demment d√©marr√©e. Assurez-vous de d√©connecter tous les fournisseurs avant d'arr√™ter la session. Si vous arr√™tez la session avant de d√©sactiver le fournisseur pour la premi√®re fois, ETW d√©connectera le fournisseur et tentera d'appeler la fonction de contr√¥le de rappel du fournisseur. Si l'application qui a d√©marr√© la session se termine sans d√©connecter le fournisseur ou appeler la fonction ControlTrace, le fournisseur reste activ√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Pour arr√™ter la session de trace, appelez la fonction ControlTrace et passez-la EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons vu dans l'exemple ci-dessus, l'utilisation de l'API Event Tracing n'est pas la plus simple. </font><font style="vertical-align: inherit;">Selon ce que vous faites, vous pouvez continuer √† √©crire des fournisseurs d'√©v√©nements ou des consommateurs d'√©v√©nements. </font><font style="vertical-align: inherit;">Cependant, ces deux t√¢ches sont assez volumineuses et ne seront pas prises en compte dans cet article! </font><font style="vertical-align: inherit;">Une complexit√© suppl√©mentaire est cr√©√©e par 4 types de fournisseurs d'√©v√©nements et, par cons√©quent, 4 options pour √©crire des √©v√©nements et 4 options pour leur consommation. </font><font style="vertical-align: inherit;">Le travail avec l'API Event Tracing est d√©crit en d√©tail et bien sur le site officiel de Microsoft. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de Event Tracing</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Apr√®s avoir travaill√© pendant un certain temps avec l'API Event Tracing, j'avais une question: existe-t-il des utilitaires qui me simplifieront la vie?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de tracerpt et xperf pour travailler avec ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce chapitre, je ne consid√©rerai pas ces utilitaires d'un point de vue th√©orique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez utiliser la commande Tracerpt pour analyser les journaux de suivi des √©v√©nements, les fichiers journaux g√©n√©r√©s par le moniteur de performances et les fournisseurs de trace des √©v√©nements en temps r√©el. </font><font style="vertical-align: inherit;">Il cr√©e des fichiers de vidage, des fichiers de rapport et des sch√©mas de rapport. </font><font style="vertical-align: inherit;">Cet utilitaire a un grand nombre de param√®tres, mais le "minimum" suivant convient pour commencer le travail</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">" 1- .etl"</span> ... <span class="hljs-string">" n- .etl"</span> -o &lt;   &gt; -report &lt;    &gt; -summary&lt;    &gt; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilitaire xperf.exe est un contr√¥leur √† part enti√®re. </font><font style="vertical-align: inherit;">Il prend en charge les arguments de ligne de commande pour g√©rer les fournisseurs et les sessions ETW. </font><font style="vertical-align: inherit;">Les contr√¥leurs peuvent demander l'√©tat des sessions actuellement actives et recevoir des listes de tous les fournisseurs enregistr√©s dans le syst√®me. </font><font style="vertical-align: inherit;">Par exemple, pour obtenir toutes les sessions actives, utilisez la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et pour obtenir une liste de tous les fournisseurs enregistr√©s dans le syst√®me, utilisez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les contr√¥leurs ont quelques fonctionnalit√©s cl√©s suppl√©mentaires. </font><font style="vertical-align: inherit;">Ils peuvent mettre √† jour les sessions et vider les tampons sur le disque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour le moment! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, dans cet article, je n'ai pas abord√© un certain nombre de questions int√©ressantes (par exemple, la consommation d'√©v√©nements en temps r√©el ou le travail avec des sessions sp√©ciales). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez en lire plus sur les sites suivants: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - documentation officielle de Microsoft </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous √©tudions ETW et tirons les avantages du </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Tracing pour Windows du mauvais c√¥t√©. </font><font style="vertical-align: inherit;">Mais ce n'est pas exactement la </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pire API jamais cr√©√©e</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502350/index.html">R√©tro-ing√©nierie de l'amplificateur de son d'une console portable populaire - discussion des principales conclusions</a></li>
<li><a href="../fr502352/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 344 (12 - 17 mai)</a></li>
<li><a href="../fr502354/index.html">Les fournisseurs d'IaaS se battent pour le march√© europ√©en - discuter de la situation et des √©v√©nements de l'industrie</a></li>
<li><a href="../fr502358/index.html">Impl√©mentation de MVP bas√©e sur ApplicationController et IoC dans une application WinForms</a></li>
<li><a href="../fr502360/index.html">D√©charges Grizzly ou Super Drill</a></li>
<li><a href="../fr502366/index.html">Comparez le travail de Python open source - biblioth√®ques pour la reconnaissance des entit√©s nomm√©es</a></li>
<li><a href="../fr502368/index.html">Nous pompons le tapis roulant</a></li>
<li><a href="../fr502370/index.html">Mettre le jeu "Snake" sur la planche √† pain. Partie 1: machines d'√©tat</a></li>
<li><a href="../fr502372/index.html">Probl√®mes et principes de personnalisation de la version en bo√Æte de Bitrix24</a></li>
<li><a href="../fr502374/index.html">Protocole de communication FT8 - Fonctionnement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>