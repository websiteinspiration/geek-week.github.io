<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§±üèæ üé≠ ü§ôüèΩ Using malware in Azure to gain access to Microsoft 365 tenants üò≠ üë©üèæ‚Äçüè≠ ‚Ü™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Phishing remains one of the most successful ways to infiltrate an organization. We have seen a huge number of malware infections arising from users op...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Using malware in Azure to gain access to Microsoft 365 tenants</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/493700/"><img src="https://habrastorage.org/webt/wh/ra/bs/whrabsdl8mcpqm0jawnwlcue9y0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Phishing remains one of the most successful ways to infiltrate an organization. We have seen a huge number of malware infections arising from users opening infected attachments or following links to malicious sites that tried to compromise vulnerable browsers or plugins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that organizations are moving to Microsoft 365 at such a fast pace, we are seeing a new attack vector - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Azure applications</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you will see below, cybercriminals can create, mask and deploy malicious Azure applications for use in their phishing campaigns. </font><font style="vertical-align: inherit;">Azure applications do not require approval from Microsoft and, more importantly, they do not require code execution on the user's computer, which makes it easy to bypass detection tools and antivirus programs on workstations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the attacker convinces the victim to install the malicious Azure application, he will be able to find out which organization the victim belongs to, access the victim‚Äôs files, read her emails, send emails on behalf of the victim (great for an internal phishing attack) and in general a lot more.</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are Azure apps?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft created the Azure Application Service to enable users to create their own cloud-based applications that can call and use Azure APIs and resources. This makes it easy to create powerful custom programs that integrate with the Microsoft 365 ecosystem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most common APIs in Azure is the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS Graph API</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This API allows applications to interact with the user's environment, namely: users, groups, OneDrive documents, Exchange Online mailboxes and chats.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n6/dr/zc/n6drzcttdf-3kiqwxrkxtdim1ti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just as your iOS phone will ask you if the application can be allowed access to your contacts or location, Azure will ask you to give the application access to the necessary resources. </font><font style="vertical-align: inherit;">Obviously, an attacker can use this opportunity to fraudulently give an application access to one or more confidential cloud resources.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is the attack</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To perform this attack, the attacker must have the web application itself and the Azure tenant to host it. After setting up the store, we can start a phishing campaign using the link to install the Azure application: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_w/3q/xn/_w3qxnbrx9et81dpjyfhv8kojt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
link in the email directs the user to a website controlled by attackers (for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myapp.malicious.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), which, in turn, redirects the victim to the Microsoft login page . The authentication process is fully handled by Microsoft, so using multi-factor authentication is not a solution.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as the user enters his O365 instance, a token will be created for the malicious application, and the user will be asked to log in and provide the application with the necessary permissions. Here's what it looks like for the end user (and it should look very familiar if the user previously installed the application in SharePoint or Teams): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/yp/lp/ayyplpzzbrahvn3v3xi9xjjcm14.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are the MS Graph API permissions that are requested by the attacker in the code of our application: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/ih/gz/mvihgzebcfluk9fnxoha-2hgaly.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the attacker controls the name of the application ("MicrosoftOffice" ) and shortcut (we used the OneNote shortcut). The URL is a valid Microsoft URL, the certificate is also valid.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the name of the tenant of the attacker and a warning message are indicated under the application name, and neither one nor the other can be hidden. The hope of the attacker is that the user will be in a hurry, see a familiar shortcut and skip this information as quickly and thoughtlessly as notifications of terms of use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By clicking "Accept", the victim grants our application permissions on behalf of his account, that is, the application will be able to read the victim's emails and gain access to any files that the victim has access to. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This step is the only one requiring the consent of the victim, from now on the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attacker has full control over the user account and resources</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After giving consent to the application, the victim will be redirected to the website of our choice. </font><font style="vertical-align: inherit;">Comparing recent user access to files and redirecting them to one of the recently opened internal SharePoint documents can be a good trick to arouse a minimum of suspicion.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opportunities Received</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This attack is ideal for the following activities:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intelligence (getting a list of accounts, groups, objects in user tenant); </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internal phishing</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theft of data from file resources and email.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To illustrate the power of our Azure application, we created a funny console to display resources that we accessed as part of our PoC (proof of concept) test: the </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oz/tz/et/oztzetnke3lzvzbricpzwn-9u6w.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúMe‚Äù section</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shows the details of the victim: the </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/j6/8l/wij68lol6i-uopcxdirvrbeowzg.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúUsers‚Äù section</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will show us the above metadata for each An individual user in an organization, including an email address, mobile phone number, job title, and more, depending on the attributes of the organization‚Äôs Active Directory. This API call alone can cause a massive violation of personal data protection policies, especially within the framework of GDPR and CCPA. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eh/v4/fi/ehv4fiefehohqs7ai59ailatiu0.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calendar Section</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shows us the events of the victim‚Äôs calendar. We can also schedule appointments on her behalf, view existing meetings, and even delete future meetings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the most important section in our console application is the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecentFiles section</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which allows us to see any file that the user has accessed in OneDrive or SharePoint. We can also upload or modify files (including files with malicious macros to develop an attack). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/qo/ae/ovqoaes4ydnkgs_962ixhn0h5qu.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMPORTANT:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when we access the file through this API, Azure creates a unique link. This link is accessible to anyone from anywhere, even if the organization does not allow anonymous exchange of links for ordinary 365 users.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
API links are special. Frankly speaking, we are not sure why they are not blocked by the organization‚Äôs policy for link exchange; perhaps Microsoft does not want to break existing user applications if the policy changes. The application may request a download link or a link to modify the file - in our PoC we requested both. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚ÄúOutlook‚Äù section</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gives us full access to the victim‚Äôs email. We can see the recipients of any message, filter them by priority, send emails (internal phishing) and much more.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ub/6-/aw/ub6-awypxaz8mrssovs-ukadffq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By reading the victim's emails, we can identify the circle of her communications and the most vulnerable contacts from this circle, send internal phishing emails on behalf of our victim and thus develop an attack within the organization. We can also use the victim‚Äôs email address and contacts from her circle to filter out the data that we find in 365. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, Microsoft has an API that provides information about the victim‚Äôs current communication circle: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gc/ri/yp/gcriypl3ebgd0hygrplmaptoams.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we mentioned above, we can modify user files subject to relevant rights. But what if we use the API to modify files? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jo/mw/ls/jomwlsbpkzivualsqu5fcbmw99s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One option is to turn our malicious Azure application into a ransomware program that remotely encrypts files that the victim has access to modify on SharePoint and OneDrive:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gl/kb/ug/glkbugxe_1mhhxatzw5ckuimndc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, this method of encrypting files is not reliable (since some files can be restored using more strict backup settings), but tenants with default configurations risk losing data permanently. </font><font style="vertical-align: inherit;">On the other hand, we can always bring out confidential data and threaten to publish it, unless we get a ransom. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other sources:</font></font></strong><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kevin Mitnik introduced a similar cloud-based encryption method that applies to mailboxes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Krebs On Security also wrote a good post about such an attack on his blog.</font></font></li>
</ul><br>
<h3><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Urgency of the problem</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Awareness of this phishing technique is relatively low today. </font><font style="vertical-align: inherit;">Many experts do not understand the potential level of damage that an attacker can inflict due to only one employee in the organization that provided access to the malicious Azure application. </font><font style="vertical-align: inherit;">Giving consent to an Azure application is not much different from running a malicious .exe file or allowing macros to be activated in a document from an unknown sender. </font><font style="vertical-align: inherit;">But, since this is a newer vector that does not require code to be executed on the user's machine, it is more difficult to detect and block.</font></font><br>
<br>
<h3><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How about disabling all third-party applications? </font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft does not recommend setting a ban on users to grant permissions to applications: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúYou can disable integrated applications for your tenant. </font><font style="vertical-align: inherit;">This is a radical step that globally deprives end users of the ability to provide consent at the tenant level. </font><font style="vertical-align: inherit;">This prevents your users from inadvertently granting access to a malicious application. </font><font style="vertical-align: inherit;">This is not a strong recommendation, as it seriously impairs the ability of your users to work with third-party applications. ‚Äù</font></font><br>
<br>
<h3><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How can I detect abuse of Azure apps? </font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way to detect illegal permissions is to track access events in Azure AD and regularly review your Enterprise Applications in the Azure portal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Always ask yourself questions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do I know this app?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Does it belong to an organization that I know?</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For Varonis customers:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the DatAlert module has threat models that detect malicious permissions. </font><font style="vertical-align: inherit;">It is also possible to create your own Azure app sharing notification rules.</font></font><br>
<br>
<h3><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to remove malicious applications? </font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the Azure portal, go to the "Enterprise Applications" section of the "Azure Active Directory" tab and uninstall the applications. </font><font style="vertical-align: inherit;">An ordinary user can delete the permissions granted earlier by going to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">myapps.microsoft.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , checking the applications listed there and revoking the permissions as necessary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
See </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft's official guidelines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for detailed instructions </font><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493686/index.html">The mysterious origin of the board game about hacking codes Mastermind</a></li>
<li><a href="../en493688/index.html">We make Microsoft Teams free - stay in touch with colleagues at this difficult time</a></li>
<li><a href="../en493690/index.html">20 tips for pilot DJI Mavic Mini to protect your drone from crash and loss</a></li>
<li><a href="../en493692/index.html">Theoretical data structures and their application in JavaScript. P1. Couples</a></li>
<li><a href="../en493696/index.html">Accelerating the Qemu KVM disk subsystem on Linux</a></li>
<li><a href="../en493702/index.html">Massive transition to remote work: technical problems and threats to security</a></li>
<li><a href="../en493704/index.html">Using TypeScript in JavaScript without writing TypeScript</a></li>
<li><a href="../en493706/index.html">Know your enemy: create a Node.js backdoor</a></li>
<li><a href="../en493708/index.html">Anatomy of my home Kubernetes cluster</a></li>
<li><a href="../en493712/index.html">New TypeScript features for enhanced usability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>