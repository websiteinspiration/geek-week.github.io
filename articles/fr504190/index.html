<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦌 👨🏼‍🎨 💠 MVCC comme moyen d'assurer l'isolement des transactions 🌝 🏇🏾 🎋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Habr. Je m'appelle Vladislav Rodin. Actuellement, je dirige le cours d'architecte à charge élevée d'OTUS et j'enseigne également des cours sur ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MVCC comme moyen d'assurer l'isolement des transactions</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/504190/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salut, Habr. </font><font style="vertical-align: inherit;">Je m'appelle Vladislav Rodin. </font><font style="vertical-align: inherit;">Actuellement, je dirige le cours d'architecte à charge élevée d'OTUS et j'enseigne également des cours sur l'architecture logicielle. </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surtout pour le début d'un nouvel ensemble pour le cours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Architecte de fortes charges",</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai écrit un petit matériel que je partage volontiers avec vous.</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/hv/fy/ll/hvfyllpmp4nnso0wztz_u0ju278.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La dernière fois,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous vous avons parlé des conséquences de l'affaiblissement de l'isolement des transactions dans les bases de données. </font><font style="vertical-align: inherit;">Aujourd'hui, nous allons discuter plus en détail de l'un des moyens d'assurer cet isolement et d'éviter les anomalies considérées. </font><font style="vertical-align: inherit;">Comme vous l'avez peut-être remarqué, dans le dernier article, deux approches ont souvent été distinguées: l'une était basée sur le fait que les enregistrements ont certaines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et la seconde sur le fait que nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloquerons l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enregistrement d'une manière ou d'une autre </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ainsi, deux classes de bases de données sont distinguées: les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versions et les bloqueurs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aujourd'hui, nous allons parler de ce que sont les contrôleurs de version et laissons la considération des bloqueurs la prochaine fois.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versionionistes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai dit, l'une des approches est basée sur la gestion des versions. </font><font style="vertical-align: inherit;">Elle est également appelée </font><font style="vertical-align: inherit;">approche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimiste</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVCC (contrôle de concurrence multiversionnelle)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En fait, le stockage des versions pour les transactions actives se produit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Où sont stockées les versions?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mise en œuvre du mécanisme dépend de la base de données. </font><font style="vertical-align: inherit;">Je vais en donner quelques exemples.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque transaction est caractérisée par un id-shnik. Les transactions id-shnik se développent de façon monotone. Toute ligne a 2 attributs qui représentent des méta-informations pour fournir le mécanisme: updated_by_id - id de la transaction qui a mis à jour cet enregistrement en dernier et supprimé_by_id - id de la transaction qui a supprimé cet enregistrement. Lorsqu'une nouvelle transaction arrive, la base de données détermine les pseudos des transactions en cours d'exécution, les modifications apportées par ces transactions seront ignorées dans la transaction entrante. Il s'avère que la transaction entrante fonctionne comme avec sa version des données. Les anciennes versions des données sont stockées au même endroit que les versions actuelles. Si la mise à jour arrive, une autre ligne est ajoutée et cet enregistrement devient actif. Il est également clair que pour le bon fonctionnement de ce schéma, un "garbage collector" est requis:si un enregistrement a supprimé_par_id = 100 et que l'id-shnik minimum parmi les transactions en cours est 150, cet enregistrement doit être supprimé.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL (moteur InnoDB)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seule la version actuelle est stockée dans la base de données MySQL. </font><font style="vertical-align: inherit;">Lorsque la mise à jour arrive, les données à l'intérieur du fichier de table sont corrigées. </font><font style="vertical-align: inherit;">Après avoir ajusté les données, la version précédente se trouve dans le journal de restauration. </font><font style="vertical-align: inherit;">Il existe plusieurs journaux de restauration dans MySQL (ils sont différents pour insert'ov et update'ov). </font><font style="vertical-align: inherit;">Si une transaction nécessite une version précédente de la ligne, le système annule le journal et restaure la version nécessaire. </font><font style="vertical-align: inherit;">La version est également déterminée par l'ID de transaction.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le schéma est similaire à MySQL: les versions actuelles sont stockées dans le fichier de données, les anciennes versions sont restaurées grâce au journal d'annulation. </font><font style="vertical-align: inherit;">Le journal d'annulation dans Oracle est réécrit cycliquement. </font><font style="vertical-align: inherit;">Par conséquent, une situation est possible lorsqu'une transaction a besoin d'une très ancienne version de l'enregistrement, mais dans le journal d'annulation, elle n'est plus là. </font><font style="vertical-align: inherit;">Si cette situation se produit, la transaction échouera.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS SQL permet l'inclusion des modes versionioner et blocker. Pour activer le mode versionné dans les paramètres de la base de données, vous devez activer les instantanés. Dans MS SQL, il existe une table système (tempdb), conçue pour stocker des tables temporaires. C'est tempdb qui est utilisé pour stocker les anciennes versions, tandis que le tableau contient les versions actuelles. Le processus système surveille que dans tempdb il existe des versions auxquelles personne ne fait référence, elles peuvent être supprimées. Si la transaction est longue, les versions seront enregistrées pour elle. Tempdb grandit, atteint sa taille maximale, MS SQL alloue un peu d'espace disque. S'il se termine, les transactions avec l'isolement d'instantané ne peuvent pas être effectuées. Si ce mode de fonctionnement est utilisé, il est nécessaire de surveiller les transactions longues,car le retour en arrière d'une telle transaction dans le temps peut coûter autant que cela fonctionne, et peut-être un peu plus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conflits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche est qualifiée d'optimiste, car nous espérons qu'il n'y aura pas de conflit si des transactions de changement de données parallèles sont exécutées. </font><font style="vertical-align: inherit;">Que se passe-t-il en cas de conflit? </font><font style="vertical-align: inherit;">Supposons que la transaction T1 modifie 10 000 enregistrements et la transaction T2 modifie 1 enregistrement en parallèle. </font><font style="vertical-align: inherit;">S'il arrivait que ce 1 enregistrement soit inclus dans ces 10 000, alors l'une des transactions sera annulée: si T1 est exécuté en premier, alors T2 sera annulé, sinon l'inverse.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mécanisme de retour en arrière</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mécanisme de restauration des transactions dans les versions versionnées dépend de l'implémentation. </font><font style="vertical-align: inherit;">Par exemple, dans PostgreSQL, une transaction est marquée comme évacuée et le vide libère de l'espace disque. </font><font style="vertical-align: inherit;">Un tel mécanisme est assez rapide. </font><font style="vertical-align: inherit;">Dans Oracle, pour la restauration, les données sont restaurées à partir du journal d'annulation. </font><font style="vertical-align: inherit;">Dans ce cas, le temps de fonctionnement augmente, cependant, il est encore beaucoup plus rapide que dans les casiers. </font><font style="vertical-align: inherit;">MySQL fonctionne de la même manière qu'Oracle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'approche optimiste est bonne car l'écrivain ne bloque pas le lecteur, le lecteur lit simplement sa version des données. </font><font style="vertical-align: inherit;">Par conséquent, la gestion des versions est bénéfique si le fardeau principal concerne la lecture plutôt que l'écriture (blog, rapports et autres cas où vous devez lire souvent et beaucoup).</font></font><br>
<br>
<hr><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur le cours ici.</font></font></a></b><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504180/index.html">L'histoire de la façon dont nous avons apprivoisé BigQuery</a></li>
<li><a href="../fr504182/index.html">Scanner 3D Review500 Solution500 C500</a></li>
<li><a href="../fr504184/index.html">Création d'un bot de trading à l'aide de l'apprentissage automatique dans l'analyse de séries chronologiques</a></li>
<li><a href="../fr504186/index.html">Paul Graham: Comment écrire des textes utiles (complet)</a></li>
<li><a href="../fr504188/index.html">Quarantaine, systèmes en ligne et science des données. Qui pense à la fidélisation de la clientèle?</a></li>
<li><a href="../fr504194/index.html">Le résultat d'une enquête auprès des développeurs sur Stack Overflow 2020 (+ habraopros)</a></li>
<li><a href="../fr504196/index.html">NFC: Analyse de la technologie de communication en champ proche</a></li>
<li><a href="../fr504198/index.html">SwiftUI sur les étagères: Animation. Partie 1</a></li>
<li><a href="../fr504204/index.html">Ateliers IBM: Quarkus (Java ultrarapide pour microservices), Jakarta EE et OpenShift</a></li>
<li><a href="../fr504208/index.html">Comment automatiser un centre de services partagés</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>