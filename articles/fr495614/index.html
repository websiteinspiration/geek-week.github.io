<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñçÔ∏è üò∑ üë©üèø‚Äçü§ù‚Äçüë©üèæ FFmpeg libav manual ‚ôãÔ∏è üë®üèΩ‚ÄçüöÄ üßùüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Longtemps que je cherchais un livre qui serait m√¢ch√© √† utiliser FFmpeg -comme biblioth√®que connue sous le nom libav (le nom signifie lib raire un udio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FFmpeg libav manual</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/edison/blog/495614/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><div style="text-align:center;"><img width="779" height="232" src="https://habrastorage.org/webt/yn/ed/vp/ynedvpoyntkab2ppkqxuqtrbwma.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Longtemps que </font><font style="vertical-align: inherit;">je cherchais un livre qui serait m√¢ch√© √† utiliser </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -comme biblioth√®que connue sous le </font><font style="vertical-align: inherit;">nom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (le nom signifie </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> raire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> udio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> id√©o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Trouv√© un manuel " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √©crire un lecteur vid√©o et tenir en moins de mille lignes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." Malheureusement, les informations y sont obsol√®tes, j'ai donc d√ª cr√©er un manuel par moi-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart du code sera en C, mais ne vous inqui√©tez pas: vous comprendrez tout facilement et pourrez l'appliquer dans votre langue pr√©f√©r√©e. FFmpeg libav a beaucoup de liaisons avec de nombreux langages (dont Python et Go). Mais m√™me si votre langue n'a pas de compatibilit√© directe, vous pouvez toujours </font><font style="vertical-align: inherit;">vous </font><font style="vertical-align: inherit;">attacher via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (voici un exemple avec</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par une courte digression sur ce que sont la vid√©o, l'audio, les codecs et les conteneurs. </font><font style="vertical-align: inherit;">Ensuite, nous passons au cours acc√©l√©r√© sur l'utilisation de la ligne de commande FFmpeg, et √©crivons enfin le code. </font><font style="vertical-align: inherit;">N'h√©sitez pas √† aller directement √† la section ¬´Le chemin √©pineux de l'apprentissage FFmpeg libav¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une opinion (et pas seulement la mienne) selon laquelle le streaming de vid√©os sur Internet a d√©j√† pris le relais de la t√©l√©vision traditionnelle. </font><font style="vertical-align: inherit;">Quoi qu'il en soit, FFmpeg libav vaut vraiment la peine d'√™tre explor√©.</font></font><a name="menu"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table des mati√®res</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La vid√©o est ce que vous voyez!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'audio est ce que vous entendez!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - Compression de donn√©es</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un conteneur est un moyen pratique de stocker de l'audio / vid√©o</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de commande Ffmpeg</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outil de ligne de commande FFmpeg 101</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√©rations de base sur la vid√©o</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodage</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexage</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transising</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: streaming adaptatif</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aller plus loin</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   FFmpeg libav</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 0 ‚Äî  ¬´Hello World¬ª</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FFmpeg libav </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">, </a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 1 ‚Äî    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 2 ‚Äî </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 3 ‚Äî </a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a></li>
</ul></li>
</ul></li>
</ul><a name="intro"></a><a name="video"></a><a name="habracut"></a><blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="Logiciel EDISON - d√©veloppement web"><img align="left" width="153" height="75" src="https://habrastorage.org/webt/w0/zl/to/w0zltoxvysbr0yeinstkfvw1wbg.png" alt="Logiciel EDISON - d√©veloppement web"></a><br clear="right">
     EDISON.<br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  ,  </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a>.<br>
<br>
     ! ;-)</blockquote><img align="right" width="210" height="280" src="https://habrastorage.org/webt/5k/lz/nu/5klznusfiwgawobmtbcrpdboscw.jpeg"><br clear="left">
<h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a></h2><br>
<h3> ‚Äî  ,   ! <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">‚Üë</a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la s√©quence d'images est modifi√©e √† une fr√©quence donn√©e (disons, 24 images par seconde), une illusion de mouvement est cr√©√©e. </font><font style="vertical-align: inherit;">C'est l'id√©e principale de la vid√©o: une s√©rie d'images (cadres) se d√©pla√ßant √† une vitesse donn√©e. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Illustration de 1886.</font></font></i><br>
<br>
<a name="audio"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'audio est ce que vous entendez! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que la vid√©o silencieuse puisse provoquer une grande vari√©t√© de sentiments, l'ajout de son augmente consid√©rablement le degr√© de plaisir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le son est une onde vibratoire se propageant dans l'air ou dans tout autre milieu de transmission (tel que gaz, liquide ou solide). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un syst√®me audio num√©rique, un microphone convertit le son en un signal √©lectrique analogique. </font><font style="vertical-align: inherit;">Ensuite, un convertisseur analogique-num√©rique ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - qui utilise g√©n√©ralement la modulation par impulsions cod√©es ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - convertit un signal analogique en signal num√©rique.</font></font><br>
<br>
<div style="text-align:center;"><img width="640" height="220" src="https://habrastorage.org/webt/eu/gb/_m/eugb_mwqa5x5yctawseum7qdtss.png"></div><br>
<a name="codec"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - compression des donn√©es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un codec est un circuit √©lectronique ou un logiciel qui comprime ou d√©compresse l'audio / vid√©o num√©rique. </font><font style="vertical-align: inherit;">Il convertit l'audio / vid√©o num√©rique brut (non compress√©) en un format compress√© (ou vice versa). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous d√©cidons de regrouper des millions d'images dans un fichier et de l'appeler film, nous pouvons obtenir un fichier √©norme. </font><font style="vertical-align: inherit;">Calculons: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous cr√©ons une vid√©o avec une r√©solution de 1080 √ó 1920 (hauteur √ó largeur). </font><font style="vertical-align: inherit;">Nous d√©pensons 3 octets par pixel (le point minimum sur l'√©cran) pour le codage couleur (couleur 24 bits, ce qui nous donne </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 777 216</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> couleurs diff√©rentes). </font><font style="vertical-align: inherit;">Cette vid√©o fonctionne √† une vitesse de 24 images par seconde, la dur√©e totale de 30 minutes.</font></font><br>
<br>
<pre><code class="cpp hljs">toppf = <span class="hljs-number">1080</span> * <span class="hljs-number">1920</span> <span class="hljs-comment">//    </span>
cpp = <span class="hljs-number">3</span> <span class="hljs-comment">//  </span>
tis = <span class="hljs-number">30</span> * <span class="hljs-number">60</span> <span class="hljs-comment">//   </span>
fps = <span class="hljs-number">24</span> <span class="hljs-comment">//   </span><font></font>
<font></font>
required_storage = tis * fps * toppf * cpp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette vid√©o n√©cessitera environ 250,28 Go de m√©moire, soit 1,11 Go / s! </font><font style="vertical-align: inherit;">C'est pourquoi vous devez utiliser un codec.</font></font><br>
<br>
<a name="container"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un conteneur est un moyen pratique de stocker de l'audio / vid√©o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le format conteneur (wrapper) est un format de m√©tafichier dont la sp√©cification d√©crit la fa√ßon dont divers √©l√©ments de donn√©es et de m√©tadonn√©es coexistent dans un fichier informatique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un fichier unique contenant tous les flux (principalement audio et vid√©o), assurant la synchronisation, contenant des m√©tadonn√©es communes (telles que le titre, la r√©solution), etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, le format de fichier est d√©termin√© par son extension: par exemple, video.webm est tr√®s probablement une vid√©o utilisant le conteneur webm.</font></font><br>
<br>
<div style="text-align:center;"><img width="621" height="328" src="https://habrastorage.org/webt/ay/du/qa/ayduqaajbhuh59tah4vdgcu2sj0.png"></div><br>
<a name="command_line"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne de commande FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solution multiplateforme autonome pour l'enregistrement, la conversion et le streaming audio / vid√©o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour travailler avec le multim√©dia, nous avons un outil incroyable - une biblioth√®que appel√©e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">M√™me si vous ne l'utilisez pas dans votre code de programme, vous l'utilisez toujours (utilisez-vous Chrome?). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioth√®que poss√®de un programme de console pour entrer une ligne de commande appel√©e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (en petites lettres, contrairement au nom de la biblioth√®que elle-m√™me). </font><font style="vertical-align: inherit;">Il s'agit d'un binaire simple et puissant. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez convertir de mp4 en avi en tapant simplement cette commande:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg -i input.mp4 output.avi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous venons de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remixer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - converti d'un conteneur √† un autre. </font><font style="vertical-align: inherit;">Techniquement, FFmpeg peut √©galement transcoder, mais plus √† ce sujet plus tard.</font></font><br>
<br>
<a name="101"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outil de ligne de commande FFmpeg 101 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg a une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o√π tout est parfaitement expliqu√© comment ce qui fonctionne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sch√©matiquement, le programme de ligne de commande FFmpeg attend que le format d'argument suivant fasse son travail - </font></font><code><b>ffmpeg {1} {2} -i {3} {4} {5}</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o√π: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{1}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - param√®tres globaux </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{2}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - param√®tres du fichier d'entr√©e </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{3}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - URL entrante </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{4}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - param√®tres du fichier de sortie </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{5}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - sortants Les </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
parties d' </font><font style="vertical-align: inherit;">URL </font><font style="vertical-align: inherit;">{2}, {3}, {4}, {5} sp√©cifient autant d'arguments que n√©cessaire. </font><font style="vertical-align: inherit;">Il est plus facile de comprendre le format de passage des arguments √† l'aide d'un exemple: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVERTISSEMENT: un fichier par r√©f√©rence p√®se 300 Mo</font></font></b><br>
<br>
<pre><code class="bash hljs">$ wget -O bunny_1080p_60fps.mp4 http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4<font></font>
<font></font>
$ ffmpeg \<font></font>
-y \ <span class="hljs-comment">#  </span>
-c: libfdk_aac -c: v libx264 \ <span class="hljs-comment">#  </span>
-i bunny_1080p_60fps.mp4 \ <span class="hljs-comment">#  URL</span>
-c: v libvpx-vp9 -c: libvorbis \ <span class="hljs-comment">#  </span>
bunny_1080p_60fps_vp9.webm <span class="hljs-comment">#  URL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette commande prend un fichier mp4 entrant contenant deux flux (audio cod√© √† l'aide du codec aac et vid√©o cod√© √† l'aide du codec h264), et le convertit en webm, en modifiant √©galement les codecs audio et vid√©o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous simplifiez la commande ci-dessus, vous devez consid√©rer que FFmpeg acceptera les valeurs par d√©faut √† votre place. </font><font style="vertical-align: inherit;">Par exemple, si vous tapez simplement</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i input.avi output.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
quel codec audio / vid√©o utilise-t-il pour cr√©er output.mp4? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werner Robitz a √©crit un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guide de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> codage et d'√©dition pour la lecture / ex√©cution avec FFmpeg.</font></font><br>
<br>
<a name="operations"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√©rations vid√©o de base </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous travaillons avec de l'audio / vid√©o, nous effectuons g√©n√©ralement un certain nombre de t√¢ches li√©es au multim√©dia.</font></font><br>
<br>
<a name="transcoding"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodage (transcodage) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<br>
<div style="text-align:center;"><img width="494" height="225" src="https://habrastorage.org/webt/uf/fl/cr/ufflcrik3ha4z6tt5axevtdfv9u.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'Est-ce que c'est? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processus de conversion de streaming ou audio ou vid√©o (ou les deux en m√™me temps) d'un codec √† un autre. </font><font style="vertical-align: inherit;">Le format de fichier (conteneur) ne change pas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il arrive que certains appareils (t√©l√©viseurs, smartphones, consoles, etc.) ne prennent pas en charge le format audio / vid√©o X, mais prennent en charge le format audio / vid√©o Y. Ou, les codecs plus r√©cents sont pr√©f√©rables car ils offrent un meilleur taux de compression. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convertissez, par exemple, la vid√©o H264 (AVC) en H265 (HEVC):</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c:v libx265 \<font></font>
bunny_1080p_60fps_h265.mp4</code></pre><br>
<a name="transmuxing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="492" height="231" src="https://habrastorage.org/webt/es/vp/gm/esvpgmlkjcj38alzp2sbrdckpne.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'Est-ce que c'est? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conversion d'un format (conteneur) √† un autre. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il arrive que certains appareils (t√©l√©viseurs, smartphones, consoles, etc.) ne prennent pas en charge le format de fichier X, mais prennent en charge le format de fichier Y. Ou, les conteneurs plus r√©cents, contrairement aux anciens, fournissent les fonctions modernes requises. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convertissez un mp4 en webm:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c copy \ <span class="hljs-comment"># just saying to ffmpeg to skip encoding</span>
bunny_1080p_60fps.webm</code></pre><br>
<a name="transrating"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="437" height="235" src="https://habrastorage.org/webt/ev/hx/cp/evhxcp7a6y5fkjjq9s53hyfs3iq.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'Est-ce que c'est? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modifiez le d√©bit de donn√©es ou cr√©ez une autre vue. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisateur peut regarder votre vid√©o √† la fois sur un r√©seau 2G sur un smartphone basse consommation et via une connexion Internet en fibre optique sur un t√©l√©viseur 4K. </font><font style="vertical-align: inherit;">Par cons√©quent, vous devez proposer plusieurs options pour lire la m√™me vid√©o avec des d√©bits de donn√©es diff√©rents. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produit une lecture √† un d√©bit compris entre 3856K et 2000K.</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-minrate 964K -maxrate 3856K -bufsize 2000K \<font></font>
bunny_1080p_60fps_transrating_964_3856.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, la conversion est effectu√©e conjointement avec le recalibrage. </font><font style="vertical-align: inherit;">Werner Robitz a √©crit un autre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article obligatoire</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le contr√¥le de vitesse FFmpeg.</font></font><br>
<br>
<a name="transsizing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transizing (recalibrage) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="515" height="277" src="https://habrastorage.org/webt/gj/c2/4k/gjc24kcqli3iwwdkzbb70pbue-k.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'Est-ce que c'est? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changement de r√©solution. </font><font style="vertical-align: inherit;">Comme indiqu√© ci-dessus, le transsizing est souvent effectu√© simultan√©ment avec le transrating. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les m√™mes raisons que pour le transfert. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©duisez la r√©solution de 1080 √† 480:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-vf scale=480:-1 \<font></font>
bunny_1080p_60fps_transsizing_480.mp4</code></pre><br>
<a name="bonus"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: streaming adaptatif </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br>
<div style="text-align:center;"><img width="750" height="134" src="https://habrastorage.org/webt/3z/az/lg/3zazlgpe3wjx3zvvhapi0z3ur68.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'Est-ce que c'est? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation de nombreuses autorisations (d√©bits binaires) et division des m√©dias en parties et leur transmission via le protocole http. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le but de fournir un multim√©dia flexible, qui peut √™tre visualis√© m√™me sur un smartphone √©conomique, m√™me sur un plasma 4K, afin qu'il puisse √™tre facilement mis √† l'√©chelle et d√©ploy√© (mais cela peut ajouter un retard). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un WebM r√©actif √† l'aide de DASH:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># video streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 160x90 -b:v 250k -keyint_min 150 -g 150 -an -f webm -dash 1 video_160x90_250k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 320x180 -b:v 500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_320x180_500k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 750k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_750k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 1000k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_1000k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 1280x720 -b:v 1500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_1280x720_1500k.webm<font></font>
<font></font>
<span class="hljs-comment"># audio streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:a libvorbis -b:a 128k -vn -f webm -dash 1 audio_128k.webm<font></font>
<font></font>
<span class="hljs-comment"># the DASH manifest</span><font></font>
$ ffmpeg \<font></font>
 -f webm_dash_manifest -i video_160x90_250k.webm \<font></font>
 -f webm_dash_manifest -i video_320x180_500k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_750k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_1000k.webm \<font></font>
 -f webm_dash_manifest -i video_1280x720_500k.webm \<font></font>
 -f webm_dash_manifest -i audio_128k.webm \<font></font>
 -c copy -map 0 -map 1 -map 2 -map 3 -map 4 -map 5 \<font></font>
 -f webm_dash_manifest \<font></font>
 -adaptation_sets <span class="hljs-string">"id=0,streams=0,1,2,3,4 id=1,streams=5"</span> \<font></font>
 manifest.mpd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS: J'ai tir√© cet exemple des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions pour jouer √† Adaptive WebM √† l'aide de DASH</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="beyond"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aller au-del√† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas d'autres utilisations pour FFmpeg. </font><font style="vertical-align: inherit;">Je l'utilise avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iMovie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour cr√©er / √©diter des vid√©os YouTube. </font><font style="vertical-align: inherit;">Et, bien s√ªr, rien ne vous emp√™che de l'utiliser professionnellement.</font></font><br>
<br>
<a name="hard_way"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le chemin √©pineux de l'apprentissage FFmpeg libav </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'est-ce pas √©tonnant de temps en temps qui soit per√ßu par l'ou√Øe et la vue? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biologiste David Robert Jones</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg est extr√™mement utile comme outil de ligne de commande pour effectuer des op√©rations importantes avec des fichiers multim√©dias. </font><font style="vertical-align: inherit;">Peut-√™tre qu'il peut √©galement √™tre utilis√© dans des programmes? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg se compose de plusieurs biblioth√®ques qui peuvent √™tre int√©gr√©es dans nos propres programmes. </font><font style="vertical-align: inherit;">G√©n√©ralement, lorsque vous installez FFmpeg, toutes ces biblioth√®ques sont automatiquement install√©es. </font><font style="vertical-align: inherit;">Je ferai r√©f√©rence √† un ensemble de ces biblioth√®ques comme </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le titre de la section est un hommage √† la s√©rie de Zed Shaw, The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thorny Path of Learning [...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en particulier son livre The Thorny Path of Learning C.</font></font><br>
<br>
<a name="chapter_0"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapitre 0 - Le simple monde bonjour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello World</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous n'accueillerez vraiment pas le monde en langage console. </font><font style="vertical-align: inherit;">Au lieu de cela, imprimez les informations suivantes sur la vid√©o: format (conteneur), dur√©e, r√©solution, canaux audio, et enfin, d√©chiffrez certaines images et enregistrez-les sous forme de fichiers image.</font></font><br>
<br>
<a name="architecture"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture libav FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avant de commencer √† √©crire le code, voyons comment l'architecture libav FFmpeg fonctionne en g√©n√©ral et comment ses composants interagissent avec les autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un sch√©ma du processus de d√©codage vid√©o:</font></font><br>
<div style="text-align:center;"><img width="750" height="424" src="https://habrastorage.org/webt/ej/1d/ek/ej1deksvwwqdctppaujla5v5tog.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, le fichier multim√©dia est charg√© dans un composant appel√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (le conteneur vid√©o est √©galement un format). En fait, il ne t√©l√©charge pas enti√®rement le fichier entier: souvent seul l'en-t√™te est lu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que vous avez t√©l√©charg√© l'en- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√™te minimum de notre conteneur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous pouvez acc√©der √† ses flux (ils peuvent √™tre repr√©sent√©s comme des donn√©es audio et vid√©o √©l√©mentaires). Chaque flux sera disponible dans le composant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que notre vid√©o comporte deux flux: audio cod√© √† l'aide du codec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et vid√©o cod√© √† l'aide du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codec H264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). De chaque flux, nous pouvons extraire des √©l√©ments de donn√©es appel√©s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui sont charg√©s dans des composants appel√©s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es √† l'int√©rieur des paquets sont toujours cod√©es (compress√©es), et pour d√©coder les paquets, nous devons les transmettre √† un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sp√©cifique </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©code en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , √† la suite de quoi ce composant nous donne une trame non compress√©e. </font><font style="vertical-align: inherit;">Notez que la terminologie et le processus sont les m√™mes pour les flux audio et vid√©o.</font></font><br>
<br>
<a name="requirements"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exigences </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisqu'il y a parfois des probl√®mes lors de la compilation ou de l'ex√©cution d'exemples, nous utiliserons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme environnement de d√©veloppement / d'ex√©cution. </font><font style="vertical-align: inherit;">Nous utiliserons √©galement une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o avec un gros lapin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donc si vous ne l'avez pas sur votre ordinateur local, lancez simplement la commande </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make fetch_small_bunny_video</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la console </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="code"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, le code </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">montrez-moi un exemple de code ex√©cutable, bro:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_hello</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons omettre certains d√©tails, mais ne vous inqui√©tez pas: le code source </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est disponible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons allouer de la m√©moire pour le composant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui contiendra des informations sur le format (conteneur).</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *pFormatContext = avformat_alloc_context();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous allons ouvrir le fichier, lire son en-t√™te et remplir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext avec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des informations de format minimal (notez que les codecs ne s'ouvrent g√©n√©ralement pas). </font><font style="vertical-align: inherit;">Pour ce faire, utilisez la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_open_input</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il attend </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un nom de fichier et deux arguments facultatifs: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVInputFormat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (si vous passez NULL, FFmpeg d√©terminera le format) et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVDictionary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (qui sont des options de d√©multiplexeur).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_open_input(&amp;pFormatContext, filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©galement imprimer le nom du format et la dur√©e du support:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Format %s, duration %lld us"</span>, pFormatContext-&gt;iformat-&gt;long_name, pFormatContext-&gt;duration);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour acc√©der aux flux, nous devons lire les donn√©es des m√©dias. </font><font style="vertical-align: inherit;">Cela se fait par la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_find_stream_info</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Maintenant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; nb_streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contiendra le nombre de threads, et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; streams [i]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous donnera le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √®me flux cons√©cutif ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_find_stream_info(pFormatContext,  <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons en revue la boucle dans tous les threads:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pFormatContext-&gt;nb_streams; i++) {
  <span class="hljs-comment">//</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour chaque flux, nous allons enregistrer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecParameters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui d√©crit les propri√©t√©s du codec utilis√© par le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √®me flux:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecParameters *pLocalCodecParameters = pFormatContext-&gt;streams[i]-&gt;codecpar;</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant les propri√©t√©s des codecs, nous pouvons trouver celui correspondant en demandant la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_decoder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous pouvons √©galement trouver le d√©codeur enregistr√© pour l'identifiant du codec et renvoyer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un composant qui sait coder et d√©coder le flux:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec *pLocalCodec = avcodec_find_decoder(pLocalCodecParameters-&gt;codec_id);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons maintenant imprimer les informations du codec:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// specific for video and audio</span>
<span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Video Codec: resolution %d x %d"</span>, pLocalCodecParameters-&gt;width, pLocalCodecParameters-&gt;height);<font></font>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Audio Codec: %d channels, sample rate %d"</span>, pLocalCodecParameters-&gt;channels, pLocalCodecParameters-&gt;sample_rate);<font></font>
}<font></font>
<span class="hljs-comment">// general</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\tCodec %s ID %d bit_rate %lld"</span>, pLocalCodec-&gt;long_name, pLocalCodec-&gt;id, pCodecParameters-&gt;bit_rate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant le codec, nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allouons</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la m√©moire √† </font><b><font style="vertical-align: inherit;">AVCodecContext</font></b><font style="vertical-align: inherit;"> , qui contiendra le contexte de notre processus de d√©codage / codage. </font><font style="vertical-align: inherit;">Mais alors vous devez remplir ce contexte de codec avec les param√®tres </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CODEC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - nous le faisons en utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_to_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir rempli le contexte du codec, vous devez ouvrir le codec. </font><font style="vertical-align: inherit;">Nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appelons la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonction </font><b><font style="vertical-align: inherit;">avcodec_open2</font></b><font style="vertical-align: inherit;"> et ensuite nous pouvons l'utiliser:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecContext *pCodecContext = avcodec_alloc_context3(pCodec);<font></font>
avcodec_parameters_to_context(pCodecContext, pCodecParameters);<font></font>
avcodec_open2(pCodecContext, pCodec, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant lire les paquets du flux et les d√©coder en trames, mais nous devons d'abord allouer de la m√©moire aux deux composants ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">AVPacket *pPacket = av_packet_alloc();<font></font>
AVFrame *pFrame = av_frame_alloc();</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nourrissons</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
nos packages √† partir des flux de la fonction </font><b><font style="vertical-align: inherit;">av_read_frame</font></b><font style="vertical-align: inherit;"> pendant qu'elle a les packages:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(av_read_frame(pFormatContext, pPacket) &gt;= <span class="hljs-number">0</span>) {
  <span class="hljs-comment">//...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant envoyer le paquet de donn√©es brutes (trame compress√©e) au d√©codeur via le contexte du codec en utilisant la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_send_packet(pCodecContext, pPacket);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et r√©cup√©rons une trame de donn√©es brutes (une trame non compress√©e) du d√©codeur via le m√™me contexte de codec en utilisant la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_receive_frame(pCodecContext, pFrame);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons imprimer le num√©ro de trame, PTS, DTS, le type de trame, etc.:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(
    <span class="hljs-string">"Frame %c (%d) pts %d dts %d key_frame %d [coded_picture_number %d, display_picture_number %d]"</span>,<font></font>
    av_get_picture_type_char(pFrame-&gt;pict_type),<font></font>
    pCodecContext-&gt;frame_number,<font></font>
    pFrame-&gt;pts,<font></font>
    pFrame-&gt;pkt_dts,<font></font>
    pFrame-&gt;key_frame,<font></font>
    pFrame-&gt;coded_picture_number,<font></font>
    pFrame-&gt;display_picture_number<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, nous pouvons enregistrer notre cadre d√©cod√© dans une simple image grise. </font><font style="vertical-align: inherit;">Le processus est tr√®s simple: nous utiliserons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFrame-&gt; data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π l'index est associ√© aux espaces colorim√©triques </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">S√©lectionnez simplement 0 (Y) pour enregistrer notre image grise:</font></font><br>
<br>
<pre><code class="cpp hljs">save_gray_frame(pFrame-&gt;data[<span class="hljs-number">0</span>], pFrame-&gt;linesize[<span class="hljs-number">0</span>], pFrame-&gt;width, pFrame-&gt;height, frame_filename);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save_gray_frame</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> wrap, <span class="hljs-keyword">int</span> xsize, <span class="hljs-keyword">int</span> ysize, <span class="hljs-keyword">char</span> *filename)</span>
</span>{<font></font>
    FILE *f;<font></font>
    <span class="hljs-keyword">int</span> i;<font></font>
    f = fopen(filename,<span class="hljs-string">"w"</span>);
    <span class="hljs-comment">// writing the minimal required header for a pgm file format</span>
    <span class="hljs-comment">// portable graymap format -&gt; https://en.wikipedia.org/wiki/Netpbm_format#PGM_example</span>
    <span class="hljs-built_in">fprintf</span>(f, <span class="hljs-string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="hljs-number">255</span>);<font></font>
<font></font>
    <span class="hljs-comment">// writing line by line</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ysize; i++)<font></font>
        fwrite(buf + i * wrap, <span class="hljs-number">1</span>, xsize, f);<font></font>
    fclose(f);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le tour est jou√©! </font><font style="vertical-align: inherit;">Nous avons maintenant une image en niveaux de gris de 2 Mo:</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="413" src="https://habrastorage.org/webt/gk/tf/i9/gktfi9xb3ylqmmzu927uc7aon9w.png"></div><br>
<a name="chapter_1"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapitre 1 - Synchroniser l'audio et la vid√©o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√ätre dans le jeu, c'est quand un jeune d√©veloppeur JS √©crit un nouveau lecteur vid√©o MSE.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avant de commencer √† √©crire le code de transcodage, parlons de la synchronisation ou de la fa√ßon dont le lecteur vid√©o trouve le bon moment pour lire une image. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple pr√©c√©dent, nous avons enregistr√© plusieurs images: </font></font><br>
<img width="194" height="110" src="https://habrastorage.org/webt/gj/yz/7h/gjyz7h4agcr6n2hdkmt9w9ko5ho.png"> <img width="194" height="110" src="https://habrastorage.org/webt/is/cl/yy/isclyy5ckz1_4w2mepv4msr2dba.png"> <img width="194" height="110" src="https://habrastorage.org/webt/7z/tr/mu/7ztrmukulalxo5qihbly0cpm_5w.png"> <img width="194" height="110" src="https://habrastorage.org/webt/u3/q8/pq/u3q8pqb2qxhroy1ycatplyeveco.png"> <img width="194" height="110" src="https://habrastorage.org/webt/uu/lh/ih/uulhihectxop1sphmmss_ipvfpc.png"> <img width="194" height="110" src="https://habrastorage.org/webt/9x/ss/bm/9xssbmfyxzra5frtcob9dirkxt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
lorsque nous concevons un lecteur vid√©o, nous devons lire chaque image √† un certain rythme, sinon il est difficile d'appr√©cier la vid√©o, car elle est trop rapide ou trop lente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, nous devons d√©finir une logique pour une lecture fluide de chaque image. A cet √©gard, chaque trame a un rep√®re de repr√©sentation temporelle ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√©sentation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ime </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamp), qui est un nombre croissant pris en compte dans la variable</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de temps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est un nombre rationnel (o√π le d√©nominateur est connu sous le nom d'√©chelle de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √©chelle de </font><b><font style="vertical-align: inherit;">temps</font></b><font style="vertical-align: inherit;"> ) divis√© par la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fr√©quence d' </font></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><b><font style="vertical-align: inherit;">fps</font></b><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est plus facile √† comprendre avec des exemples. </font><font style="vertical-align: inherit;">Simulons quelques sc√©narios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 60/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de temps = 1/60000,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chaque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> augmentera l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©chelle de temps / fps = 1000</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de sorte que le temps </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√©el </font><font style="vertical-align: inherit;">pour chaque trame peut √™tre (√† condition qu'il commence √† 0):</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque le m√™me sc√©nario, mais avec une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©chelle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><b><font style="vertical-align: inherit;">temps</font></b><font style="vertical-align: inherit;"> √©gale √† 1/60:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.050</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 25/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de temps = 1/75,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chaque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> augmentera l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©chelle de temps / fps = 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et le temps </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut √™tre:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.04</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">6</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.08</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">9</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.12</span><font></font>
...<font></font>
frame=<span class="hljs-number">24</span>, PTS = <span class="hljs-number">72</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.96</span><font></font>
...<font></font>
frame=<span class="hljs-number">4064</span>, PTS = <span class="hljs-number">12192</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">162.56</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous pouvons trouver un moyen de visualiser cela en synchronisation avec le son de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou avec l'horloge syst√®me. </font><font style="vertical-align: inherit;">FFmpeg libav fournit ces informations via son API:</font></font><br>
<br>
<pre><code class="cpp hljs">fps = AVStream-&gt;avg_frame_rate<font></font>
tbr = AVStream-&gt;r_frame_rate<font></font>
tbn = AVStream-&gt;time_base</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par simple curiosit√©, les images que nous avons enregistr√©es ont √©t√© envoy√©es dans l'ordre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (images: 1, 6, 4, 2, 3, 5), mais reproduites dans l'ordre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (images: 1, 2, 3, 4, 5). </font><font style="vertical-align: inherit;">Notez √©galement combien d' </font><font style="vertical-align: inherit;">images </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> moins ch√®res </font><font style="vertical-align: inherit;">sont compar√©es aux </font><font style="vertical-align: inherit;">images </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">LOG: AVStream-&gt;r_frame_rate <span class="hljs-number">60</span>/<span class="hljs-number">1</span>
LOG: AVStream-&gt;time_base <span class="hljs-number">1</span>/<span class="hljs-number">60000</span><font></font>
...<font></font>
LOG: Frame <span class="hljs-number">1</span> (type=I, size=<span class="hljs-number">153797</span> bytes) pts <span class="hljs-number">6000</span> key_frame <span class="hljs-number">1</span> [DTS <span class="hljs-number">0</span>]<font></font>
LOG: Frame <span class="hljs-number">2</span> (type=B, size=<span class="hljs-number">8117</span> bytes) pts <span class="hljs-number">7000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">3</span>]<font></font>
LOG: Frame <span class="hljs-number">3</span> (type=B, size=<span class="hljs-number">8226</span> bytes) pts <span class="hljs-number">8000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">4</span>]<font></font>
LOG: Frame <span class="hljs-number">4</span> (type=B, size=<span class="hljs-number">17699</span> bytes) pts <span class="hljs-number">9000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">2</span>]<font></font>
LOG: Frame <span class="hljs-number">5</span> (type=B, size=<span class="hljs-number">6253</span> bytes) pts <span class="hljs-number">10000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">5</span>]<font></font>
LOG: Frame <span class="hljs-number">6</span> (type=P, size=<span class="hljs-number">34992</span> bytes) pts <span class="hljs-number">11000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">1</span>]</code></pre><br>
<a name="chapter_2"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapitre 2 - Remultiplexage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remultiplexage (r√©arrangement, remuxage) - la transition d'un format (conteneur) √† un autre. </font><font style="vertical-align: inherit;">Par exemple, nous pouvons facilement remplacer la vid√©o MPEG-4 par MPEG-TS en utilisant FFmpeg:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fichier MP4 sera d√©multiplex√©, tandis que le fichier ne sera pas d√©cod√© ou encod√© ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copie -c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), et, √† la fin, nous obtenons le fichier mpegts. </font><font style="vertical-align: inherit;">Si vous ne sp√©cifiez pas le format </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-f</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ffmpeg essaiera de le deviner en fonction de l'extension du fichier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisation g√©n√©rale de FFmpeg ou libav suit un tel mod√®le / architecture ou flux de travail:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">niveau de protocole</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - accepter les donn√©es d'entr√©e (par exemple, un fichier, mais il peut √©galement s'agir d'un t√©l√©chargement rtmp ou HTTP)</font></font></li>
<li><b> </b> ‚Äî  , ,  ,   </li>
<li><b> </b> ‚Äî       </li>
<li><b> </b> ‚Äî         (,  ),  </li>
<li>‚Ä¶        :</li>
<li><b> </b> ‚Äî  (    )  </li>
<li><b> </b> ‚Äî  ( )   ( )</li>
<li><b> </b> ‚Äî , ,      (   , ,    )</li>
</ul><br>
<img src="https://habrastorage.org/webt/u6/x4/g3/u6x4g3oijeetm1lpdvxnjo9hwls.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Ce graphique est tr√®s inspir√© par le travail de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leixiaohua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slhck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Cr√©ons</font></a></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
maintenant un exemple utilisant libav pour fournir le m√™me effet que lors de l'ex√©cution de cette commande:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons lire depuis l'entr√©e ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et la changer en une autre sortie ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *input_format_context = <span class="hljs-literal">NULL</span>;<font></font>
AVFormatContext *output_format_context = <span class="hljs-literal">NULL</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, nous commen√ßons par allouer de la m√©moire et ouvrir le format d'entr√©e. </font><font style="vertical-align: inherit;">Pour ce cas sp√©cifique, nous allons ouvrir le fichier d'entr√©e et allouer de la m√©moire au fichier de sortie:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> ((ret = avformat_open_input(&amp;input_format_context, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open input file '%s'"</span>, in_filename);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<span class="hljs-keyword">if</span> ((ret = avformat_find_stream_info(input_format_context, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to retrieve input stream information"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<font></font>
avformat_alloc_output_context2(&amp;output_format_context, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);
<span class="hljs-keyword">if</span> (!output_format_context) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create output context\n"</span>);<font></font>
  ret = AVERROR_UNKNOWN;<font></font>
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne remultiplexerons que les flux vid√©o, audio et sous-titres. </font><font style="vertical-align: inherit;">Par cons√©quent, nous fixons les flux que nous utiliserons dans un tableau d'indices:</font></font><br>
<br>
<pre><code class="cpp hljs">number_of_streams = input_format_context-&gt;nb_streams;<font></font>
streams_list = av_mallocz_array(number_of_streams, <span class="hljs-keyword">sizeof</span>(*streams_list));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imm√©diatement apr√®s avoir allou√© la m√©moire n√©cessaire, nous devons parcourir tous les flux et pour chacun, nous devons cr√©er un nouveau flux de sortie dans notre contexte du format de sortie √† l'aide de la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Veuillez noter que nous signalons tous les flux qui ne sont pas vid√©o, audio ou sous-titres afin que nous puissions les ignorer.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; input_format_context-&gt;nb_streams; i++) {<font></font>
  AVStream *out_stream;<font></font>
  AVStream *in_stream = input_format_context-&gt;streams[i];<font></font>
  AVCodecParameters *in_codecpar = in_stream-&gt;codecpar;<font></font>
  <span class="hljs-keyword">if</span> (in_codecpar-&gt;codec_type != AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) {<font></font>
    streams_list[i] = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  streams_list[i] = stream_index++;<font></font>
  out_stream = avformat_new_stream(output_format_context, <span class="hljs-literal">NULL</span>);
  <span class="hljs-keyword">if</span> (!out_stream) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed allocating output stream\n"</span>);<font></font>
    ret = AVERROR_UNKNOWN;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to copy codec parameters\n"</span>);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez maintenant le fichier de sortie:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (!(output_format_context-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) {<font></font>
  ret = avio_open(&amp;output_format_context-&gt;pb, out_filename, AVIO_FLAG_WRITE);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open output file '%s'"</span>, out_filename);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}<font></font>
<font></font>
ret = avformat_write_header(output_format_context, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error occurred when opening output file\n"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, vous pouvez copier des flux, package par package, de nos flux d'entr√©e vers nos flux de sortie. </font><font style="vertical-align: inherit;">Cela se produit dans une boucle, tant qu'il existe des packages ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), pour chaque package, vous devez recalculer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour enfin l'√©crire ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dans notre contexte du format de sortie.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
  AVStream *in_stream, *out_stream;<font></font>
  ret = av_read_frame(input_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">break</span>;<font></font>
  in_stream  = input_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-keyword">if</span> (packet.stream_index &gt;= number_of_streams || streams_list[packet.stream_index] &lt; <span class="hljs-number">0</span>) {<font></font>
    av_packet_unref(&amp;packet);<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  packet.stream_index = streams_list[packet.stream_index];<font></font>
  out_stream = output_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-comment">/* copy packet */</span><font></font>
  packet.pts = av_rescale_q_rnd(packet.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.dts = av_rescale_q_rnd(packet.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.duration = av_rescale_q(packet.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);<font></font>
  <span class="hljs-comment">// https://ffmpeg.org/doxygen/trunk/structAVPacket.html#ab5793d8195cf4789dfb3913b7a693903</span>
  packet.pos = <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">//https://ffmpeg.org/doxygen/trunk/group__lavf__encoding.html#ga37352ed2c63493c38219d935e71db6c1</span><font></font>
  ret = av_interleaved_write_frame(output_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error muxing packet\n"</span>);
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  av_packet_unref(&amp;packet);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour terminer, nous devons √©crire la bande-annonce du flux dans le fichier multim√©dia de sortie √† l'aide de la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_write_trailer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">av_write_trailer(output_format_context);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes maintenant pr√™ts √† tester le code. </font><font style="vertical-align: inherit;">Et le premier test sera la conversion du format (conteneur vid√©o) de MP4 en fichier vid√©o MPEG-TS. </font><font style="vertical-align: inherit;">Fondamentalement, nous cr√©ons une ligne de commande ffmpeg input.mp4 -c pour copier output.ts en utilisant libav.</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa marche! </font><font style="vertical-align: inherit;">Ne me crois pas ?! </font><font style="vertical-align: inherit;">V√©rifiez avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffprobe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">ffprobe -i remuxed_small_bunny_1080p_60fps.ts<font></font>
<font></font>
Input <span class="hljs-comment">#0, mpegts, from 'remuxed_small_bunny_1080p_60fps.ts':</span><font></font>
  Duration: 00:00:10.03, start: 0.000000, bitrate: 2751 kb/s<font></font>
  Program 1<font></font>
    Metadata:<font></font>
      service_name    : Service01<font></font>
      service_provider: FFmpeg<font></font>
    Stream <span class="hljs-comment">#0:0[0x100]: Video: h264 (High) ([27][0][0][0] / 0x001B), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 60 fps, 60 tbr, 90k tbn, 120 tbc</span>
    Stream <span class="hljs-comment">#0:1[0x101]: Audio: ac3 ([129][0][0][0] / 0x0081), 48000 Hz, 5.1(side), fltp, 320 kb/s</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©sumer ce que nous avons fait, nous pouvons maintenant revenir √† notre id√©e originale du fonctionnement de libav. </font><font style="vertical-align: inherit;">Mais nous avons manqu√© une partie du codec, qui est affich√© dans le diagramme.</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="415" src="https://habrastorage.org/webt/_i/vz/yw/_ivzywrkd4le_hfwqyf-7hhrcb8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de terminer ce chapitre, je voudrais montrer une partie si importante du processus de remultiplexage, o√π vous pouvez passer des param√®tres au multiplexeur. </font><font style="vertical-align: inherit;">Supposons que vous souhaitiez fournir le format MPEG-DASH, vous devez donc utiliser mp4 fragment√© (parfois appel√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fmp4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) au lieu de MPEG-TS ou MPEG-4 ordinaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisation de la ligne de commande est simple:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i non_fragmented.mp4 -movflags frag_keyframe+empty_moov+default_base_moof fragmented.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est presque aussi simple que cela dans la version libav, nous passons simplement les options lors de l'√©criture de l'en-t√™te de sortie, juste avant de copier les packages:</font></font><br>
<br>
<pre><code class="cpp hljs">AVDictionary* opts = <span class="hljs-literal">NULL</span>;<font></font>
av_dict_set(&amp;opts, <span class="hljs-string">"movflags"</span>, <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>, <span class="hljs-number">0</span>);<font></font>
ret = avformat_write_header(output_format_context, &amp;opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous pouvons g√©n√©rer ce fichier mp4 fragment√©:</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_fragmented_mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vous assurer que tout est juste, vous pouvez utiliser l'incroyable </font><font style="vertical-align: inherit;">site de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outil gpac / mp4box.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://mp4parser.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour voir les diff√©rences - t√©l√©chargez d'abord mp4.</font></font><br>
<br>
<img align="left" width="212" height="81" src="https://habrastorage.org/webt/x5/hw/9u/x5hw9uxcdgvl36yvns8hkquzlca.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme vous pouvez le voir, il a un bloc </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indivisible </font><font style="vertical-align: inherit;">- c'est l'endroit o√π se trouvent les images vid√©o et audio. </font><font style="vertical-align: inherit;">T√©l√©chargez maintenant le mp4 fragment√© pour voir comment il √©tend les blocs mdat:</font></font><br>
<br>
<img align="left" width="184" height="140" src="https://habrastorage.org/webt/pu/bv/mm/pubvmm5ogancxewrdxfgdth1d34.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><a name="chapter_3"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapitre 3 - Transcodage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">montrez-moi le code et l'ex√©cution:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_transcoding</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ignorerons certains d√©tails, mais ne vous inqui√©tez pas: le code source </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est disponible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce chapitre, nous allons cr√©er un transcodeur minimaliste √©crit en C, qui peut convertir des vid√©os de H264 en H265 en utilisant les biblioth√®ques libav FFmpeg, en particulier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavcodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavformat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavutil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="396" src="https://habrastorage.org/webt/pw/zj/ys/pwzjys-eok7ggnpkztlv7n60njm.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une abstraction pour le format de fichier multim√©dia, c'est-√†-dire </font><font style="vertical-align: inherit;">pour un conteneur (MKV, MP4, Webm, TS) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> repr√©sente chaque type de donn√©es pour un format donn√© (par exemple: audio, vid√©o, sous-titres, m√©tadonn√©es) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un fragment de donn√©es compress√©es re√ßues d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui peuvent √™tre d√©cod√©es √† l'aide d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (par exemple : av1, h264, vp9, hevc) g√©n√©rant des donn√©es brutes appel√©es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="cahpter_3_transmuxing"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par une simple conversion, puis chargeons le fichier d'entr√©e.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Allocate an AVFormatContext</span><font></font>
avfc = avformat_alloc_context();<font></font>
<span class="hljs-comment">// Open an input stream and read the header.</span>
avformat_open_input(avfc, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
<span class="hljs-comment">// Read packets of a media file to get stream information.</span>
avformat_find_stream_info(avfc, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurez maintenant le d√©codeur. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous donnera acc√®s √† tous les composants d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et pour chacun desquels nous pouvons obtenir leur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et cr√©er un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sp√©cifique </font><font style="vertical-align: inherit;">. Et enfin, nous pouvons ouvrir ce codec pour passer au processus de d√©codage. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contient des donn√©es de configuration multim√©dia, telles que le d√©bit de donn√©es, la fr√©quence d'images, la fr√©quence d'√©chantillonnage, les canaux, la hauteur et bien d'autres.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; avfc-&gt;nb_streams; i++) {<font></font>
  AVStream *avs = avfc-&gt;streams[i];<font></font>
  AVCodec *avc = avcodec_find_decoder(avs-&gt;codecpar-&gt;codec_id);<font></font>
  AVCodecContext *avcc = avcodec_alloc_context3(*avc);<font></font>
  avcodec_parameters_to_context(*avcc, avs-&gt;codecpar);<font></font>
  avcodec_open2(*avcc, *avc, <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez √©galement pr√©parer le fichier multim√©dia de sortie pour la conversion. </font><font style="vertical-align: inherit;">Tout d'abord, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allouez de la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©moire pour la sortie </font><b><font style="vertical-align: inherit;">AVFormatContext</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cr√©ez chaque flux dans le format de sortie. </font><font style="vertical-align: inherit;">Pour emballer correctement le flux, copiez les param√®tres du codec depuis le d√©codeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©finissez l'indicateur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV_CODEC_FLAG_GLOBAL_HEADER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui indique √† l'encodeur qu'il peut utiliser des en-t√™tes globaux, et enfin ouvrez le fichier de sortie pour l'√©criture et enregistrez les en-t√™tes:</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_alloc_output_context2(&amp;encoder_avfc, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);<font></font>
<font></font>
AVStream *avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_copy(avs-&gt;codecpar, decoder_avs-&gt;codecpar);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (encoder_avfc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<font></font>
  encoder_avfc-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<font></font>
<font></font>
avio_open(&amp;encoder_avfc-&gt;pb, encoder-&gt;filename, AVIO_FLAG_WRITE);<font></font>
avformat_write_header(encoder-&gt;avfc, &amp;muxer_opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenons AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du d√©codeur, ajustons les horodatages et √©crivons le paquet correctement dans le fichier de sortie. </font><font style="vertical-align: inherit;">Malgr√© le fait que la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> signale ¬´ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©crire le cadre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª, nous enregistrons le package. </font><font style="vertical-align: inherit;">Nous terminons le processus de permutation en √©crivant la bande-annonce du flux dans un fichier.</font></font><br>
<br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span>(av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>) {<font></font>
  av_packet_rescale_ts(input_packet, decoder_video_avs-&gt;time_base, encoder_video_avs-&gt;time_base);<font></font>
  av_interleaved_write_frame(*avfc, input_packet) &lt; <span class="hljs-number">0</span>));<font></font>
}<font></font>
<font></font>
av_write_trailer(encoder_avfc);</code></pre><br>
<a name="cahpter_3_transcoding"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcodage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üë</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la section pr√©c√©dente, il y avait un programme simple pour la conversion, maintenant nous allons ajouter la possibilit√© d'encoder des fichiers, en particulier, le transcodage vid√©o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois le d√©codeur pr√©par√©, mais avant d'organiser le fichier multim√©dia de sortie, configurez l'encodeur.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vid√©o </font><font style="vertical-align: inherit;">dans l'encodeur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec le nom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libx265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_encoder_by_name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bas√© sur le codec cr√©√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_alloc_context3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez les attributs de base pour une session de transcodage et ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... ouvrez le codec et copiez les param√®tres du contexte dans le flux ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_from_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVRational input_framerate = av_guess_frame_rate(decoder_avfc, decoder_video_avs, <span class="hljs-literal">NULL</span>);<font></font>
AVStream *video_avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
<span class="hljs-keyword">char</span> *codec_name = <span class="hljs-string">"libx265"</span>;
<span class="hljs-keyword">char</span> *codec_priv_key = <span class="hljs-string">"x265-params"</span>;
<span class="hljs-comment">// we're going to use internal options for the x265</span>
<span class="hljs-comment">// it disables the scene change detection and fix then</span>
<span class="hljs-comment">// GOP on 60 frames.</span>
<span class="hljs-keyword">char</span> *codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
AVCodec *video_avc = avcodec_find_encoder_by_name(codec_name);<font></font>
AVCodecContext *video_avcc = avcodec_alloc_context3(video_avc);<font></font>
<span class="hljs-comment">// encoder codec params</span>
av_opt_set(sc-&gt;video_avcc-&gt;priv_data, codec_priv_key, codec_priv_value, <span class="hljs-number">0</span>);<font></font>
video_avcc-&gt;height = decoder_ctx-&gt;height;<font></font>
video_avcc-&gt;width = decoder_ctx-&gt;width;<font></font>
video_avcc-&gt;pix_fmt = video_avc-&gt;pix_fmts[<span class="hljs-number">0</span>];
<span class="hljs-comment">// control rate</span>
video_avcc-&gt;bit_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_buffer_size = <span class="hljs-number">4</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_max_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_min_rate = <span class="hljs-number">2.5</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;
<span class="hljs-comment">// time base</span><font></font>
video_avcc-&gt;time_base = av_inv_q(input_framerate);<font></font>
video_avs-&gt;time_base = sc-&gt;video_avcc-&gt;time_base;<font></font>
<font></font>
avcodec_open2(sc-&gt;video_avcc, sc-&gt;video_avc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_from_context(sc-&gt;video_avs-&gt;codecpar, sc-&gt;video_avcc);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est n√©cessaire d'√©tendre le cycle de d√©codage pour transcoder un flux vid√©o:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous envoyons un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vide </font><b><font style="vertical-align: inherit;">au</font></b><font style="vertical-align: inherit;"> d√©codeur ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez l'AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> non compress√© </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous commen√ßons √† recoder le cadre brut.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous envoyons le cadre brut ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenons une</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compression bas√©e sur notre codec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><b><font style="vertical-align: inherit;">avcodec_receive_packet</font></b><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez l'horodatage ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_packet_rescale_ts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous √©crivons dans le fichier de sortie ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span> (av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_packet(decoder_video_avcc, input_packet);
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_frame(decoder_video_avcc, input_frame);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
      encode(encoder_avfc, decoder_video_avs, encoder_video_avs, decoder_video_avcc, input_packet-&gt;stream_index);<font></font>
    }<font></font>
    av_frame_unref(input_frame);<font></font>
  }<font></font>
  av_packet_unref(input_packet);<font></font>
}<font></font>
av_write_trailer(encoder_avfc);<font></font>
<font></font>
<span class="hljs-comment">// used function</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">encode</span><span class="hljs-params">(AVFormatContext *avfc, AVStream *dec_video_avs, AVStream *enc_video_avs, AVCodecContext video_avcc <span class="hljs-keyword">int</span> index)</span> </span>{<font></font>
  AVPacket *output_packet = av_packet_alloc();<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_frame(video_avcc, input_frame);<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_packet(video_avcc, output_packet);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    output_packet-&gt;stream_index = index;<font></font>
    output_packet-&gt;duration = enc_video_avs-&gt;time_base.den / enc_video_avs-&gt;time_base.num / dec_video_avs-&gt;avg_frame_rate.num * dec_video_avs-&gt;avg_frame_rate.den;<font></font>
<font></font>
    av_packet_rescale_ts(output_packet, dec_video_avs-&gt;time_base, enc_video_avs-&gt;time_base);<font></font>
    response = av_interleaved_write_frame(avfc, output_packet);<font></font>
  }<font></font>
  av_packet_unref(output_packet);<font></font>
  av_packet_free(&amp;output_packet);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons converti le flux multim√©dia de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Comme pr√©vu, la version du fichier multim√©dia h265 est plus petite que h264, tandis que le programme offre de nombreuses possibilit√©s:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">/*
   * H264 -&gt; H265
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx265"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x265-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - fragmented MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.muxer_opt_key = <span class="hljs-string">"movflags"</span>;<font></font>
  sp.muxer_opt_value = <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; AAC
   * MP4 - MPEG-TS
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">0</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.audio_codec = <span class="hljs-string">"aac"</span>;<font></font>
  sp.output_extension = <span class="hljs-string">".ts"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/* WIP :P  -&gt; it's not playing on VLC, the final bit rate is huge
   * H264 -&gt; VP9
   * Audio -&gt; Vorbis
   * MP4 - WebM
   */</span>
  <span class="hljs-comment">//StreamingParams sp = {0};</span>
  <span class="hljs-comment">//sp.copy_audio = 0;</span>
  <span class="hljs-comment">//sp.copy_video = 0;</span>
  <span class="hljs-comment">//sp.video_codec = "libvpx-vp9";</span>
  <span class="hljs-comment">//sp.audio_codec = "libvorbis";</span>
  <span class="hljs-comment">//sp.output_extension = ".webm";</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La main sur le c≈ìur, j'avoue que c'√©tait un peu plus compliqu√© qu'il n'y paraissait au d√©but. </font><font style="vertical-align: inherit;">J'ai d√ª choisir le code source de la ligne de commande FFmpeg et tester beaucoup. </font><font style="vertical-align: inherit;">J'ai probablement manqu√© quelque chose quelque part, car j'ai d√ª utiliser </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force-cfr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et certains messages d'avertissement apparaissent toujours, par exemple, que le type de trame (5) a √©t√© chang√© de force en type de trame (3).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traductions sur le blog Edison:</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/fr/yz/q7/fryzq72v0ik0irt2q4orchflxvs.jpeg"></a></td>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/jv/3k/-f/jv3k-f5vi9drztohsh-e0t-puru.jpeg"></a></td>
</tr>
<tr>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Top 50 des franchises de jeux </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
avec plus d'un milliard de revenus</font></font></a></th>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  Airbnb ?<br>
[: ]</a></th>
</tr>
</tbody></table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495604/index.html">Localisation temporaire sur Symfony 4 + Twig</a></li>
<li><a href="../fr495606/index.html">"Surveillance sociale." Score 1: 0 en notre faveur</a></li>
<li><a href="../fr495608/index.html">[Infographie] Visualisation des pand√©mies dans l'histoire de l'humanit√©</a></li>
<li><a href="../fr495610/index.html">Pourquoi l'avenir n'est pas pour Python</a></li>
<li><a href="../fr495612/index.html">Airbnb survivra-t-il au coronavirus? [spoiler: oui]</a></li>
<li><a href="../fr495618/index.html">La mise en quarantaine entra√Æne des pertes. Comment vivre sans quarantaine?</a></li>
<li><a href="../fr495620/index.html">Assembl√© une moissonneuse de vid√©oconf√©rence √† Jabra Panacast, avantages et inconv√©nients pour le bureau et la maison</a></li>
<li><a href="../fr495622/index.html">Avion √† double syst√®me de climatisation num√©rique (SLE)</a></li>
<li><a href="../fr495624/index.html">Pourquoi la Xbox Series X sera le principal achat de 2020</a></li>
<li><a href="../fr495634/index.html">Tout le monde le fait: pourquoi les employ√©s sont la principale menace √† la s√©curit√© des informations de l'entreprise et comment y faire face</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>