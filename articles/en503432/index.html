<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚úàÔ∏è ü§† üôä Cross-platform multi-threaded TCP / IP server in C ++ ‚õ≥Ô∏è üßìüèΩ ‚ò†Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, the task arose of writing a simple and fast multi-threaded TCP / IP server in C ++ and at the same time to work from under Windows and Linux wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cross-platform multi-threaded TCP / IP server in C ++</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503432/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once, the task arose of writing a simple and fast multi-threaded TCP / IP server in C ++ and at the same time to work from under Windows and Linux without the need to somehow change the code outside the class of the server itself. </font><font style="vertical-align: inherit;">Previously, in pure C ++ without libraries like Qt, the Tcp server did not write, and foreshadowed itself a long time of torment with platform-dependent. </font><font style="vertical-align: inherit;">But as it turned out, everything is much simpler than it seemed at first glance, because basically the socket interfaces of both systems are similar as two drops of water and differ only in small details.</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So the server and client class is as follows:</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TcpServer.h</font></font></strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> TCPSERVER_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TCPSERVER_H</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdint&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;functional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;list&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32 <span class="hljs-comment">// Windows NT</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;WinSock2.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">// *nix</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-comment">//     </span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">uint16_t</span> buffer_size = <span class="hljs-number">4096</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TcpServer</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span>;</span>
     <span class="hljs-comment">// Callback-  </span>
    <span class="hljs-keyword">typedef</span> <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(Client)&gt; <span class="hljs-keyword">handler_function_t</span>;
     <span class="hljs-comment">// </span>
    <span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">status</span> :</span> <span class="hljs-keyword">uint8_t</span> {<font></font>
        up = <span class="hljs-number">0</span>,<font></font>
        err_socket_init = <span class="hljs-number">1</span>,<font></font>
        err_socket_bind = <span class="hljs-number">2</span>,<font></font>
        err_socket_listening = <span class="hljs-number">3</span>,<font></font>
        close = <span class="hljs-number">4</span><font></font>
    };<font></font>
<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">uint16_t</span> port; <span class="hljs-comment">//</span><font></font>
    status _status = status::close;<font></font>
    <span class="hljs-keyword">handler_function_t</span> handler;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::thread handler_thread;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread&gt; client_handler_threads;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread::id&gt; client_handling_end;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32 <span class="hljs-comment">// Windows NT</span></span><font></font>
    SOCKET serv_socket = INVALID_SOCKET;<font></font>
    WSAData w_data;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">// *nix</span></span>
    <span class="hljs-keyword">int</span> serv_socket;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">handlingLoop</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    TcpServer(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> port, <span class="hljs-keyword">handler_function_t</span> handler);<font></font>
    ~TcpServer();<font></font>
<font></font>
    <span class="hljs-comment">//! Set client handler</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setHandler</span><span class="hljs-params">(<span class="hljs-keyword">handler_function_t</span> handler)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">uint16_t</span> <span class="hljs-title">getPort</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">uint16_t</span> <span class="hljs-title">setPort</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> port)</span></span>;<font></font>
<font></font>
    <span class="hljs-function">status <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{<span class="hljs-keyword">return</span> _status;}<font></font>
<font></font>
    <span class="hljs-function">status <span class="hljs-title">restart</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function">status <span class="hljs-title">start</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">joinLoop</span><span class="hljs-params">()</span></span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TcpServer</span>:</span>:Client {
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32 <span class="hljs-comment">// Windows NT</span></span><font></font>
    SOCKET socket;<font></font>
    SOCKADDR_IN address;<font></font>
    <span class="hljs-keyword">char</span> buffer[buffer_size];
<span class="hljs-keyword">public</span>:<font></font>
    Client(SOCKET socket, SOCKADDR_IN address);<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">// *nix</span></span>
    <span class="hljs-keyword">int</span> socket;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">address</span>;</span>
    <span class="hljs-keyword">char</span> buffer[buffer_size];
<span class="hljs-keyword">public</span>:<font></font>
    Client(<span class="hljs-keyword">int</span> socket, struct sockaddr_in address);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-keyword">public</span>:<font></font>
    Client(<span class="hljs-keyword">const</span> Client&amp; other);<font></font>
    ~Client();<font></font>
    <span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">getHost</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">uint16_t</span> <span class="hljs-title">getPort</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">sendData</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* buffer, <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> size)</span> <span class="hljs-keyword">const</span></span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">// TCPSERVER_H</span></span>
</code></pre><br>
<p>               ‚Äî <code>SOCKET</code>  Windows  (     ) <code>int</code>  Linux.       Linux   int    ,      Windows             ,       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//file _socket_types.h</span>
<span class="hljs-comment">//...</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 1</span>
<span class="hljs-keyword">typedef</span> UINT_PTR    SOCKET;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-keyword">typedef</span> INT_PTR     SOCKET;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">//...</span><font></font>
<font></font>
<span class="hljs-comment">//file BaseTsd.h</span>
<span class="hljs-comment">//...</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(_WIN64)</span>
 <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> __int64 UINT_PTR;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
 <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> UINT_PTR;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">//...</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(_WIN64) </span>
 <span class="hljs-keyword">typedef</span> __int64 INT_PTR; 
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> </span>
 <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">int</span> INT_PTR;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">//...</span></code></pre><br>
<p>   Windows  TcpServer-       WinSocket ‚Äî <code>WSAData w_data;</code>(. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">WSAData</a>)</p><br>
<p>   :</p><br>
<p><strong>TcpServer.cpp</strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"../hdr/TcpServer.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// :</span>
<span class="hljs-comment">//port -      </span>
<span class="hljs-comment">//handler - callback-    </span>
<span class="hljs-comment">//                 callback</span>
<span class="hljs-comment">//          ( -: [](TcpServer::Client){...do something...})</span>
TcpServer::TcpServer(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> port, <span class="hljs-keyword">handler_function_t</span> handler) : port(port), handler(handler) {}<font></font>
<font></font>
<span class="hljs-comment">//      </span>
<span class="hljs-comment">//    WinSocket</span><font></font>
TcpServer::~TcpServer() {<font></font>
  <span class="hljs-keyword">if</span>(_status == status::up)<font></font>
    stop();<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32 <span class="hljs-comment">// Windows NT</span></span><font></font>
    WSACleanup ();<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// callback-    </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::setHandler</span><span class="hljs-params">(TcpServer::<span class="hljs-keyword">handler_function_t</span> handler)</span> </span>{<span class="hljs-keyword">this</span>-&gt;handler = handler;}<font></font>
<font></font>
<span class="hljs-comment">//Getter/Setter </span>
<span class="hljs-function"><span class="hljs-keyword">uint16_t</span> <span class="hljs-title">TcpServer::getPort</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{<span class="hljs-keyword">return</span> port;}
<span class="hljs-function"><span class="hljs-keyword">uint16_t</span> <span class="hljs-title">TcpServer::setPort</span><span class="hljs-params">( <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> port)</span> </span>{
    <span class="hljs-keyword">this</span>-&gt;port = port;<font></font>
    restart(); <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">return</span> port;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// </span>
<span class="hljs-function">TcpServer::status <span class="hljs-title">TcpServer::restart</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span>(_status == status::up)<font></font>
      stop ();<font></font>
    <span class="hljs-keyword">return</span> start();<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//     </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::joinLoop</span><span class="hljs-params">()</span> </span>{handler_thread.join();}<font></font>
<font></font>
<span class="hljs-comment">//         </span>
<span class="hljs-keyword">int</span> TcpServer::Client::loadData() {<span class="hljs-keyword">return</span> recv(socket, buffer, buffer_size, <span class="hljs-number">0</span>);}
<span class="hljs-comment">//       </span>
<span class="hljs-keyword">char</span>* TcpServer::Client::getData() {<span class="hljs-keyword">return</span> buffer;}
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">bool</span> TcpServer::Client::sendData(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* buffer, <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> size) <span class="hljs-keyword">const</span> {
  <span class="hljs-keyword">if</span>(send(socket, buffer, size, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32 <span class="hljs-comment">// Windows NT</span></span>
<span class="hljs-comment">// </span>
<span class="hljs-function">TcpServer::status <span class="hljs-title">TcpServer::start</span><span class="hljs-params">()</span> </span>{<font></font>
    WSAStartup(MAKEWORD(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), &amp;w_data); <span class="hljs-comment">//  WinSocket</span><font></font>
<font></font>
    SOCKADDR_IN address; <span class="hljs-comment">// //   </span>
    address.sin_addr.S_un.S_addr = INADDR_ANY; <span class="hljs-comment">// IP </span>
    address.sin_port = htons(port); <span class="hljs-comment">// </span>
    address.sin_family = AF_INET; <span class="hljs-comment">//AF_INET - C   IPv4</span><font></font>
<font></font>
    <span class="hljs-comment">//        </span>
    <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">int</span>&gt;(serv_socket = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>)) == SOCKET_ERROR) <span class="hljs-keyword">return</span> _status = status::err_socket_init;
    <span class="hljs-comment">//          </span>
    <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">if</span>(bind(serv_socket, (struct sockaddr*)&amp;address, <span class="hljs-keyword">sizeof</span>(address)) == SOCKET_ERROR) <span class="hljs-keyword">return</span> _status = status::err_socket_bind;
    <span class="hljs-comment">//      </span>
    <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">if</span>(listen(serv_socket, SOMAXCONN) == SOCKET_ERROR) <span class="hljs-keyword">return</span> _status = status::err_socket_listening;<font></font>
<font></font>
    <span class="hljs-comment">// ,      </span><font></font>
    _status = status::up;<font></font>
    handler_thread = <span class="hljs-built_in">std</span>::thread([<span class="hljs-keyword">this</span>]{handlingLoop();});
    <span class="hljs-keyword">return</span> _status;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::stop</span><span class="hljs-params">()</span> </span>{<font></font>
    _status = status::close; <span class="hljs-comment">// </span>
    closesocket (serv_socket); <span class="hljs-comment">// </span>
    joinLoop(); <span class="hljs-comment">// </span>
    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::thread&amp; cl_thr : client_handler_threads) <span class="hljs-comment">//   </span>
        cl_thr.join(); <span class="hljs-comment">//   </span>
    client_handler_threads.clear (); <span class="hljs-comment">//    </span>
    client_handling_end.clear (); <span class="hljs-comment">//      </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::handlingLoop</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span>(_status == status::up) {<font></font>
        SOCKET client_socket; <span class="hljs-comment">// </span>
        SOCKADDR_IN client_addr; <span class="hljs-comment">// </span>
        <span class="hljs-keyword">int</span> addrlen = <span class="hljs-keyword">sizeof</span>(client_addr); <span class="hljs-comment">//  </span>
        <span class="hljs-comment">//    </span>
        <span class="hljs-comment">//(        )</span>
        <span class="hljs-keyword">if</span> ((client_socket = accept(serv_socket, (struct sockaddr*)&amp;client_addr, &amp;addrlen)) != <span class="hljs-number">0</span> &amp;&amp; _status == status::up){<font></font>
            client_handler_threads.push_back(<span class="hljs-built_in">std</span>::thread([<span class="hljs-keyword">this</span>, &amp;client_socket, &amp;client_addr] {<font></font>
                handler(Client(client_socket, client_addr)); <span class="hljs-comment">// callback-</span>
                <span class="hljs-comment">//       </span>
                client_handling_end.push_back (<span class="hljs-built_in">std</span>::this_thread::get_id()); <font></font>
            }));<font></font>
        }<font></font>
        <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">if</span>(!client_handling_end.empty())
          <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread::id&gt;::iterator id_it = client_handling_end.begin (); !client_handling_end.empty() ; id_it = client_handling_end.begin())
            <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread&gt;::iterator thr_it = client_handler_threads.begin (); thr_it != client_handler_threads.end () ; ++thr_it)
              <span class="hljs-keyword">if</span>(thr_it-&gt;get_id () == *id_it) {<font></font>
                thr_it-&gt;join();<font></font>
                client_handler_threads.erase(thr_it);<font></font>
                client_handling_end.erase (id_it);<font></font>
                <span class="hljs-keyword">break</span>;<font></font>
              }<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">50</span>));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//      </span><font></font>
TcpServer::Client::Client(SOCKET socket, SOCKADDR_IN address) : socket(socket), address(address) {}<font></font>
<span class="hljs-comment">//  </span>
TcpServer::Client::Client(<span class="hljs-keyword">const</span> TcpServer::Client&amp; other) : socket(other.socket), address(other.address) {}<font></font>
<font></font>
TcpServer::Client::~Client() {<font></font>
    shutdown(socket, <span class="hljs-number">0</span>); <span class="hljs-comment">//  </span>
    closesocket(socket); <span class="hljs-comment">// </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">uint32_t</span> TcpServer::Client::getHost() <span class="hljs-keyword">const</span> {<span class="hljs-keyword">return</span> address.sin_addr.S_un.S_addr;}
<span class="hljs-keyword">uint16_t</span> TcpServer::Client::getPort() <span class="hljs-keyword">const</span> {<span class="hljs-keyword">return</span> address.sin_port;}<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">// *nix</span></span><font></font>
<font></font>
<span class="hljs-comment">//  (     Windows)</span>
<span class="hljs-function">TcpServer::status <span class="hljs-title">TcpServer::start</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server</span>;</span><font></font>
    server.sin_addr.s_addr = INADDR_ANY;<font></font>
    server.sin_port = htons( port );<font></font>
    server.sin_family = AF_INET;<font></font>
    serv_socket = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(serv_socket == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> _status = status::err_socket_init;
    <span class="hljs-keyword">if</span>(bind(serv_socket,(struct sockaddr *)&amp;server , <span class="hljs-keyword">sizeof</span>(server)) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> _status = status::err_socket_bind;
    <span class="hljs-keyword">if</span>(listen(serv_socket, <span class="hljs-number">3</span>) &lt; <span class="hljs-number">0</span>)<span class="hljs-keyword">return</span> _status = status::err_socket_listening;<font></font>
<font></font>
    _status = status::up;<font></font>
    handler_thread = <span class="hljs-built_in">std</span>::thread([<span class="hljs-keyword">this</span>]{handlingLoop();});
    <span class="hljs-keyword">return</span> _status;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::stop</span><span class="hljs-params">()</span> </span>{<font></font>
    _status = status::close;<font></font>
    close(serv_socket);<font></font>
    joinLoop();<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::thread&amp; cl_thr : client_handler_threads)<font></font>
        cl_thr.join();<font></font>
    client_handler_threads.clear ();<font></font>
    client_handling_end.clear ();<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    (     Windows)</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TcpServer::handlingLoop</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (_status == status::up) {
        <span class="hljs-keyword">int</span> client_socket;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">client_addr</span>;</span>
        <span class="hljs-keyword">int</span> addrlen = <span class="hljs-keyword">sizeof</span> (struct sockaddr_in);
        <span class="hljs-keyword">if</span>((client_socket = accept(serv_socket, (struct sockaddr*)&amp;client_addr, (<span class="hljs-keyword">socklen_t</span>*)&amp;addrlen)) &gt;= <span class="hljs-number">0</span> &amp;&amp; _status == status::up)<font></font>
            client_handler_threads.push_back(<span class="hljs-built_in">std</span>::thread([<span class="hljs-keyword">this</span>, &amp;client_socket, &amp;client_addr] {<font></font>
                handler(Client(client_socket, client_addr));<font></font>
                client_handling_end.push_back (<span class="hljs-built_in">std</span>::this_thread::get_id());<font></font>
            }));<font></font>
<font></font>
        <span class="hljs-keyword">if</span>(!client_handling_end.empty())
          <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread::id&gt;::iterator id_it = client_handling_end.begin (); !client_handling_end.empty() ; id_it = client_handling_end.begin())
            <span class="hljs-keyword">for</span>(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">list</span>&lt;<span class="hljs-built_in">std</span>::thread&gt;::iterator thr_it = client_handler_threads.begin (); thr_it != client_handler_threads.end () ; ++thr_it)
              <span class="hljs-keyword">if</span>(thr_it-&gt;get_id () == *id_it) {<font></font>
                thr_it-&gt;join();<font></font>
                client_handler_threads.erase(thr_it);<font></font>
                client_handling_end.erase (id_it);<font></font>
                <span class="hljs-keyword">break</span>;<font></font>
              }<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">50</span>));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//      </span>
TcpServer::Client::Client(<span class="hljs-keyword">int</span> socket, struct sockaddr_in address) : socket(socket), address(address) {}
<span class="hljs-comment">//  </span>
TcpServer::Client::Client(<span class="hljs-keyword">const</span> TcpServer::Client&amp; other) : socket(other.socket), address(other.address) {}<font></font>
<font></font>
TcpServer::Client::~Client() {<font></font>
    shutdown(socket, <span class="hljs-number">0</span>); <span class="hljs-comment">//  </span>
    close(socket); <span class="hljs-comment">// </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">uint32_t</span> TcpServer::Client::getHost() {<span class="hljs-keyword">return</span> address.sin_addr.s_addr;}
<span class="hljs-keyword">uint16_t</span> TcpServer::Client::getPort() {<span class="hljs-keyword">return</span> address.sin_port;}<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation for Linux and Windows is almost identical, with the exception of some places, caused only by various structures that store addresses ( </font></font><code>struct sockaddr_in/SOCKADDR_IN, struct sockaddr/SOCKADDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and sockets ( </font></font><code>int/SOCKET</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), as well as the presence of a WinSocket ( </font></font><code>WSAData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">version in Windows </font><font style="vertical-align: inherit;">.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usage example:</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"server/hdr/TcpServer.h"</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// ip  std::string</span>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">getHostStr</span><span class="hljs-params">(<span class="hljs-keyword">const</span> TcpServer::Client&amp; client)</span> </span>{
  <span class="hljs-keyword">uint32_t</span> ip = client.getHost ();
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>() + <span class="hljs-built_in">std</span>::to_string(<span class="hljs-keyword">int</span>(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>*&gt;(&amp;ip)[<span class="hljs-number">0</span>])) + <span class="hljs-string">'.'</span> +
         <span class="hljs-built_in">std</span>::to_string(<span class="hljs-keyword">int</span>(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>*&gt;(&amp;ip)[<span class="hljs-number">1</span>])) + <span class="hljs-string">'.'</span> +
         <span class="hljs-built_in">std</span>::to_string(<span class="hljs-keyword">int</span>(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>*&gt;(&amp;ip)[<span class="hljs-number">2</span>])) + <span class="hljs-string">'.'</span> +
         <span class="hljs-built_in">std</span>::to_string(<span class="hljs-keyword">int</span>(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">char</span>*&gt;(&amp;ip)[<span class="hljs-number">3</span>])) + <span class="hljs-string">':'</span> +
         <span class="hljs-built_in">std</span>::to_string( client.getPort ());<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">//  TcpServer      -   </span>
  <span class="hljs-function">TcpServer <span class="hljs-title">server</span><span class="hljs-params">( <span class="hljs-number">8080</span>,

      [](TcpServer::Client client){

          <span class="hljs-comment">//     </span>
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Connected host:"</span>&lt;&lt;getHostStr(client)&lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;

          <span class="hljs-comment">//   </span>
          <span class="hljs-keyword">int</span> size = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">while</span> (size == <span class="hljs-number">0</span>) size = client.loadData ();

          <span class="hljs-comment">//       </span>
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>
              &lt;&lt;<span class="hljs-string">"size: "</span>&lt;&lt;size&lt;&lt;<span class="hljs-string">" bytes"</span>&lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>
              &lt;&lt; client.getData() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;

          <span class="hljs-comment">//  </span>
          <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> answer[] = <span class="hljs-string">"Hello World from Server"</span>;
          client.sendData(answer, <span class="hljs-keyword">sizeof</span> (answer));
      }

  )</span></span>;<font></font>
<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">if</span>(server.start() == TcpServer::status::up) {
    <span class="hljs-comment">//          </span>
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Server is up!"</span>&lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
      server.joinLoop();<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//         </span>
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"Server start error! Error code:"</span>&lt;&lt; <span class="hljs-keyword">int</span>(server.getStatus()) &lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
}</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Link</font></font></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Used articles:</font></font></p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux socket programming</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple and fast server in C / C ++ ...</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winsock server application</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503414/index.html">Hack The Box. Walkthrough Rope. PWN. Format strings and ROP using pwntools</a></li>
<li><a href="../en503420/index.html">Lemmatize it faster (PyMorphy2, PyMystem3 and some magic)</a></li>
<li><a href="../en503426/index.html">44.2 Tb / s over fiber - how does it work?</a></li>
<li><a href="../en503428/index.html">How to Improve Written English for Communication Abroad: Linguix Business Project</a></li>
<li><a href="../en503430/index.html">MS Remote Desktop Gateway, HAProxy and password guessing</a></li>
<li><a href="../en503446/index.html">Where can you open a bank account for a non-resident company from the high-risk category in 2020?</a></li>
<li><a href="../en503448/index.html">How not to join the ranks of aspiring specialists if you are Data Scientist</a></li>
<li><a href="../en503450/index.html">Stories about my work in the Netherlands</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electr√≥nico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisi√≥n de noticias gratuitas y de c√≥digo abierto del 27 de enero al 2 de febrero de 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>