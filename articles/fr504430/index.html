<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖲️ 👨🏾‍🚀 🔸 Centre des opérations de sécurité Tinkoff de la vie quotidienne: analyse du chargeur de démarrage unique ▪️ 👩🏾‍🤝‍👨🏽 ↔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Dans notre centre d'opérations de sécurité Tinkoff, nous analysons régulièrement les techniques utilisées dans les logiciels malvei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Centre des opérations de sécurité Tinkoff de la vie quotidienne: analyse du chargeur de démarrage unique</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre centre d'opérations de sécurité Tinkoff, nous analysons régulièrement les techniques utilisées dans les logiciels malveillants et les attaques, et récemment nous sommes tombés sur un fichier intéressant dont nous aimerions parler.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="image"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La technique qui a été utilisée pour créer ce chef-d'œuvre est connue depuis plus de 20 ans, mais même des décennies plus tard, elle reste pertinente, car les appels de certains contrôles dans la macro ne sont pas suspects et peuvent être utilisés dans des documents légitimes. </font><font style="vertical-align: inherit;">Il s'agit d'un téléchargeur de logiciels malveillants écrit dans des macros Excel 4.0.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de l'analyse, nous utiliserons au minimum des outils tiers et nous nous en sortirons avec un ensemble standard de programmes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suite Microsoft Office</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archiveur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éditeur de texte;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme outil d'analyse des actions logicielles, nous utiliserons Sysmon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme environnement d'analyse, nous utiliserons une machine virtuelle avec Windows 7 à bord</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mnogabukaf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le document que nous allons analyser est un classeur Excel au format xls. </font><font style="vertical-align: inherit;">Le logiciel malveillant est livré dans des e-mails de phishing, lorsque le document démarre, la macro décharge la branche de registre, télécharge des informations sur les mises à jour Office à partir du site Web de Microsoft, et télécharge et lance également des fichiers .dll malveillants. </font><font style="vertical-align: inherit;">Après ces étapes, le livre se ferme sans enregistrer les modifications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La principale différence avec les autres chargeurs de ce type est qu'il n'utilise pas de macros VBA.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse statique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un exemple d'e-mail contenant un document malveillant. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrez la pièce jointe dans notre machine virtuelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez faire attention tout de suite: l'image vous avertit que le document est «protégé» et il vaut la peine de l'ouvrir localement et de cliquer sur «activer le contenu»: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
un avertissement de sécurité indique que vous devez regarder les projets dans Visual Basic Editor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous tournons vers le développeur - gestion des macros (vbs), mais nous ne voyons pas de macros vbs ou vba: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
voici le moment de se rappeler ce que sont les documents bureautiques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque document Microsoft Office est une archive qui peut être décompressée à l'aide de n'importe quel archiveur, extrayant le contenu du document:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après le déballage, nous voyons qu'à l'intérieur des documents il n'y a pas de fichiers xml que nous sommes habitués à voir, la chose est dans l'ancien format de document - xls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'extension xls, le contenu n'est pas stocké au format Office Open XML, mais au format binaire BIFF8. Le document utilise la macro Excel 4.0, où les macros peuvent être exécutées dans les cellules du document. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de noter que la feuille avec la macro n'est pas masquée, mais la feuille a un grand nombre de cellules vides, ce qui rend l'analyse difficile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des outils pour analyser les fichiers BIFF8, ​​par exemple BiffViewer, et pour analyser le contenu, il existe un excellent outil - oletools. Mais nous essaierons de faire sans utiliser des utilitaires tiers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excel a également un format basé sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xlsm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez y enregistrer du code macro VBA et des feuilles de macro Excel 4.0, ce que nous ferons. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste complète des formats disponibles pour Excel est les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formats Excel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous enregistrons notre document, le décompressons: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qu'il y a dans les fichiers, commençons par le répertoire des macrosheets dans le dossier xl et trouvons le fichier avec toutes les données sur la feuille de macro: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous obtenons toutes les valeurs dans les cellules de la feuille de macro. </font><font style="vertical-align: inherit;">La macro elle-même est obscurcie, les cellules contiennent uniquement des valeurs numériques et des formules qui convertissent ces valeurs et écrivent le résultat dans de nouvelles cellules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, dans cette formule, les valeurs numériques sont converties en caractères, concaténées et écrites dans la cellule FK17653.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formule en excel</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de la formule, nous obtenons la ligne suivante: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque macro-commande suivante est «collectée» par une formule similaire, écrite dans la cellule, puis exécutée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que la macro s'exécute automatiquement à l'ouverture du document, la cellule à partir de laquelle le script doit être lancé doit être appelée Auto_Open. </font><font style="vertical-align: inherit;">Considérez le fichier workbook.xml:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=«1.0» encoding=«UTF-8» standalone=«yes»?&gt;<br>
&lt;workbook xmlns=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>» xmlns:r=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>» xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>» mc:Ignorable=«x15» xmlns:x15=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>»&gt; appName=«xl» lastEdited=«6» lowestEdited=«6» rupBuild=«14420»/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>»&gt; Requires=«x15»&gt;&lt;x15ac:absPath url=«C:\Users\User\Desktop\malware\» xmlns:x15ac=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>»/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=«Sheet1» sheetId=«1» r:id=«rId1»/&gt;&lt;sheet name=«Sheet2» sheetId=«2» r:id=«rId2»/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'intérieur du fichier, nous trouvons la ligne name = "_ xlnm.Auto_OpenT8nee" hidden = "1"&gt; Sheet2! $ IE $ 65406 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que la cellule à partir de laquelle la macro est exécutée, IE65406, est masquée. </font><font style="vertical-align: inherit;">Nous connaissons maintenant le point d'entrée de la macro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse dynamique</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'exécutez jamais de fichiers suspects sur votre ordinateur. </font><font style="vertical-align: inherit;">Pour étudier les actions des logiciels suspects, il est nécessaire d'utiliser un environnement spécialement préparé: divers bacs à sable ou une machine isolée spécialement préparée - virtuelle ou en fer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrez le document et exécutez le contenu. </font><font style="vertical-align: inherit;">La fenêtre d'invite de commandes clignote et le livre se ferme. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons les journaux Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon a un événement de création de processus (id 1), plus d'informations sur Sysmon peuvent être trouvées </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par les journaux, nous voyons que la macro crée des fichiers dans le répertoire c: \ users \ public </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui suit est le message sysmon, qui montre que la branche de registre est déchargée et le résultat est écrit dans le fichier:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID d'événement d'événement Sysmon 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: «C:\Windows\system32\reg.exe» EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: «C:\Program Files\Microsoft Office\Office16\EXCEL.EXE»</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois terminée, la macro supprime les fichiers créés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour interdire la suppression de fichiers, modifier les autorisations sur le dossier, laisser les autorisations de lecture et d'écriture et interdire la suppression: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Réexécutez le document, nous recevrons une erreur lors de l'exécution de la macro, ce qui nous permettra de le déboguer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela est possible car il n'y a pas de gestion des exceptions dans certains appels. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutons la macro étape par étape; pendant le débogage, nous rencontrons des appels de fonction à partir de bibliothèques dll, telles que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Une fois la macro terminée, les fichiers suivants seront dans le dossier des utilisateurs partagés:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous connaissons la cellule à partir de laquelle commence l'exécution, nous pouvons remplir toutes les cellules de la feuille macro. </font><font style="vertical-align: inherit;">Passons en revue la macro jusqu'à la fonction close (false), où nous allons interrompre l'exécution en cliquant sur le bouton "Pause".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cellules de contrôle de l'environnement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En parcourant les cellules que la macro remplit, nous rencontrons plusieurs fonctions get.window () et get.workspace ()</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fonction get.window () renvoie des informations sur la fenêtre actuelle: état, état de la fenêtre, son nom, options d'affichage, etc.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fonction get.workspace () vous permet de trouver des informations sur l'environnement dans lequel le document s'exécute.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une liste complète des appels disponibles pour Excel 4.0 se trouve dans les liens. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous devons nous attarder plus en détail: mon collègue et moi avons suggéré que la plupart de ces appels sont liés à des tentatives de contournement des bacs à sable:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow (7) - vérifie si la fenêtre actuelle est masquée. </font><font style="vertical-align: inherit;">Renvoie vrai ou faux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (20) - renvoie vrai si la fenêtre est agrandie.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (23) - peut renvoyer les valeurs 1, 2 et 3.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/d54/afe/028/d54afe0281d24b5e34040af0122cd3d7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - restauré </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - minimisé </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - maximisé </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, il vérifie si la fenêtre actuelle est ouverte: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (31) - vérifie si la macro est déboguée par étapes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (13) - vérifier la largeur de l'espace de travail en pixels: si moins de 770, le livre se fermera </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (14) - vérifier la hauteur de l'espace de travail en pixels: si moins de 390, le livre fermera </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (19) - vérifier la présence d'une souris. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (1) - retourne dans quel système d'exploitation le document est exécuté. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cas de faux, dans chaque chèque, il y a une transition vers la cellule de fermeture du livre sans enregistrer le résultat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels de bibliothèque externe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir vérifié l'environnement, nous passons à la fonctionnalité principale. Voyons comment les fonctions WinAPI sont appelées à partir de la macro: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. L'appel reg.exe, que nous avons vu dans les journaux Sysmon. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour appeler l'utilitaire, la fonction ShellExecute de la bibliothèque shell32.dll est utilisée, les paramètres de la fonction sont dispersés dans d'autres cellules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cellule BN16631: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cellule A46097: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la cellule GN47559, la commande pour exporter la branche de registre nécessaire est envoyée, Get.workspace (2) renvoie la version d'Excel. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cellule DX48821 contient le chemin où le résultat est écrit. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus loin dans la macro, il existe une vérification de l'existence du fichier IcltdXw.reg créé et de sa suppression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Appel de la fonction URLDownloadToFile. Cette fonction enregistre le résultat d'une requête get dans un fichier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel est le suivant:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet appel nous mène au site Web de Microsoft, à la page contenant des informations sur les mises à jour d'Office. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paramètres de fonction: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cellule BR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cellule IN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après l'exécution de l'instruction, il est vérifié si le fichier a été créé, ainsi que la lecture du caractère par l'offset dans le fichier: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces actions visent très probablement à vérifier si l'environnement dans lequel le document s'exécute dispose d'un accès Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la formule, la fonction FILES est transmise à iserror et l'argument est le nom du fichier dans lequel le résultat de la fonction URLDownloadToFile doit être écrit: la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cellule FM27223 donnera le contrôle de la fonction de fermeture du livre: une </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fois le fichier reçu de Microsoft, les cellules sont remplies pour préparer le deuxième appel à la DLL urlmon.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chargement de charge utile</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le deuxième appel, mais au domaine dehabadi [.] Ir, à partir duquel la charge malveillante doit être chargée: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le résultat sera écrit dans un fichier dans le même dossier avec l'extension html: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous rencontrons une branche dans le code macro si, lors de la première tentative de téléchargement de la charge utile, a échoué, une deuxième tentative sera effectuée, mais à partir d'une adresse différente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le téléchargement réussit, une fenêtre contextuelle d'avertissement apparaît et la bibliothèque chargée est appelée. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel complet est le suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un appel complet, la fonction ShellExecuteA est appelée à partir de la bibliothèque Shell32 avec des paramètres de lancement de rundll32, avec lesquels la fonction exportée de la bibliothèque malveillante téléchargée est appelée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci termine la fonction macro, la charge utile est opérationnelle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme cela a été dit, la technologie est assez ancienne ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel 4.0 pour Windows 3.0 et 3.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mais elle fournit pleinement les fonctionnalités dont les logiciels malveillants ont besoin pour atteindre leurs objectifs. Et le but de ce fichier est de placer discrètement des logiciels dangereux dans le système qui peuvent causer de graves dommages, à commencer par le vol de données personnelles, les données d'autorisation pour les systèmes, se terminant par une corruption / chiffrement des données sur l'ordinateur et la possibilité d'exécuter du code à distance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'analyse de tels documents, il n'est pas du tout nécessaire d'utiliser des utilitaires et des logiciels spéciaux, cependant, il convient de mentionner un ensemble de scripts </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oletools - plus de détails peuvent être trouvés ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous terminerons ici, ci-dessous, les indicateurs de compromis identifiés à la suite de l'analyse. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIO reçu:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [.] williamdmon [@] wp [.] pl </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [.] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [.] ir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une liste complète des indicateurs de compromis. </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Références:</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Référence de macro 4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A travaillé sur l'analyse: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504402/index.html">29 mai Java Digest</a></li>
<li><a href="../fr504408/index.html">Modèle de cadre de test simple et pratique sur séléniure pour les autotests de l'interface utilisateur</a></li>
<li><a href="../fr504412/index.html">Championnat de programmation en ligne "Open Finals of Moscow Training"</a></li>
<li><a href="../fr504414/index.html">Comment Microsoft a tué AppGet</a></li>
<li><a href="../fr504420/index.html">Écrire une arène PvP au tour par tour avec des mouvements simultanés</a></li>
<li><a href="../fr504434/index.html">Programme éducatif pour les parents: comment protéger les enfants du danger sur Internet</a></li>
<li><a href="../fr504438/index.html">30 mitaps par semaine. Nous ouvrons la saison d'été 2020</a></li>
<li><a href="../fr504442/index.html">Un peu sur les délocalisations dans le noyau Linux</a></li>
<li><a href="../fr504444/index.html">Utilisation de Docker en plusieurs étapes pour créer des images Windows</a></li>
<li><a href="../fr504448/index.html">Gamers Generation II</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>