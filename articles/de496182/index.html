<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📃 🎽 👩‍👩‍👧‍👦 Apache Kafka für Dummies 😈 🈵 🤛🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel ist nützlich für diejenigen, die gerade erst begonnen haben, sich mit der Microservice-Architektur und dem Apache Kafka-Service vertrau...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apache Kafka für Dummies</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dieser Artikel ist nützlich für diejenigen, die gerade erst begonnen haben, sich mit der Microservice-Architektur und dem Apache Kafka-Service vertraut zu machen. </font><font style="vertical-align: inherit;">Das Material erhebt keinen Anspruch auf ein detailliertes Tutorial, hilft Ihnen jedoch dabei, schnell mit dieser Technologie zu beginnen. </font><font style="vertical-align: inherit;">Ich werde darüber sprechen, wie Kafka unter Windows 10 installiert und konfiguriert wird. Wir werden auch ein Projekt mit Intellij IDEA und Spring Boot erstellen.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wozu?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schwierigkeiten beim Verständnis verschiedener Tools hängen häufig damit zusammen, dass der Entwickler noch nie auf Situationen gestoßen ist, in denen diese Tools möglicherweise benötigt werden. Bei Kafka ist das genau das gleiche. Wir beschreiben die Situation, in der diese Technologie nützlich sein wird. Wenn Sie eine monolithische Anwendungsarchitektur haben, benötigen Sie natürlich kein Kafka. Mit dem Übergang zu Microservices ändert sich alles. Tatsächlich ist jeder Mikrodienst ein separates Programm, das die eine oder andere Funktion ausführt und das unabhängig von anderen Mikrodiensten gestartet werden kann. Microservices können mit Mitarbeitern im Büro verglichen werden, die an separaten Schreibtischen sitzen und ihr Problem unabhängig lösen. Die Arbeit eines solchen verteilten Teams ist ohne zentrale Koordination undenkbar.Die Mitarbeiter sollten in der Lage sein, Nachrichten und Ergebnisse ihrer Arbeit miteinander auszutauschen. Apache Kafka für Microservices wurde entwickelt, um dieses Problem zu lösen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka ist ein Nachrichtenbroker. Damit können Microservices miteinander interagieren und wichtige Informationen senden und empfangen. Es stellt sich die Frage, warum Sie nicht die reguläre POST-Anfrage für diese Zwecke verwenden, in deren Hauptteil Sie die erforderlichen Daten übertragen und die Antwort auf die gleiche Weise erhalten können. Dieser Ansatz weist eine Reihe offensichtlicher Nachteile auf. Beispielsweise kann ein Produzent (ein Dienst, der eine Nachricht sendet) Daten nur in Form einer Antwort als Antwort auf eine Anfrage eines Verbrauchers (eines Dienstes, der Daten empfängt) senden. Angenommen, ein Verbraucher sendet eine POST-Anfrage und der Hersteller beantwortet sie. Aus irgendeinem Grund kann der Verbraucher die Antwort derzeit nicht akzeptieren. Was wird mit den Daten passieren? Sie werden verloren gehen. Der Verbraucher muss erneut eine Anfrage senden und hofft, dass sich die Daten, die er erhalten wollte, in dieser Zeit nicht geändert haben.und der Hersteller ist immer noch bereit, die Anfrage anzunehmen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka löst dieses und viele andere Probleme, die beim Austausch von Nachrichten zwischen Microservices auftreten. </font><font style="vertical-align: inherit;">Es wird nicht verkehrt sein, daran zu erinnern, dass ein ununterbrochener und bequemer Datenaustausch eines der Hauptprobleme ist, die gelöst werden müssen, um den stabilen Betrieb der Mikroservice-Architektur sicherzustellen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren und konfigurieren Sie ZooKeeper und Apache Kafka unter Windows 10</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was Sie wissen müssen, um loszulegen, ist, dass Apache Kafka über dem ZooKeeper-Dienst ausgeführt wird. ZooKeeper ist ein verteilter Konfigurations- und Synchronisierungsdienst, und das ist alles, was wir in diesem Zusammenhang darüber wissen müssen. Wir müssen es herunterladen, konfigurieren und ausführen, bevor wir mit Kafka beginnen können. Stellen Sie vor der Arbeit mit ZooKeeper sicher, dass JRE installiert und konfiguriert ist. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können die neueste Version von ZooKeeper von der offiziellen Website herunterladen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir extrahieren die Dateien aus dem heruntergeladenen ZooKeeper-Archiv in einen Ordner auf der Festplatte. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im zookeeper-Ordner mit der Versionsnummer finden wir den conf-Ordner und darin die Datei „zoo_sample.cfg“.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kopieren Sie es und ändern Sie den Namen der Kopie in "zoo.cfg". Öffnen Sie die Kopierdatei und suchen Sie die Zeile dataDir = / tmp / zookeeper darin. In dieser Zeile schreiben wir den vollständigen Pfad in unseren Ordner zookeeper-x.x.x. Für mich sieht es so aus: dataDir = C: \\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt fügen wir die Systemumgebungsvariable hinzu: ZOOKEEPER_HOME = C: \ ZooKeeper \ zookeeper-3.4.9 und am Ende der Systemvariablen Path den Eintrag :;% ZOOKEEPER_HOME % \ Behälter; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie die Befehlszeile aus und schreiben Sie den Befehl:</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Wenn alles richtig gemacht ist, sehen Sie ungefähr Folgendes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet, dass ZooKeeper normal gestartet wurde. Wir fahren direkt mit der Installation und Konfiguration des Apache Kafka-Servers fort. Laden Sie die neueste Version von der offiziellen Website herunter und extrahieren Sie den Inhalt des Archivs: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kafka.apache.org/downloads</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Im Ordner mit Kafka finden wir den Konfigurationsordner, darin finden wir die Datei server.properties und öffnen sie. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir finden die Zeile log.dirs = / tmp / kafka-logs und geben darin den Pfad an, in dem Kafka die Protokolle speichert: log.dirs = c: / kafka / kafka-logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten Sie im selben Ordner die Datei zookeeper.properties. Wir ändern die Zeile dataDir = / tmp / zookeeper in dataDir = c: / kafka / zookeeper-data, ohne zu vergessen, den Pfad zu Ihrem Kafka-Ordner nach dem Datenträgernamen anzugeben. Wenn Sie alles richtig gemacht haben, können Sie ZooKeeper und Kafka ausführen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für einige mag es eine unangenehme Überraschung sein, dass es keine grafische Benutzeroberfläche gibt, mit der Kafka gesteuert werden kann. </font><font style="vertical-align: inherit;">Vielleicht liegt dies daran, dass der Dienst für harte Nerds konzipiert ist, die ausschließlich mit der Konsole arbeiten. </font><font style="vertical-align: inherit;">Auf die eine oder andere Weise benötigen wir eine Befehlszeile, um Kafka auszuführen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst müssen Sie ZooKeeper starten. </font><font style="vertical-align: inherit;">In dem Ordner mit der kafka finden wir den Ordner bin / windows, darin finden wir die Datei zum Starten des Dienstes zookeeper-server-start.bat, klicken Sie darauf. </font><font style="vertical-align: inherit;">Es passiert nichts? </font><font style="vertical-align: inherit;">Es sollte so sein. </font><font style="vertical-align: inherit;">Öffnen Sie die Konsole in diesem Ordner und schreiben Sie:</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Funktioniert nicht wieder </font><font style="vertical-align: inherit;">Das ist die Norm. </font><font style="vertical-align: inherit;">Dies liegt daran, dass zookeeper-server-start.bat die in der Datei zookeeper.properties angegebenen Parameter benötigt, die sich, wie wir uns erinnern, für ihre Arbeit im Konfigurationsordner befindet. </font><font style="vertical-align: inherit;">Wir schreiben an die Konsole:</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt sollte alles normal beginnen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Öffnen Sie erneut die Konsole in diesem Ordner (schließen Sie ZooKeeper nicht!) Und führen Sie kafka aus:</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um nicht jedes Mal Befehle in die Befehlszeile zu schreiben, können Sie die alte bewährte Methode verwenden und eine Batchdatei mit den folgenden Inhalten erstellen:</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Timeout 10-Zeile wird benötigt, um eine Pause zwischen dem Starten von zookeeper und kafka festzulegen. </font><font style="vertical-align: inherit;">Wenn Sie alles richtig gemacht haben, sollten beim Klicken auf die Batch-Datei zwei Konsolen mit zookeeper und kafka geöffnet werden. Jetzt können wir einen Nachrichtenproduzenten und einen Konsumenten mit den erforderlichen Parametern direkt über die Befehlszeile erstellen. </font><font style="vertical-align: inherit;">In der Praxis kann dies jedoch erforderlich sein, es sei denn, Sie testen den Dienst. </font><font style="vertical-align: inherit;">Wir werden uns viel mehr dafür interessieren, wie man mit Kafka von IDEA arbeitet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeite mit Kafka von IDEA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden die einfachste mögliche Anwendung schreiben, die gleichzeitig Produzent und Konsument der Nachricht ist, und dann nützliche Funktionen hinzufügen. </font><font style="vertical-align: inherit;">Erstellen Sie ein neues Frühlingsprojekt. </font><font style="vertical-align: inherit;">Dies geschieht am bequemsten mit einem Federinitialisierer. </font><font style="vertical-align: inherit;">Fügen Sie die Abhängigkeiten org.springframework.kafka und spring-boot-startup-web hinzu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher sollte die Datei pom.xml folgendermaßen aussehen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Senden von Nachrichten benötigen wir das Objekt KafkaTemplate &lt;K, V&gt;. </font><font style="vertical-align: inherit;">Wie wir sehen, ist das Objekt getippt. </font><font style="vertical-align: inherit;">Der erste Parameter ist der Schlüsseltyp, der zweite ist die Nachricht selbst. </font><font style="vertical-align: inherit;">Im Moment werden wir beide Parameter als String angeben. </font><font style="vertical-align: inherit;">Wir werden das Objekt im Klassencontroller erstellen. </font><font style="vertical-align: inherit;">Deklarieren Sie KafkaTemplate und bitten Sie Spring, es durch Annotieren zu initialisieren</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autowired</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grundsätzlich ist unser Produzent bereit. Sie müssen nur noch die send () -Methode aufrufen. Es gibt mehrere überladene Versionen dieser Methode. Wir verwenden in unserem Projekt eine Option mit 3 Parametern - send (String-Thema, K-Taste, V-Daten). Da KafkaTemplate von String eingegeben wird, sind der Schlüssel und die Daten in der send-Methode eine Zeichenfolge. Der erste Parameter gibt das Thema an, dh das Thema, an das Nachrichten gesendet werden und das Verbraucher abonnieren können, um sie zu empfangen. Wenn das in der Sendemethode angegebene Thema nicht vorhanden ist, wird es automatisch erstellt. Der vollständige Klassentext sieht so aus.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Controller ordnet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost zu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / msg, der Schlüssel und die Nachricht selbst werden im Anforderungshauptteil übertragen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Absender der Nachricht ist bereit. Erstellen Sie jetzt einen Listener. </font><font style="vertical-align: inherit;">Mit Spring können Sie dies auch ohne großen Aufwand tun. </font><font style="vertical-align: inherit;">Es reicht aus, eine Methode zu erstellen und sie mit der Annotation @KafkaListener zu markieren, in deren Parametern Sie nur das Thema angeben können, das angehört werden soll. </font><font style="vertical-align: inherit;">In unserem Fall sieht es so aus.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die mit Anmerkungen gekennzeichnete Methode selbst kann einen akzeptierten Parameter angeben, der den vom Produzenten übertragenen Nachrichtentyp enthält. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Klasse, in der der Consumer erstellt wird, muss mit der Annotation @EnableKafka gekennzeichnet sein.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Außerdem müssen Sie in der Einstellungsdatei application.property den Concierge-Parameter groupe-id angeben. </font><font style="vertical-align: inherit;">Andernfalls wird die Anwendung nicht gestartet. </font><font style="vertical-align: inherit;">Der Parameter ist vom Typ String und kann beliebig sein.</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser einfachstes Kafka-Projekt ist fertig. </font><font style="vertical-align: inherit;">Wir haben einen Absender und einen Empfänger von Nachrichten. </font><font style="vertical-align: inherit;">Es bleibt nur zu laufen. </font><font style="vertical-align: inherit;">Starten Sie zuerst ZooKeeper und Kafka mit der zuvor geschriebenen Batch-Datei und starten Sie dann unsere Anwendung. </font><font style="vertical-align: inherit;">Am bequemsten ist es, eine Anfrage mit Postman zu senden. </font><font style="vertical-align: inherit;">Vergessen Sie nicht, im Hauptteil der Anforderung die Parameter msgId und msg anzugeben. </font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir ein solches Bild in IDEA sehen, funktioniert alles: Der Produzent hat eine Nachricht gesendet, der Verbraucher hat sie empfangen und auf der Konsole angezeigt.</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erschweren das Projekt</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echte Projekte mit Kafka sind sicherlich komplizierter als die, die wir erstellt haben. Nachdem wir die Grundfunktionen des Dienstes herausgefunden haben, überlegen Sie, welche zusätzlichen Funktionen er bietet. Zunächst werden wir den Produzenten verbessern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie die send () -Methode geöffnet haben, stellen Sie möglicherweise fest, dass alle Varianten den Rückgabewert ListenableFuture &lt;SendResult &lt;K, V &gt;&gt; haben. Jetzt werden wir die Funktionen dieser Schnittstelle nicht im Detail betrachten. Hier genügt es zu sagen, dass es erforderlich ist, das Ergebnis des Sendens einer Nachricht anzuzeigen.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die addCallback () -Methode akzeptiert zwei Parameter - SuccessCallback und FailureCallback. </font><font style="vertical-align: inherit;">Beide sind funktionale Schnittstellen. </font><font style="vertical-align: inherit;">Anhand des Namens können Sie erkennen, dass die Methode der ersten als Ergebnis eines erfolgreichen Sendens der Nachricht aufgerufen wird, die zweite als Ergebnis eines Fehlers. Wenn wir nun das Projekt ausführen, wird auf der Konsole Folgendes angezeigt:</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns unseren Produzenten noch einmal genau an. </font><font style="vertical-align: inherit;">Interessanterweise, was passiert, wenn der Schlüssel nicht String ist, sondern beispielsweise Long, aber als übertragene Nachricht noch schlimmer - eine Art kompliziertes DTO? </font><font style="vertical-align: inherit;">Versuchen </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
wir zunächst, </font><font style="vertical-align: inherit;">den Schlüssel in einen numerischen Wert zu ändern ... </font><font style="vertical-align: inherit;">Wenn wir Long als Schlüssel im Produzenten angeben, wird die Anwendung normal gestartet. Wenn Sie jedoch versuchen, eine Nachricht zu senden, wird eine ClassCastException ausgelöst und es wird gemeldet, dass die Long-Klasse nicht in die String-Klasse umgewandelt werden kann.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir versuchen, das KafkaTemplate-Objekt manuell zu erstellen, wird das Schnittstellenobjekt ProducerFactory &lt;K, V&gt;, z. B. DefaultKafkaProducerFactory &lt;&gt;, als Parameter an den Konstruktor übergeben. Um eine DefaultKafkaProducerFactory zu erstellen, müssen wir eine Map mit ihren Produzenteneinstellungen an ihren Konstruktor übergeben. Der gesamte Code für die Konfiguration und Erstellung des Produzenten wird in eine separate Klasse eingeordnet. Erstellen Sie dazu das Konfigurationspaket und darin die KafkaProducerConfig-Klasse.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie in der ProducerConfigs () -Methode eine Map mit den Konfigurationen und geben Sie LongSerializer.class als Serializer für den Schlüssel an. </font><font style="vertical-align: inherit;">Wir starten, senden eine Anfrage von Postman und sehen, dass jetzt alles so funktioniert, wie es sollte: Der Produzent sendet eine Nachricht und der Verbraucher empfängt sie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ändern wir nun den Typ des übertragenen Werts. </font><font style="vertical-align: inherit;">Was ist, wenn wir keine Standardklasse aus der Java-Bibliothek haben, sondern eine Art benutzerdefiniertes DTO? </font><font style="vertical-align: inherit;">Sagen wir das.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um DTO als Nachricht zu senden, müssen Sie einige Änderungen an der Herstellerkonfiguration vornehmen. </font><font style="vertical-align: inherit;">Geben Sie JsonSerializer.class als Serializer des Nachrichtenwerts an und vergessen Sie nicht, den String-Typ überall in UserDto zu ändern.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine Nachricht schicken. Die folgende Zeile wird in der Konsole angezeigt: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt werden wir den Verbraucher komplizieren. Zuvor hat unsere Methode public void msgListener (String msg), die mit der Anmerkung @KafkaListener (topic = "msg") gekennzeichnet ist, String als Parameter verwendet und auf der Konsole angezeigt. Was ist, wenn wir andere Parameter der übertragenen Nachricht erhalten möchten, beispielsweise einen Schlüssel oder eine Partition? In diesem Fall muss der Typ des übertragenen Wertes geändert werden.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Über das ConsumerRecord-Objekt können wir alle Parameter abrufen, die uns interessieren. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen, dass anstelle des Schlüssels auf der Konsole eine Art Krakozyabry angezeigt wird. Dies liegt daran, dass der StringDeserializer standardmäßig zum Deserialisieren des Schlüssels verwendet wird. Wenn der Schlüssel im Ganzzahlformat korrekt angezeigt werden soll, müssen wir ihn in LongDeserializer ändern. Erstellen Sie die KafkaConsumerConfig-Klasse, um den Consumer im Konfigurationspaket zu konfigurieren.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die KafkaConsumerConfig-Klasse ist der zuvor erstellten KafkaProducerConfig sehr ähnlich. Es gibt auch eine Map, die die erforderlichen Konfigurationen enthält, z. B. einen Deserializer für den Schlüssel und den Wert. Die erstellte Map wird zum Erstellen der ConsumerFactory &lt;&gt; verwendet, die wiederum zum Erstellen der KafkaListenerContainerFactory &lt;?&gt; Erforderlich ist. Ein wichtiges Detail: Die Methode, die KafkaListenerContainerFactory &lt;?&gt; Zurückgibt, sollte kafkaListenerContainerFactory () heißen, da Spring sonst die gewünschte Bean nicht finden kann und das Projekt nicht kompiliert wird. Wir starten.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen, dass jetzt der Schlüssel so angezeigt wird, wie er sollte, was bedeutet, dass alles funktioniert. </font><font style="vertical-align: inherit;">Natürlich gehen die Funktionen von Apache Kafka weit über die in diesem Artikel beschriebenen hinaus. Ich hoffe jedoch, dass Sie nach dem Lesen eine Vorstellung von diesem Service bekommen und vor allem damit beginnen können, damit zu arbeiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Waschen Sie Ihre Hände häufiger, tragen Sie Masken, gehen Sie nicht ohne Notwendigkeit nach draußen und seien Sie gesund.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496170/index.html">Wir sind zum Scheitern verurteilt # 1 // Udalenka in der Krise und im Tod der Originalität</a></li>
<li><a href="../de496174/index.html">Die gestiegene Nachfrage nach Analysen, Produktteams, Amazon, Israel, Singapur, Remote-Arbeit usw. wurde viel diskutiert.</a></li>
<li><a href="../de496176/index.html">Große virtuelle Konferenz: Erfahrungen aus der Praxis beim Schutz von Daten vor modernen digitalen Unternehmen</a></li>
<li><a href="../de496178/index.html">Swift 5.2. Übersicht aller Änderungen</a></li>
<li><a href="../de496180/index.html">Pass auf den Schatten der Jugend auf</a></li>
<li><a href="../de496184/index.html">LED-Anzeigetechnologie: Micro-LED vs. Mini LED</a></li>
<li><a href="../de496188/index.html">Wie man aufhört, Fernsehsendungen zu schauen und anfängt zu leben</a></li>
<li><a href="../de496190/index.html">Über Phrasal Verbs-2</a></li>
<li><a href="../de496192/index.html">Rust-Funktionen von Go aus aufrufen</a></li>
<li><a href="../de496194/index.html">Zur Binarisierung feinstrukturierter tomographischer Bilder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>