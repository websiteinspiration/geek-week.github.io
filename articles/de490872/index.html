<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ∞Ô∏è üë®‚Äçüíª ü¶ç Trio - Asynchrone Programmierung f√ºr Menschen üèõÔ∏è ‚ôäÔ∏è üíÜüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Python hat eine Trio- Bibliothek - eine asynchrone Programmierbibliothek. 
 Das Kennenlernen von Trio ist vor allem f√ºr diejenigen interessant, die an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trio - Asynchrone Programmierung f√ºr Menschen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/barsgroup/blog/490872/"><img src="https://habrastorage.org/webt/m7/0o/ye/m70oyejwkcwdk32csx1mq2wprao.jpeg" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python hat eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek - eine asynchrone Programmierbibliothek. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Kennenlernen von Trio ist vor allem f√ºr diejenigen interessant, die an Asyncio arbeiten, da es eine gute Alternative ist, mit der Sie einige der Probleme l√∂sen k√∂nnen, die Asyncio nicht l√∂sen kann. </font><font style="vertical-align: inherit;">In diesem Test werden wir uns √ºberlegen, was Trio ist und welche Funktionen es uns bietet.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr diejenigen, die gerade erst mit der Arbeit in der asynchronen Programmierung beginnen, schlage ich vor, eine kleine Einf√ºhrung zu Asynchronit√§t und Synchronit√§t zu lesen. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronit√§t und Asynchronit√§t </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">synchronen Programmierung werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alle Vorg√§nge nacheinander ausgef√ºhrt, und Sie k√∂nnen eine neue Aufgabe erst starten, nachdem Sie die vorherige abgeschlossen haben. </font><font style="vertical-align: inherit;">Einer der ‚ÄûSchmerzpunkte‚Äú ist jedoch, dass das gesamte Programm einfrieren kann, wenn einer der Threads sehr lange an einer Aufgabe gearbeitet hat. </font><font style="vertical-align: inherit;">Es gibt Aufgaben, die keine Rechenleistung erfordern, aber Prozessorzeit in Anspruch nehmen. Diese k√∂nnen rationaler verwendet werden, indem einem anderen Thread die Kontrolle √ºbertragen wird. </font><font style="vertical-align: inherit;">Bei der synchronen Programmierung gibt es keine M√∂glichkeit, die aktuelle Aufgabe anzuhalten, um Folgendes in ihrer L√ºcke zu vervollst√§ndigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wof√ºr ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchronit√§t?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Es muss zwischen echter Asynchronit√§t und Eingabe-Ausgabe-Asynchronit√§t unterschieden werden. In unserem Fall handelt es sich um eine asynchrone Eingabe / Ausgabe. Weltweit - um Zeit zu sparen und Produktionsanlagen effizienter zu nutzen. Mit Asynchronit√§t k√∂nnen Sie die Problembereiche von Threads umgehen. Bei asynchroner Eingabe / Ausgabe wartet der aktuelle Thread nicht auf die Ausf√ºhrung eines externen Ereignisses, sondern gibt einem anderen Thread die Kontrolle. Somit wird tats√§chlich immer nur ein Thread gleichzeitig ausgef√ºhrt. Der Thread, der die Kontrolle gegeben hat, wird in die Warteschlange gestellt und wartet darauf, dass die Kontrolle zu ihr zur√ºckkehrt. M√∂glicherweise tritt zu diesem Zeitpunkt das erwartete externe Ereignis ein und es ist m√∂glich, weiter zu arbeiten. Auf diese Weise k√∂nnen Sie zwischen Aufgaben wechseln, um Zeitverschwendung zu minimieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt k√∂nnen wir zu dem zur√ºckkehren, was ist</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Der Betrieb dieser Bibliothek </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ereignisschleife</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Ereignisschleife), die die Aufgabenwarteschlange und die Schleife selbst enth√§lt. Der Zyklus steuert die Ausf√ºhrung von Aufgaben, dh er zieht Aufgaben aus der Warteschlange und bestimmt, was damit geschehen wird. Beispielsweise werden m√∂glicherweise E / A-Aufgaben verarbeitet. Das hei√üt, die Ereignisschleife w√§hlt die Aufgabe aus, registriert sich und beginnt zum richtigen Zeitpunkt mit ihrer Verarbeitung. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutinen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sind spezielle Funktionen, die die Steuerung dieser Aufgabe an die Ereignisschleife zur√ºckgeben, </font><b><font style="vertical-align: inherit;">dh</font></b><font style="vertical-align: inherit;"> an die Warteschlange zur√ºckgeben. Es ist notwendig, dass diese Coroutinen genau durch eine Reihe von Ereignissen gestartet werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt auch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Futures</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Objekte, in denen das aktuelle Ergebnis der Ausf√ºhrung einer Aufgabe gespeichert ist. </font><font style="vertical-align: inherit;">Dies kann eine Information sein, dass die Aufgabe noch nicht verarbeitet wurde oder das Ergebnis bereits erhalten wurde. </font><font style="vertical-align: inherit;">oder es kann eine Ausnahme geben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen ist die Asyncio-Bibliothek bekannt, weist jedoch eine Reihe von Nachteilen auf, die Trio schlie√üen kann.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laut dem Autor der Bibliothek, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nathaniel Smith</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , wollte er bei der Entwicklung von Trio ein leichtes und einfach zu verwendendes Tool f√ºr den Entwickler entwickeln, das die einfachste asynchrone Eingabe / Ausgabe und Fehlerbehandlung bietet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein wichtiges Merkmal von Trio ist das asynchrone Kontextmanagement, √ºber das Asyncio nicht verf√ºgt. </font><font style="vertical-align: inherit;">Zu diesem Zweck schuf der Autor im Trio den sogenannten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Kindergarten"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Kindergarten) - ein Bereich der L√∂schung, der die Verantwortung f√ºr die Atomizit√§t (Kontinuit√§t) einer Gruppe von F√§den √ºbernimmt. Die Schl√ºsselidee ist, dass wenn im ‚ÄûKindergarten‚Äú eine der Coroutinen ausf√§llt, alle Abl√§ufe im ‚ÄûKindergarten‚Äú entweder erfolgreich abgeschlossen oder abgebrochen werden. In jedem Fall ist das Ergebnis korrekt. Und erst wenn alle Coroutinen abgeschlossen sind, entscheidet der Entwickler nach dem Beenden der Funktion selbst, wie er vorgehen soll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das hei√üt, mit "Kinder" k√∂nnen Sie die Fortsetzung der Fehlerverarbeitung verhindern, was dazu f√ºhren kann, dass entweder alles "f√§llt" oder das Ergebnis ein falsches Ergebnis ist.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Genau dies kann mit Asyncio passieren, da in Asyncio der Prozess trotz der Tatsache, dass ein Fehler aufgetreten ist, nicht gestoppt wird. </font><font style="vertical-align: inherit;">In diesem Fall wei√ü der Entwickler erstens nicht, was genau zum Zeitpunkt des Fehlers passiert ist, und zweitens wird die Verarbeitung fortgesetzt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiele </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Betrachten Sie das einfachste Beispiel f√ºr zwei konkurrierende Funktionen: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
loop = asyncio.get_event_loop()<font></font>
bundle = asyncio.wait([<font></font>
    loop.create_task(foo1()),<font></font>
    loop.create_task(foo2()),<font></font>
])<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    loop.run_until_complete(bundle)<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    loop.close()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:<font></font>
        nursery.start_soon(foo1)<font></font>
        nursery.start_soon(foo2)<font></font>
<font></font>
trio.run(root)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In beiden F√§llen ist das Ergebnis dasselbe:</font></font><br>
<br>
<pre><code class="python hljs">foo1: <font></font>
foo2: <font></font>
foo2: <font></font>
foo1: </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Strukturell ist der Asyncio und Trio Code in diesem Beispiel √§hnlich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der offensichtliche Unterschied besteht darin, dass Trio nicht die explizite Vervollst√§ndigung der Ereignisschleife erfordert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Betrachten Sie ein etwas lebhafteres Beispiel. </font><font style="vertical-align: inherit;">Rufen wir den Webdienst an, um einen Zeitstempel zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr Asyncio verwenden wir zus√§tzlich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session, i))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS)<font></font>
        ]<font></font>
        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr Trio verwenden wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fragt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
            nursery.start_soon(foo, i)<font></font>
<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
trio.run(root)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In beiden F√§llen bekommen wir so etwas wie</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">0</span> | <span class="hljs-number">1543837647522</span> (  <span class="hljs-number">0.11855053901672363</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543837647535</span> (  <span class="hljs-number">0.1389765739440918</span>)
<span class="hljs-number">3</span> | <span class="hljs-number">1543837647527</span> (  <span class="hljs-number">0.13904547691345215</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543837647557</span> (  <span class="hljs-number">0.1591191291809082</span>)
<span class="hljs-number">1</span> | <span class="hljs-number">1543837647607</span> (  <span class="hljs-number">0.2100353240966797</span>)<font></font>
  <span class="hljs-number">0.2102828025817871</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gut. </font><font style="vertical-align: inherit;">Stellen Sie sich vor, w√§hrend der Ausf√ºhrung einer der Coroutinen ist ein Fehler </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
f√ºr Asyncio </font><font style="vertical-align: inherit;">aufgetreten </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-number">1</span> | <span class="hljs-number">1543839060815</span> (  <span class="hljs-number">0.10857725143432617</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839060844</span> (  <span class="hljs-number">0.10372781753540039</span>)
<span class="hljs-number">5</span> | <span class="hljs-number">1543839060843</span> (  <span class="hljs-number">0.10734415054321289</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543839060874</span> (  <span class="hljs-number">0.13985681533813477</span>)<font></font>
  <span class="hljs-number">0.15044045448303223</span><font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
f√ºr Trio</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-number">4</span> | <span class="hljs-number">1543839223372</span> (  <span class="hljs-number">0.13524699211120605</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839223379</span> (  <span class="hljs-number">0.13848185539245605</span>)<font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">28</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<font></font>
    trio.run(root)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">1337</span>, <span class="hljs-keyword">in</span> run
    <span class="hljs-keyword">raise</span> runner.main_task_outcome.error<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">23</span>, <span class="hljs-keyword">in</span> root<font></font>
    nursery.start_soon(foo, i)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">397</span>, <span class="hljs-keyword">in</span> __aexit__
    <span class="hljs-keyword">raise</span> combined_error_from_nursery<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">15</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist deutlich zu sehen, dass in Trio unmittelbar nach dem Auftreten des Fehlers der "Abbruchbereich" funktionierte und zwei der vier Aufgaben, die keine Fehler enthielten, abnormal beendet wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Asyncio wurden alle Aufgaben abgeschlossen, und erst dann wurde der Trackback angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im gegebenen Beispiel ist dies nicht wichtig, aber stellen wir uns vor, dass die Aufgaben auf die eine oder andere Weise voneinander abh√§ngen und die Aufgaben die Eigenschaft der Atomizit√§t haben m√ºssen. In diesem Fall wird die rechtzeitige Reaktion auf einen Fehler viel wichtiger. Nat√ºrlich k√∂nnen Sie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await asyncio.wait (Aufgaben, return_when = FIRST_EXCEPTION) verwenden</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber Sie m√ºssen daran denken, ge√∂ffnete Aufgaben korrekt abzuschlie√üen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein weiteres Beispiel: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, Coroutinen greifen gleichzeitig auf mehrere √§hnliche Webdienste zu, und die erste empfangene Antwort ist wichtig.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> FIRST_COMPLETED
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()
        <span class="hljs-keyword">return</span> content.get(<span class="hljs-string">"time"</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, MAX_CLIENTS + <span class="hljs-number">1</span>)<font></font>
        ]<font></font>
        done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=FIRST_COMPLETED)<font></font>
        print(done.pop().result())<font></font>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> pending:<font></font>
            future.cancel()<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">except</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles ist ziemlich einfach. </font><font style="vertical-align: inherit;">Die einzige Voraussetzung ist, sich daran zu erinnern, Aufgaben zu erledigen, die noch nicht erledigt wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Trio ist es etwas schwieriger, ein √§hnliches Man√∂ver zu starten, aber es ist fast unm√∂glich, die ‚ÄûSchw√§nze‚Äú sofort unsichtbar zu lassen:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, send_channel, nursery</span>):</span>
    response = <span class="hljs-keyword">await</span> session.request(<span class="hljs-string">'GET'</span>, url=URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel:<font></font>
        send_channel.send_nowait(content.get(<span class="hljs-string">"time"</span>))<font></font>
    nursery.cancel_scope.cancel()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    send_channel, receive_channel = trio.open_memory_channel(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel, receive_channel:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asks.Session() <span class="hljs-keyword">as</span> session:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
                    nursery.start_soon(foo, session, send_channel.clone(), nursery)<font></font>
<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receive_channel:<font></font>
            x = <span class="hljs-keyword">await</span> receive_channel.receive()<font></font>
            print(x)<font></font>
<font></font>
trio.run(root)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nursery.cancel_scope.cancel ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Die erste abgeschlossene Coroutine ruft eine Funktion im R√ºckg√§ngig-Bereich auf, die alle anderen Aufgaben abbricht, sodass Sie sich nicht separat darum k√ºmmern m√ºssen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Richtig, um das Ergebnis der Coroutine-Ausf√ºhrung auf die Funktion zu √ºbertragen, die es verursacht hat, m√ºssen Sie einen Kommunikationskanal initiieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoffentlich hat diese vergleichende √úberpr√ºfung ein Verst√§ndnis der Hauptmerkmale von Trio geliefert. </font><font style="vertical-align: inherit;">Danke an alle!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de490850/index.html">Helfen Sie dem Compiler, Ihnen zu helfen</a></li>
<li><a href="../de490852/index.html">–ü–æ–¥—Ä–æ–±–Ω–æ –æ SpinLaunch ‚Äî —Å–∞–º–æ–º —Ä–µ–≤–Ω–æ—Å—Ç–Ω–æ —Ö—Ä–∞–Ω–∏–º–æ–º —Å–µ–∫—Ä–µ—Ç–µ –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –∏–Ω–¥—É—Å—Ç—Ä–∏–∏</a></li>
<li><a href="../de490854/index.html">Lagerroboter, die KI zum Sortieren von Artikeln verwenden, sind einsatzbereit</a></li>
<li><a href="../de490856/index.html">Auto Dungeon Master</a></li>
<li><a href="../de490862/index.html">LetsEncrypt plant, seine Zertifikate aufgrund eines Softwarefehlers zu widerrufen</a></li>
<li><a href="../de490874/index.html">Absichtliche Implementierung von Remote-Arbeit: So verdoppeln Sie Ihre Ergebnisse, ohne jemanden einzustellen</a></li>
<li><a href="../de490876/index.html">Warum brennen wir aus?</a></li>
<li><a href="../de490878/index.html">Nichtlineare Differentialgleichungen, Diskretion von Raum-Zeit und Epsilon-Produkt</a></li>
<li><a href="../de490882/index.html">Beheben Sie Probleme unter Docker. Es scheint, was hat GIT damit zu tun?</a></li>
<li><a href="../de490884/index.html">DEFCON-Konferenz 27. Ihr Auto ist mein Auto. Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>