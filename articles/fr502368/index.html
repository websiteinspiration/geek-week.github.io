<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïõ ‚úçüèæ ‚¨õÔ∏è Nous pompons le tapis roulant üçÇ üëàüèΩ üôÜüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="R√©cemment, j'ai d√©cid√© d'un achat tr√®s √©trange pour moi. Oui, j'ai achet√© un tapis roulant. 
 
 
 
 Et bient√¥t, je me suis rendu compte qu'il n'y avai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous pompons le tapis roulant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©cemment, j'ai d√©cid√© d'un achat tr√®s √©trange pour moi. </font><font style="vertical-align: inherit;">Oui, j'ai achet√© un tapis roulant. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bient√¥t, je me suis rendu compte qu'il n'y avait pas assez de statistiques d√©taill√©es comme lorsque je faisais du v√©lo. </font><font style="vertical-align: inherit;">Dans le cas d'un v√©lo, l'application sur le t√©l√©phone √©crit ma vitesse, ma fr√©quence cardiaque, ma cadence et mon portance. </font><font style="vertical-align: inherit;">Il est tr√®s curieux de contr√¥ler tous ces param√®tres pendant l'entra√Ænement, pour pouvoir consulter les graphiques et comparer de temps en temps vos r√©sultats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc d√©cid√© de faire quelque chose de similaire avec le tapis roulant: le connecter √† un smartphone ou une tablette afin de collecter et d'afficher des statistiques.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme d'habitude, mon histoire se pr√©sente sous la forme d'un article texte traditionnel, et par vid√©o. </font><font style="vertical-align: inherit;">Comme vous en voulez plus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vid√©o</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Article</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conception</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√™me au moment o√π je r√©cup√©rais le tapis roulant, j'ai remarqu√© que la t√©l√©commande et la courroie elle-m√™me ne connectaient que quatre fils. Apparemment, certains d'entre eux sont utilis√©s pour alimenter la console, car la toile elle-m√™me est connect√©e au r√©seau 220 volts, et les fils restants sont n√©cessaires pour transmettre des signaux de contr√¥le dans la direction oppos√©e - de la console √† la toile, ils contr√¥lent la vitesse et l'angle de la piste. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai connect√© l'oscilloscope en parall√®le √† ces fils, en essayant diff√©rentes combinaisons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, j'ai d√©couvert que tout √©tait √† peu pr√®s le m√™me que ce √† quoi je m'attendais. L'un des fils est mis √† la terre et un autre est de 12 volts. Les autres transmettent des donn√©es num√©riques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'un d'eux, le signal change lors du changement de vitesse et d'angle. </font><font style="vertical-align: inherit;">C'est exactement ce dont j'ai besoin! </font><font style="vertical-align: inherit;">L'amplitude du signal est d'environ quatre volts. </font><font style="vertical-align: inherit;">Mais le protocole ne ressemble pas √† quelque chose de standard, et le signal est tr√®s bruyant, lorsque la piste est activ√©e, vous devez le filtrer d'une mani√®re ou d'une autre. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dernier fil n'est que des impulsions √† fr√©quence constante. </font><font style="vertical-align: inherit;">Apparemment, pour que la console puisse voir la connexion √† la ceinture de course. </font><font style="vertical-align: inherit;">Si vous d√©connectez ce fil, la t√©l√©commande donne imm√©diatement une erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les indications du capteur d'impulsions sur ces fils ne sont clairement pas transmises, mais ce n'est pas n√©cessaire. </font><font style="vertical-align: inherit;">Il est pr√©f√©rable de connecter un capteur thoracique s√©par√©, que j'utilise depuis longtemps lorsque je fais du v√©lo. </font><font style="vertical-align: inherit;">De plus, il s'est av√©r√© que le capteur de fr√©quence cardiaque sur le tapis roulant lui-m√™me ment beaucoup, sous-estimant les lectures.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblage de l'appareil</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la t√¢che suivante consiste √† assembler une carte qui se connecte en parall√®le √† ces fils, lit la vitesse et l'angle actuels, et les transf√®re en quelque sorte sans fil vers une tablette ou un smartphone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois de plus, j'ai d√©cid√© d'utiliser l'ordinateur monocarte Onion Omega2. Il doit faire un excellent travail. Il suffit de baisser la tension d'alimentation √† 3,3 volts et de filtrer les donn√©es des interf√©rences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©duire la tension, j'utilise maintenant ces cartes pr√™tes √† l'emploi avec un convertisseur DC-DC. Ils co√ªtent un sou, peuvent supporter jusqu'√† quelques amp√®res et la tension de sortie est ajust√©e avec une torsion. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En m√™me temps, cette carte a des conclusions √† souder directement sur une autre carte, c'est tr√®s pratique. L'essentiel est de ne pas tordre la torsion de tension apr√®s l'installation dans le circuit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour filtrer le bruit sur la ligne de donn√©es, j'ai fabriqu√© un filtre RC ordinaire: une r√©sistance de 2,2 kilo-ohms et un condensateur de 22 picofarad. </font><font style="vertical-align: inherit;">Cela devrait filtrer le bruit haute fr√©quence, laissant un signal basse fr√©quence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est av√©r√© √™tre une petite √©charpe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je l'ai connect√© aux fils du tapis roulant pour voir √† quel point le signal est filtr√© lorsqu'il est allum√© et, apparemment, la forme d'onde est devenue presque parfaite.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module noyau</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il n'est pas si facile de v√©rifier les performances du fer. Comme nous l'avons vu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plus t√¥t sur l'oscilloscope, les signaux vont tr√®s vite, et nous n'utilisons pas de microcontr√¥leur, mais un ordinateur Omega2 mono-carte avec Linux embarqu√©. Sous Linux, nous ne pourrons pas traiter les signaux de l'espace utilisateur aussi rapidement. Mais du c≈ìur, nous pouvons! Il est donc temps d'√©crire un module du noyau Linux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, vous devez t√©l√©charger les sources du noyau Linux, dans notre cas, il s'agit d'un assemblage OpenWRT pour Omega2, et cr√©er un r√©pertoire contenant le code source de notre module.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©criture de code de module ressemble beaucoup √† la programmation d'un microcontr√¥leur. Nous √©crivons √©galement en C, tout est √©galement de bas niveau, nous travaillons √©galement avec des interruptions et nous nous tournons √©galement vers les conclusions GPIO. Seulement ici, en plus de tout ce qui pr√©c√®de, nous interagissons toujours avec l'espace utilisateur via un pseudo-fichier. Ainsi, notre module noyau devient une sorte d'adaptateur entre le mat√©riel et les applications ordinaires. En fait, cela s'appelle le pilote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au d√©but, je ne savais pas comment d√©coder les signaux, j'ai donc simplement d√©duit leur dur√©e. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est vite devenu clair que les signaux √©taient cod√©s avec une dur√©e de haut niveau. Elle est longue de 600 microsecondes ou de 1200 microsecondes. Le niveau bas est toujours de 600 microsecondes √† l'exception de la s√©quence initiale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un total de 17 de ces gouttes de haut en bas. </font><font style="vertical-align: inherit;">Apparemment, il s'agit de 16 bits de donn√©es plus la s√©quence initiale. </font><font style="vertical-align: inherit;">J'ai fait leur d√©codage, en prenant comme base que les longues diff√©rences √©lev√©es sont un z√©ro logique, et les courtes sont une unit√© logique et j'ai compris ce qui s'est pass√©. </font><font style="vertical-align: inherit;">J'ai imm√©diatement vu les donn√©es dont j'avais besoin! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, 16 bits sont deux octets. </font><font style="vertical-align: inherit;">Le premier octet indique le type de donn√©es transmises: l'angle d'inclinaison ou de vitesse, et le deuxi√®me octet les donn√©es elles-m√™mes. </font><font style="vertical-align: inherit;">Le pilote est extr√™mement simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le seul param√®tre de pilote est le num√©ro de port.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'initialisation, configurez-le pour l'entr√©e et d√©finissez l'interruption, qui sera d√©clench√©e √† chaque changement de niveau.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette interruption, nous regardons d'abord l'heure actuelle. Ensuite, nous utilisons cette valeur pour calculer le temps √©coul√© depuis le d√©clenchement de la derni√®re interruption et la placer dans un tableau. Bien s√ªr, nous nous souvenons de l'heure actuelle pour le calcul la prochaine fois. De plus, vous devez red√©marrer la minuterie sp√©ciale.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'astuce est que si la minuterie fonctionne toujours, cela signifie qu'il n'y a pas eu de baisse de niveau sur la broche pendant une longue p√©riode, et qu'il est donc temps de traiter les informations collect√©es. </font><font style="vertical-align: inherit;">Dans la fonction appel√©e par le temporisateur, il est v√©rifi√© qu'il y a eu exactement 34 gouttes, apr√®s quoi nous regardons la dur√©e de chaque intervalle. </font><font style="vertical-align: inherit;">S'il y a 600 microsecondes, puis 1200 microsecondes, alors nous prenons 900 √† l'√©tranger. Si l'intervalle est inf√©rieur, alors nous √©crivons un dans le r√©sultat, en le d√©calant d'un bit. </font><font style="vertical-align: inherit;">Apr√®s avoir trait√© chaque intervalle, nous envoyons le r√©sultat √† des pseudo-fichiers ouverts, transf√©rant ainsi les donn√©es vers l'espace utilisateur.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur Python et d√©tection de vitesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste ensuite √† √©crire un script Python qui les lira du pseudo-fichier et les enverra sur le r√©seau sous forme de cha√Ænes JSON. Il semblerait que tout soit assez simple. Cependant, si tout est simple avec l'angle d'inclinaison et que la valeur dans le deuxi√®me octet correspond exactement √† l'angle d'inclinaison en pourcentage, alors avec la vitesse tout s'est av√©r√© beaucoup plus d√©routant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une valeur de 9 correspond √† un kilom√®tre par heure et une valeur de 160 correspond √† 18 kilom√®tres par heure. Autrement dit, la d√©pendance des donn√©es √† la vitesse r√©elle n'est pas du tout √©vidente. J'ai √©crit toutes les valeurs manuellement, les ai conduites dans Excel, trac√© et obtenu une courbe tr√®s in√©gale.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a des vitesses lorsque les lectures sur la t√©l√©commande sont diff√©rentes, mais les donn√©es et la vitesse de la piste elle-m√™me restent les m√™mes! Par exemple, 5,2 km / h et 5,3 km / h sont en fait les m√™mes vitesses. Partout tricher. Je me demande quelle vitesse est vraiment l√†? Mesurez-le en quelque sorte, mais laissez-le pour plus tard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hormis ce transfert de perroquets en kilom√®tres par heure, le script s'est av√©r√© extr√™mement simple. Nous lisons les donn√©es du pseudo-fichier Linux, les d√©codons, acceptons les connexions r√©seau et transf√©rons les donn√©es aux clients connect√©s sur le r√©seau sous forme de cha√Æne JSON.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense qu'aucune autorisation et s√©curit√© ne sont n√©cessaires ici. </font><font style="vertical-align: inherit;">L'√©tat du tapis roulant n'est pas le type de donn√©es que je voudrais prot√©ger contre les pirates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons ce script au d√©marrage et retirons la planche √† l'int√©rieur du tapis roulant. </font><font style="vertical-align: inherit;">H√©las, il ne tient que dans un tuyau m√©tallique reliant la console √† la bande de roulement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, le m√©tal prot√®ge le signal radio, j'ai donc sorti l'antenne Wi-Fi du tuyau, mais sous un bo√Ætier en plastique qui cache les fils. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur ce tapis roulant directement ¬´intelligent¬ª est pr√™t. </font><font style="vertical-align: inherit;">Elle sait d√©j√† comment diffuser des statistiques sur le r√©seau. </font><font style="vertical-align: inherit;">Il ne reste plus qu'√† lui √©crire un client!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client Android</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui √† mon avis devrait √™tre un tel client. </font><font style="vertical-align: inherit;">Il s'agit d'une application Android que je vais ex√©cuter sur une tablette ou un smartphone et placer sur le dessus de l'√©cran du tapis roulant lui-m√™me, respectivement, elle devrait afficher toutes les informations sur les exercices sur l'√©cran, en rempla√ßant l'affichage du tapis roulant lui-m√™me. </font><font style="vertical-align: inherit;">L'application devrait pouvoir fonctionner en arri√®re-plan, afin que je puisse regarder la vid√©o sans aucun probl√®me pendant le jogging. </font><font style="vertical-align: inherit;">En outre, il devrait conserver des statistiques d√©taill√©es sur les courses, tout synchroniser avec le nuage et dessiner des graphiques de la d√©pendance de l'impulsion √† la vitesse et √† l'angle d'inclinaison. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le c≈ìur d'une telle application devrait √™tre un service qui s'ex√©cute en arri√®re-plan, se connecte au tapis roulant dans une boucle sans fin, re√ßoit des donn√©es et les d√©code. </font><font style="vertical-align: inherit;">Il n'y a pas de difficult√©s particuli√®res √† cela.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteur de fr√©quence cardiaque</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chose la plus difficile a √©t√© de travailler soudainement avec un capteur de fr√©quence cardiaque. </font><font style="vertical-align: inherit;">De nombreux pi√®ges ont √©t√© d√©couverts. </font><font style="vertical-align: inherit;">J'ai un tel moniteur de fr√©quence cardiaque thoracique ici: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
je l'utilise depuis longtemps quand je fais du v√©lo. </font><font style="vertical-align: inherit;">Il est assez standard, il fonctionne sur BLE √† la Bluetooth Low Enegy, il peut √™tre coupl√© avec un t√©l√©phone et un navigateur Garmin sans aucun probl√®me. </font><font style="vertical-align: inherit;">Je ne pouvais m√™me pas penser que travailler avec lui depuis ma candidature serait si √©vident. </font><font style="vertical-align: inherit;">Ces capteurs ont des GUID standard pour diff√©rentes lectures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer √† recevoir une fr√©quence cardiaque, vous devez d'abord configurer votre moniteur de fr√©quence cardiaque pour envoyer p√©riodiquement des lectures. </font><font style="vertical-align: inherit;">Je ne pouvais le faire qu'en √©tudiant des exemples non fonctionnels et en tapant.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, j'ai √©crit une classe pour travailler avec un √©metteur de fr√©quence cardiaque, qui essaie automatiquement de s'y connecter et rapporte p√©riodiquement la fr√©quence cardiaque actuelle.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quant aux statistiques et aux graphiques. </font><font style="vertical-align: inherit;">J'ai d√©cid√© de ne pas r√©inventer la roue, mais d'utiliser ce que j'utilise d√©j√† quand je fais du v√©lo, √† savoir me lier d'amiti√© avec la merveilleuse application Samsung Health. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, il semblerait que je fasse de nouveau de la publicit√© pour Samsung. </font><font style="vertical-align: inherit;">Mais sur un v√©lo, cette application a vraiment fait ses preuves. </font><font style="vertical-align: inherit;">√Ä ma grande surprise, il se connecte √† tous les capteurs sans probl√®me, affiche √† la fois la cadence et la vitesse des roues, et dicte les statistiques dans les √©couteurs, il affiche les m√™mes statistiques avec des graphiques, donne des r√©alisations et stocke tout dans le cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche a montr√© que Samsung Health poss√®de son propre SDK, qui, bien que pas enti√®rement intelligible, est toujours document√©: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travailler avec, c'est essentiellement travailler avec une base de donn√©es qui stocke une vari√©t√© de lectures, des mesures prises et des mesures de la fr√©quence cardiaque √† la glyc√©mie et aux phases de sommeil. </font><font style="vertical-align: inherit;">Mais maintenant, nous nous int√©ressons aux enregistrements d'exercices, qui incluent √† la fois des valeurs scalaires comme le type d'exercice, le temps, la distance, la dur√©e, les calories br√ªl√©es et des tableaux de donn√©es en direct comme l'historique de la fr√©quence cardiaque, de la vitesse et des coordonn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes ces donn√©es doivent √™tre correctement stock√©es et pr√©par√©es. </font><font style="vertical-align: inherit;">Certains doivent √™tre calcul√©s.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcul de la hauteur</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, la hauteur de levage. </font><font style="vertical-align: inherit;">Depuis le tapis roulant, nous connaissons l'angle de mont√©e √† chaque instant, qui est mesur√© en pourcentage. </font><font style="vertical-align: inherit;">Le pourcentage de l'angle d'√©l√©vation est le rapport de la distance parcourue √† la mont√©e. </font><font style="vertical-align: inherit;">Il s'av√®re que la vitesse verticale est √©gale √† la vitesse habituelle multipli√©e par la pente en pourcentage et divis√©e par cent. </font><font style="vertical-align: inherit;">Connaissant la vitesse verticale, nous pouvons calculer la hauteur actuelle √† chaque instant. </font><font style="vertical-align: inherit;">Par cons√©quent, il doit √™tre entr√© dans les coordonn√©es actuelles, malgr√© le fait que pendant l'exercice, elles ne changent pas et ne sont pas prises en compte. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√©ponse √† ces donn√©es, l'application Samsung Health montrera combien j'ai soi-disant grimp√©, ainsi que la vitesse verticale √† chaque moment de l'entra√Ænement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comptage des calories</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comment compter les calories? De plus, le comptage des calories est un must pour Samsung Health. Dans le m√™me temps, les calories br√ªl√©es sont un indicateur tr√®s inexact, qui d√©pend de nombreux facteurs diff√©rents. Je ne sais pas s'il est logique de les compter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne suis pas venu avec quelque chose de moi et juste google la calculatrice (https://42.195km.net/e/treadsim/) et copi√© l'algorithme de mon javascript (https://42.195km.net/e/treadsim/treadsim107 .js). A l'entr√©e, il prend la distance parcourue, l'angle d'√©l√©vation et ... le poids.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pouvais d√©finir mon poids manuellement, mais puisque nous travaillons avec Samsung Health, je peux prendre mon poids actuel √† partir de l√†. </font><font style="vertical-align: inherit;">Apr√®s tout, j'utilise des balances intelligentes de Xiaomi, qui sont synchronis√©es avec Google Fit sur mon t√©l√©phone, Google FIt via une application distincte est synchronis√© avec Samsung Health, Samsung Health via le cloud est synchronis√© avec lui-m√™me sur la tablette, o√π mon application le re√ßoit d√©j√†.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apparence de l'application</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visuellement, la t√¢che de l'application est d'afficher √† grande √©chelle les principales indications: vitesse, angle, fr√©quence cardiaque, distance, calories. Il est pr√©f√©rable de le faire en blanc sur fond noir afin que la consommation de la batterie lors de l'utilisation de l'√©cran AMOLED soit minimale, car nous indiquons certainement que lors de l'affichage de notre activit√©, l'√©cran doit √™tre allum√© en permanence. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les boutons sont automatiquement masqu√©s lorsque le tapis roulant est actif. Vous pouvez d√©marrer et arr√™ter l'entra√Ænement uniquement √† vitesse nulle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien s√ªr, vous devez prendre en charge le mode ¬´image dans l'image¬ª. Cela se fait en quelques lignes seulement. Vous avez juste besoin d'indiquer dans le manifeste que l'activit√© prend en charge ce mode, et dans le code, allez-y lorsque vous r√©duisez l'application. Par cons√©quent, vous pouvez regarder, par exemple, YouTube et voir les lectures du tapis roulant dans un coin de l'√©cran. Cela s'est av√©r√© tr√®s pratique. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais √† ce stade, j'ai finalement √©t√© d√©pass√© par la douleur du d√©veloppeur pour Android, car j'ai d√©j√† quatre tailles d'√©cran diff√©rentes: le t√©l√©phone et la tablette en mode normal et ils sont en mode "image dans l'image". Et il se trouve que si je s√©lectionne la taille de police normale pour une taille d'√©cran, dans d'autres cas, tout est trop petit, puis trop grand.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du d√©veloppement pour Android, il existe plusieurs cat√©gories d'√©crans et vous pouvez appliquer diff√©rents param√®tres automatiquement pour eux, mais dans mon cas, cela ne suffisait pas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, j'ai d√ª calculer et d√©finir les tailles de police dans le code, ce qui, je pense, est tr√®s faux. </font><font style="vertical-align: inherit;">Cependant, cela fonctionne parfaitement en cons√©quence.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le r√©sultat. </font><font style="vertical-align: inherit;">Nous ouvrons l'application, attendons la connexion avec le tapis roulant et le capteur de fr√©quence cardiaque, commen√ßons l'entra√Ænement et utilisons le tapis roulant comme d'habitude. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la fin de l'entra√Ænement, nous arr√™tons le tapis roulant. </font><font style="vertical-align: inherit;">Une fois la vitesse nulle atteinte, le bouton ¬´terminer l'entra√Ænement¬ª appara√Æt. </font><font style="vertical-align: inherit;">Cliquez dessus et les statistiques sont envoy√©es √† Samsung Health. </font><font style="vertical-align: inherit;">Ouvrez-le et voyez toutes les donn√©es. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir le graphique du pouls, de la vitesse et de l'√©l√©vation, comparer vos progr√®s √† diff√©rents intervalles de temps, tout cela est stock√© dans le cloud et accessible depuis tous les appareils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez le synchroniser avec Google Fit. </font><font style="vertical-align: inherit;">La beaut√©. </font><font style="vertical-align: inherit;">Je suis content du r√©sultat. </font><font style="vertical-align: inherit;">Maintenant, l'essentiel n'est pas de lancer des cours. </font><font style="vertical-align: inherit;">Vous pouvez ajouter √† la fonctionnalit√© de l'application pour qu'elle ressemble √† une formation si je suis paresseux pendant longtemps. </font><font style="vertical-align: inherit;">Mais je suis d√©j√† trop paresseux pour faire cette fonction.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502354/index.html">Les fournisseurs d'IaaS se battent pour le march√© europ√©en - discuter de la situation et des √©v√©nements de l'industrie</a></li>
<li><a href="../fr502358/index.html">Impl√©mentation de MVP bas√©e sur ApplicationController et IoC dans une application WinForms</a></li>
<li><a href="../fr502360/index.html">D√©charges Grizzly ou Super Drill</a></li>
<li><a href="../fr502362/index.html">Apprentissage du tra√ßage d'√©v√©nements pour Windows: th√©orie et pratique</a></li>
<li><a href="../fr502366/index.html">Comparez le travail de Python open source - biblioth√®ques pour la reconnaissance des entit√©s nomm√©es</a></li>
<li><a href="../fr502370/index.html">Mettre le jeu "Snake" sur la planche √† pain. Partie 1: machines d'√©tat</a></li>
<li><a href="../fr502372/index.html">Probl√®mes et principes de personnalisation de la version en bo√Æte de Bitrix24</a></li>
<li><a href="../fr502374/index.html">Protocole de communication FT8 - Fonctionnement</a></li>
<li><a href="../fr502380/index.html">C√©leri + asyncio</a></li>
<li><a href="../fr502382/index.html">Interface V√©los Toxic Grandfather. "Mensonges, menaces et chantage." (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>