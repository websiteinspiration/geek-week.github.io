<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕛 ✍🏾 ⬛️ Nous pompons le tapis roulant 🍂 👈🏽 🙆🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Récemment, j'ai décidé d'un achat très étrange pour moi. Oui, j'ai acheté un tapis roulant. 
 
 
 
 Et bientôt, je me suis rendu compte qu'il n'y avai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous pompons le tapis roulant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Récemment, j'ai décidé d'un achat très étrange pour moi. </font><font style="vertical-align: inherit;">Oui, j'ai acheté un tapis roulant. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bientôt, je me suis rendu compte qu'il n'y avait pas assez de statistiques détaillées comme lorsque je faisais du vélo. </font><font style="vertical-align: inherit;">Dans le cas d'un vélo, l'application sur le téléphone écrit ma vitesse, ma fréquence cardiaque, ma cadence et mon portance. </font><font style="vertical-align: inherit;">Il est très curieux de contrôler tous ces paramètres pendant l'entraînement, pour pouvoir consulter les graphiques et comparer de temps en temps vos résultats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc décidé de faire quelque chose de similaire avec le tapis roulant: le connecter à un smartphone ou une tablette afin de collecter et d'afficher des statistiques.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme d'habitude, mon histoire se présente sous la forme d'un article texte traditionnel, et par vidéo. </font><font style="vertical-align: inherit;">Comme vous en voulez plus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vidéo</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Article</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conception</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même au moment où je récupérais le tapis roulant, j'ai remarqué que la télécommande et la courroie elle-même ne connectaient que quatre fils. Apparemment, certains d'entre eux sont utilisés pour alimenter la console, car la toile elle-même est connectée au réseau 220 volts, et les fils restants sont nécessaires pour transmettre des signaux de contrôle dans la direction opposée - de la console à la toile, ils contrôlent la vitesse et l'angle de la piste. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai connecté l'oscilloscope en parallèle à ces fils, en essayant différentes combinaisons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, j'ai découvert que tout était à peu près le même que ce à quoi je m'attendais. L'un des fils est mis à la terre et un autre est de 12 volts. Les autres transmettent des données numériques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'un d'eux, le signal change lors du changement de vitesse et d'angle. </font><font style="vertical-align: inherit;">C'est exactement ce dont j'ai besoin! </font><font style="vertical-align: inherit;">L'amplitude du signal est d'environ quatre volts. </font><font style="vertical-align: inherit;">Mais le protocole ne ressemble pas à quelque chose de standard, et le signal est très bruyant, lorsque la piste est activée, vous devez le filtrer d'une manière ou d'une autre. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le dernier fil n'est que des impulsions à fréquence constante. </font><font style="vertical-align: inherit;">Apparemment, pour que la console puisse voir la connexion à la ceinture de course. </font><font style="vertical-align: inherit;">Si vous déconnectez ce fil, la télécommande donne immédiatement une erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les indications du capteur d'impulsions sur ces fils ne sont clairement pas transmises, mais ce n'est pas nécessaire. </font><font style="vertical-align: inherit;">Il est préférable de connecter un capteur thoracique séparé, que j'utilise depuis longtemps lorsque je fais du vélo. </font><font style="vertical-align: inherit;">De plus, il s'est avéré que le capteur de fréquence cardiaque sur le tapis roulant lui-même ment beaucoup, sous-estimant les lectures.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblage de l'appareil</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la tâche suivante consiste à assembler une carte qui se connecte en parallèle à ces fils, lit la vitesse et l'angle actuels, et les transfère en quelque sorte sans fil vers une tablette ou un smartphone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois de plus, j'ai décidé d'utiliser l'ordinateur monocarte Onion Omega2. Il doit faire un excellent travail. Il suffit de baisser la tension d'alimentation à 3,3 volts et de filtrer les données des interférences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour réduire la tension, j'utilise maintenant ces cartes prêtes à l'emploi avec un convertisseur DC-DC. Ils coûtent un sou, peuvent supporter jusqu'à quelques ampères et la tension de sortie est ajustée avec une torsion. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En même temps, cette carte a des conclusions à souder directement sur une autre carte, c'est très pratique. L'essentiel est de ne pas tordre la torsion de tension après l'installation dans le circuit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour filtrer le bruit sur la ligne de données, j'ai fabriqué un filtre RC ordinaire: une résistance de 2,2 kilo-ohms et un condensateur de 22 picofarad. </font><font style="vertical-align: inherit;">Cela devrait filtrer le bruit haute fréquence, laissant un signal basse fréquence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est avéré être une petite écharpe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je l'ai connecté aux fils du tapis roulant pour voir à quel point le signal est filtré lorsqu'il est allumé et, apparemment, la forme d'onde est devenue presque parfaite.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module noyau</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il n'est pas si facile de vérifier les performances du fer. Comme nous l'avons vu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plus tôt sur l'oscilloscope, les signaux vont très vite, et nous n'utilisons pas de microcontrôleur, mais un ordinateur Omega2 mono-carte avec Linux embarqué. Sous Linux, nous ne pourrons pas traiter les signaux de l'espace utilisateur aussi rapidement. Mais du cœur, nous pouvons! Il est donc temps d'écrire un module du noyau Linux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, vous devez télécharger les sources du noyau Linux, dans notre cas, il s'agit d'un assemblage OpenWRT pour Omega2, et créer un répertoire contenant le code source de notre module.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'écriture de code de module ressemble beaucoup à la programmation d'un microcontrôleur. Nous écrivons également en C, tout est également de bas niveau, nous travaillons également avec des interruptions et nous nous tournons également vers les conclusions GPIO. Seulement ici, en plus de tout ce qui précède, nous interagissons toujours avec l'espace utilisateur via un pseudo-fichier. Ainsi, notre module noyau devient une sorte d'adaptateur entre le matériel et les applications ordinaires. En fait, cela s'appelle le pilote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début, je ne savais pas comment décoder les signaux, j'ai donc simplement déduit leur durée. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est vite devenu clair que les signaux étaient codés avec une durée de haut niveau. Elle est longue de 600 microsecondes ou de 1200 microsecondes. Le niveau bas est toujours de 600 microsecondes à l'exception de la séquence initiale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un total de 17 de ces gouttes de haut en bas. </font><font style="vertical-align: inherit;">Apparemment, il s'agit de 16 bits de données plus la séquence initiale. </font><font style="vertical-align: inherit;">J'ai fait leur décodage, en prenant comme base que les longues différences élevées sont un zéro logique, et les courtes sont une unité logique et j'ai compris ce qui s'est passé. </font><font style="vertical-align: inherit;">J'ai immédiatement vu les données dont j'avais besoin! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, 16 bits sont deux octets. </font><font style="vertical-align: inherit;">Le premier octet indique le type de données transmises: l'angle d'inclinaison ou de vitesse, et le deuxième octet les données elles-mêmes. </font><font style="vertical-align: inherit;">Le pilote est extrêmement simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le seul paramètre de pilote est le numéro de port.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'initialisation, configurez-le pour l'entrée et définissez l'interruption, qui sera déclenchée à chaque changement de niveau.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette interruption, nous regardons d'abord l'heure actuelle. Ensuite, nous utilisons cette valeur pour calculer le temps écoulé depuis le déclenchement de la dernière interruption et la placer dans un tableau. Bien sûr, nous nous souvenons de l'heure actuelle pour le calcul la prochaine fois. De plus, vous devez redémarrer la minuterie spéciale.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'astuce est que si la minuterie fonctionne toujours, cela signifie qu'il n'y a pas eu de baisse de niveau sur la broche pendant une longue période, et qu'il est donc temps de traiter les informations collectées. </font><font style="vertical-align: inherit;">Dans la fonction appelée par le temporisateur, il est vérifié qu'il y a eu exactement 34 gouttes, après quoi nous regardons la durée de chaque intervalle. </font><font style="vertical-align: inherit;">S'il y a 600 microsecondes, puis 1200 microsecondes, alors nous prenons 900 à l'étranger. Si l'intervalle est inférieur, alors nous écrivons un dans le résultat, en le décalant d'un bit. </font><font style="vertical-align: inherit;">Après avoir traité chaque intervalle, nous envoyons le résultat à des pseudo-fichiers ouverts, transférant ainsi les données vers l'espace utilisateur.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur Python et détection de vitesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste ensuite à écrire un script Python qui les lira du pseudo-fichier et les enverra sur le réseau sous forme de chaînes JSON. Il semblerait que tout soit assez simple. Cependant, si tout est simple avec l'angle d'inclinaison et que la valeur dans le deuxième octet correspond exactement à l'angle d'inclinaison en pourcentage, alors avec la vitesse tout s'est avéré beaucoup plus déroutant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une valeur de 9 correspond à un kilomètre par heure et une valeur de 160 correspond à 18 kilomètres par heure. Autrement dit, la dépendance des données à la vitesse réelle n'est pas du tout évidente. J'ai écrit toutes les valeurs manuellement, les ai conduites dans Excel, tracé et obtenu une courbe très inégale.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a des vitesses lorsque les lectures sur la télécommande sont différentes, mais les données et la vitesse de la piste elle-même restent les mêmes! Par exemple, 5,2 km / h et 5,3 km / h sont en fait les mêmes vitesses. Partout tricher. Je me demande quelle vitesse est vraiment là? Mesurez-le en quelque sorte, mais laissez-le pour plus tard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hormis ce transfert de perroquets en kilomètres par heure, le script s'est avéré extrêmement simple. Nous lisons les données du pseudo-fichier Linux, les décodons, acceptons les connexions réseau et transférons les données aux clients connectés sur le réseau sous forme de chaîne JSON.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense qu'aucune autorisation et sécurité ne sont nécessaires ici. </font><font style="vertical-align: inherit;">L'état du tapis roulant n'est pas le type de données que je voudrais protéger contre les pirates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons ce script au démarrage et retirons la planche à l'intérieur du tapis roulant. </font><font style="vertical-align: inherit;">Hélas, il ne tient que dans un tuyau métallique reliant la console à la bande de roulement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, le métal protège le signal radio, j'ai donc sorti l'antenne Wi-Fi du tuyau, mais sous un boîtier en plastique qui cache les fils. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur ce tapis roulant directement «intelligent» est prêt. </font><font style="vertical-align: inherit;">Elle sait déjà comment diffuser des statistiques sur le réseau. </font><font style="vertical-align: inherit;">Il ne reste plus qu'à lui écrire un client!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client Android</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui à mon avis devrait être un tel client. </font><font style="vertical-align: inherit;">Il s'agit d'une application Android que je vais exécuter sur une tablette ou un smartphone et placer sur le dessus de l'écran du tapis roulant lui-même, respectivement, elle devrait afficher toutes les informations sur les exercices sur l'écran, en remplaçant l'affichage du tapis roulant lui-même. </font><font style="vertical-align: inherit;">L'application devrait pouvoir fonctionner en arrière-plan, afin que je puisse regarder la vidéo sans aucun problème pendant le jogging. </font><font style="vertical-align: inherit;">En outre, il devrait conserver des statistiques détaillées sur les courses, tout synchroniser avec le nuage et dessiner des graphiques de la dépendance de l'impulsion à la vitesse et à l'angle d'inclinaison. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cœur d'une telle application devrait être un service qui s'exécute en arrière-plan, se connecte au tapis roulant dans une boucle sans fin, reçoit des données et les décode. </font><font style="vertical-align: inherit;">Il n'y a pas de difficultés particulières à cela.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capteur de fréquence cardiaque</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chose la plus difficile a été de travailler soudainement avec un capteur de fréquence cardiaque. </font><font style="vertical-align: inherit;">De nombreux pièges ont été découverts. </font><font style="vertical-align: inherit;">J'ai un tel moniteur de fréquence cardiaque thoracique ici: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
je l'utilise depuis longtemps quand je fais du vélo. </font><font style="vertical-align: inherit;">Il est assez standard, il fonctionne sur BLE à la Bluetooth Low Enegy, il peut être couplé avec un téléphone et un navigateur Garmin sans aucun problème. </font><font style="vertical-align: inherit;">Je ne pouvais même pas penser que travailler avec lui depuis ma candidature serait si évident. </font><font style="vertical-align: inherit;">Ces capteurs ont des GUID standard pour différentes lectures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer à recevoir une fréquence cardiaque, vous devez d'abord configurer votre moniteur de fréquence cardiaque pour envoyer périodiquement des lectures. </font><font style="vertical-align: inherit;">Je ne pouvais le faire qu'en étudiant des exemples non fonctionnels et en tapant.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, j'ai écrit une classe pour travailler avec un émetteur de fréquence cardiaque, qui essaie automatiquement de s'y connecter et rapporte périodiquement la fréquence cardiaque actuelle.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quant aux statistiques et aux graphiques. </font><font style="vertical-align: inherit;">J'ai décidé de ne pas réinventer la roue, mais d'utiliser ce que j'utilise déjà quand je fais du vélo, à savoir me lier d'amitié avec la merveilleuse application Samsung Health. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, il semblerait que je fasse de nouveau de la publicité pour Samsung. </font><font style="vertical-align: inherit;">Mais sur un vélo, cette application a vraiment fait ses preuves. </font><font style="vertical-align: inherit;">À ma grande surprise, il se connecte à tous les capteurs sans problème, affiche à la fois la cadence et la vitesse des roues, et dicte les statistiques dans les écouteurs, il affiche les mêmes statistiques avec des graphiques, donne des réalisations et stocke tout dans le cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche a montré que Samsung Health possède son propre SDK, qui, bien que pas entièrement intelligible, est toujours documenté: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travailler avec, c'est essentiellement travailler avec une base de données qui stocke une variété de lectures, des mesures prises et des mesures de la fréquence cardiaque à la glycémie et aux phases de sommeil. </font><font style="vertical-align: inherit;">Mais maintenant, nous nous intéressons aux enregistrements d'exercices, qui incluent à la fois des valeurs scalaires comme le type d'exercice, le temps, la distance, la durée, les calories brûlées et des tableaux de données en direct comme l'historique de la fréquence cardiaque, de la vitesse et des coordonnées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes ces données doivent être correctement stockées et préparées. </font><font style="vertical-align: inherit;">Certains doivent être calculés.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcul de la hauteur</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, la hauteur de levage. </font><font style="vertical-align: inherit;">Depuis le tapis roulant, nous connaissons l'angle de montée à chaque instant, qui est mesuré en pourcentage. </font><font style="vertical-align: inherit;">Le pourcentage de l'angle d'élévation est le rapport de la distance parcourue à la montée. </font><font style="vertical-align: inherit;">Il s'avère que la vitesse verticale est égale à la vitesse habituelle multipliée par la pente en pourcentage et divisée par cent. </font><font style="vertical-align: inherit;">Connaissant la vitesse verticale, nous pouvons calculer la hauteur actuelle à chaque instant. </font><font style="vertical-align: inherit;">Par conséquent, il doit être entré dans les coordonnées actuelles, malgré le fait que pendant l'exercice, elles ne changent pas et ne sont pas prises en compte. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En réponse à ces données, l'application Samsung Health montrera combien j'ai soi-disant grimpé, ainsi que la vitesse verticale à chaque moment de l'entraînement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comptage des calories</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comment compter les calories? De plus, le comptage des calories est un must pour Samsung Health. Dans le même temps, les calories brûlées sont un indicateur très inexact, qui dépend de nombreux facteurs différents. Je ne sais pas s'il est logique de les compter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne suis pas venu avec quelque chose de moi et juste google la calculatrice (https://42.195km.net/e/treadsim/) et copié l'algorithme de mon javascript (https://42.195km.net/e/treadsim/treadsim107 .js). A l'entrée, il prend la distance parcourue, l'angle d'élévation et ... le poids.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pouvais définir mon poids manuellement, mais puisque nous travaillons avec Samsung Health, je peux prendre mon poids actuel à partir de là. </font><font style="vertical-align: inherit;">Après tout, j'utilise des balances intelligentes de Xiaomi, qui sont synchronisées avec Google Fit sur mon téléphone, Google FIt via une application distincte est synchronisé avec Samsung Health, Samsung Health via le cloud est synchronisé avec lui-même sur la tablette, où mon application le reçoit déjà.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apparence de l'application</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visuellement, la tâche de l'application est d'afficher à grande échelle les principales indications: vitesse, angle, fréquence cardiaque, distance, calories. Il est préférable de le faire en blanc sur fond noir afin que la consommation de la batterie lors de l'utilisation de l'écran AMOLED soit minimale, car nous indiquons certainement que lors de l'affichage de notre activité, l'écran doit être allumé en permanence. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les boutons sont automatiquement masqués lorsque le tapis roulant est actif. Vous pouvez démarrer et arrêter l'entraînement uniquement à vitesse nulle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et bien sûr, vous devez prendre en charge le mode «image dans l'image». Cela se fait en quelques lignes seulement. Vous avez juste besoin d'indiquer dans le manifeste que l'activité prend en charge ce mode, et dans le code, allez-y lorsque vous réduisez l'application. Par conséquent, vous pouvez regarder, par exemple, YouTube et voir les lectures du tapis roulant dans un coin de l'écran. Cela s'est avéré très pratique. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais à ce stade, j'ai finalement été dépassé par la douleur du développeur pour Android, car j'ai déjà quatre tailles d'écran différentes: le téléphone et la tablette en mode normal et ils sont en mode "image dans l'image". Et il se trouve que si je sélectionne la taille de police normale pour une taille d'écran, dans d'autres cas, tout est trop petit, puis trop grand.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du développement pour Android, il existe plusieurs catégories d'écrans et vous pouvez appliquer différents paramètres automatiquement pour eux, mais dans mon cas, cela ne suffisait pas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, j'ai dû calculer et définir les tailles de police dans le code, ce qui, je pense, est très faux. </font><font style="vertical-align: inherit;">Cependant, cela fonctionne parfaitement en conséquence.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le résultat. </font><font style="vertical-align: inherit;">Nous ouvrons l'application, attendons la connexion avec le tapis roulant et le capteur de fréquence cardiaque, commençons l'entraînement et utilisons le tapis roulant comme d'habitude. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la fin de l'entraînement, nous arrêtons le tapis roulant. </font><font style="vertical-align: inherit;">Une fois la vitesse nulle atteinte, le bouton «terminer l'entraînement» apparaît. </font><font style="vertical-align: inherit;">Cliquez dessus et les statistiques sont envoyées à Samsung Health. </font><font style="vertical-align: inherit;">Ouvrez-le et voyez toutes les données. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir le graphique du pouls, de la vitesse et de l'élévation, comparer vos progrès à différents intervalles de temps, tout cela est stocké dans le cloud et accessible depuis tous les appareils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez le synchroniser avec Google Fit. </font><font style="vertical-align: inherit;">La beauté. </font><font style="vertical-align: inherit;">Je suis content du résultat. </font><font style="vertical-align: inherit;">Maintenant, l'essentiel n'est pas de lancer des cours. </font><font style="vertical-align: inherit;">Vous pouvez ajouter à la fonctionnalité de l'application pour qu'elle ressemble à une formation si je suis paresseux pendant longtemps. </font><font style="vertical-align: inherit;">Mais je suis déjà trop paresseux pour faire cette fonction.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502354/index.html">Les fournisseurs d'IaaS se battent pour le marché européen - discuter de la situation et des événements de l'industrie</a></li>
<li><a href="../fr502358/index.html">Implémentation de MVP basée sur ApplicationController et IoC dans une application WinForms</a></li>
<li><a href="../fr502360/index.html">Décharges Grizzly ou Super Drill</a></li>
<li><a href="../fr502362/index.html">Apprentissage du traçage d'événements pour Windows: théorie et pratique</a></li>
<li><a href="../fr502366/index.html">Comparez le travail de Python open source - bibliothèques pour la reconnaissance des entités nommées</a></li>
<li><a href="../fr502370/index.html">Mettre le jeu "Snake" sur la planche à pain. Partie 1: machines d'état</a></li>
<li><a href="../fr502372/index.html">Problèmes et principes de personnalisation de la version en boîte de Bitrix24</a></li>
<li><a href="../fr502374/index.html">Protocole de communication FT8 - Fonctionnement</a></li>
<li><a href="../fr502380/index.html">Céleri + asyncio</a></li>
<li><a href="../fr502382/index.html">Interface Vélos Toxic Grandfather. "Mensonges, menaces et chantage." (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>