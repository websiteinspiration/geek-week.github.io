<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò≥ üîÑ ü§∂üèΩ JOOQ et son terrier de lapin. Comment survivre sans hibernation üëêüèº üêõ ‚ò™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je ne me noierai pas pour JOOQ. Je pr√©f√®re Hibernate et toute la puissance JPA de Spring Data derri√®re. Mais l'article ne parlera pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>JOOQ et son terrier de lapin. Comment survivre sans hibernation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488522/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cet article, je ne me noierai pas pour JOOQ. </font><font style="vertical-align: inherit;">Je pr√©f√®re Hibernate et toute la puissance JPA de Spring Data derri√®re. </font><font style="vertical-align: inherit;">Mais l'article ne parlera pas d'eux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wt/-0/co/wt-0condklmkd6zkb2ag_a46vb4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous utilisons Hibernate et Spring Data JPA, nous n'avons pas besoin de penser aux processus internes - conna√Ætre les annotations et √©crire les noms de m√©thode corrects dans le r√©f√©rentiel - ces deux monstres feront le reste pour vous. </font><font style="vertical-align: inherit;">Dans le cas de JOOQ, malheureusement pour beaucoup, vous devez tendre un peu et √©crire plus que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findAllByUserId (Long userId)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'un JOOQ?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âcrivons une simple requ√™te SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> countries c <span class="hljs-keyword">where</span> c.population &gt; <span class="hljs-number">10000000</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons ex√©cuter cette demande dans la console. </font><font style="vertical-align: inherit;">d'accord </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne nous sentons pas comme dans la console. </font><font style="vertical-align: inherit;">Nous voulons que notre application envoie cette demande. </font><font style="vertical-align: inherit;">Que ce n'√©tait pas un script √† usage unique et qu'il a √©t√© valid√© au moins pour la syntaxe. </font><font style="vertical-align: inherit;">Nous le faisons via Spring Data JPA:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllByPopulationAfter</span><span class="hljs-params">(Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√™me demande est ex√©cut√©e comme ci-dessus, mais au printemps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels sont les avantages √©vidents de cette approche? </font><font style="vertical-align: inherit;">Elle est r√©alis√©e par un framework puissant; elle valide √©galement une demande d'erreurs. </font><font style="vertical-align: inherit;">Mais la gestion des requ√™tes s'occupe du framework. </font><font style="vertical-align: inherit;">Et nous voulons g√©rer compl√®tement la demande, mais en m√™me temps, pour que la demande soit compl√®tement valid√©e. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisation</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requete</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Query("select c from Country c where c.population &gt; :amount")</span>
<span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllPopulationGreaterThan</span><span class="hljs-params">(<span class="hljs-meta">@Param("amount")</span> Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un tel compromis entre SQL et DSL est √©galement bon. </font><font style="vertical-align: inherit;">Mais si nous ne voulons pas jouer avec SQL, nous serons heureux de voir quelque chose comme:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plusieurs biblioth√®ques conviennent √† cela: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QueryDSL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speedment</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
√Ä propos de QueryDSL J'ai </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©crit il y a</font></font></u></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quelques ann√©es. </font><font style="vertical-align: inherit;">Je n'ai pas creus√© Speedment, mais il semble que ce soit plus qu'un simple g√©n√©rateur DSL, et je devrai apprendre les m√©thodes par lesquelles ils ont chiffr√© les commandes de requ√™te SQL. </font><font style="vertical-align: inherit;">En g√©n√©ral, nous parlerons aujourd'hui de l'OJOQ.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requ√™tes JOOQ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, nous avons d√©j√† vu l'une de ces requ√™tes ci-dessus:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'y a-t-il d'autre? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, une simple requ√™te get:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou ins√©rez la demande:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, tout est clair, rien de plus. </font><font style="vertical-align: inherit;">Mais ce n'est qu'√† premi√®re vue. </font><font style="vertical-align: inherit;">D√©couvrir √† quelle profondeur ce terrier de lapin peut prendre plusieurs semaines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais commen√ßons par le d√©but.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oui ce sera maven</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pr√©f√®re Gradle. </font><font style="vertical-align: inherit;">Mais pour une raison quelconque, les d√©veloppeurs JOOQ accordent moins d'attention √† Gradle, proposant d'opter pour des plugins tiers. </font><font style="vertical-align: inherit;">D'accord, le projet de formation sera sur Maven. </font><font style="vertical-align: inherit;">Mais si vous, cher lecteur, fouillez comme il se doit dans les profondeurs du github et √™tes pr√™t √† r√©v√©ler un projet enti√®rement personnalis√© sur Gradle - √©crivez-moi et vous deviendrez co-auteur de cet article. </font><font style="vertical-align: inherit;">Il en va de m√™me pour H2 (le projet de formation sera sur PostgreSQL).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi je n'ai pas r√©ussi avec Gradle et H2</font></font></b><div class="spoiler_text">    ,      Gradle.           jooq-generator .          H2,  ¬´  ¬ª   H2         ,   ,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©pendances Maven n√©cessaires:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Spring Starters --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Database --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flywaydb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flyway-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Helpers --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${commons.lang3.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!--Test --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- JOOQ Generator --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-meta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring a d√©j√† un d√©marreur JOOQ qui auto-configurera le DataSource selon les param√®tres sp√©cifi√©s dans application.yml. </font><font style="vertical-align: inherit;">Mais pour le travail complet de l'OJOQ, cela ne suffit pas. </font><font style="vertical-align: inherit;">Les entit√©s doivent √™tre g√©n√©r√©es. </font><font style="vertical-align: inherit;">Oui, oui, nous n'√©crivons pas d'entit√©s, mais nous les g√©n√©rons. </font><font style="vertical-align: inherit;">L'approche dite de la table d'abord. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure d'application habituelle, ax√©e sur l'utilisation de la base de donn√©es, ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c-/pz/tp/c-pztpdxbkn5kxot-s_08tzlzbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
jusqu'√† la couche de service, les donn√©es transitent par l'application sous la forme d'un mod√®le plat (DTO). </font><font style="vertical-align: inherit;">De plus, lorsque le service doit travailler avec la base de donn√©es, il convertit le DTO en une entit√©, l'envoie au r√©f√©rentiel et celui-ci le sauvegarde d√©j√† dans la base de donn√©es. </font><font style="vertical-align: inherit;">Les d√©veloppeurs de JOOQ voient tout diff√©remment: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/wy/4b/vvwy4bbp1ox57f4j0edmulfe7ni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comme on peut le voir, √† JOOQ, ils ont s√©rieusement r√©vis√© le mod√®le standard et ont d√©cid√© de suivre leur propre chemin. </font><font style="vertical-align: inherit;">Les diff√©rences sont importantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conversion de DTO en une entit√© se produit d√©j√† dans le r√©f√©rentiel. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'√©crivons pas une entit√© en tant que telle. </font><font style="vertical-align: inherit;">Il est √©crit pour nous par le g√©n√©rateur JOOQ.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©j√†, cela suffit pour conclure que l'OJOQ n'est pas si simple. </font><font style="vertical-align: inherit;">Une entit√© g√©n√©r√©e hautement personnalisable, une cartographie incompr√©hensible dans DTO et d'autres difficult√©s en effrayeront beaucoup. </font><font style="vertical-align: inherit;">Mais dans les cas o√π il n'y a nulle part o√π aller, une √©tude cibl√©e de ces aspects de l'OJOQ peut s√©rieusement se prolonger et prendre des jours, voire des semaines. </font><font style="vertical-align: inherit;">Je suis s√ªr que mon message vous fera gagner beaucoup de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous couvrirons les aspects suivants de la collaboration avec l'OJOQ:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©ration d'entit√©. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcriture de requ√™tes CRUD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation des requ√™tes CRUD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et une autre optimisation de demande CRUD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mappage d'entit√©s √† l'aide de la biblioth√®que JOOQ standard. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et discuter pourquoi tout cela est n√©cessaire. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allons-y.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'√©crivons-nous?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre projet comportera deux entit√©s: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pays:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Country</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> GovernmentForm governmentForm;
    <span class="hljs-keyword">private</span> Integer population;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> List&lt;City&gt; cities;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ville:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">City</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long countryId;
    <span class="hljs-keyword">private</span> String name;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Relation un √† plusieurs. </font><font style="vertical-align: inherit;">Le pays contient de nombreuses villes li√©es. </font><font style="vertical-align: inherit;">La ville contient countryId. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La migration des voies de migration ressemble √† ceci:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> countries<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>              bigserial primary <span class="hljs-keyword">key</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    government_form <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    population      <span class="hljs-built_in">int</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cities<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>         bigserial primary <span class="hljs-keyword">key</span>,<font></font>
    country_id <span class="hljs-built_in">bigint</span>,
    <span class="hljs-keyword">name</span>       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>)<font></font>
);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commen√ßons par la g√©n√©ration d'entit√©s.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai dit, les entit√©s sont g√©n√©r√©es s√©par√©ment. </font><font style="vertical-align: inherit;">Il y a deux fa√ßons de faire √ßa.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√¢ce au plugin Maven. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En code Java. </font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©ration d'entit√©s dans Maven</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le projet se construit, Maven d√©marre le g√©n√©rateur et g√©n√®re des entit√©s. </font><font style="vertical-align: inherit;">Et vous pouvez appeler le g√©n√©rateur √† tout moment et g√©n√©rer des entit√©s. </font><font style="vertical-align: inherit;">Cela est n√©cessaire dans les moments o√π, disons, la structure de la base a chang√©. </font><font style="vertical-align: inherit;">Le plugin dans Maven ressemble √† ceci:</font></font><br>
<br>
<pre><code class="xml hljs">            <span class="hljs-comment">&lt;!-- JOOQ Generator Plugin --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen-maven<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>generate-sources<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>generate<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">jdbc</span>&gt;</span>  <span class="hljs-comment">&lt;!--    --&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">driver</span>&gt;</span>${db.driver}<span class="hljs-tag">&lt;/<span class="hljs-name">driver</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>${db.url}<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>${db.username}<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>${db.password}<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">jdbc</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">generator</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">database</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>.*<span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span><font></font>
                                flyway_schema_history<font></font>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">inputSchema</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">inputSchema</span>&gt;</span>  <span class="hljs-comment">&lt;!--  --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">database</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">generate</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">records</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">records</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">generate</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--      --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">packageName</span>&gt;</span>ru.xpendence.jooqexample.domain<span class="hljs-tag">&lt;/<span class="hljs-name">packageName</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--  .    target. --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>target/generated-sources/jooq<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">generator</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez tout fait correctement, mettez √† jour Maven et parmi les plugins vous verrez jooq-codegen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/ch/pv/1nchpvafnxml7qle_dfsq1zsuje.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cuter. Il g√©n√©rera des entit√©s pour vous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/kf/la/cskfla2pzxfkm-vkot_dcggqoia.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sont les m√™mes entit√©s que vous utiliserez pour acc√©der √† la base de donn√©es. Premi√®re nuisance: ils sont immuables. Autrement dit, ils sont modifiables, mais le changement de type se produit d'une mani√®re si artificielle que cette description de processus sera tir√©e vers un article distinct. Par cons√©quent, essayez de r√©fl√©chir aux types de donn√©es au stade de la g√©n√©ration de la table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les entit√©s semblent particuli√®res. Voici, par exemple, la signature de la classe CountriesRecord:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountriesRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UpdatableRecordImpl</span>&lt;<span class="hljs-title">CountriesRecord</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Record4</span>&lt;<span class="hljs-title">Long</span>, <span class="hljs-title">String</span>, <span class="hljs-title">String</span>, <span class="hljs-title">Integer</span>&gt; </span>{
    <span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous pouvons le voir, CountriesRecord impl√©mente Record4, qui est tap√© par 4 types. </font><font style="vertical-align: inherit;">Le tableau des pays a 4 colonnes, donc Record4. </font><font style="vertical-align: inherit;">Il y a 3 colonnes dans les villes, donc Record3. </font><font style="vertical-align: inherit;">Pourquoi cela a √©t√© invent√©, je ne sais pas. </font><font style="vertical-align: inherit;">Il y a 22 enregistrements de ce type dans la biblioth√®que OJOQ, Record1 ... Record22. </font><font style="vertical-align: inherit;">D'o√π nous pouvons conclure que les capacit√©s de JOOQ sont limit√©es au traitement des tables avec un maximum de 22 colonnes, mais ce n'est pas le cas. </font><font style="vertical-align: inherit;">J'ai des tables avec des dizaines de colonnes et JOOQ impl√©mente imm√©diatement Record. </font><font style="vertical-align: inherit;">Eh bien, cela ... La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
g√©n√©ration d'entit√©s JOOQ en code Java ressemble √† ceci:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterStartupApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ContextRefreshedEvent</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.driver-class-name}")</span>
    <span class="hljs-keyword">private</span> String driver;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.url}")</span>
    <span class="hljs-keyword">private</span> String url;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.username}")</span>
    <span class="hljs-keyword">private</span> String username;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.password}")</span>
    <span class="hljs-keyword">private</span> String password;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.name}")</span>
    <span class="hljs-keyword">private</span> String databaseName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-includes}")</span>
    <span class="hljs-keyword">private</span> String databaseWithIncludes;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-input-schema}")</span>
    <span class="hljs-keyword">private</span> String databaseWithInputSchema;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.package-name}")</span>
    <span class="hljs-keyword">private</span> String targetPackageName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.directory}")</span>
    <span class="hljs-keyword">private</span> String targetDirectory;<font></font>
<font></font>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent contextRefreshedEvent)</span> </span>{
        <span class="hljs-keyword">new</span> GenerationTool().run(configureGenerator());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Configuration <span class="hljs-title">configureGenerator</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Configuration()<font></font>
                .withJdbc(<span class="hljs-keyword">new</span> Jdbc()<font></font>
                        .withDriver(driver)<font></font>
                        .withUrl(url)<font></font>
                        .withUser(username)<font></font>
                        .withPassword(password))<font></font>
                .withGenerator(<span class="hljs-keyword">new</span> Generator()<font></font>
                        .withDatabase(<span class="hljs-keyword">new</span> Database()<font></font>
                                .withName(databaseName)<font></font>
                                .withIncludes(databaseWithIncludes)<font></font>
                                .withExcludes(<span class="hljs-string">""</span>)<font></font>
                                .withInputSchema(databaseWithInputSchema))<font></font>
                        .withTarget(<span class="hljs-keyword">new</span> Target()<font></font>
                                .withPackageName(targetPackageName)<font></font>
                                .withDirectory(targetDirectory)));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon cas, le g√©n√©rateur d√©marre apr√®s un d√©marrage complet de l'application, lorsque toutes les nouvelles migrations sont cumul√©es et que la base de donn√©es est √† jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, nous avons des mod√®les, nous avons des entit√©s, nous avons une base. </font><font style="vertical-align: inherit;">Il est temps de cr√©er un r√©f√©rentiel et d'√©crire des requ√™tes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er un r√©f√©rentiel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les demandes passent par DslContext. </font><font style="vertical-align: inherit;">R√©p√©tez le DslContext.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Repository</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©f√©rentiel est pr√™t.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âcriture de requ√™tes CRUD</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ins√©rer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous utilisions SQL, la demande d'ajout d'un autre pays serait:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> countries(<span class="hljs-keyword">name</span>, government_form, population)
<span class="hljs-keyword">values</span> (<span class="hljs-string">' -'</span>, <span class="hljs-string">'UNITARY'</span>, <span class="hljs-number">100500</span>) <span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans JOOQ, une requ√™te est aussi proche que possible de la syntaxe SQL:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertValues</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)  <span class="hljs-comment">//insert into countries</span>
                .values(country.getId(), country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))  <span class="hljs-comment">//values (? ? ? ?)</span>
                .returning()  <span class="hljs-comment">//returning</span>
                .fetchOne()  <span class="hljs-comment">//*</span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme on le voit, rien de compliqu√©. </font><font style="vertical-align: inherit;">Cependant, une telle demande ne nous convient pas, car dans notre cas, l'ID est g√©n√©r√© dans la base de donn√©es et nous devons en tenir compte. </font><font style="vertical-align: inherit;">Si nous √©crivons quelque chose comme:</font></font><br>
<br>
<pre><code class="java hljs">.values(<span class="hljs-keyword">null</span>, country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nous aurons </font></font><br>
<br>
<pre><code class="java hljs">org.postgresql.util.PSQLException: :     <span class="hljs-string">"id"</span>   NOT NULL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, si nous g√©n√©rions l'ID du c√¥t√© de l'application, une telle demande serait un tour. </font><font style="vertical-align: inherit;">Nous devrons r√©√©crire la demande, en donnant √† chaque champ une valeur sp√©cifique. </font><font style="vertical-align: inherit;">Afin que vous puissiez:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne()<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous d√©finissons manuellement l'objet dans le champ. </font><font style="vertical-align: inherit;">Cette option fonctionne assez bien, mais il y a mieux. </font><font style="vertical-align: inherit;">Il serait id√©al d'envoyer l'objet entier pour sauvegarde, comme cela se fait dans Spring Data JPA:</font></font><br>
<br>
<pre><code class="java hljs">repository.save(country);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela pourrait √™tre le cas. </font><font style="vertical-align: inherit;">Pour ce faire, nous devons mapper notre mod√®le dans l'entit√© Record √©tendue et l'envoyer pour enregistrement:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))  <span class="hljs-comment">//   </span><font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette m√©thode est la plus simple et la plus compr√©hensible dans les cas o√π nous n'avons pas besoin de configurer le mappage. </font><font style="vertical-align: inherit;">Mais le r√©glage de la cartographie sera plus bas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons remarqu√©, cette requ√™te renvoie l'entit√© enti√®re. </font><font style="vertical-align: inherit;">Vous pouvez d√©terminer exactement ce que vous devez retourner dans la m√©thode fetch (). </font><font style="vertical-align: inherit;">Cela ressemble √† ceci:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">insertAndReturnId</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .returning(Countries.COUNTRIES.ID) <span class="hljs-comment">//  Record    - id</span><font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .get(Countries.COUNTRIES.ID); <span class="hljs-comment">// id</span>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu encombrant, mais, encore une fois, avec quoi comparer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©crirons le reste des m√©thodes CRUD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise √† jour</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Requ√™te SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">update</span> countries
<span class="hljs-keyword">set</span> <span class="hljs-keyword">name</span>            = <span class="hljs-string">''</span>,<font></font>
    government_form = <span class="hljs-string">'CONFEDERATE'</span>,<font></font>
    population      = <span class="hljs-number">100500</span>
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">1</span>
<span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demande JOOQ:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">update</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.update(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .where(Countries.COUNTRIES.ID.eq(country.getId()))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error updating entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lectionner</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une requ√™te en SQL serait:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> *
<span class="hljs-keyword">from</span> countries c
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = ?;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans JOOQ, la requ√™te se pr√©sentera en cons√©quence:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES) <span class="hljs-comment">//select * from countries</span>
                .where(Countries.COUNTRIES.ID.eq(id))  <span class="hljs-comment">//where id = ?</span>
                .fetchAny()  <span class="hljs-comment">// ,    </span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a des demandes dans lesquelles nous n'avons rien √† retourner. </font><font style="vertical-align: inherit;">Ces requ√™tes renvoient le nombre de lignes affect√©es. </font><font style="vertical-align: inherit;">En suppression, nous n'avons rien √† retourner, mais les informations que nous recevons nous seront toujours utiles.</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">delete</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.deleteFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .execute() == <span class="hljs-number">1</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous supprimons une ligne. </font><font style="vertical-align: inherit;">Ainsi, la requ√™te SQL retournera quelque chose comme:</font></font><br>
<br>
<pre><code class="sql hljs">1 row affected in 5 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ayant re√ßu une telle r√©ponse, nous savons avec certitude que la ligne a √©t√© supprim√©e. </font><font style="vertical-align: inherit;">Ce sera suffisant pour d√©clarer l'op√©ration r√©ussie.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce n'√©tait pas un conte de f√©es. </font><font style="vertical-align: inherit;">C'√©tait juste un lubrifiant. </font><font style="vertical-align: inherit;">Utilisation d'un mappeur standard pour le mappage fin d'une entit√© dans Record et vice versa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"D'accord," dites-vous, lecteur, "o√π est un √† plusieurs, emoe?" Quelque chose que je n'ai pas vu le moment o√π le pays grandit avec une multitude de villes. ¬ª </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et vous aurez raison. Ce n'est pas Hibernate; ici, vous devez le faire manuellement. Tout ce que vous devez faire est d'obtenir une liste des villes pour lesquelles id = country.getId (). J'ai d√©j√† montr√© la m√©thode into (), qui utilise un mappeur normal pour mapper Record dans une entit√©. Mais JOOQ a une m√©thode map () suppl√©mentaire qui nous permet de faire tout ce que nous voulons avec Record. Examinons ses fonctionnalit√©s et ajoutons l'ajout de villes:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; {<font></font>
                    Country country = r.into(Country.class);<font></font>
                    country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
                    <span class="hljs-keyword">return</span> country;<font></font>
                });<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous le voyons, maintenant nous mappons d'abord l'enregistrement dans le pays, puis nous faisons une autre demande dans les villes, nous obtenons toutes les villes pour ce pays et les d√©finissons en substance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il peut y avoir des dizaines de tels ensembles, ce qui signifie qu'il peut y avoir des dizaines de demandes. </font><font style="vertical-align: inherit;">Et d√©crire ces requ√™tes directement dans la m√©thode, c'est comme √ßa. </font><font style="vertical-align: inherit;">La bonne solution consiste √† √©crire un mappeur distinct et √† y placer toutes ces demandes.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordMapper</span>&lt;<span class="hljs-title">CountriesRecord</span>, <span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CityRepository cityRepository;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">map</span><span class="hljs-params">(CountriesRecord record)</span> </span>{<font></font>
        Country country = record.into(Country.class);<font></font>
        country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
        <span class="hljs-keyword">return</span> country;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La requ√™te ressemblera maintenant √† ceci:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">findWithCustomMapper</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; countryRecordMapper.map((CountriesRecord) r));<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est plus concis et ne contient pas de logique suppl√©mentaire.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ok, nous avons appris √† mapper Record dans une entit√©, mais qu'en est-il du r√©glage fin du mappage d'une entit√© dans Record?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jusqu'√† pr√©sent, nous avons cette conception:</font></font><br>
<br>
<pre><code class="java hljs">.set(dsl.newRecord(Countries.COUNTRIES, country))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©j√† bon, mais que se passe-t-il si nous devons cartographier sp√©cifiquement un champ? </font><font style="vertical-align: inherit;">Par exemple, nous avons LocalDateTime et un g√©n√©rateur pour PostgreSQL comme Timestamp a g√©n√©r√© un OffsetDateTime. </font><font style="vertical-align: inherit;">Dans ce cas, le champ ne sera tout simplement pas mapp√© et non enregistr√© dans la base de donn√©es. </font><font style="vertical-align: inherit;">Pour de tels cas, nous aurons besoin d'un autre mappeur qui fera de m√™me, mais dans la direction oppos√©e.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oui, pour chaque mappeur, nous avons un mappeur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'appelle ainsi. </font><font style="vertical-align: inherit;">√âcrivons son h√©ritier.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordUnmapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordUnmapper</span>&lt;<span class="hljs-title">Country</span>, <span class="hljs-title">CountriesRecord</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CountriesRecord <span class="hljs-title">unmap</span><span class="hljs-params">(Country country)</span> <span class="hljs-keyword">throws</span> MappingException </span>{<font></font>
        CountriesRecord record = dsl.newRecord(Countries.COUNTRIES, country);<font></font>
        record.setPopulation(-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> record;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ins√©rer avec son application ressemblera √† ceci:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertWithUnmapper</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(countryRecordUnmapper.unmap(country))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous le voyons, aussi tout √† fait.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions et conclusions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personnellement, j'aime plus Hibernate. </font><font style="vertical-align: inherit;">Probablement, pour 90 +% des applications son utilisation sera plus justifi√©e. </font><font style="vertical-align: inherit;">Mais si vous, le lecteur, souhaitez contr√¥ler chaque demande, JOOQ ou une autre biblioth√®que similaire vous convient mieux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme toujours, je poste le projet de formation. </font><font style="vertical-align: inherit;">Il est allong√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488504/index.html">Nous connectons un calendrier de production dans Zabbix</a></li>
<li><a href="../fr488514/index.html">D√©bogueur √† distance Android - D√©bogage √† distance des applications Android</a></li>
<li><a href="../fr488516/index.html">Guide complet des balises iframe</a></li>
<li><a href="../fr488518/index.html">Examen comparatif des livres √©lectroniques ONYX BOOX Livingstone et Amazon Kindle Paperwhite (2018)</a></li>
<li><a href="../fr488520/index.html">Bloopers et gribouillis. 2</a></li>
<li><a href="../fr488528/index.html">Utilisation des m√©canismes de jetons cryptographiques PKCS # 11 sur la plate-forme Android</a></li>
<li><a href="../fr488530/index.html">Qu'est-ce que la r√©activit√©?</a></li>
<li><a href="../fr488534/index.html">Lampe UV DIY 400-405 nm pour la polym√©risation de mod√®les photopolym√®res 3D</a></li>
<li><a href="../fr488536/index.html">R√©fl√©chissez bien avant d'utiliser Docker-in-Docker pour CI ou environnement de test.</a></li>
<li><a href="../fr488540/index.html">Pistolet Gauss</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>