<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉ üëçüèΩ üèÇüèø C√≥digo asincr√≥nico en Startup ASP.NET Core: 4 formas de evitar GetAwaiter (). GetResult () ü•† üë®üèΩ‚Äçüè´ üßóüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Desde que se introdujo el mecanismo as√≠ncrono / espera en C # 5.0, en todos los art√≠culos y documentos se nos ha ense√±ado constantemente que usar c√≥di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥digo asincr√≥nico en Startup ASP.NET Core: 4 formas de evitar GetAwaiter (). GetResult ()</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dodopizzadev/blog/496300/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde que se introdujo el mecanismo as√≠ncrono / espera en C # 5.0, en todos los art√≠culos y documentos se nos ha ense√±ado constantemente que usar c√≥digo as√≠ncrono en sincron√≠a es muy malo. </font><font style="vertical-align: inherit;">Y llaman al miedo como las construcciones GetAwaiter (). GetResult (). </font><font style="vertical-align: inherit;">Sin embargo, hay un caso en el que los programadores de Microsoft mismos no desde√±an este dise√±o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yl/m9/nb/ylm9nbu--2sz9pzjxu-tgx8k5t4.png"><br>
 <a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes sobre la tarea laboral</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora estamos en el proceso de transici√≥n de la autenticaci√≥n heredada a OAuth 2.0, que ya es un est√°ndar en nuestra industria. </font><font style="vertical-align: inherit;">El servicio en el que estoy trabajando ahora se ha convertido en un piloto para la integraci√≥n con el nuevo sistema y para la transici√≥n a la autenticaci√≥n JWT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante el proceso de integraci√≥n, experimentamos, considerando varias opciones, c√≥mo reducir la carga en el proveedor de tokens (IdentityServer en nuestro caso) y garantizar una mayor confiabilidad de todo el sistema. </font><font style="vertical-align: inherit;">Conectar la validaci√≥n basada en JWT a ASP.NET Core es muy simple y no est√° vinculado a una implementaci√≥n espec√≠fica del proveedor de tokens:</font></font><br>
<br>
<pre><code class="cs hljs">services<font></font>
      .AddAuthentication()<font></font>
      .AddJwtBearer(); <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øqu√© se esconde detr√°s de estas dos l√≠neas? </font><font style="vertical-align: inherit;">Bajo su cap√≥, se crea un JWTBearerHandler, que ya se ocupa de JWT desde el cliente API.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fs/sx/ce/fssxce2duwjnem0_zgekkezhglm.jpeg" width="550"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interacci√≥n del cliente, la API y el proveedor de tokens cuando se solicita</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cuando JWTBearerHandler recibe el token del cliente, no env√≠a el token al proveedor para su validaci√≥n, sino que, por el contrario, solicita el proveedor de la clave de firma, la parte p√∫blica de la clave con la que se firma el token. En funci√≥n de esta clave, se verifica que el token est√© firmado por el proveedor correcto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dentro de JWTBearerHandler se encuentra HttpClient, que interact√∫a con el proveedor a trav√©s de la red. Pero, si suponemos que la Clave de firma de nuestro proveedor no planea cambiar con frecuencia, puede recogerla una vez que inicie la aplicaci√≥n, guardar en cach√© y deshacerse de las constantes solicitudes de red. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo este c√≥digo para la clave de firma:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthenticationBuilder <span class="hljs-title">AddJwtAuthentication</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> AuthenticationBuilder builder, AuthJwtOptions options</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> signingKeys = <span class="hljs-keyword">new</span> List&lt;SecurityKey&gt;();<font></font>
<font></font>
    <span class="hljs-keyword">var</span> jwtBearerOptions = <span class="hljs-keyword">new</span> JwtBearerOptions {Authority = options?.Authority};<font></font>
    <font></font>
    <span class="hljs-keyword">new</span> JwtBearerPostConfigureOptions().PostConfigure(<span class="hljs-keyword">string</span>.Empty, jwtBearerOptions);
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> config = jwtBearerOptions.ConfigurationManager<font></font>
            .GetConfigurationAsync(<span class="hljs-keyword">new</span> CancellationTokenSource(options?.AuthorityTimeoutInMs ?? <span class="hljs-number">5000</span>).Token)<font></font>
            .GetAwaiter().GetResult();<font></font>
        <span class="hljs-keyword">var</span> providerSigningKeys = config.SigningKeys;<font></font>
        signingKeys.AddRange(providerSigningKeys);<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception)<font></font>
    {<font></font>
        <span class="hljs-comment">// ignored</span><font></font>
    }<font></font>
<font></font>
    builder<font></font>
        .AddJwtBearer(options =&gt;<font></font>
        {<font></font>
            options.TokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters<font></font>
            {<font></font>
                <span class="hljs-comment">// ...</span><font></font>
                IssuerSigningKeys = signingKeys,<font></font>
                <span class="hljs-comment">// ...</span><font></font>
            };<font></font>
        });<font></font>
    <span class="hljs-keyword">return</span> builder;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la l√≠nea 12 nos encontramos con .GetAwaiter (). GetResult (). </font><font style="vertical-align: inherit;">Esto se debe a que AuthenticationBuilder est√° configurado dentro de Public Void ConfigureServices (servicios IServiceCollection) {...} de la clase Startup, y este m√©todo no tiene una versi√≥n asincr√≥nica. </font><font style="vertical-align: inherit;">Problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzando con C # 7.1, tenemos un Main () as√≠ncrono. </font><font style="vertical-align: inherit;">Pero los m√©todos de configuraci√≥n de inicio as√≠ncrono en Asp.NET Core a√∫n no se han entregado. </font><font style="vertical-align: inherit;">Est√©ticamente me molest√≥ escribir GetAwaiter (). GetResult () (¬°Me ense√±aron a no hacer esto!), As√≠ que me conect√© en l√≠nea para buscar c√≥mo otros lidian con este problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetAwaiter (). GetResult () me molesta, pero Microsoft no</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los primeros que encontr√© una opci√≥n que los programadores de Microsoft usaron en una tarea similar para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtener secretos de Azure KeyVault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si atraviesas varias capas de abstracci√≥n, veremos:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Load</span>(<span class="hljs-params"></span>)</span> =&gt; LoadAsync().ConfigureAwait(<span class="hljs-literal">false</span>).GetAwaiter().GetResult();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hola de nuevo, GetAwaiter (). GetResult ()! </font><font style="vertical-align: inherit;">¬øHay alguna otra soluci√≥n? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de un breve google, encontr√© una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serie de excelentes art√≠culos de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Andrew Lock, quien hace un a√±o pens√≥ en el mismo problema que yo. </font><font style="vertical-align: inherit;">Incluso por las mismas razones: est√©ticamente no le gusta invocar sincr√≥nicamente c√≥digo asincr√≥nico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, recomiendo a todos los que est√©n interesados ‚Äã‚Äãen este tema que lean la serie completa de cinco art√≠culos de Andrew. </font><font style="vertical-align: inherit;">All√≠, analiza en detalle qu√© tareas de trabajo conducen a este problema, luego considera varios enfoques incorrectos y solo luego describe las soluciones. </font><font style="vertical-align: inherit;">En mi art√≠culo intentar√© presentar un breve resumen de su investigaci√≥n, concentr√°ndome m√°s en las soluciones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El papel de las tareas asincr√≥nicas al iniciar un servicio web</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da un paso atr√°s para ver la imagen completa. </font><font style="vertical-align: inherit;">¬øCu√°l es el problema conceptual que intent√© resolver, independientemente del marco?</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es necesario iniciar el servicio web para que procese las solicitudes de sus clientes, pero al mismo tiempo hay un conjunto de operaciones (relativamente) largas, sin las cuales el servicio no puede responder al cliente, o sus respuestas ser√°n incorrectas.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplos de tales operaciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Validaci√≥n de configuraciones fuertemente tipadas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llenar el cach√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conexi√≥n preliminar a la base de datos u otros servicios.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT y carga de ensamblaje (servicio de calentamiento).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraci√≥n de bases de datos. </font><font style="vertical-align: inherit;">Este es uno de los ejemplos de Andrew Lock, pero √©l mismo admite que, despu√©s de todo, esta operaci√≥n no es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deseable al iniciar el servicio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustar√≠a encontrar una soluci√≥n que le permita realizar tareas asincr√≥nicas arbitrarias al inicio de la aplicaci√≥n, y de forma natural para ellas, sin GetAwaiter (). GetResult (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estas tareas deben completarse antes de que la aplicaci√≥n comience a aceptar solicitudes, pero para su trabajo pueden necesitar la configuraci√≥n y los servicios registrados de la aplicaci√≥n. </font><font style="vertical-align: inherit;">Por lo tanto, estas tareas deben realizarse despu√©s de la configuraci√≥n DI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta idea se puede representar en forma de diagrama:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/eh/ym/ncehymvjo0cm3yz5p3uq-uycvpq.jpeg"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n n. ¬∞ 1: una soluci√≥n de trabajo que puede confundir a los herederos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera soluci√≥n de trabajo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ofrecida por Lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
{<font></font>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
   {<font></font>
       IWebHost webHost = CreateWebHostBuilder(args).Build();<font></font>
<font></font>
       <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = webHost.Services.CreateScope())<font></font>
       {<font></font>
           <span class="hljs-comment">//   </span>
           <span class="hljs-keyword">var</span> myService = scope.ServiceProvider.GetRequiredService&lt;MyService&gt;();<font></font>
<font></font>
           <span class="hljs-keyword">await</span> myService.DoAsyncJob();<font></font>
       }<font></font>
<font></font>
       <span class="hljs-keyword">await</span> webHost.RunAsync();<font></font>
   }<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWebHostBuilder <span class="hljs-title">CreateWebHostBuilder</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span> =&gt;<font></font>
       WebHost.CreateDefaultBuilder(args)<font></font>
           .UseStartup&lt;Startup&gt;();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque fue posible gracias al advenimiento de Main () as√≠ncrono de C # 7.1. </font><font style="vertical-align: inherit;">Lo √∫nico negativo es que transferimos la parte de configuraci√≥n de Startup.cs a Program.cs. </font><font style="vertical-align: inherit;">Una soluci√≥n no est√°ndar para el marco ASP.NET puede confundir a una persona que heredar√° nuestro c√≥digo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n # 2: incrustar operaciones asincr√≥nicas en DI</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, Andrew propuso una versi√≥n mejorada de la soluci√≥n. </font><font style="vertical-align: inherit;">Se declara una interfaz para tareas asincr√≥nicas:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStartupTask</span><font></font>
{<font></font>
    <span class="hljs-function">Task <span class="hljs-title">ExecuteAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de un m√©todo de extensi√≥n que registra estas tareas en DI:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServiceCollectionExtensions</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IServiceCollection AddStartupTask&lt;T&gt;(<span class="hljs-keyword">this</span> IServiceCollection services)
        <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span>, <span class="hljs-title">IStartupTask</span><font></font>
        =&gt; services.AddTransient&lt;IStartupTask, T&gt;();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, se declara otro m√©todo de extensi√≥n, ya para IWebHost:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StartupTaskWebHostExtensions</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunWithTasksAsync</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IWebHost webHost, CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">//      DI</span>
        <span class="hljs-keyword">var</span> startupTasks = webHost.Services.GetServices&lt;IStartupTask&gt;();<font></font>
<font></font>
        <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> startupTask <span class="hljs-keyword">in</span> startupTasks)<font></font>
        {<font></font>
            <span class="hljs-keyword">await</span> startupTask.ExecuteAsync(cancellationToken);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">await</span> webHost.RunAsync(cancellationToken);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y en Program.cs cambiamos solo una l√≠nea. </font><font style="vertical-align: inherit;">En lugar:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">await</span> CreateWebHostBuilder(args).Build().Run();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosotros llamamos:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">await</span> CreateWebHostBuilder(args).Build().RunWithTasksAsync();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi opini√≥n, un gran enfoque que hace que trabajar con operaciones largas sea lo m√°s transparente posible al iniciar la aplicaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n # 3: para aquellos que cambiaron a ASP.NET Core 3.x</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero si est√° utilizando ASP.NET Core 3.x, entonces hay otra opci√≥n. </font><font style="vertical-align: inherit;">Me referir√© nuevamente a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un art√≠culo de Andrew Lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° el c√≥digo de inicio de WebHost de ASP.NET Core 2.x:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebHost</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ... initial setup</span>
        <span class="hljs-keyword">await</span> Server.StartAsync(hostingApp, cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// Fire IApplicationLifetime.Started</span><font></font>
        _applicationLifetime?.NotifyStarted();<font></font>
<font></font>
        <span class="hljs-comment">// Fire IHostedService.Start</span>
        <span class="hljs-keyword">await</span> _hostedServiceExecutor.StartAsync(cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// ...remaining setup</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el mismo m√©todo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en ASP.NET Core 3.0:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WebHost</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken = <span class="hljs-keyword">default</span></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ... initial setup</span><font></font>
<font></font>
        <span class="hljs-comment">// Fire IHostedService.Start</span>
        <span class="hljs-keyword">await</span> _hostedServiceExecutor.StartAsync(cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// ... more setup</span>
        <span class="hljs-keyword">await</span> Server.StartAsync(hostingApp, cancellationToken).ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
<font></font>
        <span class="hljs-comment">// Fire IApplicationLifetime.Started</span><font></font>
        _applicationLifetime?.NotifyStarted();<font></font>
<font></font>
        <span class="hljs-comment">// ...remaining setup</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ASP.NET Core 3.x, HostedServices se inicia por primera vez, y solo luego el WebHost principal, y anteriormente era exactamente lo contrario. </font><font style="vertical-align: inherit;">¬øQu√© nos da esto? </font><font style="vertical-align: inherit;">Ahora todas las operaciones asincr√≥nicas se pueden invocar dentro del m√©todo StartAsync (CancellationToken) de la interfaz IHostedService y lograr el mismo efecto sin crear interfaces y m√©todos de extensi√≥n separados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n # 4: la historia del chequeo de salud y Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno podr√≠a calmarse con esto, pero hay otro enfoque, y de repente resulta ser importante en las realidades actuales. Este es el uso del chequeo de salud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea b√°sica es iniciar el servidor Kestrel lo antes posible para informar al equilibrador de carga que el servicio est√° listo para aceptar solicitudes. Pero al mismo tiempo, todas las solicitudes de verificaci√≥n que no sean de salud devolver√°n 503 (Servicio no disponible). Hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bastante </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">extenso</font></a><font style="vertical-align: inherit;"> en el sitio de Microsoft </font><font style="vertical-align: inherit;">sobre c√≥mo usar la comprobaci√≥n de estado en ASP.NET Core. Quer√≠a considerar este enfoque sin detalles especiales aplicados a nuestra tarea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andrew Lock tiene un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo separado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para este enfoque. Su principal ventaja es que evita los tiempos de espera de la red.</font></font><br>
<blockquote> ,          ,    ,     .  Kestrel   ,       ,       ¬´   ¬ª.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No dar√© aqu√≠ la soluci√≥n completa de Andrew Lock para el enfoque de verificaci√≥n de salud. Es bastante voluminoso, pero no tiene nada de complicado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te lo dir√© en pocas palabras: debes iniciar el servicio web sin esperar a que finalicen las operaciones asincr√≥nicas. En este caso, el punto final de comprobaci√≥n de estado debe conocer el estado de estas operaciones, emitir 503 mientras se ejecutan y 200 cuando ya se han completado. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Honestamente, cuando estudi√© esta opci√≥n, tuve cierto escepticismo. Toda la soluci√≥n parec√≠a engorrosa en comparaci√≥n con los enfoques anteriores. Y si dibujamos una analog√≠a, entonces esta es la forma de usar nuevamente el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enfoque EAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con la suscripci√≥n de eventos, en lugar de la async / wait ya familiar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero entonces Kubernetes entr√≥ en juego. </font><font style="vertical-align: inherit;">√âl tiene su propio concepto de sonda de preparaci√≥n. </font><font style="vertical-align: inherit;">Citar√© el libro "Kubernetes in Action" en mi presentaci√≥n gratuita:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siempre determine la sonda de preparaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no tiene una sonda de preparaci√≥n, sus pods se convierten en puntos finales de los servicios casi al instante. </font><font style="vertical-align: inherit;">Si su aplicaci√≥n tarda demasiado tiempo en prepararse para aceptar solicitudes entrantes, las solicitudes de los clientes para el servicio tambi√©n podr√°n iniciar pods que a√∫n no est√°n listos para aceptar conexiones entrantes. </font><font style="vertical-align: inherit;">Como resultado, los clientes recibir√°n un error de "Conexi√≥n rechazada".</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realic√© un experimento simple: cre√© un servicio ASP.NET Core 3 con una tarea asincr√≥nica larga en HostedService:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LongTaskHostedService</span> : <span class="hljs-title">IHostedService</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StartAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span><font></font>
    {<font></font>
            Console.WriteLine(<span class="hljs-string">"Long task started..."</span>);
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">5000</span>, cancellationToken);<font></font>
            Console.WriteLine(<span class="hljs-string">"Long task finished."</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">StopAsync</span>(<span class="hljs-params">CancellationToken cancellationToken</span>)</span><font></font>
    {...}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando comenc√© este servicio usando minikube, y luego aument√© el n√∫mero a dos, dentro de los 5 segundos del retraso, cada segundo pedido m√≠o no produjo informaci√≥n √∫til, pero "Conexi√≥n rechazada".</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes 1.16 UPD</font></font></b><div class="spoiler_text">    , ,   Kubernetes 1.16  startup probe (   ).     ,     readiness probe.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>.      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendaciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© conclusi√≥n se puede sacar de todos estos estudios? </font><font style="vertical-align: inherit;">Quiz√°s todos deber√≠an decidir para su proyecto qu√© soluci√≥n es la m√°s adecuada. </font><font style="vertical-align: inherit;">Si se supone que la operaci√≥n asincr√≥nica no tomar√° demasiado tiempo y los clientes tienen alg√∫n tipo de pol√≠tica de reintento, puede usar todos los enfoques, comenzando con GetAwaiter (). GetResult () y terminando con IHostedService en ASP.NET Core 3.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por otro lado, si usa Kubernetes y sus operaciones asincr√≥nicas se pueden realizar durante un tiempo notablemente largo, entonces no puede prescindir de un control de estado (tambi√©n conocido como preparaci√≥n / sonda de inicio).</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496260/index.html">Consejos de ciberseguridad para trabajar desde casa</a></li>
<li><a href="../es496262/index.html">Obtener ID de CVE</a></li>
<li><a href="../es496266/index.html">Coronavirus: ¬ømoriremos todos?</a></li>
<li><a href="../es496268/index.html">Productos y soluciones de red de Huawei Enterprise para clientes empresariales en 2020</a></li>
<li><a href="../es496272/index.html">Privacidad diferencial: comparaci√≥n de bibliotecas</a></li>
<li><a href="../es496302/index.html">C√≥mo no darle su compa√±√≠a a un hacker mientras ella est√° ausente. Consejos para especialistas en COS</a></li>
<li><a href="../es496304/index.html">C√≥mo sigo aprendiendo UE4 mientras hago mi juego</a></li>
<li><a href="../es496308/index.html">Crea mapas de ruido sin interrupciones</a></li>
<li><a href="../es499818/index.html">Uzbek Telegram Marketing</a></li>
<li><a href="../es499820/index.html">Por qu√© elegimos Kotlin como uno de nuestros idiomas de destino. Parte 2: Multiplataforma Kotlin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>