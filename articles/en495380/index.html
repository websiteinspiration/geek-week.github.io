<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèæ üòÄ üö£üèº Great Egyptian Firewall ü§≤üèΩ üôáüèª üë©üèª‚Äçü§ù‚Äçüë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A pandemic is raging in the world, people are buying toilet paper and buckwheat on an industrial scale, and most IT companies are transferring employe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Great Egyptian Firewall</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pandemic is raging in the world, people are buying toilet paper and buckwheat on an industrial scale, and most IT companies are transferring employees to a remote location. </font><font style="vertical-align: inherit;">So did my employer - a German parastatal office.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basically, there were no problems, but one of our employees a month ago, when everything looked still not so scary, I went on vacation to my relatives in Egypt and was safely stuck there because of the border closure. Well, she‚Äôs healthy herself, a working laptop with her - she‚Äôs quarantined herself and works through a VPN. A week works, two ... On the third week, the VPN stopped connecting. The support of the first line checked the commonplace, like a reboot - it did not help. The second line began to diagnose: the connection goes into perpetual timeout at the TLS Handshake stage. Disabled a local firewall - it did not help. We tried another car - it does not work. Another provider does not work. At this point, the support team gave up and joyfully shoved the problem onto me according to the good old principle of ‚Äúthe network manager is to blame.‚Äù</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look in the server logs: he does not see any attempts to reach it after answering the initial packet. Funny and pretty familiar. I called an employee, I was interested in how they deal with human rights in general and freedom of the Internet in particular. He says that things are bad, the Internet is blocking them so that the camels hiccup, and Roskomnadzor nervously smokes on the sidelines. Yeah ... A quick googling shows a bunch of complaints about similar VPN problems in Egypt since 2017. To complete the picture, I ask if the employee has been in the homeland for more than 2 weeks in recent years - no, she says, has not been. The puzzle begins to take shape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We raise a copy of the corporate VPN server on a free white IP - there is no connection. Expected. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We change the port - there is no connection. This is sadder.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We change the protocol - there is no connection. </font><font style="vertical-align: inherit;">The puzzle has developed - in front of us is DPI like a great Chinese firewall. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The employee is sad, the boss plaintively asks, "You are a Russian hacker, do something." </font><font style="vertical-align: inherit;">Well ... Uncover Darknet's heavy artillery and rotate obfsproxy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a server (CentOS 7), it looks like this:</font></font><br>
<br>
<pre><code class="bash hljs">~ sudo pip install virtualenv<font></font>
~ <span class="hljs-built_in">cd</span> /etc/openvpn &amp;&amp; virtualenv venv &amp;&amp; <span class="hljs-built_in">source</span> venv/bin/activate<font></font>
~ sudo pip install obfsproxy<font></font>
~ sudo -u openvpn /etc/openvpn/venv/bin/python /etc/openvpn/venv/bin/obfsproxy obfs3 --dest=127.0.0.1:1194 server 1.2.3.4:49416</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a client (MacOS) like this:</font></font><br>
<br>
<pre><code class="bash hljs">~ brew install pip<font></font>
~ pip install pyopenssl obfsproxy<font></font>
~ obfsproxy obfs3 socks 127.0.0.1:8443</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the OpenVPN config on the client, add:</font></font><br>
<br>
<pre><code class="bash hljs">socks-proxy-retry<font></font>
socks-proxy 127.0.0.1 8443</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Profit </font><font style="vertical-align: inherit;">OpenVPN in obfsproxy wrapper is not detected by local signature detection algorithms, the session takes off, pings go, the traffic runs, the employee is happy. </font><font style="vertical-align: inherit;">It remains only to add the obfsproxy client part to autoload </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúobvious‚Äù way (I hate poppies). </font><font style="vertical-align: inherit;">I say goodbye to our prisoner in relief and write a letter to support in the spirit of "this problem is solved like this, but I can‚Äôt guarantee stability, and you can only use this workaround if there‚Äôs no other way out." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparently, in Egypt there is a place to be especially cunning DPI, which for the first time does not block communication to new subscribers and / or traffic to new hosts, referring those to the conditional category ‚Äútourists‚Äù. </font><font style="vertical-align: inherit;">And after a certain timeout expires, the user is categorized as ‚Äútheir own‚Äù and joyfully cuts traffic to please local kings.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495368/index.html">We self-register for self-walking self-dogs in conditions of self-isolation</a></li>
<li><a href="../en495370/index.html">Public is evil</a></li>
<li><a href="../en495374/index.html">Decorative ceiling light General Lumino 02</a></li>
<li><a href="../en495376/index.html">Quarantine boredom. How to spend the most money in Azure with one click</a></li>
<li><a href="../en495378/index.html">DEFCON 27 Conference. Buttplug: True Penetration Testing. Part 1</a></li>
<li><a href="../en495384/index.html">My internship experience at Microsoft Redmond and getting an offer</a></li>
<li><a href="../en495388/index.html">1970s television show that became an ancestor of eSports</a></li>
<li><a href="../en495390/index.html">STM32CubeMonitor is worth a try</a></li>
<li><a href="../en495392/index.html">How to search for bugs on the front end: 4 main stages</a></li>
<li><a href="../en495396/index.html">First impression of concepts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>