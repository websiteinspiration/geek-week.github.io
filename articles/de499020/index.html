<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆒 🍄 🚊 Eine Studie über ein vages Verhalten 🏇🏼 👨🏿‍🚀 🏂🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Artikel untersucht die möglichen Manifestationen von undefiniertem Verhalten, das in c ++ auftritt, wenn eine nicht leere Funktion abgeschlossen w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Eine Studie über ein vages Verhalten</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499020/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Artikel untersucht die möglichen Manifestationen von undefiniertem Verhalten, das in c ++ auftritt, wenn eine nicht leere Funktion abgeschlossen wird, ohne return mit einem geeigneten Wert aufzurufen. </font><font style="vertical-align: inherit;">Der Artikel ist eher wissenschaftlich und unterhaltsam als praktisch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wer keinen Spaß daran hat, auf einen Rechen zu springen - wir gehen vorbei, wir hören nicht auf.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder weiß, dass Sie bei der Entwicklung von C ++ - Code kein undefiniertes Verhalten zulassen sollten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedoch:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unbestimmtes Verhalten scheint aufgrund der Abstraktheit der möglichen Konsequenzen nicht gefährlich genug zu sein;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist nicht immer klar, wo sich die Linie befindet.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir, die möglichen Manifestationen von undefiniertem Verhalten anzugeben, die in einem ziemlich einfachen Fall auftreten - in einer nicht leeren Funktion gibt es keine Rückkehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berücksichtigen Sie dazu den Code, der von den beliebtesten Compilern in verschiedenen Optimierungsmodi generiert wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Forschung unter Linux wird mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compiler Explorer durchgeführt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Recherche zu Windows und MacOs X - zur Hardware, die mir direkt zur Verfügung steht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Builds werden für x86-x64 durchgeführt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es werden keine Maßnahmen ergriffen, um Compiler-Warnungen / -Fehler zu verbessern oder zu unterdrücken.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird viel zerlegten Code geben. </font><font style="vertical-align: inherit;">Sein Design ist leider bunt, weil </font><font style="vertical-align: inherit;">Ich muss verschiedene Tools verwenden (zumindest habe ich es geschafft, überall Intel-Syntax zu erhalten). </font><font style="vertical-align: inherit;">Ich werde mäßig detaillierte Kommentare zu zerlegtem Code abgeben, die jedoch die Notwendigkeit der Kenntnis der Prozessorregister und der Prinzipien des Stapels nicht beseitigen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standard lesen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 11 endgültiger Entwurf n3797, C ++ 14 endgültiger Entwurf N3936:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.6.3 Die return-Anweisung </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font><font style="vertical-align: inherit;">Das Abfließen </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
am Ende einer Funktion entspricht einer Rückgabe ohne Wert. </font><font style="vertical-align: inherit;">Dies führt zu einem undefinierten </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verhalten in einer Wertrückgabefunktion. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Erreichen des Endes einer Funktion entspricht einer Rückgabe ohne Rückgabewert. </font><font style="vertical-align: inherit;">Für eine Funktion, deren Rückgabewert angegeben ist, führt dies zu undefiniertem Verhalten.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 17 Entwurf n4713</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6.3 Die return-Anweisung </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font><font style="vertical-align: inherit;">Das Abfließen </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
des Endes eines Konstruktors, eines Destruktors oder einer Funktion mit dem Rückgabetyp cv void entspricht einer Rückgabe ohne Operanden. </font><font style="vertical-align: inherit;">Andernfalls führt das Abfließen des Endes einer anderen Funktion als main (6.8.3.1) zu undefiniertem Verhalten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Erreichen des Endes eines Konstruktors, Destruktors oder einer Funktion mit einem ungültigen Rückgabewert (möglicherweise mit const- und flüchtigen Qualifikationsmerkmalen) entspricht einer Rückgabe ohne Rückgabewert. </font><font style="vertical-align: inherit;">Bei allen anderen Funktionen führt dies zu undefiniertem Verhalten (mit Ausnahme der Hauptfunktion).</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was bedeutet das in der Praxis? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Funktionssignatur einen Rückgabewert liefert:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Ausführung sollte mit einer return-Anweisung mit einer Instanz des entsprechenden Typs enden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ansonsten vages Verhalten;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undefiniertes Verhalten beginnt nicht ab dem Moment, in dem die Funktion aufgerufen wird, und nicht ab dem Moment, an dem der zurückgegebene Wert verwendet wird, sondern ab dem Moment, an dem die Funktion nicht ordnungsgemäß abgeschlossen wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die Funktion sowohl korrekte als auch falsche Ausführungspfade enthält, tritt undefiniertes Verhalten nur bei falschen Pfaden auf.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das fragliche undefinierte Verhalten hat keinen Einfluss auf die Ausführung von Anweisungen, die im Hauptteil der Funktion enthalten sind.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Satz über die Hauptfunktion ist in c ++ 17 nicht neu - in früheren Versionen des Standards wurde eine ähnliche Ausnahme in Abschnitt 3.6.1 Hauptfunktion beschrieben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel 1 - bool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In c ++ gibt es keinen Typ mit einem einfacheren Status als bool. </font><font style="vertical-align: inherit;">Beginnen wir mit ihm.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVC generiert für ein solches Beispiel einen C4716-Kompilierungsfehler, sodass der Code für MSVC durch Angabe mindestens eines korrekten Ausführungspfads etwas kompliziert werden muss:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusammenstellung:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plattform</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compiler</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenstellungsergebnis</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 Clang 10.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warnung: Nicht-void-Funktion gibt keinen Wert zurück [-Wreturn-Typ]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 gcc 9.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warnung: Keine return-Anweisung in der Funktion, die nicht ungültig zurückgibt [-Wreturn-Typ]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac OS X</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple Clang Version 11.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warnung: Die Steuerung erreicht das Ende der nicht leeren Funktion [-Treturn-Typ]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC 2019 16.5.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ursprüngliche Beispiel ist Fehler C4716, kompliziert - Warnung C4715: Nicht alle Steuerpfade geben einen Wert zurück</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausführungsergebnisse:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimierung</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmrückgabe</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsolenausgabe</font></font></b></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple Clang Version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0, -O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Originalbeispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Kompliziertes Beispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selbst in diesem einfachsten Beispiel haben vier Compiler mindestens drei Möglichkeiten aufgezeigt, um undefiniertes Verhalten anzuzeigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns herausfinden, was diese Compiler dort kompiliert haben.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/yc/pg/vw/ycpgvw4062ruxbxhec61lpr5oec.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die letzte Anweisung in der Funktion bad () ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beschreibung der Anweisungen aus dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklerhandbuch für Intel 64- und IA-32-Architekturen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>UD2—Undefined Instruction<br>
Generates an invalid opcode exception. This instruction is provided for software testing to explicitly generate an invalid opcode exception. The opcode for this instruction is reserved for this purpose.<br>
Other than raising the invalid opcode exception, this instruction has no effect on processor state or memory.<br>
<br>
Even though it is the execution of the UD2 instruction that causes the invalid opcode exception, the instruction pointer saved by delivery of the exception references the UD2 instruction (and not the following instruction).<br>
<br>
This instruction’s operation is the same in non-64-bit modes and 64-bit mode.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kurz gesagt, dies ist eine spezielle Anweisung zum Auslösen einer Ausnahme. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie müssen den Aufruf von bad () in einen Versuch einschließen ... catch! Block </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Egal wie. </font><font style="vertical-align: inherit;">Dies ist keine C ++ - Ausnahme. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist es möglich, ud2 zur Laufzeit abzufangen? </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter Windows sollte __try dafür verwendet werden, unter Linux und MacOs X der SIGILL-Signalhandler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/qg/al/gl/qgalgl3q6xaqajpp2kdjqxpbp9m.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis der Optimierung hat der Compiler einfach den Hauptteil der bad () - Funktion und ihren Aufruf weggenommen und weggeworfen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/a7/ny/2g/a7ny2ghbcx-bj4a73pqzu_y_eam.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erklärungen (in umgekehrter Reihenfolge, da in diesem Fall die Kette vom Ende aus leichter zu analysieren ist): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Der Ausgabeoperator in stream for bool wird aufgerufen (Zeile 14); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Die Adresse std :: cout wird in das edi-Register gestellt - dies ist das erste Argument des Ausgabeoperators in stream (Zeile 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Der Inhalt des eax-Registers wird in das esi-Register gestellt - dies ist das zweite Argument des Ausgabeoperators im Stream (Zeile 12); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Die drei hohen Bytes von eax werden auf Null zurückgesetzt, der Wert von al ändert sich nicht (Zeile 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Die Funktion bad () heißt (Zeile 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0. Die Funktion bad () sollte den Rückgabewert in das al-Register einfügen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stattdessen zeigt Zeile 4 nop (No Operation, Dummy). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Byte Müll aus dem al-Register wird an die Konsole ausgegeben. </font><font style="vertical-align: inherit;">Das Programm endet normal.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O1, -O2, -O3</font></font></h4><br>
<img src="https://habrastorage.org/webt/dp/sl/yh/dpslyhnvjwxt2c24ifgw6lgpxnu.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Compiler warf alles als Ergebnis der Optimierung.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple klirrte Version 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funktion main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/kl/aw/eyklawd5cgswoa14yg-h8iotxkq.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Pfad des Booleschen Arguments des Ausgabeoperators zum Stream (diesmal in direkter Reihenfolge): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Der Inhalt des al-Registers wird im edx-Register abgelegt (Zeile 8); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Alle Bits des edx-Registers mit Ausnahme des niedrigsten (Zeile 9) werden auf Null gesetzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Ein Zeiger auf std :: cout wird in das rdi-Register gesetzt - dies ist das erste Argument des Ausgabeoperators in stream (Zeile 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Der Inhalt des edx-Registers wird in das esi-Register gestellt - dies ist das zweite Argument für den Ausgabeoperator in stream (Zeile 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Die Ausgabeanweisung wird im Stream für bool aufgerufen (Zeile 13). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Hauptfunktion erwartet, das Ergebnis der Funktion bad () aus dem Register al zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Funktion bad (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v5/tx/1p/v5tx1pohulp-fewcheimnj0wnkk.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Der noch nicht zugewiesene Wert aus dem nächsten Byte des Stapels wird in ein Register gestellt (Zeile 4);</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Alle Bits des al-Registers mit Ausnahme der niedrigstwertigen (Zeile 5) sind ausgenommen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Stück Müll vom nicht zugewiesenen Stapel wird an die Konsole ausgegeben. </font><font style="vertical-align: inherit;">Es kam vor, dass es sich während eines Testlaufs als Null herausstellte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Programm endet normal.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple Clang Version 11.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/zh/mm/t0/zhmmt0z4yvmtiunqa287sdu9lky.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das boolesche Argument des Ausgabeoperators im Stream wird ungültig gemacht (Zeile 5). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Aufruf bad () wurde während der Optimierung ausgelöst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Programm zeigt in der Konsole immer Null an und wird normal beendet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Erweitertes Beispiel, / Od</font></font></h4><br>
<img src="https://habrastorage.org/webt/pb/iz/ku/pbizkuhiff8y37zk6i2ea1qrwb8.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist ersichtlich, dass die Funktion bad () einen Rückgabewert im al-Register liefern sollte. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/ej/zn/auejznebzsjq0n_e4kgtbkfd5ae.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der von der Funktion bad () zurückgegebene Wert wird zuerst auf den Stapel und dann in das edx-Register verschoben, damit die Ausgabe gestreamt werden kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein einzelnes Müllbyte aus dem al-Register wird an die Konsole ausgegeben (wenn etwas genauer, dann das niedrige Byte des Ergebnisses von rand ()). </font><font style="vertical-align: inherit;">Das Programm endet normal.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Kompliziertes Beispiel, / O1, / O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/mk/wr/jy/mkwrjyimc1tfaqfzq_hzuorcaba.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Compiler hat den Aufruf bad () zwangsweise eingefügt. </font><font style="vertical-align: inherit;">Hauptfunktion:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kopiert ein Byte von ebx aus dem Speicher bei [rsp + 30h];</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn rand () Null zurückgibt, kopieren Sie die Einheit von ecx nach ebx (Zeile 11).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kopiert den gleichen Wert nach dl (genauer gesagt das niedrigstwertige Byte) (Zeile 13);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ruft die Ausgabefunktion in stream auf, die den dl-Wert ausgibt (Zeile 14).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Byte Müll aus dem RAM (von der Adresse rsp + 30h) wird an den Stream ausgegeben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Schlussfolgerung von Beispiel 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Ergebnisse der Berücksichtigung von Disassembler-Listen sind in der Tabelle aufgeführt:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimierung</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmrückgabe</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsolenausgabe</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ursache</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Konsolenausgabe und der Aufruf der Funktion bad () wurden als Ergebnis der Optimierung ausgelöst</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus Register al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Konsolenausgabe und der Aufruf der Funktion bad () wurden als Ergebnis der Optimierung ausgelöst</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple Clang Version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Müll aus dem RAM</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionsaufruf bad () durch Null ersetzt</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Originalbeispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Kompliziertes Beispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus Register al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus dem RAM</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sich herausstellte, zeigten die Compiler nicht 3, sondern 6 Varianten undefinierten Verhaltens - kurz bevor wir Disassembler-Listen in Betracht zogen, konnten wir einige davon nicht unterscheiden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel 1a - Verwalten von undefiniertem Verhalten</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir, mit undefiniertem Verhalten ein wenig zu steuern - beeinflussen Sie den Wert, der von der Funktion bad () zurückgegeben wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist nur mit Compilern möglich, die Müll ausgeben. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie dazu die gewünschten Werte an den Stellen aus, an denen die Compiler sie übernehmen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die leere Funktion bad () ändert den Wert von register al nicht, da der aufrufende Code dies erfordert. </font><font style="vertical-align: inherit;">Wenn wir also vor dem Aufruf von bad () einen bestimmten Wert in al setzen, erwarten wir, dass genau dieser Wert als Ergebnis der Ausführung von bad () angezeigt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies kann natürlich durch Aufrufen einer anderen Funktion erfolgen, die bool zurückgibt. </font><font style="vertical-align: inherit;">Es kann aber auch eine Funktion verwendet werden, die beispielsweise nicht gesungenes Zeichen zurückgibt.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodTrue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> rand();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodFalse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> !goodTrue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
    <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    goodTrue();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodFalse();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Beispiel für MSVC gibt die Funktion bad () das Low-Byte des Ergebnisses von rand () zurück. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ohne die Funktion bad () zu ändern, kann externer Code seinen Rückgabewert beeinflussen, indem das Ergebnis von rand () geändert wird.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">control</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> value)</span>
</span>{
    <span class="hljs-keyword">uint32_t</span> count = <span class="hljs-number">0</span>;<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> ((rand() &amp; <span class="hljs-number">0xff</span>) != value) {<font></font>
        ++count;<font></font>
    }<font></font>
<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
        rand();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    control(<span class="hljs-number">1</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">0</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den von der Funktion bad () zurückgegebenen Wert nicht zu beeinflussen, reicht es aus, eine Stapelvariable zu erstellen. </font><font style="vertical-align: inherit;">Damit der darin enthaltene Datensatz während der Optimierung nicht verworfen wurde, sollten Sie ihn als flüchtig markieren.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">85</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">240</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple klirrte Version 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie bad () aufrufen, müssen Sie einen bestimmten Wert in diese Speicherzelle eingeben, der zum Zeitpunkt des Aufrufs von bad () um eins unter dem oberen Rand des Stapels liegt.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putToStack</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> value)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> memory[<span class="hljs-number">1</span>]{value};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    putToStack(<span class="hljs-number">20</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">55</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">0xfe</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">11</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
      -O0,         memory.          ,    .<br>
<br>
   memory      ,   —       ,    ,   .<br>
<br>
   , ..        ,      —   putToStack     .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint passiert zu sein: Es ist möglich, die Ausgabe der Funktion bad () zu ändern, und nur das niederwertige Bit wird berücksichtigt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Schlussfolgerung von Beispiel 1a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Beispiel ermöglichte es, die korrekte Interpretation von Disassembler-Listen zu überprüfen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel 1b - gebrochener Bool</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun, Sie denken daran, "41" wird in der Konsole anstelle von "1" angezeigt ... Ist das gefährlich? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden zwei Compiler überprüfen, die ein ganzes Byte Müll bereitstellen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> badBool1 = bad();
    <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 35 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Undefiniertes Verhalten führte zum Auftreten einer Booleschen Variablen, die mindestens Folgendes zerstört:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vergleichsoperatoren für boolesche Werte;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hash-Funktion des Booleschen Wertes.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">213</span>;
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
  ch = <span class="hljs-number">137</span>;
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Arbeit mit einer beschädigten booleschen Variablen hat sich beim Aktivieren der Optimierung nicht geändert.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
  <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  goodChar(<span class="hljs-number">213</span>);
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
<font></font>
  goodChar(<span class="hljs-number">137</span>);
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgabe an die Konsole:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font><br>
</b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Vergleich zu MSVC hat gcc auch die falsche Operation des Operators not hinzugefügt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Schlussfolgerung von Beispiel 1b</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Unterbrechung grundlegender Operationen mit Booleschen Werten kann schwerwiegende Folgen für die Logik auf hoher Ebene haben. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum ist das geschehen? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weil einige Operationen mit Booleschen Variablen unter der Annahme implementiert werden, dass true ausschließlich eine Einheit ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden dieses Problem im Disassembler nicht berücksichtigen - der Artikel erwies sich als umfangreich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden die Tabelle noch einmal mit dem Verhalten der Compiler verdeutlichen:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimierung</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmrückgabe</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsolenausgabe</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ursache</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folgen der Verwendung des Ergebnisses von bad ()</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Konsolenausgabe und der Aufruf der Funktion bad () wurden als Ergebnis der Optimierung ausgelöst</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus Register al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verletzung der Arbeit: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nicht; </font><font style="vertical-align: inherit;">==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keine Leistung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Konsolenausgabe und der Aufruf der Funktion bad () wurden als Ergebnis der Optimierung ausgelöst</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple Clang Version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein bisschen Müll aus dem RAM</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionsaufruf bad () durch Null ersetzt</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Originalbeispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kein Build</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Kompliziertes Beispiel</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus Register al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verletzung der Arbeit: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Byte Müll aus dem RAM</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verletzung der Arbeit: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vier Compiler gaben 7 verschiedene Manifestationen von undefiniertem Verhalten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel 2 - Struktur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nehmen wir ein etwas komplizierteres Beispiel:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Erstellung der Teststruktur ist ein einzelner Parameter vom Typ int erforderlich. </font><font style="vertical-align: inherit;">Diagnosemeldungen werden von seinem Konstruktor und Destruktor ausgegeben. </font><font style="vertical-align: inherit;">Die Funktion bad (int) verfügt über zwei gültige Ausführungspfade, von denen keiner in einem einzigen Aufruf implementiert wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diesmal - zuerst die Tabelle, dann die Disassembler-Analyse für dunkle Punkte.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimierung</font></font></b></td>
<td><b>Program return</b></td>
<td><b>Console output</b></td>
<td><b></b></td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 Clang 10.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>255</td>
<td>rnd: 1804289383</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 gcc 9.3</b></td>
</tr>
<tr>
<td>-O0</td>
<td>0</td>
<td>rnd: 1804289383<br>
4198608<br>
Test::~Test()</td>
<td>nop       .<br>
value    .</td>
</tr>
<tr>
<td>-O1, -O2, -O3</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>macOs X Apple clang version 11.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>The program has unexpectedly finished.</td>
<td>rnd: 16807</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 16807<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Windows MSVC 2019 16.5.4</b></td>
</tr>
<tr>
<td>/Od /RTCs</td>
<td>Access violation reading location 0x00000000CCCCCCCC</td>
<td>rnd: 41</td>
<td>  MSVC stack frame run-time error checking</td>
</tr>
<tr>
<td>/Od, /O1, /O2</td>
<td>0</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791061810776 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Müll von einem Speicherort, dessen Adresse in rax ist</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wieder sehen wir viele Optionen: Zusätzlich zu dem bereits bekannten ud2 gibt es mindestens 4 verschiedene Verhaltensweisen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Compilerhandling mit einem Konstruktor ist sehr interessant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In einigen Fällen wurde die Ausführung fortgesetzt, ohne den Konstruktor aufzurufen. In diesem Fall befand sich das Objekt in einem zufälligen Zustand.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In anderen Fällen war auf dem Ausführungspfad kein Konstruktoraufruf vorgesehen, was ziemlich seltsam ist.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/z7/cq/ry/z7cqry23rk0ul156zrdhnedehl0.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Code wird nur ein Vergleich durchgeführt (Zeile 14), und es gibt nur einen bedingten Sprung (Zeile 15). </font><font style="vertical-align: inherit;">Der Compiler ignorierte den zweiten Vergleich und den zweiten bedingten Sprung. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies führt zu dem Verdacht, dass unbestimmtes Verhalten früher begann, als es der Standard vorschreibt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Überprüfen des Zustands der Sekunde, wenn es keine Nebenwirkungen enthält, und die Compilerlogik funktionierten wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die zweite Bedingung erfüllt ist, müssen Sie den Konstruktor Test mit dem Argument 142 aufrufen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die zweite Bedingung nicht erfüllt ist, wird die Funktion beendet, ohne einen Wert zurückzugeben. Dies bedeutet ein undefiniertes Verhalten, bei dem der Compiler alles tun kann. </font><font style="vertical-align: inherit;">Einschließen - denselben Konstruktor mit demselben Argument aufrufen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Überprüfung ist überflüssig. Der Testkonstruktor mit dem Argument 142 kann aufgerufen werden, ohne die Bedingung zu überprüfen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, was passiert, wenn die zweite Prüfung eine Bedingung mit Nebenwirkungen enthält:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<img src="https://habrastorage.org/webt/j5/mi/-w/j5mi-w148l3tnejie9aaxus5nr8.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Compiler reproduzierte ehrlich alle beabsichtigten Nebenwirkungen, indem er rand () (Zeile 16) aufrief, wodurch Zweifel an dem unangemessen frühen Beginn eines undefinierten Verhaltens zerstreut wurden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Option / RTCs aktiviert die Fehlerprüfung zur Laufzeit des Stapelrahmens. Diese Option ist nur in der Debug-Assembly verfügbar. Betrachten Sie den disassemblierten Code des main () -Segments: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/sr/4y/klsr4ygrimmzxwbwuqtvfd3xvmy.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor dem Aufruf von bad (int) (Zeile 4) werden die Argumente vorbereitet - der Wert der rnd-Variablen wird in das edx-Register (Zeile 2) kopiert und die effektive Adresse einer lokalen Variablen an der Adresse wird in das rcx-Register geladen rsp + 28h (Zeile 3). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vermutlich ist rsp + 28 die Adresse einer temporären Variablen, die das Ergebnis des Aufrufs von bad (int) speichert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Annahme wird durch die Zeilen 19 und 20 bestätigt - die effektive Adresse derselben Variablen wird in rcx geladen, wonach der Destruktor aufgerufen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Intervall der Zeilen 4 bis 18 wird jedoch trotz der Ausgabe des Werts des zu streamenden Datenfelds nicht auf diese Variable zugegriffen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir aus früheren MSVC-Listen gesehen haben, sollte das Argument für den Stream-Ausgabeoperator im rdx-Register erwartet werden. </font><font style="vertical-align: inherit;">Das rdx-Register erhält das Ergebnis der Dereferenzierung der in rax befindlichen Adresse (Zeile 9). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher erwartet der aufrufende Code von bad (int):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausfüllen einer Variablen, deren Adresse durch das rcx-Register geleitet wird (hier sehen wir RVO in Aktion);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rückgabe der Adresse dieser Variablen über das Rax-Register.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fahren wir mit der Auflistung von bad (int) fort:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c3/vm/-x/c3vm-xwuhghbvtp6byyqwf6l6xg.png" alt="Bild"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In eax wird der Wert 0xCCCCCCCC eingegeben, den wir in der Zugriffsverletzungsnachricht (Zeile 9) gesehen haben (beachten Sie, dass es nur 4 Bytes sind, während in der AccessViolation-Nachricht die Adresse aus 8 Bytes besteht).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Befehl rep stos wird aufgerufen und führt 0xC-Zyklen aus, in denen der Inhalt von eax ausgehend von der Adresse rdi (Zeile 10) in den Speicher geschrieben wird. </font><font style="vertical-align: inherit;">Dies sind 48 Bytes - genau so viel, wie auf dem Stapel in Zeile 6 zugewiesen ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf den korrekten Ausführungspfaden wird der Wert von rsp + 40h in rax eingegeben (Zeilen 23, 36);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Wert des rcx-Registers (durch das main () die Zieladresse übergeben hat) wird bei rsp + 8 (Zeile 4) auf den Stapel geschoben;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdi wird auf den Stapel geschoben, wodurch rsp um 8 reduziert wird (Zeile 5);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30h Bytes werden auf dem Stapel durch Verringern von rsp zugewiesen (Zeile 6).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also sind rsp + 8 in Zeile 4 und rsp + 40h im Rest des Codes der gleiche Wert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Code ist eher verwirrend als </font><font style="vertical-align: inherit;">es wird kein rbp verwendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Meldung "Zugriffsverletzung" enthält zwei Unfälle:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nullen im oberen Teil der Adresse - es könnte Müll geben;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Adresse hat sich versehentlich als falsch herausgestellt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anscheinend ermöglichte die Option / RTCs das Überschreiben von Stapeln mit bestimmten Werten ungleich Null, und die Meldung "Zugriffsverletzung" war nur ein zufälliger Nebeneffekt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, wie sich der Code mit aktivierter Option / RTCs vom Code ohne unterscheidet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ai/gh/r4aighkarr9kdcerpk60u6jvdya.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Paketcode main () unterscheidet sich nur in den Adressen der lokalen Variablen auf dem Stapel. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/oi/zt/kqoizt0khccfqovtmw6qn_--xiq.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(Aus Gründen der Übersichtlichkeit habe ich zwei Versionen der Funktion bad (int) nebeneinander gestellt - mit / ohne / RTCs.) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ohne / RTCs verschwand die Anweisung rep stos und bereitete zu Beginn der Funktion Argumente dafür vor.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel 2a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen Sie erneut, unbestimmtes Verhalten zu kontrollieren. </font><font style="vertical-align: inherit;">Diesmal für nur einen Compiler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit der Option / RTCs fügt der Compiler am Anfang der Funktion bad (int) Code ein, der die untere Hälfte von rax mit einem festen Wert auffüllt, was zu einer Zugriffsverletzung führen kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dieses Verhalten zu ändern, füllen Sie rax einfach mit einer gültigen Adresse. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies kann mit einer sehr einfachen Modifikation erreicht werden: Fügen Sie die Ausgabe von etwas zu std :: cout zum fehlerhaften (int) body hinzu.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständiger Beispielcode</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; v &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791039331928 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Operator &lt;&lt; gibt einen Link zum Stream zurück, der implementiert wird, indem die Adresse std :: cout in rax platziert wird. </font><font style="vertical-align: inherit;">Die Adresse ist korrekt, sie kann dereferenziert werden. </font><font style="vertical-align: inherit;">Zugriffsverletzung wird verhindert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anhand der einfachsten Beispiele konnten wir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sammeln Sie ungefähr 10 verschiedene Manifestationen unbestimmten Verhaltens.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erfahren Sie im Detail genau, wie diese Optionen ausgeführt werden.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Compiler zeigten die strikte Einhaltung des Standards - in keinem Beispiel begann das unbestimmte Verhalten früher als erwartet. </font><font style="vertical-align: inherit;">Sie können Compiler-Entwicklern jedoch keine Fantasie verweigern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oft hängt die Manifestation von subtilen Nuancen ab: Es lohnt sich, eine scheinbar irrelevante Codezeile hinzuzufügen oder zu entfernen - und das Verhalten des Programms ändert sich erheblich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Offensichtlich ist es einfacher, solchen Code nicht zu schreiben, als später Rätsel zu lösen.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499008/index.html">Warum Entwickler so langsam sind: häufige Probleme und ihre Lösungen</a></li>
<li><a href="../de499010/index.html">Wir untersuchen die Mediastreamer2 VoIP-Engine. Teil 11</a></li>
<li><a href="../de499014/index.html">23 schwierige Fragen für JavaScript-Interviews</a></li>
<li><a href="../de499016/index.html">Integration mit ESIA für .Net: einfacher als es sich anhört</a></li>
<li><a href="../de499018/index.html">6 Heimsport-Apps</a></li>
<li><a href="../de499030/index.html">Überwachung der MySQL-Leistung für Grafana auf isic in 20 Minuten</a></li>
<li><a href="../de499032/index.html">Verwendung von Prometheus zum Erkennen von Anomalien in GitLab</a></li>
<li><a href="../de499034/index.html">Wie kann man gefährliches Refactoring einführen, um mit einer Million Benutzern zu arbeiten?</a></li>
<li><a href="../de499036/index.html">Arbeit des Anbieters: eine Auswahl von Materialien zu Protokollen, IT und Netzwerkinfrastruktur</a></li>
<li><a href="../de499038/index.html">Meine Erfahrung mit einem vertikalen Monitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>