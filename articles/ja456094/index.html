<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•‰ï¸ â“ âš–ï¸ ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ2ã‚’èª­ã‚€ï¼šSTM32ä¸Šã®SPIã€‚STM8ã®PWMã‚¿ã‚¤ãƒãƒ¼ã¨å‰²ã‚Šè¾¼ã¿ â© ğŸ’ ğŸš¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã§ã¯æœ€åˆã®éƒ¨åˆ†ã€ç§ã¯Arduinoã®ãƒ‘ãƒ³ãƒ„ã©ã®ã‚ˆã†ã«ã€ãªãœå½¼ã‚‰ã¯ãƒã‚¤ã‚¯ãƒ­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŠã‚ˆã³ãã®ä»–ã®æ–‡æ›¸ã‚’ãŠèª­ã¿ãã ã•ã„ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸé›»å­æ„›å¥½å®¶ã‚’æ•™ãˆã¦ã¿ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆãŒå¤§ãããªã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã®ã§ã€åˆ¥ã®è¨˜äº‹ã§å®Ÿéš›ã®ä¾‹ã‚’ç¤ºã™ã“ã¨ã‚’ç´„æŸã—ã¾ã—ãŸã€‚ã•ã¦ã€å½¼ã¯è‡ªåˆ†ã‚’è²¨ç‰©ã¨å‘¼ã³ã¾ã—ãŸ...
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ2ã‚’èª­ã‚€ï¼šSTM32ä¸Šã®SPIã€‚STM8ã®PWMã‚¿ã‚¤ãƒãƒ¼ã¨å‰²ã‚Šè¾¼ã¿</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/456094/"><p><img src="https://habrastorage.org/webt/zz/sh/fd/zzshfdfytuphbmlregcazfpxo2a.jpeg"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åˆã®éƒ¨åˆ†ã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç§ã¯Arduinoã®ãƒ‘ãƒ³ãƒ„ã©ã®ã‚ˆã†ã«ã€ãªãœå½¼ã‚‰ã¯ãƒã‚¤ã‚¯ãƒ­ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŠã‚ˆã³ãã®ä»–ã®æ–‡æ›¸ã‚’ãŠèª­ã¿ãã ã•ã„ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸé›»å­æ„›å¥½å®¶ã‚’æ•™ãˆã¦ã¿ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãƒ†ã‚­ã‚¹ãƒˆãŒå¤§ãããªã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã®ã§ã€åˆ¥ã®è¨˜äº‹ã§å®Ÿéš›ã®ä¾‹ã‚’ç¤ºã™ã“ã¨ã‚’ç´„æŸã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã•ã¦ã€å½¼ã¯è‡ªåˆ†ã‚’è²¨ç‰©ã¨å‘¼ã³ã¾ã—ãŸ...</font></font></p><br>
<p>  ,       ,         STM32 (Blue Pill)  STM8.  -    ,       ,       .</p><a name="habracut"></a><br>
<p>   ,     :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">STM32 Blue Pill: 16    DM634</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">STM8:    </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">STM8: 8 RGB-   , </a></p><br>
<p><em>:   ,       ,        .   ,          .    -  ,        ,         -           .</em></p><br>
<p><em>    â€” ,   ,          .    ,         .</em></p><br>
<p><em>,     -      .</em></p><br>
<h1 id="stm32">STM32</h1><br>
<h1 id="16-svetodiodov-c-dm634-i-spi">16  c DM634  SPI</h1><br>
<p>    Blue Pill (STM32F103C8T6)    DM634.      , IO- STM   SPI.</p><br>
<h2 id="dm634">DM634</h2><br>
<p>   16- 16- -,    .  12-      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Lightpack</a>.   ,   DM63x    TLC5940,   DM   : 1) TLC    ,   â€“ ; 2)  DM      ; 3)       ,      .  , ,      ,     .        SSOP24,     .</p><br>
<p>  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>      ,  ,  .     (<em>Pin Connection</em>),  ,     ,    (<em>Pin Description</em>). 16 :</p><br>
<p><img src="https://habrastorage.org/webt/uj/n8/mo/ujn8mooelrxoxg7xzvvfsdh4er8.png"><br>
<sup>     ( )</sup></p><br>
<p><strong>Sink</strong> / <strong>Open-drain output</strong> â€“ ;   ; ,      , â€“     .  , ,   Â« Â» (<em>open drain</em>),            .</p><br>
<p><img src="https://habrastorage.org/webt/yk/bq/p4/ykbqp4ivabirkgahd2d7l_9gjny.png"><br>
<sup>    REXT  GND     </sup></p><br>
<p>  REXT     ,    , .   . 9 .  DM634      ,    (<em>global brightness</em>);        ,      2.2 â€“ 3 .</p><br>
<p> ,   ,     :</p><br>
<p><img src="https://habrastorage.org/webt/7s/5n/to/7s5ntogguqr1yb6fu2l5pchaob8.png"></p><br>
<p>,  ,     .   ,    ,     â€“ ,         TLC5940:</p><br>
<p><img src="https://habrastorage.org/webt/qi/za/j2/qizaj2wq08ppbzehiszsd2spqz8.png"><br>
<sub>â€¦         .    SCLK     SIN   .  ,    ,    XLAT       .   â€“     XLAT .      .</sub></p><br>
<p><strong>Latch</strong> â€“ //.<br>
<strong>Rising edge</strong> â€“   <br>
<strong>MSB first</strong> â€“  ( )  .<br>
<strong>to clock data</strong> â€“    ().</p><br>
<p> <em>latch</em>         ,      </p><div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text">LED- â€“    . Â«Â» (<em>shift</em>)   â€“     :           .           ,     ,     (<em>latch</em>) â€“    ,      .   ,  ,    ,   .  <em>latch</em>         ,       .</div></div><br>
<p>,    DM634  :   DAI      ,  DCK -;   DAI    ,  DCK;   ,       (<em>clocked in</em>),    LAT.     (<em>bit-bang</em>),         SPI,      STM32   .</p><br>
<h2 id="sinyaya-tabletka-stm32f103">  STM32F103</h2><br>
<p>:  STM32 â€“   Atmega328,   .             ,     8    .  ,  STM  ,    Â«Â» 72 ,      IDE     ,      ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">,   </a>).     .</p><br>
<p>:  Blue Pill    STM32F103C8T6,      :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Data Sheet</a>   STM32F103x8  STM32F103xB;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Reference Manual</a>    STM32F103   .</li>
</ul><br>
<p>     :</p><br>
<ul>
<li>Pinouts â€“   â€“   ,      ;</li>
<li>Memory Map â€“     .  Reference Manual     ,    ,    .</li>
<li> Pin Definitions â€“      ;  Â« Â»             .    Blue Pill pinout       :</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/_q/q_/o4/_qq_o4hwzc3k1nzqluqtaqpuye0.png"><br>
<em>NB:      ,   ,   .  ,    â€”      .</em></p><br>
<p> ,  Reference Manual,    .<br>
 :    /,  SPI,   .</p><br>
<h3 id="vvod-vyvod">-</h3><br>
<p> Atmega328 -   , -    STM32    .     ,      :</p><br>
<p><img src="https://habrastorage.org/webt/qv/ao/t6/qvaot6ql0b4z6c0bvv71dumovji.png"><br>
<sub>    ,  Â«-Â»,  Â«-Â»,   </sub></p><br>
<p>Â«-Â» (<em>push-pull</em>) â€“    ,      HIGH,  LOW.    Â« Â»  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,       :</p><br>
<p><img src="https://habrastorage.org/webt/qa/e-/al/qae-alom88ushdmghd8wcu2l0q4.png"><br>
<img src="https://habrastorage.org/webt/en/oh/ny/enohnyxpb5u8cs4_t_m-cmtxbwy.png"><br>
<sub>   /     : /   : / â€“   : Â«0Â»     N-MOS, Â«1Â»        Hi-Z (P-MOS  ) / â€“  Â«-Â»: Â«0Â»     N-MOS, Â«1Â»     P-MOS.</sub></p><br>
<p>    (<em>open drain</em>)  Â«-Â» (<em>push-pull</em>)   ,         HIGH:             (<em>high impedance</em>, <em>Hi-Z</em>).          ,  ,   .</p><br>
<p>         .  Â«Â»     (. 9.1.4):</p><br>
<p><img src="https://habrastorage.org/webt/wu/mz/fv/wumzfvlk-fueikoig1wg6npj59u.png"><br>
<sub>        ,   ,       </sub></p><br>
<p>      <em>Pin Definitions</em>      .  ,  ,      ,     :</p><br>
<p><img src="https://habrastorage.org/webt/g1/hq/mi/g1hqmixkcdtdiius8u45hjfzagy.png"><br>
<sub>          ,             ,        (   RCC). </sub></p><br>
<p>,         .     ,         .</p><br>
<p>:   SPI, ,   (     )   Â«  -Â»,    (LAT) â€“ Â« -Â».  ,   ,   SPI.</p><br>
<h3 id="spi">SPI</h3><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>SPI  Serial Peripherial Interface (  ) â€“               .      , ,    LED- ( reference manual   25). SPI      (Â«Â»)   (Â«Â»).  SPI    ,       :</p><br>
<ul>
<li>MOSI, Master Output / Slave Input:      ,      ;</li>
<li>MISO, Master Input / Slave Output: ,   ,   â€“ ;</li>
<li>SCK, Serial Clock:            .  ,  ;</li>
<li>SS, Slave Select:      ,    - .  STM32  NSS,  N = negative, ..   ,     .     Open Drain Output,    .</li>
</ul></div></div><br>
<p>   , SPI  STM32  ,     . ,      SPI,   I2S-,       ,    .      :     ,   MOSI  SCK.    25.3.4 (half-duplex communication,  ),   <em>1 clock and 1 unidirectional data wire</em> (1    1   ):</p><br>
<p><img src="https://habrastorage.org/webt/3o/wg/pm/3owgpmokhpahr9rkftf5ns2lclw.png"><br>
<sub>      SPI     ,   . /       :      (MOSI     MISO   ),    (MISO  MOSI )      -.        Rx (  ,     ).</sub></p><br>
<p>,  MISO   ,     LAT.   Slave Select,   STM32   ,   .     25.3.1 SPI General Description:</p><br>
<p><img src="https://habrastorage.org/webt/8t/ng/jf/8tngjfopfxskwyq_gl8tlogcp2o.png"><br>
<sub>  NSS (SSM = 1) /        SSI  SPI_CR1.   NSS      .</sub></p><br>
<p>   .    SPI2,       â€“   3.3 Memory Map ( ):</p><br>
<p><img src="https://habrastorage.org/webt/os/xd/6p/osxd6pdv5zfwombf5xflzfikj5c.png"></p><br>
<p>  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _SPI2_(mem_offset) (*(volatile uint32_t *)(0x40003800 + (mem_offset)))</span></code></pre><br>
<p>  25.3.3    Â« SPI   Â»:</p><br>
<p><img src="https://habrastorage.org/webt/s8/ah/o5/s8aho5pbdv55j5vhhwecvewrm3m.png"></p><br>
<p><strong>1.       BR[2:0]   SPI_CR1.</strong></p><br>
<p>     reference manual.   (<em>Address offset</em>)  CR1 â€“ 0x00,      (<em>Reset value</em> 0x0000):</p><br>
<p><img src="https://habrastorage.org/webt/vt/46/um/vt46umrvbimjon75durupo3zsao.png"></p><br>
<p> BR     ,    ,     SPI.  STM32    72 , LED-,   ,     25 ,  ,     (BR[2:0] = 001).</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _SPI_CR1 0x00</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BR_0        0x0008</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BR_1        0x0010</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BR_2        0x0020</span><font></font>
<font></font>
_SPI2_ (_SPI_CR1) |= BR_0;<span class="hljs-comment">// pclk/4</span></code></pre><br>
<p><strong>2.   CPOL  CPHA,           (.    240)</strong></p><br>
<p>    ,    ,       CPOL  CPHA  . 704 (SPI General Description):</p><br>
<p><img src="https://habrastorage.org/webt/2h/pj/in/2hpjinoa65388hdfarcc9lwnqok.png"><br>
<sub>    <br>
   CPOL  CPHA  SPI_CR1       .  CPOL (  )    ,    .       .  CPOL ,  SCK       .   CPOL ,  SCK       .<br>
   CPHA (  ), -       SCK (,  CPOL ,  ,  CPOL ).       .   CPHA , -       SCK (,  CPOL ,  ,  CPOL ).       .</sub></p><br>
<p>   ,   ,      , ..  ,   SCK  ,   ,        (. <em>Rising Edge</em>   DM634).</p><br>
<p>,          ST:    Â«   Â» â€“  <em>to reset a bit</em>,   <em>to clear a bit</em>, , ,  .</p><br>
<p><strong>3.   DFF   8-  16-   </strong></p><br>
<p>   16- DM634,      12-  ,   DM633. DFF     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DFF         0x0800</span><font></font>
<font></font>
_SPI2_ (_SPI_CR1) |= DFF; <span class="hljs-comment">// 16-bit mode</span></code></pre><br>
<p><strong>4.   LSBFIRST   SPI_CR1    </strong></p><br>
<p>LSBFIRST,     ,     .  DM634   ,    .   .</p><br>
<p><strong>5.   ,      NSS,    NSS        .    NSS   SSM  SSI   SPI_CR1.   NSS    ,     SSOE.</strong></p><br>
<p> SSM  SSI,      NSS:</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SSI         0x0100</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SSM         0x0200</span><font></font>
<font></font>
_SPI2_ (_SPI_CR1) |= SSM | SSI; <span class="hljs-comment">//enable software control of SS, SS high</span></code></pre><br>
<p><strong>6.     MSTR  SPE (      NSS   )</strong></p><br>
<p>,      SPI    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSTR        0x0004</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPE         0x0040</span><font></font>
<font></font>
_SPI2_ (_SPI_CR1) |= MSTR; <span class="hljs-comment">//SPI master</span>
<span class="hljs-comment">//  ,  SPI</span>
_SPI2_ (_SPI_CR1) |= SPE;</code></pre><br>
<p>SPI ,    ,   .   25.3.3 Â« SPI   Â»:</p><br>
<p><img src="https://habrastorage.org/webt/sb/rg/u5/sbrgu5xwvaj7vc8a9rk2guxfdeq.png"><br>
<sub>  <br>
     Tx  .<br>
       <strong></strong>  (  )     ,     <strong></strong>   MOSI,           LSBFIRST   CPI_CR1.  TXE     <strong>  Tx   </strong>,    ,    TXEIE   CPI_CR1.</sub></p><br>
<p>     ,        SPI   STM.    TXE (<em>Tx Empty</em>, Tx     )    ,     <em></em>.       ,        .        (),     , TXE   ,    .  , ..    LED-     LAT   <em></em> , ..   TXE   .</p><br>
<p>  ,     - .   25.3.7 â€“ Â« Â»:</p><br>
<p><img src="https://habrastorage.org/webt/_d/vn/jj/_dvnjjudvkmdyutpylvwfkfknng.png"><br>
&lt;...&gt;<br>
<img src="https://habrastorage.org/webt/3y/wv/nd/3ywvndaij5blabzqfq2n6wzdbfe.png"><br>
<sub> BUSY<br>
 BSY     (       ).  BSY     SPI.<br>
 :<br>
   (  ,   )<br>
 SPI <br>
     (MODF=1)<br>
   ,  BSY     </sub></p><br>
<p>, . ,    Tx.    Â«  SPIÂ»:</p><br>
<p><img src="https://habrastorage.org/webt/sj/gk/o7/sjgko7dcnefgkio4jk9xrwt67bs.png"><br>
<sub>  15:0 DR[15:0]  <br>
     .<br>
      â€“    ( )     ( ).        Tx,       ,    Rx.</sub></p><br>
<p>   ,    TXE  BSY:</p><br>
<p><img src="https://habrastorage.org/webt/-k/pi/q9/-kpiq96tkpbqvvr1vly6nlzpwoe.png"></p><br>
<p>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _SPI_DR  0x0C</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _SPI_SR  0x08</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BSY         0x0080</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TXE         0x0002</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dm_shift16</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> value)</span>
</span>{<font></font>
    _SPI2_(_SPI_DR) = value; <span class="hljs-comment">//send 2 bytes</span>
    <span class="hljs-keyword">while</span> (!(_SPI2_(_SPI_SR) &amp; TXE)); <span class="hljs-comment">//wait until they're sent</span>
}</code></pre><br>
<p>      16    ,    LED-,  - :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendLEDdata</span><span class="hljs-params">()</span>
</span>{<font></font>
    LAT_low();<font></font>
    <span class="hljs-keyword">uint8_t</span> k = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">do</span><font></font>
    {   k--;<font></font>
        dm_shift16(leds[k]);<font></font>
    } <span class="hljs-keyword">while</span> (k);<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (_SPI2_(_SPI_SR) &amp; BSY); <span class="hljs-comment">// finish transmission</span><font></font>
<font></font>
    LAT_pulse();<font></font>
}</code></pre><br>
<p>       LAT,    I/O.</p><br>
<h3 id="naznachaem-piny"> </h3><br>
<p> STM32F1 ,    ,  . ,   ,   ,         STM.  9.1   GPIO:</p><br>
<p><img src="https://habrastorage.org/webt/ky/w9/ks/kyw9ksdar6bepxsf1u7kvyejfwm.png"><br>
<sub>    /   <em>(GPIO)</em>   32-   (GPIOx_CRL  GPIOx_CRH),  32-   (GPIOx_IDR  GPIOx_ODR), 32-  / (GPIOx_BSRR), 16-   (GPIOx_BRR)  32-   (GPIOx_LCKR).</sub></p><br>
<p>,    ,    ,   16        Â«    Â». ..        CRL,   â€“  CRH.             â€“    Â«Â».</p><br>
<p>     .</p><br>
<p>    .</p><br>
<p>      ,     :      BSRR,   16      ,   â€“   1,    BRR,  16     .     .    ,      :</p><br>
<p><img src="https://habrastorage.org/webt/tr/g9/tq/trg9tqg8ksmhfiaokjbslfvvhny.png"><br>
<img src="https://habrastorage.org/webt/yb/dm/da/ybdmdaayb-f0np1pawunxobfbaa.png"><br>
<sub>    <br>
      GPIOx_ODR   :           APB2.    Â«1Â»   / (GPIOx_BSRR ,   ,  GPIOx_BRR) ,   .    .</sub></p><br>
<p>      â€“ IDR = <em>Input</em> Direction Register,  ; ODR = <em>Output</em> Direction Register,  .       .</p><br>
<p> , ,  .      SPI,   PB13, PB14  PB15,    CRH:</p><br>
<p><img src="https://habrastorage.org/webt/ei/_v/it/ei_vitm85yhwasuf5zjbhksfsoq.png"></p><br>
<p> ,    -     20-  31-.</p><br>
<p>     ,     ,      ,  ,  MODE   (,      0)    (  50MHz, ..    Â«1Â»),  CNF  :  Â«-Â» â€“ 00, Â«Â» â€“ 10.  ,    ,        (CNF0),      <em>floating input</em>.</p><br>
<p>   -     ,         MODE  CNF   ,      .</p><br>
<div class="spoiler"><b class="spoiler_title">  - </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF0_0 0x00000004</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF0_1 0x00000008</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF1_0 0x00000040</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF1_1 0x00000080</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF2_0 0x00000400</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF2_1 0x00000800</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF3_0 0x00004000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF3_1 0x00008000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF4_0 0x00040000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF4_1 0x00080000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF5_0 0x00400000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF5_1 0x00800000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF6_0 0x04000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF6_1 0x08000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF7_0 0x40000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF7_1 0x80000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF8_0 0x00000004</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF8_1 0x00000008</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF9_0 0x00000040</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF9_1 0x00000080</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF10_0 0x00000400</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF10_1 0x00000800</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF11_0 0x00004000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF11_1 0x00008000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF12_0 0x00040000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF12_1 0x00080000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF13_0 0x00400000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF13_1 0x00800000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF14_0 0x04000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF14_1 0x08000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF15_0 0x40000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNF15_1 0x80000000</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE0_0 0x00000001</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE0_1 0x00000002</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE1_0 0x00000010</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE1_1 0x00000020</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE2_0 0x00000100</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE2_1 0x00000200</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE3_0 0x00001000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE3_1 0x00002000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE4_0 0x00010000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE4_1 0x00020000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE5_0 0x00100000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE5_1 0x00200000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE6_0 0x01000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE6_1 0x02000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE7_0 0x10000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE7_1 0x20000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE8_0 0x00000001</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE8_1 0x00000002</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE9_0 0x00000010</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE9_1 0x00000020</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE10_0 0x00000100</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE10_1 0x00000200</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE11_0 0x00001000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE11_1 0x00002000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE12_0 0x00010000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE12_1 0x00020000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE13_0 0x00100000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE13_1 0x00200000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE14_0 0x01000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE14_1 0x02000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE15_0 0x10000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MODE15_1 0x20000000</span></code></pre></div></div><br>
<p>     B (  â€“ 0x40010C00), :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _PORTB_(mem_offset) (*(volatile uint32_t *)(0x40010C00 + (mem_offset)))</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _BRR  0x14</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _BSRR 0x10</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRL  0x00</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRH  0x04</span><font></font>
<font></font>
<span class="hljs-comment">//  SPI2: MOSI  B15, CLK  B13</span>
<span class="hljs-comment">//LAT     MISO â€“ B14</span><font></font>
<font></font>
<span class="hljs-comment">//  ,     </span><font></font>
_PORTB_ (_CRH) &amp;= ~(CNF15_0 | CNF14_0 | CNF13_0 | CNF12_0);<font></font>
<font></font>
<span class="hljs-comment">//   MOSI  SCK</span><font></font>
_PORTB_ (_CRH) |= CNF15_1 | CNF13_1;<font></font>
<font></font>
<span class="hljs-comment">//50 , MODE = 11</span>
_PORTB_ (_CRH) |= MODE15_1 | MODE15_0 | MODE14_1 | MODE14_0 | MODE13_1 | MODE13_0;</code></pre><br>
<p>, ,     LAT,     BRR  BSRR:</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*** LAT pulse â€“ high, then low */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LAT_pulse() _PORTB_(_BSRR) = (1&lt;&lt;14); _PORTB_(_BRR) = (1&lt;&lt;14)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LAT_low() _PORTB_(_BRR) = (1&lt;&lt;14)</span></code></pre><br>
<p>(LAT_low   , -  ,   )</p><br>
<p>   ,   .    STM32,   ,  ,     .</p><br>
<h2 id="vklyuchaem-taktirovanie"> </h2><br>
<p>   ,   Clock.       RCC.    :  Reset and Clock Control (   ).</p><br>
<p>   ,  ,           STM,      (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Di Halt'</a>,   ,   ).     ,      (Peripheral Clock Enable Registers).      RCC,     Â« Â»:</p><br>
<p><img src="https://habrastorage.org/webt/r5/ad/jt/r5adjtnefym8toywwtuxwls-s8e.png"></p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _RCC_(mem_offset) (*(volatile uint32_t *)(0x40021000 + (mem_offset)))</span></code></pre><br>
<p>     ,     - , ,  ,         <em>enable registers</em>.    RCC_APB1ENR  RCC_APB2ENR:</p><br>
<p><img src="https://habrastorage.org/webt/bt/e7/_6/bte7_6icypsiop8tvagswdtfdpe.png"><br>
<img src="https://habrastorage.org/webt/pr/d0/l1/prd0l1e_vckbrxqk83wso_h9t5k.png"></p><br>
<p>  , , ,   SPI2, IOPB (I/O Port B)    (AFIO).</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _APB2ENR 0x18</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _APB1ENR 0x1C</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> IOPBEN 0x0008</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SPI2EN 0x4000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AFIOEN 0x0001</span><font></font>
<font></font>
<span class="hljs-comment">//   B  . </span><font></font>
_RCC_(_APB2ENR) |= IOPBEN | AFIOEN;<font></font>
<font></font>
<span class="hljs-comment">//   SPI2</span>
_RCC_(_APB1ENR) |= SPI2EN;</code></pre><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p>     ,   DM634 : DAI  PB15, DCK  PB13, LAT  PB14.    5 ,    .</p><br>
<p><img src="https://habrastorage.org/webt/sx/bz/va/sxbzvazmpgcgwsl0o5pt90gzlnm.jpeg"></p><br>
<h1 id="stm8-pwm">STM8 PWM</h1><br>
<h1 id="shim-na-stm8">  STM8</h1><br>
<p>     ,       -        ,      . STM8     : -,        STM8S103,  -,    ,               .</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">reference manual RM0016</a>,      ,   â€“  .  STM8  C   IDE <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ST Visual Develop</a>.</p><br>
<h3 id="taktirovanie-i-vvod-vyvod">  -</h3><br>
<p>  STM8    2 ,    .</p><br>
<p><img src="https://habrastorage.org/webt/h-/w7/hc/h-w7hclj1kovrmig-mxtjj-n62k.png"><br>
<sub>   HSI ( )<br>
  HSI    16- RC-    ( 1  8).        (CLK_CKDIVR).<br>
:        HSI RC-   8.</sub></p><br>
<p>    ,   refman  ,    :</p><br>
<pre><code class="plaintext hljs">#define CLK_CKDIVR *(volatile uint8_t *)0x0050C6<font></font>
<font></font>
CLK_CKDIVR &amp;= ~(0x18);</code></pre><br>
<p>       ,  :</p><br>
<p><img src="https://habrastorage.org/webt/uv/ii/kt/uviikt-bigbrftn_ivjxx681d8e.png"></p><br>
<p> ,         . ,     â€“ Â« Â»,   Â« Â» (<em>option bytes</em>) â€“ -   .     ,   , ..      .   ST Visual Programmer (   Visual Develop),    .   ,   CH1  CH2      ;   STVP   AFR1  AFR0,      CH1    PD4  PC5.</p><br>
<p> ,    6 : PC6, PC7  PC3   , PC5, PD3  PA3  .</p><br>
<p>   -  STM8   ,   STM32:</p><br>
<ul>
<li>  Atmega    DDR (<em>Data Direction Register</em>): 1 = ;</li>
<li>   CR1     Â«-Â» (1)    (0);       ,   ;</li>
<li>   CR2     : 1 = 10 </li>
</ul><br>
<pre><code class="plaintext hljs">#define PA_DDR     *(volatile uint8_t *)0x005002<font></font>
#define PA_CR2     *(volatile uint8_t *)0x005004<font></font>
#define PD_DDR     *(volatile uint8_t *)0x005011<font></font>
#define PD_CR2     *(volatile uint8_t *)0x005013<font></font>
#define PC_DDR     *(volatile uint8_t *)0x00500C<font></font>
#define PC_CR2     *(volatile uint8_t *)0x00500E<font></font>
<font></font>
PA_DDR = (1&lt;&lt;3); //output<font></font>
PA_CR2 |= (1&lt;&lt;3); //fast<font></font>
PD_DDR = (1&lt;&lt;3); //output<font></font>
PD_CR2 |= (1&lt;&lt;3); //fast<font></font>
PC_DDR = ((1&lt;&lt;3) | (1&lt;&lt;5) | (1&lt;&lt;6) | (1&lt;&lt;7)); //output<font></font>
PC_CR2 |= ((1&lt;&lt;3) | (1&lt;&lt;5) | (1&lt;&lt;6) | (1&lt;&lt;7)); //fast</code></pre><br>
<h2 id="nastroyka-shim"> </h2><br>
<p>    :</p><br>
<ul>
<li><strong>PWM Frequency</strong> â€“ ,    ;</li>
<li><strong>Auto-reload, AR</strong> â€“  ,      ( );</li>
<li><strong>Update Event, UEV</strong> â€“ , ,     AR;</li>
<li><strong>PWM Duty Cycle</strong> â€“   ,   Â«Â»;</li>
<li><strong>Capture/Compare Value</strong> â€“   /,     <em>- </em> (   â€“   );</li>
<li><strong>Preload Value</strong> â€“  . <em>Compare value</em>   ,   ,    .          ,       ;</li>
<li><strong>Edge-aligned</strong>  <strong>Center-aligned modes</strong> â€“      ,  ,   <em>Fast PWM</em>  <em>Phase-correct PWM</em>.</li>
<li><strong>OCiREF, Output Compare Reference Signal</strong> â€“   , , ,        .</li>
</ul><br>
<p>    ,       â€“   .  16-,      ( ,    ,  ).  ,    ,         ,     -,    .     ,        reference manual       (17.5.7 PWM Mode),      -  .</p><br>
<p>  STM8      :</p><br>
<p><img src="https://habrastorage.org/webt/pk/_-/za/pk_-za7gnzo77lvwyw-gvkts1y0.png"><br>
<sub>     <br>
   <br>
   ,   DIR   TIM_CR1 <br>
<br>
    .    OCiREF    ,  TIM1_CNT &lt; TIM1_CCRi.     .       TIM1_CCRi ,    ( TIM1_ARR),  OCiREF   1. <strong>     0, OCiREF   .</strong>â€¦ </sub></p><br>
<p> STM8   <em>update event</em>   <em>compare value</em>,      .     ,   ,     <code>compare value == 0</code>    ,    -  (,   ).</p><br>
<p>,    : 8-  (<code>AR == 255</code>),   ,   .      ,    0 (LED )  <em>compare value</em>  1 .</p><br>
<p>     <em>PWM mode</em>,         reference manual    (18.6.8 â€“ TIMx_CCMR1):</p><br>
<p><img src="https://habrastorage.org/webt/tt/_3/7s/tt_37syfd9-bib2-ymdxijus9qi.png"><br>
<sub> 110:    â€“    ,   ,  TIMx_CNT &lt; TIMx_CCR1.      . [       1]<br>
111:    â€“    ,   ,  TIMx_CNT &lt; TIMx_CCR1.      .</sub></p><br>
<p>     ,     ( ,      ).</p><br>
<p><img src="https://habrastorage.org/webt/go/ap/x_/goapx_hk5neeok4phdkas_nnfzu.png"><br>
<sub>  3 OC1PE:    1<br>
0:    TIMx_CCR1 .   TIMx_CCR1    .    .<br>
1:    TIMx_CCR1 .  /    .   TIMx_CCR1         .<br>
*:          .       (  TIMx_CR1   OPM). </sub><br>
</p><p>,  ,  ,     :</p><br>
<pre><code class="plaintext hljs">#define TIM2_CCMR1 *(volatile uint8_t *)0x005307<font></font>
#define TIM2_CCMR2 *(volatile uint8_t *)0x005308<font></font>
#define TIM2_CCMR3 *(volatile uint8_t *)0x005309<font></font>
<font></font>
#define PWM_MODE2   0x70 //PWM mode 2, 0b01110000<font></font>
#define OCxPE       0x08 //preload enable<font></font>
<font></font>
TIM2_CCMR1 = (PWM_MODE2 | OCxPE);<font></font>
TIM2_CCMR2 = (PWM_MODE2 | OCxPE);<font></font>
TIM2_CCMR3 = (PWM_MODE2 | OCxPE);</code></pre><br>
<p>AR     ,   :</p><br>
<pre><code class="plaintext hljs">#define TIM2_ARRH  *(volatile uint8_t *)0x00530F<font></font>
#define TIM2_ARRL  *(volatile uint8_t *)0x005310<font></font>
<font></font>
TIM2_ARRH = 0;<font></font>
TIM2_ARRL = 255;</code></pre><br>
<p>     -,   ,    .   , ,  256.        TIM2_PSCR     :</p><br>
<pre><code class="plaintext hljs">#define TIM2_PSCR  *(volatile uint8_t *)0x00530E<font></font>
<font></font>
TIM2_PSCR = 8;</code></pre><br>
<p>      .     <em>Capture/Compare <strong>Enable</strong></em>:  ,      .     ,     , ..       PWM Mode 1. :</p><br>
<pre><code class="plaintext hljs">#define TIM2_CCER1 *(volatile uint8_t *)0x00530A<font></font>
#define TIM2_CCER2 *(volatile uint8_t *)0x00530B<font></font>
<font></font>
#define CC1E  (1&lt;&lt;0) // CCER1<font></font>
#define CC2E  (1&lt;&lt;4) // CCER1<font></font>
#define CC3E  (1&lt;&lt;0) // CCER2<font></font>
<font></font>
TIM2_CCER1 = (CC1E | CC2E);<font></font>
TIM2_CCER2 = CC3E;</code></pre><br>
<p> , ,     TIMx_CR1:</p><br>
<p><img src="https://habrastorage.org/webt/u8/rj/5v/u8rj5vb2h3oxtgnoe1zzz90fnfm.png"></p><br>
<pre><code class="plaintext hljs">#define TIM2_CR1   *(volatile uint8_t *)0x005300<font></font>
<font></font>
TIM2_CR1 |= 1;</code></pre><br>
<p>   AnalogWrite(),        .    <em>Capture/Compare registers</em>,      :  8   TIM2_CCRxL    TIM2_CCRxH.    8- ,     :</p><br>
<pre><code class="plaintext hljs">#define TIM2_CCR1L *(volatile uint8_t *)0x005312<font></font>
#define TIM2_CCR2L *(volatile uint8_t *)0x005314<font></font>
#define TIM2_CCR3L *(volatile uint8_t *)0x005316<font></font>
<font></font>
void setRGBled(uint8_t r, uint8_t g, uint8_t b)<font></font>
{<font></font>
    TIM2_CCR1L = r;<font></font>
    TIM2_CCR2L = g;<font></font>
    TIM2_CCR3L = b;<font></font>
}</code></pre><br>
<p>  ,       ,   100%  (   255      ).      ,      ,   .</p><br>
<p>    ,   .</p><br>
<p>           (  ,   Â«Â»   ,        ).            .      , ..       ,   16-     <em>Prescaler High</em>  <em>Low</em>.   â€¦    .   ?</p><br>
<p>            1,   ,     .  <em>17.7.30 Break register (TIM1_BKR)</em>,    :</p><br>
<p><img src="https://habrastorage.org/webt/kb/h8/ue/kbh8ueavruur-vxcqo4fe0c2pdy.png"><br>
<sub>   </sub></p><br>
<pre><code class="plaintext hljs">#define TIM1_BKR   *(volatile uint8_t *)0x00526D<font></font>
<font></font>
TIM1_BKR = (1&lt;&lt;7);</code></pre><br>
<p>   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</p><br>
<p><img src="https://habrastorage.org/webt/b9/hb/tn/b9hbtn6retrnp1vpnzxjsjaayoq.jpeg"></p><br>
<h1 id="stm8-multiplex">STM8 Multiplex</h1><br>
<h1 id="multipleksing-na-stm8">  STM8</h1><br>
<p> -   ,          RGB-      .   â€“  LED-,   ,   -     ,   ,     (<em>persistence of vision</em>,   ). -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">-   </a>.</p><br>
<p>   :</p><br>
<ul>
<li>   RGB LED;</li>
<li> ,     ;</li>
<li>   ;</li>
<li>   RGB LED;</li>
<li> ...</li>
</ul><br>
<p>  .. ,    ,     Â«Â»   .   .   ,    ,         ,   UEV          RGB-.</p><br>
<p>  LED  ,   Â«Â»,      .   :</p><br>
<pre><code class="plaintext hljs">uint8_t colors[8][3];</code></pre><br>
<p> ,     ,        .        </p><br>
<pre><code class="plaintext hljs">uint8_t cnt;</code></pre><br>
<h3 id="demuks"></h3><br>
<p>    ,   ,  CD74HC238.  â€“ ,    <code>&lt;&lt;</code>.     ( 0, 1  2)      X,        (<code>1&lt;&lt;X</code>).        .            ,     â€“      ,  ,    .   ,       .</p><br>
<p>CD74HC238      ,       .           P-MOSFET,       , ..   20 ,  <em>absolute maximum ratings</em>  .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> CD74HC238</a>       :</p><br>
<p><img src="https://habrastorage.org/webt/b3/lz/rv/b3lzrv4xyavibkiwekm3lbvkays.png"><br>
<sub> H =   , L =   , X â€“  </sub></p><br>
<p> E2  E1  , E3, A0, A1  A3   PD5, PC3, PC4  PC5 STM8.      ,   ,     push-pull .</p><br>
<h2 id="shim"></h2><br>
<p>      ,    ,   :</p><br>
<p>-,      <em>Update Event</em> (UEV),    ,   LED.     <em>Update Interrupt Enable</em>     </p><br>
<p><img src="https://habrastorage.org/webt/me/kx/6p/mekx6pckxk6qmhkegaudnneach4.png"><br>
<sub>   </sub></p><br>
<pre><code class="plaintext hljs">#define TIM2_IER   *(volatile uint8_t *)0x005303<font></font>
<font></font>
//enable interrupt<font></font>
TIM2_IER = 1;</code></pre><br>
<p>      ,  <em>ghosting</em> â€“   .       - ,  ,    UEV,   ,       LED      -   .        (0 =  , 255 =   )      . ..  ,   UEV       .</p><br>
<p> :</p><br>
<pre><code class="plaintext hljs">//set polarity <font></font>
    TIM2_CCER1 |= (CC1P | CC2P);<font></font>
    TIM2_CCER2 |= CC3P;</code></pre><br>
<p>  r, g  b  255       .</p><br>
<h3 id="preryvaniya"></h3><br>
<p>   ,            -  .   -    ,     .</p><br>
<p>        ST Visual Develop,   <code>main.c</code>       <code>stm8_interrupt_vector.c</code>,    .         <code>NonHandledInterrupt</code>.        .</p><br>
<p>     ,    :</p><br>
<p><img src="https://habrastorage.org/webt/ly/ra/gy/lyragyga5skmcrzjojlftjit1qg.png"><br>
<sub> 13 TIM2 /<br>
14 TIM2 /</sub></p><br>
<p>   LED  UEV,     â„–13.</p><br>
<p>, -,   <code>stm8_interrupt_vector.c</code>   ,    â„–13 (IRQ13)    :</p><br>
<pre><code class="plaintext hljs">{0x82, TIM2_Overflow}, /* irq13 */</code></pre><br>
<p>-,     <code>main.h</code>  :</p><br>
<pre><code class="plaintext hljs">#ifndef __MAIN_H<font></font>
#define __MAIN_H<font></font>
<font></font>
@far @interrupt void TIM2_Overflow (void);<font></font>
#endif</code></pre><br>
<p> , ,      <code>main.c</code>:</p><br>
<pre><code class="plaintext hljs">@far @interrupt void TIM2_Overflow (void)<font></font>
{<font></font>
    PD_ODR &amp;= ~(1&lt;&lt;5); //  <font></font>
    PC_ODR = (cnt&lt;&lt;3); //     <font></font>
    PD_ODR |= (1&lt;&lt;5); //  <font></font>
<font></font>
    TIM2_SR1 = 0; //   Update Interrupt Pending<font></font>
<font></font>
    cnt++; <font></font>
    cnt &amp;= 7; //   LED<font></font>
<font></font>
    TIM2_CCR1L = ~colors[cnt][0]; //     <font></font>
    TIM2_CCR2L = ~colors[cnt][1]; //    <font></font>
    TIM2_CCR3L = ~colors[cnt][2]; // <font></font>
<font></font>
    return;<font></font>
}</code></pre><br>
<p>  .     <code>rim</code> â€“     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Programming Manual</a>:</p><br>
<pre><code class="plaintext hljs">//enable interrupts<font></font>
_asm("rim");</code></pre><br>
<p>   â€“ <code>sim</code> â€“  .          Â«Â»,         .</p><br>
<p>  â€“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</p><br>
<p><img src="https://habrastorage.org/webt/ri/ul/qs/riulqsjmsnehvg5fb_iofcnjl3u.jpeg"></p><br>
<p>  -   , ,     .     ,    .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456084/index.html">Kubernetes 1.15ï¼šãƒã‚¤ãƒ©ã‚¤ãƒˆã®æ¦‚è¦</a></li>
<li><a href="../ja456086/index.html">iOSã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒœãƒ¼ãƒ‰ï¼šé•·æ‰€ã¨çŸ­æ‰€ã®åˆ†æã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</a></li>
<li><a href="../ja456088/index.html">ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿åˆ†æã®å•é¡Œ</a></li>
<li><a href="../ja456090/index.html">Unityã§ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®æ¦‚è¦</a></li>
<li><a href="../ja456092/index.html">å¤©æ°—ã«ä¾å­˜ã—ã¦ã„ã‚‹7ã¤ã®å„ä»‹ãªå…†å€™</a></li>
<li><a href="../ja456096/index.html">é›²ã®ä¸­ã‚’ãƒ›ãƒãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã¨ãã®å¹³å‡çš„ãªã‚®ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã®è¡Œå‹•</a></li>
<li><a href="../ja456100/index.html">æ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ãªã‚Šã¾ã—ãŸ-M.2å½¢å¼ã®Kingston A400ãŒå¸‚å ´ã«æ€¥ãã¾ã™</a></li>
<li><a href="../ja456102/index.html">C / C ++ã§ã®ç°¡å˜ãªãƒ¬ãƒãƒ¼ãƒˆ</a></li>
<li><a href="../ja456104/index.html">Ezblock Pi-ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãªã—ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ä»Šå›ã¯Raspberry Piãƒ•ã‚¡ãƒ³å‘ã‘</a></li>
<li><a href="../ja456106/index.html">æ©Ÿèƒ½ã‚’ã‚ˆã‚Šé€Ÿãåˆ†å‰²ã—ã¾ã™ã€‚Badooã§ã®Androidé–‹ç™ºçµŒé¨“</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>