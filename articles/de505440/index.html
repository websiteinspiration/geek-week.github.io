<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ìÇÔ∏è ‚úñÔ∏è üí¨ Tauchen Sie ein in die internen Statistiken von PostgreSQL. Alexey Lesovsky „äôÔ∏è üßìüèΩ üë∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entschl√ºsselung des Berichts 2015 von Alexey Lesovsky "Tief in die internen Statistiken von PostgreSQL eintauchen"
 

Haftungsausschluss des Autors de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tauchen Sie ein in die internen Statistiken von PostgreSQL. Alexey Lesovsky</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505440/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entschl√ºsselung des Berichts 2015 von Alexey Lesovsky "Tief in die internen Statistiken von PostgreSQL eintauchen"</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haftungsausschluss des Autors des Berichts: </font></font></strong> <em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich stelle fest, dass dieser Bericht vom November 2015 datiert ist - mehr als 4 Jahre sind vergangen und viel Zeit ist vergangen. Die im Bericht beschriebene Version 9.4 wird nicht mehr unterst√ºtzt. In den letzten 4 Jahren wurden 5 neue Releases ver√∂ffentlicht, in denen viele Innovationen, Verbesserungen und √Ñnderungen in Bezug auf Statistiken ver√∂ffentlicht wurden und ein Teil des Materials veraltet und nicht relevant ist. Im Verlauf der √úberpr√ºfung habe ich versucht, diese Stellen zu markieren, um den Leser nicht irrezuf√ºhren. Ich habe diese Orte nicht umgeschrieben, es gibt viele davon, und als Ergebnis wird sich ein v√∂llig anderer Bericht herausstellen.</font></font></em> </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL DBMS ist ein riesiger Mechanismus, und dieser Mechanismus besteht aus vielen Subsystemen, deren DBMS-Leistung direkt von der koordinierten Arbeit abh√§ngt. </font><font style="vertical-align: inherit;">W√§hrend des Betriebs werden Statistiken und Informationen zum Betrieb der Komponenten gesammelt, mit denen Sie die Wirksamkeit von PostgreSQL bewerten und Ma√ünahmen zur Steigerung der Produktivit√§t ergreifen k√∂nnen. </font><font style="vertical-align: inherit;">Diese Informationen sind jedoch sehr umfangreich und werden in einer eher vereinfachten Form dargestellt. </font><font style="vertical-align: inherit;">Die Verarbeitung dieser Informationen und ihre Interpretation ist manchmal eine nicht triviale Aufgabe, und der ‚ÄûZoo‚Äú von Tools und Dienstprogrammen wird selbst den fortgeschrittenen DBA leicht verwirren.</font></font><br>
<img src="https://habrastorage.org/webt/8d/zi/wq/8dziwqqvzrr6n_jpe0vb1djgf4q.png"></p><a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/nBSF3rHXM38" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guten Tag! </font><font style="vertical-align: inherit;">Ich hei√üe Alexey. </font><font style="vertical-align: inherit;">Wie Ilya sagte, werde ich √ºber PostgreSQL-Statistiken sprechen.</font></font></p><br>
<p><img src="https://habrastorage.org/webt/44/hq/rw/44hqrwbe_ilywzjen1phivicteu.png"></p><br>
<p>  PostgreSQL.  PostgreSQL   .  ,    .      .        PostgreSQL,        -  .</p><br>
<p>,         ,       . </p><br>
<p><img src="https://habrastorage.org/webt/qf/-w/uv/qf-wuvngd11nlszoh84ak7ixln4.png"></p><br>
<p>    ?        , ..        ,                    . </p><br>
<p>    ,        .    .  . </p><br>
<p><img src="https://habrastorage.org/webt/qz/xm/lu/qzxmlucpbq8h16yh-owxuod1lb4.png"></p><br>
<p>   ,    ‚Äì  .  .   .      SQL     SQL.</p><br>
<p> ,      .</p><br>
<p><img src="https://habrastorage.org/webt/l6/lx/ug/l6lxug6s9ojmchwkfhzipuahhxw.png"></p><br>
<p>    PostgreSQL         ,   " ".   - ,  - ,       ,    ,  . ,  ,   ,     . </p><br>
<p>       <code>top</code>,     -  ,    PostgreSQL   .      . </p><br>
<p><img src="https://habrastorage.org/webt/do/bl/uo/dobluoy4uh1mqt9lzq5gewnquom.png"></p><br>
<p>    ,   .    PostgreSQL    ,    ,   .   :         ,   PostgreSQL    .</p><br>
<p>       ,    ,    .           .    .    .     .  -  -      .           "shared buffers".  ,   updates, deletes,      WAL.          .       .          .</p><br>
<p>         ?     ,           .       :  autovacuum, checkpointer, ,   , background writer.         .</p><br>
<p><img src="https://habrastorage.org/webt/_6/zp/8a/_6zp8aiksnauyjpuy1emyyi7ipe.png"></p><br>
<p>    ? </p><br>
<ul>
<li> . PostgreSQL 9.4  109     . ,       , , ,          , . . .    .      .</li>
<li>  ‚Äì  ,    .     ,      .          ,    .      . </li>
<li> .     - , -  15-30  ,      ,   15-30  .  .</li>
<li>   PostgreSQL  ‚Äì  .      .     .      . ,    ,  ,   . </li>
<li>    PostgreSQL  ,      .   .  ,    -  ,    .     community   ,       .       ,      ,   -  .   ,    -- ,        .   . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ii/gj/en/iigjenmvagagz2pgncnxdofdqls.png"></p><br>
<p>   ?     ,     ,  -    :  - ,    . </p><br>
<p>    SQL.   -   ,    SQL, . .   ,   select, join.</p><br>
<p><img src="https://habrastorage.org/webt/82/jz/me/82jzmew2kjrmmvx5xagkhkuawwc.png"></p><br>
<p>    .     .</p><br>
<ul>
<li>  ‚Äì  ,   .      - : ,   , , ,    .     .      . </li>
<li>  ‚Äì    ,  , .    .   .     ,  .     . </li>
<li>   ‚Äì  ,   .  ‚Äì  .       .  ,  .    .        .    . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/_0/mh/a_/_0mha_byhkpbr8ias2qjfyf5wkk.png"></p><br>
<p>    : </p><br>
<ul>
<li>   (shared buffers)       ,      ,   ,      ,   -    . </li>
<li>          .   .     PostgreSQL     SQL .    select        -  (  ). </li>
<li>      ,       (VIEWs).   ,     -  ,   -     . </li>
<li>   (VIEWs)        .   -     ,    , ,   .    contrib'. Contrib'  .     postgresql-contrib (, postgresql94-contrib),     ,    ,  PostgreSQL   . (. <em>   ,    contrib     </em>).</li>
<li>   contrib.       PostgreSQL.    ,    .     ,    ,      contrib‚Äô. </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/oq/cb/cl/oqcbclvrz_chxnihgvcsvo7nwhm.png"></p><br>
<p>       (VIEWs)    ,    PostgreSQL 9.4.   ,   .    ,        .</p><br>
<p><img src="https://habrastorage.org/webt/ik/fx/ol/ikfxol834oxvxqm3rhnsvpdu99g.png"></p><br>
<p>,      <code>    PostgreSQL</code>     ,     .   (VIEWs),               ,     PostgreSQL.     -    . </p><br>
<p><img src="https://habrastorage.org/webt/rz/j_/wf/rzj_wfer1eswag9lntqr15ykwlw.png"></p><br>
<p>,   ,  <code>pg_stat_database</code>.   ,  .     .   .      ,       . </p><br>
<p>     ?  c   .</p><br>
<p><img src="https://habrastorage.org/webt/in/1l/6w/in1l6wbqytyjnnkpyrqtr2q18km.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span>
<span class="hljs-keyword">sum</span>(blks_hit)*<span class="hljs-number">100</span>/<span class="hljs-keyword">sum</span>(blks_hit+blks_read) <span class="hljs-keyword">as</span> hit_ratio
<span class="hljs-keyword">from</span> pg_stat_database;</code></pre><br>
<p>,     ‚Äì     .     ‚Äì   .   ,       shared buffers,      . </p><br>
<p> ,  <strong>      ,   </strong>.      . , ,           90 %,   . <strong>    90 %, ,        ""   .     , PostgreSQL              .       :  shared buffers ,     (RAM).</strong> </p><br>
<p><img src="https://habrastorage.org/webt/gt/7d/yl/gt7dylzytgbq5db0zkb3v13tbf4.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span><font></font>
datname,<font></font>
(xact_commit*<span class="hljs-number">100</span>)/(xact_commit+xact_rollback) <span class="hljs-keyword">as</span> c_ratio,<font></font>
deadlocks, conflicts,<font></font>
temp_file, pg_size_pretty(temp_bytes) <span class="hljs-keyword">as</span> temp_size
<span class="hljs-keyword">from</span> pg_stat_database;</code></pre><br>
<p>      ?      .   ?   commits, rollbacks,   ,  , deadlocks  . </p><br>
<p>    .  SQL  .        .</p><br>
<p><img src="https://habrastorage.org/webt/8v/3m/44/8v3m449d61nxacbamybuxlo0n8e.png"></p><br>
<p>    .    commits  rollbacks. Commits ‚Äì    . Rollbacks ‚Äì  , . .   - ,  , - ,    ,    . . . <strong> rollbacks,  ,  .   -  ,   ,    .</strong> </p><br>
<p><strong> (conflicts)   .     .</strong>    - ,       ,     , ,  .     .    ,      . </p><br>
<p><strong>Deadlocks ‚Äì    .     ,         ,          ,                 .    .            .</strong>    ,    deadlocks  ,     ,        . </p><br>
<p><strong>  (temp_files) ‚Äì   .         ,  ,     .             ,     .  .</strong>     .  ,    PostgreSQL    .        , Postgres        . </p><br>
<p><img src="https://habrastorage.org/webt/qs/kt/u3/qsktu3tnn6wgc2ga7okewnud3w8.png"></p><br>
<p>Pg_stat_bgwriter ‚Äì        PostgreSQL:  <code>checkpointer</code>  <code>background writer</code>. </p><br>
<p><img src="https://habrastorage.org/webt/1q/hu/wa/1qhuwacn-vc5k8imyd-iftle7ii.png"></p><br>
<p>    , .. <code>checkpoints</code>.    ?                     .                      shared buffers    .    ?   PostgreSQL         ,      ,    .   PostgreSQL   ,       . Postgres             .         .      .     ,   .      .   ,    ,   .    checkpoint.</p><br>
<p>Checkpoint   shared buffers,   ,     checkpoint.      shared buffers.  ,    checkpoint,    .        . </p><br>
<p>    .  checkpoint   -.  checkpoint    ‚Äì <code>checkpoint_timed</code>.   checkpoints   ‚Äì <code>checkpoint required</code>.            .      .  PostgreSQL ,         ,      . </p><br>
<p>     <code>pg_stat_bgwriter</code>  ,    <strong>checkpoint_req  ,  checkpoint_timed,   .  ?  ,  PostgreSQL     ,       .</strong> Checkpoint               .  PostgreSQL           .   PostgreSQL .  ,     checkpoint      ,    . </p><br>
<p>   checkpoint   :</p><br>
<ul>
<li><p><code>heckpoint_segments</code>.</p><br>
</li>
<li><p><code>heckpoint_timeout</code>.</p><br>
</li>
<li><p><code>heckpoint_competion_target</code>. </p><br>
</li>
</ul><br>
<p>     .      .   ‚Äì    .</p><br>
<p><strong>:</strong>     9.4  .    PostgreSQL  <code>checkpoint_segments</code>   <code>min_wal_size</code>  <code>max_wal_size</code>. </p><br>
<p><img src="https://habrastorage.org/webt/h0/ox/tu/h0oxtusf16s0rvlikpg1ath0muu.png"></p><br>
<p>     ‚Äî <code>background writer</code>.   ?      .    shared buffers   ,   ,   .     checkpointer'        . </p><br>
<p>    ?        shared buffers     (    )   .                shared buffers.  <code>backend</code>     ,      .      ,                  ‚Äî          . <strong>  ,     <code>maxwritten_clean</code> ,  ,  background writer          <code>bgwriter_lru_maxpages</code></strong>,         ,   . </p><br>
<p><strong>     ‚Äì  <code>buffers_backend_fsync</code>.</strong>    fsync,    .   fsync   IO stack checkpointer‚Äô.  checkpointer   ,   fsync          . <strong>    checkpointer  ,      fsync     </strong>, . .    ,   .   ,       ,      <strong>     background writer'      .</strong> </p><br>
<p><img src="https://habrastorage.org/webt/pc/4m/j6/pc4mj62p-kbr3bljysintew2su8.png"></p><br>
<p><strong>:</strong> _       .          Postgres 10.      <code>xlog</code>  <code>wal</code>  <code>location</code>  <code>lsn</code>   /  ..  ,  <code>pg_xlog_location_diff()</code>    <code>pg_wal_lsn_diff()</code>._ </p><br>
<p>     .      ,   location. </p><br>
<p><img src="https://habrastorage.org/webt/ep/xk/mo/epxkmodndt65xosqkutjikocc8i.png"></p><br>
<p><strong>  ,    ,          .</strong></p><br>
<p>    ‚Äì     .   ,     - : inserts, deletes  . . </p><br>
<p><img src="https://habrastorage.org/webt/ef/zk/ec/efzkecianqamsvw4jtqeqa59luk.png"></p><br>
<pre><code class="sql hljs">  xlog  <font></font>
$ <span class="hljs-keyword">select</span>
pg_xlog_location_diff(pg_current_xlog_location(),<span class="hljs-string">'0/00000000'</span>);<font></font>
   <font></font>
$ <span class="hljs-keyword">select</span><font></font>
client_addr,<font></font>
pg_xlog_location_diff(pg_current_xlog_location(), replay_location)<font></font>
<span class="hljs-keyword">from</span> pg_stat_replication;<font></font>
   <font></font>
$ <span class="hljs-keyword">select</span>
<span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>() - pg_last_xact_replay_timestamp());</code></pre><br>
<p>   ,   - .  ‚Äì     , . .    .</p><br>
<p>   : </p><br>
<ul>
<li>        . </li>
<li>   ,   ,             . </li>
<li> .  ‚Äì    .        ,     .</li>
</ul><br>
<p>   ,     .   ,       .    <code>pg_xlog_location_diff</code>         .          (VIEWs). </p><br>
<p><strong>:</strong> _ pg_xlog_location<em>diff()         location  . .</em></p><br>
<p> ,   ,   .       ,    - 15      ,        ,      15 .    .      ,     . </p><br>
<p><img src="https://habrastorage.org/webt/oy/fx/vp/oyfxvpxmsnjwqp8ugdma9ezxtl4.png"></p><br>
<p>Pg_stat_all_tables ‚Äì    .     .       ,    - , - ,        .</p><br>
<p><img src="https://habrastorage.org/webt/t2/o2/vc/t2o2vcdij14qo4yqpkukhwmrpne.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span><font></font>
relname,<font></font>
pg_size_pretty(pg_relation_size(relname::regclass)) <span class="hljs-keyword">as</span> <span class="hljs-keyword">size</span>,<font></font>
seq_scan, seq_tup_read,<font></font>
seq_scan / seq_tup_read <span class="hljs-keyword">as</span> seq_tup_avg
<span class="hljs-keyword">from</span> pg_stat_user_tables
<span class="hljs-keyword">where</span> seq_tup_read &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span>,<span class="hljs-number">4</span> <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">5</span>;</code></pre><br>
<p>,    ,     .             ,     - .</p><br>
<p><strong>    ‚Äì seq_tup_read.   ,     .     1 000, 10 000, 50 000, 100 000,    ,     -  ,     ,         ,    .</strong> </p><br>
<p>  ‚Äì ,    OFFSET  LIMIT .    100 000        50 000  ,     .    .     .      SQL-,         . </p><br>
<p><img src="https://habrastorage.org/webt/xg/ub/jq/xgubjqtjchxsguekyvlkuh-vssu.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span><font></font>
relname,<font></font>
pg_size_pretty(pg_total_relation_size(relname::regclass)) <span class="hljs-keyword">as</span><font></font>
full_size,<font></font>
pg_size_pretty(pg_relation_size(relname::regclass)) <span class="hljs-keyword">as</span><font></font>
table_size,<font></font>
pg_size_pretty(pg_total_relation_size(relname::regclass) -<font></font>
pg_relation_size(relname::regclass)) <span class="hljs-keyword">as</span> index_size
<span class="hljs-keyword">from</span> pg_stat_user_tables
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> pg_total_relation_size(relname::regclass) <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">10</span>;</code></pre><br>
<p>              <code>pg_total_relation_size()</code>, <code>pg_relation_size()</code>.</p><br>
<p>,   <code>\dt</code>  <code>\di</code>,     PSQL       . </p><br>
<p>           ,        -      , . .     ,       -    . </p><br>
<p><img src="https://habrastorage.org/webt/aj/hh/a8/ajhha8wpkijuymwhqvbq7wzkgxy.png"></p><br>
<p>  .   ?    <code>UPDATE</code> ‚Äì     .  , update ‚Äì    (    ).            .           ,        .</p><br>
<p> , update ‚Äì     .    .       ,   update  ,    ,   ,    .        ,    . </p><br>
<p><img src="https://habrastorage.org/webt/so/wq/dq/sowqdqlnksjvoq5t3s7qa43rmtm.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span><font></font>
s.relname,<font></font>
pg_size_pretty(pg_relation_size(relid)),<font></font>
<span class="hljs-keyword">coalesce</span>(n_tup_ins,<span class="hljs-number">0</span>) + <span class="hljs-number">2</span> * <span class="hljs-keyword">coalesce</span>(n_tup_upd,<span class="hljs-number">0</span>) -
<span class="hljs-keyword">coalesce</span>(n_tup_hot_upd,<span class="hljs-number">0</span>) + <span class="hljs-keyword">coalesce</span>(n_tup_del,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> total_writes,<font></font>
(<span class="hljs-keyword">coalesce</span>(n_tup_hot_upd,<span class="hljs-number">0</span>)::<span class="hljs-built_in">float</span> * <span class="hljs-number">100</span> / (<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> n_tup_upd &gt; <span class="hljs-number">0</span>
<span class="hljs-keyword">then</span> n_tup_upd <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>)::<span class="hljs-built_in">float</span>)::<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> hot_rate,<font></font>
(<span class="hljs-keyword">select</span> v[<span class="hljs-number">1</span>] <span class="hljs-keyword">FROM</span> regexp_matches(reloptions::<span class="hljs-built_in">text</span>,E<span class="hljs-string">'fillfactor=(\\d+)'</span>) <span class="hljs-keyword">as</span>
r(v) <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> fillfactor
<span class="hljs-keyword">from</span> pg_stat_all_tables s
<span class="hljs-keyword">join</span> pg_class c <span class="hljs-keyword">ON</span> c.oid=relid
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> total_writes <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">50</span>;</code></pre><br>
<p>    , UPDATE ‚Äì   .    .  <code>hot updates</code>.    PostgreSQL  8.3.    ?   update,     . . .   ,         (  ),   -        .      ,   ,     <code>hot</code>        ,       . </p><br>
<p><strong>    <code>n_tup_hot_upd</code> ,    .  ,   updates           .</strong> </p><br>
<p><img src="https://habrastorage.org/webt/nu/fw/wg/nufwwgowva_voi5_tixn3diibac.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> table_name <span class="hljs-keyword">SET</span> (fillfactor = <span class="hljs-number">70</span>);</code></pre><br>
<p>   <code>hot update</code>?    <code>fillfactor</code>.              INSERT'.     inserts,     ,      .    .   .     , fillfactor = 100 %.</p><br>
<p><strong>   fillfactor  70 %. . .  inserts   ,     70 % .  30 %     .     update,            ,         .    hot_update.      .</strong> </p><br>
<p><img src="https://habrastorage.org/webt/2c/fd/3l/2cfd3lq4epuy3mbgqe_q1ixvxfq.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> c.relname,<font></font>
current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>) <span class="hljs-keyword">as</span> av_base_thresh,<font></font>
current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>) <span class="hljs-keyword">as</span> av_scale_factor,<font></font>
(current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>)::<span class="hljs-built_in">int</span> +<font></font>
(current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>)::<span class="hljs-built_in">float</span> * c.reltuples))
<span class="hljs-keyword">as</span> av_thresh,<font></font>
s.n_dead_tup<font></font>
<span class="hljs-keyword">from</span> pg_stat_user_tables s <span class="hljs-keyword">join</span> pg_class c <span class="hljs-keyword">ON</span> s.relname = c.relname
<span class="hljs-keyword">where</span> s.n_dead_tup &gt; (current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>)::<span class="hljs-built_in">int</span>
+ (current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>)::<span class="hljs-built_in">float</span> * c.reltuples));</code></pre><br>
<p> .  ‚Äì   ,     PostgreSQL  .       pg_stat_activity ,        .  ,          . </p><br>
<p><strong>:</strong> _   Postgres 10       ‚Äî   pg_stat_progress<em>vacuum,      .</em></p><br>
<p>      .   ,     . ,      ?     ,     . Update ,    .    .   <code>pg_stat_user_tables</code>    <code>n_dead_tup</code>.    "" .        ,   ,    . </p><br>
<p>    ?           .   <code>autovacuum_vacuum_scale_factor</code>.     . , 10 % +      50 .   ?         "10 % + 50"     ,      .</p><br>
<p><img src="https://habrastorage.org/webt/6p/gn/ox/6pgnox0d7bwmwzhsbnjcam2rzse.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> c.relname,<font></font>
current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>) <span class="hljs-keyword">as</span> av_base_thresh,<font></font>
current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>) <span class="hljs-keyword">as</span> av_scale_factor,<font></font>
(current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>)::<span class="hljs-built_in">int</span> +<font></font>
(current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>)::<span class="hljs-built_in">float</span> * c.reltuples))
<span class="hljs-keyword">as</span> av_thresh,<font></font>
s.n_dead_tup<font></font>
<span class="hljs-keyword">from</span> pg_stat_user_tables s <span class="hljs-keyword">join</span> pg_class c <span class="hljs-keyword">ON</span> s.relname = c.relname
<span class="hljs-keyword">where</span> s.n_dead_tup &gt; (current_setting(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>)::<span class="hljs-built_in">int</span>
+ (current_setting(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>)::<span class="hljs-built_in">float</span> * c.reltuples));</code></pre><br>
<p>    .     <code>av_base_thresh</code>  <code>av_scale_factor</code>   . , ,    ,    .   ,      .    ,          Avito (       ).</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">munin plugin</a>,    .     .         ,        ,  . </p><br>
<p>     ? <strong>        ,       ,     </strong>,    ,    . <strong>     .</strong> ‚Äî       , ..   ,    SSD/NVMe     .</p><br>
<p><img src="https://habrastorage.org/webt/9b/q1/1y/9bq11y4hodhskweeokqynhnj0jy.png"></p><br>
<p>Pg_stat_all_indexes ‚Äì    .  .          .         . </p><br>
<p><img src="https://habrastorage.org/webt/w-/83/w_/w-83w_gl41znzosfdvt_hcpmg5o.png"></p><br>
<p>   , <strong>update ‚Äì     ,     .</strong> ,             ,      ,  <strong>     ,     ,      .     .</strong>      <code>idx_scan</code>.      .            (   2-3 ),      ,     .</p><br>
<p><strong>:</strong> <em>             , ..   ,      ,       (   ).</em> </p><br>
<p> :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/dataegret/pg-utils/blob/master/sql/low_used_indexes.sql</a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">http://www.databasesoup.com/2014/05/new-finding-unused-indexes-query.html</a></p><br>
<p>      ,    . </p><br>
<p>  ‚Äì    .     .    .</p><br>
<p><img src="https://habrastorage.org/webt/yv/ch/i1/yvchi1pkvqluackjex8pchix_mw.png"></p><br>
<p>     ? </p><br>
<ul>
<li><p>  ‚Äì  . </p><br>
</li>
<li><p> . </p><br>
</li>
<li><p>  .</p><br>
</li>
<li><p>   . </p><br>
</li>
</ul><br>
<p><strong>    ,      .</strong> </p><br>
<p><img src="https://habrastorage.org/webt/xk/sb/v4/xksbv4c25g6qqfuer_gi5_hoeae.png"></p><br>
<p>  ‚Äì  <code>pg_stat_activity</code>.    <code>ps</code>,   PostgreSQL.  <code>ps</code>'      ,  <code>pg_stat_activity</code>     PostgreSQL.</p><br>
<p>     ?</p><br>
<p><img src="https://habrastorage.org/webt/si/ew/kr/siewkr4grofcqg6k8bcq2jhil7g.png"></p><br>
<pre><code class="plaintext hljs">select<font></font>
count(*)*100/(select current_setting('max_connections')::int)<font></font>
from pg_stat_activity;</code></pre><br>
<p>    ,    .    .     ,    ,    .</p><br>
<p><img src="https://habrastorage.org/webt/ga/6t/2_/ga6t2_jk4mk95okroro5h0d5v-i.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span>
client_addr, usename, datname, <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">4</span> <span class="hljs-keyword">desc</span>;</code></pre><br>
<p>                ,       .       ,  user <code>cron_role</code>  508 .  -    .      .   ,   -   .</p><br>
<p><img src="https://habrastorage.org/webt/ci/dj/vk/cidjvkskcb3kmikplfwe8mkqe9y.png"></p><br>
<p>    OLTP,    ,        . ,    ,       ,  <strong>      ,   bloat  ,    .   bloat,      .</strong></p><br>
<p><img src="https://habrastorage.org/webt/k1/rl/rg/k1rlrg5ilqkxduz9zksadf7hcro.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span><font></font>
client_addr, usename, datname,<font></font>
clock_timestamp() - xact_start <span class="hljs-keyword">as</span> xact_age,<font></font>
clock_timestamp() - query_start <span class="hljs-keyword">as</span> query_age,
<span class="hljs-keyword">query</span>
<span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> xact_start, query_start;</code></pre><br>
<p> :          .    <code>clock_timestamp()</code>    . <strong> ,   ,    ,  <code>explain</code>,    - .</strong>        . </p><br>
<p><img src="https://habrastorage.org/webt/ce/vh/nk/cevhnkgeddjls8lw6jclo9uzy5s.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">where</span> state <span class="hljs-keyword">in</span>
(<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>;</code></pre><br>
<p><strong>  ‚Äì     idle in transaction  idle in transaction (aborted).</strong></p><br>
<p>  ?    .           .      <code>state</code>   .       . </p><br>
<p><img src="https://habrastorage.org/webt/db/aa/dy/dbaadywldmkgs4uz-sirvtiw_2c.png"></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">where</span> state <span class="hljs-keyword">in</span>
(<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>;</code></pre><br>
<p>,     ,    <strong>idle in transaction  idle in transaction (aborted) ‚Äì  .   ?     ,  -      .   .  ,     ,   ,         bloat  , -    Postrges'.      ,     ,   .</strong> </p><br>
<p>  ,        5-10-20,         - .</p><br>
<p>       <code>clock_timestamp()</code>.  ,  .</p><br>
<p><img src="https://habrastorage.org/webt/bv/lz/sq/bvlzsqnwiakymptboyi6valyhaq.png"></p><br>
<p>    ,  ‚Äì            .       <code>waiting</code>    <code>true</code>  <code>false</code>.</p><br>
<p><strong>True ‚Äì  ,     ,  - .     , , ,      .       .</strong> </p><br>
<p><strong>:</strong> _   Postgres 9.6  <code>waiting</code>          <code>wait_event_type</code>  <code>wait_event</code>._ </p><br>
<p><img src="https://habrastorage.org/webt/lj/lz/bf/ljlzbf8ayxhl3vfim4hyqpuknxq.png"></p><br>
<p> ? <strong>   true,      ,     .     .  ,   - ,      .     ,    .</strong> </p><br>
<p> ,        ‚Äì  <strong> deadlocks.     ,     ,    . PostgreSQL        ,     .        .  PostgreSQL    .</strong></p><br>
<p><img src="https://habrastorage.org/webt/f2/ru/4e/f2ru4e6_4j3c_oi8qxyj9f1wziw.png"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/lesovsky/uber-scripts/blob/master/postgresql/sql/c4_06_show_locked_queries.sql</a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/lesovsky/uber-scripts/blob/master/postgresql/sql/show_locked_queries_95.sql</a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/lesovsky/uber-scripts/blob/master/postgresql/sql/show_locked_queries_96.sql</a></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">http://big-elephants.com/2013-09/exploring-query-locks-in-postgres/</a></p><br>
<p>   ,    .    <code>pg_locks</code>,     .</p><br>
<p>   ‚Äì    .  - .</p><br>
<p>   ‚Äì    locks.   ,   .</p><br>
<p>,   ?    .   <code>ALTER TABLE</code> ‚Äì   .  ,         -   .    ‚Äì update.  ,   alter table,    . </p><br>
<p>    ,   ,       . </p><br>
<p><img src="https://habrastorage.org/webt/uz/6j/bc/uz6jbcjaevda_vl63j5p9ai3j7s.png"></p><br>
<p>  ‚Äì  <code>pg_stat_statements</code>.    ,  .         ,  PostgreSQL,   ( )       . </p><br>
<p><img src="https://habrastorage.org/webt/b7/0t/j5/b70tj5quyfxd6agwuwlam3dupwu.png"></p><br>
<pre><code class="sql hljs">C    <font></font>
$ <span class="hljs-keyword">select</span> (<span class="hljs-keyword">sum</span>(total_time) / <span class="hljs-keyword">sum</span>(calls))::<span class="hljs-built_in">numeric</span>(<span class="hljs-number">6</span>,<span class="hljs-number">3</span>)
<span class="hljs-keyword">from</span> pg_stat_statements;<font></font>
<font></font>
   ( shared_buffers) <font></font>
$ <span class="hljs-keyword">select</span> <span class="hljs-keyword">query</span>, shared_blks_dirtied
<span class="hljs-keyword">from</span> pg_stat_statements
<span class="hljs-keyword">where</span> shared_blks_dirtied &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">2</span> <span class="hljs-keyword">desc</span>;</code></pre><br>
<p>    ?     ,       .  , ,   PostgreSQL     - .</p><br>
<p>        ,     shared buffers. ,        . </p><br>
<p>        .</p><br>
<p><img src="https://habrastorage.org/webt/pd/ig/z1/pdigz16w5yckclnm9sofmaf0eba.png"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/dataegret/pg-utils/blob/master/sql/global_reports/query_stat_total.sql</a></p><br>
<p> <code>pg_stat_statements</code>    .     .  .      ,  .    .    .</p><br>
<p><img src="https://habrastorage.org/webt/bv/lc/ae/bvlcae6xqoguu1cjoptouihb9yw.png"></p><br>
<p>  ?       .             . </p><br>
<p>    ?               .       -   .     .             ,  . </p><br>
<p><img src="https://habrastorage.org/webt/ff/8v/64/ff8v64xocel-fc4rasw5tkwxeng.png"></p><br>
<p>     ?    ,     ,    . </p><br>
<p> <code>pgstattuple</code> ‚Äì        contribs.    <code>bloat</code> , ..  .    ,   ,   .   <code>pgstattuple</code>  .    ,     .</p><br>
<p><img src="https://habrastorage.org/webt/2t/tw/8b/2ttw8bekfp6ttrhhtohj73x8x9k.png"></p><br>
<p> contrib ‚Äì  <code>pg_buffercache</code>.     shared buffers:         .      shared buffers    . </p><br>
<p>  ‚Äì  <code>pgfincore</code>.           <code>mincore()</code>, . .       ,   .          , . .         page cache,  shared buffers      .</p><br>
<p>  ‚Äì <code>pg_stat_kcache</code>.      <code>getrusage()</code>.        .      ,         -, . .        .    (-)       PostgreSQL 9.4  pg_stat_statements,     . </p><br>
<p><img src="https://habrastorage.org/webt/ba/dn/8i/badn8iutai1czfmf1iuuy8zvpsy.png"></p><br>
<ul>
<li><p>   ‚Äì .     .    , , - , . </p><br>
</li>
<li><p>  ,   SQL.   , , , . </p><br>
</li>
<li><p>    .     ,     ‚Äì ,  ,  .</p><br>
</li>
<li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und experimentieren. </font><font style="vertical-align: inherit;">Es gibt viele Anfragen, viele Daten. </font><font style="vertical-align: inherit;">Sie k√∂nnen eine vorhandene Abfrage jederzeit optimieren. </font><font style="vertical-align: inherit;">Sie k√∂nnen Ihre eigene Version der Anfrage erstellen, die mehr zu Ihnen passt als das Original, und sie verwenden.</font></font></p><br>
</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/m4/dr/e3/m4dre3esnukcqd59roitxsnzeea.png"></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise</font></font></b>
                        <div class="spoiler_text"><p> ,    ,   ,   . </p><br>
<p>  <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://dataegret.com/news-blog</a> (eng)</p><br>
<p>The Statistics Collector<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.postgresql.org/docs/current/monitoring-stats.html</a></p><br>
<p>System Administration Functions<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.postgresql.org/docs/current/functions-admin.html</a></p><br>
<p>Contrib modules<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.postgresql.org/docs/current/pgstatstatements.html</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.postgresql.org/docs/current/pgstattuple.html</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://www.postgresql.org/docs/current/pgbuffercache.html</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/klando/pgfincore</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/dalibo/pg_stat_kcache</a></p><br>
<p>SQL utils and sql code examples<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">https://github.com/dataegret/pg-utils</a></p></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vielen Dank f√ºr Ihre Aufmerksamkeit!</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de505424/index.html">Ein geologisches Modell eines Arizona-Kraters, der in der Arizona-W√ºste, USA gelegen ist</a></li>
<li><a href="../de505428/index.html">Kann ich mit einem Rechnungspr√ºfer an einem Arcade-Automaten Geld verdienen?</a></li>
<li><a href="../de505430/index.html">FESTE Prinzipien in Bildern</a></li>
<li><a href="../de505432/index.html">In welchen St√§dten Russlands gibt es keine Quarant√§ne f√ºr Besucher</a></li>
<li><a href="../de505438/index.html">Wohin zur IT? Detaillierte Anweisungen vom Projektmanager</a></li>
<li><a href="../de505442/index.html">VxLAN-Fabrik. Teil 1</a></li>
<li><a href="../de505448/index.html">Wie wir die Analyse und Datenverarbeitung in DomKlik organisiert haben</a></li>
<li><a href="../de505452/index.html">Die Entwicklung der Bankkarten: von Metall zu Metall</a></li>
<li><a href="../de505456/index.html">Warum Drucker Dokumente mit unsichtbaren Punkten versehen</a></li>
<li><a href="../de505458/index.html">Wie man maschinelles Lernen versteht, wenn man kein gro√üartiger Mathematiker ist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>