<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ–•ğŸ» ğŸ‘©ğŸ» ğŸ‘©ğŸ½ Power BIã®ãƒ¬ãƒãƒ¼ãƒˆã«Microsoft SQLã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã€‚Mindboxã®ä¾‹ã«ã¤ã„ã¦ ğŸ‘°ğŸ¾ âœ‹ğŸ¼ ğŸ’‹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åºƒå‘Šã¸ã®æŠ•è³‡ãŒã„ã‹ã«åŠ¹æœçš„ã§ã‚ã‚‹ã‹ã‚’ç†è§£ã—ãŸã„å ´åˆã¯ã€æ‰‹ç´™ã€è¨ªå•ã€æ³¨æ–‡ã€åç›Šãªã©ã™ã¹ã¦ã‚’æ¸¬å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹é€Ÿåº¦ã‚‚é‡è¦ã§ã™ã€‚æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«ã€Microsoft Power BIã§ç¾ã—ãã‚ã‹ã‚Šã‚„ã™ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚ã¾ãŸã€ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã“ã¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Power BIã®ãƒ¬ãƒãƒ¼ãƒˆã«Microsoft SQLã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã€‚Mindboxã®ä¾‹ã«ã¤ã„ã¦</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506740/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åºƒå‘Šã¸ã®æŠ•è³‡ãŒã„ã‹ã«åŠ¹æœçš„ã§ã‚ã‚‹ã‹ã‚’ç†è§£ã—ãŸã„å ´åˆã¯ã€æ‰‹ç´™ã€è¨ªå•ã€æ³¨æ–‡ã€åç›Šãªã©ã™ã¹ã¦ã‚’æ¸¬å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹é€Ÿåº¦ã‚‚é‡è¦ã§ã™ã€‚</font><font style="vertical-align: inherit;">æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«ã€Microsoft Power BIã§ç¾ã—ãã‚ã‹ã‚Šã‚„ã™ã„ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€ãƒ¬ãƒãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ã‚’ç°¡ç´ åŒ–ã™ã‚‹ã“ã¨ã§ã€ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ ¼ç´ã«å½¹ç«‹ã¡ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€ç‰¹ã«æƒ…å ±ãŒå¤šãã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹ã“ã¨ãŒé›£ã—ã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚</font><font style="vertical-align: inherit;">Microsoft SQLã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã™ãŒã€åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font></font></p><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESPã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹éš›ã®å•é¡Œ</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€æ–°ã®ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆEãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¾ãŸã¯ESPï¼‰ã¯ã€é€ä¿¡ã€é…ä¿¡ã€é–‹å°ã€ã‚¯ãƒªãƒƒã‚¯ã¨ã„ã£ãŸãƒ¡ãƒ¼ãƒªãƒ³ã‚°ã®çµ±è¨ˆã‚’åé›†ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€Mindboxãªã©ã®ã‚ˆã‚Šé«˜åº¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ã€æ³¨æ–‡ã¨åç›Šã‚’ã“ã“ã«è¿½åŠ ã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€ãƒ‡ãƒ¼ã‚¿ã¯Google Analyticsã‚„Yandex.Metricsã‚’ä½¿ç”¨ã—ã¦åé›†ã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã¯ã©ã“ã‹ã«ä¿å­˜ã•ã‚Œã€ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ APIã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€æ¬¡ã®ç†ç”±ã«ã‚ˆã‚Šã€ã“ã‚Œã‚‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã«é–¢ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯å›°é›£ã§ã™ã€‚</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã¯ã•ã¾ã–ã¾ãªå½¢å¼ã§ä¿å­˜ã§ãã€å¤šãã®å ´åˆä¸ä¾¿ã§ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¤‡é›‘ãªèªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ã€è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å›°é›£ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã¯ESPã«éå»æ•°ã‹æœˆé–“ã—ã‹ä¿å­˜ã§ãã¾ã›ã‚“ã€‚é€šå¸¸ã€å¤ã„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€APIãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¸¯åŸŸå¹…ã®åˆ¶é™ã«ã‚ˆã‚Šã€è¿…é€Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Power BIã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ãƒãƒ¼ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ›´æ–°ã‚’æ•´ç†ã™ã‚‹å ´åˆã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€ã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å˜ä¸€ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€æ•°ç™¾ã¾ãŸã¯æ•°åƒã‚‚ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¨åŒã˜æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å¢—åŠ ã‚’æ—¥ã”ã¨ã«åˆ†æã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ã“ã‚Œã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ãŸã„æ—¥æ•°ã ã‘å®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">å˜ä¸€ã®ã‚¯ã‚¨ãƒªãŒ1ç§’é–“å®Ÿè¡Œã•ã‚ŒãŸã¨ã—ã¦ã‚‚ã€Power BIã§ã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨æ›´æ–°ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p><br>
<p> &nbsp;    &nbsp;   &nbsp;â€” Microsoft SQL Server.    &nbsp;&nbsp; , &nbsp; &nbsp; .    SQL-    ,   MS&nbsp;Azure  BigQuery.</p><br>
<p><strong> &nbsp;:</strong>    &nbsp;   .  ESP-   &nbsp;     &nbsp;. &nbsp;    &nbsp; SQL- &nbsp;   . ,   ,   &nbsp;   &nbsp;, â€¦    &nbsp;3&nbsp;!</p><br>
<p>    API ESP      :</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/929/374/8eb/9293748eb6a2fd08d2c004d3a478cb59.png" alt="ESP APIã¸ã®æ¨™æº–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çµæœ" width="435" height="200"></p><br>
<p> ,   :     .</p><br>
<p>    SQL-      .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/0f9/18b/b2f/0f918bb2f65691737dc02d715e639274.png" alt="Microsoft SQLã‚µãƒ¼ãƒãƒ¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ã™ã‚‹ã¨ãã«å¿…è¦ãªæœŸé–“ã®æƒ…å ±" width="926" height="409"></p><br>
<p>           ,   SQL-       .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/2d9/73f/11c/2d973f11c0b1b2c91f94649268f282fb.png" alt="Microsoft SQL Serverã‹ã‚‰ã®æ¯æ—¥ã®çµ±è¨ˆ" width="873" height="381"></p><br>
<h2> &nbsp;  &nbsp;Microsoft SQL Server</h2><br>
<p> SQL-    ,    .            Node.js.          API-.</p><br>
<p>   API-   &nbsp;ESP,  &nbsp;  &nbsp; &nbsp; . &nbsp;   ,      &nbsp;.</p><br>
<p> , &nbsp; &nbsp;  ,  &nbsp; &nbsp;  &nbsp; Power BI&nbsp;&nbsp;:   ,  &nbsp;.</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/d64/fa9/d99/d64fa9d9966babdc7a5e8394512f50d3.png" alt="Microsoft SQL Serverã‚’ä½¿ç”¨ã—ã¦Mindboxã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹" width="1920" height="1080"></p><br>
<p>, &nbsp;  &nbsp; &nbsp; &nbsp;Mindbox. &nbsp;  &nbsp;â€”  ,   &nbsp;,  &nbsp; Â«â†’â†’â†’ &nbsp; &nbsp;â†’ &nbsp;Â».</p><br>
<p>       &nbsp; &nbsp;, &nbsp; .</p><br>
<ol>
<li>Mindbox     ,  .       â€” 10 000,     500-1000  â€”    API.        .     ,       ,   Mindbox.</li>
<li>&nbsp;API Mindbox     &nbsp;.    c&nbsp;&nbsp;ID ( ) , &nbsp;,   &nbsp;, ID&nbsp;  ,  &nbsp;  &nbsp; .</li>
<li>    ,       .     , &nbsp;&nbsp;  .</li>
<li> API- &nbsp;Mindbox    &nbsp; .     ,      &nbsp;,  .   , &nbsp;&nbsp;   .       .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mindboxã¯ã€ã»ã¨ã‚“ã©ã®å ´åˆãƒ¬ãƒãƒ¼ãƒˆã«å¿…è¦ã¨ã•ã‚Œãªã„ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">SQLã‚µãƒ¼ãƒãƒ¼ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã™ãã«é›†è¨ˆã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€Ÿåº¦ãŒå‘ä¸Šã—ã€Power BIãƒ¬ãƒãƒ¼ãƒˆã§ã®å‡¦ç†ãŒç°¡ç´ åŒ–ã•ã‚Œã¾ã™ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®æ©Ÿä¼šã«ã€Mindboxã®è£½å“ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼Ilya Tsyrulnikovã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚</font></font><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€Œ2020å¹´6æœˆã«ã€éåŒæœŸã§å‹•ä½œã—ã€ã™ãã«å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™æ–°ã—ã„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPIã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€éå»6ã‹æœˆã®ã™ã¹ã¦ã®æ³¨æ–‡ã‚’1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†æ¥çš„ã«ã¯ã€BIã‚·ã‚¹ãƒ†ãƒ ã®1ã¤ã®æ¨™æº–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹äºˆå®šã§ã™ã€‚</font><font style="vertical-align: inherit;">BIã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯ã€å€‹åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å°å…¥ã‚„ã‚µãƒãƒ¼ãƒˆãªã—ã§è‡ªå‹•çš„ã«å±Šãã¾ã™ã€‚ã€</font></font></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft SQL Data Collectorã®ä»•çµ„ã¿</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã§ãã¾ã™ã€‚</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã§ããŸæœ€å¤§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³IDã‚’ç¢ºèªã—ã¾ã™ã€‚</font></font></li>
<li>  API Mindbox , ID&nbsp; ,   ID&nbsp;  .    , &nbsp; &nbsp; ID.</li>
<li>  , &nbsp; &nbsp;&nbsp;  .  &nbsp; 1. &nbsp;  , , &nbsp;  &nbsp; ,  Mindbox  .</li>
</ol><br>
<p>     .  &nbsp;     &nbsp;&nbsp;.</p><br>
<pre><code class="plaintext hljs">/* MSSQL */<font></font>
const config = require('./config.js');<font></font>
/**<font></font>
   :<font></font>
module.exports = {<font></font>
<font></font>
mssql: {<font></font>
user: 'sa',<font></font>
password: 'mssqlpassword',<font></font>
server: 'mssqlhost',<font></font>
database: 'mssqldbname',<font></font>
connectionTimeout: 60000,<font></font>
requestTimeout: 60000<font></font>
},<font></font>
<font></font>
mindbox_api_key: '___API_mindbox'<font></font>
};<font></font>
**/<font></font>
<font></font>
const async = require('async');<font></font>
const request = require('request');<font></font>
const https = require("https");<font></font>
const sql = require('mssql');<font></font>
var parseString = require('xml2js').parseString;<font></font>
var _ = require('lodash');<font></font>
var iconv = require('iconv-lite');<font></font>
<font></font>
//  SQL-<font></font>
sql.connect(config.mssql, err =&gt; {<font></font>
// Query<font></font>
if (err) {<font></font>
console.log('SQL connect error: ', err, config.mssql);<font></font>
}<font></font>
})<font></font>
<font></font>
sql.on('error', err =&gt; {<font></font>
console.log('SQL server error: ', err);<font></font>
// ... error handler<font></font>
})<font></font>
<font></font>
setTimeout(function() {<font></font>
//     ,     <font></font>
var operarions = ['EksportDejstvijPoRuchnym', 'EksportDejstvijPoRassylkam', 'EksportDejstvijPoRassylkamSkandinavskij', 'EksportDejstvijPoRassylkamNovoe', 'EksportDejstvijPoRassylkamSkolkovskij', 'EksportDejstvijPoRassylkamDsk1', 'EksportDejstvijPoRassylkamDyxanie', 'EksportDejstvijPoRassylkamPokolenie', 'EksportDejstvijPoRassylkamFsk'];<font></font>
async.forEach(operarions, function(operation, cb1) {<font></font>
mbxChunk(operation, cb1);<font></font>
},<font></font>
function(err, res) {<font></font>
if (err) {<font></font>
sql.close();<font></font>
process.exit();<font></font>
return;<font></font>
}<font></font>
console.log('DONE!');<font></font>
sql.close();<font></font>
process.exit();<font></font>
}<font></font>
)<font></font>
}, 1000);<font></font>
<font></font>
/**<font></font>
*        <font></font>
*/<font></font>
function mbxChunk(operation, cb) {<font></font>
console.log('New Chunk '+operation);<font></font>
var sqlreq = new sql.Request();<font></font>
//  mindboxId  ,  ,   ID  <font></font>
sqlreq.query("SELECT MAX(mindboxId) AS last FROM "+config.mssql.database+".dbo."+operation+";", function(err, maxres) {<font></font>
if (err || !maxres.recordset[0]) {<font></font>
console.log('MsSQL SELECT MAX error: ', err);<font></font>
cb(err);<font></font>
return;<font></font>
}<font></font>
var chunk = parseInt(maxres.recordset[0].last || 0) + 1;<font></font>
<font></font>
// ,   ID=chunk<font></font>
mbxCall(operation, chunk, function(err, xml) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ' started');<font></font>
if (err) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox API request error: ', err);<font></font>
cb(err);<font></font>
}<font></font>
parseString(xml, function(err, res) {<font></font>
if (err) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox returns invalid XML, parse error: ', err);<font></font>
console.log(xml);<font></font>
cb(err);<font></font>
}<font></font>
if (res &amp;&amp; res.result &amp;&amp; res.result.status == 'Success') {<font></font>
var rows = res.result.customerActions ? res.result.customerActions[0].customerAction : [];<font></font>
if (rows.length &gt; 0) {<font></font>
mbxHandle(operation, rows, function(err, res) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ' + '+rows.length.toString()+' done!');<font></font>
mbxChunkCopy(operation, cb);<font></font>
});<font></font>
}<font></font>
else {<font></font>
console.log(operation + ' - data is over!');<font></font>
cb();<font></font>
}<font></font>
}<font></font>
else {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox returns unsuccessfull result: ', res);<font></font>
cb(err);<font></font>
}<font></font>
});<font></font>
})<font></font>
})<font></font>
}<font></font>
<font></font>
function mbxChunkCopy(operation, cb) {<font></font>
mbxChunk(operation, cb);<font></font>
}<font></font>
<font></font>
/**<font></font>
*   API Mindbox<font></font>
*  1000 . ID    startId<font></font>
*/<font></font>
function mbxCall(operation, startId, cb) {<font></font>
var request = require("request");<font></font>
var options = {<font></font>
method: 'POST',<font></font>
url: 'https://api.mindbox.ru/v3/operations/sync',<font></font>
qs: {<font></font>
endpointId: 'fskuniversalpoint', operation: operation<font></font>
},<font></font>
headers: {<font></font>
"Cache-Control": "no-cache",<font></font>
"Content-Type": "application/xml",<font></font>
"Accept": "application/xml",<font></font>
"Authorization": 'Mindbox secretKey="'+config.mindbox_api_key+'"'<font></font>
},<font></font>
body: '&lt;operation&gt;\r\n  &lt;page&gt;\r\n    &lt;firstmindboxid&gt;' + startId.toString() + '&lt;/firstmindboxid&gt;\r\n    &lt;pagenumber&gt;1&lt;/pagenumber&gt;\r\n    &lt;itemsperpage&gt;1000&lt;/itemsperpage&gt;\r\n  &lt;/page&gt;\r\n&lt;/operation&gt;'<font></font>
};<font></font>
<font></font>
request(options, function (error, response, body) {<font></font>
cb(error, body);<font></font>
});<font></font>
}<font></font>
<font></font>
/**<font></font>
*     Mindbox<font></font>
*    table MsSQL<font></font>
*/<font></font>
function mbxHandle(table, rows, cb) {<font></font>
console.log(rows.length.toString() + ' items to save into '+table);<font></font>
var i = 0;<font></font>
<font></font>
async.forEach(rows, function(row, cb1) {<font></font>
try {<font></font>
var sqlreq = new sql.Request();<font></font>
sqlreq.input('mindboxId', sql.Int, parseInt(row.ids[0].mindboxId[0]));<font></font>
sqlreq.input('transactionId', sql.VarChar, (row.ids[0].transactionId ? row.ids[0].transactionId[0] : ''));<font></font>
sqlreq.input('systemName', row.actionTemplate[0].systemName[0]);<font></font>
sqlreq.input('name', sql.NVarChar, row.actionTemplate[0].name[0]);<font></font>
sqlreq.input('dateTimeUtc', sql.DateTime, new Date(row.dateTimeUtc[0]));<font></font>
sqlreq.input('pointOfContact_externalId', sql.VarChar, row.pointOfContact[0].ids[0].externalId[0]);<font></font>
sqlreq.input('customer_mindboxId', sql.VarChar, (row.customer[0].ids[0] ? row.customer[0].ids[0].mindboxId[0] : ''));<font></font>
sqlreq.input('customer_webSiteId', sql.VarChar, (row.customer[0].ids[0].webSiteId ? row.customer[0].ids[0].webSiteId[0] : ''));<font></font>
sqlreq.input('channel', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].channel ? row.mailing[0].channel[0] : ''));<font></font>
sqlreq.input('action', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].action ? row.mailing[0].action[0] : ''));<font></font>
sqlreq.input('notSentReason_name', sql.VarChar, row.ids[0].mindboxId[0]);<font></font>
sqlreq.input('notSentReason_systemName', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].notSentReason &amp;&amp;  row.mailing[0].notSentReason[0].name ? row.mailing[0].notSentReason[0].name[0] : ''));<font></font>
sqlreq.input('groupingKey', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].groupingKey ? row.mailing[0].groupingKey[0] : ''));<font></font>
sqlreq.input('link', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].link ? row.mailing[0].link[0] : ''));<font></font>
sqlreq.input('viewEmailMessageUrl', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].viewEmailMessageUrl ? row.mailing[0].viewEmailMessageUrl[0] : ''));<font></font>
var q = "INSERT INTO "+config.mssql.database+".dbo."+table<font></font>
+ " (mindboxId, transactionId, systemName, name, dateTimeUtc, pointOfContact_externalId, customer_mindboxId, customer_webSiteId, channel, [action], notSentReason_name, notSentReason_systemName, groupingKey, link, viewEmailMessageUrl)"<font></font>
+ " VALUES(@mindboxId, @transactionId, @systemName, @name, @dateTimeUtc, @pointOfContact_externalId, @customer_mindboxId, @customer_webSiteId, @channel, @action, @notSentReason_name, @notSentReason_systemName, @groupingKey, @link, @viewEmailMessageUrl);";<font></font>
}<font></font>
catch (err) {<font></font>
console.log('MsSQL input vars error: ', err, JSON.stringify(row));<font></font>
return cb1(err);<font></font>
}<font></font>
sqlreq.query(q, function(err, r) {<font></font>
if (err) {<font></font>
console.log('MsSQL query error: ', err, JSON.stringify(row));<font></font>
}<font></font>
cb1(err, r);<font></font>
})<font></font>
}, function(err, r) {<font></font>
cb(err, r);<font></font>
});<font></font>
}</code></pre><br>
<p>  , &nbsp;&nbsp;  , ,   .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/e1b/763/f84/e1b763f8481d28a292fe9e90652b8e17.jpg" alt="Microsoft SQLã‚’ä½¿ç”¨ã—ã¦åé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒãƒ¼ãƒˆ" width="1364" height="736"></p><br>
<p>&nbsp;  Power BI&nbsp;     &nbsp;Mindbox &nbsp;  :</p><br>
<pre><code class="plaintext hljs">let<font></font>
//       Mindbox<font></font>
   ExportAction = (name as text, page as number)=&gt;let<font></font>
   Source=Xml.Tables(Web.Contents("https://api.mindbox.ru/v3/",<font></font>
                     [Headers=[#"content-type"="application/xml",Accept="application/xml",Authorization="Mindbox secretKey="""""],<font></font>
                     RelativePath="operations/sync",<font></font>
                     Query=[endpointId="",operation=name],<font></font>
                     Content=Text.ToBinary("&lt;operation&gt;&lt;page&gt;&lt;firstmindboxid&gt;0&lt;/firstmindboxid&gt;&lt;pagenumber&gt;"&amp;Number.ToText(page)&amp;"&lt;/pagenumber&gt;&lt;itemsperpage&gt;10000&lt;/itemsperpage&gt;&lt;/page&gt;&lt;/operation&gt;")])),<font></font>
   Data= try Source{0}[customerActions] otherwise null //    <font></font>
in<font></font>
   Data,<font></font>
//  <font></font>
   name="XXXXXXXXXXX",  //     Mindbox<font></font>
   Source = List.Generate( ()=&gt;                                            //        Mindbox<font></font>
            [Result = ExportAction(name, 1), Page = 1],                    //    .<font></font>
            each [Result] &lt;&gt; null,                                         //   ,   <font></font>
            each [Result = ExportAction(name,[Page]+1), Page = [Page]+1],  //     <font></font>
            each [Result]),<font></font>
//     <font></font>
    #"Converted to Table" = Table.FromList(Source, Splitter.SplitByNothing(), null, null, ExtraValues.Error)<font></font>
//   *<font></font>
//   *<font></font>
//     <font></font>
//   *<font></font>
//   *<font></font>
//   result = ..........<font></font>
in<font></font>
    result</code></pre><br>
<p>&nbsp;&nbsp;  .  2-3. , ,  &nbsp;,  &nbsp; &nbsp;   &nbsp;  &nbsp; .</p><br>
<p>&nbsp; &nbsp;,  ,  ,    . &nbsp;  &nbsp;.       , &nbsp;   &nbsp;.</p><br>
<p>    2020  PowerQuery    () ,        ,     API    .</p><br>
<p> &nbsp;Power BI&nbsp; ,   &nbsp;SQL-, &nbsp;    &nbsp;   &nbsp;â€”   .</p><br>
<p>&nbsp;   ( &nbsp; &nbsp;API):</p><br>
<br>
<pre><code class="plaintext hljs">let<font></font>
Source = Sql.Database("ServerNameÂ«, Â«DataBaseÂ»),<font></font>
Result = Source{[Schema="dbo",Item="TableName"]}[Data]<font></font>
in<font></font>
Result</code></pre><br>
<p>           ,         Power query  .</p><br>
<br>
<h2>   &nbsp;Power BI</h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€Mindboxã¨Google Analyticsã®ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦åé›†ã§ãã‚‹ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/aae/bd3/fff/aaebd3fff86c4fa89626c19330db1bbd.png" alt="Microsoft SQLã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸPower BIãƒ¬ãƒãƒ¼ãƒˆ" width="1651" height="899"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šè¨˜ã®æ–¹æ³•ã«å¾“ã£ã¦ã€Mindboxã¨Google Analyticsã‹ã‚‰ã®æ¯æ™©ã®ãƒ‡ãƒ¼ã‚¿ãŒSQLã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åé›†ã•ã‚Œï¼ˆç‰¹åˆ¥ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãªã—ã§ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ï¼‰ã€SQLã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åé›†ãŠã‚ˆã³é›†è¨ˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒPower BIã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ãƒãƒ¼ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€å–¶æ¥­æ—¥ã®åˆã‚ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¬ãƒãƒ¼ãƒˆã§æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja506726/index.html">ã‚·ã‚¹ãƒ†ãƒ ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã¨æ‰¿èªã«Rutokenãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚’ä½¿ç”¨ã—ãŸçµŒé¨“ï¼ˆãƒ‘ãƒ¼ãƒˆ2ï¼‰</a></li>
<li><a href="../ja506730/index.html">Snortã¾ãŸã¯Suricataã€‚ãƒ‘ãƒ¼ãƒˆ1ï¼šä¼æ¥­ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®ç„¡æ–™ã®IDS / IPSã‚’é¸æŠã™ã‚‹</a></li>
<li><a href="../ja506732/index.html">UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ„ç¹”å…¨ä½“ã§ã®å†åˆ©ç”¨</a></li>
<li><a href="../ja506734/index.html">é›»æ°—ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®éæ¸¡è¨ˆç®—</a></li>
<li><a href="../ja506736/index.html">ã‚¯ãƒ©ã‚¹ã«ã¯ã„ãã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja506742/index.html">ãƒ”ã‚¯ã‚»ãƒ«ã®ä¸­å¿ƒã‚’ï¼ˆ0.5; 0.5ï¼‰ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ç†ç”±</a></li>
<li><a href="../ja506748/index.html">æ¤œç–«å£²ä¸ŠãŒä¼¸ã³ã¦ã„ã‚‹ã®ã¯èª°ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja506758/index.html">è£½å“ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®åŸå‰‡ã«åŸºã¥ã„ã¦ä¼šè­°ã‚’é–‹å‚¬ã—ã€10å¹´é–“å„å‚åŠ è€…ãŒä¸»å‚¬è€…ã§ã—ãŸ</a></li>
<li><a href="../ja506762/index.html">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¦ã‚£ãƒ¼ã‚¯25ï¼šãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆã®è¨˜éŒ²çš„ãªãƒ‘ãƒƒãƒã‚»ãƒƒãƒˆ</a></li>
<li><a href="../ja506766/index.html">æœ‰æ–™ã®RPAãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æ‹’å¦ã—ã€OpenSourceï¼ˆOpenRPAï¼‰ã«åŸºã¥ã„ã¦ã„ã¾ã™</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>