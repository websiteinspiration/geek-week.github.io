<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👶🏼 👩🏼‍🔬 👨🏼‍🎤 如何在C ++中处理异常时减少开销 🕴🏾 🧠 🧢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在开发软件时遇到的许多情况下，处理运行时错误非常重要-从错误的用户输入到损坏的网络数据包。如果用户突然下载PNG而不是PDF，或者在更新软件时断开了网络电缆的连接，则应用程序不会崩溃。用户期望该程序无论发生什么都会工作，并且可以在后台处理紧急情况，或者通过友好界面发送的消息让他选择解决问题的选项。
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>如何在C ++中处理异常时减少开销</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/488244/"><img src="https://habrastorage.org/webt/ml/92/sj/ml92sjlj3hq1paudqwokbods74m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在开发软件时遇到的许多情况下，处理运行时错误非常重要-从错误的用户输入到损坏的网络数据包。如果用户突然下载PNG而不是PDF，或者在更新软件时断开了网络电缆的连接，则应用程序不会崩溃。用户期望该程序无论发生什么都会工作，并且可以在后台处理紧急情况，或者通过友好界面发送的消息让他选择解决问题的选项。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
异常处理可能是一个令人困惑，复杂的任务，并且对于许多C ++开发人员而言，这从根本上来说很重要，它会大大降低应用程序的速度。但是，与许多其他情况一样，有几种方法可以解决此问题。接下来，我们将深入研究C ++中的异常处理过程，处理其陷阱，并观察其如何影响应用程序的速度。另外，我们将研究可用于减少开销的替代方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我不会敦促您完全停止使用这些异常。</font><font style="vertical-align: inherit;">应该应用它们，但是要在无法避免的情况下精确地应用它们：例如，如何报告在构造函数内部发生的错误？</font><font style="vertical-align: inherit;">我们将主要考虑使用异常来处理运行时错误。</font><font style="vertical-align: inherit;">使用我们将要讨论的替代方法，可以使您开发更可靠和易于维护的应用程序。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">快速性能测试</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与控制程序进度的常规机制相比，C ++中的异常要慢多少？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
异常显然比简单的break或return操作慢。</font><font style="vertical-align: inherit;">但是，让我们找出速度慢了多少！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在下面的示例中，我们编写了一个简单的函数，该函数随机生成数字，并在检查一个生成的数字的基础上给出/不给出错误消息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们测试了几种用于错误处理的实现选项：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引发带有整数参数的异常。</font><font style="vertical-align: inherit;">尽管这在实践中并未特别适用，但这是在C ++中使用异常的最简单方法。</font><font style="vertical-align: inherit;">因此，我们消除了测试实施中的过度复杂性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">丢弃std :: runtime_error，它可以发送文本消息。</font><font style="vertical-align: inherit;">与前一个选项不同，此选项在实际项目中使用更多。</font><font style="vertical-align: inherit;">让我们来看看第二种选择是否会比第一种明显增加间接费用成本。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空收益。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回C样式int错误代码</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了运行测试，我们使用了简单的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google基准测试库</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">她在一个周期内反复运行了每个测试。</font><font style="vertical-align: inherit;">接下来，我将描述一切如何发生。</font><font style="vertical-align: inherit;">不耐烦的读者可以立即跳转到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
测试代码</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的超复杂随机数生成器：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> randomRange = <span class="hljs-number">2</span>;  <span class="hljs-comment">//     0  2.</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> errorInt = <span class="hljs-number">0</span>; 	<span class="hljs-comment">//    ,    0.</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getRandom</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">return</span> random() % randomRange;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
测试功能：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 1.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exitWithBasicException</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">if</span> (getRandom() == errorInt) {
    	<span class="hljs-keyword">throw</span> <span class="hljs-number">-2</span>;<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 2.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exitWithMessageException</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">if</span> (getRandom() == errorInt) {
    	<span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"Halt! Who goes there?"</span>);<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 3.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">exitWithReturn</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">if</span> (getRandom() == errorInt) {
    	<span class="hljs-keyword">return</span>;<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 4.</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">exitWithErrorCode</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">if</span> (getRandom() == errorInt) {
    	<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就是这样，现在我们可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google基准测试库了</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 1.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">BM_exitWithBasicException</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
    	<span class="hljs-keyword">try</span> {<font></font>
        	exitWithBasicException();<font></font>
    	} <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">int</span> ex) {
        	<span class="hljs-comment">//  ,    .</span><font></font>
    	}<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 2.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">BM_exitWithMessageException</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
    	<span class="hljs-keyword">try</span> {<font></font>
        	exitWithMessageException();<font></font>
    	} <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::runtime_error &amp;ex) {
        	<span class="hljs-comment">//  ,    </span><font></font>
    	}<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 3.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">BM_exitWithReturn</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {<font></font>
    	exitWithReturn();<font></font>
	}<font></font>
}<font></font>
<span class="hljs-comment">// 4.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">BM_exitWithErrorCode</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
    	<span class="hljs-keyword">auto</span> err = exitWithErrorCode();
    	<span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) {
        	<span class="hljs-comment">// `handle_error()` …  - </span><font></font>
    	}<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span><font></font>
BENCHMARK(BM_exitWithBasicException);<font></font>
BENCHMARK(BM_exitWithMessageException);<font></font>
BENCHMARK(BM_exitWithReturn);<font></font>
BENCHMARK(BM_exitWithErrorCode);<font></font>
<font></font>
<span class="hljs-comment">//  !</span><font></font>
BENCHMARK_MAIN();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于那些想要触摸美丽的人，我们</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布了完整的代码</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在控制台中，根据编译选项，我们看到不同的测试结果：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -O0：</font></font></b><br>
<br>
<pre><code class="bash hljs">------------------------------------------------------------------<font></font>
Benchmark                        Time             CPU   Iterations<font></font>
------------------------------------------------------------------<font></font>
BM_exitWithBasicException     1407 ns         1407 ns       491232<font></font>
BM_exitWithMessageException   1605 ns         1605 ns       431393<font></font>
BM_exitWithReturn              142 ns          142 ns      5172121<font></font>
BM_exitWithErrorCode           144 ns          143 ns      5069378<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行-O2：</font></font></b><br>
<br>
<pre><code class="bash hljs">------------------------------------------------------------------<font></font>
Benchmark                        Time             CPU   Iterations<font></font>
------------------------------------------------------------------<font></font>
BM_exitWithBasicException     1092 ns         1092 ns       630165<font></font>
BM_exitWithMessageException   1261 ns         1261 ns       547761<font></font>
BM_exitWithReturn             10.7 ns         10.7 ns     64519697<font></font>
BM_exitWithErrorCode          11.5 ns         11.5 ns     62180216<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（于2015年MacBook Pro 2.5GHz i7推出）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果令人惊叹！</font><font style="vertical-align: inherit;">看看有无异常（空返回和errorCode）之间的代码速度之间的巨大差距。</font><font style="vertical-align: inherit;">借助编译器优化，这个差距更大！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
无疑，这是一个伟大的考验。</font><font style="vertical-align: inherit;">编译器可能会对测试3和4进行了大量的代码优化，但无论如何差距还是很大的。</font><font style="vertical-align: inherit;">因此，这使我们能够估计使用异常时的开销。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多亏了零成本模型，在大多数C ++中的try块实现中，都没有额外的开销。</font><font style="vertical-align: inherit;">但是捕获块的工作要慢得多。</font><font style="vertical-align: inherit;">通过简单的示例，我们可以看到如何缓慢地抛出和捕获异常。</font><font style="vertical-align: inherit;">即使在这么小的调用堆栈上！</font><font style="vertical-align: inherit;">随着堆栈深度的增加，开销将线性增加。</font><font style="vertical-align: inherit;">这就是为什么设法捕获尽可能接近引发异常的代码如此重要的原因。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好吧，我们发现异常工作缓慢。</font><font style="vertical-align: inherit;">然后也许停止它？</font><font style="vertical-align: inherit;">但是，并非一切都那么简单。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么每个人都继续使用异常？</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++性能技术报告（第5.4章）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
中充分记录了异常的好处</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<blockquote>        ,      ,     errorCode- [  ],       .  ,                .          ,              .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再一次：主要思想是无法忽略和忘记异常。这使异常成为非常强大的内置C ++工具，能够通过我们从C继承的错误代码来代替困难的处理。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，异常在与程序不直接相关的情况下非常有用，例如，“硬盘已满”。 “或”网络电缆已损坏。在这种情况下，例外是理想的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，处理与程序直接相关的错误处理的最佳方法是什么？</font><font style="vertical-align: inherit;">无论如何，我们都需要一种机制来明确地指示开发人员，他应该检查错误，为他提供有关该错误的足够信息（如果出现了此错误），以消息的形式或其他某种格式进行传输。</font><font style="vertical-align: inherit;">似乎我们再次返回到内置异常，但是刚才我们将讨论替代解决方案。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预期</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了开销之外，异常还有一个缺点：它们按顺序工作：异常一旦抛出就需要捕获并处理，不可能将其推迟到以后。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们对于它可以做些什么呢？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明有办法。 Andrei Alexandrescu教授为我们开设了一个特别课程，称为Expected。它允许您创建T类的对象（如果一切正常）或Exception类的对象（如果发生错误）。就是这个或那个。或或。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本质上，这是对数据结构的包装，在C ++中将其称为联合。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们举例说明他的想法：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span>&gt;
<span class="hljs-title">class</span> <span class="hljs-title">Expected</span> {</span>
<span class="hljs-keyword">private</span>:
	<span class="hljs-comment">//  union:  ,   .     </span>
	<span class="hljs-keyword">union</span> {<font></font>
    	T value;<font></font>
    	Exception exception;<font></font>
	};<font></font>
<font></font>
<span class="hljs-keyword">public</span>:
	<span class="hljs-comment">//    `Expected`   T,   .</span>
	Expected(<span class="hljs-keyword">const</span> T&amp; value) ...<font></font>
<font></font>
	<span class="hljs-comment">//    `Expected`   Exception,  -   </span>
	Expected(<span class="hljs-keyword">const</span> Exception&amp; ex) ...<font></font>
<font></font>
	<span class="hljs-comment">//    :    </span>
	<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">hasError</span><span class="hljs-params">()</span> ...

	<span class="hljs-comment">//   T</span>
	T <span class="hljs-title">value</span><span class="hljs-params">()</span> ...

	<span class="hljs-comment">//        (  Exception)</span>
	Exception <span class="hljs-title">error</span><span class="hljs-params">()</span> ...
}</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全面实施肯定会更加困难。</font><font style="vertical-align: inherit;">但是Expected的主要思想是，在同一个对象（Expected＆e）中，我们可以接收程序正常运行的数据（它将具有我们已知的类型和格式：T＆值）和错误数据（例外和例外）。</font><font style="vertical-align: inherit;">因此，很容易再次检查一下我们遇到的情况（例如，使用hasError方法）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，现在没有人会强迫我们在这一秒内处理异常。</font><font style="vertical-align: inherit;">我们将没有throw（）调用或catch块。</font><font style="vertical-align: inherit;">相反，我们可以在方便时引用Exception对象。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预期性能测试</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将为新类编写类似的性能测试：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 5. Expected! Testcase 5 </span><font></font>
<font></font>
<span class="hljs-function">Expected&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">exitWithExpected</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">if</span> (getRandom() == errorInt) {
    	<span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"Halt! If you want..."</span>);  <span class="hljs-comment">//  : return,   throw!</span><font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Benchmark.</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">BM_exitWithExpected</span><span class="hljs-params">(benchmark::State&amp; state)</span> </span>{
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> _ : state) {
    	<span class="hljs-keyword">auto</span> expected = exitWithExpected();<font></font>
<font></font>
    	<span class="hljs-keyword">if</span> (expected.hasError()){
        	<span class="hljs-comment">// Handle in our own time.</span><font></font>
    	}<font></font>
    	<span class="hljs-comment">// Or we can use the value...</span>
    	<span class="hljs-comment">// else {</span>
    	<span class="hljs-comment">// 	doSomethingInteresting(expected.value());</span>
    	<span class="hljs-comment">// }</span><font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span><font></font>
BENCHMARK(BM_exitWithExpected);<font></font>
<font></font>
<span class="hljs-comment">// </span><font></font>
BENCHMARK_MAIN();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
击鼓！！！</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调试-O0：</font></font></b><br>
<br>
<pre><code class="bash hljs">------------------------------------------------------------------<font></font>
Benchmark                        Time             CPU   Iterations<font></font>
------------------------------------------------------------------<font></font>
BM_exitWithExpected            147 ns          147 ns      4685942<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行-O2：</font></font></b><br>
<br>
<pre><code class="bash hljs">------------------------------------------------------------------<font></font>
Benchmark                        Time             CPU   Iterations<font></font>
------------------------------------------------------------------<font></font>
BM_exitWithExpected           57.5 ns         57.5 ns     11873261<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不错！</font><font style="vertical-align: inherit;">对于未经优化的std :: runtime_error，我们可以将操作时间从1605减少到147纳秒。</font><font style="vertical-align: inherit;">通过优化，一切看起来都更好：从1261纳秒降至57.5纳秒。</font><font style="vertical-align: inherit;">这比使用-O0快10倍以上，比使用-O2快20倍以上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，与内置异常相比，Expected的工作速度快了很多倍，并且还为我们提供了更灵活的错误处理机制。</font><font style="vertical-align: inherit;">此外，它具有语义纯洁性，并且无需牺牲错误消息和剥夺用户的质量反馈。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例外并非绝对邪恶。</font><font style="vertical-align: inherit;">有时这一点都是好事，因为它们在达到预期目的时会非常有效地工作：在特殊情况下。</font><font style="vertical-align: inherit;">我们只有在使用更有效的解决方案的情况下，才开始遇到问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管我们的测试非常简单，但我们的测试显示：如果在仅发送数据（使用return）就足够的情况下不捕获异常（缓慢的catch块），则可以大大减少开销。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我们还简要介绍了Expected类以及如何使用它来加快错误处理过程。</font><font style="vertical-align: inherit;">Expected使跟踪程序的进度变得容易，也使我们更加灵活，可以将消息发送给用户和开发人员。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488230/index.html">SSD简介。第3部分。外形尺寸</a></li>
<li><a href="../zh-CN488232/index.html">大约技术：QATOK＃2</a></li>
<li><a href="../zh-CN488234/index.html">在Windows 7上使用QubesOS</a></li>
<li><a href="../zh-CN488240/index.html">一个没有尽头的无尽循环：圣杯虫的故事</a></li>
<li><a href="../zh-CN488242/index.html">VueJS + TS项目与SonarQube集成</a></li>
<li><a href="../zh-CN488246/index.html">iOS上的VoiceOver：每个控件的行为都不同</a></li>
<li><a href="../zh-CN488250/index.html">到Linux（L）问题</a></li>
<li><a href="../zh-CN488252/index.html">如何使用SLS降低开发新产品的成本</a></li>
<li><a href="../zh-CN488254/index.html">云安全责任分配模型</a></li>
<li><a href="../zh-CN488256/index.html">乡间别墅的自制换热器，效率达80％</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>