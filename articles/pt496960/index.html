<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆔 🧑🏿‍🤝‍🧑🏻 🎽 Acelerando gráficos usando OffscreenCanvas 👨🏾‍🤝‍👨🏼 ⛄️ ♣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A renderização de gráficos pode afetar seriamente o navegador. Especialmente quando se trata de produzir uma infinidade de elementos representando dia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acelerando gráficos usando OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A renderização de gráficos pode afetar seriamente o navegador. </font><font style="vertical-align: inherit;">Especialmente quando se trata de produzir uma infinidade de elementos representando diagramas na interface de um aplicativo complexo. </font><font style="vertical-align: inherit;">Você pode tentar melhorar a situação usando a interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cujo nível de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suporte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> está aumentando gradualmente. </font><font style="vertical-align: inherit;">Ele permite, usando um trabalhador da Web, mudar para ele as tarefas de formar uma imagem exibida em um elemento visível </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
O artigo, cuja tradução estamos publicando hoje, é dedicado ao uso da interface </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Aqui, falaremos sobre por que essa interface pode ser necessária, sobre o que realmente pode ser esperado de seu uso e sobre quais dificuldades podem surgir ao trabalhar com ela.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que prestar atenção ao OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O código envolvido na renderização do diagrama pode ter uma complexidade computacional suficientemente alta. Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muitos lugares,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> você pode encontrar histórias detalhadas sobre como produzir animações suaves e para garantir uma interação conveniente do usuário com a página, é necessário que a renderização de um quadro caiba em cerca de 10 ms, o que permite atingir 60 quadros por segundo. Se os cálculos necessários para a saída de um quadro demorar mais de 10 ms, isso resultará em "lentidão" perceptível na página. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao exibir diagramas, no entanto, a situação é agravada pelo seguinte:</font></font><br>
<br>
<ul>
<li>        —   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( —   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses problemas são candidatos ideais para uma abordagem de otimização clássica chamada dividir e conquistar. Nesse caso, estamos falando sobre a distribuição da carga de computação em vários segmentos. No entanto, antes do aparecimento da interface, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo o código de renderização precisava ser executado no encadeamento principal. A única maneira de esse código usar as APIs necessárias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do ponto de vista técnico, cálculos "pesados" poderiam ser enviados para um encadeamento de trabalhadores da Web anteriormente. Porém, como as chamadas responsáveis ​​pela renderização precisavam ser feitas no fluxo principal, isso exigia o uso de esquemas complexos de troca de mensagens entre o fluxo de trabalho e o fluxo principal no código de saída do gráfico. Além disso, essa abordagem geralmente oferece apenas um pequeno ganho de desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especificação</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos fornece um mecanismo para transferir o controle de superfície para exibir elementos gráficos </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em um trabalhador da Web. </font><font style="vertical-align: inherit;">Atualmente, esta especificação é suportada pelos navegadores Chrome e Edge (após a migração do Edge para o Chromium). </font><font style="vertical-align: inherit;">Espera-se que no Firefox o suporte </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apareça dentro de seis meses. </font><font style="vertical-align: inherit;">Se falamos sobre o Safari, ainda não se sabe se o suporte para esta tecnologia está planejado neste navegador.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saída do gráfico usando OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo de gráfico que exibe 100.000 pontos multicoloridos</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Para avaliar melhor as vantagens e desvantagens em potencial</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vejamos um exemplo da saída do diagrama "pesado" mostrado na figura anterior.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, consultamos </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando o novo método </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, chamamos o método </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fazendo isso para enviar uma mensagem ao trabalhador que contém um link para </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. É muito importante que aqui, como segundo argumento, você precise usar </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Isso permite que você faça o proprietário desse objeto trabalhador, o que permitirá que ele gerencie sozinho </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considerando que os tamanhos foram </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">originalmente herdados dos atributos </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e do </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, é nossa responsabilidade manter esses valores atualizados quando o elemento for redimensionado </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Aqui usamos o evento </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que nos dará a oportunidade, de acordo com </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de transmitir ao trabalhador informações sobre as novas dimensões do elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para simplificar o exemplo, usaremos componentes da biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este é um conjunto de componentes auxiliares que agregam componentes d3 ou complementam sua funcionalidade. Você </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode </font><font style="vertical-align: inherit;">trabalhar </font><font style="vertical-align: inherit;">sem os componentes d3fc. Tudo o que será discutido pode ser feito usando recursos JavaScript exclusivamente padrão.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vá para o código do arquivo </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Neste exemplo, para obter um aumento real no desempenho da renderização, usaremos o WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando recebemos uma mensagem contendo uma propriedade </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, assumimos que a mensagem veio do thread principal. Em seguida, obtemos o </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contexto </font><font style="vertical-align: inherit;">do elemento </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e passamos para o componente </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, chamamos o componente </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, passando os dados ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que queremos renderizar usando (abaixo, falaremos sobre de onde as variáveis ​​correspondentes </font><font style="vertical-align: inherit;">vieram </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, verificamos as propriedades </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que vieram na mensagem, e as usamos para definir as dimensões </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a área de visualização do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. O link </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não é usado diretamente. O fato é que a mensagem contém uma propriedade </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou propriedades </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O código de trabalho restante é responsável por configurar a renderização do que queremos exibir. </font><font style="vertical-align: inherit;">Não há nada de especial aqui; portanto, se tudo isso lhe é familiar, você pode prosseguir imediatamente para a próxima seção na qual discutiremos o desempenho.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, criamos um conjunto de dados contendo as coordenadas dos pontos distribuídos aleatoriamente em torno da origem x / y e ajustamos a escala. </font><font style="vertical-align: inherit;">Não definimos o intervalo dos valores x e y usando o método </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pois a série WebGL é exibida em tamanho real do elemento </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nas coordenadas normalizadas do dispositivo).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, configuramos uma série de pontos usando </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em seguida, configuramos os meios de acesso apropriados que permitem a leitura de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, definimos nossa própria função de verificação de igualdade, projetada para garantir que o componente não transmita </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUs a cada renderização. </font><font style="vertical-align: inherit;">Devemos expressar isso explicitamente, porque mesmo que saibamos que não modificaremos esses dados, o componente não poderá saber sobre eles sem executar uma verificação "suja" que consome muitos recursos.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este código permite colorir o gráfico. </font><font style="vertical-align: inherit;">Usamos o índice do ponto no conjunto de dados para selecionar uma cor adequada </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, depois convertemos para o formato necessário e o usamos para decorar o ponto de saída.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora que os pontos estão coloridos, tudo o que resta é animar o gráfico. Devido a isso, precisaremos de uma chamada de método constante </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Além disso, isso criará alguma carga no sistema. Simulamos o aumento e a diminuição da escala do gráfico usando </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para modificar as propriedades </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os quadros. Aqui, os valores dependentes do tempo são aplicados e calculados para que a escala do gráfico mude sem problemas. Além disso, modificamos o cabeçalho da mensagem para que um método seja chamado para iniciar o ciclo de renderização </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e para que não seja necessário chamar diretamente </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que este exemplo funcione, resta apenas importar as bibliotecas necessárias para o trabalhador. </font><font style="vertical-align: inherit;">Usamos para isso </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e também, para não usar as ferramentas para criar projetos, usamos uma lista de dependências compiladas manualmente. </font><font style="vertical-align: inherit;">Infelizmente, não podemos apenas fazer o download das compilações completas do d3 / d3fc, pois elas dependem do DOM e o que elas precisam não está disponível no trabalhador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ O código completo deste exemplo pode ser encontrado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telas e desempenho</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A animação em nosso projeto funciona graças ao uso </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de um trabalhador. Isso permite que o trabalhador processe páginas mesmo quando o segmento principal está ocupado com outras coisas. Se você olhar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a página do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projeto descrita na seção anterior e clicar no botão </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, poderá prestar atenção ao fato de que, quando a caixa de mensagem for exibida, a atualização das informações do carimbo de data / hora será interrompida. O segmento principal está bloqueado, mas a animação do gráfico não para.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janela do projeto</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Podemos organizar uma renderização iniciada pelo recebimento de mensagens do fluxo principal. Por exemplo, esses eventos podem ser enviados quando um usuário interage com um gráfico ou ao receber dados atualizados pela rede. Mas com essa abordagem, se o segmento principal estiver ocupado com algo e nenhuma mensagem for recebida no trabalhador, a renderização será interrompida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A renderização contínua do gráfico em condições em que nada acontece é uma ótima maneira de incomodar o usuário com um ventilador vibrante e bateria fraca. Como resultado, verifica-se que, no mundo real, a decisão sobre como dividir responsabilidades entre o thread principal e o thread de trabalho depende se o trabalhador pode render algo útil quando não recebe mensagens sobre uma mudança na situação do segmento principal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se falamos sobre a transferência de mensagens entre threads, deve-se notar que aqui aplicamos uma abordagem muito simples. Honestamente, precisamos transmitir muito poucas mensagens entre os threads, então prefiro chamar nossa abordagem de consequência do pragmatismo, não de preguiça. Porém, se falarmos sobre aplicativos reais, pode-se observar que o esquema de transferência de mensagens entre os fluxos se tornará mais complicado se a interação do usuário com o diagrama e a atualização dos dados visualizados depender deles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você pode usar a interface </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> padrão para criar canais de mensagens separados entre o thread principal e o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">thread de</font></a><font style="vertical-align: inherit;"> trabalho </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cada um desses canais pode ser usado para uma categoria específica de mensagens, o que facilita o processamento de mensagens. Como alternativa aos mecanismos padrão, bibliotecas de terceiros como o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podem agir </font><font style="vertical-align: inherit;">. Esta biblioteca oculta detalhes de baixo nível atrás de uma interface de alto nível usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objetos proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra característica interessante do nosso exemplo, que se torna claramente visível em retrospecto, é o fato de levar em consideração o fato de que os recursos da GPU, como outros recursos do sistema, estão longe de serem infinitos. A conversão da renderização em um trabalhador permite que o thread principal resolva outros problemas. Mas o navegador, de qualquer maneira, precisa usar a GPU para renderizar o DOM e o que foi gerado pelos meios </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o trabalhador consumir todos os recursos da GPU, a janela principal do aplicativo terá problemas de desempenho, independentemente de onde a renderização é realizada. Preste atenção em como a velocidade de atualização do registro de data e hora no exemplo diminui à medida que o número de pontos exibidos aumenta. Se você possui uma placa gráfica poderosa, pode ser necessário aumentar o número de pontos transmitidos para a página na cadeia de consulta. Para fazer isso, você pode usar um valor que exceda o valor máximo de 100000, especificado usando um dos links na página de exemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note-se que aqui não exploramos o mundo secreto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos atributos de contexto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esse estudo poderia nos ajudar a aumentar a produtividade da solução. </font><font style="vertical-align: inherit;">No entanto, não fiz isso por causa do baixo nível de suporte a esses atributos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se falarmos sobre renderização usando </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o atributo parecerá mais interessante aqui </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ele, onde é suportado, e levando em consideração algumas restrições, permite que você se livre da sincronização entre o loop de eventos e o loop de renderização que é executado no trabalhador. </font><font style="vertical-align: inherit;">Isso minimiza o atraso na atualização da imagem. </font><font style="vertical-align: inherit;">Detalhes sobre isso podem ser encontrados </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumário</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oferece aos desenvolvedores a oportunidade de melhorar o desempenho da renderização do gráfico, mas sua utilização requer uma abordagem cuidadosa. </font><font style="vertical-align: inherit;">Para usá-lo, é necessário considerar o seguinte:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui está um</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> código de exemplo e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> está sua versão de trabalho. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queridos leitores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você usou o OffscreenCanvas para acelerar a exibição de gráficos nas páginas da web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496950/index.html">Design é design, não a beleza das imagens.</a></li>
<li><a href="../pt496952/index.html">Qualcomm QCC3020 - a ascensão dos fones de ouvido TWS chineses</a></li>
<li><a href="../pt496954/index.html">Desenvolvimento na Wargaming - encontro com Maxim Baryshnikov, chefe de plataforma (parte I)</a></li>
<li><a href="../pt496956/index.html">Por que os servidores da Web assíncronos apareceram?</a></li>
<li><a href="../pt496958/index.html">CSS interessante encontra no novo design do Facebook</a></li>
<li><a href="../pt496962/index.html">Como arrumar um servidor sobrecarregado?</a></li>
<li><a href="../pt496964/index.html">Seminários semanais da IBM - abril de 2020</a></li>
<li><a href="../pt496966/index.html">Cores CSS LCH</a></li>
<li><a href="../pt496968/index.html">4 ações imperdoáveis ​​para o líder durante o COVID-19</a></li>
<li><a href="../pt496972/index.html">Tendências de segurança de alimentos 2020. Mitap on-line gratuito 21 de abril</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>