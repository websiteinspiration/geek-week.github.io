<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâüèª ü•¶ üî° O poder do PWA: um sistema de vigil√¢ncia por v√≠deo com um c√≥digo JS de rede neural de 300 linhas ‚ò¶Ô∏è ‚úçüèº üë®üèΩ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 
 
 Os navegadores da Web implementam lenta mas seguramente a maioria dos recursos do sistema operacional, e h√° cada vez menos raz√µes para d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>O poder do PWA: um sistema de vigil√¢ncia por v√≠deo com um c√≥digo JS de rede neural de 300 linhas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492006/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os navegadores da Web </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementam</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lenta mas seguramente a </font><font style="vertical-align: inherit;">maioria dos recursos do sistema operacional, e h√° cada vez menos raz√µes para desenvolver um aplicativo nativo se voc√™ puder escrever uma vers√£o da Web (PWA). Plataforma cruzada, API avan√ßada, alta velocidade de desenvolvimento em TS / JS e at√© o desempenho do mecanismo V8 - tudo isso √© uma vantagem. Os navegadores t√™m sido capazes de trabalhar com um fluxo de v√≠deo e executar redes neurais, ou seja, temos todos os componentes para criar um sistema de vigil√¢ncia por v√≠deo com reconhecimento de objetos. Inspirado por este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decidi levar a demonstra√ß√£o ao n√≠vel de aplica√ß√£o pr√°tica que desejo compartilhar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O aplicativo grava v√≠deos da c√¢mera, enviando periodicamente quadros para reconhecimento no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COCO-SSD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e se uma pessoa for detectada, fragmentos de v√≠deo em partes de 7 segundos come√ßam a ser enviados para o e-mail especificado por meio da API do Gmail. Como nos sistemas adultos, a pr√©-grava√ß√£o √© realizada, ou seja, salvamos um fragmento at√© o momento da detec√ß√£o, todos os fragmentos com detec√ß√£o e um depois. Se a Internet n√£o estiver dispon√≠vel ou ocorrer um erro durante o envio, os v√≠deos ser√£o salvos na pasta local de Downloads. O uso do email permite que voc√™ fique sem o lado do servidor, notifique instantaneamente o propriet√°rio e, se um invasor tomar posse do dispositivo e quebrar todas as senhas, ele n√£o poder√° excluir os emails do destinat√°rio. Das desvantagens - um uso excessivo de tr√°fego devido ao Base64 (embora o suficiente para uma c√¢mera) e a necessidade de coletar o arquivo de v√≠deo final de muitos e-mails. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A demonstra√ß√£o de trabalho est√° aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os problemas encontrados s√£o os seguintes:</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) A rede neural carrega muito o processador e, se voc√™ o executar no segmento principal, atrasos aparecer√£o nos v√≠deos. Portanto, o reconhecimento √© colocado em um thread separado (trabalhador), embora nem tudo seja tranquilo aqui. Tudo √© perfeitamente paralelo no Linux pr√©-hist√≥rico de n√∫cleo duplo, mas em alguns telefones celulares de quatro n√∫cleos relativamente novos - no momento do reconhecimento (no trabalhador), o segmento principal tamb√©m come√ßa a ficar lento, o que √© percept√≠vel na interface do usu√°rio. Felizmente, isso n√£o afeta a qualidade do v√≠deo, embora reduza a frequ√™ncia de reconhecimento (ajusta-se automaticamente √† carga). Esse problema provavelmente est√° relacionado √† forma como as diferentes vers√µes do Android distribuem threads por n√∫cleo, a presen√ßa de SIMD, as fun√ß√µes dispon√≠veis da placa de v√≠deo etc. N√£o consigo descobrir sozinho, n√£o conhe√ßo o interior do TensorFlow e serei grato pelas informa√ß√µes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) FireFox. </font><font style="vertical-align: inherit;">O aplicativo funciona bem no Chrome / Chromium / Edge; no entanto, o reconhecimento no FireFox √© notavelmente mais lento; al√©m disso, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageCapture</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ainda n√£o foi implementado </font><font style="vertical-align: inherit;">(√© claro, isso pode ser ignorado capturando um quadro de &lt;video&gt;, mas √© uma pena para a raposa, porque √© padr√£o API). </font><font style="vertical-align: inherit;">Em geral, tamb√©m n√£o havia acessibilidade completa entre navegadores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, tudo em ordem.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtendo uma c√¢mera e um microfone</font></font></h4><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">this</span>.video = <span class="hljs-keyword">this</span>.querySelector(<span class="hljs-string">'video'</span>)
<span class="hljs-keyword">this</span>.canvas = <span class="hljs-keyword">this</span>.querySelectorAll(<span class="hljs-string">'canvas'</span>)[<span class="hljs-number">0</span>]<font></font>
<font></font>
<span class="hljs-keyword">this</span>.stream = <span class="hljs-keyword">await</span> navigator.mediaDevices.getUserMedia(<font></font>
   {<span class="hljs-attr">video</span>: {<span class="hljs-attr">facingMode</span>: {<span class="hljs-attr">ideal</span>: <span class="hljs-string">"environment"</span>}}, <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>}<font></font>
)<font></font>
<span class="hljs-keyword">this</span>.video.srcObject = <span class="hljs-keyword">this</span>.stream
<span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
   <span class="hljs-keyword">this</span>.video.onloadedmetadata = <span class="hljs-function">(<span class="hljs-params">_</span>) =&gt;</span> resolve()<font></font>
})<font></font>
<span class="hljs-keyword">this</span>.W = <span class="hljs-keyword">this</span>.bbox.width = <span class="hljs-keyword">this</span>.canvas.width = <span class="hljs-keyword">this</span>.video.videoWidth
<span class="hljs-keyword">this</span>.H = <span class="hljs-keyword">this</span>.bbox.height = <span class="hljs-keyword">this</span>.canvas.height = <span class="hljs-keyword">this</span>.video.videoHeight
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, selecionamos a c√¢mera principal do celular / tablet (ou a primeira no computador / laptop), exibimos o fluxo em um reprodutor de v√≠deo padr√£o, ap√≥s o qual aguardamos o carregamento dos metadados e definimos as dimens√µes da tela de servi√ßo. </font><font style="vertical-align: inherit;">Como todo o aplicativo √© gravado no estilo de async / waiting, voc√™ precisa converter APIs de retorno de chamada (e existem muitas) em Promise para uniformidade.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Captura de v√≠deo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem duas maneiras de capturar v√≠deo. </font><font style="vertical-align: inherit;">A primeira √© ler diretamente os quadros do fluxo de entrada, exibi-los na tela, modific√°-los (por exemplo, adicionar geografia e data e hora) e, em seguida, coletar os dados da tela - para o gravador como um fluxo de sa√≠da e para uma rede neural como imagens separadas. </font><font style="vertical-align: inherit;">Nesse caso, voc√™ pode ficar sem o elemento &lt;video&gt;.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">this</span>.capture = <span class="hljs-keyword">new</span> ImageCapture(<span class="hljs-keyword">this</span>.stream.getVideoTracks()[<span class="hljs-number">0</span>])
<span class="hljs-keyword">this</span>.recorder = <span class="hljs-keyword">new</span> MediaRecorder(<span class="hljs-keyword">this</span>.canvas.captureStream(), {<span class="hljs-attr">mimeType</span> : <span class="hljs-string">"video/webm"</span>})<font></font>
<font></font>
grab_video()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">grab_video</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.canvas.drawImage(<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.capture.grabFrame(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
	<span class="hljs-keyword">const</span> img = <span class="hljs-keyword">this</span>.canvas.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.W, <span class="hljs-keyword">this</span>.H)<font></font>
	... <span class="hljs-comment">//    -   img</span>
	... <span class="hljs-comment">//   -    </span>
        <span class="hljs-built_in">window</span>.requestAnimationFrame(<span class="hljs-keyword">this</span>.grab_video.bind(<span class="hljs-keyword">this</span>))<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda maneira (trabalhando em FF) √© usar um reprodutor de v√≠deo padr√£o para capturar. </font><font style="vertical-align: inherit;">A prop√≥sito, ele consome menos tempo do processador, diferente da exibi√ß√£o quadro a quadro na tela, mas n√£o podemos adicionar uma inscri√ß√£o.</font></font><br>
<br>
<pre><code class="javascript hljs">...<font></font>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">grab_video</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.canvas.drawImage(<span class="hljs-keyword">this</span>.video, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<font></font>
	...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O aplicativo usa a primeira op√ß√£o, como resultado da qual o player de v√≠deo pode ser desligado durante o processo de reconhecimento. </font><font style="vertical-align: inherit;">Para economizar processador, a grava√ß√£o √© realizada a partir do fluxo recebido, e os quadros de desenho na tela s√£o usados ‚Äã‚Äãapenas para obter uma matriz de pixels para a rede neural, com uma frequ√™ncia dependendo da velocidade de reconhecimento. </font><font style="vertical-align: inherit;">Desenhamos o quadro ao redor da pessoa em uma tela separada colocada no player.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregamento de rede neural e detec√ß√£o humana</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â tudo indecentemente simples. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iniciamos o trabalhador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , depois de carregar o modelo (bastante longo), enviamos uma mensagem vazia para o encadeamento principal, onde no evento onmessage mostramos o bot√£o Iniciar, ap√≥s o qual o trabalhador est√° pronto para receber imagens. </font><font style="vertical-align: inherit;">C√≥digo completo do trabalhador:</font></font><br>
<br>
<pre><code class="javascript hljs">(<span class="hljs-keyword">async</span> () =&gt; {<font></font>
  self.importScripts(<span class="hljs-string">'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js'</span>)<font></font>
  self.importScripts(<span class="hljs-string">'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd'</span>)<font></font>
<font></font>
  <span class="hljs-keyword">let</span> model = <span class="hljs-keyword">await</span> cocoSsd.load()<font></font>
  self.postMessage({})<font></font>
<font></font>
  self.onmessage = <span class="hljs-keyword">async</span> (ev) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> model.detect(ev.data)
    <span class="hljs-keyword">const</span> person = result.find(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.class === <span class="hljs-string">'person'</span>)
    <span class="hljs-keyword">if</span> (person) <font></font>
      self.postMessage({<span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bbox</span>: person.bbox})
    <span class="hljs-keyword">else</span>
      self.postMessage({<span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">bbox</span>: <span class="hljs-literal">null</span>})<font></font>
  }<font></font>
})()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No thread principal, iniciamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fun√ß√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">grab_video ()</font></a><font style="vertical-align: inherit;"> somente depois de receber o resultado anterior do trabalhador, ou seja, a frequ√™ncia de detec√ß√£o depender√° da carga do sistema.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grava√ß√£o de v√≠deo</font></font></h4><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">this</span>.recorder.rec = <span class="hljs-keyword">new</span> MediaRecorder(<span class="hljs-keyword">this</span>.stream, {<span class="hljs-attr">mimeType</span> : <span class="hljs-string">"video/webm"</span>})
<span class="hljs-keyword">this</span>.recorder.rec.ondataavailable = <span class="hljs-function">(<span class="hljs-params">ev</span>) =&gt;</span> {
   <span class="hljs-keyword">this</span>.chunk = ev.data
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.detected) {
      <span class="hljs-keyword">this</span>.send_chunk()<font></font>
   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.recorder.num &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.send_chunk()
      <span class="hljs-keyword">this</span>.recorder.num--<font></font>
   }<font></font>
}<font></font>
...<font></font>
this.recorder.rec.start()<font></font>
<span class="hljs-keyword">this</span>.recorder.num = <span class="hljs-number">0</span>
<span class="hljs-keyword">this</span>.recorder.interval = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
   <span class="hljs-keyword">this</span>.recorder.rec.stop()
   <span class="hljs-keyword">this</span>.recorder.rec.start()<font></font>
}, CHUNK_DURATION)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em cada parada do gravador (usamos um intervalo fixo), o evento ondataavailable √© gerado, onde o fragmento gravado no formato Blob √© transferido, salvo neste peda√ßo e enviado de forma ass√≠ncrona. Sim, this.send_chunk () retorna uma promessa, mas a fun√ß√£o leva muito tempo (codifica√ß√£o em Base64, enviando um email ou salvando o arquivo localmente), e n√£o esperamos que seja executado e n√£o processe o resultado - portanto, n√£o h√° espera. Mesmo que os novos videoclipes apare√ßam com mais frequ√™ncia do que podem ser enviados, o mecanismo JS organiza a linha de promessas de forma transparente para o desenvolvedor, e todos os dados ser√£o enviados / gravados mais cedo ou mais tarde. A √∫nica coisa que vale a pena prestar aten√ß√£o √© dentro da fun√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send_chunk ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes da primeira espera, √© necess√°rio clonar o Blob com o m√©todo slice (), pois o link this.chunk √© esfregado a cada CHUNK_DURATION segundos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API do Gmail</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usado para enviar cartas. </font><font style="vertical-align: inherit;">A API √© bastante antiga, em parte em promessas, em parte em retornos de chamada, a documenta√ß√£o e os exemplos n√£o s√£o abundantes; portanto, darei o c√≥digo completo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">obtemos as chaves do aplicativo e do cliente no console do desenvolvedor do Google. </font><font style="vertical-align: inherit;">Em uma janela de autoriza√ß√£o pop-up, o Google relata que o aplicativo n√£o foi verificado e voc√™ precisar√° clicar em "configura√ß√µes avan√ßadas" para entrar. </font><font style="vertical-align: inherit;">Verificar a aplica√ß√£o no Google acabou por ser uma tarefa n√£o trivial, voc√™ precisa confirmar a propriedade do dom√≠nio (que eu n√£o tenho), organizar corretamente a p√°gina principal, ent√£o decidi n√£o me incomodar.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'https://apis.google.com/js/api.js'</span>)<font></font>
gapi.load(<span class="hljs-string">'client:auth2'</span>, <span class="hljs-keyword">async</span> () =&gt; {
   <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> gapi.client.init({
         <span class="hljs-attr">apiKey</span>: API_KEY,
         <span class="hljs-attr">clientId</span>: CLIENT_ID,
         <span class="hljs-attr">discoveryDocs</span>: [<span class="hljs-string">'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'</span>],
         <span class="hljs-attr">scope</span>: <span class="hljs-string">'https://www.googleapis.com/auth/gmail.send'</span><font></font>
      }) <font></font>
      <span class="hljs-keyword">if</span> (!gapi.auth2.getAuthInstance().isSignedIn.je) {
         <span class="hljs-keyword">await</span> gapi.auth2.getAuthInstance().signIn()<font></font>
      }<font></font>
      <span class="hljs-keyword">this</span>.msg.innerHTML = <span class="hljs-string">''</span>
      <span class="hljs-keyword">this</span>.querySelector(<span class="hljs-string">'nav'</span>).style.display = <span class="hljs-string">''</span>
   } <span class="hljs-keyword">catch</span>(e) {
      <span class="hljs-keyword">this</span>.msg.innerHTML = <span class="hljs-string">'Gmail authorization error: '</span> + <span class="hljs-built_in">JSON</span>.stringify(e, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)<font></font>
   }<font></font>
})<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envio de email</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As cadeias codificadas em Base64 n√£o podem ser concatenadas, e isso √© inconveniente. </font><font style="vertical-align: inherit;">Como enviar v√≠deo em formato bin√°rio, eu ainda n√£o entendi. </font><font style="vertical-align: inherit;">Nas √∫ltimas linhas, convertemos o retorno de chamada em uma promessa. </font><font style="vertical-align: inherit;">Infelizmente, isso tem que ser feito com bastante frequ√™ncia.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> send_mail(subject, mime_type, body) {
   <span class="hljs-keyword">const</span> headers = {
      <span class="hljs-string">'From'</span>: <span class="hljs-string">''</span>,
      <span class="hljs-string">'To'</span>: <span class="hljs-keyword">this</span>.email,
      <span class="hljs-string">'Subject'</span>: <span class="hljs-string">'Balajahe CCTV: '</span> + subject,
      <span class="hljs-string">'Content-Type'</span>: mime_type,
      <span class="hljs-string">'Content-transfer-encoding'</span>: <span class="hljs-string">'base64'</span><font></font>
   }<font></font>
   <span class="hljs-keyword">let</span> head = <span class="hljs-string">''</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [k, v] <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.entries(headers)) head += k + <span class="hljs-string">': '</span> + v + <span class="hljs-string">'\r\n'</span>
   <span class="hljs-keyword">const</span> request = gapi.client.gmail.users.messages.send({
      <span class="hljs-string">'userId'</span>: <span class="hljs-string">'me'</span>,
      <span class="hljs-string">'resource'</span>: { <span class="hljs-string">'raw'</span>: btoa(head + <span class="hljs-string">'\r\n'</span> + body) }<font></font>
   })<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<font></font>
      request.execute(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
         <span class="hljs-keyword">if</span> (!res.code) <font></font>
            resolve() <font></font>
         <span class="hljs-keyword">else</span> <font></font>
            reject(res)<font></font>
      })<font></font>
   })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salvando um videoclipe em disco. </font><font style="vertical-align: inherit;">Usamos um hiperlink oculto.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-keyword">this</span>.querySelector(<span class="hljs-string">'a'</span>)<font></font>
URL.revokeObjectURL(a.href)<font></font>
a.href = URL.createObjectURL(chunk)<font></font>
a.download = name<font></font>
a.click()</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciamento de estado no mundo dos componentes da web</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuando a id√©ia apresentada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , levei-a ao </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absurdo do</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fim l√≥gico (apenas para os lulz) e virei o controle do estado de cabe√ßa para baixo. </font><font style="vertical-align: inherit;">Se geralmente as vari√°veis ‚Äã‚ÄãJS s√£o consideradas como um estado e o DOM √© apenas a exibi√ß√£o atual, no meu caso a fonte de dados √© o pr√≥prio DOM (j√° que os componentes da Web s√£o os n√≥s DOM de longa dura√ß√£o) e, para usar dados no lado JS, os componentes da Web fornecem getters / setters para cada campo de formul√°rio. </font><font style="vertical-align: inherit;">Assim, por exemplo, em vez de caixas de sele√ß√£o desconfort√°veis ‚Äã‚Äãno estilo, &lt;button&gt; simples √© usado e o "valor" do bot√£o (true √© pressionado, false √© pressionado) √© o valor do atributo de classe, que permite estiliz√°-lo da seguinte maneira:</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.true</span> {<span class="hljs-attribute">background-color</span>: red}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e obtenha o valor assim:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">get</span> <span class="hljs-title">detecting</span>() { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.querySelector(<span class="hljs-string">'#detecting'</span>).className === <span class="hljs-string">'true'</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o posso aconselhar usar isso na produ√ß√£o, porque essa √© uma boa maneira de diminuir a produtividade. </font><font style="vertical-align: inherit;">Embora ... o DOM virtual tamb√©m n√£o seja gratuito, e eu n√£o fiz benchmarks.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo offline</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim, adicione um pouco de PWA, a saber, instale um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabalhador de servi√ßo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que armazenar√° em cache todas as solicita√ß√µes de rede e permitir√° que o aplicativo funcione sem acesso √† Internet. </font><font style="vertical-align: inherit;">Uma pequena nuance - em artigos sobre trabalhadores de servi√ßo, eles geralmente fornecem o seguinte algoritmo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No evento de instala√ß√£o - crie uma nova vers√£o do cache e adicione todos os recursos necess√°rios ao cache.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No evento de ativa√ß√£o - exclua todas as vers√µes do cache, exceto a atual.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No evento de busca - primeiro tentamos pegar o recurso do cache e, se n√£o o encontrarmos, enviamos uma solicita√ß√£o de rede, cujo resultado √© adicionado ao cache.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na pr√°tica, esse esquema √© inconveniente por duas raz√µes. Em primeiro lugar, no c√≥digo do trabalhador, voc√™ precisa ter uma lista atualizada de todos os recursos necess√°rios e, em grandes projetos usando bibliotecas de terceiros, tente acompanhar todas as importa√ß√µes anexadas (incluindo as din√¢micas). O segundo problema - ao alterar qualquer arquivo, voc√™ precisa aumentar a vers√£o do trabalhador do servi√ßo, o que levar√° √† instala√ß√£o de um novo trabalhador e √† invalida√ß√£o do anterior, e isso acontecer√° SOMENTE quando o navegador for fechado / aberto. Uma simples atualiza√ß√£o de p√°gina n√£o ajudar√° - o trabalhador antigo com o cache antigo funcionar√°. E onde est√° a garantia de que meus clientes n√£o manter√£o a guia do navegador para sempre? Portanto, primeiro fazemos uma solicita√ß√£o de rede, adicionamos o resultado ao cache de forma ass√≠ncrona (sem aguardar a resolu√ß√£o de permiss√£o cache.put (ev.request, resp.clone ())) e, se a rede n√£o estiver dispon√≠vel, obtemos o mesmo do cache. Melhor perder um diadepois voe em 5 minutos ¬©.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quest√µes n√£o resolvidas</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em alguns telefones celulares, a rede neural diminui, talvez no meu caso, o COCO-SSD n√£o seja a melhor op√ß√£o, mas eu n√£o sou especialista em ML e peguei a primeira que foi ouvida.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o encontrei um exemplo de como enviar v√≠deo via GAPI, n√£o no formato Base64, mas no bin√°rio original. </font><font style="vertical-align: inherit;">Isso economizaria tempo do processador e tr√°fego de rede.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu n√£o entendi seguran√ßa. </font><font style="vertical-align: inherit;">Para fins de depura√ß√£o local, adicionei o dom√≠nio localhost ao aplicativo do Google, mas se algu√©m come√ßar a usar as chaves do aplicativo para enviar spam - o Google bloquear√° as chaves ou a conta do remetente?</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ficaria muito grato pelo feedback. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fontes no github. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado pela aten√ß√£o.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491994/index.html">Migrando do Cocoapods para o Swift Package Manager</a></li>
<li><a href="../pt491996/index.html">Mais sobre Coroutines em C ++</a></li>
<li><a href="../pt492000/index.html">Produto muito primeiro. Esgotamento</a></li>
<li><a href="../pt492002/index.html">Asas que absorvem luz: o segredo das borboletas super pretas</a></li>
<li><a href="../pt492004/index.html">Como passar de um programador para um gerente ("Eu quero ser a amante do mar")</a></li>
<li><a href="../pt492008/index.html">Resultados da pesquisa de motiva√ß√£o em TI: os desenvolvedores est√£o satisfeitos com seu trabalho?</a></li>
<li><a href="../pt492010/index.html">O lado sombrio do sistema de design e o que fazer com ele</a></li>
<li><a href="../pt492012/index.html">As panelas de estabiliza√ß√£o Gyenno compensam at√© 80% de tremor</a></li>
<li><a href="../pt492016/index.html">ABP e tudo, tudo, tudo: entrada autom√°tica de reserva no data center</a></li>
<li><a href="../pt492018/index.html">Exceder a velocidade: riscos e vulnerabilidades no campo de sistemas de transporte inteligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>