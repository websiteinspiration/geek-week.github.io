<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇🏿 ⛴️ ⬛️ 楕円投影でカードを接続する方法（これが提供されていない場合） 👸🏾 💧 🏥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="または、YandexマップタイルをOpenStreetMapsプロジェクションに合わせる方法は？
 
 前書き
 ある種のオンラインマップを開くたびに、全体をダウンロードするわけではありません。マップの読み込みを高速化するために、小さな部分（タイル）に分割されているため、目的の領域のみをダウンロード...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>楕円投影でカードを接続する方法（これが提供されていない場合）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483120/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または、YandexマップタイルをOpenStreetMapsプロジェクションに合わせる方法は？</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある種のオンラインマップを開くたびに、全体をダウンロードするわけではありません。</font><font style="vertical-align: inherit;">マップの読み込みを高速化するために、小さな部分（タイル）に分割されているため、目的の領域のみをダウンロードできます。</font><font style="vertical-align: inherit;">問題は、いくつかの方法でこれらの正方形に切り込むことができることです。</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/p5/bu/ss/p5bussiwefnatdwdbgrlktj_yq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのオンラインカードは、地球がボールの形をしていると「考え」ています。たとえば、GoogleマップやOpenStreetMapsなどです。いくつかは、より注意深く、惑星が正しい球ではないという事実を考慮に入れます：少なくとも、それは極で平らにされます。このような楕円体投影は、たとえばYandexマップで使用されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6k/dc/ag/6kdcageqgsw_y7j6xbhpehkku-y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、異なる投影法で同じ番号のセルは、完全に異なる場所を示します。たとえば、ここでは、X軸が10427、Y軸が5119のタイルです。スケールレベル14。左側-OSM、右側はYandex。都市の代わりに、ある種の森。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/sm/fr/zgsmfrsatg1gwtyofaanw-ymqfk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのマップエンジンはタイルを希望の投影法に自動的に調整できますが、手動で調整する必要がある場合があります。</font><font style="vertical-align: inherit;">しかし、どうやって？</font><font style="vertical-align: inherit;">最も簡単な方法は、タイルを特定のピクセル数だけシフトすることです。</font><font style="vertical-align: inherit;">その結果、目的のエリアがマップ上に表示されます。</font><font style="vertical-align: inherit;">もちろん、よく見ると歪みが見られます。</font><font style="vertical-align: inherit;">しかし、私は、同じように、同じような正確さの日常のタスクで十分だと思います。</font><font style="vertical-align: inherit;">それでは、はじめに終了して、コンバーターの作成を開始します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7c/-j/cr/7c-jcrrc1osrir4ttvlk-q2gsq8.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法論</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能させるには、変換式が必要です。私が理解しているように、それはYandex Mapsのページコードから直接取得されました。当時は、これを実行することがまだ十分可能でした。ソースへのリンクは見つかりませんが、この式</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はすでに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハブで</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">公開さ</font></a><font style="vertical-align: inherit;">れ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ています</font></a><font style="vertical-align: inherit;">。実際には触れませんでした。単にSwiftで書き直して、理解しにくい1文字の変数により「話している」名前を付けました。少なくともそれらを識別できた人たち。 （助けてくれたErelenに感謝）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、タスクは次のとおりです。入力として、標準投影のタイル番号、楕円体投影のタイル番号、および出力でシフトする必要があるピクセル数を使用するコンバーターを作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そう。たとえば</font><font style="vertical-align: inherit;">、番号がX 10427、Y 5119、Z 14の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を考えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのステップで行動します。</font><font style="vertical-align: inherit;">まず、このタイルの座標（緯度と経度）を見つけます。</font><font style="vertical-align: inherit;">たとえば、その左上隅の座標。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">tileNumberToCoordinates</span><span class="hljs-params">(tileX: Int, tileY: Int, mapZoom: Int)</span></span> -&gt; (lat_deg: <span class="hljs-type">Double</span>, lon_deg: <span class="hljs-type">Double</span>) {<font></font>
        <font></font>
        <span class="hljs-keyword">let</span> n : <span class="hljs-type">Double</span> = pow(<span class="hljs-number">2.0</span>, <span class="hljs-type">Double</span>(mapZoom))
        <span class="hljs-keyword">let</span> lon = (<span class="hljs-type">Double</span>(tileX) / n) * <span class="hljs-number">360.0</span> - <span class="hljs-number">180.0</span>
        <span class="hljs-keyword">let</span> lat = atan( sinh (.pi - (<span class="hljs-type">Double</span>(tileY) / n) * <span class="hljs-number">2</span> * <span class="hljs-type">Double</span>.pi)) * (<span class="hljs-number">180.0</span> / .pi)<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> (lat, lon)<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力（55.7889 49.1088）を取得します。</font><font style="vertical-align: inherit;">次に、取得した値を式に代入します。</font><font style="vertical-align: inherit;">ズームレベルは同じです：14です。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getWGS84Position</span><span class="hljs-params">(latitude: Double, longitude: Double, zoom: Int)</span></span> -&gt; (x:<span class="hljs-type">Int</span>, y:<span class="hljs-type">Int</span>, offsetX:<span class="hljs-type">Int</span>, offsetY:<span class="hljs-type">Int</span>) {<font></font>
        <font></font>
        <span class="hljs-comment">// Earth vertical and horisontal radiuses</span>
        <span class="hljs-keyword">let</span> radiusA = <span class="hljs-number">6378137.0</span>
        <span class="hljs-keyword">let</span> radiusB = <span class="hljs-number">6356752.0</span><font></font>
        <font></font>
        <span class="hljs-keyword">let</span> latitudeInRadians = latitude * <span class="hljs-type">Double</span>.pi / <span class="hljs-number">180</span><font></font>
        <font></font>
        <span class="hljs-keyword">let</span> yCompressionOfEllipsoid = sqrt( pow(radiusA, <span class="hljs-number">2.0</span>) - pow(radiusB, <span class="hljs-number">2.0</span>)) / radiusA<font></font>
        <font></font>
        <span class="hljs-comment">// I really don't know what the name of this variable mean =(</span>
        <span class="hljs-keyword">let</span> m2 = log((<span class="hljs-number">1</span> + sin(latitudeInRadians)) / (<span class="hljs-number">1</span> - sin(latitudeInRadians))) / <span class="hljs-number">2</span> - yCompressionOfEllipsoid * log((<span class="hljs-number">1</span> + yCompressionOfEllipsoid * sin(latitudeInRadians)) / (<span class="hljs-number">1</span> - yCompressionOfEllipsoid * sin(latitudeInRadians))) / <span class="hljs-number">2</span><font></font>
        <font></font>
        <span class="hljs-comment">// x count = y count</span>
        <span class="hljs-keyword">let</span> xTilesCountForThisZoom = <span class="hljs-type">Double</span>(<span class="hljs-number">1</span> &lt;&lt; zoom)<font></font>
        <font></font>
        <span class="hljs-comment">//Tile numbers in WGS-84 proection</span>
        <span class="hljs-keyword">let</span> xTileNumber = floor((longitude + <span class="hljs-number">180</span>) / <span class="hljs-number">360</span> * xTilesCountForThisZoom)
        <span class="hljs-keyword">let</span> yTileNumber = floor(xTilesCountForThisZoom / <span class="hljs-number">2</span> - m2 * xTilesCountForThisZoom / <span class="hljs-number">2</span> / <span class="hljs-type">Double</span>.pi)<font></font>
        <font></font>
        <span class="hljs-comment">//Offset in pixels of the coordinate of the</span>
        <span class="hljs-comment">//left-top corner of the OSM tile</span>
        <span class="hljs-comment">//from the left-top corner of the WGS-84 tile</span>
        <span class="hljs-keyword">let</span> offsetX = floor(((longitude + <span class="hljs-number">180</span>) / <span class="hljs-number">360</span> * xTilesCountForThisZoom - xTileNumber) * <span class="hljs-number">256</span>)
        <span class="hljs-keyword">let</span> offsetY = floor(((xTilesCountForThisZoom / <span class="hljs-number">2</span> - m2 * xTilesCountForThisZoom / <span class="hljs-number">2</span> / <span class="hljs-type">Double</span>.pi) - yTileNumber) * <span class="hljs-number">256</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">Int</span>(xTileNumber), <span class="hljs-type">Int</span>(yTileNumber), <span class="hljs-type">Int</span>(offsetX), <span class="hljs-type">Int</span>(offsetY))<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（10427、5133、0、117）が得られます。</font><font style="vertical-align: inherit;">つまり、</font><font style="vertical-align: inherit;">X 10427、Y 5133、Z 14の</font><font style="vertical-align: inherit;">Yandex </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><font style="vertical-align: inherit;">です。左に0ピクセル、上に117ピクセル移動すると、正しい位置に配置されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kz/vp/ft/kzvpfty0jfvlc_igwvzugk2qktw.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そしてそれをどうするか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ナビゲーターを作成し、マップの表示に影響を与える機会がある場合、すべてが比較的簡単です。画面上のタイルのオフセットを計算します。そして、任意の便利な方法で、マップとともに要素をこのピクセル数だけ移動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、コードにアクセスできない場合は、マップサーバーとナビゲーターの間に中間リンクを入力する必要があります。例えば、私はこれのために単純なサーバーを作りました。希望するタイルの数の入力を受け取り、楕円体投影のタイルの数を計算します。また、隣接する3つのタイルをダウンロードします。これらの4つのタイルを1つの大きなタイルに接着し、目的のフラグメントを切り取り、ユーザーナビゲーターに返します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/5c/6k/ns5c6kacnerrjgsi_gyf2rxf99u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果とオリジナル：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/e0/an/jie0ankna-4goxvdxvxsbe-qzhc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これらすべての操作には追加の時間コストが必要です。</font><font style="vertical-align: inherit;">これらのリンクを使用すると、サーバーがカードをリアルタイムで「フォトショップ」する速度を評価でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます。https</font></a><font style="vertical-align: inherit;">：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//anygis.ru/api/v1/Yandex_map/ { </font></font></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xasket </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">/ { </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">y </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">} </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">/ </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">{ </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">z </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">} </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https://anygis.ru / api / v1 / Yandex_sat_clean / {x} / {y} / {z}</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ええと、誰かがここで概説されている情報が役に立つと思います。</font><font style="vertical-align: inherit;">あなたの実験で頑張ってください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483110/index.html">ロストフ・ナ・ドヌ：2019年のIT企業、コミュニティ、イベント</a></li>
<li><a href="../ja483112/index.html">ELK、Big Query、TimescaleDBの代わりとしてClickhouseを使用する</a></li>
<li><a href="../ja483114/index.html">私たちがふさわしいモーダルウィンドウ</a></li>
<li><a href="../ja483116/index.html">自宅で望遠鏡のパイプを作る</a></li>
<li><a href="../ja483118/index.html">2020年にJavaScriptに追加されるもの</a></li>
<li><a href="../ja483124/index.html">近い将来最も大きなガジェット（スマートフォンではない）</a></li>
<li><a href="../ja483126/index.html">極低温暴露により、損傷した電気自動車バッテリーの安全な輸送を確保できます</a></li>
<li><a href="../ja483130/index.html">スーツケースのロックのコードを忘れた場合はどうすればよいですか？</a></li>
<li><a href="../ja483132/index.html">望遠鏡の設計と製造</a></li>
<li><a href="../ja483134/index.html">二要素認証テストと可能な回避策</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>