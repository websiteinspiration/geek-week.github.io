<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™…ğŸ¿ ğŸ¤šğŸ¾ ğŸ“ å¦‚ä½•åœ¨Power BIä¸­ä½¿ç”¨Microsoft SQLç”ŸæˆæŠ¥è¡¨ã€‚ä»¥Mindboxä¸ºä¾‹ ğŸ¹ â¬ ğŸ§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¦‚æœæ‚¨æƒ³äº†è§£å¹¿å‘ŠæŠ•èµ„çš„æœ‰æ•ˆç¨‹åº¦ï¼Œåˆ™éœ€è¦è¯„ä¼°æ‰€æœ‰å†…å®¹ï¼šä¿¡ä»¶ï¼Œè®¿é—®æ¬¡æ•°ï¼Œè®¢å•ï¼Œæ”¶å…¥ã€‚è·å¾—è¿™äº›æŒ‡æ ‡çš„é€Ÿåº¦ä¹Ÿå¾ˆé‡è¦ã€‚ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæ‚¨å¯ä»¥åœ¨Microsoft Power BIä¸­æ„å»ºæ¼‚äº®ä¸”æ˜“äºç†è§£çš„æŠ¥å‘Šã€‚å¹¶ç®€åŒ–äº†æŠ¥è¡¨æ•°æ®çš„æ¥æ”¶ï¼Œå°†æœ‰åŠ©äºå°†å…¶å­˜å‚¨åœ¨è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚è¿™å¾ˆæ–¹ä¾¿ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰å¾ˆå¤šä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”å¾ˆéš¾ç›´...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•åœ¨Power BIä¸­ä½¿ç”¨Microsoft SQLç”ŸæˆæŠ¥è¡¨ã€‚ä»¥Mindboxä¸ºä¾‹</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506740/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨æƒ³äº†è§£å¹¿å‘ŠæŠ•èµ„çš„æœ‰æ•ˆç¨‹åº¦ï¼Œåˆ™éœ€è¦è¯„ä¼°æ‰€æœ‰å†…å®¹ï¼šä¿¡ä»¶ï¼Œè®¿é—®æ¬¡æ•°ï¼Œè®¢å•ï¼Œæ”¶å…¥ã€‚</font><font style="vertical-align: inherit;">è·å¾—è¿™äº›æŒ‡æ ‡çš„é€Ÿåº¦ä¹Ÿå¾ˆé‡è¦ã€‚</font><font style="vertical-align: inherit;">ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæ‚¨å¯ä»¥åœ¨Microsoft Power BIä¸­æ„å»ºæ¼‚äº®ä¸”æ˜“äºç†è§£çš„æŠ¥å‘Šã€‚</font><font style="vertical-align: inherit;">å¹¶ç®€åŒ–äº†æŠ¥è¡¨æ•°æ®çš„æ¥æ”¶ï¼Œå°†æœ‰åŠ©äºå°†å…¶å­˜å‚¨åœ¨è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚</font><font style="vertical-align: inherit;">è¿™å¾ˆæ–¹ä¾¿ï¼Œå°¤å…¶æ˜¯åœ¨æœ‰å¾ˆå¤šä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”å¾ˆéš¾ç›´æ¥ä»åœ¨çº¿æœåŠ¡ä¸­è·å–ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†æ•°æ®å­˜å‚¨åœ¨Microsoft SQLä¸­ï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨å…¶ä»–æ•°æ®åº“æœåŠ¡å™¨ã€‚</font></font></p><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ESPä¸­çš„æ•°æ®æ„å»ºæŠ¥å‘Šæ—¶å‡ºç°é—®é¢˜</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°ä»£é‚®ä»¶å¹³å°ï¼ˆç”µå­é‚®ä»¶å‘é€å¹³å°æˆ–ESPï¼‰æ”¶é›†æœ‰å…³é‚®ä»¶çš„ç»Ÿè®¡ä¿¡æ¯ï¼šå‘é€ï¼Œå‘é€ï¼Œæ‰“å¼€ï¼Œç‚¹å‡»ã€‚</font><font style="vertical-align: inherit;">è¿˜æœ‰æ›´é«˜çº§çš„å¹³å°ï¼Œä¾‹å¦‚Mindboxï¼Œå¯è®©æ‚¨åœ¨æ­¤å¤„æ·»åŠ è®¢å•å’Œæ”¶å…¥ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œå¯ä»¥å¹¶ä¸”åº”è¯¥ä½¿ç”¨Google Analyticsï¼ˆåˆ†æï¼‰å’Œ/æˆ–Yandex.Metricsæ”¶é›†æ•°æ®ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®å­˜å‚¨åœ¨å¯é€šè¿‡ç”µå­é‚®ä»¶å¹³å°APIè®¿é—®çš„æŸä¸ªä½ç½®ï¼Œä½†æ˜¯å¾ˆéš¾æ ¹æ®è¿™äº›åŸå§‹æ•°æ®ç”ŸæˆæŠ¥å‘Šï¼ŒåŸå› æ˜¯ï¼š</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®å¯ä»¥ä»¥ä¸åŒçš„æ ¼å¼å­˜å‚¨ï¼Œé€šå¸¸ä¸æ–¹ä¾¿ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”±äºå¤æ‚çš„æˆæƒæ–¹æ¡ˆï¼Œå¤æ‚çš„æ•°æ®è·å–åè®®ï¼Œè®¿é—®æ•°æ®å¯èƒ½å¾ˆå›°éš¾ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®åªèƒ½åœ¨æœ€è¿‘å‡ ä¸ªæœˆå†…å­˜å‚¨åœ¨ESPä¸­ï¼›é€šå¸¸ä¼šåˆ é™¤è¾ƒæ—§çš„å¹³å°æ•°æ®ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“æœ‰å¤§é‡æ•°æ®æ—¶ï¼Œç”±äºAPIé‚®ä»¶å¹³å°çš„æ€§èƒ½æˆ–ç½‘ç»œå¸¦å®½çš„é™åˆ¶ï¼Œæ— æ³•å¿«é€Ÿè·å–æ•°æ®ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨Power BIæœåŠ¡å™¨ä¸Šç»„ç»‡æŠ¥è¡¨ä¸­çš„æ•°æ®çš„è‡ªåŠ¨æ›´æ–°æ—¶ï¼Œç”±äºéšç§ç­–ç•¥ï¼Œè®¿é—®æºæ—¶å¸¸ä¼šå‡ºç°é—®é¢˜ã€‚</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”Ÿæˆå•ä¸ªæŠ¥å‘Šå¯èƒ½éœ€è¦æ•°ç™¾ç”šè‡³æ•°åƒä¸ªAPIè¯·æ±‚ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œè¦æŒ‰è®¢æˆ·ç»†åˆ†æ„å»ºæŠ¥å‘Šï¼Œæ‚¨éœ€è¦è¿›è¡Œä¸åˆ†é…çš„ç»†åˆ†å—ä¼—ç¾¤ä¸€æ ·å¤šçš„æŸ¥è¯¢ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨éœ€è¦æŒ‰æ—¥åˆ†æç»†åˆ†çš„å¢é•¿æƒ…å†µï¼Œåˆ™éœ€è¦å®Œæˆè¿™äº›è¯·æ±‚çš„æ¬¡æ•°æ˜¯æˆ‘ä»¬è¦ç”ŸæˆæŠ¥å‘Šçš„æ¬¡æ•°ã€‚</font><font style="vertical-align: inherit;">å³ä½¿ç¬¬äºŒæ¬¡æ‰§è¡Œå•ä¸ªæŸ¥è¯¢ï¼ŒPower BIä¹Ÿä¼šåœ¨åˆå§‹æ•°æ®åŠ è½½å’Œæ›´æ–°æ—¶é‡åˆ°é—®é¢˜ã€‚</font></font></p><br>
<p> &nbsp;    &nbsp;   &nbsp;â€” Microsoft SQL Server.    &nbsp;&nbsp; , &nbsp; &nbsp; .    SQL-    ,   MS&nbsp;Azure  BigQuery.</p><br>
<p><strong> &nbsp;:</strong>    &nbsp;   .  ESP-   &nbsp;     &nbsp;. &nbsp;    &nbsp; SQL- &nbsp;   . ,   ,   &nbsp;   &nbsp;, â€¦    &nbsp;3&nbsp;!</p><br>
<p>    API ESP      :</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/929/374/8eb/9293748eb6a2fd08d2c004d3a478cb59.png" alt="å¯¹ESP APIçš„æ ‡å‡†è¯·æ±‚ç»“æœ" width="435" height="200"></p><br>
<p> ,   :     .</p><br>
<p>    SQL-      .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/0f9/18b/b2f/0f918bb2f65691737dc02d715e639274.png" alt="åœ¨Microsoft SQL Serverä¸Šæ±‡æ€»æ•°æ®æ—¶æ‰€éœ€æ—¶é—´çš„ä¿¡æ¯" width="926" height="409"></p><br>
<p>           ,   SQL-       .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/2d9/73f/11c/2d973f11c0b1b2c91f94649268f282fb.png" alt="æ¥è‡ªMicrosoft SQL Serverçš„æ¯æ—¥ç»Ÿè®¡ä¿¡æ¯" width="873" height="381"></p><br>
<h2> &nbsp;  &nbsp;Microsoft SQL Server</h2><br>
<p> SQL-    ,    .            Node.js.          API-.</p><br>
<p>   API-   &nbsp;ESP,  &nbsp;  &nbsp; &nbsp; . &nbsp;   ,      &nbsp;.</p><br>
<p> , &nbsp; &nbsp;  ,  &nbsp; &nbsp;  &nbsp; Power BI&nbsp;&nbsp;:   ,  &nbsp;.</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/d64/fa9/d99/d64fa9d9966babdc7a5e8394512f50d3.png" alt="ä½¿ç”¨Microsoft SQL Serverä»Mindboxå¯¼å…¥æ•°æ®" width="1920" height="1080"></p><br>
<p>, &nbsp;  &nbsp; &nbsp; &nbsp;Mindbox. &nbsp;  &nbsp;â€”  ,   &nbsp;,  &nbsp; Â«â†’â†’â†’ &nbsp; &nbsp;â†’ &nbsp;Â».</p><br>
<p>       &nbsp; &nbsp;, &nbsp; .</p><br>
<ol>
<li>Mindbox     ,  .       â€” 10 000,     500-1000  â€”    API.        .     ,       ,   Mindbox.</li>
<li>&nbsp;API Mindbox     &nbsp;.    c&nbsp;&nbsp;ID ( ) , &nbsp;,   &nbsp;, ID&nbsp;  ,  &nbsp;  &nbsp; .</li>
<li>    ,       .     , &nbsp;&nbsp;  .</li>
<li> API- &nbsp;Mindbox    &nbsp; .     ,      &nbsp;,  .   , &nbsp;&nbsp;   .       .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mindboxæä¾›çš„åŸå§‹æ•°æ®é€šå¸¸æ˜¯æŠ¥å‘Šæ‰€ä¸éœ€è¦çš„ã€‚</font><font style="vertical-align: inherit;">åœ¨SQL Serverä¸Šï¼Œæ‚¨å¯ä»¥ç«‹å³èšåˆæ•°æ®ï¼Œè¿™å°†æé«˜ä¸‹è½½é€Ÿåº¦å¹¶ç®€åŒ–Power BIæŠ¥è¡¨ä¸­çš„æ•°æ®å¤„ç†ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ¬¡ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†Mindboxäº§å“ç»ç†Ilya Tsyrulnikovçš„è¯„è®ºï¼š</font></font><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œ 2020å¹´6æœˆï¼Œæˆ‘ä»¬å‘å¸ƒäº†ä¸€ä¸ªæ–°çš„å¯¼å‡ºAPIï¼Œè¯¥APIå¼‚æ­¥å·¥ä½œï¼Œå¹¶ç«‹å³è¿”å›å¤§é‡æ•°æ®ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªè¯·æ±‚å¸è½½è¿‡å»å…­ä¸ªæœˆä¸­çš„æ‰€æœ‰è®¢å•ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†æ¥ï¼Œæˆ‘ä»¬è®¡åˆ’ä¸ºBIç³»ç»Ÿä¹‹ä¸€æä¾›æ ‡å‡†çš„æä¾›ç¨‹åºã€‚</font><font style="vertical-align: inherit;">BIä¸­çš„åŸå§‹æ•°æ®å°†è‡ªåŠ¨åˆ°è¾¾ï¼Œè€Œæ— éœ€éƒ¨ç½²å’Œæ”¯æŒå•ç‹¬çš„æ•°æ®åº“ã€‚â€</font></font></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft SQLæ•°æ®æ”¶é›†å™¨å¦‚ä½•å·¥ä½œ</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¨‹åºç®—æ³•å¯ä»¥è¿™æ ·æè¿°ï¼š</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾å‡ºæˆ‘ä»¬è®¾æ³•ä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„æœ€å¤§æ“ä½œIDã€‚</font></font></li>
<li>  API Mindbox , ID&nbsp; ,   ID&nbsp;  .    , &nbsp; &nbsp; ID.</li>
<li>  , &nbsp; &nbsp;&nbsp;  .  &nbsp; 1. &nbsp;  , , &nbsp;  &nbsp; ,  Mindbox  .</li>
</ol><br>
<p>     .  &nbsp;     &nbsp;&nbsp;.</p><br>
<pre><code class="plaintext hljs">/* MSSQL */<font></font>
const config = require('./config.js');<font></font>
/**<font></font>
   :<font></font>
module.exports = {<font></font>
<font></font>
mssql: {<font></font>
user: 'sa',<font></font>
password: 'mssqlpassword',<font></font>
server: 'mssqlhost',<font></font>
database: 'mssqldbname',<font></font>
connectionTimeout: 60000,<font></font>
requestTimeout: 60000<font></font>
},<font></font>
<font></font>
mindbox_api_key: '___API_mindbox'<font></font>
};<font></font>
**/<font></font>
<font></font>
const async = require('async');<font></font>
const request = require('request');<font></font>
const https = require("https");<font></font>
const sql = require('mssql');<font></font>
var parseString = require('xml2js').parseString;<font></font>
var _ = require('lodash');<font></font>
var iconv = require('iconv-lite');<font></font>
<font></font>
//  SQL-<font></font>
sql.connect(config.mssql, err =&gt; {<font></font>
// Query<font></font>
if (err) {<font></font>
console.log('SQL connect error: ', err, config.mssql);<font></font>
}<font></font>
})<font></font>
<font></font>
sql.on('error', err =&gt; {<font></font>
console.log('SQL server error: ', err);<font></font>
// ... error handler<font></font>
})<font></font>
<font></font>
setTimeout(function() {<font></font>
//     ,     <font></font>
var operarions = ['EksportDejstvijPoRuchnym', 'EksportDejstvijPoRassylkam', 'EksportDejstvijPoRassylkamSkandinavskij', 'EksportDejstvijPoRassylkamNovoe', 'EksportDejstvijPoRassylkamSkolkovskij', 'EksportDejstvijPoRassylkamDsk1', 'EksportDejstvijPoRassylkamDyxanie', 'EksportDejstvijPoRassylkamPokolenie', 'EksportDejstvijPoRassylkamFsk'];<font></font>
async.forEach(operarions, function(operation, cb1) {<font></font>
mbxChunk(operation, cb1);<font></font>
},<font></font>
function(err, res) {<font></font>
if (err) {<font></font>
sql.close();<font></font>
process.exit();<font></font>
return;<font></font>
}<font></font>
console.log('DONE!');<font></font>
sql.close();<font></font>
process.exit();<font></font>
}<font></font>
)<font></font>
}, 1000);<font></font>
<font></font>
/**<font></font>
*        <font></font>
*/<font></font>
function mbxChunk(operation, cb) {<font></font>
console.log('New Chunk '+operation);<font></font>
var sqlreq = new sql.Request();<font></font>
//  mindboxId  ,  ,   ID  <font></font>
sqlreq.query("SELECT MAX(mindboxId) AS last FROM "+config.mssql.database+".dbo."+operation+";", function(err, maxres) {<font></font>
if (err || !maxres.recordset[0]) {<font></font>
console.log('MsSQL SELECT MAX error: ', err);<font></font>
cb(err);<font></font>
return;<font></font>
}<font></font>
var chunk = parseInt(maxres.recordset[0].last || 0) + 1;<font></font>
<font></font>
// ,   ID=chunk<font></font>
mbxCall(operation, chunk, function(err, xml) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ' started');<font></font>
if (err) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox API request error: ', err);<font></font>
cb(err);<font></font>
}<font></font>
parseString(xml, function(err, res) {<font></font>
if (err) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox returns invalid XML, parse error: ', err);<font></font>
console.log(xml);<font></font>
cb(err);<font></font>
}<font></font>
if (res &amp;&amp; res.result &amp;&amp; res.result.status == 'Success') {<font></font>
var rows = res.result.customerActions ? res.result.customerActions[0].customerAction : [];<font></font>
if (rows.length &gt; 0) {<font></font>
mbxHandle(operation, rows, function(err, res) {<font></font>
console.log(operation + ' from #' + chunk.toString() + ' + '+rows.length.toString()+' done!');<font></font>
mbxChunkCopy(operation, cb);<font></font>
});<font></font>
}<font></font>
else {<font></font>
console.log(operation + ' - data is over!');<font></font>
cb();<font></font>
}<font></font>
}<font></font>
else {<font></font>
console.log(operation + ' from #' + chunk.toString() + ': Mindbox returns unsuccessfull result: ', res);<font></font>
cb(err);<font></font>
}<font></font>
});<font></font>
})<font></font>
})<font></font>
}<font></font>
<font></font>
function mbxChunkCopy(operation, cb) {<font></font>
mbxChunk(operation, cb);<font></font>
}<font></font>
<font></font>
/**<font></font>
*   API Mindbox<font></font>
*  1000 . ID    startId<font></font>
*/<font></font>
function mbxCall(operation, startId, cb) {<font></font>
var request = require("request");<font></font>
var options = {<font></font>
method: 'POST',<font></font>
url: 'https://api.mindbox.ru/v3/operations/sync',<font></font>
qs: {<font></font>
endpointId: 'fskuniversalpoint', operation: operation<font></font>
},<font></font>
headers: {<font></font>
"Cache-Control": "no-cache",<font></font>
"Content-Type": "application/xml",<font></font>
"Accept": "application/xml",<font></font>
"Authorization": 'Mindbox secretKey="'+config.mindbox_api_key+'"'<font></font>
},<font></font>
body: '&lt;operation&gt;\r\n  &lt;page&gt;\r\n    &lt;firstmindboxid&gt;' + startId.toString() + '&lt;/firstmindboxid&gt;\r\n    &lt;pagenumber&gt;1&lt;/pagenumber&gt;\r\n    &lt;itemsperpage&gt;1000&lt;/itemsperpage&gt;\r\n  &lt;/page&gt;\r\n&lt;/operation&gt;'<font></font>
};<font></font>
<font></font>
request(options, function (error, response, body) {<font></font>
cb(error, body);<font></font>
});<font></font>
}<font></font>
<font></font>
/**<font></font>
*     Mindbox<font></font>
*    table MsSQL<font></font>
*/<font></font>
function mbxHandle(table, rows, cb) {<font></font>
console.log(rows.length.toString() + ' items to save into '+table);<font></font>
var i = 0;<font></font>
<font></font>
async.forEach(rows, function(row, cb1) {<font></font>
try {<font></font>
var sqlreq = new sql.Request();<font></font>
sqlreq.input('mindboxId', sql.Int, parseInt(row.ids[0].mindboxId[0]));<font></font>
sqlreq.input('transactionId', sql.VarChar, (row.ids[0].transactionId ? row.ids[0].transactionId[0] : ''));<font></font>
sqlreq.input('systemName', row.actionTemplate[0].systemName[0]);<font></font>
sqlreq.input('name', sql.NVarChar, row.actionTemplate[0].name[0]);<font></font>
sqlreq.input('dateTimeUtc', sql.DateTime, new Date(row.dateTimeUtc[0]));<font></font>
sqlreq.input('pointOfContact_externalId', sql.VarChar, row.pointOfContact[0].ids[0].externalId[0]);<font></font>
sqlreq.input('customer_mindboxId', sql.VarChar, (row.customer[0].ids[0] ? row.customer[0].ids[0].mindboxId[0] : ''));<font></font>
sqlreq.input('customer_webSiteId', sql.VarChar, (row.customer[0].ids[0].webSiteId ? row.customer[0].ids[0].webSiteId[0] : ''));<font></font>
sqlreq.input('channel', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].channel ? row.mailing[0].channel[0] : ''));<font></font>
sqlreq.input('action', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].action ? row.mailing[0].action[0] : ''));<font></font>
sqlreq.input('notSentReason_name', sql.VarChar, row.ids[0].mindboxId[0]);<font></font>
sqlreq.input('notSentReason_systemName', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].notSentReason &amp;&amp;  row.mailing[0].notSentReason[0].name ? row.mailing[0].notSentReason[0].name[0] : ''));<font></font>
sqlreq.input('groupingKey', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].groupingKey ? row.mailing[0].groupingKey[0] : ''));<font></font>
sqlreq.input('link', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].link ? row.mailing[0].link[0] : ''));<font></font>
sqlreq.input('viewEmailMessageUrl', sql.VarChar, (row.mailing &amp;&amp; row.mailing[0].viewEmailMessageUrl ? row.mailing[0].viewEmailMessageUrl[0] : ''));<font></font>
var q = "INSERT INTO "+config.mssql.database+".dbo."+table<font></font>
+ " (mindboxId, transactionId, systemName, name, dateTimeUtc, pointOfContact_externalId, customer_mindboxId, customer_webSiteId, channel, [action], notSentReason_name, notSentReason_systemName, groupingKey, link, viewEmailMessageUrl)"<font></font>
+ " VALUES(@mindboxId, @transactionId, @systemName, @name, @dateTimeUtc, @pointOfContact_externalId, @customer_mindboxId, @customer_webSiteId, @channel, @action, @notSentReason_name, @notSentReason_systemName, @groupingKey, @link, @viewEmailMessageUrl);";<font></font>
}<font></font>
catch (err) {<font></font>
console.log('MsSQL input vars error: ', err, JSON.stringify(row));<font></font>
return cb1(err);<font></font>
}<font></font>
sqlreq.query(q, function(err, r) {<font></font>
if (err) {<font></font>
console.log('MsSQL query error: ', err, JSON.stringify(row));<font></font>
}<font></font>
cb1(err, r);<font></font>
})<font></font>
}, function(err, r) {<font></font>
cb(err, r);<font></font>
});<font></font>
}</code></pre><br>
<p>  , &nbsp;&nbsp;  , ,   .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/e1b/763/f84/e1b763f8481d28a292fe9e90652b8e17.jpg" alt="ä½¿ç”¨Microsoft SQLæ”¶é›†æ•°æ®çš„æ ·æœ¬æŠ¥å‘Š" width="1364" height="736"></p><br>
<p>&nbsp;  Power BI&nbsp;     &nbsp;Mindbox &nbsp;  :</p><br>
<pre><code class="plaintext hljs">let<font></font>
//       Mindbox<font></font>
   ExportAction = (name as text, page as number)=&gt;let<font></font>
   Source=Xml.Tables(Web.Contents("https://api.mindbox.ru/v3/",<font></font>
                     [Headers=[#"content-type"="application/xml",Accept="application/xml",Authorization="Mindbox secretKey="""""],<font></font>
                     RelativePath="operations/sync",<font></font>
                     Query=[endpointId="",operation=name],<font></font>
                     Content=Text.ToBinary("&lt;operation&gt;&lt;page&gt;&lt;firstmindboxid&gt;0&lt;/firstmindboxid&gt;&lt;pagenumber&gt;"&amp;Number.ToText(page)&amp;"&lt;/pagenumber&gt;&lt;itemsperpage&gt;10000&lt;/itemsperpage&gt;&lt;/page&gt;&lt;/operation&gt;")])),<font></font>
   Data= try Source{0}[customerActions] otherwise null //    <font></font>
in<font></font>
   Data,<font></font>
//  <font></font>
   name="XXXXXXXXXXX",  //     Mindbox<font></font>
   Source = List.Generate( ()=&gt;                                            //        Mindbox<font></font>
            [Result = ExportAction(name, 1), Page = 1],                    //    .<font></font>
            each [Result] &lt;&gt; null,                                         //   ,   <font></font>
            each [Result = ExportAction(name,[Page]+1), Page = [Page]+1],  //     <font></font>
            each [Result]),<font></font>
//     <font></font>
    #"Converted to Table" = Table.FromList(Source, Splitter.SplitByNothing(), null, null, ExtraValues.Error)<font></font>
//   *<font></font>
//   *<font></font>
//     <font></font>
//   *<font></font>
//   *<font></font>
//   result = ..........<font></font>
in<font></font>
    result</code></pre><br>
<p>&nbsp;&nbsp;  .  2-3. , ,  &nbsp;,  &nbsp; &nbsp;   &nbsp;  &nbsp; .</p><br>
<p>&nbsp; &nbsp;,  ,  ,    . &nbsp;  &nbsp;.       , &nbsp;   &nbsp;.</p><br>
<p>    2020  PowerQuery    () ,        ,     API    .</p><br>
<p> &nbsp;Power BI&nbsp; ,   &nbsp;SQL-, &nbsp;    &nbsp;   &nbsp;â€”   .</p><br>
<p>&nbsp;   ( &nbsp; &nbsp;API):</p><br>
<br>
<pre><code class="plaintext hljs">let<font></font>
Source = Sql.Database("ServerNameÂ«, Â«DataBaseÂ»),<font></font>
Result = Source{[Schema="dbo",Item="TableName"]}[Data]<font></font>
in<font></font>
Result</code></pre><br>
<p>           ,         Power query  .</p><br>
<br>
<h2>   &nbsp;Power BI</h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯ä»¥ä»æ­¤æŠ¥å‘Šä¸­æ”¶é›†Mindboxå’ŒGoogle Analyticsï¼ˆåˆ†æï¼‰ä¸­çš„æ•°æ®ã€‚</font></font></p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/aae/bd3/fff/aaebd3fff86c4fa89626c19330db1bbd.png" alt="ä½¿ç”¨Microsoft SQLç¼–è¯‘çš„Power BIæŠ¥è¡¨" width="1651" height="899"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œæ¯æ™šä»Mindboxå’ŒGoogle Analyticsï¼ˆåˆ†æï¼‰æ”¶é›†æ•°æ®åˆ°SQL Serverä¸Šçš„æ•°æ®åº“ä¸­ï¼ˆç‰¹æ®Šè„šæœ¬æ”¶é›†æ•°æ®è€Œä¸è¿›è¡ŒæŠ½æ ·ï¼‰ï¼Œç„¶åå°†æ¥è‡ªSQL Serverçš„æ”¶é›†å’Œæ±‡æ€»çš„æ•°æ®ä¸Šè½½åˆ°Power BIæœåŠ¡å™¨ä¸Šçš„æŠ¥å‘Šä¸­ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å› æ­¤ï¼Œåœ¨å·¥ä½œæ—¥å¼€å§‹ä¹‹å‰ï¼Œç”¨æˆ·å°†åœ¨æŠ¥å‘Šä¸­æ¥æ”¶åˆ°æœ€æ–°æ•°æ®ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN506726/index.html">ä½¿ç”¨RutokenæŠ€æœ¯è¿›è¡Œç³»ç»Ÿä¸­ç”¨æˆ·æ³¨å†Œå’Œæˆæƒçš„ç»éªŒï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN506730/index.html">Snortæˆ–Suricataã€‚ç¬¬1éƒ¨åˆ†ï¼šé€‰æ‹©å…è´¹çš„IDS / IPSä¿æŠ¤ä¼ä¸šç½‘ç»œ</a></li>
<li><a href="../zh-CN506732/index.html">ç»„ç»‡èŒƒå›´å†…å¯¹UIç»„ä»¶çš„é‡ç”¨</a></li>
<li><a href="../zh-CN506734/index.html">ç”µç½‘ä¸­çš„ç¬æ€è®¡ç®—</a></li>
<li><a href="../zh-CN506736/index.html">ä¸€ä¸ªç­çº§åº”è¯¥æœ‰å¤šå°‘ç§æ–¹æ³•ï¼Ÿ</a></li>
<li><a href="../zh-CN506742/index.html">ä¸ºä»€ä¹ˆåƒç´ çš„ä¸­å¿ƒåº”ä½äºï¼ˆ0.5; 0.5ï¼‰</a></li>
<li><a href="../zh-CN506748/index.html">è°éš”ç¦»äº†é”€å”®é¢å¢é•¿çš„éš”ç¦»åŒºï¼Ÿ</a></li>
<li><a href="../zh-CN506758/index.html">äº§å“ç»„ç»‡äº†ä¸€æ¬¡å…³äºå¼€æºåŸåˆ™çš„ä¼šè®®ï¼Œåå¹´æ¥ï¼Œæ¯ä¸ªå‚ä¸è€…éƒ½æ˜¯ç»„ç»‡è€…</a></li>
<li><a href="../zh-CN506762/index.html">å®‰å…¨å‘¨25ï¼šå¾®è½¯ç ´çºªå½•çš„è¡¥ä¸é›†</a></li>
<li><a href="../zh-CN506766/index.html">æˆ‘ä»¬æ‹’ç»ä»˜è´¹RPAå¹³å°ï¼Œå¹¶ä¸”åŸºäºOpenSourceï¼ˆOpenRPAï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>