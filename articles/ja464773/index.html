<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎅🏽 💣 🤳🏻 リッチインターネットアプリケーションの非同期Typescriptとそれと戦うデコレータ 📑 👨‍👧‍👦 🙅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Typescriptにasync/ awaitが導入されて以来、開発におけるこのアプローチを称賛する記事が数多くあります（hackernoon、blog.bitsrc.io、habr.com）。私たちはクライアント側で最初からそれらを使用します（ES6ジェネレーターがサポートするブラウザーの50％未...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>リッチインターネットアプリケーションの非同期Typescriptとそれと戦うデコレータ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464773/"><p><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Typescript</font></a><font style="vertical-align: inherit;">に</font></font><code>async</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">導入されて以来、</font><font style="vertical-align: inherit;">開発におけるこのアプローチを称賛する記事が数多くあります（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hackernoon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog.bitsrc.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">私たちはクライアント側で最初からそれらを使用します（ES6ジェネレーターがサポートするブラウザーの50％未満の場合）。</font><font style="vertical-align: inherit;">そして、私は自分の経験を共有したいと思います。なぜなら、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列実行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">このパスに沿って知るのは良いことではないからです。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後の記事はあまり好きではありません。何かが理解できないかもしれません。</font><font style="vertical-align: inherit;">独占的なコードを提供できないという事実もあって、一般的なアプローチの概要のみです。</font><font style="vertical-align: inherit;">したがって：</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読むことなくタブを閉じることを躊躇しないでください </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理している場合は、不明確な詳細を尋ねます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は最も永続的で徹底的に掘り下げたアドバイスや批判を喜んで受け入れます。</font></font></li>
</ul><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コアテクノロジーのリスト：</font></font></strong></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトは主にいくつかのJavaScriptライブラリを使用してTypescriptで記述されています。</font><font style="vertical-align: inherit;">メインライブラリはExtJSです。</font><font style="vertical-align: inherit;">Reactよりもファッショナビリティは劣りますが、豊富なインターフェースを備えたエンタープライズ製品に最適です。多くの既製コンポーネント、優れた設計のテーブル、箱から出してすぐに使える、開発を簡素化する関連製品の豊富なエコシステム。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期マルチスレッドサーバー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Websocketを介したRPCは、クライアントとサーバー間のトランスポートとして使用されます。</font><font style="vertical-align: inherit;">実装は.NET WCFに似ています。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトはすべてサービスです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトは、値と参照の両方で送信できます。</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データクエリインターフェイスは、Typescriptでのみ、FacebookのGraphQLに似ています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">双方向通信：データ更新の初期化は、クライアントとサーバーの両方から起動できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期コードは、</font></font><code>async</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typesrciptの関数を</font><font style="vertical-align: inherit;">使用して順番に記述され</font><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーAPIはTypescriptで生成されます。変更された場合、エラーが発生した場合、ビルドはすぐにそれを表示します。</font></font></li>
</ul><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力は何ですか</font></font></strong></p><br>
<p>,             :   Typesrcipt,   .      race condition   ,     . </p><br>
<h2 id="kak-strukturirovany-dannye-poluchaemye-s-servera">  ,   </h2><br>
<p>   ,       ( ,  ,  etc.)   .       : </p><br>
<ul>
<li>     /ML   -. </li>
<li>         </li>
<li>  :    "",    ""   .</li>
</ul><br>
<p>              GraphQL,   ,       .</p><br>
<p>  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">//  </span><font></font>
interface IParent {<font></font>
    <span class="hljs-attr">ServerId</span>: string;<font></font>
    Nodes: INodes; <span class="hljs-comment">// INodes -     INode</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span><font></font>
interface INodes&lt;TNode extends INode&gt; extends ICollection {<font></font>
    IndexOf(item: TNode): number;<font></font>
    Item(index: number): TNode;<font></font>
    <span class="hljs-comment">// ...    </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span><font></font>
interface INode extends IItem {<font></font>
    <span class="hljs-attr">Guid</span>: string;<font></font>
    Name: string;<font></font>
    DisplayName: string;<font></font>
    Links: ILinks; <span class="hljs-comment">// ILinks -   </span>
    Info: INodeInfo; <span class="hljs-comment">//    - </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//     </span><font></font>
interface ILink {<font></font>
    <span class="hljs-attr">Guid</span>: string;<font></font>
    DisplayName: string;<font></font>
    SourceNode: INode; <span class="hljs-comment">//   - </span>
    TargetNode: INode; <span class="hljs-comment">//   ,  </span><font></font>
}<font></font>
<font></font>
interface INodeInfo {<font></font>
    <span class="hljs-attr">Component</span>: IComponent;<font></font>
    ConfigData: IData;<font></font>
}<font></font>
</code></pre><br>
<h2 id="kak-klient-poluchaet-dannye">   </h2><br>
<p> :   -     RPC  <code>Promise</code>:</p><br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">let</span> Nodes = Parent.Nodes; <span class="hljs-comment">// Nodes -&gt; Promise&lt;INodes&gt;</span>
</code></pre><br>
<h3 id="asinhronnost-bez-callback-hell">  "Callback Hell".</h3><br>
<p>  ""    <code>async</code>/<code>await</code>  Typescript:</p><br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ShowNodes</span>(<span class="hljs-params">parent: IParent</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">let</span> Nodes = <span class="hljs-keyword">await</span> parent.Nodes;<font></font>
<font></font>
    <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">await</span> Nodes.forEachParallel(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">node</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
        <span class="hljs-keyword">await</span> RenderNode(node); <span class="hljs-comment">//         </span><font></font>
    });<font></font>
}<font></font>
</code></pre><br>
<p>     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.    Typescript   2016 .       ,     feature   Typescript,         .       production. </p><br>
<p>   ,      :</p><br>
<p>        <code>async</code>,     <code>Promise&lt;_&gt;</code>.   :</p><br>
<ul>
<li>  <code>async</code>   <code>await</code> (  <code>Promise</code>)          <code>Promise</code>. </li>
<li>    <code>async</code> ,  <code>Promise</code>     .</li>
<li>   Javascript   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   ES6 ( <code>function*</code>  <code>async function</code>  <code>yield</code>  <code>await</code>)      <code>switch</code>  ES5 ( ). <code>await</code> —   ,    .         <code>ShowNodes</code> ,      Javascript   -  .</li>
</ul><br>
<p>       <code>forEachParallel</code>,        .   <code>await</code>  <code>Nodes.forEachParallel</code>   .   — <code>Promise.all</code>:</p><br>
<pre><code class="javascript hljs">
<span class="hljs-comment">/**
 *           
 * <span class="hljs-doctag">@param </span>items 
 * <span class="hljs-doctag">@param </span>callbackfn 
 * <span class="hljs-doctag">@param </span>[thisArg]   ,      this  callbackfn
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">forEachParallel</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">items: IItemArray&lt;T&gt;, callbackfn: (value: T, index: int, items: IItemArray&lt;T&gt;</span>) =&gt; <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span> | <span class="hljs-title">any</span>&gt;, <span class="hljs-title">thisArg</span>?: <span class="hljs-title">any</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
    <span class="hljs-keyword">let</span> xCount = items ? <span class="hljs-keyword">await</span> items.Count : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!xCount)
        <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">let</span> xActions = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span> | any&gt;&gt;(xCount);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; xCount; i++) {
        <span class="hljs-keyword">let</span> xItem = items.Item(i);<font></font>
        xActions[i] = ExecuteCallback(xItem, callbackfn, i, items, thisArg);<font></font>
    }<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(xActions);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**   item   callbackfn */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ExecuteCallback</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">item: Promise&lt;T&gt; | T, callbackfn: (value: T, index: int, items: IItemArray&lt;T&gt;</span>) =&gt; <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span> | <span class="hljs-title">any</span>&gt;, <span class="hljs-title">index</span>: <span class="hljs-title">int</span>, <span class="hljs-title">items</span>: <span class="hljs-title">IItemArray</span>&lt;<span class="hljs-title">T</span>&gt;, <span class="hljs-title">thisArg</span>?: <span class="hljs-title">any</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
    <span class="hljs-keyword">let</span> xItem = <span class="hljs-keyword">await</span> item;
    <span class="hljs-keyword">await</span> callbackfn.call(thisArg, xItem, index, items);<font></font>
}<font></font>
</code></pre><br>
<p>  :         ,       Javascript'.</p><br>
<p> <code>ShowNodes</code>   :         .    ,      ,       .             .</p><br>
<h2 id="yazyk-zaprosov"> </h2><br>
<p>  ,    ""    .  "" ,        :</p><br>
<pre><code class="javascript hljs">
<span class="hljs-comment">/**
 *       item    Promise  ,
 *      properties
 */</span>
selectAsync&lt;T extends IItem&gt;<span class="hljs-function">(<span class="hljs-params">item: T, properties: (</span>) =&gt;</span> any[]): <span class="hljs-built_in">Promise</span>&lt;T&gt;;<font></font>
<font></font>
<span class="hljs-comment">/**
 *   items,       properties
 */</span>
selectAsyncAll&lt;T extends ICollection&gt;<span class="hljs-function">(<span class="hljs-params">items: T[], properties: (</span>) =&gt;</span> any[]): <span class="hljs-built_in">Promise</span>&lt;T[]&gt;;<font></font>
<font></font>
<span class="hljs-comment">/**    selectAsync     */</span>
select&lt;T&gt;<span class="hljs-function">(<span class="hljs-params">item: T, properties: (</span>) =&gt;</span> any[]): T;<font></font>
<font></font>
<span class="hljs-comment">/**    selectAsync     */</span>
selectAll&lt;T&gt;<span class="hljs-function">(<span class="hljs-params">items: T[], properties: (</span>) =&gt;</span> any[]): T[];
</code></pre><br>
<p>              :</p><br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ShowNodes</span>(<span class="hljs-params">parentPoint: IParent</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
    <span class="hljs-comment">//       IParent -    selectAsync (</span>
    <span class="hljs-comment">// Promise,  ).</span>
    <span class="hljs-keyword">let</span> Parent = <span class="hljs-keyword">await</span> selectAsync(parentPoint, parent =&gt; [
        <span class="hljs-comment">//          </span>
        selectAll(parent.Nodes, nodes =&gt; [node.Name, node.DisplayName]) <span class="hljs-comment">// [node.Name, node.DisplayName] -       </span><font></font>
    ]);<font></font>
<font></font>
    <span class="hljs-comment">//      Parent.Nodes</span><font></font>
    ...<font></font>
}<font></font>
</code></pre><br>
<p>         :</p><br>
<pre><code class="javascript hljs">
    <span class="hljs-comment">//     parent.Nodes  selectAsyncAll,   </span>
    <span class="hljs-keyword">let</span> Parent = <span class="hljs-keyword">await</span> selectAsyncAll(parent.Nodes, nodes =&gt; [
        <span class="hljs-comment">//    :</span><font></font>
        select(node, node =&gt; [<font></font>
            node.Name,<font></font>
            node.DisplayName,<font></font>
            selectAll(node.Links, link =&gt; [<font></font>
                link.Guid,<font></font>
                link.DisplayName,<font></font>
                select(link.TargetNode, targetNode =&gt; [targetNode.Guid])<font></font>
            ]),<font></font>
            select(node.Info, info =&gt; [info.Component]) <span class="hljs-comment">//    IInfo    IComponent,   ,   ,       </span><font></font>
        ])<font></font>
    ]);<font></font>
</code></pre><br>
<p>       .      ,          ,  , race condition. </p><br>
<h2 id="race-condition-i-puti-resheniya">Race Condition   </h2><br>
<p>              ,     ,  <code>async</code>  <code>FuncOne</code> ,  <code>Promise</code>.        (    ) ,  ,    .  <code>FuncOne</code>     , ,    .</p><br>
<p>    :   <code>IParent</code>    <code>Parent.OnSynchronize</code>.</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">/**   */</span>
Parent.OnSynchronize.AddListener(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
    <span class="hljs-comment">//   .   ,  .</span><font></font>
});<font></font>
</code></pre><br>
<p>      <code>INodes</code>  .       :</p><br>
<ol>
<li>     ,      <br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">OnClickRemoveNode</span>(<span class="hljs-params">node: INode</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">void</span>&gt; </span>{
<span class="hljs-keyword">let</span> removedOnServer: boolean = <span class="hljs-keyword">await</span> Parent.RemoveNode(node);
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">if</span> (removedOnServer) ....<font></font>
}</code></pre></li>
<li> <code>Parent.OnSynchronize</code>     .</li>
<li><code>Parent.OnSynchronize</code>     .</li>
<li><code>async OnClickRemoveNode()</code>     <code>await</code>        .</li>
</ol><br>
<p>   <code>OnClickRemoveNode</code>    .         — .      ?       <code>await</code> —  :</p><br>
<ul>
<li>        . </li>
<li>   ,  :    <code>OnClickRemoveNode</code>,         .       ,    .</li>
<li>  :   -  ,   .     ,             ,        —  .</li>
<li>  ,     ,   ?   <code>await</code>   ?</li>
</ul><br>
<p>   : ,     ? ,   :</p><br>
<ul>
<li> </li>
<li> </li>
<li>/ </li>
<li>   </li>
<li>  :            .</li>
</ul><br>
<p>  ,       - race condition,     ..            —      .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Typescript</a>        .</p><br>
<p><strong>      :</strong></p><br>
<ol>
<li>       .                    .</li>
<li>         .     ,       View,    .</li>
<li>      (,  <code>IsDestroyed</code>).           .</li>
<li> View                  .</li>
<li>     <code>Promise.done()</code>.      <code>handler</code>  .   : <br>
<ul>
<li>,   <code>Promise</code>-,      (, ,      stak trace'),      (       ).       —   . :        <code>unhandledrejection</code>,         Chrome  Edge:<br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{ 
<span class="hljs-comment">// handling... </span>
});</code></pre></li>
<li>       <code>async</code> - ,    stack trace . </li>
</ul></li>
</ol><br>
<p>          ,     .</p><br>
<pre><code class="javascript hljs">
<span class="hljs-comment">/**
 * :
 * 1.     
 * 2.      ,   .
 * 
 *  ,  :   ,        
 */</span><font></font>
@Lock<font></font>
<font></font>
<span class="hljs-comment">/**
 * :
 *     ,     .
 * 
 *  ,     :   ,   .
 */</span><font></font>
@LockQueue<font></font>
<font></font>
<span class="hljs-comment">/**
 *  LockQueue .  -        
 * 
 *   ,       . ,   .
 */</span><font></font>
@LockBetween<font></font>
<font></font>
<span class="hljs-comment">/**
 * :  
 *       ,   . 
 *     . :     ,     300 .       . 
 */</span>
@LockDeferred(<span class="hljs-number">300</span>)<font></font>
<font></font>
<span class="hljs-comment">// ,    ,     :</span><font></font>
<font></font>
interface ILockTarget {<font></font>
<font></font>
    <span class="hljs-comment">/**
     * ,   View,   .   ,        ,     ,       
     */</span><font></font>
    GetControllerView?(): IView;<font></font>
    <span class="hljs-comment">/**  true      */</span><font></font>
    IsDestroyed: boolean;<font></font>
<font></font>
}<font></font>
</code></pre><br>
<p>  ,         ,   :</p><br>
<pre><code class="javascript hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GraphController</span> <span class="hljs-title">implements</span> <span class="hljs-title">ILockTarget</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">/** ,      .      */</span><font></font>
    private View: IView;<font></font>
<font></font>
    public GetControllerView(): IView {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.View;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**      . */</span><font></font>
    @Lock<font></font>
    private <span class="hljs-keyword">async</span> OnClickRemoveNode(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**     . */</span><font></font>
    @Lock<font></font>
    private <span class="hljs-keyword">async</span> OnClickRemoveLink(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**     */</span><font></font>
    @Lock<font></font>
    private <span class="hljs-keyword">async</span> OnClickAddNewNode(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    " " */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnServerUpdateNode(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    " " */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnServerAddLink(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    " " */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnServerAddNode(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    -   */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnServerRemoveNode(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    -       */</span><font></font>
    @LockBetween<font></font>
    private <span class="hljs-keyword">async</span> OnServerSynchronize(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**    -    (/warning/error/...) */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnServerUpdateNodeStatus(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**        */</span>
    @LockDeferred(<span class="hljs-number">300</span>)<font></font>
    private <span class="hljs-keyword">async</span> OnSearchFieldChange(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {<font></font>
        ...<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
<p>          :</p><br>
<ol>
<li>  - : <code>OnClickRemoveNode</code>, <code>OnClickRemoveLink</code>.    ,         (    ).  , ,  : <br>
<ul>
<li>        </li>
<li>      (     <code>OnServerSynchronize</code>).         —            .<br>
  ,  ,  <code>Lock</code>             .   ,   ,   . , Websocket   ,     ,    .</li>
</ul></li>
<li>  : <code>OnClickAddNewNode</code>.     <code>OnServerSynchronize</code>, <code>OnServerAddNode</code>. <br>
<ul>
<li><code>OnClickAddNewNode</code>   (    - ,  <code>Lock</code>     )</li>
<li><code>OnServerSynchronize</code>, <code>OnServerAddNode</code>   ,    <code>OnClickAddNewNode</code>,    .</li>
</ul></li>
<li>    <code>OnServerSynchronize</code>  <code>OnServerUpdateNode</code>. ,        <code>GraphController</code>.    <code>OnServerUpdateNode</code>     ,       ,     .     <code>ILockTarget</code>  <code>IsDestroyed</code> —   ,      .<br>
Profit:     <code>await</code>  <code>if (!this.IsDestroyed())</code>.</li>
<li>   .     <code>OnServerSynchronize</code>, <code>OnServerUpdateNode</code>.       .  ..       <code>LockQueue</code>  <code>LockBetween</code>,   .</li>
<li>,         .  <code>GraphController #1</code>,       —   <code>GraphController #2</code>. , <code>GraphController</code>-    ,   (  —         ), ..     .  :<br>
<ul>
<li></li>
<li>  </li>
<li>   <code>GraphController #2</code>,     ,    . </li>
</ul></li>
<li><code>OnSearchFieldChange</code>   ,       .         -  .  <code>@LockDeferred(300)</code>     300 :         ,     ,    300 .  ,       .  :<br>
<ul>
<li>  ,   500 ,         .     —        <code>OnSearchFieldChange</code>,     .</li>
<li>     <code>OnSearchFieldChange</code>    —        ,   . </li>
</ul></li>
</ol><br>
<h2 id="chto-nuzhno-znat-pri-ispolzovanii-dekoratorov">     </h2><br>
<ol>
<li> Deadlock:     <code>Handler1</code>,    ,   <code>await</code>   <code>Handler2</code>,  <code>LockQueue</code>,    <code>Handler2</code> — <code>Handler1</code>    .</li>
<li> ,     View      . :            ,      —                .</li>
</ol><br>
<h2 id="profilirovanie-zaprosov-k-serveru">   </h2><br>
<p>   ,     ,        .  :</p><br>
<ul>
<li>      - <code>&lt;Class&gt;</code>.<code>&lt;Method&gt;</code> =&gt; <code>&lt;Time&gt;</code> (  ). </li>
<li>      .</li>
<li>       .</li>
</ul><br>
<h2 id="desert"></h2><br>
<p>,    ,           ,    .        ?         ?  :</p><br>
<pre><code class="javascript hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GraphController</span> <span class="hljs-title">implements</span> <span class="hljs-title">ILockTarget</span> </span>{<font></font>
<font></font>
    private View: IView;<font></font>
<font></font>
    public GetControllerView(): IView {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.View;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**     . */</span><font></font>
    @Lock<font></font>
    private <span class="hljs-keyword">async</span> RunBigDataCalculations(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
        <span class="hljs-keyword">await</span> Start();
        <span class="hljs-keyword">await</span> UpdateSmth();
        <span class="hljs-keyword">await</span> End();
        <span class="hljs-keyword">await</span> CleanUp();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**   . */</span><font></font>
    @LockQueue<font></font>
    private <span class="hljs-keyword">async</span> OnChangeNodeState(node: INode): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
        <span class="hljs-keyword">await</span> GetNodeData(node);
        <span class="hljs-keyword">await</span> UpdateNode(node);<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
<p>  :</p><br>
<ol>
<li> <code>RunBigDataCalculations</code>. </li>
<li> <code>await Start();</code></li>
<li>  /  (  )</li>
<li>  <code>await Start();</code>,   <code>await UpdateSmth();</code>      .</li>
</ol><br>
<p>:</p><br>
<ol>
<li> <code>RunBigDataCalculations</code>. </li>
<li>   <code>OnChangeNodeState</code>,          (..  ). </li>
<li>  <code>await GetNodeData(node);</code></li>
<li>  /  (  )</li>
<li>  <code>await GetNodeData(node);</code>,   <code>await UpdateNode(node);</code>      .</li>
</ol><br>
<p>     - .  :</p><br>
<ul>
<li>  :</li>
</ul><br>
<pre><code class="javascript hljs"><span class="hljs-comment">/**
 *       ,     
 */</span>
<span class="hljs-keyword">export</span> interface IQueuedDisposableLockTarget extends ILockTarget {
    <span class="hljs-comment">/**     . Lock          IsDisposing() === true */</span><font></font>
    IsDisposing(): boolean;<font></font>
    SetDisposing(): <span class="hljs-keyword">void</span>;<font></font>
}</code></pre><br>
<ul>
<li>       :</li>
</ul><br>
<pre><code class="javascript hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">QueuedDispose</span>(<span class="hljs-params">controller: IQueuedDisposableLockTarget</span>): <span class="hljs-title">void</span> </span>{
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">let</span> xQueue = GetQueue(controller);
    <span class="hljs-comment">// 1. ,     -,   -  </span>
    <span class="hljs-keyword">if</span> (xQueue.Empty) {<font></font>
        controller.Dispose();<font></font>
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// 2.  ,     " ",     ,   .  </span><font></font>
    controller.SetDisposing();<font></font>
    <span class="hljs-comment">// 3.   finally  </span>
    xQueue.finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
        debug.assert(!IsDisposed(controller), <span class="hljs-string">"-      ,  "</span>);<font></font>
        controller.Dispose();<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
<p> ,          .    <code>QueuedDispose</code>     :</p><br>
<ul>
<li>        .       . </li>
<li>  <code>QueuedDispose</code>     <code>controller</code>.         —  ExtJS     .</li>
</ul><br>
<p><strong></strong></p><br>
<p> ,          , ..         . ,      ?    ,  .</p><br>
<p>   ,      :</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    vk.com</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Telegram</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja464759/index.html">プロジェクトマネージャーが2020年に必要とする数十のアジャイルブック</a></li>
<li><a href="../ja464761/index.html">小さな改造はテスラをビデオ監視ステーションに変えます</a></li>
<li><a href="../ja464763/index.html">Linux上のサーバーのベンチマーク：オープンツールの選択</a></li>
<li><a href="../ja464765/index.html">FreePBX + GoIPの構成</a></li>
<li><a href="../ja464769/index.html">Badooが毎秒20万枚の写真を提供することを可能にした方法</a></li>
<li><a href="../ja464775/index.html">9月21日Badoo PHPミートアップ＃3：パフォーマンス</a></li>
<li><a href="../ja464777/index.html">constがC / C ++コードを高速化しないのはなぜですか？</a></li>
<li><a href="../ja464779/index.html">快楽主義のミツバチについて、人々が彼らを働かせる方法とドローン</a></li>
<li><a href="../ja464781/index.html">スマートTV：CRTからHDR</a></li>
<li><a href="../ja464785/index.html">競争力のないビーラインのメリット</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>