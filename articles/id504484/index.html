<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐽 🧛🏿 😇 IPSec Mahakuasa ⛽️ 💔 🤛🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang teman teman. Bukan rahasia lagi bahwa banyak dari kita memiliki setidaknya sekali, tetapi harus berurusan dengan kebutuhan untuk mengkon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Mahakuasa</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selamat siang teman teman. </font><font style="vertical-align: inherit;">Bukan rahasia lagi bahwa banyak dari kita memiliki setidaknya sekali, tetapi harus berurusan dengan kebutuhan untuk mengkonfigurasi VPN. </font><font style="vertical-align: inherit;">Menjadi pembaca aktif Habr, saya perhatikan bahwa meskipun ada banyak artikel tentang IPSec, bagi banyak orang itu masih merupakan sesuatu yang rumit dan kelebihan beban. </font><font style="vertical-align: inherit;">Pada artikel ini saya akan mencoba untuk menghilangkan mitos-mitos ini menggunakan konfigurasi saya sendiri yang berfungsi penuh sebagai contoh. </font><font style="vertical-align: inherit;">Dalam empat contoh, kita akan benar-benar melalui konfigurasi solusi Linux (Strongswan) paling populer, dari terowongan sederhana dengan otentikasi sisi dengan kunci PSK ke koneksi host-ke-host dengan otentikasi kedua belah pihak berdasarkan sertifikat dari Let's Encrypt. </font><font style="vertical-align: inherit;">Menarik? </font><font style="vertical-align: inherit;">Selamat datang di kucing!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latar Belakang</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Awalnya, VPN direncanakan hanya untuk pengaturan saluran antara router mini dari orang tua dan server home "bedside", yang secara bersamaan bertindak sebagai router. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah beberapa saat, Keenetic ditambahkan ke perusahaan ini dari dua perangkat. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi begitu mulai, ternyata sulit untuk berhenti, dan segera telepon dan laptop muncul pada diagram, yang ingin bersembunyi dari mata iklan MT_Free dan jaringan WiFi tidak terenkripsi lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian ILV yang dicintai akhirnya menguatkan Banhammer, yang sangat ia cintai di depan umum berayun ke segala arah, dan untuk menetralisir kepeduliannya terhadap manusia biasa, ia harus </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendukung sektor IT asing</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk mendapatkan VPS di luar negeri.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, seorang warga negara tertentu yang terlihat seperti Shapoklyak, berlarian di mana-mana dengan </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tasnya oleh</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paket, dan mungkin percaya bahwa "Siapa yang membantu orang, membuang-buang waktu. </font><font style="vertical-align: inherit;">Kamu tidak bisa menjadi terkenal karena perbuatan baik, ”aku ingin mengintip lalu lintas orang lain dan mengambilnya dengan pensil. </font><font style="vertical-align: inherit;">Kami juga harus membela diri terhadap cinta dan VPN yang tidak diminta dalam hal ini persis seperti yang diperintahkan dokter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk meringkas ringkasan singkat. </font><font style="vertical-align: inherit;">Itu perlu untuk menemukan solusi yang idealnya dapat menutup beberapa tugas sekaligus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interkoneksi antar router Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Membangun terowongan antara Linux dan Rumah Tangga Keenetik</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Berikan akses ke sumber daya rumah dan Internet ke perangkat yang dapat dipakai (telepon, laptop) dari jaringan yang tidak terpercaya</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Buat terowongan terenkripsi dengan aman ke VPS jarak jauh</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jangan lupa tentang prinsip KISS yang luar biasa - Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">Semakin sedikit komponen yang terlibat dan semakin mudah untuk mengkonfigurasi masing-masing - semakin dapat diandalkan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ikhtisar solusi yang ada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara singkat membahas apa yang sekarang: </font><font style="vertical-align: inherit;">
Kakek </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lenin dari semua protokol. </font><font style="vertical-align: inherit;">Mati, "Membusuk di cetakan dan madu linden." </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Apakah ada orang selain satu penyedia yang menggunakan ini? </font><font style="vertical-align: inherit;">
Proyek </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wireguard</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sedang berkembang. </font><font style="vertical-align: inherit;">Digergaji secara aktif. </font><font style="vertical-align: inherit;">Sangat mudah untuk membuat terowongan antara dua rekan yang memiliki IP statis. </font><font style="vertical-align: inherit;">Dalam kasus lain, kruk, sepeda dengan roda persegi dan pita listrik biru selalu siap membantu, tetapi ini bukan cara kami. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dukungan untuk berbagai platform - Windows, Linux, OpenWRT dan turunannya, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enkripsi yang kuat dan dukungan sertifikat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fleksibilitas penyesuaian.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Dan kontra:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bekerja sepenuhnya di ruang pengguna.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dukungan terbatas dari router rumah - krenenko-kosenko di Mikrotik (tanpa mengurangi kelebihan kelenjar lainnya) dan normal di OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kesulitan dalam mengatur klien seluler: Anda perlu mengunduh, atau membuat pemasang Anda sendiri, menyalin konfigurasi di suatu tempat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jika ada beberapa terowongan, tarian akan menunggu dengan mengedit unit systemd di server.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (implementasi open source dari protokol Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Suatu solusi yang sangat menarik tentang yang, sayangnya, adalah sedikit informasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dukungan yang relatif luas untuk berbagai platform - Windows, Android, Mac berdasarkan aplikasi asli Cisco Anyconnect dari toko - adalah pilihan ideal untuk menyediakan akses ke jaringan internal perangkat yang dapat dipakai.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enkripsi yang kuat, dukungan sertifikat, konektivitas 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokol itu sendiri sepenuhnya berbasis TLS (tidak seperti OpenVPN, yang mudah dideteksi pada port 443). </font><font style="vertical-align: inherit;">Selain TLS, DTLS juga didukung - selama sesi yang ditetapkan, klien dapat beralih untuk mentransmisikan data melalui UDP dan sebaliknya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Koeksistensi luar biasa pada satu port baik untuk VPN maupun server web lengkap menggunakan sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pengaturan mudah dari server dan klien.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini juga bukan tanpa kontra:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bekerja sepenuhnya di ruang pengguna.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP di atas TCP adalah ide yang buruk.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tidak ada dukungan dari peralatan tingkat pelanggan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kompleksitas menginstal terowongan antara dua Linux: secara teori memungkinkan, praktis - lebih baik menghabiskan waktu untuk sesuatu yang lebih berguna.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jika ada beberapa terowongan, tarian dengan beberapa konfigurasi dan unit sistem editing sedang menunggu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sepertinya jalan buntu, tetapi setelah melihat lebih dekat dan menghabiskan sedikit waktu belajar, saya menyadari bahwa IPSec yang berbasis pada IKEv2 mampu menggantikan yang lainnya. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dengan munculnya IKEv2, protokol itu sendiri menjadi lebih mudah untuk dikonfigurasi, dibandingkan dengan versi sebelumnya, tetapi dengan biaya kehilangan kompatibilitas ke belakang.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berkat standardisasi, pekerjaan disediakan di mana saja dan apa saja - daftarnya dapat dipertahankan tanpa batas waktu. </font><font style="vertical-align: inherit;">Linux, Mikrotik (dalam versi terbaru dari RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows juga memiliki dukungan asli yang dimulai dengan Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kecepatan tinggi: pemrosesan lalu lintas sepenuhnya di ruang kernel. </font><font style="vertical-align: inherit;">Bagian ruang pengguna hanya diperlukan untuk mengatur parameter koneksi dan memantau kesehatan saluran.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kemampuan untuk menggunakan beberapa metode otentikasi: menggunakan PSK dan sertifikat, dan dalam kombinasi apa pun.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa mode pengoperasian: terowongan dan transportasi. </font><font style="vertical-align: inherit;">Bagaimana perbedaan mereka dapat dibaca termasuk di Habré.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan ringan untuk simpul perantara: jika dalam versi pertama IKE ada masalah yang disebabkan oleh NAT, maka IKEv2 memiliki mekanisme bawaan untuk mengatasi NAT dan fragmentasi asli pesan IKE, yang memungkinkan Anda membuat koneksi pada saluran dengan kurva MTU. </font><font style="vertical-align: inherit;">Ke depan, saya akan mengatakan bahwa dalam praktiknya saya tidak pernah menjumpai jaringan WiFi, di mana pun klien dapat membuat koneksi.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kontra, bagaimanapun, juga memiliki:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Anda perlu meluangkan waktu mempelajari dan memahami cara kerjanya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur yang dapat membingungkan pemula: IPSec, tidak seperti solusi VPN konvensional, tidak membuat antarmuka jaringan. </font><font style="vertical-align: inherit;">Hanya kebijakan pemrosesan lalu lintas yang ditetapkan, yang lainnya diselesaikan dengan cara firewall.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum melanjutkan dengan pengaturan, kami berasumsi bahwa pembaca sudah sedikit akrab dengan konsep dan istilah dasar. </font><font style="vertical-align: inherit;">Untuk membantu pemula, Anda dapat merekomendasikan artikel dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan Habr sendiri, yang sudah ada artikel yang cukup menarik dan bermanfaat tentang topik ini.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memulai pengaturan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah memutuskan keputusan, kami melanjutkan ke konfigurasi. </font><font style="vertical-align: inherit;">Diagram jaringan dalam kasus saya memiliki bentuk berikut (dihapus di bawah spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagram jaringan</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah server rumah yang merupakan pusat jaringan. IP eksternal 1.1.1.1. Jaringan internal 10.0.0.0/23 dan alamat lain 10.255.255.1/30 untuk mengatur sesi BGP pribadi dengan VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah router Linux yang didasarkan pada nettop kecil dan sunyi yang dipasang oleh orang tua. ISP mengeluarkan alamat IP dinamis. Jaringan internal 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Router </font><b><font style="vertical-align: inherit;">tajam</font></b><font style="vertical-align: inherit;"> dengan IPSec diinstal. ISP mengeluarkan alamat IP dinamis. Jaringan internal 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-warriors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - perangkat portabel yang terhubung dari jaringan yang tidak terpercaya. Alamat dikeluarkan untuk klien secara dinamis ketika terhubung dari kumpulan internal (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS di luar yurisdiksi ILV yang disegani. </font><font style="vertical-align: inherit;">IP eksternal - 5.5.5.5, alamat internal 10.255.255.2/30 untuk mengatur sesi BGP pribadi.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah pertama. </font><font style="vertical-align: inherit;">Dari sederhana ke rumit: terowongan menggunakan kunci yang dibagikan sebelumnya (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di kedua Linux-box kami menginstal paket yang diperlukan:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada kedua host, buka port 500 / udp, 4500 / udp dan biarkan lewatnya protokol ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit file /etc/strongswan/ipsec.secrects (di sisi host ipsecgw.example.com) dan tambahkan baris berikut:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sisi kedua, sama:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, ID adalah alamat email fiktif. </font><font style="vertical-align: inherit;">Informasi lebih lanjut dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resmi </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rahasia disimpan, terus berjalan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada host ipsecgw.example.com, edit file /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demikian pula, kami mengedit pada remote peer /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda membandingkan konfigurasi, Anda dapat melihat bahwa mereka hampir dicerminkan, hanya definisi dari teman sebaya yang ditukar silang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arahan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = rute</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menyebabkan charon mengatur jebakan untuk lalu lintas yang jatuh ke arahan left / rightsubnet (penyeleksi lalu lintas). </font><font style="vertical-align: inherit;">Koordinasi parameter terowongan dan pertukaran kunci akan dimulai segera setelah munculnya lalu lintas yang jatuh di bawah kondisi yang diberikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di server ipsecgw.example.com dalam pengaturan firewall, kami melarang menyamar untuk jaringan 10.0.3.0/24. </font><font style="vertical-align: inherit;">Izinkan penerusan paket antara 10.0.0.0/23 dan 10.0.3.0/24 dan sebaliknya. </font><font style="vertical-align: inherit;">Pada host jarak jauh, kami melakukan pengaturan serupa dengan menonaktifkan penyamaran untuk jaringan 10.0.0.0/23 dan mengatur penerusan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami me-restart strongswan di kedua server dan mencoba melakukan ping ke simpul pusat:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pastikan semuanya berfungsi:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini juga akan berguna untuk memastikan bahwa parameter make_before_break diatur ke yes di file /etc/strongswan/strongswan.d/charon.conf di semua rekan. </font><font style="vertical-align: inherit;">Dalam hal ini, daemon charon yang melayani protokol IKEv2 tidak akan menghapus asosiasi keamanan saat ini selama prosedur perubahan utama, tetapi akan membuat yang baru terlebih dahulu.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah Dua </font><font style="vertical-align: inherit;">Munculnya Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kejutan yang menyenangkan adalah IPSec VPN bawaan di firmware Keenetic resmi. </font><font style="vertical-align: inherit;">Untuk mengaktifkannya, cukup buka </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan Komponen KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan tambahkan paket </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menyiapkan pengaturan pada simpul pusat, untuk ini: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit /etc/strongswan/ipsec.secrect dan tambahkan PSK untuk rekan baru:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit /etc/strongswan/ipsec.conf dan tambahkan koneksi lain sampai akhir:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sisi Keenetic, konfigurasi dilakukan di WebUI di sepanjang jalur: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Connections -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other Connections</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sederhana saja</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 gambar)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda berencana untuk mengarahkan volume lalu lintas yang signifikan melalui terowongan, maka Anda dapat mencoba mengaktifkan akselerasi perangkat keras, yang didukung oleh banyak model. </font><font style="vertical-align: inherit;">Diaktifkan oleh perintah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perangkat keras mesin crypto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di CLI. </font><font style="vertical-align: inherit;">Untuk menonaktifkan dan memproses enkripsi dan proses hashing menggunakan instruksi CPU untuk keperluan umum - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perangkat lunak mesin crypto</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Setelah menyimpan pengaturan, kami mengembalikan strongswan dan membiarkan Keenetic berpikir selama setengah menit. </font><font style="vertical-align: inherit;">Kemudian di terminal kita melihat koneksi yang berhasil:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semuanya berfungsi:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah ketiga </font><font style="vertical-align: inherit;">Melindungi perangkat seluler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah membaca banyak manual dan banyak artikel, diputuskan untuk berhenti di sekelompok sertifikat gratis dari Let's Encrypt untuk mengotentikasi server dan otorisasi klasik dengan login dan kata sandi untuk klien. </font><font style="vertical-align: inherit;">Dengan demikian, kami menyingkirkan kebutuhan untuk mempertahankan infrastruktur PKI kami sendiri, memantau kedaluwarsa kunci dan melakukan gerakan yang tidak perlu dengan perangkat seluler dengan memasang sertifikat yang ditandatangani sendiri dalam daftar tepercaya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal paket yang hilang:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mendapatkan sertifikat mandiri (jangan lupa untuk membuka 80 / tcp di pengaturan iptables terlebih dahulu):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah certbot menyelesaikan tugasnya, kita harus mengajar Strongswan untuk melihat sertifikat kami:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di direktori /etc/strongswan/ipsec.d/cacerts membuat 2 tautan simbolis: satu ke root store sertifikat tepercaya di / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">dan yang kedua dengan nama ca.pem yang menunjuk ke /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dua symlink juga dibuat di direktori /etc/strongswan/ipsec.d/certs: yang pertama, dengan nama Certificate.pem, merujuk ke file /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">Dan yang kedua, bernama fullchain.pem, yang terhubung ke /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam direktori /etc/strongswan/ipsec.d/private, tempatkan symlink key.pem menunjuk ke kunci pribadi yang dihasilkan oleh certbot dan berbaring di sepanjang jalan /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambahkan otentikasi melalui RSA ke ipsec.secrets dan sekelompok login / kata sandi untuk pengguna baru:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami me-restart Strongswan dan ketika memanggil sudo strongswan listcerts kita akan melihat informasi sertifikat:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian kami menggambarkan koneksi baru di </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jangan lupa mengedit file / etc / sysconfig / certbot yang mengindikasikan bahwa kami juga akan memperbarui sertifikat sebagai mandiri, dengan menambahkan CERTBOT_ARGS = "- standalone" ke dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga, jangan lupa untuk mengaktifkan timer certbot-renew.timer dan atur hook untuk memulai kembali Strongswan jika mengeluarkan sertifikat baru. </font><font style="vertical-align: inherit;">Untuk melakukan ini, letakkan skrip bash sederhana di / etc / letsencrypt / renewal-hooks / deploy /, atau edit file / etc / sysconfig / certbot lagi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memulai ulang Strongswan, aktifkan penyamaran untuk jaringan 10.1.1.0/24 di iptables dan lanjutkan untuk mengonfigurasi perangkat seluler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal aplikasi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami meluncurkan dan membuat yang baru</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menyimpan profil, terhubung dan, setelah sedetik, kami tidak perlu khawatir tentang seseorang yang dapat memata-matai kami.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memeriksa:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows versi saat ini terkejut. </font><font style="vertical-align: inherit;">Semua konfigurasi VPN baru berlangsung dengan memanggil dua cmdlet PowerShell:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan satu hal lagi, jika Strongswan dikonfigurasikan untuk mengeluarkan alamat IPv6 kepada klien (ya, ia juga bisa melakukannya):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian Empat, Final. </font><font style="vertical-align: inherit;">Kami memotong jendela ke Eropa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah melihat selokan penyedia "Situs ini diblokir oleh keputusan tumit kiri wakil jaksa kelima desa Trudovye Mozoli dari daerah Bogozabyt", sebuah VPS kecil dan tidak mencolok muncul (dengan nama domain yang terdengar bagus rkn.example.com) seribu kilometer dari monyet yang suka melambai dengan banhammer dan ukuran jaringan blok. / 16 sekaligus. Dan memutar VPS kecil ini adalah kreasi luar biasa dari rekan-rekan dari NIC.CZ bernama BIRD. Burung versi pertama terus-menerus mati dalam kepanikan akibat aktivitas monyet dengan pentungan, yang melarang hampir 4% Internet di puncak aktivitas kerja mereka, meninggalkan perhatian mendalam selama konfigurasi ulang, oleh karena itu diperbarui ke versi 2.0.7. Jika pembaca tertarik, saya akan menerbitkan artikel tentang transisi dari BIRD ke BIRD2, di mana format konfigurasi telah berubah secara dramatis,tetapi versi baru telah menjadi jauh lebih cepat dan tidak ada masalah dengan konfigurasi ulang dengan sejumlah besar rute. Dan karena kita menggunakan protokol routing dinamis, maka harus ada antarmuka jaringan yang melaluinya Anda perlu merutekan lalu lintas. Secara default, IPSec tidak membuat antarmuka, tetapi karena fleksibilitasnya, kita dapat menggunakan terowongan GRE klasik, yang akan kita lindungi di masa depan. Sebagai bonus, host ipsecgw.example.com dan rkn.example.com akan saling mengautentikasi menggunakan sertifikat yang memperbaharui diri sendiri. Tidak ada PSK, hanya sertifikat, hanya hardcore, tidak ada banyak keamanan.Secara default, IPSec tidak membuat antarmuka, tetapi karena fleksibilitasnya, kita dapat menggunakan terowongan GRE klasik, yang akan kita lindungi di masa depan. Sebagai bonus, host ipsecgw.example.com dan rkn.example.com akan saling mengautentikasi menggunakan sertifikat yang memperbaharui diri sendiri. Tidak ada PSK, hanya sertifikat, hanya hardcore, tidak ada banyak keamanan.Secara default, IPSec tidak membuat antarmuka, tetapi karena fleksibilitasnya, kita dapat menggunakan terowongan GRE klasik, yang akan kita lindungi di masa depan. Sebagai bonus, host ipsecgw.example.com dan rkn.example.com akan saling mengautentikasi menggunakan sertifikat yang memperbaharui diri sendiri. Tidak ada PSK, hanya sertifikat, hanya hardcore, tidak ada banyak keamanan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami percaya bahwa VPS disiapkan, Strongswan dan Certbot sudah diinstal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada host ipsecgw.example.com (IP-nya 1.1.1.1), kami menggambarkan antarmuka gif0 baru:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dicerminkan pada host vps.example.com (IP-nya 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami meningkatkan antarmuka, tetapi karena iptables tidak memiliki aturan yang memungkinkan protokol GRE, lalu lintas tidak akan pergi (yang kami butuhkan, karena tidak ada perlindungan di dalam GRE terhadap penggemar dari segala jenis "paket" legislatif).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memasak VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami mendapatkan sertifikat lain untuk nama domain rkn.example.com. </font><font style="vertical-align: inherit;">Buat symlink di /etc/strongswan/ipsec.d seperti yang dijelaskan di bagian sebelumnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit ipsec.secrets dengan menambahkan satu baris ke dalamnya:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sisi tuan rumah, ipsecgw.example.com juga ditambahkan ke ipsec.conf di bagian pengaturan parameter strictcrlpolicy = yes, yang mencakup pemeriksaan CRL yang ketat. </font><font style="vertical-align: inherit;">Dan uraikan koneksi lain:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurasi hampir dicerminkan. </font><font style="vertical-align: inherit;">Pembaca yang penuh perhatian sudah bisa memperhatikan beberapa poin:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kiri / rightsubnet =% dinamis - memerintahkan Strongswan untuk menerapkan kebijakan ke semua jenis lalu lintas antar teman</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jangan lupa untuk mengkonfigurasi firewall dan sertifikat perpanjangan otomatis. </font><font style="vertical-align: inherit;">Setelah memulai ulang Strongswan di kedua server, mulai ping sisi jauh dari terowongan GRE dan lihat koneksi yang berhasil. </font><font style="vertical-align: inherit;">Di VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di ipsecgw sisi tuan rumah </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di bawah spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terowongan diinstal, ping pergi, di tcpdump terlihat bahwa hanya ESP yang berjalan di antara host. </font><font style="vertical-align: inherit;">Tampaknya mungkin untuk bersukacita. </font><font style="vertical-align: inherit;">Tetapi Anda tidak dapat bersantai tanpa memeriksa semuanya sampai akhir. </font><font style="vertical-align: inherit;">Kami sedang mencoba menerbitkan kembali sertifikat untuk VPS dan ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, semuanya rusak</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita mulai memahami dan menemukan satu fitur yang tidak menyenangkan dari Let's Encrypt, yang indah dalam hal lainnya - dengan penerbitan ulang sertifikat, kunci pribadi yang terkait dengannya juga berubah. Kunci pribadi telah berubah - dan publik telah berubah. Pada pandangan pertama, situasinya tidak ada harapan bagi kita: bahkan jika kita dapat dengan mudah mengekstraksi kunci publik selama penerbitan ulang sertifikat menggunakan hook di certbot dan meneruskannya ke sisi jarak jauh melalui SSH, tidak jelas bagaimana membuat Strongswan remote membacanya kembali. Tetapi bantuan datang dari tempat mereka tidak menunggu - systemd dapat memantau perubahan pada sistem file dan menjalankan layanan yang terkait dengan acara tersebut. Ini yang akan kita gunakan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan membuat pengguna layanan pengamat kunci di setiap host dengan hak yang paling terbatas, menghasilkan kunci SSH untuk masing-masing, dan menukarnya di antara host. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada host ipsecgw.example.com, buat direktori / opt / ipsec-pubkey tempat kami menempatkan 2 skrip.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada VPS (host rkn.example.com), kami juga membuat direktori dengan nama yang sama, di mana kami juga membuat skrip yang sama, hanya mengubah nama kunci. </font><font style="vertical-align: inherit;">Kode, agar tidak mengacaukan artikel, di bawah</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spoiler</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Script pubkey-copy.sh diperlukan untuk mengekstrak bagian publik kunci dan menyalinnya ke host jarak jauh ketika mengeluarkan sertifikat baru. </font><font style="vertical-align: inherit;">Untuk melakukan ini, di direktori / etc / letsencrypt / renewal-hooks / deploy di kedua server, buat microscript lain:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setengah dari masalah diselesaikan, sertifikat dikeluarkan kembali, kunci publik diekstraksi dan disalin antara server, dan waktunya telah tiba untuk systemd dengan unit path-nya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada server ipsecgw.example.com di direktori / etc / systemd / system, buat file keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demikian pula pada host VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan akhirnya, pada setiap server kami membuat layanan yang terkait dengan unit ini, yang akan diluncurkan ketika kondisi (PathChanged) terpenuhi - mengubah file dan menutupnya setelah merekam. </font><font style="vertical-align: inherit;">Kami membuat file /etc/systemd/system/keyupdater.service dan menulis:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jangan lupa untuk membaca kembali konfigurasi systemd dengan sudo systemctl daemon-reload dan tetapkan autostart ke unit path melalui sudo systemctl aktifkan keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera setelah host jarak jauh menulis file yang berisi kunci publik ke direktori home pengguna keywatcher dan deskriptor file ditutup, systemd akan secara otomatis memulai layanan yang sesuai, yang akan menyalin kunci ke lokasi yang diinginkan dan memulai kembali Strongswan. </font><font style="vertical-align: inherit;">Terowongan akan dipasang menggunakan kunci publik yang benar dari sisi kedua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menghembuskan napas dan menikmati hasilnya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alih-alih sebuah kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti kita hanya melihat </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neraka</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec adalah tidak menakutkan seperti yang dicat. </font><font style="vertical-align: inherit;">Semua yang telah dijelaskan adalah konfigurasi operasional penuh yang saat ini digunakan. </font><font style="vertical-align: inherit;">Bahkan tanpa banyak pengetahuan, Anda dapat mengkonfigurasi VPN dan melindungi data Anda dengan andal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentu saja, saat-saat pengaturan iptables tetap berada di luar ruang lingkup artikel, tetapi artikel itu sendiri ternyata sudah sangat banyak, dan banyak yang telah ditulis tentang iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada poin-poin dalam artikel yang dapat ditingkatkan, baik itu penolakan untuk memulai ulang daemon Strongswan, membaca kembali konfigurasi dan sertifikatnya, tetapi saya tidak dapat mencapainya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, daemon yang dimulai ulang tidak menakutkan: satu atau dua ping di antara rekan-rekan terputus, klien seluler memulihkan koneksi sendiri.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya harap kolega dalam komentar akan meminta solusi yang benar.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id504464/index.html">Bagaimana kami menemukan TableAdapter dan menyederhanakan pekerjaan dengan UITableView</a></li>
<li><a href="../id504468/index.html">Kinerja Raspberry Pi: tambahkan ZRAM dan ubah parameter kernel</a></li>
<li><a href="../id504472/index.html">Alat Pengembang Gratis Teratas Saya</a></li>
<li><a href="../id504480/index.html">Bagaimana cara menemukan seorang pemasar yang akan menguntungkan untuk bekerja?</a></li>
<li><a href="../id504482/index.html">Tanyakan kepada kami: DIT akan menjawab pertanyaan</a></li>
<li><a href="../id504486/index.html">Proses: Membuat Vue 3</a></li>
<li><a href="../id504488/index.html">Industri dan teknologi apa yang akan mulai berkembang pesat setelah menyelesaikan masalah COVID-19</a></li>
<li><a href="../id504490/index.html">Juni Acara Online Intisari</a></li>
<li><a href="../id504492/index.html">Tekan tombol: teori dan praktik meja bundar pemungutan suara elektronik pada 30 Mei</a></li>
<li><a href="../id504502/index.html">Kehidupan pendek dan aneh dari robot ramah pertama di dunia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>