<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüåæ üñ≤Ô∏è üå∂Ô∏è Nous √©tudions les op√©rateurs RxJS multicast üí° üê∏ üë®‚Äçüë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article "Comprendre les op√©rateurs de multidiffusion RxJS" par Netanel Basal. 
 
 Les op√©rateurs de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous √©tudions les op√©rateurs RxJS multicast</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490988/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Je vous pr√©sente la traduction de l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Comprendre les op√©rateurs de multidiffusion RxJS"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par Netanel Basal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les op√©rateurs de diffusion ou de multidiffusion semblent souvent √™tre le sujet le plus difficile √† apprendre sur RxJS. </font><font style="vertical-align: inherit;">Dans cet article, je vais essayer de tout expliquer de mani√®re accessible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous consid√©rerons la structure interne des op√©rateurs de multidiffusion et les t√¢ches qu'ils r√©solvent.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par d√©crire les blocs de construction de base de RxJS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observable</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans RxJS, les objets observables (ci-apr√®s d√©nomm√©s ¬´flux¬ª) sont initialement froids. Cela signifie que chaque fois que vous vous abonnez √† un flux, un rappel de l'abonnement est effectu√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une meilleure compr√©hension, cr√©ez l'impl√©mentation suivante:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Observable</span> </span>{
  <span class="hljs-keyword">constructor</span>(subscriptionFn) {
    <span class="hljs-keyword">this</span>.subscriptionFn = subscriptionFn;<font></font>
  }<font></font>
<font></font>
  subscribe(observer) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscriptionFn(observer);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le constructeur </font></font><code>Observable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accepte un seul param√®tre - le rappel de l'abonnement </font></font><br>
 <code>subscriptionFn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il sera appel√© chaque fois que nous nous abonnerons au stream ( </font></font><code>subscribe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, ils appellent un rappel d'un abonnement </font></font><code>producer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car cela ¬´produit¬ª √©galement des valeurs pour l'abonn√© (l'objet observateur dans notre code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode </font></font><code>subscribe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prend une entr√©e </font></font><code>observer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est un objet avec trois m√©thodes propres: </font></font><code>next(), error(), complete()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans RxJS en direct, vous pouvez passer trois fonctions au lieu d'un objet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode, </font></font><code>subscribe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lorsqu'elle est appel√©e, appelle la fonction d'abonnement en la passant √† l'entr√©e </font></font><code>observer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas mentionn√© la m√©thode maintenant</font></font><code>unsubscribe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais il ne faut pas oublier que chaque abonnement permet de le d√©truire. </font><font style="vertical-align: inherit;">Le plus souvent, un abonnement renvoie une fonction (ou un objet avec la m√©thode appropri√©e), au cours de laquelle la connexion entre le flux et ses abonn√©s est d√©truite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela est assez simple. </font><font style="vertical-align: inherit;">Rapprochez-vous de la r√©alit√© maintenant. </font><font style="vertical-align: inherit;">Par exemple, encapsuler une API XHR native dans un flux</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">http</span>(<span class="hljs-params">url</span>) </span>{
  <span class="hljs-comment">// This function will be called when we call http().subscribe()</span>
  <span class="hljs-keyword">const</span> subscriptionFn = <span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> {<font></font>
    log(<span class="hljs-string">'Observable execution: http'</span>);
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
    xhr.addEventListener(<span class="hljs-string">'load'</span>, () =&gt; {
      <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {<font></font>
        observer.next(<span class="hljs-built_in">JSON</span>.parse(xhr.responseText));<font></font>
        observer.complete();<font></font>
      }<font></font>
    });<font></font>
    xhr.open(<span class="hljs-string">'GET'</span>, url);<font></font>
    xhr.send();<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> xhr.abort()<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Observable(subscriptionFn);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©crit une fonction </font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui re√ßoit une URL, ex√©cute une demande http et renvoie un flux qui √©met la r√©ponse http re√ßue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, en regardant notre impl√©mentation, que pensez-vous qu'il se passera lorsque nous nous abonnerons √† ce flux deux fois?</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-comment">// A small observer helper</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-function"><span class="hljs-params">tag</span> =&gt;</span> ({<font></font>
  next(value) {<font></font>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${tag}</span>:`</span>, value);<font></font>
  }<font></font>
});<font></font>
<font></font>
http(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>)<font></font>
  .subscribe(observer(<span class="hljs-string">'subscriber-1'</span>));<font></font>
<font></font>
http(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>)<font></font>
  .subscribe(observer(<span class="hljs-string">'subscriber-2'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Correctement, deux requ√™tes http seront ex√©cut√©es. </font><font style="vertical-align: inherit;">Si nous regardons √† nouveau l'impl√©mentation de la classe Observable, nous verrons pourquoi il en est ainsi. </font><font style="vertical-align: inherit;">Chaque abonn√© appelle un rappel d'abonnement, qui √† son tour effectue une demande http √† chaque fois.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/by/ee/aybyeesbyfdzvcjcp3etc8jhfww.gif"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les op√©rateurs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un op√©rateur est une fonction qui prend un flux en entr√©e, effectue n'importe quelle action et renvoie un flux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©crirons notre premier op√©rateur.</font></font><br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span>(<span class="hljs-params">fn</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">source</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Observable(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> {<font></font>
      log(<span class="hljs-string">'Observable execution: map'</span>);
      <span class="hljs-keyword">return</span> source.subscribe({<font></font>
        next(value) {<font></font>
          observer.next(fn(value));<font></font>
        }<font></font>
      });<font></font>
    });<font></font>
  };<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction </font></font><code>map()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie un op√©rateur qui accepte le flux d'origine et retourne un flux dans lequel toutes les valeurs de passage seront transmises via la fonction </font></font><code>fn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceux. </font><font style="vertical-align: inherit;">√† l'int√©rieur, il y a toujours un abonnement au flux d'entr√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant d'utiliser ce nouvel op√©rateur, nous devons l'attacher en quelque sorte au flux. </font><font style="vertical-align: inherit;">Prolongez notre classe </font></font><code>Observable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en</font></font><code>pipe()</code><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Observable</span> </span>{
  <span class="hljs-keyword">constructor</span>(subscriptionFn) {
    <span class="hljs-keyword">this</span>.subscriptionFn = subscriptionFn;<font></font>
  }<font></font>
<font></font>
  subscribe(observer) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.subscriptionFn(observer);<font></font>
  }<font></font>
<font></font>
  pipe(...operators) {<font></font>
    <span class="hljs-keyword">return</span> operators.reduce(<span class="hljs-function">(<span class="hljs-params">source, next</span>) =&gt;</span> next(source), <span class="hljs-keyword">this</span>);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une m√©thode simple, une seule ligne de code. </font></font><code>pipe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il prend un tableau d'op√©rateurs et les appelle √† son tour, en passant √† chaque entr√©e le r√©sultat de la pr√©c√©dente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisons notre op√©rateur:</font></font><br>
<br>
<pre><code class="javascript hljs">http(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>)<font></font>
  .pipe(map(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res[<span class="hljs-number">0</span>]))<font></font>
  .subscribe(observer(<span class="hljs-string">'subscriber'</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'il est appel√© </font></font><code>subscribe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, un abonnement au flux de sortie sera ex√©cut√© </font></font><code>map()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et √† son tour </font></font><code>map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, un abonnement au flux d'origine sera ex√©cut√© √† l' </font><font style="vertical-align: inherit;">int√©rieur </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le flux http √©met la valeur dans laquelle il tombe </font></font><code>map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, la fonction est ex√©cut√©e </font></font><code>fn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le flux de </font></font><code>map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©met la valeur vers l'abonnement final. </font><font style="vertical-align: inherit;">Cela fonctionne comme une </font></font><code>observable chain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cha√Æne de fils. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4a/ou/8r/4aou8rffl-aqkm6asdvs2224n84.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous souscrivons √† une cha√Æne deux fois, chaque abonnement de la cha√Æne sera appel√© deux fois.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> firstUser$ = http(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>)<font></font>
    .pipe(map(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res[<span class="hljs-number">0</span>]));<font></font>
<font></font>
firstUser$.subscribe(observer(<span class="hljs-string">'subscriber-1'</span>));<font></font>
firstUser$.subscribe(observer(<span class="hljs-string">'subscriber-2'</span>));
</code></pre><br>
<img src="https://habrastorage.org/webt/kg/c2/iw/kgc2iwjualmgnqh_kcaxfe4c45g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et si ce comportement ne nous convient pas? </font><font style="vertical-align: inherit;">Si nous voulons appeler la fonction d'abonnement une seule fois, combien d'abonnements aurions-nous? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, que se passe-t-il si nous voulons faire une seule requ√™te http et utiliser le r√©sultat pour tous les abonn√©s? </font><font style="vertical-align: inherit;">Dans ce cas, vous en avez besoin </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sujets</font></font></h2><br>
<code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'est √† la fois un flux et un abonn√©. </font><font style="vertical-align: inherit;">Le flux - parce qu'il a une m√©thode </font></font><code>subscribe()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'abonn√© - parce qu'il impl√©mente l'interface d'abonn√© - m√©thodes </font></font><code>next(), error(), complete().</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âcrivons-le.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Subject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Observable</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">super</span>();
    <span class="hljs-keyword">this</span>.observers = [];<font></font>
  }<font></font>
<font></font>
  subscribe(observer) {<font></font>
    <span class="hljs-keyword">this</span>.observers.push(observer);<font></font>
  }<font></font>
<font></font>
  next(value) {<font></font>
    <span class="hljs-keyword">this</span>.observers.forEach(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> observer.next(value));<font></font>
  }<font></font>
<font></font>
  error(error) {<font></font>
    <span class="hljs-keyword">this</span>.observers.forEach(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> observer.error(error));<font></font>
  }<font></font>
<font></font>
  complete() {<font></font>
    <span class="hljs-keyword">this</span>.observers.forEach(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> observer.complete());<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
<code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut servir d'interm√©diaire entre le flux froid et de nombreux abonn√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez notre exemple comme suit:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> Subject();<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber1'</span>));<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber2'</span>));<font></font>
<font></font>
http(<span class="hljs-string">'https://jsonplaceholder.typicode.com/users'</span>)<font></font>
  .pipe(map(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res[<span class="hljs-number">0</span>]))<font></font>
  .subscribe(subject);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'elle est appel√©e </font></font><code>subject.subscribe(someFn)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, une seule op√©ration simple est effectu√©e - ajouter une </font></font><code>subject.observers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonction </font><font style="vertical-align: inherit;">au tableau </font></font><code>someFn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, comme il </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se comporte √©galement comme un abonn√©, vous pouvez le souscrire au flux d'origine, c'est-√†-dire </font><font style="vertical-align: inherit;">lorsque le thread d'origine √©met une valeur, elle est appel√©e </font></font><code>subject.next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui entra√Æne le transfert de cette valeur √† chacun des abonn√©s </font></font><code>subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant le rappel d'origine de l'abonnement ex√©cut√© une seule fois, et une seule requ√™te http sera ex√©cut√©e.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hk/8h/ld/hk8hld-xyjtum5d3srqpquhaqic.gif"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les retardataires du parti</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que se passe-t-il si le flux d'origine a d√©j√† fonctionn√© avant notre inscription? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne sera pas possible de le montrer dans l'exemple pr√©c√©dent, car http est asynchrone, m√™me si vous vous y abonnez imm√©diatement apr√®s, la valeur viendra toujours apr√®s l'abonnement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ons rapidement une fonction g√©n√©ratrice </font></font><code>of</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">of</span>(<span class="hljs-params">...values</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Observable(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> {<font></font>
    log(<span class="hljs-string">'Observable execution: of'</span>);<font></font>
    values.forEach(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> observer.next(value));<font></font>
  });<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un flux cr√©√© par moyen </font></font><code>of()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©met des valeurs de mani√®re synchrone, l'une apr√®s l'autre. </font><font style="vertical-align: inherit;">Nous nous abonnerons </font></font><code>subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apr√®s qu'il a d√©j√† souscrit √†.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> Subject();
<span class="hljs-keyword">of</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).subscribe(subject);<font></font>
<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber1'</span>));<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber2'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos abonn√©s n'ont rien re√ßu. Pourquoi? Notre impl√©mentation ne prend pas en charge les abonn√©s ¬´tardifs¬ª. Lorsque le flux d'origine </font></font><code>of()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©met des valeurs, les abonn√©s ne sont pas encore enregistr√©s, ces valeurs n'iront nulle part. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans des exemples r√©els sur Angular, il se pourrait bien que le flux source ait fonctionn√©, mais votre composant n'est pas encore pr√©sent sur la page. Et lorsque le composant appara√Æt, il s'abonne √† la source, mais ne re√ßoit pas les valeurs qui ont d√©j√† √©t√© transmises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fa√ßon de r√©soudre le probl√®me est la suivante </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous d√©crivons sa version et voyons comment cela fonctionne.</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReplaySubject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Subject</span> </span>{
  <span class="hljs-keyword">constructor</span>(bufferSize) {
    <span class="hljs-keyword">super</span>();
    <span class="hljs-keyword">this</span>.observers = [];
    <span class="hljs-keyword">this</span>.bufferSize = bufferSize;
    <span class="hljs-keyword">this</span>.buffer = [];<font></font>
  }<font></font>
<font></font>
  subscribe(observer) {<font></font>
    <span class="hljs-keyword">this</span>.buffer.forEach(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> observer.next(val));
    <span class="hljs-keyword">this</span>.observers.push(observer);<font></font>
  }<font></font>
<font></font>
  next(value) {<font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.buffer.length === <span class="hljs-keyword">this</span>.bufferSize) {
      <span class="hljs-keyword">this</span>.buffer.shift();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">this</span>.buffer.push(value);
    <span class="hljs-keyword">this</span>.observers.forEach(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> observer.next(value));<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le concept est simple. Comme son nom l'indique, </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">celui-ci est sp√©cial </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et peut reproduire les anciennes valeurs √† tous les nouveaux abonn√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque valeur publi√©e sera transf√©r√©e √† tous les abonn√©s actuels et enregistr√©e pour les futurs, la taille de la m√©moire tampon est </font></font><code>bufferSize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finie dans le constructeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©√©crivez l'exemple pr√©c√©dent avec </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> ReplaySubject(<span class="hljs-number">3</span>);
<span class="hljs-keyword">of</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).subscribe(subject);<font></font>
<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber1'</span>));<font></font>
subject.subscribe(observer(<span class="hljs-string">'subscriber2'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat a chang√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© l'abonnement tardif, nous les avons tous pris. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/xv/y1/sgxvy1flevy8totuzlejeiphvm0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√©sum√©, le but </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est la distribution de valeurs √† tous les abonn√©s et leur mise en cache pour les futurs abonn√©s "tardifs". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de continuer, je vous recommande d'essayer d'√©crire votre propre impl√©mentation </font></font><code>BehaviorSubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vous pouvez trouver le code fini √† la fin de l'article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous passons enfin aux op√©rateurs de multidiffusion. </font><font style="vertical-align: inherit;">J'esp√®re que les exemples ci-dessus vous aideront √† les comprendre plus rapidement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√©rateurs de multidiffusion</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multidiffusion et connexion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'op√©rateur </font></font><code>multicast() </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour envoyer le flux source √† plusieurs abonn√©s.</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">import</span> { interval, Subject, ConnectableObservable } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { multicast } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  multicast(<span class="hljs-keyword">new</span> Subject())<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">const</span> observer1 = connectableObservable.subscribe(log);
<span class="hljs-keyword">const</span> observer2 = connectableObservable.subscribe(log);<font></font>
<font></font>
<span class="hljs-keyword">const</span> connectableSubscription = (connectableObservable <span class="hljs-keyword">as</span> ConnectableObservable&lt;any&gt;)<font></font>
  .connect();<font></font>
</code></pre><br>
<code>multicast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie un objet </font></font><code>ConnectableObservable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui a une m√©thode </font></font><code>connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Son but est de signer le sujet re√ßu dans le flux source. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode </font></font><code>connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous permet de d√©terminer quand d√©marrer l'ex√©cution du thread d'origine. </font><font style="vertical-align: inherit;">Il y a un moment √† garder √† l'esprit - pour vous d√©sabonner de la source, vous devez faire:</font></font><br>
<br>
<pre><code class="javascript hljs">connectableSubscription.unsubscribe();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne sommes pas limit√©s au simple </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Au lieu de cela, vous pouvez utiliser n'importe quelle classe d√©riv√©e, par exemple </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { interval, ReplaySubject, ConnectableObservable } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { multicast } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  multicast(<span class="hljs-keyword">new</span> ReplaySubject(<span class="hljs-number">1</span>))<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">const</span> observer1 = connectableObservable.subscribe(log);<font></font>
<font></font>
setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-comment">// Late subscriber</span><font></font>
  connectableObservable.subscribe(log);<font></font>
}, <span class="hljs-number">3000</span>)<font></font>
<font></font>
<span class="hljs-keyword">const</span> connectable = (connectableObservable <span class="hljs-keyword">as</span> ConnectableObservable&lt;any&gt;).connect();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä partir de ce code, vous pouvez deviner ce qui se passera sous le capot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous utilisons </font></font><code>multicast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous pouvons transf√©rer non seulement </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais aussi une fonction d'usine, qui renvoie une nouvelle √† chaque fois </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©utilis√© d√©j√† termin√© </font></font><code>subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut pas l'√™tre, la fonction d'usine r√©sout ce probl√®me.</font></font><br>
<br>
<pre><code class="javascript hljs">interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  multicast(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">new</span> Subject())<font></font>
)<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refount</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous utilisons l'op√©rateur </font></font><code>multicast()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous sommes responsables de l'appel </font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour commencer l'ex√©cution de l'observable d'origine. </font><font style="vertical-align: inherit;">De plus, nous devons toujours surveiller les √©ventuelles fuites de m√©moire, en vous d√©sinscrivant manuellement </font></font><code>ConnectableSubscription</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'automatisation du processus √©viterait les erreurs et simplifierait le code. </font><font style="vertical-align: inherit;">Les aimables d√©veloppeurs RxJS y ont pens√© et ont cr√©√© un </font></font><code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">op√©rateur. </font></font><br>
<br>
<code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compte les abonnements et lorsque le premier appara√Æt, il appelle </font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, c'est-√†-dire </font><font style="vertical-align: inherit;">s'abonne. </font><font style="vertical-align: inherit;">Quand il revient √† z√©ro, une r√©ponse sera appel√©e.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> source = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  multicast(<span class="hljs-keyword">new</span> Subject()),<font></font>
  refCount()<font></font>
)<font></font>
 <font></font>
<span class="hljs-comment">// refCount === 1 =&gt; source.subscribe();</span>
<span class="hljs-keyword">const</span> observer1 = source.subscribe(log);<font></font>
<font></font>
<span class="hljs-comment">// refCount === 2</span>
<span class="hljs-keyword">const</span> observer2 = source.subscribe(log);<font></font>
<font></font>
setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-comment">// refCount - 1</span><font></font>
  observer1.unsubscribe();<font></font>
  <span class="hljs-comment">// refCount - 1</span><font></font>
  observer2.unsubscribe();<font></font>
  <span class="hljs-comment">// refCount === 0 =&gt; source.unsubcribe();</span>
}, <span class="hljs-number">3000</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez qu'apr√®s avoir </font></font><code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenu l'observable habituel, non </font></font><code>ConnectableObservable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Publier et ses variantes</font></font></h3><br>
<code>multicast() + Subject + refCount()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'est un cas assez typique dans RxJS et les d√©veloppeurs l'ont r√©duit √† un seul op√©rateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons quelles options nous avons.</font></font><br>
<br>
<ul>
<li><code>publish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalent </font></font><code>multicast(() =&gt; new Subject())</code><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  publish()<font></font>
)<font></font>
<font></font>
connectableObservable.connect();<font></font>
</code></pre><br>
</li>
<li><code>publishBehavior()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalent </font></font><code>multicast(new BehaviorSubject())</code><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  publishBehavior(<span class="hljs-number">100</span>)<font></font>
)<font></font>
<font></font>
connectableObservable.connect();<font></font>
</code></pre><br>
</li>
<li><code>publishReplay()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalent </font></font><code>multicast(() =&gt; new ReplaySubject(x))</code><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  publishReplay(<span class="hljs-number">3</span>)<font></font>
)<font></font>
<font></font>
connectableObservable.connect();<font></font>
</code></pre><br>
</li>
<li><code>publishLast()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalent </font></font><code>multicast(new AsyncSubject())</code><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> connectableObservable = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  take(<span class="hljs-number">2</span>),<font></font>
  publishLast()<font></font>
)<font></font>
<font></font>
connectableObservable.connect();<font></font>
</code></pre><br>
</li>
<li><code>share()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalent </font></font><code>multicast(() =&gt; new Subject()) + refCount()</code><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> source = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  share()<font></font>
)<font></font>
</code></pre><br>
</li>
<li><code>shareReplay(bufferSize) </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un op√©rateur de multidiffusion qui utilise </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il n'a pas √† l'int√©rieur </font></font><code>multicast()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et son r√©sultat est observable, non </font></font><code>ConnectableObservable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il peut √™tre utilis√© avec </font></font><code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou sans. </font><font style="vertical-align: inherit;">Voici les deux options:</font></font><br>
<br>
<pre><code class="javascript hljs">interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  shareReplay({ <span class="hljs-attr">refCount</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">1</span> })<font></font>
)<font></font>
<font></font>
interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  shareReplay(<span class="hljs-number">1</span>)<font></font>
)<font></font>
</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'il est </font></font><code>shareReplay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appel√© avec, </font></font><code>{ refCount: false }</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'est comme appeler </font></font><code>shareReplay(x)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, il n'y aura pas de comptage de r√©f√©rences. </font><font style="vertical-align: inherit;">Cela signifie que jusqu'√† ce que le flux d'origine soit termin√©, il </font></font><code>shareReplay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y sera abonn√©, qu'il ait lui-m√™me ou non les abonn√©s finaux. </font><font style="vertical-align: inherit;">Tous les nouveaux abonn√©s recevront les derni√®res valeurs x.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shareReplay vs publishReplay + refCount</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä premi√®re vue </font><font style="vertical-align: inherit;">, c'est </font></font><code>shareReplay({ refCount: true, bufferSize: X })</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identique </font></font><code>publishReplay(X) + refCount() </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais ce n'est pas tout √† fait vrai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons quelles sont les similitudes et quelle est la diff√©rence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont le m√™me comportement </font></font><code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- s'abonner et se d√©sinscrire du flux d'origine en fonction du nombre d'abonn√©s. </font><font style="vertical-align: inherit;">Ils r√©agissent √©galement de la m√™me mani√®re lorsque le flux d'origine est termin√© - tous les nouveaux abonn√©s re√ßoivent X derni√®res valeurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, si le flux d'origine n'est pas encore finalis√©, dans ce cas o√π nous l'avons </font></font><code>publishReplay(X) + refCount()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- tous les nouveaux abonn√©s re√ßoivent des valeurs X du tampon, puis seront re-sign√©s en utilisant le m√™me </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous utilisons les </font></font><code>shareReplay({ refCount: true, bufferSize: 1 })</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">derni√®res valeurs X, ils ne les obtiendront pas, car √† l'int√©rieur, il en cr√©e une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouvelle</font></font></i> <code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l'utilise pour se r√©abonner √† la source.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemples illustrant cela:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> source = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  publishReplay(<span class="hljs-number">1</span>),<font></font>
  refCount()<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">const</span> one = source.subscribe(observer(<span class="hljs-string">'subcriber-1'</span>));<font></font>
<font></font>
setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
  one.unsubscribe();<font></font>
 <font></font>
  <span class="hljs-comment">// This subscriber will get the last emitted values from the source</span>
  <span class="hljs-keyword">const</span> two = source.subscribe(observer(<span class="hljs-string">'subcriber-2'</span>));<font></font>
}, <span class="hljs-number">3000</span>);</code></pre><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> source = interval(<span class="hljs-number">1000</span>).pipe(<font></font>
  shareReplay({ <span class="hljs-attr">refCount</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bufferSize</span>: <span class="hljs-number">1</span> })<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">const</span> one = source.subscribe(observer(<span class="hljs-string">'subcriber-1'</span>));<font></font>
<font></font>
setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
  one.unsubscribe();<font></font>
  <font></font>
  <span class="hljs-comment">// This subscriber will NOT get the last emitted values from the source</span>
  <span class="hljs-keyword">const</span> two = source.subscribe(observer(<span class="hljs-string">'subcriber-2'</span>));<font></font>
}, <span class="hljs-number">3000</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/6i/j1/ih/6ij1ihusgtdo_avliuz4tk4gsca.png"><br>
<br>
<img src="https://habrastorage.org/webt/ew/nk/6q/ewnk6q0ems5ysw574aa7unvy2jc.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemples r√©els en angulaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment utiliser les op√©rateurs de multidiffusion √©tudi√©s dans des conditions de combat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utilisons le partage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons un composant qui a besoin de donn√©es du flux d'origine. </font><font style="vertical-align: inherit;">Cela peut √™tre une requ√™te http, un √©tat ou autre. </font><font style="vertical-align: inherit;">Et nous avons √©galement besoin de manipulation de donn√©es, comme le filtrage, le tri, etc.</font></font><br>
<br>
<pre><code class="javascript hljs">@Component({
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;users-list [users]="allUsers$ | async"&gt;&lt;/users-list&gt;
  `</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersPageComponent</span> </span>{
  <span class="hljs-attr">allUsers$</span>: Observable&lt;User[]&gt;;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(private http: HttpClient) {<font></font>
  }<font></font>
<font></font>
  ngOnInit() {<font></font>
    <span class="hljs-keyword">this</span>.allUsers$ = <span class="hljs-keyword">this</span>.http.get(<span class="hljs-string">'https://api/users'</span>).pipe(<font></font>
      map(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> filter/sort),<font></font>
    );<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous avons besoin d'un autre composant qui ne montre que le premier utilisateur. </font><font style="vertical-align: inherit;">Si nous nous abonnons au flux source tel quel, alors:</font></font><br>
<br>
<pre><code class="javascript hljs">@Component({
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;user [user]="firstUser$ | async"&gt;&lt;/user&gt;
    &lt;users-list [users]="allUsers$ | async"&gt;&lt;/users-list&gt;
  `</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersPageComponent</span> </span>{
  <span class="hljs-attr">allUsers$</span>: Observable&lt;User[]&gt;;<font></font>
  firstUser$: Observable&lt;User&gt;;<font></font>
  <font></font>
  <span class="hljs-keyword">constructor</span>(private http: HttpClient) {<font></font>
  }<font></font>
<font></font>
  ngOnInit() {<font></font>
    <span class="hljs-keyword">this</span>.allUsers$ = <span class="hljs-keyword">this</span>.http.get(<span class="hljs-string">'https://api/users'</span>).pipe(<font></font>
      map(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> filter/sort),<font></font>
    );<font></font>
    <font></font>
    <span class="hljs-keyword">this</span>.firstUser$ = <span class="hljs-keyword">this</span>.allUsers$.pipe(map(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> users[<span class="hljs-number">0</span>]));<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant nous avons deux requ√™tes http, les op√©rations de tri ou de filtrage seront effectu√©es deux fois. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appliquons </font></font><code>share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs">@Component({
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;user [user]="firstUser$ | async"&gt;&lt;/user&gt;
    &lt;users-list [users]="allUsers$ | async"&gt;&lt;/users-list&gt;
  `</span>,<font></font>
})<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersPageComponent</span> </span>{
  <span class="hljs-attr">allUsers$</span>: Observable&lt;User[]&gt;;<font></font>
  firstUser$: Observable&lt;User&gt;;<font></font>
  <font></font>
  <span class="hljs-keyword">constructor</span>(private http: HttpClient) {<font></font>
  }<font></font>
<font></font>
  ngOnInit() {<font></font>
    <span class="hljs-keyword">this</span>.allUsers$ = <span class="hljs-keyword">this</span>.http.get(<span class="hljs-string">'https://api/users'</span>).pipe(<font></font>
      map(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> filter/sort),<font></font>
      share()<font></font>
    );<font></font>
    <font></font>
    <span class="hljs-keyword">this</span>.firstUser$ = <span class="hljs-keyword">this</span>.allUsers$.pipe(map(<span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> users[<span class="hljs-number">0</span>]));<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous savons d√©j√† qu'il en cr√©e un nouveau </font></font><code>Subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui s'abonne √† la source. </font><font style="vertical-align: inherit;">Lorsque la source √©met, le sujet transmet cette valeur √† tous ses abonn√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me est r√©solu, et lorsque nous nous sommes abonn√©s √† </font></font><code>firstUser$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- nous nous sommes abonn√©s au </font></font><code>subject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flux </font><font style="vertical-align: inherit;">interne </font><font style="vertical-align: inherit;">, et non directement au flux d'origine.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de ShareReplay</font></font></h3><br>
<code>ShareReplay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'applique lorsque vous devez √©mettre, mettre en cache et r√©p√©ter les derni√®res valeurs X. </font><font style="vertical-align: inherit;">Un exemple typique est un service singleton qui ex√©cute une requ√™te http.</font></font><br>
<br>
<pre><code class="javascript hljs">
@Injectable({ <span class="hljs-attr">providedIn</span>: <span class="hljs-string">'root'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlogService</span> </span>{<font></font>
  posts$ = <span class="hljs-keyword">this</span>.http.get(<span class="hljs-string">'https://jsonplaceholder.typicode.com/posts'</span>)<font></font>
              .pipe(shareReplay(<span class="hljs-number">1</span>));<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(private http: HttpClient) {}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peu importe le nombre de composants qui demanderont des donn√©es maintenant ou √† l'avenir, il n'y aura qu'une seule demande http et le r√©sultat sera enregistr√© dans le tampon interne </font></font><code>ReplaySubject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il peut toujours y avoir un cas o√π vous devez annuler une demande incompl√®te, car il n'y a pas d'abonn√©s, vous devrez alors postuler </font></font><code>refCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code complet peut √™tre trouv√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490976/index.html">Section frontend sur DUMP2020: nous pr√©viendrons qu'il y aura √† nouveau un full. Top rapports de l'ann√©e derni√®re et sujets de cette</a></li>
<li><a href="../fr490978/index.html">Envoyer des commandes √† plusieurs appareils en m√™me temps √† l'aide de SecureCRT</a></li>
<li><a href="../fr490982/index.html">Mauvais conseils √† l'employeur. Comment interagir "correctement" avec le d√©veloppeur</a></li>
<li><a href="../fr490984/index.html">Mat√©riaux de la mitap Android Nizhny Novgorod. MotionLayout, Kotlin Coroutines, infrastructure CI / CD et syst√®mes de conception</a></li>
<li><a href="../fr490986/index.html">Test des processeurs AMD Ryzen pour fonctionner avec KOMPAS-3D</a></li>
<li><a href="../fr490992/index.html">Gestion des remises de prix: mod√®les de quantification de l'effet des stations-service √† titre d'exemple</a></li>
<li><a href="../fr490996/index.html">STOP RESCUE! Instructions pour l'auto-assemblage du "masque m√©dical"</a></li>
<li><a href="../fr490998/index.html">Test de mat√©riel dans SIBUR</a></li>
<li><a href="../fr491000/index.html">Option de s√©lection de style (presque) sans JavaScript</a></li>
<li><a href="../fr491006/index.html">Intel NUC comme passe dans Unity3D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>