<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ñ üë∂üèø üëèüèΩ Como escrib√≠ mi mensajero üë©üèΩ‚Äçü§ù‚Äçüë©üèº ‚ú°Ô∏è üïû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una tarde, despu√©s de otro d√≠a frustrante, lleno de intentos de equilibrar el juego, decid√≠ que necesitaba un descanso urgente. ¬°Cambiar√© a otro proye...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como escrib√≠ mi mensajero</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una tarde, despu√©s de otro d√≠a frustrante, lleno de intentos de equilibrar el juego, decid√≠ que necesitaba un descanso urgente. </font><font style="vertical-align: inherit;">¬°Cambiar√© a otro proyecto, lo har√© r√°pidamente, devolver√© la autoestima que se ha reducido durante el desarrollo del juego y lo tomar√° por asalto con renovado vigor! </font><font style="vertical-align: inherit;">Lo principal es elegir un proyecto agradable y relajante ... ¬øEscribir su propio mensajero? </font><font style="vertical-align: inherit;">¬°Decir ah! </font><font style="vertical-align: inherit;">¬øQu√© tan dif√≠cil puede ser? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breves antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante casi un a√±o antes de comenzar a trabajar en el messenger, hab√≠a estado trabajando en el juego multijugador en l√≠nea Line Tower Wars. </font><font style="vertical-align: inherit;">La programaci√≥n fue bien, todo lo dem√°s (equilibrio y visual en particular) no fue muy bueno. </font><font style="vertical-align: inherit;">De repente result√≥ que hacer un juego y hacer un juego divertido (divertido para alguien que no sea √©l mismo) son dos cosas diferentes. </font><font style="vertical-align: inherit;">Despu√©s de un a√±o de prueba, necesitaba distraerme, as√≠ que decid√≠ probar algo m√°s. </font><font style="vertical-align: inherit;">La elecci√≥n recay√≥ en el desarrollo m√≥vil, a saber, Flutter. </font><font style="vertical-align: inherit;">Escuch√© muchas cosas buenas sobre Flutter, y me gust√≥ el dardo despu√©s de un breve experimento. </font><font style="vertical-align: inherit;">Decid√≠ escribir mi propio mensajero. </font><font style="vertical-align: inherit;">En primer lugar, es una buena pr√°ctica implementar tanto el cliente como el servidor. </font><font style="vertical-align: inherit;">En segundo lugar, habr√° algo importante para poner en la cartera para buscar trabajo, solo estoy en el proceso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funcionalidad programada</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chats privados y grupales</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o de texto, im√°genes y videos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmaci√≥n de recibo y lectura (ticks de Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impresiones ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notificaciones</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda por c√≥digo QR y geolocalizaci√≥n</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mirando hacia el futuro, puedo decir con orgullo (y con alivio) que casi todo lo planeado se ha implementado, y que a√∫n no se ha implementado, se implementar√° en el futuro cercano.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecci√≥n de idioma</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No pens√© durante mucho tiempo con la elecci√≥n del idioma. </font><font style="vertical-align: inherit;">Al principio, era tentador usar el dardo tanto para el cliente como para el servidor, pero una inspecci√≥n m√°s detallada mostr√≥ que no hay muchos controladores para los dardos disponibles, y aquellos que no inspiran mucha confianza. </font><font style="vertical-align: inherit;">Aunque no responder√© para hablar sobre el momento actual, la situaci√≥n puede haber mejorado. </font><font style="vertical-align: inherit;">Entonces mi elecci√≥n recay√≥ en C #, con el que trabaj√© en Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitectura</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenz√≥ pensando en la arquitectura. </font><font style="vertical-align: inherit;">Por supuesto, considerando que 3 y media personas probablemente usar√°n mi messenger, uno no tendr√≠a que preocuparse por la arquitectura en general. </font><font style="vertical-align: inherit;">Tomas y haces lo mismo en innumerables tutoriales. </font><font style="vertical-align: inherit;">Aqu√≠ est√° el nodo, aqu√≠ est√° el mongo, aqu√≠ est√°n los sockets web. </font><font style="vertical-align: inherit;">Hecho. </font><font style="vertical-align: inherit;">Y Firebase est√° por aqu√≠. </font><font style="vertical-align: inherit;">Pero no es interesante. </font><font style="vertical-align: inherit;">Decid√≠ hacer un mensajero que pueda escalar f√°cilmente horizontalmente, como si esperara millones de clientes simult√°neos. </font><font style="vertical-align: inherit;">Sin embargo, como no ten√≠a experiencia en esta √°rea, tuve que aprender todo en la pr√°ctica por el m√©todo de errores y nuevamente errores.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La arquitectura final se ve as√≠</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No afirmo que dicha arquitectura sea s√∫per genial y confiable, pero es viable y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en teor√≠a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deber√≠a soportar cargas pesadas y escalar horizontalmente, pero realmente no entiendo c√≥mo verificar. </font><font style="vertical-align: inherit;">Y espero que no me haya perdido alg√∫n momento obvio que todos conozcan, excepto yo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n se muestra una descripci√≥n detallada de los componentes individuales.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor frontend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso antes de comenzar a hacer el juego, me fascinaba el concepto de un servidor asincr√≥nico de un solo subproceso. </font><font style="vertical-align: inherit;">Efectivamente y sin potencial race'ov: ¬øqu√© m√°s se puede pedir? </font><font style="vertical-align: inherit;">Para entender c√≥mo se organizan dichos servidores, comenc√© a profundizar en el m√≥dulo de </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lenguaje python. </font><font style="vertical-align: inherit;">La soluci√≥n que vi me pareci√≥ muy elegante. </font><font style="vertical-align: inherit;">En resumen, la soluci√≥n de pseudoc√≥digo se ve as√≠.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando esta t√©cnica simple, podemos servir una gran cantidad de sockets en un solo hilo. </font><font style="vertical-align: inherit;">Nunca bloqueamos una secuencia mientras esperamos que se reciban o env√≠en bytes. </font><font style="vertical-align: inherit;">La transmisi√≥n siempre est√° ocupada con trabajo √∫til. </font><font style="vertical-align: inherit;">Concurrencia, en una palabra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los servidores frontend se implementan de esa manera. </font><font style="vertical-align: inherit;">Todos son de un solo subproceso y as√≠ncronos. </font><font style="vertical-align: inherit;">Por lo tanto, para obtener el m√°ximo rendimiento, debe ejecutar tantos servidores en una m√°quina como n√∫cleos (4 en la imagen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servidor Frontend lee el mensaje del cliente y, seg√∫n el c√≥digo del mensaje, lo env√≠a a uno de los temas en Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una peque√±a nota al pie para aquellos que no est√°n familiarizados con kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 ‚Äî     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servidor frontend env√≠a un mensaje al kafka sin una clave (cuando no hay clave, el kafka simplemente env√≠a mensajes a la parte por turno). El mensaje es extra√≠do del tema por uno de los servidores de fondo correspondientes. El servidor procesa el mensaje y ... ¬øqu√© sigue? Y lo que m√°s depende del tipo de mensaje. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso m√°s com√∫n, se produce un ciclo de solicitud-respuesta. Por ejemplo, para una solicitud de registro, solo necesitamos darle una respuesta al cliente ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc.) Pero para un mensaje que contiene una invitaci√≥n a un chat existente de nuevos miembros (Vasya, Emil y Julia), necesitamos responder de inmediato con tres tipos diferentes de mensajes. El primer tipo: debe notificar al invitador sobre el resultado de la operaci√≥n (de repente se produjo un error del servidor). El segundo tipo: debe notificar a todos los miembros actuales del chat que ahora hay miembros nuevos y nuevos en el chat. El tercero es enviar invitaciones a Vasya, Emil y Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acuerdo, eso no parece muy dif√≠cil, pero para enviar un mensaje a cualquier cliente necesitamos: 1) averiguar a qu√© servidor frontend est√° conectado este cliente (no elegimos a qu√© servidor se conectar√° el cliente, el equilibrador decide por nosotros); 2) enviar un mensaje desde el servidor de fondo al servidor de interfaz deseado; 3) de hecho, env√≠e un mensaje al cliente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar los puntos 1 y 2, decid√≠ usar un tema separado (tema "servidores frontend"). La separaci√≥n de los temas de autenticaci√≥n, sesi√≥n y llamada en particiones sirve como un mecanismo de paralelizaci√≥n. ¬øVemos que el servidor de sesi√≥n est√° muy cargado? Solo agregamos un par de nuevos servidores de partici√≥n y sesi√≥n, y Kafka redistribuir√° la carga por nosotros, descargando los servidores de sesi√≥n existentes. La separaci√≥n del tema "servidores frontend" en la partici√≥n sirve como un mecanismo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enrutamiento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada servidor frontend corresponde a una parte del tema "servidores frontend" (con el mismo √≠ndice que el propio servidor). Es decir, servidor 0 - partici√≥n 0, y as√≠ sucesivamente. Kafka hace posible suscribirse no solo a un tema espec√≠fico, sino tambi√©n a una parte espec√≠fica de un tema determinado. Todos los servidores frontend en las nuevas empresas se suscriben a la partici√≥n correspondiente. Por lo tanto, el servidor de fondo puede enviar un mensaje a un servidor frontend espec√≠fico enviando un mensaje a una partici√≥n espec√≠fica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien, ahora cuando el cliente se une, solo necesita guardar en alg√∫n lugar un par de UserId - Frontend Server Index. En caso de desconexi√≥n - eliminar. Para estos prop√≥sitos, cualquiera de las muchas bases de datos clave-valor en memoria funcionar√°. Eleg√≠ un r√°bano.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥mo se ve en la pr√°ctica. </font><font style="vertical-align: inherit;">En primer lugar, una vez establecida la conexi√≥n, el cliente Andrey env√≠a un mensaje al servidor </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El servidor Frontend recibe el mensaje y lo reenv√≠a al tema de la sesi√≥n, agregando preliminarmente el encabezado "Servidor Frontend": {index}. </font><font style="vertical-align: inherit;">Uno de los servidores de sesi√≥n de fondo recibir√° un mensaje, leer√° el token de autorizaci√≥n, determinar√° qu√© tipo de usuario se ha unido, leer√° el √≠ndice agregado por el servidor frontend y escribir√° UserId - Index en el r√°bano. </font><font style="vertical-align: inherit;">A partir de este momento, el cliente se considera en l√≠nea, y ahora sabemos a trav√©s de qu√© servidor frontend (y, en consecuencia, a trav√©s de qu√© parte del tema "servidores frontend") podemos "comunicarnos" con √©l cuando otros clientes env√≠an mensajes a Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* De hecho, el proceso es un poco m√°s complicado de lo que describ√≠. </font><font style="vertical-align: inherit;">Puedes encontrarlo en el c√≥digo fuente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seudoc√≥digo del servidor frontend</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay algunos trucos aqu√≠. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ser√° un error tomar simplemente la toma que desee y de inmediato comenzar a enviar un mensaje a ella, porque a lo mejor estamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enviando otro mensaje al cliente. Si comenzamos a enviar bytes sin verificar si el socket est√° actualmente ocupado, los mensajes se mezclar√°n. Como en muchos otros lugares donde se requiere el procesamiento ordenado de datos, el truco consiste en utilizar una cola, es decir, una cola de Completers ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la cola no est√° vac√≠a, el socket ya est√° ocupado en este momento. Cree uno nuevo </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, agr√©guelo a la cola y </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anterior</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por lo tanto, cuando se env√≠a el mensaje anterior, se </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completar√° </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que har√° que el servidor comience a enviar el siguiente mensaje. Tal cola tambi√©n permite propagar excepciones sin problemas. Supongamos que se produce un error al enviar un mensaje a un cliente. En este caso, debemos completar, con la excepci√≥n de enviar no solo este mensaje, sino tambi√©n todos los mensajes que actualmente est√°n esperando en la cola (espere </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah). Si no lo hacemos, continuar√°n colg√°ndose y recibiremos una p√©rdida de memoria. Por brevedad, el c√≥digo que hace esto no se muestra aqu√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En realidad, ni siquiera es un truco, sino solo un intento de suavizar las deficiencias de la implementaci√≥n del m√©todo </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- solo una envoltura sobre este m√©todo). Dependiendo del sistema operativo bajo el cap√≥, este m√©todo utiliza </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pero esto no es importante aqu√≠. Lo importante es c√≥mo funciona este m√©todo con las listas que lo alimentamos a la entrada (lista de sockets para lectura, escritura, verificaci√≥n de errores). Este m√©todo toma listas, sondea los sockets y deja solo esos sockets en las listas que est√°n listos para realizar la operaci√≥n requerida. Todos los dem√°s enchufes se eliminan de las listas. La "patada" ocurre a trav√©s de</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(es decir, todos los elementos posteriores se desplazan, lo que es ineficiente). Adem√°s, dado que necesitamos sondear todos los enchufes registrados en cada iteraci√≥n del ciclo, tal "limpieza" es generalmente da√±ina, tenemos que volver a llenar las listas cada vez. Podemos solucionar todos estos problemas utilizando uno personalizado </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuyo </font><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">no elimina el elemento de la lista, sino que simplemente lo marca como eliminado. La clase </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es mi implementaci√≥n de dicha lista. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo funciona con el m√©todo </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y no es adecuado para nada m√°s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En la mayor√≠a de los casos, el servidor frontend, despu√©s de haber enviado el mensaje del cliente al servidor back-end, espera una respuesta (confirmaci√≥n de que la operaci√≥n fue exitosa o un error si algo sali√≥ mal). Si no espera una respuesta dentro de un per√≠odo de tiempo configurable, env√≠a un error al cliente para que no espere una respuesta que nunca llegar√°. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es una cola prioritaria. Inmediatamente despu√©s de que el servidor env√≠a el mensaje a Kafka, hace algo como esto:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la devoluci√≥n de llamada, se cancela la espera de una respuesta y comienza el env√≠o de error del servidor. Si se recibe una respuesta del servidor de fondo, la devoluci√≥n de llamada no hace nada. </font><font style="vertical-align: inherit;">No hay forma de </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
usarlo </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ya que el c√≥digo despu√©s de que </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ejecuta en el subproceso del grupo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠, de hecho, todo sobre los servidores frontend. Se requiere una ligera correcci√≥n aqu√≠. De hecho, el servidor no est√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completamente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un solo hilo. Por supuesto, kafka debajo del cap√≥ usa hilos, pero me refiero al c√≥digo de la aplicaci√≥n. El hecho es que enviar un mensaje al tema de kafka (producir) puede no tener √©xito. En caso de falla, Kafka repite el env√≠o de un cierto n√∫mero de veces configurables, pero, si fallan las salidas repetidas, Kafka abandona este negocio como desesperado. Puede verificar si el mensaje se envi√≥ con √©xito o no en el </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pasamos al m√©todo </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka llama a este controlador en el hilo de E / S del productor (el hilo que env√≠a mensajes). Debemos asegurarnos de que el mensaje se haya enviado correctamente y, si no, cancelar la espera de una respuesta del servidor de fondo (la respuesta no llegar√° porque la solicitud no se envi√≥) y enviar un error al cliente. Es decir, no podemos evitar interactuar con otro hilo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Al escribir un art√≠culo, de repente me di cuenta de que no podemos pasar </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al m√©todo </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o simplemente ignorar todos los errores de kafka (el error a√∫n se enviar√° al cliente por el tiempo de espera que describ√≠ anteriormente), entonces todo nuestro c√≥digo ser√° de un solo subproceso. </font><font style="vertical-align: inherit;">Ahora estoy pensando en c√≥mo hacerlo mejor.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√©, de hecho, kafka, no conejo?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de fondo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparaci√≥n con el servidor frontend, pr√°cticamente no hay puntos interesantes aqu√≠. </font><font style="vertical-align: inherit;">Todos los servidores de fondo funcionan de la misma manera. </font><font style="vertical-align: inherit;">Al inicio, el servidor se suscribe al tema (autenticaci√≥n, sesi√≥n o llamada seg√∫n el rol), y el kafka le asigna una o m√°s particiones. </font><font style="vertical-align: inherit;">El servidor recibe el mensaje de Kafka, procesa y generalmente env√≠a uno o m√°s mensajes en respuesta. </font><font style="vertical-align: inherit;">C√≥digo casi real:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© tipo de compensaciones para comprometer?</font></font></b><div class="spoiler_text">       .   ‚Äî   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deshabilit√© el autocompromiso y el compromiso. Esto es necesario porque </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cuando el procesamiento del mensaje se lleva a cabo realmente, este es un </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo, por lo tanto, no hay garant√≠a de que el mensaje 5 se procesar√° antes del mensaje 6. Kafka almacena solo un desplazamiento comprometido (y no un conjunto de desplazamiento), respectivamente, antes de confirmar el desplazamiento 6, debemos asegurarnos de que todos los mensajes anteriores tambi√©n se hayan procesado. Adem√°s, un servidor de fondo puede consumir mensajes de varias particiones al mismo tiempo y, por lo tanto, debe asegurarse de que confirma el desplazamiento correcto en la partici√≥n correspondiente. Para esto, usamos un mapa hash de la partici√≥n de formulario: unidades de trabajo. As√≠ es como se ve el c√≥digo </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(c√≥digo real esta vez):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, iteramos sobre las unidades, encontramos la √∫ltima unidad completada en este momento, despu√©s de lo cual </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hay</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> unidades </font><i><font style="vertical-align: inherit;">incompletas</font></i><font style="vertical-align: inherit;"> , y confirmamos el desplazamiento correspondiente. </font><font style="vertical-align: inherit;">Tal bucle nos permite evitar cometer "holey". </font><font style="vertical-align: inherit;">Por ejemplo, si actualmente tenemos 4 unidades ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), solo podemos comprometer la unidad 0, ya que si confirmamos la tercera de inmediato, esto puede conducir a la p√©rdida potencial de la primera si el servidor muere en este momento.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como se dijo, el </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo y, en consecuencia, est√° completamente envuelto </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©l llama al servicio necesario, y en </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los servicios son bastante triviales. </font><font style="vertical-align: inherit;">Aqu√≠, por ejemplo, qu√© c√≥digo se ejecuta cuando el usuario env√≠a un nuevo mensaje:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de datos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mayor parte de la funcionalidad de los servicios llamados por los servidores de back-end es simplemente agregar nuevos datos a la base de datos y procesar los existentes. Obviamente, c√≥mo est√° organizada la base de datos y c√≥mo operamos en ella es muy importante para el mensajero, y aqu√≠ me gustar√≠a decir que abord√© el tema de elegir una base de datos con mucho cuidado despu√©s de estudiar cuidadosamente todas las opciones, pero esto no es as√≠. Acabo de elegir CockroachDb porque promete mucho con un m√≠nimo de esfuerzo y tiene una sintaxis compatible con postgres (trabaj√© con postgres antes). Pens√© en usar Cassandra, pero al final decid√≠ pensar en algo familiar. Nunca hab√≠a trabajado con Kafka, o con Rabbit, o con Flutter y Dart, o con WebRtc, as√≠ que decid√≠ no arrastrar a Cassandra tambi√©n, porque ten√≠a miedo de ahogarme en una gran cantidad de nuevas tecnolog√≠as para m√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De todas las partes de mi proyecto, el dise√±o de la base de datos es lo que m√°s dudo. No estoy seguro de que las decisiones que tom√© sean realmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buenas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Todo funciona, pero podr√≠a hacerse mejor. Por ejemplo, hay tablas ShareRooms (como llamo chats) y ShareItems (como llamo mensajes). Por lo tanto, todos los usuarios que ingresan a una sala se registran en el campo jsonb de esta sala. Esto es conveniente, pero obviamente muy lento, por lo que probablemente lo volver√© a hacer usando claves for√°neas. O, por ejemplo, la tabla ShareItems almacena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mensajes. Lo cual tambi√©n es conveniente, pero dado que ShareItems es una de las tablas m√°s cargadas (persistente </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), podr√≠a valer la pena crear una nueva tabla para cada habitaci√≥n o algo as√≠. Kokroach dispersa los registros en diferentes nodos, por lo tanto, debe pensar cuidadosamente qu√© registro se utilizar√° para lograr el m√°ximo rendimiento, pero no lo hice. En general, como se puede entender de todo lo anterior, las bases de datos no son mi punto m√°s fuerte. En este momento, generalmente estoy probando todo para postgres, y no kokroach, porque hay menos carga en mi m√°quina de trabajo, ya es tan pobre por las cargas que despegar√° pronto. Afortunadamente, el c√≥digo para postgres y kokroach difiere bastante, por lo que cambiar no es dif√≠cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora estoy en el proceso de estudiar c√≥mo funciona realmente el cocroach (c√≥mo se produce el mapeo entre SQL y el valor clave (el cocroach usa RocksDb debajo del cap√≥), c√≥mo distribuye datos entre nodos, r√©plicas, etc.). Por supuesto, vali√≥ la pena estudiar el cocroach antes de usarlo, pero m√°s vale tarde que nunca.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que la base sufrir√° grandes cambios cuando llegue a comprender mejor este problema. En este momento, la mesa de Acks me persigue. En esta tabla, almaceno datos sobre qui√©n a√∫n no ha recibido y qui√©n a√∫n no ha le√≠do el mensaje (para mostrar las marcas de verificaci√≥n del usuario). Es f√°cil notificar al usuario que su mensaje ha sido le√≠do si el usuario est√° en l√≠nea ahora, pero si no, necesitamos guardar esta informaci√≥n para notificarlo m√°s tarde. Y como los chats grupales est√°n disponibles, no basta con almacenar la bandera, sino que necesita datos sobre usuarios individuales. Entonces, aqu√≠ pedimos directamente el uso de cadenas de bits (una l√≠nea para usuarios que a√∫n no han recibido, la segunda, para aquellos que a√∫n no han le√≠do). Especialmente soporte de kokroach </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sin embargo, nunca descubr√≠ c√≥mo implementar este negocio, dado que la composici√≥n de las habitaciones puede cambiar constantemente. Para que las cadenas de bits conserven su significado, los usuarios en la sala deben permanecer en el mismo orden, lo cual es bastante dif√≠cil de hacer cuando, por ejemplo, alg√∫n usuario abandona la sala. Hay opciones aqu√≠. Quiz√°s valga la pena escribir -1 en lugar de eliminar al usuario del campo jsonb para que se mantenga el orden, o usar alg√∫n m√©todo de control de versiones, de modo que sepamos que esta cadena de bits se refiere al orden de los usuarios, que era entonces, y no en el orden actual de los usuarios. Todav√≠a estoy en el proceso de pensar en c√≥mo implementar mejor este negocio, pero por el momento, aquellos que a√∫n no han recibido y no han le√≠do a los usuarios tambi√©n son solo campos jsonb. Dado que la tabla Acks se escribe con cada mensaje, la cantidad de datos es grande.Aunque el registro, por supuesto, se elimina cuando el mensaje es recibido y le√≠do por todos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aleteo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante mucho tiempo trabaj√© en el lado del servidor y utilic√© clientes de consola simples para la prueba, por lo que ni siquiera cre√© un proyecto de Flutter. </font><font style="vertical-align: inherit;">Y cuando lo cre√©, pens√© que la parte del servidor era una </font><font style="vertical-align: inherit;">parte </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compleja</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y la aplicaci√≥n es as√≠, basura, lo resolver√© en un par de d√≠as. </font><font style="vertical-align: inherit;">Mientras trabajaba en el servidor, cre√© Hello Worlds para aletear un par de veces para tener una idea del marco, y dado que el mensajero no necesita ninguna interfaz de usuario compleja, pens√© que estaba completamente listo. </font><font style="vertical-align: inherit;">Entonces, la interfaz de usuario, realmente, es basura, pero la implementaci√≥n de la funcionalidad me dio problemas (y a√∫n se entregar√°, ya que no todo est√° listo).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administraci√≥n del Estado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tema m√°s popular. Hay mil maneras de controlar su condici√≥n, y el enfoque recomendado se cambia cada seis meses. Ahora la corriente principal es el proveedor. Personalmente, eleg√≠ 2 formas para m√≠: bloc y redux. Bloc (Business Logic Component) para gestionar el estado local y redux para gestionar el global. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc no es alg√∫n tipo de biblioteca (aunque, por supuesto, tambi√©n hay una biblioteca que reduce la repetitiva, pero no la uso). Bloc es un enfoque basado en la transmisi√≥n. En general, el dardo es un lenguaje bastante agradable, y las transmisiones son generalmente tan dulces. La esencia de este enfoque es que empujamos toda la l√≥gica empresarial a los servicios, y nos comunicamos entre la interfaz de usuario y los servicios a trav√©s de un controlador que nos proporciona varias corrientes. ¬øEl usuario hizo clic en el bot√≥n "buscar contacto"? Utilizando</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(el otro extremo de la transmisi√≥n) enviamos un evento al controlador </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el controlador llamar√° al servicio deseado, esperar√° el resultado y tambi√©n devolver√° la lista de usuarios a la interfaz de usuario a trav√©s de la transmisi√≥n. La interfaz de usuario espera los resultados utilizando </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget que se reconstruye cada vez que llegan datos nuevos a la secuencia a la que est√° suscrito). Eso, de hecho, es todo. En algunos casos, necesitamos actualizar la interfaz de usuario sin la participaci√≥n del usuario (por ejemplo, cuando lleg√≥ un nuevo mensaje), pero esto tambi√©n se puede hacer f√°cilmente a trav√©s de las transmisiones. De hecho, un MVC simple con transmisiones, sin magia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparaci√≥n con otros enfoques, el bloque requiere m√°s repetitivo, pero, en mi opini√≥n, es mejor usar soluciones nativas sin la participaci√≥n de bibliotecas de terceros, a menos que el uso de una soluci√≥n de terceros proporcione algo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significativo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ventajas </font><font style="vertical-align: inherit;">Cuantas m√°s abstracciones en la parte superior, m√°s dif√≠cil es comprender cu√°l es el error cuando se produce un error. </font><font style="vertical-align: inherit;">No considero que las ventajas del proveedor sean lo suficientemente significativas como para cambiar a √©l. </font><font style="vertical-align: inherit;">Pero tengo poca experiencia en esta √°rea, por lo que es probable que cambie el campamento en el futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, sobre redux, y as√≠ todos lo saben todo, as√≠ que no hay nada que decir. </font><font style="vertical-align: inherit;">Adem√°s, lo cort√© de la aplicaci√≥n :) Lo utilic√© para administrar mi cuenta, pero luego, al darme cuenta de que en este caso no hay ventajas especiales sobre el bloque, lo cort√© para no arrastrar demasiado. </font><font style="vertical-align: inherit;">Pero en general considero que redux es algo √∫til para administrar el estado global.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La parte m√°s insoportable</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© debo hacer si el usuario envi√≥ un mensaje, pero antes de que se enviara, se perdi√≥ la conexi√≥n a Internet? ¬øQu√© debo hacer si el usuario recibi√≥ una confirmaci√≥n de lectura, pero cerr√≥ la aplicaci√≥n antes de que se actualizara el registro correspondiente en la base de datos? ¬øQu√© debo hacer si el usuario invit√≥ a su amigo a la sala, pero antes de que se enviara la invitaci√≥n, su bater√≠a se agot√≥? ¬øAlguna vez has hecho preguntas similares? Aqu√≠ estoy. Antes de. Pero en el proceso de desarrollo comenc√© a preguntarme. Como la conexi√≥n puede desaparecer en cualquier momento y el tel√©fono se apaga en cualquier momento, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe </font><b><font style="vertical-align: inherit;">confirmarse</font></b><font style="vertical-align: inherit;"> . No es divertido. Por lo tanto, el primer mensaje que el cliente env√≠a al servidor ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si recuerda) no es solo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hola, estoy en l√≠nea"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hola, estoy en l√≠nea y aqu√≠ hay habitaciones sin confirmar, aqu√≠ hay confirmaciones no confirmadas, aqu√≠ hay operaciones de membres√≠a de sala sin confirmar y aqu√≠ est√°n los √∫ltimos mensajes recibidos por habitaci√≥n"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y el servidor responde con una hoja similar: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúMientras estabas desconectado, tal y tal tus mensajes fueron le√≠dos por tales y tales usuarios, y tambi√©n invitaron a Petya a esta sala, y Sveta sali√≥ de esta sala, y t√∫ fuiste invitado a esta sala, pero a estas dos habitaciones tienen 40 nuevos puestos "</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Realmente me gustar√≠a saber c√≥mo se hacen cosas similares en otros mensajeros, porque mi implementaci√≥n no brilla con gracia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im√°genes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por el momento, puede enviar texto, texto + im√°genes y solo im√°genes. </font><font style="vertical-align: inherit;">La carga de video a√∫n no se ha implementado. </font><font style="vertical-align: inherit;">Las im√°genes se comprimen un poco y se guardan en el almacenamiento de Firebase. </font><font style="vertical-align: inherit;">El mensaje en s√≠ contiene enlaces. </font><font style="vertical-align: inherit;">Al recibir el mensaje, el cliente descarga im√°genes, genera miniaturas y guarda todo en el sistema de archivos. </font><font style="vertical-align: inherit;">Las rutas de archivo se escriben en la base de datos. </font><font style="vertical-align: inherit;">Por cierto, la generaci√≥n de miniaturas es el √∫nico c√≥digo ejecutado en un subproceso separado, ya que es una operaci√≥n de procesamiento pesado. </font><font style="vertical-align: inherit;">Acabo de comenzar una secuencia de trabajo, le doy una imagen y, a cambio, obtengo una miniatura. </font><font style="vertical-align: inherit;">El c√≥digo es extremadamente simple, ya que dart proporciona abstracciones convenientes para trabajar con flujos.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La autenticaci√≥n de Firebase tambi√©n se usa, pero solo para la autorizaci√≥n de acceso al almacenamiento de Firebase (para que el usuario no pueda, por ejemplo, completar la foto de perfil de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otra persona</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Toda otra autorizaci√≥n se realiza a trav√©s de mis servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formato de mensaje</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente est√©s horrorizado aqu√≠, ya que uso conjuntos de bytes regulares. Json desaparece porque se requiere eficiencia, y no sab√≠a sobre protobuf cuando comenc√©. El uso de matrices requiere mucho cuidado porque un √≠ndice est√° mal y las cosas salen mal. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros 4 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son la longitud del mensaje. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente byte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el c√≥digo del mensaje. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los siguientes 16 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son el identificador de solicitud (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los siguientes 40 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son el token de autorizaci√≥n. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resto del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Longitud del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requerido, ya que no utilizo sockets http o web, o alg√∫n otro protocolo que proporcione la separaci√≥n de un mensaje de otro. Mis servidores frontend solo ven flujos de bytes, y necesitan saber d√≥nde termina un mensaje y comienza otro. Hay varias formas de separar los mensajes (por ejemplo, para usar alg√∫n tipo de car√°cter que nunca se encuentra en los mensajes como separador), pero prefer√≠ especificar la longitud, ya que este m√©todo es el m√°s f√°cil, aunque implica una sobrecarga, ya que faltan la mayor√≠a de los mensajes y un byte para indicar la longitud. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es solo uno de los miembros de la enumeraci√≥n</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El enrutamiento se lleva a cabo de acuerdo con el c√≥digo, y dado que podemos extraer el c√≥digo de la matriz sin deserializaci√≥n preliminar, el servidor frontend decide en qu√© tema del kafka enviar un mensaje en lugar de delegar esta responsabilidad a otra persona. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID de solicitud</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presente en la mayor√≠a de las publicaciones, pero no en todas. Realiza 2 funciones: mediante este identificador, el cliente establece la correspondencia entre la solicitud enviada y la respuesta recibida (si el cliente envi√≥ los mensajes A, B, C en este orden, esto no significa que las respuestas tambi√©n estar√°n en orden). La segunda funci√≥n es evitar duplicados. Como se mencion√≥ anteriormente, kafka garantiza al menos una vez la entrega. Es decir, en casos raros, los mensajes a√∫n pueden duplicarse. Al agregar la columna RequestIdentifier con una restricci√≥n √∫nica a la tabla de base de datos deseada, podemos evitar insertar un duplicado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token de autorizaci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es un UserId (8 bytes) + 32 bytes de firma HmacSha256. </font><font style="vertical-align: inherit;">No creo que valga la pena usar Jwt aqu√≠. </font><font style="vertical-align: inherit;">¬øJwt es aproximadamente 7-8 veces m√°s grande para qu√©? </font><font style="vertical-align: inherit;">Mis usuarios no tienen ning√∫n reclamo, por lo que una simple firma hmac est√° bien. </font><font style="vertical-align: inherit;">La autorizaci√≥n a trav√©s de otros servicios no es ni est√° planificada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es curioso que pospuse deliberadamente la implementaci√≥n de las llamadas de audio y video, porque estaba seguro de que no podr√≠a resolver los problemas, pero en realidad result√≥ ser una de las caracter√≠sticas m√°s f√°ciles de implementar. </font><font style="vertical-align: inherit;">Al menos la funcionalidad b√°sica. </font><font style="vertical-align: inherit;">En general, solo agregar WebRtc a la aplicaci√≥n y obtener la primera sesi√≥n de video tom√≥ solo unas pocas horas y, milagrosamente, la primera prueba fue exitosa. </font><font style="vertical-align: inherit;">Antes de eso, pens√© que el c√≥digo que funcion√≥ la primera vez era un mito. </font><font style="vertical-align: inherit;">Por lo general, la primera prueba de una nueva caracter√≠stica siempre falla debido a alg√∫n tipo de error est√∫pido como "se agreg√≥ un servicio, pero no se registr√≥ en un contenedor DI".</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No es muy breve sobre WebRtc para los no iniciados</font></font></b><div class="spoiler_text">WebRtc ‚Äî  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    ‚Äî stun .   stun  ,    ‚Äî  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP ‚Äî Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP ‚Äî Router Port.   ‚Äî <i></i>   .     ,  ¬´¬ª    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  ‚Äî turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  ‚Äî coturn,      .<br>
<br>
  ‚Äî .    <i> </i>  ,    .       ,    .   ‚Äî           .       .    ,          , ,     :)       ‚Äî   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tecnolog√≠a WebRtc en s√≠ misma establece una conexi√≥n y maneja las secuencias de un lado a otro, pero este no es un marco para crear llamadas completas. Por llamada, me refiero a una sesi√≥n de comunicaci√≥n con la capacidad de cancelar, rechazar y aceptar la llamada, as√≠ como colgar. Adem√°s, debe informar a la persona que llama si el otro lado ya est√° ocupado. Y tambi√©n para implementar peque√±as cosas como "esperar una respuesta a la llamada N segundos, luego reiniciar". Si simplemente implementa WebRtc en la aplicaci√≥n de forma simple, con una llamada entrante, la c√°mara y el video se encender√°n espont√°neamente, lo que, por supuesto, es inaceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En su forma pura, WebRtc generalmente implica enviar candidatos a la otra parte lo antes posible para que las negociaciones comiencen lo m√°s r√°pido posible, lo cual es l√≥gico. En mis pruebas, los candidatos al partido receptor generalmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siempre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comenz√≥ a llegar incluso antes de que llegue la oferta. Dichos candidatos "tempranos" no pueden descartarse, deben recordarse, de modo que m√°s tarde, cuando llegue la oferta y </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se cree, agr√©guelos a la conexi√≥n. El hecho de que los candidatos puedan comenzar a llegar incluso antes de la oferta, as√≠ como algunas otras razones, hacen que la implementaci√≥n de llamadas completas sea una tarea no trivial. ¬øQu√© hacer si varios usuarios nos llaman a la vez? Recibiremos candidatos de todos, y aunque podemos separar a los candidatos de un usuario de otro, no queda claro qu√© candidatos rechazar, porque no sabemos qu√© oferta vendr√° antes. Tambi√©n habr√° problemas si los candidatos comienzan a venir a nosotros y luego una oferta en el momento en que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosotros mismos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> llamamos a alguien.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de probar varias opciones con un WebRtc simple, llegu√© a la conclusi√≥n de que de esta forma ser√≠a problem√°tico y lleno de p√©rdidas de memoria tratar de hacer llamadas, as√≠ que decid√≠ agregar otra etapa al proceso de negociaci√≥n de WebRtc. Yo llamo a esta etapa </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea es muy simple, pero me llev√≥ bastante tiempo alcanzarla. La persona que llama, incluso antes de crear la transmisi√≥n y </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(y generalmente antes de ejecutar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cualquier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo relacionado con WebRtc) env√≠a un mensaje a trav√©s del servidor de se√±ales al otro lado </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En el lado receptor, se verifica si el usuario est√° en alguna otra sesi√≥n de comunicaci√≥n en este momento ( </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campo </font><font style="vertical-align: inherit;">simple </font><font style="vertical-align: inherit;">). Si es as√≠, se devuelve un mensaje.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y de esta manera le informamos a la persona que llama que el usuario est√° ocupado y al receptor, que tal o cual tel√©fono llam√≥ mientras estaba ocupado con otra conversaci√≥n. Si el usuario est√° actualmente libre, entonces est√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reservado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificador de sesi√≥n se env√≠a </font><font style="vertical-align: inherit;">en el mensaje </font><font style="vertical-align: inherit;">, y este identificador se establece como el identificador de la </font><font style="vertical-align: inherit;">sesi√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si el usuario est√° reservado, rechazar√° todos los </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensajes con identificadores de sesi√≥n distintos del actual. Despu√©s de la reserva, el receptor env√≠a un mensaje a trav√©s del servidor de se√±al a la persona que llama </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Vale la pena decir que este proceso no es visible para el usuario receptor, ya que todav√≠a no hay una llamada. Y lo principal aqu√≠ es no olvidar colgar un tiempo de espera en el lado receptor. De repente, reservaremos una sesi√≥n y no se ofrecer√° ninguna oferta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La persona que llama recibe </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y aqu√≠ es donde WebRtc comienza con ofertas, candidatos, y esto es para todos. </font><font style="vertical-align: inherit;">La oferta vuela hacia el receptor y √©l, al recibirla, muestra una pantalla con los botones Responder / Rechazar. </font><font style="vertical-align: inherit;">Pero los candidatos, como siempre, no esperan a nadie. </font><font style="vertical-align: inherit;">De nuevo comienzan a llegar incluso antes de la oferta, porque no hay raz√≥n para esperar a que el usuario responda la llamada. </font><font style="vertical-align: inherit;">Es posible que no responda, pero rechace o espere hasta que expire el tiempo de espera, entonces los candidatos simplemente ser√°n expulsados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado actual y planes futuros</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chats privados y grupales</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o de texto, im√°genes</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y videos.</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmaci√≥n de recibo y lectura</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impresiones ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notificaciones</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda por c√≥digo QR y geolocalizaci√≥n</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La b√∫squeda por c√≥digo QR es, inesperadamente, bastante problem√°tica de implementar, porque casi todos los complementos para el escaneo de c√≥digo que intent√© se niegan a comenzar o no funcionan correctamente. </font><font style="vertical-align: inherit;">Pero creo que los problemas se resolver√°n aqu√≠. </font><font style="vertical-align: inherit;">Y para la implementaci√≥n de la b√∫squeda de geolocalizaci√≥n, a√∫n no he retomado. </font><font style="vertical-align: inherit;">En teor√≠a, no deber√≠a haber ning√∫n problema especial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notificaciones en progreso, as√≠ como el env√≠o de videos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© m√°s hay que hacer?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh mucho </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no hay pruebas. Los colegas sol√≠an escribir ex√°menes, as√≠ que me relaj√© por completo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> invitar a los usuarios a un chat existente y abandonar el chat actualmente no es posible. El c√≥digo del servidor est√° listo para esto, el c√≥digo del cliente no. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tercer lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si el manejo de errores en el servidor es m√°s o menos, entonces no hay manejo de errores en el cliente. No basta con hacer una entrada de registro; debe volver a intentar la operaci√≥n. Ahora, por ejemplo, el mecanismo para reenviar mensajes no est√° implementado. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarto, el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor no hace ping al cliente, por lo que no se detecta la desconexi√≥n si, por ejemplo, el cliente ha perdido Internet. La desconexi√≥n se detecta solo cuando el cliente cierra la aplicaci√≥n. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quinto, los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √≠ndices no se usan en la base de datos.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sexto,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimizaci√≥n. El c√≥digo tiene una gran cantidad de lugares donde se escribe algo as√≠ </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La mayor√≠a de las matrices son solo </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eso. El servidor de fondo crea muchas matrices de longitud fija, por lo que aqu√≠ puede y debe usar el grupo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©ptimo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hay muchos lugares en el cliente donde </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">termina </font><font style="vertical-align: inherit;">el c√≥digo </font><font style="vertical-align: inherit;">, aunque esto no es necesario. El env√≠o de im√°genes, por ejemplo, parece lento porque el c√≥digo</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guarda im√°genes en el sistema de archivos y genera miniaturas antes de mostrar el mensaje, aunque no es necesario hacer nada de esto. O, por ejemplo, si abre la aplicaci√≥n y, durante su ausencia, le enviaron im√°genes, el inicio ser√° lento, porque nuevamente todas estas im√°genes se descargan, se guardan en el sistema, se generan miniaturas, y solo despu√©s de eso finaliza el inicio y se le arroja desde la pantalla de inicio en la pantalla de inicio Todos estos redundantes </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se hicieron para una depuraci√≥n m√°s f√°cil, pero, por supuesto, debe deshacerse de las esperas innecesarias antes del lanzamiento. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octavo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interfaz de usuario ahora est√° medio lista, porque no he decidido c√≥mo quiero verla. Por lo tanto, ahora no todo es intuitivo, la mitad de los botones no tienen claro qu√© est√°n haciendo. Y los botones a menudo no se presionan la primera vez, porque ahora son solo iconos con </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y sin relleno, por lo que no siempre es posible acceder a ellos. Adem√°s, en algunos lugares, el desbordamiento de p√≠xeles no es fijo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noveno,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ahora es incluso imposible iniciar sesi√≥n en una cuenta, solo registrarse. Por lo tanto, si desinstala la aplicaci√≥n y la reinstala, no podr√° iniciar sesi√≥n en su cuenta :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cimo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el c√≥digo de verificaci√≥n no se env√≠a al correo. Ahora el c√≥digo generalmente es siempre el mismo, nuevamente porque es m√°s f√°cil de depurar. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und√©cimo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El principio de responsabilidad √∫nica se viola en muchos lugares. Necesito un refactor. Las clases responsables de interactuar con la base de datos (tanto en el cliente como en el servidor) generalmente est√°n muy hinchadas porque participan en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas las</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operaciones de la base de datos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duod√©cimo, el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor frontend ahora siempre espera una respuesta del servidor back-end, incluso si el mensaje no implica enviar una respuesta (por ejemplo, un mensaje con un c√≥digo </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y algunos mensajes relacionados con WebRtc). Por lo tanto, sin esperar una respuesta, escribe un error en la consola, aunque esto no es un error. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decimotercero,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> las im√°genes completas no se abren al tocar. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de quintos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunos mensajes que deben enviarse en lotes se env√≠an por separado. Lo mismo se aplica a algunas operaciones de la base de datos. En lugar de ejecutar un solo comando, los comandos se ejecutan en un bucle con </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de sextos,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algunos valores est√°n codificados, en lugar de ser configurables. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento un mill√≥n de s√©ptimos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iniciar sesi√≥n en el servidor ahora es solo a la consola, y en el cliente en general, directamente al widget. En la pantalla principal hay una pesta√±a de Registros, donde se sueltan todos los registros al tocar. El hecho es que mi m√°quina de trabajo se niega a ejecutar tanto el emulador como todo lo necesario para el servidor (kafka, base de datos, r√°bano y todos los servidores). El d√©bito con un dispositivo conectado tampoco funcion√≥, todo simplemente se colg√≥ en la mitad de los casos, porque la computadora no pod√≠a hacer frente a las cargas. Por lo tanto, debe realizar una compilaci√≥n cada vez, soltarla en el dispositivo, instalarla y probarla de esta manera. Para ver los registros, los dejo caer directamente en el widget. Perversi√≥n, lo s√©, pero no hay otra opci√≥n. Por la misma raz√≥n, muchos m√©todos regresan </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Son (para atrapar la excepci√≥n y tirar al widget), aunque no deber√≠an. Si observa el c√≥digo, ver√° un </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">feo </font><font style="vertical-align: inherit;">en muchas clases que hace esto. Esto, por supuesto, tambi√©n ir√° a la basura. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento millones y ocho,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no hay sonidos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento millones y noveno,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe usar el almacenamiento en cach√© m√°s. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de d√©cimas,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mucho c√≥digo repetitivo. Por ejemplo, muchas acciones primero comprueban la validez del token y, si no es v√°lido, env√≠an un error. Creo que necesita implementar una tuber√≠a de middleware simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y muchas peque√±as cosas, como concatenar cadenas en lugar de usar </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no en todas partes se llama donde deber√≠a, y as√≠ sucesivamente. </font><font style="vertical-align: inherit;">En general, el estado normal del proyecto est√° en desarrollo. </font><font style="vertical-align: inherit;">Todo lo anterior es solucionable, pero hay un problema fundamental en el que no pens√© hasta el √∫ltimo momento, porque se me pas√≥ por la cabeza: el mensajero deber√≠a funcionar incluso cuando la aplicaci√≥n no est√° abierta, y la m√≠a no funciona. </font><font style="vertical-align: inherit;">Para ser honesto, la soluci√≥n a este problema a√∫n no se me ha pasado por la cabeza. </font><font style="vertical-align: inherit;">Aqu√≠, aparentemente, no puede prescindir del c√≥digo nativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calificar√≠a la preparaci√≥n del proyecto en un 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Han pasado seis meses desde el inicio del trabajo en el proyecto. </font><font style="vertical-align: inherit;">Combinado con el trabajo a tiempo parcial y tom√≥ largos descansos, pero de todos modos, el tiempo y el esfuerzo fueron decentemente. </font><font style="vertical-align: inherit;">Planeo implementar todas las caracter√≠sticas declaradas + agregar algo inusual como tic-tac-toe o borradores en la habitaci√≥n. </font><font style="vertical-align: inherit;">Sin ninguna raz√≥n, solo porque es interesante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tiene alguna pregunta, escriba. </font><font style="vertical-align: inherit;">El correo est√° en github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490054/index.html">17 sorpresas para mi primer a√±o usando el Tesla Model 3</a></li>
<li><a href="../es490056/index.html">Black Box: olv√≠date de iniciar sesi√≥n</a></li>
<li><a href="../es490060/index.html">Gr√°fico de conocimiento de b√∫squeda: construcci√≥n desde m√∫ltiples fuentes</a></li>
<li><a href="../es490066/index.html">De China al Polo Sur: uniendo fuerzas para resolver el rompecabezas de masas de neutrinos</a></li>
<li><a href="../es490068/index.html">Falsificaci√≥n de aleatoriedad y transformaci√≥n clasificando secuencias pseudoaleatorias</a></li>
<li><a href="../es490076/index.html">Clasificaci√≥n deportiva de las disciplinas de deportes electr√≥nicos.</a></li>
<li><a href="../es490080/index.html">C√≥mo los competidores pueden bloquear f√°cilmente su sitio</a></li>
<li><a href="../es490082/index.html">An√°lisis del C√≥digo Gen√©tico I</a></li>
<li><a href="../es490084/index.html">Comprensi√≥n de la especificaci√≥n ECMAScript, Parte 1</a></li>
<li><a href="../es490086/index.html">Gu√≠a de surf para principiantes o vida de programador en Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>