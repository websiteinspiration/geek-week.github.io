<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥖 👶🏿 👏🏽 Como escribí mi mensajero 👩🏽‍🤝‍👩🏼 ✡️ 🕞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una tarde, después de otro día frustrante, lleno de intentos de equilibrar el juego, decidí que necesitaba un descanso urgente. ¡Cambiaré a otro proye...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como escribí mi mensajero</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una tarde, después de otro día frustrante, lleno de intentos de equilibrar el juego, decidí que necesitaba un descanso urgente. </font><font style="vertical-align: inherit;">¡Cambiaré a otro proyecto, lo haré rápidamente, devolveré la autoestima que se ha reducido durante el desarrollo del juego y lo tomará por asalto con renovado vigor! </font><font style="vertical-align: inherit;">Lo principal es elegir un proyecto agradable y relajante ... ¿Escribir su propio mensajero? </font><font style="vertical-align: inherit;">¡Decir ah! </font><font style="vertical-align: inherit;">¿Qué tan difícil puede ser? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breves antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante casi un año antes de comenzar a trabajar en el messenger, había estado trabajando en el juego multijugador en línea Line Tower Wars. </font><font style="vertical-align: inherit;">La programación fue bien, todo lo demás (equilibrio y visual en particular) no fue muy bueno. </font><font style="vertical-align: inherit;">De repente resultó que hacer un juego y hacer un juego divertido (divertido para alguien que no sea él mismo) son dos cosas diferentes. </font><font style="vertical-align: inherit;">Después de un año de prueba, necesitaba distraerme, así que decidí probar algo más. </font><font style="vertical-align: inherit;">La elección recayó en el desarrollo móvil, a saber, Flutter. </font><font style="vertical-align: inherit;">Escuché muchas cosas buenas sobre Flutter, y me gustó el dardo después de un breve experimento. </font><font style="vertical-align: inherit;">Decidí escribir mi propio mensajero. </font><font style="vertical-align: inherit;">En primer lugar, es una buena práctica implementar tanto el cliente como el servidor. </font><font style="vertical-align: inherit;">En segundo lugar, habrá algo importante para poner en la cartera para buscar trabajo, solo estoy en el proceso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funcionalidad programada</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chats privados y grupales</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envío de texto, imágenes y videos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmación de recibo y lectura (ticks de Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impresiones ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notificaciones</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Búsqueda por código QR y geolocalización</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mirando hacia el futuro, puedo decir con orgullo (y con alivio) que casi todo lo planeado se ha implementado, y que aún no se ha implementado, se implementará en el futuro cercano.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selección de idioma</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No pensé durante mucho tiempo con la elección del idioma. </font><font style="vertical-align: inherit;">Al principio, era tentador usar el dardo tanto para el cliente como para el servidor, pero una inspección más detallada mostró que no hay muchos controladores para los dardos disponibles, y aquellos que no inspiran mucha confianza. </font><font style="vertical-align: inherit;">Aunque no responderé para hablar sobre el momento actual, la situación puede haber mejorado. </font><font style="vertical-align: inherit;">Entonces mi elección recayó en C #, con el que trabajé en Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitectura</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzó pensando en la arquitectura. </font><font style="vertical-align: inherit;">Por supuesto, considerando que 3 y media personas probablemente usarán mi messenger, uno no tendría que preocuparse por la arquitectura en general. </font><font style="vertical-align: inherit;">Tomas y haces lo mismo en innumerables tutoriales. </font><font style="vertical-align: inherit;">Aquí está el nodo, aquí está el mongo, aquí están los sockets web. </font><font style="vertical-align: inherit;">Hecho. </font><font style="vertical-align: inherit;">Y Firebase está por aquí. </font><font style="vertical-align: inherit;">Pero no es interesante. </font><font style="vertical-align: inherit;">Decidí hacer un mensajero que pueda escalar fácilmente horizontalmente, como si esperara millones de clientes simultáneos. </font><font style="vertical-align: inherit;">Sin embargo, como no tenía experiencia en esta área, tuve que aprender todo en la práctica por el método de errores y nuevamente errores.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La arquitectura final se ve así</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No afirmo que dicha arquitectura sea súper genial y confiable, pero es viable y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en teoría</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debería soportar cargas pesadas y escalar horizontalmente, pero realmente no entiendo cómo verificar. </font><font style="vertical-align: inherit;">Y espero que no me haya perdido algún momento obvio que todos conozcan, excepto yo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación se muestra una descripción detallada de los componentes individuales.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor frontend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso antes de comenzar a hacer el juego, me fascinaba el concepto de un servidor asincrónico de un solo subproceso. </font><font style="vertical-align: inherit;">Efectivamente y sin potencial race'ov: ¿qué más se puede pedir? </font><font style="vertical-align: inherit;">Para entender cómo se organizan dichos servidores, comencé a profundizar en el módulo de </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lenguaje python. </font><font style="vertical-align: inherit;">La solución que vi me pareció muy elegante. </font><font style="vertical-align: inherit;">En resumen, la solución de pseudocódigo se ve así.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando esta técnica simple, podemos servir una gran cantidad de sockets en un solo hilo. </font><font style="vertical-align: inherit;">Nunca bloqueamos una secuencia mientras esperamos que se reciban o envíen bytes. </font><font style="vertical-align: inherit;">La transmisión siempre está ocupada con trabajo útil. </font><font style="vertical-align: inherit;">Concurrencia, en una palabra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los servidores frontend se implementan de esa manera. </font><font style="vertical-align: inherit;">Todos son de un solo subproceso y asíncronos. </font><font style="vertical-align: inherit;">Por lo tanto, para obtener el máximo rendimiento, debe ejecutar tantos servidores en una máquina como núcleos (4 en la imagen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servidor Frontend lee el mensaje del cliente y, según el código del mensaje, lo envía a uno de los temas en Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una pequeña nota al pie para aquellos que no están familiarizados con kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 —     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servidor frontend envía un mensaje al kafka sin una clave (cuando no hay clave, el kafka simplemente envía mensajes a la parte por turno). El mensaje es extraído del tema por uno de los servidores de fondo correspondientes. El servidor procesa el mensaje y ... ¿qué sigue? Y lo que más depende del tipo de mensaje. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso más común, se produce un ciclo de solicitud-respuesta. Por ejemplo, para una solicitud de registro, solo necesitamos darle una respuesta al cliente ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc.) Pero para un mensaje que contiene una invitación a un chat existente de nuevos miembros (Vasya, Emil y Julia), necesitamos responder de inmediato con tres tipos diferentes de mensajes. El primer tipo: debe notificar al invitador sobre el resultado de la operación (de repente se produjo un error del servidor). El segundo tipo: debe notificar a todos los miembros actuales del chat que ahora hay miembros nuevos y nuevos en el chat. El tercero es enviar invitaciones a Vasya, Emil y Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acuerdo, eso no parece muy difícil, pero para enviar un mensaje a cualquier cliente necesitamos: 1) averiguar a qué servidor frontend está conectado este cliente (no elegimos a qué servidor se conectará el cliente, el equilibrador decide por nosotros); 2) enviar un mensaje desde el servidor de fondo al servidor de interfaz deseado; 3) de hecho, envíe un mensaje al cliente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar los puntos 1 y 2, decidí usar un tema separado (tema "servidores frontend"). La separación de los temas de autenticación, sesión y llamada en particiones sirve como un mecanismo de paralelización. ¿Vemos que el servidor de sesión está muy cargado? Solo agregamos un par de nuevos servidores de partición y sesión, y Kafka redistribuirá la carga por nosotros, descargando los servidores de sesión existentes. La separación del tema "servidores frontend" en la partición sirve como un mecanismo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enrutamiento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada servidor frontend corresponde a una parte del tema "servidores frontend" (con el mismo índice que el propio servidor). Es decir, servidor 0 - partición 0, y así sucesivamente. Kafka hace posible suscribirse no solo a un tema específico, sino también a una parte específica de un tema determinado. Todos los servidores frontend en las nuevas empresas se suscriben a la partición correspondiente. Por lo tanto, el servidor de fondo puede enviar un mensaje a un servidor frontend específico enviando un mensaje a una partición específica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien, ahora cuando el cliente se une, solo necesita guardar en algún lugar un par de UserId - Frontend Server Index. En caso de desconexión - eliminar. Para estos propósitos, cualquiera de las muchas bases de datos clave-valor en memoria funcionará. Elegí un rábano.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cómo se ve en la práctica. </font><font style="vertical-align: inherit;">En primer lugar, una vez establecida la conexión, el cliente Andrey envía un mensaje al servidor </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El servidor Frontend recibe el mensaje y lo reenvía al tema de la sesión, agregando preliminarmente el encabezado "Servidor Frontend": {index}. </font><font style="vertical-align: inherit;">Uno de los servidores de sesión de fondo recibirá un mensaje, leerá el token de autorización, determinará qué tipo de usuario se ha unido, leerá el índice agregado por el servidor frontend y escribirá UserId - Index en el rábano. </font><font style="vertical-align: inherit;">A partir de este momento, el cliente se considera en línea, y ahora sabemos a través de qué servidor frontend (y, en consecuencia, a través de qué parte del tema "servidores frontend") podemos "comunicarnos" con él cuando otros clientes envían mensajes a Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* De hecho, el proceso es un poco más complicado de lo que describí. </font><font style="vertical-align: inherit;">Puedes encontrarlo en el código fuente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seudocódigo del servidor frontend</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay algunos trucos aquí. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Será un error tomar simplemente la toma que desee y de inmediato comenzar a enviar un mensaje a ella, porque a lo mejor estamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enviando otro mensaje al cliente. Si comenzamos a enviar bytes sin verificar si el socket está actualmente ocupado, los mensajes se mezclarán. Como en muchos otros lugares donde se requiere el procesamiento ordenado de datos, el truco consiste en utilizar una cola, es decir, una cola de Completers ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la cola no está vacía, el socket ya está ocupado en este momento. Cree uno nuevo </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, agréguelo a la cola y </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anterior</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por lo tanto, cuando se envía el mensaje anterior, se </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completará </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que hará que el servidor comience a enviar el siguiente mensaje. Tal cola también permite propagar excepciones sin problemas. Supongamos que se produce un error al enviar un mensaje a un cliente. En este caso, debemos completar, con la excepción de enviar no solo este mensaje, sino también todos los mensajes que actualmente están esperando en la cola (espere </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah). Si no lo hacemos, continuarán colgándose y recibiremos una pérdida de memoria. Por brevedad, el código que hace esto no se muestra aquí. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En realidad, ni siquiera es un truco, sino solo un intento de suavizar las deficiencias de la implementación del método </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- solo una envoltura sobre este método). Dependiendo del sistema operativo bajo el capó, este método utiliza </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pero esto no es importante aquí. Lo importante es cómo funciona este método con las listas que lo alimentamos a la entrada (lista de sockets para lectura, escritura, verificación de errores). Este método toma listas, sondea los sockets y deja solo esos sockets en las listas que están listos para realizar la operación requerida. Todos los demás enchufes se eliminan de las listas. La "patada" ocurre a través de</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(es decir, todos los elementos posteriores se desplazan, lo que es ineficiente). Además, dado que necesitamos sondear todos los enchufes registrados en cada iteración del ciclo, tal "limpieza" es generalmente dañina, tenemos que volver a llenar las listas cada vez. Podemos solucionar todos estos problemas utilizando uno personalizado </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuyo </font><font style="vertical-align: inherit;">método </font><font style="vertical-align: inherit;">no elimina el elemento de la lista, sino que simplemente lo marca como eliminado. La clase </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es mi implementación de dicha lista. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo funciona con el método </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y no es adecuado para nada más. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En la mayoría de los casos, el servidor frontend, después de haber enviado el mensaje del cliente al servidor back-end, espera una respuesta (confirmación de que la operación fue exitosa o un error si algo salió mal). Si no espera una respuesta dentro de un período de tiempo configurable, envía un error al cliente para que no espere una respuesta que nunca llegará. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es una cola prioritaria. Inmediatamente después de que el servidor envía el mensaje a Kafka, hace algo como esto:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la devolución de llamada, se cancela la espera de una respuesta y comienza el envío de error del servidor. Si se recibe una respuesta del servidor de fondo, la devolución de llamada no hace nada. </font><font style="vertical-align: inherit;">No hay forma de </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
usarlo </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ya que el código después de que </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ejecuta en el subproceso del grupo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí, de hecho, todo sobre los servidores frontend. Se requiere una ligera corrección aquí. De hecho, el servidor no está </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completamente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un solo hilo. Por supuesto, kafka debajo del capó usa hilos, pero me refiero al código de la aplicación. El hecho es que enviar un mensaje al tema de kafka (producir) puede no tener éxito. En caso de falla, Kafka repite el envío de un cierto número de veces configurables, pero, si fallan las salidas repetidas, Kafka abandona este negocio como desesperado. Puede verificar si el mensaje se envió con éxito o no en el </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pasamos al método </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka llama a este controlador en el hilo de E / S del productor (el hilo que envía mensajes). Debemos asegurarnos de que el mensaje se haya enviado correctamente y, si no, cancelar la espera de una respuesta del servidor de fondo (la respuesta no llegará porque la solicitud no se envió) y enviar un error al cliente. Es decir, no podemos evitar interactuar con otro hilo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Al escribir un artículo, de repente me di cuenta de que no podemos pasar </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al método </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o simplemente ignorar todos los errores de kafka (el error aún se enviará al cliente por el tiempo de espera que describí anteriormente), entonces todo nuestro código será de un solo subproceso. </font><font style="vertical-align: inherit;">Ahora estoy pensando en cómo hacerlo mejor.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué, de hecho, kafka, no conejo?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor de fondo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparación con el servidor frontend, prácticamente no hay puntos interesantes aquí. </font><font style="vertical-align: inherit;">Todos los servidores de fondo funcionan de la misma manera. </font><font style="vertical-align: inherit;">Al inicio, el servidor se suscribe al tema (autenticación, sesión o llamada según el rol), y el kafka le asigna una o más particiones. </font><font style="vertical-align: inherit;">El servidor recibe el mensaje de Kafka, procesa y generalmente envía uno o más mensajes en respuesta. </font><font style="vertical-align: inherit;">Código casi real:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué tipo de compensaciones para comprometer?</font></font></b><div class="spoiler_text">       .   —   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deshabilité el autocompromiso y el compromiso. Esto es necesario porque </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cuando el procesamiento del mensaje se lleva a cabo realmente, este es un </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">método, por lo tanto, no hay garantía de que el mensaje 5 se procesará antes del mensaje 6. Kafka almacena solo un desplazamiento comprometido (y no un conjunto de desplazamiento), respectivamente, antes de confirmar el desplazamiento 6, debemos asegurarnos de que todos los mensajes anteriores también se hayan procesado. Además, un servidor de fondo puede consumir mensajes de varias particiones al mismo tiempo y, por lo tanto, debe asegurarse de que confirma el desplazamiento correcto en la partición correspondiente. Para esto, usamos un mapa hash de la partición de formulario: unidades de trabajo. Así es como se ve el código </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(código real esta vez):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, iteramos sobre las unidades, encontramos la última unidad completada en este momento, después de lo cual </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hay</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> unidades </font><i><font style="vertical-align: inherit;">incompletas</font></i><font style="vertical-align: inherit;"> , y confirmamos el desplazamiento correspondiente. </font><font style="vertical-align: inherit;">Tal bucle nos permite evitar cometer "holey". </font><font style="vertical-align: inherit;">Por ejemplo, si actualmente tenemos 4 unidades ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), solo podemos comprometer la unidad 0, ya que si confirmamos la tercera de inmediato, esto puede conducir a la pérdida potencial de la primera si el servidor muere en este momento.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como se dijo, el </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">método y, en consecuencia, está completamente envuelto </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">él llama al servicio necesario, y en </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los servicios son bastante triviales. </font><font style="vertical-align: inherit;">Aquí, por ejemplo, qué código se ejecuta cuando el usuario envía un nuevo mensaje:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de datos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mayor parte de la funcionalidad de los servicios llamados por los servidores de back-end es simplemente agregar nuevos datos a la base de datos y procesar los existentes. Obviamente, cómo está organizada la base de datos y cómo operamos en ella es muy importante para el mensajero, y aquí me gustaría decir que abordé el tema de elegir una base de datos con mucho cuidado después de estudiar cuidadosamente todas las opciones, pero esto no es así. Acabo de elegir CockroachDb porque promete mucho con un mínimo de esfuerzo y tiene una sintaxis compatible con postgres (trabajé con postgres antes). Pensé en usar Cassandra, pero al final decidí pensar en algo familiar. Nunca había trabajado con Kafka, o con Rabbit, o con Flutter y Dart, o con WebRtc, así que decidí no arrastrar a Cassandra también, porque tenía miedo de ahogarme en una gran cantidad de nuevas tecnologías para mí.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De todas las partes de mi proyecto, el diseño de la base de datos es lo que más dudo. No estoy seguro de que las decisiones que tomé sean realmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buenas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Todo funciona, pero podría hacerse mejor. Por ejemplo, hay tablas ShareRooms (como llamo chats) y ShareItems (como llamo mensajes). Por lo tanto, todos los usuarios que ingresan a una sala se registran en el campo jsonb de esta sala. Esto es conveniente, pero obviamente muy lento, por lo que probablemente lo volveré a hacer usando claves foráneas. O, por ejemplo, la tabla ShareItems almacena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mensajes. Lo cual también es conveniente, pero dado que ShareItems es una de las tablas más cargadas (persistente </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), podría valer la pena crear una nueva tabla para cada habitación o algo así. Kokroach dispersa los registros en diferentes nodos, por lo tanto, debe pensar cuidadosamente qué registro se utilizará para lograr el máximo rendimiento, pero no lo hice. En general, como se puede entender de todo lo anterior, las bases de datos no son mi punto más fuerte. En este momento, generalmente estoy probando todo para postgres, y no kokroach, porque hay menos carga en mi máquina de trabajo, ya es tan pobre por las cargas que despegará pronto. Afortunadamente, el código para postgres y kokroach difiere bastante, por lo que cambiar no es difícil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora estoy en el proceso de estudiar cómo funciona realmente el cocroach (cómo se produce el mapeo entre SQL y el valor clave (el cocroach usa RocksDb debajo del capó), cómo distribuye datos entre nodos, réplicas, etc.). Por supuesto, valió la pena estudiar el cocroach antes de usarlo, pero más vale tarde que nunca.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que la base sufrirá grandes cambios cuando llegue a comprender mejor este problema. En este momento, la mesa de Acks me persigue. En esta tabla, almaceno datos sobre quién aún no ha recibido y quién aún no ha leído el mensaje (para mostrar las marcas de verificación del usuario). Es fácil notificar al usuario que su mensaje ha sido leído si el usuario está en línea ahora, pero si no, necesitamos guardar esta información para notificarlo más tarde. Y como los chats grupales están disponibles, no basta con almacenar la bandera, sino que necesita datos sobre usuarios individuales. Entonces, aquí pedimos directamente el uso de cadenas de bits (una línea para usuarios que aún no han recibido, la segunda, para aquellos que aún no han leído). Especialmente soporte de kokroach </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sin embargo, nunca descubrí cómo implementar este negocio, dado que la composición de las habitaciones puede cambiar constantemente. Para que las cadenas de bits conserven su significado, los usuarios en la sala deben permanecer en el mismo orden, lo cual es bastante difícil de hacer cuando, por ejemplo, algún usuario abandona la sala. Hay opciones aquí. Quizás valga la pena escribir -1 en lugar de eliminar al usuario del campo jsonb para que se mantenga el orden, o usar algún método de control de versiones, de modo que sepamos que esta cadena de bits se refiere al orden de los usuarios, que era entonces, y no en el orden actual de los usuarios. Todavía estoy en el proceso de pensar en cómo implementar mejor este negocio, pero por el momento, aquellos que aún no han recibido y no han leído a los usuarios también son solo campos jsonb. Dado que la tabla Acks se escribe con cada mensaje, la cantidad de datos es grande.Aunque el registro, por supuesto, se elimina cuando el mensaje es recibido y leído por todos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aleteo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante mucho tiempo trabajé en el lado del servidor y utilicé clientes de consola simples para la prueba, por lo que ni siquiera creé un proyecto de Flutter. </font><font style="vertical-align: inherit;">Y cuando lo creé, pensé que la parte del servidor era una </font><font style="vertical-align: inherit;">parte </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compleja</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y la aplicación es así, basura, lo resolveré en un par de días. </font><font style="vertical-align: inherit;">Mientras trabajaba en el servidor, creé Hello Worlds para aletear un par de veces para tener una idea del marco, y dado que el mensajero no necesita ninguna interfaz de usuario compleja, pensé que estaba completamente listo. </font><font style="vertical-align: inherit;">Entonces, la interfaz de usuario, realmente, es basura, pero la implementación de la funcionalidad me dio problemas (y aún se entregará, ya que no todo está listo).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Administración del Estado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El tema más popular. Hay mil maneras de controlar su condición, y el enfoque recomendado se cambia cada seis meses. Ahora la corriente principal es el proveedor. Personalmente, elegí 2 formas para mí: bloc y redux. Bloc (Business Logic Component) para gestionar el estado local y redux para gestionar el global. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc no es algún tipo de biblioteca (aunque, por supuesto, también hay una biblioteca que reduce la repetitiva, pero no la uso). Bloc es un enfoque basado en la transmisión. En general, el dardo es un lenguaje bastante agradable, y las transmisiones son generalmente tan dulces. La esencia de este enfoque es que empujamos toda la lógica empresarial a los servicios, y nos comunicamos entre la interfaz de usuario y los servicios a través de un controlador que nos proporciona varias corrientes. ¿El usuario hizo clic en el botón "buscar contacto"? Utilizando</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(el otro extremo de la transmisión) enviamos un evento al controlador </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el controlador llamará al servicio deseado, esperará el resultado y también devolverá la lista de usuarios a la interfaz de usuario a través de la transmisión. La interfaz de usuario espera los resultados utilizando </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget que se reconstruye cada vez que llegan datos nuevos a la secuencia a la que está suscrito). Eso, de hecho, es todo. En algunos casos, necesitamos actualizar la interfaz de usuario sin la participación del usuario (por ejemplo, cuando llegó un nuevo mensaje), pero esto también se puede hacer fácilmente a través de las transmisiones. De hecho, un MVC simple con transmisiones, sin magia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparación con otros enfoques, el bloque requiere más repetitivo, pero, en mi opinión, es mejor usar soluciones nativas sin la participación de bibliotecas de terceros, a menos que el uso de una solución de terceros proporcione algo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significativo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ventajas </font><font style="vertical-align: inherit;">Cuantas más abstracciones en la parte superior, más difícil es comprender cuál es el error cuando se produce un error. </font><font style="vertical-align: inherit;">No considero que las ventajas del proveedor sean lo suficientemente significativas como para cambiar a él. </font><font style="vertical-align: inherit;">Pero tengo poca experiencia en esta área, por lo que es probable que cambie el campamento en el futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, sobre redux, y así todos lo saben todo, así que no hay nada que decir. </font><font style="vertical-align: inherit;">Además, lo corté de la aplicación :) Lo utilicé para administrar mi cuenta, pero luego, al darme cuenta de que en este caso no hay ventajas especiales sobre el bloque, lo corté para no arrastrar demasiado. </font><font style="vertical-align: inherit;">Pero en general considero que redux es algo útil para administrar el estado global.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La parte más insoportable</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué debo hacer si el usuario envió un mensaje, pero antes de que se enviara, se perdió la conexión a Internet? ¿Qué debo hacer si el usuario recibió una confirmación de lectura, pero cerró la aplicación antes de que se actualizara el registro correspondiente en la base de datos? ¿Qué debo hacer si el usuario invitó a su amigo a la sala, pero antes de que se enviara la invitación, su batería se agotó? ¿Alguna vez has hecho preguntas similares? Aquí estoy. Antes de. Pero en el proceso de desarrollo comencé a preguntarme. Como la conexión puede desaparecer en cualquier momento y el teléfono se apaga en cualquier momento, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe </font><b><font style="vertical-align: inherit;">confirmarse</font></b><font style="vertical-align: inherit;"> . No es divertido. Por lo tanto, el primer mensaje que el cliente envía al servidor ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si recuerda) no es solo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hola, estoy en línea"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hola, estoy en línea y aquí hay habitaciones sin confirmar, aquí hay confirmaciones no confirmadas, aquí hay operaciones de membresía de sala sin confirmar y aquí están los últimos mensajes recibidos por habitación"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y el servidor responde con una hoja similar: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Mientras estabas desconectado, tal y tal tus mensajes fueron leídos por tales y tales usuarios, y también invitaron a Petya a esta sala, y Sveta salió de esta sala, y tú fuiste invitado a esta sala, pero a estas dos habitaciones tienen 40 nuevos puestos "</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Realmente me gustaría saber cómo se hacen cosas similares en otros mensajeros, porque mi implementación no brilla con gracia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imágenes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por el momento, puede enviar texto, texto + imágenes y solo imágenes. </font><font style="vertical-align: inherit;">La carga de video aún no se ha implementado. </font><font style="vertical-align: inherit;">Las imágenes se comprimen un poco y se guardan en el almacenamiento de Firebase. </font><font style="vertical-align: inherit;">El mensaje en sí contiene enlaces. </font><font style="vertical-align: inherit;">Al recibir el mensaje, el cliente descarga imágenes, genera miniaturas y guarda todo en el sistema de archivos. </font><font style="vertical-align: inherit;">Las rutas de archivo se escriben en la base de datos. </font><font style="vertical-align: inherit;">Por cierto, la generación de miniaturas es el único código ejecutado en un subproceso separado, ya que es una operación de procesamiento pesado. </font><font style="vertical-align: inherit;">Acabo de comenzar una secuencia de trabajo, le doy una imagen y, a cambio, obtengo una miniatura. </font><font style="vertical-align: inherit;">El código es extremadamente simple, ya que dart proporciona abstracciones convenientes para trabajar con flujos.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La autenticación de Firebase también se usa, pero solo para la autorización de acceso al almacenamiento de Firebase (para que el usuario no pueda, por ejemplo, completar la foto de perfil de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otra persona</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Toda otra autorización se realiza a través de mis servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formato de mensaje</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente estés horrorizado aquí, ya que uso conjuntos de bytes regulares. Json desaparece porque se requiere eficiencia, y no sabía sobre protobuf cuando comencé. El uso de matrices requiere mucho cuidado porque un índice está mal y las cosas salen mal. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros 4 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son la longitud del mensaje. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente byte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el código del mensaje. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los siguientes 16 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son el identificador de solicitud (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los siguientes 40 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son el token de autorización. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resto del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Longitud del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requerido, ya que no utilizo sockets http o web, o algún otro protocolo que proporcione la separación de un mensaje de otro. Mis servidores frontend solo ven flujos de bytes, y necesitan saber dónde termina un mensaje y comienza otro. Hay varias formas de separar los mensajes (por ejemplo, para usar algún tipo de carácter que nunca se encuentra en los mensajes como separador), pero preferí especificar la longitud, ya que este método es el más fácil, aunque implica una sobrecarga, ya que faltan la mayoría de los mensajes y un byte para indicar la longitud. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El código del mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es solo uno de los miembros de la enumeración</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El enrutamiento se lleva a cabo de acuerdo con el código, y dado que podemos extraer el código de la matriz sin deserialización preliminar, el servidor frontend decide en qué tema del kafka enviar un mensaje en lugar de delegar esta responsabilidad a otra persona. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID de solicitud</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presente en la mayoría de las publicaciones, pero no en todas. Realiza 2 funciones: mediante este identificador, el cliente establece la correspondencia entre la solicitud enviada y la respuesta recibida (si el cliente envió los mensajes A, B, C en este orden, esto no significa que las respuestas también estarán en orden). La segunda función es evitar duplicados. Como se mencionó anteriormente, kafka garantiza al menos una vez la entrega. Es decir, en casos raros, los mensajes aún pueden duplicarse. Al agregar la columna RequestIdentifier con una restricción única a la tabla de base de datos deseada, podemos evitar insertar un duplicado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token de autorización</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es un UserId (8 bytes) + 32 bytes de firma HmacSha256. </font><font style="vertical-align: inherit;">No creo que valga la pena usar Jwt aquí. </font><font style="vertical-align: inherit;">¿Jwt es aproximadamente 7-8 veces más grande para qué? </font><font style="vertical-align: inherit;">Mis usuarios no tienen ningún reclamo, por lo que una simple firma hmac está bien. </font><font style="vertical-align: inherit;">La autorización a través de otros servicios no es ni está planificada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es curioso que pospuse deliberadamente la implementación de las llamadas de audio y video, porque estaba seguro de que no podría resolver los problemas, pero en realidad resultó ser una de las características más fáciles de implementar. </font><font style="vertical-align: inherit;">Al menos la funcionalidad básica. </font><font style="vertical-align: inherit;">En general, solo agregar WebRtc a la aplicación y obtener la primera sesión de video tomó solo unas pocas horas y, milagrosamente, la primera prueba fue exitosa. </font><font style="vertical-align: inherit;">Antes de eso, pensé que el código que funcionó la primera vez era un mito. </font><font style="vertical-align: inherit;">Por lo general, la primera prueba de una nueva característica siempre falla debido a algún tipo de error estúpido como "se agregó un servicio, pero no se registró en un contenedor DI".</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No es muy breve sobre WebRtc para los no iniciados</font></font></b><div class="spoiler_text">WebRtc —  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    — stun .   stun  ,    —  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP — Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP — Router Port.   — <i></i>   .     ,  «»    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  — turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  — coturn,      .<br>
<br>
  — .    <i> </i>  ,    .       ,    .   —           .       .    ,          , ,     :)       —   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tecnología WebRtc en sí misma establece una conexión y maneja las secuencias de un lado a otro, pero este no es un marco para crear llamadas completas. Por llamada, me refiero a una sesión de comunicación con la capacidad de cancelar, rechazar y aceptar la llamada, así como colgar. Además, debe informar a la persona que llama si el otro lado ya está ocupado. Y también para implementar pequeñas cosas como "esperar una respuesta a la llamada N segundos, luego reiniciar". Si simplemente implementa WebRtc en la aplicación de forma simple, con una llamada entrante, la cámara y el video se encenderán espontáneamente, lo que, por supuesto, es inaceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En su forma pura, WebRtc generalmente implica enviar candidatos a la otra parte lo antes posible para que las negociaciones comiencen lo más rápido posible, lo cual es lógico. En mis pruebas, los candidatos al partido receptor generalmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siempre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comenzó a llegar incluso antes de que llegue la oferta. Dichos candidatos "tempranos" no pueden descartarse, deben recordarse, de modo que más tarde, cuando llegue la oferta y </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se cree, agréguelos a la conexión. El hecho de que los candidatos puedan comenzar a llegar incluso antes de la oferta, así como algunas otras razones, hacen que la implementación de llamadas completas sea una tarea no trivial. ¿Qué hacer si varios usuarios nos llaman a la vez? Recibiremos candidatos de todos, y aunque podemos separar a los candidatos de un usuario de otro, no queda claro qué candidatos rechazar, porque no sabemos qué oferta vendrá antes. También habrá problemas si los candidatos comienzan a venir a nosotros y luego una oferta en el momento en que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosotros mismos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> llamamos a alguien.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de probar varias opciones con un WebRtc simple, llegué a la conclusión de que de esta forma sería problemático y lleno de pérdidas de memoria tratar de hacer llamadas, así que decidí agregar otra etapa al proceso de negociación de WebRtc. Yo llamo a esta etapa </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La idea es muy simple, pero me llevó bastante tiempo alcanzarla. La persona que llama, incluso antes de crear la transmisión y </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(y generalmente antes de ejecutar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cualquier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> código relacionado con WebRtc) envía un mensaje a través del servidor de señales al otro lado </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En el lado receptor, se verifica si el usuario está en alguna otra sesión de comunicación en este momento ( </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campo </font><font style="vertical-align: inherit;">simple </font><font style="vertical-align: inherit;">). Si es así, se devuelve un mensaje.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y de esta manera le informamos a la persona que llama que el usuario está ocupado y al receptor, que tal o cual teléfono llamó mientras estaba ocupado con otra conversación. Si el usuario está actualmente libre, entonces está </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reservado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificador de sesión se envía </font><font style="vertical-align: inherit;">en el mensaje </font><font style="vertical-align: inherit;">, y este identificador se establece como el identificador de la </font><font style="vertical-align: inherit;">sesión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si el usuario está reservado, rechazará todos los </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensajes con identificadores de sesión distintos del actual. Después de la reserva, el receptor envía un mensaje a través del servidor de señal a la persona que llama </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Vale la pena decir que este proceso no es visible para el usuario receptor, ya que todavía no hay una llamada. Y lo principal aquí es no olvidar colgar un tiempo de espera en el lado receptor. De repente, reservaremos una sesión y no se ofrecerá ninguna oferta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La persona que llama recibe </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y aquí es donde WebRtc comienza con ofertas, candidatos, y esto es para todos. </font><font style="vertical-align: inherit;">La oferta vuela hacia el receptor y él, al recibirla, muestra una pantalla con los botones Responder / Rechazar. </font><font style="vertical-align: inherit;">Pero los candidatos, como siempre, no esperan a nadie. </font><font style="vertical-align: inherit;">De nuevo comienzan a llegar incluso antes de la oferta, porque no hay razón para esperar a que el usuario responda la llamada. </font><font style="vertical-align: inherit;">Es posible que no responda, pero rechace o espere hasta que expire el tiempo de espera, entonces los candidatos simplemente serán expulsados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado actual y planes futuros</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chats privados y grupales</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envío de texto, imágenes</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y videos.</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamadas de audio y video</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmación de recibo y lectura</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impresiones ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notificaciones</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Búsqueda por código QR y geolocalización</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La búsqueda por código QR es, inesperadamente, bastante problemática de implementar, porque casi todos los complementos para el escaneo de código que intenté se niegan a comenzar o no funcionan correctamente. </font><font style="vertical-align: inherit;">Pero creo que los problemas se resolverán aquí. </font><font style="vertical-align: inherit;">Y para la implementación de la búsqueda de geolocalización, aún no he retomado. </font><font style="vertical-align: inherit;">En teoría, no debería haber ningún problema especial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notificaciones en progreso, así como el envío de videos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué más hay que hacer?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh mucho </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no hay pruebas. Los colegas solían escribir exámenes, así que me relajé por completo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En segundo lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> invitar a los usuarios a un chat existente y abandonar el chat actualmente no es posible. El código del servidor está listo para esto, el código del cliente no. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En tercer lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si el manejo de errores en el servidor es más o menos, entonces no hay manejo de errores en el cliente. No basta con hacer una entrada de registro; debe volver a intentar la operación. Ahora, por ejemplo, el mecanismo para reenviar mensajes no está implementado. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarto, el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor no hace ping al cliente, por lo que no se detecta la desconexión si, por ejemplo, el cliente ha perdido Internet. La desconexión se detecta solo cuando el cliente cierra la aplicación. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quinto, los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> índices no se usan en la base de datos.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sexto,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimización. El código tiene una gran cantidad de lugares donde se escribe algo así </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La mayoría de las matrices son solo </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eso. El servidor de fondo crea muchas matrices de longitud fija, por lo que aquí puede y debe usar el grupo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Séptimo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hay muchos lugares en el cliente donde </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">termina </font><font style="vertical-align: inherit;">el código </font><font style="vertical-align: inherit;">, aunque esto no es necesario. El envío de imágenes, por ejemplo, parece lento porque el código</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guarda imágenes en el sistema de archivos y genera miniaturas antes de mostrar el mensaje, aunque no es necesario hacer nada de esto. O, por ejemplo, si abre la aplicación y, durante su ausencia, le enviaron imágenes, el inicio será lento, porque nuevamente todas estas imágenes se descargan, se guardan en el sistema, se generan miniaturas, y solo después de eso finaliza el inicio y se le arroja desde la pantalla de inicio en la pantalla de inicio Todos estos redundantes </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se hicieron para una depuración más fácil, pero, por supuesto, debe deshacerse de las esperas innecesarias antes del lanzamiento. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octavo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interfaz de usuario ahora está medio lista, porque no he decidido cómo quiero verla. Por lo tanto, ahora no todo es intuitivo, la mitad de los botones no tienen claro qué están haciendo. Y los botones a menudo no se presionan la primera vez, porque ahora son solo iconos con </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y sin relleno, por lo que no siempre es posible acceder a ellos. Además, en algunos lugares, el desbordamiento de píxeles no es fijo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noveno,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ahora es incluso imposible iniciar sesión en una cuenta, solo registrarse. Por lo tanto, si desinstala la aplicación y la reinstala, no podrá iniciar sesión en su cuenta :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décimo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el código de verificación no se envía al correo. Ahora el código generalmente es siempre el mismo, nuevamente porque es más fácil de depurar. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Undécimo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El principio de responsabilidad única se viola en muchos lugares. Necesito un refactor. Las clases responsables de interactuar con la base de datos (tanto en el cliente como en el servidor) generalmente están muy hinchadas porque participan en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas las</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operaciones de la base de datos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duodécimo, el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor frontend ahora siempre espera una respuesta del servidor back-end, incluso si el mensaje no implica enviar una respuesta (por ejemplo, un mensaje con un código </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y algunos mensajes relacionados con WebRtc). Por lo tanto, sin esperar una respuesta, escribe un error en la consola, aunque esto no es un error. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decimotercero,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> las imágenes completas no se abren al tocar. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de quintos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunos mensajes que deben enviarse en lotes se envían por separado. Lo mismo se aplica a algunas operaciones de la base de datos. En lugar de ejecutar un solo comando, los comandos se ejecutan en un bucle con </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de sextos,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algunos valores están codificados, en lugar de ser configurables. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento un millón de séptimos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iniciar sesión en el servidor ahora es solo a la consola, y en el cliente en general, directamente al widget. En la pantalla principal hay una pestaña de Registros, donde se sueltan todos los registros al tocar. El hecho es que mi máquina de trabajo se niega a ejecutar tanto el emulador como todo lo necesario para el servidor (kafka, base de datos, rábano y todos los servidores). El débito con un dispositivo conectado tampoco funcionó, todo simplemente se colgó en la mitad de los casos, porque la computadora no podía hacer frente a las cargas. Por lo tanto, debe realizar una compilación cada vez, soltarla en el dispositivo, instalarla y probarla de esta manera. Para ver los registros, los dejo caer directamente en el widget. Perversión, lo sé, pero no hay otra opción. Por la misma razón, muchos métodos regresan </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Son (para atrapar la excepción y tirar al widget), aunque no deberían. Si observa el código, verá un </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">método </font><font style="vertical-align: inherit;">feo </font><font style="vertical-align: inherit;">en muchas clases que hace esto. Esto, por supuesto, también irá a la basura. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento millones y ocho,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no hay sonidos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciento millones y noveno,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe usar el almacenamiento en caché más. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cien millones de décimas,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mucho código repetitivo. Por ejemplo, muchas acciones primero comprueban la validez del token y, si no es válido, envían un error. Creo que necesita implementar una tubería de middleware simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y muchas pequeñas cosas, como concatenar cadenas en lugar de usar </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no en todas partes se llama donde debería, y así sucesivamente. </font><font style="vertical-align: inherit;">En general, el estado normal del proyecto está en desarrollo. </font><font style="vertical-align: inherit;">Todo lo anterior es solucionable, pero hay un problema fundamental en el que no pensé hasta el último momento, porque se me pasó por la cabeza: el mensajero debería funcionar incluso cuando la aplicación no está abierta, y la mía no funciona. </font><font style="vertical-align: inherit;">Para ser honesto, la solución a este problema aún no se me ha pasado por la cabeza. </font><font style="vertical-align: inherit;">Aquí, aparentemente, no puede prescindir del código nativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calificaría la preparación del proyecto en un 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Han pasado seis meses desde el inicio del trabajo en el proyecto. </font><font style="vertical-align: inherit;">Combinado con el trabajo a tiempo parcial y tomó largos descansos, pero de todos modos, el tiempo y el esfuerzo fueron decentemente. </font><font style="vertical-align: inherit;">Planeo implementar todas las características declaradas + agregar algo inusual como tic-tac-toe o borradores en la habitación. </font><font style="vertical-align: inherit;">Sin ninguna razón, solo porque es interesante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tiene alguna pregunta, escriba. </font><font style="vertical-align: inherit;">El correo está en github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490054/index.html">17 sorpresas para mi primer año usando el Tesla Model 3</a></li>
<li><a href="../es490056/index.html">Black Box: olvídate de iniciar sesión</a></li>
<li><a href="../es490060/index.html">Gráfico de conocimiento de búsqueda: construcción desde múltiples fuentes</a></li>
<li><a href="../es490066/index.html">De China al Polo Sur: uniendo fuerzas para resolver el rompecabezas de masas de neutrinos</a></li>
<li><a href="../es490068/index.html">Falsificación de aleatoriedad y transformación clasificando secuencias pseudoaleatorias</a></li>
<li><a href="../es490076/index.html">Clasificación deportiva de las disciplinas de deportes electrónicos.</a></li>
<li><a href="../es490080/index.html">Cómo los competidores pueden bloquear fácilmente su sitio</a></li>
<li><a href="../es490082/index.html">Análisis del Código Genético I</a></li>
<li><a href="../es490084/index.html">Comprensión de la especificación ECMAScript, Parte 1</a></li>
<li><a href="../es490086/index.html">Guía de surf para principiantes o vida de programador en Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>