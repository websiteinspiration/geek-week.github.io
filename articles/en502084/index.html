<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèº üë®‚Äçüë©‚Äçüëß üèõÔ∏è Checking the portal of regional public services under load through puppeteer üë©üèæ‚Äçüíª üñïüèº üï¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! You, too, are curiously watching the "epic of the American Wild West on the distribution of land plots - go first and stick a flag to sta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Checking the portal of regional public services under load through puppeteer</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502084/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! You, too, are curiously watching the "epic of the American Wild West on the distribution of land plots - go first and stick a flag to stake" or perhaps even participate in it. More precisely in its modern version - be the first to apply for public services in order to receive money for children or get a pass to leave the house. Looking at all this, I would like to share the experience of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our team</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in testing and participating in the preparation of a regional portal of services for the provision of the ‚ÄúFirst Class Record‚Äù service. It is also very similar to the habra effect and, I think, was close to what happened a couple of days ago with the federal portal gosuslugi.ru, but on a regional scale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We passed this challenge in Khabarovsk in January this year and recently participated in the preparation of a similar service for issuing hunting permits in another region. Below is a little experience that will give you the opportunity to look at the issue of preparing the work of regional public services portals for peak periods from another perspective. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And for starters - a photo of a black bus, who was on duty at the school for three days around the clock, in which the author of these lines confirmed his turn among parents three years ago. At least our parents have come together. Watching in winter in Khabarovsk at -30 degrees is still a pleasure.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/vh/rb/o8vhrboqvtrufnftfwxsxb1rgm4.png" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the process of preparing for the peak recording in the first grade, several teams worked, because </font><font style="vertical-align: inherit;">one way or another is involved in it: the data center operator, the operator and the developer of the information system of the regional portal, the operator and the developer of the integrated education information system, technical support for users of the regional portal. </font><font style="vertical-align: inherit;">We at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iondv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perform the last task, independently monitoring the health of the portal and supporting users. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our role in the preparation is to organize testing and recommendations on caching configurations in nginx, well, we also prepared instructions for users with the recommended ‚Äúbehavior‚Äù.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For those who do not know about the problem of writing in the 1st grade</font></font></b>
                        <div class="spoiler_text">         ,    .  .          ,     ,   -     (      ,   ‚Äî      ),    ,  -     ,   ,            .  ,       ,      ,     ‚Äì    ,        .           .<br>
<br>
     1-          ,    .           0:00 ,        10:00 26 . ,    ‚Äì       .        10:00 ,       ‚Äî    ,      - .<br>
<br>
            .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>    .   2017 .     .         ,    ,    .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A service for a demanded resource as a technical task</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem in services like ‚Äúwriting to 1st grade‚Äù in the integral indicator of the load (or probability of queries) tending to the ‚Äúdelta function‚Äù (Œ¥-function, Dirac function) is clearly visible on the graphs in the form of peaks. At this moment, there is a multiple increase in calls in a short period of time. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0l/uc/c6/0lucc67w9pr4uh2ig1swg5tgtq0.png" alt="Œ¥-function and peak query statistics"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our experience says that the main task of training is not to increase resources. The task is to minimize the potential number of requests per second, stretch them for some period and prepare the system for the remaining load. In this case, it is necessary to find and accelerate bottlenecks - this will give the greatest effect in accordance with the principles of the theory of bounded systems (Goldratt's principles). And otherwise it is the bottleneck that will fail. The whole system should work from him: the principle of "drum-buffer-rope."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is physically impossible to spill the entire volume in 10 minutes of hourglass in 1 minute - it is obvious that they will collapse. </font><font style="vertical-align: inherit;">Similarly for the provision of services. </font><font style="vertical-align: inherit;">It does not surprise anyone - when it is the turn of the MFC and scandals to receive services, but it surprises everyone - why the portal went down. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are different patterns of load handling behavior from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queuing theory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can put users on hold, i.e. </font><font style="vertical-align: inherit;">increase the queue;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can simply refuse to service those who came later, for example, until the previous ones are processed;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You can try to endlessly increase productivity.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expediency is somewhere in between. Indeed, for a service with a limited resource provided by a region or state, not only speed is important, but, first of all, the preservation of social justice - i.e. equal conditions for all. At the same time - if the user has not received what he needs, he initiates a new request. In this case, requests grow in an avalanche, forming a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model of attack ‚Äú</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dog-pile effect </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">‚Äù</font></a><font style="vertical-align: inherit;"> (dog-pile effect, cache stampede, hit miss storm) - the user has already canceled the request and initiated a new one, while the previous one is still in the queue to be processed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This process reinforces the fact that whole families participate in the submission - dad and mom fill out applications at the same time, and often submit applications several times for reliability. </font><font style="vertical-align: inherit;">And besides, often also in several tabs and several browsers. </font><font style="vertical-align: inherit;">Therefore, the expected peak load usually makes sense to multiply by 2-3 times, from the number of those who actually apply for such services.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Justice retreat</font></font></b>
                        <div class="spoiler_text">,   ¬´¬ª,            .   ?  ¬´¬ª    ,    .   .     ‚Äî        ,     .        ¬´ ¬ª.        .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organization of the provision of services</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We calculated the expected number of applicants based on a combination of data on the total number of applications submitted last year and per-minute data for other regions. </font><font style="vertical-align: inherit;">Typically, the peak of applications falls on 5-10 minutes, including because the portals almost do not respond for the first three to five minutes, and later users fill out the form from 1 to 5 minutes (do not be surprised, many fill out from the phone even in such ‚Äúnervous‚Äù conditions) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An approximate calculation model for the conditional 1000 applications per hour is as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peak from 5 to 10 minutes from the start and 80% of applications will be filed under the Paretto rule</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conventionally, we plan 160 applications per minute or 3 applications per second.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, the first submission occurred after one minute and 45 seconds, and the peak of applications went from 4 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To reduce the load on ESIA and on the system from generating authorization sessions, the instructions suggested that users log in in advance and lengthen the session lifetime. </font><font style="vertical-align: inherit;">In fact, 50% were authorized in 1 hour, and ~ 90% in half an hour. </font><font style="vertical-align: inherit;">We encountered earlier that users started logging into the portal 10 minutes before the start of the service - and authorization began to work unstably. </font><font style="vertical-align: inherit;">It‚Äôs hard to say why. </font><font style="vertical-align: inherit;">Perhaps the reason is that when technical work is carried out in Moscow at night, in Khabarovsk we have just the beginning of the working day.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retreat about instruction and organizational arrangements</font></font></b>
                        <div class="spoiler_text">            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>.<br>
<br>
         ,    ¬´ ¬ª     . ..      .       ,   -   .. <br>
<br>
    ,        ,         ,    .        -        .      ,       ,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is impossible to remove the "delta function" when the form is reloaded at 00:00. The whole point of this procedure is that the service appears at a given time. But you can try to reduce the number of browser requests on all expected user routes and thereby leave the load on the system only from the necessary ones - form, dynamic directories and sending applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The nginx settings themselves are fairly standard. Here it is more important to choose the limitations that the system can withstand. Pick them up - i.e. start queuing requests when the server is expected to come to the limit of its capabilities.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, and most importantly, we forced the caching (proxy_cache) and increased the lifetime of the "expires" data in nginx for all static paths and, where possible, dynamic pages in which there are no sessions. By the way, this is a common mistake when caching - writing to the cache data (sometimes even statics) in which someone else's session is stored, the output is usually to delete these cookies from the headers if the server cannot separate the data types. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the browser for the user, it looks like updating pages from files downloaded from disk or memory. But even when the user gets them from the server, they are taken from the nginx cache. Directories themselves, of course, are cached in the system itself.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/oq/nv/qioqnv0ofdjd5e0ygculnetdta4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This reduced the number of potential requests from 89 requests to 14 and the volume from 2.1 MB (for 1000 users who updated the page, this is a potential peak of 4-8 Gbit / s) to 38 Kb (we all remember webpack, but for entrprise platforms this is not always easy to do). According to the results of the passage, it was still necessary to cache not only in the system, but also in nginx some of the directories from the form and dynamic classifiers not used at the peak moment and force the lifetime for them. And with an increase in load it generally makes sense to put on the main fully static page with routing users to the desired service or to create a separate resource for the service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To reduce the load on sending, drafts and automatic filling of data for the child were disabled. All users have different data entry speeds, which eliminates the appearance of a form that is completely ready for submission and avoids the delta function for sending applications - all 1000 in one minute. At the same time, social justice is maintained, although, of course, complaints appear. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not describe the optimization of the system itself - during load testing, bottlenecks were identified - mainly in DBMS queries and the indexes and queries themselves were optimized. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probably the most important optimization is to simplify the form. What affects speed the most when implemented in a form?</font></font><br>
<br>
<ul>
<li>   ‚Äî   ,        ,      .    ‚Äî       5-10 (   iPhone         )   5-       375 /  (1       10 ,     <code>application/x-www-form-urlencoded </code>‚Äì  20 ),  100      625 /.           100/      ‚Äî        .   ,      ¬´  ¬ª.    ‚Äî     ?     ,     .    ,      ?</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sophisticated guides. </font><font style="vertical-align: inherit;">The load is usually increased by using the FIAS or CLADR address directory. </font><font style="vertical-align: inherit;">The problems here are due to size - FIAS takes up to 40GB in the database and it takes time to search for it. </font><font style="vertical-align: inherit;">Tenths of a second, but multiplied by 1000 simultaneous requests, load any system. </font><font style="vertical-align: inherit;">Without special preparation, possibly in the form of a separate web service and on a separate resource, it is difficult to withstand the load - therefore, they often use a plain text field for the address.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, let's move on to the tests.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load testing in preparation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testing was done through puppeteer - by emulating user actions in the Crominium browser. </font><font style="vertical-align: inherit;">Yanedeks.tank and JMeter beat off protection against attacks, because they generate many of the same type of requests. </font><font style="vertical-align: inherit;">In addition, these tests weakly coincide with the profile of real queries when changing the behavior of the system under load. </font><font style="vertical-align: inherit;">In addition, the servers cache requests, and it is difficult to reproduce part of the processes in them (for example, authorization). </font><font style="vertical-align: inherit;">By the way, from one of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devDV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seminars </font><font style="vertical-align: inherit;">we have a presentation with a presentation on the use of puppeteer for testing, including </font><font style="vertical-align: inherit;">load, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link to the video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To begin with, we compiled a user behavior profile and divided the procedure into key stages:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mass authorization in ESIA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> one-time updating of the service form,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mass feed </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each of the stages we did a separate test. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Last year, there were difficulties at the authorization stage in ESIA, but testing it full-scale is difficult. The system is external, protection against attacks and bans on authorization is triggered. Nevertheless, it is possible to formulate a test profile to verify precisely the bottlenecks of the system under test - usually this is the number of simultaneously authorized sessions and planned authorization values ‚Äã‚Äãper minute, which can be adjusted by recommendations.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the test, the wrapper is important for organizing several threads, we use the 'puppeteer-cluster'. But usually it is more complicated to handle exceptions and change the behavior of the portal under load - layout elements are often revealed that pop up twice. Or the elements do not appear if some data did not load as expected. These are all the errors that users will see and reload the page - which means they will create an additional load. There are two ways: implement exception handling in the test. Or modify the portal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The test itself is simple. Below is a fragment from clicking on the ‚ÄúLogin‚Äù button on the services portal to entering data into ESIA.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">await</span> page.waitForSelector(AUTH_AVAIL,{<span class="hljs-attr">timeout</span>:OPT_ELEM_WAIT_TIME});
<span class="hljs-keyword">const</span> needAuth = <span class="hljs-keyword">await</span> page.$(ELEM_AUTH_IN);
<span class="hljs-keyword">if</span> (!needAuth) <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`  `</span>));<font></font>
        <font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(AUTH_BUT, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.click(AUTH_BUT);
<span class="hljs-keyword">await</span> waitNewUrl(page, <span class="hljs-string">'https://esia.gosuslugi.ru/idp/rlogin?cc=bp'</span>, OPT_PAGE_WAIT_TIME);
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#mobileOrEmail'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">let</span> text = <span class="hljs-keyword">await</span> elemGetText(page, <span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt; div.detected &gt; div.left &gt; div.this-user'</span>);
<span class="hljs-keyword">if</span> (text) <font></font>
   text = text.replace(<span class="hljs-regexp">/ -\(\)/g</span>, <span class="hljs-string">''</span>);        
<span class="hljs-keyword">if</span> (text &amp;&amp; text.indexOf(user) === <span class="hljs-number">-1</span>) {
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'div.click-to-another &gt; a'</span>);
  <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt;'</span> +
                <span class="hljs-string">' div.detected &gt; div.left &gt; div.this-user'</span>, OPT_ELEMENT_INVISIBLE);<font></font>
}<font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#password'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#mobileOrEmail'</span>, user);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#password'</span>, pwd);
<span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#loginByPwdButton'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verification of updating the application form pending users "opening the record." The reboot test is essentially one-step, but it is important to check the types of errors returned - the network is a problem, a nginx error, a server error, and whether the form meets the criteria. And the difficulty is to generate the maximum volume of requests in the least amount of time and not fall under the protection restrictions (however, during the tests it can be changed, on the other hand, it is also a check of the network and server infrastructure settings and WAF). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such tests on puppeteer require a lot of resources to work. De facto it turned out that you need at least 2 cores against the 1st core of the front-end subsystem and a very wide channel. But when renting them in the cloud - this is quite affordable. We used Yandex.cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the test, authorization is first implemented in ESIA for each stream separately. </font><font style="vertical-align: inherit;">After that, a separate browser is launched for each thread and within the framework of one instance a given number of updates is carried out. </font><font style="vertical-align: inherit;">After that, the instance restarts. </font><font style="vertical-align: inherit;">The check itself may include a typical path, for example, the main page, the form of the service. </font><font style="vertical-align: inherit;">But more often it is enough only to completely update the service and check the necessary directory that the service can be submitted - all as in the instructions for users. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oe/8w/vk/oe8wvknrrkkw1hn3vb4ke0oh8sw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fragment of the test to open the main and refresh the page.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> page.setViewport(PUP_OPT);
  <span class="hljs-keyword">await</span> page.goto(BASE_URL);
  <span class="hljs-keyword">await</span> page.setCookie(...cookies[worker.id]);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/nd/lk/form/dnv.htm`</span>);<font></font>
  rdyRefresh++;<font></font>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#       <span class="hljs-subst">${data}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
  getErr++;<font></font>
  <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
}<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_REFRESH - <span class="hljs-number">1</span>; i++) {
  <span class="hljs-keyword">const</span> filenameIter = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
   <span class="hljs-keyword">try</span> {
       <span class="hljs-keyword">await</span> page.reload({<span class="hljs-attr">waitUntil</span>: [<span class="hljs-string">"networkidle0"</span>, <span class="hljs-string">"domcontentloaded"</span>]});<font></font>
        rdyRefresh++;<font></font>
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (!err.message.includes(<span class="hljs-string">'Navigation failed because browser'</span>)) {
           <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
           getErr++;<font></font>
           <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filenameIter});<font></font>
        }<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the load by sending applications, the entire verification cycle was implemented - with a reload of the form and verification of the input of all data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fragment.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_RESEND; i++) {
   <span class="hljs-keyword">const</span> filename = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
  <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://uslugi27.ru/nd/lk/form/dnv.htm'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      1  <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
      getErr++;<font></font>
      <span class="hljs-keyword">continue</span>;<font></font>
 }<font></font>
 <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">const</span> FORM_PREF = <span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; '</span>;
     <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data`</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
     <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input`</span>, <span class="hljs-string">''</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});
     <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-primary.pull-right.next'</span>);
      <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(1) &gt; div &gt; div`</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(2) &gt; div &gt; div'</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-success.pull-right.submit'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
    sendErr++;<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, the test can be accelerated if you enter all the data not from puppeteer by the await page.type construct, but transfer this logic to the browser itself. But then the complexity of catching errors increases. Like so</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data'</span>).click();
 <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input'</span>).value = <span class="hljs-string">''</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the tests, we provided several thousand ESIA authorizations and about 16 thousand applications sent. How was the restoration of a productive educational information system after such a number of statements - do not even ask. This is a completely different story. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main visible result of this process was that local media were bored now in the days of enrollment in first grade. The service has left the media area. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In parallel, we made a dashboard for monitoring the performance of the form based on Grafana: the number of applications, the number of calls, Yandex metrics, etc. But we will leave this topic for the next time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, I would like to congratulate everyone who is connected with the topic of improving the quality of the provision of state and municipal services in electronic form. </font><font style="vertical-align: inherit;">This endless preparatory work was not in vain - after all, in April and May the number of applications submitted increased significantly.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502068/index.html">110 volts on your computer</a></li>
<li><a href="../en502070/index.html">The history of Pentax (article plus video)</a></li>
<li><a href="../en502072/index.html">Docking the ISS using JavaScript and compass</a></li>
<li><a href="../en502076/index.html">Trolley Robot 2.0. Part 1. Autonomous navigation of a home robot based on ROS</a></li>
<li><a href="../en502080/index.html">Kanban method: Example PNZ No. 1, the measurement-study process in a startup</a></li>
<li><a href="../en502086/index.html">Setting up Minio so that the user can only work with his bucket</a></li>
<li><a href="../en502088/index.html">A tale of excess and lost time. According to py3</a></li>
<li><a href="../en502092/index.html">Technological and regulatory support for digital trust services in the Russian Federation</a></li>
<li><a href="../en502098/index.html">How we built B2B</a></li>
<li><a href="../en502102/index.html">AutoML is great and powerful</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>