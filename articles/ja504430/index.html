<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗑️ 🚟 👨🏾‍🏭 Everyday Life Tinkoff Security Operations Center：シングルブートローダー分析 👎🏿 🐍 👦🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！
 
 Tinkoffセキュリティオペレーションセンターでは、マルウェアや攻撃で使用される手法を定期的に分析しており、最近、お話ししたい興味深いファイルを1つ見つけました。
 
 
  
 この傑作を作成するために使用された手法は20年以上前から知られていますが、マクロでのいくつ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Everyday Life Tinkoff Security Operations Center：シングルブートローダー分析</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tinkoffセキュリティオペレーションセンターでは、マルウェアや攻撃で使用される手法を定期的に分析しており、最近、お話ししたい興味深いファイルを1つ見つけました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="画像"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この傑作を作成するために使用された手法は20年以上前から知られていますが、マクロでのいくつかのチェックの呼び出しは疑わしくなく、正当なドキュメントで使用できるため、数十年後も関連性はあります。</font><font style="vertical-align: inherit;">これは、Excel 4.0マクロで記述されたマルウェアダウンローダーです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツール</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析の一環として、サードパーティのツールを最小限に抑え、標準的なプログラムのセットで問題を解決します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Officeスイート</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーカイバ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストエディタ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソフトウェアアクションを分析するツールとして、Sysmonを使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析環境として、Windows 7を搭載したVMを使用します</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ムノガブカフ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解析するドキュメントは、xls形式のExcelワークブックです。</font><font style="vertical-align: inherit;">マルウェアはフィッシングメールで配信され、ドキュメントが開始すると、マクロがレジストリブランチをアンロードし、MicrosoftのWebサイトからOfficeの更新に関する情報をダウンロードし、悪意のある.dllをダウンロードして起動します。</font><font style="vertical-align: inherit;">これらの手順の後、変更を保存せずにブックが閉じます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このタイプの他のローダーとの主な違いは、VBAマクロを使用しないことです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静的分析</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、悪意のあるドキュメントを含むメールの例です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仮想マシンで添付ファイルを開きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐに注意を払う必要があります。画像はドキュメントが「保護されている」ことを警告し、ローカルで開いて「コンテンツを有効にする」をクリックする価値があることを</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
警告します</font><font style="vertical-align: inherit;">：</font><font style="vertical-align: inherit;">Visual Basic Editorでプロジェクトを確認する必要があるというセキュリティ警告のヒント。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者に渡す-マクロ管理（vbs）ですが、vbsまたはvbaマクロは表示されません。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、</font><font style="vertical-align: inherit;">Office </font><font style="vertical-align: inherit;">ドキュメントとは何かを覚えておきます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各Microsoft Officeドキュメントは、任意のアーカイバを使用して解凍でき、ドキュメントのコンテンツを抽出できるアーカイブです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解凍すると、ドキュメントの中に、慣れているxmlファイルがないことがわかります。これは、古いドキュメント形式のxlsです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xls拡張機能では、コンテンツはOffice Open XML形式ではなく、BIFF8バイナリ形式で保存されます。ドキュメントはExcel 4.0マクロを使用します。マクロはドキュメントセルで実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マクロを含むシートは非表示になりませんが、シートには多数の空のセルがあり、分析が困難になることに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BIFF8ファイルを分析するためのツール（BiffViewerなど）があり、コンテンツを分析するための優れたツール（oletools）があります。ただし、サードパーティのユーティリティを使用せずに実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excelはまた、持っている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベースのフォーマットを</font><font style="vertical-align: inherit;">- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XLSMを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、VBAマクロコードとExcel 4.0マクロシートを保存できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excelで使用できる形式の完全なリストは、Excel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントを保存して解凍し</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。ファイルの内容を確認し、xlフォルダーのmacrosheetsディレクトリから始めて、マクロシート上のすべてのデータを含むファイルを見つけます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font><font style="vertical-align: inherit;">マクロシート</font><font style="vertical-align: inherit;">のセル内のすべての値を取得します。</font><font style="vertical-align: inherit;">マクロ自体は難読化されており、セルには数値とこれらの値を変換して結果を新しいセルに書き込む数式のみが含まれています </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、この数式では、数値が文字に変換され、連結されて、セルFK17653に書き込まれます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excelの数式</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数式の結果、次の行が得られます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後続の各マクロコマンドは、同様の数式によって「収集」され、セルに書き込まれて実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントを開いたときにマクロが自動的に実行されるようにするには、スクリプトを起動するセルをAuto_Openと呼ぶ必要があります。</font><font style="vertical-align: inherit;">workbook.xmlファイルを検討してください。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=«1.0» encoding=«UTF-8» standalone=«yes»?&gt;<br>
&lt;workbook xmlns=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>» xmlns:r=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>» xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>» mc:Ignorable=«x15» xmlns:x15=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>»&gt; appName=«xl» lastEdited=«6» lowestEdited=«6» rupBuild=«14420»/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>»&gt; Requires=«x15»&gt;&lt;x15ac:absPath url=«C:\Users\User\Desktop\malware\» xmlns:x15ac=«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>»/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=«Sheet1» sheetId=«1» r:id=«rId1»/&gt;&lt;sheet name=«Sheet2» sheetId=«2» r:id=«rId2»/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル内には、行名= "_ xlnm.Auto_OpenT8nee" hidden = "1"&gt; Sheet2！$ IE $ 65406があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、マクロの実行元のセルであるIE65406が非表示であることを意味します。</font><font style="vertical-align: inherit;">これで、マクロのエントリポイントがわかりました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的分析</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
疑わしいファイルをマシンで実行しないでください。</font><font style="vertical-align: inherit;">疑わしいソフトウェアのアクションを調査するには、特別に準備された環境を使用する必要があります。さまざまなサンドボックスまたは特別に準備された隔離されたマシン（仮想または鉄）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントを開き、コンテンツを実行します。</font><font style="vertical-align: inherit;">コマンドプロンプトウィンドウが点滅し、ブックが閉じます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmonログを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmonにはプロセス作成イベント（ID 1）があります。Sysmonの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログから、マクロがディレクトリc：\ users \ publicにファイルを作成して</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いることがわかります。次のsysmonメッセージは、レジストリブランチがアンロードされ、結果がファイルに書き込まれていることを示しています。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SysmonイベントイベントID 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: «C:\Windows\system32\reg.exe» EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: «C:\Program Files\Microsoft Office\Office16\EXCEL.EXE»</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完了すると、マクロは作成されたファイルを削除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルの削除を禁止するには、フォルダーのアクセス許可を変更し、読み取りと書き込みのアクセス許可を残し、削除を禁止します。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントを再度実行すると、マクロの実行中にエラーが発生し、デバッグできるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部の呼び出しでは例外処理がないため、これは可能です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マクロを段階的に実行してみましょう;デバッグ中に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのdllライブラリからの関数呼び出しが発生します</font><font style="vertical-align: inherit;">。マクロが完了すると、次のファイルが共有ユーザーフォルダーに格納されます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行を開始するセルがわかっているので、マクロシートのすべてのセルに入力できます。</font><font style="vertical-align: inherit;">マクロを閉じて（false）関数に移りましょう。「一時停止」ボタンをクリックして実行を中断します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境チェックセル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マクロが埋めるセルを調べると、いくつかの関数get.window（）とget.workspace（）に出会います</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.window（）関数は、現在のウィンドウに関する情報（ステータス、ウィンドウのステータス、その名前、表示オプションなど）を返します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.workspace（）関数を使用すると、ドキュメントが実行されている環境に関する情報を見つけることができます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excel 4.0で使用できる呼び出しの完全なリストは、リンクにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでさらに詳しく説明する必要があります。私の同僚と私は、これらの呼び出しのほとんどがサンドボックスをバイパスする試みに関連していることを示唆しました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow（7）-現在のウ​​ィンドウが非表示かどうかを確認します。</font><font style="vertical-align: inherit;">trueまたはfalseを返します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows（20）-ウィンドウが最大化されている場合はtrueを返します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows（23）-値1、2、3を返すことができます</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/0fb/30d/39e/0fb30d39eff6ae78514edebe00d67a69.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1-復元</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2-最小化</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3-最大化した</font><font style="vertical-align: inherit;">
がって</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、現在のウィンドウが開いているかどうかを確認します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。get.workspace（31）-マクロが段階的にデバッグされているかどうかを確認します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（13）-ワークスペースの幅をピクセルで確認：770未満の場合、本は閉じます</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（14）-ワークスペースの高さをピクセルで確認：390未満の場合、本は閉じます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（19）-チェックマウスの存在。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace（1）-ドキュメントが実行されているオペレーティングシステムを返します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
falseの場合、各チェックで、結果を保存せずに本を閉じるセルへの遷移があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部ライブラリ呼び出し</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
環境を確認した後、主な機能に移ります。 WinAPI関数がマクロからどのように呼び出されるかを見てみましょう</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1. Sysmonログで確認したreg.exe呼び出し。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーティリティを呼び出すには、shell32.dllライブラリのShellExecute関数を使用します。関数のパラメーターは他のセルに分散しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルBN16631：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルA46097：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルGN47559では、必要なレジストリブランチをエクスポートするコマンドが送信され、Get.workspace（2）がExcelのバージョンを返します。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルDX48821には、結果が書き込まれるパスが含まれています。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらにマクロには、作成されたIcltdXw.regファイルの存在とその削除のチェックがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. URLDownloadToFile関数を呼び出します。この関数は、getリクエストの結果をファイルに保存します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出しは次のとおりです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この電話により、マイクロソフトのWebサイト、Officeの更新に関する情報が記載されたページにアクセスできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数パラメーター：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルBR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルIN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
命令の実行後、ファイルが作成されたかどうか、およびファイル内のオフセットによる文字の読み取りがチェックされます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのアクションは、ドキュメントが実行されている環境がインターネットにアクセスできるかどうかをチェックすることを目的としています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FILES関数は式のiserrorに渡され、引数はURLDownloadToFile関数の結果が書き込まれるファイルの名前です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セルFM27223は、本を閉じる関数に制御を渡し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。Microsoftからファイルを正常に受信すると、セルは、urlmon dllへの2回目の呼び出しに備えるために入力されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロードの読み込み</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これが2番目の呼び出しですが、悪意のあるロードがロードされるはずのdehabadi [。] Irドメインへ</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
の結果</font><font style="vertical-align: inherit;">です</font><font style="vertical-align: inherit;">。結果は、html拡張子が付いた同じフォルダー内のファイルに書き込まれます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最初にペイロードをダウンロードしようとしたときに、マクロコードのブランチに遭遇します失敗した場合、2回目の試行が行われますが、別のアドレスから行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダウンロードが成功すると、警告ポップアップが表示され、ロードされたライブラリが呼び出されます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全な呼び出しは次のとおりです。</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全な呼び出しでは、ShellExecuteA関数は、rundll32を起動するためのパラメーターを指定してShell32ライブラリから呼び出され、ダウンロードされた悪意のあるライブラリのエクスポートされた関数が呼び出されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでマクロ機能が完了し、ペイロードが稼働しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
言われたように、このテクノロジーはかなり古いものですが（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel 3.0 for Windows 3.0および3.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、マルウェアがその目標を達成するために必要な機能を完全に提供します。そして、このファイルの目的は、個人データの盗難から始まり、システムの認証データ、コンピューター上のデータの破損/暗号化、そしてリモートでコードを実行する機能まで、深刻な損害を引き起こす危険なソフトウェアをシステムに静かに置くことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなドキュメントの分析には、特別なユーティリティやソフトウェアを使用する必要はまったくありませんが、一連の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oletools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトに言及する価値</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">があります</font></a><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">詳細については、こちらを参照してください</font></a><font style="vertical-align: inherit;">。分析の結果として特定された侵害の指標を以下に示します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受け取ったIOC：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [。] williamdmon [@] wp [。] pl </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [。] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [。] ir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps：//eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps：//dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">侵害の指標の完全なリスト。</font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照：</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> マクロリファレンス4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析に取り組んだ：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504412/index.html">オンラインプログラミングチャンピオンシップ「モスクワトレーニングのオープンファイナル」</a></li>
<li><a href="../ja504414/index.html">Как Microsoft убила AppGet</a></li>
<li><a href="../ja504416/index.html">3D ML。パート2：3D MLタスクの損失関数</a></li>
<li><a href="../ja504420/index.html">同時移動を伴うターンベースのPvPアリーナの作成</a></li>
<li><a href="../ja504422/index.html">Kafka Streamsを使用したSpring Bootアプリケーション</a></li>
<li><a href="../ja504434/index.html">親のための教育プログラム：インターネットで子供を危険から守る方法</a></li>
<li><a href="../ja504438/index.html">1週間あたり30ミタップ。2020年夏シーズンオープン</a></li>
<li><a href="../ja504442/index.html">Linuxカーネルでの再配置について少し</a></li>
<li><a href="../ja504444/index.html">docker multi-stageを使用してWindowsイメージを構築する</a></li>
<li><a href="../ja504446/index.html">VLSI自動原価計算で行ったように</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>