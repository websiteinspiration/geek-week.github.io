<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏿 ⛸️ 🈷️ 再一次关于嵌入式：在Embox项目中寻找错误 👩‍👦‍👦 🧜🏾 👩🏽‍🤝‍👨🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Embox是用于嵌入式系统的跨平台，多任务实时操作系统。它旨在在低计算资源下工作，并允许您在微控制器上运行基于Linux的应用程序，而无需使用Linux本身。当然，像其他任何应用程序一样，Embox错误也无法幸免。本文专门分析Embox项目代码中发现的错误。
 
 几个月前，我已经写了一篇有关检查F...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>再一次关于嵌入式：在Embox项目中寻找错误</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="图2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embox是用于嵌入式系统的跨平台，多任务实时操作系统。它旨在在低计算资源下工作，并允许您在微控制器上运行基于Linux的应用程序，而无需使用Linux本身。当然，像其他任何应用程序一样，Embox错误也无法幸免。本文专门分析Embox项目代码中发现的错误。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
几个月前，我已经写</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了一篇</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关检查FreeRTOS </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">的文章</font></a><font style="vertical-align: inherit;">，FreeRTOS是另一个用于嵌入式系统的OS。</font><font style="vertical-align: inherit;">那时我没有发现错误，但是在开发他们自己的FreeRTOS版本时，我在亚马逊的家伙添加的库中找到了它们。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从某种意义上讲，您现在看到的这篇文章延续了上一篇的主题。</font><font style="vertical-align: inherit;">我们经常收到检查FreeRTOS的请求，而我们做到了。</font><font style="vertical-align: inherit;">这次，没有要求检查特定项目的请求，但是我开始收到喜欢它并想要更多东西的嵌入式开发人员的来信和评论。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好吧，《 PVS-Studio for Embedded》杂志的新一期已经成熟，摆在您面前。</font><font style="vertical-align: inherit;">喜欢看！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用PVS-Studio（用于C，C ++，C＃和Java的静态代码分析器）进行了分析。在进行分析之前，需要对项目进行组装-因此，我们将确保项目代码正在运行，并且还将为分析人员提供收集组装信息的机会，这些信息对于更好的代码验证很有用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在指令</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">仓库</font></a><font style="vertical-align: inherit;">报价的能力，不同的系统（Arch Linux的，MacOS的，Debian的），并使用泊坞窗下构建。我决定为自己的生活增添些变化，并从Debian（我最近安装在虚拟机上）进行构建和分析。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大会进行得很顺利。</font><font style="vertical-align: inherit;">现在有必要进行分析。</font><font style="vertical-align: inherit;">Debian是受支持的基于Linux的PVS-Studio系统之一。</font><font style="vertical-align: inherit;">在Linux下检查项目的一种便捷方法是编译跟踪。</font><font style="vertical-align: inherit;">这是一种特殊模式，在该模式下，分析仪将收集有关装配的所有必要信息，以便您一键即可开始分析。</font><font style="vertical-align: inherit;">我需要做的就是：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）下载并安装PVS-Studio；</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）通过使用Embox转到文件夹并在终端中键入来启动程序集跟踪</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）等待组装完成后，运行命令：</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4）将原始报告转换为任何方便的格式。</font><font style="vertical-align: inherit;">该分析仪带有一个特殊的实用程序PlogConverter，您可以使用它执行此操作。</font><font style="vertical-align: inherit;">例如，将报告转换为任务列表的命令（例如，在QtCreator中进行查看）将如下所示：</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有！</font><font style="vertical-align: inherit;">完成这些步骤只花了我不到15分钟的时间。</font><font style="vertical-align: inherit;">报告已准备就绪，现在您可以查看错误了。</font><font style="vertical-align: inherit;">好吧，让我们开始吧:)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怪周期</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析器发现的错误之一是奇怪的while循环：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">：</font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> “ while”操作员的身体空了。</font><font style="vertical-align: inherit;">检测到可疑模式：“ while（expr）{...} while（dp.skip！= 0）;”。</font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font><font style="vertical-align: inherit;">真是怪异的循环。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式</font><i><font style="vertical-align: inherit;">（dp.skip！= 0）</font></i><font style="vertical-align: inherit;">被写入两次，一次在循环的上方，第二次在循环的下方。</font><font style="vertical-align: inherit;">实际上，现在有两个不同的循环：一个循环包含花括号，而第二个循环为空。</font><font style="vertical-align: inherit;">在这种情况下，将永远不会执行第二个循环。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下面是具有类似条件的do ... while循环，这使我想到：奇怪的循环原本是指do ... while，但出了点问题。</font><font style="vertical-align: inherit;">我认为这段代码很可能包含逻辑错误。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内存泄漏</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是的，不是没有他们。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该函数在其内部创建局部变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些指针被分配了使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc在</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部分配的新内存位置的地址</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果分配内存时出现问题，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回空指针。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果只分配了一个内存块怎么办？</font><font style="vertical-align: inherit;">该函数将崩溃，而不会释放任何内存。</font><font style="vertical-align: inherit;">恰好已分配的站点将保留在内存中，而没有任何机会再次访问它并释放它以供将来使用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
内存泄漏的另一个示例更亮一些：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，程序员已经显示出准确性，并且正确地处理了仅分配一块内存的情况。</font><font style="vertical-align: inherit;">正确处理了……在下一个表达式中，从字面上看，这又犯了一个错误。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过正确编写的检查，我们可以确保在执行表达式时</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回-EINVAL;。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们肯定会为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配内存</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，从该函数返回后，我们将同时发生两次泄漏。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我认为，与传统PC相比，嵌入式设备上的内存泄漏可能会更加痛苦。</font><font style="vertical-align: inherit;">在资源严重受限的情况下，您需要特别仔细地监视它们。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指针处理不当</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下错误代码简洁明了：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在针对nullptr进行验证之前，已使用了'sdev'指针。检查行：116，118。scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查sdev</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指针</font><i><font style="vertical-align: inherit;">是否</font></i><font style="vertical-align: inherit;">为NULL之前</font><i><font style="vertical-align: inherit;">就已</font></i><font style="vertical-align: inherit;">取消对其的引用。逻辑上假设，如果有人写了这样的支票，则该指针可能为空。在这种情况下，我们有可能在字符串</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取消引用空指针</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
错误是支票不在需要的地方。它应该在“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”行之后，但应在“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font><font style="vertical-align: inherit;">行之前</font><font style="vertical-align: inherit;">。这样就可以避免对零地址的潜在吸引力。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio在以下代码中发现了另外两个错误：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769'xs-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; extra.rec.in_base + recvsz'表达式中的'xs-&gt; extra.rec.in_base'指针可以为nullptr。</font><font style="vertical-align: inherit;">在这种情况下，结果值将毫无意义，因此不应使用。</font><font style="vertical-align: inherit;">检查行：56，48。xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769'buff</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + recvsz'表达式中的'buff'指针可以为nullptr。</font><font style="vertical-align: inherit;">在这种情况下，结果值将毫无意义，因此不应使用。</font><font style="vertical-align: inherit;">检查行：61，​​48。xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
buf指针使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初始化</font><font style="vertical-align: inherit;">，然后其值用于初始化其他指针。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">可以返回空指针，应始终检查该指针。似乎这是一个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">断言</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是否为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><i><font style="vertical-align: inherit;">断言</font></i><font style="vertical-align: inherit;">，并且一切正常。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但不是！事实是使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行调试，并且在Release配置中构建项目时，该</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将被删除。事实证明，在Debug中工作时，程序将正确运行，而在Release中进行构建时，空指针将进一步“运行”。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空值</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算术运算中的错误是不正确的，因为这样的运算结果将毫无意义，并且无法使用这种结果。</font><font style="vertical-align: inherit;">这就是分析仪警告我们的内容。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有人可能会争辩说，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之后不检查指针</font><font style="vertical-align: inherit;">是无所畏惧的。</font><font style="vertical-align: inherit;">就像，在第一次由空指针访问时，将发生信号/异常，并且不会有任何错误。</font><font style="vertical-align: inherit;">在实践中，一切都更加复杂，如果缺少验证对您而言似乎并不危险，我建议您看一下文章“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么检查malloc函数返回什么很重要</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组处理不正确</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下错误与上一个示例非常相似：</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用“ offt”索引后，将对其进行检查。</font><font style="vertical-align: inherit;">程序逻辑中可能有一个错误。</font><font style="vertical-align: inherit;">fat_common.c 1813 </font><font style="vertical-align: inherit;">首先在索引操作中使用</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后才检查其值是否大于零。</font><font style="vertical-align: inherit;">但是，如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变成空字符串</font><font style="vertical-align: inherit;">，会发生什么</font><font style="vertical-align: inherit;">？</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后在腿部大声射击。</font><font style="vertical-align: inherit;">该程序将以负索引访问，这将导致未定义的行为。</font><font style="vertical-align: inherit;">任何事情都可能发生，包括程序崩溃。</font><font style="vertical-align: inherit;">乱！</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="图片1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可疑情况</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有他们的地方呢？</font><font style="vertical-align: inherit;">从字面上看，我们在检查的每个项目中都会发现此类错误。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑检查状况。 “ |”的“ 0x0010”参数按位运算包含一个非零值。 index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要了解错误所在，请查看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常量的定义</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，在表达式中，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">按位“或”右边的</font><i><font style="vertical-align: inherit;">if（cloexec | FD_CLOEXEC）</font></i><font style="vertical-align: inherit;">始终存在一个非零常数。</font><font style="vertical-align: inherit;">这样的运算结果将始终为非零数。</font><font style="vertical-align: inherit;">因此，此表达式将始终等同于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if（true）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式</font><font style="vertical-align: inherit;">，并且我们将始终仅处理if-expression的then分支。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我怀疑此宏常量用于预配置Embox操作系统，但是即使这样，始终为true的条件看起来还是很奇怪。</font><font style="vertical-align: inherit;">也许他们想在这里使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＆</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font><font style="vertical-align: inherit;">，但是他们打错了字。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数除法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下错误与C语言的一项功能有关：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">：</font></b><font style="vertical-align: inherit;"> V636'1024 / dev_bsize'表达式已从'int'类型隐式转换为'float'类型。考虑使用显式类型转换以避免丢失小数部分。例如：double A =（double）（X）/ Y;。 ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此功能如下：如果我们将两个整数值相除，则相除的结果将为整数。因此，将进行除法运算而没有余数，换句话说，将从除法结果中舍弃小数部分。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有时程序员会忘记它，并且会出现这样的错误。 SBSIZE常量和变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有整数类型（分别为int和size_t）。因此，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SBSIZE / dev_bsize表达式的结果</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也将是整数类型。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但请稍等。</font><font style="vertical-align: inherit;">变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的类型为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font><font style="vertical-align: inherit;">显然，程序员希望得到分数除法结果。</font><font style="vertical-align: inherit;">如果您注意此变量的进一步使用，则可以进一步验证。</font><font style="vertical-align: inherit;">例如，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">（其中</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为第三个参数传递）具有以下签名：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
类似地，在其他</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量的地方</font><font style="vertical-align: inherit;">：一切都表明需要浮点数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要更正此错误，仅将除法操作数之一转换为实型就足够了。</font><font style="vertical-align: inherit;">例如：</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后除法的结果将是一个分数。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未验证的输入</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下错误与使用从程序外部接收的未经验证的数据有关。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">索引“ strlen（＆text [0]）”中使用了未经检查的污染数据。</font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，考虑</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数返回什么</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果成功读取一行，该函数将返回指向该行的指针。</font><font style="vertical-align: inherit;">如果在读取</font><font style="vertical-align: inherit;">至少一个元素之前</font><font style="vertical-align: inherit;">读取遇到</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件结尾</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，或者发生输入错误，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此表达式为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets（....）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查收到的输入是否正确。但是有一个警告。如果将空终端作为要读取的第一个字符进行传输（例如，可以通过在Windows命令行的Legacy模式下按Ctrl + 2来完成），则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">将其视为不返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在这种情况下，要进行记录的行将只有一个元素-' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来会发生什么？表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen（＆text [0]）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。结果，我们得到一个负索引调用：</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，我们可以通过简单地将行终止符传递给输入来“翻转”程序。</font><font style="vertical-align: inherit;">这很尴尬，可能会被用来攻击使用Embox的系统。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正在开发此诊断规则的我的同事甚至以NcFTP项目受到这种攻击的示例作了记录：</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我建议您看看您是否仍然不相信这样的机会：）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，分析仪还发现了另外两个具有相同错误的地方：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010未检查的污染数据用于索引：“ strlen（＆from [0]）”。</font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010未检查的污染数据用于索引：“ strlen（＆到[0]）”。</font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">米斯拉</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA是用于为高度负责的嵌入式系统编写安全的C和C ++代码的一组准则和准则。</font><font style="vertical-align: inherit;">从某种意义上讲，这是一本培训手册，在此手册之后，您不仅可以摆脱所谓的“代码异味”，而且还可以保护程序免受漏洞侵害。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA用于医疗，汽车，飞机和军工行业中人们生活取决于嵌入式系统质量的场合。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio具有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">广泛的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">诊断规则，使您可以检查代码是否符合MISRA C和MISRA C ++标准。</font><font style="vertical-align: inherit;">默认情况下，具有这些诊断的模式是关闭的，但是由于我们正在寻找嵌入式系统项目中的错误，因此没有MISRA我无能为力。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是我设法找到的：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6]本地阵列'namebuf'的地址不应存储在该阵列范围之外。 ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析仪检测到可疑的分配，有可能导致不确定的行为。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们仔细看一下代码。在这里，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是在函数的本地范围内创建的数组，并且</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指针</font><font style="vertical-align: inherit;">通过</font><font style="vertical-align: inherit;">指针</font><font style="vertical-align: inherit;">传递给函数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据C语法，数组的名称是指向存储该数组的存储区中第一个元素的指针。事实证明，表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf会将</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的地址分配给</font><i><font style="vertical-align: inherit;">cp</font></i><font style="vertical-align: inherit;">指向的变量</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。由于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp是</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过指针传递给函数的，因此它指向的值的更改将反映在调用函数的位置。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><i><font style="vertical-align: inherit;">完成</font></i><font style="vertical-align: inherit;">其工作之后，其第三个参数将指示</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组曾经占据的区域</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
只有一个“但是”：由于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是在堆栈上保留的数组，因此在函数退出时将被删除。因此，存在于函数外部的指针将指向已释放的内存。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该地址将是什么？</font><font style="vertical-align: inherit;">无法预测。</font><font style="vertical-align: inherit;">一段时间后，阵列的内容可能会继续保留在内存中，或者程序可能会立即使用其他内容立即擦除该区域。</font><font style="vertical-align: inherit;">通常，访问此类地址将返回未定义的值，并且使用此类值是严重错误。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析仪还发现了另一个警告相同的错误：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6]本地变量'dst_haddr'的地址不应存储在该变量范围之外。</font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="图6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我喜欢与Embox项目一起工作。尽管我没有写出本文中发现的所有错误，但警告的总数却相对较少，并且总的来说，项目代码的编写质量很高。因此，我对开发人员以及代表社区为该项目做出贡献的开发人员表示感谢。你很棒！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我借此机会向图拉的开发人员致以问候。我会相信在圣彼得堡现在还不是很冷：) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是我的文章结束的地方。我希望您喜欢阅读它，并为自己找到了一些新东西。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您对PVS-Studio感兴趣，并想独立验证使用它的某些项目，请</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下载并尝试</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。这将不超过15分钟。</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您想与讲英语的读者分享本文，请使用翻译链接：George Gribkov。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于再次嵌入：在Embox项目中搜索错误</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499970/index.html">我们研究了Mediastreamer2 VoIP引擎。第12部分</a></li>
<li><a href="../zh-CN499972/index.html">可能在线事件摘要</a></li>
<li><a href="../zh-CN499974/index.html">Instagram Javascript或香肠飞行路线上的3D游戏</a></li>
<li><a href="../zh-CN499978/index.html">安德鲁·安（Andrew Un）的书《机器学习的激情》第36和37章的翻译</a></li>
<li><a href="../zh-CN499982/index.html">初学者测试计划：从“输入IT”到“我是工程师！”</a></li>
<li><a href="../zh-CN499988/index.html">糖和COVID-19</a></li>
<li><a href="../zh-CN499990/index.html">地理编码 如何在10分钟内将25万个地址绑定到坐标？</a></li>
<li><a href="../zh-CN499992/index.html">为企业客户实施计费系统的设计技术（第2部分）</a></li>
<li><a href="../zh-CN499994/index.html">冠状病毒何时结束</a></li>
<li><a href="../zh-CN500000/index.html">到广播日。沟通-战争的神经</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>