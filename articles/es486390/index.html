<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ú¥Ô∏è üê° üíÖüèª Wright en las sombras üë©‚Äçüè´ üê§ üöï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es una historia sobre una de las tareas que preparamos para la etapa de calificaci√≥n CTFZone , que se realiz√≥ a fines de noviembre. Puede leer so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wright en las sombras</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/bizone/blog/486390/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta es una historia sobre una de las tareas que preparamos para la etapa de calificaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTFZone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se realiz√≥ a fines de noviembre. Puede leer sobre el proceso de preparaci√≥n de calificaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comienza con dos archivos: decrypt_flag.py y ntfs_volume.raw. Echemos un vistazo al gui√≥n. Abre un archivo llamado key.bin, y luego, usando un bucle, intenta tomar una cadena binaria de 34 bytes de cada desplazamiento dentro del archivo, que luego se usa como entrada para la funci√≥n PBKDF2. Cada clave devuelta se usa como una clave XOR para descifrar la cadena cifrada cosida en el c√≥digo. Si su hash MD5 descifrado coincide con el valor predeterminado en una forma descifrada, el script usa los datos recibidos para generar e imprimir la bandera.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces necesita encontrar el archivo key.bin. </font><font style="vertical-align: inherit;">Es imposible simplemente ordenar todos los desplazamientos dentro del archivo de imagen (ntfs_volume.raw), ya que el proceso de encontrar la clave ser√° demasiado lento. </font><font style="vertical-align: inherit;">Las reglas no lo proh√≠ben, pero ciertamente no tendr√° tiempo antes del final del CTF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo de imagen contiene una tabla de partici√≥n MBR de partici√≥n √∫nica. </font><font style="vertical-align: inherit;">Su desplazamiento es 2048 sectores de 512 bytes, y contiene el sistema de archivos NTFS, pero el archivo key.bin no est√° all√≠:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fls -o 2048 -r -p ntfs_volume.raw | grep -F key.bin | wc ‚Äìl<font></font>
0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTFS almacena nombres de archivos codificados UTF-16LE. </font><font style="vertical-align: inherit;">¬°Intentemos buscar en √©l!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/c4/9n/5g/c49n5g_kmk7j-ga2zo5nzthtad0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultados de b√∫squeda para registros de archivos</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Despu√©s de estudiar los resultados de b√∫squeda, nos centramos en los registros de archivos que comienzan con la firma FILE [1]. </font><font style="vertical-align: inherit;">Aqu√≠ est√° la √∫nica entrada de este tipo:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/-x/id/wv-xid-sp4valyl_kmqxj9e2o5s.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registro encontrado ¬°</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
El objetivo ya est√° cerca! Tenemos un registro de archivo, pero necesitamos datos. En NTFS, se almacenan en el atributo $ DATA, que puede ser residente o no residente [2]. Para el registro que encontramos, este atributo comienza en el desplazamiento 0 √ó 3AADD00 e indica datos no residentes (esto significa que la informaci√≥n se almacena fuera del registro del archivo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, ¬ød√≥nde est√°n exactamente los datos del archivo deseado? Para responder a esta pregunta, es necesario decodificar los llamados pares de mapeo, o corridas de datos (pares "longitud de bloque - desplazamiento de bloque") [3]. Las ejecuciones de datos del archivo deseado son las siguientes (tenga en cuenta el desplazamiento 0 √ó 3AADD40): 22 53 01 A0 4E 21 05 31 C1 11 38 30 00. O, si los reorganizamos:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.	22 53 01 A0 4E<font></font>
2.	21 05 31 C1<font></font>
3.	11 38 30 00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo consta de tres fragmentos, el tama√±o del primero de los cuales es de 339 grupos, y comienza con el grupo # 20128. Para nuestro c√≥digo que usa PBKDF2, este fragmento es grande. Como se indica en el encabezado del sistema de archivos, el tama√±o de un cl√∫ster es de 4096 bytes:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fsstat -o 2048 ntfs_volume.raw | grep 'Cluster Size'<font></font>
Cluster Size: 4096</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo a los datos para este desplazamiento (en bytes): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 4096 = 83492864. Extraeremos cualquier cantidad significativa de informaci√≥n (por ejemplo, 128 bytes) desde aqu√≠, ins√©rtela en un nuevo archivo, que llamaremos key.bin, ejecute el script ... Nada tuvo √©xito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiz√°s el archivo no estaba almacenado en la versi√≥n actual, sino en la versi√≥n anterior del sistema de archivos (formato anterior); no olvide que no vimos el registro sobre el archivo eliminado con el mismo nombre. ¬øCu√°l era el tama√±o del cl√∫ster antes? Busquemos el encabezado del sistema de archivos con la firma NTFS [4]. Tal vez tengamos suerte y realmente encontremos el encabezado del formato anterior.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s3/mp/na/s3mpnalay_jhx-yvaytbqgp4qta.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultados de b√∫squeda para el encabezado del sistema de archivos</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Las primeras y √∫ltimas posiciones en los resultados de </font><i><font style="vertical-align: inherit;">b√∫squeda</font></i><font style="vertical-align: inherit;"> se refieren al sistema de archivos actual, pero los encabezados del sistema de archivos ubicados entre ellos parecen pertenecer al formato anterior. ¬°Y tienen un tama√±o de racimo diferente!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/co/hb/locohbcqzrc6_etzqfxfnb1tusk.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El encabezado del sistema de archivos de la versi√≥n anterior.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tal tama√±o de sector se escribe en un desplazamiento de 0 √ó 4554800B: 00 02 o 512. Pero dicho tama√±o de cl√∫ster se registra en un desplazamiento de 0 √ó 0x4554800D: F7 o 247. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, tenemos el tama√±o de cl√∫ster (en bytes) 512 * 247 = 126464. ¬°Alg√∫n tipo de tonter√≠a! Si cree que el analizador NTFS [5], dicho valor debe tener un signo y procesarse de manera especial, por lo que el tama√±o real del cl√∫ster (en sectores) es 1 &lt;&lt; - (- 9) = 512. O, si est√° en bytes, 512 * 512 = 262144 Ahora suena m√°s cre√≠ble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los datos comienzan aqu√≠ en este desplazamiento (en bytes): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 262144 = 5277483008. Intentemos nuevamente hacer el mismo truco con la informaci√≥n almacenada all√≠ ... ¬°De nuevo, un error! ¬øQu√© est√° mal? Tenemos CTF aqu√≠, significa "no tan" que cualquier cosa puede ser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea por la que estamos luchando se llama In the Shadows. </font><font style="vertical-align: inherit;">Es posible que tenga algo que ver con las instant√°neas del volumen. </font><font style="vertical-align: inherit;">Entonces, tenemos un archivo del sistema de archivos que anteriormente exist√≠a en este volumen. </font><font style="vertical-align: inherit;">Desafortunadamente, simplemente no podemos tomar y montar su instant√°nea, ¬°pero sabemos el desplazamiento exacto en el que comienzan los datos! </font><font style="vertical-align: inherit;">Esto es 5277483008 o, dentro de la secci√≥n, 5277483008 - 2048 * 512 = 5276434432. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acuerdo con las especificaciones del formato VSS [6], los bloques de datos redirigidos se describen en la estructura del descriptor de bloques que contiene un campo de 64 bits en el que se almacena el desplazamiento original (dentro del volumen), y Tambi√©n un campo de 64 bits que describe el desplazamiento del bloque de destino (dentro del volumen). </font><font style="vertical-align: inherit;">Busquemos 5276434432 como un peque√±o n√∫mero endian de 64 bits.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay dos resultados en los resultados, y solo uno de ellos se encuentra en un desplazamiento uniforme.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y6/bo/dm/y6bodmvczyemr2uu-2m7giaukqw.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descriptor de bloque encontrado</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Desplazamiento de </font><i><font style="vertical-align: inherit;">bloque de</font></i><font style="vertical-align: inherit;"> destino: 00 00 9B 03 00 00 00 00, o simplemente 60489728. Desplazamiento final: 60489728 + 2048 * 512 = 61538304. Desde aqu√≠, exporta una cierta cantidad de datos a un nuevo archivo llamado key.bin, y ...</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./decrypt_flag.py<font></font>
ctfzone{my_c0ngr4t5_t0_u,w311_d0n3_31337}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Hecho!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/file_record.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/attributes/data.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/data_runs.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/files/boot.html</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/msuhanov/dfir_ntfs/blob/94bb46d6600153071b0c3c507ef37c42ad62110d/dfir_ntfs/BootSector.py#L58</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/libyal/libvshadow/blob/master/documentation/Volume%20Shadow%20Snapshot%20(VSS)%20format.asciidoc#431-block-descriptor</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486390/">https://habr.com/ru/post/es486390/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486376/index.html">C√≥mo los dise√±adores de niveles usan la teor√≠a de la arquitectura para crear niveles de juego</a></li>
<li><a href="../es486378/index.html">El servidor dom√©stico alimentado por energ√≠a solar funcion√≥ durante 15 meses: tiempo de actividad del 95,26%</a></li>
<li><a href="../es486380/index.html">Lo que un gerente de producto deber√≠a hacer en realidad</a></li>
<li><a href="../es486382/index.html">Sellos y Scrum</a></li>
<li><a href="../es486388/index.html">Descripci√≥n general del proyecto MyVPN Open Source Nonprofit</a></li>
<li><a href="../es486392/index.html">Una breve comparaci√≥n de la arquitectura SDS o encontrar una plataforma de almacenamiento adecuada (GlusterVsCephVsVirtuozzoStorage)</a></li>
<li><a href="../es486394/index.html">Marcadores: ¬øhay un l√≠mite?</a></li>
<li><a href="../es486396/index.html">React Native: nuevo hito en el desarrollo m√≥vil de Shopify</a></li>
<li><a href="../es486400/index.html">Para obtener sus datos personales, debe proporcionar a√∫n m√°s datos personales.</a></li>
<li><a href="../es486402/index.html">Muerte de respaldo: nuevas amenazas y nueva protecci√≥n para la Global Cyber ‚Äã‚ÄãSummit 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>