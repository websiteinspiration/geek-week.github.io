<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜë üëßüèΩ üç≥ C√≥mo est√° organizado el sistema de contenido de las p√°ginas Turbo: esquemas, hechos y un poco de historia üèì üëáüèæ üê≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seg√∫n TelecomDaily , casi el 30% de los usuarios de Internet m√≥vil en Rusia diariamente tienen problemas para descargar sitios. Sin embargo, la raz√≥n ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥mo est√° organizado el sistema de contenido de las p√°ginas Turbo: esquemas, hechos y un poco de historia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494824/"><img src="https://habrastorage.org/webt/hq/a5/mv/hqa5mvtylx0m3ns_yixifxt1qw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelecomDaily</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , casi el 30% de los usuarios de Internet m√≥vil en Rusia diariamente tienen problemas para descargar sitios. Sin embargo, la raz√≥n puede estar no solo en una cobertura desigual, sino tambi√©n en demasiado "peso" de la p√°gina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No podemos influir en la calidad de la conexi√≥n, pero para ayudar a los webmasters a simplificar el contenido del sitio, hacerlo m√°s f√°cil, ¬øpor qu√© no? Entonces, la tecnolog√≠a de las p√°ginas Turbo apareci√≥ en Yandex: nuestro sistema de contenido pasa todo lo necesario para su colocaci√≥n, y convierte estos datos en materiales f√°ciles y r√°pidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo funciona esta magia? ¬øCu√°l es la ruta de datos antes de convertirse en una p√°gina Turbo completa? Mi nombre es Stas Makeev, lidero el desarrollo de la tecnolog√≠a de las p√°ginas Turbo. Ahora intentar√© explicar todo.</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero primero, es un resumen para que no te pierdas cuando empiezo a profundizar en los detalles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una ventaja clave del sistema de p√°ginas Turbo es la conversi√≥n r√°pida de datos del formulario original al final: los materiales de los sitios de noticias son los m√°s solicitados en los primeros minutos despu√©s de la publicaci√≥n, y las tarjetas de los productos de las tiendas en l√≠nea deben actualizarse r√°pidamente y corresponder siempre al estado actual de disponibilidad. El segundo par√°metro importante es la fiabilidad: el sistema de contenido debe ser lo m√°s estable posible, ser capaz de sobrevivir al colapso de servidores individuales o incluso de centros de datos completos. Y, por supuesto, era importante evitar una carga excesiva en los hosts de nuestros socios conectados a las p√°ginas de Turbo. Es decir, al dise√±ar el servicio, era necesario encontrar de alg√∫n modo un equilibrio entre la velocidad del procesamiento de datos y el aumento en el n√∫mero de solicitudes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los propietarios del sitio tienen varias formas de conectarse al sistema:</font></font><br>
<br>
<ul>
<li>  . : YML ‚Äî  -, RSS ‚Äì   ;</li>
<li>   API:          (    );</li>
<li> : -       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema de contenido almacena los resultados de su trabajo en un almacenamiento especial del tipo "clave-valor" (clave-valor-almacenamiento o KV-almacenamiento), donde la clave es la URL del sitio original, y el valor almacena el contenido de la p√°gina Turbo. </font><font style="vertical-align: inherit;">Tan pronto como los datos caigan en este almacenamiento KV, la siguiente p√°gina de Turbo estar√° inmediatamente disponible para los usuarios de b√∫squeda, y en los servicios de Yandex el documento correspondiente tiene un icono especial con un cohete. </font><font style="vertical-align: inherit;">Adem√°s, para acelerar el trabajo, almacenamos en cach√© im√°genes y videos en nuestros CDN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un esquema general de trabajo muy simplificado se ve as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/mq/u5/aomqu5polx3u8fse71spyit1eam.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo todo empez√≥</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera versi√≥n del sistema de contenido se organiz√≥ de manera bastante simple: cada pocos minutos, de acuerdo con el cronograma, se lanzaba el mismo programa en el servidor interno de la nube Yandex. </font><font style="vertical-align: inherit;">Consisti√≥ en varios pasos, cada siguiente ejecuci√≥n despu√©s de que los datos anteriores estuvieran listos para todos los feeds que conocemos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se descarg√≥ la lista de fuentes RSS, se lanz√≥ el analizador de documentos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se extrajo una lista de im√°genes de los resultados del analizador;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">las im√°genes no almacenadas en cach√© se cargaron en el CDN todav√≠a;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los documentos procesados ‚Äã‚Äãse vertieron en el repositorio de KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal esquema funcion√≥ perfectamente cuando el sistema manej√≥ varios miles de fuentes RSS de agencias de noticias (en total, informaci√≥n sobre un poco menos de 100,000 documentos). Pero con el aumento en el n√∫mero de alimentaciones, se descubri√≥ r√°pidamente un problema: cada paso tom√≥ m√°s y m√°s tiempo, aument√≥ el retraso entre la aparici√≥n de un nuevo documento en la fuente original y su visualizaci√≥n en modo Turbo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logramos mantener la situaci√≥n bajo control con la ayuda de varios trucos: en primer lugar, seleccionamos el primer paso (descargar fuentes RSS + un analizador de documentos) en un proceso separado. Es decir, mientras uno procesaba im√°genes para la iteraci√≥n anterior, el otro proceso ya descargaba feeds para la siguiente. Despu√©s de un tiempo, qued√≥ claro: de esta forma, el sistema es muy dif√≠cil de escalar. Necesitamos algo fundamentalmente nuevo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesamiento de RSS, API y YML en el nuevo sistema de contenido</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El principal problema del antiguo sistema de contenido era que todos los datos se procesaban en una sola pieza: no hab√≠a transici√≥n al siguiente paso hasta que cada documento pasara el anterior. </font><font style="vertical-align: inherit;">Para deshacerse de esto, se decidi√≥ construir una cierta tuber√≠a: dejar que los feeds y los documentos individuales se procesen de la manera m√°s independiente posible. </font><font style="vertical-align: inherit;">Todos los pasos se separaron en cubos de servicio separados: en el nivel superior, el esquema result√≥ as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g6/lp/xd/g6lpxdauqtwxm9alh-mrgyf_wro.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el primer cubo descarga canales RSS y pasa;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el segundo: toma los feeds uno por uno, analiza el contenido. </font><font style="vertical-align: inherit;">A la salida: documentos separados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el tercero: toma documentos de uno en uno, procesa im√°genes y videos, graba todo en el almacenamiento KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los mismos feeds se pueden registrar no solo en Turbo, sino tambi√©n en nuestros otros servicios, por ejemplo, en las Noticias o en el Mercado. Si cada uno de ellos descarga datos por s√≠ solo, la carga en el servidor webmasters ser√° varias veces mayor que la permitida. ¬øCu√°nta raz√≥n? Descargue el feed una vez y luego distribuya el contenido a todos los servicios al consumidor: Yandex.Robot hace esto. Utilizamos sus servicios para descargar contenido: tomamos de Yandex.Webmaster una lista de fuentes RSS y YML registradas en Turbo, la transfieren a Robot y se suscriben a los resultados de la descarga.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los datos recibidos, inicie el analizador. Por si acaso, perm√≠tame recordarle: una fuente RSS es solo un archivo en el formato ".XML", accesible mediante una URL est√°tica en el host del socio. Este archivo contiene informaci√≥n sobre todas las actualizaciones en el sitio: qu√© documentos son nuevos y cu√°les se modifican. Solo la informaci√≥n m√°s actualizada en las √∫ltimas horas estar√≠a en las fuentes ideales: no m√°s de 100 documentos por varios cientos de kilobytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mordiscos de realidad: a veces los archivos est√°n dentro del feed durante mucho tiempo y nunca cambian. ¬øC√≥mo evitar el reprocesamiento en tales casos? Calculamos el hash de cada documento, lo almacenamos en la base de datos y no hacemos nada hasta que el hash cambie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Procesar feeds YML y API desde el punto de vista del sistema de contenido pr√°cticamente no es diferente de interactuar con RSS: para YML, iniciamos otro analizador, y los datos transmitidos a trav√©s de la API se obtienen directamente de Yandex.Webmaster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/hh/gz/rehhgz4wtfo8nqylaexh74z5dga.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesamiento de imagen y video</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El documento que se recibe en la salida del analizador est√° casi listo para escribir en el almacenamiento KV. </font><font style="vertical-align: inherit;">Lo √∫nico que queda por hacer antes de enviar es procesar las im√°genes y videos: almacenar en cach√© en el CDN y reemplazar los enlaces en el documento. </font><font style="vertical-align: inherit;">Aqu√≠ nuevamente recurrimos al Robot en busca de ayuda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, verificamos cada imagen y video: ¬øest√°n en la CDN? </font><font style="vertical-align: inherit;">Si todo ya est√° en cach√©, reemplace los enlaces y env√≠e el documento actualizado al repositorio de KV. </font><font style="vertical-align: inherit;">De otra manera:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enviamos la lista de URL faltantes al Robot para su planificaci√≥n y descarga;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el documento en s√≠ est√° en almacenamiento temporal, as√≠ que despu√©s de un tiempo intente verificarlo nuevamente.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este momento, otro cubo recibe los resultados de la descarga, carga los datos en el CDN y actualiza la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En dicho esquema, se puede resolver otro problema importante relacionado con la planificaci√≥n: el robot comprende qu√© tan r√°pido es posible descargar datos de diferentes hosts y no permite sobrecargas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2n/g4/oz/2ng4oz6c5ocn3jjbld4armtcewk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ruta t√≠pica que sigue un nuevo documento:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El documento aparece en el feed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El robot descarga la alimentaci√≥n;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el analizador descubre un nuevo documento y lo env√≠a m√°s lejos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comprobamos que las im√°genes del documento no se mencionan en la base de datos, ordenamos la descarga, el documento se env√≠a al almacenamiento temporal (Retraso). </font><font style="vertical-align: inherit;">Mientras el documento est√° all√≠, el Robot descarga las im√°genes, se almacenan en cach√© en la CDN y los enlaces aparecen en la base de datos;</font></font></li>
<li>       ,    CDN,      KV-. </li>
<li> :    ,       Delay.</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay otra forma de conectarse a las p√°ginas de Turbo, para lo cual el webmaster no necesita hacer nada: Autoparser. </font><font style="vertical-align: inherit;">Construye p√°ginas Turbo basadas en los datos de origen del sitio de contenido. </font><font style="vertical-align: inherit;">Puede conectarse, ver ejemplos de p√°ginas terminadas, configurar anuncios y an√°lisis en Yandex.Webmaster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La principal dificultad que enfrenta AutoParser es reconocer mediante el marcado HTML qu√© informaci√≥n b√°sica se debe usar al crear una p√°gina Turbo. </font><font style="vertical-align: inherit;">Para hacer esto, tenemos varios procesos fuera de l√≠nea que intentan comprender exactamente c√≥mo analizar un host espec√≠fico. </font><font style="vertical-align: inherit;">Me centrar√© en dos principales:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primero</font></font></b>     RSS-    HTML-  .  ‚Äî    ,       RSS- (    ),   .   ,    .        CatBoost  ,   ,      .     ,          , , .  ,          .  ,     ,  ,        HTML     . ?  :     .  ‚Äì    ,    .</li>
<li><b></b>   :            ..  ,    ,   ,          ,   ‚Äî  .       ‚Äî   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, un obst√°culo m√°s frecuente: muchos sitios bloquean la capacidad de descargar im√°genes de robots en robots.txt. Desafortunadamente, es imposible solucionar este problema, y ‚Äã‚Äãel Autoparser no est√° disponible para tales p√°ginas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el esquema completo del sistema de contenido se ve as√≠: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ll/jx/-a/lljx-adtt8ykngcnfnutykobxr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema result√≥ ser bien escalable: ahora se usa una cantidad significativa de recursos para dar servicio a la base de datos, el autoparser y otros componentes del sistema (solo el cubo responsable de analizar RSS, YML y API usa m√°s de 300 procesadores n√∫cleos), y en caso de aumento de la carga, no ser√° demasiado dif√≠cil conectar capacidades adicionales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Gracias por leer hasta el final! Espero que, despu√©s de este material, en el trabajo de las p√°ginas Turbo obtengas m√°s l√≥gica y menos magia (por cierto, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Incluso m√°s detalles sobre las p√°ginas Turbo). </font><font style="vertical-align: inherit;">Si algo sigue siendo incomprensible, escribe en los comentarios, estamos en contacto.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es494808/index.html">Analista de producto: qu√© hace, cu√°nto gana, qu√© beneficios aporta el negocio</a></li>
<li><a href="../es494810/index.html">Introducci√≥n a 3D: conceptos b√°sicos de Three.js</a></li>
<li><a href="../es494814/index.html">¬øEs √∫til Slurm?</a></li>
<li><a href="../es494818/index.html">C√≥mo elegir un terminal comercial para trabajar en el intercambio</a></li>
<li><a href="../es494820/index.html">C√≥mo la especificaci√≥n de la fuente de alimentaci√≥n ATX12VO de Intel cambiar√° el futuro</a></li>
<li><a href="../es494826/index.html">Ser "nuevo" o no ser ...</a></li>
<li><a href="../es494830/index.html">ViennaNET: un conjunto de bibliotecas para el backend</a></li>
<li><a href="../es494838/index.html">M√≥dems GSM / 3G / 4G en sistemas integrados que utilizan el m√≥dem Quectel EC21 LTE y Yocto Project como ejemplo</a></li>
<li><a href="../es494848/index.html">15 mujeres que han hecho una gran contribuci√≥n a la astronom√≠a</a></li>
<li><a href="../es494850/index.html">Configure Microsoft Windows Server 2016/2019 para proporcionar servicios DHCP para VXLAN (DFA)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>