<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèø üéÖ üßùüèª Una gu√≠a pr√°ctica para lidiar con p√©rdidas de memoria en Node.js üìû üåî ü§≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las p√©rdidas de memoria son similares a las entidades par√°sitas en una aplicaci√≥n. Penetran silenciosamente en el sistema, al principio sin causar nin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Una gu√≠a pr√°ctica para lidiar con p√©rdidas de memoria en Node.js</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/495898/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las p√©rdidas de memoria son similares a las entidades par√°sitas en una aplicaci√≥n. </font><font style="vertical-align: inherit;">Penetran silenciosamente en el sistema, al principio sin causar ning√∫n da√±o. </font><font style="vertical-align: inherit;">Pero si la fuga resulta ser lo suficientemente fuerte, puede llevar la aplicaci√≥n al desastre. </font><font style="vertical-align: inherit;">Por ejemplo, para reducir la velocidad fuertemente o simplemente para "matarlo". </font><font style="vertical-align: inherit;">
El autor del art√≠culo, cuya traducci√≥n publicamos hoy, sugiere hablar sobre p√©rdidas de memoria en JavaScript. </font><font style="vertical-align: inherit;">En particular, hablaremos sobre la administraci√≥n de memoria en JavaScript, c√≥mo identificar p√©rdidas de memoria en aplicaciones reales y c√≥mo lidiar con p√©rdidas de memoria.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ut/sj/t-/utsjt-d80r9mqkvrexbbkws-eae.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© es una p√©rdida de memoria?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una p√©rdida de memoria es, en un sentido amplio, una pieza de memoria asignada a una aplicaci√≥n que esta aplicaci√≥n ya no necesita, pero que no puede devolverse al sistema operativo para su uso futuro. </font><font style="vertical-align: inherit;">En otras palabras, es un bloque de memoria que es capturado por la aplicaci√≥n sin la intenci√≥n de usar esta memoria en el futuro.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesti√≥n de la memoria</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La administraci√≥n de memoria es un mecanismo para asignar memoria del sistema a una aplicaci√≥n que la necesita, y un mecanismo para devolver memoria innecesaria al sistema operativo. </font><font style="vertical-align: inherit;">Hay muchos enfoques para la gesti√≥n de la memoria. </font><font style="vertical-align: inherit;">El enfoque utilizado depende del lenguaje de programaci√≥n utilizado. </font><font style="vertical-align: inherit;">Aqu√≠ hay una descripci√≥n general de varios enfoques comunes para la administraci√≥n de memoria:</font></font><br>
<br>
<ul>
<li>  .           .         .       ,    .        C  C++.   ,   ,   <code>malloc</code>  <code>free</code>,      .</li>
<li>   . ,      ,   ,       .   ,  ,    ,        . ,     ,  ,      ,   .         .  ‚Äî JavaScript, ,   JVM (Java, Scala, Kotlin), Golang, Python, Ruby  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n del concepto de propiedad de la memoria. </font><font style="vertical-align: inherit;">Con este enfoque, cada variable debe tener su propio propietario. </font><font style="vertical-align: inherit;">Tan pronto como el propietario est√° fuera del alcance, el valor en la variable se destruye, liberando memoria. </font><font style="vertical-align: inherit;">Esta idea se usa en Rust.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen otros enfoques para la administraci√≥n de memoria utilizados en diferentes lenguajes de programaci√≥n. </font><font style="vertical-align: inherit;">Por ejemplo, C ++ 11 usa el lenguaje </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAII</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mientras que Swift usa el mecanismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pero hablar de eso est√° m√°s all√° del alcance de este art√≠culo. </font><font style="vertical-align: inherit;">Para comparar los m√©todos anteriores de administraci√≥n de memoria, para comprender sus ventajas y desventajas, necesitamos un art√≠culo separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScript, un lenguaje sin el cual los programadores web no pueden imaginar su trabajo, utiliza la idea de recolecci√≥n de basura. </font><font style="vertical-align: inherit;">Por lo tanto, hablaremos m√°s sobre c√≥mo funciona este mecanismo.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recolecci√≥n de basura JavaScript</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ya se mencion√≥, JavaScript es un lenguaje que utiliza el concepto de recolecci√≥n de basura. </font><font style="vertical-align: inherit;">Durante la operaci√≥n de los programas JS, se lanza peri√≥dicamente un mecanismo llamado recolector de basura. </font><font style="vertical-align: inherit;">√âl descubre a qu√© partes de la memoria asignada se puede acceder desde el c√≥digo de la aplicaci√≥n. </font><font style="vertical-align: inherit;">Es decir, a qu√© variables se hace referencia. </font><font style="vertical-align: inherit;">Si el recolector de basura descubre que ya no se accede a un trozo de memoria desde el c√≥digo de la aplicaci√≥n, libera esta memoria. </font><font style="vertical-align: inherit;">El enfoque anterior se puede implementar utilizando dos algoritmos principales. </font><font style="vertical-align: inherit;">El primero es el llamado algoritmo Mark and Sweep. </font><font style="vertical-align: inherit;">Se usa en JavaScript. </font><font style="vertical-align: inherit;">El segundo es el recuento de referencias. </font><font style="vertical-align: inherit;">Se usa en Python y PHP.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3ee/8ac/c60/3ee8acc608afe85e6a4c6f202cb1e8fe.gif"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fases Mark (marcar) y Sweep (limpiar) del</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
algoritmo</font><i><font color="#999999"><font style="vertical-align: inherit;"> Mark and Sweep</font></font></i><font style="vertical-align: inherit;"> Al implementar el algoritmo de marcado,</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primero se crea</font><font style="vertical-align: inherit;">una lista de nodos ra√≠z representados por variables de entorno globales (este es un objeto en el navegador</font><font style="vertical-align: inherit;">), y luego el √°rbol resultante se rastrea de los nodos ra√≠z a hoja marcados con todos En el camino se encontraron objetos. </font><font style="vertical-align: inherit;">Se libera memoria en el mont√≥n que est√° ocupado por objetos sin etiquetar.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P√©rdidas de memoria en aplicaciones Node.js</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasta la fecha, hemos analizado suficientes conceptos te√≥ricos relacionados con fugas de memoria y recolecci√≥n de basura. </font><font style="vertical-align: inherit;">Entonces, estamos listos para ver c√≥mo se ve todo en aplicaciones reales. </font><font style="vertical-align: inherit;">En esta secci√≥n, escribiremos un servidor Node.js que tenga una p√©rdida de memoria. </font><font style="vertical-align: inherit;">Intentaremos identificar esta fuga utilizando varias herramientas y luego la eliminaremos.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Familiaridad con un c√≥digo que tiene una p√©rdida de memoria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fines de demostraci√≥n, escrib√≠ un servidor Express que tiene una ruta de p√©rdida de memoria. </font><font style="vertical-align: inherit;">Vamos a depurar este servidor.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Example app listening on port <span class="hljs-subst">${port}</span>!`</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay una matriz </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que est√° fuera del alcance del c√≥digo de procesamiento de solicitud de API. </font><font style="vertical-align: inherit;">Como resultado, cada vez que se ejecuta el c√≥digo correspondiente, simplemente se agregan nuevos elementos a la matriz. </font><font style="vertical-align: inherit;">La matriz nunca se borra. </font><font style="vertical-align: inherit;">Dado que el enlace a esta matriz no desaparece despu√©s de salir del controlador de solicitudes, el recolector de basura nunca libera la memoria que utiliza.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçP√©rdida de memoria de llamada</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ llegamos a lo m√°s interesante. Se han escrito muchos art√≠culos sobre c√≥mo, utilizando </font></font><code>node --inspect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, para depurar fugas de memoria del servidor, despu√©s de llenar el servidor con solicitudes utilizando algo como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artiller√≠a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pero este enfoque tiene un inconveniente importante. Imagine que tiene un servidor API que tiene miles de puntos finales. Cada uno de ellos toma muchos par√°metros, el c√≥digo particular que se llamar√° depende de las caracter√≠sticas de los cuales. Como resultado, en condiciones reales, si el desarrollador no sabe d√≥nde se encuentra la p√©rdida de memoria, tendr√° que acceder a cada API muchas veces utilizando todas las combinaciones posibles de par√°metros para llenar la memoria. En cuanto a m√≠, no es f√°cil hacerlo. La soluci√≥n a este problema, sin embargo, se facilita mediante el uso de algo como</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">goreplay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : un sistema que le permite grabar y "reproducir" el tr√°fico real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer frente a nuestro problema, vamos a depurar en producci√≥n. </font><font style="vertical-align: inherit;">Es decir, permitiremos que nuestro servidor desborde memoria durante su uso real (ya que recibe una variedad de solicitudes de API). </font><font style="vertical-align: inherit;">Y despu√©s de encontrar un aumento sospechoso en la cantidad de memoria asignada, realizaremos la depuraci√≥n.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Descarga del mont√≥n</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comprender qu√© es un volcado de almacenamiento din√°mico, primero necesitamos descubrir el significado del concepto de almacenamiento din√°mico. Si describe este concepto de la manera m√°s simple posible, resulta que el mont√≥n es el lugar donde cae todo lo que se asigna a la memoria. Todo esto est√° en el mont√≥n hasta que el recolector de basura elimine todo lo que se considere innecesario. Un volcado de almacenamiento din√°mico es una instant√°nea del estado actual del almacenamiento din√°mico. El volcado contiene todas las variables internas y variables declaradas por el programador. Representa toda la memoria asignada en el mont√≥n en el momento en que se recibi√≥ el volcado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, si pudi√©ramos comparar de alguna manera el volcado del mont√≥n del servidor que acaba de comenzar con el volcado del mont√≥n del servidor, que se ha estado ejecutando durante mucho tiempo y desbordando memoria, podr√≠amos identificar objetos sospechosos que la aplicaci√≥n no necesita, pero que el recolector de basura no elimina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de continuar la conversaci√≥n, hablemos sobre c√≥mo crear volcados de almacenamiento din√°mico. </font><font style="vertical-align: inherit;">Para resolver este problema, utilizaremos el paquete de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> din√°mico </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">npm</font></a><font style="vertical-align: inherit;"> , que le permite obtener mediante programaci√≥n un volcado del </font><font style="vertical-align: inherit;">almacenamiento </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">din√°mico</font></a><font style="vertical-align: inherit;"> del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instala el paquete:</font></font><br>
<br>
<pre><code class="bash hljs">npm i heapdump
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Haremos algunos cambios en el c√≥digo del servidor que nos permitir√°n usar este paquete:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> heapdump = <span class="hljs-built_in">require</span>(<span class="hljs-string">"heapdump"</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.get(<span class="hljs-string">'/heapdump'</span>, (req, res) =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDump-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a bloated server written to"</span>, filename);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">msg</span>: <span class="hljs-string">"successfully took a heap dump"</span>})<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDumpAtServerStart.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a fresh server written to"</span>, filename);<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ usamos este paquete para volcar un servidor reci√©n lanzado. </font><font style="vertical-align: inherit;">Tambi√©n creamos una API </font></font><code>/heapdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dise√±ada para crear un mont√≥n al acceder a ella. </font><font style="vertical-align: inherit;">Pasaremos a esta API en el momento en que nos demos cuenta de que el servidor comenz√≥ a consumir demasiada memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si su servidor se est√° ejecutando en un cl√∫ster de Kubernetes, no podr√°, sin esfuerzos adicionales, recurrir a ese mismo pod cuyo servidor se est√° ejecutando y que consume demasiada memoria. </font><font style="vertical-align: inherit;">Para hacer esto, puede usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reenv√≠o de puertos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Adem√°s, dado que no tendr√° acceso al sistema de archivos que necesita para descargar los archivos de volcado, ser√≠a mejor cargar estos archivos en el almacenamiento externo en la nube (como S3).</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Detecci√≥n de p√©rdida de memoria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora, el servidor est√° implementado. √âl ha estado trabajando por varios d√≠as. Recibe muchas solicitudes (en nuestro caso, solo solicitudes del mismo tipo) y prestamos atenci√≥n al aumento en la cantidad de memoria consumida por el servidor. Se puede detectar una p√©rdida de memoria utilizando herramientas de monitoreo como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express Status Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clinic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Despu√©s de eso, llamamos a la API para volcar el mont√≥n. Este volcado contendr√° todos los objetos que el recolector de basura no pudo eliminar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve la consulta para crear un volcado:</font></font><br>
<br>
<pre><code class="bash hljs">curl --location --request GET <span class="hljs-string">'http://localhost:3000/heapdump'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se crea un volcado de mont√≥n, el recolector de basura se ve obligado a ejecutarse. Como resultado, no necesitamos preocuparnos por aquellos objetos que el recolector de basura puede eliminar en el futuro, pero que todav√≠a est√°n en el mont√≥n. Es decir, sobre los objetos cuando se trabaja con los que no se producen p√©rdidas de memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de tener ambos volcados a nuestra disposici√≥n (un volcado de un servidor reci√©n lanzado y un volcado de un servidor que ha funcionado durante alg√∫n tiempo), podemos comenzar a compararlos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtener un volcado de memoria es una operaci√≥n de bloqueo que requiere mucha memoria para completarse. Por lo tanto, debe llevarse a cabo con precauci√≥n. Puede leer m√°s sobre los posibles problemas encontrados durante esta operaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicie Chrome y presione la tecla.</font></font><code>F12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto conducir√° al descubrimiento de herramientas para desarrolladores. </font><font style="vertical-align: inherit;">Aqu√≠ debe ir a la pesta√±a </font></font><code>Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y cargar ambas instant√°neas de memoria.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5c1/252/992/5c125299224be08bb5bb73f74842f0b8.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga de la memoria vuelca en la pesta√±a Memoria de las herramientas para desarrolladores de Chrome</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Despu√©s de descargar los dos instant√°neas, es necesario el cambio</font></font><code>perspective</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font><code>Comparison</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y haga clic en la instant√°nea de la memoria del servidor que trabaj√≥ durante alg√∫n tiempo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/7c7/224/a997c7224ac3d053651be9e848380e75.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comience a comparar instant√°neas</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aqu√≠ podemos analizar la columna</font></font><code>Constructor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y buscar objetos que el recolector de basura no pueda eliminar. </font><font style="vertical-align: inherit;">La mayor√≠a de estos objetos estar√°n representados por enlaces internos que usan los nodos. </font><font style="vertical-align: inherit;">Aqu√≠ es √∫til usar un truco, que consiste en ordenar la lista por campo</font></font><code>Alloc. Size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto encontrar√° r√°pidamente los objetos que usan m√°s memoria. </font><font style="vertical-align: inherit;">Si expande el bloque</font></font><code>(array)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego</font></font><code>(object elements)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puede ver una matriz que</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene una gran cantidad de objetos que no se pueden eliminar con el recolector de basura.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e85/02c/0a2/e8502c0a2dcd1cf635f229eaef8d9e90.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lisis de una matriz sospechosa</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Esta t√©cnica nos permitir√° ir a la matriz</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y comprender que es la operaci√≥n incorrecta con ella la que causa una p√©rdida de memoria.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçFija la p√©rdida de memoria</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que sabemos que el "culpable" es una matriz </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, podemos analizar el c√≥digo y descubrir que el problema es que la matriz se declara fuera del controlador de solicitudes. </font><font style="vertical-align: inherit;">Como resultado, resulta que el enlace a √©l nunca se elimina. </font><font style="vertical-align: inherit;">Para solucionar este problema es bastante simple: simplemente transfiera la declaraci√≥n de la matriz al controlador:</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar la efectividad de las medidas tomadas, es suficiente repetir los pasos anteriores y volver a comparar las im√°genes del mont√≥n.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las p√©rdidas de memoria ocurren en diferentes idiomas. </font><font style="vertical-align: inherit;">En particular, en aquellos que usan mecanismos de recolecci√≥n de basura. </font><font style="vertical-align: inherit;">Por ejemplo, en JavaScript. </font><font style="vertical-align: inherit;">Por lo general, no es dif√≠cil solucionar una fuga; las verdaderas dificultades surgen solo cuando la busca. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo, se familiariz√≥ con los conceptos b√°sicos de la administraci√≥n de memoria y c√≥mo se organiza la administraci√≥n de memoria en diferentes idiomas. </font><font style="vertical-align: inherit;">Aqu√≠ reproducimos un escenario real de una p√©rdida de memoria y describimos un m√©todo para la resoluci√≥n de problemas. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Queridos lectores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øHa encontrado p√©rdidas de memoria en sus proyectos web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495888/index.html">PyCon Russia ha abierto CFP para futuros oradores. Formularios de participaci√≥n y temas esperados</a></li>
<li><a href="../es495890/index.html">Configuraci√≥n de paquetes Nginx / LetsEncrypt en Docker Swarm</a></li>
<li><a href="../es495892/index.html">¬øRealmente sabes qu√© son las matrices?</a></li>
<li><a href="../es495894/index.html">Medici√≥n del rendimiento de Javascript</a></li>
<li><a href="../es495896/index.html">Paquete de uso de sonido: efectos de sonido en aplicaciones de reacci√≥n</a></li>
<li><a href="../es495902/index.html">CAPTCHA: matando la conversi√≥n</a></li>
<li><a href="../es495904/index.html">¬øSe puede predecir una epidemia?</a></li>
<li><a href="../es495908/index.html">El camino a la recompensa</a></li>
<li><a href="../es495910/index.html">Instalaci√≥n de ROS en una imagen IMG de placa √∫nica de Ubuntu</a></li>
<li><a href="../es495912/index.html">Pegatinas inteligentes de repetici√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>