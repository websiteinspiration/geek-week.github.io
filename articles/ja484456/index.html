<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐆 💆 🐷 ReactJS、サーバー側レンダリング、およびページメタタグの処理の微妙な点 👌🏼 👨🏾‍⚖️ 🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="サーバーサイドレンダリングアプリケーションを作成するときに解決しなければならない問題の1つは、すべてのページに必要なメタタグを処理することです。これは、検索エンジンによるインデックスの作成に役立ちます。
 
 グーグルから始めて、あなたが導かれる最初の解決策は、おそらくReact Helmetです。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ReactJS、サーバー側レンダリング、およびページメタタグの処理の微妙な点</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484456/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーサイドレンダリングアプリケーションを作成するときに解決しなければならない問題の1つは、すべてのページに必要なメタタグを処理することです。これは、検索エンジンによるインデックスの作成に役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グーグルから始めて、あなたが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">導か</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れる最初の解決策は、おそらく</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">React Helmet</font></a><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリの利点の1つは、同形と見なすことができ、クライアント側とサーバー側の両方で完全に使用できることです。</font></font><br>
<a name="habracut"></a><br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{<font></font>
   render() {<font></font>
       <span class="hljs-keyword">return</span> (
           <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
               <span class="hljs-tag">&lt;<span class="hljs-name">Helmet</span>&gt;</span>
                   <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Turbo Todo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
                   <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"#008f68"</span> /&gt;</span>
               <span class="hljs-tag">&lt;/<span class="hljs-name">Helmet</span>&gt;</span>
               {/* ... */}
           <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
       );<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーでは、ルーターは次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/*'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> html = renderToString(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
  <span class="hljs-keyword">const</span> helmet = Helmet.renderStatic();<font></font>
  res.send(<span class="hljs-string">`
     &lt;!doctype html&gt;
     &lt;html <span class="hljs-subst">${helmet.htmlAttributes.toString()}</span>&gt;
     &lt;head&gt;
       <span class="hljs-subst">${helmet.title.toString()}</span>
       <span class="hljs-subst">${helmet.meta.toString()}</span>
     &lt;/head&gt;
     &lt;body <span class="hljs-subst">${helmet.bodyAttributes.toString()}</span>&gt;
       &lt;div id="app"&gt;<span class="hljs-subst">${html}</span>&lt;/div&gt;
     &lt;/body&gt;
     &lt;/html&gt;
  `</span>);<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのスニペットはどちらも完全に正しく機能しますが、1つありますが、サーバーの上記のコードは完全に同期しているため完全に安全ですが、非同期になると、デバッグが難しいバグ自体が非表示になります。</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
   <span class="hljs-comment">// ....</span>
   <span class="hljs-keyword">await</span> anyAsyncAction();
   <span class="hljs-comment">//....</span>
   <span class="hljs-keyword">const</span> helmet = Helmet.renderStatic();
   <span class="hljs-comment">// ...</span><font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでの問題は主にReact Helmetライブラリ自体にあり、特に、React Tree内のすべてのタグを収集し、実際にグローバル変数に入れます。コードが非同期になったため、コードは異なるユーザーから同時に処理されたリクエストを混在させることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
良いニュースは、このライブラリに基づいてフォークが作成されたことです。今では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">react-helmet-async</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ</font><font style="vertical-align: inherit;">を優先する方が良い</font><font style="vertical-align: inherit;">です。この場合の主なパラダイムは、この場合、react-helmetコンテキストは、HelmetProviderでReact Treeアプリケーションをカプセル化することにより、単一のリクエストのフレームワーク内で分離されることです。</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">import</span> { Helmet, HelmetProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-helmet-async'</span>;<font></font>
<font></font>
app.get(<span class="hljs-string">'/*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {​
   <span class="hljs-comment">// ... code may content any async actions</span>
   <span class="hljs-keyword">const</span> helmetContext = {};
   <span class="hljs-keyword">const</span> app = (
       <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">HelmetProvider</span> <span class="hljs-attr">context</span>=<span class="hljs-string">{helmetContext}</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span>
       <span class="hljs-tag">&lt;/<span class="hljs-name">HelmetProvider</span>&gt;</span></span><font></font>
   );<font></font>
   <span class="hljs-comment">// ...code may content any async actions</span>
   <span class="hljs-keyword">const</span> html = renderToString(app);
   <span class="hljs-keyword">const</span> { helmet } = helmetContext;
   <span class="hljs-comment">// ...code may content any async actions</span><font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは完了する可能性がありますが、おそらく最大のパフォーマンスを絞り出し、いくつかのSEOメトリックを改善するためにさらに進んでいきます。たとえば、サーバーがチャンクを含むページレイアウトを、完全に計算されるまで待つのではなく、計算されるときに送信できる場合、最初のバイトまでの時間（TTFB）メトリックを改善できます。これを行うには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renderToStringの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代わりに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renderToNodeStreamの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用に目を向け始めます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでも、小さな問題に直面しています。</font><font style="vertical-align: inherit;">ページに必要なすべてのメタタグを取得するには、アプリケーションの反応ツリー全体を通過する必要がありますが、問題は、renderToNodeStreamを使用してコンテンツのストリーミングを開始する前にメタタグを送信する必要があることです。</font><font style="vertical-align: inherit;">実際、React Treeを2回計算する必要があり、次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {​
   <span class="hljs-keyword">const</span> helmetContext = {};
   <span class="hljs-keyword">let</span> app = (
       <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">HelmetProvider</span> <span class="hljs-attr">context</span>=<span class="hljs-string">{helmetContext}</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span>
       <span class="hljs-tag">&lt;/<span class="hljs-name">HelmetProvider</span>&gt;</span></span><font></font>
   );<font></font>
<font></font>
   <span class="hljs-comment">// do a first pass render so that react-helmet-async</span>
   <span class="hljs-comment">// can see what meta tags to render</span><font></font>
   ReactDOMServer.renderToString(app);<font></font>
   <span class="hljs-keyword">const</span> { helmet } = helmetContext;<font></font>
<font></font>
   response.write(<span class="hljs-string">`
       &lt;html&gt;
       &lt;head&gt;
           <span class="hljs-subst">${helmet.title.toString()}</span>​
           <span class="hljs-subst">${helmet.meta.toString()}</span>
       &lt;/head&gt;
       &lt;body&gt;
   `</span>);<font></font>
<font></font>
   <span class="hljs-keyword">const</span> stream = ReactDOMServer.renderToNodeStream(app);<font></font>
  <font></font>
   stream.pipe(response, { <span class="hljs-attr">end</span>: <span class="hljs-literal">false</span> });<font></font>
   stream.on(<span class="hljs-string">'end'</span>, () =&gt; response.end(<span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span>));<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなアプローチでは、そのような最適化の必要性は原則として大きな問題となり、達成したいTTFBメトリックを改善することはほとんどありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで少し最適化を行うことができ、いくつかのオプションがあります</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renderToStringの代わりに、renderToStaticMarkupを使用してください。</font></font></li>
<li>  ,    ,        ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">react-tree-walker</a>,             ,      ,   shallow </li>
<li>  ,          </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、いずれにしても、記述されたすべてが洗練されすぎて聞こえ、原則として、いくつかの異常に複雑なアーキテクチャが数ミリ秒で構築されている場合、効率に対する競争に疑問を投げかけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、SSRのレンダリング用のデータを抽出する方法に慣れている人（そして、誰かが知らない場合、これは</font><font style="vertical-align: inherit;">このトピックに関する</font><font style="vertical-align: inherit;">優れた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事です</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）にとっては、ページのメタタグを抽出する同じ方法に進むのに役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的な概念は、ルーターの構成ファイルがあるということです-これは通常のJS構造であり、オブジェクトの配列であり、それぞれにタイプ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンポーネント</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">パスの</font></i><font style="vertical-align: inherit;">いくつかのフィールドが含まれています</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リクエストURLに基​​づいて、構成ファイルを使用して、必要なルーターとそれに関連付けられているコンポーネントを見つけます。</font><font style="vertical-align: inherit;">これらのコンポーネントは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loadData</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの静的メソッドのセットを定義します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、メタタグの場合でも、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">createMetatagsを使用し</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ページコンポーネント自体は次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
   <span class="hljs-keyword">static</span> createMetatags(store, request){
       <span class="hljs-keyword">const</span> item = selectItem(store, request.params.product_id);
       <span class="hljs-keyword">return</span> []<font></font>
           .concat({<span class="hljs-attr">property</span>: <span class="hljs-string">'og:description'</span>, <span class="hljs-attr">content</span>: item.desc})<font></font>
           .concat({<span class="hljs-attr">property</span>: <span class="hljs-string">'og:title'</span>, <span class="hljs-attr">content</span>: item.title})<font></font>
   }<font></font>
   <span class="hljs-keyword">static</span> loadData(store, request){
       <span class="hljs-comment">// extract external data for SSR and return Promise</span><font></font>
   }<font></font>
   <span class="hljs-comment">// the rest of component</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なメタタグのセットを作成する静的なcreateMetatagsメソッドを定義しました。</font><font style="vertical-align: inherit;">これを念頭に置くと、サーバー上のコードは次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/*'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {​​
   <span class="hljs-keyword">const</span> store = createStore();
   <span class="hljs-keyword">const</span> matchedRoutes = matchRoutes(routes, request.path);<font></font>
<font></font>
   <span class="hljs-comment">// load app state</span>
   <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(<font></font>
       matchedRoutes.reduce(<span class="hljs-function">(<span class="hljs-params">promises, { route }</span>) =&gt;</span> {
           <span class="hljs-keyword">return</span> route.component.loadData ? promises.concat(route.component.loadData(store, req)) : promises;<font></font>
       }, [])<font></font>
   );<font></font>
  <font></font>
   <span class="hljs-comment">// to get  metatags</span>
   <span class="hljs-keyword">const</span> metaTags = matchedRoutes.reduce(<span class="hljs-function">(<span class="hljs-params">tags, {route}</span>) =&gt;</span> {
       <span class="hljs-keyword">return</span> route.component.createMetatags ? tags.concat(route.component.createMetatags(store, req)): tags<font></font>
   });<font></font>
<font></font>
   res.write(<span class="hljs-string">`​
     &lt;html&gt;​
     &lt;head&gt;​
         <span class="hljs-subst">${ReactDOMServer.renderToString(() =&gt; metaTags.map(tag =&gt; &lt;meta {...tag}</span>/&gt;) )}​​
     &lt;/head&gt;​
     &lt;body&gt;​
 `</span>);​<font></font>
<font></font>
 <span class="hljs-keyword">const</span> stream = ReactDOMServer.renderToNodeStream(app);​<font></font>
 stream.pipe(response, { <span class="hljs-attr">end</span>: <span class="hljs-literal">false</span> });​<font></font>
 stream.on(<span class="hljs-string">'end'</span>, () =&gt; response.end(<span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span>));​<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それら。</font><font style="vertical-align: inherit;">これで、Reactツリーを2回レンダリングする必要がなくなりました-ルートのデータ抽出と同様に、動作に必要なすべてのものを同形アプリケーションから即座に抽出できます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484442/index.html">SNMPv3の例</a></li>
<li><a href="../ja484444/index.html">動作条件がバッテリーに与える影響、または奇跡的な復活の物語</a></li>
<li><a href="../ja484446/index.html">Python 3.5 asyncioを使用した同時実行性の実装</a></li>
<li><a href="../ja484448/index.html">DEFCON会議27.警察をハッキングする。パート1</a></li>
<li><a href="../ja484454/index.html">ハブラ探偵：あなたの写真は失われます</a></li>
<li><a href="../ja484458/index.html">このフリーランサーは壊れています-次のフリーランサーをください</a></li>
<li><a href="../ja484462/index.html">Githubのスクレイピング：開発する「シークレット」の検索</a></li>
<li><a href="../ja484464/index.html">日本のバイクオークション、それがすべてどうなるか</a></li>
<li><a href="../ja484466/index.html">誰もが知っておくべき共通のJavaScript約束事項</a></li>
<li><a href="../ja484468/index.html">赤い企業文化はロシアのビジネスの主要な問題です（パート2）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>