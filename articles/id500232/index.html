<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòó üêÆ üë¶üèº Belajar Akka.NET: Server game online yang sederhana üëÇüèø üò° ‚èÆÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Saya memutuskan itu berarti mencoba menulis ulang server yang saya lakukan dengan MS Orleans di Akka.NET hanya untuk mencoba teknologi ini...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Belajar Akka.NET: Server game online yang sederhana</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500232/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo, Habr! </font><font style="vertical-align: inherit;">Saya memutuskan itu berarti mencoba menulis ulang server yang saya lakukan dengan MS Orleans di Akka.NET hanya untuk mencoba teknologi ini juga. </font><font style="vertical-align: inherit;">Jika Anda tertarik dengan apa yang terjadi sebelumnya, selamat datang di kucing.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode sumber</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gitlab.com/VictorWinbringer/msorleansonlinegame/-/tree/master/Server/AkkaActors</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang permainan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memotret dengan mode des match. </font><font style="vertical-align: inherit;">Semua melawan semua orang. </font><font style="vertical-align: inherit;">Hijau # adalah lawan. </font><font style="vertical-align: inherit;">Kuning # adalah karakter Anda. </font><font style="vertical-align: inherit;">Red $ adalah sebuah peluru. </font><font style="vertical-align: inherit;">Pemotretan adalah ke arah Anda bergerak. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arah gerakan dikendalikan oleh tombol WASD atau panah. </font><font style="vertical-align: inherit;">Bilah spasi digunakan untuk pemotretan. </font><font style="vertical-align: inherit;">Saya ingin membuat klien grafis di Three.js di masa depan dan menempatkan permainan di beberapa jenis hosting gratis. </font><font style="vertical-align: inherit;">Sejauh ini, hanya ada klien konsol sementara.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2l/n1/j0/2ln1j0xw4cm-reechlymcdrx86q.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesan pribadi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, mereka berdua memecahkan masalah ketika Anda ingin memparalelkan perhitungan Anda dan tidak menggunakan kunci (objek). Secara kasar, semua kode yang Anda miliki di dalam kunci biasanya dapat ditempatkan di aktor. Selain itu, setiap aktor menjalani hidupnya sendiri dan dapat memulai kembali secara independen dari yang lain. Pada saat yang sama, menjaga kelangsungan hidup seluruh sistem secara keseluruhan. Toleransi kesalahan secara umum. Bagi saya MS Orleans lebih nyaman dan dipertajam di bawah RPC. Akka.NET lebih sederhana dan lebih sedikit. Ini dapat digunakan hanya sebagai perpustakaan untuk komputasi asinkron yang reaktif. MS Orleans segera mengharuskan dirinya untuk memilih port terpisah dan mengkonfigurasi sendiri host yang akan diluncurkan ketika aplikasi dimulai. Akka.NET tidak memerlukan apa pun dalam konfigurasi dasar. Saya menghubungkan paket nuget dan menggunakannya. Tetapi MS Orleans memiliki antarmuka yang sangat diketik untuk aktor (biji-bijian).Secara umum, jika saya perlu menulis microservice sepenuhnya pada aktor, saya akan memilih MS Orleans jika, di satu tempat, kami hanya menyejajarkan perhitungan dan menghindari menyinkronkan utas melalui kunci, AutoResetEventSlim atau yang lainnya, Akka.NET. Jadi ya, ada kesalahpahaman yang diduga server shooting Hallo dibuat pada aktor. Oh, tetap saja. Di sana, pada aktor, hanya infrastruktur seperti pembayaran dan hal-hal lain. Logika gerakan pemain dan pukulan, itulah logika permainan, dihitung dalam C ++ monolith. Di sini, di MMO seperti WoW di mana Anda memilih target dengan jelas dan Anda memiliki pengisian global hampir 1 detik untuk semua mantra yang sering menggunakan aktor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode dan komentar</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Titik masuk server kami. </font><font style="vertical-align: inherit;">Hub SignalR</font></font></h3><br>
<pre><code class="cs hljs">      <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameHub</span> : <span class="hljs-title">Hub</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ActorSystem _system;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IServiceProvider _provider;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IGrainFactory _client;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameHub</span>(<span class="hljs-params">
            IGrainFactory client,
            ActorSystem system,
            IServiceProvider provider
            </span>)</span><font></font>
        {<font></font>
            _client = client;<font></font>
            _system = system;<font></font>
            _provider = provider;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">JoinGame</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> gameId, Guid playerId</span>)</span><font></font>
        {<font></font>
<span class="hljs-comment">//IActorRef     .</span>
<span class="hljs-comment">//        </span>
            <span class="hljs-keyword">var</span> gameFactory = _provider.GetRequiredServiceByName&lt;Func&lt;<span class="hljs-keyword">long</span>, IActorRef&gt;&gt;(<span class="hljs-string">"game"</span>);
            <span class="hljs-keyword">var</span> game = gameFactory(gameId);
            <span class="hljs-keyword">var</span> random = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-keyword">var</span> player = <span class="hljs-keyword">new</span> Player()<font></font>
            {<font></font>
                IsAlive = <span class="hljs-literal">true</span>,<font></font>
                GameId = gameId,<font></font>
                Id = playerId,<font></font>
                Point = <span class="hljs-keyword">new</span> Point()<font></font>
                {<font></font>
                    X = (<span class="hljs-keyword">byte</span>)random.Next(<span class="hljs-number">1</span>, GameActor.WIDTH - <span class="hljs-number">1</span>),<font></font>
                    Y = (<span class="hljs-keyword">byte</span>)random.Next(<span class="hljs-number">1</span>, GameActor.HEIGHT - <span class="hljs-number">1</span>)<font></font>
                }<font></font>
            };<font></font>
            game.Tell(player);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GameInput</span>(<span class="hljs-params">Input input, <span class="hljs-keyword">long</span> gameId</span>)</span><font></font>
        {<font></font>
<span class="hljs-comment">//            . </span>
<span class="hljs-comment">// user    .</span>
<span class="hljs-comment">//    -  akka://game/user/1/2</span>
            _system.ActorSelection(<span class="hljs-string">$"user/<span class="hljs-subst">{gameId}</span>/<span class="hljs-subst">{input.PlayerId}</span>"</span>).Tell(input);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daftarkan sistem aktor kami di DI:</font></font><br>
<br>
<pre><code class="cs hljs">services.AddSingleton(ActorSystem.Create(<span class="hljs-string">"game"</span>));
<span class="hljs-keyword">var</span> games = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">long</span>, IActorRef&gt;();<font></font>
services.AddSingletonNamedService&lt;Func&lt;<span class="hljs-keyword">long</span>, IActorRef&gt;&gt;(
    <span class="hljs-string">"game"</span>, (sp, name) =&gt; gameId =&gt;<font></font>
{<font></font>
    <span class="hljs-keyword">lock</span> (games)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (!games.TryGetValue(gameId, <span class="hljs-keyword">out</span> IActorRef gameActor))<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> frame = <span class="hljs-keyword">new</span> Frame(GameActor.WIDTH, GameActor.HEIGHT) { GameId = gameId };
            <span class="hljs-keyword">var</span> gameEntity = <span class="hljs-keyword">new</span> Game()<font></font>
            {<font></font>
                Id = gameId,<font></font>
                Frame = frame<font></font>
            };<font></font>
<span class="hljs-comment">//    .</span>
<span class="hljs-comment">//   IServiceProvide       </span>
            <span class="hljs-keyword">var</span> props = Props.Create(() =&gt; <span class="hljs-keyword">new</span> GameActor(gameEntity, sp));
            <span class="hljs-keyword">var</span> actorSystem = sp.GetRequiredService&lt;ActorSystem&gt;();
<span class="hljs-comment">//        .</span><font></font>
            gameActor = actorSystem.ActorOf(props, gameId.ToString());<font></font>
            games[gameId] = gameActor;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> gameActor;<font></font>
    }<font></font>
});<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktor</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gameactor</font></font></h4><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GameActor</span> : <span class="hljs-title">UntypedActor</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">byte</span> WIDTH = <span class="hljs-number">100</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">byte</span> HEIGHT = <span class="hljs-number">50</span>;
        <span class="hljs-keyword">private</span> DateTime _updateTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> _totalTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Game _game;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IHubContext&lt;GameHub&gt; _hub;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GameActor</span>(<span class="hljs-params">Game game, IServiceProvider provider</span>)</span><font></font>
        {<font></font>
            _updateTime = DateTime.Now;<font></font>
            _game = game;<font></font>
            _hub = (IHubContext&lt;GameHub&gt;)provider.GetService(<span class="hljs-keyword">typeof</span>(IHubContext&lt;GameHub&gt;));
<span class="hljs-comment">//        </span>
<span class="hljs-comment">//RunMessage      .</span>
<span class="hljs-comment">//      .</span><font></font>
            Context<font></font>
                .System<font></font>
                .Scheduler<font></font>
                .ScheduleTellRepeatedly(<font></font>
<span class="hljs-comment">//       .</span>
                    TimeSpan.FromMilliseconds(<span class="hljs-number">100</span>), 
<span class="hljs-comment">//     </span>
                    TimeSpan.FromMilliseconds(<span class="hljs-number">1</span>),
<span class="hljs-comment">// </span><font></font>
                    Context.Self, <font></font>
<span class="hljs-comment">//    </span>
                    <span class="hljs-keyword">new</span> RunMessage(),
<span class="hljs-comment">//   . Nobody   . null .</span><font></font>
                    ActorRefs.Nobody<font></font>
                    );<font></font>
        }<font></font>
<font></font>
<span class="hljs-comment">//    .</span>
<span class="hljs-comment">//    -  .</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnReceive</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> RunMessage run)<font></font>
                Handle(run);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> Player player)<font></font>
                Handle(player);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> Bullet bullet)<font></font>
                Handle(bullet);<font></font>
        }<font></font>
<font></font>
<span class="hljs-comment">//   Create or Update</span>
<span class="hljs-comment">//            </span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> Update&lt;T&gt;(<font></font>
            List&lt;T&gt; entities,<font></font>
            T entity,<font></font>
            Func&lt;<span class="hljs-keyword">object</span>&gt; createInitMessage,<font></font>
            Func&lt;Props&gt; createProps<font></font>
            )<font></font>
            <span class="hljs-keyword">where</span> T : IGameEntity<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!entity.IsAlive)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> actor = Context.Child(entity.Id.ToString());
                <span class="hljs-keyword">if</span> (!actor.IsNobody())<font></font>
                    Context.Stop(actor);<font></font>
                entities.RemoveAll(b =&gt; b.Id == entity.Id);<font></font>
            }<font></font>
<span class="hljs-comment">//Create</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!entities.Any(b =&gt; b.Id == entity.Id))<font></font>
            {<font></font>
                Context.ActorOf(createProps(), entity.Id.ToString());<font></font>
                entities.Add(entity);<font></font>
                Context.Child(entity.Id.ToString()).Tell(createInitMessage());<font></font>
            }<font></font>
<span class="hljs-comment">//Update</span>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                entities.RemoveAll(b =&gt; b.Id == entity.Id);<font></font>
                entities.Add(entity);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Bullet bullet</span>)</span><font></font>
        {<font></font>
            Update(<font></font>
                _game.Bullets,<font></font>
                bullet,<font></font>
                () =&gt; <span class="hljs-keyword">new</span> InitBulletMessage(bullet.Clone(), _game.Frame.Clone()),<font></font>
                () =&gt; Props.Create(() =&gt; <span class="hljs-keyword">new</span> BulletActor())<font></font>
                );<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Player player</span>)</span><font></font>
        {<font></font>
            Update(<font></font>
                _game.Players,<font></font>
                player,<font></font>
                () =&gt; <span class="hljs-keyword">new</span> InitPlayerMessage(player.Clone(), _game.Frame.Clone()),<font></font>
                () =&gt; Props.Create(() =&gt; <span class="hljs-keyword">new</span> PlayerActor())<font></font>
            );<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">RunMessage run</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> deltaTime = DateTime.Now - _updateTime;<font></font>
            _updateTime = DateTime.Now;<font></font>
            <span class="hljs-keyword">var</span> delta = deltaTime.TotalMilliseconds;<font></font>
            Update(delta);<font></font>
            Draw(delta);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> deltaTime</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> players = _game.Players.Select(p =&gt; p.Clone()).ToList();
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> child <span class="hljs-keyword">in</span> Context.GetChildren())<font></font>
            {<font></font>
                child.Tell(<span class="hljs-keyword">new</span> UpdateMessage(deltaTime, players));<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Draw</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> deltaTime</span>)</span><font></font>
        {<font></font>
            _totalTime += deltaTime;<font></font>
            <span class="hljs-keyword">if</span> (_totalTime &lt; <span class="hljs-number">50</span>)
                <span class="hljs-keyword">return</span>;<font></font>
            _totalTime = <span class="hljs-number">0</span>;
<span class="hljs-comment">//PipeTo    Task     .</span>
<span class="hljs-comment">// ReciveActor    async await </span>
            _hub.Clients.All.SendAsync(<span class="hljs-string">"gameUpdated"</span>, _game.Clone()).PipeTo(Self);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BulletActor</font></font></h4><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BulletActor</span> : <span class="hljs-title">UntypedActor</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> Bullet _bullet;
        <span class="hljs-keyword">private</span> Frame _frame;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnReceive</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> InitBulletMessage bullet)<font></font>
                Handle(bullet);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> UpdateMessage update)<font></font>
                Handle(update);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">InitBulletMessage message</span>)</span><font></font>
        {<font></font>
            _bullet = message.Bullet;<font></font>
            _frame = message.Frame;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">UpdateMessage message</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (_bullet == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">if</span> (!_bullet.IsAlive)<font></font>
            {<font></font>
                Context.Parent.Tell(_bullet.Clone());<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
            _bullet.Move(message.DeltaTime);<font></font>
            <span class="hljs-keyword">if</span> (_frame.Collide(_bullet))<font></font>
                _bullet.IsAlive = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (!_bullet.IsInFrame(_frame))<font></font>
                _bullet.IsAlive = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> player <span class="hljs-keyword">in</span> message.Players)<font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (player.Id == _bullet.PlayerId)
                    <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
<span class="hljs-comment">//         </span>
<span class="hljs-comment">//  </span>
                <span class="hljs-keyword">if</span> (player.Collide(_bullet))<font></font>
                {<font></font>
                    _bullet.IsAlive = <span class="hljs-literal">false</span>;<font></font>
                    Context<font></font>
                        .ActorSelection(Context.Parent.Path.ToString() + <span class="hljs-string">"/"</span> + player.Id.ToString())<font></font>
                        .Tell(<span class="hljs-keyword">new</span> DieMessage());<font></font>
                }<font></font>
            }<font></font>
            Context.Parent.Tell(_bullet.Clone());<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PlayerActor</font></font></h4><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlayerActor</span> : <span class="hljs-title">UntypedActor</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> Player _player;
        <span class="hljs-keyword">private</span> Queue&lt;Direction&gt; _directions;
        <span class="hljs-keyword">private</span> Queue&lt;Command&gt; _commands;
        <span class="hljs-keyword">private</span> Frame _frame;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PlayerActor</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            _directions = <span class="hljs-keyword">new</span> Queue&lt;Direction&gt;();<font></font>
            _commands = <span class="hljs-keyword">new</span> Queue&lt;Command&gt;();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnReceive</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> Input input)<font></font>
                Handle(input);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> UpdateMessage update)<font></font>
                Handle(update);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> InitPlayerMessage init)<font></font>
                Handle(init);<font></font>
            <span class="hljs-keyword">if</span> (message <span class="hljs-keyword">is</span> DieMessage)<font></font>
            {<font></font>
                _player.IsAlive = <span class="hljs-literal">false</span>;<font></font>
                Context.Parent.Tell(_player.Clone());<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">InitPlayerMessage message</span>)</span><font></font>
        {<font></font>
            _player = message.Player;<font></font>
            _frame = message.Frame;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">Input message</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (_player == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">if</span> (_player.IsAlive)<font></font>
            {<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> command <span class="hljs-keyword">in</span> message.Commands)<font></font>
                {<font></font>
                    _commands.Enqueue(command);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> direction <span class="hljs-keyword">in</span> message.Directions)<font></font>
                {<font></font>
                    _directions.Enqueue(direction);<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Handle</span>(<span class="hljs-params">UpdateMessage update</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (_player == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">if</span> (_player.IsAlive)<font></font>
            {<font></font>
                HandleCommands(update.DeltaTime);<font></font>
                HandleDirections();<font></font>
                Move(update.DeltaTime);<font></font>
            }<font></font>
            Context.Parent.Tell(_player.Clone());<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleDirections</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (_directions.Count &gt; <span class="hljs-number">0</span>)<font></font>
            {<font></font>
                _player.Direction = _directions.Dequeue();<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleCommands</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> delta</span>)</span><font></font>
        {<font></font>
            _player.TimeAfterLastShot += delta;<font></font>
            <span class="hljs-keyword">if</span> (!_player.HasColldown &amp;&amp; _commands.Any(command =&gt; command == Command.Shoot))<font></font>
            {<font></font>
<span class="hljs-comment">//Shot      </span>
<span class="hljs-comment">//         </span>
                <span class="hljs-keyword">var</span> bullet = _player.Shot();<font></font>
                Context.Parent.Tell(bullet.Clone());<font></font>
                _commands.Clear();<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Move</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> delta</span>)</span><font></font>
        {<font></font>
            _player.Move(delta);<font></font>
            <span class="hljs-keyword">if</span> (_frame.Collide(_player))<font></font>
                _player.MoveBack();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesan diteruskan antar aktor</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-comment">//    .</span>
<span class="hljs-comment">//            .</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DieMessage</span> { }
</code></pre><br>
<pre><code class="cs hljs"><span class="hljs-comment">//      </span>
<span class="hljs-comment">//        </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InitBulletMessage</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> Bullet Bullet { <span class="hljs-keyword">get</span>; }
        <span class="hljs-keyword">public</span> Frame Frame { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InitBulletMessage</span>(<span class="hljs-params">Bullet bullet, Frame frame</span>)</span><font></font>
        {<font></font>
            Bullet = bullet ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">" "</span>);<font></font>
            Frame = frame ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">" "</span>);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs"><span class="hljs-comment">//      </span>
<span class="hljs-comment">//     </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InitPlayerMessage</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> Player Player { <span class="hljs-keyword">get</span>; }
        <span class="hljs-keyword">public</span> Frame Frame { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InitPlayerMessage</span>(<span class="hljs-params">Player player, Frame frame</span>)</span><font></font>
        {<font></font>
            Player = player ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">" !"</span>);<font></font>
            Frame = frame ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">" "</span>);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs"><span class="hljs-comment">//          </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RunMessage</span> { }
</code></pre><br>
<pre><code class="cs hljs"><span class="hljs-comment">//     </span>
<span class="hljs-comment">//       .</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UpdateMessage</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> DeltaTime { <span class="hljs-keyword">get</span>; }
<span class="hljs-comment">//          </span>
        <span class="hljs-keyword">public</span> List&lt;Player&gt; Players { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UpdateMessage</span>(<span class="hljs-params"><span class="hljs-keyword">double</span> deltaTime, List&lt;Player&gt; players</span>)</span><font></font>
        {<font></font>
            DeltaTime = deltaTime;<font></font>
            Players = players ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(<span class="hljs-string">" !"</span>);<font></font>
        }<font></font>
    }<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id500218/index.html">Model epidemiologis Covid-19</a></li>
<li><a href="../id500220/index.html">Rekaman vinil dan kaset tepat di Android Anda</a></li>
<li><a href="../id500222/index.html">Telepon Nirkabel dari Biplan WWI Inggris</a></li>
<li><a href="../id500224/index.html">Hidung elektronik DIY</a></li>
<li><a href="../id500228/index.html">Bagaimana Gatsby menghindari Next.js</a></li>
<li><a href="../id500234/index.html">Mengapa saya membuat proyek akuntansi pengeluaran pribadi untuk Git + JS</a></li>
<li><a href="../id500238/index.html">Katakan padaku apa yang mengganggumu</a></li>
<li><a href="../id500244/index.html">Di luar array</a></li>
<li><a href="../id500246/index.html">Melindungi dan Meretas Xbox 360 (Bagian 3)</a></li>
<li><a href="../id500248/index.html">Berita FOSS No. 14 - ulasan berita gratis dan sumber terbuka untuk 27 April - 3 Mei 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>