<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍⚖️ 👂🏼 💇 Facebook Webhook处理的演变：从零到每秒25,000 🦉 👲🏽 👩🏼‍⚖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最有可能的是，没有人需要告诉您什么是网络钩子。但是以防万一：Webhooks是一种用于报告外部系统中的事件的机制。例如，关于通过在线收银员在在线商店中购买商品，向GitHub存储库发送代码或聊天中的用户操作。在典型的API中，如果用户在聊天中写了一些内容，则需要不断查询服务器。使用webhook机制...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Facebook Webhook处理的演变：从零到每秒25,000</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最有可能的是，没有人需要告诉您什么是网络钩子。但是以防万一：Webhooks是一种用于报告外部系统中的事件的机制。例如，关于通过在线收银员在在线商店中购买商品，向GitHub存储库发送代码或聊天中的用户操作。在典型的API中，如果用户在聊天中写了一些内容，则需要不断查询服务器。使用webhook机制，您可以“订阅”通知，并且服务器本身将在事件发生时发送HTTP请求。这比在服务器上不断请求新数据更方便，更快捷。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat是一个平台，可帮助企业通过即时通讯程序中的聊天与客户进行沟通。 Webhooks是ManyChat的重要组成部分之一，因为企业通过它与客户进行通信。他们之间进行了很多交流-例如，通过系统，企业每月向其客户发送数十亿条消息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大多数消息都是通过Facebook Messenger发送的。它具有一个功能-慢速API。当客户写消息订购披萨时，Facebook将网络挂钩发送给ManyChat。平台对其进行处理，将请求发送回去，并且用户会收到一条消息。由于API速度较慢，某些请求会持续几秒钟。但是，当平台长时间没有响应时，企业就会失去客户端，Facebook可以将应用程序与网络挂钩断开。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，处理Webhook是平台的主要工程任务之一。</font><font style="vertical-align: inherit;">为了解决该问题，在三年的过程中，ManyChat几次将其处理体系结构从Yii中的简单控制器更改为带有星系的分布式系统。</font><font style="vertical-align: inherit;">阅读更多关于Dmitry Kushnikov（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
梅德Kushnikov导致发展的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并已在专业PHP自2001年以来的编程。</font><font style="vertical-align: inherit;">Dmitry将告诉您架构如何随着服务和负载的增长而变化，在不同阶段应用了哪些解决方案和技术，webhook处理如何演变以及平台如何使用PHP中的少量资源来应对巨大的负载。</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意。</font><font style="vertical-align: inherit;">本文基于Dmitry在</font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019中</font></font></em></a><font style="vertical-align: inherit;"><em><font style="vertical-align: inherit;">的报告“ Facebook Webhook处理的演变：从零到每秒12,500” </font></em></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是在他准备的时候，指标上升到25,000。</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我将向您介绍我们的任务范围。 ManyChat是一项服务，可帮助企业使用即时通讯工具进行营销，销售和支持。主要产品是</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facebook Messenger上的Messenger营销平台</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。三年来，来自全球100个国家/地区的超过100万家企业使用该服务与7亿客户进行了交流。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在客户端，</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它看起来像这样。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facebook Messenger中对话框中的按钮，图片和图库。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
这是Facebook Messenger界面。除了文本消息，您还可以在其中发送交互元素以与客户交互，进行对话，增加对产品的兴趣和销售。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从业务方面</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一切看起来都不同。</font><font style="vertical-align: inherit;">这是我们的Web应用程序的界面，业务代表使用可视界面在其中创建和编程对话脚本。</font><font style="vertical-align: inherit;">图片是一个场景的例子。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们系统的核心是Flow Builder组件。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这套脚本和自动化规则称为</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，为简化起见，我们可以说ManyChat是机器人设计师。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">机器人的例子。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参与对话的业务的客户称为</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">订户</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为进行交互时，该客户会</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">订阅机器人</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么选择Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为什么选择Facebook Messenger，我们是尚存电报的国家？</font><font style="vertical-align: inherit;">这是有原因的。</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     №1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与Facebook的交互组织如下：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
业务使用Web应用程序配置漫游器的逻辑。</font><font style="vertical-align: inherit;">当客户通过电话与漫游器进行互动时，Facebook会接收有关此信息，并向我们发送网络挂钩。</font><font style="vertical-align: inherit;">ManyChat根据业务编程的逻辑对其进行处理，然后将请求发送回去。</font><font style="vertical-align: inherit;">然后，Facebook将消息传递到用户的手机。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技术栈</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在适度的堆栈上完成所有这些操作。</font><font style="vertical-align: inherit;">当然，核心是PHP。</font><font style="vertical-align: inherit;">Web服务器运行Nginx，主数据库是PostgreSQL，还有Redis和Elasticsearch。</font><font style="vertical-align: inherit;">所有这些都在Amazon Web Services云中旋转。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理Facebook Webhook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是Facebook的网络摄像头的样子：这是带有JSON格式有效负载的请求。</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webhook仅占我们负载的10％，但却是系统中最重要的部分。</font><font style="vertical-align: inherit;">通过它们，企业与用户进行通信。</font><font style="vertical-align: inherit;">如果消息变慢或没有发送，则用户拒绝与该机器人进行交互，从而使企业失去客户。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们来看看自产品推出以来我们架构的发展。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年5月</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们刚刚启动了我们的服务：20个机器人，其中10个是测试机器人，还有20个订阅者。</font><font style="vertical-align: inherit;">负载为0 RPS。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
交互方案如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该请求转到nginx。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx访问PHP-FPM。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM将应用程序升级到Yii。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webhook控制器处理逻辑，并根据逻辑将请求发送到Facebook。</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一堆Nginx和PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年6月。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个月后，我们在ProductHunt上宣布了ManyChat，而僵尸程序的数量增加到了2000。</font><font style="vertical-align: inherit;">订户数量已增加到7,000。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此时，第一个问题出现在系统中。</font><font style="vertical-align: inherit;">Facebook API的运行速度不是很快：有些请求可能需要几秒钟，而有些请求可能需要数十秒钟。</font><font style="vertical-align: inherit;">但是webhook服务器希望我们快速响应。</font><font style="vertical-align: inherit;">由于API的速度较慢，我们很长一段时间都没有响应：服务器先发誓，然后它才能完全断开应用程序与webhooks的连接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用户很少，我们仍在开发应用程序，我们正在寻找我们的市场，受众，并且负载问题已经出现。</font><font style="vertical-align: inherit;">但是我们被一个简单的解决方案所拯救：</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在控制器启动时，我们中断了对Facebook的访问</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们告诉Facebook一切都很好，但是在后台我们处理请求和Webhook。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL上的队列</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年12月。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务增长了5到10倍：1万个自动程序和70万个订阅者。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，我们从事新任务：显示统计信息，消息传递，印象转换和过渡。</font><font style="vertical-align: inherit;">还实现了实时聊天。</font><font style="vertical-align: inherit;">除了自动进行交互之外，它还使企业能够直接将消息写入其订户。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些问题的解决方案使跟踪的挂钩数增加了4倍。</font><font style="vertical-align: inherit;">对于我们发送的每条消息，我们还会收到3个额外的Webhook。</font><font style="vertical-align: inherit;">处理系统需要再次改进。</font><font style="vertical-align: inherit;">我们是一个小型平台，后端只有两个人工作，因此我们选择了最简单的解决方案-PostgreSQL上的队列。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还不想实现复杂的系统，因此我们只是共享处理流程。</font><font style="vertical-align: inherit;">需要快速处理以使用户收到响应的Webhook会被同步处理。</font><font style="vertical-align: inherit;">所有其余的都在队列中发送以进行异步请求。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis的队列</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017年6月。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务在增长：7.5万个机器人，700万用户。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们正在实现另一个新功能。我们处理的所有Webhook仅与Messenger中的通信有关。但是现在，我们决定给企业提供</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与企业页面订阅者</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行交流的机会，</font><font style="vertical-align: inherit;">并开始处理新型的Webhooks-与页面本身的提要相关的那些。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
业务页面供稿不会经常更新。营销人员经常发布一些东西，然后他们按照每个人的喜好进行计数。业务页面上没有大量流量。但是也有相反的情况，例如，</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
凯蒂·佩里（Katy Perry）是一位著名的美国歌手，在世界各地都有大量的歌迷。</font><font style="vertical-align: inherit;">仅在她的Facebook组中就有6400万订户。</font><font style="vertical-align: inherit;">在某个时候，歌手的营销商决定在Facebook Messenger上制作一个机器人，并选择了我们的平台。</font><font style="vertical-align: inherit;">那时，当他们发布一条消息来订阅该机器人时，我们的负载增加了3-4倍。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种情况有助于我们了解，如果没有正常执行队列，我们​​将无能为力。</font><font style="vertical-align: inherit;">作为解决方案，他们选择了Redis。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为队列选择Redis是一个非常好的决定。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他帮助解决了许多问题。现在，通过我们的Redis集群，每秒传递一百万个不同的请求。我们不仅将其用于所有级联队列，还用于其他任务，例如监视。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一次尝试时未实现Redis上的队列。当我们开始只在Redis中折叠Webhook并在一个过程中对其进行处理时，我们在顶部扩展了该漏斗：也处理了更多传入的Webhook，但该过程本身仍需要一些时间。最初的决定没有成功。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当他们尝试扩展这些请求的数量时，出现了轻微的崩溃。队列可以累积来自不同页面的请求，但是来自一个页面的请求可以连续进行。如果一个处理程序运行缓慢，则来自一个订户和一个机器人的请求将以错误的顺序处理。用户发送消息，使用机器人执行一些操作，但随机接收响应。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这似乎很少见，但是对我们的工作负载进行测试表明，这种情况经常发生。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们开始寻找另一种解决方案。 Redis的简单性和强大功能在这里得到了拯救-我们决定</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为每个机器人排队</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
怎么运行的？与每个漫游器相关的消息将添加到队列中。为了不将处理程序提升到每个队列，我们​​制作了一个</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">控制队列</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。她那样工作。每次来自机器人的请求时，都会在Redis中发布两条消息：一条消息在机器人的队列中，第二条消息在控件中。处理程序监视控件，并在有任务要处理僵尸程序时每次监视守护程序。恶魔在相应机器人的队列中抽风。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了主要任务，我们还解决了“吵闹的邻居”问题。这是一个机器人生成大量Webhooks并减慢系统速度的原因，因为其他页面正在等待处理。要解决该问题，就可以进行</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">扩展</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：当控制队列已满时，我们添加新的处理程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另外，</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">队列是虚拟的</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些只是Redis内存中的单元格。</font><font style="vertical-align: inherit;">当队列中没有任何内容时，它不存在，不会占据任何内容。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018年1月</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我们每月已达到10亿个职位。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个系统的负载为5000 RPS。这不是峰值负载，而是标准负载。当著名歌手的机器人出现时，这个数字已经使一切增长了数倍。但这不是问题。问题出在PHP-FPM中：它再也无法承受5000 RPS的负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当时每个人都在谈论时尚的异步处理。我们仔细研究了一下，看到ReactPHP，进行了快速测试，将其替换为PHP-FPM，并立即增长了4倍。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们没有重写处理过程-ReactPHP提出了Yii框架。首先，我们提出了4种ReactPHP服务，后来又增加到30种。很长一段时间，我们都依靠它们来生存，而框架可以应付负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
扩展漏斗后，又发生了另一次崩溃：在接收端启动漏斗后，处理又开始受到影响。</font><font style="vertical-align: inherit;">为了已经解决了这个问题，我们决定将处理分为几类。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集群</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他们拿走了机器人，将它们分配到集群中，并从Redis，Postgres和处理程序构建了逻辑链。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，我们形成了</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“银河”</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的概念</font><strong><font style="vertical-align: inherit;">-处理上的逻辑物理抽象</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它由实例组成：Redis，PostgreSQL和一组PHP服务。</font><font style="vertical-align: inherit;">每个机器人都属于一个特定的集群，ReactPHP知道需要将该机器人的消息放置在哪个集群中。</font><font style="vertical-align: inherit;">上面的方案更有效。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
宇宙正在扩展，我们系统的宇宙也在扩展，并且当这种情况发生时，我们添加了一个新的“ Galaxy”。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">星系是我们扩展的方式。</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用一堆Nginx和Lua替换ReactPHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在接下来的六个月中，我们继续增长：每月有2亿订户和30亿条消息。</font><font style="vertical-align: inherit;">想象一个拥有2亿注册用户的网站-同样的负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出现了一个新问题。</font><font style="vertical-align: inherit;">Webhooks是相同类型的小任务，PHP不适合解决它们。</font><font style="vertical-align: inherit;">甚至ReactPHP也无济于事。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他无法应付1万RPS的负载-自从引入ReactPHP以来，负载已经增加。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而且，即使在进行部署的情况下也必须按顺序重新启动它，因为您不能中断传入Webhooks的处理。</font><font style="vertical-align: inherit;">当Facebook意识到存在问题时，将禁用该应用程序。</font><font style="vertical-align: inherit;">对于ManyChat来说，这是一场灾难-650,000个活跃运营的企业不会原谅我们。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们逐渐摆脱了ReactPHP的不同逻辑，将其传递给处理器，并隔离了新队列。在此过程中，他们注意到</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP执行了一个简单的任务-它需要一个webhook并将其放入队列中</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。其余的全部通过处理完成。有没有类似的东西可以完成这么简单的任务？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们记得Nginx有模块，并注意到了</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">。除了支持Lua编程语言外，她还有一个用于Redis的模块。在3个小时内编写的测试表明，ReactPHP上30个服务的所有工作都可以直接在nginx端完成。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果是这样的：我们处理某种端点，选择请求主体并将其直接添加到Redis。</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty和Lua帮助提高了吞吐量。</font><font style="vertical-align: inherit;">我们将继续应付工作量，服务永存，每个人都很高兴。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">改进Lua上的解决方案</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后一个阶段（</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：在</font></font></em><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">撰写</font></font></strong><font style="vertical-align: inherit;"><em><font style="vertical-align: inherit;">报告时</font></em><font style="vertical-align: inherit;">）是</font><strong><font style="vertical-align: inherit;">2019年2月</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">每月有5亿订户发送和接收来自100万个机器人的700万条消息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是改进我们在Lua上的解决方案的步骤。</font><font style="vertical-align: inherit;">逐渐消除队列中的某些逻辑，并将在系统之间分发Webhook的主要过程转移到Lua。</font><font style="vertical-align: inherit;">现在，我们的系统生产率更高，依赖性更低。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们维护</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分开的处理和异步处理</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">处理涉及统计数据和其他事项-现在它是一个完全不同的系统。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该系统看起来很简单，但事实并非如此。</font><font style="vertical-align: inherit;">在后台，有500个服务处理它们的请求。</font><font style="vertical-align: inherit;">整个系统在50个Amazon实例上运行：Redis，PostgreSQL和PHP处理程序本身。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理演变</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在PHP中，高负载可以很酷。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
简要回顾一下我们在系统开发过程中是如何做到的。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从常规的Nginx和PHP-FPM开始。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将队列添加到PostgreSQL，然后添加到Redis。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加了集群。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实现了ReactPHP。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们用一堆Nginx和Lua替换了ReactPHP，然后将逻辑移到了那堆。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从我们的经验中我们发现，可以通过使用简单的众所周知的方法连续更改易受攻击的部分来增长和构建体系结构，同时又不扩展堆栈。</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN486844/">https://habr.com/ru/post/zh-CN486844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN486824/index.html">使用ANTLR时的坏建议</a></li>
<li><a href="../zh-CN486826/index.html">在Django 2和Viber REST API上创建完整的Viberbot。第一部分-Webhook</a></li>
<li><a href="../zh-CN486828/index.html">食品设计文摘，2020年1月</a></li>
<li><a href="../zh-CN486832/index.html">针叶林走了多少年-不懂</a></li>
<li><a href="../zh-CN486842/index.html">领事+ iptables =：3</a></li>
<li><a href="../zh-CN486850/index.html">新预留的座位-如胶囊旅馆</a></li>
<li><a href="../zh-CN486858/index.html">创建一个成熟的Viberbot。第二部分-首次联系或“ conversion_started”</a></li>
<li><a href="../zh-CN486860/index.html">ATX12VO-吃一种新方法</a></li>
<li><a href="../zh-CN486862/index.html">运动设计可帮助您与人建立联系的5个原因</a></li>
<li><a href="../zh-CN486864/index.html">从OpenVPN迁移到WireGuard，将网络加入一个L2网络</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>