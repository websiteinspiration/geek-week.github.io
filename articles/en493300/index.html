<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úã üîâ üîª Calculation of the center of mass for O (1) using integrated images üë®üèø‚Äçüé§ ‚úåüèæ üç´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An integrated image is an algorithm that allows you to efficiently calculate the sum of the values ‚Äã‚Äãenclosed in a rectangular subset of a multidimens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Calculation of the center of mass for O (1) using integrated images</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/493300/"><img src="https://habrastorage.org/webt/jz/zu/un/jzzuunk1lhxykcm7wzw8abqoaek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An integrated image is an algorithm that allows you to efficiently calculate the sum of the values ‚Äã‚Äãenclosed in a rectangular subset of a multidimensional array. </font><font style="vertical-align: inherit;">His very idea dates back to the study of multidimensional probability distribution functions, and until now he has found successful application in those areas that directly use probability theory as the main toolkit. </font><font style="vertical-align: inherit;">For example, in pattern recognition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we will consider a curious case of how to apply integrated images in a radically different field - computational physics. </font><font style="vertical-align: inherit;">Namely, let's see what happens if we calculate with them the center of mass of the pulse field, and what benefit can be derived from this symbiosis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will tell:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What kind of task is this in question;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more about integrated images;</font></font></li>
<li>         N       (-);</li>
<li>        ;</li>
<li>, ,          .</li>
</ul><a name="habracut"></a><br>
<h2>  N </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A rigorous solution to the gravitational interaction of a system of N bodies refers to algorithms that have quadratic complexity: all other bodies in the system have a gravitational effect on each body </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[1]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Consequently, the force of the gravitational interaction need to calculate for each of the N </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /2 pair. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To illustrate how time-consuming a strict solution is, you can try to correlate the complexity of calculating a real system with the performance of modern computers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To calculate the gravitational force between two bodies in three-dimensional space, you must perform 20 operations with a floating point (FLOP). In the solar system, there are about 100 bodies larger than 200 kilometers (including the Sun, 9 planets, dwarf planets and satellites) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[2]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The approximate number of asteroids in near-Earth orbit is about 20 thousand </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[3]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the asteroid belt, there are from 1.1 to 1.9 million bodies larger than 1 km </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[4]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and about one million similar asteroids in the ‚ÄúTrojan‚Äù </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[5]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and ‚ÄúGreek‚Äù groups of Jupiter. In the Kuiper belt, about 100 million objects larger than 20 km </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[6]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and about 2 trillion more are in the Oort cloud </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[7]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/yx/dq/zpyxdqsshts30cbhyethrg6l1nq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The computational power required to strictly solve the last gravitational problem is only an order of magnitude smaller than the computational power required to simulate the work of the human brain at the neural level (2.5 √ó 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[8]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. That is why its rigorous solution is usually replaced by an approximate one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most widely used algorithms for the approximate solution of the gravitational problem - Tree Code - has a quasilinear time complexity O (N * logN) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[9]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The Tree Code builds a spatial tree and for each node in this tree calculates the total mass and center of mass of all the bodies that fall into it. Further, when calculating the gravitational forces acting on each body, the Tree Code can take into account not the direct influence of other bodies, but the influence of tree nodes, and depending on the distance, it selects ever larger nodes that contain parameters of an increasingly numerous subset of bodies.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fy/mu/cp/fymucpzatvvwlghoadwjgdzku3y.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Illustration from Wikipedia. </font><font style="vertical-align: inherit;">On the body in the center are the masses of nodes indicated by green rectangles. </font><font style="vertical-align: inherit;">Only the masses of the nearest bodies are taken into account directly.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gravity problem for the momentum field</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The momentum field is a discrete vector field </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mv (p)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which </font><font style="vertical-align: inherit;">associates a mass-velocity pair with </font><font style="vertical-align: inherit;">each point of the space </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> under consideration </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The pulse field can be set for a space of any dimension. </font><font style="vertical-align: inherit;">A mass-velocity pair characterizes the momentum and represents a vector of dimension </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + 1, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the dimension of the space for which the pulse field is given. </font><font style="vertical-align: inherit;">For example, for R = 2 this could be the vector { </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></sub></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></sub></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> }.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that the mathematically traditional version of the description of this system is a combination of a vector velocity field and a scalar mass field. In this case, we allow ourselves the freedom to combine speed and mass in one vector, since we do not pretend to be mathematical. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gl/sf/ku/glsfku0yn1u3tdyftw6noww3fhg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A small portion of the vector field of pulses: the masses are indicated by color, the directions by arrows. The </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/xc/qh/uc/xcqhuc3vgvbr8-k4ybjmbeoh5na.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vector field of pulses of 729 √ó 729 elements in size. On the left are the masses. On the right are impulses. The pulses in this illustration are color coded in HSV format (Hue is the direction of the pulse, and Value linearly displays the order of its absolute value so that the least distinguishable (Value = 0.05) pulses are of the order of 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-7</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the brightest pulses (Value = 1 , 0) are of the order of 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and higher).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similar to this - grid - methods for describing physical systems are widely used in astrophysics to simulate the evolution of gas clouds, the formation of stars and galaxies. These include the SAMR method </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[10]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or the grid model of hydrodynamics </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[11]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As in the case of the gravitational problem of N bodies, the evolution of a discrete field must take into account the gravitational influence of all the masses that make up this field on each of its discrete elements. It is necessary to take into account that the complexity of the problem indirectly depends on the dimension of the space </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : for example, for a field on a plane consisting of 1000 √ó 1000 elements, the total number N will be 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elements, and a field of the same size in three-dimensional space will already include 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> elements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, there are a number of tricks that make it possible to approximately solve the gravitational problem for the momentum field. The Multigrid method uses hierarchical discretization, supporting several grids of various sizes </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[12]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Multipole Expansion treats groups of sources located close to each other as one object </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[13]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Multigrid has quasilinear computational complexity and logarithmic memory complexity. One of the Multipole Expansion options - FMM - demonstrates linear computational complexity in exchange for reduced computational accuracy </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[14]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below we consider another method that allows us to solve the gravitational problem for a discrete field of pulses in quasilinear time and has linear complexity in memory.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrated image</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The integral image allows calculating the constant time the sum of the elements of the original image in an arbitrary rectangular region </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[15]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In computer graphics, integrated images were originally proposed as an alternative to mipmapping and anisotropic filtering </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[16]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In addition, they are successfully used for digital image processing and in pattern recognition techniques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An integrated image is one of the most obvious examples of a trade-off between computational complexity and memory complexity. A ‚Äúnaive‚Äù algorithm for calculating the sum of image elements has a time complexity of O (M * N) and a memory complexity of O (1). The integrated image allows you to perform the same calculations in O (1) time and has O (M * N) memory complexity.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_f/dp/ap/_fdpapnp5qlfd1e7uwv1hkqd614.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using an integrated image to calculate the sum of elements in a given region</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The algorithm for calculating an integral image is very simple, characterized by linear computational complexity and is easily parallelized under GPGPU </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[17]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is implemented like a two-pass Gaussian filter </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[18]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : in the first pass, the partial sums for the rows are considered, in the second, these partial sums are accumulated in columns. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d-/c9/gt/d-c9gtnjp-6xcsuykgfd0ruwhn4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculation of the integrated image in two passes. On the left is the original image. In the center are the partial amounts for the lines. On the right is the final integrated image. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/ak/si/rc/aksircbzhaq2lby19dpbiaxwhwo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the left is an image containing masses of elements. On the right is its integral image. The images on the left and right use different logarithmic scales.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An approximate solution to the gravitational problem using an integrated image</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having at its disposal an integral image of the masses, it is not difficult to adapt the technique characteristic of the Tree Code and Multipole Expansion to it. </font><font style="vertical-align: inherit;">So, for each element of the discrete field:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We directly take into account the influence of the masses of only the neighboring eight elements;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We take into account the influence of eight neighboring regions, consisting of nine elements (3 √ó 3), by calculating the sum of their masses using an integrated image;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At each subsequent step, we increase the size of the region by 3 times (9 √ó 9, 27 √ó 27, 81 √ó 81, etc.) until this one exceeds the size of the entire vector field.</font></font></li>
</ol><br>
 <img src="https://habrastorage.org/webt/u8/fy/qb/u8fyqbvn6-8o53z-hxsptyogxzk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An approximate calculation of the forces acting on an element of the vector field of pulses using an integral image of masses</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The complexity of the approximate solution of the gravitational problem for a field of pulses using an integral image grows quasilinearly, like O (N * 8 * log3 (sqrt (N))) for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 2 and like O (N * 26 * log3 (cbrt (N))) for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 3. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ik/ou/zg/ikouzgiqpe4r0gs70ib-cxkxd9q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, in this form, this solution has the same drawback as the Multigrid technique, namely, the perceptible discrete "rigidity" of the low-frequency components of the gravity function. The easiest way to demonstrate this problem is clearly.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t-/1c/j8/t-1cj8ryo2xicugndkrgg6i_s3i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The forces in this illustration are color coded in HSV format (Hue is the direction of the force, Value linearly displays the order of its absolute value in such a way that the least distinguishable (Value = 0.05) forces are of the order of 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-7</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the brightest forces (Value = 1, 0) are of the order of 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and higher).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the illustration above, the effect of "rigidity" of the low-frequency components of the gravity function is noticeable to the naked eye. But if in ‚ÄúMultigrid‚Äù this ‚Äúrigidity‚Äù occurs due to a decrease in the sampling frequency, then in the integrated image this is due to the lack of information about the nature of the spatial distribution of masses. The fact is that an algorithm that approximates forces using an integrated image considers that the center of mass coincides with the center of the region.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yp/p-/bt/ypp-bt8mx3i_w3g22ryuyveix_y.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The center of the illustration shows the mass extremum with a relatively uniform mass distribution in the rest of the field. The</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
mass </font><i><font style="vertical-align: inherit;">extremum</font></i><font style="vertical-align: inherit;"> falls into each of the four rectangular regions. Obviously, the position of the center of mass of each region should approximately coincide with the element indicated by white, the mass of which is three orders of magnitude greater than the mass of most elements of the region indicated by yellow. However, in the calculations of the low-frequency components of the gravity function for these regions, it is believed that their centers of mass coincide with the centers of the regions indicated by circles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This problem can be solved by introducing additional information into the integrated image, which will make it possible to calculate not only the sum of the masses in a given region, but also the coordinates of the center of mass.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's try to imagine an image, each element of which contains its own coordinates. The corresponding integral image will contain the sum of the coordinates. Therefore, the sum of an arbitrary region of this integrated image, divided by the total number of elements in this region, will be equal to the coordinates of the center of this region. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/ay/cp/jcaycpxtpzl1zn73lydkfbuwzig.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integral image of coordinates</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let‚Äôs take for example the region in the lower left corner with coordinates {3; 1} and in the upper right with coordinates {7; 5}. The sum of the coordinates of this region {168; 120} - {18; 45} - {28; 0} + {3; 0} is {125; 75}, the total number of elements is 25, therefore, the coordinates of its center will be {5; 3}.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All that remains to be done is to generalize this particular case in which we consider that all elements of the image have the same weight coefficient equal to unity. To take into account different weights, we will multiply the coordinates of the elements by them. And we will get the weighted coordinates of the center of the region if we divide the sum of the weighted coordinates by the sum of the weighting factors. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o-/b5/nb/o-b5nb0apzvgpvx_mzegt-gcjza.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrated image of weighted coordinates. Larger font indicates weights</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the region in the lower left corner with coordinates {2; 1} and in the upper right with coordinates {5; 4}. The sum of the weighting coefficients of this region 4.8 - 1.0 - 0.6 + 0.2 is 3.4, and the sum of its weighted coordinates {11.1; 13.2} - {0.5; 2.0} - {1.5; 0,0} + {0,1; 0,0} is equal to {9,2; 11.2}. Thus, the weighted coordinates of the center of this region are {2.7; 3.3}. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that this circuit really works, you can visually - by converting the integrated image with weighted coordinates to a distance field using distance transform </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[19]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5-/id/lq/5-idlqqfst1l6fektpcfezhxp2s.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Converting an integrated image with weighted coordinates to a distance field. On the left is an image of the masses. The following image is the distance to the center of mass for a region of 3 √ó 3 elements. Next is the distance to the centers of mass for regions with sizes of 9 √ó 9 and 27 √ó 27 elements. The distance values ‚Äã‚Äãin this illustration are normalized to the size of the region used for sampling. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/dv/yy/q7/dvyyq7f-7eyoq3-ppjmfsoddouo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Converts an integrated image with weighted coordinates to a directed distance field. The direction and distance are color coded in HSV format, where Hue is the direction, Value is the normalized distance. The distance values ‚Äã‚Äãin this illustration are normalized to the size of the region used for sampling.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Summarizing all of the above:</font></font><br>
<br>
<ol>
<li>   ,     ,    ( ,  <i>R</i> = 3)  ‚Äï   ,  ,   .</li>
<li>               .</li>
<li>        O(1).</li>
<li>           O(M*N).</li>
</ol><br>
 <img src="https://habrastorage.org/webt/zk/ts/ti/zktstidnvrzkvinkpx9tiekqofy.png"><br>
<i>    .  ‚Äï        .  ‚Äï        .</i><br>
<br>
<h2>      </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Time to pay attention to one of the key features of integrated images, which still limits the scope of their application, namely, resource consumption and numerical stability. So, depending on the range of values ‚Äã‚Äãthat the original image contains, a longer data type may be required for its integral image. For example, when calculating the standard deviations, in addition to the original image (value range 0..255), an image containing squares of the corresponding values ‚Äã‚Äã(value range 0..65535) is used. In this case, accuracy is not enough for calculating large-scale integrated images of 32 bits </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[20]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar situation is observed in the case of integrated images with weighted coordinates. By itself, the value of the sum of coordinates that must be stored in the integrated image grows depending on the image size N: quadratically for the one-dimensional case 0 + 1 + 2 + ... + N - 1 = (N - 1) * N / 2 and cubically for two-dimensional N * (N - 1) * N / 2. For example, to store the sum of one integer coordinate for an image of 2048 √ó 2048 size (equal to 4292870144), a 32-bit unsigned integer (the maximum value of which is 4294967295) is barely enough. When calculating larger integrated images, overflow occurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The use of 32-bit floating-point numbers in integrated images delays the problem of overflow by an astronomical distance (10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">38</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but at the same time, the accuracy of calculations with weighted coordinates is significantly reduced due to the truncation error accumulated during summation </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[21]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ab/dc/hd/abdchducjcslm8db-fhmwtqnk14.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The absolute value of the error in calculating the weighted center of mass of a region with a size of 4 √ó 4 elements. The integrated image contains single precision numbers (32 bits). </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/wu/zt/qj/wuztqj-7c30j-yhdhnd7gwugrs4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The absolute value of the error in calculating the weighted center of mass of a region with a size of 32 √ó 32 elements. The integrated image contains single precision numbers (32 bits).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The largest absolute value is achieved by the calculation of the weighted center of mass for small regions. An increase in the size of the region by two orders of magnitude leads to a decrease in the magnitude of the absolute error of calculations by four orders of magnitude. In this case, no dependence of the calculation error on the range of values ‚Äã‚Äãof the weighting coefficients (which are used to calculate the weighted coordinates of the elements) was found. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nn/xg/at/nnxgat46ty-pm8x78yh9ph-d3cq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An increase in the range of weights does not affect the absolute value of the error in calculating the weighted center of mass. The graph shows the errors for the ‚Äúworst‚Äù region (in the upper right corner of the integrated image). The size of the integrated image is 256 √ó 256 elements.</font></font></i><br>
 <br>
<img src="https://habrastorage.org/webt/j3/im/68/j3im68bh4wkidntnuo9ihllayxs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The absolute value of the error in calculating the weighted center of mass decreases with increasing size of the region. The graph shows the errors for the ‚Äúworst‚Äù region (in the upper right corner of the integrated image).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Based on the analysis described above, we can conclude that the use of single-precision numbers for calculating weighted centers of mass using integrated images makes practical sense only for images of about 512 √ó 512 elements in size. With a further increase in size, the magnitude of the error becomes comparable with the size of the image element. And although this error decreases with increasing size of the region, it is regions of a small size that have the greatest impact on the final result - the magnitude of the force of gravity - therefore, only the corresponding errors should be taken into account.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for larger images, you can use double-precision weighted coordinates or add one more level of discretization: divide the original image into several parts and read the integral images separately for each of these parts. </font><font style="vertical-align: inherit;">From the point of view of computational complexity, if more than one integral image is used to calculate the sum of the elements of a region, but this ‚Äúmore than one‚Äù is a constant, the complexity of the sum calculation algorithm does not change.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above example of the use of an integrated image can probably be adapted to develop an optimal algorithm O (1) for sampling by importance (importance sampling). </font><font style="vertical-align: inherit;">Existing - and extremely resource-intensive from the point of view of GPU - algorithms have linear complexity O (N) and find application in modern methods of global lighting </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[22, 23]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, in my opinion, integrated images are one of the most underrated algorithms. </font><font style="vertical-align: inherit;">They can be an excellent alternative to mipmapping and anisotropic filtering at the same time, and taking into account how the latter is implemented on the GPU </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[24, 25]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is quite possible that they are already a more effective measure.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View list</font></font></b><div class="spoiler_text"><ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/N-body_problem</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/List_of_Solar_System_objects_by_size</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Near-Earth_object</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Asteroid</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Trojan_</a>(celestial_body)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Kuiper_belt</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Oort_cloud</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Computer_performance_by_orders_of_magnitude</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Barnes%E2%80%93Hut_simulation</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">link.springer.com/chapter/10.1007/978-1-4612-1252-2_10</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.researchgate.net/publication/281362507_Grid-Based_Hydrodynamics_in_Astrophysical_Fluid_Flows</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Multigrid_method</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Multipole_expansion</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">math.nyu.edu/faculty/greengar/shortcourse_fmm.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Summed-area_table</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.florian-oeser.de/wordpress/wp-content/2012/10/crow-1984.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.nmr.mgh.harvard.edu/~berkin/Bilgic_2010_Integral_Image.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Gaussian_blur</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Distance_transform</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">staffhome.ecm.uwa.edu.au/~00082689/papers/Shafait-efficient-binarization-SPIE08.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Truncation_error</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">t.co/Muf6I3yq71?amp=1</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">developer.nvidia.com/gpugems/gpugems3/part-iii-rendering/chapter-20-gpu-based-importance-sampling</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Mipmap</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Anisotropic_filtering</a></li>
</ol><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493284/index.html">Kubernetes 1.18: Overview of Key Innovations</a></li>
<li><a href="../en493288/index.html">Five Famous Explained Programming Quotes</a></li>
<li><a href="../en493292/index.html">Responsive or responsive? Parsing React Component Structure</a></li>
<li><a href="../en493294/index.html">We look inside the Soviet integrated circuit with TTL</a></li>
<li><a href="../en493298/index.html">C ++, metaprogramming and microcontroller registers</a></li>
<li><a href="../en493302/index.html">What technologies have already been called on to fight against coronavirus?</a></li>
<li><a href="../en493304/index.html">Developing a hexapod from scratch (part 8) - improved math movement</a></li>
<li><a href="../en493306/index.html">Using Gateway APIs as a Single Entry Point for Web Applications and APIs</a></li>
<li><a href="../en493308/index.html">Real experience of transferring almost all employees to a remote site</a></li>
<li><a href="../en493310/index.html">Game of God: Artificial Organisms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>