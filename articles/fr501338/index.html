<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∏ ü§¢ ‚ö°Ô∏è √Ä l'int√©rieur de la machine virtuelle Python. Partie 1 üíü üôáüèº üëã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous. J'ai finalement d√©cid√© de comprendre comment fonctionne l'interpr√©teur Python. Pour ce faire, il a commenc√© √† √©tudier un livre d'artic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>√Ä l'int√©rieur de la machine virtuelle Python. Partie 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501338/"><img src="https://habrastorage.org/webt/jm/9r/uc/jm9rucormi1lrcussoajjremszi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour √† tous. </font><font style="vertical-align: inherit;">J'ai finalement d√©cid√© de comprendre comment fonctionne l'interpr√©teur Python. </font><font style="vertical-align: inherit;">Pour ce faire, il a commenc√© √† √©tudier un livre d'articles et a con√ßu en m√™me temps le traduire en russe. </font><font style="vertical-align: inherit;">Le fait est que les traductions ne vous permettent pas de manquer une phrase incompr√©hensible et la qualit√© d'assimilation du mat√©riel augmente).</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je m'excuse √† l'avance pour d'√©ventuelles inexactitudes. </font><font style="vertical-align: inherit;">J'essaie toujours de traduire le plus correctement possible, mais l'un des principaux probl√®mes: il n'y a tout simplement aucune mention de certains termes dans l'√©quivalent russe.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note de traduction</font></font></b>
                        <div class="spoiler_text"> Python   ,  ¬´code object¬ª,  (  )     .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  </a>   .<br>
<br>
<b> </b> ‚Äî   Python,    -   ,     :   ,    ,  ( !    )  ,    ,     - (     )  .. ‚Äî    ()  -   str (,  Python3, bytes).<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le langage de programmation Python existe depuis un certain temps. </font><font style="vertical-align: inherit;">Le d√©veloppement de la premi√®re version a √©t√© lanc√© par Guido Van Rossum en 1989, et depuis lors, la langue s'est d√©velopp√©e et est devenue l'une des plus populaires. </font><font style="vertical-align: inherit;">Python est utilis√© dans diverses applications: des interfaces graphiques aux applications d'analyse de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le but de cet article est d'aller dans les coulisses de l'interpr√©teur et de fournir un aper√ßu conceptuel de la fa√ßon dont un programme √©crit en Python est ex√©cut√©. </font><font style="vertical-align: inherit;">CPython sera consid√©r√© dans l'article, car au moment de la r√©daction, c'est l'impl√©mentation Python la plus populaire et la plus basique.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python et CPython sont utilis√©s comme synonymes dans ce texte, mais toute mention de Python signifie CPython (la version python impl√©ment√©e en C). </font><font style="vertical-align: inherit;">D'autres impl√©mentations incluent PyPy (python impl√©ment√© dans un sous-ensemble limit√© de Python), Jython (impl√©mentation sur la machine virtuelle Java), etc.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'aime diviser l'ex√©cution d'un programme Python en deux ou trois √©tapes principales (list√©es ci-dessous), selon la fa√ßon dont l'interpr√©teur est appel√©. </font><font style="vertical-align: inherit;">Ces √©tapes seront trait√©es √† des degr√©s divers dans cet article:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - cette √©tape implique la mise en place des diff√©rentes structures de donn√©es requises par le processus python. </font><font style="vertical-align: inherit;">Cela se produira tr√®s probablement lorsque le programme sera ex√©cut√© en mode non interactif via le shell de l'interpr√©teur.</font></font></li>
<li><b></b> ‚Äî     , :       ,    ,       .</li>
<li><b></b> ‚Äî         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le m√©canisme de g√©n√©ration d'arbres "d'analyse", ainsi que d'arbres √† syntaxe abstraite (ASD), est ind√©pendant du langage. Par cons√©quent, nous ne couvrirons pas beaucoup ce sujet, car les m√©thodes utilis√©es en Python sont similaires aux m√©thodes d'autres langages de programmation. D'un autre c√¥t√©, le processus de construction de tables de symboles et d'objets de code √† partir d'ADS en Python est plus sp√©cifique, il m√©rite donc une attention particuli√®re. Il traite √©galement de l'interpr√©tation des objets de code compil√©s et de toutes les autres structures de donn√©es. Les sujets trait√©s par nous comprendront, sans s'y limiter: le processus de construction de tables de symboles et de cr√©ation d'objets de code, objets Python, objets de cadre, objets de code, objets fonctionnels, opcodes, boucles d'interpr√©teur, g√©n√©rateurs et classes d'utilisateurs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce mat√©riel est destin√© √† toute personne int√©ress√©e √† apprendre comment fonctionne la machine virtuelle CPython. Il est suppos√© que l'utilisateur est d√©j√† familier avec python et comprend les bases du langage. Lors de l'√©tude de la structure d'une machine virtuelle, nous rencontrerons une quantit√© importante de code C, il sera donc plus facile pour un utilisateur ayant une compr√©hension √©l√©mentaire du langage C de comprendre le mat√©riau. Et donc, fondamentalement, ce dont vous avez besoin pour vous familiariser avec ce mat√©riel: le d√©sir d'en savoir plus sur la machine virtuelle CPython. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article est une version √©tendue des notes personnelles faites dans l'√©tude du travail interne de l'interpr√®te. Il y a beaucoup de choses de qualit√© dans les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©os PyCon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les conf√©rences scolaires et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce blog.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mon travail n'aurait pas √©t√© achev√© sans ces fantastiques sources de connaissances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la fin de ce livre, le lecteur pourra comprendre les subtilit√©s de la fa√ßon dont l'interpr√©teur Python ex√©cute votre programme. </font><font style="vertical-align: inherit;">Cela comprend les diff√©rentes √©tapes de l'ex√©cution du programme et les structures de donn√©es qui sont critiques dans le programme. </font><font style="vertical-align: inherit;">Pour commencer, nous prendrons une vue d'ensemble de ce qui se passe lorsqu'un programme trivial est ex√©cut√©, lorsque le nom du module est transmis √† l'interpr√©teur sur la ligne de commande. </font><font style="vertical-align: inherit;">Le code ex√©cutable CPython peut √™tre install√© √† partir des sources, en suivant le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide du d√©veloppeur Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce livre utilise la version Python 3.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vue de 30 000 pieds</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce chapitre explique comment l'interpr√©teur ex√©cute un programme Python. Dans les chapitres suivants, nous examinerons les diff√©rentes parties de ce ¬´puzzle¬ª et fournirons une description plus d√©taill√©e de chaque partie. Quelle que soit la complexit√© d'un programme √©crit en Python, ce processus est toujours le m√™me. L'excellente explication donn√©e par Yaniv Aknin dans sa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©rie d'articles sur Python Internal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©finit le sujet de notre discussion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le module source test.py peut √™tre ex√©cut√© √† partir de la ligne de commande (en le passant comme argument au programme interpr√©teur Python sous la forme de $ python test.py). Ce n'est qu'une fa√ßon d'invoquer l'ex√©cutable Python. Nous pouvons √©galement lancer un interpr√©teur interactif, ex√©cuter des lignes d'un fichier sous forme de code, etc. Mais cela et d'autres m√©thodes ne nous int√©ressent pas. C'est le transfert du module en tant qu'argument (√† l'int√©rieur de la ligne de commande) vers le fichier ex√©cutable (figure 2.1) qui refl√®te le mieux le flux de diverses actions impliqu√©es dans l'ex√©cution r√©elle du code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/bw/i5/tlbwi5onywd5j1xmkmyv7ni_lgm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2.1: Stream √† l'ex√©cution.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ex√©cutable python est un programme C ordinaire, donc lorsqu'il est appel√©, des processus similaires √† ceux qui existent, par exemple, dans le noyau Linux ou le simple programme hello world, se produisent. </font><font style="vertical-align: inherit;">Prenez une minute de votre temps pour comprendre: l'ex√©cutable python n'est qu'un autre programme qui lance le v√¥tre. </font><font style="vertical-align: inherit;">De telles "relations" existent entre le langage C et l'assembleur (ou llvm). </font><font style="vertical-align: inherit;">Le processus d'initialisation standard (qui d√©pend de la plate-forme o√π l'ex√©cution a lieu) d√©marre lorsque l'ex√©cutable python est appel√© avec le nom du module comme argument.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet article suppose que vous utilisez un syst√®me d'exploitation bas√© sur Unix, donc certaines fonctionnalit√©s peuvent varier sous Windows.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le langage </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au d√©marrage ex√©cute toute sa ¬´magie¬ª d'initialisation - charge les biblioth√®ques, v√©rifie / d√©finit les variables d'environnement, et apr√®s cela, la m√©thode principale de l'ex√©cutable python est lanc√©e comme tout autre programme C. Le fichier ex√©cutable principal de Python se trouve dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Programs/python.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et effectue une initialisation (telle que la copie des arguments de ligne de commande de programme qui ont √©t√© pass√©s au module). La fonction principale appelle ensuite la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> situ√©e dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Modules/main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il traite le processus d'initialisation de l'interpr√©teur: analyse les arguments de la ligne de commande, d√©finit les drapeaux, lit les variables d'environnement, ex√©cute les hooks, randomise les fonctions de hachage, etc. Aussi appel√©</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylifecycle.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui g√®re l'initialisation de l'interpr√©teur et des structures de donn√©es d'√©tat de flux, sont deux structures de donn√©es tr√®s importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'examen des d√©clarations des structures de donn√©es de l'interpr√©teur et des √©tats des flux montre clairement pourquoi elles sont n√©cessaires. L'√©tat de l'interpr√©teur et du flux ne sont que des structures avec des pointeurs vers des champs qui contiennent les informations n√©cessaires √† l'ex√©cution du programme. Les donn√©es d'√©tat de l'interpr√©teur sont cr√©√©es via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (pensez simplement √† ce mot-cl√© en C comme d√©finition de type, bien que ce ne soit pas enti√®rement vrai). Le code de cette structure est indiqu√© dans l'extrait 2.1.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> {</span>
 <span class="hljs-number">2</span> 
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">tstate_head</span>;</span>
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         PyObject *modules;
 <span class="hljs-number">7</span>         PyObject *modules_by_index;
 <span class="hljs-number">8</span>         PyObject *sysdict;
 <span class="hljs-number">9</span>         PyObject *builtins;
<span class="hljs-number">10</span>         PyObject *importlib;
<span class="hljs-number">11</span> 
<span class="hljs-number">12</span>         PyObject *codec_search_path;
<span class="hljs-number">13</span>         PyObject *codec_search_cache;
<span class="hljs-number">14</span>         PyObject *codec_error_registry;
<span class="hljs-number">15</span>         <span class="hljs-keyword">int</span> codecs_initialized;
<span class="hljs-number">16</span>         <span class="hljs-keyword">int</span> fscodec_initialized;
<span class="hljs-number">17</span> 
<span class="hljs-number">18</span>         PyObject *builtins_copy;
<span class="hljs-number">19</span>     } PyInterpreterState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code 2.1: Structure des donn√©es d'√©tat de l'interpr√©teur</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Quiconque utilise le langage de programmation Python depuis longtemps peut reconna√Ætre plusieurs champs mentionn√©s dans cette structure (sysdict, builtins, codec).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le champ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* next</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une r√©f√©rence √† une autre instance de l'interpr√©teur, car plusieurs interpr√®tes Python peuvent exister dans le m√™me processus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">champ * tstate_head</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indique le thread principal d'ex√©cution (si le programme est multi-thread, alors l'interpr√©teur est commun √† tous les threads cr√©√©s par le programme). </font><font style="vertical-align: inherit;">Nous en discuterons plus en d√©tail sous peu.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modules, modules_by_index, sysdict, builtins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importlib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parlent d'eux-m√™mes. </font><font style="vertical-align: inherit;">Tous sont d√©finis comme des instances de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est le type racine de tous les objets de la machine virtuelle Python. </font><font style="vertical-align: inherit;">Les objets Python seront discut√©s plus en d√©tail dans les chapitres suivants.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les champs li√©s au </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codec *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contiennent des informations qui aident au t√©l√©chargement des encodages. </font><font style="vertical-align: inherit;">Ceci est tr√®s important pour le d√©codage d'octets.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ex√©cution du programme doit avoir lieu dans un thread. </font><font style="vertical-align: inherit;">La structure d'√©tat du flux contient toutes les informations dont le flux a besoin pour ex√©cuter un objet de code. </font><font style="vertical-align: inherit;">Une partie de la structure des donn√©es de flux est pr√©sent√©e dans le Listing 2.2.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> {</span>
 <span class="hljs-number">2</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">prev</span>;</span>
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         PyInterpreterState *interp;
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">frame</span> *<span class="hljs-title">frame</span>;</span>
 <span class="hljs-number">7</span>         <span class="hljs-keyword">int</span> recursion_depth;
 <span class="hljs-number">8</span>         <span class="hljs-keyword">char</span> overflowed; 
 <span class="hljs-number">9</span>                         
<span class="hljs-number">10</span>         <span class="hljs-keyword">char</span> recursion_critical; 
<span class="hljs-number">11</span>         <span class="hljs-keyword">int</span> tracing;
<span class="hljs-number">12</span>         <span class="hljs-keyword">int</span> use_tracing;
<span class="hljs-number">13</span> 
<span class="hljs-number">14</span>         Py_tracefunc c_profilefunc;
<span class="hljs-number">15</span>         Py_tracefunc c_tracefunc;
<span class="hljs-number">16</span>         PyObject *c_profileobj;
<span class="hljs-number">17</span>         PyObject *c_traceobj;
<span class="hljs-number">18</span> 
<span class="hljs-number">19</span>         PyObject *curexc_type;
<span class="hljs-number">20</span>         PyObject *curexc_value;
<span class="hljs-number">21</span>         PyObject *curexc_traceback;
<span class="hljs-number">22</span> 
<span class="hljs-number">23</span>         PyObject *exc_type;
<span class="hljs-number">24</span>         PyObject *exc_value;
<span class="hljs-number">25</span>         PyObject *exc_traceback;
<span class="hljs-number">26</span> 
<span class="hljs-number">27</span>         PyObject *dict;  <span class="hljs-comment">/* Stores per-thread state */</span>
<span class="hljs-number">28</span>         <span class="hljs-keyword">int</span> gilstate_counter;
<span class="hljs-number">29</span> 
<span class="hljs-number">30</span>         ... 
<span class="hljs-number">31</span>     } PyThreadState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 2.2: Partie de la</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
structure des </font><i><font style="vertical-align: inherit;">donn√©es d'√©tat du flux</font></i><font style="vertical-align: inherit;"> Les structures de </font><i><font style="vertical-align: inherit;">donn√©es de l'</font></i><font style="vertical-align: inherit;"> interpr√©teur et les √©tats du flux sont abord√©s plus en d√©tail dans les chapitres suivants. Le processus d'initialisation met √©galement en place des m√©canismes d'importation ainsi que des stdio √©l√©mentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir termin√© toute l'initialisation, Py_Main appelle la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (√©galement situ√©e dans le module main.c). Voici une s√©rie d'appels de fonction: PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags -&gt; PyRun_FileExFlags -&gt; PyParser_ASTFromFileObject. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyRun_SimpleFileExFlags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©e l'espace de noms __main__ dans lequel le contenu du fichier sera ex√©cut√©. Il v√©rifie √©galement si la version pyc du fichier existe (le fichier pyc est un simple fichier contenant une version d√©j√† compil√©e du code source). S'il existe une version pyc, une tentative sera faite de la lire en tant que fichier binaire, puis de l'ex√©cuter. Si le fichier pyc est manquant, alors PyRun_FileExFlags est appel√©, etc. La fonction PyParser_ASTFromFileObject appelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ParseFileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui lit le contenu du module et en construit des arbres d'analyse. Ensuite, l'arborescence cr√©√©e est transmise √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ASTFromNodeObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui en cr√©e une arborescence de syntaxe abstraite.</font></font><br>
<br>
<blockquote>     ,     Py_INCREF  Py_DECREF.    ,     . CPython        :  ,      ,    Py_INCREF. ,      ,       Py_DECREF.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AST est g√©n√©r√© lorsque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_mod est</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appel√© </font><font style="vertical-align: inherit;">. Cette fonction appelle </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyAST_CompileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui cr√©e des objets de code √† partir d'AST. Notez que le bytecode g√©n√©r√© pendant l'appel PyAST_CompileObject est transmis via l'optimiseur de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">judas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple </font><font style="vertical-align: inherit;">, qui effectue une faible optimisation du bytecode g√©n√©r√© avant de cr√©er des objets de code. La fonction de run_mod applique alors la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyEval_EvalCode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonction </font><font style="vertical-align: inherit;">du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ceval.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fichier </font><font style="vertical-align: inherit;">√† l'objet de code. Cela conduit √† une autre s√©rie d'appels de fonction: PyEval_EvalCode -&gt; PyEval_EvalCode -&gt; _PyEval_EvalCodeWithName -&gt; _PyEval_EvalFrameEx. L'objet code est pass√© en argument √† la plupart de ces fonctions sous une forme ou une autre. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_PyEval_EvalFrameEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Il s'agit d'une boucle d'interpr√©teur normale qui g√®re l'ex√©cution des objets de code. Cependant, il est appel√© non seulement avec l'objet code comme argument, mais avec l'objet frame, qui a pour attribut un champ qui fait r√©f√©rence √† l'objet code. Ce cadre fournit le contexte pour l'ex√©cution de l'objet de code. En termes simples: la boucle d'interpr√©tation lit en continu l'instruction suivante indiqu√©e par le compteur d'instructions dans le tableau d'instructions. Ensuite, il ex√©cute cette instruction: il ajoute ou supprime des objets de la pile de valeurs dans le processus jusqu'√† ce qu'il se vide dans le tableau d'instructions √† ex√©cuter (enfin, ou quelque chose d'exceptionnel se produit qui perturbe la boucle).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python fournit un ensemble de fonctions que vous pouvez utiliser pour examiner des objets de code r√©els. Par exemple, un programme simple peut √™tre compil√© en un objet code et d√©sassembl√© pour obtenir des opcodes ex√©cut√©s par la machine virtuelle python. Ceci est illustr√© dans le Listing 2.3.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">1</span>         &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square</span>(<span class="hljs-params">x</span>):</span>
<span class="hljs-number">2</span>         ...     <span class="hljs-keyword">return</span> x*x
<span class="hljs-number">3</span>         ... 
<span class="hljs-number">4</span> 
<span class="hljs-number">5</span>         &gt;&gt;&gt; dis(square)
<span class="hljs-number">6</span>         <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">7</span>                     <span class="hljs-number">2</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">8</span>                     <span class="hljs-number">4</span> BINARY_MULTIPLY     
<span class="hljs-number">9</span>                     <span class="hljs-number">6</span> RETURN_VALUE        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de code 2.3: D√©sassembler une fonction en Python Le </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fichier d'en-t√™te </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Include/opcodes.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contient une liste compl√®te de toutes les instructions / opcodes pour la machine virtuelle Python. Les opcode sont assez simples. Prenons notre exemple dans le Listing 2.3, qui contient un ensemble de quatre instructions. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOAD_FAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> charge la valeur de son argument (dans ce cas x) </font><b><font style="vertical-align: inherit;">sur la</font></b><font style="vertical-align: inherit;"> pile de valeurs. La machine virtuelle python est bas√©e sur la pile, de sorte que les valeurs des op√©rations d'opcode sont ¬´extraites¬ª de la pile et les r√©sultats du calcul sont repouss√©s sur la pile pour une utilisation ult√©rieure par d'autres opcodes. Ensuite, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BINARY_MULTIPLY extrait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deux √©l√©ments de la pile, effectue une multiplication binaire des deux valeurs et repousse le r√©sultat </font><b><font style="vertical-align: inherit;">sur la</font></b><font style="vertical-align: inherit;"> pile. Instruction </font><b><font style="vertical-align: inherit;">VALEUR</font></b><font style="vertical-align: inherit;"> RENVOY√âE</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©cup√®re une valeur de la pile, d√©finit la valeur de retour de l'objet sur cette valeur et quitte la boucle d'interpr√©teur. </font><font style="vertical-align: inherit;">Si vous regardez le Listing 2.3, il est clair que c'est une simplification assez forte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'explication actuelle de la boucle d'interpr√©tation ne prend pas en compte un certain nombre de d√©tails, qui seront discut√©s dans les chapitres suivants. </font><font style="vertical-align: inherit;">Par exemple, voici les questions auxquelles nous n'avons pas re√ßu de r√©ponse:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'o√π proviennent les valeurs charg√©es par l'instruction LOAD_FAST?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'o√π viennent les arguments, qui sont utilis√©s dans le cadre des instructions?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment les appels de fonction et de m√©thode imbriqu√©s sont-ils trait√©s?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment la boucle interpr√®te g√®re-t-elle les exceptions?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir termin√© toutes les instructions, la fonction Py_Main continue son ex√©cution, mais cette fois d√©marre le processus de nettoyage. </font><font style="vertical-align: inherit;">Si </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est appel√© pour effectuer l'initialisation lors du d√©marrage de l'interpr√©teur, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_FinalizeEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est appel√© pour effectuer le nettoyage. </font><font style="vertical-align: inherit;">Ce processus comprend l'attente de la sortie des threads, l'appel √† tous les gestionnaires de sortie, ainsi que la lib√©ration de la m√©moire encore utilis√©e allou√©e par l'interpr√©teur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, nous avons examin√© la description "de haut niveau" des processus qui se produisent dans l'ex√©cutable Python lorsqu'un script est ex√©cut√©. </font><font style="vertical-align: inherit;">Comme indiqu√© pr√©c√©demment, de nombreuses questions restent sans r√©ponse. </font><font style="vertical-align: inherit;">√Ä l'avenir, nous approfondirons l'√©tude de l'interpr√®te et examinerons en d√©tail chacune des √©tapes. </font><font style="vertical-align: inherit;">Et nous commencerons par d√©crire le processus de compilation dans le chapitre suivant.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501326/index.html">Comment devenir ing√©nieur DevOps en six mois ou plus vite. Partie 3. Versions</a></li>
<li><a href="../fr501328/index.html">Pr√©sentation des espaces de code Visual Studio: d√©veloppement cloud, o√π que vous soyez</a></li>
<li><a href="../fr501330/index.html">Microservices en C ++. Fiction ou r√©alit√©?</a></li>
<li><a href="../fr501332/index.html">Les r√©unions sont faciles. Trois conseils pratiques quotidiens</a></li>
<li><a href="../fr501336/index.html">FOSS News n ¬∞ 15 - une revue des nouvelles gratuites et open source du 4 au 10 mai 2020</a></li>
<li><a href="../fr501340/index.html">Pourquoi Flutter gagne-t-il?</a></li>
<li><a href="../fr501342/index.html">Certification Microsoft en ligne - Remarques sur le terrain</a></li>
<li><a href="../fr501344/index.html">Ventilation d'alimentation combin√©e √† la climatisation de conduit (partie 1 - √©lectrique)</a></li>
<li><a href="../fr501346/index.html">Pr√©sentation du clavier m√©canique Vortex Core RGB</a></li>
<li><a href="../fr501352/index.html">Kafka contre-attaque</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>