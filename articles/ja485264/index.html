<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🍳 👩🏼‍🔬 🙎🏽 zipアーカイブはどのように見え、それで何ができるか。パート4-アーカイブの読み取り 🧛🏼 👩🏼‍🎓 👩‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ZipアーカイブとPHPに関するサイクルの継続。前の記事：第1部、第2 部 、第3部
 
 こんにちは。
 今回は、おそらくZipアーカイブとPHPに関するサイクルの最後の部分を紹介したいと思います。
 
 この記事では、既存のアーカイブを読み取る方法を示します。例として、前の記事のphotos.z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>zipアーカイブはどのように見え、それで何ができるか。パート4-アーカイブの読み取り</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485264/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZipアーカイブとPHPに関するサイクルの継続。前の記事：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1部</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2 </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部</font></font></a></i> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">、</font></i><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">第3部</font></a></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
こんにちは。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回は、おそらくZipアーカイブとPHPに関するサイクルの最後の部分を紹介したいと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、既存のアーカイブを読み取る方法を示します。例として</font><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">前の記事の</font></a></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">photos.zip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">取り上げ</font></b></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。すべての手順を繰り返さないように、既製の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/userqq/images/raw/master/photos.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで少し脱線して、アーカイブが何で構成されているかを覚えておきましょう。最初に、パックされたファイルデータのセットがあり、各パックされたファイルの前にローカルファイルヘッダー（LFH）構造があり、すべてのデータの後に、セントラルディレクトリファイルヘッダー（CDFH）構造のセットがあります。 -これは私たちのアーカイブの目次であり、すべての要素とファイルの先頭を基準にしたそれらの変位の位置がリストされています。そして、End Of Central Directory Record（EOCD）アーカイブが完了します-ここに、CDFH構造の始まりの位置、それらの数、およびバイト単位の全長が示されます。したがって、最初にEOCDを見つけてからCDFH構造を読み取り、アーカイブ内のファイルのリストを取得するために、アーカイブを最後から読み取る必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考：そして、JPEGのようないくつかのフォーマットは最初から読み込まれます。したがって、アーカイブを使用して画像を接着できます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">猫image.jpeg archive.zip&gt; imagearchive.jpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能を失うことなく。画像を表示するためのブラウザとアプリケーションは問題なく画像を表示します。 zipアーカイブを読み取るためのアプリケーションは、7zであってもunzipであっても、ファイルをアーカイブとして静かに処理できます。たとえば、ここ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-https://github.com/userqq/images/blob/master/jpegarchive.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（注意、これは約20MBの重量があるため、電話からトラフィックを開いたり、トラフィックが必要な場合はお勧めしません）。したがって、画像のホスティングがわかっていて、画像が再コーディングされておらず、トリミングされていない場合は、そこに画像だけでなくアップロードすることもできます:)私には思えますが、今はこれらを見つけることができません。</font></font></i><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、unpackでの作業を容易にする補助関数を定義します（</font><font style="vertical-align: inherit;">靴下で作業するためにリポジトリの1 </font><font style="vertical-align: inherit;">つでこのアイデアを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手がかりに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、ケースに合わせて少し変更しました）。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readBytes</span>(<span class="hljs-params">$fh, $formatArray</span>)
</span>{
    <span class="hljs-comment">//          pack()</span>
    <span class="hljs-comment">// https://www.php.net/manual/ru/function.pack.php</span>
    <span class="hljs-comment">//       </span>
    <span class="hljs-comment">// , L = unsigned long 32bit = 4 </span>
    <span class="hljs-built_in">static</span> $lengths = [<span class="hljs-string">'L'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'l'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'i'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'I'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'S'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'a'</span> =&gt; <span class="hljs-number">1</span>]; <font></font>
    <font></font>
    <span class="hljs-comment">//     , </span>
    <span class="hljs-comment">//    fread()     .</span>
    $totalLength = <span class="hljs-number">0</span>;<font></font>
    <font></font>
    <span class="hljs-comment">//      ,     unpack();</span><font></font>
    $unpackFormat = [];<font></font>
    <font></font>
    <span class="hljs-comment">//   ,        -,     0.</span>
    <span class="hljs-comment">// ,    ,      0,      . </span>
    <span class="hljs-comment">//      </span><font></font>
    $nullData = [];<font></font>
    <font></font>
    <span class="hljs-keyword">foreach</span> ($formatArray <span class="hljs-keyword">as</span> $name =&gt; $format) {<font></font>
        $length = <span class="hljs-number">1</span>;
        <span class="hljs-comment">//      , , ['versionMadeBy' =&gt; 'S'],</span>
        <span class="hljs-comment">//       SversionMadeBy</span>
        <span class="hljs-comment">//   ['filename' =&gt; ['a', $filenameLength]]</span>
        <span class="hljs-comment">//    "a{$filenameLength}filename"</span>
        <span class="hljs-keyword">if</span> (is_array($format)) {<font></font>
            [$format, $length] = $format;<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-comment">//    ,    - </span>
        <span class="hljs-comment">//  ['extraFieldLength' =&gt; ['a', 0]]</span>
        <span class="hljs-comment">//       </span>
        <span class="hljs-comment">//      ['extraFieldLength' =&gt; null]</span>
        <span class="hljs-keyword">if</span> ($length &lt; <span class="hljs-number">1</span>) {<font></font>
            $nullData[] = $name;<font></font>
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <font></font>
        $totalLength += $lengths[$format] * $length;<font></font>
        $unpackFormat[] = $format . (($length &gt; <span class="hljs-number">1</span>) ? $length : <span class="hljs-string">''</span>) . $name;<font></font>
    }<font></font>
    <font></font>
    $packet = [];    <font></font>
    <span class="hljs-keyword">if</span> ($totalLength &gt; <span class="hljs-number">0</span>) {<font></font>
        $packet = unpack(implode(<span class="hljs-string">'/'</span>, $unpackFormat), fread($fh, $totalLength));<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">foreach</span> ($nullData <span class="hljs-keyword">as</span> $empty) {<font></font>
        $packet[$empty] = <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> $packet;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、EOCD構造を見つけてみましょう。</font><font style="vertical-align: inherit;">コメントがない場合の最小長は22バイトで、そのうち最初の4文字は署名です。</font><font style="vertical-align: inherit;">したがって、最初にfilesize（$ file）-22の位置に移動し、次の4バイトを読み取ります。幸運で、これらのバイトが署名（0x06054b50）と等しい場合、これがEOCDです。</font><font style="vertical-align: inherit;">運が悪い場合-バイトごとに、ファイルが見つかるか、またはファイルが終了するまでファイルの先頭に移動します。おそらく、これはアーカイブではありません。</font></font><br>
<br>
<pre><code class="php hljs">$fh = fopen(<span class="hljs-string">'photos.zip'</span>, <span class="hljs-string">'r'</span>);<font></font>
<font></font>
<span class="hljs-keyword">for</span> ($offset = <span class="hljs-number">22</span>, $length = fstat($fh)[<span class="hljs-string">'size'</span>]; $offset &lt;= $length; $offset++) {<font></font>
    fseek($fh, $offset * <span class="hljs-number">-1</span>, SEEK_END);<font></font>
    <font></font>
    <span class="hljs-comment">// "\x50\x4b\x05\x06" === pack('L', 0x06054b50),  EOCD</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x05\x06"</span> === $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'EOCD    '</span> . ($length - $offset) . PHP_EOL;
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
$EOCD = readBytes($fh, [<font></font>
    <span class="hljs-string">'diskNumber'</span>                   =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'startDiskNumber'</span>              =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'numberCentralDirectoryRecord'</span> =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'totalCentralDirectoryRecord'</span>  =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'sizeOfCentralDirectory'</span>       =&gt; <span class="hljs-string">'L'</span>,
    <span class="hljs-string">'centralDirectoryOffset'</span>       =&gt; <span class="hljs-string">'L'</span>,
    <span class="hljs-string">'commentLength'</span>                =&gt; <span class="hljs-string">'S'</span>,<font></font>
]);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> <span class="hljs-string">'  : '</span> . $EOCD[<span class="hljs-string">'numberCentralDirectoryRecord'</span>] . PHP_EOL;
<span class="hljs-keyword">echo</span> <span class="hljs-string">' CDFH: '</span> . $EOCD[<span class="hljs-string">'centralDirectoryOffset'</span>] . PHP_EOL;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、アーカイブにある要素の数と、「目次」が始まる場所、つまりCDFH構造のリストがわかりました。</font><font style="vertical-align: inherit;">それらを反復処理して、各アーカイブ要素の名前、データサイズ、LFH開始位置を取得できます。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">echo</span> <span class="hljs-string">'   :'</span> . PHP_EOL;<font></font>
<font></font>
<span class="hljs-comment">//  ,       CDFH  LFH -</span>
$offset = $EOCD[<span class="hljs-string">'centralDirectoryOffset'</span>];
<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; $EOCD[<span class="hljs-string">'numberCentralDirectoryRecord'</span>]; $i++) {<font></font>
    fseek($fh, $offset, SEEK_SET);<font></font>
    <font></font>
    <span class="hljs-comment">// "\x50\x4b\x01\x02" === pack('L', 0x02014b50),  CDFH</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x01\x02"</span> !== $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">exit</span>(<span class="hljs-string">'  CDFH'</span> . PHP_EOL);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-comment">//  CDFH</span><font></font>
    $CDFH = readBytes($fh, [<font></font>
        <span class="hljs-string">'versionMadeBy'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'versionToExtract'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'compressionMethod'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationTime'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationDate'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'crc32'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'compressedSize'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'uncompressedSize'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'filenameLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'extraFieldLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'fileCommentLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'diskNumber'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'internalFileAttributes'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'externalFileAttributes'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'localFileHeaderOffset'</span> =&gt; <span class="hljs-string">'L'</span>,        <font></font>
    ]);<font></font>
    $CDFH += readBytes($fh, [<font></font>
        <span class="hljs-string">'filename'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'filenameLength'</span>]],
        <span class="hljs-string">'extraField'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'extraFieldLength'</span>]],
        <span class="hljs-string">'fileComment'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'fileCommentLength'</span>]],<font></font>
    ]);<font></font>
    <font></font>
    <span class="hljs-comment">// ,       CDFH</span><font></font>
    $offset = ftell($fh);<font></font>
    <font></font>
    <span class="hljs-comment">//   LFH</span>
    fseek($fh, $CDFH[<span class="hljs-string">'localFileHeaderOffset'</span>], SEEK_SET);<font></font>
    <font></font>
    <font></font>
    <span class="hljs-comment">// "\x50\x4b\x03\x04" === pack('L', 0x04034b50),  LFH</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x03\x04"</span> !== $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">exit</span>(<span class="hljs-string">'  LFH'</span> . PHP_EOL);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-comment">//  LFH</span><font></font>
    $LFH = readBytes($fh, [<font></font>
        <span class="hljs-string">'versionToExtract'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'compressionMethod'</span>     =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationTime'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationDate'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'crc32'</span>                 =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'compressedSize'</span>        =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'uncompressedSize'</span>      =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'filenameLength'</span>        =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'extraFieldLength'</span>      =&gt; <span class="hljs-string">'S'</span>,<font></font>
    ]);<font></font>
    $LFH += readBytes($fh, [<font></font>
        <span class="hljs-string">'filename'</span>    =&gt; [<span class="hljs-string">'a'</span>, $LFH[<span class="hljs-string">'filenameLength'</span>]],
        <span class="hljs-string">'extraField'</span>  =&gt; [<span class="hljs-string">'a'</span>, $LFH[<span class="hljs-string">'extraFieldLength'</span>]],<font></font>
    ]);<font></font>
    <font></font>
    $dataOffset = ftell($fh);<font></font>
    <font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'&gt; '</span> . $CDFH[<span class="hljs-string">'filename'</span>] . <span class="hljs-string">' '</span> . $CDFH[<span class="hljs-string">'compressedSize'</span>] . <span class="hljs-string">' , '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'LFH: '</span>  . $CDFH[<span class="hljs-string">'localFileHeaderOffset'</span>] . <span class="hljs-string">', '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">' : '</span>  . $dataOffset . <span class="hljs-string">', '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">' : '</span> . ($dataOffset + $CDFH[<span class="hljs-string">'compressedSize'</span>]);
    <span class="hljs-keyword">echo</span> PHP_EOL;<font></font>
    <font></font>
} <font></font>
<font></font>
fclose($fp);</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般に、レコードごとにファイルを前後に実行することは、パフォーマンスの点で最良のアイデアではないため、すべてのCDFH構造を読み取り、必要に応じてLFHとデータの読み取りに進むことをお勧めしますが、ここにそれがあります。型破りなプログラミングです」 </font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なスクリプトコード</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readBytes</span>(<span class="hljs-params">$fh, $formatArray</span>)
</span>{
    <span class="hljs-built_in">static</span> $lengths = [<span class="hljs-string">'L'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'l'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'i'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'I'</span> =&gt; <span class="hljs-number">4</span>, <span class="hljs-string">'S'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'a'</span> =&gt; <span class="hljs-number">1</span>]; <font></font>
    <font></font>
    $totalLength = <span class="hljs-number">0</span>;<font></font>
    $unpackFormat = [];<font></font>
    $nullData = [];<font></font>
    <font></font>
    <span class="hljs-keyword">foreach</span> ($formatArray <span class="hljs-keyword">as</span> $name =&gt; $format) {<font></font>
        $length = <span class="hljs-number">1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (is_array($format)) {<font></font>
            [$format, $length] = $format;<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> ($length &lt; <span class="hljs-number">1</span>) {<font></font>
            $nullData[] = $name;<font></font>
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <font></font>
        $totalLength += $lengths[$format] * $length;<font></font>
        $unpackFormat[] = $format . (($length &gt; <span class="hljs-number">1</span>) ? $length : <span class="hljs-string">''</span>) . $name;<font></font>
    }<font></font>
    <font></font>
    $packet = [];    <font></font>
    <span class="hljs-keyword">if</span> ($totalLength &gt; <span class="hljs-number">0</span>) {<font></font>
        $packet = unpack(implode(<span class="hljs-string">'/'</span>, $unpackFormat), fread($fh, $totalLength));<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">foreach</span> ($nullData <span class="hljs-keyword">as</span> $empty) {<font></font>
        $packet[$empty] = <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> $packet;<font></font>
}<font></font>
<font></font>
$fh = fopen(<span class="hljs-string">'photos.zip'</span>, <span class="hljs-string">'r'</span>);<font></font>
<font></font>
<span class="hljs-keyword">for</span> ($offset = <span class="hljs-number">22</span>, $length = fstat($fh)[<span class="hljs-string">'size'</span>]; $offset &lt;= $length; $offset++) {<font></font>
    fseek($fh, $offset * <span class="hljs-number">-1</span>, SEEK_END);<font></font>
    <font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x05\x06"</span> === $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'EOCD    '</span> . ($length - $offset) . PHP_EOL;
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
$EOCD = readBytes($fh, [<font></font>
    <span class="hljs-string">'diskNumber'</span>                   =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'startDiskNumber'</span>              =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'numberCentralDirectoryRecord'</span> =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'totalCentralDirectoryRecord'</span>  =&gt; <span class="hljs-string">'S'</span>,
    <span class="hljs-string">'sizeOfCentralDirectory'</span>       =&gt; <span class="hljs-string">'L'</span>,
    <span class="hljs-string">'centralDirectoryOffset'</span>       =&gt; <span class="hljs-string">'L'</span>,
    <span class="hljs-string">'commentLength'</span>                =&gt; <span class="hljs-string">'S'</span>,<font></font>
]);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> <span class="hljs-string">'  : '</span> . $EOCD[<span class="hljs-string">'numberCentralDirectoryRecord'</span>] . PHP_EOL;
<span class="hljs-keyword">echo</span> <span class="hljs-string">'  CDFH: '</span> . $EOCD[<span class="hljs-string">'centralDirectoryOffset'</span>] . PHP_EOL;<font></font>
<font></font>
<span class="hljs-keyword">echo</span> <span class="hljs-string">'   :'</span> . PHP_EOL;<font></font>
<font></font>
$offset = $EOCD[<span class="hljs-string">'centralDirectoryOffset'</span>];
<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">0</span>; $i &lt; $EOCD[<span class="hljs-string">'numberCentralDirectoryRecord'</span>]; $i++) {<font></font>
    fseek($fh, $offset, SEEK_SET);<font></font>
    <font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x01\x02"</span> !== $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">exit</span>(<span class="hljs-string">'  CDFH'</span> . PHP_EOL);<font></font>
    }<font></font>
    <font></font>
    $CDFH = readBytes($fh, [<font></font>
        <span class="hljs-string">'versionMadeBy'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'versionToExtract'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'compressionMethod'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationTime'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationDate'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'crc32'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'compressedSize'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'uncompressedSize'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'filenameLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'extraFieldLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'fileCommentLength'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'diskNumber'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'internalFileAttributes'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'externalFileAttributes'</span> =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'localFileHeaderOffset'</span> =&gt; <span class="hljs-string">'L'</span>,        <font></font>
    ]);<font></font>
    $CDFH += readBytes($fh, [<font></font>
        <span class="hljs-string">'filename'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'filenameLength'</span>]],
        <span class="hljs-string">'extraField'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'extraFieldLength'</span>]],
        <span class="hljs-string">'fileComment'</span> =&gt; [<span class="hljs-string">'a'</span>, $CDFH[<span class="hljs-string">'fileCommentLength'</span>]],<font></font>
    ]);<font></font>
    <font></font>
    $offset = ftell($fh);<font></font>
    <font></font>
    fseek($fh, $CDFH[<span class="hljs-string">'localFileHeaderOffset'</span>], SEEK_SET);<font></font>
    <font></font>
    <font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"\x50\x4b\x03\x04"</span> !== $bytes = fread($fh, <span class="hljs-number">4</span>)) {
        <span class="hljs-keyword">exit</span>(<span class="hljs-string">'  LFH'</span> . PHP_EOL);<font></font>
    }<font></font>
    <font></font>
    $LFH = readBytes($fh, [<font></font>
        <span class="hljs-string">'versionToExtract'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'generalPurposeBitFlag'</span> =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'compressionMethod'</span>     =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationTime'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'modificationDate'</span>      =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'crc32'</span>                 =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'compressedSize'</span>        =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'uncompressedSize'</span>      =&gt; <span class="hljs-string">'L'</span>,
        <span class="hljs-string">'filenameLength'</span>        =&gt; <span class="hljs-string">'S'</span>,
        <span class="hljs-string">'extraFieldLength'</span>      =&gt; <span class="hljs-string">'S'</span>,<font></font>
    ]);<font></font>
    $LFH += readBytes($fh, [<font></font>
        <span class="hljs-string">'filename'</span>    =&gt; [<span class="hljs-string">'a'</span>, $LFH[<span class="hljs-string">'filenameLength'</span>]],
        <span class="hljs-string">'extraField'</span>  =&gt; [<span class="hljs-string">'a'</span>, $LFH[<span class="hljs-string">'extraFieldLength'</span>]],<font></font>
    ]);<font></font>
    <font></font>
    $dataOffset = ftell($fh);<font></font>
    <font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'&gt; '</span> . $CDFH[<span class="hljs-string">'filename'</span>] . <span class="hljs-string">' '</span> . $CDFH[<span class="hljs-string">'compressedSize'</span>] . <span class="hljs-string">' , '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'LFH: '</span>  . $CDFH[<span class="hljs-string">'localFileHeaderOffset'</span>] . <span class="hljs-string">', '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">' : '</span>  . $dataOffset . <span class="hljs-string">', '</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">' : '</span> . ($dataOffset + $CDFH[<span class="hljs-string">'compressedSize'</span>]);
    <span class="hljs-keyword">echo</span> PHP_EOL;<font></font>
    <font></font>
}<font></font>
<font></font>
fclose($fh);<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの結果として、以下に関するアーカイブに関する情報を取得する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ php readzip.php<font></font>
EOCD    18873702<font></font>
  : 172<font></font>
 CDFH: 18864696<font></font>
   :<font></font>
&gt; 0.jpg 135021 , LFH: 0,  : 35,  : 135056<font></font>
&gt; 1.jpg 205686 , LFH: 135056,  : 135091,  : 340777<font></font>
&gt; 2.jpg 81393 , LFH: 340777,  : 340812,  : 422205<font></font>
&gt; 3.jpg 64892 , LFH: 422205,  : 422240,  : 487132<font></font>
...<font></font>
&gt; 171.jpg 50465 , LFH: 18814194,  : 18814231,  : 18864696<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして一般的に、これらのデータのおかげで、すべてまたは特定のファイルを既に抽出できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗号化圧縮をバイパスして、アーカイブにデータがある場合のみを考慮しましたが、これは構造を理解するために必要ではありません。混乱したい場合は、この一連の記事に基づいて仕様を読み、不足している機能を追加することは難しくありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、メインサイクルが終了したと考えることができると思います。</font><font style="vertical-align: inherit;">それでも質問がある場合、または以前の記事へのコメントで言及を思い出す場合は、追加の記事がある可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シムすべてのために。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それだけでは不十分でしたが、それでも面白かったです:)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485238/index.html">Reduxセレクターを使いすぎている</a></li>
<li><a href="../ja485240/index.html">VPSでのgo goプロジェクトのレイアウト</a></li>
<li><a href="../ja485246/index.html">DevOpsを使用して本格的な社内開発を構築する方法-VTBエクスペリエンス</a></li>
<li><a href="../ja485256/index.html">Ivan LilekvistとKim Dotkom、大インタビュー：メガアップロード、米国への引き渡し、自由、ビットコインの物語。パート1</a></li>
<li><a href="../ja485260/index.html">初心者ビジネスアナリストの13の間違い</a></li>
<li><a href="../ja485266/index.html">Habrコンテスト：アイデアコンテストの勝者</a></li>
<li><a href="../ja485268/index.html">.NETがどこでも機能する場合、Windows 3.11およびDOSでも</a></li>
<li><a href="../ja485270/index.html">管理者をハック</a></li>
<li><a href="../ja485272/index.html">Taimyrコンピューター-進化はその逆</a></li>
<li><a href="../ja485274/index.html">RaiffeisenbankでのモスクワJSミートアップ：放送を続ける</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>