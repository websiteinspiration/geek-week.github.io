<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👌🏾 🎡 👇🏿 Organisasi organisasi SMB kerja jarak jauh pada OpenVPN ☕️ ⛹🏻 👴🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Perumusan masalah
 Artikel ini menjelaskan organisasi akses jarak jauh bagi karyawan pada produk-produk open source dan dapat digunakan baik untuk mem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Organisasi organisasi SMB kerja jarak jauh pada OpenVPN</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501048/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perumusan masalah</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel ini menjelaskan organisasi akses jarak jauh bagi karyawan pada produk-produk open source dan dapat digunakan baik untuk membangun sistem yang sepenuhnya otonom dan akan berguna untuk ekspansi ketika ada kekurangan lisensi dalam sistem komersial yang ada atau kinerjanya tidak mencukupi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuan artikel ini adalah untuk memperkenalkan sistem lengkap untuk menyediakan akses jarak jauh ke suatu organisasi, yang sedikit lebih dari "menginstal OpenVPN dalam 10 menit". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, kami mendapatkan sistem di mana sertifikat dan (opsional) direktori perusahaan Direktori Aktif akan digunakan untuk otentikasi pengguna. UNTUK. kami mendapatkan sistem dengan dua faktor verifikasi - apa yang saya miliki (sertifikat) dan apa yang saya tahu (kata sandi).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tanda bahwa pengguna diizinkan untuk terhubung adalah keanggotaannya di grup myVPNUsr. Otoritas Sertifikat akan digunakan secara mandiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biaya penerapan solusi hanya sumber daya perangkat keras kecil dan 1 jam kerja dari administrator sistem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menggunakan mesin virtual dengan OpenVPN dan Easy-RSA versi ke-3 pada CetntOS 7, yang berdasarkan pada 100 koneksi yang dikeluarkan 4 vCPU, 4 GiB RAM.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam contoh, jaringan organisasi kami adalah 172.16.0.0/16, di mana server VPN dengan alamat 172.16.19.123 terletak di segmen 172.16.19.0/24, server DNS adalah 172.16.16.16 dan 172.16.17.17, dan subnet 172.16.20.0/23 dialokasikan untuk klien VPN . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk terhubung dari luar, koneksi digunakan pada port 1194 / udp, dan dalam DNS untuk server kami, gw.abc.ru A-record dibuat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sangat tidak disarankan untuk menonaktifkan SELinux! </font><font style="vertical-align: inherit;">OpenVPN berfungsi tanpa menonaktifkan kebijakan keamanan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kandungan</font></font></h3><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi OS dan perangkat lunak aplikasi</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan Kriptografi</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan OpenVPN</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otentikasi dalam AD</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peluncuran dan Diagnostik</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah dan pencabutan sertifikat</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi jaringan</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa berikutnya</font></font></a></li>
</ol><br>
<a name="setup"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi OS dan perangkat lunak aplikasi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menggunakan kit distribusi CentOS 7.8.2003. </font><font style="vertical-align: inherit;">Kita perlu menginstal OS dalam konfigurasi minimal. </font><font style="vertical-align: inherit;">Lebih mudah untuk melakukan ini menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kickstart</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kloning gambar OS yang diinstal sebelumnya, dan cara lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menginstal, menetapkan alamat ke antarmuka jaringan (sesuai dengan kondisi tugas 172.16.19.123), kami memperbarui OS:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum update -y &amp;&amp; reboot
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda juga perlu memastikan bahwa mesin kami menyinkronkan waktu. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menginstal perangkat lunak aplikasi, Anda memerlukan paket openvpn, openvpn-auth-ldap, easy-rsa dan vim sebagai editor utama (Anda akan memerlukan repositori EPEL).</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install epel-release<font></font>
$ sudo yum install openvpn openvpn-auth-ldap easy-rsa vim<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mesin virtual, ada baiknya memasang agen tamu:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install open-vm-tools</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
untuk host VMware ESXi, atau untuk oVirt</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install ovirt-guest-agent</code></pre><br>
<a name="crypto"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan Kriptografi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buka direktori easy-rsa:</font></font><br>
<br>
<pre><code class="bash hljs">$ <span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat file variabel:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo vim vars</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
konten berikut:</font></font><br>
<br>
<pre><code class="plaintext hljs">export KEY_COUNTRY="RU"<font></font>
export KEY_PROVINCE="MyRegion"<font></font>
export KEY_CITY="MyCity"<font></font>
export KEY_ORG="ABC LLC"<font></font>
export KEY_EMAIL="admin@abc.ru"<font></font>
export KEY_CN="allUsers"<font></font>
export KEY_OU="allUsers"<font></font>
export KEY_NAME="gw.abc.ru"<font></font>
export KEY_ALTNAMES="abc-openvpn-server"<font></font>
export EASYRSA_CERT_EXPIRE=3652<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter untuk organisasi bersyarat ABC LLC dijelaskan di sini. Anda dapat memperbaikinya nyata atau membiarkannya sebagai contoh. </font><font style="vertical-align: inherit;">Hal terpenting dalam parameter adalah baris terakhir, yang menentukan masa berlaku sertifikat dalam beberapa hari. </font><font style="vertical-align: inherit;">Dalam contoh ini, nilai 10 tahun digunakan (365 * 10 + 2 tahun kabisat). </font><font style="vertical-align: inherit;">Nilai ini perlu disesuaikan sebelum mengeluarkan sertifikat pengguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, buat otoritas sertifikasi mandiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penyiapan mencakup variabel ekspor, inisialisasi CA, mengeluarkan kunci root dan sertifikat CA, kunci Diffie-Hellman, kunci TLS, serta kunci server dan sertifikat. </font><font style="vertical-align: inherit;">Kunci otoritas sertifikat harus dijaga dan dirahasiakan! </font><font style="vertical-align: inherit;">Semua parameter pada permintaan dapat dibiarkan secara default.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
. ./vars<font></font>
./easyrsa init-pki<font></font>
./easyrsa build-ca nopass<font></font>
./easyrsa gen-dh<font></font>
./easyrsa gen-req myvpngw nopass<font></font>
./easyrsa sign-req server myvpngw<font></font>
./easyrsa gen-crl<font></font>
openvpn --genkey --secret pki/ta.key<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada ini, bagian utama dari pengaturan mekanisme kriptografi selesai.</font></font><br>
<a name="ovpn"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan OpenVPN</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pergi ke direktori OpenVPN, buat direktori layanan dan tambahkan tautan ke easy-rsa:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /etc/openvpn/<font></font>
mkdir /var/<span class="hljs-built_in">log</span>/openvpn/ /etc/openvpn/ccd /usr/share/easy-rsa/3/client<font></font>
ln -s /usr/share/easy-rsa/3/pki/ /etc/openvpn/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat file konfigurasi OpenVPN utama:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo vim server.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
konten berikut</font></font><br>
<br>
<pre><code class="plaintext hljs">port 1194<font></font>
proto udp<font></font>
dev tun<font></font>
ca /etc/openvpn/pki/ca.crt<font></font>
cert /etc/openvpn/pki/issued/myvpngw.crt<font></font>
key /etc/openvpn/pki/private/myvpngw.key<font></font>
crl-verify /etc/openvpn/pki/crl.pem<font></font>
dh /etc/openvpn/pki/dh.pem<font></font>
server 172.16.20.0 255.255.254.0<font></font>
ifconfig-pool-persist ipp.txt<font></font>
push "route 172.16.0.0 255.255.255.0"<font></font>
push "route 172.17.0.0 255.255.255.0"<font></font>
client-config-dir ccd<font></font>
push "dhcp-option DNS 172.16.16.16"<font></font>
push "dhcp-option DNS 172.16.17.17"<font></font>
keepalive 10 120<font></font>
cipher AES-256-CBC<font></font>
user nobody<font></font>
group nobody<font></font>
persist-key<font></font>
persist-tun<font></font>
status /var/log/openvpn/openvpn-status.log<font></font>
log-append  /var/log/openvpn/openvpn.log<font></font>
verb 3<font></font>
explicit-exit-notify 1<font></font>
username-as-common-name<font></font>
plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so /etc/openvpn/ldap.conf<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa catatan pada parameter:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jika nama yang berbeda ditunjukkan saat mengeluarkan sertifikat, tunjukkan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tentukan kumpulan alamat untuk tugas Anda *;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rute dan server DNS dapat berupa satu atau lebih;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 baris terakhir diperlukan untuk mengimplementasikan otentikasi dalam AD **.</font></font></li>
</ul><br>
<i>*         127 , ..   /23,  OpenVPN        /30.<br>
        ,    ,        SELinux,    tcp   , ..   tcp-        .<br>
<br>
**   AD  ,  ,   — ,    <b>  auth-user-pass</b>.</i><br>
<a name="auth"></a><br>
<h4>  AD</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mendukung faktor kedua, kami akan menggunakan verifikasi akun dalam AD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membutuhkan akun di domain dengan hak pengguna biasa dan grup, yang keanggotaannya akan menentukan kemampuan untuk terhubung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat file konfigurasi:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/openvpn/ldap.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
konten berikut</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;LDAP&gt;<font></font>
        URL             "ldap://ldap.abc.ru"<font></font>
        BindDN          "CN=bindUsr,CN=Users,DC=abc,DC=ru"<font></font>
        Password        b1ndP@SS<font></font>
        Timeout         15<font></font>
        TLSEnable       no<font></font>
        FollowReferrals yes<font></font>
&lt;/LDAP&gt;<font></font>
&lt;Authorization&gt;<font></font>
        BaseDN          "OU=allUsr,DC=abc,DC=ru"<font></font>
        SearchFilter    "(sAMAccountName=%u)"<font></font>
        RequireGroup    true<font></font>
        &lt;Group&gt;<font></font>
                BaseDN          "OU=myGrp,DC=abc,DC=ru"<font></font>
                SearchFilter    "(cn=myVPNUsr)"<font></font>
                MemberAttribute "member"<font></font>
        &lt;/Group&gt;<font></font>
&lt;/Authorization&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter utama:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL "ldap: //ldap.abc.ru" - alamat pengontrol domain;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BindDN "CN = bindUsr, CN = Pengguna, DC = abc, DC = ru" - nama kanonik untuk mengikat LDAP (UZ - bindUsr dalam wadah abc.ru/Users);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kata sandi b1ndP @ SS - kata sandi pengguna untuk pengikatan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseDN "OU = allUsr, DC = abc, DC = ru" - jalur untuk memulai pencarian pengguna;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseDN "OU = myGrp, DC = abc, DC = ru" - wadah grup yang memungkinkan (grup myVPNUsr dalam wadah abc.ru \ myGrp);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SearchFilter "(cn = myVPNUsr)" adalah nama grup penyelesai.</font></font></li>
</ul><br>
<a name="run"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peluncuran dan Diagnostik</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita dapat mencoba untuk menghidupkan dan memulai server kami:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo systemctl <span class="hljs-built_in">enable</span> openvpn@server.service<font></font>
$ sudo systemctl start openvpn@server.service<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peluncuran Periksa:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl status openvpn@server.service<font></font>
journalctl -xe<font></font>
cat /var/<span class="hljs-built_in">log</span>/messages<font></font>
cat /var/<span class="hljs-built_in">log</span>/openvpn/*<span class="hljs-built_in">log</span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah dan pencabutan sertifikat</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena </font><font style="vertical-align: inherit;">selain sertifikat itu sendiri, Anda memerlukan kunci dan pengaturan lain, sangat nyaman untuk membungkus semua ini dalam satu file profil. </font><font style="vertical-align: inherit;">File ini kemudian ditransfer ke pengguna dan profil sudah diimpor pada klien OpenVPN. </font><font style="vertical-align: inherit;">Untuk melakukan ini, buat templat konfigurasi dan skrip yang membentuk profil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di profil, Anda perlu menambahkan konten file sertifikat root (ca.crt) dan kunci TLS (ta.key). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum mengeluarkan sertifikat pengguna, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pastikan untuk menetapkan periode validitas sertifikat yang diperlukan</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam file parameter. </font><font style="vertical-align: inherit;">Anda tidak boleh membuatnya terlalu besar, saya sarankan membatasi hingga maksimum 180 hari.</font></font><br>
<br>
<pre><code class="bash hljs">vim /usr/share/easy-rsa/3/vars</code></pre><br>
<pre><code class="plaintext hljs">...<font></font>
export EASYRSA_CERT_EXPIRE=180<font></font>
</code></pre><br>
<pre><code class="bash hljs">vim /usr/share/easy-rsa/3/client/template.ovpn</code></pre><br>
<pre><code class="plaintext hljs">client<font></font>
dev tun<font></font>
proto udp<font></font>
remote gw.abc.ru 1194<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
persist-key<font></font>
persist-tun<font></font>
remote-cert-tls server<font></font>
cipher AES-256-CBC<font></font>
verb 3<font></font>
auth-user-pass<font></font>
<font></font>
&lt;ca&gt;<font></font>
-----BEGIN CERTIFICATE-----<font></font>
PUT YOUR CA CERT (ca.crt) HERE<font></font>
-----END CERTIFICATE-----<font></font>
&lt;/ca&gt;<font></font>
<font></font>
key-direction 1<font></font>
&lt;tls-auth&gt;<font></font>
-----BEGIN OpenVPN Static key V1-----<font></font>
PUT YOUR TA KEY (ta.key) HERE<font></font>
-----END OpenVPN Static key V1-----<font></font>
&lt;/tls-auth&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catatan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUT Your ...</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> string </font><font style="vertical-align: inherit;">diubah ke konten </font><font style="vertical-align: inherit;">sertifikat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mereka</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di remote direktif tentukan nama / alamat gateway Anda;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arahan auth-user-pass digunakan untuk otentikasi eksternal tambahan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di direktori home (atau tempat lain yang nyaman) kami membuat skrip untuk meminta sertifikat dan membuat profil:</font></font><br>
<br>
<pre><code class="bash hljs">vim ~/make.profile.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ] ; <span class="hljs-keyword">then</span>
 <span class="hljs-built_in">echo</span> Missing mandatory client name. Usage: <span class="hljs-variable">$0</span> vpn-username
 <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span><font></font>
<font></font>
<span class="hljs-comment">#Set variables</span><font></font>
basepath=/usr/share/easy-rsa/3<font></font>
clntpath=<span class="hljs-variable">$basepath</span>/client<font></font>
privpath=<span class="hljs-variable">$basepath</span>/pki/private<font></font>
certpath=<span class="hljs-variable">$basepath</span>/pki/issued<font></font>
profile=<span class="hljs-variable">$clntpath</span>/<span class="hljs-variable">$1</span>.ovpn<font></font>
<font></font>
<span class="hljs-comment">#Get current year and lowercase client name</span><font></font>
year=`date +%F`<font></font>
client=<span class="hljs-variable">${1,,}</span>
<span class="hljs-built_in">echo</span> Processing <span class="hljs-variable">$year</span> year cert <span class="hljs-keyword">for</span> user/device <span class="hljs-variable">$client</span><font></font>
<font></font>
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$basepath</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [  -f client/<span class="hljs-variable">$client</span>* ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"*** ERROR! ***"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Certificate <span class="hljs-variable">$client</span> already issued!"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"*** ERROR! ***"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span><font></font>
<font></font>
. ./vars<font></font>
./easyrsa --batch --req-cn=<span class="hljs-variable">$client</span> gen-req <span class="hljs-variable">$client</span> nopass<font></font>
./easyrsa --batch sign-req client <span class="hljs-variable">$client</span><font></font>
<font></font>
<span class="hljs-comment">#Make profile</span>
cp <span class="hljs-variable">$clntpath</span>/template.ovpn <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;key&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
cat <span class="hljs-variable">$privpath</span>/<span class="hljs-variable">$1</span>.key &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;/key&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
openssl x509 -<span class="hljs-keyword">in</span> <span class="hljs-variable">$certpath</span>/<span class="hljs-variable">$1</span>.crt -out <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt<font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;cert&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
cat <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;/cert&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span> &gt;&gt; <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-comment">#remove tmp file</span>
rm -f <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt<font></font>
<font></font>
<span class="hljs-built_in">echo</span> Complete. See <span class="hljs-variable">$profile</span> file.<font></font>
<font></font>
<span class="hljs-built_in">cd</span> ~
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membuat file dapat dieksekusi:</font></font><br>
<br>
<pre><code class="bash hljs">chmod a+x ~/make.profile.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan Anda dapat menerbitkan sertifikat pertama kami.</font></font><br>
<br>
<pre><code class="bash hljs">~/make.profile.sh my-first-user</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Umpan balik</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika sertifikat dikompromikan (hilang, dicuri), sertifikat ini harus dicabut:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
./easyrsa revoke my-first-user<font></font>
./easyrsa gen-crl<font></font>
</code></pre><br>
<a name="cert"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lihat sertifikat yang dikeluarkan dan dicabut</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melihat sertifikat yang dikeluarkan dan dicabut, cukup lihat file indeks:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
cat pki/index.txt<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penjelasan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">baris pertama adalah sertifikat server;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">karakter pertama</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V (Valid) - valid;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R (Dicabut) - dipanggil kembali.</font></font></li>
</ul></li>
</ul><br>
<a name="net"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi jaringan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Langkah terakhir adalah menyiapkan jaringan transmisi - perutean dan firewall. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Izin untuk koneksi di firewall lokal:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --add-service=openvpn<font></font>
$ sudo firewall-cmd --add-service=openvpn --permanent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, aktifkan perutean lalu lintas IP:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo sysctl net.ipv4.ip_forward=1<font></font>
$ sudo <span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.ip_forward=1"</span> &gt; /etc/sysctl.d/50-sysctl.conf
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam lingkungan perusahaan, mungkin ada divisi dalam subnet dan kami perlu memberi tahu router bagaimana mengirim paket yang ditujukan ke klien VPN kami. Di baris perintah, jalankan perintah dengan cara (tergantung pada peralatan yang digunakan):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># ip route 172.16.20.0 255.255.254.0 172.16.19.123</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan simpan konfigurasinya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, pada antarmuka router perbatasan, di mana alamat eksternal gw.abc.ru disajikan, perlu untuk mengizinkan berlalunya paket udp / 1194. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika organisasi Anda memiliki aturan keamanan yang ketat, Anda juga harus mengonfigurasi firewall di server VPN kami. </font><font style="vertical-align: inherit;">Menurut pendapat saya, pengaturan rantai iptables FORWARD memberikan fleksibilitas paling besar, meskipun pengaturannya kurang nyaman. </font><font style="vertical-align: inherit;">Sedikit lagi tentang pengaturannya. </font><font style="vertical-align: inherit;">Untuk ini, akan lebih mudah menggunakan "aturan langsung" - aturan langsung yang disimpan dalam file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/firewalld/direct.xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Konfigurasi aturan saat ini dapat ditemukan sebagai berikut:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --direct --get-all-rule</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum mengubah file, buat salinan cadangannya:</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/firewalld/direct.xml /etc/firewalld/direct.xml.`date +%F.%T`.bak</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perkiraan isi file adalah sebagai berikut:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">direct</span>&gt;</span>
 <span class="hljs-comment">&lt;!--Common Remote Services--&gt;</span>
  <span class="hljs-comment">&lt;!--DNS--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o ens192 -p udp --dport 53 -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--web--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p tcp -d 172.16.19.200 --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p tcp -d 172.16.19.201 --dport 443 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--Some Other Systems--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p udp -d 172.16.19.100 --dport 7000 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--just logging--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -j LOG --log-prefix 'forward_fw '<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">direct</span>&gt;</span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penjelasan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada dasarnya, ini adalah aturan iptables yang biasa, jika tidak dikemas setelah munculnya firewalld. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antarmuka tujuan pada pengaturan default adalah tun0, dan yang eksternal untuk terowongan mungkin berbeda, misalnya, EN192, tergantung pada platform yang digunakan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baris terakhir adalah untuk mencatat paket yang dijatuhkan. </font><font style="vertical-align: inherit;">Agar logging berfungsi, Anda perlu mengubah level debugging di konfigurasi firewalld:</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/sysconfig/firewalld<font></font>
FIREWALLD_ARGS=--debug=2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terapkan pengaturan - perintah firewalld biasa untuk membaca kembali pengaturan:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --reload</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket yang dibuang dapat dilihat sebagai berikut:</font></font><br>
<br>
<pre><code class="bash hljs">grep forward_fw /var/<span class="hljs-built_in">log</span>/messages</code></pre><br>
<a name="next"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa berikutnya</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengaturan selesai! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetap di sisi klien untuk menginstal perangkat lunak klien, mengimpor profil dan terhubung. </font><font style="vertical-align: inherit;">Untuk OS seperti Windows, distribusi tersedia di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">situs pengembang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai kesimpulan, kami menghubungkan server baru kami ke sistem pemantauan dan pengarsipan, dan jangan lupa untuk menginstal pembaruan secara teratur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Koneksi stabil!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id501034/index.html">Seminar Mingguan IBM - Mei 2020</a></li>
<li><a href="../id501040/index.html">Kesalahan umum pada aplikasi yang menyebabkan mengasapi di postgresql. Andrey Salnikov</a></li>
<li><a href="../id501042/index.html">Likbez tentang Kepatuhan: kami memahami persyaratan regulator di bidang keamanan informasi</a></li>
<li><a href="../id501044/index.html">Jangan pegang orang karena orang idiot atau mengapa orang dengan latar belakang teknik dapat membakar menara sel (video)</a></li>
<li><a href="../id501046/index.html">Sekitar keuntungan yang kuat: 10 laporan teratas konferensi C ++ Russia 2019 Piter</a></li>
<li><a href="../id501050/index.html">Instal dan aktifkan Edisi Komunitas LabVIEW</a></li>
<li><a href="../id501052/index.html">Kembalinya Spaceship Cina</a></li>
<li><a href="../id501056/index.html">Mengapa, kapan dan bagaimana menggunakan multithreading dan multiprocessing dengan Python</a></li>
<li><a href="../id501058/index.html">Teamcenter Solusi Mulai Cepat Membantu Produsen Peralatan Industri Memotong Waktu Desain Dengan 25%</a></li>
<li><a href="../id501060/index.html">JetBrains .NET Days Online, 13-14 Mei</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>