<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµüèª üßíüèΩ üíÉ Error with #line directive in Visual C ++ compiler ü§πüèø üßôüèæ ‚è∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The #line directive is added by the preprocessor and then can be used to understand which file and line a particular piece of code in the preprocessed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Error with #line directive in Visual C ++ compiler</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/502918/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c23/e6f/6ec/c23e6f6ecd4b643e19f80e58db05104a.png" alt="image1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The #line directive is added by the preprocessor and then can be used to understand which file and line a particular piece of code in the preprocessed file belongs to. </font><font style="vertical-align: inherit;">The #line directive tells code tools to change the internal stored line number and the name of the compiler file to the specified line number. </font><font style="vertical-align: inherit;">The following lines will already count relative to the given position. </font><font style="vertical-align: inherit;">Explicit preprocessing is mainly used for debugging or by various generators. </font><font style="vertical-align: inherit;">In any case, an error in such a functionality can lead to various negative consequences. </font><font style="vertical-align: inherit;">One of these problems occurred to the user of PVS-Studio in Visual Studio 2019.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error history and description</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The #line directive is an important part of the preprocessed files that are used by the PVS-Studio analyzer to issue warnings on the necessary lines of user code. This is where the story of the error search begins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of our users with a large code base began the translation of the entire project from Platform Toolset version v141 to v142 in Visual Studio 2019. After that, in the results of the analysis, a surge of V002 warnings appeared and several tens of other warnings were issued to the wrong lines of code (one line error )</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diagnostics V002 just detects such situations (incorrect line numbering). </font><font style="vertical-align: inherit;">This usually occurs due to multi-line macros or other preprocessor directives (e.g. #pragma). </font><font style="vertical-align: inherit;">The problem does not occur very often, but mainly on a compiler from Microsoft. </font><font style="vertical-align: inherit;">Such a surge of problems on one project was unexpected, because </font><font style="vertical-align: inherit;">our testing system did not show the presence of such a serious problem, and we began to debug the analyzer on the preprocessed user file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a few hours of debugging, we found that the analyzer was already working with incorrect data about lines of code and were able to make a test example:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MACRO(a, b)              <span class="hljs-comment">// line1</span></span>
                                 <span class="hljs-comment">// line2</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span> <span class="hljs-comment">// line3</span>
</span>{                                <span class="hljs-comment">// line4</span>
    MACRO(<span class="hljs-string">"Some string"</span>,         <span class="hljs-comment">// line5</span>
        <span class="hljs-number">42</span>);                     <span class="hljs-comment">// line6</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;                    <span class="hljs-comment">// line7 &lt;=</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The preprocessed file is as follows:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">line</span> 1 <span class="hljs-meta-string">"D:\\_Tests\\TestApp\\Project2\\rnd_bs.cpp"</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span>
</span>{<font></font>
  ;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">line</span> 8 <span class="hljs-meta-string">"D:\\_Tests\\TestApp\\Project2\\rnd_bs.cpp"</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return statement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7th</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> line in the source file, and the preprocessor points to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8th</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> line. </font><font style="vertical-align: inherit;">This error occurred in the preprocessor, presumably due to a multi-line macro.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Released Version Release</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the time of writing, the problem was relevant for the latest versions of Visual Studio, up to version 16.4.3 (dated January 14, 2020). We opened the Bug Report " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invalid #line directive after preprocessing (VS2019, v142)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " and after 4 days received an interesting answer: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This issue has been identified as a duplicate of an earlier reported feedback linked here: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developercommunity.visualstudio.com/content/problem /738407/preprocessor-generates-incorrect-line-information.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you reported or voted here, your vote has been applied to the original issue. Everyone else can add their vote directly at the above linked feedback. Voting helps increase the priority of the issue by consolidating customer impact under one feedback. Thank you!</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that this problem has already been reported, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on September 18, 2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - almost half a year ago: " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preprocessor generates incorrect line information</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". The user provided similar code examples to reproduce the error. According to the author, the error exists at least with Visual Studio 2019 16.2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is not known whether this is a coincidence or not, but after a few days of our activity, the error was assigned the status </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fixed - Pending Release</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On May 19, 2020, a revised version of Visual Studio 2019 16.6.0 was released. We recommend that all users of PVS-Studio switch to it.</font></font></b><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Bug Caused by the #line Directive in the Visual C ++ Compiler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502904/index.html">Examples of technical debt in implementing BI systems</a></li>
<li><a href="../en502908/index.html">VKontakte, MIPT and GSOM SPbSU have created a machine learning course for computer science teachers</a></li>
<li><a href="../en502910/index.html">Internet History: Era of Fragmentation; part 2: sowing wasteland</a></li>
<li><a href="../en502914/index.html">Mathematical logic that can help check more people for coronavirus</a></li>
<li><a href="../en502916/index.html">Unit tests for RxSwift code</a></li>
<li><a href="../en502920/index.html">As we tested the performance of new processors in the cloud for 1C according to the Gilyov test</a></li>
<li><a href="../en502922/index.html">Crowd marketing as a tool for enhancing business vitality</a></li>
<li><a href="../en502924/index.html">Snom D735 IP Phone Review</a></li>
<li><a href="../en502926/index.html">Paul Graham: Brevity = Strength</a></li>
<li><a href="../en502928/index.html">Mini-conference "Safe work with cloud services"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>