<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☸️ 🌈 👊🏻 トランザクションでArduinoのEEPROMにデータを保存する 🏩 🥒 👿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="EEPROMの存在により、開発者は構成パラメータを保存するための便利なツール、または停電が生き残るべきゆっくり変化する状態を得ることができます。この記事では、これを可能な限り安全かつ便利に行う方法を見て、何も忘れず、そこに何がなかったかを思い出さないようにします。
 
 変数があり、それをEEPRO...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>トランザクションでArduinoのEEPROMにデータを保存する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482918/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EEPROMの存在により、開発者は構成パラメータを保存するための便利なツール、または停電が生き残るべきゆっくり変化する状態を得ることができます。</font><font style="vertical-align: inherit;">この記事では、これを可能な限り安全かつ便利に行う方法を見て、何も忘れず、そこに何がなかったかを思い出さないようにします。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数があり、それをEEPROMに保存したいとします。</font><font style="vertical-align: inherit;">これのためのすべてのツールは私たちの手にあるようです：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;EEPROM.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> my_var = DEFAULT_VALUE;<font></font>
<font></font>
EEPROM.get(MY_VAR_ADDR, my_var);<font></font>
my_var = NEW_VALUE;<font></font>
EEPROM.put(MY_VAR_ADDR, my_var);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、よく見ると、このアプローチでは解決するよりも多くの問題が発生することがわかります。それらについて順に説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.書き留めた内容を正確に読み取る方法（</font><b><font style="vertical-align: inherit;">完全性の</font></b><font style="vertical-align: inherit;">保証）</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）？次の画像を想像してみてください。停電やリセット信号で急死した場合に備えて、手紙を書いて机の引き出しに入れます。次の人生では、私たちは机の引き出しを開け、一枚の紙を取り出し、メッセージを読み、使命を続けます。問題は、箱の中には常にランダムなテキストで落書きされた紙があることです。したがって、正しいメッセージとランダムなメッセージを区別する方法が必要です。彼が公証人であることを保証することもできますが、最も単純なケースでは、その正当性を検証する方法があれば、彼の署名で十分です。たとえば、テキストに応じた数式の結果をシグネチャとして使用できるため、偶然の一致の確率が十分に低くなります。最も単純なケースでは、これはCRCまたはチェックサムです。私たちが書いていないことを読むだけでなく、破損したメッセージを読むことからも。結局のところ、テキストは時間とともに消え、孤立したシャッター内の電子の耐久性はさらに低下します。粒子は十分なエネルギーで宇宙から飛び、ビットは変化します。しかし、破損したメッセージを取得する別の方法があります。これは、メッセージを最後に追加することではありません。録音時に消費電流が急激に増加するため、それほどエキゾチックではありません。これは、ライターの早期の死亡を引き起こす可能性があります。これは作家の早期の死を引き起こす可能性があります。これは作家の早期の死を引き起こす可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.メッセージの正確さを確信していると仮定しますが、メッセージを確実に作成するにはどうすればよいですか（</font><b><font style="vertical-align: inherit;">信頼性を</font></b><font style="vertical-align: inherit;">保証します）</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）ことわざの通り、私は違います。突然、私が生まれ変わる前に誰かがこのテーブルに座っていて、彼は別の使命を持っていました、そして私は今彼のメッセージによってどのような理由で導かれますか？ノートに特定のラベルを付ければ、他人と区別しやすくなります。たとえば、そのようなラベルは、保存する変数の名前にすることができます。唯一の問題は、EEPROMに変数名を配置するためのスペースがあまりなく、長さが異なるために配置するのが不便であるということです。しかし幸いなことに、もっと簡単な方法があります。変数に代わってチェックサムを計算し、それをショートカットとして使用できます。同時に、誤って間違った量を読み取らないように、変数のサイズをバイト単位でこのチェックサムに追加すると便利です。さて、完全を期すために、そこに別の数値識別子を追加します。同じ名前で呼び出されている場合でも、変数を他の誰かと確実に区別するため。この番号をインスタンスIDと呼びます（変数名がオブジェクトフィールドと見なされる場合のOOPに触発されます）。ミッションを根本的に新しいバージョンにアップグレードし、この更新により古いバージョンが保存したすべてを無意味にする場合は、インスタンスIDを変更して、古いバージョンで保存されたすべてを無効にする必要があります。古いバージョンで保存されたすべてのものを無効にします。古いバージョンで保存されたすべてのものを無効にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.古い保存値を変更せずに、不完全な書き込み操作を行うにはどうすればよいですか？つまり、保存操作は成功するか、または目に見える影響がまったくないはずです。つまり、</font><b><font style="vertical-align: inherit;">アトミック</font></b><font style="vertical-align: inherit;">である必要があります</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または、単一の値の無条件の更新に至るトランザクションについて話している場合は、トランザクション。明らかに、以前の値を書き換えてレコードのアトミック性を保証することはできません。新しい場所への書き込みを行って、少なくとも新しい値の記録が完了するまで、古い保存値をそのままにしておく必要があります。この手法は、保存された値の一部のみが更新され、変更されていない部分がコピーされて新しい場所に書き込まれる場合、「コピーオンライト」と呼ばれることがよくあります。私たちの類推を発展させて、私たちは自分に手紙を書き、古いものはそのままにしますが、次の人生で最後に書かれた手紙を見つける機会を持つことができるように、各手紙に増加するシリアル番号を提供します。しかし、新しい問題が発生します-ボックス内の場所、無関係になった古い手紙を捨てない限り、私たちが手紙を置く場所は遅かれ早かれ終わります。 2文字だけを保存するだけで十分であることを理解するのは簡単です。1つは古いもので、もう1つは新しいものです。作成中の場合もあります。したがって、文字番号も多くのビットを必要としません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
奇妙なことに、作成者は、整合性、信頼性、および原子性を確保しながら、EEPROMでのデータストレージの編成を可能にする単一の実装を見つけることができませんでした。自分で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">github.com/olegv142/NvTx</font></a><font style="vertical-align: inherit;">に書き込む必要があり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EEPROMに各変数を保存するために、2つの連続した領域が使用されます-同じ構造のセル。サイズ、テキストラベル、インスタンス識別子に基づいて計算された変数の識別子は、最初の2バイトに書き込まれます。次に、データが書き込まれ、その後に2バイトのチェックサムが続きます。最初のバイトでは、2ビットに特別な目的があります。最上位ビットは正しさフラグであり、書き込み時には常に1に設定されます。下位ビットは元号の1ビットの数値として使用され、最後のメッセージを見つけるために必要です。記録は「円の中の」セルで行われます。年号は、最初のセルにレコードが作成されるたびに変更されます。したがって、最後に記録されたセルを決定するためのアルゴリズム：セルのエポックが同じである場合、2番目は最後に書き込まれ、異なる場合は最初に書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正確性ビットは冗長に見えますが、重要な機能があります。まず、保存されているデータを読み取り、両方のセルの正確性を確認します。セルが正しい識別子またはチェックサムのチェックに合格しない場合、正当性ビットをリセットします。後続の書き込み操作では、セルの正確性をチェックしない場合がありますが、このフラグに依存するため、オーバーヘッドが約2分の1に削減されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装の詳細を掘り下げたい人は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">リポジトリ内の</font></a><font style="vertical-align: inherit;">画像とコードを見ることができ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。私は、読者を退屈させないために、使用に移ります。データの書き込み/読み取り機能はそれぞれ5つのパラメーターを受け取るため、柔軟性を優先して使用の利便性が犠牲になります。ただし、2組のマクロによって寛大に補われ、EEPROM.get / putの場合と同じくらい簡単にライブラリを使用できます。変数を特定のアドレスに保存するだけの場合は、最初のマクロセットが使用されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;NvTx.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> my_var = DEFAULT_VALUE;<font></font>
<font></font>
<span class="hljs-keyword">bool</span> have_my_var = NvTxGetAt(my_var, MY_VAR_ADDR);<font></font>
my_var = NEW_VALUE;<font></font>
NvTxPutAt(my_var, MY_VAR_ADDR);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
保存する変数が複数ある場合は、それぞれがアドレスを決定し、同時にサイズを正しく考慮して、変数が格納されているメモリ領域が重複しないようにする必要があります。タスクを簡略化するために、2番目のマクロセットは自動アドレス割り当てを実装し、これ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をコンパイル時に実行し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino-EEPROMExライブラリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は実行時にメモリを割り当てることができますが、格納された各変数のアドレスをRAMに格納します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NvTx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ</font><font style="vertical-align: inherit;">は、実行可能コードやRAMの内容に何も追加せずに、EEPROMにスペースを割り当てます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;NvTx.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> my_var = DEFAULT_VALUE;
<span class="hljs-keyword">char</span> my_string[<span class="hljs-number">16</span>] = <span class="hljs-string">""</span>;<font></font>
<font></font>
NvPlace(my_var, MY_START_ADDR, MY_INST_ID);<font></font>
NvAfter(my_string, my_var);<font></font>
<font></font>
<span class="hljs-keyword">bool</span> have_my_var = NvTxGet(my_var);<font></font>
my_var = NEW_VALUE;<font></font>
NvTxPut(my_var);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NvPlaceマクロは、変数を格納するEEPROM領域の開始アドレスとインスタンス識別子を設定します。 NvAfterマクロは、メモリ領域を予約して、2番目に予約されたメモリ領域の直後に最初の引数を格納します。メモリを割り当てるときに、使用可能なEEPROMサイズを超えていないこと、および重複するメモリ領域を予約していないことも確認されます（これは、2つのNvAfterマクロに同じ2番目の引数がある場合に発生する可能性があります）。指定された2つの条件のいずれかに違反した場合、プログラムはコンパイルされません。メモリ割り当てメカニズムを扱いたい人は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">NvTx.h</font></a><font style="vertical-align: inherit;">ヘッダーファイルでそれを見つけるでしょう。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">NvPlaceおよびNvAfterマクロが行うすべてのことは、列挙を定義し、変数名に基づいてそれらの名前を形成し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイル時のassertの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に便利な慣用的な構成を使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">すること</font></a><font style="vertical-align: inherit;">です。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">NvTx</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ライブラリが</font><font style="vertical-align: inherit;">、読者が信頼性の高い産業用コードを作成するのに役立つ</font><font style="vertical-align: inherit;">ことを願ってい</font><font style="vertical-align: inherit;">ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja482906/index.html">ネットワークセキュリティについて</a></li>
<li><a href="../ja482908/index.html">デビッドクシュナーの本「マスターズオブドゥーム」の翻訳の第2部。6〜12章</a></li>
<li><a href="../ja482912/index.html">Идея децентрализованной социальной сети следующего поколения</a></li>
<li><a href="../ja482914/index.html">macOS組み込みツールを備えたWi-Fiポーク</a></li>
<li><a href="../ja482916/index.html">NESでの音楽の仕組み</a></li>
<li><a href="../ja482920/index.html">自動操縦装置がどのように私たちの生活に入ったか、私たちは気づかなかった</a></li>
<li><a href="../ja482922/index.html">Drupal Digest-2019/12月</a></li>
<li><a href="../ja482926/index.html">アークは、単一リポジトリのバージョン管理システムです。Yandexレポート</a></li>
<li><a href="../ja482928/index.html">Predator Vision：Thermal Vision Effect</a></li>
<li><a href="../ja482930/index.html">系図調査-計量図書、国勢調査、アーカイブ、オープンデータベース</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>