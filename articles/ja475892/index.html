<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🔧 👨🏻‍🏭 😋 オフィスでのランチの注文を改善した方法（サーバーにアクセスできない場合） 👩🏽‍🌾 ☮️ 👨🏾‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは。
 
 私はオフィスで働きます。ソフトウェア開発者。そして時々私は食べる。はい、毎日です。雇用主は私たちに昼食を提供します-労働者は明日の昼食を注文し、明日は昼食の供給者が労働者が注文したものを持ち込みます。注文したものと持ち込まれたものは必ずしも一致しませんが、そうではありま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>オフィスでのランチの注文を改善した方法（サーバーにアクセスできない場合）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475892/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みなさん、こんにちは。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はオフィスで働きます。</font><font style="vertical-align: inherit;">ソフトウェア開発者。</font><font style="vertical-align: inherit;">そして時々私は食べる。</font><font style="vertical-align: inherit;">はい、毎日です。</font><font style="vertical-align: inherit;">雇用主は私たちに昼食を提供します-労働者は明日の昼食を注文し、明日は昼食の供給者が労働者が注文したものを持ち込みます。</font><font style="vertical-align: inherit;">注文したものと持ち込まれたものは必ずしも一致しませんが、そうではありません。</font><font style="vertical-align: inherit;">ランチはランチオーダーページで注文します。</font><font style="vertical-align: inherit;">だが…</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、最初に、ランチオーダーページがどのように形成されるかについて、サプライヤは1週間の価格リストを含むXLSファイルを送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/zj/sw/8bzjswumny4twmbde-z_qlxhlx8.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サプライヤーが送信する価格の例は、</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
会社の腸内の誰かが開発したユーティリティを介してランチパースを担当し、会社のポータルが表示できる形式に変換することです。そして、彼はそれを表示します... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/xe/vm/mjxevmjk1xjpktpmhzsvfqv7-zu.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注文されたディナーの</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/g_/gv/ur/g_gvurzwytojpckxlvm9ttpk3vu.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリーンショットランチの注文ページ</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の</font><i><font style="vertical-align: inherit;">スクリーンショット</font></i><font style="vertical-align: inherit;">位置は不快にカテゴリーに分けられています。名前と構成に関する情報はフルテキストであり、ナビゲートするのは困難です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他の人が気に入っているので、注文しない方が良いことと、何を試すことができるかを理解したいと思います。つまり、評価が必要です。ダイニングルームで何を注文したか思い出せないように、電報でも注文を受け取りたいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、目標は明確です。</font><font style="vertical-align: inherit;">私はすぐに言っておく必要があります。私の同僚と私が取った道は、最も正確で合理的なものからはほど遠いものです。</font><font style="vertical-align: inherit;">それでも、アーキテクチャ、セキュリティ、サポート、フォールトトレランスの点で完全なゲームです。</font><font style="vertical-align: inherit;">しかし、成長したものは成長しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーにはアクセスできないため、ユーザースクリプトを使用してのみページの外観を変更できます。</font><font style="vertical-align: inherit;">しかし、評価はどうですか？</font><font style="vertical-align: inherit;">データベースへのアクセスもありません。</font><font style="vertical-align: inherit;">注文処理、評価、Telegramとのやり取りのためのサーバーが必要です。</font><font style="vertical-align: inherit;">この役割は、NodeJSサーバーによって行われました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバ側</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーを担当し、同僚がページに機能を追加するユーザースクリプトを担当します。</font><font style="vertical-align: inherit;">nodejsサーバーを取得し、エクスプレス接続し、MySQLを追加します。</font><font style="vertical-align: inherit;">上位配置の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequelize</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node-telegram-bot-apiを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介してTelegramと対話し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-comment">// ...</span>
<span class="hljs-comment">//  </span>
<span class="hljs-comment">//   </span>
app.get(<span class="hljs-string">"/dinners/user_menu"</span>, dinner.getUserMenu);
<span class="hljs-comment">//     </span>
app.get(<span class="hljs-string">"/dinners/r/:id"</span>, dinner.getPersonalRatings);
<span class="hljs-comment">//  </span>
app.post(<span class="hljs-string">"/dinners/r/:id"</span>, dinner.setRating);
<span class="hljs-comment">//      Telegram</span>
app.post(<span class="hljs-string">"/dinners/resend/:id"</span>, dinner.resendMessage);
<span class="hljs-comment">//     </span>
app.post(<span class="hljs-string">"/dinners/order"</span>, dinner.order);
<span class="hljs-comment">//  ,     </span>
app.post(<span class="hljs-string">"/dinners/days"</span>, dinner.setDinnerDays);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能について簡単に説明：</font><i><font style="vertical-align: inherit;">/ディナー/ user_menuパスは、</font></i><font style="vertical-align: inherit;">ユーザースクリプトを返します。</font></font><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="javascript hljs">res.sendFile(__dirname + <span class="hljs-string">'/public_html/user_script.js'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、新しいバージョンのスクリプトをインストールすることにより、それを使用する同僚の注意をそらさないようにするためです。</font><font style="vertical-align: inherit;">修正-サーバーに投げた-全員更新。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、セキュリティの観点からはこれは悪いことですが、機能自体は重要ではなく、スクリプトが格納されているサーバーは非常に安全であると考えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、パス</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ディナー/ r /：id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に沿って、</font><font style="vertical-align: inherit;">すべてのポジションの評価を取得し、評価を保存できます。つまり、料理に投票できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パス</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ディナー/再送信/：id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Telegramにメッセージを送信するために使用されます。</font><font style="vertical-align: inherit;">メッセージのテキストはクライアントで生成され、テレグラムとの対話のみがサーバーで行われます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> parseMode: TelegramBot.SendMessageOptions = {<span class="hljs-attr">parse_mode</span>: <span class="hljs-string">"HTML"</span>};
<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.bot.sendMessage(telegramId, htmlMessage, {...options, ...parseMode});
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、ボットは注文を含むメッセージを送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/rb/uv/wxrbuv4-_nexpcmsavuenefuvwa.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、パス</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ディナー/注文</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に沿って</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">注文</font></i><font style="vertical-align: inherit;">が保存されます。元の注文リクエストを特定するのは難しいため（[保存]ボタンをクリックすると、注文確認ボタンでアラートが表示されます）、注文ページが読み込まれると、注文を含むサーバーのリクエストが送信されます（サイトの注文システム全体が2つのページ（注文ページとメニューページ）に分割されます） -特定の日の料理の選択-つまり、注文の形成）。注文ページにアクセスするたびにリクエストを送信するのはかなり合理的ではありませんが、簡単な方法はありませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、パス</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ディナー/日</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランチを注文する日を設定します。</font><font style="vertical-align: inherit;">機能のこの部分は、未完了の注文に関するリマインダーを正しく操作するために表示されています-注文の翌日が何であるかを知る必要があります（結局、週末は週末であり、週の途中が休日です）。</font><font style="vertical-align: inherit;">生産カレンダーを実装する代わりに、注文ページで日付を解析します。ここでは、稼働日と非稼働日がすでにマークされています（非稼働日の注文はできません）。</font><font style="vertical-align: inherit;">非稼働日は、isHolidayクラスを使用してポータルでマークされます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> trToday = $(<span class="hljs-string">".dinner_today"</span>)[<span class="hljs-number">0</span>];
<span class="hljs-keyword">const</span> tbodyAllDays = $(trToday).parent();
<span class="hljs-keyword">const</span> dinnerDays = [];<font></font>
$(tbodyAllDays).children().each(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> ($(<span class="hljs-keyword">this</span>).hasClass(<span class="hljs-string">"isHoliday"</span>)) {
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">const</span> itemMenuDate = $(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">"&gt; td:first-child"</span>).text().substring(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);<font></font>
    dinnerDays.push(itemMenuDate);<font></font>
    <span class="hljs-comment">// ...</span><font></font>
});<font></font>
<span class="hljs-keyword">await</span> sendRequest(<span class="hljs-string">"POST"</span>, <span class="hljs-string">`https://****/dinners/days/`</span>, {<span class="hljs-attr">days</span>: dinnerDays});
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ああそう、ピッキングにjqueryを使用します。</font><font style="vertical-align: inherit;">ページツリーを掘り下げるのはとても便利です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報ボット</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アドオン全体のもう1つの部分は電報ボットです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/24/wf/ek/24wfekdwtsuscjixrrguvl55nam.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このような機能を備えた</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Get IDは、そのような識別システムです。特定のブラウザのユーザースクリプトを電報のuserIdに関連付ける。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日の注文を表示し、注文のリスト（最後の5）を表示し、リマインダーを設定します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランチは毎日同じ時刻に自動的にサプライヤーに送信されるため、特定の時間、たとえば13:00の前に注文することが重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、注文する機能はブロックされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リマインダー：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hr/v2/v5/hrv2v5mfkmx7v8ia6aff9ko9jvc.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボットはリマインダーの時間を選択する機能を提供します：9、10または11時間。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、リマインダーの後で注文をしなかった場合、注文するまで、または注文がブロックされるまで、次の10分ごとにボットが注文を通知します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはcronタスクによって行われます（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node-scheduleを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="javascript hljs">schedule.scheduleJob(<span class="hljs-string">'*/10 9-13 * * 1-5'</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// ...</span><font></font>
});<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント部分。</font><font style="vertical-align: inherit;">メニュー</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しになりますが、サプライヤが送信するメニュー項目のテキストと組み合わせた現在のインターフェースはひどいものです（画面2を参照）。そして、ある時点で、何トンもの単調で堅固なテキストや有用なテキストがほとんど表示されなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちを助けることができるインターネットを検索した後、カスタムGreasemonkeyスクリプト用のかなり良いプラグインを見つけ、彼らはそれを使用することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ユーザースクリプトを作成し、評価とリクエストの送信機能が組み込まれている企業ポータルおよびサーバーと通信する権利を与えます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">// @include  http://****.int/*</span>
<span class="hljs-comment">// @include  http://****/*</span>
<span class="hljs-comment">// @grant GM.xmlHttpRequest</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ランチページ自体を変更するために、jQueryを使用し、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// @require</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して接続し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。次に</font><i><font style="vertical-align: inherit;">、</font></i><font style="vertical-align: inherit;">ランチページの</font><i><font style="vertical-align: inherit;">シャベルの作成</font></i><font style="vertical-align: inherit;">を開始します。</font><font style="vertical-align: inherit;">ページのhtmlコードを見て、ランチテーブルの識別子を見つけ、テーブルを取得して変更します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> table = $(<span class="hljs-string">".dinner__innerData"</span>);
<span class="hljs-keyword">const</span> categoryList = [];
<span class="hljs-comment">//     </span>
$(table).find(“tbody tr td:nth-child(<span class="hljs-number">2</span>})”).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> text = $(<span class="hljs-keyword">this</span>).text();
    <span class="hljs-comment">//          </span>
    <span class="hljs-keyword">if</span> (!categoryList.find(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name === text)) {<font></font>
        $(<span class="hljs-keyword">this</span>).parent().before(<span class="hljs-string">"&lt;tr&gt;&lt;th colspan='6'&gt;"</span> + text + <span class="hljs-string">"&lt;/th&gt;&lt;th style='display:none'&gt;&lt;/th&gt;&lt;th style='display:none'&gt;&lt;/th&gt;&lt;th style='display:none'&gt;0&lt;/th&gt;&lt;th style='display:none'&gt;&lt;span class='dish__amount'&gt;0&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;"</span>);<font></font>
        categoryList.push(text);<font></font>
    }<font></font>
});<font></font>
<span class="hljs-comment">//     </span>
$(table).find(“thead th:nth-child(<span class="hljs-number">2</span>)”).remove();<font></font>
$(table).find(<span class="hljs-string">"tbody tr td:nth-child(2)”).remove();
//    
$(table).find(“tbody tr td:nth-child(2)”).after("</span>&lt;td&gt;&lt;/td&gt;<span class="hljs-string">");
$(table).find(“thead th:nth-child(2)”).after("</span>&lt;th <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">'ui-state-default'</span>&gt;&lt;/th&gt;<span class="hljs-string">");
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランチフォーメーションページでは、注文金額を計算するときに、テーブルのすべての行で考慮され、注文されたアイテムの数に価格を掛けたものになります。</font><font style="vertical-align: inherit;">これらの理由により、カテゴリの名前で行を追加すると、すべてが壊れます...この行の数量と金額がゼロの非表示の列を入力する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、テキストのクリーニングと料理の評価に関する情報の追加に移りましょう。</font><font style="vertical-align: inherit;">まず、いくつかのヘルパー関数。</font><font style="vertical-align: inherit;">格付けの料理は、グラムの形のゴミ、句読点、スペースのない名前で識別されます。</font><font style="vertical-align: inherit;">つまり、「チキンブロスウィズエッグ（チキンブロス、ニンジン、タマネギ、卵、グリーン）」と呼ばれる料理です。</font><font style="vertical-align: inherit;">100gで：タンパク質-3.43; </font><font style="vertical-align: inherit;">fats-2.86; </font><font style="vertical-align: inherit;">炭水化物-1.0; </font><font style="vertical-align: inherit;">en.value-43.39kcal（200gr）は、「ブイヨンカード」として識別されます。</font><font style="vertical-align: inherit;">これは、サプライヤーが余分なスペース、看板などに忍び込む可能性があるためです。</font><font style="vertical-align: inherit;">慣例が示すように、これは90％のケースで料理を正確に特定するのに十分であり、私たちはわざわざ全文検索を行わないことにしました。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">/**
 *        
 * <span class="hljs-doctag">@param </span>items   
 * <span class="hljs-doctag">@param </span>tdText   
 * <span class="hljs-doctag">@return </span> 
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findByName</span>(<span class="hljs-params">items, tdText</span>) </span>{<font></font>
    tdText = clearTrash(tdText, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> items.find(<span class="hljs-function">(<span class="hljs-params">{clear_name}</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> clear_name.trim().toLowerCase() === tdText;<font></font>
    });<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 *    
 * <span class="hljs-doctag">@param </span>text       
 * <span class="hljs-doctag">@param </span>clearDescr      
 * <span class="hljs-doctag">@param </span>clearGrams   
 * <span class="hljs-doctag">@return </span>  
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearTrash</span>(<span class="hljs-params">text, clearDescr, clearGrams, clearSymbols</span>) </span>{
    <span class="hljs-comment">//   ,      </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてこれは評価の形成です：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> table = $(<span class="hljs-string">".dinner__innerData"</span>);
<span class="hljs-keyword">const</span> nameTd = $(table).find(“tr td:nth-child(<span class="hljs-number">2</span>)”);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt;= nameTd.length; index++) {
    <span class="hljs-keyword">const</span> tdText = $(nameTd[index]).text();
    <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">const</span> item = findByName(items, tdText);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (item) {
        <span class="hljs-keyword">let</span> ratingTd = $(nameTd[index]).parent().find(“td:nth-child(<span class="hljs-number">2</span>)”)[<span class="hljs-number">0</span>];
        <span class="hljs-comment">//          </span>
        <span class="hljs-keyword">let</span> ratingText = <span class="hljs-string">"&lt;i&gt;&lt;/i&gt; "</span> + <span class="hljs-built_in">parseFloat</span>(item.avgrating).toFixed(<span class="hljs-number">1</span>) + <span class="hljs-string">" (: "</span> + item.orders + <span class="hljs-string">", : "</span> + item.ratingsCount + <span class="hljs-string">")"</span>;<font></font>
        ratingText = item.persrating ? <span class="hljs-string">`&lt;b&gt;&lt;i&gt;&lt;/i&gt; <span class="hljs-subst">${<span class="hljs-built_in">parseFloat</span>(item.persrating).toFixed(<span class="hljs-number">1</span>)}</span> (: <span class="hljs-subst">${item.perscount}</span>)&lt;/b&gt;&lt;br&gt;`</span> + ratingText : ratingText;
       <span class="hljs-comment">//  </span><font></font>
       $(ratingTd).css({<font></font>
	<span class="hljs-comment">// getColorRating      </span>
            <span class="hljs-attr">background</span>: getColorRating(item.avgrating)<font></font>
      }).html(ratingText);<font></font>
    }<font></font>
    <span class="hljs-comment">//          </span>
    <span class="hljs-comment">//   ,     </span>
    <span class="hljs-keyword">const</span> grams = getGrams(tdText);
    <span class="hljs-comment">//    </span>
    $(nameTd[index]).html(clearTrash(tdText, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
    <span class="hljs-comment">//      ,      </span>
    $(nameTd[index]).append(<span class="hljs-string">"&lt;br/&gt;&lt;span&gt;&lt;/span&gt;"</span>)<font></font>
                                .find(<span class="hljs-string">"span"</span>)<font></font>
                                .append(grams)<font></font>
                                .css({<span class="hljs-string">"font-size"</span>: <span class="hljs-number">10</span>});<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それが起こったのです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2p/hh/i5/2phhi5w3iumlfgvezwl7uqvb-2k.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同意しますが、はるかに便利で便利ですか？</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント部分。</font><font style="vertical-align: inherit;">投票</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、注文した料理に投票する機能を追加し、注文を電文で送信するメッセージを送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/xe/vm/mjxevmjk1xjpktpmhzsvfqv7-zu.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトなしの注文の</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
あるページ注文した料理のページで、評価を追加します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addRatingForm</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> table = $(<span class="hljs-string">".dinner__innerData"</span>);
    <span class="hljs-keyword">const</span> nameTd = $(table).find(<span class="hljs-string">"tr td:nth-child(1)"</span>);
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt;= nameTd.length; index++) {
        <span class="hljs-keyword">const</span> tdText = $(nameTd[index]).text();<font></font>
        $(nameTd[index]).html(clearTrash(tdText, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));<font></font>
    }<font></font>
    <span class="hljs-comment">//       Telegram</span>
    $(table).append(<span class="hljs-string">"&lt;tfoot&gt;&lt;tr&gt;&lt;th colspan='6' class='rating-buttons btn-group margT0' style='display: table-cell;'&gt;&lt;/tr&gt;&lt;/tfoot&gt;"</span>);<font></font>
    $(<span class="hljs-string">".rating-buttons"</span>).prepend(<span class="hljs-string">`&lt;input type="submit" value="" class="btn_primary rating-button"&gt;`</span>);<font></font>
    $(<span class="hljs-string">".rating-buttons"</span>).prepend(<span class="hljs-string">`&lt;input type="submit" value=" Telegram" class="btn_primary send-button"&gt;`</span>);
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">await</span> diableButtonByDate();
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt;= table.length; index++) {<font></font>
        $(table[index]).find(<span class="hljs-string">"tbody tr td:nth-child(4)"</span>).after(<span class="hljs-string">"&lt;td class='ratingInputTd'&gt;&lt;input id='horizontal-spinner' class='ui-spinner-input' style='width:20px;'&gt;&lt;/td&gt;"</span>);<font></font>
        $(table[index]).find(<span class="hljs-string">"thead th:nth-child(4)"</span>).after(<span class="hljs-string">"&lt;th class='ui-state-default'&gt;&lt;/th&gt;"</span>);<font></font>
    }<font></font>
    $(<span class="hljs-string">".ui-spinner-input"</span>).spinner({
         <span class="hljs-attr">max</span>: <span class="hljs-number">10</span>,
         <span class="hljs-attr">min</span>: <span class="hljs-number">1</span><font></font>
    });<font></font>
    <span class="hljs-comment">//  </span>
    $(<span class="hljs-string">".rating-button"</span>).click(sendRating);<font></font>
    $(<span class="hljs-string">".send-button"</span>).click(sendTelegram);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 *      ,   
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">diableButtonByDate</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">//             .</span>
    <span class="hljs-comment">//             </span>
    <span class="hljs-keyword">const</span> buttons  = $(<span class="hljs-string">".rating-button"</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt;= buttons.length; index++) {
        <span class="hljs-keyword">const</span> button = $(buttons[index]);
        <span class="hljs-keyword">const</span> date = button.parent().parent().parent().parent().parent().parent().find(<span class="hljs-string">"&gt; td:nth-child(1)"</span>).text().substring(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> GM.getValue(date)) {<font></font>
            button.attr({<span class="hljs-attr">disabled</span>: <span class="hljs-string">"disabled"</span>});<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * 
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendRating</span>(<span class="hljs-params">event</span>) </span>{<font></font>
    event.preventDefault();<font></font>
    <span class="hljs-keyword">const</span> items = [];
    <span class="hljs-comment">//        </span>
    $(<span class="hljs-keyword">this</span>).parent().parent().parent().parent().find(<span class="hljs-string">"tr"</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> tdList = $(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">"td"</span>);
        <span class="hljs-keyword">const</span> ratingInput = $(tdList[<span class="hljs-number">4</span>]).find(<span class="hljs-string">"input"</span>);
        <span class="hljs-keyword">if</span> (!ratingInput.length) {
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
        items.push({<font></font>
             <span class="hljs-attr">count</span>: $(tdList[<span class="hljs-number">2</span>]).text(),
             <span class="hljs-attr">price</span>: $(tdList[<span class="hljs-number">1</span>]).text(),
             <span class="hljs-attr">name</span>: $(tdList[<span class="hljs-number">0</span>]).text(),
             <span class="hljs-attr">rating</span>: ratingInput.val(),<font></font>
        });<font></font>
     });<font></font>
    <span class="hljs-keyword">await</span> sendRequest(<span class="hljs-string">"POST"</span>, <span class="hljs-string">`https://****/dinners/r/<span class="hljs-subst">${telegramId}</span>`</span>, items);
    <span class="hljs-keyword">const</span> menuDate = $(<span class="hljs-keyword">this</span>).parent().parent().parent().parent().parent().parent().find(<span class="hljs-string">"&gt; td:nth-child(1)"</span>).text().substring(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">await</span> GM.setValue(menuDate, <span class="hljs-literal">true</span>);<font></font>
    location.reload();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これが出力で得られたものです：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/uq/ef/1kuqefnumbp3k_qu3ugottb5sd0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい-コードはひどいです。</font><font style="vertical-align: inherit;">はい-最適化されていません。</font><font style="vertical-align: inherit;">そして、はい-一部の場所では非論理的です。</font><font style="vertical-align: inherit;">しかし、費やす時間は最小限であり、機能性と利便性は大幅に向上しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目的は、私と私の同志のために夕食を注文することをより楽しいものにすることでした、そして私の考えでは、この目標は達成されました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja475880/index.html">マイクロソフトソリューションアーキテクト向けの7つの無料コース</a></li>
<li><a href="../ja475882/index.html">JavaFXチュートリアル：基本的なレイアウト</a></li>
<li><a href="../ja475884/index.html">グラデーションのギザギザ線の問題を解決する</a></li>
<li><a href="../ja475886/index.html">Amazon AIは、ユーザーのわいせつなコンテンツへの取り組みを容易にします</a></li>
<li><a href="../ja475888/index.html">クラウドの顔認識の利点</a></li>
<li><a href="../ja475894/index.html">3パスプロトコル</a></li>
<li><a href="../ja475896/index.html">フル機能のベアメタルI / Oリアクター</a></li>
<li><a href="../ja475900/index.html">最新の6つのAzureコース</a></li>
<li><a href="../ja475902/index.html">ワークフローコア-.Net Coreのビジネスプロセスエンジン</a></li>
<li><a href="../ja475904/index.html">新しいマネージャーのための5つのメモ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>