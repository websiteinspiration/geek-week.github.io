<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèΩ üë©üèª‚Äç‚úàÔ∏è üôé The task for the developer, or how we scanned hand scanners without a vendor üóØÔ∏è ‚úåüèø üëàüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. 
 
 We, Victor Antipov and Ilya Aleshin, today will talk about our experience with USB devices through Python PyUSB and a little about...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The task for the developer, or how we scanned hand scanners without a vendor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/490748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We, Victor Antipov and Ilya Aleshin, today will talk about our experience with USB devices through Python PyUSB and a little about reverse engineering.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/ux/va/j4uxvafzrna4qe-37a6miqsyg1u.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2019, Decree of the Government of the Russian Federation No. 224 ‚ÄúOn approval of the rules for labeling tobacco products by means of identification and the specifics of introducing a state information system for monitoring the circulation of goods subject to mandatory labeling by means of identification in relation to tobacco products‚Äù entered into force. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The document explains that from July 1, 2019, manufacturers are required to label each pack of tobacco. And direct distributors should receive these products with the design of a universal transfer document (UPD). Shops, in turn, need to register the sale of labeled products through the cash register.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, from July 1, 2020, unmarked tobacco products are banned. This means that all packs of cigarettes must be labeled with a special Datamatrix barcode. And - an important point - it turned out that Datamatrix will not be ordinary, but inverse. That is, not a black code on white, but vice versa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We tested our scanners, and it turned out that most of them need to be reflashed / retrained, otherwise they simply are not able to work normally with this barcode. This turn of events guaranteed us a severe headache, because our company has a lot of stores that are scattered across a vast territory. Several tens of thousands of cash desks - and extremely little time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What was to be done? </font><font style="vertical-align: inherit;">There are two options. </font><font style="vertical-align: inherit;">First: engineers at the facility manually reflash and adjust the scanners. </font><font style="vertical-align: inherit;">Second: we work remotely and, preferably, we cover many scanners at once in one iteration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first option, obviously, did not suit us: we would have to spend money on field trips of engineers, and in this case it is difficult to control and coordinate the process. </font><font style="vertical-align: inherit;">But the most important thing is that people would work, that is, potentially we would get a lot of mistakes and, most likely, would not fit the deadline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second option is good for everyone, if not for one but. </font><font style="vertical-align: inherit;">Some vendors did not have the remote flashing tools we needed for all the required operating systems. </font><font style="vertical-align: inherit;">And since the deadlines were running out, I had to think with my own head.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we will describe how we developed tools for handheld scanners for the Debian 9.x OS (we have all the Debian box office).</font></font><br>
<br>
<h3> :   </h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Says Victor Antipov.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The official utility provided by the vendor works under Windows, and only with IE. The utility can flash and configure the scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the target system is Debian, we installed the usb-redirector server on the Debian server and the usb-redirector client on the Windows. Using the usb-redirector utilities, the scanner was forwarded from the Linux machine to the Windows machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The utility from the Windows vendor saw the scanner and even flashed it normally. Thus, the first conclusion was made: nothing depends on the OS, the matter is in the flashing protocol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK. A flashing was launched on a Windows machine, and a dump was removed on a Linux machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They stuffed the dump into WireShark and ... were sad (I‚Äôll omit part of the dump details, they are of no interest). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What dump showed us:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/ut/sa/5cutsausebu86kbucq6rfksz7wu.png"><br>
<br>
<img src="https://habrastorage.org/webt/9z/ex/jo/9zexjowdglq6cjc88ln5r6tlkcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The addresses 0000-0030, judging by Wireshark, are USB service information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We were interested in part 0040-0070. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nothing was clear from one transmission frame, except for MOCFT characters. These symbols turned out to be symbols from the firmware file, as well as the rest of the symbols until the end of the frame (the firmware file is highlighted): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/ls/mf/yblsmf2htqk4n-lsa3u702yy5vm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What did the symbols fd 3e 02 01 fe mean, I personally, like Ilya, had no idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I looked at the next frame (service information is deleted here, the firmware file is highlighted): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/sr/ut/r3srutakf1ioytxspf1zurv9pww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What became clear? That the first two bytes are some kind of constant. All subsequent blocks confirmed this, but before the end of the transmission block:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/t6/ux/j7t6uxe8auhqxaxp5azeolv5jwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This frame also entered into a stupor, since the constant changed (highlighted) and, strangely enough, there was a part of the file. The size of the transmitted bytes of the file indicated that 1024 bytes were transferred. What the remaining bytes meant - I did not know again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, like an old BBS nickname, I revised the standard transfer protocols. 1024 bytes, no protocol passed. He began to study the materiel and stumbled upon the 1K Xmodem protocol. It allowed to transmit 1024, but with a nuance: at first only 128, and only in the absence of errors did the protocol increase the number of bytes transmitted. I immediately had a transmission of 1024 bytes. I decided to study the transmission protocols, and specifically the X-modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were two variations of the modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, the format of the XMODEM package with CRC8 support (original XMODEM):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/dq/7w/wudq7w7yg59duxo2ok3rcng5bga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secondly, the XMODEM packet format with CRC16 support (XmodemCRC): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i2/cz/j3/i2czj3nd212vhlbms9uqrysd5xa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks similar, with the exception of SOH, packet number and CRC and the length of the packet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I looked at the beginning of the second transmission block (and again saw the firmware file, but with an indent of 1024 bytes):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/lk/nb/5vlknbhbecr2d3d7uigb19dh_cg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I saw the familiar header fd 3e 02, but the next two bytes have already changed: it was 01 fe, and it became 02 fd. Then I noticed that the second block is now numbered 02 and thus understood: in front of me is the numbering of the transmission block. The first 1024 transmission is 01, the second 02, the third 03 and so on (but in hex, of course). But what does the change from fe to fd mean? The eyes saw a decrease of 1, the brain reminded that programmers count from 0, not from 1. But then why is the first block 1, not 0? I did not find the answer to this question. But I understood how the second block is considered. The second block is nothing more than FF - (minus) the number of the first block. Thus, the second block was designated as = 02 (FF-02) = 02 FD. Subsequent reading of the dump confirmed my hunch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the following picture of the program began to emerge: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The beginning of the program</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 02 - Start </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01 FE - transmission counter </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transmission (34 blocks, 1024 bytes are transmitted) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 1024 bytes of data (divided into blocks of 30 bytes). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
End of transmission </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remains of data to align to 1024 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What does the block transfer end frame look like: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ee/t9/dmeet9sttaokhdirciuxag4p9y4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 - signal to the end of the block transfer. Next 2f 52 - the remains of the file up to 1024 bytes. 2f 52, judging by the protocol, is a 16-bit CRC checksum.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on old memory, I made a program in C that pulled 1024 bytes from a file and read 16-bit CRC. </font><font style="vertical-align: inherit;">The launch of the program showed that this is not a 16-bit CRC. </font><font style="vertical-align: inherit;">Again stupor - for about three days. </font><font style="vertical-align: inherit;">All this time I tried to understand what it could be if not a checksum. </font><font style="vertical-align: inherit;">Studying English-language sites, I found that the X-modem uses its own checksum calculation - CRC-CCITT (XModem). </font><font style="vertical-align: inherit;">I did not find any implementations in C for this calculation, but I found a site that read this checksum online. </font><font style="vertical-align: inherit;">By uploading 1024 bytes of my file to the web page, the site showed me a checksum that completely coincided with the checksum from the file.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hooray! </font><font style="vertical-align: inherit;">The last riddle is solved, now you had to make your own firmware. </font><font style="vertical-align: inherit;">Then I transferred my knowledge (and they remained only in my head) to Ilya, who is familiar with powerful tools - Python.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Program creation</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Narrated by Ilya Aleshin. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having received the appropriate instructions, I was very ‚Äúhappy‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where to begin? </font><font style="vertical-align: inherit;">Right, from the beginning. </font><font style="vertical-align: inherit;">ÔÅä From dumping from a USB port. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run USB-pcap </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://desowin.org/usbpcap/tour.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Select the port to which the device is connected and the file where we will save the dump. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/ax/xp/gaaxxp3qdqajous7didfd7gwkg8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect the scanner to the machine where the native EZConfigScanning software for Windows is installed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/oo/le/olooleeirgestw3q0gzvhqvzr58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In it we find the point of sending commands to the device. </font><font style="vertical-align: inherit;">But what about the teams? </font><font style="vertical-align: inherit;">Where to get them? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the program starts, the equipment is interrogated automatically (we will see this a bit later). </font><font style="vertical-align: inherit;">And there were training barcodes from official equipment documents. </font><font style="vertical-align: inherit;">DEFALT. </font><font style="vertical-align: inherit;">This is our team. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/dv/gf/8vdvgfiuthogftttgzdsxym22_4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The necessary data is received. </font><font style="vertical-align: inherit;">Open dump.pcap through wireshark.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Block at startup EZConfigScanning. The red points are places to pay attention to. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/ju/0x/wpju0xwxz9_hgex0jnnyttjxqpa.png"><br>
<br>
<img src="https://habrastorage.org/webt/nw/6s/so/nw6ssotdpggn37qvn9kvayxhxde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seeing all this for the first time, I lost heart. Where to dig further is unclear. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A bit of a brainstorming and-and-and ... Aha! In a dump, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">out</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">out</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Googled what URB_INTERRUPT is. Found out that this is a data transfer method. And there are 4 such methods: control, interrupt, isochronous, bulk. You can read about them separately. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the endpoint addresses in the USB device interface can be obtained either through the ‚Äúlsusb ‚Äìv‚Äù command, or by means of pyusb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to find all the devices with this VID. You can search specifically by VID: PID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/xp/i_/fnxpi_m69b43p6yzpeoh3atps0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g0/h4/td/g0h4tdpscytduyzmj4xqe31r5s4.png"><br>
<br>
<img src="https://habrastorage.org/webt/d4/wf/5k/d4wf5k6asqr5nvofve-ntd5sm4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have the necessary information: P_INFO commands. or DEFALT, addresses where to write the commands endpoint = 03 and where to get the answer endpoint = 86. It remains only to translate the commands in hex. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/io/wf/ui/iowfuid0hhvl6q6zpb9kfds3tny.png"><br>
<br>
<img src="https://habrastorage.org/webt/0p/gr/2j/0pgr2jw1u6tj5vqetitjg3g6chw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we already found the device, disconnect it from the kernel ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/xy/84/jixy849fy7l81g9tenjxpf7uymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and write to endpoint with address 0x03, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qx/v0/nt/qxv0nttjmnddvekfmbnfq9vebfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and then read the response from endpoint with address 0x86. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kj/xn/e2/kjxne2x9ab6spmxnk2ac3bnroc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Structured answer:</font></font><br>
<br>
<pre><code class="plaintext hljs">P_INFOfmt: 1<font></font>
mode: app<font></font>
app-present: 1<font></font>
boot-present: 1<font></font>
hw-sn: 18072B44CA<font></font>
hw-rev: 0x20<font></font>
cbl: 4<font></font>
app-sw-rev: CP000116BBA<font></font>
boot-sw-rev: CP000014BAD<font></font>
flash: 3<font></font>
app-m_name: Voyager 1450g<font></font>
boot-m_name: Voyager 1450g<font></font>
app-p_name: 1450g<font></font>
boot-p_name: 1450g<font></font>
boot-time: 16:56:02<font></font>
boot-date: Oct 16 2014<font></font>
app-time: 08:49:30<font></font>
app-date: Mar 25 2019<font></font>
app-compat: 289<font></font>
boot-compat: 288<font></font>
csum: 0x6986</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see this data in dump.pcap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cr/z5/2y/crz52y_j0alhcohhokmry0bx7t8.png"><br>
<br>
<img src="https://habrastorage.org/webt/-s/np/cv/-snpcv4opok9jdsrj8thkshno_4.png"><br>
<br>
<img src="https://habrastorage.org/webt/qj/dq/zl/qjdqzlcwogon9yts12p5awr32ha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fine! We translate system barcodes to hex. Everything, the training functionality is ready. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do with firmware? It seems that everything is the same, but there is a nuance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having removed a complete dump of the flashing process, we roughly understood what we were dealing with. Here is an article about XMODEM that really helped to understand how this communication happens, albeit in general terms: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://microsin.net/adminstuff/others/xmodem-protocol-overview.html I</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recommend reading it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking in the dump, you can see that the frame size is 1024, and the size of URB-data is 64. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/o6/uj/wio6ujyvlj_bnltlngxf24k9evk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, 1024/64, we get 16 lines in a block, read the firmware file by 1 character and form a block. Supplementing 1 line in a block with special characters fd3e02 + block number.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next 14 lines are supplemented with fd25 +, using XMODEM.calc_crc () we calculate the checksum of the entire block (it took a lot of time to understand that ‚ÄúFF - 1‚Äù is CSUM) and the last 16th line is supplemented with fd3e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem that everything, read the firmware file, hit the blocks, disconnect the scanner from the kernel and send it to the device. </font><font style="vertical-align: inherit;">But not so simple. </font><font style="vertical-align: inherit;">The scanner must be put into firmware mode by </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sending it NEWAPP = '\\ xfd \\ x0a \\ x16 \\ x4e \\ x2c \\ x4e \\ x45 \\ x57 \\ x41 \\ x50 \\ x50 \\ x0d'. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where does this command come from ?? </font><font style="vertical-align: inherit;">From the dump. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/sd/nd/ausdnd16ikur6ajzdiyk9-ntklw.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we cannot send the whole block to the scanner due to the restriction of 64: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/db/k6/qg/dbk6qgrapgsxiwdo9jyxqd0svwu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the scanner in the NEWAPP flashing mode does not accept hex either. </font><font style="vertical-align: inherit;">Therefore it is necessary to translate each line bytes_array</font></font><br>
<br>
<pre><code class="plaintext hljs">[253, 10, 22, 78, 44, 78, 69, 87, 65, 80, 80, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And already send this data to the scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get the answer:</font></font><br>
<br>
<pre><code class="plaintext hljs">[2, 1, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you check the article about XMODEM, it becomes clear: the data has been accepted. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/fd/gj/pofdgjvcgns7oxdeonuldkqbptg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all the blocks have been transferred, we complete the transfer END_TRANSFER = '\ xfd \ x01 \ x04'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, since these blocks do not carry any information for ordinary people, we‚Äôll make the firmware in hidden mode by default. </font><font style="vertical-align: inherit;">And just in case, through tqdm we will organize a progress bar. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/18/g1/da18g1axnll2zps9qpx2s7opkha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, the rest is small. </font><font style="vertical-align: inherit;">It remains only to wrap the solution in scripts for mass replication at a clearly defined time, so as not to slow down the process of working at the box office, and add logging.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having spent a lot of time and energy </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and hair on the head</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we were able to develop the solutions we needed, moreover, we met the deadline. </font><font style="vertical-align: inherit;">At the same time, scanners are reflashed and retrained now centrally, we clearly control the entire process. </font><font style="vertical-align: inherit;">The company saved time and money, and we gained invaluable experience in reverse engineering of this type of equipment.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490736/index.html">9 clear tools for learning and pumping English vocabulary</a></li>
<li><a href="../en490738/index.html">Lisk substitution principle</a></li>
<li><a href="../en490740/index.html">Defecting *** s is not just randomization</a></li>
<li><a href="../en490742/index.html">A new era in robotics has begun</a></li>
<li><a href="../en490746/index.html">Rating in Yandex.Taxi: a short post on a serious topic</a></li>
<li><a href="../en490750/index.html">Mikhail Salosin. Golang Meetup. Using Go in the backend of the Watch + application</a></li>
<li><a href="../en490754/index.html">Visual Studio Code Code Editor. The most detailed guide for setting up and installing plugins for beginners</a></li>
<li><a href="../en490756/index.html">Deploy Jenkins as code</a></li>
<li><a href="../en490758/index.html">Mathematicians have proved the universal law of turbulence</a></li>
<li><a href="../en490760/index.html">Ray Casting Visual Search (RCVS). Simple and fast algorithm for finding 3D models similar in geometry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>