<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♻️ 👩🏿‍🤝‍👩🏼 💳 我们在etcd Kubernetes-cluster中直接处理数据的经验（不使用K8s API） 🏭 👨🏻‍🎤 👨🏿‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="客户越来越多地向我们请求提供对Kubernetes集群的访问权，以访问集群内的服务：为了能够直接连接到某些数据库或服务，将本地应用程序与集群内的应用程序连接起来…… 
 
 
 
 例如，需要进行连接从您的本地机器到服务memcached.staging.svc.cluster.local。我们为这...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>我们在etcd Kubernetes-cluster中直接处理数据的经验（不使用K8s API）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/501956/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户越来越多地向我们请求提供对Kubernetes集群的访问权，以访问集群内的服务：为了能够直接连接到某些数据库或服务，将本地应用程序与集群内的应用程序连接起来…… </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/mh/du/rimhduzpzbuwtylhnil4dorhzw4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，需要进行连接从您的本地机器到服务</font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我们为这个机会提供了客户端连接到的群集内部的VPN。为此，我们宣布了Pod，服务的子网，并将群集DNS推送到客户端。因此，当客户端尝试连接到服务时</font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，请求将转到群集的DNS，并作为响应从群集服务网络接收该服务的地址或Pod地址。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们使用kubeadm配置K8s集群，其中服务子网默认</font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为，吊舱网络为</font></font><code>10.244.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">通常，一切正常，但有两点：</font></font><a name="habracut"></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子</font></font><code>192.168.*.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网通常用于客户端的办公网络，甚至更经常用于开发人员的家庭网络。</font><font style="vertical-align: inherit;">然后我们遇到了冲突：家用路由器在该子网上工作，VPN将这些子网从群集推送到客户端。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有几个集群（生产，阶段和/或几个开发集群）。</font><font style="vertical-align: inherit;">然后，默认情况下，所有这些容器中的pod和服务都将具有相同的子网，这给同时使用多个群集中的服务带来了很大的困难。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，在相当长的一段时间内，我们已经采用了在一个项目的框架内对服务和Pod使用不同子网的做法-通常，以便所有群集都具有不同的网络。</font><font style="vertical-align: inherit;">但是，我不想从头开始运行大量群集，因为它们运行许多服务，有状态应用程序等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后我们问自己：如何更改现有群集中的子网？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">搜寻决策</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最常见的做法是</font><font style="vertical-align: inherit;">使用ClusterIP类型</font><font style="vertical-align: inherit;">重新创建</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务。</font><font style="vertical-align: inherit;">或者，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他们也可以建议</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下过程存在问题：配置完所有内容后，pod在/etc/resolv.conf中将旧IP用作DNS名称服务器。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于仍然找不到解决方案，因此我不得不使用kubeadm reset重置整个集群，然后再次将其初始化。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但这并不适合每个人...以下是针对我们案例的更详细的入门说明： </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 被法兰绒使用；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 云层和铁块上都有团簇;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我想避免在集群中重复部署所有服务；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 需要以最小的问题来做所有事情；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kubernetes版本为1.16.6（但是，其他版本的其他操作将类似）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要任务是将其</font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换为</font><font style="vertical-align: inherit;">使用带有服务子网的kubeadm部署的群集</font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
碰巧的是，很长一段时间以来，我们很感兴趣地看到它存储在etcd中的方式以及如何在Kubernetes中存储，根本可以用它来完成...因此我们想到：“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么不通过替换旧的IP地址（子网）来更新etcd中的数据换新的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在寻找用于在etcd中处理数据的现成工具时，我们没有找到可以完全解决任务的任何东西。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（顺便说一句，如果您知道任何直接在etcd中处理数据的实用程序，我们将非常感谢您提供的链接。）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但是，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">OpenShift </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etcdhelper</font></font></b><font style="vertical-align: inherit;"></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成为了一个很好的起点</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（感谢其作者！）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该实用程序能够连接使用证书ETCD使用这些命令上读出的数据</font></font><code>ls</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>dump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加etcdhelper</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下想法是合乎逻辑的：“是什么阻碍了添加此实用程序，增加了向etcd写入数据的功能？” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它已被翻译成etcdhelper修改后的版本有两个新的</font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font><font style="vertical-align: inherit;">功能</font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里</font></font></a></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">看到</font></b><font style="vertical-align: inherit;">她的</font><b><font style="vertical-align: inherit;">代码</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新功能有什么作用？</font><font style="vertical-align: inherit;">算法</font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建一个反序列化器；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 编译正则表达式以替换CIDR；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们通过集群中所有具有ClusterIP类型的服务：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 将etcd中的值解码为Go对象；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 使用正则表达式替换地址的前两个字节；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 从新子网为服务分配IP地址；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 创建一个序列化器，将Go对象转换为protobuf，将新数据写入etcd。</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
功能</font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本质上是相同的</font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-只是不对服务规范进行编辑，我们对节点进行了处理并将其更改</font></font><code>.spec.PodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为新的子网。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实践</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变更服务CIDR</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任务的执行计划非常简单，但是在重新创建集群中的所有Pod时都会涉及停机时间。</font><font style="vertical-align: inherit;">在描述了主要步骤之后，我们还将分享我们的想法，即从理论上如何最小化这一简单步骤。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
准备行动：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 安装必要的软件并组装修补的etcdhelper；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">备份etcd和</font></font><code>/etc/kubernetes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更改服务的短期行动计划CIDR：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 修改apiserver和控制器管理器清单</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 重新签发证书；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> etcd中的ClusterIP服务发生了变化；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 重新启动集群中的所有Pod。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是详细的完整动作序列。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.安装etcd-client进行数据转储：</font></font><br>
<br>
<pre><code class="bash hljs">apt install etcd-client</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.我们收集etcdhelper：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们把golang：</font></font><br>
<br>
<pre><code class="bash hljs">GOPATH=/root/golang<font></font>
mkdir -p <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
curl -sSL https://dl.google.com/go/go1.14.1.linux-amd64.tar.gz | tar -xzvC <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"export GOPATH=\"<span class="hljs-variable">$GOPATH</span>\""</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export GOROOT="$GOPATH/local/go"'</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="$PATH:$GOPATH/local/go/bin"'</span> &gt;&gt; ~/.bashrc</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们保存自己</font></font><code>etcdhelper.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，加载依赖项，收集：</font></font><br>
<br>
<pre><code class="bash hljs">wget https://raw.githubusercontent.com/flant/examples/master/2020/04-etcdhelper/etcdhelper.go<font></font>
go get go.etcd.io/etcd/clientv3 k8s.io/kubectl/pkg/scheme k8s.io/apimachinery/pkg/runtime<font></font>
go build -o etcdhelper etcdhelper.go</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.备份etcd：</font></font><br>
<br>
<pre><code class="bash hljs">backup_dir=/root/backup<font></font>
mkdir <span class="hljs-variable">${backup_dir}</span>
cp -rL /etc/kubernetes <span class="hljs-variable">${backup_dir}</span>
ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --key=/etc/kubernetes/pki/etcd/server.key --cert=/etc/kubernetes/pki/etcd/server.crt --endpoints https://192.168.199.100:2379 snapshot save <span class="hljs-variable">${backup_dir}</span>/etcd.snapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.在Kubernetes控制平面清单中更改服务子网。</font><font style="vertical-align: inherit;">在文件中</font></font><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并</font></font><code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">改变参数</font></font><code>--service-cluster-ip-range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到新的子网：</font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代替</font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.由于我们正在更改kubeadm为其颁发apiserver证书（包括）的服务子网，因此必须重新发布：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 让我们看一下当前证书的颁发域和IP地址：</font></font><br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:dev-1-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:apiserver, IP Address:192.168.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 准备kubeadm的最低配置：</font></font><br>
<br>
<pre><code class="bash hljs">cat kubeadm-config.yaml<font></font>
apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: ClusterConfiguration<font></font>
networking:<font></font>
  podSubnet: <span class="hljs-string">"10.244.0.0/16"</span>
  serviceSubnet: <span class="hljs-string">"172.24.0.0/16"</span><font></font>
apiServer:<font></font>
  certSANs:<font></font>
  - <span class="hljs-string">"192.168.199.100"</span> <span class="hljs-comment"># IP-  </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 让我们删除旧的crt和密钥，因为没有它，将不会颁发新证书：</font></font><br>
<br>
<pre><code class="bash hljs">rm /etc/kubernetes/pki/apiserver.{key,crt}</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 重新颁发API服务器的证书：</font></font><br>
<br>
<pre><code class="bash hljs">kubeadm init phase certs apiserver --config=kubeadm-config.yaml</code></pre></li>
<li> ,      :<br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:kube-2-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:172.24.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li>    API-   :<br>
<br>
<pre><code class="bash hljs">docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string">'{print $1}'</span> | xargs docker restart</code></pre></li>
<li>    <code>admin.conf</code>:<br>
<br>
<pre><code class="bash hljs">kubeadm alpha certs renew admin.conf</code></pre></li>
<li>    etcd:<br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-service-cidr 172.24.0.0/16 </code></pre><br>
<b>!</b>         ,      pod'  <code>/etc/resolv.conf</code>    CoreDNS (kube-dns),  kube-proxy   iptables     .         .</li>
<li>  ConfigMap'    <code>kube-system</code>:<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubelet-config-1.16</code></pre><br>
—   <code>clusterDNS</code>   IP-  kube-dns: <code>kubectl -n kube-system get svc kube-dns</code>.<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br>
—  <code>data.ClusterConfiguration.networking.serviceSubnet</code>   .</li>
<li>     kube-dns,    kubelet   :<br>
<br>
<pre><code class="bash hljs">kubeadm upgrade node phase kubelet-config &amp;&amp; systemctl restart kubelet</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 仍然可以重新启动集群中的所有Pod：</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get pods --no-headers=<span class="hljs-literal">true</span> --all-namespaces |sed -r <span class="hljs-string">'s/(\S+)\s+(\S+).*/kubectl --namespace \1 delete pod \2/e'</span></code></pre></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">停机时间最少</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于如何最大程度地减少停机时间的想法：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更改控制平面的表示后，例如，使用名称</font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和新地址</font><font style="vertical-align: inherit;">创建一个新的kube-dns服务</font></font><code>172.24.0.10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在etcdhelper，这不会修改KUBE-DNS服务。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用</font></font><code>ClusterDNS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新的</font><font style="vertical-align: inherit;">kubelet替换所有kubelet中的地址</font><font style="vertical-align: inherit;">，而旧的服务将继续与新的</font><font style="vertical-align: inherit;">kubelet </font><font style="vertical-align: inherit;">同时工作。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 等待带有应用程序的pod出于自然原因自己或在约定的时间滚动。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除服务</font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并将其更改</font></font><code>serviceSubnetCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为kube-dns服务。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该计划将</font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在关闭服务和更换服务的子网之前，</font><font style="vertical-align: inherit;">将停机时间最小化到一分钟左右</font></font><code>kube-dns</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">修改podNetwork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，我们决定看看如何使用生成的etcdhelper修改podNetwork。</font><font style="vertical-align: inherit;">动作顺序如下：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们修复了配置</font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们修复了kube-controller-manager的清单；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们直接在etcd中更改podCIDR；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 重新启动群集的所有节点。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，更多有关这些操作的信息：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.在名称空间中修改ConfigMap </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-固定</font></font><code>data.ClusterConfiguration.networking.podSubnet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在新的子网中</font></font><code>10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kube-proxy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-我们纠正了</font></font><code>data.config.conf.clusterCIDR: 10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.修改控制器管理员的清单：</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-我们纠正了</font></font><code>--cluster-cidr=10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.查看当前值</font></font><code>.spec.podCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>.spec.podCIDRs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>.InternalIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>.status.addresses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于集群中的所有节点：</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.通过直接对etcd进行更改来替换podCIDR：</font></font><br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-pod-cidr 10.55.0.0/16</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.检查podCIDR是否确实已更改：</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6.反过来，我们将重新引导集群的所有节点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7.如果至少一个节点</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">离开了旧的podCIDR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么kube-controller-manager将无法启动，并且群集中的Pod也不会被计划。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，更改podCIDR可以变得更加容易（例如，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">像这样</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">但是我们想学习如何直接使用etcd，因为在某些情况下，在etcd中编辑Kubernetes对象是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">唯一</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能的选择。</font><font style="vertical-align: inherit;">（例如，您不能在没有停机的情况下更改服务范围</font></font><code>spec.clusterIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。）</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文考虑了直接在etcd中处理数据的可能性，即 </font><font style="vertical-align: inherit;">绕过Kubernetes API。</font><font style="vertical-align: inherit;">有时，这种方法使您可以做“棘手的事情”。</font><font style="vertical-align: inherit;">本文中描述的操作已在真实的K8s集群上进行了测试。</font><font style="vertical-align: inherit;">但是，它们准备广泛使用的状态是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PoC（概念证明）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，如果要在群集上使用etcdhelper实用程序的修改版，则后果自负，并承担风险。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另请参阅我们的博客：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etcd 3.4.3：存储可靠性和安全性研究</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes上的Calico for web：了解和一点经验</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes [及其解决方案]操作中的6个有趣的系统错误</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">      Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501938/index.html">普罗米修斯（Prometheus），不要走：用于Kubernetes的6种替代监视工具</a></li>
<li><a href="../zh-CN501940/index.html">关于Neutralino.js的一些知识</a></li>
<li><a href="../zh-CN501942/index.html">看板方法：将您的过程理解为集体学习过程</a></li>
<li><a href="../zh-CN501948/index.html">火车如何在车站之间行驶：路线功能</a></li>
<li><a href="../zh-CN501954/index.html">VR是在等待Microsoft Kinect还是游戏的未来-让我们一起谈谈</a></li>
<li><a href="../zh-CN501960/index.html">搜索缩放。弹性搜索 其优点和安装基本要求</a></li>
<li><a href="../zh-CN501964/index.html">工业计算机有什么用？</a></li>
<li><a href="../zh-CN501968/index.html">Kotlin多平台中的MVI建筑模板，第1部分</a></li>
<li><a href="../zh-CN501970/index.html">在RPG中创建良好的地牢需要什么？</a></li>
<li><a href="../zh-CN501976/index.html">如何学习测试软件</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>