<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥üèº ‚õπüèæ üßöüèΩ Trabajo inteligente con RabbitMQ en NestJS üî∏ üî∑ üë®‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando se desarrollan sistemas financieros, los mecanismos est√°ndar para procesar tareas completadas en la mayor√≠a de las implementaciones del protoco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trabajo inteligente con RabbitMQ en NestJS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491076/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se desarrollan sistemas financieros, los mecanismos est√°ndar para procesar tareas completadas en la mayor√≠a de las implementaciones del protocolo AMQP no siempre son adecuados. </font><font style="vertical-align: inherit;">En alg√∫n momento, encontramos ese problema, pero lo primero es lo primero.</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La implementaci√≥n est√°ndar de RabbitMQ en NestJS facilita la recepci√≥n de mensajes en funciones decoradas:</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-built_in">console</span>.log(context.getMessage());<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ se describen m√°s detalles sobre c√≥mo funciona esto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n el trabajo con colas en Nest estaba bien cubierto en este art√≠culo sobre Habr√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que se podr√≠a necesitar algo m√°s. </font><font style="vertical-align: inherit;">Sin embargo, hay una serie de desventajas en la implementaci√≥n actual.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para enviar el resultado ack a un canal, debe extraer el canal manualmente del contexto RmqContext y enviarle una se√±al.</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-keyword">const</span> channel = context.getChannelRef();
  <span class="hljs-keyword">const</span> originalMsg = context.getMessage();<font></font>
  channel.ack(originalMsg);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilice el mismo patr√≥n que se utiliz√≥ al trabajar con controladores HTTP al devolver el resultado de la ejecuci√≥n directamente desde la funci√≥n como un objeto normal, Promesa u Observable.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesita enviar el resultado en una cola separada, entonces en cada controlador que use Rabbit necesita saber su nombre. </font><font style="vertical-align: inherit;">En otras palabras, no hay forma de configurar esto en 1 lugar durante la inicializaci√≥n del m√≥dulo y usarlo impl√≠citamente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la etapa de configuraci√≥n del m√≥dulo, especifique las colas para resultados exitosos de operaciones y para errores. </font><font style="vertical-align: inherit;">Decidimos enviar los resultados de operaciones exitosas en una cola y los resultados de operaciones err√≥neas en otra. </font><font style="vertical-align: inherit;">Usando la soluci√≥n al problema 1, si el valor de retorno, Promesa u Observable es exitoso, entonces el resultado se env√≠a a la cola de operaci√≥n exitosa, si no, el mensaje se rechaza y cae en la cola de error, RabbitMQ hace que sea f√°cil hacerlo usando las opciones x-dead -letter-exchange y x-dead-letter-routing-key al crear la cola.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como usuario de la biblioteca, el desarrollador necesita conocer los detalles del protocolo AMQP para obtener la identificaci√≥n del siguiente mensaje, comprender qu√© es el reconocimiento y cu√°ndo llamarlo, etc.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregue un decorador para obtener la identificaci√≥n del mensaje. </font><font style="vertical-align: inherit;">En lugar de ack, devuelve el resultado de la ejecuci√≥n desde la funci√≥n del controlador.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 4</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiz√°s el problema m√°s importante: entregar un mensaje al controlador m√°s de una vez. Cuando se trata de transacciones financieras, este es un punto muy importante, porque puede surgir una situaci√≥n en la que el dinero ya ha sido enviado, y la operaci√≥n cay√≥ en el √∫ltimo paso, al escribir en la base de datos o al enviar un mensaje de confirmaci√≥n al agente de mensajes. Una de las decisiones obvias es cuando el consumidor recibe el mensaje, antes de procesar el mensaje, escriba el ID del mensaje generado por el productor en la base de datos, si no hay ninguno, si lo hay, luego rechace el mensaje. Pero el protocolo AMQP proporciona un indicador de reenv√≠o que identifica si este mensaje se entreg√≥ alguna vez a otros clientes, que podemos usar para detectar mensajes reenviados y enviarlos a la cola con errores.En la implementaci√≥n actual en Nest, no hay forma de no entregar dichos mensajes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entregue este mensaje al controlador, pero registre el error en la etapa de recepci√≥n del mensaje del controlador. </font><font style="vertical-align: inherit;">Por supuesto, este comportamiento se puede configurar en la etapa de decorar el m√©todo para indicar expl√≠citamente que todav√≠a queremos recibir mensajes para este tipo de acci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver todos los problemas anteriores, se escribi√≥ su propia implementaci√≥n del protocolo. </font><font style="vertical-align: inherit;">C√≥mo se ve la inicializaci√≥n:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> amqp = <span class="hljs-keyword">await</span> NestFactory.create(<font></font>
 RabbitModule.forRoot({<font></font>
   <span class="hljs-attr">host</span>: process.env.AMQP_QUEUE_HOST,
   <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PORT, <span class="hljs-number">10</span>),
   <span class="hljs-attr">login</span>: process.env.AMQP_QUEUE_LOGIN,
   <span class="hljs-attr">password</span>: process.env.AMQP_QUEUE_PASSWORD,
   <span class="hljs-attr">tasksQueueNormal</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST,
   <span class="hljs-attr">tasksQueueRedelivery</span>: process.env.AMQP_QUEUE_REQUEST_ONCE_DELIVERY,
   <span class="hljs-attr">deadLetterRoutingKey</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_DEAD_LETTER,
   <span class="hljs-attr">deadLetterRoutingKeyRedelivery</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_ONCE_DELEVERY_DEAD_LETTER,
   <span class="hljs-attr">exchange</span>: process.env.AMQP_EXCHANGE_COMMAND,
   <span class="hljs-attr">prefetch</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PREFETCH, <span class="hljs-number">10</span>),<font></font>
 }),<font></font>
);<font></font>
<span class="hljs-keyword">const</span> transport = amqp.get&lt;RabbitTransport&gt;(RabbitTransport);<font></font>
app.connectMicroservice({<font></font>
 <span class="hljs-attr">strategy</span>: transport,
 <span class="hljs-attr">options</span>: {},<font></font>
});<font></font>
<font></font>
app.startAllMicroservices();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ indicamos los nombres de las colas para entregar mensajes, resultados y errores, as√≠ como las colas individuales que no son sensibles a la nueva entrega. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el nivel del controlador, el trabajo es tan similar como trabajar con http</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHay(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heyService.greet(requestId, q);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado de la tarea caer√° en la cola de resultados tan pronto como se ejecute este Observable. </font><font style="vertical-align: inherit;">El par√°metro decorado con @AMQPRequest corresponde al campo correlationId del protocolo. </font><font style="vertical-align: inherit;">Este es un identificador √∫nico para el mensaje entregado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El par√°metro @AMQPParam coincide con el cuerpo del mensaje. </font><font style="vertical-align: inherit;">Si es JSON, el mensaje llegar√° a la funci√≥n ya convertida en el objeto. </font><font style="vertical-align: inherit;">Si es un tipo simple, el mensaje se env√≠a tal cual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente mensaje estar√° en la letra muerta:</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHayErr(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> throwError(‚ÄòBuy‚Äô);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√© pasa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregue Type Reflection a AMQPParam para que el cuerpo del mensaje se convierta a la clase que se pasa. </font><font style="vertical-align: inherit;">Ahora es solo una casta para escribir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo el c√≥digo y las instrucciones de instalaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√°n disponibles en GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier edici√≥n y comentario son bienvenidos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es491052/index.html">C√≥mo y por qu√© los curadores de la HSE de San Petersburgo ayudan a los programadores de primer a√±o</a></li>
<li><a href="../es491054/index.html">C√≥mo firmar correspondencia por correo electr√≥nico con una clave GPG usando tokens PKCS # 11</a></li>
<li><a href="../es491056/index.html">Ampere Altra: el primer procesador ARM de 80 n√∫cleos del mundo</a></li>
<li><a href="../es491058/index.html">Mortalidad, mortalidad, coronavirus y matan</a></li>
<li><a href="../es491062/index.html">Angular: crear un elemento de formulario personalizado y pasarle el estado del formulario</a></li>
<li><a href="../es491084/index.html">saneex.c: try / catch / finalmente basado en setjmp / longjmp (C99) m√°s r√°pido que las excepciones est√°ndar de C ++ ¬π</a></li>
<li><a href="../es491086/index.html">Biblioteca JavaScript de Webix a trav√©s de los ojos de un principiante. Parte 6. Interacci√≥n del servidor</a></li>
<li><a href="../es491088/index.html">GitHub: nueva biblioteca de c√≥digo abierto para OSINT</a></li>
<li><a href="../es491090/index.html">Convierta documentos de texto a xml en C #</a></li>
<li><a href="../es491092/index.html">C√≥mo Crash Bandicoot hacke√≥ Playstation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>