<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👋🏽 👨🏾‍🎤 💖 Beschleunigung des Qemu KVM-Festplattensubsystems unter Linux 👩🏽‍🤝‍👩🏼 ⚖️ 👖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Manchmal übernehme ich verschiedene Aufgaben zum Einrichten von Servern. Vor einiger Zeit kam der Besitzer eines kleinen Hosting-Unternehmens mit eine...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Beschleunigung des Qemu KVM-Festplattensubsystems unter Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/493696/"><img src="https://habrastorage.org/webt/gx/ub/i1/gxubi1ucfhq7jujnimizriacaqa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manchmal übernehme ich verschiedene Aufgaben zum Einrichten von Servern. </font><font style="vertical-align: inherit;">Vor einiger Zeit kam der Besitzer eines kleinen Hosting-Unternehmens mit einem interessanten Problem auf mich zu. </font><font style="vertical-align: inherit;">Er möchte virtuelle Windows-Maschinen unter KVM auf seinen Servern ausführen, auf denen Ubuntu 18.04 bereits installiert war. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seine Tests zeigten jedoch, dass das KVM-Festplattensystem deutlich hinter den Indikatoren zurückblieb, die er unter Hyper-V hatte. </font><font style="vertical-align: inherit;">Er wollte qemu auf seinen Ubuntu-Servern einsetzen, um den Kauf teurer Windows-Serverlizenzen zu vermeiden (die kostenlose Version von Microsoft Hyper-V Server funktionierte aufgrund ihrer Einschränkungen nicht).</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0. Disposition</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Testen haben wir die Samsung 970 Pro 1 TB SSD verwendet. </font><font style="vertical-align: inherit;">Der Kunde überprüfte die Arbeitsergebnisse in CrystalDiskMark, also weiter im Artikel alle Grafiken daraus.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10 LTSC</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hyper-V </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2-CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/h_/-8/n1/h_-8n1bwsgaovljitrm1wztowbi.png"></td>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der erste Schritt bestand darin, die Leistung zufälliger E / A zu verbessern. </font><font style="vertical-align: inherit;">Diese Art der Auslastung ist typisch für virtuelle Maschinen, insbesondere für solche, die verschiedene Datenbanken verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu (16.04 LTS und 18.04) verwendet weiterhin qemu Version 2.11. </font><font style="vertical-align: inherit;">Daher werden einige der neuesten Qemu-Brötchen in diesem Artikel nicht berücksichtigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben beschlossen, das Binden von Eisen an eine virtuelle Maschine zu vermeiden, da dies die Portabilität virtueller Maschinen erschwert. Daher wurden Optionen zum Werfen von SSD / physischen Festplatten / Partitionen in virtuelle Maschinen als unerwünscht angesehen.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informationen zur Größe der Testdatei für CrystalDiskMark</font></font></b><div class="spoiler_text">   ,          100  4.   ,         :   ,    .<br>
<br>
,        ,  Windows       .    100  4    ,     40  .<br>
<br>
       ,      ,         100-1.         4.<br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Wir verwenden LVM-Volumes, keine Dateien zum Speichern von Festplatten virtueller Maschinen.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Logik ist dies. Die Datei mit der virtuellen Festplatte wird im Linux-Dateisystem gespeichert, NTFS befindet sich in der Datei selbst. Jedes Dateisystem verbraucht während des Festplattenbetriebs Ressourcen. Je kleiner die Tiefe der Puppe ist, desto schneller ist die Eingabe / Ausgabe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir über qcow2-Dateien sprechen, steht ihr Name für „Qemu Copy-On-Write“ und sie haben tatsächlich eine eigene Übersetzungstabelle, die dafür verantwortlich ist, welche Blöcke belegt sind, welche nicht und wo sich was befindet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die LVM-Schicht verbraucht erheblich weniger Prozessorressourcen als das Dateisystem. Einer der Gründe dafür ist, dass die darin enthaltenen Blöcke viel größer sind als ein typischer Dateisystemblock (4 KB). Je größer der Block (die Ausdehnung) auf dem physischen LVM-Gerät ist, desto schneller tritt E / A auf und desto weniger Fragmentierung.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber auch für SSDs ist zufällige E / A viel langsamer als serielle. Daher geben wir beim Erstellen der Volume-Gruppe einen sehr großen Umfang an: 256 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Vorauslesen eines logischen Volumes sollte deaktiviert sein, da es E / A ohne Gewinn ausgibt, da jetzt niemand mehr Festplatten in Windows auf SSDs defragmentiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LVM ist sehr praktisch für das Hosting virtueller Maschinen. LVM-Volumes können problemlos zwischen physischen Festplatten portiert werden. Es gibt Snapshots und Größenänderungen online. Darüber hinaus kann virt-manager (libvirt) sofort logische Volumes für Festplatten virtueller Maschinen aus der Volume-Gruppe erstellen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Möglichkeit, dünne Volumes zu erstellen, sieht ebenfalls attraktiv aus. Da ein dünnes Volume jedoch eine zusätzliche Abstraktionsebene darstellt, ist es offensichtlich, dass es die E / A-Leistung beeinträchtigt. </font><font style="vertical-align: inherit;">Darüber hinaus bietet libvirt keine elegante Möglichkeit, Festplatten für virtuelle Maschinen in einem Thin Pool automatisch zu erstellen.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#    SSD    (volume group)</span><font></font>
pvcreate /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    win    (extent) 256.</span><font></font>
vgcreate -s 256M win_pool /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    vm1.    C</span><font></font>
lvcreate -n vm1 -L 100G win_pool<font></font>
<font></font>
<span class="hljs-comment">#      (read ahead)</span><font></font>
lvchange -r none /dev/win_pool/vm1<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Thin Volume als Festplatte und / oder logische Volume-Einstellungen für Snapshots</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie einen Thin Pool verwenden möchten, in dem Sie Thin Volumes erstellen, ist es sinnvoll, die Blockgröße des Pools auf 4 MB festzulegen, was viel größer als die Standardgröße von 64 KB ist. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies erfordert eine schnellere Arbeit dieser Abstraktionsebene. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Snapshot-Mechanismus in LVM funktioniert fast mit demselben Code wie Thin Volumes, sodass die Einstellungen zur Erhöhung der Snapshot-Geschwindigkeit identisch sind.</font></font><br>
<br>
<pre><code class="bash hljs">lvcreate -c 4m -L 300G -T -Zn win_pool/thin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Option </font></font><code>-Zn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deaktiviert das Überschreiben des Blocks mit Nullen beim Hervorheben, wodurch die Arbeitsgeschwindigkeit erhöht wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einstellungen für lvm.conf oder eine ähnliche Datei (z. B. lvmlocal.conf):</font></font><br>
<br>
<pre><code class="bash hljs">thin_pool_chunk_size = 4096<font></font>
thin_pool_zero = n</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können die optimale Größe des Blocks bestimmen, indem Sie den Test mit dem folgenden Befehl abschließen und den Wert auswählen </font></font><code>--blocksize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">fio --name=randwrite --filename=/dev/nvme0n1p9 --size=10G --ioengine=libaio --iodepth=1 --buffered=0 --direct=1 --rw=randwrite --blocksize=4m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können die aktuelle Größe des Blocks mit dem folgenden Befehl anzeigen:</font></font><br>
<br>
<pre><code class="bash hljs">lvs -ao name,chunksize</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Durch Erhöhen der Anzahl der logischen Prozessoren, die jeder virtuellen KVM-Maschine zugewiesen sind, wird die Festplattenleistung verbessert</font></font></h4><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/rk/d5/pp/rkd5pphdlwmwx0ykk_mszbtcxjc.png"></td>
<td><img src="https://habrastorage.org/webt/o6/0s/u-/o60su-evqzflfsjh4v0wl7ih8sa.png"></td>
<td><img src="https://habrastorage.org/webt/gv/0x/jf/gv0xjf7ky6xkidam9duclsztowo.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist klar, dass kaum jemand der virtuellen Maschine 10 Prozessoren zuweisen wird, aber es war interessant, den Extremfall zu betrachten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies hängt bereits von der Anzahl der freien Prozessoren ab. </font><font style="vertical-align: inherit;">Meiner Meinung nach ist es nicht zweckmäßig, mehr als 4 zuzuweisen. </font><font style="vertical-align: inherit;">Mit einer Anzahl von 8 Threads haben wir die maximale zufällige Lese- und Schreibleistung. </font><font style="vertical-align: inherit;">Dies ist eine Besonderheit von CrystalDiskMark 6.0.2, in der der zweite Test 8 Threads durchführt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daraus können wir schließen, dass es gut ist, einen logischen Prozessor für jede Aufgabe zu haben, die aktiv E / A verwendet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Wir verwenden große Seiten mit Direktzugriffsspeicher (riesige Seiten), um Leistungseinbußen aufgrund der Fragmentierung des Arbeitsspeichers zu vermeiden</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Paket kann nützlich sein, wenn wir während des Betriebs verschiedene Informationen über große Seiten benötigen.</font></font><br>
<br>
<pre><code class="bash hljs">apt install hugepages</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten </font></font><code>/etc/default/grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string">"default_hugepagesz=1GB hugepagesz=1G hugepages=64"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall wurden 64 GB Speicher für alle virtuellen Maschinen als riesige Seiten zugewiesen. </font><font style="vertical-align: inherit;">In Ihrem Fall kann es weniger / mehr geben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wenden diese Einstellungen auf GRUB an, damit sie beim nächsten Systemstart aktiv werden:</font></font><br>
<br>
<pre><code class="bash hljs">grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bearbeiten der Konfiguration der virtuellen Maschine:</font></font><br>
<br>
<pre><code class="bash hljs">virsh edit vm_name</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hinzufügen:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">memoryBacking</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">hugepages</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">memoryBacking</span>&gt;</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Fügen Sie jeder virtuellen Maschine einen dedizierten Stream hinzu, um E / A zu bedienen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen hinzufügen, was fett hervorgehoben ist. </font><font style="vertical-align: inherit;">Wir verwenden </font></font><code>virsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wie im vorherigen Absatz.</font></font><br>
<br>
<blockquote><b>&lt;iothreads&gt;1&lt;/iothreads&gt;</b><br>
<br>
&lt;disk type='block' device='disk'&gt;<br>
&lt;driver name='qemu' type='raw' cache='none' io='threads' <b>iothread='1'</b>/&gt;<br>
&lt;source dev='/dev/win/terminal'/&gt;<br>
&lt;target dev='vda' bus='virtio'/&gt;<br>
&lt;boot order='2'/&gt;<br>
&lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;<br>
&lt;/disk&gt;</blockquote><br>
<br>
<h4>4.1.       writeback</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das versehentliche Schreiben auf die Festplatte zu beschleunigen, aber das Risiko eines Datenverlusts zu erhöhen, können Sie </font></font><code>cache=writeback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den vorherigen Absatz verwenden. </font><font style="vertical-align: inherit;">Es kann nur verwendet werden, wenn großes Vertrauen in die Qualität und Sicherung der Stromversorgung sowie in das Vorhandensein von Sicherungen besteht.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Einstellungen des Festplattensubsystems in Virt Manager</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Festplattenbus: VirtIO </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speicherformat: Raw </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cache-Modus: Writeback </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IO-Modus: Threads</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1. </font><font style="vertical-align: inherit;">Konfigurieren eines Festplattensubsystems über eine Konfigurationsdatei</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qemu 2.11 (das derzeit von Ubuntu verwendet wird) unterstützt zwei Arten von virtuellen Festplattengeräten: virtio-blk und virtio-scsi. </font><font style="vertical-align: inherit;">Wenn in Virt Manager angegeben </font></font><code>Disk bus: VirtIO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bedeutet dies, dass das virtio-blk-Gerät verwendet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In allen Fällen ist virtio-blk schneller, obwohl es in der getesteten qemu-Version TRIM im Gegensatz zu virtio-scsi (es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterstützt es bereits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seit Version 5.x </font><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">immer noch nicht unterstützt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter dem Gesichtspunkt der Festplatten-E / A-Geschwindigkeit ist virtio-scsi nur in exotischen Fällen sinnvoll, beispielsweise wenn Sie Hunderte von Festplatten an eine virtuelle Maschine anschließen müssen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Installieren Sie während der Installation von Windows den VirtIO-Treiber</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andernfalls ist die Festplatte für das Betriebssystem nicht verfügbar. </font><font style="vertical-align: inherit;">Verwenden Sie dazu das Treiber-Image, das wir vorab mit der virtuellen Maschine verbinden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Ergebnisse nach Anwendung aller Optimierungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich wurde der Tweak 4.1 nicht verwendet, da ich mir der Zuverlässigkeit der Stromversorgung durch den Client nicht sicher war.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hyper-V </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2-CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen verstehen, dass diese Ergebnisse eine bestimmte Konvention haben, da die Werte bei jedem Start von CrystalDiskMark geringfügig abweichen.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM aus der Box </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM nach Tweaks </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen, dass es möglich war, die Arbeit des Festplattensubsystems in qemu (kvm) mit der gleichen Anzahl von Kernen signifikant zu beschleunigen. </font><font style="vertical-align: inherit;">Das Schreiben wurde um durchschnittlich 58% und das Lesen um 25% beschleunigt. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wichtige Erfolgselemente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Verwendung von LVM-Volumes anstelle von qcow2-Dateien, separate E / A und große Seiten. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Richten Sie die festgestellten Fehler an die PM. </font><font style="vertical-align: inherit;">Ich erhöhe das Karma dafür.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS vhost-user-blk und vhost-user-nvme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während der Experimente wurden auch Qemu 2.12 und Version 3 kompiliert. </font><font style="vertical-align: inherit;">Die Option vhost-user-blk für eine Festplatte wurde getestet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende funktionierte es schlimmer als virtio-blk.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vhost-user-blk </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">virtio-blk </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/x_/zw/04/x_zw04o-k8gq4so3yvyp66ddyga.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um vhost-user-nvme verwenden zu können, musste qemu gepatcht werden. Diese Option erschwerte die automatische Aktualisierung von Servern in der Produktion und wurde daher nicht getestet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS SPDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intel hat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieses Framework entwickelt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um herausragende Leistungsindikatoren für Festplattensysteme in virtuellen Maschinen zu erzielen, die auf seinen Prozessoren ausgeführt werden sollten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit spdk gut funktioniert, gehen sie vielen Tricks nach - sie weisen ihm separate Kernel zu, platzieren den Kernel spdk und die virtuelle Maschine in einem Socket. Laden Sie die virtuelle Maschine in einen zusammenhängenden Speicherblock. Wenn Sie solche Maßnahmen auf reguläres virtio-blk anwenden, funktioniert es auch schneller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPDK kann in drei Modi arbeiten: vhost-user-scsi, vhost-user-blk und vhost-user-nvme. Der zweite Modus ist nur in qemu ab 2.12 verfügbar, was in ubuntu noch nicht verfügbar ist. Der vhost-user-nvme-Modus ist im Allgemeinen mega-experimentell - Sie müssen qemu dafür patchen. Derzeit funktioniert nur die SCSI-Emulation und ist langsam.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt noch eine weitere schwerwiegende Einschränkung für den vhost-user-scsi-Modus: spdk kann nicht bootfähig sein.</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie sicher, dass dem Gerät vhost-user-scsi-pci die Option bootindex = 2 Qemu zugewiesen ist.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datensätze werden festgelegt, wenn sie ihren Treiber verwenden, um SSDs auf mehreren Geräten freizugeben und sie als vhost-user-nvme weiterzuleiten. </font><font style="vertical-align: inherit;">Der Ansatz des Eisenpiercings passte nicht zu uns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Eindruck war, dass es normal war, SPDK nur mit der Implementierung von logischen Datenträgern zu verwenden (was sich völlig von Standard-lvm unterscheidet). </font><font style="vertical-align: inherit;">Dies ist so ein selbstgemachtes Fahrrad mit seinen Bildern und Klonen. </font><font style="vertical-align: inherit;">Die Teams unterscheiden sich alle von LVM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Schwierigkeit bei der Konfiguration von SPDK, die Unterstützung und Portabilität virtueller Maschinen sowie die Anbindung an Intel-Prozessoren haben sich von seiner Verwendung abgewandt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Danksagung</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Danke für das Bild </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TripletConcept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es ist besser, es in voller Größe in einem separaten Fenster anzusehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Erlaubnis zum Teilen von Arbeitsmaterialien -</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">st_neon</font></font></a></i><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können eine virtuelle Maschine mit SSD bei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUVDS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für den unten stehenden Gutschein </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">bestellen</font></a><font style="vertical-align: inherit;"> . </font><b><i><font style="vertical-align: inherit;">Richten Sie die festgestellten Fehler an die PM. </font></i></b><b><i><font style="vertical-align: inherit;">Ich erhöhe das Karma dafür.</font></i></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a><br>
<br>
<b><i><font style="vertical-align: inherit;"></font></i></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493680/index.html">10 Tricks, wie man Online-Konfu nicht zusammenführt</a></li>
<li><a href="../de493686/index.html">Der mysteriöse Ursprung des Brettspiels über das Hacken von Codes Mastermind</a></li>
<li><a href="../de493688/index.html">Wir machen Microsoft Teams kostenlos - bleiben Sie in dieser schwierigen Zeit mit Kollegen in Kontakt</a></li>
<li><a href="../de493690/index.html">20 Tipps für den Piloten DJI Mavic Mini zum Schutz Ihrer Drohne vor Absturz und Verlust</a></li>
<li><a href="../de493692/index.html">Theoretische Datenstrukturen und ihre Anwendung in JavaScript. P1. Paare</a></li>
<li><a href="../de493700/index.html">Verwenden von Malware in Azure, um Zugriff auf Microsoft 365-Mandanten zu erhalten</a></li>
<li><a href="../de493702/index.html">Massiver Übergang zur Fernarbeit: technische Probleme und Sicherheitsbedrohungen</a></li>
<li><a href="../de493704/index.html">Verwenden von TypeScript in JavaScript ohne Schreiben von TypeScript</a></li>
<li><a href="../de493706/index.html">Kennen Sie Ihren Feind: Erstellen Sie eine Node.js-Hintertür</a></li>
<li><a href="../de493708/index.html">Anatomie meines Heimat-Kubernetes-Clusters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>