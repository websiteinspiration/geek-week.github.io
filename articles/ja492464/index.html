<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏻 👨🏿‍✈️ 👨🏿‍🔬 DBA：同期とインポートを適切に整理する 💆🏾 📋 📯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大きなデータセットの複雑な処理（さまざまなETLプロセス：インポート、変換、外部ソースとの同期）では、一時的に「記憶」し、大量のデータをすぐに処理する必要があることがよくあります。
 
 この種の典型的なタスクは通常、次のように聞こえます。「ここで、経理部門はクライアント銀行から最後に受け取った支払...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA：同期とインポートを適切に整理する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなデータセットの複雑な処理（さまざまな</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETLプロセス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：インポート、変換、外部ソースとの同期）では、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一時的に「記憶」し、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大量のデータ</font><b><font style="vertical-align: inherit;">をすぐに処理</font></b><font style="vertical-align: inherit;">する</font><font style="vertical-align: inherit;">必要があることがよくあり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この種の典型的なタスクは通常、次のように聞こえます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ここで、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">経理部門はクライアント銀行から</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に受け取った支払い</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">アップロードしました。それをすばやくWebサイトにアップロードし、アカウントにリンクする必要があります」</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
しかし、この「何か」の量が数百メガバイト単位で測定され始めると、サービスこれは24時間年中無休モードのベースで引き続き動作するはずです。あなたの人生を台無しにする多くの副作用があります。</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLで（それだけでなく）それらに対処するには、いくつかの最適化オプションを使用して、より速く、より少ないリソースで処理できるようにすることができます。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.どこに発送しますか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、「処理」したいデータをどこにアップロードできるかを決めましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1。</font><font style="vertical-align: inherit;">一時テーブル（TEMPORARY TABLE）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、PostgreSQLの場合、一時テーブルは他のテーブルと同じです。</font><font style="vertical-align: inherit;">したがって、</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「すべてはメモリにのみ保存されますが、終了する可能性がある」</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの迷信は正しくありません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、いくつかの大きな違いがあります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースへの接続ごとに独自の名前空間</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの接続が同時に作成しようとすると、</font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰かが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一意でない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBオブジェクトの</font><b><font style="vertical-align: inherit;">エラーを</font></b><font style="vertical-align: inherit;">確実に取得し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、両方が実行しようとすると</font><font style="vertical-align: inherit;">、通常は両方が</font><font style="vertical-align: inherit;">実行し</font><font style="vertical-align: inherit;">、それぞれが</font><b><font style="vertical-align: inherit;">独自の</font></b><font style="vertical-align: inherit;">テーブルの</font><b><font style="vertical-align: inherit;">コピーを</font></b><font style="vertical-align: inherit;">受け取り</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">そして、それらの間には共通点は何もありません。</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">切断を伴う「自己破壊」</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続を閉じると、すべての一時テーブルが自動的に削除されるため</font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、...を除いて</font><font style="vertical-align: inherit;">「手動」で実行</font><font style="vertical-align: inherit;">しても意味がありません。</font><b><font style="vertical-align: inherit;">トランザクションモード</font></b><font style="vertical-align: inherit;">で</font><b><font style="vertical-align: inherit;">pgbouncer</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">、データベースはこの接続がまだアクティブであると想定し続け、この一時テーブルはまだ存在しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、別の接続からpgbouncerへの再作成を試みると、エラーが発生します。</font><font style="vertical-align: inherit;">しかし、これは利用することで回避できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
確かに、同じことを行わない方がよいでしょう。そうすると、「前の所有者」から残されたデータを「突然」見つけることができるからです。</font><font style="vertical-align: inherit;">代わりに、マニュアルを読んで、テーブルを作成するときに、追加する機会があることを確認することをお勧めします</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -つまり、トランザクションが完了すると、テーブルは自動的に削除されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非複製</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の結合のみが属しているため、一時テーブルは複製されません。</font><font style="vertical-align: inherit;">しかし、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これにより、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒープ+ WALで</font><b><font style="vertical-align: inherit;">データを二重に書き込む必要がなくなるため、</font></b><font style="vertical-align: inherit;"> INSERT / UPDATE / DELETEの方がはるかに高速です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、一時テーブルは依然として「ほぼ通常の」テーブルであるため、レプリカ上にも作成できません。</font><font style="vertical-align: inherit;">少なくとも今のところ、対応するパッチは長い間存在していますが。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2。</font><font style="vertical-align: inherit;">ロギングされていないテーブル（UNLOGGED TABLE）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、たとえば、単一のトランザクション内に実装できないある種の厄介なETLプロセスが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり、トランザクションモードのpgbouncer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がまだある場合はどうすればよいです</font><font style="vertical-align: inherit;">か？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、データストリームが大きすぎて</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続ごとに十分な帯域幅</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><b><font style="vertical-align: inherit;">ない場合</font></b><font style="vertical-align: inherit;">データベースから（読み取り、CPU上の1つのプロセス）？.. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、いくつかの操作</font><font style="vertical-align: inherit;">は異なる接続で</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期に実行さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れますか？.. </font><b><font style="vertical-align: inherit;">一時的でないテーブル</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一時的に作成する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションは1つだけ</font><font style="vertical-align: inherit;">です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">うん、うん。</font><font style="vertical-align: inherit;">つまり：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰とも交わらないように、ランダムな名前で「彼の」テーブルを作成した</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抽出</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：外部ソースからそれらにデータを注ぎ込みます</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変換</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：変換され、キーバインディングフィールドに入力されます</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロード</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：完成したデータをターゲットテーブルに注ぎ込みます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「マイ」テーブルを削除</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今-軟膏のハエ。</font><font style="vertical-align: inherit;">実際には、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのすべての書き込みは二回起こる</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALの最初の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そしてテーブル/インデックスの身体インチ </font><font style="vertical-align: inherit;">これはすべて、ACIDと、</font><font style="vertical-align: inherit;">ネストされたトランザクション</font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネストされたトランザクション</font><font style="vertical-align: inherit;">間のデータの正しい可視性をサポートするために行われ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは必要ありません！</font><font style="vertical-align: inherit;">プロセス全体が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功したか、成功したか、失敗したか</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">中間トランザクションがいくつあっても、特にプロセスがどこからであるかが明確でない場合は、「途中からプロセスを続行する」ことに関心はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このために、PostgreSQL開発者は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非ジャーナル（UNLOGGED）テーブル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などのバージョン9.1を導入しました</font><font style="vertical-align: inherit;">。</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要するに、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はるかに高速</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">になりますが、データベースサーバーが「クラッシュ」した場合、不快になります。</font><font style="vertical-align: inherit;">しかし、これはどのくらいの頻度で発生し、ETLプロセスはデータベースを「活性化」した後、「途中から」正しく修正する方法を知っていますか？.. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうでない場合、上記のケースはあなたのケースに似ています-使用し</font><b><font style="vertical-align: inherit;">ますが、実際のテーブルにはこの属性を含め</font></b></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ないでください。</font><font style="vertical-align: inherit;">大切なデータ。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3。</font><font style="vertical-align: inherit;">コミット時{行を削除| </font><font style="vertical-align: inherit;">落とす}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この設計により、トランザクションの終了時にテーブルを作成して自動動作を設定できます。</font><font style="vertical-align: inherit;">私はすでに上で書いた、それが生成する</font><font style="vertical-align: inherit;">が、</font><font style="vertical-align: inherit;">状況はより興味深いものです-ここではそれが生成されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
一時テーブルのメタ記述を保存するためのインフラストラクチャ全体は通常のものとまったく同じであるため、一時テーブルを</font><b><font style="vertical-align: inherit;">絶えず作成および削除すると、システムテーブル</font></b><font style="vertical-align: inherit;"> pg_class、pg_attribute、pg_attrdef、pg_dependなどの</font><b><font style="vertical-align: inherit;">強力な「</font></b><font style="vertical-align: inherit;">スウェル」が発生します</font><font style="vertical-align: inherit;">
。データベースに接続すると、毎秒新しいトランザクションが開かれ、一時テーブルが作成、入力、処理、削除されます。システムテーブル内のガベージは過剰に蓄積され、これは各操作中の余分なブレーキです。</font></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的には、しないでください。</font><font style="vertical-align: inherit;">この場合、それははるかに効率的だ</font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、各新しいトランザクションの開始によってテーブルが-トランザクション・サイクルのそれを取ること</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でしょう</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに</font><b><font style="vertical-align: inherit;">存在して</font></b><font style="vertical-align: inherit;">（コール・セーブ</font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、それが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空になり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、おかげで</font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前のトランザクションが完了したとき、（我々はまた、コールを保存しました）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4。</font><font style="vertical-align: inherit;">LIKE ...含む...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一時テーブルの典型的な使用例の1つはさまざまな種類のインポートであると冒頭で述べました。開発者はターゲットテーブルのフィールドのリストを一時的に宣言にコピーアンドペーストします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし</font><font style="vertical-align: inherit;">、遅延</font><font style="vertical-align: inherit;">は進行のエンジンです！</font><font style="vertical-align: inherit;">したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「モデル上に」新しいテーブルを作成する方</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がはるかに簡単です。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、このテーブルに大量のデータを追加できるため、テーブルの検索が速くなることはありません。しかし、これに対する伝統的な解決策があります-インデックス！そして、はい、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一時テーブルにもインデックスを含めることができます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、目的のインデックスはターゲットテーブルのインデックスと一致するため、単純にと書くことができます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">-values（たとえば、主キーの値を入力するため）</font><font style="vertical-align: inherit;">
も必要な場合は</font><font style="vertical-align: inherit;">、を使用できます</font><font style="vertical-align: inherit;">。まあ、または単に-- </font><font style="vertical-align: inherit;">デフォルト、インデックス、制約をコピーします... </font><font style="vertical-align: inherit;">
しかし、ここで</font><font style="vertical-align: inherit;">、インデックス</font><font style="vertical-align: inherit;">を使用して</font><b><font style="vertical-align: inherit;">インポートテーブルをすぐに</font></b><font style="vertical-align: inherit;">作成した場合</font><b><font style="vertical-align: inherit;">、データがより長く入力されること</font></b><font style="vertical-align: inherit;">を理解する必要があり</font><b><font style="vertical-align: inherit;">ます</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてを最初に入力してからインデックスをロールする場合よりも、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がどのように実行するかの例として見てください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局のところ、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.書き方は？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は単純に言うだろう-使用は</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「パック」の代わりに-stream </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時には加速</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">事前に生成されたファイルから直接行うこともできます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.取り扱い方法は？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、私たちの紹介は次のようになります：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">1Mレコードの</font></b><font style="vertical-align: inherit;">クライアントデータを含むプレートがデータベースにあります</font></font><b><font style="vertical-align: inherit;"></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントが毎日新しい</font><b><font style="vertical-align: inherit;">完全な「イメージ」を</font></b><font style="vertical-align: inherit;">送信する</font></font><b><font style="vertical-align: inherit;"></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">経験から、時々</font><b><font style="vertical-align: inherit;">変化</font></b><font style="vertical-align: inherit;">する</font><b><font style="vertical-align: inherit;">レコードは10K以下である</font></b><font style="vertical-align: inherit;">ことを知って</font><b><font style="vertical-align: inherit;">い</font></b><font style="vertical-align: inherit;">ます。</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような状況の典型的な例は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、KLADRデータベース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。住所はたくさんありますが、毎週の変更（集落の名前の変更、街路協会、新しい家の出現）のアップロードでは、全国的にもごくわずかです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1。</font><font style="vertical-align: inherit;">完全同期アルゴリズム</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単にするために、データを再構築する必要さえないとしましょう。テーブルを正しい形式にしてください：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不要になったものをすべて</font><b><font style="vertical-align: inherit;">削除し</font></b><font style="vertical-align: inherit;">ます</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでにあったすべてを</font><b><font style="vertical-align: inherit;">更新し</font></b><font style="vertical-align: inherit;">、あなたは更新する必要があります</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れていないすべてを</font><b><font style="vertical-align: inherit;">挿入</font></b></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜこの順序で操作を行う価値があるのですか？</font><font style="vertical-align: inherit;">これは、テーブルのサイズが最小限に大きくなる方法</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">MVCCについて覚えておいてください！</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dstから削除</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいえ、もちろん、2つの操作しか実行できません。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全に</font><b><font style="vertical-align: inherit;">削除</font></b><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">）</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい画像からすべてを</font><b><font style="vertical-align: inherit;">貼り付ける</font></b></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし同時に、MVCCのおかげ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、テーブル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">サイズは正確に2倍になり</font></b><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">10Kの更新により、テーブル内の+ 1Mの画像レコードを取得-冗長性...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">切り捨てdst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より経験豊富な開発者は、プレート全体を非常に安価にクリーニングできることを知っています。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル全体を</font><b><font style="vertical-align: inherit;">クリア</font></b><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">）</font></font></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい画像からすべてを</font><b><font style="vertical-align: inherit;">貼り付ける</font></b></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法は効果的ですが、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適切な</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合もありますが、問題があります。100万件のレコードを入力するため、この間は常にテーブルを空のままにしておくことはできません（単一のトランザクションでラップしない場合も同様です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは</font><b><font style="vertical-align: inherit;">長いトランザクション</font></b><font style="vertical-align: inherit;">を開始します</font></font><b><font style="vertical-align: inherit;"></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock </font><font style="vertical-align: inherit;">を課し</font><font style="vertical-align: inherit;">ます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは長い間挿入を行っていますが、現時点では誰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もが</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何かが悪い...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENAME ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オプションとして、すべてを別の新しいテーブルに入力してから、単にそれを古いテーブルに名前変更します。</font><font style="vertical-align: inherit;">いくつかの厄介な小さなこと：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も</font><font style="vertical-align: inherit;">、時間は大幅に短縮されますが</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このテーブルのすべてのクエリプラン/統計はリセットされます。ANALYZEを実行する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要があります</font></font></a></li>
<li><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルの</font><b><font style="vertical-align: inherit;">すべての外部キー</font></b><font style="vertical-align: inherit;">（FK）が</font><b><font style="vertical-align: inherit;">壊れ</font></b><font style="vertical-align: inherit;">ている</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simon RiggsからのWIPパッチがあり</font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、統計とFKを変更せずにファイルレベルでテーブル本体を置き換える操作を</font><font style="vertical-align: inherit;">実行するよう提案さ</font><font style="vertical-align: inherit;">れましたが、クォーラムは収集されませんでした。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">削除、更新、挿入</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、3つの操作の非ブロッキングバージョンで停止します。</font><font style="vertical-align: inherit;">ほぼ3つ...これを最も効果的に行う方法</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2。</font><font style="vertical-align: inherit;">インポート後処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じKLADERで、変更されたすべてのレコードを追加で後処理で実行する必要があります。つまり、正規化し、キーワードを強調表示して、必要な構造にします。</font><font style="vertical-align: inherit;">しかし</font><font style="vertical-align: inherit;">、同期コードを複雑にすることなく、理想的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にはまったく変更</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">せずに、</font><b><font style="vertical-align: inherit;">何が変更されたかを正確に</font></b><font style="vertical-align: inherit;">知る</font><b><font style="vertical-align: inherit;">には</font></b><font style="vertical-align: inherit;">どうすればよい</font><font style="vertical-align: inherit;">でしょうか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期時にプロセスのみに書き込みアクセスがある場合は、すべての変更を収集するトリガーを使用できます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、同期を開始する前にトリガーを強制する（またはを介して有効にする</font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">ことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ログテーブルから静かに、必要なすべての変更を抽出し、追加のハンドラーを介して実行します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3。</font><font style="vertical-align: inherit;">関連セットをインポートする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では、ソースとレシーバーのデータ構造が一致する場合を検討しました。</font><font style="vertical-align: inherit;">しかし、外部システムからのアンロードのフォーマットがデータベースのストレージ構造と異なる場合はどうなりますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例として、顧客とそのアカウントのストレージを取り上げます。これは、従来の多対1オプションです。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、外部ソースからのアンロードは、「オールインワン」の形で行われます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、顧客データはこの方法で複製でき、メインレコードは「アカウント」です。</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデルについては、テストデータを挿入するだけですが、覚えておいてください- </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より効率的です！</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、「事実」が参照する「カット」を選択します。</font><font style="vertical-align: inherit;">私たちの場合、アカウントとは顧客を指します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アカウントをお客様IDに正しく関連付けるには、まずこれらの識別子を検出または生成する必要があります。</font><font style="vertical-align: inherit;">それらのフィールドを追加します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のテーブルをわずかに修正して同期する方法を使用します。クライアントのインポートは「追加のみ」であるため、ターゲットテーブルの何も更新または削除しません。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、すべて- </font><font style="vertical-align: inherit;">これで、アカウントを挿入する</font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通信フィールド</font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に入力しました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492454/index.html">アーキテクチャリファクタリングをクライアントに販売するか、開発者の問題は何か</a></li>
<li><a href="../ja492456/index.html">（地球物理学）モデルを視覚化してアニメーション化する方法。生データを表示</a></li>
<li><a href="../ja492458/index.html">M5Stack（Arduino）のシンプルなGUI</a></li>
<li><a href="../ja492460/index.html">関数型プログラミングは、（おそらく）言われたことです。聞いたら</a></li>
<li><a href="../ja492462/index.html">真実の情報源：アナリストがマネージャーと開発者に協力する方法を教える方法</a></li>
<li><a href="../ja492466/index.html">わずか5つのステップで、cPanelを使用するホストプロバイダーからRusonixのPleskに移行する方法</a></li>
<li><a href="../ja492468/index.html">レノボThinkserver SE350：周辺からのヒーロー</a></li>
<li><a href="../ja492474/index.html">Androidボックスの情報を構造化し、通常の接頭辞で何ができるかを分析します。</a></li>
<li><a href="../ja492478/index.html">ナレッジマネジメントがなければ、それは傷つきます：システムの欠如による5つの主な結果</a></li>
<li><a href="../ja492480/index.html">以前に流行に苦しんだ方法とコロナウイルスに対して私たちが何をすべきか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>