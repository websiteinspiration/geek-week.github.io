<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÉ üë®üèæ‚Äçüé§ üéì Managing smart home sensors with the Google Assistant üëéüèΩ üñ§ üê≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, colleagues in this guide will tell you how to control smart home sensors using the Google Assistant and the mqtt protocol, using the ESP8266 bo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Managing smart home sensors with the Google Assistant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, colleagues in this guide will tell you how to control smart home sensors using the Google Assistant and the mqtt protocol, using the ESP8266 board and LED as an example. </font><font style="vertical-align: inherit;">We will also create our own Assistant app with blackjack and php scripts. </font><font style="vertical-align: inherit;">I ask everyone for cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we need the ESP8266 controller, or other controllers with an Internet connection, as well as a server with a valid ssl certificate (instead of a valid ssl, you can use a reverse proxy which already has one) and an MQTT server (broker). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For integration with google assistant we will use the Google Actions service and Dialogflow. </font><font style="vertical-align: inherit;">So, let's begin.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/n4/so/7nn4sojacyuqznn0ngm2_az_tek.jpeg" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating and setting up a project</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google action console</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to log in to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and create a project, select a language and region. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/8d/8p/3c8d8pr_uuzir7e6jizg3cx-xf4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you need to choose the scope. </font><font style="vertical-align: inherit;">I chose Kids &amp; Family. </font><font style="vertical-align: inherit;">From someone else‚Äôs experience I‚Äôll say that the logically asking category Smart Home only works correctly with devices from Google, for projects with its own sensors it‚Äôs better to choose a different category for correct operation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/jk/-x/qrjk-xl3cvbhcrpdocrfhyfiecm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We read and accept the agreement. </font><font style="vertical-align: inherit;">In the Quick setup category, go to Decide how your Action is invoked. </font><font style="vertical-align: inherit;">We come up with what our bot will be called and select a voice from the available ones, save it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w1/oz/ue/w1ozueqhhrzh0y42i1xwfwk8330.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the Actions tab, add a Custom Intent action</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/sg/n4/ntsgn4ps4curjg5c0ociivilfma.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dialogflow</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After clicking the Build button, we are redirected to the Dialogflow resource, we also log in and proceed to the creation of the project:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choose the default language and time zone.</font></font></li>
<li>   Fulfillment   <abbr title="interface between two programs">Webhook</abbr>.       (     ,  )   Dialogflow   POST .<br>
<br>
<img src="https://habrastorage.org/webt/2e/tu/ij/2etuijbmkox37tup8de8t8sq694.png" alt="image"></li>
<li>3.    .<br>
<br>
 intets         .       .      +   Intents.       .</li>
</ol><br>
<img src="https://habrastorage.org/webt/ay/d4/zy/ayd4zyszkzl59pzklkt8ps34sh4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The page itself can be divided into three categories: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training phrases</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are words that the assistant responds to with the team. </font><font style="vertical-align: inherit;">They can be different for one team. </font><font style="vertical-align: inherit;">For example, shine the words, cut the light, turn on the lamp, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/v8/mm/duv8mm1gpmvibh2w6fd0u7x777w.png" alt="image"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Action</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the action itself, or the word that the sensor will understand, it is one and concrete. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the answers of the assistant after the command is executed. </font><font style="vertical-align: inherit;">Here is just a field for creativity.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/vj/hp/yxvjhpwsqueymkbo-4llo9jfvh8.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hosting setup </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a server, I purchased the cheapest ($ 5) droplet and installed Debian 10.2 on it. </font><font style="vertical-align: inherit;">Which hosting you choose does not matter.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure reverse proxy and DNS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can skip this part if you have a hosting with a valid certificate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Cloudflare service itself offers a lot of lower level names, so if you are experiencing problems with step 4, you may need to indicate your ip instead of the default one in the content column next to www ***, https // www *** (*** is your domain) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To interact with Dialogflow, you need an SSL certificate. </font><font style="vertical-align: inherit;">I did not install it on the server, instead I used the DNS proxy Cloudflare (free - basic). </font><font style="vertical-align: inherit;">To do this, when configuring Cloudflare, I added my previously purchased domain name and added the IP address of my server to it (Content column). </font><font style="vertical-align: inherit;">Also added two A records (in the picture it is Value) in the settings of the name provider. </font><font style="vertical-align: inherit;">It is worth noting that adding a record is not a matter of seconds and can take up to several business days.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yp/gz/qz/ypgzqzczh7qgdveopje4to1dtp8.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Software installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. First thing after starting the server for the first time, do not forget to update the package database</font></font><br>
<br>
<pre><code class="bash hljs">apt update</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and then update the installed packages </font></font><pre><code class="bash hljs">apt upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. After we install LAMP </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache</font></font><br>
<br>
<pre><code class="bash hljs">apt install apache2 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Php / mysql</font></font><br>
<br>
<pre><code class="bash hljs">apt-get install php libapache2-mod-php php-mcrypt php-mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the server address in apache2.conf. This can be done with the nano /etc/apache2/apache2.conf command, indicating at the end of the file ServerName *** at the end of your file, where instead of asterisks you need to substitute the server ip. Check the syntax and restart the Apach service Learn more </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After successfully completing the steps described above when entering your domain name in the browser bar, you will receive the Apache2 welcome page. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/3k/uw/wu3kuwqec_ykskpcqtqttzph6wm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If this does not happen, check whether the commands were executed correctly, and whether the page works with an unsecured http connection. If it works, the server is probably listening on port 80, not port 443. Or some service is already running on it. More details </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Installing the Mosquitto Library for PHP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IoT devices can use different protocols for interoperability. </font><font style="vertical-align: inherit;">One such </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that works on a publisher-subscriber basis. </font><font style="vertical-align: inherit;">In this case, subscribers can receive information from many publishers. </font><font style="vertical-align: inherit;">But since the protocol understands only certain types of messages, it needs a converter (broker). </font><font style="vertical-align: inherit;">Here we set it up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. If you do not have PECL installed, install it</font></font><br>
<br>
<pre><code class="bash hljs">apt install pecl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we become a broker </font></font><br>
<br>
<pre><code class="bash hljs">pecl install Mosquitto-alpha</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then add extension = mosquitto.so to your php.ini. </font><font style="vertical-align: inherit;">And don't forget the client</font></font><br>
<br>
<pre><code class="bash hljs">apt install mosquitto mosquitto-clients
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More details </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up php script, subscription to topic</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually the script itself. </font><font style="vertical-align: inherit;">Its purpose is to accept a post request from Dialogflow, isolate the action from it and send it as a message to the broker in the subject, whose name is indicated at the end of the script. </font><font style="vertical-align: inherit;">What do you call a script does not matter. </font><font style="vertical-align: inherit;">By the way, this is the script that we indicated in the Fulfillment tab. </font><font style="vertical-align: inherit;">Place the script at / var / www / html </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Topics are created by subscribers. To create a topic, use the command:</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_sub -h localhost - t /<span class="hljs-built_in">test</span>/light</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of localhost, you can specify any other address, or domain, where you want to create a publisher (pub). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of / test / light, you can specify any topic. </font><font style="vertical-align: inherit;">In our case, the main thing is that it be indicated in the script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Messages are created by publishers. </font><font style="vertical-align: inherit;">To create a message, you can use the command.</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_pub -h localhost - t /<span class="hljs-built_in">test</span>/light -m ‚Äúlight‚Äù</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we will not need it, because our publisher (pub) will be our application. </font><font style="vertical-align: inherit;">The scheme is this, when our application receives a command, it sends a request to our script. </font><font style="vertical-align: inherit;">The script is for the broker, and the broker is for the subscriber (esp8266). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will check the sending of messages through the Test Action Console tab.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/j0/ff/ljj0ffysayc5d3wfg8ui2rcc15w.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/j5/tf/xz/j5tfxzjm9gbh7toxf9wi6zah2zw.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Php script</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">//Make sure that it is a POST request.</span>
<span class="hljs-keyword">if</span>(strcasecmp($_SERVER[<span class="hljs-string">'REQUEST_METHOD'</span>], <span class="hljs-string">'POST'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Request method must be POST!'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Make sure that the content type of the POST request has been set to application/json</span>
$contentType = <span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>]) ? trim($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>])                                                                                                              : <span class="hljs-string">''</span>;
<span class="hljs-keyword">if</span>(strcasecmp($contentType, <span class="hljs-string">'application/json'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Content type must be: application/json'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Receive the RAW post data.</span>
$content = trim(file_get_contents(<span class="hljs-string">"php://input"</span>));<font></font>
<font></font>
<span class="hljs-comment">//Attempt to decode the incoming RAW post data from JSON.</span><font></font>
$decoded = json_decode($content);<font></font>
<font></font>
<span class="hljs-comment">//file_put_contents($filename, $data);</span><font></font>
var_dump($decoded);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> $decoded-&gt;queryResult-&gt;action;<font></font>
<font></font>
define(<span class="hljs-string">'BROKER'</span>, <span class="hljs-string">'localhost'</span>);<font></font>
define(<span class="hljs-string">'PORT'</span>, <span class="hljs-number">1883</span>);<font></font>
define(<span class="hljs-string">'CLIENT_ID'</span>,  getmypid());<font></font>
  <font></font>
$client = <span class="hljs-keyword">new</span> Mosquitto\Client(CLIENT_ID);<font></font>
$client-&gt;connect(BROKER, PORT, <span class="hljs-number">60</span>);<font></font>
<font></font>
        $message = $decoded-&gt;queryResult-&gt;action;<font></font>
        $client-&gt;publish(<span class="hljs-string">'/test/light'</span>, $message, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
        $client-&gt;loop();<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware ESP8266</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the firmware we will use the Arduino IDE. </font><font style="vertical-align: inherit;">If someone will install the IDE for the first time, do not forget about the ch340 driver. </font><font style="vertical-align: inherit;">By default, there is no such payment in arduino. </font><font style="vertical-align: inherit;">In File &gt;&gt; Settings you need to specify the address of the additional boards: arduino.esp8266.com/stable/package_esp8266com_index.json. </font><font style="vertical-align: inherit;">In Tools &gt;&gt; board &gt;&gt; board manager you need to install the esp8266 package. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the sketch after const char * ssid, you should indicate the name of your wi-fi network. </font><font style="vertical-align: inherit;">After const char * password, her password. </font><font style="vertical-align: inherit;">After const char * mqtt_server specify the ip address of your server.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sketch Arduino IDE</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;ESP8266WiFi.h&gt;<font></font>
#include &lt;PubSubClient.h&gt;<font></font>
<font></font>
// Update these with values suitable for your network.<font></font>
<font></font>
const char* ssid = "***";<font></font>
const char* password = "********";<font></font>
const char* mqtt_server = "**.**.*.*";<font></font>
<font></font>
WiFiClient espClient;<font></font>
PubSubClient client(espClient);<font></font>
long lastMsg = 0;<font></font>
char msg[50];<font></font>
int value = 0;<font></font>
<font></font>
int led = D5;<font></font>
<font></font>
void setup_wifi() {<font></font>
<font></font>
  delay(10);<font></font>
  // We start by connecting to a WiFi network<font></font>
  Serial.println();<font></font>
  Serial.print("Connecting to ");<font></font>
  Serial.println(ssid);<font></font>
<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  while (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(500);<font></font>
    Serial.print(".");<font></font>
  }<font></font>
<font></font>
  randomSeed(micros());<font></font>
<font></font>
  Serial.println("");<font></font>
  Serial.println("WiFi connected");<font></font>
  Serial.println("IP address: ");<font></font>
  Serial.println(WiFi.localIP());<font></font>
}<font></font>
<font></font>
void callback(char* topic, byte* payload, unsigned int length) {<font></font>
  String msg="";<font></font>
  Serial.print("Message arrived [");<font></font>
  Serial.print(topic);<font></font>
  Serial.print("] ");<font></font>
  for (int i = 0; i &lt; length; i++) {<font></font>
    Serial.print((char)payload[i]);<font></font>
    msg+=(char)payload[i];<font></font>
  }<font></font>
  Serial.println();<font></font>
<font></font>
  // Switch on the LED if an 1 was received as first character<font></font>
//  if ((char)payload[0] == '1') {<font></font>
  if (msg == "light") {<font></font>
    digitalWrite(led, HIGH);   // Turn the LED on <font></font>
  } else {<font></font>
    digitalWrite(led, LOW);  // Turn the LED off <font></font>
  }<font></font>
<font></font>
}<font></font>
<font></font>
void reconnect() {<font></font>
  // Loop until we're reconnected<font></font>
  while (!client.connected()) {<font></font>
    Serial.print("Attempting MQTT connection...");<font></font>
    // Create a random client ID<font></font>
    String clientId = "ESP8266Client-";<font></font>
    clientId += String(random(0xffff), HEX);<font></font>
    // Attempt to connect<font></font>
    if (client.connect(clientId.c_str())) {<font></font>
      Serial.println("connected");<font></font>
      // ... and resubscribe<font></font>
      client.subscribe("/test/light");<font></font>
    } else {<font></font>
      Serial.print("failed, rc=");<font></font>
      Serial.print(client.state());<font></font>
      Serial.println(" try again in 5 seconds");<font></font>
      // Wait 5 seconds before retrying<font></font>
      delay(5000);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
void setup() {<font></font>
  pinMode(led, OUTPUT);     // Initialize the led pin as an output<font></font>
  Serial.begin(115200);<font></font>
  setup_wifi();<font></font>
  client.setServer(mqtt_server, 1883);<font></font>
  client.setCallback(callback);<font></font>
}<font></font>
<font></font>
void loop() {<font></font>
<font></font>
  if (!client.connected()) {<font></font>
    reconnect();<font></font>
  }<font></font>
  client.loop();<font></font>
<font></font>
}<font></font>
</code></pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Result</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, after compiling the sketch, we get an application that is integrated into the google assistant and manages the sensors. </font><font style="vertical-align: inherit;">Instead of a smartphone, I used a web application, but tested on Android - the result is the same. </font><font style="vertical-align: inherit;">The main thing is if you are testing from a smartphone do not forget to say: ‚ÄúTalk with the application ***‚Äù.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/vh/ug/qfvhugumopat-isohcimmyujd08.jpeg" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/eh/or/mv/ehormvyz41fgzhgogas1yrszpvs.jpeg" alt="image"><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/g-S82CdMIrY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490472/index.html">As I wrote a semi-decentralized cryptocurrency in PHP. (Part 1 - Collecting Libraries)</a></li>
<li><a href="../en490474/index.html">STM32 Part 1: The Basics</a></li>
<li><a href="../en490476/index.html">Wireless sensor for opening and closing with advanced functionality</a></li>
<li><a href="../en490478/index.html">DIY DIY Soldering Station v2</a></li>
<li><a href="../en490480/index.html">O Tiling-wm in 2 words</a></li>
<li><a href="../en490490/index.html">Weekend Reading: 10 materials on the effects of sound on health - from ‚Äúnoise hygiene‚Äù to good sleep and GTD</a></li>
<li><a href="../en490492/index.html">Warehouse robot learns to sort non-standard things</a></li>
<li><a href="../en490494/index.html">Shop rats, Widiots and gamers: propaganda of the dangers of video games in the 80s</a></li>
<li><a href="../en490496/index.html">Creating an Online Store on Nuxt.js 2 Walkthrough Part 1</a></li>
<li><a href="../en490498/index.html">As I wrote a semi-decentralized cryptocurrency in PHP. (Part 2 - Development)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>