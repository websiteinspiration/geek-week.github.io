<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèº ‚ö°Ô∏è üíâ How we helped schools switch to distance learning and coped with the load üçò üà¥ ü§≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! My name is Alexey Vakhov, I‚Äôm the technical director of Uchi.ru. In mid-March, when schools began to switch to distance learning, we prov...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How we helped schools switch to distance learning and coped with the load</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/uchi_ru/blog/498906/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! My name is Alexey Vakhov, I‚Äôm the technical director of Uchi.ru. In mid-March, when schools began to switch to distance learning, we provided teachers and students with several services for online classes. According to our calculations, we had a margin of safety to withstand a maximum of 1.5-2 times the load. In mid-April, our traffic grew 8 times. I had to do a lot to stay afloat. Perhaps someone will need our experience to survive this or a future crisis.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We did not expect such surprises and were not ready for them, probably not a single company in Russia, nor in the world, was ready for this. Usually in March, the activity on Uchi.ru is lower relative to autumn due to spring and upcoming summer vacations, at which time we are already preparing for September: we are sawing features, doing refactoring, conducting large-scale architectural changes and doing another pleasant routine. However, this time it was different. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The peak number of unique users on the site at one time reached 240 thousand, we recorded the previous maximum of the current school year on 30 thousand people. At this point, the load grew every day, and we worked around the clock to stabilize the site.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When such a load falls on the site, as a rule, applications, services, balancers, bases, web, channels are formed. </font><font style="vertical-align: inherit;">All the "bottlenecks" of the infrastructure are exposed. </font><font style="vertical-align: inherit;">In such conditions, it is difficult to diagnose problems - symptomatically everything is buggy. </font><font style="vertical-align: inherit;">It's easy to repair when traffic grows smoothly and one thing breaks down. </font><font style="vertical-align: inherit;">When the load goes in a flurry, one of the big problems is to understand the causes of failures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The strategy for working in such conditions is to eliminate what hits the site the most, then find the next most painful point, at the same time look for potential problems and fix them, and so on. </font><font style="vertical-align: inherit;">Here are some of the most notable things we did to stabilize the platform.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rely on themselves</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During a crisis before the traffic, you as a team become one. It will depend on your employees whether you will find solutions, cope with the crisis, or not. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are no people in the industry who would come, look into your complex system, immediately do something and everything would be fine. Of course, in the world there are enough specialists who will cope with the task if there is time. But when a fundamental solution is needed right now, you can only rely on your team, which knows the system and its specifics. The result and responsibility to the business lies with the team. External examination is advisable to connect pointwise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Operational coordination of the anti-crisis team in a special chat in Slack helped us quickly navigate and build our work, all of which were solved here and now. </font><font style="vertical-align: inherit;">We divided the areas of responsibility between the employees so that there were no intersections and the guys did not do double work. </font><font style="vertical-align: inherit;">On the most difficult days, I had to be in touch literally around the clock.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expanded cloud</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You cannot insure against all crises, but it is important to be flexible. </font><font style="vertical-align: inherit;">The cloud stack gave us such plasticity and a chance to stay afloat even with such a dramatic increase in load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, we increased resources under the increased load, but at some point we ran into the quotas of the region of our cloud provider. </font><font style="vertical-align: inherit;">Problems arose at its level: our virtual servers were affected by neighbors, on which traffic also grew, which caused failures in the operation of our applications. </font><font style="vertical-align: inherit;">This was expected: we depend on the provider and its infrastructure, which in turn also experienced a high load. </font><font style="vertical-align: inherit;">We have released some resources from non-priority virtual machines for the main site. </font><font style="vertical-align: inherit;">With the provider, we agreed on a dedicated resource.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upgraded monitoring tools</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the crisis, alert did not actually fulfill its function. </font><font style="vertical-align: inherit;">All team members already monitored all systems around the clock, and incident management was reduced to constant work on all fronts. </font><font style="vertical-align: inherit;">To fully diagnose the problems that we encountered, we had too little data. </font><font style="vertical-align: inherit;">For example, for monitoring virtual machines, we use the standard Node Exporter for Prometheus. </font><font style="vertical-align: inherit;">He is good to see the big picture, for a closer look at a single virtual machine began to use NetData.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized cache storage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A problem also arose with key-value stores. </font><font style="vertical-align: inherit;">In one of the applications, Redis could not cope - in a single copy it can work on only one core. </font><font style="vertical-align: inherit;">Therefore, they used a Redis fork called KeyDB, which can work in multiple threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To increase the bandwidth in another application, we have raised 10 independent Redis'ov. </font><font style="vertical-align: inherit;">They are proxied by our Service Mesh, which also shards keys. </font><font style="vertical-align: inherit;">Even if one or two Redis crashes, this will not cause problems due to consistent hashing. </font><font style="vertical-align: inherit;">Plus, they practically do not need to be administered.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expanded the network</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, 640 Kb is enough for everyone. </font><font style="vertical-align: inherit;">We always used private / 24 subnets, but against the background of quarantine we had to urgently expand to / 22. </font><font style="vertical-align: inherit;">Now the network accommodates four times as many servers, we hope it will be enough for sure.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PgBouncer carried out separately</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a relational database, we use PostgreSQL everywhere, somewhere small virtual instances, and somewhere - the installation of several large dedicated servers for the master and replicas. The obvious bottleneck of this architecture is the master, which in the ideal case is used only for recording and does not scale horizontally. With the growth of traffic, we began to rest on the CPU.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, we use PgBouncer, which was installed on the wizard and on each replica, to manage the connections. </font><font style="vertical-align: inherit;">On one port, it can use no more than one processor core, so on each server we had several bouncers. </font><font style="vertical-align: inherit;">At some point, it became clear that PgBouncer itself took away the tangible part of the CPU from the base, and at maximum load we experienced a rapid increase in load average and a drop in system performance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We moved the bouncers to a separate server, which helped us save 20-25% of CPU on each database server.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faced with surprises</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one tool cannot be trusted, especially in times of crisis. On the contrary, redundancy of tools helps, because it makes it possible to see a more objective picture. Familiar tools begin to fail for a variety of reasons. For example, usually to estimate the number of people on a site, we usually use a real-time Google Analytics report, which is a sensitive and accurate metric. But sometimes it is buggy and this time we had to look at internal metrics like the number of pageview events and the number of requests per second.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For centralized logging we use ELK. </font><font style="vertical-align: inherit;">Our log delivery pipeline is based on Apache Kafka and Elastic Filebeat. </font><font style="vertical-align: inherit;">Under high load, the log delivery conveyor stopped managing, logs began to get lost or lag. </font><font style="vertical-align: inherit;">We increased the speed of log transfer and storage indexing by manipulating the Elasticsearch indexes, increasing the number of partitions in Kafka and Filebeat, and fine-tuned compression at all stages. </font><font style="vertical-align: inherit;">Due to the fact that the pipeline for collecting logs is separate from production, problems with the increased traffic of the logs did not have any effect on the functioning of the site.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accepted the rules of the game</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is impossible to prepare for each crisis in advance, but you can initially try to build a flexible system. </font><font style="vertical-align: inherit;">Startups or companies that are gradually ceasing to be startups, in a quiet time, it is not always rational to prepare for an abnormal traffic growth: the resources of the team are limited. </font><font style="vertical-align: inherit;">If we set aside their preparation for something that may never happen, there will be no strength left for the main product. </font><font style="vertical-align: inherit;">It is much more important to react correctly in the moment and not be afraid of bold decisions. </font><font style="vertical-align: inherit;">As a rule, the outcome of their crisis is an exit to a qualitatively new level. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is such a fun spring this year. </font><font style="vertical-align: inherit;">When it seems that everything possible has been done, sometimes it turns out that this is only the beginning.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498892/index.html">The Last Renga API Review</a></li>
<li><a href="../en498894/index.html">Normal flight</a></li>
<li><a href="../en498898/index.html">Neural networks for children: explain as simple as possible</a></li>
<li><a href="../en498900/index.html">Rosbank Java-school - learning outcomes</a></li>
<li><a href="../en498904/index.html">Adding Parallel Computing to Pandas</a></li>
<li><a href="../en498910/index.html">Commercial astronautics - myths and reality</a></li>
<li><a href="../en498912/index.html">Anti-crisis section of Habr</a></li>
<li><a href="../en498914/index.html">Growing AI - Genetic Algorithms: An Introduction</a></li>
<li><a href="../en498918/index.html">Your statement is 100% correct, only misses the point</a></li>
<li><a href="../en498920/index.html">Payment systems. Armor and Shell Competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>