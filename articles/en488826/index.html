<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌽 👩🏽‍🔬 🙋🏽 Recognize privilege escalation in ABBYY FineReader 🤫 🥧 🔸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The cycle of how I find privilege escalation vulnerabilities in Windows applications continues. In the previous series: Steam ( CVE-2019-14743 , CVE-2...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Recognize privilege escalation in ABBYY FineReader</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pm/blog/488826/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The cycle of how I find privilege escalation vulnerabilities in Windows applications continues. </font><font style="vertical-align: inherit;">In the previous series: Steam ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CVE-2019-14743</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CVE-2019-15316</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CVE-2019-17180</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and Origin ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CVE-2019-19247, CVE-2019-19248</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">But today we will not talk about the game launcher, but about the ABBYY FinerReader application software package. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n6/4z/ac/n64zach5hyh0x3hdcoskm6ojz7m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Summary - I will tell you how, thanks to the component that checks the license, in 10 minutes you can raise your rights from the user level to NT AUTHORITY \ SYSTEM. </font><font style="vertical-align: inherit;">The vulnerability was assigned the identifier CVE-2019-20383, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link to the ABBYY website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font color="orange"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intelligence service</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I downloaded the trial version of FineReader from the ABBYY website and quickly checked it to see if it makes any sense to pick the product to increase privileges. Yes, the product includes a service that, judging by the name "ABBYY network license server", is associated with licenses and is launched by default from the user NT AUTHORITY \ SYSTEM. I started ProcMon started to watch the behavior of the service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My attention was drawn to the file located along the path "C: \ ProgramData \ ABBYY \ FineReader \ 15 \ Licenses \ Licensing.cnt". The service reads something from it, writes something to it, in general, the file looked like an interesting candidate for experiments. Consider the folder "C: \ ProgramData \ ABBYY \ FineReader \ 15 \ Licenses". The inherited All-Full Access ACL from the parent folder (“C: \ ProgramData \ ABBYY \ FineReader \ 15”) is valid for this folder, which means that you can delete all its contents, including the file “Licensing.cnt”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The service, having discovered the absence of the file, tried to create it, and in a slightly strange way. He created a file of the form “tmpXXXX-YYYYYYYYY.tmp”, wrote some data into it, and then renamed it “Licensing.cnt”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the ProcMon log in which this operation is performed twice.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8h/hk/ro/8hhkroiszje9qtzyovchs1zldjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, it happens at 20:36, and then at 20:46. Between these timestamps, the file was deleted again to be created again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rectangle 1 indicates the situation when the service has detected the absence of a file. Rectangle 2 - create a temporary file. Rectangle 3 - rename the temporary file. Rectangle 4 - repeat operations after 10 minutes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the format of the name "tmpXXXX_YYYYYYYYY.tmp". As part of one running process, XXXX will always be constant, moreover, in fact, this is the identifier of the thread that performs this work. YYYYYYYYY does not remain constant, but if we look at two neighboring starts (values: 430210515 and 430810515), then it appears that this is just some time mark - the difference between the numbers 600000 - surprisingly coincides with 10 minutes of difference. A few more tests confirm our assumption.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To summarize this part. </font><font style="vertical-align: inherit;">Any user can delete the file "C: \ ProgramData \ ABBYY \ FineReader \ 15 \ Licenses \ Licensing.cnt", then he can very often request the contents of the folder "C: \ ProgramData \ ABBYY \ FineReader \ 15 \ Licenses" in at some point, find there a file called "tmpXXXX_YYYYYYYYY.tmp". </font><font style="vertical-align: inherit;">Now the user will be prepared, after deleting the file, he will know exactly at what moment and with what name the file will be created next time.</font></font><br>
<br>
<h2><font color="orange"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we will play with symlinks</font></font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to create symlinks without administrator rights</font></font></b><div class="spoiler_text">  ,           .     . , ,     «C:\abc\1»   «C:\def\2».<br>
<br>
  NTFS reparse point (  NTFS mount point)   «C:\abc»  «\RPC Control\". «\RPC Control\» –        ,   , ,  .    ,   , ,  ,     .       NTFS reparse point ,  ,             .   - ,  -            .<br>
<br>
          .    "\RPC Control\1" &lt;-&gt; «C:\def\2».  ,     «C:\abc\1»,       «C:\def\2».<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, the process of creating a license file looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/zh/8w/lnzh8ws9y5e0ewunx4u_pnnhkh8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we know the exact moment of the next such operation, we can create the following symlinks (we will skip the source folder name “C: \ ProgramData \ ABBYY \ FineReader \ 15 \ Licenses \”): </font><font style="vertical-align: inherit;">
Where YYYYYYYYA, YYYYYYYYB, YYYYYYYYC, ... YYYYYYYYYZ - these are different timestamps in the YYYYYYYYYY + 10minutes (in case the timestamp is slightly late). </font><font style="vertical-align: inherit;">
Next, create a link: </font><font style="vertical-align: inherit;">
Note that none of these files really exist. This is necessary so that when referring, for example, to tmpXXXX_YYYYYYYYB.tmp, two redirects occur and, as a result, the service works with the file "C: \ test \ l2 \ nope". </font><font style="vertical-align: inherit;">
As soon as we discover the creation of the file “C: \ test \ l2 \ nope”, we should immediately create two new symlinks:</font></font><br>
<br>
<code>tmpXXXX_YYYYYYYYA.tmp &lt;-&gt; C:\test\l1\proxy<br>
tmpXXXX_YYYYYYYYB.tmp &lt;-&gt; C:\test\l1\proxy<br>
tmpXXXX_YYYYYYYYC.tmp &lt;-&gt; C:\test\l1\proxy<br>
…<br>
tmpXXXX_YYYYYYYYZ.tmp &lt;-&gt; C:\test\l1\proxy</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>C:\test\l1\proxy &lt;-&gt; C:\test\l2\nope</code><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>C:\test\l1\proxy &lt;-&gt; C:\test\l2\payload<br>
Licensing.cnt &lt;-&gt; C:\target\path</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The service will continue to write the contents of the file to "C: \ test \ l2 \ nope", but will rename it after passing through the new symlink. Thus, instead of renaming, for example, “tmpXXXX_YYYYYYYYC.tmp” to “Licensing.cnt”, “C: \ test \ l2 \ payload” will actually be renamed (moved) to “C: \ target \ path”. In fact, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we can place a file with any content in any path on behalf of the user NT AUTHORITY \ SYSTEM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schematically, it will look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/bq/cb/m2bqcbiptwhuauds0bpsn4giyjo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The color indicates what will actually be performed due to the influence of symlinks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Raising privileges using the resulting primitive is already easy - you can attach your dll to system processes and other similar things. At this stage, I contacted ABBYY representatives and passed them information about the vulnerability.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, according to ABBYY, the vulnerability is closed.</font></font><br>
<br>
<h2><font color="orange"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timeline</font></font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11/25/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - vulnerability detection </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11/26/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - requested security contact from the manufacturer on </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11/26/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - sending a vulnerability report to the manufacturer </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12/09/2019</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the vulnerability was confirmed by the manufacturer </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10/01/2020</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the vulnerability was fixed </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on 01/22/2020</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - vulnerabilities were assigned CVE-2019-20383 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">19.02 .2020</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - publication of this article </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are many projects now and we are expanding the “Prospective Monitoring” team. </font><font style="vertical-align: inherit;">We are looking for experts in the study of source codes, as well as experts in the analysis of mobile applications. </font><font style="vertical-align: inherit;">Want to join my team - write to me, Anastasia (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ana2121</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) or by mail info@amonitoring.ru </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article in english.</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488814/index.html">Forge of Empires from AS3 to Haxe. Post mortem</a></li>
<li><a href="../en488816/index.html">How we lost Mir: a fire at a space station, a collision with a Progress truck, depressurization</a></li>
<li><a href="../en488818/index.html">Breakthroughs #DeepPavlov in 2019: review and results of the year</a></li>
<li><a href="../en488820/index.html">How not to burn out at work and what to do if you still burn out</a></li>
<li><a href="../en488824/index.html">DGTL Design Community Meetup at Raiffeisenbank: Broadcast</a></li>
<li><a href="../en488828/index.html">Spam, spam, spam ...</a></li>
<li><a href="../en488830/index.html">Internet in Turkmenistan: price, availability and restrictions</a></li>
<li><a href="../en488832/index.html">Surprisingly, last year, corporate HDDs were more popular than SSDs and their sales are growing</a></li>
<li><a href="../en488834/index.html">How the error from 2009 causes a conflict between Docker for Windows and Razer Synapse</a></li>
<li><a href="../en488836/index.html">Some aspects of working with Dictionary when developing loaded applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>