<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöû üöÆ üë©üèΩ‚Äç‚úàÔ∏è Comment s'affiche l'√©cran de message VK? üò† üèñÔ∏è ü§∏üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Que fait VK pour r√©duire les retards de rendu? Comment afficher un tr√®s gros message et ne pas tuer UiThread? Comment r√©duire les d√©lais de d√©filement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment s'affiche l'√©cran de message VK?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/501988/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que fait VK pour r√©duire les retards de rendu? </font><font style="vertical-align: inherit;">Comment afficher un tr√®s gros message et ne pas tuer UiThread? </font><font style="vertical-align: inherit;">Comment r√©duire les d√©lais de d√©filement dans RecyclerView? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vs/2s/jg/vs2sjg1iyfq7cdkohrmgpuy5mla.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon exp√©rience est bas√©e sur le travail de dessin d'un √©cran de message dans l'application VK Android, dans lequel il est n√©cessaire d'afficher une √©norme quantit√© d'informations avec un minimum de freins sur l'interface utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je programme pour Android depuis pr√®s de dix ans, j'√©tais auparavant freelance pour PHP / Node.js. </font><font style="vertical-align: inherit;">Maintenant - un d√©veloppeur Android senior VKontakte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous la coupe - vid√©o et transcription de mon rapport de la conf√©rence Mobius 2019 √† Moscou.</font></font><a name="habracut"></a><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/GZkTwgetUWI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rapport r√©v√®le trois sujets</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les solutions standard sont les principes de base du fonctionnement de l'√©cran de message VK. </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les solutions non standard sont des solutions peu connues ou originales qui permettent de minimiser les retards d'interface utilisateur.</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les alternatives concernent diff√©rentes biblioth√®ques et impl√©mentations, ainsi que les raisons pour lesquelles les d√©veloppeurs VK ne les ont pas utilis√©es.</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regarde l'√©cran:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/he/h2/xj/heh2xjq-ij5pnzsu49cf11uuabu.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce message est quelque part sur cinq √©crans. </font><font style="vertical-align: inherit;">Et ils pourraient bien √™tre avec nous (dans le cas du transfert de messages). </font><font style="vertical-align: inherit;">Les outils standard ne fonctionneront plus. </font><font style="vertical-align: inherit;">M√™me sur un appareil haut de gamme, tout peut prendre du retard. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, en plus de cela, l'interface utilisateur elle-m√™me est assez diversifi√©e:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dates et indicateurs de chargement,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messages de service</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">texte (emoji, lien, email, hashtags),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clavier bot</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ 40 fa√ßons d'afficher les pi√®ces jointes,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arborescence des messages transf√©r√©s.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question se pose: comment r√©duire au maximum le nombre de d√©calages? </font><font style="vertical-align: inherit;">√Ä la fois dans le cas de messages simples et dans le cas de messages en masse (cas de bord de la vid√©o ci-dessus).</font></font><br>
<a name="ordinary"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solutions standard</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecyclerView et ses modules compl√©mentaires</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe diff√©rents modules compl√©mentaires pour RecyclerView.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setHasFixedSize ( </font></font><code>boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup de gens pensent que ce drapeau est n√©cessaire lorsque les √©l√©ments de la liste sont de la m√™me taille. </font><font style="vertical-align: inherit;">Mais en fait, √† en juger par la documentation, le contraire est vrai. </font><font style="vertical-align: inherit;">C'est lorsque la taille de RecyclerView est constante et ind√©pendante des √©l√©ments (√† peu pr√®s, pas wrap_content). </font><font style="vertical-align: inherit;">La d√©finition de l'indicateur permet d'augmenter l√©g√®rement la vitesse du RecyclerView afin d'√©viter des calculs inutiles.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setNestedScrollingEnabled ( </font></font><code>boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optimisation mineure qui d√©sactive la prise en charge de NestedScroll. </font><font style="vertical-align: inherit;">Nous n'avons pas CollapsingToolbar ou d'autres fonctionnalit√©s en fonction de NestedScroll sur cet √©cran, nous pouvons donc d√©finir ce drapeau sur false en toute s√©curit√©.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setItemViewCacheSize ( </font></font><code>cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuration du cache RecyclerView interne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup de gens pensent que les m√©canismes de RecyclerView sont:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a un ViewHolder affich√© sur l'√©cran;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il y a un RecycledViewPool stockant ViewHolder;</font></font></li>
<li> ViewHolder    ‚Äî    RecycledViewPool.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En pratique, tout est un peu plus compliqu√©, car il y a un cache interm√©diaire entre ces deux choses. </font><font style="vertical-align: inherit;">Il s'appelle ItemViewCache. </font><font style="vertical-align: inherit;">Quelle est son essence? </font><font style="vertical-align: inherit;">Lorsque le ViewHolder quitte l'√©cran, il n'est pas plac√© dans le RecycledViewPool, mais dans le cache interm√©diaire (ItemViewCache). </font><font style="vertical-align: inherit;">Toutes les modifications apport√©es √† l'adaptateur s'appliquent √† la fois au ViewHolder visible et au ViewHolder √† l'int√©rieur de ItemViewCache. </font><font style="vertical-align: inherit;">Et pour le ViewHolder √† l'int√©rieur de RecycledViewPool, les modifications ne sont pas appliqu√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gr√¢ce √† setItemViewCacheSize, nous pouvons d√©finir la taille de ce cache interm√©diaire. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus il est grand, plus le d√©filement sera rapide sur de courtes distances, mais les op√©rations de mise √† jour prendront plus de temps (en raison de ViewHolder.onBind, etc.). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment RecyclerView est impl√©ment√© et comment son cache est structur√© est un sujet assez vaste et complexe. </font><font style="vertical-align: inherit;">Vous pouvez lire un excellent </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o√π ils parlent en d√©tail de tout.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation OnCreate / OnBind</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre solution classique consiste √† optimiser onCreateViewHolder / onBindViewHolder:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise en page facile (nous essayons d'utiliser autant que possible FrameLayout ou Custom ViewGroup),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les op√©rations lourdes (parsing links / emoji) se font de mani√®re asynchrone au stade du chargement des messages,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StringBuilder pour la mise en forme du nom, de la date, etc.,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et d'autres solutions qui r√©duisent le temps de travail de ces m√©thodes.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracking Adapter.onFailedToRecyclerView ()</font></font></h3><br>
<img src="https://habrastorage.org/webt/8l/eo/1n/8leo1nki7gxrit4wg8mhhv0q3ua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous disposez d'une liste dans laquelle certains √©l√©ments (ou une partie d'entre eux) sont anim√©s en alpha. </font><font style="vertical-align: inherit;">Au moment o√π View, en cours d'animation, quitte l'√©cran, il ne passe pas √† RecycledViewPool. </font><font style="vertical-align: inherit;">Pourquoi? </font><font style="vertical-align: inherit;">RecycledViewPool voit que la vue est maintenant anim√©e par l'indicateur View.hasTransientState et l'ignore simplement. </font><font style="vertical-align: inherit;">Par cons√©quent, la prochaine fois que vous faites d√©filer vers le haut ou vers le bas, la photo ne sera pas prise √† partir de RecycledViewPool, mais sera recr√©√©e √† nouveau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La d√©cision la plus correcte est lorsque ViewHolder quitte l'√©cran, vous devez annuler toutes les animations. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-7/1r/rh/-71rrhbw5idwburnf60gtfllcau.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez besoin d'un correctif d√®s que possible ou si vous √™tes un d√©veloppeur paresseux, alors dans la m√©thode onFailedToRecycle, vous pouvez simplement toujours retourner true et tout fonctionnera, mais je ne le conseillerais pas.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/se/ha/iusehamefbgzcvc6miixbtfmfoy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suivi du d√©couvert et du profileur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mani√®re classique de d√©tecter les probl√®mes est le sur-retrait et le suivi du profileur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Overdraw - le nombre de redessins du pixel: moins il y a de couches et moins le pixel est redessin√©, plus vite. Mais selon mes observations, dans les r√©alit√©s modernes, cela n'affecte pas tellement les performances. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0h/-d/fh/0h-dfhogberhs_hsy1eseaexkwa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Profiler - alias Android Monitor, qui est dans Android Studio. Dans celui-ci, vous pouvez analyser toutes les m√©thodes appel√©es. Par exemple, ouvrez des messages, faites d√©filer vers le haut et vers le bas et voyez quelles m√©thodes ont √©t√© appel√©es et combien de temps elles ont pris. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/la/wy/dzlawyqmpqtzxbnpcbezvfoq_ww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout ce qui se trouve dans la moiti√© gauche est les appels syst√®me Android n√©cessaires pour cr√©er / rendre un View / ViewHolder. Soit nous ne pouvons pas les influencer, soit nous devrons consacrer beaucoup d'efforts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La moiti√© droite est notre code qui s'ex√©cute dans ViewHolder.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bloc d'appel au num√©ro 1 est un appel √† des expressions r√©guli√®res: quelque part, ils ont oubli√© et oubli√© de mettre l'op√©ration sur le thread d'arri√®re-plan, ralentissant ainsi le d√©filement de ~ 20%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc d'appel au num√©ro 2 - Fresco, une biblioth√®que pour afficher des images. </font><font style="vertical-align: inherit;">Il n'est pas optimal √† certains endroits. On ne sait pas encore quoi faire avec ce d√©calage, mais si nous pouvons le r√©soudre, nous √©conomiserons encore ~ ‚Äã‚Äã15%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, en r√©solvant ces probl√®mes, nous pouvons obtenir une augmentation de ~ 35%, ce qui est plut√¥t cool.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difficile</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beaucoup d'entre vous utilisent DiffUtil sous sa forme standard: il existe deux listes - appel√©es, compar√©es et pouss√©es. Faire tout cela sur le thread principal est un peu cher car la liste peut √™tre tr√®s longue. Ainsi, le calcul DiffUtil s'ex√©cute g√©n√©ralement sur un thread d'arri√®re-plan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ListAdapter et AsyncListDiffer le font pour vous. Le ListAdapter √©tend l'adaptateur normal et d√©marre tout de mani√®re asynchrone - il suffit de cr√©er une liste de soumission et le calcul complet des modifications s'envole vers le thread d'arri√®re-plan interne. Le ListAdapter peut prendre en compte le cas de mises √† jour fr√©quentes: si vous l'appelez trois fois de suite, il ne prendra que le dernier r√©sultat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DiffUtil lui-m√™me, nous utilisons uniquement pour certains changements structurels - l'apparence du message, son changement et sa suppression. </font><font style="vertical-align: inherit;">Pour certaines donn√©es √† changement rapide, elles ne conviennent pas. </font><font style="vertical-align: inherit;">Par exemple, lorsque nous t√©l√©chargeons une photo ou lisons de l'audio. </font><font style="vertical-align: inherit;">De tels √©v√©nements se produisent souvent - plusieurs fois par seconde, et si vous ex√©cutez DiffUtil √† chaque fois, vous aurez beaucoup de travail suppl√©mentaire.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des animations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il √©tait une fois un cadre d'animation - plut√¥t maigre, mais toujours quelque chose. </font><font style="vertical-align: inherit;">Nous avons travaill√© avec lui comme ceci:</font></font><br>
<br>
<pre><code class="java hljs">view.startAnimation(TranslateAnimation(fromX = <span class="hljs-number">0</span>, toX = <span class="hljs-number">300</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me est que le param√®tre getTranslationX () renverra la m√™me valeur avant et apr√®s l'animation. </font><font style="vertical-align: inherit;">C'est parce que l'animation a chang√© la repr√©sentation visuelle, mais n'a pas chang√© les propri√©t√©s physiques. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f0/uu/tw/f0uutwhihhopkcfvps8itszyt_a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Android 3.0, le framework Animator est apparu, ce qui est plus correct car il a modifi√© la propri√©t√© physique sp√©cifique de l'objet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q2/ib/qy/q2ibqywrlcla5cxqpslznxbxxm0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, ViewPropertyAnimator est apparu et tout le monde ne comprend toujours pas vraiment sa diff√©rence avec Animator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais expliquer. </font><font style="vertical-align: inherit;">Disons que vous devez effectuer la traduction en diagonale - d√©placez la vue le long des axes x, y. </font><font style="vertical-align: inherit;">Tr√®s probablement, vous √©cririez du code typique:</font></font><br>
<br>
<pre><code class="java hljs">val animX = ObjectAnimator.ofFloat(view, ‚ÄútranslationX‚Äù, <span class="hljs-number">100f</span>)<font></font>
val animY = ObjectAnimator.ofFloat(view, ‚ÄútranslationY‚Äù, <span class="hljs-number">200f</span>)<font></font>
AnimatorSet().apply {<font></font>
    playTogether(animX, animY)<font></font>
    start()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et vous pouvez le raccourcir:</font></font><br>
<br>
<pre><code class="java hljs">view.animate().translationX(<span class="hljs-number">100f</span>).translationY(<span class="hljs-number">200f</span>) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous ex√©cutez view.animate (), vous lancez implicitement ViewPropertyAnimator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi est-il n√©cessaire?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lecture et maintenance du code plus faciles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animation d'op√©rations par lots.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre dernier cas, nous avons modifi√© deux propri√©t√©s. Lorsque nous le faisons via des animateurs, les ticks d'animation seront appel√©s s√©par√©ment pour chaque animateur. Autrement dit, setTranslationX et setTranslationY seront appel√©s s√©par√©ment et View effectuera les op√©rations de mise √† jour s√©par√©ment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de ViewPropertyAnimator, le changement se produit en m√™me temps, il y a donc une √©conomie due √† moins d'op√©rations et le changement des propri√©t√©s lui-m√™me est mieux optimis√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez y parvenir avec Animator, mais vous devrez √©crire plus de code. </font><font style="vertical-align: inherit;">De plus, en utilisant ViewPropertyAnimator, vous pouvez √™tre s√ªr que les animations seront optimis√©es autant que possible. </font><font style="vertical-align: inherit;">Pourquoi? </font><font style="vertical-align: inherit;">Android a un RenderNode (DisplayList). </font><font style="vertical-align: inherit;">Tr√®s grossi√®rement, ils mettent en cache le r√©sultat de onDraw et l'utilisent lors du redessin. </font><font style="vertical-align: inherit;">ViewPropertyAnimator fonctionne directement avec RenderNode et lui applique des animations, en √©vitant les appels onDraw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De nombreuses propri√©t√©s d'affichage peuvent √©galement affecter directement le RenderNode, mais pas toutes. </font><font style="vertical-align: inherit;">Autrement dit, lorsque vous utilisez ViewPropertyAnimator, vous √™tes assur√© d'utiliser la mani√®re la plus efficace. </font><font style="vertical-align: inherit;">Si vous avez soudainement une sorte d'animation qui ne peut pas √™tre faite avec ViewPropertyAnimator, alors vous devriez peut-√™tre y penser et la changer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animations: TransitionManager</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, les gens associent que ce cadre est utilis√© pour passer d'une activit√© √† une autre. En fait, il peut √™tre utilis√© diff√©remment et simplifier consid√©rablement la mise en ≈ìuvre de l'animation des changements structurels. Supposons que nous ayons un √©cran sur lequel un message vocal est lu. Nous le fermons avec une croix, et le d√© monte. Comment faire? L'animation est assez compliqu√©e: le joueur se ferme avec alpha, tout en ne se d√©pla√ßant pas par translation, mais change de hauteur. Dans le m√™me temps, notre liste monte et change √©galement la hauteur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/ff/kh/mvffkhe5udzkypeumimmusvhiig.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le joueur faisait partie de la liste, l'animation serait assez simple. Mais pour nous, le joueur n'est pas un √©l√©ment de la liste, mais une vision compl√®tement ind√©pendante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que nous commencerions √† √©crire une sorte d'animateur, puis nous rencontrerions des probl√®mes, des plantages, commencerions √† scier des b√©quilles et doubler le code. </font><font style="vertical-align: inherit;">Et obtiendrait quelque chose comme l'√©cran ci-dessous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/0d/k-/wd0dk-urz2lfr6xugvvpmp16rdk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec TransitionManager, vous pouvez tout simplifier:</font></font><br>
<br>
<pre><code class="java hljs">TransitionManager.beginDelayedTransition(<font></font>
        viewGroup = &lt;LinearLayoutManager&gt;,<font></font>
        transition = AutoTransition())<font></font>
playerView.visibility = View.GONE</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute animation se d√©roule automatiquement sous le capot. </font><font style="vertical-align: inherit;">Cela ressemble √† de la magie, mais si vous allez profond√©ment √† l'int√©rieur et voyez comment cela fonctionne, il s'av√®re que le TransitionManager s'abonne simplement √† toutes les vues, capture les modifications de leurs propri√©t√©s, calcule les diff√©rences, cr√©e les animateurs n√©cessaires ou ViewPropertyAnimator si n√©cessaire, et fait tout aussi efficacement que possible. </font><font style="vertical-align: inherit;">TransitionManager nous permet de cr√©er des animations dans la section des messages rapidement et facilement.</font></font><a name="extrodinary"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solutions personnalis√©es</font></font></h2><br>
<img src="https://habrastorage.org/webt/u2/rx/ji/u2rxjicmid-zkuhvqsxc4kxbeem.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est la chose la plus fondamentale sur laquelle reposent les performances et les probl√®mes qui en d√©coulent. Que faire lorsque votre message est sur 10 √©crans? Si vous faites attention, tous nos √©l√©ments sont situ√©s exactement les uns sous les autres. Si nous acceptons que ViewHolder n'est pas un seul message, mais des dizaines de ViewHolders diff√©rents, alors tout devient beaucoup plus simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est pas un probl√®me pour nous que le message soit devenu 10 √©crans, car maintenant nous affichons seulement six ViewHolders dans un exemple concret. Nous avons obtenu une mise en page facile, le code est plus facile √† maintenir et il n'y a pas de probl√®mes particuliers, sauf un - comment faire?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/gh/ui/hoghuifbuntyzu3uszyjr6vij_0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des ViewHolders simples - ce sont des s√©parateurs de date classiques, Charger plus, etc. </font><font style="vertical-align: inherit;">Et BaseViewHolder - ViewHolder de base conditionnelle pour le message. </font><font style="vertical-align: inherit;">Il a une impl√©mentation de base et plusieurs sp√©cifiques - TextViewHolder, PhotoViewHolder, AudioViewHolder, ReplyViewHolder et ainsi de suite. </font><font style="vertical-align: inherit;">Il y en a environ 70.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De quoi est responsable BaseViewHolder?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BaseViewHolder est uniquement responsable du dessin de l'avatar et du morceau de bulle souhait√©, ainsi que de la ligne des messages transf√©r√©s - bleu √† gauche. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6o/yh/ia/6oyhiaag8f94wm6s69vskpv6r4u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'impl√©mentation concr√®te du contenu est d√©j√† effectu√©e par d'autres h√©ritiers de BaseViewHolder: TextViewHolder affiche uniquement le texte, FwdSenderViewHolder - l'auteur du message transf√©r√©, AudioMsgViewHolder - le message vocal, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/th/wi/sdthwihnbm9jm4xehrbh4mmrv20.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un probl√®me: que faire de la largeur? Imaginez un message sur au moins deux √©crans. La largeur √† d√©finir n'est pas tr√®s claire, car la moiti√© est visible, la moiti√© n'est pas visible (et n'a m√™me pas encore √©t√© cr√©√©e). Absolument tout ne peut pas √™tre mesur√©, car il repose. Je dois b√©quiller un peu, h√©las. Il y a des cas simples o√π le message est tr√®s simple: purement texte ou voix - en g√©n√©ral, se compose d'un √©l√©ment.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_q/i0/ov/_qi0ovd7qibtvqzcya0tzv_o4vq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, utilisez le wrap_content classique. </font><font style="vertical-align: inherit;">Pour un cas complexe, lorsqu'un message est compos√© de plusieurs √©l√©ments, nous prenons et forceons chaque ViewHolder sur une largeur fixe. </font><font style="vertical-align: inherit;">Plus pr√©cis√©ment ici - 220 dp. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yi/fa/5t/yifa5tx6chfyxf2c26zeak-kaeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le texte est tr√®s court et que le message est transmis, il y a un espace vide √† droite. </font><font style="vertical-align: inherit;">Il n'y a pas d'√©chappatoire √† cela, car les performances sont plus importantes. </font><font style="vertical-align: inherit;">Pendant plusieurs ann√©es, il n'y a eu aucune plainte - peut-√™tre que quelqu'un l'a remarqu√©, mais en g√©n√©ral, tout le monde s'y est habitu√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qb/mz/0l/qbmz0lzz-o_lvhongodanb3fh1m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a des cas marginaux. </font><font style="vertical-align: inherit;">Si nous r√©pondons √† un message avec un autocollant, nous pouvons sp√©cifier la largeur sp√©cifiquement pour un tel cas, afin qu'il soit plus joli. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous divisons en ViewHolders au stade du chargement des messages: nous d√©marrons le chargement en arri√®re-plan du message, le convertissons en √©l√©ment, ils sont directement affich√©s dans ViewHolders.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/12/w_/x7/12w_x7wp4a4a4s5f_dqeqrevlbc.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Global RecycledViewPool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les m√©canismes d'utilisation de notre messager sont tels que les gens ne s'assoient pas dans le m√™me chat, mais passent constamment entre eux. </font><font style="vertical-align: inherit;">Dans l'approche standard, lorsque nous sommes entr√©s dans le chat et l'avons laiss√©, le RecycledViewPool (et le ViewHolder qu'il contient) sont simplement d√©truits, et chaque fois que nous d√©pensons des ressources pour cr√©er le ViewHolder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut √™tre r√©solu par Global RecycledViewPool:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le cadre d'Application, RecycledViewPool vit comme un singleton;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©utilis√© sur l'√©cran de message lorsque l'utilisateur passe d'un √©cran √† l'autre;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©fini comme RecyclerView.setRecycledViewPool (pool).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a des pi√®ges, il est important de se rappeler deux choses:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous allez √† l'√©cran, cliquez sur retour, quittez. </font><font style="vertical-align: inherit;">Le probl√®me est que les ViewHolders qui √©taient √† l'√©cran sont jet√©s et ne sont pas retourn√©s √† la piscine. </font><font style="vertical-align: inherit;">Ceci est r√©solu comme suit:</font></font><br>
<pre><code class="java hljs">LinearLayoutManager.recycleChildrenOnDetach = <span class="hljs-keyword">true</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecycledViewPool a des limites: pas plus de cinq ViewHolders peuvent √™tre stock√©s pour chaque ViewType.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si 9 TextViews s'affichent √† l'√©cran, seuls cinq √©l√©ments seront renvoy√©s au RecycledViewPool et les autres seront jet√©s. </font><font style="vertical-align: inherit;">Vous pouvez changer la taille du RecycledViewPool: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RecycledViewPool.setMaxRecycledViews (viewType, size) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il est en quelque sorte triste de prescrire pour chaque ViewType avec vos mains, car vous pouvez √©crire votre RecycledViewPool, en √©tendant le standard et en faire NoLimit. </font><font style="vertical-align: inherit;">Par le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez t√©l√©charger l'impl√©mentation termin√©e.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DiffUtil n'est pas toujours utile</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un cas classique - t√©l√©chargement, lecture d'une piste audio et d'un message vocal. </font><font style="vertical-align: inherit;">Dans ce cas, DiffUtil appelle le spam. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/3o/lt/ho3oltgo6763hgc65xxel-ccopa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre BaseViewHolder a une m√©thode abstraite updateUploadProgress.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseViewHolder</span> : <span class="hljs-title">ViewHolder</span> </span>{<font></font>
    ‚Ä¶<font></font>
    <span class="hljs-function">fun <span class="hljs-title">updateUploadProgress</span><span class="hljs-params">(attachId: Int, progress: Float)</span>
    ‚Ä¶        
}
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour lancer un √©v√©nement, nous devons contourner tous les ViewHolder visibles:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">fun <span class="hljs-title">onUploadProgress</span><span class="hljs-params">(attachId: Int, progress: Float)</span> </span>{<font></font>
    forEachActiveViewHolder {<font></font>
        it.updateUploadProgress(attachId, progress)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une op√©ration simple, il est peu probable que nous ayons plus de dix ViewHolder √† l'√©cran. </font><font style="vertical-align: inherit;">Une telle approche ne peut pas √™tre en retard sur le principe. </font><font style="vertical-align: inherit;">Comment trouver ViewHolder visible? </font><font style="vertical-align: inherit;">Une impl√©mentation na√Øve serait quelque chose comme ceci:</font></font><br>
<br>
<pre><code class="java hljs">val firstVisiblePosition = &lt;...&gt;<font></font>
val lastVisiblePosition = &lt;...&gt;<font></font>
<span class="hljs-keyword">for</span> (i in firstVisiblePosition.. lastVisiblePosition) {<font></font>
    val viewHolder = recycler.View.findViewHolderForAdapterPosition(i)<font></font>
    viewHolder.updateUploadProgress(..)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y a un probl√®me. </font><font style="vertical-align: inherit;">Le cache interm√©diaire que j'ai mentionn√© plus t√¥t, ItemViewCache, contient des ViewHolders actifs qui n'apparaissent tout simplement pas √† l'√©cran. </font><font style="vertical-align: inherit;">Le code ci-dessus ne les affectera pas. </font><font style="vertical-align: inherit;">Directement, nous ne pouvons pas non plus y r√©pondre. </font><font style="vertical-align: inherit;">Et puis des b√©quilles viennent √† notre aide. </font><font style="vertical-align: inherit;">Cr√©ez un WeakSet qui stocke les liens vers ViewHolder. </font><font style="vertical-align: inherit;">De plus, il nous suffit de contourner simplement ce WeakSet.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Adapter</span> : <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter</span> </span>{<font></font>
    val activeViewHolders = WeakSet&lt;ViewHolder&gt;()<font></font>
        <font></font>
    <span class="hljs-function">fun <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: ViewHolder, position: Int)</span> </span>{<font></font>
        activeViewHolders.add(holder)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function">fun <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: ViewHolder)</span> </span>{<font></font>
        activeViewHolders.remove(holder)<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superposition de ViewHolder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons l'exemple des histoires. Auparavant, si une personne r√©agissait √† une histoire avec un autocollant, nous la pr√©sentions comme ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rc/kd/z1/rckdz16ebmfwftxzfpql2lwmsko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
elle a l'air assez moche. Je voulais faire mieux, car les histoires ont un contenu lumineux et nous avons un petit carr√© l√†-bas. Mais nous voulions obtenir quelque chose comme ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/ma/51/vjma51z9m4eqwlhiagc7xvu2kg0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un probl√®me: notre message est divis√© en ViewHolder, ils sont situ√©s strictement les uns sous les autres, mais ici ils se chevauchent. Imm√©diatement, on ne sait pas comment r√©soudre ce probl√®me. Vous pouvez cr√©er un autre ViewType ¬´historique + autocollant¬ª ou ¬´historique + message vocal¬ª. Donc, au lieu de 70 ViewType, nous en aurions 140 ... Non, nous devons trouver quelque chose de plus pratique.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/01/mr/5j/01mr5jqsfdpq_zcq4s3b-vf9pyq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une de vos b√©quilles pr√©f√©r√©es dans Android me vient √† l'esprit. </font><font style="vertical-align: inherit;">Par exemple, nous faisions quelque chose, mais Pixel Perfect ne converge pas. </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me, vous devez tout supprimer et √©crire √† partir de z√©ro, mais la paresse. </font><font style="vertical-align: inherit;">En cons√©quence, nous pouvons faire une marge = -2dp (n√©gative), et maintenant tout se met en place. </font><font style="vertical-align: inherit;">Mais une telle approche ne peut pas √™tre utilis√©e ici. </font><font style="vertical-align: inherit;">Si vous d√©finissez une marge n√©gative, l'autocollant se d√©placera, mais la place qu'il occupait restera vide. </font><font style="vertical-align: inherit;">Mais nous avons ItemDecoration, o√π itemOffset nous pouvons faire un nombre n√©gatif. </font><font style="vertical-align: inherit;">Et il fonctionne! </font><font style="vertical-align: inherit;">En cons√©quence, nous obtenons la superposition attendue et en m√™me temps il reste un paradigme o√π chaque ViewHolder est ami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une belle solution en une seule ligne.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OffsetItemDecoration</span> : <span class="hljs-title">RecyclerViewItemDecoration</span>() </span>{
    <span class="hljs-function">overrride fun <span class="hljs-title">getItemOffsets</span><span class="hljs-params">(offset: Rect, ‚Ä¶)</span> </span>{<font></font>
        offset.top = -<span class="hljs-number">100</span>dp<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idlehandler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est un cas avec un ast√©risque, c'est complexe et pas si souvent n√©cessaire en pratique, mais il est important de conna√Ætre l'existence d'une telle m√©thode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, je vais vous expliquer le fonctionnement du thread principal UiThread. Le sch√©ma g√©n√©ral: il existe une file d'attente d'√©v√©nements de t√¢ches dans laquelle les t√¢ches sont d√©finies via handler.post, et une boucle infinie qui traverse cette file d'attente. Autrement dit, UiThread est juste pendant (vrai). S'il y a des t√¢ches, on les ex√©cute, sinon, on attend qu'elles apparaissent.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y3/ee/nn/y3eennjezxs29i4lkbvggnqkgjw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans nos r√©alit√©s habituelles, Handler est responsable de la mise des t√¢ches dans la file d'attente, et Looper contourne sans cesse la file d'attente. </font><font style="vertical-align: inherit;">Il y a des t√¢ches qui ne sont pas tr√®s importantes pour l'interface utilisateur. </font><font style="vertical-align: inherit;">Par exemple, un utilisateur lit un message - ce n'est pas si important pour nous lorsque nous l'afficherons sur l'interface utilisateur, maintenant ou apr√®s 20 ms. </font><font style="vertical-align: inherit;">L'utilisateur ne remarquera pas la diff√©rence. </font><font style="vertical-align: inherit;">Alors, cela vaut peut-√™tre la peine d'ex√©cuter cette t√¢che sur le thread principal uniquement lorsqu'elle est gratuite? </font><font style="vertical-align: inherit;">Autrement dit, il serait bon pour nous de savoir quand la ligne waitNewTask est appel√©e. </font><font style="vertical-align: inherit;">Dans ce cas, Looper a un addIdleHandler qui se d√©clenche lorsque le code tasks.isEmpty se d√©clenche. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looper.myQueue (). AddIdleHandler ()</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Et puis l'impl√©mentation la plus simple de IdleHandler ressemblera √† ceci:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@AnyThread</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdleHandler</span> </span>{
    <span class="hljs-keyword">private</span> val handler = Handler(Looper.getMainLooper())<font></font>
<font></font>
    <span class="hljs-function">fun <span class="hljs-title">post</span><span class="hljs-params">(task: Runnable)</span> </span>{<font></font>
        handler.post {<font></font>
            Looper.myQueue().addIdleHandler {<font></font>
                task.run()<font></font>
                <span class="hljs-keyword">return</span><span class="hljs-meta">@addIdleHandler</span> <span class="hljs-keyword">false</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la m√™me mani√®re, vous pouvez mesurer un d√©marrage √† froid honn√™te de l'application.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emoji</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons nos emoji personnalis√©s au lieu de ceux du syst√®me. Voici un exemple de l'apparence des emojis sur diff√©rentes plateformes au cours des diff√©rentes ann√©es. Les emoji gauche et droit sont plut√¥t sympas, mais au milieu ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bv/71/m3/bv71m3d7rginefvtev6ogcgwess.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un deuxi√®me probl√®me: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dw/-1/nx/dw-1nxxjfpggaxcjo_-idb0ofce.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
chaque ligne est le m√™me emoji, mais les √©motions qu'ils reproduisent sont diff√©rentes. J'aime le bas √† droite le plus, je ne comprends toujours pas ce que cela signifie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a un v√©lo de VKontakte. En ~ 2014, nous avons l√©g√®rement chang√© un emoji. Peut-√™tre que quelqu'un se souvient - "Marshmallow" l'√©tait. Apr√®s son changement, une mini-√©meute a commenc√©. Bien s√ªr, il n'a pas atteint le niveau ¬´retour du mur¬ª, mais la r√©action a √©t√© assez int√©ressante. Et cela nous indique l'importance d'interpr√©ter les emoji.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment les √©mojis sont faits: nous avons un grand bitmap, o√π ils sont tous assembl√©s dans un grand ¬´atlas¬ª. </font><font style="vertical-align: inherit;">Il y en a plusieurs - sous diff√©rents DPI. </font><font style="vertical-align: inherit;">Et il y a un EmojiSpan qui contient des informations: je dessine "tel ou tel" emoji, il est dans tel ou tel bitmap √† tel ou tel endroit (x, y). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a un ReplacementSpan qui vous permet d'afficher quelque chose au lieu de texte sous Span. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, vous trouvez des emoji dans le texte, enveloppez-les avec EmojiSpan, et le syst√®me dessine les emoji souhait√©s au lieu du syst√®me.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/y5/tq/agy5tq5wl0ys8vbwuqgwhpfeoli.png"><a name="alt"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alternatives</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gonfler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelqu'un peut dire que comme le gonflage est lent, pourquoi ne pas simplement cr√©er une disposition avec vos mains, en √©vitant de gonfler. </font><font style="vertical-align: inherit;">Et acc√©l√©rez ainsi tout en √©vitant le 100500 ViewHolder. </font><font style="vertical-align: inherit;">C'est une illusion. </font><font style="vertical-align: inherit;">Avant de faire quelque chose, il vaut la peine de le mesurer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Android a une classe Debug, il a startMethodTracing et stopMethodTracing.</font></font><br>
<br>
<pre><code class="java hljs">Debug.startMethodTracing(‚Äútrace¬ª)<font></font>
inflate(...)<font></font>
Debug.stopMethodTracing()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela nous permettra de collecter des informations sur le temps d'ex√©cution d'un morceau de code particulier. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ea/hz/wa/eahzwatykq-cflwr2ul3qnwbvq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et on voit qu'ici gonfler en tant que tel est m√™me invisible. </font><font style="vertical-align: inherit;">Un quart du temps a √©t√© consacr√© au chargement de dessins, un quart au chargement de couleurs. </font><font style="vertical-align: inherit;">Et ce n'est que quelque part dans la partie etc. que notre gonflement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai essay√© de traduire la disposition XML en code et j'ai enregistr√© environ 0,5 ms. </font><font style="vertical-align: inherit;">L'augmentation, en fait, n'est pas la plus impressionnante. </font><font style="vertical-align: inherit;">Et le code est devenu beaucoup plus compliqu√©. </font><font style="vertical-align: inherit;">Autrement dit, la r√©√©criture n'a pas beaucoup de sens.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, en pratique, beaucoup ne rencontreront pas du tout ce probl√®me, car un long gonflement ne se produit g√©n√©ralement que lorsque l'application devient tr√®s volumineuse. </font><font style="vertical-align: inherit;">Dans notre application VKontakte, par exemple, il y a environ 200 √† 300 √©crans diff√©rents, et le chargement de toutes les ressources plante. </font><font style="vertical-align: inherit;">Que faire de cela n'est pas encore clair. </font><font style="vertical-align: inherit;">Tr√®s probablement, vous devrez √©crire votre propre gestionnaire de ressources.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anko</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anko est r√©cemment devenu obsol√®te. </font><font style="vertical-align: inherit;">Quoi qu'il en soit, Anko n'est pas magique, mais un sucre syntaxique simple. </font><font style="vertical-align: inherit;">Il traduit tout dans la nouvelle vue conditionnelle () de la m√™me mani√®re. </font><font style="vertical-align: inherit;">Par cons√©quent, il n'y a aucun avantage d'Anko.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Litho / Flutter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi ai-je combin√© deux choses compl√®tement ind√©pendantes? </font><font style="vertical-align: inherit;">Parce qu'il ne s'agit pas de technologie, mais de la complexit√© de la migration vers celle-ci. </font><font style="vertical-align: inherit;">Vous ne pouvez pas simplement emprunter et passer √† une nouvelle biblioth√®que. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On ne sait pas si cela nous donnera un coup de fouet sur les performances. </font><font style="vertical-align: inherit;">Et nous n'obtiendrons pas de nouveaux probl√®mes, car des millions de personnes avec des appareils compl√®tement diff√©rents utilisent notre application chaque minute (vous n'en avez probablement m√™me pas entendu parler environ un quart). </font><font style="vertical-align: inherit;">De plus, les messages sont une tr√®s grande base de code. </font><font style="vertical-align: inherit;">Il est impossible de tout r√©√©crire instantan√©ment. </font><font style="vertical-align: inherit;">Et le faire √† cause du battage m√©diatique de la technologie est stupide. </font><font style="vertical-align: inherit;">Surtout quand le Jetpack Compose se profile quelque part tr√®s loin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetpack compose</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google nous promet tous de la manne c√©leste sous la forme de cette biblioth√®que, mais elle est toujours en alpha. </font><font style="vertical-align: inherit;">Et quand ce sera dans la version - ce n'est pas clair. </font><font style="vertical-align: inherit;">Nous ne savons pas non plus si nous pouvons l'obtenir sous sa forme actuelle. </font><font style="vertical-align: inherit;">Il est trop t√¥t pour exp√©rimenter. </font><font style="vertical-align: inherit;">Laissez-le sortir en stable, laissez les principaux bugs se fermer. </font><font style="vertical-align: inherit;">Et c'est seulement alors que nous regarderons dans sa direction.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une grande vue personnalis√©e</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une autre approche dont parlent ceux qui utilisent divers messageries instantan√©es: ¬´prenez et √©crivez une grande vue personnalis√©e, pas de hi√©rarchie compliqu√©e¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels sont les inconv√©nients?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est difficile √† maintenir.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela n'a pas de sens dans les r√©alit√©s actuelles.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec Android 4.3, le syst√®me de mise en cache interne dans View a √©t√© pomp√©. </font><font style="vertical-align: inherit;">Par exemple, onMeasure n'est pas appel√© si la vue n'a pas chang√©. </font><font style="vertical-align: inherit;">Et les r√©sultats de la mesure pr√©c√©dente sont utilis√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec Android 4.3-4.4, un RenderNode (DisplayList) est apparu, mettant en cache le rendu. </font><font style="vertical-align: inherit;">Regardons un exemple. </font><font style="vertical-align: inherit;">Supposons qu'il y ait une cellule dans la liste des dialogues: avatar, titre, sous-titre, √©tat de lecture, heure, un autre avatar. </font><font style="vertical-align: inherit;">Conditionnellement - 10 √©l√©ments. </font><font style="vertical-align: inherit;">Et nous avons √©crit Custom View. </font><font style="vertical-align: inherit;">Dans ce cas, lorsque vous modifiez une propri√©t√©, nous mesurerons √† nouveau tous les √©l√©ments. </font><font style="vertical-align: inherit;">Autrement dit, il suffit de d√©penser les ressources suppl√©mentaires. </font><font style="vertical-align: inherit;">Dans le cas du ViewGroup, o√π chaque √©l√©ment est une vue distincte, lorsque vous changez une vue, nous invaliderons une seule vue (sauf lorsque cette vue affecte la taille des autres).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez donc appris que nous utilisons le RecyclerView classique avec des optimisations standard. Il y en a une partie non standard, o√π le plus important et le plus fondamental est de diviser le message en ViewHolder. Bien s√ªr, vous pouvez dire que cela est √©troitement applicable, mais cette approche peut √©galement √™tre projet√©e sur d'autres choses, par exemple, sur un grand texte de 10 000 caract√®res. Il peut √™tre divis√© en paragraphes, o√π chaque paragraphe est un ViewHolder distinct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il vaut √©galement la peine de tout maximiser sur @WorkerThread: analyse des liens, DiffUtils - d√©chargeant ainsi @UiThead autant que possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le Global RecycledViewPool vous permet de parcourir les √©crans de messages et de ne pas cr√©er un ViewHolder √† chaque fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y a d'autres choses importantes que nous n'avons pas encore d√©cid√©es, par exemple, un long gonflement, ou plut√¥t, le chargement des donn√©es √† partir des ressources.</font></font><br>
<br>
<blockquote>    ,   Mobius 2019 Piter  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,     .     ,     ,  SQLite,     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mobius 2020 Piter</a>     .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501978/index.html">Comment fonctionne l'histogramme Prometheus?</a></li>
<li><a href="../fr501980/index.html">L'histoire d'un projet ou comment j'ai cr√©√© un PBX de 7 ans bas√© sur Asterisk et Php</a></li>
<li><a href="../fr501982/index.html">Comment transf√©rer un shader d'un moteur de jeu vers Substance Painter</a></li>
<li><a href="../fr501984/index.html">Que voir en quarantaine? Une s√©lection de mat√©riaux de Technostream (partie 4)</a></li>
<li><a href="../fr501986/index.html">Les secrets de l'incroyable succ√®s des Apple AirPods</a></li>
<li><a href="../fr501990/index.html">Poste utile: 4 √©v√©nements pour r√©soudre les probl√®mes de la deuxi√®me journ√©e dans OpenShift et cr√©er des op√©rateurs</a></li>
<li><a href="../fr501992/index.html">Comment organiser les tests afin d'acc√©l√©rer et de stabiliser les versions des produits. Partie 1</a></li>
<li><a href="../fr501994/index.html">Orchestrator pour MySQL: pourquoi un projet √† s√©curit√© int√©gr√©e ne peut pas √™tre construit sans lui</a></li>
<li><a href="../fr501996/index.html">Zen Go (Pocket Version)</a></li>
<li><a href="../fr501998/index.html">Prix ‚Äã‚Äãcher des styles. Rapport Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>