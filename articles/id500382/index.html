<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍⚕️ 🎂 🤳 Integrasi Aviasales API dengan Amazon Kinesis dan kesederhanaan tanpa server 👂🏻 🤽 🚣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! 
 
 Apakah Anda suka menerbangkan pesawat? Saya menyukainya, tetapi dengan isolasi sendiri, saya juga suka menganalisis data tiket pesawat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Integrasi Aviasales API dengan Amazon Kinesis dan kesederhanaan tanpa server</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah Anda suka menerbangkan pesawat? </font><font style="vertical-align: inherit;">Saya menyukainya, tetapi dengan isolasi sendiri, saya juga suka menganalisis data tiket pesawat dari satu sumber daya terkenal - Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hari ini kita akan menganalisis karya Amazon Kinesis, membangun sistem streaming dengan analisis waktu nyata, menempatkan basis data Amazon DynamoDB NoSQL sebagai gudang data utama dan mengatur peringatan SMS untuk tiket menarik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua detail di bawah cut! </font><font style="vertical-align: inherit;">Pergilah!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengantar</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, kita memerlukan akses ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API Aviasales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Akses ke sana disediakan gratis dan tanpa batasan, Anda hanya perlu mendaftar di bagian "Pengembang" untuk mendapatkan token API Anda untuk mengakses data.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tujuan utama artikel ini adalah untuk memberikan pemahaman umum tentang penggunaan informasi streaming di AWS, kami membuatnya keluar dari pertanyaan bahwa data yang dikembalikan oleh API yang digunakan tidak sepenuhnya relevan dan ditransfer dari cache, yang dihasilkan berdasarkan pencarian pengguna situs Aviasales.ru dan Jetradar.com untuk 48 jam terakhir. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data tiket maskapai agen Kinesis yang diterima melalui API yang dipasang pada mesin produsen akan secara otomatis diuraikan dan ditransfer ke aliran yang diinginkan melalui Kinesis Data Analytics. </font><font style="vertical-align: inherit;">Versi aliran ini yang belum diproses akan ditulis langsung ke repositori. </font><font style="vertical-align: inherit;">Digunakan dalam penyimpanan data mentah DynamoDB akan memungkinkan untuk analisis tiket yang lebih mendalam melalui alat BI, seperti AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan mempertimbangkan dua opsi untuk menggunakan seluruh infrastruktur:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual - melalui Konsol Manajemen AWS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastruktur dari kode Terraform - untuk insinyur otomatisasi malas;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arsitektur sistem dalam pengembangan</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komponen yang Digunakan:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviasales API</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - data yang dikembalikan oleh API ini akan digunakan untuk semua pekerjaan selanjutnya;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesin Virtual</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"> Produser EC2</font></b></a><font style="vertical-align: inherit;"> - mesin virtual biasa di cloud tempat aliran data input akan dihasilkan:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agen Kinesis</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah aplikasi Java yang diinstal secara lokal yang menyediakan cara mudah untuk mengumpulkan dan mengirim data ke Kinesis (Kinesis Data Stream atau Kinesis Firehose). </font><font style="vertical-align: inherit;">Agen terus memantau satu set file di direktori yang ditentukan dan mengirimkan data baru ke Kinesis;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caller API Script</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - skrip Python yang membuat permintaan API dan menempatkan respons dalam folder yang dipantau oleh Kinesis Agent;</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelatihan awal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk meniru aliran data, saya memutuskan untuk menggunakan informasi tiket pesawat yang dikembalikan oleh Aviasales API. </font><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dokumentasi memiliki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> daftar yang cukup luas metode yang berbeda, mengambil salah satu dari mereka - “Harga Kalender untuk Bulan”, yang kembali harga untuk setiap hari bulan, dikelompokkan dengan jumlah transfer. </font><font style="vertical-align: inherit;">Jika Anda tidak mengirimkan bulan pencarian dalam permintaan, informasi akan dikembalikan untuk bulan berikutnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, daftar, dapatkan token Anda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh permintaan di bawah ini:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode menerima data dari API dengan token di dalam permintaan akan berfungsi, tetapi saya lebih suka meneruskan token akses melalui header, jadi kami akan menggunakan metode ini dalam skrip api_caller.py. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh jawaban:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh respons API di atas menunjukkan tiket dari St. Petersburg ke Phuk ... Oh, impian apa ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena saya dari Kazan, dan Phuket "hanya bermimpi tentang kami" sekarang, kami akan mencari tiket dari St. Petersburg ke Kazan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diasumsikan bahwa Anda sudah memiliki akun AWS. </font><font style="vertical-align: inherit;">Saya ingin memberikan perhatian khusus segera bahwa Kinesis dan mengirim pemberitahuan melalui SMS tidak termasuk dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Free Tier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tahunan </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">(penggunaan gratis)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tetapi meskipun demikian, memiliki beberapa dolar dalam pikiran, sangat mungkin untuk membangun sistem yang diusulkan dan bermain dengannya. </font><font style="vertical-align: inherit;">Dan, tentu saja, jangan lupa untuk menghapus semua sumber daya setelah mereka menjadi tidak perlu.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untungnya, fungsi DynamoDb dan lambda akan menjadi shareware bagi kami jika Anda tetap dalam batas gratis bulanan. </font><font style="vertical-align: inherit;">Misalnya, untuk DynamoDB: penyimpanan 25 GB, 25 WCU / RCU dan 100 juta permintaan. </font><font style="vertical-align: inherit;">Dan sejuta panggilan ke fungsi lambda per bulan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistem penyebaran manual</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyiapkan Streaming Data Kinesis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pergi ke layanan Streaming Data Kinesis dan buat dua aliran baru, masing-masing satu beling.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa itu beling?</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semakin banyak pecahan dalam aliran Anda, semakin besar throughputnya. </font><font style="vertical-align: inherit;">Pada prinsipnya, aliran ditingkatkan dengan cara ini dengan menambahkan pecahan. </font><font style="vertical-align: inherit;">Tetapi semakin banyak pecahan yang Anda miliki, semakin tinggi harganya. </font><font style="vertical-align: inherit;">Setiap pecahan harganya 1,5 sen per jam dan tambahan 1,4 sen untuk setiap juta unit muatan PUT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat utas baru dengan nama </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">airline_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , 1 </font><b><font style="vertical-align: inherit;">shard</font></b><font style="vertical-align: inherit;"> akan cukup untuk itu:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang buat aliran lain yang disebut </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan Produser</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai produsen data untuk mengurai tugas, cukup menggunakan contoh EC2 biasa. </font><font style="vertical-align: inherit;">Itu tidak harus menjadi mesin virtual mahal yang kuat; spot t2.micro cukup cocok. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catatan penting: misalnya, Anda harus menggunakan gambar - Amazon Linux AMI 2018.03.0, dengan itu ada lebih sedikit pengaturan untuk meluncurkan Agen Kinesis dengan cepat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pergi ke layanan EC2, buat mesin virtual baru, pilih AMI yang diinginkan dengan tipe t2.micro, yang termasuk dalam Free Tier:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agar mesin virtual yang baru dibuat untuk dapat berinteraksi dengan layanan Kinesis, Anda harus memberikannya hak untuk melakukannya. </font><font style="vertical-align: inherit;">Cara terbaik untuk melakukan ini adalah dengan menetapkan Peran IAM. </font><font style="vertical-align: inherit;">Oleh karena itu, pada Langkah 3: Konfigurasikan detail Contoh, pilih </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat Peran IAM baru</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat Peran IAM untuk EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat membiarkan parameter hard disk secara default, juga tag (meskipun praktik yang baik untuk menggunakan tag, setidaknya berikan nama instance dan tentukan lingkungan). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita berada di Langkah 6: Konfigurasikan tab Grup Keamanan, di mana Anda perlu membuat yang baru atau menentukan grup Keamanan yang ada, yang memungkinkan Anda untuk terhubung melalui ssh (port 22) ke instance. </font><font style="vertical-align: inherit;">Pilih Sumber -&gt; IP saya di sana dan Anda dapat menjalankan instance.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah memasuki status berjalan, Anda dapat mencoba menghubungkannya melalui ssh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agar dapat bekerja dengan Agen Kinesis, setelah koneksi yang berhasil ke mesin, Anda harus memasukkan perintah berikut di terminal:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat folder untuk menyimpan respons API:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum memulai agen, Anda perlu mengkonfigurasi konfigurasinya:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isi file agent.json akan terlihat seperti ini:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang dapat Anda lihat dari file konfigurasi, agen akan memantau file dengan ekstensi .log di direktori / var / log / airline_tickets /, parsing dan transfer ke aliran airline_tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memulai kembali layanan dan memastikan bahwa itu dimulai dan berfungsi:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang unduh skrip Python yang akan meminta data dari API:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skrip api_caller.py meminta data dari Aviasales dan menyimpan respons yang diterima di direktori yang dipindai oleh agen Kinesis. </font><font style="vertical-align: inherit;">Implementasi skrip ini cukup standar, ada kelas TicketsApi, memungkinkan Anda untuk menarik API secara tidak sinkron. </font><font style="vertical-align: inherit;">Di kelas ini, kami meneruskan tajuk dengan token dan parameter permintaan:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menguji pengaturan dan operabilitas agen yang benar, kami akan melakukan uji coba script api_caller.py:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan kami melihat hasil pekerjaan di log Agen dan pada tab Pemantauan dalam aliran data airline_tickets:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda lihat, semuanya berfungsi dan Agen Kinesis berhasil mengirim data ke aliran. </font><font style="vertical-align: inherit;">Sekarang konfigurasikan konsumen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyiapkan Analisis Data Kinesis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita beralih ke komponen utama dari keseluruhan sistem - buat aplikasi baru di Kinesis Data Analytics yang disebut kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analisis Data Kinesis memungkinkan analisis data real-time dari Streaming Kinesis menggunakan SQL. </font><font style="vertical-align: inherit;">Ini adalah layanan yang sepenuhnya dapat diskalakan-otomatis (tidak seperti Kinesis Streams), yang:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda untuk membuat aliran baru (Output Stream) berdasarkan permintaan ke sumber data;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menyediakan aliran dengan kesalahan yang terjadi selama operasi aplikasi (Stream Kesalahan);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara otomatis dapat menentukan skema input data (dapat secara manual didefinisikan ulang jika perlu).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini adalah layanan mahal - 0,11 USD per jam, jadi Anda harus menggunakannya dengan hati-hati dan menghapusnya saat Anda menyelesaikan pekerjaan.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubungkan aplikasi ke sumber data:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pilih aliran yang ingin Anda hubungkan (airline_tickets):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, Anda harus melampirkan Peran IAM baru sehingga aplikasi dapat membaca dari aliran dan menulis ke aliran. </font><font style="vertical-align: inherit;">Untuk melakukan ini, cukup untuk tidak mengubah apa pun di blok izin akses:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami meminta penemuan skema data dalam aliran, untuk ini kami klik pada tombol "Temukan skema". </font><font style="vertical-align: inherit;">Akibatnya, peran IAM akan diperbarui (yang baru akan dibuat) dan penemuan skema dari data yang telah tiba di aliran akan diluncurkan:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang Anda harus pergi ke editor SQL. </font><font style="vertical-align: inherit;">Ketika Anda mengklik tombol ini, sebuah jendela dengan pertanyaan tentang meluncurkan aplikasi akan muncul - pilih apa yang ingin kita jalankan:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di jendela editor SQL, masukkan kueri sederhana seperti itu dan klik Simpan dan Jalankan SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di database relasional, Anda bekerja dengan tabel menggunakan pernyataan INSERT untuk menambahkan catatan dan pernyataan SELECT untuk meminta data. </font><font style="vertical-align: inherit;">Di Amazon Kinesis Data Analytics, Anda bekerja dengan stream (STREAM) dan "pompa" (PUMP) - permintaan penyisipan berkelanjutan yang memasukkan data dari satu aliran dalam aplikasi ke aliran lain.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kueri SQL di atas, tiket Aeroflot dicari dengan harga di bawah lima ribu rubel. </font><font style="vertical-align: inherit;">Semua catatan yang termasuk dalam kondisi ini akan ditempatkan dalam aliran DESTINATION_SQL_STREAM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di blok Tujuan, pilih aliran special_stream, dan dalam nama aliran dalam aplikasi DESTINATION_SQL_STREAM daftar turun bawah:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai hasil dari semua manipulasi, sesuatu yang mirip dengan gambar di bawah ini akan berubah:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat dan berlangganan topik SNS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buka Layanan Pemberitahuan Sederhana dan buat topik baru bernama Maskapai:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami berlangganan topik ini, di dalamnya kami menunjukkan nomor ponsel yang akan menerima pemberitahuan SMS:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat tabel di DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyimpan data mentah dari stream airline_tickets mereka, buat tabel di DynamoDB dengan nama yang sama. </font><font style="vertical-align: inherit;">Sebagai kunci utama, kami akan menggunakan record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat fungsi kolektor lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita membuat fungsi lambda yang disebut Collector, yang tugasnya adalah polling stream airline_tickets dan, jika ada catatan baru di sana, masukkan catatan ini ke dalam tabel DynamoDB. </font><font style="vertical-align: inherit;">Jelas, selain hak default, lambda ini harus memiliki akses untuk membaca aliran data Kinesis dan menulis ke DynamoDB.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat peran IAM untuk fungsi kolektor lambda</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lambda ini harus dipicu oleh pemicu Kinesis ketika entri baru mengenai aliran airline_stream, jadi Anda perlu menambahkan pemicu baru:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetap memasukkan kode dan menyimpan lambda.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat notifikasi fungsi lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsi lambda kedua, yang akan memantau aliran kedua (special_stream) dan mengirim pemberitahuan ke SNS, dibuat dengan cara yang sama. </font><font style="vertical-align: inherit;">Oleh karena itu, lambda ini harus memiliki akses baca dari Kinesis dan mengirim pesan ke topik SNS yang ditentukan, yang kemudian dikirim oleh layanan SNS ke semua pelanggan topik ini (email, SMS, dll.).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat Peran IAM</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lambda ini harus bekerja sesuai dengan pemicu untuk entri baru untuk memasuki special_stream, jadi Anda perlu mengkonfigurasi pemicu dengan cara yang sama seperti yang kami lakukan untuk lambda Kolektor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk kenyamanan mengkonfigurasi lambda ini, kami memperkenalkan variabel lingkungan baru - TOPIC_ARN, tempat kami menempatkan topik ANR (Amazon Recourse Names) dari Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan masukkan kode lambda, sangat sederhana:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya ini melengkapi konfigurasi sistem manual. </font><font style="vertical-align: inherit;">Tetap hanya untuk menguji dan memastikan bahwa kami mengkonfigurasi semuanya dengan benar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyebarkan dari kode Terraform</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persiapan yang diperlukan</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah alat open-source yang sangat nyaman untuk menyebarkan infrastruktur dari kode. </font><font style="vertical-align: inherit;">Ini memiliki sintaksnya sendiri yang mudah dipelajari dan banyak contoh tentang bagaimana dan apa yang harus digunakan. </font><font style="vertical-align: inherit;">Ada banyak plugin yang nyaman di editor Atom atau Visual Studio Code yang membuatnya lebih mudah untuk bekerja dengan Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat mengunduh kit distribusi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Analisis terperinci dari semua fitur Terraform berada di luar cakupan artikel ini, jadi kami akan membatasi diri pada poin utama.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana memulainya</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode proyek lengkap ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di repositori saya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kami mengkloning repositori ke diri kami sendiri. </font><font style="vertical-align: inherit;">Sebelum memulai, Anda harus memastikan bahwa Anda telah menginstal dan mengkonfigurasi AWS CLI, sebagai </font><font style="vertical-align: inherit;">Terraform akan mencari kredensial di file ~ / .aw / credentials. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merupakan praktik yang baik untuk mengerahkan seluruh infrastruktur sebelum meluncurkan perintah rencana untuk melihat apa yang Terraform ciptakan bagi kita di cloud:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda akan diminta memasukkan nomor telepon untuk mengirim pemberitahuan. </font><font style="vertical-align: inherit;">Pada tahap ini, itu opsional.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menganalisis rencana kerja program, kami dapat memulai pembuatan sumber daya:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mengirim perintah ini, Anda akan kembali diminta untuk memasukkan nomor telepon, ketik "ya" ketika pertanyaan tentang pelaksanaan tindakan yang sebenarnya ditampilkan. </font><font style="vertical-align: inherit;">Ini akan memungkinkan Anda untuk meningkatkan seluruh infrastruktur, melakukan semua pengaturan yang diperlukan untuk EC2, menyebarkan fungsi lambda, dll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah semua sumber daya berhasil dibuat melalui kode Terraform, Anda perlu masuk ke detail aplikasi Kinesis Analytics (sayangnya, saya tidak menemukan cara melakukan ini langsung dari kode). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luncurkan aplikasi:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah itu, Anda harus secara eksplisit mengatur nama aliran dalam aplikasi dengan memilih dari daftar turun bawah:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang semuanya sudah siap.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengujian Aplikasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari bagaimana Anda menggunakan sistem, secara manual atau melalui kode Terraform, itu akan bekerja sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melewati SSH ke mesin virtual EC2 tempat Agen Kinesis diinstal dan menjalankan skrip api_caller.py</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetap menunggu SMS ke nomor Anda: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS - pesan tiba di telepon dalam hampir 1 menit: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masih harus dilihat apakah catatan disimpan dalam database DynamoDB untuk analisis selanjutnya yang lebih terperinci. </font><font style="vertical-align: inherit;">Tabel airline_tickets berisi sesuatu seperti ini:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam proses pengerjaan, sistem pemrosesan data online berbasis Amazon Kinesis dibangun. </font><font style="vertical-align: inherit;">Kami memeriksa opsi untuk menggunakan Agen Kinesis dalam hubungannya dengan Streaming Data Kinesis dan analitik real-time dari Kinesis Analytics menggunakan perintah SQL, serta interaksi Amazon Kinesis dengan layanan AWS lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menggunakan sistem di atas dalam dua cara: manual yang cukup panjang dan cepat dari kode Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seluruh kode sumber proyek tersedia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di repositori saya di GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , saya sarankan Anda membiasakan diri dengannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya siap membahas artikel ini dengan senang hati, saya menunggu komentar Anda. </font><font style="vertical-align: inherit;">Saya berharap kritik yang membangun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semoga tercapai!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id500364/index.html">Memperluas portal pembelajaran sekolah di Moodle dan BigBlueButton</a></li>
<li><a href="../id500368/index.html">Menghasilkan urutan acak yang dapat diprediksi: pendekatan permutasi yang berbeda</a></li>
<li><a href="../id500370/index.html">10 podcast berbahasa Inggris yang berguna untuk programmer yang layak berlangganan pada tahun 2020</a></li>
<li><a href="../id500378/index.html">Pencarian informasi yang efektif di tempat kerja</a></li>
<li><a href="../id500380/index.html">Memproses data pribadi dari jarak jauh: risiko dan kemungkinan konsekuensi</a></li>
<li><a href="../id500384/index.html">Pixar Studio Pioneers Menerima Penghargaan Turing dan $ 1 Juta</a></li>
<li><a href="../id500386/index.html">Mengadaptasi solusi bisnis Anda yang sudah ada untuk SwiftUI. Bagian 2</a></li>
<li><a href="../id500390/index.html">Model aktualisasi lokalisasi bahasa di bidang IT dan komunikasi digital. Bagian 1</a></li>
<li><a href="../id500396/index.html">Masalah sistem kontrol akses otonom - Di mana mereka tidak mengharapkan</a></li>
<li><a href="../id500398/index.html">Remote Marathon Week 3: Proses Tidak Aktif</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>