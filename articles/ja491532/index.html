<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🌾 🙆🏻 🤹🏾 Laravel + Docker + Gitlab。どこから始めるか 🕴🏾 😽 🦔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私はいつもDockerなしでいつもやっていて、Dockerは大企業の大規模なプロジェクトにのみ必要だと思っていました。しかし、ある日、Dockerが友人のgitlabと連携して動作する様子を見て、まだ研究する必要があることに気付きました。しかし、いつものように、適切な記事は1つも見つかりませんでした...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Laravel + Docker + Gitlab。どこから始めるか</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491532/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はいつもDockerなしでいつもやっていて、Dockerは大企業の大規模なプロジェクトにのみ必要だと思っていました。</font><font style="vertical-align: inherit;">しかし、ある日、Dockerが友人のgitlabと連携して動作する様子を見て、まだ研究する必要があることに気付きました。</font><font style="vertical-align: inherit;">しかし、いつものように、適切な記事は1つも見つかりませんでした。それらの記事は複雑すぎるか、不完全であるか、またはあなた自身がすべて知っていることを暗示していました。</font><font style="vertical-align: inherit;">私は長い間、さまざまなソースを探し、それらをすべてまとめる必要があり、最終的には簡単なプロジェクトとそのためのCI / CDを作成することができました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての作業は、ローカルマシン、ヒットラボ、サーバーの3つの部分に分けることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、プロジェクトの実装には、gitlabアカウントと、KVMまたはXEN仮想化を備えたリモートサーバーが必要です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1.ローカルマシン</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルマシンにdockerをインストールする必要があります。 </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント</font></font></b><div class="spoiler_text">  . Docker     Linux  ( Ubuntu, ),    Windows  MacOS.   macos     ,     Windows      .   - ,        linux .   - ,           .       VirtualBox.          Ubuntu     <br>
</div></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linux環境にインストールするには、次のコマンドを実行する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古いコンテナを削除します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get remove docker docker-engine docker.io containerd runc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aptを更新します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
https経由でリポジトリからdockerをダウンロードできるように、次のパッケージをインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install \<font></font>
    apt-transport-https \<font></font>
    ca-certificates \<font></font>
    curl \<font></font>
    gnupg-agent \<font></font>
    software-properties-common</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
公式のGPG Dockerキーを追加します。</font></font><br>
<br>
<pre><code class="bash hljs">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
印刷が正しいことを確認してください：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-key fingerprint 0EBFCD88</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答：</font></font><br>
<br>
<pre><code class="bash hljs">pub   rsa4096 2017-02-22 [SCEA]<font></font>
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88<font></font>
uid           [ unknown] Docker Release (CE deb) &lt;docker@docker.com&gt;<font></font>
sub   rsa4096 2017-02-22 [S]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
安定版をダウンロード：</font></font><br>
<br>
<pre><code class="bash hljs">sudo add-apt-repository \
   <span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="hljs-subst">$(lsb_release -cs)</span> \
   stable"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aptをもう一度更新します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最新のDockerエンジンをインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install docker-ce docker-ce-cli containerd.io</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerの動作を確認します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker run hello-world</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが正しければ、Hello Worldイメージのダウンロードが開始されます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerの公式ドキュメントの完全な手順</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-composeもインストールする必要があります。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式指示はこちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールするには、ターミナルでコマンドを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリからダウンロード：</font></font><br>
<br>
<pre><code class="bash hljs">sudo curl -L <span class="hljs-string">"https://github.com/docker/compose/releases/download/1.25.4/docker-compose-<span class="hljs-subst">$(uname -s)</span>-<span class="hljs-subst">$(uname -m)</span>"</span> -o /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
権利行使を追加する：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョンチェック：</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker-compose --version</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerをインストールしました。ここで、イメージを収集する必要があります。</font><font style="vertical-align: inherit;">これを行うために、私はdigitalocean Webサイト（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.digitalocean.com/community/tutorials/how-to-set-up-laravel-nginx-and-mysql-with-docker-compose-ru）の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事を使用しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この記事の転載があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laravelのダウンロードと依存関係のインストール</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最初のステップでは、Laravelの最新バージョンをダウンロードし、アプリケーションレベルのPHPパッケージマネージャーであるComposerを含むプロジェクトの依存関係をインストールします。</font><font style="vertical-align: inherit;">Composerのグローバルインストールを実行しないように、Dockerを使用してこれらの依存関係をインストールします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホームディレクトリに移動し、Laravelの最新バージョンをlaravel-appというディレクトリに複製します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~<font></font>
git <span class="hljs-built_in">clone</span> https://github.com/laravel/laravel.git laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
laravel-appディレクトリに移動します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、DockerのcomposerイメージをLaravelプロジェクトに必要なディレクトリにマウントして、Composerをグローバルにインストールするオーバーヘッドを回避します。</font></font><br>
<br>
<pre><code class="bash hljs">docker run --rm -v $(<span class="hljs-built_in">pwd</span>):/app composer install</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker runコマンドの-vおよび--rmフラグは、削除されるまで現在のディレクトリにバインドする仮想コンテナーを作成します。</font><font style="vertical-align: inherit;">〜/ laravel-appディレクトリのコンテンツがコンテナーにコピーされ、ベンダーフォルダーコンテナー内に作成されたComposerのコンテンツが現在のディレクトリにコピーされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論として、root権限を持たないユーザーが所有できるように、プロジェクトディレクトリに権限レベルを設定します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、アプリケーションのイメージ用のDockerfileを作成するときに重要になります。これにより、アプリケーションコードを操作したり、ルート権限なしでコンテナー内のプロセスを開始したりできるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでアプリケーションコードが配置され、Docker Composeを使用してサービスの定義に進むことができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Composeファイルの作成Docker Composeを</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
使用してアプリケーションを構築すると、インフラストラクチャの構成とバージョン管理のプロセスが簡素化されます。 Laravelアプリケーションをカスタマイズするには、Webサーバーサービス、データベース、アプリケーションの定義を含むdocker-composeファイルを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルを開きます。</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/docker-compose.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-composeファイルには、app、webserver、dbの3つのサービスが定義されています。</font><font style="vertical-align: inherit;">次のコードをファイルに追加し、dbサービス環境変数として定義されているMYSQL_ROOT_PASSWORDのルートパスワードを任意のパスワードに置き換えます。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">version: '3'<font></font>
services:<font></font>
<font></font>
  #PHP Service<font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #Nginx Service<font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "80:80"<font></font>
      - "443:443"<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #MySQL Service<font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "3306:3306"<font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
#Docker Networks<font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここには次のサービスが含まれています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app：このサービス定義にはLaravelアプリケーションが含まれており、パーソナライズされたDockerイメージ、digitalocean.com / phpを起動します。</font><font style="vertical-align: inherit;">また、コンテナーのworking_dirパラメーターを/ var / wwwに設定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webserver：このサービス定義は、Dockerからnginx：alpineイメージを取得し、ポート80と443を開きます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">db：このサービス定義は、Dockerからmysql：5.7.22イメージを取得し、アプリケーションのlaravelデータベースやデータベースのrootパスワードなど、新しい環境変数を定義します。</font><font style="vertical-align: inherit;">任意のデータベース名を使用できます。your_mysql_root_passwordも独自の強力なパスワードに置き換える必要があります。</font><font style="vertical-align: inherit;">このサービス定義は、ホストポート3306をコンテナポート3306にもマップします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各container_nameプロパティは、サービス名に対応するコンテナ名を定義します。</font><font style="vertical-align: inherit;">このプロパティを定義しない場合、Dockerは各コンテナに、下線で区切られた歴史上の人物の名前とランダムな単語で構成される名前を付けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナー間の相互作用を単純化するために、サービスはapp-networkと呼ばれる接続ネットワークに接続します。接続ネットワークは、このネットワークに接続されたコンテナが互いに通信できるようにするソフトウェアブリッジを使用します。ブリッジドライバーはホストルールを自動的に設定して、異なる接続ネットワーク上のコンテナーが互いに直接通信できないようにします。これにより、関連するサービスのみが相互に通信できるため、アプリケーションのセキュリティが向上します。また、関連する機能に接続するさまざまなネットワークやサービスを指定できることも意味します。たとえば、クライアントアプリケーションサービスはフロントエンドネットワークを使用でき、サーバーサービスはバックエンドネットワークを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ボリュームを追加し、マウントされたイメージをサービス定義にバインドして、アプリケーションデータを永続的に保存する方法を見てみましょう。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">永続的なデータストレージ</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dockerには、永続的なデータストレージのための強力で便利な手段があります。</font><font style="vertical-align: inherit;">このアプリケーションでは、ボリュームとマウントされたイメージを使用して、データベースファイル、アプリケーション、および構成を永続的に保存します。</font><font style="vertical-align: inherit;">ボリュームは、コンテナーのライフサイクルの終了時にバックアップの柔軟性と保存を提供し、マウント可能なマウント可能なイメージは、コンテナー内のホストファイルまたはディレクトリへの変更を即座に反映することにより、開発中のコード変更を簡素化します。</font><font style="vertical-align: inherit;">両方のオプションを使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告！</font></font></b><div class="spoiler_text">             ,   ,        .      ,       Docker   .       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLデータベースを永続化するには、dbサービス定義のdocker-composeファイルでdbdataという名前のボリュームを定義します。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dbdataという名前のボリュームは、コンテナ内の/ var / lib / mysqlフォルダーの内容を永続的に保存するために使用されます。</font><font style="vertical-align: inherit;">これにより、データを失うことなく、dbサービスを停止して再起動できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルの最後にdbdataボリューム定義を追加します。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#Volumes<font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: local</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この定義により、このボリュームをさまざまなサービスに使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、MySQL構成ファイルのdbサービスにマウントイメージバインディングを追加します。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このマウントされたイメージは、〜/ laravel-app / mysql / my.cnfファイルをコンテナ内の/etc/mysql/my.cnfディレクトリにバインドします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、マウントされたイメージをWebサーバーサービスに追加します。</font><font style="vertical-align: inherit;">2つあります。1つはアプリケーションコード用、もう1つはNginx構成を決定するためのものです。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#Nginx Service<font></font>
webserver:<font></font>
  ...<font></font>
  volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
  networks:<font></font>
      - app-network</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にマウントされたイメージは、〜/ laravel-appディレクトリのアプリケーションコードをコンテナ内の/ var / wwwディレクトリにバインドします。 〜/ laravel-app / nginx / conf.d /に追加された設定ファイルは、コンテナの/etc/nginx/conf.d/にもマウントされ、必要に応じて設定ディレクトリのコンテンツを追加および変更できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論として、次のマウントされたイメージのマウントを、アプリケーションコードと構成ファイルのアプリサービスに追加します。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#PHP Service<font></font>
app:<font></font>
  ...<font></font>
  volumes:<font></font>
       - ./:/var/www<font></font>
       - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini<font></font>
  networks:<font></font>
      - app-network<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
appサービスは、アプリケーションコードを含む〜/ laravel-appフォルダーのマウントされたイメージを/ var / wwwフォルダーにバインドします。これにより、ローカルアプリケーションディレクトリの変更がコンテナにすぐに反映されるため、開発プロセスがスピードアップします。また、PHP構成ファイル〜/ laravel-app / php / local.iniをコンテナー内の/usr/local/etc/php/conf.d/local.iniファイルにリンクします。後で、ローカルPHP構成ファイルを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-composeファイルは次のようになります。</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="bash hljs">version: <span class="hljs-string">'3'</span><font></font>
services:<font></font>
<font></font>
  <span class="hljs-comment">#PHP Service</span><font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./php/local.ini:/usr/<span class="hljs-built_in">local</span>/etc/php/conf.d/local.ini<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#Nginx Service</span><font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"80:80"</span>
      - <span class="hljs-string">"443:443"</span><font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#MySQL Service</span><font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"3306:3306"</span><font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql/<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
<span class="hljs-comment">#Docker Networks</span><font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge<font></font>
<span class="hljs-comment">#Volumes</span><font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: <span class="hljs-built_in">local</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfileの作成</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dockerでは、Dockerfileを使用して個々のコンテナー内の環境を定義できます。</font><font style="vertical-align: inherit;">Dockerfileを使用すると、パーソナライズされたイメージを作成できます。</font><font style="vertical-align: inherit;">必要なアプリケーションソフトウェアをインストールし、必要に応じて設定を変更するために使用できます。</font><font style="vertical-align: inherit;">作成したイメージをDocker Hubまたは任意のプライベートレジストリに転送できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerfileは〜/ laravel-appディレクトリにあります。</font><font style="vertical-align: inherit;">ファイルを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/Dockerfile</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このDockerfileは、ベースイメージと、Laravelアプリケーションイメージをビルドするために必要なコマンドと指示を指定します。</font><font style="vertical-align: inherit;">次のコードをファイルに追加します。</font></font><br>
<br>
<code>~/laravel-app/php/Dockerfile</code><br>
<br>
<pre><code class="xml hljs">FROM php:7.2-fpm<font></font>
<font></font>
# Copy composer.lock and composer.json<font></font>
COPY composer.lock composer.json /var/www/<font></font>
<font></font>
# Set working directory<font></font>
WORKDIR /var/www<font></font>
<font></font>
# Install dependencies<font></font>
RUN apt-get update &amp;&amp; apt-get install -y \<font></font>
    build-essential \<font></font>
    mysql-client \<font></font>
    libpng-dev \<font></font>
    libjpeg62-turbo-dev \<font></font>
    libfreetype6-dev \<font></font>
    locales \<font></font>
    zip \<font></font>
    jpegoptim optipng pngquant gifsicle \<font></font>
    vim \<font></font>
    unzip \<font></font>
    git \<font></font>
    curl<font></font>
<font></font>
# Clear cache<font></font>
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*<font></font>
<font></font>
# Install extensions<font></font>
RUN docker-php-ext-install pdo_mysql mbstring zip exif pcntl<font></font>
RUN docker-php-ext-configure gd --with-gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/<font></font>
RUN docker-php-ext-install gd<font></font>
<font></font>
# Install composer<font></font>
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer<font></font>
<font></font>
# Add user for laravel application<font></font>
RUN groupadd -g 1000 www<font></font>
RUN useradd -u 1000 -ms /bin/bash -g www www<font></font>
<font></font>
# Copy existing application directory contents<font></font>
COPY . /var/www<font></font>
<font></font>
# Copy existing application directory permissions<font></font>
COPY --chown=www:www . /var/www<font></font>
<font></font>
# Change current user to www<font></font>
USER www<font></font>
<font></font>
# Expose port 9000 and start php-fpm server<font></font>
EXPOSE 9000<font></font>
CMD ["php-fpm"]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、Dockerfileはphp：7.2-fpm Dockerイメージの上にイメージを作成します。これは、PHP FastCGI PHP-FPMのインストール済みインスタンスに基づくイメージです。このファイルは、Laravelに必要なパッケージ（mcrypt、pdo_mysql、mbstring、およびimagick with composer）もインストールします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RUNディレクティブは、専用ユーザーとwwwというグループを含む、コンテナー内のパラメーターを更新、インストール、および構成するためのコマンドを指定します。 WORKDIRステートメントは、ディレクトリ/ var / wwwをアプリケーションの作業ディレクトリとして設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセス権が制限された個別のユーザーとグループを作成すると、デフォルトでルート権限で実行されるDockerコンテナーを起動する際の脆弱性が軽減されます。このコンテナーをroot特権で実行する代わりに、-chownフラグを指定したCOPYコマンドを使用して、/ var / wwwフォルダーに対する読み取りおよび書き込み権限を持つwwwユーザーを作成し、アプリケーションフォルダーの権限をコピーしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EXPOSEコマンドは、php-fpmサーバーのコンテナーでポート9000を開きます。 CMDは、コンテナーの作成後に実行する必要があるコマンドを示します。ここで、CMDはサーバーを起動するphp-fpmコマンドを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更が完了したら、ファイルを保存してエディターを閉じます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、PHP構成の定義に進むことができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPのセットアップ</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-composeファイルでインフラストラクチャを定義しました。これで、着信NginxリクエストのPHPプロセッサとして機能するようにPHPサービスを構成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPを構成するには、phpフォルダーにlocal.iniファイルを作成します。</font><font style="vertical-align: inherit;">これは、上記のコンテナの/usr/local/etc/php/conf.d/local.iniファイルにリンクしたファイルです。</font><font style="vertical-align: inherit;">このファイルを作成すると、PHPが起動時に読み取るデフォルトのphp.iniファイルを無視できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
phpディレクトリを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、local.iniファイルを開きます。</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/php/local.ini</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHPの設定を示すために、次のコードを追加して、ファイルのアップロードサイズの制限を設定します。</font></font><br>
<br>
<code>~/laravel-app/php/local.ini</code><br>
<br>
<pre><code class="xml hljs">upload_max_filesize=40M<font></font>
post_max_size=40M</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
upload_max_filesizeおよびpost_max_sizeディレクティブは、アップロードされるファイルの最大許容サイズを設定し、local.iniファイルからphp.ini構成を設定する方法を示します。無視する任意のPHP構成パラメーターをlocal.iniファイルに挿入できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginxの</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
構成PHPサービスを構成するときに、動的コンテンツを提供するFastCGIサーバーとしてPHP-FPMを使用するようにNginxサービスを変更できます。 FastCGIサーバーは、対話型プログラムとWebサーバーとの相互作用のためのバイナリプロトコルに基づいています。追加情報は、記事「NginxでのFastCGIプロキシの理解と実装」にあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nginxを構成するには、〜/ laravel-app / nginx / conf.d /フォルダーにサービス構成を含むapp.confファイルを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にnginx / conf.d /ディレクトリを作成します：</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p ~/laravel-app/nginx/conf.d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、app.conf構成ファイルを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/nginx/conf.d/app.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードをファイルに追加して、Nginxを構成します。</font></font><br>
<br>
<code>~/laravel-app/nginx/conf.d/app.conf</code><br>
<br>
<pre><code class="xml hljs">server {<font></font>
    listen 80;<font></font>
    index index.php index.html;<font></font>
    error_log  /var/log/nginx/error.log;<font></font>
    access_log /var/log/nginx/access.log;<font></font>
    root /var/www/public;<font></font>
    location ~ \.php$ {<font></font>
        try_files $uri =404;<font></font>
        fastcgi_split_path_info ^(.+\.php)(/.+)$;<font></font>
        fastcgi_pass app:9000;<font></font>
        fastcgi_index index.php;<font></font>
        include fastcgi_params;<font></font>
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<font></font>
        fastcgi_param PATH_INFO $fastcgi_path_info;<font></font>
    }<font></font>
    location / {<font></font>
        try_files $uri $uri/ /index.php?$query_string;<font></font>
        gzip_static on;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーブロックは、次のディレクティブを使用してNginx Webサーバーを構成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listen：このディレクティブは、サーバーが着信要求をlistenするポートを定義します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error_logおよびaccess_log：これらのディレクティブは、ロギング用のファイルを定義します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root：このディレクティブは、ルートフォルダーへのパスを設定し、ローカルファイルシステム内の要求されたファイルの完全パスを形成します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
phpロケーションブロックのfastcgi_passディレクティブは、アプリサービスがポート9000のTCPソケットをリッスンしていることを示します。これを使用すると、PHP-FPMサーバーはUnixソケットではなくネットワークをリッスンします。 Unixソケットは、TCPソケットよりも速度がわずかに優れていますが、ネットワークプロトコルがなく、ネットワークスタックをスキップします。ホストが同じシステム上にある場合、Unixソケットを使用することは意味がありますが、サービスが異なるホスト上で実行されている場合、TCPソケットは分散サービスに接続できるため、利点があります。アプリとWebサーバーのコンテナーは異なるホストで実行されるため、構成でTCPソケットを使用する方が効率的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更が完了したら、ファイルを保存してエディターを閉じます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前に作成されたバインディングのおかげで、nginx / conf.d /フォルダー内の変更はWebサーバーコンテナーに直接反映されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、MySQLパラメータを見てみましょう。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQLの</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
設定PHPとNginxを設定したら、MySQLをアプリケーションのデータベースとしてアクティブ化できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLを設定するには、mysqlフォルダにmy.cnfファイルを作成する必要があります。</font><font style="vertical-align: inherit;">これは、データベース構成ステップ中にコンテナー内の/etc/mysql/my.cnfファイルに添付したファイルです。</font><font style="vertical-align: inherit;">マウントされたイメージをマウントすると、必要に応じてmy.cnfオプションを無視できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがどのように機能するかを示すために、一般的なリクエストログを含む設定をmy.cnfに追加し、ログファイルを設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysqlディレクトリを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
my.cnfファイルを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードをファイルに追加して、クエリログをアクティブにし、ログファイルの場所を設定します。</font></font><br>
<br>
<code>~/laravel-app/mysql/my.cnf</code><br>
<br>
<pre><code class="xml hljs">[mysqld]<font></font>
general_log = 1<font></font>
general_log_file = /var/lib/mysql/general.log</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
my.cnfファイルは、general_logパラメーターを1に設定してログをサポートします。これにより、一般ログが有効になります。</font><font style="vertical-align: inherit;">general_log_fileパラメータは、ログが保存される場所を指定します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナーの開始と環境設定の変更</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
すべてのサービスをdocker-composeファイルで定義し、これらのサービスの構成ファイルを作成しました。</font><font style="vertical-align: inherit;">これでコンテナーを実行できます。</font><font style="vertical-align: inherit;">結論として、Laravelがこのようなファイルを使用して環境を決定するため、Laravelがデフォルトで含める.env.exampleファイルのコピーを作成し、それに.envという名前を付けます。</font></font><br>
<br>
<pre><code class="bash hljs">cp .env.example .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナーを起動した後、このファイルで特定のインストールパラメーターを構成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、すべてのサービスがdocker-composeファイルで定義されました。1つのコマンドを実行してすべてのコンテナーを起動し、ボリュームを作成して、ネットワークを構成して接続するだけです。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose up -d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-compose upを初めて起動すると、必要なすべてのDockerイメージがダウンロードされますが、しばらく時間がかかる場合があります。</font><font style="vertical-align: inherit;">画像をダウンロードしてローカルコンピューターに保存した後、Composeはコンテナーを作成します。</font><font style="vertical-align: inherit;">-dフラグは、プロセスをデーモンに変換します。これにより、コンテナーはバックグラウンドで実行されたままになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスが完了したら、次のコマンドを使用して、実行中のすべてのコンテナを一覧表示します。</font></font><br>
<pre><code class="bash hljs">docker ps</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリ、ウェブサーバー、データベースコンテナのデータを使用して、次の結果が表示されます。</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
CONTAINER ID        NAMES               IMAGE                             STATUS              PORTS<font></font>
c31b7b3251e0        db                  mysql:5.7.22                      Up 2 seconds        0.0.0.0:3306-&gt;3306/tcp<font></font>
ed5a69704580        app                 digitalocean.com/php              Up 2 seconds        9000/tcp<font></font>
5ce4ee31d7c0        webserver           nginx:alpine                      Up 2 seconds        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの結果では、CONTAINER IDは各コンテナーの一意の識別子であり、NAMESは各コンテナーのサービス名をリストします。</font><font style="vertical-align: inherit;">これらの識別子の両方を使用してコンテナにアクセスできます。</font><font style="vertical-align: inherit;">IMAGEは各コンテナーのイメージ名を定義し、STATUSはコンテナーの状況（開始済み、再始動済み、または停止済み）に関する情報を提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、アプリコンテナーの.envファイルを変更して、特定のパラメーターをシステムに追加できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-compose execでファイルを開きます。これにより、コンテナーで特定のコマンドを実行できます。</font><font style="vertical-align: inherit;">この場合、ファイルを開いて編集します。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app nano .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DB_CONNECTIONを指定するブロックを見つけ、システム設定を反映するように更新します。</font><font style="vertical-align: inherit;">次のフィールドを変更します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_HOSTは、dbデータベースコンテナーになります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_DATABASEは、laravelデータベースになります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_USERNAMEはデータベースのユーザー名になります。</font><font style="vertical-align: inherit;">この場合、laraveluserを使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_PASSWORDは、このユーザーアカウントに対して保護されたパスワードになります。</font></font></li>
</ol><br>
<code>/var/www/.env</code><br>
<br>
<pre><code class="xml hljs">DB_CONNECTION=mysql<font></font>
DB_HOST=db<font></font>
DB_PORT=3306<font></font>
DB_DATABASE=laravel<font></font>
DB_USERNAME=laraveluser<font></font>
DB_PASSWORD=your_laravel_db_password</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後でサーバーにデプロイするときに使用されるため、.env.exampleファイル内の同じ変数を修正することも必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、php artisan key：generateコマンドを使用して、Laravelのアプリケーションキーを構成します。</font><font style="vertical-align: inherit;">このコマンドは、キーを生成して.envファイルにコピーします。これにより、ユーザーセッションと暗号化されたデータが保護されます。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan key:generate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、アプリケーションを実行するために必要なすべての環境設定が整いました。</font><font style="vertical-align: inherit;">アプリケーションの読み込みを高速化するファイルにこれらの設定をキャッシュするには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan config:cache</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定はコンテナ内の/var/www/bootstrap/cache/config.phpファイルに読み込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、ブラウザーで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイトを開きます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Laravelアプリケーションのメインページが開きます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQLユーザーの作成MySQLを</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
インストールすると、デフォルトでは、データベースサーバーにアクセスするための無制限の権限を持つ管理rootアカウントのみが作成されます。</font><font style="vertical-align: inherit;">通常、データベースを操作するときは、管理者のrootアカウントを使用しないことをお勧めします。</font><font style="vertical-align: inherit;">代わりに、アプリケーションのLaravelデータベース用に特別なデータベースユーザーを作成します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいユーザーを作成するには、docker-compose execコマンドを使用して、dbコンテナーでbashインタラクティブシェルを起動します。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> db bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナー内で、MySQLルート管理アカウントにログインします。</font></font><br>
<br>
<pre><code class="sql hljs">mysql -u root -p</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker-composeファイルにインストールするときに、MySQL rootアカウントに指定されたパスワードを入力するように求められます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、docker-composeファイルで定義されているlaravelデータベースを確認します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
show databasesコマンドを実行して、既存のデータベースを確認します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">show</span> <span class="hljs-keyword">databases</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果には、laravelデータベースが表示されます。</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
+--------------------+<font></font>
| Database           |<font></font>
+--------------------+<font></font>
| information_schema |<font></font>
| laravel            |<font></font>
| mysql              |<font></font>
| performance_schema |<font></font>
| sys                |<font></font>
+--------------------+<font></font>
5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、このデータベースへのアクセスを許可するユーザーアカウントを作成します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、laraveluserユーザー名を使用していますが、任意の名前に置き換えることができます。</font><font style="vertical-align: inherit;">ユーザー名とパスワードが前の手順の.envファイルにあるものと一致することを確認してください。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> laravel.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'laraveluser'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'your_laravel_db_password'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLサーバーに変更を通知する権限を更新します。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLを閉じます。</font></font><br>
<br>
<pre><code class="sql hljs">EXIT;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナを終了します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">exit</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、データベースをテストするための移行を実行できます。</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan migrate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行確認の結果は次のとおりです。</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
<font></font>
Migration table created successfully.<font></font>
Migrating: 2014_10_12_000000_create_users_table<font></font>
Migrated:  2014_10_12_000000_create_users_table<font></font>
Migrating: 2014_10_12_100000_create_password_resets_table<font></font>
Migrated:  2014_10_12_100000_create_password_resets_table</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2. Gitlab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hitlabでは、新しいプロジェクトを作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プロジェクトをhitlabリポジトリに保存する必要があります。</font><font style="vertical-align: inherit;">これを行うには、ローカルマシンのプロジェクトフォルダから次のコマンドを呼び出します。</font></font><br>
<br>
<pre><code class="bash hljs">git init<font></font>
git remote add origin git@gitlab.com:&lt;&gt;/&lt;&gt;  <font></font>
git remote add origin https://gitlab.com/&lt;&gt;/&lt;&gt;      SSH<font></font>
git add .<font></font>
git commit -m <span class="hljs-string">"Initial commit"</span>
git push -u origin master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトは[プロジェクトの概要]-&gt; [詳細]に表示されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成した環境をすぐに取得できるように、環境のDockerイメージをヒットリストレジスタに保存します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、次のことを行う必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">docker login registry.gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてgitlabに画像を投げます：</font></font><br>
<br>
<pre><code class="bash hljs">docker build -t registry.gitlab.com/&lt;&gt;/&lt;&gt; .<font></font>
docker push registry.gitlab.com/&lt;&gt;/&lt;&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イメージはPackages-&gt; Container Registryにあります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。gitlabを終了するには、すぐにgitlab-runnerのキーを取得します。</font><font style="vertical-align: inherit;">これを行うには、設定-&gt; CI / CD-&gt;ランナーに移動します。</font><font style="vertical-align: inherit;">キーは、セクション手動構成（特定のランナーを手動でセットアップする）のステップ3にあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3.サーバー構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPSサーバーは、仮想化タイプKVMまたはXENで使用する必要があります。</font><font style="vertical-align: inherit;">OpenVZのような仮想化は、すべてのユーザー間でシステムのコアを共有するため、カーネルパラメーターを変更する機能はありません。</font><font style="vertical-align: inherit;">テストでは、DockerがプリインストールされたKVMサーバーを使用しました。</font><font style="vertical-align: inherit;">ただし、サーバーにDockerがない場合があります。</font><font style="vertical-align: inherit;">この場合、手動でインストールする必要があります。</font><font style="vertical-align: inherit;">アルゴリズムは、ローカルマシンにインストールする場合と同じです。</font><font style="vertical-align: inherit;">また、phpのバージョンを確認する必要があります。</font><font style="vertical-align: inherit;">Laravelの場合、少なくとも7.2が必要です。</font><font style="vertical-align: inherit;">また、php ext-mbstring（私の場合はphp 7.3）の拡張機能を個別にインストールする必要がありました。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update<font></font>
sudo apt-get install php7.3-mbstring<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、gitlab-runnerをインストールする必要があります。</font><font style="vertical-align: inherit;">ランナーは、新しいバージョンを受け取ったときにヒットラボからのWebhookを受け入れ、すべてをサーバーにデプロイするサービスです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gitlab-runnerをインストールするには、次のことを行う必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">curl -L --output /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダウンロード後、実行権限を設定します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、gitlab-runnerユーザーを作成し、gitlab runnerサービスを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo useradd --comment <span class="hljs-string">'GitLab Runner'</span> --create-home gitlab-runner --shell /bin/bash<font></font>
sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner<font></font>
sudo gitlab-runner start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランナーを登録します。</font><font style="vertical-align: inherit;">これを行うには、この記事のパート2のトークンが必要です。</font></font><br>
<br>
<pre><code class="bash hljs">sudo gitlab-runner register</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
応答として、彼らはあなたのヒットラボのアドレスを尋ねます。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">gitlab.comを</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
指定し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )<font></font>
https://gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、トークンを入力する必要があります。</font><font style="vertical-align: inherit;">パート2のトークンを入力します。</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci token <span class="hljs-keyword">for</span> this runner<font></font>
xxx<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、説明とタグをコンマで区切って指定します。</font><font style="vertical-align: inherit;">次に、実行者を選択するように提案されます。</font><font style="vertical-align: inherit;">ここでは、シェルを選択する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
Please enter the executor:<font></font>
shell</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が理解しているように、エグゼキュータは.gitlab-ci.ymlファイルのコードが実行される環境です。</font><font style="vertical-align: inherit;">bash、ssh、docker、Parallels、virtualbox、kubernetsから選択できます。</font><font style="vertical-align: inherit;">ドキュメントでは、何を使用するかわからない場合はbashを使用することを推奨しています。</font><font style="vertical-align: inherit;">これは、サーバーのコマンドラインで実行される汎用オプションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、gitlab-runnerユーザーをdockerユーザーグループに追加する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">sudo usermod -aG docker gitlab-runner</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセスエラーを回避するには、sudoersに追加します</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/sudoers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライン </font></font><br>
<br>
<pre><code class="bash hljs">gitlab-runner ALL=(ALL) NOPASSWD: ALL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、.gitlab-ci.ymlファイルを作成できます。</font><font style="vertical-align: inherit;">いわゆるパイプラインの実行には、プロジェクトをデプロイするための一連のコマンドが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、ヒットリストのプロジェクトリポジトリに移動し、[新しいファイルの作成]をクリックします。</font><font style="vertical-align: inherit;">Gitlab自身がファイルテンプレートを提供します。その中から.gitlab-ci.ymlを選択する必要があります。</font><font style="vertical-align: inherit;">gitlabでファイルを作成した後、ファイルのコンテンツのテンプレートを選択できます。</font><font style="vertical-align: inherit;">私はlaravelを選択し、自分用に少しやり直しました。</font></font><br>
<br>
<pre><code class="xml hljs"><font></font>
# This file is a template, and might need editing before it works on your project.<font></font>
# Official framework image. Look for the different tagged releases at:<font></font>
# https://hub.docker.com/r/library/php<font></font>
# .    ,        <font></font>
image: registry.gitlab.com/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>:latest<font></font>
<font></font>
# Pick zero or more services to be used on all builds.<font></font>
# Only needed when using a docker container to run your tests in.<font></font>
# Check out: http://docs.gitlab.com/ce/ci/docker/using_docker_images.html#what-is-a-service<font></font>
services:<font></font>
  - mysql:latest<font></font>
#    <font></font>
variables:<font></font>
  MYSQL_DATABASE: laravel<font></font>
  MYSQL_ROOT_PASSWORD: ***********<font></font>
<font></font>
# This folder is cached between builds<font></font>
# ,      <font></font>
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache<font></font>
cache:<font></font>
  paths:<font></font>
    - vendor/<font></font>
    - node_modules/<font></font>
<font></font>
# This is a basic example for a gem or script which doesn't use<font></font>
# services such as redis or postgres<font></font>
#     <font></font>
before_script:<font></font>
  #   <font></font>
  - sudo apt-get update -yqq<font></font>
  #    nodejs<font></font>
  - sudo apt-get install gnupg -yqq<font></font>
  #  Node   12<font></font>
  - curl -sL https://deb.nodesource.com/setup_12.x | sudo bash -<font></font>
  #  <font></font>
  - sudo apt-get install git nodejs libcurl4-gnutls-dev libicu-dev libmcrypt-dev libvpx-dev libjpeg-dev libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq<font></font>
  #  composer<font></font>
  - curl -sS https://getcomposer.org/installer | php<font></font>
  - php composer.phar install<font></font>
  - composer install<font></font>
  #   Node<font></font>
  - npm install<font></font>
  # Copy over testing configuration.<font></font>
  # Don't forget to set the database config in .env.testing correctly<font></font>
  - DB_HOST=mysql<font></font>
  - DB_DATABASE=laravel<font></font>
  - DB_USERNAME=root<font></font>
  - DB_PASSWORD=*********<font></font>
  #  .env.example    .env<font></font>
  - cp .env.example .env<font></font>
  #  npm build<font></font>
  - npm run dev<font></font>
  #       laravel<font></font>
  - php artisan key:generate<font></font>
  - php artisan config:cache<font></font>
  - php artisan route:clear<font></font>
  - php artisan config:clear<font></font>
  - php artisan cache:clear<font></font>
  #  .<font></font>
  - docker-compose exec app php artisan migrate<font></font>
  #   <font></font>
  #- docker-compose exec app php artisan db:seed<font></font>
<font></font>
#<font></font>
test:<font></font>
  script:<font></font>
    #  <font></font>
    - php vendor/bin/phpunit --coverage-text --colors=never<font></font>
    #  npm<font></font>
    - npm test<font></font>
<font></font>
#       <font></font>
deploying:<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - echo "Deployed"<font></font>
    - docker-compose stop<font></font>
    - docker-compose up -d<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーのIPアドレスでパイプライン（CI / CD-&gt; Pipelines）を正常に実行すると、laravelページが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CI / CDを構成するために、私はSean Bradleyからの指示を使用しました：</font></font><br>
<br>
<div class="oembed"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/RV0845KmsNI</font></font></a></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">medium.com/@sean_bradley/auto-devops-with-gitlab-ci-and-docker-compose-f931233f080f</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja491520/index.html">Cでxlsをxlsxとxmlに変換する＃</a></li>
<li><a href="../ja491522/index.html">なぜ女性は長生きするのか</a></li>
<li><a href="../ja491524/index.html">Stas Afanasyev。ジュノ。io.Reader / io.Writerに基づくパイプライン。パート2</a></li>
<li><a href="../ja491528/index.html">私の経験は1000回のインタビューを行っています。Yegor Bugaenkoによるレポートの概要</a></li>
<li><a href="../ja491530/index.html">もう一度約433 MHzの送信機と受信機</a></li>
<li><a href="../ja491534/index.html">GDBの使用に関する簡単なガイド</a></li>
<li><a href="../ja491536/index.html">YouTube-エラー。後でもう一度やり直してください。再生ID：<...></a></li>
<li><a href="../ja491538/index.html">通常の文脈自由言語のためのスプロール巡回補題</a></li>
<li><a href="../ja491540/index.html">初心者ITスペシャリストのためのネットワーク。必須ベース</a></li>
<li><a href="../ja491542/index.html">色変換：テーブル検索の間引き</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>