<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≠ üßúüèº üë©üèø‚Äçüåæ Forensics, SQL injection and long-suffering cat: analysis of task No. 3 of the online stage NeoQUEST-2020 üõ¥ üßóüèæ ‚õÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will consider the most controversial task of NeoQUEST-2020 : its first part is a champion in the number of participants who passed it, and th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Forensics, SQL injection and long-suffering cat: analysis of task No. 3 of the online stage NeoQUEST-2020</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/neobit/blog/495296/"><img src="https://habrastorage.org/webt/gd/oc/8f/gdoc8fvxf7oimhxlgxvmijvuwmk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we will consider the most controversial task of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NeoQUEST-2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : its first part is a champion in the number of participants who passed it, and the second part obeyed only a few. </font><font style="vertical-align: inherit;">What is so special about him? </font><font style="vertical-align: inherit;">Understand the cut!</font></font><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Have you ever had to investigate a RAM dump? Do you know how many interesting things you can get from there? (spoiler: everything, including the results of running scripts, recent photos, as well as browser history). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What about exotic SQL injections? You upload a certain picture to the site, and you are given information from a closed database - is this not an ideal crime? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first part of the article, we will consider the tools for analyzing the memory dump and learn how to extract the information we need from there, and in the second part of the article we will clearly show the process of manipulating image tags for a tricky injection :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the task is to download the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which contains a 1 GB binary file with the speaking name memdump.bin, based on which we can assume that this is a RAM dump. We will use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">volatility framework</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for its research </font><font style="vertical-align: inherit;">. Volatility supports various plugins that make it easy to search and extract from the dump various information useful for </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blackmailing an</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> analyst. First, use the imageinfo command and get information about the dump:</font></font><br>
<cut></cut><br>
<img src="https://habrastorage.org/webt/8b/po/2n/8bpo2nbfia9ykmdpqohz8zt4w0a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Judging by the output of the imageinfo command, we are dealing with a Windows 7 memory dump. Next, we will look at the list of running processes in the system at the time the dump was removed using the pslist command: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/1n/py/ja1npywtltvjjnzwwhbs7mkk1ho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this list, you can see several interesting processes. Let's start the study with the chrome.exe process - you can always find something intriguing in the browser. There are additional plugins for volatility that automate the extraction of information from processes. For example, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chromehistory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plugin </font><font style="vertical-align: inherit;">will allow us to extract a browser visit history from a RAM dump: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lx/oo/o7/lxooo7skzcqwcxf-hw_njv5rmdk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the history of chrome, several interesting things can be noticed at once. First, a link </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the second part of the assignment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as well as search queries about metadata in PNG images, which is also a hint to the second part, but we will turn to this later. At the current stage, we are interested in requests for a promotional code </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a discount</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the site and pdf files, which hints at the object of further searches (running Acrobat Reader`a may also prompt us on this). Let's try to find pdf documents in a dump using the filescan command: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sb/ro/qk/sbroqkdf1jetkddyzac1rhasqh0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good luck! It looks like there is some promo.pdf in the dump. Let's try to pull it using the dumpfiles command:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-w/gn/iz/-wgnizdzvl_kszkhof-z1bldwxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, minor difficulties may arise due to the fact that some pdf-document viewers may not recognize the file just extracted (you just need to delete the extra bytes at the end of the file). But are we really afraid of some extra bytes? :) In the end, open the document and see the QR code, having read which, we get the flag from the first part of the task (and at the same time the promotional code for receiving a gift from the NeoQUEST team - we give memorable prizes all participants who completed at least one assignment!).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/84/od/xp84odjm5frx774wqy9ka75rjws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, try to get the second flag. We return to the site, the link to which was found in the browser history. To access the site you need to enter a promotional code. We recall the search history in the browser and the description of the document itself (USE THIS TO JOIN), from which we can assume that the first flag is the promotional code we need. We enter it into the field and get to the site where we are offered to upload a picture: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n9/kb/vu/n9kbvuleozzylxcgoa2hxy5trhq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Judging by how often the site freezes, our participants decided to experimentally verify the loading of all possible types of documents. A certain amount of time later we understand that only PNG images can be uploaded to the site. The next puzzle is the message ‚ÄúNot enough data to store this image, sorry!‚Äù, Which occurs when you try to upload a picture.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returning to the history of the browser, we recall about requests of the form ‚Äúadd metadata to png file‚Äù. Using simple inferences, we conclude that, most likely, certain values ‚Äã‚Äãmust be entered in the metadata to upload an image to a site. You can start by exploring the PNG format (for a description, for example, click </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). First, check the list of standard keywords for metadata PNG images, for example: "Author", "Description", etc. Using, for example, the convert utility from the ImageMagick set, add metadata to the test image: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
convert test.png -set 'Title' '1' -set 'Author' '2' -set 'Description' '3' -set 'Copyright' '4 '-set' Creation Time '' 5 '-set' Software '' 6 '-set' Disclaimer '' 7 '-set 'Warning' '8' -set 'Source' '9' -set 'Comment' '0' out.png</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We try to upload the resulting image to the site and enjoy the success: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/7o/pw/sa7opwndturwyzaqse9f4qah83g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that the necessary metadata fields are Title, Description, Author and Copyright. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A hint for this, by the way, can also be found in the memory dump: you can find the mention of the mr_cat.png file using volatility. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/bw/cn/ixbwcn3pzw3ndqxlbnfb6btadyk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our participants decided that it was with the help of Mr. Cat that it was necessary to inject the site (a lot of messages came to our mail with Mr. Cat in a compressed, inverted, reflected and other </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsightly</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appearance), but the cat had nothing to do with it! He simply distracts and hints to the participants: well, look at me, there is something interesting inside! Inside the dump, the image was only partially preserved; however, in its residues, you can notice the necessary completed metadata fields:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zv/4h/0o/zv4h0ogsh94higmrsqslbzbxzby.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go ahead: now we can upload files to the site; however, what does it give and how to look for a flag? It is logical to assume that since metadata is required for downloading, it is possible that they are somehow used to store downloaded files (for example, as keys in a database). Hooray! We are approaching the dessert: we need to check the site for the possibility of SQL injection. We find out that if one of the parameters is substituted with a double quote ("), then the site will notify us of an error instead of loading the image:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f7/s2/bf/f7s2bfigyph9mkfj9jfg6wfxhxc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we see the SQL query itself and understand what fields we can operate in order to construct an injection to extract data from the database used. As for the location of the flag, in this case it is logical to check the very first image that has been uploaded to the database. Also, during injection operation, you should pay attention to the fact that INSERT is executed in the request. This forces you to construct specific queries, because you cannot explicitly perform a SELECT operation from the same table into which you are inserting at the same time as the insert operation (INSERT). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let‚Äôs make a request with which we pull out the Description of the first image in the database:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
convert test1.png -set 'Title' '1' -set 'Author' '", (SELECT description FROM (SELECT * FROM picture) AS x limit 0,1)) - -' -set 'Description' '3' - set 'Copyright' '4' test.png </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upload the received image to the website and get the description in the Copyright field, which is a flag: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/k8/6x/vzk86xyosytdwsvc9orcwkypybi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hooray, task completed! We hope that we convinced everyone to double-check user input for the millionth time and also keep it safe apple of your eye from creating a dump of your RAM :) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finish the article with a quote from the great sages:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qg/9i/un/qg9iunp8zncqovjy3_qg990lmlc.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495280/index.html">Max Patrol SIEM. Information Security Event Management System Overview</a></li>
<li><a href="../en495282/index.html">XML validation using XSD, JAXB, and Spring Framework</a></li>
<li><a href="../en495290/index.html">Exploring the code quality of the Zephyr operating system</a></li>
<li><a href="../en495292/index.html">InterSystems IRIS 2020.1 Release</a></li>
<li><a href="../en495294/index.html">Macros for a pythonist. Yandex Report</a></li>
<li><a href="../en495298/index.html">Evaluate Monte Carlo Clojure Options</a></li>
<li><a href="../en495302/index.html">How to increase sales 2.5 times in 4 months in an online store - a case for SEO promotion</a></li>
<li><a href="../en495304/index.html">Rejuvenation of human cells due to their reprogramming</a></li>
<li><a href="../en495308/index.html">Rake on the way to keep-alive</a></li>
<li><a href="../en495310/index.html">Electronic walk-through: biometrics and multi-format</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>