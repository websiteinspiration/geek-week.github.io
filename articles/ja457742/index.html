<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➖ 🤥 🚭 高可用性とインフラストラクチャの可用性のためのKubernetesとPrometheusの炉床の水平方向の自動スケーリング 🏯 🤱🏾 🚬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="敬礼、ハブロバイト！次の記事の翻訳は、Kubernetesベースのインフラストラクチャプラットフォームコースの生徒のために特別に準備されたもので、明日クラスを開始します。始めましょう。
 
 
 
 Kubernetesの自動スケール
 自動スケーリングでは、リソースの使用状況に応じて、ワークロード...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>高可用性とインフラストラクチャの可用性のためのKubernetesとPrometheusの炉床の水平方向の自動スケーリング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/457742/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">敬礼、ハブロバイト！</font><font style="vertical-align: inherit;">次の記事の翻訳は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesベースのインフラストラクチャプラットフォーム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの生徒のために特別に準備されたもので、</font><font style="vertical-align: inherit;">明日クラスを開始します。</font><font style="vertical-align: inherit;">始めましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ex/tr/ly/extrlyzx2l86vdau8i-upyejtf4.png"><br>
<br>
<i><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesの自動スケール</font></font></h3></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動スケーリングでは、リソースの使用状況に応じて、ワークロードを自動的に増減できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes自動スケーリングには次の2つの次元があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノードのスケーリングを担当するクラスターオートスケーラー。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">水平ポッドオートスケーラー（HPA）。デプロイメントまたはレプリカセットのハースの数を自動的にスケーリングします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスター自動スケーリングを水平ハース自動スケーリングと組み合わせて使用​​すると、コンピューティングリソースと、サービスレベル契約（SLA）に準拠するために必要なシステム並列処理の度合いを動的に制御できます。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターの自動スケーリングは、クラスターをホストしているクラウドインフラストラクチャプロバイダーの機能に大きく依存しており、HPAはIaaS / PaaSプロバイダーから独立して動作できます。</font></font><br>
<br>
<i><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HPA開発</font></font></h3></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
水平ハースの自動スケーリングは、Kubernetes v1.1の導入以降、大幅に変更されました。 HPAの最初のバージョンは、測定されたCPU消費に基づいてハースをスケーリングし、後でメモリ使用量に基づいてスケーリングしました。 Kubernetes 1.6では、カスタムメトリックと呼ばれる新しいAPIが導入され、HPAがカスタムメトリックにアクセスできるようになりました。 Kubernetes 1.7は、サードパーティアプリケーションがAPIアドオンとして登録することでKubernetes APIを拡張できるようにする集計レベルを追加しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムメトリックAPIと集約レベルのおかげで、Prometheusなどのモニタリングシステムは、アプリケーション固有のメトリックをHPAコントローラーに提供できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
水平ハースの自動スケーリングは、CPUやメモリの使用状況などの主要なメトリックについてResource Metrics API（リソースメトリックAPI）を定期的にクエリする制御ループとして実装され、特定のアプリケーションメトリックについてはCustom Metrics API（カスタムメトリックAPI）を実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j3/7c/-b/j37c-bs-leoz4u_a8tg6ov6zflu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、Kubernetes 1.9以降用にHPA v2を構成するためのステップバイステップガイドです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要なメトリックを提供するMetrics Serverアドインをインストールします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモアプリケーションを実行して、CPUとメモリの使用量に基づいてハースの自動スケーリングがどのように機能するかを確認します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrometheusおよびカスタムAPIサーバーをデプロイします。</font><font style="vertical-align: inherit;">集約レベルでカスタムAPIサーバーを登録します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモアプリケーションによって提供されるカスタムメトリックを使用してHPAを構成します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 始める前に、あなたが行くのバージョン1.8（またはそれ以降）をインストールする必要がありますし、クローン</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">K8S-ウエディング-HPAリポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へ&nbsp; </font></font><code>GOPATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="go hljs">cd $GOPATH<font></font>
git clone https:<span class="hljs-comment">//github.com/stefanprodan/k8s-prom-hpa</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Metricsサーバーのセットアップ</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Metric</font></a><font style="vertical-align: inherit;"> Serverは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heapsterに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代わるクラスター内リソース使用率データアグリゲーターです&nbsp; </font><font style="vertical-align: inherit;">。メトリックサーバーは、ノードとハースのCPUとメモリの使用情報をから収集します&nbsp; </font></font><code>kubernetes.summary_api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。概要APIは、Kubelet / cAdvisorデータメトリックをサーバーに転送するためのメモリ効率の高いAPIです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a-/ks/a5/a-ksa5k66aqr8auak_onalu3jki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HPAの最初のバージョンでは、CPUとメモリを取得するためにHeapsterアグリゲーターが必要でした。 HPA v2およびKubernetes 1.8では、有効になっているMetricsサーバーのみが必要です</font></font><code>horizontal-pod-autoscaler-use-rest-clients</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このオプションは、Kubernetes 1.9ではデフォルトで有効になっています。 GKE 1.9には、メトリックサーバーがプリインストールされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前空間にMetric Serverをデプロイします&nbsp; </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./metrics-server</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1分後&nbsp; </font></font><code>metric-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;、ノードとポッドによるCPUとメモリの使用に関するデータの送信が開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードメトリックを表示します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get --raw <span class="hljs-string">"/apis/metrics.k8s.io/v1beta1/nodes"</span> | jq .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
心拍数インジケーターを表示します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get --raw <span class="hljs-string">"/apis/metrics.k8s.io/v1beta1/pods"</span> | jq .</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. CPUとメモリの使用量に基づく自動スケーリング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハース水平自動スケーリング（HPA）のテストには、小さなGolangベースのWebアプリケーションを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
展開&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">podinfo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;名前空間に&nbsp; </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./podinfo/podinfo-svc.yaml,./podinfo/podinfo-dep.yaml</code></pre><br><font style="vertical-align: inherit;"></font><code>podinfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;のNodePortサービスの使用を</font><font style="vertical-align: inherit;">
参照し</font><font style="vertical-align: inherit;">て&nbsp; </font><font style="vertical-align: inherit;">ください&nbsp; </font></font><code>http://&lt;K8S_PUBLIC_IP&gt;:31198</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
平均CPU使用率が80％を超える場合、またはメモリ消費量が200 MiBを超える場合は、少なくとも2つのレプリカを提供し、10のレプリカにスケーリングするHPAを指定します。</font></font><br>
<br>
<pre><code class="go hljs">apiVersion: autoscaling/v2beta1<font></font>
kind: HorizontalPodAutoscaler<font></font>
metadata:<font></font>
  name: podinfo<font></font>
spec:<font></font>
  scaleTargetRef:<font></font>
    apiVersion: extensions/v1beta1<font></font>
    kind: Deployment<font></font>
    name: podinfo<font></font>
  minReplicas: <span class="hljs-number">2</span>
  maxReplicas: <span class="hljs-number">10</span><font></font>
  metrics:<font></font>
  - <span class="hljs-keyword">type</span>: Resource<font></font>
    resource:<font></font>
      name: cpu<font></font>
      targetAverageUtilization: <span class="hljs-number">80</span>
  - <span class="hljs-keyword">type</span>: Resource<font></font>
    resource:<font></font>
      name: memory<font></font>
      targetAverageValue: <span class="hljs-number">200</span>Mi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HPAを作成します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./podinfo/podinfo-hpa.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数秒後、HPAコントローラーはMetric Serverに接続し、CPUおよびメモリーの使用状況に関する情報を受け取ります。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get hpa<font></font>
NAME      REFERENCE            TARGETS                      MINPODS   MAXPODS   REPLICAS   AGE<font></font>
podinfo   Deployment/podinfo   <span class="hljs-number">2826240</span> / <span class="hljs-number">200</span>Mi, <span class="hljs-number">15</span>% / <span class="hljs-number">80</span>%   <span class="hljs-number">2</span>         <span class="hljs-number">10</span>        <span class="hljs-number">2</span>          <span class="hljs-number">5</span>m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU使用率を上げるには、rakyll / heyで負荷テストを実行します。</font></font><br>
<br>
<pre><code class="go hljs">#install hey
<span class="hljs-keyword">go</span> get -u github.com/rakyll/hey<font></font>
#do <span class="hljs-number">10</span>K requests<font></font>
hey -n <span class="hljs-number">10000</span> -q <span class="hljs-number">10</span> -c <span class="hljs-number">5</span> http:<span class="hljs-comment">//&lt;K8S_PUBLIC_IP&gt;:31198/</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HPAイベントは次のように監視できます。</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl describe hpa<font></font>
Events:<font></font>
  Type    Reason             Age   From                       Message<font></font>
  ----    ------             ----  ----                       -------<font></font>
  Normal  SuccessfulRescale  <span class="hljs-number">7</span>m    horizontal-pod-autoscaler  New size: <span class="hljs-number">4</span>; reason: cpu resource utilization (percentage of request) above target<font></font>
  Normal  SuccessfulRescale  <span class="hljs-number">3</span>m    horizontal-pod-autoscaler  New size: <span class="hljs-number">8</span>; reason: cpu resource utilization (percentage of request) above target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
podinfoを一時的に削除します（このガイドの次の手順のいずれかで再展開する必要があります）。</font></font><br>
<br>
<pre><code class="go hljs">kubectl <span class="hljs-built_in">delete</span> -f ./podinfo/podinfo-hpa.yaml,./podinfo/podinfo-dep.yaml,./podinfo/podinfo-svc.yaml</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.カスタムメトリックサーバーのセットアップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタム指標に基づいてスケーリングするには、2つのコンポーネントが必要です。</font><font style="vertical-align: inherit;">最初の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Prometheus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時系列データベース&nbsp; </font><font style="vertical-align: inherit;">&nbsp;-アプリケーションメトリックを収集して保存します。</font><font style="vertical-align: inherit;">2番目のコンポーネントである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k8s-prometheus-adapter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ビルダーによって提供されるメトリックでカスタムメトリックAPI Kubernetesを補完します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hf/g5/-j/hfg5-js5hf_5ldfgkrhk0dwgfu0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
専用の名前空間を使用して、Prometheusとアダプターをデプロイします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前空間を作成します&nbsp; </font></font><code>monitoring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./namespaces.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前空間でPrometheus v2を展開します&nbsp; </font></font><code>monitoring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./prometheus</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheusアダプターに必要なTLS証明書を生成します。</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-built_in">make</span> certs</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムメトリクスAPI用のPrometheusアダプターをデプロイします。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./custom-metrics-api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheusが提供する特別なメトリックのリストを取得します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get --raw <span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1"</span> | jq .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、名前空間内のすべてのポッドのファイルシステム使用状況データを抽出します&nbsp; </font></font><code>monitoring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get --raw <span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/monitoring/pods/*/fs_usage_bytes"</span> | jq .</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.カスタム指標に基づく自動スケーリング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NodePortサービス</font></font><code>podinfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;を</font><font style="vertical-align: inherit;">作成 &nbsp; </font><font style="vertical-align: inherit;">し、名前空間にデプロイします&nbsp; </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./podinfo/podinfo-svc.yaml,./podinfo/podinfo-dep.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーション&nbsp; </font></font><code>podinfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;はカスタム指標を渡します&nbsp; </font></font><code>http_requests_total</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Prometheusアダプターはサフィックスを削除し、&nbsp; </font></font><code>_total</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;このメトリックをカウンターとしてマークします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムメトリックスAPIから1秒あたりのクエリの総数を取得します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get --raw <span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/http_requests"</span> | jq .<font></font>
{<font></font>
  <span class="hljs-string">"kind"</span>: <span class="hljs-string">"MetricValueList"</span>,
  <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"custom.metrics.k8s.io/v1beta1"</span>,
  <span class="hljs-string">"metadata"</span>: {
    <span class="hljs-string">"selfLink"</span>: <span class="hljs-string">"/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/http_requests"</span><font></font>
  },<font></font>
  <span class="hljs-string">"items"</span>: [<font></font>
    {<font></font>
      <span class="hljs-string">"describedObject"</span>: {
        <span class="hljs-string">"kind"</span>: <span class="hljs-string">"Pod"</span>,
        <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"podinfo-6b86c8ccc9-kv5g9"</span>,
        <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"/__internal"</span><font></font>
      },<font></font>
      <span class="hljs-string">"metricName"</span>: <span class="hljs-string">"http_requests"</span>,
      <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2018-01-10T16:49:07Z"</span>,
      <span class="hljs-string">"value"</span>: <span class="hljs-string">"901m"</span>    },<font></font>
    {<font></font>
      <span class="hljs-string">"describedObject"</span>: {
        <span class="hljs-string">"kind"</span>: <span class="hljs-string">"Pod"</span>,
        <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"podinfo-6b86c8ccc9-nm7bl"</span>,
        <span class="hljs-string">"apiVersion"</span>: <span class="hljs-string">"/__internal"</span><font></font>
      },<font></font>
      <span class="hljs-string">"metricName"</span>: <span class="hljs-string">"http_requests"</span>,
      <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2018-01-10T16:49:07Z"</span>,
      <span class="hljs-string">"value"</span>: <span class="hljs-string">"898m"</span><font></font>
    }<font></font>
  ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字&nbsp; </font></font><code>m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;は&nbsp; </font></font><code>milli-units</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、したがって、たとえば、&nbsp; </font></font><code>901m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;901ミリセクストです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエスト数が1秒あたり10リクエストを超える場合にpodinfoデプロイメントを拡張するHPAを作成します。</font></font><br>
<br>
<pre><code class="go hljs">apiVersion: autoscaling/v2beta1<font></font>
kind: HorizontalPodAutoscaler<font></font>
metadata:<font></font>
  name: podinfo<font></font>
spec:<font></font>
  scaleTargetRef:<font></font>
    apiVersion: extensions/v1beta1<font></font>
    kind: Deployment<font></font>
    name: podinfo<font></font>
  minReplicas: <span class="hljs-number">2</span>
  maxReplicas: <span class="hljs-number">10</span><font></font>
  metrics:<font></font>
  - <span class="hljs-keyword">type</span>: Pods<font></font>
    pods:<font></font>
      metricName: http_requests<font></font>
      targetAverageValue: <span class="hljs-number">10</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HPA </font></font><code>podinfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;を名前空間に</font><font style="vertical-align: inherit;">デプロイ&nbsp; </font><font style="vertical-align: inherit;">します&nbsp; </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs">kubectl create -f ./podinfo/podinfo-hpa-custom.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数秒後、HPAは</font></font><code>http_requests</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;メトリックAPIから</font><font style="vertical-align: inherit;">値を受け取り&nbsp; </font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="go hljs">kubectl get hpa<font></font>
NAME      REFERENCE            TARGETS     MINPODS   MAXPODS   REPLICAS   AGE<font></font>
podinfo   Deployment/podinfo   <span class="hljs-number">899</span>m / <span class="hljs-number">10</span>   <span class="hljs-number">2</span>         <span class="hljs-number">10</span>        <span class="hljs-number">2</span>          <span class="hljs-number">1</span>m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1秒あたり25リクエストでpodinfoサービスの負荷を適用します。</font></font><br>
<br>
<pre><code class="go hljs">#install hey
<span class="hljs-keyword">go</span> get -u github.com/rakyll/hey<font></font>
#do <span class="hljs-number">10</span>K requests rate limited at <span class="hljs-number">25</span> QPS<font></font>
hey -n <span class="hljs-number">10000</span> -q <span class="hljs-number">5</span> -c <span class="hljs-number">5</span> http:<span class="hljs-comment">//&lt;K8S-IP&gt;:31198/healthz</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数分で、HPAは展開のスケーリングを開始します。</font></font><br>
<br>
<pre><code class="go hljs">kubectl describe hpa<font></font>
Name:                       podinfo<font></font>
Namespace:                  <span class="hljs-keyword">default</span><font></font>
Reference:                  Deployment/podinfo<font></font>
Metrics:                    ( current / target )<font></font>
  <span class="hljs-string">"http_requests"</span> on pods:  <span class="hljs-number">9059</span>m / <span class="hljs-number">10</span>&lt;<font></font>
Min replicas:               <span class="hljs-number">2</span>
Max replicas:               <span class="hljs-number">10</span><font></font>
Events:<font></font>
  Type    Reason             Age   From                       Message<font></font>
  ----    ------             ----  ----                       -------<font></font>
  Normal  SuccessfulRescale  <span class="hljs-number">2</span>m    horizontal-pod-autoscaler  New size: <span class="hljs-number">3</span>; reason: pods metric http_requests above target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在の1秒あたりのリクエスト数では、デプロイメントは最大10ポッドに達することはありません。</font><font style="vertical-align: inherit;">各ポッドの1秒あたりのリクエスト数が10未満になるようにするには、レプリカが3つあれば十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷テストが完了すると、HPAはデプロイの規模を元のレプリカ数に削減します。</font></font><br>
<br>
<pre><code class="go hljs">Events:<font></font>
  Type    Reason             Age   From                       Message<font></font>
  ----    ------             ----  ----                       -------<font></font>
  Normal  SuccessfulRescale  <span class="hljs-number">5</span>m    horizontal-pod-autoscaler  New size: <span class="hljs-number">3</span>; reason: pods metric http_requests above target<font></font>
  Normal  SuccessfulRescale  <span class="hljs-number">21</span>s   horizontal-pod-autoscaler  New size: <span class="hljs-number">2</span>; reason: All metrics below target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動スケールツールがメトリックの変更にすぐに応答しないことに気づいたかもしれません。</font><font style="vertical-align: inherit;">デフォルトでは、30秒ごとに同期されます。</font><font style="vertical-align: inherit;">また、スケーリングは、過去3〜5分間にワークロードの増減がない場合にのみ発生します。</font><font style="vertical-align: inherit;">これにより、競合する決定を防ぎ、クラスターオートスケーラーを接続する時間を確保できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのシステムが、CPUまたはメモリの使用率（あるいはその両方）に基づいてのみSLAコンプライアンスを実施できるわけではありません。トラフィックの急増に対処するためのほとんどのWebサーバーとモバイルサーバーでは、1秒あたりのリクエスト数に基づいた自動スケーリングが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ETLアプリケーション（工学抽出変換ロード-「抽出、変換、ロード」から）の場合、たとえば、ジョブキューの指定されたしきい値の長さを超えたときに、自動スケーリングをトリガーできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての場合において、Prometheusを使用してアプリケーションをインストルメント化し、自動スケーリングに必要なインジケーターを強調表示すると、アプリケーションを微調整してトラフィックスパイクの処理を改善し、インフラストラクチャの高可用性を確保できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイデア、質問、コメント？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slackで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の議論に参加して&nbsp; </font><font style="vertical-align: inherit;">ください！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こちらがそのような素材です。</font><font style="vertical-align: inherit;">コメントをお待ちしており、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お会いしましょう</font><font style="vertical-align: inherit;">！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja457728/index.html">Goのハッシュテーブル。実装の詳細</a></li>
<li><a href="../ja457730/index.html">オフィスにはコントロールの幻想があります-それはリモコンにはありません。Devhabとの会話</a></li>
<li><a href="../ja457734/index.html">イタリアのオープンソース革命が始まります</a></li>
<li><a href="../ja457736/index.html">「ツールは、それが作成するシステムについて考える能力ほど重要ではありません。」マーティンクレップマンへのインタビュー</a></li>
<li><a href="../ja457738/index.html">SD-Accessの実装方法とそれが必要な理由</a></li>
<li><a href="../ja457744/index.html">Qtライブラリでの拡張システムの作成-パート2</a></li>
<li><a href="../ja457746/index.html">気象学とフライト</a></li>
<li><a href="../ja457750/index.html">Symfony 4でJSON RPCを操作する</a></li>
<li><a href="../ja457752/index.html">月面探査機やジョーカーではありません。福島のロボットについて知っていること</a></li>
<li><a href="../ja457754/index.html">Государство и Т-киллеры</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>