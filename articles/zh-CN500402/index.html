<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ”© ğŸ…ğŸ¿ â¤µï¸ [Part 1/2] FFmpegå’ŒSDLæŒ‡å—æˆ–å¦‚ä½•ç¼–å†™å°‘äº1000è¡Œçš„è§†é¢‘æ’­æ”¾å™¨ ğŸ‘¨ğŸ¼â€ğŸš’ ğŸŒ” ğŸ‘§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å°½ç®¡æ­¤ä¿¡æ¯å·²ç»è¿‡æ—¶ï¼Œä½†åŸå§‹ææ–™ä»ç„¶æ˜¯FFmpegä¸»é¢˜ä¸Šå„ç§æœ‰ç”¨å†…å®¹çš„æµè¡Œçµæ„Ÿæ¥æºã€‚ä½†æ˜¯ï¼Œä»ç„¶æ²¡æœ‰å°†åŸä»¶å®Œå…¨ç¿»è¯‘æˆä¿„æ–‡ã€‚æˆ‘ä»¬æ›´æ­£äº†çƒ¦äººçš„é—æ¼ï¼Œå› ä¸ºè¿Ÿåˆ°æ€»æ¯”æ²¡æœ‰å¥½ã€‚
 
 å°½ç®¡æˆ‘ä»¬å°è¯•äº†ï¼Œä½†æ˜¯åœ¨å¦‚æ­¤åºå¤§çš„æ–‡æœ¬ä¸­ç¿»è¯‘çš„å›°éš¾æ˜¯ä¸å¯é¿å…çš„ã€‚æŠ¥å‘Šé”™è¯¯ï¼ˆæœ€å¥½æ˜¯åœ¨ç§äººæ¶ˆæ¯ä¸­ï¼‰-æˆ‘ä»¬åœ¨ä¸€èµ·å°†åšå¾—æ›´å¥½ã€‚
 
 ç›®å½•  ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>[Part 1/2] FFmpegå’ŒSDLæŒ‡å—æˆ–å¦‚ä½•ç¼–å†™å°‘äº1000è¡Œçš„è§†é¢‘æ’­æ”¾å™¨</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/edison/blog/500402/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><div style="text-align:center;"><img width="780" height="325" src="https://habrastorage.org/webt/8g/lm/9b/8glm9bxivqkvscmah31ojdjmzci.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡æ­¤ä¿¡æ¯å·²ç»è¿‡æ—¶ï¼Œä½†åŸå§‹ææ–™ä»ç„¶æ˜¯FFmpegä¸»é¢˜ä¸Šå„ç§æœ‰ç”¨å†…å®¹çš„æµè¡Œçµæ„Ÿæ¥æºã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œä»ç„¶æ²¡æœ‰å°†åŸä»¶å®Œå…¨ç¿»è¯‘æˆä¿„æ–‡ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ›´æ­£äº†çƒ¦äººçš„é—æ¼ï¼Œå› ä¸ºè¿Ÿåˆ°æ€»æ¯”æ²¡æœ‰å¥½ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡æˆ‘ä»¬å°è¯•äº†ï¼Œä½†æ˜¯åœ¨å¦‚æ­¤åºå¤§çš„æ–‡æœ¬</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ç¿»è¯‘çš„å›°éš¾æ˜¯</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸å¯é¿å…çš„</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æŠ¥å‘Šé”™è¯¯ï¼ˆæœ€å¥½æ˜¯åœ¨ç§äººæ¶ˆæ¯ä¸­ï¼‰-æˆ‘ä»¬åœ¨ä¸€èµ·å°†åšå¾—æ›´å¥½ã€‚</font></font><a name="menu"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç›®å½•</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<th align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬1éƒ¨åˆ†</font></font></th>
<th align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬2éƒ¨åˆ†</font></font></th>
</tr>
<tr>
<td align="left"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰è¨€</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬1è¯¾ï¼šåˆ›å»ºå±å¹•æˆªå›¾</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬2è¯¾ï¼šæ˜¾ç¤º</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬3è¯¾ï¼šæ’­æ”¾å£°éŸ³</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬4è¯¾ï¼šå¤šçº¿ç¨‹</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬5è¯¾ï¼šåŒæ­¥è§†é¢‘</font></font></a><br>
</td>
<td align="left"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 6:  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 7: </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 1.  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> 2.  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></td>
</tr>
</tbody></table></div><a name="habracut"></a><a name="preamble"></a><blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="EDISONè½¯ä»¶-ç½‘ç»œå¼€å‘"><img align="left" width="153" height="75" src="https://habrastorage.org/webt/w0/zl/to/w0zltoxvysbr0yeinstkfvw1wbg.png" alt="EDISONè½¯ä»¶-ç½‘ç»œå¼€å‘"></a><br clear="right">
     EDISON.<br>
<br>
        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     </a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">      C  C++</a>.<br>
<br>
     ! ;-)</blockquote><br>
<h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•">â‡‘</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬1è¯¾ï¼šåˆ›å»ºå±å¹•æˆªå›¾">â†’</a></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDï¼šæœ¬æŒ‡å—å·²äº2015å¹´2æœˆæ›´æ–°ã€‚</font></font></b><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯ç”¨äºåˆ›å»ºè§†é¢‘åº”ç”¨ç¨‹åºå’Œé€šç”¨å®ç”¨ç¨‹åºçš„å‡ºè‰²åº“ã€‚ FFmpegè´Ÿè´£æ•´ä¸ªè§†é¢‘å¤„ç†ä¾‹ç¨‹ï¼Œæ‰§è¡Œæ‰€æœ‰è§£ç ï¼Œç¼–ç ï¼Œå¤ç”¨å’Œè§£å¤ç”¨ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†åª’ä½“åº”ç”¨ç¨‹åºçš„åˆ›å»ºã€‚ä¸€åˆ‡éƒ½éå¸¸ç®€å•ï¼Œå¿«æ·ï¼Œç”¨Cç¼–å†™ï¼Œæ‚¨å¯ä»¥è§£ç å½“ä»Šå‡ ä¹æ‰€æœ‰å¯ç”¨çš„ç¼–è§£ç å™¨ï¼Œä»¥åŠç¼–ç ä¸ºå…¶ä»–æ ¼å¼ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å”¯ä¸€çš„ä¸è¶³æ˜¯è¯¥æ–‡æ¡£å‡ ä¹ä¸¢å¤±äº†ã€‚æœ‰ä¸€ä¸ªæ•™ç¨‹ï¼ˆ</font><i><font style="vertical-align: inherit;">åœ¨åŸå§‹</font></i><font style="vertical-align: inherit;">æ•™ç¨‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ï¼Œè¿™æ˜¯åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„ç½‘é¡µçš„é“¾æ¥-æ³¨é‡Šç¿»è¯‘å™¨</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼Œæ¶µç›–äº†FFmpegçš„åŸºç¡€çŸ¥è¯†å’Œdoxygenæ‰©å±•åçš„è‡ªåŠ¨ç”Ÿæˆã€‚ä»…æ­¤è€Œå·²ã€‚å› æ­¤ï¼Œæˆ‘å†³å®šç‹¬ç«‹ç ”ç©¶å¦‚ä½•ä½¿ç”¨FFmpegåˆ›å»ºæœ‰æ•ˆçš„æ•°å­—è§†é¢‘å’ŒéŸ³é¢‘åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶è®°å½•è¯¥è¿‡ç¨‹å¹¶ä»¥æ•™ç§‘ä¹¦çš„å½¢å¼è¿›è¡Œä»‹ç»ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpegé™„å¸¦æœ‰ä¸€ä¸ªFFplayç¨‹åºã€‚å®ƒå¾ˆç®€å•ï¼Œç”¨Cç¼–å†™ï¼Œä½¿ç”¨FFmpegå®ç°äº†å®Œæ•´çš„è§†é¢‘æ’­æ”¾å™¨ã€‚æˆ‘çš„ç¬¬ä¸€è¯¾æ˜¯Martin Boehmeçš„åŸå§‹è¯¾ç¨‹çš„æ›´æ–°ç‰ˆæœ¬ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŸå§‹è¯­è¨€æ˜¯æŒ‡å‘å·²ç»å¤±æ•ˆçš„ç½‘é¡µçš„é“¾æ¥-è¯‘è€…æ³¨</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰-æˆ‘ä»é‚£é‡Œæ‹–äº†ä¸€äº›ç‰‡æ®µã€‚åœ¨æˆ‘çš„ç³»åˆ—è¯¾ç¨‹ä¸­ï¼Œæˆ‘è¿˜å°†å±•ç¤ºåŸºäº</font><b><font style="vertical-align: inherit;">ffplay.c</font></b><font style="vertical-align: inherit;">åˆ›å»ºæœ‰æ•ˆçš„è§†é¢‘æ’­æ”¾å™¨çš„è¿‡ç¨‹</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³•å¸ƒé‡Œæ–¯Â·è´å‹’ï¼ˆFabrice Bellardï¼‰ã€‚æ¯èŠ‚è¯¾å°†ä»‹ç»ä¸€ä¸ªæ–°çš„æƒ³æ³•ï¼ˆç”šè‡³ä¸¤ä¸ªï¼‰ï¼Œå¹¶è¯´æ˜å…¶å®æ–½æ–¹å¼ã€‚æ¯ç« éƒ½æœ‰ä¸€ä¸ªCæ¸…å•ï¼Œæ‚¨å¯ä»¥ç¼–è¯‘å¹¶è‡ªè¡Œè¿è¡Œã€‚æºæ–‡ä»¶å°†æ˜¾ç¤ºè¯¥ç¨‹åºçš„å·¥ä½œæ–¹å¼ï¼Œå„ä¸ªéƒ¨åˆ†çš„å·¥ä½œæ–¹å¼ï¼Œå¹¶æ¼”ç¤ºæœ¬æŒ‡å—æœªæ¶µç›–çš„æ¬¡è¦æŠ€æœ¯ç»†èŠ‚ã€‚å®Œæˆåï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸åˆ°1000è¡Œä»£ç ç¼–å†™ä¸€ä¸ªå¯æ­£å¸¸å·¥ä½œçš„è§†é¢‘æ’­æ”¾å™¨ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºæ’­æ”¾å™¨æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SDLè¾“å‡ºéŸ³é¢‘å’Œè§†é¢‘åª’ä½“æ–‡ä»¶ã€‚ SDLæ˜¯ä¸€ä¸ªå‡ºè‰²çš„è·¨å¹³å°å¤šåª’ä½“åº“ï¼Œå¯ç”¨äºMPEGæ’­æ”¾ç¨‹åºï¼Œä»¿çœŸå™¨å’Œè®¸å¤šè§†é¢‘æ¸¸æˆã€‚æ‚¨éœ€è¦åœ¨ç³»ç»Ÿä¸Šä¸‹è½½å¹¶å®‰è£…SDLåº“ï¼Œæ‰èƒ½ä»æœ¬æŒ‡å—ä¸­ç¼–è¯‘ç¨‹åºã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ¬æ•™ç¨‹é€‚ç”¨äºå…·æœ‰è‰¯å¥½ç¼–ç¨‹ç»éªŒçš„äººã€‚è‡³å°‘ï¼Œæ‚¨éœ€è¦äº†è§£Cï¼Œå¹¶ä¸”è¿˜éœ€è¦äº†è§£é˜Ÿåˆ—ï¼Œäº’æ–¥å¯¹è±¡ç­‰æ¦‚å¿µã€‚åº”è¯¥å¯¹å¤šåª’ä½“æœ‰æ‰€äº†è§£ï¼›ä¾‹å¦‚ï¼Œè¯¸å¦‚æ³¢å½¢ä¹‹ç±»çš„ä¸œè¥¿ã€‚ä½†æ˜¯ï¼Œä¸å¿…åœ¨è¿™äº›é—®é¢˜ä¸Šæ‹…ä»»ä¸“å®¶ï¼Œå› ä¸ºåœ¨ä¸Šè¯¾è¿‡ç¨‹ä¸­å°†è§£é‡Šè®¸å¤šæ¦‚å¿µã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·éšæ—¶é€šè¿‡Dranger Doggy Gmail dot Comå‘æˆ‘å‘é€é”™è¯¯æ¶ˆæ¯ï¼Œé—®é¢˜ï¼Œè¯„è®ºï¼Œæƒ³æ³•ï¼ŒåŠŸèƒ½ç­‰ã€‚</font></font><a name="screencaps"></a><br>
<br>
<hr><hr><hr><hr><hr><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img align="right" width="420" height="125" src="https://habrastorage.org/webt/co/i3/m0/coi3m0tliby9r5uxtiydjoeaqkm.png"></a><br clear="left">
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦è¯·å‚é˜…</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EDISONå…¬å¸</font><font style="vertical-align: inherit;">çš„åšå®¢</font><font style="vertical-align: inherit;">ï¼š</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libavæ‰‹å†Œ</font></font></b></a><br>
<hr><hr><hr><hr><hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬1è¯¾ï¼šåˆ›å»ºå±å¹•æˆªå›¾</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="å‰è¨€"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â† </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â‡‘ </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬2è¯¾ï¼šæ˜¾ç¤º"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â†’</font></font></a></h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæ•´æ¸…å•ï¼štutorial01.c</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">// tutorial01.c</span>
<span class="hljs-comment">// Code based on a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span>
<span class="hljs-comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span>
<span class="hljs-comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span>
<span class="hljs-comment">// Updates tested on:</span>
<span class="hljs-comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101 </span>
<span class="hljs-comment">// on GCC 4.7.2 in Debian February 2015</span><font></font>
<font></font>
<span class="hljs-comment">// A small sample program that shows how to use libavformat and libavcodec to</span>
<span class="hljs-comment">// read video from a file.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Use</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// gcc -o tutorial01 tutorial01.c -lavformat -lavcodec -lswscale -lz</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to build (assuming libavformat and libavcodec are correctly installed</span>
<span class="hljs-comment">// your system).</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Run using</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// tutorial01 myvideofile.mpg</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to write the first five frames from "myvideofile.mpg" to disk in PPM</span>
<span class="hljs-comment">// format.</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libswscale/swscale.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// compatibility with newer API</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_free avcodec_free_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SaveFrame</span><span class="hljs-params">(AVFrame *pFrame, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height, <span class="hljs-keyword">int</span> iFrame)</span> </span>{<font></font>
  FILE *pFile;<font></font>
  <span class="hljs-keyword">char</span> szFilename[<span class="hljs-number">32</span>];
  <span class="hljs-keyword">int</span>  y;<font></font>
  <font></font>
  <span class="hljs-comment">// Open file</span>
  <span class="hljs-built_in">sprintf</span>(szFilename, <span class="hljs-string">"frame%d.ppm"</span>, iFrame);<font></font>
  pFile=fopen(szFilename, <span class="hljs-string">"wb"</span>);
  <span class="hljs-keyword">if</span>(pFile==<span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">return</span>;<font></font>
  <font></font>
  <span class="hljs-comment">// Write header</span>
  <span class="hljs-built_in">fprintf</span>(pFile, <span class="hljs-string">"P6\n%d %d\n255\n"</span>, width, height);<font></font>
  <font></font>
  <span class="hljs-comment">// Write pixel data</span>
  <span class="hljs-keyword">for</span>(y=<span class="hljs-number">0</span>; y&lt;height; y++)<font></font>
    fwrite(pFrame-&gt;data[<span class="hljs-number">0</span>]+y*pFrame-&gt;linesize[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, width*<span class="hljs-number">3</span>, pFile);<font></font>
  <font></font>
  <span class="hljs-comment">// Close file</span><font></font>
  fclose(pFile);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
  <span class="hljs-comment">// Initalizing these to NULL prevents segfaults!</span>
  AVFormatContext   *pFormatCtx = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">int</span>               i, videoStream;<font></font>
  AVCodecContext    *pCodecCtxOrig = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodecContext    *pCodecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec           *pCodec = <span class="hljs-literal">NULL</span>;<font></font>
  AVFrame           *pFrame = <span class="hljs-literal">NULL</span>;<font></font>
  AVFrame           *pFrameRGB = <span class="hljs-literal">NULL</span>;<font></font>
  AVPacket          packet;<font></font>
  <span class="hljs-keyword">int</span>               frameFinished;
  <span class="hljs-keyword">int</span>               numBytes;
  <span class="hljs-keyword">uint8_t</span>           *buffer = <span class="hljs-literal">NULL</span>;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span> = <span class="hljs-title">NULL</span>;</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please provide a movie file\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">// Register all formats and codecs</span><font></font>
  av_register_all();<font></font>
  <font></font>
  <span class="hljs-comment">// Open video file</span>
  <span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span><font></font>
  <font></font>
  <span class="hljs-comment">// Retrieve stream information</span>
  <span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span><font></font>
  <font></font>
  <span class="hljs-comment">// Dump information about file onto standard error</span>
  av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);<font></font>
  <font></font>
  <span class="hljs-comment">// Find the first video stream</span>
  videoStream=<span class="hljs-number">-1</span>;
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++)
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO) {<font></font>
      videoStream=i;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  <span class="hljs-keyword">if</span>(videoStream==<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Didn't find a video stream</span><font></font>
  <font></font>
  <span class="hljs-comment">// Get a pointer to the codec context for the video stream</span><font></font>
  pCodecCtxOrig=pFormatCtx-&gt;streams[videoStream]-&gt;codec;<font></font>
  <span class="hljs-comment">// Find the decoder for the video stream</span><font></font>
  pCodec=avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(pCodec==<span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Codec not found</span><font></font>
  }<font></font>
  <span class="hljs-comment">// Copy context</span><font></font>
  pCodecCtx = avcodec_alloc_context3(pCodec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Open codec</span>
  <span class="hljs-keyword">if</span>(avcodec_open2(pCodecCtx, pCodec, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Could not open codec</span><font></font>
  <font></font>
  <span class="hljs-comment">// Allocate video frame</span><font></font>
  pFrame=av_frame_alloc();<font></font>
  <font></font>
  <span class="hljs-comment">// Allocate an AVFrame structure</span><font></font>
  pFrameRGB=av_frame_alloc();<font></font>
  <span class="hljs-keyword">if</span>(pFrameRGB==<span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">// Determine required buffer size and allocate buffer</span><font></font>
  numBytes=avpicture_get_size(PIX_FMT_RGB24, pCodecCtx-&gt;width,<font></font>
			      pCodecCtx-&gt;height);<font></font>
  buffer=(<span class="hljs-keyword">uint8_t</span> *)av_malloc(numBytes*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint8_t</span>));<font></font>
  <font></font>
  <span class="hljs-comment">// Assign appropriate parts of buffer to image planes in pFrameRGB</span>
  <span class="hljs-comment">// Note that pFrameRGB is an AVFrame, but AVFrame is a superset</span>
  <span class="hljs-comment">// of AVPicture</span><font></font>
  avpicture_fill((AVPicture *)pFrameRGB, buffer, PIX_FMT_RGB24,<font></font>
		 pCodecCtx-&gt;width, pCodecCtx-&gt;height);<font></font>
  <font></font>
  <span class="hljs-comment">// initialize SWS context for software scaling</span><font></font>
  sws_ctx = sws_getContext(pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   pCodecCtx-&gt;pix_fmt,<font></font>
			   pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   PIX_FMT_RGB24,<font></font>
			   SWS_BILINEAR,<font></font>
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span><font></font>
			   );<font></font>
<font></font>
  <span class="hljs-comment">// Read frames and save first five frames to disk</span>
  i=<span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet.stream_index==videoStream) {
      <span class="hljs-comment">// Decode video frame</span><font></font>
      avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);<font></font>
      <font></font>
      <span class="hljs-comment">// Did we get a video frame?</span>
      <span class="hljs-keyword">if</span>(frameFinished) {
	<span class="hljs-comment">// Convert the image from its native format to RGB</span>
	sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
		  pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
		  pFrameRGB-&gt;data, pFrameRGB-&gt;linesize);<font></font>
	<font></font>
	<span class="hljs-comment">// Save the frame to disk</span>
	<span class="hljs-keyword">if</span>(++i&lt;=<span class="hljs-number">5</span>)<font></font>
	  SaveFrame(pFrameRGB, pCodecCtx-&gt;width, pCodecCtx-&gt;height, <font></font>
		    i);<font></font>
      }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-comment">// Free the packet that was allocated by av_read_frame</span><font></font>
    av_free_packet(&amp;packet);<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// Free the RGB image</span><font></font>
  av_free(buffer);<font></font>
  av_frame_free(&amp;pFrameRGB);<font></font>
  <font></font>
  <span class="hljs-comment">// Free the YUV frame</span><font></font>
  av_frame_free(&amp;pFrame);<font></font>
  <font></font>
  <span class="hljs-comment">// Close the codecs</span><font></font>
  avcodec_close(pCodecCtx);<font></font>
  avcodec_close(pCodecCtxOrig);<font></font>
<font></font>
  <span class="hljs-comment">// Close the video file</span><font></font>
  avformat_close_input(&amp;pFormatCtx);<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€»è§ˆ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”µå½±æ–‡ä»¶å…·æœ‰å‡ ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæ–‡ä»¶æœ¬èº«ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®¹å™¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font><b><font style="vertical-align: inherit;">å®¹å™¨</font></b><font style="vertical-align: inherit;">çš„ç±»å‹å†³å®šäº†æ–‡ä»¶ä¸­æ•°æ®çš„è¡¨ç¤ºæ–¹å¼ã€‚å®¹å™¨çš„ç¤ºä¾‹æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVI</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quicktime</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æ­¤å¤–ï¼Œæ–‡ä»¶ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ã€‚ç‰¹åˆ«åœ°ï¼Œé€šå¸¸å­˜åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŸ³é¢‘æµ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§†é¢‘æµ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ ï¼ˆâ€œæµâ€æ˜¯ä¸€ä¸ªæœ‰è¶£çš„è¯ï¼Œæ„ä¸ºâ€œæ ¹æ®æ—¶é—´è½´å¯ç”¨çš„ä¸€ç³»åˆ—æ•°æ®é¡¹ã€‚â€ï¼‰æµä¸­çš„æ•°æ®é¡¹ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¸§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æ¯ä¸ªæµç”±ä¸€ç§æˆ–å¦ä¸€ç§ç±»å‹çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼–è§£ç å™¨ç¼–ç </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ç¼–è§£ç å™¨ç¡®å®šå¦‚ä½•å°†å®é™…æ•°æ®å‘é€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diruyutsyaå’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">December</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å·²å®¡æ ¸-ç¼–è§£ç å™¨çš„åç§°ã€‚</font><font style="vertical-align: inherit;">DivXå’ŒMP3æ˜¯ç¼–è§£ç å™¨çš„ç¤ºä¾‹ã€‚</font><font style="vertical-align: inherit;">ç„¶åä»æµä¸­è¯»å–æ•°æ®åŒ…ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®åŒ…</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æ•°æ®ç‰‡æ®µï¼Œå¯ä»¥åŒ…å«</font><font style="vertical-align: inherit;">è§£ç ä¸ºåŸå§‹å¸§</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æ•°æ®ä½</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å¯¹å…¶è¿›è¡Œæ“ä½œã€‚</font><font style="vertical-align: inherit;">ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½åŒ…å«å®Œæ•´å¸§ï¼ˆå¦‚æœæ˜¯éŸ³é¢‘ï¼Œåˆ™åŒ…å«å‡ ä¸ªå¸§ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å³ä½¿åœ¨æœ€åŸºæœ¬çš„çº§åˆ«ä¸Šï¼Œä½¿ç”¨è§†é¢‘å’ŒéŸ³é¢‘æµä¹Ÿéå¸¸ç®€å•ï¼š</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-number">10</span> OPEN video_stream FROM video.avi
<span class="hljs-number">20</span> READ packet FROM video_stream INTO frame
<span class="hljs-number">30</span> <span class="hljs-keyword">IF</span> frame <span class="hljs-keyword">NOT</span> COMPLETE <span class="hljs-keyword">GOTO</span> <span class="hljs-number">20</span>
<span class="hljs-number">40</span> <span class="hljs-keyword">DO</span> SOMETHING <span class="hljs-keyword">WITH</span> frame
<span class="hljs-number">50</span> <span class="hljs-keyword">GOTO</span> <span class="hljs-number">20</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½¿ç”¨FFmpegä½¿ç”¨å¤šåª’ä½“å‡ ä¹ä¸è¯¥ç¨‹åºä¸€æ ·ç®€å•ï¼Œå°½ç®¡åœ¨æŸäº›ç¨‹åºä¸­â€œ MAKEâ€æ­¥éª¤å¯èƒ½éå¸¸å›°éš¾ã€‚</font><font style="vertical-align: inherit;">åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ‰“å¼€æ–‡ä»¶ï¼Œè®¡ç®—å…¶ä¸­çš„è§†é¢‘æµï¼Œç„¶åæˆ‘ä»¬çš„â€œ MAKEâ€å°†å¸§å†™å…¥PPMæ–‡ä»¶ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰“å¼€æ–‡ä»¶</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æ‰“å¼€æ–‡ä»¶æ—¶é¦–å…ˆå‘ç”Ÿçš„æƒ…å†µã€‚</font><font style="vertical-align: inherit;">é¦–å…ˆä½¿ç”¨FFmpegåˆå§‹åŒ–æ‰€éœ€çš„åº“ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ffmpeg/swscale.h&gt;</span></span><font></font>
...<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, charg *argv[])</span> </span>{<font></font>
av_register_all();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™ä¼šåœ¨åº“ä¸­æ³¨å†Œæ‰€æœ‰å¯ç”¨çš„æ–‡ä»¶æ ¼å¼å’Œç¼–è§£ç å™¨ï¼Œå› æ­¤åœ¨æ‰“å¼€å…·æœ‰é€‚å½“æ ¼å¼/ç¼–è§£ç å™¨çš„æ–‡ä»¶æ—¶å°†è‡ªåŠ¨ä½¿ç”¨å®ƒä»¬ã€‚</font><font style="vertical-align: inherit;">è¯·æ³¨æ„ï¼Œæ‚¨åªéœ€è¦è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_register_all</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ä¸­è¿›è¡Œæ­¤æ“ä½œã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ„¿æ„ï¼Œå¯ä»¥ä»…æ³¨å†Œé€‰æ‹©æ€§æ–‡ä»¶æ ¼å¼å’Œç¼–è§£ç å™¨ï¼Œä½†é€šå¸¸æ²¡æœ‰ç‰¹æ®ŠåŸå› ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨æ‰“å¼€æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *pFormatCtx = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-comment">// Open video file</span>
<span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»ç¬¬ä¸€ä¸ªå‚æ•°è·å–æ–‡ä»¶åã€‚</font><font style="vertical-align: inherit;">æ­¤å‡½æ•°è¯»å–æ–‡ä»¶å¤´å¹¶å°†æ–‡ä»¶æ ¼å¼ä¿¡æ¯å­˜å‚¨åœ¨</font><font style="vertical-align: inherit;">æˆ‘ä»¬ä¼ é€’</font><font style="vertical-align: inherit;">çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ä¸­ã€‚</font><font style="vertical-align: inherit;">æœ€åä¸‰ä¸ªå‚æ•°ç”¨äºæŒ‡å®šæ–‡ä»¶æ ¼å¼ï¼Œç¼“å†²åŒºå¤§å°å’Œæ ¼å¼å‚æ•°ã€‚</font><font style="vertical-align: inherit;">é€šè¿‡å°†å®ƒä»¬è®¾ç½®ä¸ºNULLæˆ–0ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavformat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰å†…å®¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥å‡½æ•°ä»…æŸ¥çœ‹æ ‡å¤´ï¼Œå› æ­¤ç°åœ¨æˆ‘ä»¬éœ€è¦æ£€æŸ¥æ–‡ä»¶ä¸­çš„æµä¿¡æ¯ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Retrieve stream information</span>
<span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥å‡½æ•°å°†</font><font style="vertical-align: inherit;">æœ‰æ•ˆæ•°æ®</font><font style="vertical-align: inherit;">ä¼ é€’ç»™</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatCtx-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç†Ÿæ‚‰äº†æ–¹ä¾¿çš„è°ƒè¯•åŠŸèƒ½ï¼Œå‘æˆ‘ä»¬å±•ç¤ºäº†å…¶ä¸­çš„å†…å®¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Dump information about file onto standard error</span>
av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatCtx-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åªæ˜¯ä¸€ä¸ªå¤§å°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatCtx-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nb_streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æŒ‡é’ˆæ•°ç»„</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†ä»”ç»†ç ”ç©¶ç›´åˆ°æ‰¾åˆ°è§†é¢‘æµï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> i;<font></font>
AVCodecContext *pCodecCtxOrig = <span class="hljs-literal">NULL</span>;<font></font>
AVCodecContext *pCodecCtx = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-comment">// Find the first video stream</span>
videoStream=<span class="hljs-number">-1</span>;
<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++)
  <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO) {<font></font>
    videoStream=i;<font></font>
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
<span class="hljs-keyword">if</span>(videoStream==<span class="hljs-number">-1</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Didn't find a video stream</span><font></font>
<font></font>
<span class="hljs-comment">// Get a pointer to the codec context for the video stream</span>
pCodecCtx=pFormatCtx-&gt;streams[videoStream]-&gt;codec;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰å…³æµä¸­ç¼–è§£ç å™¨çš„ä¿¡æ¯ä½äºç§°ä¸ºâ€œ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼–è§£ç å™¨ä¸Šä¸‹æ–‡</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> â€çš„ä½ç½®ã€‚</font><font style="vertical-align: inherit;">å®ƒåŒ…å«æœ‰å…³æµä½¿ç”¨çš„ç¼–è§£ç å™¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¿…é¡»æ‰¾åˆ°çœŸæ­£çš„ç¼–è§£ç å™¨å¹¶æ‰“å¼€å®ƒï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec *pCodec = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-comment">// Find the decoder for the video stream</span><font></font>
pCodec=avcodec_find_decoder(pCodecCtx-&gt;codec_id);<font></font>
<span class="hljs-keyword">if</span>(pCodec==<span class="hljs-literal">NULL</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Codec not found</span><font></font>
}<font></font>
<span class="hljs-comment">// Copy context</span><font></font>
pCodecCtx = avcodec_alloc_context3(pCodec);<font></font>
<span class="hljs-keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
}<font></font>
<span class="hljs-comment">// Open codec</span>
<span class="hljs-keyword">if</span>(avcodec_open2(pCodecCtx, pCodec)&lt;<span class="hljs-number">0</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Could not open codec</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œæ‚¨ä¸èƒ½ç›´æ¥</font><font style="vertical-align: inherit;">ä»è§†é¢‘æµä¸­</font><font style="vertical-align: inherit;">ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vcodec_copy_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å°†ä¸Šä¸‹æ–‡å¤åˆ¶åˆ°æ–°ä½ç½®ï¼ˆå½“ç„¶ï¼Œåœ¨ä¸ºå®ƒåˆ†é…å†…å­˜ä¹‹åï¼‰ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®å­˜å‚¨</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå­˜æ”¾æ¡†æ¶çš„åœ°æ–¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AVFrame *pFrame = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-comment">// Allocate video frame</span>
pFrame=av_frame_alloc();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºæˆ‘ä»¬è®¡åˆ’è¾“å‡ºä»¥24ä½RGBå­˜å‚¨çš„PPMæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å¸§ä»å…¶è‡ªèº«çš„æ ¼å¼è½¬æ¢ä¸ºRGBã€‚</font><font style="vertical-align: inherit;">FFmpegå°†ä¸ºæˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹ã€‚</font><font style="vertical-align: inherit;">å¯¹äºå¤§å¤šæ•°é¡¹ç›®ï¼ˆåŒ…æ‹¬æ­¤é¡¹ç›®ï¼‰ï¼Œæ‚¨éœ€è¦å°†èµ·å§‹å¸§è½¬æ¢ä¸ºç‰¹å®šæ ¼å¼ã€‚</font><font style="vertical-align: inherit;">ä¸ºè½¬æ¢åçš„å¸§é€‰æ‹©ä¸€ä¸ªå¸§ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Allocate an AVFrame structure</span><font></font>
pFrameRGB=av_frame_alloc();<font></font>
<span class="hljs-keyword">if</span>(pFrameRGB==<span class="hljs-literal">NULL</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡æˆ‘ä»¬é€‰æ‹©äº†æ¡†æ¶ï¼Œä½†åœ¨è½¬æ¢åŸå§‹æ•°æ®æ—¶ä»éœ€è¦ä¸€ä¸ªåœ°æ–¹æ¥å®¹çº³åŸå§‹æ•°æ®ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avpicture_get_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥è·å–æ­£ç¡®çš„å¤§å°å¹¶æ‰‹åŠ¨åˆ†é…å¿…è¦çš„ç©ºé—´ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint8_t</span> *buffer = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">int</span> numBytes;
<span class="hljs-comment">// Determine required buffer size and allocate buffer</span><font></font>
numBytes=avpicture_get_size(PIX_FMT_RGB24, pCodecCtx-&gt;width,<font></font>
                            pCodecCtx-&gt;height);<font></font>
buffer=(<span class="hljs-keyword">uint8_t</span> *)av_malloc(numBytes*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">uint8_t</span>));</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_malloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font><font style="vertical-align: inherit;">FFmpeg </font><font style="vertical-align: inherit;">çš„Cå‡½æ•°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„ç±»ä¼¼ç‰©</font><font style="vertical-align: inherit;">ï¼Œå®ƒæ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„ç®€å•åŒ…è£…</font><font style="vertical-align: inherit;">ï¼Œæä¾›å†…å­˜åœ°å€ç­‰çš„å¯¹é½æ–¹å¼ã€‚</font><font style="vertical-align: inherit;">é¡ºä¾¿è¯´ä¸€å¥ï¼Œè¿™ä¸èƒ½é˜²æ­¢å†…å­˜æ³„æ¼ï¼ŒåŒé‡é‡Šæ”¾æˆ–</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘ç”Ÿçš„å…¶ä»–é—®é¢˜</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avpicture_fill</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†å¸§ä¸æ–°åˆ†é…çš„ç¼“å†²åŒºå…³è”ã€‚</font><font style="vertical-align: inherit;">å…³äº</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæ‰€è¿°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">æ˜¯çš„ä¸€ä¸ªå­é›†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">-çš„å¼€å¤´</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><b><font style="vertical-align: inherit;">æ˜¯</font></b><font style="vertical-align: inherit;">ç›¸åŒäº</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Assign appropriate parts of buffer to image planes in pFrameRGB</span>
<span class="hljs-comment">// Note that pFrameRGB is an AVFrame, but AVFrame is a superset</span>
<span class="hljs-comment">// of AVPicture</span><font></font>
avpicture_fill((AVPicture *)pFrameRGB, buffer, PIX_FMT_RGB24,<font></font>
                pCodecCtx-&gt;width, pCodecCtx-&gt;height);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å·²ç»åˆ°äº†ç»ˆç‚¹çº¿ï¼</font><font style="vertical-align: inherit;">ç°åœ¨æˆ‘ä»¬å‡†å¤‡ä»æµä¸­è¯»å–ä¿¡æ¯ï¼</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯»å–æ•°æ®</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œè¦è¯»å–æ•´ä¸ªè§†é¢‘æµï¼Œæˆ‘ä»¬å°†è¯»å–ä¸‹ä¸€ä¸ªåŒ…ï¼Œå¹¶åœ¨å¸§ä¸­å¯¹å…¶è¿›è¡Œè§£å¯†ï¼Œè§£å¯†å®Œæˆåï¼Œç«‹å³è½¬æ¢å¸§å¹¶ä¿å­˜ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span> = <span class="hljs-title">NULL</span>;</span>
<span class="hljs-keyword">int</span> frameFinished;<font></font>
AVPacket packet;<font></font>
<span class="hljs-comment">// initialize SWS context for software scaling</span><font></font>
sws_ctx = sws_getContext(pCodecCtx-&gt;width,<font></font>
    pCodecCtx-&gt;height,<font></font>
    pCodecCtx-&gt;pix_fmt,<font></font>
    pCodecCtx-&gt;width,<font></font>
    pCodecCtx-&gt;height,<font></font>
    PIX_FMT_RGB24,<font></font>
    SWS_BILINEAR,<font></font>
    <span class="hljs-literal">NULL</span>,
    <span class="hljs-literal">NULL</span>,
    <span class="hljs-literal">NULL</span><font></font>
    );<font></font>
<font></font>
i=<span class="hljs-number">0</span>;
<span class="hljs-keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="hljs-number">0</span>) {
  <span class="hljs-comment">// Is this a packet from the video stream?</span>
  <span class="hljs-keyword">if</span>(packet.stream_index==videoStream) {
	<span class="hljs-comment">// Decode video frame</span><font></font>
    avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);<font></font>
    <font></font>
    <span class="hljs-comment">// Did we get a video frame?</span>
    <span class="hljs-keyword">if</span>(frameFinished) {
    <span class="hljs-comment">// Convert the image from its native format to RGB</span>
        sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
		  pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
		  pFrameRGB-&gt;data, pFrameRGB-&gt;linesize);<font></font>
	<font></font>
        <span class="hljs-comment">// Save the frame to disk</span>
        <span class="hljs-keyword">if</span>(++i&lt;=<span class="hljs-number">5</span>)<font></font>
          SaveFrame(pFrameRGB, pCodecCtx-&gt;width, <font></font>
                    pCodecCtx-&gt;height, i);<font></font>
    }<font></font>
  }<font></font>
    <font></font>
  <span class="hljs-comment">// Free the packet that was allocated by av_read_frame</span><font></font>
  av_free_packet(&amp;packet);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ²¡ä»€ä¹ˆå¤æ‚çš„ï¼š</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰è¯»å–åŒ…å¹¶å°†å…¶ä¿å­˜åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„ä¸­</font><font style="vertical-align: inherit;">ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä»…åˆ†å‘åŒ…çš„ç»“æ„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘æˆ‘ä»¬æä¾›äº†</font><b><font style="vertical-align: inherit;">packet.data</font></b><font style="vertical-align: inherit;">æŒ‡å‘çš„å†…éƒ¨æ•°æ®</font><font style="vertical-align: inherit;">ã€‚ç¨åé‡Šæ”¾</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_free_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_video</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å°†æ•°æ®åŒ…è½¬æ¢ä¸ºå¸§ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯èƒ½æ²¡æœ‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹åˆ†ç»„è¿›è¡Œè§£ç åçš„å¸§çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå› æ­¤</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_video</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ç»„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frameFinished</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“æˆ‘ä»¬æœ‰ä¸‹ä¸€å¸§ã€‚æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sws_scale</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ä»æˆ‘ä»¬è‡ªå·±çš„æ ¼å¼è¿›è¡Œè½¬æ¢ï¼ˆ</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pCodecCtx-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt;</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pix_fmt</font></font></b></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰åœ¨RGBä¸­ã€‚è¯·è®°ä½ï¼Œå¯ä»¥å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‡é’ˆ</font><b><font style="vertical-align: inherit;">å¼ºåˆ¶</font></b><font style="vertical-align: inherit;">è½¬æ¢ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‡é’ˆ</font><font style="vertical-align: inherit;">ã€‚æœ€åï¼Œæˆ‘ä»¬ä¼ é€’æœ‰å…³</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SaveFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°çš„æ¡†æ¶ï¼Œé«˜åº¦å’Œå®½åº¦çš„</font><b><font style="vertical-align: inherit;">ä¿¡æ¯</font></b><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯´èµ·åŒ…è£¹ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œæ•°æ®åŒ…åªèƒ½åŒ…å«ä¸€éƒ¨åˆ†å¸§ä»¥åŠå…¶ä»–æ•°æ®ä½ã€‚ä½†æ˜¯ï¼ŒFFmpegè§£æå™¨ä¿è¯æˆ‘ä»¬æ”¶åˆ°çš„æ•°æ®åŒ…åŒ…å«å®Œæ•´å¸§æˆ–ä»€è‡³å‡ ä¸ªå¸§ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨å‰©ä¸‹è¦åšçš„å°±æ˜¯ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SaveFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å°†RGBä¿¡æ¯å†™å…¥PPMæ–‡ä»¶ã€‚å°½ç®¡æˆ‘ä»¬åªæ˜¯åœ¨è¡¨é¢ä¸Šå¤„ç†PPMæ ¼å¼ï¼›ç›¸ä¿¡æˆ‘ï¼Œä¸€åˆ‡éƒ½åœ¨è¿™é‡Œå·¥ä½œï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SaveFrame</span><span class="hljs-params">(AVFrame *pFrame, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height, <span class="hljs-keyword">int</span> iFrame)</span> </span>{<font></font>
  FILE *pFile;<font></font>
  <span class="hljs-keyword">char</span> szFilename[<span class="hljs-number">32</span>];
  <span class="hljs-keyword">int</span>  y;<font></font>
  <font></font>
  <span class="hljs-comment">// Open file</span>
  <span class="hljs-built_in">sprintf</span>(szFilename, <span class="hljs-string">"frame%d.ppm"</span>, iFrame);<font></font>
  pFile=fopen(szFilename, <span class="hljs-string">"wb"</span>);
  <span class="hljs-keyword">if</span>(pFile==<span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">return</span>;<font></font>
  <font></font>
  <span class="hljs-comment">// Write header</span>
  <span class="hljs-built_in">fprintf</span>(pFile, <span class="hljs-string">"P6\n%d %d\n255\n"</span>, width, height);<font></font>
  <font></font>
  <span class="hljs-comment">// Write pixel data</span>
  <span class="hljs-keyword">for</span>(y=<span class="hljs-number">0</span>; y&lt;height; y++)<font></font>
    fwrite(pFrame-&gt;data[<span class="hljs-number">0</span>]+y*pFrame-&gt;linesize[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>, width*<span class="hljs-number">3</span>, pFile);<font></font>
  <font></font>
  <span class="hljs-comment">// Close file</span><font></font>
  fclose(pFile);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬æ‰§è¡Œæ ‡å‡†æ–‡ä»¶æ‰“å¼€ç­‰æ“ä½œï¼Œç„¶åè®°å½•RGBæ•°æ®ã€‚è¯¥æ–‡ä»¶é€è¡Œå†™å…¥ã€‚ PPMæ–‡ä»¶åªæ˜¯å…¶ä¸­RGBä¿¡æ¯ä»¥é•¿è¡Œæ˜¾ç¤ºçš„æ–‡ä»¶ã€‚å¦‚æœæ‚¨çŸ¥é“HTMLçš„é¢œè‰²ï¼Œåˆ™å°±åƒæ ‡è®°æ¯ä¸ªåƒç´ ä»å¤´åˆ°å°¾çš„é¢œè‰²ä¸€æ ·ï¼Œä¾‹å¦‚</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ƒff0000ï¼ƒff0000 ....</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå°±åƒçº¢è‰²å±å¹•ä¸€æ ·ã€‚ ï¼ˆå®é™…ä¸Šï¼Œå®ƒä»¥äºŒè¿›åˆ¶æ ¼å¼å­˜å‚¨ï¼Œæ²¡æœ‰åˆ†éš”ç¬¦ï¼Œä½†æˆ‘å¸Œæœ›æ‚¨èƒ½ç†è§£ã€‚ï¼‰æ ‡é¢˜æŒ‡ç¤ºå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ï¼Œä»¥åŠRGBå€¼çš„æœ€å¤§å¤§å°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨å›åˆ°æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†ä»è§†é¢‘æµä¸­è¯»å–çš„å†…å®¹ï¼Œæˆ‘ä»¬åªéœ€æ¸…é™¤æ‰€æœ‰å†…å®¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Free the RGB image</span><font></font>
av_free(buffer);<font></font>
av_free(pFrameRGB);<font></font>
<font></font>
<span class="hljs-comment">// Free the YUV frame</span><font></font>
av_free(pFrame);<font></font>
<font></font>
<span class="hljs-comment">// Close the codecs</span><font></font>
avcodec_close(pCodecCtx);<font></font>
avcodec_close(pCodecCtxOrig);<font></font>
<font></font>
<span class="hljs-comment">// Close the video file</span><font></font>
avformat_close_input(&amp;pFormatCtx);<font></font>
<font></font>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_free</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”¨äºä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcode_alloc_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_malloc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†é…çš„å†…å­˜</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯å…¨éƒ¨ä»£ç ï¼</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯Linuxæˆ–ç±»ä¼¼å¹³å°ï¼Œè¯·è¿è¡Œï¼š</font></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial01 tutorial01.c -lavutil -lavformat -lavcodec -lz -lavutil -lm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯è¾ƒæ—§ç‰ˆæœ¬çš„FFmpegï¼Œåˆ™å¯èƒ½éœ€è¦åˆ é™¤</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-lavutil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial01 tutorial01.c -lavformat -lavcodec -lz -lm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤§å¤šæ•°å›¾å½¢ç¨‹åºå¿…é¡»æ‰“å¼€PPMæ ¼å¼ã€‚</font><font style="vertical-align: inherit;">åœ¨ä½¿ç”¨æˆ‘ä»¬çš„ç¨‹åºåˆ¶ä½œäº†å±å¹•æˆªå›¾çš„ä¸€äº›ç”µå½±æ–‡ä»¶ä¸Šè¿›è¡Œæ£€æŸ¥ã€‚</font></font><a name="outputting"></a><br>
<br>
<hr><hr><hr><hr><hr><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬2è¯¾ï¼šæ˜¾ç¤ºå±å¹•</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬1è¯¾ï¼šåˆ›å»ºå±å¹•æˆªå›¾"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â† </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â‡‘ </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬ä¸‰è¯¾ï¼šæ’­æ”¾å£°éŸ³"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â†’</font></font></a></h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæ•´æ¸…å•ï¼štutorial02.c</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">// tutorial02.c</span>
<span class="hljs-comment">// A pedagogical video player that will stream through every video frame as fast as it can.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Code based on FFplay, Copyright (c) 2003 Fabrice Bellard, </span>
<span class="hljs-comment">// and a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span>
<span class="hljs-comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span>
<span class="hljs-comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span>
<span class="hljs-comment">// Updates tested on:</span>
<span class="hljs-comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101, SDL 1.2.15</span>
<span class="hljs-comment">// on GCC 4.7.2 in Debian February 2015</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Use</span>
<span class="hljs-comment">// </span>
<span class="hljs-comment">// gcc -o tutorial02 tutorial02.c -lavformat -lavcodec -lswscale -lz -lm `sdl-config --cflags --libs`</span>
<span class="hljs-comment">// to build (assuming libavformat and libavcodec are correctly installed, </span>
<span class="hljs-comment">// and assuming you have sdl-config. Please refer to SDL docs for your installation.)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Run using</span>
<span class="hljs-comment">// tutorial02 myvideofile.mpg</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to play the video stream on your screen.</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libswscale/swscale.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL_thread.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __MINGW32__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> main <span class="hljs-comment">/* Prevents SDL from overriding main() */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// compatibility with newer API</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_free avcodec_free_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{<font></font>
  AVFormatContext *pFormatCtx = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">int</span>             i, videoStream;<font></font>
  AVCodecContext  *pCodecCtxOrig = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodecContext  *pCodecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec         *pCodec = <span class="hljs-literal">NULL</span>;<font></font>
  AVFrame         *pFrame = <span class="hljs-literal">NULL</span>;<font></font>
  AVPacket        packet;<font></font>
  <span class="hljs-keyword">int</span>             frameFinished;
  <span class="hljs-keyword">float</span>           aspect_ratio;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span> = <span class="hljs-title">NULL</span>;</span><font></font>
<font></font>
  SDL_Overlay     *bmp;<font></font>
  SDL_Surface     *screen;<font></font>
  SDL_Rect        rect;<font></font>
  SDL_Event       event;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Usage: test &lt;file&gt;\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-comment">// Register all formats and codecs</span><font></font>
  av_register_all();<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Open video file</span>
  <span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span><font></font>
  <font></font>
  <span class="hljs-comment">// Retrieve stream information</span>
  <span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span><font></font>
  <font></font>
  <span class="hljs-comment">// Dump information about file onto standard error</span>
  av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);<font></font>
  <font></font>
  <span class="hljs-comment">// Find the first video stream</span>
  videoStream=<span class="hljs-number">-1</span>;
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++)
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO) {<font></font>
      videoStream=i;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  <span class="hljs-keyword">if</span>(videoStream==<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Didn't find a video stream</span><font></font>
  <font></font>
  <span class="hljs-comment">// Get a pointer to the codec context for the video stream</span><font></font>
  pCodecCtxOrig=pFormatCtx-&gt;streams[videoStream]-&gt;codec;<font></font>
  <span class="hljs-comment">// Find the decoder for the video stream</span><font></font>
  pCodec=avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(pCodec==<span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Codec not found</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Copy context</span><font></font>
  pCodecCtx = avcodec_alloc_context3(pCodec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Open codec</span>
  <span class="hljs-keyword">if</span>(avcodec_open2(pCodecCtx, pCodec, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Could not open codec</span><font></font>
  <font></font>
  <span class="hljs-comment">// Allocate video frame</span><font></font>
  pFrame=av_frame_alloc();<font></font>
<font></font>
  <span class="hljs-comment">// Make a screen to put our video</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __DARWIN__</span>
        screen = SDL_SetVideoMode(pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        screen = SDL_SetVideoMode(pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="hljs-number">24</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-keyword">if</span>(!screen) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL: could not set video mode - exiting\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// Allocate a place to put our YUV image on that screen</span><font></font>
  bmp = SDL_CreateYUVOverlay(pCodecCtx-&gt;width,<font></font>
				 pCodecCtx-&gt;height,<font></font>
				 SDL_YV12_OVERLAY,<font></font>
				 screen);<font></font>
<font></font>
  <span class="hljs-comment">// initialize SWS context for software scaling</span><font></font>
  sws_ctx = sws_getContext(pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   pCodecCtx-&gt;pix_fmt,<font></font>
			   pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   PIX_FMT_YUV420P,<font></font>
			   SWS_BILINEAR,<font></font>
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span><font></font>
			   );<font></font>
<font></font>
<font></font>
<font></font>
  <span class="hljs-comment">// Read frames and save first five frames to disk</span>
  i=<span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet.stream_index==videoStream) {
      <span class="hljs-comment">// Decode video frame</span><font></font>
      avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);<font></font>
      <font></font>
      <span class="hljs-comment">// Did we get a video frame?</span>
      <span class="hljs-keyword">if</span>(frameFinished) {<font></font>
	SDL_LockYUVOverlay(bmp);<font></font>
<font></font>
	AVPicture pict;<font></font>
	pict.data[<span class="hljs-number">0</span>] = bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
	pict.data[<span class="hljs-number">1</span>] = bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
	pict.data[<span class="hljs-number">2</span>] = bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
<font></font>
	pict.linesize[<span class="hljs-number">0</span>] = bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
	pict.linesize[<span class="hljs-number">1</span>] = bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
	pict.linesize[<span class="hljs-number">2</span>] = bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
<font></font>
	<span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
	sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
		  pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
		  pict.data, pict.linesize);<font></font>
<font></font>
	SDL_UnlockYUVOverlay(bmp);<font></font>
	<font></font>
	rect.x = <span class="hljs-number">0</span>;<font></font>
	rect.y = <span class="hljs-number">0</span>;<font></font>
	rect.w = pCodecCtx-&gt;width;<font></font>
	rect.h = pCodecCtx-&gt;height;<font></font>
	SDL_DisplayYUVOverlay(bmp, &amp;rect);<font></font>
      <font></font>
      }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-comment">// Free the packet that was allocated by av_read_frame</span><font></font>
    av_free_packet(&amp;packet);<font></font>
    SDL_PollEvent(&amp;event);<font></font>
    <span class="hljs-keyword">switch</span>(event.type) {
    <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
      SDL_Quit();<font></font>
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// Free the YUV frame</span><font></font>
  av_frame_free(&amp;pFrame);<font></font>
  <font></font>
  <span class="hljs-comment">// Close the codec</span><font></font>
  avcodec_close(pCodecCtx);<font></font>
  avcodec_close(pCodecCtxOrig);<font></font>
  <font></font>
  <span class="hljs-comment">// Close the video file</span><font></font>
  avformat_close_input(&amp;pFormatCtx);<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDLå’Œè§†é¢‘</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†åœ¨å±å¹•ä¸Šç»˜å›¾ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SDLã€‚ SDLä»£è¡¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç®€å•ç›´æ¥å±‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚å®ƒæ˜¯è®¸å¤šé¡¹ç›®ä¸­ä½¿ç”¨çš„å‡ºè‰²çš„è·¨å¹³å°å¤šåª’ä½“åº“ã€‚æ‚¨å¯ä»¥åœ¨å®˜æ–¹ç½‘ç«™ä¸Šè·å¾—è¯¥åº“ï¼Œæˆ–è€…ä¸‹è½½é€‚ç”¨äºæ‚¨çš„æ“ä½œç³»ç»Ÿçš„å¼€å‘äººå‘˜è½¯ä»¶åŒ…ã€‚æ‚¨å°†éœ€è¦åº“æ¥ç¼–è¯‘æœ¬è¯¾ç¨‹ä¸­çš„ä»£ç ï¼ˆé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œæ‰€æœ‰å…¶ä»–è¯¾ç¨‹ä¹Ÿéƒ½é€‚ç”¨ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDLæœ‰è®¸å¤šåœ¨å±å¹•ä¸Šç»˜åˆ¶çš„æ–¹æ³•ã€‚æ˜¾ç¤ºç”µå½±çš„ä¸€ç§æ–¹æ³•æ˜¯æ‰€è°“çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUVè¦†ç›–</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£å¼ä¸Šï¼Œç”šè‡³ä¸æ˜¯YUVï¼Œè€Œæ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YCbCr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚é¡ºä¾¿è¯´ä¸€å¥ï¼Œå½“â€œ YCbCrâ€è¢«ç§°ä¸ºâ€œ YUVâ€æ—¶ï¼ŒæŸäº›äººä¼šéå¸¸ç‡ƒçƒ§ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒYUVæ˜¯æ¨¡æ‹Ÿæ ¼å¼ï¼Œè€ŒYCbCræ˜¯æ•°å­—æ ¼å¼ã€‚ FFmpegå’ŒSDLåœ¨å…¶ä»£ç å’Œå®ä¸­å°†YCbCræŒ‡å®šä¸ºYUVï¼Œä½†è¿™æ˜¯ã€‚</font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯ä¸€ç§å­˜å‚¨åŸå§‹å›¾åƒæ•°æ®ï¼ˆä¾‹å¦‚RGBï¼‰çš„æ–¹æ³•ã€‚å¤§è‡´æ¥è¯´ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº®åº¦</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„ç»„æˆéƒ¨åˆ†</font><font style="vertical-align: inherit;">ï¼Œè€Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¢œè‰²çš„</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»„æˆéƒ¨åˆ†</font><font style="vertical-align: inherit;">ã€‚ ï¼ˆè¿™æ¯”RGBæ›´å¤æ‚ï¼Œå› ä¸ºéƒ¨åˆ†é¢œè‰²ä¿¡æ¯è¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”</font><font style="vertical-align: inherit;">æ¯2ä¸ª</font><b><font style="vertical-align: inherit;">Y</font></b><font style="vertical-align: inherit;">å€¼åªèƒ½æœ‰1ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€¼ã€‚</font><font style="vertical-align: inherit;">ï¼‰</font><b><font style="vertical-align: inherit;">YUVå åŠ </font></b></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDLä¸­çš„æ¥å—åŸå§‹YUVæ•°æ®é›†å¹¶æ˜¾ç¤ºå®ƒã€‚å®ƒæ¥å—4ç§ä¸åŒçš„YUVæ ¼å¼ï¼Œä½†æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YV12</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯å…¶ä¸­æœ€å¿«çš„ä¸€ç§ã€‚</font><font style="vertical-align: inherit;">é™¤äº†</font><font style="vertical-align: inherit;">äº¤æ¢</font><b><font style="vertical-align: inherit;">U</font></b><font style="vertical-align: inherit;">å’Œ</font><b><font style="vertical-align: inherit;">V</font></b><font style="vertical-align: inherit;">çš„æ•°ç»„ä¹‹å¤–ï¼Œ</font><font style="vertical-align: inherit;">è¿˜æœ‰å¦ä¸€ç§YUVæ ¼å¼ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV420P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®ƒä¸YV12åŒ¹é…</font><font style="vertical-align: inherit;">ã€‚ 420è¡¨ç¤ºä»¥4ï¼š2ï¼š0çš„æ¯”ç‡å¯¹å…¶è¿›è¡Œé‡‡æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯4æ¬¡äº®åº¦æµ‹é‡éƒ½è¿›è¡Œ1æ¬¡é¢œè‰²æµ‹é‡ï¼Œå› æ­¤é¢œè‰²ä¿¡æ¯æŒ‰å››åˆ†ä¹‹ä¸€åˆ†å¸ƒã€‚è¿™æ˜¯èŠ‚çœå¸¦å®½çš„å¥½æ–¹æ³•ï¼Œå› ä¸ºäººçœ¼ä»ç„¶æ²¡æœ‰æ³¨æ„åˆ°è¿™äº›å˜åŒ–ã€‚åœ¨åç§°æ‹‰ä¸å­—æ¯â€œPâ€è¡¨ç¤ºè¯¥æ ¼å¼æ˜¯â€œå¹³é¢â€ï¼Œå®ƒç®€å•åœ°æ„å‘³ç€è¯¥ç»„ä»¶æ˜¯</font><b><font style="vertical-align: inherit;">Ã¿</font></b><font style="vertical-align: inherit;">ï¼Œ</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨å•ç‹¬çš„æ•°ç»„ä¸­ã€‚</font><font style="vertical-align: inherit;">FFmpegå¯ä»¥å°†å›¾åƒè½¬æ¢ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV420P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œè¿™éå¸¸æœ‰å¸®åŠ©ï¼Œå› ä¸ºè®¸å¤šè§†é¢‘æµå·²ç»ä»¥è¿™ç§æ ¼å¼å­˜å‚¨æˆ–æ˜“äºè½¬æ¢ä¸ºå®ƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæˆ‘ä»¬å½“å‰çš„è®¡åˆ’æ˜¯æ›¿æ¢</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šä¸€è¯¾ä¸­çš„SaveFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼Œå¹¶æ˜¾ç¤ºæˆ‘ä»¬çš„æ¡†æ¶ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯é¦–å…ˆï¼Œæ‚¨éœ€è¦ç†Ÿæ‚‰SDLåº“çš„åŸºæœ¬åŠŸèƒ½ã€‚</font><font style="vertical-align: inherit;">é¦–å…ˆï¼Œè¿æ¥åº“å¹¶åˆå§‹åŒ–SDLï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL_thread.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰æœ¬è´¨ä¸Šå‘Šè¯‰åº“æˆ‘ä»¬å°†ä½¿ç”¨å“ªäº›å‡½æ•°ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_GetError</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯æˆ‘ä»¬æ–¹ä¾¿çš„è°ƒè¯•åŠŸèƒ½ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¾ç¤ºåˆ¶ä½œ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨å±å¹•ä¸Šæ”¾ç½®ä¸€ä¸ªä½ç½®æ¥æ’åˆ—å…ƒç´ ã€‚</font><font style="vertical-align: inherit;">ä½¿ç”¨SDLæ˜¾ç¤ºå›¾åƒçš„ä¸»è¦åŒºåŸŸç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¡¨é¢</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">SDL_Surface *screen;<font></font>
<font></font>
screen = SDL_SetVideoMode(pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span>(!screen) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL: could not set video mode - exiting\n"</span>);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæˆ‘ä»¬è®¾ç½®äº†å…·æœ‰ç»™å®šå®½åº¦å’Œé«˜åº¦çš„å±å¹•ã€‚</font><font style="vertical-align: inherit;">ä¸‹ä¸€ä¸ªé€‰é¡¹æ˜¯å±å¹•çš„ä½æ·±åº¦-0-è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºâ€œä¸å½“å‰æ˜¾ç¤ºç›¸åŒâ€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬</font><font style="vertical-align: inherit;">åœ¨æ­¤å±å¹•ä¸Š</font><font style="vertical-align: inherit;">åˆ›å»ºä¸€ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUVå åŠ å±‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å‘å…¶è¾“å‡ºè§†é¢‘ï¼Œå¹¶é…ç½®</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWSContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†å›¾åƒæ•°æ®è½¬æ¢ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV420</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">SDL_Overlay     *bmp = <span class="hljs-literal">NULL</span>;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SWSContext</span> *<span class="hljs-title">sws_ctx</span> = <span class="hljs-title">NULL</span>;</span><font></font>
<font></font>
bmp = SDL_CreateYUVOverlay(pCodecCtx-&gt;width, pCodecCtx-&gt;height,<font></font>
                           SDL_YV12_OVERLAY, screen);<font></font>
<font></font>
<span class="hljs-comment">// initialize SWS context for software scaling</span><font></font>
sws_ctx = sws_getContext(pCodecCtx-&gt;width,<font></font>
                         pCodecCtx-&gt;height,<font></font>
			 pCodecCtx-&gt;pix_fmt,<font></font>
			 pCodecCtx-&gt;width,<font></font>
			 pCodecCtx-&gt;height,<font></font>
			 PIX_FMT_YUV420P,<font></font>
			 SWS_BILINEAR,<font></font>
			 <span class="hljs-literal">NULL</span>,
			 <span class="hljs-literal">NULL</span>,
			 <span class="hljs-literal">NULL</span>
			 );</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YV12</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥æ˜¾ç¤ºå›¾åƒå¹¶</font><font style="vertical-align: inherit;">ä»FFmpeg </font><font style="vertical-align: inherit;">è·å–</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV420</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°æ®</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›¾åƒæ˜¾ç¤º</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½å§ï¼Œè¿™å¾ˆå®¹æ˜“ï¼ç°åœ¨æˆ‘ä»¬åªéœ€è¦æ˜¾ç¤ºå›¾åƒã€‚è®©æˆ‘ä»¬ä¸€ç›´èµ°åˆ°å®Œæˆæ‹æ‘„çš„åœ°æ–¹ã€‚æˆ‘ä»¬å¯ä»¥æ‘†è„±RGBå¸§çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶</font><font style="vertical-align: inherit;">ç”¨æ˜¾ç¤ºä»£ç </font><font style="vertical-align: inherit;">æ›¿æ¢</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚ä¸ºäº†æ˜¾ç¤ºå›¾åƒï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ï¼Œå¹¶ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUVå åŠ å±‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®¾ç½®å…¶æ•°æ®æŒ‡é’ˆå’Œè¡Œå¤§å°</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span>(frameFinished) {<font></font>
    SDL_LockYUVOverlay(bmp);<font></font>
<font></font>
    AVPicture pict;<font></font>
    pict.data[<span class="hljs-number">0</span>] = bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
    pict.data[<span class="hljs-number">1</span>] = bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
    pict.data[<span class="hljs-number">2</span>] = bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
<font></font>
    pict.linesize[<span class="hljs-number">0</span>] = bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
    pict.linesize[<span class="hljs-number">1</span>] = bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
    pict.linesize[<span class="hljs-number">2</span>] = bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
<font></font>
    <span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
    sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
	      pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
	      pict.data, pict.linesize);<font></font>
    <font></font>
    SDL_UnlockYUVOverlay(bmp);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬è®¡åˆ’è¦†ç›–è¯¥è¦†ç›–å±‚ï¼Œå› ä¸ºæˆ‘ä»¬è®¡åˆ’å¯¹å…¶è¿›è¡Œå†™å…¥ã€‚è¿™æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œè¿™æ ·ä»¥åå°±æ²¡æœ‰é—®é¢˜äº†ã€‚</font><font style="vertical-align: inherit;">å¦‚ä¸Šæ‰€ç¤ºï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">å…·æœ‰ä¸€ä¸ªæ•°æ®æŒ‡é’ˆï¼Œè¯¥æ•°æ®æŒ‡é’ˆæ˜¯4ä¸ªæŒ‡é’ˆçš„æ•°ç»„ã€‚ç”±äºåœ¨è¿™é‡Œæˆ‘ä»¬è¦å¤„ç†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV420P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæœ‰3ä¸ªé€šé“ï¼Œå› æ­¤åªæœ‰3ä¸ªæ•°æ®é›†ã€‚å…¶ä»–æ ¼å¼å¯èƒ½å…·æœ‰ç”¨äºalphaé€šé“æˆ–å…¶ä»–å†…å®¹çš„ç¬¬å››ä¸ªæŒ‡é’ˆã€‚è¡Œå¤§å°å°±æ˜¯å®ƒçš„æ ·å­ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUVå åŠ å±‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­çš„</font><font style="vertical-align: inherit;">ç±»ä¼¼ç»“æ„</font><font style="vertical-align: inherit;">æ˜¯åƒç´ å’Œé«˜åº¦çš„å˜é‡ã€‚ ï¼ˆé—´è·ï¼Œé—´è·-å¦‚æœç”¨SDLè¡¨ç¤ºä»¥è¡¨ç¤ºç»™å®šæ•°æ®å­—ç¬¦ä¸²çš„å®½åº¦ã€‚ï¼‰å› æ­¤ï¼Œæˆ‘ä»¬</font><font style="vertical-align: inherit;">åœ¨å åŠ å±‚ä¸Š</font><font style="vertical-align: inherit;">è¡¨ç¤ºäº†ä¸‰ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pict.dataæ•°ç»„</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå› æ­¤å½“æˆ‘ä»¬å†™å…¥æ—¶</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pict</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®é™…ä¸Šæ˜¯æˆ‘ä»¬åœ¨å åŠ å±‚ä¸­è¿›è¡Œè®°å½•ï¼Œå½“ç„¶ï¼Œå åŠ å±‚å·²ç»ä¸ºå®ƒä¸“é—¨åˆ†é…äº†å¿…è¦çš„ç©ºé—´ã€‚</font><font style="vertical-align: inherit;">ä»¥åŒæ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬ç›´æ¥ä»å åŠ å±‚ä¸­è·å¾—çº¿å¾„ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†è½¬æ¢æ ¼å¼æ›´æ”¹ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIX_FMT_YUV420P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶</font><font style="vertical-align: inherit;">åƒä»¥å‰ä¸€æ ·</font><font style="vertical-align: inherit;">ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sws_scale</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›¾åƒç»˜å›¾</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦æŒ‡å®šSDLï¼Œä»¥ä¾¿å®ƒçœŸæ­£æ˜¾ç¤ºæˆ‘ä»¬æä¾›ç»™å®ƒçš„æ•°æ®ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬è¿˜å‘è¯¥å‡½æ•°ä¼ é€’äº†ä¸€ä¸ªçŸ©å½¢ï¼Œè¯¥çŸ©å½¢æŒ‡ç¤ºå½±ç‰‡åº”è¯¥æ”¾å“ªé‡Œï¼Œåº”ç¼©æ”¾å½±ç‰‡çš„å®½åº¦å’Œé«˜åº¦ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼ŒSDLå¯ä¸ºæˆ‘ä»¬æ‰©å±•ï¼Œè¿™å¯ä»¥å¸®åŠ©æ‚¨çš„GPUæ›´å¿«åœ°æ‰©å±•ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">SDL_Rect rect;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(frameFinished) {
    <span class="hljs-comment">/* ... code ... */</span>
    <span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
    sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
              pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
	      pict.data, pict.linesize);<font></font>
    <font></font>
    SDL_UnlockYUVOverlay(bmp);<font></font>
	rect.x = <span class="hljs-number">0</span>;<font></font>
	rect.y = <span class="hljs-number">0</span>;<font></font>
	rect.w = pCodecCtx-&gt;width;<font></font>
	rect.h = pCodecCtx-&gt;height;<font></font>
	SDL_DisplayYUVOverlay(bmp, &amp;rect);<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬çš„è§†é¢‘å·²æ˜¾ç¤ºï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬å±•ç¤ºSDLçš„å¦ä¸€ä¸ªåŠŸèƒ½ï¼š</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹ä»¶ç³»ç»Ÿ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ SDLçš„é…ç½®æ–¹å¼ä½¿å¾—å½“æ‚¨åœ¨SDLåº”ç”¨ç¨‹åºä¸­è¾“å…¥æˆ–ç§»åŠ¨é¼ æ ‡æˆ–å‘å…¶å‘é€ä¿¡å·æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªäº‹ä»¶ã€‚ç„¶åï¼Œå¦‚æœç¨‹åºæ‰“ç®—å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œåˆ™æ£€æŸ¥è¿™äº›äº‹ä»¶ã€‚æ‚¨çš„ç¨‹åºè¿˜å¯ä»¥åˆ›å»ºäº‹ä»¶ä»¥å°†SDLäº‹ä»¶å‘é€åˆ°ç³»ç»Ÿã€‚è¿™å¯¹äºä½¿ç”¨SDLè¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹ç‰¹åˆ«æœ‰ç”¨ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬4è¯¾ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†åœ¨å¤„ç†ç¨‹åºåŒ…åç«‹å³æ£€æŸ¥äº‹ä»¶ã€‚ç›®å‰ï¼Œæˆ‘ä»¬å°†å¤„ç†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_QUIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹ä»¶ï¼Œ</font><b><font style="vertical-align: inherit;">ä»¥ä¾¿</font></b><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥é€€å‡ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">SDL_Event       event;<font></font>
<font></font>
    av_free_packet(&amp;packet);<font></font>
    SDL_PollEvent(&amp;event);<font></font>
    <span class="hljs-keyword">switch</span>(event.type) {
    <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
      SDL_Quit();<font></font>
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ ·æˆ‘ä»¬å°±æ´»ç€ï¼æˆ‘ä»¬æ‘†è„±äº†æ‰€æœ‰æ—§çš„åƒåœ¾ï¼Œå¹¶å‡†å¤‡å¥½è¿›è¡Œç¼–è¯‘ã€‚å¦‚æœæ‚¨ä½¿ç”¨Linuxæˆ–ç±»ä¼¼Linuxçš„è½¯ä»¶ï¼Œåˆ™ä½¿ç”¨SDLåº“è¿›è¡Œç¼–è¯‘çš„æœ€ä½³æ–¹æ³•æ˜¯ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial02 tutorial02.c -lavformat -lavcodec -lswscale -lz -lm \<font></font>
`sdl-config --cflags --libs`</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdl-config</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…æ˜¾ç¤º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gcc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„å¿…è¦æ ‡å¿—ï¼Œ</font><font style="vertical-align: inherit;">ä»¥æ­£ç¡®å¯ç”¨SDLåº“ã€‚</font><font style="vertical-align: inherit;">æ‚¨å¯èƒ½éœ€è¦åšå…¶ä»–äº‹æƒ…æ‰èƒ½åœ¨æ‚¨çš„ç³»ç»Ÿä¸Šè¿›è¡Œç¼–è¯‘ã€‚</font><font style="vertical-align: inherit;">è¯·ä¸ºä»»ä½•æ¶ˆé˜²å‘˜æ£€æŸ¥ç³»ç»Ÿçš„SDLæ–‡æ¡£ã€‚</font><font style="vertical-align: inherit;">ç¼–è¯‘åï¼Œç»§ç»­è¿è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿è¡Œæ­¤ç¨‹åºä¼šæ€æ ·ï¼Ÿ</font><font style="vertical-align: inherit;">è¯¥è§†é¢‘ä¼¼ä¹å¿«è¦ç–¯äº†ï¼</font><font style="vertical-align: inherit;">å®é™…ä¸Šï¼Œæˆ‘ä»¬åªéœ€æ˜¾ç¤ºæ‰€æœ‰è§†é¢‘å¸§ï¼Œå°±å¯ä»¥ä»ç”µå½±æ–‡ä»¶ä¸­æå–å®ƒä»¬ä¸€æ ·å¿«ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç°åœ¨æ²¡æœ‰ä»£ç æ¥ç¡®å®šä½•æ—¶éœ€è¦æ˜¾ç¤ºè§†é¢‘ã€‚</font><font style="vertical-align: inherit;">æœ€åï¼ˆç¬¬5è¯¾ï¼‰ï¼Œæˆ‘ä»¬å°†å¼€å§‹åŒæ­¥è§†é¢‘ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯æ­¤åˆ»ï¼Œæˆ‘ä»¬ç¼ºå°‘äº†åŒæ ·é‡è¦çš„ä¸œè¥¿ï¼šå£°éŸ³ï¼</font></font><a name="sound"></a><br>
<br>
<hr><hr><hr><hr><hr><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬3è¯¾ï¼šæ’­æ”¾å£°éŸ³</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬2è¯¾ï¼šæ˜¾ç¤º"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â† </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â‡‘ </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬4è¯¾ï¼šå¤šçº¿ç¨‹"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â†’</font></font></a></h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæ•´æ¸…å•ï¼štutorial03.c</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">// tutorial03.c</span>
<span class="hljs-comment">// A pedagogical video player that will stream through every video frame as fast as it can</span>
<span class="hljs-comment">// and play audio (out of sync).</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Code based on FFplay, Copyright (c) 2003 Fabrice Bellard, </span>
<span class="hljs-comment">// and a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span>
<span class="hljs-comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span>
<span class="hljs-comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span>
<span class="hljs-comment">// Updates tested on:</span>
<span class="hljs-comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101, SDL 1.2.15</span>
<span class="hljs-comment">// on GCC 4.7.2 in Debian February 2015</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Use</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// gcc -o tutorial03 tutorial03.c -lavformat -lavcodec -lswscale -lz -lm `sdl-config --cflags --libs`</span>
<span class="hljs-comment">// to build (assuming libavformat and libavcodec are correctly installed, </span>
<span class="hljs-comment">// and assuming you have sdl-config. Please refer to SDL docs for your installation.)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Run using</span>
<span class="hljs-comment">// tutorial03 myvideofile.mpg</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to play the stream on your screen.</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libswscale/swscale.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL_thread.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __MINGW32__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> main <span class="hljs-comment">/* Prevents SDL from overriding main() */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// compatibility with newer API</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_free avcodec_free_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PacketQueue</span> {</span><font></font>
  AVPacketList *first_pkt, *last_pkt;<font></font>
  <span class="hljs-keyword">int</span> nb_packets;
  <span class="hljs-keyword">int</span> size;<font></font>
  SDL_mutex *mutex;<font></font>
  SDL_cond *cond;<font></font>
} PacketQueue;<font></font>
<font></font>
PacketQueue audioq;<font></font>
<font></font>
<span class="hljs-keyword">int</span> quit = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packet_queue_init</span><span class="hljs-params">(PacketQueue *q)</span> </span>{
  <span class="hljs-built_in">memset</span>(q, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(PacketQueue));<font></font>
  q-&gt;mutex = SDL_CreateMutex();<font></font>
  q-&gt;cond = SDL_CreateCond();<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_put</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt)</span> </span>{<font></font>
<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">if</span>(av_dup_packet(pkt) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  pkt1 = av_malloc(<span class="hljs-keyword">sizeof</span>(AVPacketList));
  <span class="hljs-keyword">if</span> (!pkt1)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  pkt1-&gt;pkt = *pkt;<font></font>
  pkt1-&gt;next = <span class="hljs-literal">NULL</span>;<font></font>
  <font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (!q-&gt;last_pkt)<font></font>
    q-&gt;first_pkt = pkt1;<font></font>
  <span class="hljs-keyword">else</span><font></font>
    q-&gt;last_pkt-&gt;next = pkt1;<font></font>
  q-&gt;last_pkt = pkt1;<font></font>
  q-&gt;nb_packets++;<font></font>
  q-&gt;size += pkt1-&gt;pkt.size;<font></font>
  SDL_CondSignal(q-&gt;cond);<font></font>
  <font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_get</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt, <span class="hljs-keyword">int</span> block)</span>
</span>{<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">int</span> ret;<font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(quit) {<font></font>
      ret = <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    pkt1 = q-&gt;first_pkt;<font></font>
    <span class="hljs-keyword">if</span> (pkt1) {<font></font>
      q-&gt;first_pkt = pkt1-&gt;next;<font></font>
      <span class="hljs-keyword">if</span> (!q-&gt;first_pkt)<font></font>
	q-&gt;last_pkt = <span class="hljs-literal">NULL</span>;<font></font>
      q-&gt;nb_packets--;<font></font>
      q-&gt;size -= pkt1-&gt;pkt.size;<font></font>
      *pkt = pkt1-&gt;pkt;<font></font>
      av_free(pkt1);<font></font>
      ret = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!block) {<font></font>
      ret = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      SDL_CondWait(q-&gt;cond, q-&gt;mutex);<font></font>
    }<font></font>
  }<font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">audio_decode_frame</span><span class="hljs-params">(AVCodecContext *aCodecCtx, <span class="hljs-keyword">uint8_t</span> *audio_buf, <span class="hljs-keyword">int</span> buf_size)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">static</span> AVPacket pkt;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> *audio_pkt_data = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> audio_pkt_size = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">static</span> AVFrame frame;<font></font>
<font></font>
  <span class="hljs-keyword">int</span> len1, data_size = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">while</span>(audio_pkt_size &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">int</span> got_frame = <span class="hljs-number">0</span>;<font></font>
      len1 = avcodec_decode_audio4(aCodecCtx, &amp;frame, &amp;got_frame, &amp;pkt);<font></font>
      <span class="hljs-keyword">if</span>(len1 &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* if error, skip frame */</span>
	audio_pkt_size = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      audio_pkt_data += len1;<font></font>
      audio_pkt_size -= len1;<font></font>
      data_size = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span>(got_frame) {<font></font>
	data_size = av_samples_get_buffer_size(<span class="hljs-literal">NULL</span>, <font></font>
					       aCodecCtx-&gt;channels,<font></font>
					       frame.nb_samples,<font></font>
					       aCodecCtx-&gt;sample_fmt,<font></font>
					       <span class="hljs-number">1</span>);<font></font>
	assert(data_size &lt;= buf_size);<font></font>
	<span class="hljs-built_in">memcpy</span>(audio_buf, frame.data[<span class="hljs-number">0</span>], data_size);<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span>(data_size &lt;= <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* No data yet, get more frames */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      }<font></font>
      <span class="hljs-comment">/* We have data, return it and come back for more later */</span>
      <span class="hljs-keyword">return</span> data_size;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pkt.data)<font></font>
      av_free_packet(&amp;pkt);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;audioq, &amp;pkt, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    audio_pkt_data = pkt.data;<font></font>
    audio_pkt_size = pkt.size;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">audio_callback</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata, Uint8 *stream, <span class="hljs-keyword">int</span> len)</span> </span>{<font></font>
<font></font>
  AVCodecContext *aCodecCtx = (AVCodecContext *)userdata;<font></font>
  <span class="hljs-keyword">int</span> len1, audio_size;<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> audio_buf[(MAX_AUDIO_FRAME_SIZE * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>];
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> audio_buf_size = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> audio_buf_index = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">while</span>(len &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span>(audio_buf_index &gt;= audio_buf_size) {
      <span class="hljs-comment">/* We have already sent all our data; get more */</span>
      audio_size = audio_decode_frame(aCodecCtx, audio_buf, <span class="hljs-keyword">sizeof</span>(audio_buf));
      <span class="hljs-keyword">if</span>(audio_size &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* If error, output silence */</span>
	audio_buf_size = <span class="hljs-number">1024</span>; <span class="hljs-comment">// arbitrary?</span>
	<span class="hljs-built_in">memset</span>(audio_buf, <span class="hljs-number">0</span>, audio_buf_size);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
	audio_buf_size = audio_size;<font></font>
      }<font></font>
      audio_buf_index = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    len1 = audio_buf_size - audio_buf_index;<font></font>
    <span class="hljs-keyword">if</span>(len1 &gt; len)<font></font>
      len1 = len;<font></font>
    <span class="hljs-built_in">memcpy</span>(stream, (<span class="hljs-keyword">uint8_t</span> *)audio_buf + audio_buf_index, len1);<font></font>
    len -= len1;<font></font>
    stream += len1;<font></font>
    audio_buf_index += len1;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{<font></font>
  AVFormatContext *pFormatCtx = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">int</span>             i, videoStream, audioStream;<font></font>
  AVCodecContext  *pCodecCtxOrig = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodecContext  *pCodecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec         *pCodec = <span class="hljs-literal">NULL</span>;<font></font>
  AVFrame         *pFrame = <span class="hljs-literal">NULL</span>;<font></font>
  AVPacket        packet;<font></font>
  <span class="hljs-keyword">int</span>             frameFinished;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span> = <span class="hljs-title">NULL</span>;</span><font></font>
  <font></font>
  AVCodecContext  *aCodecCtxOrig = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodecContext  *aCodecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec         *aCodec = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
  SDL_Overlay     *bmp;<font></font>
  SDL_Surface     *screen;<font></font>
  SDL_Rect        rect;<font></font>
  SDL_Event       event;<font></font>
  SDL_AudioSpec   wanted_spec, spec;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Usage: test &lt;file&gt;\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-comment">// Register all formats and codecs</span><font></font>
  av_register_all();<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Open video file</span>
  <span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span><font></font>
  <font></font>
  <span class="hljs-comment">// Retrieve stream information</span>
  <span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span><font></font>
  <font></font>
  <span class="hljs-comment">// Dump information about file onto standard error</span>
  av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, argv[<span class="hljs-number">1</span>], <span class="hljs-number">0</span>);<font></font>
    <font></font>
  <span class="hljs-comment">// Find the first video stream</span>
  videoStream=<span class="hljs-number">-1</span>;<font></font>
  audioStream=<span class="hljs-number">-1</span>;
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) {
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
       videoStream &lt; <span class="hljs-number">0</span>) {<font></font>
      videoStream=i;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
       audioStream &lt; <span class="hljs-number">0</span>) {<font></font>
      audioStream=i;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(videoStream==<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Didn't find a video stream</span>
  <span class="hljs-keyword">if</span>(audioStream==<span class="hljs-number">-1</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
   <font></font>
  aCodecCtxOrig=pFormatCtx-&gt;streams[audioStream]-&gt;codec;<font></font>
  aCodec = avcodec_find_decoder(aCodecCtxOrig-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(!aCodec) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Copy context</span><font></font>
  aCodecCtx = avcodec_alloc_context3(aCodec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(aCodecCtx, aCodecCtxOrig) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Set audio settings from codec info</span><font></font>
  wanted_spec.freq = aCodecCtx-&gt;sample_rate;<font></font>
  wanted_spec.format = AUDIO_S16SYS;<font></font>
  wanted_spec.channels = aCodecCtx-&gt;channels;<font></font>
  wanted_spec.silence = <span class="hljs-number">0</span>;<font></font>
  wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;<font></font>
  wanted_spec.callback = audio_callback;<font></font>
  wanted_spec.userdata = aCodecCtx;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  avcodec_open2(aCodecCtx, aCodec, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  <span class="hljs-comment">// audio_st = pFormatCtx-&gt;streams[index]</span><font></font>
  packet_queue_init(&amp;audioq);<font></font>
  SDL_PauseAudio(<span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">// Get a pointer to the codec context for the video stream</span><font></font>
  pCodecCtxOrig=pFormatCtx-&gt;streams[videoStream]-&gt;codec;<font></font>
  <font></font>
  <span class="hljs-comment">// Find the decoder for the video stream</span><font></font>
  pCodec=avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(pCodec==<span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Codec not found</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Copy context</span><font></font>
  pCodecCtx = avcodec_alloc_context3(pCodec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Open codec</span>
  <span class="hljs-keyword">if</span>(avcodec_open2(pCodecCtx, pCodec, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Could not open codec</span><font></font>
  <font></font>
  <span class="hljs-comment">// Allocate video frame</span><font></font>
  pFrame=av_frame_alloc();<font></font>
<font></font>
  <span class="hljs-comment">// Make a screen to put our video</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __DARWIN__</span>
        screen = SDL_SetVideoMode(pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        screen = SDL_SetVideoMode(pCodecCtx-&gt;width, pCodecCtx-&gt;height, <span class="hljs-number">24</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-keyword">if</span>(!screen) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL: could not set video mode - exiting\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">// Allocate a place to put our YUV image on that screen</span><font></font>
  bmp = SDL_CreateYUVOverlay(pCodecCtx-&gt;width,<font></font>
				 pCodecCtx-&gt;height,<font></font>
				 SDL_YV12_OVERLAY,<font></font>
				 screen);<font></font>
<font></font>
  <span class="hljs-comment">// initialize SWS context for software scaling</span><font></font>
  sws_ctx = sws_getContext(pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   pCodecCtx-&gt;pix_fmt,<font></font>
			   pCodecCtx-&gt;width,<font></font>
			   pCodecCtx-&gt;height,<font></font>
			   PIX_FMT_YUV420P,<font></font>
			   SWS_BILINEAR,<font></font>
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span>,
			   <span class="hljs-literal">NULL</span><font></font>
			   );<font></font>
<font></font>
  <span class="hljs-comment">// Read frames and save first five frames to disk</span>
  i=<span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet.stream_index==videoStream) {
      <span class="hljs-comment">// Decode video frame</span><font></font>
      avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);<font></font>
      <font></font>
      <span class="hljs-comment">// Did we get a video frame?</span>
      <span class="hljs-keyword">if</span>(frameFinished) {<font></font>
	SDL_LockYUVOverlay(bmp);<font></font>
<font></font>
	AVPicture pict;<font></font>
	pict.data[<span class="hljs-number">0</span>] = bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
	pict.data[<span class="hljs-number">1</span>] = bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
	pict.data[<span class="hljs-number">2</span>] = bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
<font></font>
	pict.linesize[<span class="hljs-number">0</span>] = bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
	pict.linesize[<span class="hljs-number">1</span>] = bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
	pict.linesize[<span class="hljs-number">2</span>] = bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
<font></font>
	<span class="hljs-comment">// Convert the image into YUV format that SDL uses	</span>
	sws_scale(sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
		  pFrame-&gt;linesize, <span class="hljs-number">0</span>, pCodecCtx-&gt;height,<font></font>
		  pict.data, pict.linesize);<font></font>
	<font></font>
	SDL_UnlockYUVOverlay(bmp);<font></font>
	<font></font>
	rect.x = <span class="hljs-number">0</span>;<font></font>
	rect.y = <span class="hljs-number">0</span>;<font></font>
	rect.w = pCodecCtx-&gt;width;<font></font>
	rect.h = pCodecCtx-&gt;height;<font></font>
	SDL_DisplayYUVOverlay(bmp, &amp;rect);<font></font>
	av_free_packet(&amp;packet);<font></font>
      }<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(packet.stream_index==audioStream) {<font></font>
      packet_queue_put(&amp;audioq, &amp;packet);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      av_free_packet(&amp;packet);<font></font>
    }<font></font>
    <span class="hljs-comment">// Free the packet that was allocated by av_read_frame</span><font></font>
    SDL_PollEvent(&amp;event);<font></font>
    <span class="hljs-keyword">switch</span>(event.type) {
    <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
      quit = <span class="hljs-number">1</span>;<font></font>
      SDL_Quit();<font></font>
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Free the YUV frame</span><font></font>
  av_frame_free(&amp;pFrame);<font></font>
  <font></font>
  <span class="hljs-comment">// Close the codecs</span><font></font>
  avcodec_close(pCodecCtxOrig);<font></font>
  avcodec_close(pCodecCtx);<font></font>
  avcodec_close(aCodecCtxOrig);<font></font>
  avcodec_close(aCodecCtx);<font></font>
  <font></font>
  <span class="hljs-comment">// Close the video file</span><font></font>
  avformat_close_input(&amp;pFormatCtx);<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŸ³è®¯</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›å£°éŸ³åœ¨åº”ç”¨ç¨‹åºä¸­æ’­æ”¾ã€‚</font><font style="vertical-align: inherit;">SDLè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†æ’­æ”¾å£°éŸ³çš„æ–¹æ³•ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_OpenAudio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ç”¨äºæ‰“å¼€éŸ³é¢‘è®¾å¤‡æœ¬èº«ã€‚</font><font style="vertical-align: inherit;">å®ƒä»¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_AudioSpec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„ä½œä¸ºå‚æ•°ï¼Œè¯¥ç»“æ„</font><font style="vertical-align: inherit;">åŒ…å«æœ‰å…³æˆ‘ä»¬å°†è¦æ’­æ”¾çš„éŸ³é¢‘çš„æ‰€æœ‰ä¿¡æ¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å±•ç¤ºå¦‚ä½•é…ç½®å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¯´æ˜è®¡ç®—æœºé€šå¸¸å¦‚ä½•å¤„ç†éŸ³é¢‘ã€‚</font><font style="vertical-align: inherit;">æ•°å­—éŸ³é¢‘åŒ…å«å¤§é‡</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ·æœ¬</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ¯ä¸ªä»£è¡¨å£°æ³¢çš„ç‰¹å®šå«ä¹‰ã€‚å£°éŸ³ä»¥ç‰¹å®šçš„é‡‡æ ·ç‡è®°å½•ï¼Œè¯¥é‡‡æ ·ç‡ä»…æŒ‡ç¤ºæ¯ä¸ªæ ·æœ¬çš„æ’­æ”¾é€Ÿåº¦ï¼Œå¹¶é€šè¿‡æ¯ç§’çš„æ ·æœ¬æ•°è¿›è¡Œæµ‹é‡ã€‚å¤§æ¦‚çš„é‡‡æ ·é¢‘ç‡æ˜¯</font><font style="vertical-align: inherit;">æ¯ç§’</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22,050</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">44,100ä¸ª</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡‡æ ·ï¼Œåˆ†åˆ«æ˜¯ç”¨äºæ— çº¿ç”µå’ŒCDçš„é€Ÿåº¦ã€‚æ­¤å¤–ï¼Œå¤§å¤šæ•°éŸ³é¢‘å¯ä»¥æœ‰å¤šä¸ªå£°é“ç”¨äºç«‹ä½“å£°æˆ–ç¯ç»•å£°ï¼Œå› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ ·æœ¬ä¸ºç«‹ä½“å£°ï¼Œåˆ™æ ·æœ¬ä¸€æ¬¡å°†ä¸ºä¸¤ä¸ªã€‚å½“æˆ‘ä»¬ä»ç”µå½±æ–‡ä»¶ä¸­è·å–æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å°†è·å¾—å¤šå°‘æ ·æœ¬ï¼Œä½†æ˜¯FFmpegä¸ä¼šäº§ç”Ÿæ®‹ç¼ºçš„æ ·æœ¬-è¿™ä¹Ÿæ„å‘³ç€å®ƒä¹Ÿä¸ä¼šåˆ†ç¦»ç«‹ä½“å£°æ ·æœ¬ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨SDLä¸­æ’­æ”¾éŸ³é¢‘çš„æ–¹æ³•å¦‚ä¸‹ã€‚</font><font style="vertical-align: inherit;">å£°éŸ³å‚æ•°å·²é…ç½®ï¼šé‡‡æ ·é¢‘ç‡ï¼Œé€šé“æ•°ç­‰ã€‚</font><font style="vertical-align: inherit;">å¹¶åŒæ—¶è®¾ç½®å›è°ƒå‡½æ•°å’Œç”¨æˆ·æ•°æ®ã€‚</font><font style="vertical-align: inherit;">å½“æˆ‘ä»¬å¼€å§‹æ’­æ”¾å£°éŸ³æ—¶ï¼ŒSDLå°†ä¸æ–­è°ƒç”¨æ­¤å›è°ƒå‡½æ•°ï¼Œå¹¶è¦æ±‚å®ƒç”¨ä¸€å®šæ•°é‡çš„å­—èŠ‚å¡«å……éŸ³é¢‘ç¼“å†²åŒºã€‚</font><font style="vertical-align: inherit;">å°†è¿™äº›ä¿¡æ¯æ”¾å…¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_AudioSpec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„ä¹‹å</font><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_OpenAudio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ï¼Œå®ƒå°†æ‰“å¼€éŸ³é¢‘è®¾å¤‡å¹¶å‘</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿”å›å¦ä¸€ä¸ª</font><b><font style="vertical-align: inherit;">AudioSpec</font></b><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è¿™äº›æ˜¯æˆ‘ä»¬å°†å®é™…ä½¿ç”¨çš„ç‰¹å¾-æ— æ³•ä¿è¯æˆ‘ä»¬ä¼šå®Œå…¨å¾—åˆ°æˆ‘ä»¬æ‰€è¦æ±‚çš„ï¼</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŸ³è®¯è®¾å®š</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æš‚æ—¶è¯·è®°ä½ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰æœ‰å…³éŸ³é¢‘æµçš„ä»»ä½•ä¿¡æ¯ï¼</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å›åˆ°ä»£ç ä¸­æ‰¾åˆ°è§†é¢‘æµå¹¶æ‰¾å‡ºéŸ³é¢‘æµæ˜¯å“ªä¸ªä½ç½®çš„åœ°æ–¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Find the first video stream</span>
videoStream=<span class="hljs-number">-1</span>;<font></font>
audioStream=<span class="hljs-number">-1</span>;
<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i &lt; pFormatCtx-&gt;nb_streams; i++) {
  <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO<font></font>
     &amp;&amp;<font></font>
       videoStream &lt; <span class="hljs-number">0</span>) {<font></font>
    videoStream=i;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
     audioStream &lt; <span class="hljs-number">0</span>) {<font></font>
    audioStream=i;<font></font>
  }<font></font>
}<font></font>
<span class="hljs-keyword">if</span>(videoStream==<span class="hljs-number">-1</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Didn't find a video stream</span>
<span class="hljs-keyword">if</span>(audioStream==<span class="hljs-number">-1</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥</font><font style="vertical-align: inherit;">ä»æµä¸­</font><font style="vertical-align: inherit;">ä»</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å¾—æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯</font><font style="vertical-align: inherit;">ï¼Œå°±åƒæˆ‘ä»¬å¯¹è§†é¢‘æµæ‰€åšçš„é‚£æ ·ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecContext *aCodecCtxOrig;<font></font>
AVCodecContext *aCodecCtx;<font></font>
<font></font>
aCodecCtxOrig=pFormatCtx-&gt;streams[audioStream]-&gt;codec;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨è¿˜è®°å¾—çš„è¯ï¼Œåœ¨ä¸Šä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶å¿…é¡»æ‰“å¼€éŸ³é¢‘ç¼–è§£ç å™¨æœ¬èº«ã€‚</font><font style="vertical-align: inherit;">è¿™å¾ˆç®€å•ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec         *aCodec;<font></font>
<font></font>
aCodec = avcodec_find_decoder(aCodecCtx-&gt;codec_id);<font></font>
<span class="hljs-keyword">if</span>(!aCodec) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
<span class="hljs-comment">// Copy context</span><font></font>
aCodecCtx = avcodec_alloc_context3(aCodec);<font></font>
<span class="hljs-keyword">if</span>(avcodec_copy_context(aCodecCtx, aCodecCtxOrig) != <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
}<font></font>
<span class="hljs-comment">/* set up SDL Audio here */</span><font></font>
<font></font>
avcodec_open2(aCodecCtx, aCodec, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ç¼–è§£ç å™¨çš„ä¸Šä¸‹æ–‡ä¸­åŒ…å«é…ç½®éŸ³é¢‘æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">wanted_spec.freq = aCodecCtx-&gt;sample_rate;<font></font>
wanted_spec.format = AUDIO_S16SYS;<font></font>
wanted_spec.channels = aCodecCtx-&gt;channels;<font></font>
wanted_spec.silence = <span class="hljs-number">0</span>;<font></font>
wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;<font></font>
wanted_spec.callback = audio_callback;<font></font>
wanted_spec.userdata = aCodecCtx;<font></font>
<font></font>
<span class="hljs-keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¯ä¸ªé¡¹ç›®ï¼š</font></font><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freq</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆé¢‘ç‡ï¼‰ï¼šé‡‡æ ·ç‡ï¼Œå¦‚å‰æ‰€è¿°ã€‚</font></font></li>
<li><b>format</b> ():  SDL ,      . Â«<b>S</b>Â»  Â«<b>S16SYS</b>Â»  Â«Â», <b>16</b> ,      16 ,  Â«<b>SYS</b>Â» ,       ,    .  ,   <b>avcodec_decode_audio2</b>   .</li>
<li><b>channels</b> ():  .</li>
<li><b>silence</b> ():  ,  .   0.</li>
<li><b>samples</b> ():    ,    ,  SDL  ,     .    -  512  8192; FFplay,  ,  1024.</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆcallbackï¼‰ï¼šè¿™é‡Œæˆ‘ä»¬ä¼ é€’çœŸå®çš„å›è°ƒå‡½æ•°ã€‚</font><font style="vertical-align: inherit;">ç¨åæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºå›è°ƒå‡½æ•°ã€‚</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">userdata</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šSDLå°†ä¸ºæˆ‘ä»¬çš„å›è°ƒæä¾›ä¸€ä¸ªç©ºæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬æƒ³è¦çš„ä»»ä½•ç”¨æˆ·æ•°æ®ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬æƒ³è®©ä»–çŸ¥é“æˆ‘ä»¬çš„ç¼–è§£ç å™¨ç¯å¢ƒï¼›</font><font style="vertical-align: inherit;">ç¨å¾®é™ä½ä¸€ç‚¹å°±æ¸…æ¥šäº†ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åï¼Œä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_OpenAudio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰“å¼€éŸ³é¢‘</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queueåˆ—</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ˜¯å¿…è¦çš„ï¼ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡ä»æµä¸­æå–éŸ³é¢‘ä¿¡æ¯ã€‚ä½†æ˜¯å¦‚ä½•å¤„ç†æ­¤ä¿¡æ¯ï¼Ÿæˆ‘ä»¬å°†ä¸æ–­ä»ç”µå½±æ–‡ä»¶ä¸­æ¥æ”¶æ•°æ®åŒ…ï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶ï¼ŒSDLå°†è°ƒç”¨å›è°ƒå‡½æ•°ï¼è§£å†³æ–¹æ¡ˆå°†æ˜¯åˆ›å»ºæŸç§å…¨å±€ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ’å…¥éŸ³é¢‘æ•°æ®åŒ…ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥æ¥æ”¶éŸ³é¢‘æ•°æ®ï¼å› æ­¤ï¼Œè¿™æ˜¯æˆ‘ä»¬å°†åˆ›å»ºæ•°æ®åŒ…é˜Ÿåˆ—çš„å·¥ä½œã€‚ FFmpegç”šè‡³æœ‰ä¸€ä¸ªç»“æ„å¯ä»¥å¸®åŠ©è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacketList</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®ƒåªæ˜¯è½¯ä»¶åŒ…çš„é“¾è¡¨ã€‚è¿™æ˜¯æˆ‘ä»¬çš„é˜Ÿåˆ—ç»“æ„ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PacketQueue</span> {</span><font></font>
  AVPacketList *first_pkt, *last_pkt;<font></font>
  <span class="hljs-keyword">int</span> nb_packets;
  <span class="hljs-keyword">int</span> size;<font></font>
  SDL_mutex *mutex;<font></font>
  SDL_cond *cond;<font></font>
} PacketQueue;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»æŒ‡å‡º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nb_packets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„å¤§å°ä¸åŒ-å¤§å°æ˜¯æŒ‡æˆ‘ä»¬ä»</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packet-&gt; size</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å¾—çš„å­—èŠ‚çš„</font><nobr><font style="vertical-align: inherit;">å¤§å°</font></nobr><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ³¨æ„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªäº’æ–¥é”å’Œä¸€ä¸ªæ¡ä»¶å˜é‡ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯å› ä¸ºSDLå°†éŸ³é¢‘å¤„ç†ä½œä¸ºå•ç‹¬çš„æµæ‰§è¡Œã€‚</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘ä»¬æ²¡æœ‰é€‚å½“åœ°é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¡®å®ä¼šç ´åæˆ‘ä»¬çš„æ•°æ®ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°é˜Ÿåˆ—ã€‚</font><font style="vertical-align: inherit;">æ¯ä¸ªè‡ªé‡çš„ç¨‹åºå‘˜éƒ½åº”è¯¥çŸ¥é“å¦‚ä½•åˆ›å»ºé˜Ÿåˆ—ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜å°†å±•ç¤ºå¦‚ä½•æ‰§è¡Œé˜Ÿåˆ—ï¼Œä»¥ä¾¿æ‚¨æ›´è½»æ¾åœ°å­¦ä¹ SDLå‡½æ•°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥åˆå§‹åŒ–é˜Ÿåˆ—ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packet_queue_init</span><span class="hljs-params">(PacketQueue *q)</span> </span>{
  <span class="hljs-built_in">memset</span>(q, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(PacketQueue));<font></font>
  q-&gt;mutex = SDL_CreateMutex();<font></font>
  q-&gt;cond = SDL_CreateCond();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶ååˆ›å»ºä¸€ä¸ªå‡½æ•°ä»¥å°†å¯¹è±¡æ”¾å…¥æˆ‘ä»¬çš„é˜Ÿåˆ—ä¸­ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_put</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt)</span> </span>{<font></font>
<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">if</span>(av_dup_packet(pkt) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  pkt1 = av_malloc(<span class="hljs-keyword">sizeof</span>(AVPacketList));
  <span class="hljs-keyword">if</span> (!pkt1)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  pkt1-&gt;pkt = *pkt;<font></font>
  pkt1-&gt;next = <span class="hljs-literal">NULL</span>;<font></font>
  <font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (!q-&gt;last_pkt)<font></font>
    q-&gt;first_pkt = pkt1;<font></font>
  <span class="hljs-keyword">else</span><font></font>
    q-&gt;last_pkt-&gt;next = pkt1;<font></font>
  q-&gt;last_pkt = pkt1;<font></font>
  q-&gt;nb_packets++;<font></font>
  q-&gt;size += pkt1-&gt;pkt.size;<font></font>
  SDL_CondSignal(q-&gt;cond);<font></font>
  <font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_LockMutex</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰é˜»æ­¢é˜Ÿåˆ—ä¸­çš„äº’æ–¥é”ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›ä¸œè¥¿ï¼Œç„¶å</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondSignal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆ</font><font style="vertical-align: inherit;">ï¼‰é€šè¿‡æ¡ä»¶å˜é‡</font><font style="vertical-align: inherit;">å°†ä¿¡å·å‘é€åˆ°æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼ˆå¦‚æœæœŸæœ›ï¼‰ï¼Œä»¥å‘Šè¯‰å®ƒæœ‰æ•°æ®å¹¶ä¸”å¯ä»¥ç»§ç»­è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œè§£é”äº’æ–¥é”ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ˜¯ç›¸åº”çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ã€‚è¯·æ³¨æ„ï¼Œ</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘ä»¬å‘Šè¯‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondWait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼Œ</font><b><font style="vertical-align: inherit;">å®ƒå°†</font></b><font style="vertical-align: inherit;">åˆ›å»ºè¯¥åŠŸèƒ½å—ï¼ˆå³æš‚åœç›´åˆ°è·å–æ•°æ®ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> quit = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_get</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt, <span class="hljs-keyword">int</span> block)</span> </span>{<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">int</span> ret;<font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(quit) {<font></font>
      ret = <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    pkt1 = q-&gt;first_pkt;<font></font>
    <span class="hljs-keyword">if</span> (pkt1) {<font></font>
      q-&gt;first_pkt = pkt1-&gt;next;<font></font>
      <span class="hljs-keyword">if</span> (!q-&gt;first_pkt)<font></font>
	q-&gt;last_pkt = <span class="hljs-literal">NULL</span>;<font></font>
      q-&gt;nb_packets--;<font></font>
      q-&gt;size -= pkt1-&gt;pkt.size;<font></font>
      *pkt = pkt1-&gt;pkt;<font></font>
      av_free(pkt1);<font></font>
      ret = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!block) {<font></font>
      ret = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      SDL_CondWait(q-&gt;cond, q-&gt;mutex);<font></font>
    }<font></font>
  }<font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> ret;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å°†å‡½æ•°åŒ…è£…åœ¨ä¸€ä¸ªæ°¸æ’çš„å‘¨æœŸä¸­ï¼Œå› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è¦é˜»å¡å®ƒï¼Œè‚¯å®šä¼šå¾—åˆ°ä¸€äº›æ•°æ®ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬é¿å…ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondWait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°æ°¸è¿œå¾ªç¯</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æœ¬è´¨ä¸Šï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CondWait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰€åšçš„</font><font style="vertical-align: inherit;">åªæ˜¯ç­‰å¾…æ¥è‡ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondSignal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ï¼ˆæˆ–</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondBroadcast</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ï¼‰çš„ä¿¡å·ï¼Œç„¶åç»§ç»­ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå¥½åƒæˆ‘ä»¬å°†å…¶æ•è·åœ¨äº’æ–¥é”ä¸­ä¸€æ ·-å¦‚æœæˆ‘ä»¬æŒæœ‰é”ï¼Œåˆ™</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">put</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å°†æ— æ³•æ’é˜Ÿä»»ä½•ä¸œè¥¿ï¼</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CondWait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å¯¹æˆ‘ä»¬çš„ä½œç”¨è¿˜åœ¨äºå–æ¶ˆé˜»æ­¢æä¾›ç»™å®ƒçš„äº’æ–¥é”ï¼Œç„¶ååœ¨æ”¶åˆ°ä¿¡å·åç«‹å³å†æ¬¡å°è¯•å°†å…¶é”å®šã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºæ¯ä¸ªæ¶ˆé˜²å‘˜</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨è¿˜å°†çœ‹åˆ°</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ£€æŸ¥</font><font style="vertical-align: inherit;">äº†ä¸€ä¸ªå…¨å±€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€€å‡º</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å˜é‡</font><font style="vertical-align: inherit;">ï¼Œä»¥ç¡®ä¿æœªåœ¨ç¨‹åºä¸­è®¾ç½®è¾“å‡ºä¿¡å·ï¼ˆSDLè‡ªåŠ¨å¤„ç†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TERM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¿¡å·</font><font style="vertical-align: inherit;">ç­‰ï¼‰ã€‚</font><font style="vertical-align: inherit;">å¦åˆ™ï¼Œçº¿ç¨‹å°†æ°¸è¿œç»§ç»­ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†ä¸å¾—ä¸ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kill -9ç»ˆæ­¢</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¨‹åº</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">  SDL_PollEvent(&amp;event);
  <span class="hljs-keyword">switch</span>(event.type) {
  <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
    quit = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†é€€å‡ºæ ‡å¿—è®¾ç½®ä¸º1ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬æä¾›åŒ…è£¹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®ƒä»…ç”¨äºé…ç½®é˜Ÿåˆ—ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">PacketQueue audioq;<font></font>
main() {<font></font>
...<font></font>
  avcodec_open2(aCodecCtx, aCodec, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  packet_queue_init(&amp;audioq);<font></font>
  SDL_PauseAudio(<span class="hljs-number">0</span>);</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_PauseAudio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰æœ€ç»ˆå¯åŠ¨éŸ³é¢‘å•å…ƒã€‚</font><font style="vertical-align: inherit;">å¦‚æœä¸æ¥æ”¶æ•°æ®ï¼Œå®ƒå°†é‡ç°é™é»˜çŠ¶æ€ã€‚</font><font style="vertical-align: inherit;">ä½†è¿™ä¸ä¼šç«‹å³å‘ç”Ÿã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæˆ‘ä»¬å·²ç»é…ç½®äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å°†æ•°æ®åŒ…å‘é€ç»™å¥¹äº†ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬è¿›å…¥åŒ…è£…é˜…è¯»å‘¨æœŸï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="hljs-number">0</span>) {
  <span class="hljs-comment">// Is this a packet from the video stream?</span>
  <span class="hljs-keyword">if</span>(packet.stream_index==videoStream) {
    <span class="hljs-comment">// Decode video frame</span><font></font>
    ....<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(packet.stream_index==audioStream) {<font></font>
    packet_queue_put(&amp;audioq, &amp;packet);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    av_free_packet(&amp;packet);<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œæ’é˜Ÿåæˆ‘ä»¬ä¸ä¼šé‡Šæ”¾åŒ…è£¹ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç¨åå°†åœ¨è§£å¯†æ—¶å°†å…¶é‡Šæ”¾ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å–åŒ…</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œè®©æˆ‘ä»¬æœ€åä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ä»é˜Ÿåˆ—ä¸­è·å–æ•°æ®åŒ…ã€‚</font><font style="vertical-align: inherit;">å›è°ƒåº”å¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">callback</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata, Uint8 *stream, <span class="hljs-keyword">int</span> len)</span></span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">userdata</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬æä¾›SDLçš„æŒ‡é’ˆï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬å°†éŸ³é¢‘æ•°æ®å†™å…¥å…¶ä¸­çš„ç¼“å†²åŒºï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æ­¤ç¼“å†²åŒºçš„å¤§å°ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ä»£ç ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">audio_callback</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata, Uint8 *stream, <span class="hljs-keyword">int</span> len)</span> </span>{<font></font>
<font></font>
  AVCodecContext *aCodecCtx = (AVCodecContext *)userdata;<font></font>
  <span class="hljs-keyword">int</span> len1, audio_size;<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> audio_buf[(AVCODEC_MAX_AUDIO_FRAME_SIZE * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>];
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> audio_buf_size = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> audio_buf_index = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">while</span>(len &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span>(audio_buf_index &gt;= audio_buf_size) {
      <span class="hljs-comment">/* We have already sent all our data; get more */</span><font></font>
      audio_size = audio_decode_frame(aCodecCtx, audio_buf,<font></font>
                                      <span class="hljs-keyword">sizeof</span>(audio_buf));
      <span class="hljs-keyword">if</span>(audio_size &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* If error, output silence */</span>
	audio_buf_size = <span class="hljs-number">1024</span>;
	<span class="hljs-built_in">memset</span>(audio_buf, <span class="hljs-number">0</span>, audio_buf_size);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
	audio_buf_size = audio_size;<font></font>
      }<font></font>
      audio_buf_index = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    len1 = audio_buf_size - audio_buf_index;<font></font>
    <span class="hljs-keyword">if</span>(len1 &gt; len)<font></font>
      len1 = len;<font></font>
    <span class="hljs-built_in">memcpy</span>(stream, (<span class="hljs-keyword">uint8_t</span> *)audio_buf + audio_buf_index, len1);<font></font>
    len -= len1;<font></font>
    stream += len1;<font></font>
    audio_buf_index += len1;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¾ªç¯ï¼Œå®ƒä»æˆ‘ä»¬ç¼–å†™çš„å¦ä¸€ä¸ªå‡½æ•°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_decode_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">ä¸­æå–æ•°æ®</font><font style="vertical-align: inherit;">ï¼Œå°†ç»“æœä¿å­˜åœ¨ä¸­é—´ç¼“å†²åŒºä¸­ï¼Œå°è¯•å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­—èŠ‚</font><font style="vertical-align: inherit;">å†™å…¥</font><font style="vertical-align: inherit;">æµä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä»ç„¶æ²¡æœ‰è¶³å¤Ÿçš„å­—èŠ‚</font><font style="vertical-align: inherit;">ï¼Œåˆ™å°è¯•</font><font style="vertical-align: inherit;">æ¥æ”¶æ›´å¤šæ•°æ®ï¼Œæˆ–è€…å°†å…¶ä¿å­˜ä»¥å¤‡åç”¨ï¼Œå¦‚æœæˆ‘ä»¬è¿˜æœ‰ä¸œè¥¿ã€‚</font><font style="vertical-align: inherit;">å¤§å°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_buf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æœ€å¤§çš„éŸ³é¢‘å¸§å¤§å°çš„1.5å€çš„FFmpegä¼šç»™æˆ‘ä»¬ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„åˆ©æ¶¦ç‡ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€ç»ˆéŸ³é¢‘è§£å¯†</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_decode_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£ç å™¨çš„å†…éƒ¨</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">audio_decode_frame</span><span class="hljs-params">(AVCodecContext *aCodecCtx, <span class="hljs-keyword">uint8_t</span> *audio_buf,
                       <span class="hljs-keyword">int</span> buf_size)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">static</span> AVPacket pkt;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> *audio_pkt_data = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> audio_pkt_size = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">static</span> AVFrame frame;<font></font>
<font></font>
  <span class="hljs-keyword">int</span> len1, data_size = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">while</span>(audio_pkt_size &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">int</span> got_frame = <span class="hljs-number">0</span>;<font></font>
      len1 = avcodec_decode_audio4(aCodecCtx, &amp;frame, &amp;got_frame, &amp;pkt);<font></font>
      <span class="hljs-keyword">if</span>(len1 &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* if error, skip frame */</span>
	audio_pkt_size = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      audio_pkt_data += len1;<font></font>
      audio_pkt_size -= len1;<font></font>
      data_size = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span>(got_frame) {<font></font>
	data_size = av_samples_get_buffer_size(<span class="hljs-literal">NULL</span>, <font></font>
					       aCodecCtx-&gt;channels,<font></font>
					       frame.nb_samples,<font></font>
					       aCodecCtx-&gt;sample_fmt,<font></font>
					       <span class="hljs-number">1</span>);<font></font>
	assert(data_size &lt;= buf_size);<font></font>
	<span class="hljs-built_in">memcpy</span>(audio_buf, frame.data[<span class="hljs-number">0</span>], data_size);<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span>(data_size &lt;= <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* No data yet, get more frames */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      }<font></font>
      <span class="hljs-comment">/* We have data, return it and come back for more later */</span>
      <span class="hljs-keyword">return</span> data_size;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pkt.data)<font></font>
      av_free_packet(&amp;pkt);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;audioq, &amp;pkt, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    audio_pkt_data = pkt.data;<font></font>
    audio_pkt_size = pkt.size;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ•´ä¸ªè¿‡ç¨‹å®é™…ä¸Šæ˜¯åœ¨å‡½æ•°ç»“å°¾å¤„å¼€å§‹çš„ï¼Œæˆ‘ä»¬åœ¨æ­¤è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packet_queue_get</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚æˆ‘ä»¬ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®åŒ…å¹¶ä¿å­˜å…¶ä¸­çš„ä¿¡æ¯ã€‚ç„¶åï¼Œå½“æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç¨‹åºåŒ…æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_audio4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ï¼Œä¸å®ƒçš„å§å¦¹å‡½æ•°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_video</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">éå¸¸ç›¸ä¼¼</font><font style="vertical-align: inherit;">ï¼Œä¸åŒçš„æ˜¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥ç¨‹åºåŒ…å¯ä»¥å…·æœ‰å¤šä¸ªå¸§ã€‚å› æ­¤ï¼Œæ‚¨å¯èƒ½éœ€è¦å¤šæ¬¡è°ƒç”¨å®ƒæ‰èƒ½ä»æ•°æ®åŒ…ä¸­è·å–æ‰€æœ‰æ•°æ®ã€‚æ”¶åˆ°å¸§åï¼Œæˆ‘ä»¬åªéœ€å°†å…¶å¤åˆ¶åˆ°æˆ‘ä»¬çš„éŸ³é¢‘ç¼“å†²åŒºä¸­ï¼Œç¡®ä¿</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°äºæˆ‘ä»¬çš„éŸ³é¢‘ç¼“å†²åŒºã€‚å¦å¤–ï¼Œè¯·è®°ä½æœ‰å…³æŠ•å°„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_bufçš„ä¿¡æ¯</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®çš„ç±»å‹ï¼Œå› ä¸ºSDLæä¾›äº†ä¸€ä¸ª8ä½çš„intç¼“å†²åŒºï¼Œè€ŒFFmpegæä¾›äº†ä¸€ä¸ª16ä½çš„intç¼“å†²åŒºä¸­çš„æ•°æ®ã€‚æ‚¨è¿˜åº”è¯¥è€ƒè™‘</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹‹é—´çš„åŒºåˆ«</font><font style="vertical-align: inherit;">ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„åŒ…çš„å¤§å°ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯è¿”å›çš„åŸå§‹æ•°æ®é‡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æˆ‘ä»¬æœ‰ä¸€äº›æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ç«‹å³è¿”å›ä»¥æ‰¾å‡ºæ˜¯å¦éœ€è¦ä»é˜Ÿåˆ—ä¸­è·å–æ›´å¤šæ•°æ®æˆ–å·²ç»å®Œæˆã€‚å¦‚æœæˆ‘ä»¬ä»ç„¶éœ€è¦å¤„ç†åŒ…è£¹ï¼Œè¯·åšæŒä¸‹å»ã€‚å¦‚æœæ‚¨å·²å®Œæˆè½¯ä»¶åŒ…ï¼Œè¯·æœ€ç»ˆå°†å…¶é‡Šæ”¾ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯å…¨éƒ¨ï¼æˆ‘ä»¬å·²å°†éŸ³é¢‘ä»ä¸»è¯»å–å¾ªç¯ä¼ è¾“åˆ°é˜Ÿåˆ—ï¼Œç„¶åç”±</font><b><font style="vertical-align: inherit;">audio_callback</font></b><font style="vertical-align: inherit;">å‡½æ•°è¯»å–</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®ƒå°†è¿™äº›æ•°æ®ä¼ è¾“åˆ°SDLï¼Œç„¶åSDLä¼ è¾“åˆ°æ‚¨çš„å£°å¡ã€‚ç»§ç»­ç¼–è¯‘ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial03 tutorial03.c -lavutil -lavformat -lavcodec -lswscale -lz -lm \<font></font>
`sdl-config --cflags --libs`</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gip-gip-hoorayï¼</font><font style="vertical-align: inherit;">è§†é¢‘ä»ä»¥æœ€å¤§é€Ÿåº¦ä¼ è¾“ï¼Œä½†æ˜¯å£°éŸ³å·²ç»æŒ‰é¢„æœŸæ’­æ”¾ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</font><font style="vertical-align: inherit;">æ˜¯çš„ï¼Œå› ä¸ºéŸ³é¢‘ä¿¡æ¯å…·æœ‰é‡‡æ ·é¢‘ç‡-æˆ‘ä»¬ä»¥æœ€å¿«çš„é€Ÿåº¦è¾“å‡ºéŸ³é¢‘ä¿¡æ¯ï¼Œä½†æ˜¯éŸ³é¢‘åªæ˜¯æ ¹æ®å…¶é‡‡æ ·é¢‘ç‡åœ¨æ­¤æµä¸­æ’­æ”¾ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºè§†é¢‘å’ŒéŸ³é¢‘åŒæ­¥ï¼Œæˆ‘ä»¬å‡ ä¹å·²ç»æˆç†Ÿï¼Œä½†æ˜¯é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹è¯¥ç¨‹åºè¿›è¡Œå°çš„é‡ç»„ã€‚</font><font style="vertical-align: inherit;">ä½¿ç”¨å•ç‹¬çš„æµå¯¹å£°éŸ³è¿›è¡Œæ’é˜Ÿå’Œæ’­æ”¾çš„æ–¹æ³•æ•ˆæœå¾ˆå¥½ï¼šå®ƒä½¿ä»£ç æ›´æ˜“äºç®¡ç†å’Œæ¨¡å—åŒ–ã€‚</font><font style="vertical-align: inherit;">åœ¨å¼€å§‹å°†è§†é¢‘ä¸éŸ³é¢‘åŒæ­¥ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç®€åŒ–ä»£ç ã€‚</font><font style="vertical-align: inherit;">åœ¨ä¸‹ä¸€ä¸ªç³»åˆ—ä¸­ï¼Œæˆ‘ä»¬å°†äº§ç”Ÿæ§åˆ¶æµï¼</font></font><a name="threads"></a><br>
<br>
<hr><hr><hr><hr><hr><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬4è¯¾ï¼šå¤šçº¿ç¨‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬ä¸‰è¯¾ï¼šæ’­æ”¾å£°éŸ³"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â† </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â‡‘ </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬5è¯¾ï¼šè§†é¢‘åŒæ­¥"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â†’</font></font></a></h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæ•´åˆ—è¡¨tutorial04.c</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">// tutorial04.c</span>
<span class="hljs-comment">// A pedagogical video player that will stream through every video frame as fast as it can,</span>
<span class="hljs-comment">// and play audio (out of sync).</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Code based on FFplay, Copyright (c) 2003 Fabrice Bellard, </span>
<span class="hljs-comment">// and a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span>
<span class="hljs-comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span>
<span class="hljs-comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span>
<span class="hljs-comment">// Updates tested on:</span>
<span class="hljs-comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101, SDL 1.2.15</span>
<span class="hljs-comment">// on GCC 4.7.2 in Debian February 2015</span>
<span class="hljs-comment">// Use</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// gcc -o tutorial04 tutorial04.c -lavformat -lavcodec -lswscale -lz -lm `sdl-config --cflags --libs`</span>
<span class="hljs-comment">// to build (assuming libavformat and libavcodec are correctly installed, </span>
<span class="hljs-comment">// and assuming you have sdl-config. Please refer to SDL docs for your installation.)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Run using</span>
<span class="hljs-comment">// tutorial04 myvideofile.mpg</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to play the video stream on your screen.</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libswscale/swscale.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL_thread.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __MINGW32__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> main <span class="hljs-comment">/* Prevents SDL from overriding main() */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// compatibility with newer API</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_free avcodec_free_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_AUDIOQ_SIZE (5 * 16 * 1024)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_VIDEOQ_SIZE (5 * 256 * 1024)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FF_REFRESH_EVENT (SDL_USEREVENT)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FF_QUIT_EVENT (SDL_USEREVENT + 1)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VIDEO_PICTURE_QUEUE_SIZE 1</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PacketQueue</span> {</span><font></font>
  AVPacketList *first_pkt, *last_pkt;<font></font>
  <span class="hljs-keyword">int</span> nb_packets;
  <span class="hljs-keyword">int</span> size;<font></font>
  SDL_mutex *mutex;<font></font>
  SDL_cond *cond;<font></font>
} PacketQueue;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoPicture</span> {</span><font></font>
  SDL_Overlay *bmp;<font></font>
  <span class="hljs-keyword">int</span> width, height; <span class="hljs-comment">/* source height &amp; width */</span>
  <span class="hljs-keyword">int</span> allocated;<font></font>
} VideoPicture;<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoState</span> {</span><font></font>
<font></font>
  AVFormatContext *pFormatCtx;<font></font>
  <span class="hljs-keyword">int</span>             videoStream, audioStream;<font></font>
  AVStream        *audio_st;<font></font>
  AVCodecContext  *audio_ctx;<font></font>
  PacketQueue     audioq;<font></font>
  <span class="hljs-keyword">uint8_t</span>         audio_buf[(AVCODEC_MAX_AUDIO_FRAME_SIZE * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>];
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_size;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_index;<font></font>
  AVFrame         audio_frame;<font></font>
  AVPacket        audio_pkt;<font></font>
  <span class="hljs-keyword">uint8_t</span>         *audio_pkt_data;
  <span class="hljs-keyword">int</span>             audio_pkt_size;<font></font>
  AVStream        *video_st;<font></font>
  AVCodecContext  *video_ctx;<font></font>
  PacketQueue     videoq;<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span>;</span><font></font>
<font></font>
  VideoPicture    pictq[VIDEO_PICTURE_QUEUE_SIZE];<font></font>
  <span class="hljs-keyword">int</span>             pictq_size, pictq_rindex, pictq_windex;<font></font>
  SDL_mutex       *pictq_mutex;<font></font>
  SDL_cond        *pictq_cond;<font></font>
  <font></font>
  SDL_Thread      *parse_tid;<font></font>
  SDL_Thread      *video_tid;<font></font>
<font></font>
  <span class="hljs-keyword">char</span>            filename[<span class="hljs-number">1024</span>];
  <span class="hljs-keyword">int</span>             quit;<font></font>
} VideoState;<font></font>
<font></font>
SDL_Surface     *screen;<font></font>
SDL_mutex       *screen_mutex;<font></font>
<font></font>
<span class="hljs-comment">/* Since we only have one decoding thread, the Big Struct
   can be global in case we need it. */</span><font></font>
VideoState *global_video_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packet_queue_init</span><span class="hljs-params">(PacketQueue *q)</span> </span>{
  <span class="hljs-built_in">memset</span>(q, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(PacketQueue));<font></font>
  q-&gt;mutex = SDL_CreateMutex();<font></font>
  q-&gt;cond = SDL_CreateCond();<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_put</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt)</span> </span>{<font></font>
<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">if</span>(av_dup_packet(pkt) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  pkt1 = av_malloc(<span class="hljs-keyword">sizeof</span>(AVPacketList));
  <span class="hljs-keyword">if</span> (!pkt1)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  pkt1-&gt;pkt = *pkt;<font></font>
  pkt1-&gt;next = <span class="hljs-literal">NULL</span>;<font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!q-&gt;last_pkt)<font></font>
    q-&gt;first_pkt = pkt1;<font></font>
  <span class="hljs-keyword">else</span><font></font>
    q-&gt;last_pkt-&gt;next = pkt1;<font></font>
  q-&gt;last_pkt = pkt1;<font></font>
  q-&gt;nb_packets++;<font></font>
  q-&gt;size += pkt1-&gt;pkt.size;<font></font>
  SDL_CondSignal(q-&gt;cond);<font></font>
  <font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_get</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt, <span class="hljs-keyword">int</span> block)</span>
</span>{<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">int</span> ret;<font></font>
<font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(global_video_state-&gt;quit) {<font></font>
      ret = <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    pkt1 = q-&gt;first_pkt;<font></font>
    <span class="hljs-keyword">if</span> (pkt1) {<font></font>
      q-&gt;first_pkt = pkt1-&gt;next;<font></font>
      <span class="hljs-keyword">if</span> (!q-&gt;first_pkt)<font></font>
	q-&gt;last_pkt = <span class="hljs-literal">NULL</span>;<font></font>
      q-&gt;nb_packets--;<font></font>
      q-&gt;size -= pkt1-&gt;pkt.size;<font></font>
      *pkt = pkt1-&gt;pkt;<font></font>
      av_free(pkt1);<font></font>
      ret = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!block) {<font></font>
      ret = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      SDL_CondWait(q-&gt;cond, q-&gt;mutex);<font></font>
    }<font></font>
  }<font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">audio_decode_frame</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">uint8_t</span> *audio_buf, <span class="hljs-keyword">int</span> buf_size)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">int</span> len1, data_size = <span class="hljs-number">0</span>;<font></font>
  AVPacket *pkt = &amp;is-&gt;audio_pkt;<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">while</span>(is-&gt;audio_pkt_size &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">int</span> got_frame = <span class="hljs-number">0</span>;<font></font>
      len1 = avcodec_decode_audio4(is-&gt;audio_ctx, &amp;is-&gt;audio_frame, &amp;got_frame, pkt);<font></font>
      <span class="hljs-keyword">if</span>(len1 &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* if error, skip frame */</span>
	is-&gt;audio_pkt_size = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      data_size = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span>(got_frame) {<font></font>
	data_size = av_samples_get_buffer_size(<span class="hljs-literal">NULL</span>, <font></font>
					       is-&gt;audio_ctx-&gt;channels,<font></font>
					       is-&gt;audio_frame.nb_samples,<font></font>
					       is-&gt;audio_ctx-&gt;sample_fmt,<font></font>
					       <span class="hljs-number">1</span>);<font></font>
	assert(data_size &lt;= buf_size);<font></font>
	<span class="hljs-built_in">memcpy</span>(audio_buf, is-&gt;audio_frame.data[<span class="hljs-number">0</span>], data_size);<font></font>
      }<font></font>
      is-&gt;audio_pkt_data += len1;<font></font>
      is-&gt;audio_pkt_size -= len1;<font></font>
      <span class="hljs-keyword">if</span>(data_size &lt;= <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* No data yet, get more frames */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      }<font></font>
      <span class="hljs-comment">/* We have data, return it and come back for more later */</span>
      <span class="hljs-keyword">return</span> data_size;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pkt-&gt;data)<font></font>
      av_free_packet(pkt);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">/* next packet */</span>
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;audioq, pkt, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    is-&gt;audio_pkt_data = pkt-&gt;data;<font></font>
    is-&gt;audio_pkt_size = pkt-&gt;size;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">audio_callback</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata, Uint8 *stream, <span class="hljs-keyword">int</span> len)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  <span class="hljs-keyword">int</span> len1, audio_size;<font></font>
<font></font>
  <span class="hljs-keyword">while</span>(len &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span>(is-&gt;audio_buf_index &gt;= is-&gt;audio_buf_size) {
      <span class="hljs-comment">/* We have already sent all our data; get more */</span>
      audio_size = audio_decode_frame(is, is-&gt;audio_buf, <span class="hljs-keyword">sizeof</span>(is-&gt;audio_buf));
      <span class="hljs-keyword">if</span>(audio_size &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* If error, output silence */</span>
	is-&gt;audio_buf_size = <span class="hljs-number">1024</span>;
	<span class="hljs-built_in">memset</span>(is-&gt;audio_buf, <span class="hljs-number">0</span>, is-&gt;audio_buf_size);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
	is-&gt;audio_buf_size = audio_size;<font></font>
      }<font></font>
      is-&gt;audio_buf_index = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    len1 = is-&gt;audio_buf_size - is-&gt;audio_buf_index;<font></font>
    <span class="hljs-keyword">if</span>(len1 &gt; len)<font></font>
      len1 = len;<font></font>
    <span class="hljs-built_in">memcpy</span>(stream, (<span class="hljs-keyword">uint8_t</span> *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);<font></font>
    len -= len1;<font></font>
    stream += len1;<font></font>
    is-&gt;audio_buf_index += len1;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> Uint32 <span class="hljs-title">sdl_refresh_timer_cb</span><span class="hljs-params">(Uint32 interval, <span class="hljs-keyword">void</span> *opaque)</span> </span>{<font></font>
  SDL_Event event;<font></font>
  event.type = FF_REFRESH_EVENT;<font></font>
  event.user.data1 = opaque;<font></font>
  SDL_PushEvent(&amp;event);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* 0 means stop timer */</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/* schedule a video refresh in 'delay' ms */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">schedule_refresh</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> delay)</span> </span>{<font></font>
  SDL_AddTimer(delay, sdl_refresh_timer_cb, is);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_display</span><span class="hljs-params">(VideoState *is)</span> </span>{<font></font>
<font></font>
  SDL_Rect rect;<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">float</span> aspect_ratio;
  <span class="hljs-keyword">int</span> w, h, x, y;
  <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-keyword">if</span>(is-&gt;video_ctx-&gt;sample_aspect_ratio.num == <span class="hljs-number">0</span>) {<font></font>
      aspect_ratio = <span class="hljs-number">0</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      aspect_ratio = av_q2d(is-&gt;video_ctx-&gt;sample_aspect_ratio) *<font></font>
	is-&gt;video_ctx-&gt;width / is-&gt;video_ctx-&gt;height;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(aspect_ratio &lt;= <span class="hljs-number">0.0</span>) {<font></font>
      aspect_ratio = (<span class="hljs-keyword">float</span>)is-&gt;video_ctx-&gt;width /<font></font>
	(<span class="hljs-keyword">float</span>)is-&gt;video_ctx-&gt;height;<font></font>
    }<font></font>
    h = screen-&gt;h;<font></font>
    w = ((<span class="hljs-keyword">int</span>)rint(h * aspect_ratio)) &amp; <span class="hljs-number">-3</span>;
    <span class="hljs-keyword">if</span>(w &gt; screen-&gt;w) {<font></font>
      w = screen-&gt;w;<font></font>
      h = ((<span class="hljs-keyword">int</span>)rint(w / aspect_ratio)) &amp; <span class="hljs-number">-3</span>;<font></font>
    }<font></font>
    x = (screen-&gt;w - w) / <span class="hljs-number">2</span>;<font></font>
    y = (screen-&gt;h - h) / <span class="hljs-number">2</span>;<font></font>
    <font></font>
    rect.x = x;<font></font>
    rect.y = y;<font></font>
    rect.w = w;<font></font>
    rect.h = h;<font></font>
    SDL_LockMutex(screen_mutex);<font></font>
    SDL_DisplayYUVOverlay(vp-&gt;bmp, &amp;rect);<font></font>
    SDL_UnlockMutex(screen_mutex);<font></font>
<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_refresh_timer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(is-&gt;video_st) {
    <span class="hljs-keyword">if</span>(is-&gt;pictq_size == <span class="hljs-number">0</span>) {<font></font>
      schedule_refresh(is, <span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
      <span class="hljs-comment">/* Now, normally here goes a ton of code
	 about timing, etc. we're just going to
	 guess at a delay for now. You can
	 increase and decrease this value and hard code
	 the timing - but I don't suggest that ;)
	 We'll learn how to do it for real later.
      */</span>
      schedule_refresh(is, <span class="hljs-number">40</span>);<font></font>
      <font></font>
      <span class="hljs-comment">/* show the picture! */</span><font></font>
      video_display(is);<font></font>
      <font></font>
      <span class="hljs-comment">/* update queue for next picture! */</span>
      <span class="hljs-keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
	is-&gt;pictq_rindex = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
      SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
      is-&gt;pictq_size--;<font></font>
      SDL_CondSignal(is-&gt;pictq_cond);<font></font>
      SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    schedule_refresh(is, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}<font></font>
      <font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">alloc_picture</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-comment">// we already have one make another, bigger/smaller</span><font></font>
    SDL_FreeYUVOverlay(vp-&gt;bmp);<font></font>
  }<font></font>
  <span class="hljs-comment">// Allocate a place to put our YUV image on that screen</span><font></font>
  SDL_LockMutex(screen_mutex);<font></font>
  vp-&gt;bmp = SDL_CreateYUVOverlay(is-&gt;video_ctx-&gt;width,<font></font>
				 is-&gt;video_ctx-&gt;height,<font></font>
				 SDL_YV12_OVERLAY,<font></font>
				 screen);<font></font>
  SDL_UnlockMutex(screen_mutex);<font></font>
<font></font>
  vp-&gt;width = is-&gt;video_ctx-&gt;width;<font></font>
  vp-&gt;height = is-&gt;video_ctx-&gt;height;<font></font>
  vp-&gt;allocated = <span class="hljs-number">1</span>;<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">queue_picture</span><span class="hljs-params">(VideoState *is, AVFrame *pFrame)</span> </span>{<font></font>
<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">int</span> dst_pix_fmt;<font></font>
  AVPicture pict;<font></font>
<font></font>
  <span class="hljs-comment">/* wait until we have space for a new pic */</span><font></font>
  SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
  <span class="hljs-keyword">while</span>(is-&gt;pictq_size &gt;= VIDEO_PICTURE_QUEUE_SIZE &amp;&amp;<font></font>
	!is-&gt;quit) {<font></font>
    SDL_CondWait(is-&gt;pictq_cond, is-&gt;pictq_mutex);<font></font>
  }<font></font>
  SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is-&gt;quit)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">// windex is set to 0 initially</span><font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
<font></font>
  <span class="hljs-comment">/* allocate or resize the buffer! */</span>
  <span class="hljs-keyword">if</span>(!vp-&gt;bmp ||<font></font>
     vp-&gt;width != is-&gt;video_ctx-&gt;width ||<font></font>
     vp-&gt;height != is-&gt;video_ctx-&gt;height) {<font></font>
    SDL_Event event;<font></font>
<font></font>
    vp-&gt;allocated = <span class="hljs-number">0</span>;<font></font>
    alloc_picture(is);<font></font>
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/* We have a place to put our picture on the queue */</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {<font></font>
<font></font>
    SDL_LockYUVOverlay(vp-&gt;bmp);<font></font>
    <font></font>
    dst_pix_fmt = PIX_FMT_YUV420P;<font></font>
    <span class="hljs-comment">/* point pict at the queue */</span><font></font>
<font></font>
    pict.data[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
    pict.data[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
    pict.data[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    pict.linesize[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
    pict.linesize[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
    pict.linesize[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    <span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
    sws_scale(is-&gt;sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
	      pFrame-&gt;linesize, <span class="hljs-number">0</span>, is-&gt;video_ctx-&gt;height,<font></font>
	      pict.data, pict.linesize);<font></font>
    <font></font>
    SDL_UnlockYUVOverlay(vp-&gt;bmp);<font></font>
    <span class="hljs-comment">/* now we inform our display thread that we have a pic ready */</span>
    <span class="hljs-keyword">if</span>(++is-&gt;pictq_windex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
      is-&gt;pictq_windex = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
    is-&gt;pictq_size++;<font></font>
    SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">video_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{<font></font>
  VideoState *is = (VideoState *)arg;<font></font>
  AVPacket pkt1, *packet = &amp;pkt1;<font></font>
  <span class="hljs-keyword">int</span> frameFinished;<font></font>
  AVFrame *pFrame;<font></font>
<font></font>
  pFrame = av_frame_alloc();<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// means we quit getting packets</span>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// Decode video frame</span><font></font>
    avcodec_decode_video2(is-&gt;video_ctx, pFrame, &amp;frameFinished, packet);<font></font>
    <span class="hljs-comment">// Did we get a video frame?</span>
    <span class="hljs-keyword">if</span>(frameFinished) {
      <span class="hljs-keyword">if</span>(queue_picture(is, pFrame) &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-keyword">break</span>;<font></font>
      }      <font></font>
    }<font></font>
    av_free_packet(packet);<font></font>
  }<font></font>
  av_frame_free(&amp;pFrame);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">stream_component_open</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> stream_index)</span> </span>{<font></font>
<font></font>
  AVFormatContext *pFormatCtx = is-&gt;pFormatCtx;<font></font>
  AVCodecContext *codecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec *codec = <span class="hljs-literal">NULL</span>;<font></font>
  SDL_AudioSpec wanted_spec, spec;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(stream_index &lt; <span class="hljs-number">0</span> || stream_index &gt;= pFormatCtx-&gt;nb_streams) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codec = avcodec_find_decoder(pFormatCtx-&gt;streams[stream_index]-&gt;codec-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(!codec) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codecCtx = avcodec_alloc_context3(codec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(codecCtx, pFormatCtx-&gt;streams[stream_index]-&gt;codec) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(codecCtx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
    <span class="hljs-comment">// Set audio settings from codec info</span><font></font>
    wanted_spec.freq = codecCtx-&gt;sample_rate;<font></font>
    wanted_spec.format = AUDIO_S16SYS;<font></font>
    wanted_spec.channels = codecCtx-&gt;channels;<font></font>
    wanted_spec.silence = <span class="hljs-number">0</span>;<font></font>
    wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;<font></font>
    wanted_spec.callback = audio_callback;<font></font>
    wanted_spec.userdata = is;<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(avcodec_open2(codecCtx, codec, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">switch</span>(codecCtx-&gt;codec_type) {
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_AUDIO:<font></font>
    is-&gt;audioStream = stream_index;<font></font>
    is-&gt;audio_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;audio_ctx = codecCtx;<font></font>
    is-&gt;audio_buf_size = <span class="hljs-number">0</span>;<font></font>
    is-&gt;audio_buf_index = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">memset</span>(&amp;is-&gt;audio_pkt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(is-&gt;audio_pkt));<font></font>
    packet_queue_init(&amp;is-&gt;audioq);<font></font>
    SDL_PauseAudio(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_VIDEO:<font></font>
    is-&gt;videoStream = stream_index;<font></font>
    is-&gt;video_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;video_ctx = codecCtx;<font></font>
    packet_queue_init(&amp;is-&gt;videoq);<font></font>
    is-&gt;video_tid = SDL_CreateThread(video_thread, is);<font></font>
    is-&gt;sws_ctx = sws_getContext(is-&gt;video_ctx-&gt;width, is-&gt;video_ctx-&gt;height,<font></font>
				 is-&gt;video_ctx-&gt;pix_fmt, is-&gt;video_ctx-&gt;width,<font></font>
				 is-&gt;video_ctx-&gt;height, PIX_FMT_YUV420P,<font></font>
				 SWS_BILINEAR, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span><font></font>
				 );<font></font>
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decode_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)arg;<font></font>
  AVFormatContext *pFormatCtx;<font></font>
  AVPacket pkt1, *packet = &amp;pkt1;<font></font>
<font></font>
  <span class="hljs-keyword">int</span> video_index = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> audio_index = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
  is-&gt;videoStream=<span class="hljs-number">-1</span>;<font></font>
  is-&gt;audioStream=<span class="hljs-number">-1</span>;<font></font>
<font></font>
  global_video_state = is;<font></font>
<font></font>
  <span class="hljs-comment">// Open video file</span>
  <span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, is-&gt;filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span><font></font>
<font></font>
  is-&gt;pFormatCtx = pFormatCtx;<font></font>
  <font></font>
  <span class="hljs-comment">// Retrieve stream information</span>
  <span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span><font></font>
  <font></font>
  <span class="hljs-comment">// Dump information about file onto standard error</span>
  av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, is-&gt;filename, <span class="hljs-number">0</span>);<font></font>
  <font></font>
  <span class="hljs-comment">// Find the first video stream</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) {
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
       video_index &lt; <span class="hljs-number">0</span>) {<font></font>
      video_index=i;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
       audio_index &lt; <span class="hljs-number">0</span>) {<font></font>
      audio_index=i;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(audio_index &gt;= <span class="hljs-number">0</span>) {<font></font>
    stream_component_open(is, audio_index);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(video_index &gt;= <span class="hljs-number">0</span>) {<font></font>
    stream_component_open(is, video_index);<font></font>
  }   <font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is-&gt;videoStream &lt; <span class="hljs-number">0</span> || is-&gt;audioStream &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%s: could not open codecs\n"</span>, is-&gt;filename);
    <span class="hljs-keyword">goto</span> fail;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// main decode loop</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// seek stuff goes here</span>
    <span class="hljs-keyword">if</span>(is-&gt;audioq.size &gt; MAX_AUDIOQ_SIZE ||<font></font>
       is-&gt;videoq.size &gt; MAX_VIDEOQ_SIZE) {<font></font>
      SDL_Delay(<span class="hljs-number">10</span>);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(av_read_frame(is-&gt;pFormatCtx, packet) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span>(is-&gt;pFormatCtx-&gt;pb-&gt;error == <span class="hljs-number">0</span>) {<font></font>
	SDL_Delay(<span class="hljs-number">100</span>); <span class="hljs-comment">/* no error; wait for user input */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      } <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;videoStream) {<font></font>
      packet_queue_put(&amp;is-&gt;videoq, packet);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;audioStream) {<font></font>
      packet_queue_put(&amp;is-&gt;audioq, packet);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      av_free_packet(packet);<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">/* all done - wait for it */</span>
  <span class="hljs-keyword">while</span>(!is-&gt;quit) {<font></font>
    SDL_Delay(<span class="hljs-number">100</span>);<font></font>
  }<font></font>
<font></font>
 fail:<font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>){<font></font>
    SDL_Event event;<font></font>
    event.type = FF_QUIT_EVENT;<font></font>
    event.user.data1 = is;<font></font>
    SDL_PushEvent(&amp;event);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{<font></font>
<font></font>
  SDL_Event       event;<font></font>
<font></font>
  VideoState      *is;<font></font>
<font></font>
  is = av_mallocz(<span class="hljs-keyword">sizeof</span>(VideoState));<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Usage: test &lt;file&gt;\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-comment">// Register all formats and codecs</span><font></font>
  av_register_all();<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Make a screen to put our video</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __DARWIN__</span>
        screen = SDL_SetVideoMode(<span class="hljs-number">640</span>, <span class="hljs-number">480</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        screen = SDL_SetVideoMode(<span class="hljs-number">640</span>, <span class="hljs-number">480</span>, <span class="hljs-number">24</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-keyword">if</span>(!screen) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL: could not set video mode - exiting\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  screen_mutex = SDL_CreateMutex();<font></font>
<font></font>
  av_strlcpy(is-&gt;filename, argv[<span class="hljs-number">1</span>], <span class="hljs-keyword">sizeof</span>(is-&gt;filename));<font></font>
<font></font>
  is-&gt;pictq_mutex = SDL_CreateMutex();<font></font>
  is-&gt;pictq_cond = SDL_CreateCond();<font></font>
<font></font>
  schedule_refresh(is, <span class="hljs-number">40</span>);<font></font>
<font></font>
  is-&gt;parse_tid = SDL_CreateThread(decode_thread, is);<font></font>
  <span class="hljs-keyword">if</span>(!is-&gt;parse_tid) {<font></font>
    av_free(is);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
<font></font>
    SDL_WaitEvent(&amp;event);<font></font>
    <span class="hljs-keyword">switch</span>(event.type) {
    <span class="hljs-keyword">case</span> FF_QUIT_EVENT:
    <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
      is-&gt;quit = <span class="hljs-number">1</span>;<font></font>
      SDL_Quit();<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> FF_REFRESH_EVENT:<font></font>
      video_refresh_timer(event.user.data1);<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
<font></font>
}</code></pre></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€»è§ˆ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸Šä¸€æ¬¡ï¼Œæˆ‘ä»¬ä½¿ç”¨SDLéŸ³é¢‘åŠŸèƒ½æ·»åŠ äº†éŸ³é¢‘æ”¯æŒã€‚</font><font style="vertical-align: inherit;">SDLå¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºåœ¨æ¯æ¬¡éœ€è¦å£°éŸ³æ—¶ä¸ºæˆ‘ä»¬å®šä¹‰çš„å‡½æ•°è¿›è¡Œå›è°ƒã€‚</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬å°†å¯¹è§†é¢‘æ˜¾ç¤ºæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚</font><font style="vertical-align: inherit;">è¿™ä½¿ä»£ç æ›´å…·æ¨¡å—åŒ–ï¼Œå¹¶ä¸”æ›´æ˜“äºä½¿ç”¨-ç‰¹åˆ«æ˜¯åœ¨æ‚¨è¦æ·»åŠ åŒæ­¥çš„æƒ…å†µä¸‹ã€‚</font><font style="vertical-align: inherit;">é‚£ä¹ˆæˆ‘ä»¬ä»å“ªé‡Œå¼€å§‹å‘¢ï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œæˆ‘ä»¬çš„ä¸»è¦åŠŸèƒ½å¤„ç†å¾ˆå¤šäº‹æƒ…ï¼šå®ƒé€šè¿‡äº‹ä»¶å¾ªç¯ï¼Œè¯»å–æ•°æ®åŒ…å¹¶å¯¹è§†é¢‘è¿›è¡Œè§£ç ã€‚æˆ‘ä»¬è¦åšçš„æ˜¯å°†ä¸€åˆ‡éƒ½åˆ†æˆå‡ éƒ¨åˆ†ï¼šæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªæµè´Ÿè´£å¯¹æ•°æ®åŒ…è¿›è¡Œè§£ç ï¼›ç„¶åå°†è¿™äº›æ•°æ®åŒ…æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç”±ç›¸åº”çš„éŸ³é¢‘å’Œè§†é¢‘æµè¯»å–ã€‚æˆ‘ä»¬å·²ç»æ ¹æ®éœ€è¦è°ƒæ•´äº†éŸ³é¢‘æµã€‚ä½¿ç”¨è§†é¢‘æµä¼šæœ‰äº›å›°éš¾ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»ç¡®ä¿è§†é¢‘æ˜¯è‡ªå·±æ˜¾ç¤ºçš„ã€‚æˆ‘ä»¬å°†å®é™…çš„æ˜¾ç¤ºä»£ç æ·»åŠ åˆ°ä¸»å¾ªç¯ä¸­ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨æ¯æ¬¡æ‰§è¡Œå¾ªç¯æ—¶éƒ½æ˜¾ç¤ºè§†é¢‘ï¼Œè€Œæ˜¯å°†è§†é¢‘æ˜¾ç¤ºé›†æˆåˆ°äº‹ä»¶å¾ªç¯ä¸­ã€‚æƒ³æ³•æ˜¯è§£ç è§†é¢‘ï¼Œå°†æ¥æ”¶åˆ°çš„å¸§ä¿å­˜åœ¨å¦ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶ååˆ›å»ºè‡ªå·±çš„äº‹ä»¶ï¼ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FF_REFRESH_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œç„¶ååœ¨äº‹ä»¶å¾ªç¯ä¸­çœ‹åˆ°è¯¥äº‹ä»¶æ—¶ï¼Œå®ƒå°†æ˜¾ç¤ºé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€å¸§ã€‚ä»¥ä¸‹æ˜¯å‘ç”Ÿçš„æƒ…å†µçš„ä¾¿æ·ASCIIæ’å›¾ï¼š</font></font><br>
<br>
<div style="text-align:center;"><img width="335" height="221" src="https://habrastorage.org/webt/nf/ej/gq/nfejgqoqpypds3quordh_x2qgwa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šè¿‡äº‹ä»¶å¾ªç¯ç§»åŠ¨è§†é¢‘æ˜¾ç¤ºæ§ä»¶çš„ä¸»è¦åŸå› æ˜¯ï¼Œé€šè¿‡</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_Delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æµï¼Œ</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥ç²¾ç¡®æ§åˆ¶ä¸‹ä¸€ä¸ªè§†é¢‘å¸§ä½•æ—¶å‡ºç°åœ¨å±å¹•ä¸Šã€‚</font><font style="vertical-align: inherit;">å½“æˆ‘ä»¬æœ€ç»ˆåœ¨ä¸‹ä¸€è¯¾ä¸­åŒæ­¥è§†é¢‘æ—¶ï¼Œåªéœ€æ·»åŠ ä»£ç å³å¯å®‰æ’ä¸‹ä¸€æ¬¡è§†é¢‘æ›´æ–°ï¼Œä»¥ä¾¿æ­£ç¡®çš„å›¾åƒåœ¨æ­£ç¡®çš„æ—¶é—´æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç®€åŒ–ä»£ç </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æ¸…é™¤ä¸€ä¸‹ä»£ç ã€‚æˆ‘ä»¬æ‹¥æœ‰æœ‰å…³éŸ³é¢‘å’Œè§†é¢‘ç¼–è§£ç å™¨çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†æ·»åŠ é˜Ÿåˆ—ï¼Œç¼“å†²åŒºï¼Œä¸Šå¸çŸ¥é“è¿˜æœ‰ä»€ä¹ˆã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯é’ˆå¯¹æŸä¸ªé€»è¾‘å•å…ƒçš„ï¼Œå³é’ˆå¯¹ç”µå½±ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ‰“ç®—åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰è¿™äº›ä¿¡æ¯çš„å¤§å‹ç»“æ„ï¼Œç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoState</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoState</span> {</span><font></font>
<font></font>
  AVFormatContext *pFormatCtx;<font></font>
  <span class="hljs-keyword">int</span>             videoStream, audioStream;<font></font>
  AVStream        *audio_st;<font></font>
  AVCodecContext  *audio_ctx;<font></font>
  PacketQueue     audioq;<font></font>
  <span class="hljs-keyword">uint8_t</span>         audio_buf[(AVCODEC_MAX_AUDIO_FRAME_SIZE * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>];
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_size;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_index;<font></font>
  AVPacket        audio_pkt;<font></font>
  <span class="hljs-keyword">uint8_t</span>         *audio_pkt_data;
  <span class="hljs-keyword">int</span>             audio_pkt_size;<font></font>
  AVStream        *video_st;<font></font>
  AVCodecContext  *video_ctx;<font></font>
  PacketQueue     videoq;<font></font>
<font></font>
  VideoPicture    pictq[VIDEO_PICTURE_QUEUE_SIZE];<font></font>
  <span class="hljs-keyword">int</span>             pictq_size, pictq_rindex, pictq_windex;<font></font>
  SDL_mutex       *pictq_mutex;<font></font>
  SDL_cond        *pictq_cond;<font></font>
  <font></font>
  SDL_Thread      *parse_tid;<font></font>
  SDL_Thread      *video_tid;<font></font>
<font></font>
  <span class="hljs-keyword">char</span>            filename[<span class="hljs-number">1024</span>];
  <span class="hljs-keyword">int</span>             quit;<font></font>
} VideoState;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æœ€ç»ˆçš„æç¤ºã€‚é¦–å…ˆï¼Œæˆ‘ä»¬äº†è§£åŸºæœ¬ä¿¡æ¯-éŸ³é¢‘å’Œè§†é¢‘æµçš„æ ¼å¼ä¸Šä¸‹æ–‡ä»¥åŠç´¢å¼•ï¼Œä»¥åŠç›¸åº”çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹è±¡</font><font style="vertical-align: inherit;">ã€‚ç„¶åï¼Œæˆ‘ä»¬çœ‹åˆ°å…¶ä¸­ä¸€äº›éŸ³é¢‘ç¼“å†²åŒºå·²ç§»è‡³æ­¤ç»“æ„ã€‚å®ƒä»¬ï¼ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_buf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_buf_size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰ï¼‰æ—¨åœ¨è·å–æœ‰å…³ä»ç„¶å­˜åœ¨ï¼ˆæˆ–ä¸¢å¤±ï¼‰çš„éŸ³é¢‘çš„ä¿¡æ¯ã€‚æˆ‘ä»¬ä¸ºè§†é¢‘æ·»åŠ äº†å¦ä¸€ä¸ªé˜Ÿåˆ—å’Œä¸€ä¸ªç¼“å†²åŒºï¼ˆå°†ç”¨ä½œé˜Ÿåˆ—ï¼›ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä»»ä½•å¤šä½™çš„é˜Ÿåˆ—ï¼‰ç”¨äºå·²è§£ç çš„å¸§ï¼ˆä¿å­˜ä¸ºå åŠ å±‚ï¼‰ã€‚</font><b><font style="vertical-align: inherit;">VideoPicture</font></b><font style="vertical-align: inherit;">ç»“æ„</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-è¿™æ˜¯æˆ‘ä»¬è‡ªå·±çš„åˆ›ä½œï¼ˆæ¥åˆ°æ—¶å°†çœ‹åˆ°å…¶ä¸­çš„å†…å®¹ï¼‰ã€‚æ‚¨è¿˜å¯ä»¥æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬å·²ç»ä¸ºè¦åˆ›å»ºçš„ä¸¤ä¸ªé™„åŠ æµåˆ†é…äº†æŒ‡é’ˆï¼Œå¹¶ä¸ºé€€å‡ºæ ‡å¿—å’Œå½±ç‰‡æ–‡ä»¶ååˆ†é…äº†æŒ‡é’ˆã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬è¿”å›ä¸»å‡½æ•°ï¼Œä»¥äº†è§£å®ƒå¦‚ä½•æ”¹å˜ç¨‹åºã€‚è®©æˆ‘ä»¬è®¾ç½®æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoState</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{<font></font>
<font></font>
  SDL_Event       event;<font></font>
<font></font>
  VideoState      *is;<font></font>
<font></font>
  is = av_mallocz(<span class="hljs-keyword">sizeof</span>(VideoState));</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_mallocz</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å‡½æ•°ï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬åˆ†é…å†…å­˜å¹¶å°†å…¶æ¸…é›¶ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶åæˆ‘ä»¬åˆå§‹åŒ–æ˜¾ç¤ºç¼“å†²åŒºï¼ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pictq</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰çš„</font><font style="vertical-align: inherit;">é”</font><font style="vertical-align: inherit;">ï¼Œå› ä¸ºç”±äºäº‹ä»¶å¾ªç¯è°ƒç”¨äº†æˆ‘ä»¬çš„æ˜¾ç¤ºåŠŸèƒ½-è¯·è®°ä½ï¼Œæ˜¾ç¤ºåŠŸèƒ½å°†ä»</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pictq</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ£€ç´¢é¢„è§£ç çš„å¸§</font><font style="vertical-align: inherit;">ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬çš„è§†é¢‘è§£ç å™¨ä¼šå°†ä¿¡æ¯æ”¾å…¥å…¶ä¸­-æˆ‘ä»¬ä¸çŸ¥é“è°å…ˆåˆ°è¾¾é‚£é‡Œã€‚å¸Œæœ›æ‚¨äº†è§£è¿™æ˜¯ç»å…¸çš„æ¯”èµ›æ¡ä»¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨åœ¨å¼€å§‹ä»»ä½•ä¸»é¢˜ä¹‹å‰å…ˆåˆ†å‘å®ƒã€‚è®©æˆ‘ä»¬è¿˜å°†ç”µå½±çš„åç§°å¤åˆ¶åˆ°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoStateä¸­</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">av_strlcpy(is-&gt;filename, argv[<span class="hljs-number">1</span>], <span class="hljs-keyword">sizeof</span>(is-&gt;filename));<font></font>
<font></font>
is-&gt;pictq_mutex = SDL_CreateMutex();<font></font>
is-&gt;pictq_cond = SDL_CreateCond();</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_strlcpy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯FFmpegçš„å‡½æ•°ï¼Œé™¤äº†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strncpy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹‹å¤–è¿˜æ‰§è¡Œå…¶ä»–ä¸€äº›è¾¹ç•Œæ£€æŸ¥</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬è¿è¡Œçº¿ç¨‹å¹¶åšä¸€äº›å®é™…çš„äº‹æƒ…ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">schedule_refresh(is, <span class="hljs-number">40</span>);<font></font>
<font></font>
is-&gt;parse_tid = SDL_CreateThread(decode_thread, is);<font></font>
<span class="hljs-keyword">if</span>(!is-&gt;parse_tid) {<font></font>
  av_free(is);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schedule_refresh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬ç¨åå°†å®šä¹‰çš„å‡½æ•°ã€‚å¥¹æ‰€åšçš„æ˜¯å‘Šè¯‰ç³»ç»Ÿ</font><font style="vertical-align: inherit;">åœ¨æŒ‡å®šçš„æ¯«ç§’æ•°å</font><font style="vertical-align: inherit;">äº§ç”Ÿ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FF_REFRESH_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚åè¿‡æ¥ï¼Œå½“æˆ‘ä»¬åœ¨äº‹ä»¶é˜Ÿåˆ—ä¸­çœ‹åˆ°è§†é¢‘æ›´æ–°åŠŸèƒ½æ—¶ï¼Œå®ƒå°†è°ƒç”¨è§†é¢‘æ›´æ–°åŠŸèƒ½ã€‚ä½†æ˜¯ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CreateThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CreateThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å°±æ˜¯è¿™æ ·åšçš„-å®ƒäº§ç”Ÿä¸€ä¸ªå…·æœ‰å¯¹åŸå§‹è¿›ç¨‹æ‰€æœ‰å†…å­˜çš„å®Œå…¨è®¿é—®æƒé™çš„æ–°çº¿ç¨‹ï¼Œå¹¶å¯åŠ¨æˆ‘ä»¬æä¾›çš„å‡½æ•°æ‰§è¡Œçš„çº¿ç¨‹ã€‚æ­¤åŠŸèƒ½è¿˜å°†ä¼ è¾“ç”¨æˆ·å®šä¹‰çš„æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decode_thread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å¹¶é™„åŠ æˆ‘ä»¬çš„</font><b><font style="vertical-align: inherit;">VideoState</font></b><font style="vertical-align: inherit;">ç»“æ„</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚è¯¥åŠŸèƒ½çš„å‰åŠéƒ¨åˆ†æ²¡æœ‰æ–°å†…å®¹ï¼›å®ƒåªæ˜¯æ‰“å¼€æ–‡ä»¶å¹¶æŸ¥æ‰¾éŸ³é¢‘å’Œè§†é¢‘æµçš„ç´¢å¼•ã€‚æˆ‘ä»¬å”¯ä¸€ä¸åŒçš„æ–¹æ³•æ˜¯å°†æ ¼å¼ä¸Šä¸‹æ–‡ä¿ç•™åœ¨æˆ‘ä»¬çš„å¤§å‹ç»“æ„ä¸­ã€‚æ‰¾åˆ°æµç´¢å¼•åï¼Œæˆ‘ä»¬è°ƒç”¨å®šä¹‰çš„å¦ä¸€ä¸ªå‡½æ•°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream_component_open</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚è¿™æ˜¯ä¸€ç§å¾ˆè‡ªç„¶çš„åˆ†ç¦»æ–¹å¼ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬åšäº†å¾ˆå¤šç±»ä¼¼çš„äº‹æƒ…æ¥è®¾ç½®è§†é¢‘å’ŒéŸ³é¢‘ç¼–è§£ç å™¨ï¼Œå› æ­¤æˆ‘ä»¬é‡ç”¨äº†ä¸€äº›ä»£ç ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå‡½æ•°ã€‚</font><b><font style="vertical-align: inherit;">Stream_component_open</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
å‡½æ•°</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰æ˜¯æˆ‘ä»¬å‘ç°ç¼–è§£ç å™¨ï¼Œé…ç½®å£°éŸ³å‚æ•°ï¼Œåœ¨é‡è¦ç»“æ„ä¸­ä¿å­˜é‡è¦ä¿¡æ¯å¹¶å¯åŠ¨éŸ³é¢‘å’Œè§†é¢‘æµçš„åœ°æ–¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿˜æ’å…¥å…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚å¼ºåˆ¶ä½¿ç”¨ç¼–è§£ç å™¨è€Œä¸æ˜¯è‡ªåŠ¨æ£€æµ‹ç¼–è§£ç å™¨ç­‰ã€‚åƒè¿™æ ·ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">stream_component_open</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> stream_index)</span> </span>{<font></font>
<font></font>
  AVFormatContext *pFormatCtx = is-&gt;pFormatCtx;<font></font>
  AVCodecContext *codecCtx;<font></font>
  AVCodec *codec;<font></font>
  SDL_AudioSpec wanted_spec, spec;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(stream_index &lt; <span class="hljs-number">0</span> || stream_index &gt;= pFormatCtx-&gt;nb_streams) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codec = avcodec_find_decoder(pFormatCtx-&gt;streams[stream_index]-&gt;codec-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(!codec) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codecCtx = avcodec_alloc_context3(codec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(codecCtx, pFormatCtx-&gt;streams[stream_index]-&gt;codec) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(codecCtx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
    <span class="hljs-comment">// Set audio settings from codec info</span><font></font>
    wanted_spec.freq = codecCtx-&gt;sample_rate;<font></font>
    <span class="hljs-comment">/* ...etc... */</span><font></font>
    wanted_spec.callback = audio_callback;<font></font>
    wanted_spec.userdata = is;<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(avcodec_open2(codecCtx, codec, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">switch</span>(codecCtx-&gt;codec_type) {
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_AUDIO:<font></font>
    is-&gt;audioStream = stream_index;<font></font>
    is-&gt;audio_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;audio_ctx = codecCtx;<font></font>
    is-&gt;audio_buf_size = <span class="hljs-number">0</span>;<font></font>
    is-&gt;audio_buf_index = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">memset</span>(&amp;is-&gt;audio_pkt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(is-&gt;audio_pkt));<font></font>
    packet_queue_init(&amp;is-&gt;audioq);<font></font>
    SDL_PauseAudio(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_VIDEO:<font></font>
    is-&gt;videoStream = stream_index;<font></font>
    is-&gt;video_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;video_ctx = codecCtx;<font></font>
    <font></font>
    packet_queue_init(&amp;is-&gt;videoq);<font></font>
    is-&gt;video_tid = SDL_CreateThread(video_thread, is);<font></font>
    is-&gt;sws_ctx = sws_getContext(is-&gt;video_st-&gt;codec-&gt;width, is-&gt;video_st-&gt;codec-&gt;height,<font></font>
				 is-&gt;video_st-&gt;codec-&gt;pix_fmt, is-&gt;video_st-&gt;codec-&gt;width,<font></font>
				 is-&gt;video_st-&gt;codec-&gt;height, PIX_FMT_YUV420P,<font></font>
				 SWS_BILINEAR, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span><font></font>
				 );<font></font>
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™ä¸æˆ‘ä»¬ä»¥å‰çš„ä»£ç å‡ ä¹ç›¸åŒï¼Œåªæ˜¯ç°åœ¨å®ƒå·²è¢«å¹¿æ³›ç”¨äºéŸ³é¢‘å’Œè§†é¢‘ã€‚è¯·æ³¨æ„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å·²å°†å¤§å‹ç»“æ„é…ç½®ä¸ºéŸ³é¢‘å›è°ƒçš„ç”¨æˆ·æ•°æ®</font><font style="vertical-align: inherit;">ï¼Œè€Œä¸æ˜¯</font><b><font style="vertical-align: inherit;">aCodecCtx</font></b><font style="vertical-align: inherit;">ã€‚æˆ‘ä»¬è¿˜å°†æµæœ¬èº«ä¿å­˜ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_st</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video_st</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†è§†é¢‘é˜Ÿåˆ—å¹¶åƒè®¾ç½®éŸ³é¢‘é˜Ÿåˆ—ä¸€æ ·å¯¹å…¶è¿›è¡Œè®¾ç½®ã€‚æœ€é‡è¦çš„æ˜¯è¿è¡Œè§†é¢‘å’ŒéŸ³é¢‘æµã€‚è¿™äº›ä½æ‰§è¡Œæ­¤æ“ä½œï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    SDL_PauseAudio(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">break</span>;<font></font>
<font></font>
<span class="hljs-comment">/* ...... */</span><font></font>
<font></font>
    is-&gt;video_tid = SDL_CreateThread(video_thread, is);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®°ä½</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šä¸€è¯¾çš„SDL_PauseAudio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CreateThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰çš„ä½¿ç”¨æ–¹å¼ç›¸åŒã€‚å›åˆ°æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video_thread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ­¤ä¹‹å‰ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›åˆ°</font><b><font style="vertical-align: inherit;">è§£ç </font></b><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">çš„ç¬¬äºŒéƒ¨åˆ†</font><font style="vertical-align: inherit;">ã€‚æœ¬è´¨ä¸Šï¼Œè¿™åªæ˜¯ä¸€ä¸ªforå¾ªç¯ï¼Œå®ƒè¯»å–ä¸€ä¸ªåŒ…å¹¶å°†å…¶æ”¾å…¥æ­£ç¡®çš„é˜Ÿåˆ—ä¸­ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// seek stuff goes here</span>
    <span class="hljs-keyword">if</span>(is-&gt;audioq.size &gt; MAX_AUDIOQ_SIZE ||<font></font>
       is-&gt;videoq.size &gt; MAX_VIDEOQ_SIZE) {<font></font>
      SDL_Delay(<span class="hljs-number">10</span>);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(av_read_frame(is-&gt;pFormatCtx, packet) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span>((is-&gt;pFormatCtx-&gt;pb-&gt;error) == <span class="hljs-number">0</span>) {<font></font>
	SDL_Delay(<span class="hljs-number">100</span>); <span class="hljs-comment">/* no error; wait for user input */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      } <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;videoStream) {<font></font>
      packet_queue_put(&amp;is-&gt;videoq, packet);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;audioStream) {<font></font>
      packet_queue_put(&amp;is-&gt;audioq, packet);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      av_free_packet(packet);<font></font>
    }<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆçœŸæ­£çš„æ–°ä¸œè¥¿ï¼Œé™¤äº†æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªæœ€å¤§çš„éŸ³é¢‘å’Œè§†é¢‘é˜Ÿåˆ—å¤§å°ï¼Œå¹¶ä¸”æˆ‘ä»¬æ·»åŠ äº†è¯»å–é”™è¯¯æ£€æŸ¥ã€‚æ ¼å¼ä¸Šä¸‹æ–‡åœ¨å†…éƒ¨å…·æœ‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ByteIOContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„ï¼Œ</font><font style="vertical-align: inherit;">ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ByteIOContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯ä¸€ç§åŸºæœ¬ä¸Šå­˜å‚¨æœ‰å…³ä½çº§æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯çš„ç»“æ„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æˆ‘ä»¬çš„forå¾ªç¯ä¹‹åï¼Œæˆ‘ä»¬æ‹¥æœ‰æ‰€æœ‰ä»£ç æ¥ç­‰å¾…ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†å®Œæˆæˆ–é€šçŸ¥å®ƒã€‚è¿™æ®µä»£ç å…·æœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œå› ä¸ºå®ƒæ˜¾ç¤ºäº†æˆ‘ä»¬å¦‚ä½•æ¨é€äº‹ä»¶-ç¨åæˆ‘ä»¬éœ€è¦ä¸€äº›ä¸œè¥¿æ¥æ˜¾ç¤ºè§†é¢‘ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">while</span>(!is-&gt;quit) {<font></font>
    SDL_Delay(<span class="hljs-number">100</span>);<font></font>
  }<font></font>
<font></font>
 fail:<font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>){<font></font>
    SDL_Event event;<font></font>
    event.type = FF_QUIT_EVENT;<font></font>
    event.user.data1 = is;<font></font>
    SDL_PushEvent(&amp;event);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬ä½¿ç”¨SDLå¸¸é‡</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_USEREVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·å¾—è‡ªå®šä¹‰äº‹ä»¶çš„å€¼</font><font style="vertical-align: inherit;">ã€‚å¿…é¡»å°†ç¬¬ä¸€ä¸ªç”¨æˆ·äº‹ä»¶è®¾ç½®ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_USEREVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä¸‹ä¸€ä¸ª</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_USEREVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> +1</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç­‰ç­‰ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FF_QUIT_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­å®šä¹‰ä¸º</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_USEREVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> +1</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚å¦‚æœéœ€è¦ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¼ é€’ç”¨æˆ·æ•°æ®ï¼Œè¿™é‡Œæˆ‘ä»¬å°†æŒ‡é’ˆä¼ é€’ç»™å¤§å‹ç»“æ„ã€‚æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_PushEvent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚åœ¨äº‹ä»¶å¾ªç¯å¼€å…³ä¸­ï¼Œæˆ‘ä»¬å°†å…¶æ”¾åœ¨</font><b><font style="vertical-align: inherit;">SDL_QUIT_EVENT</font></b><font style="vertical-align: inherit;">éƒ¨åˆ†ä¸­</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä»¥å‰æœ‰è¿‡çš„ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†æ›´è¯¦ç»†åœ°äº†è§£äº‹ä»¶çš„å‘¨æœŸï¼›</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œè¯·ç¡®ä¿åœ¨æˆ‘ä»¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‰FF_QUIT_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ—¶</font><b><font style="vertical-align: inherit;">ç¨å</font></b><font style="vertical-align: inherit;">å†æ•è·å®ƒå¹¶åˆ‡æ¢é€€å‡ºæ ‡å¿—ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¥æ”¶å¸§ï¼švideo_thread</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‡†å¤‡å¥½ç¼–è§£ç å™¨åï¼Œå°±å¯ä»¥å¼€å§‹è§†é¢‘æµäº†ã€‚</font><font style="vertical-align: inherit;">æ­¤æµä»è§†é¢‘é˜Ÿåˆ—è¯»å–æ•°æ®åŒ…ï¼Œå°†è§†é¢‘è§£ç ä¸ºå¸§ï¼Œç„¶åè°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue_picture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å°†å¤„ç†åçš„å¸§æ”¾å…¥å›¾åƒé˜Ÿåˆ—ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">video_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{<font></font>
  VideoState *is = (VideoState *)arg;<font></font>
  AVPacket pkt1, *packet = &amp;pkt1;<font></font>
  <span class="hljs-keyword">int</span> frameFinished;<font></font>
  AVFrame *pFrame;<font></font>
<font></font>
  pFrame = av_frame_alloc();<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// means we quit getting packets</span>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// Decode video frame</span><font></font>
    avcodec_decode_video2(is-&gt;video_st-&gt;codec, pFrame, &amp;frameFinished, packet);<font></font>
<font></font>
    <span class="hljs-comment">// Did we get a video frame?</span>
    <span class="hljs-keyword">if</span>(frameFinished) {
      <span class="hljs-keyword">if</span>(queue_picture(is, pFrame) &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
    av_free_packet(packet);<font></font>
  }<font></font>
  av_free(pFrame);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå¤§å¤šæ•°åŠŸèƒ½éƒ½åº”è¯¥è¢«ç†è§£ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬åªæ˜¯åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤„</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤åˆ¶äº†avcodec_decode_video2å‡½æ•°</font><font style="vertical-align: inherit;">ï¼Œåªéœ€æ›¿æ¢ä¸€äº›å‚æ•°å³å¯ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª</font><font style="vertical-align: inherit;">å­˜å‚¨åœ¨å¤§å‹ç»“æ„ä¸­</font><font style="vertical-align: inherit;">çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå› æ­¤å¯ä»¥ä»é‚£é‡Œè·å–ç¼–è§£ç å™¨ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬åªæ˜¯ç»§ç»­ä»è§†é¢‘é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®åŒ…ï¼Œç›´åˆ°æœ‰äººå‘Šè¯‰æˆ‘ä»¬é€€å‡ºæˆ–æˆ‘ä»¬å‘ç°é”™è¯¯ä¸ºæ­¢ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é˜Ÿåˆ—æ¡†æ¶</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å°†å·²è§£ç çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­˜å‚¨</font><font style="vertical-align: inherit;">åœ¨å›¾åƒé˜Ÿåˆ—</font><font style="vertical-align: inherit;">ä¸­çš„å‡½æ•°</font><font style="vertical-align: inherit;">ã€‚ç”±äºæˆ‘ä»¬çš„å›¾åƒé˜Ÿåˆ—æ˜¯SDLçš„å åŠ å±‚ï¼ˆå¤§æ¦‚æ˜¯ä¸ºäº†ä½¿è§†é¢‘æ˜¾ç¤ºåŠŸèƒ½èƒ½å¤Ÿæ‰§è¡Œå°½å¯èƒ½å°‘çš„è®¡ç®—ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†å¸§è½¬æ¢æˆå®ƒã€‚æˆ‘ä»¬å­˜å‚¨åœ¨å›¾åƒé˜Ÿåˆ—ä¸­çš„æ•°æ®æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ç»“æ„ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoPicture</span> {</span><font></font>
  SDL_Overlay *bmp;<font></font>
  <span class="hljs-keyword">int</span> width, height; <span class="hljs-comment">/* source height &amp; width */</span>
  <span class="hljs-keyword">int</span> allocated;<font></font>
} VideoPicture;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬çš„å¤§å‹ç»“æ„åŒ…å«è¿™äº›æ–‡ä»¶çš„ç¼“å†²åŒºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨å®ƒä»¬ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±åˆ†å‘</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_Overlay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆè¯·æ³¨æ„åˆ†é…çš„æ ‡å¿—ï¼Œè¯¥æ ‡å¿—è¡¨æ˜æˆ‘ä»¬æ˜¯å¦è¿›è¡Œäº†è®¾ç½®ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦ä½¿ç”¨æ­¤é˜Ÿåˆ—ï¼Œæˆ‘ä»¬â€‹â€‹æœ‰ä¸¤ä¸ªæŒ‡é’ˆ-å†™ç´¢å¼•å’Œè¯»ç´¢å¼•ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬è¿˜è·Ÿè¸ªç¼“å†²åŒºä¸­æœ‰å¤šå°‘å®é™…å›¾åƒã€‚</font><font style="vertical-align: inherit;">è¦å†™å…¥é˜Ÿåˆ—ï¼Œæˆ‘ä»¬â€‹â€‹é¦–å…ˆç­‰å¾…ç›´åˆ°æ¸…é™¤ç¼“å†²åŒºï¼Œä»¥ä¾¿æˆ‘ä»¬æœ‰ä¸€ä¸ªä½ç½®æ¥å­˜å‚¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç„¶åæ£€æŸ¥æ˜¯å¦åœ¨è®°å½•ç´¢å¼•ä¸­è®¾ç½®äº†è¦†ç›–å›¾ï¼Ÿ</font><font style="vertical-align: inherit;">å¦‚æœä¸æ˜¯ï¼Œåˆ™éœ€è¦åˆ†é…å†…å­˜ã€‚</font><font style="vertical-align: inherit;">å¦‚æœçª—å£å¤§å°å·²æ›´æ”¹ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»é‡æ–°åˆ†é…ç¼“å†²åŒºï¼</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">queue_picture</span><span class="hljs-params">(VideoState *is, AVFrame *pFrame)</span> </span>{<font></font>
<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">int</span> dst_pix_fmt;<font></font>
  AVPicture pict;<font></font>
<font></font>
  <span class="hljs-comment">/* wait until we have space for a new pic */</span><font></font>
  SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
  <span class="hljs-keyword">while</span>(is-&gt;pictq_size &gt;= VIDEO_PICTURE_QUEUE_SIZE &amp;&amp;<font></font>
	!is-&gt;quit) {<font></font>
    SDL_CondWait(is-&gt;pictq_cond, is-&gt;pictq_mutex);<font></font>
  }<font></font>
  SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is-&gt;quit)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">// windex is set to 0 initially</span><font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
<font></font>
  <span class="hljs-comment">/* allocate or resize the buffer! */</span>
  <span class="hljs-keyword">if</span>(!vp-&gt;bmp ||<font></font>
     vp-&gt;width != is-&gt;video_st-&gt;codec-&gt;width ||<font></font>
     vp-&gt;height != is-&gt;video_st-&gt;codec-&gt;height) {<font></font>
    SDL_Event event;<font></font>
<font></font>
    vp-&gt;allocated = <span class="hljs-number">0</span>;<font></font>
    alloc_picture(is);<font></font>
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc_picture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">alloc_picture</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-comment">// we already have one make another, bigger/smaller</span><font></font>
    SDL_FreeYUVOverlay(vp-&gt;bmp);<font></font>
  }<font></font>
  <span class="hljs-comment">// Allocate a place to put our YUV image on that screen</span><font></font>
  SDL_LockMutex(screen_mutex);<font></font>
  vp-&gt;bmp = SDL_CreateYUVOverlay(is-&gt;video_st-&gt;codec-&gt;width,<font></font>
				 is-&gt;video_st-&gt;codec-&gt;height,<font></font>
				 SDL_YV12_OVERLAY,<font></font>
				 screen);<font></font>
  SDL_UnlockMutex(screen_mutex);<font></font>
  vp-&gt;width = is-&gt;video_st-&gt;codec-&gt;width;<font></font>
  vp-&gt;height = is-&gt;video_st-&gt;codec-&gt;height;  <font></font>
  vp-&gt;allocated = <span class="hljs-number">1</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨åº”è¯¥è®¤è¯†åˆ°å‡½æ•°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_CreateYUVOverlay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬å·²ç»å°†å…¶ä»ä¸»å¾ªç¯ç§»åˆ°äº†æœ¬èŠ‚ã€‚è¯¥ä»£ç ç°åœ¨åº”è¯¥å·²ç»ç›¸å½“æ¸…æ¥šäº†ã€‚ä½†æ˜¯ï¼Œç°åœ¨æœ‰äº†äº’æ–¥é”ï¼Œå› ä¸ºä¸¤ä¸ªçº¿ç¨‹æ— æ³•åŒæ—¶å°†ä¿¡æ¯å†™å…¥å±å¹•ï¼è¿™å°†ä¸å…è®¸æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alloc_picture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å¹²æ‰°å¦ä¸€ä¸ªå°†æ˜¾ç¤ºå›¾ç‰‡çš„å‡½æ•°ã€‚ ï¼ˆæˆ‘ä»¬å°†æ­¤é”åˆ›å»ºä¸ºå…¨å±€å˜é‡ï¼Œå¹¶åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ä¸­</font><font style="vertical-align: inherit;">å¯¹å…¶è¿›è¡Œäº†åˆå§‹åŒ–</font><font style="vertical-align: inherit;">ï¼›è¯·å‚è§ä»£ç ã€‚ï¼‰è¯·è®°ä½ï¼Œæˆ‘ä»¬å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„çš„å®½åº¦å’Œé«˜åº¦ä¿æŒä¸å˜</font><font style="vertical-align: inherit;">ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç¡®ä¿è§†é¢‘çš„å¤§å°ä¸ä¼šç”±äºæŸäº›åŸå› è€Œæ”¹å˜ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½çš„ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†ï¼Œæˆ‘ä»¬æœ‰å åŠ çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä¸“ç”¨å¹¶å‡†å¤‡æ¥æ”¶å›¾åƒã€‚è®©æˆ‘ä»¬å›åˆ°</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue_picture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œçœ‹çœ‹å°†å¸§å¤åˆ¶åˆ°å åŠ å±‚çš„ä»£ç ã€‚è¿™éƒ¨åˆ†æ‚¨åº”è¯¥ç†Ÿæ‚‰ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">queue_picture</span><span class="hljs-params">(VideoState *is, AVFrame *pFrame)</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">/* Allocate a frame if we need it... */</span>
  <span class="hljs-comment">/* ... */</span>
  <span class="hljs-comment">/* We have a place to put our picture on the queue */</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {<font></font>
<font></font>
    SDL_LockYUVOverlay(vp-&gt;bmp);<font></font>
    <font></font>
    dst_pix_fmt = PIX_FMT_YUV420P;<font></font>
    <span class="hljs-comment">/* point pict at the queue */</span><font></font>
<font></font>
    pict.data[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
    pict.data[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
    pict.data[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    pict.linesize[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
    pict.linesize[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
    pict.linesize[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    <span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
    sws_scale(is-&gt;sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
	      pFrame-&gt;linesize, <span class="hljs-number">0</span>, is-&gt;video_st-&gt;codec-&gt;height,<font></font>
	      pict.data, pict.linesize);<font></font>
    <font></font>
    SDL_UnlockYUVOverlay(vp-&gt;bmp);<font></font>
    <span class="hljs-comment">/* now we inform our display thread that we have a pic ready */</span>
    <span class="hljs-keyword">if</span>(++is-&gt;pictq_windex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
      is-&gt;pictq_windex = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
    is-&gt;pictq_size++;<font></font>
    SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œå¤§å¤šæ•°åªæ˜¯æˆ‘ä»¬ä¹‹å‰ç”¨æ¥ç”¨</font><font style="vertical-align: inherit;">æ¡†æ¶</font><font style="vertical-align: inherit;">å¡«å……</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YUV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å åŠ å±‚çš„ä»£ç </font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æœ€åä¸€ä½åªæ˜¯å°†æˆ‘ä»¬çš„å€¼â€œæ·»åŠ â€åˆ°é˜Ÿåˆ—ä¸­ã€‚</font><font style="vertical-align: inherit;">é˜Ÿåˆ—æ­£å¸¸å·¥ä½œï¼Œå°†å€¼æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ç›´åˆ°é˜Ÿåˆ—æ»¡ä¸ºæ­¢ï¼Œå¹¶åœ¨é˜Ÿåˆ—ä¸­è‡³å°‘æœ‰å†…å®¹çš„æƒ…å†µä¸‹è¿›è¡Œè¯»å–ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œè¿™ä¸€åˆ‡éƒ½å–å†³äºä»·å€¼</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - &gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pictq_size</font></font></b></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬è¦é˜»æ­¢å®ƒã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåšä»€ä¹ˆï¼šå¢åŠ è®°å½•æŒ‡é’ˆï¼ˆå¦‚æœ‰å¿…è¦ï¼Œé‡æ–°å¼€å§‹ï¼‰ï¼Œç„¶åé˜»å¡é˜Ÿåˆ—å¹¶å¢åŠ å…¶å¤§å°ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬çš„è¯»è€…å°†çŸ¥é“æœ‰æ›´å¤šæœ‰å…³è¯¥é˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¦‚æœè¿™ä½¿æˆ‘ä»¬çš„é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™è®°å½•å™¨å°†å¯¹æ­¤æœ‰æ‰€äº†è§£ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§†é¢‘å±•ç¤º</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯æˆ‘ä»¬çš„è§†é¢‘ä¸»é¢˜ï¼ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ‰€æœ‰çš„å…è´¹çº¿ç¨‹ï¼Œé™¤äº†ä¸€ä¸ªçº¿ç¨‹ä¹‹å¤–-è¿˜è®°å¾—æˆ‘ä»¬å¾ˆä¹…ä»¥å‰å¦‚ä½•è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schedule_refresh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å—ï¼Ÿçœ‹çœ‹å®é™…å‘ç”Ÿäº†ä»€ä¹ˆï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* schedule a video refresh in 'delay' ms */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">schedule_refresh</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> delay)</span> </span>{<font></font>
  SDL_AddTimer(delay, sdl_refresh_timer_cb, is);<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_AddTimer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰æ˜¯ä¸€ä¸ªSDLå‡½æ•°ï¼Œä»…åœ¨ä¸€å®šçš„æ¯«ç§’æ•°åç®€å•åœ°æ‰§è¡Œå¯¹ç”¨æˆ·å®šä¹‰å‡½æ•°çš„å›è°ƒï¼ˆå¹¶åœ¨å¿…è¦æ—¶ä¼ è¾“ä¸€äº›ç”¨æˆ·å®šä¹‰çš„æ•°æ®ï¼‰ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ­¤å‡½æ•°å®‰æ’è§†é¢‘æ›´æ–°-æ¯æ¬¡è°ƒç”¨å®ƒæ—¶ï¼Œå®ƒéƒ½ä¼šè®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨æ¥è§¦å‘äº‹ä»¶ï¼Œè¿™å°†å¯¼è‡´æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰å‡½æ•°è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°ä»é˜Ÿåˆ—å›¾ç‰‡ä¸­æå–å¸§å¹¶æ˜¾ç¤ºå¥¹ï¼ ï¼ä¸€å¥è¯ä¸‰ä¸ªâ€œå“ªä¸ª/å“ªä¸ª/å“ªä¸ªâ€ï¼å› æ­¤ï¼Œæˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹-è§¦å‘æ­¤äº‹ä»¶ã€‚è¿™å°†æˆ‘ä»¬å‘é€è‡³ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> Uint32 <span class="hljs-title">sdl_refresh_timer_cb</span><span class="hljs-params">(Uint32 interval, <span class="hljs-keyword">void</span> *opaque)</span> </span>{<font></font>
  SDL_Event event;<font></font>
  event.type = FF_REFRESH_EVENT;<font></font>
  event.user.data1 = opaque;<font></font>
  SDL_PushEvent(&amp;event);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* 0 means stop timer */</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥æ´»åŠ¨ç”±æˆ‘ä»¬çš„è€æœ‹å‹å‘èµ·ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FF_REFRESH_EVENTåœ¨æ­¤</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®šä¹‰ä¸º</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDL_USEREVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> +1</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬è¿”å›0æ—¶ï¼ŒSDLå°†åœæ­¢è®¡æ—¶å™¨ï¼Œå› æ­¤å›è°ƒä¸ä¼šå†æ¬¡æ‰§è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¬¡è°ƒç”¨äº†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FF_REFRESH_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬éœ€è¦åœ¨äº‹ä»¶å¾ªç¯ä¸­å¯¹å…¶è¿›è¡Œå¤„ç†ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(;;) {<font></font>
<font></font>
  SDL_WaitEvent(&amp;event);<font></font>
  <span class="hljs-keyword">switch</span>(event.type) {
  <span class="hljs-comment">/* ... */</span>
  <span class="hljs-keyword">case</span> FF_REFRESH_EVENT:<font></font>
    video_refresh_timer(event.user.data1);<font></font>
    <span class="hljs-keyword">break</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ˜¯ä»€ä¹ˆå°†æˆ‘ä»¬å¸¦åˆ°æ­¤åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å®é™…ä¸Šæ˜¯ä»å›¾åƒé˜Ÿåˆ—ä¸­æå–æ•°æ®ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_refresh_timer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(is-&gt;video_st) {
    <span class="hljs-keyword">if</span>(is-&gt;pictq_size == <span class="hljs-number">0</span>) {<font></font>
      schedule_refresh(is, <span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
      <span class="hljs-comment">/* Timing code goes here */</span><font></font>
<font></font>
      schedule_refresh(is, <span class="hljs-number">80</span>);<font></font>
      <font></font>
      <span class="hljs-comment">/* show the picture! */</span><font></font>
      video_display(is);<font></font>
      <font></font>
      <span class="hljs-comment">/* update queue for next picture! */</span>
      <span class="hljs-keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
	is-&gt;pictq_rindex = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
      SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
      is-&gt;pictq_size--;<font></font>
      SDL_CondSignal(is-&gt;pictq_cond);<font></font>
      SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    schedule_refresh(is, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç›®å‰ï¼Œæ­¤åŠŸèƒ½éå¸¸ç®€å•ï¼šå®ƒåœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ‰ç©º</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ—¶å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®è®¡æ—¶å™¨ä»¥æ˜¾ç¤ºä¸‹ä¸€ä¸ªè§†é¢‘å¸§ï¼Œè°ƒç”¨</font><b><font style="vertical-align: inherit;">video_display</font></b><font style="vertical-align: inherit;">ä»¥åœ¨å±å¹•ä¸Šå®é™…æ˜¾ç¤ºè§†é¢‘ï¼Œç„¶åå¢åŠ é˜Ÿåˆ—ä¸­çš„è®¡æ•°å™¨ï¼ŒåŒæ—¶å‡å°å…¶å¤§å°ã€‚æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œ</font><font style="vertical-align: inherit;">åœ¨æ­¤åŠŸèƒ½ä¸­ï¼Œ</font><font style="vertical-align: inherit;">æˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰å¯¹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åšä»»ä½•äº‹æƒ…ï¼Œ</font><font style="vertical-align: inherit;">è¿™å°±æ˜¯åŸå› ï¼šè¿™æ˜¯æœªæ¥ã€‚ä½†æ˜¯è¿‡äº†ä¸€ä¼šå„¿ã€‚å½“æˆ‘ä»¬å¼€å§‹å°†è§†é¢‘ä¸éŸ³é¢‘åŒæ­¥æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è®¿é—®æ—¶é—´ä¿¡æ¯ã€‚åœ¨è¿™é‡Œï¼Œè¯·çœ‹ä¸€ä¸‹ä»£ç ä¸­å†™æœ‰â€œ Timing code go hereâ€çš„æ³¨é‡Šçš„ä½ç½®ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ‰¾å‡ºåº”è¯¥æ˜¾ç¤ºä¸‹ä¸€å¸§è§†é¢‘çš„æ—¶é—´ï¼Œç„¶ååœ¨</font><b><font style="vertical-align: inherit;">schedule_refresh</font></b><font style="vertical-align: inherit;">å‡½æ•°ä¸­è¾“å…¥è¯¥å€¼ã€‚</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ã€‚ç›®å‰ï¼Œæˆ‘ä»¬åªè¾“å…¥ä¸€ä¸ªè™šæ‹Ÿå€¼80ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œæ‚¨å¯ä»¥çŒœæµ‹å¹¶æ£€æŸ¥è¯¥å€¼å¹¶ä¸ºæ¯éƒ¨ç”µå½±é‡æ–°ç¼–è¯‘ï¼Œä½†æ˜¯ï¼š1ï¼‰ä¸€æ®µæ—¶é—´åå®ƒå°†å¼€å§‹å˜æ…¢ï¼Œ2ï¼‰ç›¸å½“æ„šè ¢ã€‚è™½ç„¶ï¼Œå°†æ¥æˆ‘ä»¬ä¼šå›åˆ°è¿™ä¸€ç‚¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å¿«å®Œæˆäº†ã€‚å‰©ä¸‹è¦åšçš„åªæœ‰ä¸€ä»¶äº‹ï¼šæ˜¾ç¤ºè§†é¢‘ï¼è¿™æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video_display</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_display</span><span class="hljs-params">(VideoState *is)</span> </span>{<font></font>
<font></font>
  SDL_Rect rect;<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">float</span> aspect_ratio;
  <span class="hljs-keyword">int</span> w, h, x, y;
  <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-keyword">if</span>(is-&gt;video_st-&gt;codec-&gt;sample_aspect_ratio.num == <span class="hljs-number">0</span>) {<font></font>
      aspect_ratio = <span class="hljs-number">0</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      aspect_ratio = av_q2d(is-&gt;video_st-&gt;codec-&gt;sample_aspect_ratio) *<font></font>
	is-&gt;video_st-&gt;codec-&gt;width / is-&gt;video_st-&gt;codec-&gt;height;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(aspect_ratio &lt;= <span class="hljs-number">0.0</span>) {<font></font>
      aspect_ratio = (<span class="hljs-keyword">float</span>)is-&gt;video_st-&gt;codec-&gt;width /<font></font>
	(<span class="hljs-keyword">float</span>)is-&gt;video_st-&gt;codec-&gt;height;<font></font>
    }<font></font>
    h = screen-&gt;h;<font></font>
    w = ((<span class="hljs-keyword">int</span>)rint(h * aspect_ratio)) &amp; <span class="hljs-number">-3</span>;
    <span class="hljs-keyword">if</span>(w &gt; screen-&gt;w) {<font></font>
      w = screen-&gt;w;<font></font>
      h = ((<span class="hljs-keyword">int</span>)rint(w / aspect_ratio)) &amp; <span class="hljs-number">-3</span>;<font></font>
    }<font></font>
    x = (screen-&gt;w - w) / <span class="hljs-number">2</span>;<font></font>
    y = (screen-&gt;h - h) / <span class="hljs-number">2</span>;<font></font>
    <font></font>
    rect.x = x;<font></font>
    rect.y = y;<font></font>
    rect.w = w;<font></font>
    rect.h = h;<font></font>
    SDL_LockMutex(screen_mutex);<font></font>
    SDL_DisplayYUVOverlay(vp-&gt;bmp, &amp;rect);<font></font>
    SDL_UnlockMutex(screen_mutex);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºå±å¹•å¯ä»¥æ˜¯ä»»ä½•å¤§å°ï¼ˆæˆ‘ä»¬å®‰è£…äº†640x480ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å¯¹å…¶è¿›è¡Œé…ç½®ï¼Œä»¥ä¾¿ç”¨æˆ·è°ƒæ•´å¤§å°ï¼‰ï¼Œå› æ­¤æ‚¨éœ€è¦åŠ¨æ€ç¡®å®šå½±ç‰‡çš„çŸ©å½¢åŒºåŸŸåº”å¤šå¤§ã€‚å› æ­¤ï¼Œé¦–å…ˆæ‚¨éœ€è¦æ‰¾å‡ºæˆ‘ä»¬èƒ¶ç‰‡çš„é•¿å®½æ¯”ï¼Œåªæ˜¯å®½åº¦é™¤ä»¥é«˜åº¦ã€‚ä¸€äº›ç¼–è§£ç å™¨çš„æ ·æœ¬é•¿å®½æ¯”æ˜¯å¥‡æ•°ï¼Œå³ä¸€ä¸ªåƒç´ æˆ–æ ·æœ¬çš„å®½åº¦/é«˜åº¦ã€‚ç”±äºæˆ‘ä»¬ç¼–è§£ç å™¨ä¸Šä¸‹æ–‡ä¸­çš„é«˜åº¦å’Œå®½åº¦å€¼æ˜¯ä»¥åƒç´ ä¸ºå•ä½è¿›è¡Œæµ‹é‡çš„ï¼Œå› æ­¤å®é™…çš„å®½é«˜æ¯”ç­‰äºå®½é«˜æ¯”ä¹˜ä»¥æ ·æœ¬çš„å®½é«˜æ¯”ã€‚æŸäº›ç¼–è§£ç å™¨çš„é•¿å®½æ¯”ä¸º0ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªåƒç´ çš„å¤§å°ä»…ä¸º1x1ã€‚ç„¶åæˆ‘ä»¬ä»¥è¿™ç§æ–¹å¼ç¼©æ”¾ç”µå½±ä½¿å…¶å°½å¯èƒ½åœ°é€‚åˆå±å¹•ã€‚ä½åè½¬</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼†-3</font></font></b></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç®€å•åœ°å°†å€¼å››èˆäº”å…¥åˆ°æœ€æ¥è¿‘çš„å››å€æ•°ã€‚</font><font style="vertical-align: inherit;">ç„¶åå°†å½±ç‰‡å±…ä¸­ï¼Œå¹¶è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDL_DisplayYUVOverlay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰ä»¥ç¡®ä¿ä½¿ç”¨å±å¹•äº’æ–¥é”æ¥è®¿é—®å®ƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯å…¨éƒ¨å—ï¼Ÿ</font><font style="vertical-align: inherit;">æˆ‘ä»¬å®Œäº†å—ï¼Ÿ</font><font style="vertical-align: inherit;">æ‚¨ä»ç„¶éœ€è¦é‡å†™éŸ³é¢‘</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»£ç </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰èƒ½ä½¿ç”¨æ–°çš„</font><b><font style="vertical-align: inherit;"> VideoStruct</font></b><font style="vertical-align: inherit;">ï¼Œä½†æ˜¯è¿™äº›éƒ½æ˜¯å¾®ä¸è¶³é“çš„æ›´æ”¹ï¼Œå¯ä»¥åœ¨ç¤ºä¾‹ä»£ç ä¸­çœ‹åˆ°ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯æ›´æ”¹FFmpegä¸­å†…éƒ¨é€€å‡ºå›è°ƒå‡½æ•°çš„å›è°ƒï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">VideoState *global_video_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decode_interrupt_cb</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (global_video_state &amp;&amp; global_video_state-&gt;quit);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font><b><font style="vertical-align: inherit;">main</font></b><font style="vertical-align: inherit;">ï¼ˆï¼‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­å°†global_video_state</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
è®¾ç½®</font><font style="vertical-align: inherit;">ä¸ºè¾ƒå¤§çš„ç»“æ„</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">
å°±æ˜¯è¿™æ ·äº†ï¼</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç¼–è¯‘ï¼š</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial04 tutorial04.c -lavutil -lavformat -lavcodec -lswscale -lz -lm \<font></font>
`sdl-config --cflags --libs`</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¶æ¬£èµç”µå½±è€Œæ— éœ€åŒæ­¥ï¼</font><font style="vertical-align: inherit;">ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†æœ€ç»ˆåˆ›å»ºä¸€ä¸ª</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çœŸæ­£æœ‰æ•ˆçš„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§†é¢‘æ’­æ”¾å™¨ï¼</font></font><a name="video"></a><br>
<br>
<hr><hr><hr><hr><hr><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬5è¯¾ï¼šè§†é¢‘åŒæ­¥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬4è¯¾ï¼šå¤šçº¿ç¨‹"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â† </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="åˆ°ç›®å½•"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â‡‘ </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="ç¬¬5è¯¾ï¼šéŸ³é¢‘åŒæ­¥"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â†’</font></font></a></h2><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œæ•´åˆ—è¡¨tutorial05.c</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">// tutorial05.c</span>
<span class="hljs-comment">// A pedagogical video player that really works!</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Code based on FFplay, Copyright (c) 2003 Fabrice Bellard, </span>
<span class="hljs-comment">// and a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span>
<span class="hljs-comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span>
<span class="hljs-comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span>
<span class="hljs-comment">// Updates tested on:</span>
<span class="hljs-comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101, SDL 1.2.15</span>
<span class="hljs-comment">// on GCC 4.7.2 in Debian February 2015</span>
<span class="hljs-comment">// Use</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// gcc -o tutorial05 tutorial05.c -lavformat -lavcodec -lswscale -lz -lm `sdl-config --cflags --libs`</span>
<span class="hljs-comment">// to build (assuming libavformat and libavcodec are correctly installed, </span>
<span class="hljs-comment">// and assuming you have sdl-config. Please refer to SDL docs for your installation.)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Run using</span>
<span class="hljs-comment">// tutorial04 myvideofile.mpg</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// to play the video stream on your screen.</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libswscale/swscale.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SDL_thread.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __MINGW32__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> main <span class="hljs-comment">/* Prevents SDL from overriding main() */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;assert.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">// compatibility with newer API</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> av_frame_free avcodec_free_frame</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_AUDIOQ_SIZE (5 * 16 * 1024)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_VIDEOQ_SIZE (5 * 256 * 1024)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AV_SYNC_THRESHOLD 0.01</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AV_NOSYNC_THRESHOLD 10.0</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FF_REFRESH_EVENT (SDL_USEREVENT)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FF_QUIT_EVENT (SDL_USEREVENT + 1)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> VIDEO_PICTURE_QUEUE_SIZE 1</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PacketQueue</span> {</span><font></font>
  AVPacketList *first_pkt, *last_pkt;<font></font>
  <span class="hljs-keyword">int</span> nb_packets;
  <span class="hljs-keyword">int</span> size;<font></font>
  SDL_mutex *mutex;<font></font>
  SDL_cond *cond;<font></font>
} PacketQueue;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoPicture</span> {</span><font></font>
  SDL_Overlay *bmp;<font></font>
  <span class="hljs-keyword">int</span> width, height; <span class="hljs-comment">/* source height &amp; width */</span>
  <span class="hljs-keyword">int</span> allocated;
  <span class="hljs-keyword">double</span> pts;<font></font>
} VideoPicture;<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoState</span> {</span><font></font>
<font></font>
  AVFormatContext *pFormatCtx;<font></font>
  <span class="hljs-keyword">int</span>             videoStream, audioStream;<font></font>
<font></font>
  <span class="hljs-keyword">double</span>          audio_clock;<font></font>
  AVStream        *audio_st;<font></font>
  AVCodecContext  *audio_ctx;<font></font>
  PacketQueue     audioq;<font></font>
  <span class="hljs-keyword">uint8_t</span>         audio_buf[(AVCODEC_MAX_AUDIO_FRAME_SIZE * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>];
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_size;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>    audio_buf_index;<font></font>
  AVFrame         audio_frame;<font></font>
  AVPacket        audio_pkt;<font></font>
  <span class="hljs-keyword">uint8_t</span>         *audio_pkt_data;
  <span class="hljs-keyword">int</span>             audio_pkt_size;
  <span class="hljs-keyword">int</span>             audio_hw_buf_size;  
  <span class="hljs-keyword">double</span>          frame_timer;
  <span class="hljs-keyword">double</span>          frame_last_pts;
  <span class="hljs-keyword">double</span>          frame_last_delay;
  <span class="hljs-keyword">double</span>          video_clock; <span class="hljs-comment">///&lt;pts of last decoded frame / predicted pts of next decoded frame</span><font></font>
  AVStream        *video_st;<font></font>
  AVCodecContext  *video_ctx;<font></font>
  PacketQueue     videoq;<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SwsContext</span> *<span class="hljs-title">sws_ctx</span>;</span><font></font>
<font></font>
  VideoPicture    pictq[VIDEO_PICTURE_QUEUE_SIZE];<font></font>
  <span class="hljs-keyword">int</span>             pictq_size, pictq_rindex, pictq_windex;<font></font>
  SDL_mutex       *pictq_mutex;<font></font>
  SDL_cond        *pictq_cond;<font></font>
  <font></font>
  SDL_Thread      *parse_tid;<font></font>
  SDL_Thread      *video_tid;<font></font>
<font></font>
  <span class="hljs-keyword">char</span>            filename[<span class="hljs-number">1024</span>];
  <span class="hljs-keyword">int</span>             quit;<font></font>
} VideoState;<font></font>
<font></font>
SDL_Surface     *screen;<font></font>
SDL_mutex       *screen_mutex;<font></font>
<font></font>
<span class="hljs-comment">/* Since we only have one decoding thread, the Big Struct
   can be global in case we need it. */</span><font></font>
VideoState *global_video_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packet_queue_init</span><span class="hljs-params">(PacketQueue *q)</span> </span>{
  <span class="hljs-built_in">memset</span>(q, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(PacketQueue));<font></font>
  q-&gt;mutex = SDL_CreateMutex();<font></font>
  q-&gt;cond = SDL_CreateCond();<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_put</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt)</span> </span>{<font></font>
<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">if</span>(av_dup_packet(pkt) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  pkt1 = av_malloc(<span class="hljs-keyword">sizeof</span>(AVPacketList));
  <span class="hljs-keyword">if</span> (!pkt1)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  pkt1-&gt;pkt = *pkt;<font></font>
  pkt1-&gt;next = <span class="hljs-literal">NULL</span>;<font></font>
  <font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!q-&gt;last_pkt)<font></font>
    q-&gt;first_pkt = pkt1;<font></font>
  <span class="hljs-keyword">else</span><font></font>
    q-&gt;last_pkt-&gt;next = pkt1;<font></font>
  q-&gt;last_pkt = pkt1;<font></font>
  q-&gt;nb_packets++;<font></font>
  q-&gt;size += pkt1-&gt;pkt.size;<font></font>
  SDL_CondSignal(q-&gt;cond);<font></font>
  <font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">packet_queue_get</span><span class="hljs-params">(PacketQueue *q, AVPacket *pkt, <span class="hljs-keyword">int</span> block)</span>
</span>{<font></font>
  AVPacketList *pkt1;<font></font>
  <span class="hljs-keyword">int</span> ret;<font></font>
<font></font>
  SDL_LockMutex(q-&gt;mutex);<font></font>
  <font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(global_video_state-&gt;quit) {<font></font>
      ret = <span class="hljs-number">-1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    pkt1 = q-&gt;first_pkt;<font></font>
    <span class="hljs-keyword">if</span> (pkt1) {<font></font>
      q-&gt;first_pkt = pkt1-&gt;next;<font></font>
      <span class="hljs-keyword">if</span> (!q-&gt;first_pkt)<font></font>
	q-&gt;last_pkt = <span class="hljs-literal">NULL</span>;<font></font>
      q-&gt;nb_packets--;<font></font>
      q-&gt;size -= pkt1-&gt;pkt.size;<font></font>
      *pkt = pkt1-&gt;pkt;<font></font>
      av_free(pkt1);<font></font>
      ret = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!block) {<font></font>
      ret = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      SDL_CondWait(q-&gt;cond, q-&gt;mutex);<font></font>
    }<font></font>
  }<font></font>
  SDL_UnlockMutex(q-&gt;mutex);<font></font>
  <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">get_audio_clock</span><span class="hljs-params">(VideoState *is)</span> </span>{
  <span class="hljs-keyword">double</span> pts;
  <span class="hljs-keyword">int</span> hw_buf_size, bytes_per_sec, n;<font></font>
  <font></font>
  pts = is-&gt;audio_clock; <span class="hljs-comment">/* maintained in the audio thread */</span><font></font>
  hw_buf_size = is-&gt;audio_buf_size - is-&gt;audio_buf_index;<font></font>
  bytes_per_sec = <span class="hljs-number">0</span>;<font></font>
  n = is-&gt;audio_ctx-&gt;channels * <span class="hljs-number">2</span>;
  <span class="hljs-keyword">if</span>(is-&gt;audio_st) {<font></font>
    bytes_per_sec = is-&gt;audio_ctx-&gt;sample_rate * n;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(bytes_per_sec) {<font></font>
    pts -= (<span class="hljs-keyword">double</span>)hw_buf_size / bytes_per_sec;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> pts;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">audio_decode_frame</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">uint8_t</span> *audio_buf, <span class="hljs-keyword">int</span> buf_size, <span class="hljs-keyword">double</span> *pts_ptr)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">int</span> len1, data_size = <span class="hljs-number">0</span>;<font></font>
  AVPacket *pkt = &amp;is-&gt;audio_pkt;<font></font>
  <span class="hljs-keyword">double</span> pts;
  <span class="hljs-keyword">int</span> n;<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">while</span>(is-&gt;audio_pkt_size &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">int</span> got_frame = <span class="hljs-number">0</span>;<font></font>
      len1 = avcodec_decode_audio4(is-&gt;audio_ctx, &amp;is-&gt;audio_frame, &amp;got_frame, pkt);<font></font>
      <span class="hljs-keyword">if</span>(len1 &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* if error, skip frame */</span>
	is-&gt;audio_pkt_size = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      data_size = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span>(got_frame) {<font></font>
	data_size = av_samples_get_buffer_size(<span class="hljs-literal">NULL</span>, <font></font>
					       is-&gt;audio_ctx-&gt;channels,<font></font>
					       is-&gt;audio_frame.nb_samples,<font></font>
					       is-&gt;audio_ctx-&gt;sample_fmt,<font></font>
					       <span class="hljs-number">1</span>);<font></font>
	assert(data_size &lt;= buf_size);<font></font>
	<span class="hljs-built_in">memcpy</span>(audio_buf, is-&gt;audio_frame.data[<span class="hljs-number">0</span>], data_size);<font></font>
      }<font></font>
      is-&gt;audio_pkt_data += len1;<font></font>
      is-&gt;audio_pkt_size -= len1;<font></font>
      <span class="hljs-keyword">if</span>(data_size &lt;= <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* No data yet, get more frames */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      }<font></font>
      pts = is-&gt;audio_clock;<font></font>
      *pts_ptr = pts;<font></font>
      n = <span class="hljs-number">2</span> * is-&gt;audio_ctx-&gt;channels;<font></font>
      is-&gt;audio_clock += (<span class="hljs-keyword">double</span>)data_size /<font></font>
	(<span class="hljs-keyword">double</span>)(n * is-&gt;audio_ctx-&gt;sample_rate);
      <span class="hljs-comment">/* We have data, return it and come back for more later */</span>
      <span class="hljs-keyword">return</span> data_size;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pkt-&gt;data)<font></font>
      av_free_packet(pkt);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">/* next packet */</span>
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;audioq, pkt, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    is-&gt;audio_pkt_data = pkt-&gt;data;<font></font>
    is-&gt;audio_pkt_size = pkt-&gt;size;<font></font>
    <span class="hljs-comment">/* if update, update the audio clock w/pts */</span>
    <span class="hljs-keyword">if</span>(pkt-&gt;pts != AV_NOPTS_VALUE) {<font></font>
      is-&gt;audio_clock = av_q2d(is-&gt;audio_st-&gt;time_base)*pkt-&gt;pts;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">audio_callback</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata, Uint8 *stream, <span class="hljs-keyword">int</span> len)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  <span class="hljs-keyword">int</span> len1, audio_size;
  <span class="hljs-keyword">double</span> pts;<font></font>
<font></font>
  <span class="hljs-keyword">while</span>(len &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span>(is-&gt;audio_buf_index &gt;= is-&gt;audio_buf_size) {
      <span class="hljs-comment">/* We have already sent all our data; get more */</span>
      audio_size = audio_decode_frame(is, is-&gt;audio_buf, <span class="hljs-keyword">sizeof</span>(is-&gt;audio_buf), &amp;pts);
      <span class="hljs-keyword">if</span>(audio_size &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-comment">/* If error, output silence */</span>
	is-&gt;audio_buf_size = <span class="hljs-number">1024</span>;
	<span class="hljs-built_in">memset</span>(is-&gt;audio_buf, <span class="hljs-number">0</span>, is-&gt;audio_buf_size);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
	is-&gt;audio_buf_size = audio_size;<font></font>
      }<font></font>
      is-&gt;audio_buf_index = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    len1 = is-&gt;audio_buf_size - is-&gt;audio_buf_index;<font></font>
    <span class="hljs-keyword">if</span>(len1 &gt; len)<font></font>
      len1 = len;<font></font>
    <span class="hljs-built_in">memcpy</span>(stream, (<span class="hljs-keyword">uint8_t</span> *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);<font></font>
    len -= len1;<font></font>
    stream += len1;<font></font>
    is-&gt;audio_buf_index += len1;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> Uint32 <span class="hljs-title">sdl_refresh_timer_cb</span><span class="hljs-params">(Uint32 interval, <span class="hljs-keyword">void</span> *opaque)</span> </span>{<font></font>
  SDL_Event event;<font></font>
  event.type = FF_REFRESH_EVENT;<font></font>
  event.user.data1 = opaque;<font></font>
  SDL_PushEvent(&amp;event);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* 0 means stop timer */</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/* schedule a video refresh in 'delay' ms */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">schedule_refresh</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> delay)</span> </span>{<font></font>
  SDL_AddTimer(delay, sdl_refresh_timer_cb, is);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_display</span><span class="hljs-params">(VideoState *is)</span> </span>{<font></font>
<font></font>
  SDL_Rect rect;<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">float</span> aspect_ratio;
  <span class="hljs-keyword">int</span> w, h, x, y;
  <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-keyword">if</span>(is-&gt;video_ctx-&gt;sample_aspect_ratio.num == <span class="hljs-number">0</span>) {<font></font>
      aspect_ratio = <span class="hljs-number">0</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      aspect_ratio = av_q2d(is-&gt;video_ctx-&gt;sample_aspect_ratio) *<font></font>
	is-&gt;video_ctx-&gt;width / is-&gt;video_ctx-&gt;height;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(aspect_ratio &lt;= <span class="hljs-number">0.0</span>) {<font></font>
      aspect_ratio = (<span class="hljs-keyword">float</span>)is-&gt;video_ctx-&gt;width /<font></font>
	(<span class="hljs-keyword">float</span>)is-&gt;video_ctx-&gt;height;<font></font>
    }<font></font>
    h = screen-&gt;h;<font></font>
    w = ((<span class="hljs-keyword">int</span>)rint(h * aspect_ratio)) &amp; <span class="hljs-number">-3</span>;
    <span class="hljs-keyword">if</span>(w &gt; screen-&gt;w) {<font></font>
      w = screen-&gt;w;<font></font>
      h = ((<span class="hljs-keyword">int</span>)rint(w / aspect_ratio)) &amp; <span class="hljs-number">-3</span>;<font></font>
    }<font></font>
    x = (screen-&gt;w - w) / <span class="hljs-number">2</span>;<font></font>
    y = (screen-&gt;h - h) / <span class="hljs-number">2</span>;<font></font>
    <font></font>
    rect.x = x;<font></font>
    rect.y = y;<font></font>
    rect.w = w;<font></font>
    rect.h = h;<font></font>
    SDL_LockMutex(screen_mutex);<font></font>
    SDL_DisplayYUVOverlay(vp-&gt;bmp, &amp;rect);<font></font>
    SDL_UnlockMutex(screen_mutex);<font></font>
<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_refresh_timer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">double</span> actual_delay, delay, sync_threshold, ref_clock, diff;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(is-&gt;video_st) {
    <span class="hljs-keyword">if</span>(is-&gt;pictq_size == <span class="hljs-number">0</span>) {<font></font>
      schedule_refresh(is, <span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
<font></font>
      delay = vp-&gt;pts - is-&gt;frame_last_pts; <span class="hljs-comment">/* the pts from last time */</span>
      <span class="hljs-keyword">if</span>(delay &lt;= <span class="hljs-number">0</span> || delay &gt;= <span class="hljs-number">1.0</span>) {
	<span class="hljs-comment">/* if incorrect delay, use previous one */</span><font></font>
	delay = is-&gt;frame_last_delay;<font></font>
      }<font></font>
      <span class="hljs-comment">/* save for next time */</span><font></font>
      is-&gt;frame_last_delay = delay;<font></font>
      is-&gt;frame_last_pts = vp-&gt;pts;<font></font>
<font></font>
      <span class="hljs-comment">/* update delay to sync to audio */</span><font></font>
      ref_clock = get_audio_clock(is);<font></font>
      diff = vp-&gt;pts - ref_clock;<font></font>
<font></font>
      <span class="hljs-comment">/* Skip or repeat the frame. Take delay into account
	 FFPlay still doesn't "know if this is the best guess." */</span><font></font>
      sync_threshold = (delay &gt; AV_SYNC_THRESHOLD) ? delay : AV_SYNC_THRESHOLD;<font></font>
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD) {
	<span class="hljs-keyword">if</span>(diff &lt;= -sync_threshold) {<font></font>
	  delay = <span class="hljs-number">0</span>;<font></font>
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(diff &gt;= sync_threshold) {<font></font>
	  delay = <span class="hljs-number">2</span> * delay;<font></font>
	}<font></font>
      }<font></font>
      is-&gt;frame_timer += delay;<font></font>
      <span class="hljs-comment">/* computer the REAL delay */</span>
      actual_delay = is-&gt;frame_timer - (av_gettime() / <span class="hljs-number">1000000.0</span>);
      <span class="hljs-keyword">if</span>(actual_delay &lt; <span class="hljs-number">0.010</span>) {
	<span class="hljs-comment">/* Really it should skip the picture instead */</span>
	actual_delay = <span class="hljs-number">0.010</span>;<font></font>
      }<font></font>
      schedule_refresh(is, (<span class="hljs-keyword">int</span>)(actual_delay * <span class="hljs-number">1000</span> + <span class="hljs-number">0.5</span>));<font></font>
      <font></font>
      <span class="hljs-comment">/* show the picture! */</span><font></font>
      video_display(is);<font></font>
      <font></font>
      <span class="hljs-comment">/* update queue for next picture! */</span>
      <span class="hljs-keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
	is-&gt;pictq_rindex = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
      SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
      is-&gt;pictq_size--;<font></font>
      SDL_CondSignal(is-&gt;pictq_cond);<font></font>
      SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    schedule_refresh(is, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}<font></font>
      <font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">alloc_picture</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
<font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {
    <span class="hljs-comment">// we already have one make another, bigger/smaller</span><font></font>
    SDL_FreeYUVOverlay(vp-&gt;bmp);<font></font>
  }<font></font>
  <span class="hljs-comment">// Allocate a place to put our YUV image on that screen</span><font></font>
  SDL_LockMutex(screen_mutex);<font></font>
  vp-&gt;bmp = SDL_CreateYUVOverlay(is-&gt;video_ctx-&gt;width,<font></font>
				 is-&gt;video_ctx-&gt;height,<font></font>
				 SDL_YV12_OVERLAY,<font></font>
				 screen);<font></font>
  SDL_UnlockMutex(screen_mutex);<font></font>
<font></font>
  vp-&gt;width = is-&gt;video_ctx-&gt;width;<font></font>
  vp-&gt;height = is-&gt;video_ctx-&gt;height;<font></font>
  vp-&gt;allocated = <span class="hljs-number">1</span>;<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">queue_picture</span><span class="hljs-params">(VideoState *is, AVFrame *pFrame, <span class="hljs-keyword">double</span> pts)</span> </span>{<font></font>
<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">int</span> dst_pix_fmt;<font></font>
  AVPicture pict;<font></font>
<font></font>
  <span class="hljs-comment">/* wait until we have space for a new pic */</span><font></font>
  SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
  <span class="hljs-keyword">while</span>(is-&gt;pictq_size &gt;= VIDEO_PICTURE_QUEUE_SIZE &amp;&amp;<font></font>
	!is-&gt;quit) {<font></font>
    SDL_CondWait(is-&gt;pictq_cond, is-&gt;pictq_mutex);<font></font>
  }<font></font>
  SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is-&gt;quit)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">// windex is set to 0 initially</span><font></font>
  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];<font></font>
<font></font>
  <span class="hljs-comment">/* allocate or resize the buffer! */</span>
  <span class="hljs-keyword">if</span>(!vp-&gt;bmp ||<font></font>
     vp-&gt;width != is-&gt;video_ctx-&gt;width ||<font></font>
     vp-&gt;height != is-&gt;video_ctx-&gt;height) {<font></font>
    SDL_Event event;<font></font>
<font></font>
    vp-&gt;allocated = <span class="hljs-number">0</span>;<font></font>
    alloc_picture(is);<font></font>
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/* We have a place to put our picture on the queue */</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {<font></font>
<font></font>
    SDL_LockYUVOverlay(vp-&gt;bmp);<font></font>
    vp-&gt;pts = pts;<font></font>
    <font></font>
    dst_pix_fmt = PIX_FMT_YUV420P;<font></font>
    <span class="hljs-comment">/* point pict at the queue */</span><font></font>
<font></font>
    pict.data[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">0</span>];<font></font>
    pict.data[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">2</span>];<font></font>
    pict.data[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pixels[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    pict.linesize[<span class="hljs-number">0</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">0</span>];<font></font>
    pict.linesize[<span class="hljs-number">1</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">2</span>];<font></font>
    pict.linesize[<span class="hljs-number">2</span>] = vp-&gt;bmp-&gt;pitches[<span class="hljs-number">1</span>];<font></font>
    <font></font>
    <span class="hljs-comment">// Convert the image into YUV format that SDL uses</span>
    sws_scale(is-&gt;sws_ctx, (<span class="hljs-keyword">uint8_t</span> <span class="hljs-keyword">const</span> * <span class="hljs-keyword">const</span> *)pFrame-&gt;data,<font></font>
	      pFrame-&gt;linesize, <span class="hljs-number">0</span>, is-&gt;video_ctx-&gt;height,<font></font>
	      pict.data, pict.linesize);<font></font>
    <font></font>
    SDL_UnlockYUVOverlay(vp-&gt;bmp);<font></font>
    <span class="hljs-comment">/* now we inform our display thread that we have a pic ready */</span>
    <span class="hljs-keyword">if</span>(++is-&gt;pictq_windex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
      is-&gt;pictq_windex = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
    is-&gt;pictq_size++;<font></font>
    SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">synchronize_video</span><span class="hljs-params">(VideoState *is, AVFrame *src_frame, <span class="hljs-keyword">double</span> pts)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">double</span> frame_delay;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(pts != <span class="hljs-number">0</span>) {
    <span class="hljs-comment">/* if we have pts, set video clock to it */</span><font></font>
    is-&gt;video_clock = pts;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">/* if we aren't given a pts, set it to the clock */</span><font></font>
    pts = is-&gt;video_clock;<font></font>
  }<font></font>
  <span class="hljs-comment">/* update the video clock */</span><font></font>
  frame_delay = av_q2d(is-&gt;video_ctx-&gt;time_base);<font></font>
  <span class="hljs-comment">/* if we are repeating a frame, adjust clock accordingly */</span>
  frame_delay += src_frame-&gt;repeat_pict * (frame_delay * <span class="hljs-number">0.5</span>);<font></font>
  is-&gt;video_clock += frame_delay;<font></font>
  <span class="hljs-keyword">return</span> pts;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">video_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{<font></font>
  VideoState *is = (VideoState *)arg;<font></font>
  AVPacket pkt1, *packet = &amp;pkt1;<font></font>
  <span class="hljs-keyword">int</span> frameFinished;<font></font>
  AVFrame *pFrame;<font></font>
  <span class="hljs-keyword">double</span> pts;<font></font>
<font></font>
  pFrame = av_frame_alloc();<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// means we quit getting packets</span>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// means we quit getting packets</span>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    pts = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">// Decode video frame</span><font></font>
    avcodec_decode_video2(is-&gt;video_ctx, pFrame, &amp;frameFinished, packet);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>((pts = av_frame_get_best_effort_timestamp(pFrame)) == AV_NOPTS_VALUE) {<font></font>
      pts = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    pts *= av_q2d(is-&gt;video_st-&gt;time_base);<font></font>
<font></font>
    <span class="hljs-comment">// Did we get a video frame?</span>
    <span class="hljs-keyword">if</span>(frameFinished) {<font></font>
      pts = synchronize_video(is, pFrame, pts);<font></font>
      <span class="hljs-keyword">if</span>(queue_picture(is, pFrame, pts) &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
    av_free_packet(packet);<font></font>
  }<font></font>
  av_frame_free(&amp;pFrame);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">stream_component_open</span><span class="hljs-params">(VideoState *is, <span class="hljs-keyword">int</span> stream_index)</span> </span>{<font></font>
<font></font>
  AVFormatContext *pFormatCtx = is-&gt;pFormatCtx;<font></font>
  AVCodecContext *codecCtx = <span class="hljs-literal">NULL</span>;<font></font>
  AVCodec *codec = <span class="hljs-literal">NULL</span>;<font></font>
  SDL_AudioSpec wanted_spec, spec;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(stream_index &lt; <span class="hljs-number">0</span> || stream_index &gt;= pFormatCtx-&gt;nb_streams) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codec = avcodec_find_decoder(pFormatCtx-&gt;streams[stream_index]-&gt;codec-&gt;codec_id);<font></font>
  <span class="hljs-keyword">if</span>(!codec) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  codecCtx = avcodec_alloc_context3(codec);<font></font>
  <span class="hljs-keyword">if</span>(avcodec_copy_context(codecCtx, pFormatCtx-&gt;streams[stream_index]-&gt;codec) != <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Couldn't copy codec context"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Error copying codec context</span><font></font>
  }<font></font>
<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(codecCtx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
    <span class="hljs-comment">// Set audio settings from codec info</span><font></font>
    wanted_spec.freq = codecCtx-&gt;sample_rate;<font></font>
    wanted_spec.format = AUDIO_S16SYS;<font></font>
    wanted_spec.channels = codecCtx-&gt;channels;<font></font>
    wanted_spec.silence = <span class="hljs-number">0</span>;<font></font>
    wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;<font></font>
    wanted_spec.callback = audio_callback;<font></font>
    wanted_spec.userdata = is;<font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    is-&gt;audio_hw_buf_size = spec.size;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(avcodec_open2(codecCtx, codec, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Unsupported codec!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">switch</span>(codecCtx-&gt;codec_type) {
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_AUDIO:<font></font>
    is-&gt;audioStream = stream_index;<font></font>
    is-&gt;audio_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;audio_ctx = codecCtx;<font></font>
    is-&gt;audio_buf_size = <span class="hljs-number">0</span>;<font></font>
    is-&gt;audio_buf_index = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">memset</span>(&amp;is-&gt;audio_pkt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(is-&gt;audio_pkt));<font></font>
    packet_queue_init(&amp;is-&gt;audioq);<font></font>
    SDL_PauseAudio(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> AVMEDIA_TYPE_VIDEO:<font></font>
    is-&gt;videoStream = stream_index;<font></font>
    is-&gt;video_st = pFormatCtx-&gt;streams[stream_index];<font></font>
    is-&gt;video_ctx = codecCtx;<font></font>
<font></font>
    is-&gt;frame_timer = (<span class="hljs-keyword">double</span>)av_gettime() / <span class="hljs-number">1000000.0</span>;<font></font>
    is-&gt;frame_last_delay = <span class="hljs-number">40e-3</span>;<font></font>
    <font></font>
    packet_queue_init(&amp;is-&gt;videoq);<font></font>
    is-&gt;video_tid = SDL_CreateThread(video_thread, is);<font></font>
    is-&gt;sws_ctx = sws_getContext(is-&gt;video_ctx-&gt;width, is-&gt;video_ctx-&gt;height,<font></font>
				 is-&gt;video_ctx-&gt;pix_fmt, is-&gt;video_ctx-&gt;width,<font></font>
				 is-&gt;video_ctx-&gt;height, PIX_FMT_YUV420P,<font></font>
				 SWS_BILINEAR, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span><font></font>
				 );<font></font>
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decode_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)arg;<font></font>
  AVFormatContext *pFormatCtx;<font></font>
  AVPacket pkt1, *packet = &amp;pkt1;<font></font>
<font></font>
  <span class="hljs-keyword">int</span> video_index = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> audio_index = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
  is-&gt;videoStream=<span class="hljs-number">-1</span>;<font></font>
  is-&gt;audioStream=<span class="hljs-number">-1</span>;<font></font>
<font></font>
  global_video_state = is;<font></font>
<font></font>
  <span class="hljs-comment">// Open video file</span>
  <span class="hljs-keyword">if</span>(avformat_open_input(&amp;pFormatCtx, is-&gt;filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)!=<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't open file</span><font></font>
<font></font>
  is-&gt;pFormatCtx = pFormatCtx;<font></font>
  <font></font>
  <span class="hljs-comment">// Retrieve stream information</span>
  <span class="hljs-keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="hljs-literal">NULL</span>)&lt;<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// Couldn't find stream information</span><font></font>
  <font></font>
  <span class="hljs-comment">// Dump information about file onto standard error</span>
  av_dump_format(pFormatCtx, <span class="hljs-number">0</span>, is-&gt;filename, <span class="hljs-number">0</span>);<font></font>
  <font></font>
  <span class="hljs-comment">// Find the first video stream</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) {
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
       video_index &lt; <span class="hljs-number">0</span>) {<font></font>
      video_index=i;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
       audio_index &lt; <span class="hljs-number">0</span>) {<font></font>
      audio_index=i;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(audio_index &gt;= <span class="hljs-number">0</span>) {<font></font>
    stream_component_open(is, audio_index);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(video_index &gt;= <span class="hljs-number">0</span>) {<font></font>
    stream_component_open(is, video_index);<font></font>
  }   <font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is-&gt;videoStream &lt; <span class="hljs-number">0</span> || is-&gt;audioStream &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%s: could not open codecs\n"</span>, is-&gt;filename);
    <span class="hljs-keyword">goto</span> fail;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// main decode loop</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(is-&gt;quit) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    <span class="hljs-comment">// seek stuff goes here</span>
    <span class="hljs-keyword">if</span>(is-&gt;audioq.size &gt; MAX_AUDIOQ_SIZE ||<font></font>
       is-&gt;videoq.size &gt; MAX_VIDEOQ_SIZE) {<font></font>
      SDL_Delay(<span class="hljs-number">10</span>);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(av_read_frame(is-&gt;pFormatCtx, packet) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span>(is-&gt;pFormatCtx-&gt;pb-&gt;error == <span class="hljs-number">0</span>) {<font></font>
	SDL_Delay(<span class="hljs-number">100</span>); <span class="hljs-comment">/* no error; wait for user input */</span>
	<span class="hljs-keyword">continue</span>;<font></font>
      } <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-comment">// Is this a packet from the video stream?</span>
    <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;videoStream) {<font></font>
      packet_queue_put(&amp;is-&gt;videoq, packet);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(packet-&gt;stream_index == is-&gt;audioStream) {<font></font>
      packet_queue_put(&amp;is-&gt;audioq, packet);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      av_free_packet(packet);<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">/* all done - wait for it */</span>
  <span class="hljs-keyword">while</span>(!is-&gt;quit) {<font></font>
    SDL_Delay(<span class="hljs-number">100</span>);<font></font>
  }<font></font>
<font></font>
 fail:<font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-number">1</span>){<font></font>
    SDL_Event event;<font></font>
    event.type = FF_QUIT_EVENT;<font></font>
    event.user.data1 = is;<font></font>
    SDL_PushEvent(&amp;event);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{<font></font>
<font></font>
  SDL_Event       event;<font></font>
<font></font>
  VideoState      *is;<font></font>
<font></font>
  is = av_mallocz(<span class="hljs-keyword">sizeof</span>(VideoState));<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(argc &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Usage: test &lt;file&gt;\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-comment">// Register all formats and codecs</span><font></font>
  av_register_all();<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Make a screen to put our video</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> __DARWIN__</span>
        screen = SDL_SetVideoMode(<span class="hljs-number">640</span>, <span class="hljs-number">480</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        screen = SDL_SetVideoMode(<span class="hljs-number">640</span>, <span class="hljs-number">480</span>, <span class="hljs-number">24</span>, <span class="hljs-number">0</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-keyword">if</span>(!screen) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"SDL: could not set video mode - exiting\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
<font></font>
  screen_mutex = SDL_CreateMutex();<font></font>
<font></font>
  av_strlcpy(is-&gt;filename, argv[<span class="hljs-number">1</span>], <span class="hljs-keyword">sizeof</span>(is-&gt;filename));<font></font>
<font></font>
  is-&gt;pictq_mutex = SDL_CreateMutex();<font></font>
  is-&gt;pictq_cond = SDL_CreateCond();<font></font>
<font></font>
  schedule_refresh(is, <span class="hljs-number">40</span>);<font></font>
<font></font>
  is-&gt;parse_tid = SDL_CreateThread(decode_thread, is);<font></font>
  <span class="hljs-keyword">if</span>(!is-&gt;parse_tid) {<font></font>
    av_free(is);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">for</span>(;;) {<font></font>
<font></font>
    SDL_WaitEvent(&amp;event);<font></font>
    <span class="hljs-keyword">switch</span>(event.type) {
    <span class="hljs-keyword">case</span> FF_QUIT_EVENT:
    <span class="hljs-keyword">case</span> SDL_QUIT:<font></font>
      is-&gt;quit = <span class="hljs-number">1</span>;<font></font>
      SDL_Quit();<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> FF_REFRESH_EVENT:<font></font>
      video_refresh_timer(event.user.data1);<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
<font></font>
}<font></font>
</code></pre></div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è­¦å‘Š</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æˆ‘åˆšåˆšç¼–å†™æœ¬æŒ‡å—æ—¶ï¼Œæˆ‘æ‰€æœ‰çš„åŒæ­¥ä»£ç éƒ½æ¥è‡ªå½“æ—¶çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffplay.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç‰ˆæœ¬</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä»Šå¤©ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œå…¨ä¸åŒçš„ç¨‹åºï¼ŒFFmpegåº“ï¼ˆå’Œffplay.cæœ¬èº«ï¼‰ä¸­çš„æ›´æ–°å·²å¯¼è‡´æ ¹æœ¬æ€§çš„å˜åŒ–ã€‚</font><font style="vertical-align: inherit;">å°½ç®¡æ­¤ä»£ç ä»ç„¶æœ‰æ•ˆï¼Œä½†å®ƒå·²ç»è¿‡æ—¶ï¼Œå¹¶ä¸”æœ¬æŒ‡å—ä¸­å¯ä»¥ä½¿ç”¨è®¸å¤šå…¶ä»–æ”¹è¿›ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§†é¢‘å¦‚ä½•åŒæ­¥</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å‡ ä¹æ²¡æœ‰ç”¨è¿‡çš„ç”µå½±æ’­æ”¾å™¨â€‹â€‹ã€‚</font><font style="vertical-align: inherit;">æ˜¯çš„ï¼Œå®ƒæ’­æ”¾è§†é¢‘ï¼Œæ˜¯çš„ï¼Œå®ƒæ’­æ”¾éŸ³é¢‘ï¼Œä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”µå½±ã€‚</font><font style="vertical-align: inherit;">é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTSå’ŒDTS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¸è¿çš„æ˜¯ï¼ŒéŸ³é¢‘å’Œè§†é¢‘æµåŒ…å«æœ‰å…³æ’­æ”¾é€Ÿåº¦å’Œæ—¶é—´çš„ä¿¡æ¯ã€‚éŸ³é¢‘æµå…·æœ‰é‡‡æ ·ç‡ï¼Œè§†é¢‘æµå…·æœ‰æ¯ç§’çš„å¸§æ•°ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»…é€šè¿‡è®¡æ•°å¸§æ•°å¹¶ä¹˜ä»¥å¸§é€Ÿç‡æ¥åŒæ­¥è§†é¢‘ï¼Œåˆ™å¾ˆæœ‰å¯èƒ½å®ƒä¸å£°éŸ³ä¸åŒæ­¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†èµ°å¦ä¸€æ¡è·¯ã€‚ä»æµåˆ†ç»„å¯ä»¥å…·æœ‰æ‰€è°“çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£ç æ—¶é—´</font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">æˆ³è®°</font></i><font style="vertical-align: inherit;">ï¼ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ä»</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ecoding </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IME </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°å·</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤¯å®</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¾ç¤ºæ—¶é—´</font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">æˆ³è®°</font></i><font style="vertical-align: inherit;">ï¼ˆ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ä»</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resentation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IME </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°å·</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤¯å®</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚è¦äº†è§£è¿™ä¸¤ç§å«ä¹‰ï¼Œæ‚¨éœ€è¦äº†è§£ç”µå½±çš„å­˜å‚¨æ–¹å¼ã€‚æŸäº›æ ¼å¼ï¼ˆä¾‹å¦‚MPEGï¼‰ä½¿ç”¨å®ƒä»¬ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bå¸§çš„</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ¼å¼</font><font style="vertical-align: inherit;">ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bedï¼Œå¹¶ä¸”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯åŒå‘çš„ï¼Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Englandã€‚Bidirectional</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚å…¶ä»–ä¸¤ç§ç±»å‹çš„å¸§è¢«ç§°ä¸º</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iå¸§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">På¸§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å†…éƒ¨</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nner</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå’Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰‹æ®µ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¢„æµ‹çš„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redicted</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iå¸§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ…å«å®Œæ•´å›¾åƒã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pæ¡†</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å–å†³äºå…ˆå‰çš„Iå¸§å’ŒPå¸§ï¼Œå¹¶ä¸”ä¸å…ˆå‰çš„å¸§ä¸åŒï¼Œæˆ–è€…æ‚¨ä¹Ÿå¯ä»¥å‘½å-å¢é‡ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bå¸§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸P </font><b><font style="vertical-align: inherit;">å¸§</font></b><font style="vertical-align: inherit;">ç›¸ä¼¼ï¼Œä½†æ˜¯å–å†³äºå…ˆå‰å’Œåç»­å¸§ä¸­åŒ…å«çš„ä¿¡æ¯ï¼ä¸€ä¸ªå¸§å¯èƒ½ä¸åŒ…å«å›¾åƒæœ¬èº«ï¼Œè€Œæ˜¯ä¸å…¶ä»–å¸§ä¸åŒçš„äº‹å®-è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨è°ƒç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_video2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹‹åæˆ‘ä»¬å¯èƒ½æ²¡æœ‰å®Œæ•´çš„å¸§</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‡è®¾æˆ‘ä»¬æœ‰ä¸€éƒ¨ç”µå½±ï¼Œå…¶ä¸­æŒ‰ä»¥ä¸‹é¡ºåºæ’­æ”¾4å¸§ï¼š</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IBBP</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä»æœ€åä¸€ä¸ªPå¸§ä¸­æ‰¾å‡ºä¿¡æ¯ï¼Œç„¶åæ‰èƒ½æ˜¾ç¤ºä¹‹å‰ä¸¤ä¸ªBå¸§ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚å› æ­¤ï¼Œå¯ä»¥æŒ‰ç…§ä¸å®é™…æ˜¾ç¤ºé¡ºåºä¸åŒ¹é…çš„é¡ºåºå­˜å‚¨å¸§ï¼š</font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPBB</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚è¿™å°±æ˜¯æ¯ä¸ªå¸§çš„è§£ç æ—¶é—´æˆ³å’Œæ¼”ç¤ºæ—¶é—´æˆ³ã€‚è§£ç æ—¶é—´æˆ³å‘Šè¯‰æˆ‘ä»¬ä½•æ—¶éœ€è¦è§£ç æŸäº›å†…å®¹ï¼Œæ¼”ç¤ºæ—¶é—´æˆ³å‘Šè¯‰æˆ‘ä»¬ä½•æ—¶éœ€è¦æ˜¾ç¤ºæŸäº›å†…å®¹ã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æµå¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
&nbsp;&nbsp;&nbsp;<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTSï¼š</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 4 2 3 </font></font><br>
&nbsp;&nbsp;&nbsp;<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTSï¼š</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 2 3 4 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æµï¼š</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPBB </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šå¸¸ï¼Œä»…å½“æ­£åœ¨æ’­æ”¾çš„æµåŒ…å«Bå¸§æ—¶ï¼ŒPTSå’ŒDTSæ‰ä¸åŒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æˆ‘ä»¬ä»</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">æ¥æ”¶åˆ°ä¸€ä¸ªåŒ…æ—¶</font><font style="vertical-align: inherit;">ï¼Œå®ƒåŒ…å«è¯¥åŒ…å†…éƒ¨ä¿¡æ¯çš„PTSå’ŒDTSå€¼ã€‚ä½†æ˜¯æˆ‘ä»¬çœŸæ­£éœ€è¦çš„æ˜¯æˆ‘ä»¬æ–°è§£ç çš„åŸå§‹å¸§çš„PTSï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“ä½•æ—¶éœ€è¦æ˜¾ç¤ºå®ƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¸è¿çš„æ˜¯ï¼ŒFFmpegä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_frame_get_best_effort_timestamp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆï¼‰</font><font style="vertical-align: inherit;">å‡½æ•°ä¸ºæˆ‘ä»¬æä¾›äº†â€œæœ€ä½³æ—¶é—´æˆ³â€ </font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒæ­¥åŒ–</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†ä¾æ¬¡æ˜¾ç¤ºå¸§ï¼Œæœ€å¥½çŸ¥é“ä½•æ—¶æ˜¾ç¤ºç‰¹å®šçš„è§†é¢‘å¸§ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯æˆ‘ä»¬åˆ°åº•æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</font><font style="vertical-align: inherit;">è¿™ä¸ªæƒ³æ³•æ˜¯è¿™æ ·çš„ï¼šåœ¨æ˜¾ç¤ºæ¡†æ¶ä¹‹åï¼Œæˆ‘ä»¬ç¡®å®šä½•æ—¶åº”è¯¥æ˜¾ç¤ºä¸‹ä¸€ä¸ªæ¡†æ¶ã€‚</font><font style="vertical-align: inherit;">ç„¶åæš‚åœä¸€ä¸‹ï¼Œç„¶åæˆ‘ä»¬å°†åœ¨è¿™æ®µæ—¶é—´åæ›´æ–°è§†é¢‘ã€‚</font><font style="vertical-align: inherit;">å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œæˆ‘ä»¬æ£€æŸ¥ç³»ç»Ÿæ—¶é’Ÿä¸Šä¸‹ä¸€å¸§çš„PTSå€¼ï¼Œä»¥äº†è§£æˆ‘ä»¬çš„ç­‰å¾…æ—¶é—´åº”è¯¥å¤šé•¿æ—¶é—´ã€‚</font><font style="vertical-align: inherit;">è¿™ç§æ–¹æ³•æœ‰æ•ˆï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œé—®é¢˜æ˜¯ï¼Œä¸‹ä¸€ä¸ªPTSä½•æ—¶ç”Ÿæ•ˆï¼Ÿæ‚¨ä¼šè¯´ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°å°†è§†é¢‘æ·»åŠ åˆ°å½“å‰çš„PTSä¸­-åŸåˆ™ä¸Šæ‚¨æ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯ï¼ŒæŸäº›ç±»å‹çš„è§†é¢‘å°†éœ€è¦é‡å¤å¸§ã€‚è¿™æ„å‘³ç€æ‚¨å¿…é¡»é‡å¤å½“å‰å¸§ä¸€å®šæ¬¡æ•°ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿‡æ—©æ˜¾ç¤ºä¸‹ä¸€å¸§ã€‚å¿…é¡»è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨æˆ‘ä»¬ç›®å‰ç¼–å†™çš„ç¨‹åºä¸­ï¼Œè§†é¢‘å’ŒéŸ³é¢‘æ­£åœ¨æ¬£å–œåœ°å‘å‰å†²ï¼Œç›´åˆ°ä»–ä»¬æ ¹æœ¬ä¸å¸Œæœ›åŒæ­¥ã€‚</font><font style="vertical-align: inherit;">å¦‚æœä¸€åˆ‡æœ¬èº«éƒ½èƒ½å®Œç¾è¿è¡Œï¼Œæˆ‘ä»¬å°±ä¸å¿…æ‹…å¿ƒã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯æ‚¨çš„è®¡ç®—æœºå’Œè®¸å¤šè§†é¢‘æ–‡ä»¶éƒ½ä¸æ˜¯å®Œç¾çš„ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼šå°†éŸ³é¢‘ä¸è§†é¢‘åŒæ­¥ï¼Œå°†è§†é¢‘ä¸éŸ³é¢‘åŒæ­¥æˆ–å°†éŸ³é¢‘å’Œè§†é¢‘ä¸å¤–éƒ¨æ—¶é’Ÿï¼ˆä¾‹å¦‚ä¸æ‚¨çš„è®¡ç®—æœºï¼‰åŒæ­¥ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬å°†è§†é¢‘ä¸éŸ³é¢‘åŒæ­¥ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼–ç ï¼šæ¥æ”¶PTSå¸§</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç›´æ¥å†™ç‚¹ä¸œè¥¿ã€‚æˆ‘ä»¬éœ€è¦åœ¨å¤§å‹ç»“æ„ä¸­æ·»åŠ æ›´å¤šçš„é›¶ä»¶ï¼Œæˆ‘ä»¬å°†æŒ‰ç…§éœ€è¦çš„æ–¹å¼è¿›è¡Œæ“ä½œã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è§†é¢‘çº¿ç¨‹ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨è¿™é‡Œæ”¶é›†è§£ç æµæ’é˜Ÿçš„æ•°æ®åŒ…å—ï¼Ÿåœ¨è¿™éƒ¨åˆ†ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è·å–</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_decode_video2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»™</font><b><font style="vertical-align: inherit;">æˆ‘ä»¬</font></b><font style="vertical-align: inherit;">çš„å¸§çš„PTS </font><font style="vertical-align: inherit;">ã€‚æˆ‘ä»¬è°ˆè®ºçš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯è·å–æœ€åå¤„ç†çš„æ•°æ®åŒ…çš„DTSï¼Œè¿™å¾ˆç®€å•ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">double</span> pts;<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(;;) {
    <span class="hljs-keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// means we quit getting packets</span>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
    pts = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// Decode video frame</span><font></font>
    len1 = avcodec_decode_video2(is-&gt;video_st-&gt;codec,<font></font>
                                pFrame, &amp;frameFinished, packet);<font></font>
    <span class="hljs-keyword">if</span>(packet-&gt;dts != AV_NOPTS_VALUE) {<font></font>
      pts = av_frame_get_best_effort_timestamp(pFrame);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      pts = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    pts *= av_q2d(is-&gt;video_st-&gt;time_base);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ— æ³•ç¡®å®šå…¶å€¼ï¼Œåˆ™å°†PTSè®¾ç½®ä¸ºé›¶ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½å§ï¼Œé‚£å¾ˆå®¹æ˜“ã€‚æŠ€æœ¯è¯´æ˜ï¼šå¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int64</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”¨äºPTSã€‚è¿™æ˜¯å› ä¸ºPTSè¢«å­˜å‚¨ä¸ºæ•´æ•°ã€‚è¯¥å€¼æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä¸</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebbä¸­</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æ—¶é—´ç»´åº¦ç›¸å¯¹åº”</font><font style="vertical-align: inherit;">ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæµå…·æœ‰æ¯ç§’24å¸§ï¼Œåˆ™42ä¸­çš„PTSå°†æŒ‡ç¤ºåº”åœ¨ç¬¬42å¸§åº”ä½¿ç”¨çš„ä½ç½®ä½¿ç”¨è¯¥å¸§ï¼Œä½†å‰ææ˜¯æˆ‘ä»¬æ¯1/24ç§’é’Ÿæ›´æ¢ä¸€æ¬¡å¸§ï¼ˆå½“ç„¶ï¼Œä¸ä¸€å®šå¦‚æ­¤ã€‚äº‹å®ä¸Šï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šè¿‡é™¤ä»¥å¸§é¢‘ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¯¥å€¼è½¬æ¢ä¸ºç§’ã€‚</font><b><font style="vertical-align: inherit;">æ—¶åŸº</font></b><font style="vertical-align: inherit;">å€¼</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¥æµå°†ç­‰äº1é™¤ä»¥å¸§é€Ÿç‡ï¼ˆå¯¹äºå…·æœ‰å›ºå®šå¸§é€Ÿç‡çš„å†…å®¹ï¼‰ï¼Œå› æ­¤ï¼Œè¦è·å¾—ä»¥ç§’ä¸ºå•ä½çš„PTSï¼Œè¯·ä¹˜ä»¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">time_base</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿›ä¸€æ­¥ç¼–ç ï¼šPTSçš„åŒæ­¥å’Œä½¿ç”¨</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬æ‹¥æœ‰æ‰€æœ‰ç°æˆçš„PTSã€‚</font><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæˆ‘ä»¬å°†å¤„ç†è¿™ä¸¤ä¸ªåŒæ­¥é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å°†åœ¨åé¢è¿›è¡Œè®¨è®ºã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sync_ize_video</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼Œè¯¥</font><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">å°†æ›´æ–°PTSä»¥ä¸æ‰€æœ‰å†…å®¹è¿›è¡ŒåŒæ­¥ã€‚</font><font style="vertical-align: inherit;">æœ€åï¼Œæ­¤åŠŸèƒ½è¿˜å°†å¤„ç†æ— æ³•è·å¾—å¸§çš„PTSå€¼çš„æƒ…å†µã€‚</font><font style="vertical-align: inherit;">åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·Ÿè¸ªä½•æ—¶é¢„æœŸä¸‹ä¸€å¸§ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ­£ç¡®è®¾ç½®åˆ·æ–°ç‡ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…éƒ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video_clock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€¼æ¥æ‰§è¡Œæ­¤æ“ä½œï¼Œè¯¥å€¼</font><font style="vertical-align: inherit;">è·Ÿè¸ªè§†é¢‘ç»è¿‡äº†å¤šå°‘æ—¶é—´ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†æ­¤å€¼æ·»åŠ åˆ°å¤§å‹ç»“æ„ä¸­ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoState</span> {</span>
  <span class="hljs-keyword">double</span>          video_clock; <span class="hljs-comment">// pts of last decoded frame / predicted pts of next decoded frame</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">syncnize_video</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼Œéå¸¸æ¸…æ¥šï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">synchronize_video</span><span class="hljs-params">(VideoState *is, AVFrame *src_frame, <span class="hljs-keyword">double</span> pts)</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">double</span> frame_delay;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(pts != <span class="hljs-number">0</span>) {
    <span class="hljs-comment">/* if we have pts, set video clock to it */</span><font></font>
    is-&gt;video_clock = pts;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">/* if we aren't given a pts, set it to the clock */</span><font></font>
    pts = is-&gt;video_clock;<font></font>
  }<font></font>
  <span class="hljs-comment">/* update the video clock */</span><font></font>
  frame_delay = av_q2d(is-&gt;video_st-&gt;codec-&gt;time_base);<font></font>
  <span class="hljs-comment">/* if we are repeating a frame, adjust clock accordingly */</span>
  frame_delay += src_frame-&gt;repeat_pict * (frame_delay * <span class="hljs-number">0.5</span>);<font></font>
  is-&gt;video_clock += frame_delay;<font></font>
  <span class="hljs-keyword">return</span> pts;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬åœ¨æ­¤åŠŸèƒ½ä¸­è€ƒè™‘äº†é‡å¤çš„å¸§ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œè®©æˆ‘ä»¬è·å¾—æ­£ç¡®çš„PTSï¼Œå¹¶</font><font style="vertical-align: inherit;">é€šè¿‡æ·»åŠ ä¸€ä¸ªæ–°çš„</font><b><font style="vertical-align: inherit;">pts</font></b><font style="vertical-align: inherit;">å‚æ•°</font><font style="vertical-align: inherit;">ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue_picture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†å¸§æ’é˜Ÿ</font><font style="vertical-align: inherit;">ï¼š</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// Did we get a video frame?</span>
    <span class="hljs-keyword">if</span>(frameFinished) {<font></font>
      pts = synchronize_video(is, pFrame, pts);<font></font>
      <span class="hljs-keyword">if</span>(queue_picture(is, pFrame, pts) &lt; <span class="hljs-number">0</span>) {
	<span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queue_pictureä¸­</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
å”¯ä¸€å‘ç”Ÿå˜åŒ–çš„</font><font style="vertical-align: inherit;">æ˜¯ï¼Œæˆ‘ä»¬å°†æ­¤</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€¼å­˜å‚¨</font><font style="vertical-align: inherit;">åœ¨</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ’é˜Ÿ</font><font style="vertical-align: inherit;">çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VideoPicture</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»“æ„</font><font style="vertical-align: inherit;">ä¸­ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»å°†</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å˜é‡æ·»åŠ </font><font style="vertical-align: inherit;">åˆ°ç»“æ„ä¸­å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç è¡Œï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VideoPicture</span> {</span><font></font>
  ...<font></font>
  <span class="hljs-keyword">double</span> pts;<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">queue_picture</span><span class="hljs-params">(VideoState *is, AVFrame *pFrame, <span class="hljs-keyword">double</span> pts)</span> </span>{<font></font>
  ... stuff ...<font></font>
  <span class="hljs-keyword">if</span>(vp-&gt;bmp) {<font></font>
    ... convert picture ...<font></font>
    vp-&gt;pts = pts;<font></font>
    ... alert <span class="hljs-built_in">queue</span> ...<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬å°†å›¾åƒä¸æ­£ç¡®çš„PTSå€¼ä¸€èµ·æ’é˜Ÿï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è§†é¢‘æ›´æ–°åŠŸèƒ½ã€‚æ‚¨å¯ä»¥ä»ä¸Šä¸€è¯¾ä¸­å›æƒ³èµ·æˆ‘ä»¬åªæ˜¯ä¼ªé€ äº†å®ƒï¼Œå¹¶å®‰è£…äº†80æ¯«ç§’çš„æ›´æ–°ã€‚å¥½å§ï¼Œç°åœ¨æˆ‘ä»¬å°†è¦æ‰¾å‡ºåº”è¯¥çœŸæ­£å­˜åœ¨çš„å†…å®¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬çš„ç­–ç•¥æ˜¯é€šè¿‡ç®€å•åœ°æµ‹é‡å½“å‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç‚¹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œä¸Šä¸€ä¸ª</font><b><font style="vertical-align: inherit;">ç‚¹</font></b><font style="vertical-align: inherit;">ä¹‹é—´çš„æ—¶é—´æ¥é¢„æµ‹ä¸‹ä¸€ä¸ªPTSçš„æ—¶é—´</font><font style="vertical-align: inherit;">ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è§†é¢‘ä¸éŸ³é¢‘åŒæ­¥ã€‚æˆ‘ä»¬è¦åˆ¶é€ ä¸€ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŸ³é¢‘æ—¶é’Ÿã€‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šä¸€ä¸ªå†…éƒ¨å€¼ï¼Œç”¨äºè·Ÿè¸ªæˆ‘ä»¬æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘çš„ä½ç½®ã€‚å°±åƒä»»ä½•mp3æ’­æ”¾å™¨ä¸Šçš„æ•°å­—è¯»æ•°ä¸€æ ·ã€‚ç”±äºæˆ‘ä»¬å°†è§†é¢‘ä¸å£°éŸ³åŒæ­¥ï¼Œå› æ­¤è§†é¢‘æµä½¿ç”¨æ­¤å€¼æ¥ç¡®å®šå®ƒæ˜¯å¤ªè¿œè¿˜æ˜¯å¤ªè¿œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¨åæˆ‘ä»¬å°†è¿”å›å®æ–½ï¼›ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬å…·æœ‰</font><b><font style="vertical-align: inherit;">get_audio_clock</font></b><font style="vertical-align: inherit;">å‡½æ•°</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™å°†ä½¿æˆ‘ä»¬æœ‰æ—¶é—´ä½¿ç”¨éŸ³é¢‘æ—¶é’Ÿã€‚ä¸€æ—¦è·å¾—æ­¤å€¼ï¼Œå¦‚æœè§†é¢‘å’ŒéŸ³é¢‘ä¸åŒæ­¥ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿä»…å°è¯•é€šè¿‡æœç´¢æˆ–å…¶ä»–æ–¹æ³•è·³è½¬åˆ°æ­£ç¡®çš„è½¯ä»¶åŒ…æ˜¯æ„šè ¢çš„ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œæˆ‘ä»¬åªéœ€è°ƒæ•´ä¸ºä¸‹ä¸€æ¬¡æ›´æ–°è®¡ç®—çš„å€¼ï¼šå¦‚æœPTSä¸éŸ³é¢‘æ—¶é—´ç›¸å·®å¤ªè¿œï¼Œæˆ‘ä»¬ä¼šå°†ä¼°è®¡çš„å»¶è¿ŸåŠ å€ã€‚å¦‚æœPTSæ¯”æ’­æ”¾æ—¶é—´æå‰å¤ªå¤šï¼Œæˆ‘ä»¬å°†å°½å¿«æ›´æ–°ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»é…ç½®äº†æ›´æ–°æˆ–å»¶è¿Ÿæ—¶é—´ï¼Œæˆ‘ä»¬å°†å…¶ä¸è®¡ç®—æœºæ—¶é’Ÿè¿›è¡Œæ¯”è¾ƒï¼Œè€Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frame_timerä»åœ¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿è¡Œ</font><font style="vertical-align: inherit;">ã€‚æ­¤å¸§è®¡æ—¶å™¨æ€»ç»“äº†æˆ‘ä»¬åœ¨ç”µå½±æ’­æ”¾æœŸé—´çš„æ‰€æœ‰ä¼°è®¡å»¶è¿Ÿã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ª</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frame_timer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-è¿™æ˜¯æŒ‡ç¤ºä½•æ—¶æ˜¾ç¤ºä¸‹ä¸€å¸§çš„æ—¶é—´ã€‚æˆ‘ä»¬åªéœ€å‘å¸§è®¡æ—¶å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„å»¶è¿Ÿï¼Œå°†å…¶ä¸è®¡ç®—æœºæ—¶é’Ÿä¸Šçš„æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åä½¿ç”¨è¯¥å€¼æ¥è®¡åˆ’ä¸‹ä¸€æ¬¡æ›´æ–°ã€‚è¿™å¯èƒ½ä¼šæœ‰äº›æ··ä¹±ï¼Œå› æ­¤è¯·ä»”ç»†é˜…è¯»ä»£ç ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">video_refresh_timer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *userdata)</span> </span>{<font></font>
<font></font>
  VideoState *is = (VideoState *)userdata;<font></font>
  VideoPicture *vp;<font></font>
  <span class="hljs-keyword">double</span> actual_delay, delay, sync_threshold, ref_clock, diff;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(is-&gt;video_st) {
    <span class="hljs-keyword">if</span>(is-&gt;pictq_size == <span class="hljs-number">0</span>) {<font></font>
      schedule_refresh(is, <span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];<font></font>
<font></font>
      delay = vp-&gt;pts - is-&gt;frame_last_pts; <span class="hljs-comment">/* the pts from last time */</span>
      <span class="hljs-keyword">if</span>(delay &lt;= <span class="hljs-number">0</span> || delay &gt;= <span class="hljs-number">1.0</span>) {
	<span class="hljs-comment">/* if incorrect delay, use previous one */</span><font></font>
	delay = is-&gt;frame_last_delay;<font></font>
      }<font></font>
      <span class="hljs-comment">/* save for next time */</span><font></font>
      is-&gt;frame_last_delay = delay;<font></font>
      is-&gt;frame_last_pts = vp-&gt;pts;<font></font>
<font></font>
      <span class="hljs-comment">/* update delay to sync to audio */</span><font></font>
      ref_clock = get_audio_clock(is);<font></font>
      diff = vp-&gt;pts - ref_clock;<font></font>
<font></font>
      <span class="hljs-comment">/* Skip or repeat the frame. Take delay into account
	 FFPlay still doesn't "know if this is the best guess." */</span><font></font>
      sync_threshold = (delay &gt; AV_SYNC_THRESHOLD) ? delay : AV_SYNC_THRESHOLD;<font></font>
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD) {
	<span class="hljs-keyword">if</span>(diff &lt;= -sync_threshold) {<font></font>
	  delay = <span class="hljs-number">0</span>;<font></font>
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(diff &gt;= sync_threshold) {<font></font>
	  delay = <span class="hljs-number">2</span> * delay;<font></font>
	}<font></font>
      }<font></font>
      is-&gt;frame_timer += delay;<font></font>
      <span class="hljs-comment">/* computer the REAL delay */</span>
      actual_delay = is-&gt;frame_timer - (av_gettime() / <span class="hljs-number">1000000.0</span>);
      <span class="hljs-keyword">if</span>(actual_delay &lt; <span class="hljs-number">0.010</span>) {
	<span class="hljs-comment">/* Really it should skip the picture instead */</span>
	actual_delay = <span class="hljs-number">0.010</span>;<font></font>
      }<font></font>
      schedule_refresh(is, (<span class="hljs-keyword">int</span>)(actual_delay * <span class="hljs-number">1000</span> + <span class="hljs-number">0.5</span>));
      <span class="hljs-comment">/* show the picture! */</span><font></font>
      video_display(is);<font></font>
      <font></font>
      <span class="hljs-comment">/* update queue for next picture! */</span>
      <span class="hljs-keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) {<font></font>
	is-&gt;pictq_rindex = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
      SDL_LockMutex(is-&gt;pictq_mutex);<font></font>
      is-&gt;pictq_size--;<font></font>
      SDL_CondSignal(is-&gt;pictq_cond);<font></font>
      SDL_UnlockMutex(is-&gt;pictq_mutex);<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    schedule_refresh(is, <span class="hljs-number">100</span>);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬è¿›è¡Œä¸€äº›æ£€æŸ¥ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬ç¡®ä¿å½“å‰PTSå’Œå…ˆå‰PTSä¹‹é—´çš„å»¶è¿Ÿæ˜¯åˆç†çš„ã€‚å¦‚æœä¸éœ€è¦å»¶è¿Ÿï¼Œåˆ™éŸ³é¢‘å’Œè§†é¢‘æ­¤æ—¶æ°å¥½é‡åˆï¼Œä»…ä½¿ç”¨æœ€åä¸€ä¸ªå»¶è¿Ÿã€‚ç„¶åæˆ‘ä»¬ç¡®ä¿æ»¡è¶³åŒæ­¥é˜ˆå€¼ï¼Œå› ä¸ºæ°¸è¿œä¸ä¼šå‘ç”Ÿå®Œç¾çš„åŒæ­¥ã€‚ FFplayçš„é˜ˆå€¼ä½¿ç”¨0.01ã€‚æˆ‘ä»¬è¿˜ç¡®ä¿åŒæ­¥é˜ˆå€¼ä¸å°äºPTSå€¼ä¹‹é—´çš„é—´éš”ã€‚æœ€åï¼Œå°†æœ€å°æ›´æ–°å€¼è®¾ç½®ä¸º10æ¯«ç§’ï¼ˆå®é™…ä¸Šï¼Œä¼¼ä¹ä»–ä»¬åº”è¯¥åœ¨æ­¤å¤„è·³è¿‡è¯¥å¸§ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¿…ä¸ºæ­¤æ‹…å¿ƒï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬åœ¨å¤§å‹ç»“æ„ä¸­æ·»åŠ äº†ä¸€å †å˜é‡ï¼Œæ‰€ä»¥ä¸è¦å¿˜è®°æ£€æŸ¥ä»£ç ã€‚</font><font style="vertical-align: inherit;">åŒæ ·ï¼Œä¸è¦å¿˜è®°åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream_component_openä¸­</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆå§‹åŒ–å¸§è®¡æ—¶å™¨å’Œä¸Šä¸€å¸§çš„åˆå§‹å»¶è¿Ÿ</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    is-&gt;frame_timer = (<span class="hljs-keyword">double</span>)av_gettime() / <span class="hljs-number">1000000.0</span>;<font></font>
    is-&gt;frame_last_delay = <span class="hljs-number">40e-3</span>;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒæ­¥ï¼šéŸ³é¢‘æ—¶é’Ÿ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨æ˜¯å®ç°éŸ³é¢‘æ—¶é’Ÿçš„æ—¶å€™äº†ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¯ä»¥åœ¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_decode_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°ä¸­æ›´æ–°æ—¶é—´</font><font style="vertical-align: inherit;">ï¼Œåœ¨å…¶ä¸­è§£ç éŸ³é¢‘ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨è¯·è®°ä½ï¼Œå¹¶éæ¯æ¬¡è°ƒç”¨æ­¤å‡½æ•°æ—¶éƒ½æ€»æ˜¯å¤„ç†æ–°çš„åŒ…ï¼Œå› æ­¤éœ€è¦åœ¨ä¸¤ä¸ªåŒºåŸŸä¸­æ›´æ–°æ—¶é’Ÿã€‚</font><font style="vertical-align: inherit;">é¦–å…ˆæ˜¯è·å¾—æ–°è½¯ä»¶åŒ…çš„ä½ç½®ï¼šåªéœ€å°†å£°éŸ³æ—¶é’Ÿå®‰è£…åœ¨PTSè½¯ä»¶åŒ…ä¸Šå³å¯ã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œå¦‚æœæ•°æ®åŒ…æœ‰å‡ ä¸ªå¸§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—é‡‡æ ·æ•°å¹¶å°†å®ƒä»¬ä¹˜ä»¥æ¯ç§’ç»™å®šçš„é‡‡æ ·é¢‘ç‡æ¥èŠ‚çœéŸ³é¢‘æ’­æ”¾æ—¶é—´ã€‚</font><font style="vertical-align: inherit;">æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬æœ‰åŒ…æ—¶ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">/* if update, update the audio clock w/pts */</span>
    <span class="hljs-keyword">if</span>(pkt-&gt;pts != AV_NOPTS_VALUE) {<font></font>
      is-&gt;audio_clock = av_q2d(is-&gt;audio_st-&gt;time_base)*pkt-&gt;pts;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¶ä¸”ï¼Œä¸€æ—¦æˆ‘ä»¬å¤„ç†äº†åŒ…è£¹ï¼Œ</font></font><br>
<br>
<pre><code class="cpp hljs">      <span class="hljs-comment">/* Keep audio_clock up-to-date */</span><font></font>
      pts = is-&gt;audio_clock;<font></font>
      *pts_ptr = pts;<font></font>
      n = <span class="hljs-number">2</span> * is-&gt;audio_st-&gt;codec-&gt;channels;<font></font>
      is-&gt;audio_clock += (<span class="hljs-keyword">double</span>)data_size /<font></font>
	(<span class="hljs-keyword">double</span>)(n * is-&gt;audio_st-&gt;codec-&gt;sample_rate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€äº›ç»†å¾®çš„å·®åˆ«ï¼šåŠŸèƒ½æ¨¡æ¿å·²æ›´æ”¹ï¼Œç°åœ¨åŒ…æ‹¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_ptr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå› æ­¤è¯·ç¡®ä¿å¯¹å…¶è¿›è¡Œæ›´æ”¹ã€‚</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_ptr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬ç”¨æ¥å‘Šè¯‰</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éŸ³é¢‘æ•°æ®åŒ…</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æŒ‡é’ˆ</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¸‹æ¬¡å°†ä½¿ç”¨å®ƒæ¥åŒæ­¥éŸ³é¢‘å’Œè§†é¢‘ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥å®ç°æˆ‘ä»¬çš„</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_audio_clock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è€ƒè™‘ä¸€ä¸‹ï¼Œ</font><font style="vertical-align: inherit;">è¿™å¹¶ä¸åƒè·å–å€¼</font></font><nobr><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio_clock</font></font></b></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‚£æ ·ç®€å•</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è¯·æ³¨æ„ï¼Œæ¯æ¬¡å¤„ç†æ—¶æˆ‘ä»¬éƒ½ä¼šè®¾ç½®PTSéŸ³é¢‘ï¼Œä½†æ˜¯å¦‚æœæ‚¨æŸ¥çœ‹</font><b><font style="vertical-align: inherit;">audio_callback</font></b><font style="vertical-align: inherit;">å‡½æ•°ï¼Œ</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå°†æ‰€æœ‰æ•°æ®ä»éŸ³é¢‘æ•°æ®åŒ…ç§»åˆ°è¾“å‡ºç¼“å†²åŒºå°†éœ€è¦ä¸€äº›æ—¶é—´ã€‚</font><font style="vertical-align: inherit;">è¿™æ„å‘³ç€æˆ‘ä»¬éŸ³é¢‘æ—¶é’Ÿä¸­çš„å€¼å¯èƒ½ä¼šè¿‡é«˜ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥å¿…é¡»å†™å¤šå°‘ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯å®Œæ•´çš„ä»£ç ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">get_audio_clock</span><span class="hljs-params">(VideoState *is)</span> </span>{
  <span class="hljs-keyword">double</span> pts;
  <span class="hljs-keyword">int</span> hw_buf_size, bytes_per_sec, n;<font></font>
  <font></font>
  pts = is-&gt;audio_clock; <span class="hljs-comment">/* maintained in the audio thread */</span><font></font>
  hw_buf_size = is-&gt;audio_buf_size - is-&gt;audio_buf_index;<font></font>
  bytes_per_sec = <span class="hljs-number">0</span>;<font></font>
  n = is-&gt;audio_st-&gt;codec-&gt;channels * <span class="hljs-number">2</span>;
  <span class="hljs-keyword">if</span>(is-&gt;audio_st) {<font></font>
    bytes_per_sec = is-&gt;audio_st-&gt;codec-&gt;sample_rate * n;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(bytes_per_sec) {<font></font>
    pts -= (<span class="hljs-keyword">double</span>)hw_buf_size / bytes_per_sec;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> pts;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨ç°åœ¨åº”è¯¥äº†è§£ä¸ºä»€ä¹ˆæ­¤åŠŸèƒ½æœ‰æ•ˆï¼›ï¼‰å°±</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ ·ï¼</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç¼–è¯‘ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">gcc -o tutorial05 tutorial05.c -lavutil -lavformat -lavcodec -lswscale -lz -lm \<font></font>
`sdl-config --cflags --libs`</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®ƒå‘ç”Ÿäº†ï¼</font><font style="vertical-align: inherit;">æ‚¨å¯ä»¥åœ¨è‡ªåˆ¶æ’­æ”¾å™¨ä¸Šè§‚çœ‹ç”µå½±ã€‚</font><font style="vertical-align: inherit;">åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶éŸ³é¢‘åŒæ­¥ï¼Œç„¶åå­¦ä¹ å¦‚ä½•æœç´¢ã€‚</font></font><br>
<br>
<h3><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpegå’ŒSDLæŒ‡å—æˆ–å¦‚ä½•ç¼–å†™å°‘äº1000è¡Œçš„è§†é¢‘æ’­æ”¾å™¨-ç¬¬2éƒ¨åˆ†</font></font></a></h3><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çˆ±è¿ªç”Ÿåšå®¢ä¸Šçš„ç¿»è¯‘ï¼š</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/fr/yz/q7/fryzq72v0ik0irt2q4orchflxvs.jpeg"></a></td>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/jv/3k/-f/jv3k-f5vi9drztohsh-e0t-puru.jpeg"></a></td>
</tr>
<tr>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ”¶å…¥è¶…è¿‡åäº¿ç¾å…ƒçš„</font><font style="vertical-align: inherit;">å‰50å¤§æ¸¸æˆç‰¹è®¸ç»è¥æƒ</font></font></a></th>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Airbnbèƒ½å¦åœ¨å† çŠ¶ç—…æ¯’ä¸­å­˜æ´»ï¼Ÿ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[å‰§é€ï¼šæ˜¯çš„]</font></font></a></th>
</tr>
</tbody></table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN500386/index.html">ä½¿æ‚¨ç°æœ‰çš„ä¸šåŠ¡è§£å†³æ–¹æ¡ˆé€‚åº”SwiftUIã€‚ç¬¬2éƒ¨åˆ†</a></li>
<li><a href="../zh-CN500390/index.html">ITå’Œæ•°å­—é€šä¿¡é¢†åŸŸä¸­è¯­è¨€æœ¬åœ°åŒ–çš„å®é™…æ¨¡å‹ã€‚ç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN500396/index.html">è‡ªä¸»è®¿é—®æ§åˆ¶ç³»ç»Ÿçš„é—®é¢˜-ä»–ä»¬æ²¡æœ‰æƒ³åˆ°çš„åœ°æ–¹</a></li>
<li><a href="../zh-CN500398/index.html">è¿œç¨‹é©¬æ‹‰æ¾å‘¨3ï¼šæ— æ•ˆçš„è¿‡ç¨‹</a></li>
<li><a href="../zh-CN500400/index.html">ä¿®å‰ªçº¿ç¨‹ï¼šä»Puppet Enterpriseè¿ç§»åˆ°Ansible Towerã€‚ç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN500404/index.html">å¦‚ä½•ç»“äº¤Electronå’ŒWebixçš„æœ‹å‹ã€‚ç¬¬2éƒ¨åˆ†ã€‚ä½¿ç”¨æ‚¨çš„è§†å›¾åˆ›å»ºåº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN500406/index.html">äº’è”ç½‘ç¬¬ä¸€æ¬¡ç˜«ç—ªçš„æ•…äº‹ï¼šç¹å¿™ä¿¡å·çš„è¯…å’’</a></li>
<li><a href="../zh-CN500408/index.html">è´«ç©·å¹¸ç¦</a></li>
<li><a href="../zh-CN500410/index.html">äº§ç”Ÿåå†²</a></li>
<li><a href="../zh-CN500414/index.html">3D CNCæœºåºŠæˆ–æˆ‘ä»¬ä¹‹å‰å·²ç»å®Œæˆçš„ä¸€åˆ‡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>