<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•û üçå üßëüèª Acelerar los gr√°ficos con OffscreenCanvas üí° üîÉ ü§õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La representaci√≥n de gr√°ficos puede afectar seriamente al navegador. Especialmente cuando se trata de generar una multitud de elementos que representa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acelerar los gr√°ficos con OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La representaci√≥n de gr√°ficos puede afectar seriamente al navegador. </font><font style="vertical-align: inherit;">Especialmente cuando se trata de generar una multitud de elementos que representan diagramas en la interfaz de una aplicaci√≥n compleja. </font><font style="vertical-align: inherit;">Puede intentar mejorar la situaci√≥n utilizando la interfaz </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">cuyo </font><font style="vertical-align: inherit;">nivel de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soporte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° aumentando gradualmente los navegadores. </font><font style="vertical-align: inherit;">Permite, utilizando un trabajador web, pasar a las tareas de formar una imagen mostrada en un elemento visible </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
El art√≠culo, cuya traducci√≥n publicamos hoy, est√° dedicado al uso de la interfaz </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Aqu√≠ hablaremos sobre por qu√© podr√≠a ser necesaria esta interfaz, sobre lo que realmente se puede esperar de su uso y sobre las dificultades que pueden surgir al trabajar con ella.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© prestar atenci√≥n a OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo involucrado en la representaci√≥n del diagrama puede tener una complejidad computacional suficientemente alta. En </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muchos lugares,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede encontrar historias detalladas sobre c√≥mo generar una animaci√≥n fluida y para garantizar la interacci√≥n conveniente del usuario con la p√°gina, es necesario que la representaci√≥n de un cuadro se ajuste a unos 10 ms, lo que le permite alcanzar 60 cuadros por segundo. Si los c√°lculos necesarios para generar un cuadro tardan m√°s de 10 ms, esto dar√° como resultado "ralentizaciones" notables de la p√°gina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, cuando se muestran diagramas, la situaci√≥n se ve agravada por lo siguiente:</font></font><br>
<br>
<ul>
<li>        ‚Äî   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( ‚Äî   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos problemas son candidatos ideales para un enfoque de optimizaci√≥n cl√°sico llamado divide y vencer√°s. En este caso, estamos hablando de la distribuci√≥n de la carga inform√°tica a trav√©s de m√∫ltiples hilos. Sin embargo, antes de la aparici√≥n de la interfaz, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todo el c√≥digo de representaci√≥n deb√≠a ejecutarse en el hilo principal. La √∫nica forma en que este c√≥digo podr√≠a usar las API que necesitaba. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde un punto de vista t√©cnico, los c√°lculos "pesados" podr√≠an enviarse a un hilo de trabajo web antes. Pero, dado que las llamadas responsables de la representaci√≥n ten√≠an que hacerse desde el flujo principal, esto requer√≠a el uso de esquemas complejos de intercambio de mensajes entre el flujo de trabajo y el flujo principal en el c√≥digo de salida del gr√°fico. Adem√°s, este enfoque a menudo solo dio un ligero aumento de rendimiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especificaci√≥n</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos proporciona un mecanismo para transferir el control de superficie para mostrar gr√°ficos de elementos </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un trabajador web. </font><font style="vertical-align: inherit;">Actualmente, esta especificaci√≥n es compatible con los navegadores Chrome y Edge (despu√©s de que Edge se haya migrado a Chromium). </font><font style="vertical-align: inherit;">Se espera que en Firefox el soporte </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aparezca dentro de seis meses. </font><font style="vertical-align: inherit;">Si hablamos de Safari, a√∫n se desconoce si el soporte para esta tecnolog√≠a est√° planeado en este navegador.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico de salida usando OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un ejemplo de un gr√°fico que muestra 100,000 puntos multicolores</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Para evaluar mejor las posibles ventajas y desventajas</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, veamos un ejemplo del resultado del diagrama "pesado" que se muestra en la figura anterior.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, consultamos </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando el nuevo m√©todo </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego llamamos al m√©todo </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, haciendo esto para enviar un mensaje al trabajador que contiene un enlace </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es muy importante que aqu√≠, como segundo argumento, necesite usar </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esto le permite hacer que el propietario de este objeto trabaje, lo que le permitir√° administrar solo </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teniendo en cuenta que los tama√±os se </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heredaron originalmente de los atributos </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es nuestra responsabilidad mantener estos valores actualizados cuando se cambia el tama√±o del elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Aqu√≠ usamos el evento </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que nos dar√° la oportunidad, de acuerdo con </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de transmitir al trabajador informaci√≥n sobre las nuevas dimensiones del elemento </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para simplificar el ejemplo, utilizaremos componentes de la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este es un conjunto de componentes auxiliares que agregan componentes d3 o complementan su funcionalidad. Puede trabajar </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sin componentes d3fc. Todo lo que se discutir√° se puede hacer utilizando caracter√≠sticas de JavaScript exclusivamente est√°ndar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora ve al c√≥digo del archivo </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En este ejemplo, en aras de un aumento real en el rendimiento de representaci√≥n, vamos a utilizar WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando recibimos un mensaje que contiene una propiedad </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, asumimos que el mensaje proviene del hilo principal. Luego, obtenemos el </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contexto </font><font style="vertical-align: inherit;">del elemento </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y lo pasamos al componente </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego llamamos al componente </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pas√°ndole los datos ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que queremos representar con √©l (a continuaci√≥n hablaremos de d√≥nde </font><font style="vertical-align: inherit;">provienen las </font><font style="vertical-align: inherit;">variables correspondientes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, verificamos las propiedades </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que aparecieron en el mensaje, y las usamos para establecer las dimensiones </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√°rea de visualizaci√≥n de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. El enlace </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se usa directamente. El hecho es que el mensaje contiene una propiedad </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o propiedades </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de trabajo restante es responsable de configurar la representaci√≥n de lo que queremos generar. </font><font style="vertical-align: inherit;">Aqu√≠ no hay nada especial, por lo que si todo esto le resulta familiar, puede pasar inmediatamente a la siguiente secci√≥n en la que hablaremos sobre el rendimiento.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, creamos un conjunto de datos que contiene las coordenadas de puntos distribuidos aleatoriamente alrededor del origen x / y, y ajustamos la escala. </font><font style="vertical-align: inherit;">No establecemos el rango de valores xey usando el m√©todo </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ya que la serie WebGL se muestra en tama√±o completo del elemento </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en las coordenadas normalizadas del dispositivo).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, configuramos una serie de puntos usando </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Luego configuramos los medios de acceso apropiados que le permiten leer datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, definimos nuestra propia funci√≥n de comprobaci√≥n de igualdad, que est√° dise√±ada para garantizar que el componente no transmita </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU en cada representaci√≥n. </font><font style="vertical-align: inherit;">Debemos expresar esto expl√≠citamente, porque incluso si sabemos que no modificaremos estos datos, el componente no puede saberlo sin realizar una verificaci√≥n "sucia" de uso intensivo de recursos.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo le permite colorear el gr√°fico. </font><font style="vertical-align: inherit;">Usamos el √≠ndice del punto en el conjunto de datos para seleccionar un color adecuado </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, luego lo convertimos al formato requerido y lo usamos para decorar el punto de salida.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que los puntos est√°n coloreados, todo lo que queda es animar el gr√°fico. Debido a esto, necesitaremos una llamada al m√©todo constante </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esto, adem√°s, crear√° algo de carga en el sistema. Simulamos el aumento y la disminuci√≥n de la escala del gr√°fico </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para modificar las propiedades </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cada cuadro. Aqu√≠, los valores dependientes del tiempo se aplican y se calculan para que la escala del gr√°fico cambie sin problemas. Adem√°s, modificamos el encabezado del mensaje para que se llame a un m√©todo para comenzar el ciclo de representaci√≥n </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y para que no tengamos que llamar directamente </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que este ejemplo funcione, solo queda importar las bibliotecas necesarias al trabajador. </font><font style="vertical-align: inherit;">Usamos para esto </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y tambi√©n, para no usar las herramientas para construir proyectos, usamos una lista de dependencias compiladas manualmente. </font><font style="vertical-align: inherit;">Desafortunadamente, no podemos descargar las compilaciones d3 / d3fc completas, ya que dependen del DOM y lo que necesitan en el trabajador no est√° disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Üí El c√≥digo completo para este ejemplo se puede encontrar en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Offscreen: lienzo y rendimiento</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La animaci√≥n en nuestro proyecto funciona gracias al uso </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de un trabajador. Esto le permite al trabajador renderizar p√°ginas incluso cuando el hilo principal est√° ocupado con otras cosas. Si mira </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la p√°gina del</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proyecto descrita en la secci√≥n anterior y hace clic en el bot√≥n </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puede prestar atenci√≥n al hecho de que cuando se muestra el cuadro de mensaje, la actualizaci√≥n de la informaci√≥n de la marca de tiempo se detiene. El hilo principal est√° bloqueado, pero la animaci√≥n del gr√°fico no se detiene.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ventana del proyecto</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Podr√≠amos organizar una representaci√≥n iniciada al recibir mensajes de la transmisi√≥n principal. Por ejemplo, dichos eventos podr√≠an enviarse cuando un usuario interact√∫a con un gr√°fico o cuando recibe datos nuevos a trav√©s de la red. Pero con este enfoque, si el hilo principal est√° ocupado con algo y no se reciben mensajes en el trabajador, la representaci√≥n se detendr√°.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La representaci√≥n continua de la tabla en condiciones en las que no sucede nada es una excelente manera de molestar al usuario con un zumbido de ventilador y bater√≠a baja. Como resultado, resulta que en el mundo real, la decisi√≥n sobre c√≥mo dividir las responsabilidades entre el hilo principal y el hilo del trabajador depende de si el trabajador puede hacer algo √∫til cuando no recibe mensajes sobre un cambio en la situaci√≥n del hilo principal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si hablamos de la transferencia de mensajes entre hilos, debe tenerse en cuenta que aqu√≠ aplicamos un enfoque muy simple. Honestamente, necesitamos transmitir muy pocos mensajes entre hilos, por lo que preferir√≠a llamar a nuestro enfoque una consecuencia del pragmatismo, no de la pereza. Pero si hablamos de aplicaciones reales, se puede observar que el esquema de transferencia de mensajes entre los flujos se volver√° m√°s complicado si la interacci√≥n del usuario con el diagrama y la actualizaci√≥n de los datos visualizados depender√°n de ellos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede usar la interfaz est√°ndar </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> para crear canales de mensajes separados entre el hilo principal y el </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">hilo de</font></a><font style="vertical-align: inherit;"> trabajo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cada uno de estos canales se puede utilizar para una categor√≠a espec√≠fica de mensajes, lo que facilita el procesamiento de mensajes. Como alternativa a los mecanismos est√°ndar, pueden actuar bibliotecas de terceros como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esta biblioteca oculta detalles de bajo nivel detr√°s de una interfaz de alto nivel que utiliza </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objetos proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra caracter√≠stica interesante de nuestro ejemplo, que se vuelve claramente visible en retrospectiva, es el hecho de que tiene en cuenta el hecho de que los recursos de la GPU, como otros recursos del sistema, est√°n lejos de ser infinitos. La traducci√≥n del renderizado en un trabajador permite que el hilo principal resuelva otros problemas. Pero el navegador, de todos modos, necesita acceder a la GPU para representar el DOM y lo que se gener√≥ por los medios </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el trabajador consume todos los recursos de la GPU, la ventana principal de la aplicaci√≥n experimentar√° problemas de rendimiento, independientemente de d√≥nde se realice el renderizado. Preste atenci√≥n a c√≥mo disminuye la velocidad de actualizaci√≥n de la marca de tiempo en el ejemplo a medida que aumenta el n√∫mero de puntos mostrados. Si tiene una tarjeta gr√°fica potente, es posible que deba aumentar el n√∫mero de puntos transmitidos a la p√°gina en la cadena de consulta. Para hacer esto, puede usar un valor que exceda el valor m√°ximo de 100000, especificado usando uno de los enlaces en la p√°gina de ejemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cabe se√±alar que aqu√≠ no exploramos el mundo secreto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de los atributos de contexto.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tal estudio podr√≠a ayudarnos a aumentar la productividad de la soluci√≥n. </font><font style="vertical-align: inherit;">Sin embargo, no hice esto al hacerlo debido al bajo nivel de soporte para estos atributos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si hablamos de renderizar usando </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces el atributo se ve m√°s interesante aqu√≠ </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este, donde es compatible, y teniendo en cuenta algunas restricciones, le permite deshacerse de la sincronizaci√≥n entre el bucle de eventos y el bucle de representaci√≥n que se ejecuta en el trabajador. </font><font style="vertical-align: inherit;">Esto minimiza el retraso en la actualizaci√≥n de la imagen. </font><font style="vertical-align: inherit;">Los detalles sobre esto se pueden encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La interfaz </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brinda a los desarrolladores la oportunidad de mejorar el rendimiento de la representaci√≥n gr√°fica, pero su uso requiere un enfoque reflexivo. </font><font style="vertical-align: inherit;">Al usarlo, debe considerar lo siguiente:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo de ejemplo, y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° su versi√≥n de trabajo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Queridos lectores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øHas utilizado OffscreenCanvas para acelerar la visualizaci√≥n de gr√°ficos en p√°ginas web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496950/index.html">El dise√±o es dise√±o, no la belleza de las im√°genes.</a></li>
<li><a href="../es496952/index.html">Qualcomm QCC3020: el auge de los auriculares chinos TWS</a></li>
<li><a href="../es496954/index.html">Desarrollo en Wargaming - reuni√≥n con Maxim Baryshnikov, Jefe de Plataforma (Parte I)</a></li>
<li><a href="../es496956/index.html">¬øPor qu√© aparecieron los servidores web as√≠ncronos?</a></li>
<li><a href="../es496958/index.html">Interesante CSS encuentra en el nuevo dise√±o de Facebook</a></li>
<li><a href="../es496962/index.html">¬øC√≥mo ordenar un servidor sobrecargado?</a></li>
<li><a href="../es496964/index.html">Seminarios semanales de IBM - abril de 2020</a></li>
<li><a href="../es496966/index.html">Colores CSS LCH</a></li>
<li><a href="../es496968/index.html">4 acciones imperdonables para el l√≠der durante COVID-19</a></li>
<li><a href="../es496972/index.html">Food Safety Trends 2020. Free Online Mitap 21 de abril</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>