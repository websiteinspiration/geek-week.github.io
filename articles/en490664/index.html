<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤷🏽 👃 👨‍👨‍👧 PHP: array_key_exists searches 500 times faster than in_array 👨‍👩‍👦‍👦 💸 🗜️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2014, they already wrote about the search of the array , but hardly anyone understood.
 
 Since then, many versions of PHP have been released and h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHP: array_key_exists searches 500 times faster than in_array</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490664/"><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In 2014, they already wrote about the search of the array</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but hardly anyone understood.</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Since then, many versions of PHP have been released and have not been fixed, which means that feedback is bad and few people know about it. On python it is the same, and in 3 * worse than in 2.7.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sometimes you need to find a string in an array of strings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a very frequent operation in different algorithms, and if the array is small and look a bit and not in a loop, then in_array is normal, it does not affect the overall speed, but if you need big data and look for an array of a billion rows and a billion times , then this is critical: better hour instead of week.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A simple test shows:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in_array looks for</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideone.com/Yb1mDa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6600ms</font><font style="vertical-align: inherit;">in 6-9 seconds</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and array_key_exists looks for the same thing, but faster than 250 (php5.6 / py3. *) 400+ times (php7.3 / py2.7)</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideone .com / gwSmFc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(cycle increased 100 times) 12ms (6600/12 = 550 times + -10% spread due to load and cache) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is this happening? </font><font style="vertical-align: inherit;">Consider in detail:</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Finding strings in pure assembler / s is sorting an array of strings (quick or bubble), then binary search. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The number of steps in a binary search log (n) times depends on the size of the array, and is much smaller than a simple search. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can sort an array of strings in advance, once, and cache, and then do a billion searches. </font><font style="vertical-align: inherit;">But that does not help. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, sorting happens every time again, although they wrote that they improved in 7.2 in_array through a hash, but not much.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Search index / key (as a string) in the association. array / dictionary occurs by hash of strings and collision processing. (hash search errors). A hash is the numeric index of the array and fetching from it as (address of the zero element) + offset * the size of the pointer to the array of strings with this hash) in 2 steps. + brute force collisions, steps on average less than binary search. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The index hash is automatically done once in advance when creating the dictionary element $ m [key] = val and is cached. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The size of the hash, the hashing algorithm is sewn into the php engine and it cannot be changed, although the source code is open, you can download to change and compile if your server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can not read further, change in_array to array_combine + array_key_exists and that’s it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The number of steps when searching by hash depends on the number of collisions and the number of lines with the same hash. They need to be sorted out or also sorted and binary search. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To reduce collisions, you can allocate more memory, if it is possible that now is not such a problem as 50 years ago when 1 kb of memory on magnetic coils cost like an airplane. And it was then that all the basic algorithms were invented: sort / zip / gif / jpg / etc. - they do not need a lot of memory, but they are bad, now they are much better, but they need a lot of memory 1-16 MB. Yes, there are servers with 256 MB and each has a separate stream and 16 MB is already a lot, but on the device of the average user 1 GB at least and 16 MB is a drop in the bucket.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can get even more effect if you replace the call to the array_key_exists function with the isset ($ m [key]) construct, it does not clear the command queue and cache, does not use the stack, and is faster by about 20%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also speed it up if you create an array of the first 2 letters - 4 * 16kb and look first at the offset (index = code of the 1st character + 2nd * 256) a pointer to the hash array for the rest of the line, then look for a small array of “tails” of strings and collisions are much smaller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It requires even more memory and the algorithm is more complicated, but the search is 30+ times faster. But this is not implemented in php, you can write your so / dll library and call it, or ask developers to add it in 7.5. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can search through mySQL, but you need to group the queries and it will still be slower.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS: This method was accidentally found by typing, intuition and experience when I accelerated one big slow website, there are a lot of such subtleties and tricks, I managed to get the data to be exported from 40 seconds to 0.8 seconds, output lists with sorting and filters, and many others things where standard techniques, frameworks and frameworks do it all too slowly, although of course they are convenient and speed up development.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490650/index.html">The main mistakes in compiling a CV by beginner IT specialists</a></li>
<li><a href="../en490652/index.html">Logistics. Introduction Just about complicated</a></li>
<li><a href="../en490654/index.html">Dotting over MQ Series gas sensors - deep understanding of datasheet and tuning</a></li>
<li><a href="../en490656/index.html">Camunda external tasks - a powerful tool for building applications with resilient and scalable architecture</a></li>
<li><a href="../en490660/index.html">How did we ensure the growth of CityMobile</a></li>
<li><a href="../en490668/index.html">The history of the transformation from product to project and vice versa (using the example of Goodness in the Moscow region)</a></li>
<li><a href="../en490670/index.html">How to make a car write tests from code for you</a></li>
<li><a href="../en490674/index.html">Habr Wickley # 41 / More autonomous cars, prof. Fortran, Yandex, the pain of the robot, how to block a competitor’s site</a></li>
<li><a href="../en490676/index.html">Unit testing, science and math</a></li>
<li><a href="../en490678/index.html">Using RabbitMQ with MonsterMQ Part 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>