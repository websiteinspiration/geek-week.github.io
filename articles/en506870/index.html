<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë¶ üë®üèΩ‚Äç‚öñÔ∏è üë®‚Äçüë¶ How to disable the warning about the dangers of long listening to audio (Android) üå∞ üç≤ üôÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, many who listen to music (and not only) from an Android device have come across this warning:
 
 
 In this article, we will look at why and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to disable the warning about the dangers of long listening to audio (Android)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506870/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probably, many who listen to music (and not only) from an Android device have come across this warning:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_i/gk/oa/_igkoaiik88g5pr8eooiezni-i8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we will look at why and when this warning occurs, and how to make sure that it no longer occurs.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It appears only when listening to audio through an external device (headphones / speakers). For those who have not met this, a little explanation: imagine that you are listening to music with headphones, quite loud. Suddenly, the sound becomes quieter. You are trying to turn up the volume using the buttons on the case, but it doesn‚Äôt work. Taking the device out of your pocket and unlocking it, you will see such a warning. Only after agreement with him will it be possible to turn up the volume back.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, the warning is reasonable, but it appears at an unpredictable moment, sometimes the most inappropriate: when you are in public transport / driving / in the winter on the street / when you have dirty hands, etc. </font><font style="vertical-align: inherit;">It is inconvenient to remove the device, release the lock, accept the warning, put the device back in these cases. </font><font style="vertical-align: inherit;">And if the speakers are connected, and not the headphones, the message is not entirely appropriate.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why does it arise</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This warning is not an initiative of the authors of the platform. </font><font style="vertical-align: inherit;">The thing is that there is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHO-ETU standard for</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúsafe listening‚Äù (safe listening). </font><font style="vertical-align: inherit;">In European and some other countries, its implementation is mandatory. </font><font style="vertical-align: inherit;">The standard describes how long you can listen to audio depending on volume with minimal risk of hearing loss. </font><font style="vertical-align: inherit;">For example, for an adult, the safe weekly ‚Äúdose‚Äù of sound is 1.6 Pa </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h, which is equivalent to 20 hours of listening at a volume of 83 dB.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lf/lm/xx/lflmxxcutic2hsnxzyh2i_mepyg.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on mcc (mobile country code), safe listening mode can be turned on or off. This is determined by the value of the resource </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the mode is on, the system calculates the listening time at an unsafe volume (above 85 dB), and periodically stores the value in a variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. When the value reaches 20 hours, a warning is displayed. After accepting the warning, the value is reset and the counting starts again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such an implementation is quite simple and does not take into account, for example, how long the user listened to these 20 hours: maybe in a couple of days, or maybe listened for 6-7 minutes for six months (in accordance with the standard, this is not a threat to hearing ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Safe listening logic is concentrated in the class class </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioService.java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you can see the corresponding fields in it:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// mMusicActiveMs is the cumulative time of music activity since safe volume was disabled.</span>
<span class="hljs-comment">// When this time reaches UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX, the safe media volume is re-enabled</span>
<span class="hljs-comment">// automatically. mMusicActiveMs is rounded to a multiple of MUSIC_ACTIVE_POLL_PERIOD_MS.</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mMusicActiveMs;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX = (<span class="hljs-number">20</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 20 hours</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MUSIC_ACTIVE_POLL_PERIOD_MS = <span class="hljs-number">60000</span>;  <span class="hljs-comment">// 1 minute polling interval</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The field </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains the number of milliseconds listened by the user at an insecure volume since the last confirmation of the dialogue. </font><font style="vertical-align: inherit;">The initial value is loaded from the variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the same variable, a new mMusicActiveMs value is written every minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is also a field </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it contains the current state of the safe listening system:</font></font><br>
<br>
<ul>
<li><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: off</font></font></li>
<li><code>ACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: enabled, and the listening limit has been reached, which means you cannot allow the user to increase the volume until he agrees with the warning</font></font></li>
<li><code>INACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: on, the limit has not yet been reached</font></font></li>
</ul><br>
<pre><code class="java hljs">
<span class="hljs-comment">// mSafeMediaVolumeState indicates whether the media volume is limited over headphones.</span>
<span class="hljs-comment">// It is SAFE_MEDIA_VOLUME_NOT_CONFIGURED at boot time until a network service is connected</span>
<span class="hljs-comment">// or the configure time is elapsed. It is then set to SAFE_MEDIA_VOLUME_ACTIVE or</span>
<span class="hljs-comment">// SAFE_MEDIA_VOLUME_DISABLED according to country option. If not SAFE_MEDIA_VOLUME_DISABLED, it</span>
<span class="hljs-comment">// can be set to SAFE_MEDIA_VOLUME_INACTIVE by calling AudioService.disableSafeMediaVolume()</span>
<span class="hljs-comment">// (when user opts out).</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_NOT_CONFIGURED = <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_DISABLED = <span class="hljs-number">1</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_INACTIVE = <span class="hljs-number">2</span>;  <span class="hljs-comment">// confirmed</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_ACTIVE = <span class="hljs-number">3</span>;  <span class="hljs-comment">// unconfirmed</span>
<span class="hljs-keyword">private</span> Integer mSafeMediaVolumeState;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method for checking the excess of the limit looks like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCheckMusicActive</span><span class="hljs-params">(String caller)</span> </span>{
   <span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeState) {
       <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_INACTIVE) {
           <span class="hljs-keyword">int</span> device = getDeviceForStream(AudioSystem.STREAM_MUSIC);<font></font>
<font></font>
           <span class="hljs-keyword">if</span> ((device &amp; mSafeMediaVolumeDevices) != <span class="hljs-number">0</span>) {<font></font>
               sendMsg(mAudioHandler,<font></font>
                   MSG_CHECK_MUSIC_ACTIVE,<font></font>
                   SENDMSG_REPLACE,<font></font>
                   <span class="hljs-number">0</span>,
                   <span class="hljs-number">0</span>,<font></font>
                   caller,<font></font>
                   MUSIC_ACTIVE_POLL_PERIOD_MS);<font></font>
               <span class="hljs-keyword">int</span> index = mStreamStates[AudioSystem.STREAM_MUSIC].getIndex(device);
               <span class="hljs-keyword">if</span> (AudioSystem.isStreamActive(AudioSystem.STREAM_MUSIC, <span class="hljs-number">0</span>) &amp;&amp;<font></font>
                   (index &gt; safeMediaVolumeIndex(device))) {<font></font>
                   <span class="hljs-comment">// Approximate cumulative active music time</span><font></font>
                   mMusicActiveMs += MUSIC_ACTIVE_POLL_PERIOD_MS;<font></font>
                   <span class="hljs-keyword">if</span> (mMusicActiveMs &gt; UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX) {<font></font>
                       setSafeMediaVolumeEnabled(<span class="hljs-keyword">true</span>, caller);<font></font>
                       mMusicActiveMs = <span class="hljs-number">0</span>;<font></font>
                   }<font></font>
                   saveMusicActiveMs();<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to turn off a warning</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To turn off safe listening, you need to ensure that the variable is </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assigned a value during the configuration phase </font></font><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see where the value is initially set:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onConfigureSafeVolume</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> force, String caller)</span> </span>{<font></font>
   ...<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeEnabled =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.force"</span>, <span class="hljs-keyword">false</span>)<font></font>
                   || mContext.getResources().getBoolean(<font></font>
                 com.android.internal.R.bool.config_safe_media_volume_enabled);<font></font>
<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeBypass =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.bypass"</span>, <span class="hljs-keyword">false</span>);<font></font>
<font></font>
   <span class="hljs-keyword">int</span> persistedState;
   <span class="hljs-keyword">if</span> (safeMediaVolumeEnabled &amp;&amp; !safeMediaVolumeBypass) {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_ACTIVE;<font></font>
       <span class="hljs-comment">/*  ,  mSafeMediaVolumeState   ACTIVE,  INACTIVE */</span><font></font>
...<font></font>
   } <span class="hljs-keyword">else</span> {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
       mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that in addition to the value of the resource </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, there are two properties that enable / disable the safe listening system: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.force</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To disable the warning, you need to set the value of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass = true</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">system / build.properties file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But this requires root rights. </font><font style="vertical-align: inherit;">If they are not, then you need to understand further and look for another way.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to disable warning without root</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what happens when you close the warning dialog by clicking OK, and try to reproduce this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-keyword">int</span> which)</span> </span>{<font></font>
        mAudioManager.disableSafeMediaVolume();<font></font>
    } </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><code>disableSafeMediaVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instance </font><font style="vertical-align: inherit;">method is called </font></font><code>AudioManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
* Only useful for volume controllers.
* <span class="hljs-doctag">@hide</span>
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disableSafeMediaVolume</span><span class="hljs-params">()</span> </span>{ ‚Ä¶ }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is marked with an annotation </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This means that the method will not be included in the public API despite the public modifier. </font><font style="vertical-align: inherit;">Prior to Android 9, this could easily be circumvented using reflection. </font><font style="vertical-align: inherit;">Now, however, such a method can still be called, but with the help of a trick called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">double-reflection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> audioManager = getSystemService(Context.AUDIO_SERVICE) <span class="hljs-keyword">as</span> AudioManager
<span class="hljs-keyword">val</span> getDeclaredMethod = Class::<span class="hljs-keyword">class</span>.java.getDeclaredMethod(<span class="hljs-string">"getDeclaredMethod"</span>, String::<span class="hljs-keyword">class</span>.java, arrayOf&lt;Class&lt;*&gt;&gt;()::<span class="hljs-keyword">class</span>.java)
<span class="hljs-keyword">val</span> disableSafeMediaVolumeMethod = getDeclaredMethod.invoke(AudioManager::<span class="hljs-keyword">class</span>.java, <span class="hljs-string">"disableSafeMediaVolume"</span>, arrayOf&lt;Class&lt;*&gt;&gt;()) <span class="hljs-keyword">as</span> Method<font></font>
disableSafeMediaVolumeMethod.invoke(audioManager)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The call ends with an exception. </font></font><br>
<code>java.lang.SecurityException: Only SystemUI can disable the safe media volume: Neither user 10307 nor current process has android.permission.STATUS_BAR_SERVICE.</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STATUS_BAR_SERVICE permission has protectionLevel = "signature | privileged", it will not work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, then try this. </font><font style="vertical-align: inherit;">We will monitor the variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which the current value is periodically stored </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When the value begins to approach 20 hours, we will reset it. </font><font style="vertical-align: inherit;">Then you will need to make AudioService read the new value from the settings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can </font><font style="vertical-align: inherit;">read the value </font><font style="vertical-align: inherit;">like this:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> unsafeMs = Settings.Secure.getInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Same thing using adb:</font></font><br>
<br>
<pre><code class="bash hljs"> adb shell settings get secure unsafe_volume_music_active_ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And to write the value, the application will need permission </font></font><code>android.permission.WRITE_SECURE_SETTINGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It has protectionLevel = "signature | privileged | </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", which means it can be returned to the application using adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell pm grant com.example.app android.permission.WRITE_SECURE_SETTINGS</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The value itself can be written like this:</font></font><br>
<br>
<pre><code class="kotlin hljs">Settings.Secure.putInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>
, <span class="hljs-number">1</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can do the same with adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is better to reset to 1, as is done in AudioManager, but not to 0. Since 0 corresponds to the ACTIVE state. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need AudioService to read the new value and update the value of the local variable </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a suitable method in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioManager.java</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
*  <span class="hljs-doctag">@hide</span>
*  Reload audio settings. This method is called by Settings backup
*  agent when audio settings are restored and causes the AudioService
*  to read and apply restored settings.
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reloadAudioSettings</span><span class="hljs-params">()</span> </span>{<font></font>
   ‚Ä¶<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It initiates a method call </font></font><code>readAudioSettings </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>AudioService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where the loading </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the settings </font><font style="vertical-align: inherit;">takes place </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readAudioSettings</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> userSwitch)</span> </span>{<font></font>
...<font></font>
<span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeStateLock) {<font></font>
        mMusicActiveMs = MathUtils.constrain(Settings.Secure.getIntForUser(mContentResolver,<font></font>
                Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS, <span class="hljs-number">0</span>, UserHandle.USER_CURRENT),
                <span class="hljs-number">0</span>, UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX);
        <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_ACTIVE) {<font></font>
            enforceSafeMediaVolume(TAG);<font></font>
        }<font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method is marked with annotation </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Calling it with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">double-reflection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> throws an exception: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
java.lang.SecurityException: Permission Denial: get / set setting for user asks to run as user -2 but is calling from user 0; this requires android.permission.INTERACT_ACROSS_USERS_FULL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, the annotation </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here is no accident too. Of course, we cannot obtain this permission. It has protectionLevel = "signature | installer". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There remains one way to make AudioService read the new value - restarting it. You can‚Äôt just restart the system service. You need to either reboot the device, or switch to another user, and then go back. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now is the time to test the theory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install</font></font><code>unsafe_volume_music_active_ms = 71 990 000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (10 seconds remaining, during which you can listen to music at high volume)</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 71990000</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We restart the device (you can instead switch to another user, and then return):</font></font><br>
<br>
<pre><code class="bash hljs">adb reboot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect the headphones, turn on the music louder. </font><font style="vertical-align: inherit;">A dialogue appears within a minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we repeat the same actions, but assign unsafe_volume_music_active_ms = 1. Turn on the music, wait a minute. </font><font style="vertical-align: inherit;">The dialog does not appear.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To disable the warning, you can do the following: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have root rights</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Set the value of audio.safemedia.bypass = true in the file system / build.properties </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without root rights</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You need to monitor the value </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and prevent it from rising above </font><font style="vertical-align: inherit;">72,000,000 </font><font style="vertical-align: inherit;">(20 hours ) </font><font style="vertical-align: inherit;">After resetting the value, you need to restart the device (or switch to another user, and then return back). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wrote the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code for a simple application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that does this job, and reminds me of the need to reboot the device / log in.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Device manufacturers can make changes to the platform code, and judging by the comments, some of them mitigate the default behavior. </font><font style="vertical-align: inherit;">For example, a warning may appear once, and no longer occur until the next reboot.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506852/index.html">How Signal crypto messenger successfully resists wiretapping by US authorities</a></li>
<li><a href="../en506860/index.html">June 23 - NX Analyst Meetup # 3. We will discuss interviews with customers and work with complex clients.</a></li>
<li><a href="../en506864/index.html">Upcoming Linux 5.8 Release: Million Lines of New Code and 14,000 Changes</a></li>
<li><a href="../en506866/index.html">Single Insurance Base - System for working with insurance companies</a></li>
<li><a href="../en506868/index.html">Sam Altman: Generating Ideas</a></li>
<li><a href="../en506872/index.html">Book Spring Boot 2: Best Practices for Professionals</a></li>
<li><a href="../en506874/index.html">From the life of a programmer: Business people</a></li>
<li><a href="../en506880/index.html">Joel Spolsky: how the Stack Overflow era began</a></li>
<li><a href="../en506886/index.html">Life hack for bits</a></li>
<li><a href="../en506888/index.html">Sorting cheat sheet for Data Science</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>