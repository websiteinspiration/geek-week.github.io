<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧔🏼 🚪 🚏 我们在Kubernetes中为Yandex.Cloud开发CSI驱动程序的经验 👨🏻‍🎓 👨‍🔬 🤜🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们很高兴地宣布，Flant公司将通过发布Yandex.Cloud 的CSI（容器存储接口）驱动程序的alpha版本来补充其对Kubernetes开源工具的贡献。
 
 但是，在继续实施细节之前，我们将回答一个问题，即当Yandex已经具有Kubernetes托管服务时，为什么根本需要这样做。
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>我们在Kubernetes中为Yandex.Cloud开发CSI驱动程序的经验</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/486190/"><img src="https://habrastorage.org/webt/1y/to/tn/1ytotnf73zepbwfalhzoropf9qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们很高兴地宣布，Flant公司将通过发布Yandex.Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（容器存储接口）</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">驱动程序</font></a><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">alpha版本</font></a><font style="vertical-align: inherit;">来补充其对Kubernetes开源工具的贡献</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，在继续实施细节之前，我们将回答一个问题，即当Yandex已经具有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes托管服务</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时，为什么根本需</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">要这样做</font></a><font style="vertical-align: inherit;">。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么是这样？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们公司内部，从Kubernetes投入生产的最初阶段（即几年）开始，我们正在开发自己的工具（deckhouse），顺便说一下，我们还计划在不久的将来将其作为开源项目提供。在其帮助下，我们可以统一配置和配置所有集群，目前，在铁的各种配置以及所有可用的云服务中，有超过100个集群。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用甲板室的集群具有所有必要的工作组件：平衡器，使用方便的图表进行监视，度量和警报，通过外部提供程序进行的用户身份验证以访问所有仪表板，等等。</font><font style="vertical-align: inherit;">将这样的“集聚式”群集放入托管解决方案中是没有意义的，因为这通常是不可能的，或者将导致需要禁用一半组件。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：这是我们的经验，非常具体。</font><font style="vertical-align: inherit;">我们绝不主张每个人都应该独立参与Kubernetes集群部署，而不是使用现成的解决方案。</font><font style="vertical-align: inherit;">顺便说一下，我们在使用Yandex操作Kubernetes方面没有实际经验，在本文中我们将不对该服务进行任何评估。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是什么，给谁的？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们已经讨论过Kubernetes中的现代存储方法：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSI如何</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工作</font><font style="vertical-align: inherit;">以及</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">社区如何采用</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当前，许多大型云服务提供商已经开发了驱动程序，以将其云驱动器用作Kubernetes中的持久卷。如果供应商没有这样的驱动程序，但是同时通过API提供了所有必需的功能，那么没有什么可以阻止您自己实现驱动程序。 Yandex.Cloud也是如此。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为开发的基础，我们采用了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DigitalOcean云</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">CSI驱动</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序以及GCP驱动程序</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的一些想法</font><font style="vertical-align: inherit;">，因为这些云（Google和Yandex）与API的交互具有许多相似之处。特别是API和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回一个对象，</font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以跟踪冗长的操作（例如，创建新磁盘）的状态。</font><font style="vertical-align: inherit;">为了与</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> API进行交互，使用了</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Yandex.Cloud Go SDK</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成的工作结果将</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发布在GitHub上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，对于那些出于某种原因在Yandex.Cloud虚拟机（但不是现成的托管集群）上使用自己的Kubernetes安装并希望通过CSI使用（订购）磁盘的用户来说非常有用。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实作</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要特点</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当前，驱动程序支持以下功能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 根据集群中节点的拓扑对集群所有区域中的磁盘进行排序；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 卸下先前订购的磁盘；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">磁盘的脱机大小调整（Yandex。Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不支持</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">增加虚拟机上安装的磁盘）。</font><font style="vertical-align: inherit;">有关如何修改驱动程序以尽可能轻松地调整大小，请参见下文。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来，计划实现对创建和删除快照磁盘的支持。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要困难及其克服</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Cloud API中缺乏实时扩展磁盘的能力，这使PV（持久卷）的调整大小操作变得复杂：在这种情况下，必须停止使用磁盘的应用程序的pod停止，这可能导致简单的情况。应用程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSI规范</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如果CSI控制器报告它只能“离线”调整磁盘大小（</font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），则增加磁盘的过程应如下所示：</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果该插件仅具有</font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">扩展功能，并且当前已发布该卷或该卷在某个节点上可用，则</font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">只能在以下任一情况下调用：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该插件具有控制器</font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，</font></font><code>ControllerUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已被成功调用。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要不然</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该插件不具有控制器</font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，该插件具有节点</font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，并且</font></font><code>NodeUnstageVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已成功完成。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要不然</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该插件不具有控制器</font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，也不具有节点</font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能，并且</font></font><code>NodeUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已成功完成。</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从本质上讲，这意味着需要在增加磁盘之前将磁盘与虚拟机断开连接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，不幸的是，</font><font style="vertical-align: inherit;">通过Sidecar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实施</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CSI规范不能满足以下要求：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在sidecar-container中</font></font><code>csi-attacher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，应该负责安装之间是否存在必要的间隙，该功能根本无法通过离线调整大小来实现。</font><font style="vertical-align: inherit;">关于这个的讨论已启动</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，什么是杂物箱？</font><font style="vertical-align: inherit;">CSI插件本身不与Kubernetes API交互，而仅响应sidecar容器发送给它的gRPC调用。</font><font style="vertical-align: inherit;">后者</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kubernetes社区</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">开发</font></a><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本例中（CSI插件），增加磁盘的操作如下：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们收到一个gRPC呼叫</font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们正在尝试增加API中的磁盘，但是由于磁盘已安装，因此出现无法执行操作的错误；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将磁盘标识符保存在包含您需要对其执行增加操作的磁盘的映射中。</font><font style="vertical-align: inherit;">为了简洁起见，我们将此地图称为</font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动删除使用磁盘的Pod。</font><font style="vertical-align: inherit;">Kubernetes将重新启动它。</font><font style="vertical-align: inherit;">为了使磁盘没有时间</font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在尝试进行增加操作之前先</font><font style="vertical-align: inherit;">进行挂载（</font><font style="vertical-align: inherit;">），请检查该磁盘是否仍在插入</font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并返回错误。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSI驱动程序正在尝试重新执行调整大小操作。</font><font style="vertical-align: inherit;">如果操作成功，则从</font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">删除磁盘</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因为 </font><font style="vertical-align: inherit;">缺少磁盘标识符</font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它</font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功，磁盘已安装，pod启动。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切看起来都很简单，但是一如既往地存在陷阱。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部扩展</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序涉及磁盘</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">扩展</font></a><font style="vertical-align: inherit;">，在操作过程中发生错误时，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">外部扩展程序</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用的队列</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将超时时间以指数方式增加，最长可达1000秒：</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DefaultControllerRateLimiter</span><span class="hljs-params">()</span> <span class="hljs-title">RateLimiter</span></span> {
  <span class="hljs-keyword">return</span> NewMaxOfRateLimiter(<font></font>
  NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">1000</span>*time.Second),
  <span class="hljs-comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
  &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(<span class="hljs-number">10</span>), <span class="hljs-number">100</span>)},<font></font>
  )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这可能会周期性地导致增加磁盘的操作被拉伸15分钟以上，从而导致相应的容器无法访问。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使我们能够轻松而轻松地减少潜在停机时间的唯一选择是使用我们的外部调整器版本，最大超时限制为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5秒</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
 <br>
<pre><code class="go hljs">workqueue.NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">5</span>*time.Second)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们认为没有必要紧急启动讨论并修补外部调整大小，因为离线调整磁盘大小是一种愚蠢的做法，很快就会从所有云提供商中消失。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何开始使用？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes 1.15及更高版本中支持该驱动程序。</font><font style="vertical-align: inherit;">为了使驾驶员正常工作，必须满足以下要求：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该标志</font></font><code>--allow-privileged</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置</font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为API服务器和kubelet </font><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含</font></font><code>--feature-gates=VolumeSnapshotDataSource=true,KubeletPluginsWatcher=true,CSINodeInfo=true,CSIDriverRegistry=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于API服务器和kubelet；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传播安装（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装传播</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）应包含在群集中。</font><font style="vertical-align: inherit;">使用Docker时，必须配置守护程序，以便允许共享安装。</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">README</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
中</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">描述</font></a><font style="vertical-align: inherit;">了安装本身的所有必要步骤</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">安装是从清单中在Kubernetes中创建对象。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使驱动程序正常工作，您将需要以下内容：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在清单中指示Yandex.Cloud目录目录（</font></font><code>folder-id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">的标识符</font><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请参阅文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了与CSI驱动程序中的Yandex.Cloud API交互，使用了一个服务帐户。</font><font style="vertical-align: inherit;">在“秘密”清单中，您必须将</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">授权密钥</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传递</font><font style="vertical-align: inherit;">给服务帐户。</font><font style="vertical-align: inherit;">该文档</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍了</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何创建服务帐户并获取密钥。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，请</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尝试一下</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">如果您遇到任何问题</font><font style="vertical-align: inherit;">，我们将很高兴收到反馈和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进一步的支持</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们想指出的是，实现此CSI驱动程序并不是出于在Go上编写应用程序的乐趣，而是因为公司内部的迫切需求。</font><font style="vertical-align: inherit;">似乎不建议支持我们自己的实现，因此，如果Yandex表示兴趣并决定继续支持驱动程序，我们将很乐意将存储库移交给他们使用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，也许Kubernetes托管集群中的Yandex具有自己的CSI驱动程序实现，可以在开源中发布。</font><font style="vertical-align: inherit;">此开发选项对我们似乎也很有利-社区将能够使用服务提供商而不是第三方公司提供的可靠驱动程序。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另请参阅我们的博客：</font></font><br>
<br>
<ul>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> Kubernetes CCM (Cloud Controller Manager)  .</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     Kubernetes:  Flexvolume  CSI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> Container Storage Interface ( Kubernetes   )</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> Kubernetes-   ?  addon-operator</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">   Kubernetes (   )</a>».</li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN486190/">https://habr.com/ru/post/zh-CN486190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN486178/index.html">FOSS新闻1-2020年1月27日至2月2日免费和开源新闻的回顾</a></li>
<li><a href="../zh-CN486180/index.html">创建无服务器应用程序的提示和资源</a></li>
<li><a href="../zh-CN486184/index.html">如何有效使用搜索</a></li>
<li><a href="../zh-CN486186/index.html">灾难性云：如何工作</a></li>
<li><a href="../zh-CN486188/index.html">PostgreSQL Wal-g备份系统介绍</a></li>
<li><a href="../zh-CN486192/index.html">网络欺诈者入侵移动运营商以获取订户的电话号码</a></li>
<li><a href="../zh-CN486194/index.html">关于Proxmox VE中的备份</a></li>
<li><a href="../zh-CN486198/index.html">说话很难。与非程序员交流的论文</a></li>
<li><a href="../zh-CN486200/index.html">Docker技巧：清除垃圾邮件</a></li>
<li><a href="../zh-CN486202/index.html">Alpine在Python下收集Docker构建的速度慢了50倍，而镜像则重了2倍</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>