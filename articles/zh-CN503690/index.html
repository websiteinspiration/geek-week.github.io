<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍💻 🏈 👨‍🏭 Kubernetes最佳实践 Kubernetes零停机集群升级 📛 👇 🤜🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes最佳实践创建小型容器
 Kubernetes最佳实践。具有Kubernetes 
 最佳实践命名空间的Kubernetes组织。 Kubernetes可行性测试与就绪性和活力测试Kubernetes 
 最佳实践。设置查询和资源限制
 Kubernetes最佳实践。正确终止
 禁...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes最佳实践 Kubernetes零停机集群升级</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/503690/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes最佳实践创建小型容器</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes最佳实践。具有Kubernetes </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最佳实践命名空间的</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Kubernetes组织</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">。 Kubernetes可行性测试与就绪性和活力测试Kubernetes </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最佳实践。设置查询和资源限制</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes最佳实践。正确终止</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">禁用Kubernetes最佳实践。映射外部服务</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
每个人都知道使您的应用程序保持最新是多么的好。 Kubernetes和Docker可以简化升级过程，因此您可以创建具有更新依赖关系的新容器并轻松部署它。除了更新应用程序依赖关系外，Kubernetes还在不断更新功能和安全策略。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，Kubernetes的基本节点和基础结构必须是最新的。在本系列中，我们将学习Google Kubernetes Engine如何轻松升级Kubernetes集群。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在更新集群时，您需要更新向导和节点，并且必须先更新向导。让我们看看如何使用Google Kubernetes Engine更新两个元素。该系统在发布点版本时自动更新向导。但是，通常，它不会自动更新到新版本，例如1.7-1.8。当您准备升级到新版本时，只需在GKE控制台中单击“升级可用”链接，然后在屏幕上将出现一个对话框。它包含警告，更改主版本可能需要几分钟，在此期间您无法编辑此群集，而在升级向导期间，您的部署和服务将继续正常运行。但是，需要Kubernetes API的整个基础架构将无法正常工作。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o1/q5/uo/o1q5uoo8kjqvi9jrgezw2pvmrwo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这意味着QPTL和所有使用Kubernetes API获取集群信息的应用程序将被禁用，并且您将无法对集群进行任何更改。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看如何通过零停机时间更新向导来解决此问题。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6m/un/uc/6munuchpuwh-8_1be6o0bjvdlsm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
虽然标准GKE区域群集仅支持一个向导，但是您可以创建提供多区域高可用性向导的区域群集。因此，在创建集群时，请确保选择区域选项。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您的节点和向导将在三个区域中自动创建，并且向导将具有负载平衡的IP地址。这将使Kubernetes API在升级过程中保持平稳运行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新节点时，可以使用几种不同的策略。我想将您的注意力集中在两件事上-滚动滚动更新和使用节点池的迁移。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新Kubernetes节点最简单的方法是使用滚动更新，滚动更新是GKE用于更新节点的默认更新机制。它的工作原理如下。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yu/hy/af/yuhyafeiliwyv-mhlkiu9mdpbti.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
旧版本的节点陆续停用，以便所有模块都无法在其中运行。然后，这些节点被删除，而不是它们，更新的Kubernetes版本的新节点一个接一个地出现。一个节点开始工作后，另一节点继续进行更新过程，此过程一直持续到所有节点都更新为止。您可以通过选择“启用”来启用节点池中节点的自动更新，以让GKE为您管理此过程。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2w/jz/vy/2wjzvyfqeymrrmhtabzv4fwu85k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果不这样做，则在有新更新可用时，GKE仪表板会警告您。在这种情况下，要执行更新，您需要单击自动节点更新链接，然后按照说明进行操作。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/an/_z/zian_zvgqnwnsetfizdgguuh2pw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，确保使用副本集，有状态集或类似集合控制您的Pod非常重要。这样，自主炉床将不会进行重组。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管使用GKE进行滚动更新非常容易，但仍存在一些缺点。其中之一是，升级时，群集的容量将减少一个节点。通过添加额外的容量并在更新后减少它来扩展节点池，可以轻松消除此缺点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，滚动更新的完全自动化特性使更新变得更容易，但使您对流程的控制较少。如果出了点问题，您必须回滚到旧版本，这将花费一些时间来停止滚动更新并放弃已进行的任何更改。让我们看看如何使用来自多个节点的池来升级集群。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dl/rv/wo/dlrvwo1wdrdhzsggce76vokdonu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，无需使用滚动更新来更新活动的节点池，而是创建一个全新的节点池，等待所有节点启动，然后一次转移一个节点的工作负载。当您自己执行这些命令时，您将获得对迁移过程的更多控制，而GKE继续管理您的节点。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设Kubernetes集群包含3个虚拟机。您可以使用get nodes命令查看节点。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xe/z2/r4/xez2r4j71qjxvmvviw0-af-7q5o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要创建名为pool-two的新节点池，您需要使用适当的命令，并将其设置方式与旧池的命令完全相同。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mw/me/kl/mwmeklsu7fc4l-zudw9f4a7is2m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（可选）您也可以使用GUI创建新的节点池。有关此的更多信息，请使用此视频下方的“节点池创建”链接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果再次检查节点数，则会找到三个具有两个池名称的新节点，但是，吊舱仍将位于旧节点上。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v8/nb/rm/v8nbrmgfnwaddhn2fn0_wlrba9e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们将它们移动到新的节点池中，以滚动模式一次移动一个节点。为此，对每个旧节点使用cordon命令来保护它们并防止在其中形成新的炉膛。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v0/iq/5a/v0iq5azeontfui94okav_lgacra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一旦所有旧节点都被隔离，将仅在新节点中规划炉床的创建。这意味着您可以开始从旧节点中删除Pod，Kubernetes将自动计划在新节点中创建它们。然后，您需要“排水”每个节点，这将导致节点中所有炉床的移除。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/y7/yb/qyy7ybf-b05k7t28ludwpluo5f0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在一个节点上执行此操作之后，请确保新的Pod已准备就绪并且已经可以工作，然后继续进行下一个节点。如果在迁移过程中遇到任何问题，请对旧池运行uncordon，然后对新池运行警戒线和排水装置。在这种情况下，豆荚将自动转移回旧池。一旦安全地传输了所有的Pod，就可以删除旧池。为此，将默认池替换为要删除的池。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n_/vx/f8/n_vxf83r2fw4skngg1ijihr25ly.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
借助Google Kubernetes引擎，只需单击几下，即可使Kubernetes集群保持最新。我强烈建议对高可用性向导和自动节点更新使用GKE区域群集，以确保正确且无故障的更新。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您需要对节点更新过程的其他控制，则可以在池的帮助下为其提供控制，而不必放弃GKE提供的管理平台的优势。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果未使用GKE，则使用滚动更新滚动方法或节点池节点来更新群集的节点。</font><font style="vertical-align: inherit;">但是请记住，在这种情况下，您需要手动将新节点添加到集群并亲自执行关键更新，这可能并不十分简单。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
即将继续...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/fvpq4jqtuZ8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一点广告：）</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感谢您与我们在一起。你喜欢我们的文章吗？想看更多有趣的资料吗？通过下订单或向您的朋友推荐给</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开发人员的基于云的VPS，</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">最低</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">价格为4.99美元</font></a><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是我们为您发明的入门级服务器</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><b><font style="vertical-align: inherit;">独特类似物：</font></b></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于VPS（KVM）E5-2697 v3（6核）的全部真相10GB DDR4 480GB SSD 1Gbps从$ 19还是如何划分服务器？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（RAID1和RAID10提供选件，最多24个内核和最大40GB DDR4）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">阿姆斯特丹的Equinix Tier IV数据中心的戴尔R730xd便宜2倍吗？</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅</font><b><font style="vertical-align: inherit;">在荷兰</font></b><font style="vertical-align: inherit;">有</font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2台Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100电视</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">戴尔R420-2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB-$ 99起！</font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">阅读有关</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何构建基础设施大厦的信息。</font><font style="vertical-align: inherit;">使用Dell R730xd E5-2650 v4服务器花费一欧元9000欧元的c类？</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503676/index.html">极客骄傲日的三个极客项目</a></li>
<li><a href="../zh-CN503678/index.html">Vuex破坏封装</a></li>
<li><a href="../zh-CN503680/index.html">DBA：追求飞锁</a></li>
<li><a href="../zh-CN503682/index.html">Snom交换A到Z</a></li>
<li><a href="../zh-CN503688/index.html">乔尔·斯波斯基（Joel Spolsky）：成为软件开发人员意味着什么（从编码人员到开发人员的序言）</a></li>
<li><a href="../zh-CN503696/index.html">战争机器：当机械模拟计算机统治大海时</a></li>
<li><a href="../zh-CN503698/index.html">远程记帐-作为业务收益</a></li>
<li><a href="../zh-CN503700/index.html">在2020年创建React表单</a></li>
<li><a href="../zh-CN503702/index.html">在实践中使用Google Analytics（分析）中的原始数据</a></li>
<li><a href="../zh-CN503704/index.html">无需启动100个应用程序-只需进行一次自动测试，或如何挽救质量检查工程师20年的生命</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>