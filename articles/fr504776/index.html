<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛀🏾 ❓ 🎅🏼 Écrire un moteur de jeu dès votre première année: facile! (Presque) 👔 🈴 🚬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Je m'appelle Gleb Maryin, je suis en première année de premier cycle "Mathématiques appliquées et informatique" au HSE de Saint-Pétersbourg. Au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Écrire un moteur de jeu dès votre première année: facile! (Presque)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/hsespb/blog/504776/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! </font><font style="vertical-align: inherit;">Je m'appelle Gleb Maryin, je suis en première année de premier cycle "Mathématiques appliquées et informatique" au HSE de Saint-Pétersbourg. </font><font style="vertical-align: inherit;">Au deuxième semestre, tous les étudiants de première année de notre programme font des projets d'équipe en C ++. </font><font style="vertical-align: inherit;">Mes coéquipiers et moi avons décidé d'écrire un moteur de jeu.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez ce que nous obtenons sous le chat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes trois dans l'équipe: moi, Alexei Luchinin et Ilya Onofriychuk. </font><font style="vertical-align: inherit;">Aucun de nous n'est expert en développement de jeux, encore moins en création de moteurs de jeux. </font><font style="vertical-align: inherit;">Il s'agit du premier grand projet pour nous: avant cela, nous ne faisions que des devoirs et des travaux de laboratoire, il est donc peu probable que les professionnels du domaine de l'infographie trouvent par eux-mêmes de nouvelles informations. </font><font style="vertical-align: inherit;">Nous serons heureux si nos idées aident ceux qui veulent également créer leur propre moteur. </font><font style="vertical-align: inherit;">Mais ce sujet est complexe et multiforme, et l'article ne prétend en aucun cas être une littérature spécialisée complète. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous ceux qui souhaitent en savoir plus sur notre mise en œuvre - bonne lecture!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arts graphiques</font></font></h1><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Première fenêtre, souris et clavier</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour créer des fenêtres, gérer la saisie de la souris et du clavier, nous avons choisi la bibliothèque SDL2. </font><font style="vertical-align: inherit;">C'était un choix aléatoire, mais jusqu'à présent nous ne l'avons pas regretté.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il était important au tout premier stade d'écrire un wrapper pratique sur la bibliothèque afin que vous puissiez créer une fenêtre avec quelques lignes, faire des manipulations avec comme déplacer le curseur et entrer en mode plein écran et gérer les événements: frappes, mouvements du curseur. </font><font style="vertical-align: inherit;">La tâche n'a pas été difficile: nous avons rapidement créé un programme qui permet de fermer et d'ouvrir une fenêtre, et lorsque vous cliquez sur RMB, affichez «Bonjour tout le monde!».&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis le cycle de jeu principal est apparu:</font></font><br>
<br>
<pre><code class="cpp hljs">Event ev;
<span class="hljs-keyword">bool</span> running = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">while</span> (running):<font></font>
	ev = pullEvent();<font></font>
	<span class="hljs-keyword">for</span> handler in handlers[ev.type]:<font></font>
		handler.handleEvent(ev);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque gestionnaire d'événements attaché - </font></font><code>handlers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exemple </font></font><code>handlers[QUIT] = {QuitHandler()}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Leur tâche consiste à gérer l'événement correspondant. </font></font><code>QuitHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans l'exemple, il exposera </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, arrêtant ainsi le jeu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour le monde</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour dessiner dans le moteur que nous utilisons </font></font><code>OpenGL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le premier </font></font><code>Hello World</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comme je pense, dans de nombreux projets, était un carré blanc sur fond noir:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">glBegin(GL_QUADS);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glEnd();</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/612/ed8/fbe/612ed8fbe433abd35b12b59e72aac0c7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons appris à dessiner un polygone à deux dimensions et réalisé les figures dans une classe distincte </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui peut tourner avec </font></font><code>glRotate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se déplacer avec </font></font><code>glTranslate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et s'étirer avec </font></font><code>glScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous définissons la couleur sur quatre canaux en utilisant </font></font><code>glColor4f(r, g, b, a)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette fonctionnalité, vous pouvez déjà faire une belle fontaine de carrés. </font><font style="vertical-align: inherit;">Créez une classe </font></font><code>ParticleSystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui possède un tableau d'objets. </font><font style="vertical-align: inherit;">À chaque itération de la boucle principale, le système de particules met à jour les anciens carrés et en recueille de nouveaux qu'il démarre dans une direction aléatoire:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caméra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étape suivante consistait à écrire une caméra capable de se déplacer et de regarder dans différentes directions. </font><font style="vertical-align: inherit;">Pour comprendre comment résoudre ce problème, nous avions besoin de connaissances en algèbre linéaire. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si ce n'est pas très intéressant pour vous, vous pouvez ignorer la section, voir le gif et continuer la lecture</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulons dessiner un sommet dans les coordonnées de l'écran, connaissant ses coordonnées par rapport au centre de l'objet auquel il appartient.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, nous devons trouver ses coordonnées par rapport au centre du monde dans lequel se trouve l'objet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puis, connaissant les coordonnées et l'emplacement de la caméra, trouvez la position du sommet dans la base de la caméra.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projetez ensuite le sommet sur le plan de l'écran.&nbsp;</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, il y a trois étapes. </font><font style="vertical-align: inherit;">La multiplication par trois matrices leur correspond. </font><font style="vertical-align: inherit;">Nous avons appelé ces matrices </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par obtenir les coordonnées de l'objet dans la base du monde. </font><font style="vertical-align: inherit;">Trois transformations peuvent être effectuées avec un objet: redimensionner, faire pivoter et déplacer. </font><font style="vertical-align: inherit;">Toutes ces opérations sont spécifiées en multipliant le vecteur d'origine (coordonnées dans la base de l'objet) par les matrices correspondantes. </font><font style="vertical-align: inherit;">Ensuite, la matrice </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ressemblera à ceci:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">Model = Translate * Scale * Rotate. 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, connaissant la position de la caméra, nous voulons déterminer les coordonnées dans sa base: multiplier les coordonnées précédemment obtenues par la matrice </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En C ++, cela est facilement calculé à l'aide de la fonction:</font></font><br>
<br>
<pre><code class="cpp hljs">
glm::mat4 View = glm::lookAt(cameraPosition, objectPosition, up);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Littéralement: regardez </font></font><code>objectPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'une position </font></font><code>cameraPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et la direction vers le haut est «vers le haut». Pourquoi cette direction est-elle nécessaire? Imaginez prendre une photo d'une bouilloire. Vous pointez la caméra vers lui et placez la bouilloire dans le cadre. À ce stade, vous pouvez dire exactement où le cadre est en haut (très probablement là où la bouilloire a un couvercle). Le programme ne peut pas comprendre comment organiser le cadre, et c'est pourquoi le vecteur "up" doit être spécifié. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons obtenu les coordonnées dans la base de la caméra, il reste à projeter les coordonnées obtenues sur le plan de la caméra. La matrice est engagée dans cela </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">ce </font><font style="vertical-align: inherit;">qui crée l'effet de réduire l'objet lorsqu'il est retiré de nous.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir les coordonnées du sommet à l'écran, vous devez multiplier le vecteur par la matrice au moins cinq fois. </font><font style="vertical-align: inherit;">Toutes les matrices ont une taille de 4 par 4, vous devez donc effectuer plusieurs opérations de multiplication. </font><font style="vertical-align: inherit;">Nous ne voulons pas charger des cœurs de processeur avec beaucoup de tâches simples. </font><font style="vertical-align: inherit;">Pour cela, une carte vidéo disposant des ressources nécessaires est préférable. </font><font style="vertical-align: inherit;">Donc, vous devez écrire un shader: une petite instruction pour une carte vidéo. </font><font style="vertical-align: inherit;">OpenGL a un langage de shader GLSL spécial, similaire à C, qui nous aidera à le faire. </font><font style="vertical-align: inherit;">N'entrons pas dans les détails de l'écriture d'un shader, il vaut mieux regarder enfin ce qui s'est passé:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/9f3/3cd/6c09f33cd1fb76ea4446b1c4a79f056a.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explication: Il y a dix carrés qui sont distants l'un de l'autre. </font><font style="vertical-align: inherit;">Sur le côté droit d'eux est un joueur qui tourne et déplace la caméra.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La physique</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce qu'un jeu sans physique? Pour gérer l'interaction physique, nous avons décidé d'utiliser la bibliothèque Box2d et avons créé une classe </font></font><code>WorldObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">héritée de </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Malheureusement, Box2d n'a pas fonctionné hors de la boîte, donc le courageux Ilya a écrit un wrapper pour b2Body et toutes les connexions physiques qui se trouvent dans cette bibliothèque.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fa/68a/807/1fa68a80750c650cb3d3f947a6f58d54.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jusqu'à ce moment, nous avons pensé à rendre les graphismes du moteur absolument bidimensionnels, et pour l'éclairage, si nous décidons de l'ajouter, utilisez la technique du raycasting. </font><font style="vertical-align: inherit;">Mais nous avions en main un magnifique appareil photo qui peut afficher des objets dans les trois dimensions. </font><font style="vertical-align: inherit;">Par conséquent, nous avons ajouté de l'épaisseur à tous les objets bidimensionnels - pourquoi pas? </font><font style="vertical-align: inherit;">De plus, à l'avenir, cela vous permettra de faire un très bel éclairage qui laissera des ombres d'objets épais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'éclairage est apparu entre les cas. </font><font style="vertical-align: inherit;">Pour le créer, il était nécessaire d'écrire les instructions appropriées pour dessiner chaque pixel - un fragment shader.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/faf/f88/460faff88bbc07d7b466c0c9d7a12f4b.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Textures</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons utilisé la bibliothèque DevIL pour télécharger des images. </font><font style="vertical-align: inherit;">Chacun </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est devenu en forme une instance de la classe </font></font><code>GraphicalPolygon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- la partie avant de l'objet - et </font></font><code>GraphicalEdge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- la partie latérale. </font><font style="vertical-align: inherit;">Sur chacun, vous pouvez étirer votre texture. </font><font style="vertical-align: inherit;">Premier résultat:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8db/847/a6f/8db847a6fddf768afc0cd175a7368b98.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout ce qui est requis des graphiques est prêt: dessin, une seule source lumineuse et texture. </font><font style="vertical-align: inherit;">Graphiques - c'est tout pour l'instant.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State machine, définition du comportement des objets</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque objet, quel qu'il soit - un état dans la machine à états, graphique ou physique - doit être "ticking", c'est-à-dire que chaque itération de la boucle de jeu est mise à jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les objets pouvant être mis à jour sont hérités de la classe de comportement que nous avons créée. Il dispose de fonctions </font></font><code>onStart, onActive, onStop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui vous permettent de passer outre le comportement de l'héritier au démarrage, pendant la vie et à la fin de son activité. Maintenant, nous devons créer un objet suprême </font></font><code>Activity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui appelle ces fonctions à partir de tous les objets. La fonction de boucle qui le fait est la suivante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>:
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title">onAwake</span><span class="hljs-params">()</span></span>;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;awake = <span class="hljs-literal">true</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (awake):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStart();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;running = <span class="hljs-literal">true</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (running):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onActive();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStop();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;onDestroy();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'instant </font></font><code>running == true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, quelqu'un peut appeler une fonction </font></font><code>pause()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui le fait </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si quelqu'un appelle </font></font><code>kill()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis </font></font><code>awake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et </font></font><code>running</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tournez-vous vers l' </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activité et arrêtez-vous complètement. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problème:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous voulons mettre en pause un groupe d'objets, par exemple, un système de particules et de particules à l'intérieur. Dans l'état actuel, vous devez appeler manuellement </font></font><code>onPause</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour chaque objet, ce qui n'est pas très pratique. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le </font><font style="vertical-align: inherit;">monde </font><font style="vertical-align: inherit;">aura un tableau </font></font><code>subBehaviors</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'il mettra à jour, c'est-à-dire:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onStart</span><span class="hljs-params">()</span> 		<span class="hljs-comment">//     </span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onStart</span><span class="hljs-params">()</span>	<span class="hljs-comment">//       Behavior</span>
<span class="hljs-keyword">void</span> <span class="hljs-title">onActive</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onActive</span><span class="hljs-params">()</span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onActive</span><span class="hljs-params">()</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ainsi de suite, pour chaque fonction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais tous les comportements ne peuvent pas être définis de cette manière. Par exemple, si un ennemi marche sur une plate-forme - ennemi, alors il a très probablement des états différents: il est debout - </font></font><code>idle_stay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il marche sur une plate-forme sans nous remarquer - </font></font><code>idle_walk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et à tout moment il peut nous remarquer et entrer dans un état d'attaque - </font></font><code>attack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Je veux également définir commodément les conditions de la transition entre les États, par exemple:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">isTransitionActivated</span><span class="hljs-params">()</span>: 		<span class="hljs-comment">//  idle_walk-&gt;attack</span>
	<span class="hljs-keyword">return</span> <span class="hljs-title">canSee</span><span class="hljs-params">(enemy)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le modèle souhaité est une machine d'état. </font><font style="vertical-align: inherit;">Nous avons également fait d'elle l'héritière </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car à chaque tick il faut vérifier si le moment est venu de changer d'état. </font><font style="vertical-align: inherit;">Ceci est utile non seulement pour les objets du jeu. </font><font style="vertical-align: inherit;">Par exemple, </font></font><code>Level</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il s'agit d'un état </font></font><code>Level Switcher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les transitions à l'intérieur de la machine du contrôleur sont des conditions pour changer de niveau dans le jeu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'État a trois étapes: il a commencé, il tourne, il s'est arrêté. </font><font style="vertical-align: inherit;">Vous pouvez ajouter des actions à chaque étape, par exemple, attacher une texture à un objet, lui appliquer une impulsion, définir la vitesse, etc.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Préservation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En créant un niveau dans l'éditeur, je veux pouvoir le sauvegarder, et le jeu lui-même devrait pouvoir charger le niveau à partir des données enregistrées. Par conséquent, tous les objets qui doivent être enregistrés sont hérités de la classe </font></font><code>NamedStoredObject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il stocke une chaîne avec le nom, le nom de classe et possède une fonction </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui transfère les données sur un objet dans une chaîne.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour effectuer une sauvegarde, il reste simplement à remplacer </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour chaque objet. Le chargement est un constructeur à partir d'une chaîne contenant toutes les informations sur l'objet. Le téléchargement est terminé lorsqu'un tel constructeur est créé pour chaque objet.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le jeu et l'éditeur sont presque la même classe, seulement dans le jeu le niveau est chargé en mode lecture et dans l'éditeur en mode enregistrement. Le moteur utilise la bibliothèque rapidjson pour écrire et lire des objets à partir de json.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À un moment donné, la question s'est posée à nous: que les graphiques, la machine d'état et tout le reste soient écrits. </font><font style="vertical-align: inherit;">Comment un utilisateur peut-il écrire un jeu en utilisant cela?&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la version originale, il devrait hériter </font></font><code>Game2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et remplacer </font></font><code>onActive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et créer des objets dans les champs de la classe. </font><font style="vertical-align: inherit;">Mais pendant la création, il ne peut pas voir ce qu'il crée, et il devrait également compiler son programme et se connecter à notre bibliothèque. </font><font style="vertical-align: inherit;">Horreur! </font><font style="vertical-align: inherit;">Il y aurait des avantages - on pourrait demander des comportements si complexes qu'on aurait pu imaginer: par exemple, déplacer le bloc de terre autant que la vie du joueur, et cela à condition qu'Uranus soit dans la constellation du Taureau et que l'euro ne dépasse pas 40 roubles. </font><font style="vertical-align: inherit;">Cependant, nous avons quand même décidé de faire une interface graphique.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'interface graphique, le nombre d'actions pouvant être effectuées avec un objet sera limité: parcourir la diapositive d'animation, appliquer une force, définir une certaine vitesse, etc. Même situation avec les transitions dans la machine d'état. Dans les gros moteurs, le problème d'un nombre limité d'actions est résolu en liant le programme actuel à un autre - par exemple, Unity et Godot utilisent la liaison avec C #. Déjà à partir de ce script, vous pouvez tout faire: et voir dans quelle constellation Uranus, et quel est le taux de change de l'euro actuel. Nous n'avons pas de telles fonctionnalités pour le moment, mais nos plans incluent la connexion du moteur avec Python 3.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour implémenter l'interface graphique, nous avons décidé d'utiliser Dear ImGui, car il est très petit (par rapport au Qt bien connu) et écrire dessus est très simple. </font><font style="vertical-align: inherit;">ImGui - le paradigme de la création d'une interface graphique. </font><font style="vertical-align: inherit;">Dans celui-ci, à chaque itération de la boucle principale, tous les widgets et fenêtres sont redessinés uniquement si nécessaire. </font><font style="vertical-align: inherit;">D'une part, cela réduit la quantité de mémoire consommée, mais d'autre part, cela prend très probablement plus d'une exécution de la fonction complexe de création et d'enregistrement des informations nécessaires pour le dessin ultérieur. </font><font style="vertical-align: inherit;">Il ne reste plus qu'à implémenter les interfaces de création et d'édition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici à quoi ressemble l'interface graphique au moment de la publication:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09a/e87/f8e/09ae87f8eea964d382f07b411991d6d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éditeur de niveau</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93b/b2e/1bd/93bb2e1bd41ab656341a78fd3dd04102.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éditeur de machine d'état</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons créé uniquement la base sur laquelle vous pouvez accrocher quelque chose de plus intéressant. En d'autres termes, il y a de la place pour la croissance: vous pouvez implémenter le rendu d'ombre, la possibilité de créer plus d'une source lumineuse, vous pouvez connecter le moteur avec l'interpréteur Python 3 pour écrire des scripts pour le jeu. Je voudrais affiner l'interface: la rendre plus belle, ajouter plus d'objets différents, prendre en charge les touches de raccourci ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a encore beaucoup de travail, mais nous sommes satisfaits de ce que nous avons en ce moment.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la création du projet, nous avons acquis de nombreuses expériences diverses: travailler avec des graphiques, créer des interfaces graphiques, travailler avec des fichiers json, wrappers de nombreuses bibliothèques C. Et aussi l'expérience d'écrire le premier grand projet en équipe. Nous espérons avoir pu en parler aussi intéressant qu'intéressant de le traiter :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lien vers le projet </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">gihab</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Glebanister/ample</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504766/index.html">Comment nous avons visité l'usine métallurgique d'Asha</a></li>
<li><a href="../fr504768/index.html">Stage d'analyste à Yandex: analyse des tâches de test</a></li>
<li><a href="../fr504770/index.html">Distributions de jeux Linux</a></li>
<li><a href="../fr504772/index.html">Événements numériques à Moscou du 1er au 7 juin</a></li>
<li><a href="../fr504774/index.html">Sondage auprès des responsables informatiques sur l'évolution des besoins en services informatiques</a></li>
<li><a href="../fr504780/index.html">NSA, Ghidra et licornes</a></li>
<li><a href="../fr504784/index.html">Le certificat racine AddTrust de Sectigo a expiré le 30 mai 2020, ce qui a provoqué des problèmes dans les clients OpenSSL 1.0.x et GnuTLS</a></li>
<li><a href="../fr504786/index.html">Tout ce que vous devez savoir sur la mise en cache</a></li>
<li><a href="../fr504790/index.html">Une sélection d'articles sur l'apprentissage automatique: cas, guides et études pour mai 2020</a></li>
<li><a href="../fr504792/index.html">Pensionnat de service. Comment NSPK a sauvé sa salle de travail d'un coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>