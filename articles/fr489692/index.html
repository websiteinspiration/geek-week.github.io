<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏾 🖥️ 👩‍👦 Utilisation de RabbitMQ avec MonsterMQ Partie 3 🍕 ⏩ 🧕🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans notre article précédent, nous avons créé une file d'attente de tâches. Il suppose qu'une tâche sous la forme d'un message est remise à un destina...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Utilisation de RabbitMQ avec MonsterMQ Partie 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489692/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans notre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article précédent,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons créé une file d'attente de tâches. </font><font style="vertical-align: inherit;">Il suppose qu'une tâche sous la forme d'un message est remise à un destinataire. </font><font style="vertical-align: inherit;">Dans cet article, nous ferons autre chose, nous enverrons un message à plusieurs destinataires à la fois. </font><font style="vertical-align: inherit;">Nous allons créer un système d'enregistrement qui se composera de deux programmes: le premier enverra des messages, et le second les recevra et les affichera. </font><font style="vertical-align: inherit;">Dans notre système, tous les destinataires en cours d'exécution recevront un message envoyé par l'expéditeur.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échanges (échangeurs)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les articles précédents, nous avons envoyé et reçu des messages de files d'attente, il est maintenant temps d'introduire un modèle complet de transfert de messages dans RabbitMQ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons rapidement en revue ce que nous avons couvert dans les articles précédents:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Producteur - une application qui envoie des messages </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File d'attente - un tampon qui stocke les messages </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consumer - une application qui reçoit et traite les messages </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'idée clé de RabbitMQ (ou plutôt AMQP) est que l'expéditeur (producteur) n'envoie jamais de message directement à la file d'attente. </font><font style="vertical-align: inherit;">De plus, il ne sait même pas s'il est dans la file d'attente. </font><font style="vertical-align: inherit;">Au lieu de cela, l'expéditeur envoie des messages aux échangeurs (Exchange). </font><font style="vertical-align: inherit;">L'échangeur est une chose très simple, il fait deux choses: il reçoit un message des expéditeurs et les redirige vers la file d'attente. </font><font style="vertical-align: inherit;">Les échangeurs sont de différents types: certains envoient des messages à une file d'attente spécifique (type direct), d'autres envoient le même message à plusieurs files d'attente à la fois (type fanout), d'autres redirigent les messages vers la file d'attente en fonction de règles de redirection spécifiques et spécifiées (type de rubrique). </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/1bd/dc5/c2d/1bddc5c2d6aa4b26ba0f675162aaecf7.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(image tirée du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site officiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">RabbitMQ</font></a><font style="vertical-align: inherit;"> )</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons un échangeur de type fanout. </font><font style="vertical-align: inherit;">Pour le créer, écrivez le code suivant:</font></font><br>
<br>
<pre><code class="php hljs">$producer-&gt;newFanoutExchange(<span class="hljs-string">'logs'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'échangeur Fanout fonctionne selon un schéma très simple, il envoie simplement le message reçu à toutes les files d'attente qui lui sont attachées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour répertorier tous les échangeurs existants sur le serveur, appelez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rabbitmqctl</font></font></b><br>
<br>
<pre><code class="bash hljs">sudo rabbitmqctl list_exchanges</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette liste </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiendra amq. *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Échangeurs et un échangeur standard sans nom (ligne vide). Ne faites pas attention à eux, nous n'en avons pas encore besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le dernier article, nous ne savions rien des échangeurs, mais nous avons néanmoins pu envoyer des messages. Cela s'est produit car si dans MonsterMQ vous ne spécifiez pas explicitement l'échangeur comme troisième argument de la méthode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Producer :: publish ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la </font><font style="vertical-align: inherit;">bibliothèque utilisera l'échangeur sans nom standard RabbitMQ, qui envoie des messages dans des files d'attente dont les noms sont passés en tant que deuxième argument à la méthode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Producer :: publish ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons maintenant envoyer des messages à notre nouvel échangeur en spécifiant son nom comme troisième argument de la méthode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Producer :: publish ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="php hljs">$producer-&gt;publish($message, <span class="hljs-string">''</span>, <span class="hljs-string">'logs'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créons maintenant deux travailleurs avec deux files d'attente qui existeront tant que les travailleurs qui les auront annoncés seront actifs. </font><font style="vertical-align: inherit;">Vous pouvez le faire comme suit:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">//Worker 1</span>
$producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;setExclusive()-&gt;declare();
</code></pre><br>
<pre><code class="php hljs"><span class="hljs-comment">//Worker 2</span>
$producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;setExclusive()-&gt;declare();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Désormais, lorsque le travailleur qui a annoncé la file d'attente met fin à la session et se déconnecte, elle sera automatiquement supprimée. </font><font style="vertical-align: inherit;">Si les deux employés terminent leur travail, les deux files d'attente seront supprimées.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous connectons la file d'attente avec l'échangeur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons déjà créé un échange et une file d'attente. </font><font style="vertical-align: inherit;">Il ne nous reste plus qu'à demander à l'échangeur d'envoyer les messages reçus à nos files d'attente. </font><font style="vertical-align: inherit;">Nous devons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lier l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> échangeur et les files d'attente. </font><font style="vertical-align: inherit;">Pour ce faire, écrivez le code suivant:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">//Worker 1</span>
$producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;bind(<span class="hljs-string">'logs'</span>);
</code></pre><br>
<pre><code class="php hljs"><span class="hljs-comment">//Worker 2</span>
$producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;bind(<span class="hljs-string">'logs'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Désormais, notre échangeur de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">journaux</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est connecté à nos files d'attente et leur transmettra les messages reçus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez lister tous les liens existants avec la commande suivante sur linux</font></font><br>
<br>
<pre><code class="bash hljs">rabbitmqctl list_bindings</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembler le code</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre script d'expéditeur n'a pas beaucoup changé par rapport à la leçon précédente. </font><font style="vertical-align: inherit;">La principale différence est qu'il envoie maintenant des messages à l'échangeur annoncé précédemment, et non à l'échangeur standard (accessible depuis la boîte). </font><font style="vertical-align: inherit;">Voici le code </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send.php</font></font></b><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $producer = \MonsterMQ\Client\Producer();<font></font>
<font></font>
   $producer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $producer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;newFanoutExchange(<span class="hljs-string">'logs'</span>);<font></font>
<font></font>
   $message = implode(<span class="hljs-string">' '</span>, array_slice($argv, <span class="hljs-number">1</span>));<font></font>
   $message = <span class="hljs-keyword">empty</span>($message) ? <span class="hljs-string">'Hello world!'</span> : $message;<font></font>
<font></font>
   $producer-&gt;publish($message, <span class="hljs-string">''</span>, <span class="hljs-string">'logs'</span>);<font></font>
<font></font>
   <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n Sent {$message} \n"</span>;<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de mentionner qu'en envoyant un message à un échangeur qui n'est associé à aucune file d'attente, le message sera perdu. </font><font style="vertical-align: inherit;">Mais maintenant cela nous convient, puisque nous n'avons pas encore lancé nos destinataires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici le code de notre premier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travailleur worker-1.php</font></font></b><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;setExclusive()-&gt;declare();<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;bind(<span class="hljs-string">'logs'</span>);<font></font>
<font></font>
   $consumer-&gt;consume(<span class="hljs-string">'queue-1'</span>);<font></font>
<font></font>
   $consumer-&gt;wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$message, $channelNumber</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$consumer</span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n $message \n"</span>;<font></font>
   });<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici le code du second </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travailleur worker-2.php</font></font></b><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;setExclusive()-&gt;declare();<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;bind(<span class="hljs-string">'logs'</span>);<font></font>
<font></font>
   $consumer-&gt;consume(<span class="hljs-string">'queue-2'</span>);<font></font>
<font></font>
   $consumer-&gt;wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$message, $channelNumber</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$consumer</span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n $message \n"</span>;<font></font>
   });<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez enregistrer les messages envoyés au premier travailleur dans un fichier journal, appelez simplement la commande suivante dans la console:</font></font><br>
<br>
<pre><code class="bash hljs">php worker-1.php &gt; logs_from_rabbit.log</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour démarrer les deux travailleurs et afficher les messages dans les fenêtres du terminal, appelez les commandes suivantes, chacune dans sa propre fenêtre:</font></font><br>
<br>
<pre><code class="bash hljs">php worker-1.php</code></pre><br>
<pre><code class="bash hljs">php worker-2.php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour envoyer des messages, appelez la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">php send.php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prochaine leçon,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous verrons comment obtenir uniquement un certain sous-ensemble de messages de tous les messages envoyés.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489676/index.html">Nous faisons un clone du service de livraison de nourriture en utilisant Nuxt.js, GraphQL, Strapi et Stripe. Partie 1/7</a></li>
<li><a href="../fr489678/index.html">Mémoire indestructible, processus indestructibles</a></li>
<li><a href="../fr489682/index.html">CORB (Cross-Origin Read Blocking) dans les extensions Chrome</a></li>
<li><a href="../fr489684/index.html">C'est la norme - 4: résoudre les problèmes avec les cartes normales</a></li>
<li><a href="../fr489688/index.html">OData + RxJava + Retrofit 2 pour application Android</a></li>
<li><a href="../fr489696/index.html">Comment la bioacoustique aide à explorer le règne animal</a></li>
<li><a href="../fr489700/index.html">Où aller: les prochains événements gratuits pour les développeurs à Moscou (25 février - 11 mars)</a></li>
<li><a href="../fr489704/index.html">Événements numériques à Moscou du 24 février au 1er mars</a></li>
<li><a href="../fr489706/index.html">Événements numériques à Saint-Pétersbourg du 24 février au 1er mars</a></li>
<li><a href="../fr489708/index.html">Et une souris et une grenouille. Compilateur universel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>