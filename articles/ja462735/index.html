<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎉 🗨️ 🧙🏿 予期しないニュアンスを考慮した信頼できるストレステスト 🍲 ➕ 🧗🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1年前に、私たちのサービスで同時に働く12,000人のオンラインユーザーの数に達したときに、大負荷テストのインフラストラクチャを構築することを考えました。 3か月間、サービスの制限を示すテストの最初のバージョンを作成しました。
 
 運命の皮肉は、テストの開始と同時に製品の制限に達したため、サービス...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>予期しないニュアンスを考慮した信頼できるストレステスト</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/462735/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1年前に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのサービス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で同時に</font><font style="vertical-align: inherit;">働く12,000人のオンラインユーザーの数に達したときに、大負荷テストのインフラストラクチャを構築することを考えまし</font><font style="vertical-align: inherit;">た。 3か月間、サービスの制限を示すテストの最初のバージョンを作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
運命の皮肉は、テストの開始と同時に製品の制限に達したため、サービスが2時間低下したことです。これにより、ケースごとにテストを実施することから、効果的な耐負荷インフラストラクチャを作成することに移行することを私たちに促しました。インフラストラクチャとは、負荷を操作するためのすべてのツールを意味します。起動と起動のためのツール、負荷をロードするためのクラスター、クラスター、類似の製品、メトリックを収集してレポートを準備するためのサービス、これを管理するためのコードとスケーリングのためのサービスです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mw/kz/jl/mwkzjls34yw96qxg5lu9ubf-0bs.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、miro.comスキームがどのように簡略化されているかを示しています。それぞれが特定のタスクを実行しながら、互いに何らかの形で相互作用する多くの異なるサーバーです。負荷テストのインフラストラクチャを構築するには、そのようなスキームを描き、すべての関係を考慮に入れ、各ブロックをスクリプトで順次カバーし始めるのに十分であるようです。このアプローチは適切ですが、数か月かかります。これは急速な成長のため、私たちには適していませんでした。過去6か月間で、サービスで同時に作業する12,000人から20000人のオンラインユーザーが成長しました。さらに、サービスのインフラストラクチャが負荷の増加にどのように対応するか、つまり、どのブロックがボトルネックになるか、どのブロックを線形的に拡張できるかについても知りませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、仮想ユーザーの助けを借りてサービスをテストし、現実的な作業をシミュレートすることを決定しました。つまり、本番用クローンを構築し、次のような大きなテストを行います。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造的には本番環境と同じであるが、パワーよりも先にあるクラスターをロードします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">意思決定のためのすべてのデータを提供します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラ全体が適切な負荷に耐えることができることを示します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将来的に必要になるかもしれないストレステストの基礎となります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなテストの唯一のマイナスは、実稼働環境よりも大きな環境が必要であるため、そのコスト価格です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、現実的なシナリオの作成、プラグイン-WS、Stress-client、Taurus-クラスターのロード、クラスターの販売、およびテストの使用例を紹介します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、負荷テストのために何百ものサーバーを管理する方法についてです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現実的なシナリオを作成する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現実的なシナリオを作成するには、次のものが必要です。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">製品のユーザーの作業を分析し、これについて、私たちにとって重要なメトリックを決定し、定期的に収集を開始し、ジャンプを分析します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスロジックの必要な部分を効果的にロードできる便利なカスタムブロックを作成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーメトリックを使用してスクリプトのリアリズムを確認します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、各アイテムについて詳しく説明します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">製品でのユーザー作業の分析</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
私たちのサービスでは、ユーザーはボードを作成し、写真、テキスト、モックアップ、ステッカー、図などのさまざまなコンテンツを使用してボードで作業できます。収集する必要がある最初のメトリックは、ボードの数とボード上のコンテンツの分布です。</font></font><br>
<br>
<img align="left" src="https://habrastorage.org/webt/uq/ah/cp/uqahcpsgmjnzqao48ivvrhgzuvc.png" width="400" height="500"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に同じボード上で、一部のユーザーはアクティブに何かを行うことができます-作成、削除、編集-一部のユーザーは作成されたマテリアルを単に表示します。これは重要な指標でもあります。1つのボードのユーザーの総数に対する、ボード上のコンテンツを変更するユーザーの数の比率です。これは、データベースの操作に関する統計に基づいて取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックエンドでは、コンポーネントアプローチを使用します。モデルと呼ばれるコンポーネント。特定のモデルがビジネスロジックの各部分を担当するように、コードをモデルに分割します。各モデルを介して発生するデータベース呼び出しの数を計算し、ロジックのどの部分がデータベースを最も多くロードするかを理解できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-d/zu/iu/-dzuiu9istykhoantxrs-po64ky.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">便利なカスタムブロック</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
たとえば、ユーザーボードのリストを含むダッシュボードページを開いたときと同じように、サービスを読み込むスクリプトにブロックを追加する必要があります。このページの読み込み中に、ボードの数、ユーザーがアクセスできるアカウント、アカウントのすべてのユーザーなど、大量のデータセットを含むhttpリクエストが送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zb/j1/sx/zbj1sxyfvbkfbotawsqnegvz8zg.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダッシュボードを効果的に読み込む方法は？本番の動作を分析したところ、大規模なアカウントのダッシュボードを開いているときに、データベースに負荷の急増が見られました。同一のアカウントを再作成し、スクリプトでのそのデータの使用頻度を変更して、少数のヒットでダッシュボードを効果的にロードできます。不均一な負荷を作成して、よりリアリズムを高めることもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、仮想ユーザーの数と仮想ユーザーによって作成される負荷が、ユーザーと本番環境の負荷にできるだけ類似していることが重要です。これを行うために、平均ダッシュボードのバックグラウンドロードもテストで再作成します。したがって、ほとんどの仮想ユーザーは小さな平均ダッシュボードで作業し、本番環境で発生するように、数人のユーザーだけが壊滅的な負荷を作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、各サーバーの役割と各関係を個別のスクリプトでカバーする必要はありませんでした。</font><font style="vertical-align: inherit;">これは、ダッシュボードの例で見ることができます。ユーザーがダッシュボードを開いたときに、ダッシュボードが製品で開かれたときに何が起こるかをテスト中に繰り返すだけであり、合成スクリプトでの影響をカバーしていません。</font><font style="vertical-align: inherit;">これにより、デフォルトでは、予想もしていなかったニュアンスをテストできます。</font><font style="vertical-align: inherit;">そのため、ビジネスロジックの側からインフラストラクチャテストの作成に取り組んでいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このロジックを使用して、サービスの他のすべてのブロックを効率的にロードしました。</font><font style="vertical-align: inherit;">同時に、ファンクショナルを使用するロジックの観点から、個々のブロックは現実的ではない場合があります。</font><font style="vertical-align: inherit;">サーバーに現実的なメトリック負荷を与えることが重要です。</font><font style="vertical-align: inherit;">次に、これらのブロックから、ユーザーの実際の作業を模倣するスクリプトを作成できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wk/gc/po/wkgcporetjxwqqbca-qfeedkuam.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データはスクリプトの一部です。</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データもスクリプトの一部であり、コード自体のロジックはデータに大きく依存していることを考慮する価値があります。</font><font style="vertical-align: inherit;">テスト用に大規模なデータベースを構築する場合（そして大規模なインフラストラクチャテストには明らかに大規模であるべきです）、スクリプトの実行中にロールを発生させないデータを作成する方法を学ぶ必要があります。</font><font style="vertical-align: inherit;">ジャンクデータをダンプすると、スクリプトが非現実的になり、大規模なデータベースの修正が困難になる可能性があります。</font><font style="vertical-align: inherit;">したがって、Rest APIを使用して、ユーザーと同じ方法でデータを作成し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、利用可能なデータでボードを作成するには、APIリクエストを実行して、バックアップからボードをロードします。</font><font style="vertical-align: inherit;">その結果、私たちは正直な実際のデータを取得します-異なるサイズの異なるボード。</font><font style="vertical-align: inherit;">同時に、スクリプト内の要求をマルチスレッドでプルしているため、データベースは非常に迅速にいっぱいになります。</font><font style="vertical-align: inherit;">速度では、これはガベージデータの生成に匹敵します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このパーツの結果</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてを一度に確認する場合は、現実的なシナリオを使用してください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際のユーザーの行動を分析して、スクリプト構造を設計します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタマイズに便利なブロックをすぐに作成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用状況分析ではなく、実際のサーバーメトリックで構成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データはスクリプトの一部であることに注意してください。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターの読み込み</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷をロードするためのインストルメンテーション図：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sw/gb/wg/swgbwgmqvkv2r8uue1tkrv5oyve.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jmeterでは、Taurusを使用して起動するスクリプトを作成し、それを使用してさまざまなサーバー（web、api、boardサーバー）をロードします。</font><font style="vertical-align: inherit;">データベーステストはJmeterではなくPostgresqlを使用して個別に実行するため、図では破線が表示されています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webソケット内のカスタム作業</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボード上での作業はWS-connection内で行われ、マルチユーザー作業が可能なのはボード上です。これで、プラグインマネージャー内のJmeterボックスに、Webソケットを操作するためのプラグインがいくつかあります。ロジックはどこでも同じです。プラグインは単にWebソケット接続を開くだけですが、内部で発生するすべてのアクションは、いずれにしても、自分で書く必要があります。どうして？ HTTPリクエストの場合と同じように作業することはできないため、つまり、スクリプトを記述して、動的な値をエクストラクターで引き出し、さらにスキップすることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、Webソケット内の作業は非常にカスタムです。特定のデータをカスタムで使用して特定のメソッドを呼び出すため、リクエストが正しく実行されたかどうか、および実行にかかった時間を理解する必要があります。</font><font style="vertical-align: inherit;">このプラグイン内のリスナーも独立して書かれているため、すぐに使えるソリューションは見つかりませんでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレスクライアント</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のユーザーが行うことをできるだけ簡単に繰り返したいと考えています。しかし、WS内のブラウザーで何が起こっているのかを記録して再生する方法はわかりません。すべてを最初からWS内に書き込むと、実際のユーザーが使用するクライアントではなく、新しいクライアントが作成されます。すでに機能しているクライアントがいる場合、新しいクライアントを書く気はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、Jmeter内にクライアントを配置することにしました。そして、多くの困難に直面しました。たとえば、Jmeter内でjsを実行することは別の話です。これは、</font><font style="vertical-align: inherit;">サポートされている機能の</font><font style="vertical-align: inherit;">完全に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">固有のバージョン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。また、既存のクライアントコードを使用したい場合、成功しない可能性が高くなります。ここでは、複雑な構造を起動できないため、それらを書き直す必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の難点は、負荷テストでクライアントコード全体をサポートしたくないということです。したがって、クライアントから不要なものをすべて削除し、クライアントとサーバーの相互作用のみを残しました。これにより、クライアントサーバーメソッドを使用して、クライアントが実行できるすべてのことを実行できます。さらに、クライアントとサーバーの相互作用が非常にまれにしか変化しないため、スクリプト内のコードのサポートが必要になることはほとんどありません。たとえば、過去6か月間は、コードが優れているため、コードに変更を加えたことはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の難点-大きなスクリプトの外観は、スクリプトを大幅に複雑にします。まず、テストのボトルネックになる可能性があります。次に、1つのマシンから多数のスレッドを開始できない可能性があります。現在は、730スレッドしか起動できません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazonインスタンスの例</font></font></b><br>
<br>
<pre><code class="plaintext hljs"> Jmeter server  AWS: m5.large ($0.06 per Hour)<font></font>
<font></font>
vCPU: 2<font></font>
Mem (GiB): 8<font></font>
Dedicated EBS Bandwidth (Mbps): Up to 3,500<font></font>
Network Performance (Gbps): Up to 10<font></font>
<font></font>
→ ~730 </code></pre><br>
<h3>      </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、1つのマシンから730スレッドという問題が発生します。そんなに多くのサーバーをどこに上げるのですか？私たちはクラウドソリューションを作成しているので、クラウドソリューションをテストするためのサーバーを購入するのは奇妙に思えます。さらに、新しい鉄を購入するプロセスには常に一定の遅延があります。したがって、クラウドでもそれらを調達する必要があるため、最終的にはクラウドプロバイダーとクラウドロードツールのどちらかを選択します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BlazemeterやRedLine13などのクラウドロードツールは、私たちに適さない使用制限があるため、使用しませんでした。私たちはさまざまなテストサイトを持っているので、ローカルテストを含め、開発の90％を使用できるユニバーサルソリューションを見つけたいと考えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、私たちはクラウドプロバイダーを選択しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ud/35/8n/ud358nhlnnsa9uopiwpfisoipa8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの生産はAWS上で行われるため、主にそこでテストを行っています。テストベンチをできる限り生産スタンドに類似させる必要があります。 Amazonには多くの有料機能があり、その一部は製品で使用されています（バランサーなど）。これらの機能がAWSで必要ない場合は、ヘッツナーで17倍安価に使用できます。または、サーバーをHetznerに保持し、Openstackを使用して、バランサーやその他の機能を自分で作成することができます。Openstackを使用すると、インフラストラクチャ全体を繰り返すことができるためです。私たちは成功しました。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSで69のインスタンスを持つ5万人のユーザーをテストすると、1か月あたり約3,000ドルかかります。</font><font style="vertical-align: inherit;">保存する方法？</font><font style="vertical-align: inherit;">たとえば、AWSには一時的なインスタンス-スポットインスタンスがあります。</font><font style="vertical-align: inherit;">彼らのクールさは、私たちがそれらを常に保管するのではなく、テストの間だけそれらを上げることであり、はるかに安価です。</font><font style="vertical-align: inherit;">ニュアンスは、テスト時に他の誰かがより高い価格で購入できることです。</font><font style="vertical-align: inherit;">幸いなことに、これはこれまでに発生したことはありませんが、すでにその費用で少なくとも60％のコストを節約しています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターの読み込み</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jmeterボックスクラスターを使用します。</font><font style="vertical-align: inherit;">それは素晴らしい働きをし、いかなる方法でも修正する必要はありません。</font><font style="vertical-align: inherit;">いくつかの起動オプションがあります。</font><font style="vertical-align: inherit;">1つのウィザードがN個のインスタンスを開始するとき、最も単純なものを使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/oj/di/vzojdipz783bcxk6va84kxuu1ga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウィザードは、Jmeterサーバー上でスクリプトを実行し、それらと連絡を取りながら、すべてのインスタンスから一般的な統計をリアルタイムで収集し、コンソールに表示します。</font><font style="vertical-align: inherit;">これはすべて、1台のサーバーでスクリプトを実行する場合とまったく同じですが、100台のサーバーでの起動の結果が表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのインスタンスでのスクリプト実行結果の詳細な分析には、Kibanaを使用します。</font><font style="vertical-align: inherit;">Filebeatを使用したParsimログ。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lp/2i/es/lp2ieslbdsgadsr41ydhss4vtco.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache JMeterのPrometheusリスナー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jmeterには</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheusを操作するため</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プラグイン</font></a><font style="vertical-align: inherit;">があり、</font><font style="vertical-align: inherit;">そのままでテスト内のJVMとスレッドの使用に関するすべての統計を提供します。</font><font style="vertical-align: inherit;">これにより、ユーザーがログイン、ログアウトする頻度などを確認できます。</font><font style="vertical-align: inherit;">プラグインをカスタマイズして、スクリプトのデータをPrometheusに送信し、Grafanaでリアルタイムに表示できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mw/ig/3m/mwig3mwxuq6p7rexf1hq9nc8gek.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おうし座</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おうし座に関する現在の多くの問題を解決したいのですが、まだ対処していません。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトのクローンではなく構成。</font><font style="vertical-align: inherit;">Jmeterでテストした場合は、ソースパラメーターの異なるセットを使用してスクリプトを実行する必要に直面した可能性があり、そのためにクローンを作成する必要がありました。</font><font style="vertical-align: inherit;">おうし座では、1つのシナリオを設定することが可能で、設定を使用して起動パラメーターを制御できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターでの作業時にJmeterサーバーを管理するための構成。</font></font></li>
<li> -,        Jmeter     ;</li>
<li>   CI;</li>
<li>   .</li>
</ul><br>
<h3>  </h3><br>
<ul>
<li>     Jmeter,       ,       Jmeter,    ;</li>
<li> Jmeter —  :  ,     ;</li>
<li>      ,    ;</li>
<li>   listeners  Jmeter,         .</li>
</ul><br>
<h2>   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の全体の話は、主にサービス制限テストの現実的なシナリオを作成することについてです。</font><font style="vertical-align: inherit;">以下の例は、負荷テストのインフラストラクチャを再利用して、ローカルの問題を解決する方法を示しています。</font><font style="vertical-align: inherit;">2つのテストについて詳しく説明しますが、通常は定期的に約10種類の負荷テストを実施しています。</font></font><br>
<a name="database"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースのテスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースに何をロードテストできますか？クエリプランだけを見れば、シングルスレッドモードでクエリをテストできるため、重いクエリはほとんどありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深い状況は、テストを実行してディスクの負荷を確認するときです。グラフは、iowaitがどのように上昇するかを示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/7i/wy/o97iwyqnwc7rdo6utv-xjoe-p_c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、これはユーザーに影響を与えることがわかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3z/c_/ia/3zc_iawonyc_jwscpgs4fl8yi1a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは理由を理解しています：真空が機能せず、データベースからゴミデータを削除しませんでした。 Postgresqlを使用したことがない場合、VacuumはJavaのガベージコレクターのようなものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2l/ks/vr/2lksvred5j50eummkssdxyw7i1w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックポイント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が予定外に機能し始めた</font><font style="vertical-align: inherit;">ことがわかり</font><font style="vertical-align: inherit;">ます。私たちにとって、これはPostgresqlの設定がデータベースでの作業の集中度に対応していないというシグナルです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/sx/cb/lesxcbanlw_j5iyhm0bawfrq4ic.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの仕事は、このような状況が再発しないようにデータベースを適切に構成することです。同じPostgresqlには多くの設定があります。微調整を行うには、短い反復作業が必要です。構成の修正、起動、チェック、構成の修正、起動、チェック。もちろん、これにはベースに適切な負荷をかける必要がありますが、これには大きなインフラストラクチャテストが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特異点は、テストが正常に加速し、不要な場所に落ちないためには、加速が長くなければならないということです。テストには約3時間かかります。これは、短い反復のようには見えません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策を探しています。 Postgresqlツールの1つを見つける</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Pg_replay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">彼は、ログに記録されたものを正確にマルチスレッドで再現でき、記録時に発生したとおりに再現できます。</font><font style="vertical-align: inherit;">どうすれば効果的に使用できますか？</font><font style="vertical-align: inherit;">ベースダンプを折りたたみ、ログに保存した後にデータベースに発生したすべてをログに記録します。次に、ダンプを展開し、ベースマルチスレッドで発生したすべてを再生する機会があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログをどこに書き込むか？</font><font style="vertical-align: inherit;">ログを記録するための一般的なソリューションは、ログを本番で収集することです。これにより、最も現実的な再現可能なスクリプトが得られます。</font><font style="vertical-align: inherit;">しかし、いくつかの問題があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストでは販売データを使用する必要がありますが、これは常に可能とは限りません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このプロセスは、高価なsyslog操作を使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスクを読み込んでいます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大きなテストに対する私たちのアプローチは、ここで私たちを助けます。</font><font style="vertical-align: inherit;">テスト環境でダンプを取り、大規模なテストを実行して、現実的なスクリプトの実行時に発生するすべてのログを書き込みます。</font><font style="vertical-align: inherit;">次に、独自の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルシー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールを使用し</font><font style="vertical-align: inherit;">てデータベースをテストします。</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWSでインスタンスが作成されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なダンプが展開されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pg_replayが起動し、必要なログを再生します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニタリングを使用して、Prometheus + Grafanaの結果を分析します。</font><font style="vertical-align: inherit;">リポジトリにはダッシュボードの例があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Marcyを開始するときに、スクリプトの強度など、変更可能な少数のパラメーターを渡すことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、現実的なスクリプトを使用してテストを作成し、大規模なクラスターを使用せずにテストを再生します。</font><font style="vertical-align: inherit;">SQLデータベースをテストする場合、スクリプトは不均一でなければならないことを考慮することが重要です。そうしないと、データベース自体の動作が製品とは異なります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">劣化監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
劣化テストでは、現実的なシナリオを使用します。次のリリース以降、サービスの動作が遅くならないようにする必要があるという考えです。開発者がコードを変更してリクエストの実行時間の増加につながる場合は、新しい値を参照値と比較して、ビルドにエラーがあるかどうかを通知できます。参考値として、自分に合った現在の値を採用しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリの実行時間を制御することは有用ですが、さらに進んでいます。リリース後の実際のユーザーの作業中の応答時間が長くならないようにしたかったのです。ストレステストの時に、何とか入ってチェックできると思いましたが、これは数十件に過ぎません。既存の機能テストを実行し、同時に1000件のケースを確認する方が効率的です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_-/xy/0t/_-xy0t6oavpjngkog1hwqelq5ky.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは私たちにとってどのように機能しますか？</font><font style="vertical-align: inherit;">組み立て後、テストベンチに配備されるマスターがいます。</font><font style="vertical-align: inherit;">次に、機能テストが負荷テストと並行して自動的に実行されます。</font><font style="vertical-align: inherit;">Allureで機能テストがどのように負荷を受けているかについてのレポートを受け取った後。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、このレポートでは、比較テストが参照値で落ちていることがわかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t-/hh/b-/t-hhb-mrpc9zgyg0iwhvvt1yxtu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、機能テストでは、ブラウザーでの操作の実行時間を測定できます。</font><font style="vertical-align: inherit;">または、クライアントがタイムアウトするため、負荷がかかった状態で操作を完了するのに時間がかかるため、機能テストは成功しません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このパーツの結果</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現実的なテストでは、データベースを安価にテストし、簡単に構成できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷状態での機能テストが可能です。</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の記事では</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、我々は負荷テストのために何百ものサーバーを管理する方法についてです。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462723/index.html">TLA +で猫を捕まえる</a></li>
<li><a href="../ja462725/index.html">三角法のトリック</a></li>
<li><a href="../ja462727/index.html">2019年6〜7月のJoomlaダイジェスト</a></li>
<li><a href="../ja462729/index.html">VSBIでのナラティブデザインに関する公開講義の夜</a></li>
<li><a href="../ja462733/index.html">ファイバーチャネル：データセンターのストレージに接続することの生命力</a></li>
<li><a href="../ja462737/index.html">Opencartと会計システムの統合</a></li>
<li><a href="../ja462739/index.html">ゲーム産業会議GAMEDEV.HOUSE</a></li>
<li><a href="../ja462743/index.html">モスクワSPAミートアップ＃5-会議のお知らせ</a></li>
<li><a href="../ja462747/index.html">キーボードを見ずにこの記事を書いた</a></li>
<li><a href="../ja462749/index.html">幸福管理：30以上の都市のホームオフィスチームをケアして育成する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>