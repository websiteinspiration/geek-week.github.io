<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛬 🤜 🔘 Bermigrasi dari OpenVPN ke WireGuard untuk bergabung dengan jaringan menjadi satu jaringan L2 📎 👩🏿‍🤝‍👩🏾 🥈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya ingin berbagi pengalaman menggabungkan jaringan di tiga apartemen yang jauh secara geografis, di mana masing-masing router dengan OpenWRT digunak...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bermigrasi dari OpenVPN ke WireGuard untuk bergabung dengan jaringan menjadi satu jaringan L2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin berbagi pengalaman menggabungkan jaringan di tiga apartemen yang jauh secara geografis, di mana masing-masing router dengan OpenWRT digunakan sebagai gateway ke dalam satu jaringan umum. </font><font style="vertical-align: inherit;">Ketika memilih metode untuk menggabungkan jaringan antara L3 dengan routing subnet dan L2 dengan bridging, ketika semua node jaringan akan berada di subnet yang sama, metode kedua lebih disukai, yang lebih sulit untuk dikonfigurasi, tetapi memberikan lebih banyak peluang, karena jaringan itu direncanakan untuk menggunakan teknologi transparan. Wake-on-Lan dan DLNA.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 1: Latar Belakang</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPN pada awalnya dipilih sebagai protokol untuk mengimplementasikan tugas ini, karena, pertama, ia dapat membuat perangkat tap yang dapat dengan mudah ditambahkan ke bridge, dan kedua, OpenVPN mendukung operasi protokol TCP, yang juga penting, karena tidak ada apartemen yang memiliki alamat IP khusus, dan saya tidak dapat menggunakan STUN, karena karena alasan tertentu penyedia saya memblokir koneksi masuk melalui UDP dari jaringan mereka, sementara TCP memungkinkan saya untuk meneruskan port server VPN ke menyewa VPS menggunakan SSH. Ya, pendekatan ini memberikan beban besar, karena data dienkripsi dua kali, tetapi saya tidak ingin memasukkan VPS ke jaringan pribadi saya, karena ada risiko pihak ketiga mendapatkan kendali atas itu, oleh karena itu,memiliki perangkat seperti itu di jaringan rumah sangat tidak diinginkan dan diputuskan untuk membayar keamanan dengan overhead yang besar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk meneruskan port pada router di mana ia direncanakan untuk menyebarkan server, program sshtunnel digunakan. Saya tidak akan menjelaskan seluk beluk konfigurasinya - ini dilakukan dengan cukup mudah, saya hanya mencatat bahwa tugasnya adalah meneruskan port TCP 1194 dari router ke VPS. Selanjutnya, server OpenVPN dikonfigurasi pada perangkat tap0, yang berakhir di jembatan br-lan. Setelah memeriksa koneksi ke server yang baru saja Anda buat dari laptop, menjadi jelas bahwa gagasan port forwarding telah terbayar dan laptop saya menjadi anggota jaringan router, walaupun secara fisik saya tidak ada di sana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalahnya tetap kecil: perlu untuk mendistribusikan alamat IP di apartemen yang berbeda sehingga mereka tidak konflik dan mengkonfigurasi router sebagai klien OpenVPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alamat IP router dan rentang server DHCP berikut dipilih:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan kisaran </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk server</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan kisaran </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk router di apartemen No. 2</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan kisaran </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk router di apartemen No. 3</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu juga perlu untuk menetapkan alamat-alamat ini ke router klien dari server OpenVPN dengan menambahkan baris berikut ke konfigurasinya:</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan menambahkan baris berikut ke file /etc/openvpn/ipp.txt:</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
di mana flat1_id dan flat2_id adalah nama perangkat yang ditentukan saat membuat sertifikat untuk menghubungkan ke OpenVPN</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, klien OpenVPN dikonfigurasikan pada router, perangkat tap0 pada keduanya ditambahkan ke br-lan bridge. Pada tahap ini, tampaknya semuanya beres, karena ketiga jaringan saling melihat dan bekerja secara keseluruhan. Namun, itu ternyata menjadi detail yang tidak terlalu menyenangkan: kadang-kadang perangkat tidak bisa mendapatkan alamat IP dari router mereka, dengan semua konsekuensi berikutnya. Untuk beberapa alasan, router di beberapa apartemen tidak punya waktu untuk menanggapi DHCPDISCOVER pada waktunya dan perangkat tidak menerima alamatnya. Saya menyadari bahwa saya perlu memfilter permintaan seperti itu di tap0 pada masing-masing router, tetapi, ternyata, iptables tidak dapat bekerja dengan perangkat jika itu merupakan bagian dari jembatan dan ebtable harus membantu saya. Sayangnya, itu tidak ada dalam firmware saya dan saya harus membangun kembali gambar untuk setiap perangkat.Setelah melakukan ini dan menambahkan baris-baris tersebut ke /etc/rc.local masing-masing router, masalahnya terpecahkan:</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konfigurasi ini berlangsung selama tiga tahun.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 2: Memperkenalkan WireGuard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baru-baru ini, di Internet, mereka mulai berbicara lebih banyak tentang WireGuard, mengagumi kesederhanaan konfigurasinya, kecepatan transmisi tinggi, ping rendah dengan keamanan yang sebanding. Pencarian untuk informasi tambahan tentang dia menjelaskan bahwa mereka tidak mendukung apakah bekerja sebagai anggota bridge atau bekerja dengan protokol TCP, yang membuat saya berpikir bahwa masih ada alternatif untuk OpenVPN bagi saya. Jadi saya menunda untuk mengenal WireGuard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa hari yang lalu, melalui sumber daya, dengan satu atau lain cara terhubung dengan IT, berita muncul bahwa WireGuard akhirnya akan dimasukkan dalam kernel Linux, dimulai dengan versi 5.6. Artikel-artikel berita, seperti biasa, memuji WireGuard. Saya kembali mencari cara untuk mengganti OpenVPN yang lama dan bagus. Kali ini saya melihat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Itu berbicara tentang membangun terowongan Ethernet lebih dari L3 menggunakan GRE. Artikel ini memberi saya harapan. Masih belum jelas apa yang harus dilakukan dengan protokol UDP. Pencarian membawa saya ke artikel tentang penggunaan socat bersama dengan terowongan SSH untuk meneruskan port UDP, namun, mereka mencatat bahwa pendekatan ini hanya bekerja dalam mode koneksi tunggal, yaitu, pekerjaan beberapa klien VPN tidak mungkin dilakukan. Saya datang dengan ide meningkatkan server VPN pada VPS, dan mengatur GRE untuk klien, tetapi ternyata, GRE tidak mendukung enkripsi, yang akan mengarah pada kenyataan bahwa dalam hal akses ke server oleh pihak ketiga, semua lalu lintas antara jaringan saya ada di tangan mereka. pada prinsipnya itu tidak cocok untukku. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekali lagi, keputusan dibuat untuk enkripsi yang berlebihan, dengan menggunakan VPN melalui VPN sesuai dengan skema berikut:</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tingkat Pertama VPN: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server yang</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan alamat internal 192.168.30.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebuah</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> dengan alamat internal 192.168.30.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebuah</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> dengan alamat internal 192.168.30.3 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebuah</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> dengan alamat internal 192.168.30.3 </font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;"> adalah </font><i><font style="vertical-align: inherit;">sebuah </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tingkat kedua VPN: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server yang</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan alamat eksternal 192.168.30.2 dan internal 192.168.31.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klien </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan alamat 192.168.30.2 dan memiliki IP internal 192.168.31.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klien </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan alamat 192.168.30.2 dan memiliki IP internal 192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router-server di apartemen 1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router di apartemen 2, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router di apartemen 3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Konfigurasi perangkat diterbitkan dalam spoiler di akhir artikel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maka, ping antara node jaringan 192.168.31.0/24 pergi, sekarang saatnya untuk beralih ke pengaturan terowongan GRE. Sebelum ini, agar tidak kehilangan akses ke router, ada baiknya mengatur terowongan SSH untuk meneruskan 22 port pada VPS, sehingga, misalnya, router dari apartemen 2 akan tersedia pada port VPS 10022, dan pada port 11122 VPS akan tersedia router berasal dari apartemen 3. Yang terbaik adalah mengkonfigurasi penerusan dengan sshtunnel yang sama, karena akan mengembalikan terowongan jika jatuh.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terowongan dikonfigurasi, Anda dapat terhubung ke SSH melalui port yang diteruskan:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, nonaktifkan OpenVPN:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang konfigurasikan terowongan GRE di router dari apartemen 2:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan tambahkan antarmuka yang dibuat ke jembatan:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan melakukan prosedur serupa pada router-server:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan, juga, tambahkan antarmuka yang dibuat ke jembatan:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mulai dari saat ini, ping mulai berhasil masuk ke jaringan baru dan saya, dengan kepuasan, akan minum kopi. </font><font style="vertical-align: inherit;">Kemudian, untuk mengevaluasi cara kerja jaringan di ujung lain kabel, saya mencoba menghubungkan melalui SSH ke salah satu komputer di apartemen 2, tetapi klien ssh membeku tanpa meminta kata sandi. </font><font style="vertical-align: inherit;">Saya mencoba untuk terhubung ke komputer ini melalui telnet ke port 22 dan saya melihat garis dari mana dapat dipahami bahwa koneksi sedang dibuat, server SSH merespons, hanya untuk beberapa alasan tidak menawarkan saya untuk masuk.</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mencoba menghubungkannya melalui VNC dan melihat layar hitam. Saya meyakinkan diri sendiri bahwa itu adalah komputer jarak jauh, karena saya dapat dengan mudah terhubung ke router dari apartemen ini di alamat internal. Namun, saya memutuskan untuk terhubung ke SSH komputer ini melalui router dan saya terkejut menemukan bahwa koneksi berhasil dan komputer jarak jauh berfungsi dengan baik, tetapi juga tidak dapat terhubung ke komputer saya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menghapus perangkat grelan0 dari jembatan dan menjalankan OpenVPN pada router di apartemen 2 dan memastikan bahwa jaringan berfungsi lagi seperti yang diharapkan dan koneksi tidak putus. Ketika saya mencari, saya menemukan forum di mana orang-orang mengeluh tentang masalah yang sama, di mana mereka disarankan untuk meningkatkan MTU. Namun, saya tidak dapat meningkatkan MTU untuk VPN tingkat pertama (wg0): dengan MTU di atas 1420, yang diatur secara otomatis, mulai rusak, tetapi pada saat yang sama, VPN tingkat kedua yang bekerja di atas wg0 bekerja dengan benar dengan MTU 1600. Ini cukup untuk menginstal MTU adalah 1500 untuk perangkat gretap, sehingga antarmuka ini memiliki nilai MTU yang sama dengan jembatan br-lan tempat gretap direncanakan akan ditambahkan. Seperti yang saya pahami, bridge menetapkan MTU sama dengan yang lebih kecil dari nilai yang tersedia di semua perangkat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya membuat konfigurasi serupa pada router dari apartemen 3, dengan satu-satunya perbedaan adalah bahwa pada router server menambahkan antarmuka gretap kedua bernama grelan1, yang juga ditambahkan ke jembatan br-lan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya berfungsi. </font><font style="vertical-align: inherit;">Sekarang Anda dapat meletakkan perakitan gretap di startup. </font><font style="vertical-align: inherit;">Untuk melakukan ini: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masukkan baris-baris ini di /etc/rc.local pada router di apartemen 2:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menambahkan ini ke /etc/rc.local pada router di apartemen 3:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan pada router server:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah me-reboot router klien, saya menemukan bahwa untuk beberapa alasan mereka tidak terhubung ke server. </font><font style="vertical-align: inherit;">Setelah terhubung ke SSH mereka (untungnya, saya mengkonfigurasi sshtunnel untuk ini), ditemukan bahwa WireGuard sedang membuat rute untuk titik akhir karena alasan tertentu, tetapi itu tidak benar. </font><font style="vertical-align: inherit;">Jadi, untuk 192.168.30.2, tabel rute menunjukkan rute melalui antarmuka pppoe-wan, yaitu, melalui Internet, meskipun rute ke sana seharusnya dialihkan melalui antarmuka wg0. </font><font style="vertical-align: inherit;">Setelah menghapus rute ini, koneksi dipulihkan. </font><font style="vertical-align: inherit;">Saya tidak dapat menemukan petunjuk di suatu tempat tentang cara membuat WireGuard tidak membuat rute ini. </font><font style="vertical-align: inherit;">Selain itu, saya bahkan tidak mengerti, fitur adalah OpenWRT, atau WireGuard sendiri. </font><font style="vertical-align: inherit;">Tidak harus berurusan dengan masalah ini untuk waktu yang lama, saya hanya menambahkan baris ke router ini ke skrip yang dilingkupi oleh timer untuk menghapus rute ini:</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk meringkas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya belum mencapai penolakan lengkap terhadap OpenVPN, karena saya kadang-kadang perlu terhubung ke jaringan baru dari laptop atau telepon, dan menyiapkan perangkat gretap pada mereka secara umum tidak mungkin, tetapi meskipun demikian, saya mendapat keuntungan dalam kecepatan transfer data antara apartemen dan, misalnya, penggunaan VNC sekarang tidak menimbulkan ketidaknyamanan. </font><font style="vertical-align: inherit;">Ping sedikit menurun, tetapi menjadi lebih stabil: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat menggunakan OpenVPN:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat menggunakan WireGuard:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini lebih dipengaruhi oleh ping tinggi sebelum VPS, yaitu sekitar 61,5 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, kecepatannya meningkat secara signifikan. </font><font style="vertical-align: inherit;">Jadi, di apartemen dengan router-server, saya memiliki kecepatan koneksi internet 30 Mbit / s, dan di apartemen lain - 5 Mbit / s. </font><font style="vertical-align: inherit;">Pada saat yang sama, ketika menggunakan OpenVPN, saya tidak dapat mencapai kecepatan transfer data antara jaringan lebih dari 3,8 Mb / s menurut iperf, sementara WireGuard "dipompa" ke 5 Mb / s yang sama.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi WireGuard pada VPS</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi WireGuard pada MS (ditambahkan ke / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi WireGuard pada MK2 (ditambahkan ke / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasi WireGuard pada MK3 (ditambahkan ke / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam konfigurasi yang dijelaskan untuk VPN tingkat kedua, saya tentukan port 51821 untuk klien WireGuard. Pada prinsipnya, ini tidak perlu, karena klien akan membuat koneksi dari port yang tidak diprivatisasi gratis, tapi saya membuatnya sehingga saya bisa memblokir semua koneksi yang masuk pada antarmuka WG0 semua router, kecuali koneksi UDP masuk ke port 51821. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya harap artikel ini bermanfaat bagi seseorang. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Juga, saya ingin membagikan skrip saya yang mengirimkan saya pemberitahuan PUSH di telepon ke aplikasi WirePusher ketika perangkat baru muncul di jaringan saya. </font><font style="vertical-align: inherit;">Berikut ini tautan ke skrip: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEMBARUAN:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mengkonfigurasi Server dan Klien OpenVPN</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klien OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghasilkan sertifikat, gunakan rsa mudah</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id486844/index.html">Evolusi pemrosesan webhook Facebook: dari nol menjadi 25.000 per detik</a></li>
<li><a href="../id486850/index.html">Kursi baru yang dipesan - seperti hotel kapsul</a></li>
<li><a href="../id486858/index.html">Membuat Viberbot lengkap. Bagian dua - kontak pertama atau "conversion_started"</a></li>
<li><a href="../id486860/index.html">ATX12VO - Makan dengan Cara Baru</a></li>
<li><a href="../id486862/index.html">5 alasan mengapa desain gerak membantu Anda terhubung dengan orang-orang</a></li>
<li><a href="../id486866/index.html">Fuete Sinkron: Motor Biologis dalam Nanoteknologi</a></li>
<li><a href="../id486868/index.html">Kenapa dan untuk siapa kita melakukan Slime Agile</a></li>
<li><a href="../id486870/index.html">Bagaimana kami mengeluarkan penipuan dari pondok</a></li>
<li><a href="../id486872/index.html">Linux Pengaturan keyboard</a></li>
<li><a href="../id486874/index.html">Coronavirus 2019-nCoV: mortalitas rendah, mortalitas tinggi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>