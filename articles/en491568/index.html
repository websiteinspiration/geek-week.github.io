<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß• üîÄ üåº Building a router in SOCKS on a laptop with Debian 10 üë¶üèΩ üìì üö¥üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a whole year (or two) I postponed the publication of this article for the main reason - I have already published two articles in which I described...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Building a router in SOCKS on a laptop with Debian 10</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491568/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For a whole year (or two) I postponed the publication of this article for the main reason - I have already published two articles in which I described the process of creating a router in SOCKS from a regular laptop with Debian.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, since then the stable version of Debian has been updated to Buster, a sufficient number of people have sent me a personal request to help with the configuration, which means that my previous articles are not exhaustive. Well, I myself guessed that the methods described in them did not fully reveal all the intricacies of configuring Linux for routing in SOSKS. In addition, they were written for Debian Stretch, and after upgrading to Buster, in the systemd initialization system, I noticed small changes in the interaction of services. Yes, and in the articles themselves, I did not use systemd-networkd, although it is best suited for complex network configurations.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the above changes, services like </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hostapd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> were added to my configuration </font><font style="vertical-align: inherit;">- a service for access point virtualization, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for synchronizing the time of local network clients, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for encrypting DNS connections and disabling advertising on local network clients, as well as, as I mentioned previously, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for configuring network interfaces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the simplest block diagram of the internal structure of such a router. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gy/eq/_f/gyeq_fcjwxnobupmbqn9b-hwqqk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, I remind you what the objectives of the cycle of these articles are:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route all OS connections to SOCKS, as well as the connections of all devices that are on the same network as the laptop. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The laptop in my case should remain fully mobile. </font><font style="vertical-align: inherit;">That is, to give the opportunity to use the desktop environment and not be tied to a physical location.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last point involves connecting and routing only through the built-in wireless interface.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, of course, the creation of an exhaustive guide, as well as the analysis of appropriate technologies to the best of my modest knowledge.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will be considered in this article:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">git</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - download the tun2socks project </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositories</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> needed to route TCP traffic to SOCKS, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_ap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a script to automate the configuration of a virtual access point using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hostapd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - build and install the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service on the system </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - configure wireless and virtual interfaces, static routing tables, and packet forwarding.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_ap</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - install the systemd service on the system, configure and launch the virtual access point.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optional steps:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - install and configure the server to synchronize time on the clients of the virtual access point.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - encrypt DNS queries, route them to SOCKS and disable advertising domains for the local network.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why all this?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is one way of securing TCP connections on a local network. The main advantage is that all connections go to SOCKS if a static route through the original gateway is not built for them. This means that it is not necessary to prescribe the settings of the SOCKS server to either individual programs or clients on the local network - they all go to SOCKS by default, since it is the default gateway until we specify the opposite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, we add the second encryption router as a laptop in front of the original router and use the Internet connection of the original router for the already encrypted SOCKS requests of the laptop, which, in turn, routes and encrypts the requests of the local network clients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the point of view of the provider, we are constantly connected to the same server with encrypted traffic.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, all devices connect to a laptop‚Äôs virtual access point.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before you start</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost all configs are available in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install tun2socks into the system</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As long as you have internet on your machine, download all the necessary tools.</font></font><br>
<br>
<pre><code class="bash hljs">apt update</code></pre><br>
<pre><code class="bash hljs">apt install git make cmake</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the badvpn package</font></font><br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/ambrop72/badvpn
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badvpn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> folder will appear on your system </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Create a separate build folder</font></font><br>
<br>
<pre><code class="bash hljs">mkdir badvpn-build
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to her</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> badvpn-build
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Build </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><br>
<br>
<pre><code class="bash hljs">cmake ../badvpn -DBUILD_NOTHING_BY_DEFAULT=1 -DBUILD_TUN2SOCKS=1
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install to system</font></font><br>
<br>
<pre><code class="bash hljs">make install
</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-DBUILD_NOTHING_BY_DEFAULT =</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 </font><font style="vertical-align: inherit;">parameter </font><font style="vertical-align: inherit;">disables the assembly of all components of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badvpn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> repository </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBUILD_TUN2SOCKS = 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> includes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> components in the assembly </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make install</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - installs the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> binary </font><font style="vertical-align: inherit;">on your system at </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ usr / local / bin / badvpn-tun2socks.</font></font></i></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install tun2socks service in systemd</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/tun2socks.service</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Description=SOCKS TCP Relay<font></font>
<font></font>
[Service]<font></font>
ExecStart=/usr/<span class="hljs-built_in">local</span>/bin/badvpn-tun2socks --tundev tun2socks --netif-ipaddr 172.16.1.1 --netif-netmask 255.255.255.0 --socks-server-addr 127.0.0.1:9050<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target<font></font>
</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--tundev</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - accepts the name of the virtual interface that we initialize with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--netif-ipaddr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - network address of the ‚Äúrouter‚Äù </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to which the virtual interface is connected. </font><font style="vertical-align: inherit;">It is better to make a separate </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reserved subnet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--socks-server-addr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - accepts a socket ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">address:</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SOCKS server </font><i><font style="vertical-align: inherit;">port</font></i><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your SOCKS server requires authentication, you can specify the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--username</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--password parameters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, register the service</font></font><br>
<br>
<pre><code class="bash hljs">systemctl daemon-reload</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And turn on</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">enable</span> tun2socks</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting the service, we will provide it with a virtual network interface.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to systemd-networkd</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turn on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">enable</span> systemd-networkd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disable current network services.</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">disable</span> networking NetworkManager NetworkManager-wait-online</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NetworkManager-wait-online</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a service that waits for a working network connection before </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> continues to start other services depending on the availability of the network. </font><font style="vertical-align: inherit;">We disable it, as we switch to the analog </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's turn it on right away:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">enable</span> systemd-networkd-wait-online</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set up a wireless network interface</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration file </font><font style="vertical-align: inherit;">for the wireless network interface </font></font><code>/etc/systemd/network/25-wlp6s0.network</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[Match]<font></font>
Name=wlp6s0<font></font>
<font></font>
[Network]<font></font>
Address=192.168.1.2/24<font></font>
IPMasquerade=yes<font></font>
</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of your wireless interface. </font><font style="vertical-align: inherit;">Identify it with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPMasquerade</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a directive that includes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masquerading</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and packet forwarding on a network interface.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Address</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is responsible for assigning an IP address to the wireless interface. </font><font style="vertical-align: inherit;">We specify it statically because with the equivalent directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP = yes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> creates a default gateway in the system. </font><font style="vertical-align: inherit;">Then all traffic will go through the original gateway, and not through the future virtual interface in an excellent subnet. </font><font style="vertical-align: inherit;">You can check the current default gateway with the command</font></font><pre><code class="bash hljs">ip r</code></pre></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a static route for the remote SOCKS server</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your SOCKS server is not local, but remote, then you need to create a static route for it. </font><font style="vertical-align: inherit;">To do this, add the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section </font><font style="vertical-align: inherit;">at the end of the wireless configuration file you created with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs">[Route]<font></font>
Gateway=192.168.1.1<font></font>
Destination=0.0.0.0<font></font>
</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gateway</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the default gateway or address of your original access point.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Destination</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - SOCKS server address.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure wpa_supplicant for systemd-networkd</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uses </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wpa_supplicant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to connect to a secure access point. </font><font style="vertical-align: inherit;">When you try to "raise" the wireless interface, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> starts the service </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wpa_supplicant @ name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of the wireless interface. </font><font style="vertical-align: inherit;">If you have not used </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> before this point, then for certain this service is not available on your system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, create it with the command:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">enable</span> wpa_supplicant@wlp6s0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I used </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wlp6s0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the name of my wireless interface. </font><font style="vertical-align: inherit;">Your name may be different. </font><font style="vertical-align: inherit;">You can find out by his team</font></font><pre><code class="bash hljs">ip l</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the created </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wpa_supplicant @ wlp6s0 service</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will start when the wireless interface is ‚Äúlifted‚Äù, however, it, in turn, will look for the SSID and password of the access point in the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / wpa_supplicant / wpa_supplicant-wlp6s0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, you must create it using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wpa_passphrase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, run the command:</font></font><br>
<br>
<pre><code class="bash hljs">wpa_passphrase SSID password&gt;/etc/wpa_supplicant/wpa_supplicant-wlp6s0.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of your access point, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">password</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the password, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wlp6s0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of your wireless interface.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize virtual interface for tun2socks</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a file to initialize a new virtual interface in the system </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/network/25-tun2socks.netdev</font></font></i><br>
<br>
<pre><code class="bash hljs">[NetDev]<font></font>
Name=tun2socks<font></font>
Kind=tun<font></font>
</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will assign to the future virtual interface when it is initialized.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kind</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a type of virtual interface. </font><font style="vertical-align: inherit;">Based on the name of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">, you can guess that it uses an interface like </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netdev</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the file extension that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uses to initialize virtual network interfaces. </font><font style="vertical-align: inherit;">The address and other network settings for these interfaces are specified in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> files.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/network/25-tun2socks.network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs">[Match]<font></font>
Name=tun2socks<font></font>
<font></font>
[Network]<font></font>
Address=172.16.1.2/24<font></font>
Gateway=172.16.1.1<font></font>
</code></pre><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the name of the virtual interface that you specified in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netdev</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Address</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - IP address to be assigned to the virtual interface. </font><font style="vertical-align: inherit;">Must be on the same network as the address you specified in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gateway</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the IP address of the ‚Äúrouter‚Äù </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that you specified when creating the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><font style="vertical-align: inherit;">has the address </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.16.1.2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">172.16.1.1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , that is, it is the gateway for all connections from the virtual interface.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure a virtual access point</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the dependencies:</font></font><br>
<br>
<pre><code class="bash hljs">apt install util-linux procps hostapd iw haveged</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_ap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> repository </font><font style="vertical-align: inherit;">to your machine:</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/oblique/create_ap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the repository folder on your machine:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> create_ap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install in the system:</font></font><br>
<br>
<pre><code class="bash hljs">make install</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The config </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/create_ap.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will appear on your system </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Here are the main options for editing:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GATEWAY = 10.0.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it is better to make a separate reserved subnet.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NO_DNS = 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - turn off, since this parameter will be controlled by the virtual systemd-networkd interface.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NO_DNSMASQ = 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - turn off for the same reason.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WIFI_IFACE = wlp6s0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - wireless interface of the laptop.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INTERNET_IFACE = tun2socks&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - virtual interface created for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSID = hostapd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - name of the virtual access point.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PASSPHRASE = 12345678</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - password.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remember to enable the service:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl <span class="hljs-built_in">enable</span> create_ap</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enable DHCP server in systemd-networkd</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_ap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">initializes the </font><i><font style="vertical-align: inherit;">ap0</font></i><font style="vertical-align: inherit;"> virtual interface on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">system</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theoretically</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><i><font style="vertical-align: inherit;">dnsmasq</font></i><font style="vertical-align: inherit;"> hangs on this interface </font><font style="vertical-align: inherit;">, but why install extra services if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains a built-in DHCP server? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To enable it, define the network settings for the virtual point. To do this, create the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/network/25-ap0.network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs">[Match]<font></font>
Name=ap0<font></font>
<font></font>
[Network]<font></font>
Address=10.0.0.1/24<font></font>
DHCPServer=yes<font></font>
<font></font>
[DHCPServer]<font></font>
EmitDNS=yes<font></font>
DNS=10.0.0.1<font></font>
EmitNTP=yes<font></font>
NTP=10.0.0.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the service </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sreate_ap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initializes virtual interface </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-NetworkD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatically assign an IP-address and enable the DHCP-server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The lines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmitDNS = yes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS = 10.0.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pass the DNS server settings to devices connected to the access point. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you do not plan to use a local DNS server - in my case it is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - you can set </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS = 10.0.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS = 192.168.1.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.1.1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the address of your original gateway. Then the DNS queries of your host and local network will go unencrypted through the provider's servers. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmitNTP = yes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTP = 192.168.1.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> transmit the NTP settings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same goes for the line </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTP = 10.0.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install and configure NTP server</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install in the system:</font></font><br>
<br>
<pre><code class="bash hljs">apt install ntp
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit the config </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ntp.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Comment out the addresses of standard pools:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#pool 0.debian.pool.ntp.org iburst</span>
<span class="hljs-comment">#pool 1.debian.pool.ntp.org iburst</span>
<span class="hljs-comment">#pool 2.debian.pool.ntp.org iburst</span>
<span class="hljs-comment">#pool 3.debian.pool.ntp.org iburst</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the addresses of public servers, for example, Google Public NTP:</font></font><br>
<br>
<pre><code class="bash hljs">server time1.google.com ibrust<font></font>
server time2.google.com ibrust<font></font>
server time3.google.com ibrust<font></font>
server time4.google.com ibrust<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grant access to the server to clients from your network:</font></font><br>
<br>
<pre><code class="bash hljs">restrict 10.0.0.0 mask 255.255.255.0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turn the broadcast into your network:</font></font><br>
<br>
<pre><code class="bash hljs">broadcast 10.0.0.255
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, add the addresses of these servers to the static routing table. </font><font style="vertical-align: inherit;">To do this, open the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/network/25-wlp6s0.network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wireless interface configuration file </font><font style="vertical-align: inherit;">and add the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section at the end </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[Route]<font></font>
Gateway=192.168.1.1<font></font>
Destination=216.239.35.0<font></font>
<font></font>
[Route]<font></font>
Gateway=192.168.1.1<font></font>
Destination=216.239.35.4<font></font>
<font></font>
[Route]<font></font>
Gateway=192.168.1.1<font></font>
Destination=216.239.35.8<font></font>
<font></font>
[Route]<font></font>
Gateway=192.168.1.1<font></font>
Destination=216.239.35.12</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can find out the addresses of your NTP servers using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">host</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">as follows:</font></font><br>
<br>
<pre><code class="bash hljs">host time1.google.com</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , remove ads and hide DNS traffic from the provider</font></font></h2><br>
<pre><code class="bash hljs">apt install dnscrypt-proxy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To serve the DNS queries of the host and local network, edit the socket </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/lib/systemd/system/dnscrypt-proxy.socket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Change the following lines:</font></font><br>
<br>
<pre><code class="bash hljs">ListenStream=0.0.0.0:53<font></font>
ListenDatagram=0.0.0.0:53</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Restart </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl daemon-reload</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit the config </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/dnscrypt-proxy/dnscrypt-proxy.toml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">server_names = [<span class="hljs-string">'adguard-dns'</span>]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To route dnscrypt-proxy connections through </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , add below:</font></font><br>
<br>
<pre><code class="bash hljs">force_tcp = <span class="hljs-literal">true</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/resolv.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> config </font><font style="vertical-align: inherit;">that tells the DNS server to the host.</font></font><br>
<br>
<pre><code class="bash hljs">nameserver 127.0.0.1<font></font>
nameserver 192.168.1.1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first line includes the use of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the second - uses the original gateway, in case the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server is </font><font style="vertical-align: inherit;">unavailable.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Done!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reboot or stop existing network services:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop networking NetworkManager NetworkManager-wait-online</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And restart all the necessary ones:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl restart systemd-networkd tun2socks create_ap dnscrypt-proxy ntp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After rebooting or restarting, you will have a second access point that routes the host and LAN devices to SOCKS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is what the output looks like.</font></font><pre><code class="bash hljs">ip a</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regular laptop:</font></font><br>
<br>
<pre><code class="bash hljs">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<font></font>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<font></font>
    inet 127.0.0.1/8 scope host lo<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 ::1/128 scope host <font></font>
       valid_lft forever preferred_lft forever<font></font>
2: tun2socks: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 500<font></font>
    link/none <font></font>
    inet 172.16.1.2/24 brd 172.16.1.255 scope global tun2socks<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 fe80::122b:260:6590:1b0e/64 scope link stable-privacy <font></font>
       valid_lft forever preferred_lft forever<font></font>
3: enp4s0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000<font></font>
    link/ether e8:11:32:0e:01:50 brd ff:ff:ff:ff:ff:ff<font></font>
4: wlp6s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<font></font>
    link/ether 4c:ed:de:cb:cf:85 brd ff:ff:ff:ff:ff:ff<font></font>
    inet 192.168.1.2/24 brd 192.168.1.255 scope global wlp6s0<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 fe80::4eed:deff:fecb:cf85/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
5: ap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000<font></font>
    link/ether 4c:ed:de:cb:cf:86 brd ff:ff:ff:ff:ff:ff<font></font>
    inet 10.0.0.1/24 brd 10.0.0.255 scope global ap0<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 fe80::4eed:deff:fecb:cf86/64 scope link <font></font>
       valid_lft forever preferred_lft forever<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventually</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The provider only sees the encrypted connection to your SOCKS server, which means that it does not see anything.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And yet he sees your NTP requests, to prevent this, delete the static routes for NTP servers. </font><font style="vertical-align: inherit;">However, it is not a fact that your SOCKS server allows NTP.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crutch seen on Debain 10</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you try to restart the network service from the console, it will fail with an error. </font><font style="vertical-align: inherit;">This is due to the fact that part of it in the form of a virtual interface is tied to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">, which means it is used. </font><font style="vertical-align: inherit;">To restart the network service, you must first stop the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tun2socks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But, I think, if you read to the end, for you it is definitely not a problem!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h4><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static Routing on Linux - IBM</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemd-networkd.service - Freedesktop.org</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tun2socks ambrop72 / badvpn wiki github</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oblique / create_ap: This script creates a NATed or Bridged WiFi Access Point.</font></font></a><br>
 </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt-proxy 2 - A flexible DNS proxy, with support for encrypted DNS protocols.</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491558/index.html">Find more rock Easter eggs: from mysterious messages to calls to wash your hands and do your homework</a></li>
<li><a href="../en491560/index.html">How to make the terminal your assistant, not an enemy?</a></li>
<li><a href="../en491562/index.html">FOSS News No. 6 - review of free and open source news for March 2-8, 2020</a></li>
<li><a href="../en491564/index.html">Java 14: Record, a more concise instanceof, jpackage wrapper, switch lambdas and text blocks</a></li>
<li><a href="../en491566/index.html">Machine learning in R language using mlr3 package</a></li>
<li><a href="../en491570/index.html">Why ICQ lost an ancient user after buying Mail.Ru</a></li>
<li><a href="../en491572/index.html">The digest of fresh materials from the world of the front-end for the last week No. 405 (March 2 - 8, 2020)</a></li>
<li><a href="../en491574/index.html">A simple trick for managing procrastination</a></li>
<li><a href="../en491576/index.html">Transformers as Graph Neural Networks</a></li>
<li><a href="../en491584/index.html">The digest of interesting materials for the mobile developer # 336 (March 2 - 9)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>