<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∏Ô∏è ‚ö±Ô∏è ü¶á Replacing smaller disks with larger disks in Linux ü§úüèø üåè üë∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In anticipation of the launch of a new group of the Linux Administrator course , we are publishing useful material written by our stud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Replacing smaller disks with larger disks in Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/486084/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. In anticipation of the launch of a new group of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Linux Administrator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">, we are</font></a><font style="vertical-align: inherit;"> publishing useful material written by our student, as well as the course mentor, REG.RU corporate product technical support specialist Roman Travin.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/uo/ar/_j/uoar_jhfy1k5vvnqceiil6cbe10.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This article will discuss 2 cases of replacing disks and transferring information to new disks of a larger volume with further expansion of the array and file system. The first case will concern the replacement of disks with the same MBR / MBR or GPT / GPT markup, the second case will concern the replacement of disks with MBR marking by disks with a capacity of more than 2 TB, on which GPT markup with the biosboot partition will be required. In both cases, the disks to which we transfer data are already installed on the server. The file system used for the root partition is ext4.</font></font><br>
<br>
<hr><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case 1: Replacing smaller drives with larger drives (up to 2TB)</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Replace current drives with larger drives (up to 2 TB) with information transfer. </font><font style="vertical-align: inherit;">In this case, we have 2 x 240 GB SSD (RAID-1) disks with the installed system and 2 x 1 TB SATA disks on which you need to transfer the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the current disk layout.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
sdd              8:48   0 931,5G  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the current file system space used.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># df -h</span><font></font>
          % C <font></font>
devtmpfs                32G            0   32G            0% /dev<font></font>
tmpfs                   32G            0   32G            0% /dev/shm<font></font>
tmpfs                   32G         9,6M   32G            1% /run<font></font>
tmpfs                   32G            0   32G            0% /sys/fs/cgroup<font></font>
/dev/mapper/vg0-root   204G         1,3G  192G            1% /<font></font>
/dev/md126            1007M         120M  837M           13% /boot<font></font>
tmpfs                  6,3G            0  6,3G            0% /run/user/0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file system size before replacing the disks is 204 GB, 2 md126 program arrays are used, which is mounted in </font></font><code>/boot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>md127</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is used as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">physical volume</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the VG group </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vg0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Removing disk partitions from arrays</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the state of the array</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sda1[0] sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sda2[0] sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/2 pages [0KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system uses 2 arrays: </font></font><code>md126</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(mount point </font></font><code>/boot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - consists of a partition </font></font><code>/dev/sda1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdb1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>md127</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(LVM for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the root of the file system) - consists of </font></font><code>/dev/sda2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdb2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We mark the partitions of the first disk that are used in each array as bad.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --fail /dev/sda1<font></font>
<font></font>
mdadm /dev/md127 --fail /dev/sda2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remove sections of the block device / dev / sda from arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --remove /dev/sda1<font></font>
<font></font>
mdadm /dev/md127 --remove /dev/sda2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we removed the disk from the array, information about block devices will look like this.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
sdd              8:48   0 931,5G  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The state of arrays after removing disks.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/1] [_U]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/1] [_U]<font></font>
      bitmap: 1/2 pages [4KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Copying the partition table to a new disk</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can check the partition table used on the disk with the following command.</font></font><br>
<br>
<pre><code class="bash hljs">fdisk -l /dev/sdb | grep <span class="hljs-string">'Disk label type'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The output for the MBR will be:</font></font><br>
<br>
<pre><code class="bash hljs">Disk label <span class="hljs-built_in">type</span>: dos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
for GPT:</font></font><br>
<br>
<pre><code class="bash hljs">Disk label <span class="hljs-built_in">type</span>: gpt</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy markup table for MBR:</font></font><br>
</b><br>
<pre><code class="bash hljs">sfdisk -d /dev/sdb | sfdisk /dev/sdc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this command </font><font style="vertical-align: inherit;">, the disk </font><b><font style="vertical-align: inherit;">from </font></b><b><font style="vertical-align: inherit;">which the</font></b><font style="vertical-align: inherit;"> markup </font><b><font style="vertical-align: inherit;">is</font></b><font style="vertical-align: inherit;"> copied is </font><font style="vertical-align: inherit;">indicated </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the </font><b><font style="vertical-align: inherit;">second is where to</font></b><font style="vertical-align: inherit;"> copy.</font></font><b><font style="vertical-align: inherit;"></font></b> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : For GPT </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specified disk </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on which</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to copy the layout, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the second</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> disk drive is specified </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from which</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to copy the markup. </font><font style="vertical-align: inherit;">If you mix up the disks, then the initially healthy markup will be overwritten and destroyed.</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copying the markup table for the GPT:</font></font><br>
</b><br>
<pre><code class="bash hljs">sgdisk -R /dev/sd /dev/sdb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, assign a random UUID to the disk (for GPT).</font></font><br>
<br>
<pre><code class="bash hljs">
sgdisk -G /dev/sdc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the command is executed, partitions should appear on the disk </font></font><code> /dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
sdd              8:48   0 931,5G  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If after the performed action the partitions in the system on the disk are </font></font><code>/dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not defined, then we execute the command to re-read the partition table.</font></font><br>
<br>
<pre><code class="bash hljs">sfdisk -R /dev/sdc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the current disks use the MBR table and the information needs to be transferred to disks larger than 2 TB, then new disks will need to manually create GPT markup using the biosboot partition. </font><font style="vertical-align: inherit;">This case will be considered in part 2 of this article.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Adding partitions of the new disk to the array</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add disk partitions to the corresponding arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --add /dev/sdc1<font></font>
<font></font>
mdadm /dev/md127 --add /dev/sdc2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check that sections have been added.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that we wait for the synchronization of arrays. </font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdc1[2] sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdc2[2] sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/1] [_U]<font></font>
      [==&gt;..................]  recovery = 10.6% (24859136/233206784) finish=29.3min speed=118119K/sec<font></font>
      bitmap: 2/2 pages [8KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can continuously monitor the synchronization process using the utility </font></font><code>watch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">watch -n 2 cat /proc/mdstat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The parameter </font></font><code>-n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicates at what intervals in seconds it is necessary to execute a command to check progress. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repeat steps 1 - 3 for the next replacement drive. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We mark the partitions of the second disk, which are used in each array, as bad.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --fail /dev/sdb1<font></font>
<font></font>
mdadm /dev/md127 --fail /dev/sdb2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We delete sections of the block device </font></font><code> /dev/sdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --remove /dev/sdb1<font></font>
<font></font>
mdadm /dev/md127 --remove /dev/sdb2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we removed the disk from the array, information about block devices will look like this.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The state of arrays after removing disks.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdc1[2]<font></font>
      1047552 blocks super 1.2 [2/1] [U_]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdc2[2]<font></font>
      233206784 blocks super 1.2 [2/1] [U_]<font></font>
      bitmap: 1/2 pages [4KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy the MBR markup table from disk </font></font><code>/dev/sd </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to disk </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">sfdisk -d /dev/sd | sfdisk /dev/sdd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the command is executed, partitions should appear on the disk </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     1G  0 part  <font></font>
‚îî‚îÄsdd2           8:50   0 222,5G  0 part  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add disk partitions to arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --add /dev/sdd1<font></font>
<font></font>
mdadm /dev/md127 --add /dev/sdd2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check that sections have been added.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd2           8:50   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that we wait for the synchronization of arrays. </font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdd1[3] sdc1[2]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdd2[3] sdc2[2]<font></font>
      233206784 blocks super 1.2 [2/1] [U_]<font></font>
      [&gt;....................]  recovery =  0.5% (1200000/233206784) finish=35.4min speed=109090K/sec<font></font>
      bitmap: 2/2 pages [8KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Install GRUB on new drives</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">grub2-install /dev/sdX</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">grub-install /dev/sdX</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where </font></font><code>X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the letter of the block device. </font><font style="vertical-align: inherit;">In this case, install GRUB on </font></font><code>/dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Extension of the file system (ext4) of the root partition</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On new disks </font></font><code>/dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">available 931.5 GB. </font><font style="vertical-align: inherit;">Due to the fact that the partition table is a smaller volume is copied from CDs, on the sections </font></font><code> /dev/sdc2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdd2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are available 222.5 GB.</font></font><br>
<br>
<pre><code class="bash hljs">sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd2           8:50   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend section 2 on each drive,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend the md127 array,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expand PV (physical volume),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend LV (logical-volume) vg0-root,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend the file system.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parted</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> we expand the section </font></font><code>/dev/sdc2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the maximum value. </font><font style="vertical-align: inherit;">We execute command </font></font><code>parted /dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1) and view the current partition table with command </font></font><code>p</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(2). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/zx/xc/aozxxc_zhq42me4qblnij5bib4y.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the end of section 2 ends with 240 GB. </font><font style="vertical-align: inherit;">Let's expand the section with the command </font></font><code>resizepart</code> <code>2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where 2 is the section number (3). </font><font style="vertical-align: inherit;">We indicate the value in digital format, for example 1000 GB, or we use the indication of the disk share - 100%. </font><font style="vertical-align: inherit;">Again we check that the section has a new size (4). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Repeat the above steps for the disk </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">After the expansion of the sections, </font></font><code>/dev/sdc2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they </font></font><code>/dev/sdd2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">became equal to 930.5 GB.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk                                                 </span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 930,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd2           8:50   0 930,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, we expand the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">md127</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">to the maximum.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm --grow /dev/md127 --size=max</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check that the array has expanded. </font><font style="vertical-align: inherit;">Now its size has become 930.4 GB.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc2           8:34   0 930,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 930,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0 931,5G  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd2           8:50   0 930,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 930,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We perform the expansion of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">physical volume</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Before expansion, check the current state of PV.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># pvscan</span><font></font>
  PV /dev/md127   VG vg0             lvm2 [222,40 GiB / 0    free]<font></font>
  Total: 1 [222,40 GiB] / <span class="hljs-keyword">in</span> use: 1 [222,40 GiB] / <span class="hljs-keyword">in</span> no VG: 0 [0   ]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, PV </font></font><code>/dev/md127</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses 222.4 GB of space. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expand PV with the following command.</font></font><br>
<br>
<pre><code class="bash hljs">pvresize /dev/md127</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the result of the PV extension. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[</font></font><pre><code class="bash hljs">root@localhost ~]<span class="hljs-comment"># pvscan</span><font></font>
  PV /dev/md127   VG vg0             lvm2 [930,38 GiB / 707,98 GiB free]<font></font>
  Total: 1 [930,38 GiB] / <span class="hljs-keyword">in</span> use: 1 [930,38 GiB] / <span class="hljs-keyword">in</span> no VG: 0 [0   ]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expanding </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logical volume</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Before the extension, check the current status of LV (1).</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lvscan</span>
  ACTIVE            <span class="hljs-string">'/dev/vg0/swap'</span> [&lt;16,00 GiB] inherit<font></font>
  ACTIVE            <span class="hljs-string">'/dev/vg0/root'</span> [&lt;206,41 GiB] inherit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LV </font></font><code>/dev/vg0/root</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses 206.41 GB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We expand LV with the following command (2).</font></font><br>
<br>
<pre><code class="bash hljs">lvextend -l +100%FREE /dev/mapper/vg0-root</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the performed action (3).</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lvscan </span>
  ACTIVE            <span class="hljs-string">'/dev/vg0/swap'</span> [&lt;16,00 GiB] inherit<font></font>
  ACTIVE            <span class="hljs-string">'/dev/vg0/root'</span> [&lt;914,39 GiB] inherit
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, after expanding LV, the amount of disk space occupied became 914.39 GB. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vd/6r/qh/vd6rqhe3wvbukzdfachz7xf4ehk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LV volume has increased (4), but the file system still occupies 204 GB (5). </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Perform the file system extension.</font></font></i><br>
<br>
<pre><code class="bash hljs">resize2fs /dev/mapper/vg0-root</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check after the executed command the size of the file system.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># df -h</span><font></font>
          % C <font></font>
devtmpfs                32G            0   32G            0% /dev<font></font>
tmpfs                   32G            0   32G            0% /dev/shm<font></font>
tmpfs                   32G         9,5M   32G            1% /run<font></font>
tmpfs                   32G            0   32G            0% /sys/fs/cgroup<font></font>
/dev/mapper/vg0-root   900G         1,3G  860G            1% /<font></font>
/dev/md126            1007M         120M  837M           13% /boot<font></font>
tmpfs                  6,3G            0  6,3G            0% /run/user/0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The size of the root file system will increase to 900 GB. </font><font style="vertical-align: inherit;">After completing the steps, you can remove the old discs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case 2: Replacing smaller drives with larger drives (more than 2TB)</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Replace current disks with larger disks (2 x 3TB) with saving information. </font><font style="vertical-align: inherit;">In this case, we have 2 x 240 GB SSD (RAID-1) disks with the installed system and 2 x 3 TB SATA disks to which you need to transfer the system. </font><font style="vertical-align: inherit;">Current drives use the MBR partition table. </font><font style="vertical-align: inherit;">Since new disks have a capacity of more than 2 TB, they will need to use the GPT table, since MBR cannot work with disks larger than 2TB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
View the current disk layout.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
sdd              8:48   0   2,7T  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the partition table used on the disk </font></font><code>/dev/sda</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># fdisk -l /dev/sda | grep 'Disk label type'</span>
Disk label <span class="hljs-built_in">type</span>: dos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The disk </font></font><code>/dev/sdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses a similar partition table. </font><font style="vertical-align: inherit;">Check the used disk space in the system.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># df -h</span><font></font>
          % C <font></font>
devtmpfs                16G            0   16G            0% /dev<font></font>
tmpfs                   16G            0   16G            0% /dev/shm<font></font>
tmpfs                   16G         9,5M   16G            1% /run<font></font>
tmpfs                   16G            0   16G            0% /sys/fs/cgroup<font></font>
/dev/mapper/vg0-root   204G         1,3G  192G            1% /<font></font>
/dev/md126            1007M         120M  837M           13% /boot<font></font>
tmpfs                  3,2G            0  3,2G            0% /run/user/0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the root of the file system is 204 GB. </font><font style="vertical-align: inherit;">Check the current state of the software RAID.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Install GPT partition table and disk partitioning</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check disk layout by sector.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># parted /dev/sda print</span><font></font>
: ATA KINGSTON SVP200S (scsi)<font></font>
 /dev/sda: 240GB<font></font>
  (./.): 512B/512B<font></font>
 : msdos<font></font>
Disk Flags: <font></font>
<font></font>
                  <font></font>
 1     1049kB  1076MB  1075MB  primary                    , raid<font></font>
 2     1076MB  240GB   239GB   primary                    raid<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the new 3TB drive, we will need to create 3 partitions: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CATEGORY </font></font><code>bios_grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2MiB GPT size for compatibility with the BIOS,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The partition for the RAID array to be mounted on </font></font><code>/boot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The partition for the RAID array, on which will be </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LV root</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LV swap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parted</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><i><font style="vertical-align: inherit;">with the</font></i><font style="vertical-align: inherit;"> command </font></font><code>yum install -y parted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for CentOS), </font></font><code>apt install -y parted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(for Debian / Ubuntu). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parted,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> execute the following commands to partition the disk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We execute the command </font></font><code>parted /dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and go into edit mode for disk layout. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a GPT partition table.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) mktable gpt</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create 1 section </font></font><code>bios_grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">section and set a flag for it.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) mkpart primary 1MiB 3MiB<font></font>
(parted) <span class="hljs-built_in">set</span> 1 bios_grub on  </code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a 2 section and set a flag for it. </font><font style="vertical-align: inherit;">The partition will use as a block for the RAID array and mount it in </font></font><code>/boot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) mkpart primary ext2 3MiB 1028MiB<font></font>
(parted) <span class="hljs-built_in">set</span> 2 boot on</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create a 3 section, which will also be used as an array block in which there will be LVM.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) mkpart primary 1028MiB 100% </code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, setting the flag is not necessary, but if necessary, it is possible to set it with the following command.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) <span class="hljs-built_in">set</span> 3 raid on</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the created table.</font></font><br>
<br>
<pre><code class="bash hljs">(parted) p                                                                <font></font>
: ATA TOSHIBA DT01ACA3 (scsi)<font></font>
 /dev/sdc: 3001GB<font></font>
  (./.): 512B/4096B<font></font>
 : gpt<font></font>
Disk Flags: <font></font>
<font></font>
                  <font></font>
 1     1049kB  3146kB  2097kB                    primary  bios_grub<font></font>
 2     3146kB  1077MB  1074MB                    primary  <font></font>
 3     1077MB  3001GB  3000GB                    primary<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assign the drive a new random GUID.</font></font><br>
<br>
<pre><code class="bash hljs">sgdisk -G /dev/sdd
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Removing partitions of the first disk from arrays</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the state of the array</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sda1[0] sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sda2[0] sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/2 pages [0KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system uses 2 arrays: md126 (mount point / boot) - consists of </font></font><code>/dev/sda1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdb1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>md127</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(LVM for </font></font><code>swap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the root of the file system) - consists of </font></font><code>/dev/sda2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdb2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We mark the partitions of the first disk that are used in each array as bad.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --fail /dev/sda1<font></font>
<font></font>
mdadm /dev/md127 --fail /dev/sda2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We delete sections of the block device </font></font><code>/dev/sda</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --remove /dev/sda1<font></font>
<font></font>
mdadm /dev/md127 --remove /dev/sda2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the state of the array after removing the disk.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/1] [_U]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/1] [_U]<font></font>
      bitmap: 2/2 pages [8KB], 65536KB chunk<font></font>
<font></font>
unused devices: &lt;none&gt;<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Adding partitions of the new disk to the array</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to add the partitions of the new disk to the arrays for synchronization. </font><font style="vertical-align: inherit;">We look at the current state of the disk layout.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
sdd              8:48   0   2,7T  0 disk  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A section </font></font><code>/dev/sdc1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a </font></font><code>bios_grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">section and is not involved in creating arrays. </font><font style="vertical-align: inherit;">In arrays, only </font></font><code>/dev/sdc2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">will be involved </font></font><code>/dev/sdc3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Add these sections to the corresponding arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --add /dev/sdc2<font></font>
<font></font>
mdadm /dev/md127 --add /dev/sdc3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we wait for the synchronization of the array.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdc2[2] sdb1[1]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 0/1 pages [0KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdc3[2] sdb2[1]<font></font>
      233206784 blocks super 1.2 [2/1] [_U]<font></font>
      [&gt;....................]  recovery =  0.2% (619904/233206784) finish=31.2min speed=123980K/sec<font></font>
      bitmap: 2/2 pages [8KB], 65536KB chunk<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partitioning disks after adding partitions to an array.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0   2,7T  0 disk  </code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Removing partitions of the second disk from arrays</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We mark the partitions of the second disk, which are used in each array, as bad.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --fail /dev/sdb1<font></font>
<font></font>
mdadm /dev/md127 --fail /dev/sdb2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We delete sections of the block device </font></font><code>/dev/sda</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --remove /dev/sdb1<font></font>
<font></font>
mdadm /dev/md127 --remove /dev/sdb2<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Copy the GPT markup table and synchronize the array</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To copy the GPT markup table, we will use the utility </font></font><code>sgdisk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is included in the package for working with disk partitions and the GPT table </font></font><code>gdisk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation </font></font><code>gdisk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">yum install -y gdisk</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation </font></font><code>gdisk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">apt install -y gdisk</code></pre><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATTENTION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : For GPT </font><font style="vertical-align: inherit;">, the disk </font><b><font style="vertical-align: inherit;">to which the</font></b><font style="vertical-align: inherit;"> markup is copied is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indicated </font><font style="vertical-align: inherit;">, the </font><b><font style="vertical-align: inherit;">second</font></b><font style="vertical-align: inherit;"> disk is the disk </font><b><font style="vertical-align: inherit;">from which the</font></b><font style="vertical-align: inherit;"> markup </font><b><font style="vertical-align: inherit;">is</font></b><font style="vertical-align: inherit;"> copied. </font><font style="vertical-align: inherit;">If you mix up the disks, then the initially healthy markup will be overwritten and destroyed.</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy the GPT markup table.</font></font><br>
<br>
<pre><code class="bash hljs">sgdisk -R /dev/sdd /dev/sdc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partitioning disks after transferring a table to disk </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     2M  0 part  <font></font>
‚îú‚îÄsdd2           8:50   0     1G  0 part  <font></font>
‚îî‚îÄsdd3           8:51   0   2,7T  0 part  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we add each of the partitions participating in the software RAID arrays.</font></font><br>
<br>
<pre><code class="bash hljs">mdadm /dev/md126 --add /dev/sdd2<font></font>
<font></font>
mdadm /dev/md127 --add /dev/sdd3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are waiting for the synchronization of the array.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># cat /proc/mdstat </span><font></font>
Personalities : [raid1] <font></font>
md126 : active raid1 sdd2[3] sdc2[2]<font></font>
      1047552 blocks super 1.2 [2/2] [UU]<font></font>
      bitmap: 1/1 pages [4KB], 65536KB chunk<font></font>
<font></font>
md127 : active raid1 sdd3[3] sdc3[2]<font></font>
      233206784 blocks super 1.2 [2/1] [U_]<font></font>
      [&gt;....................]  recovery =  0.0% (148224/233206784) finish=26.2min speed=148224K/sec<font></font>
      bitmap: 2/2 pages [8KB], 65536KB chunk<font></font>
unused devices: &lt;none&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After copying the GPT markup to a second new disk, the markup will look like this.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
‚îú‚îÄsda1           8:1    0     1G  0 part  <font></font>
‚îî‚îÄsda2           8:2    0 222,5G  0 part  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
‚îú‚îÄsdb1           8:17   0     1G  0 part  <font></font>
‚îî‚îÄsdb2           8:18   0 222,5G  0 part  <font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     2M  0 part  <font></font>
‚îú‚îÄsdd2           8:50   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd126        9:126  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd3           8:51   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd127        9:127  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, install GRUB on the new drives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation for CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">grub2-install /dev/sdX</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation for Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">grub-install /dev/sdX</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where </font></font><code>X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the drive letter, in our case, the drives </font></font><code>/dev/sdc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/dev/sdd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Updating the information about the array. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">mdadm --detail --scan --verbose &gt; /etc/mdadm.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">echo</span> <span class="hljs-string">"DEVICE partitions"</span> &gt; /etc/mdadm/mdadm.conf<font></font>
<font></font>
mdadm --detail --scan --verbose | awk <span class="hljs-string">'/ARRAY/ {print}'</span> &gt;&gt; /etc/mdadm/mdadm.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update image </font></font><code>initrd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">dracut -f -v --regenerate-all</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">update-initramfs -u -k all</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Updating the GRUB configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For CentOS:</font></font><br>
<br>
<pre><code class="bash hljs">grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Debian / Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">update-grub</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the completed steps, the old discs can be removed.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Extension of the file system (ext4) of the root partition</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Partitioning disks before expanding the file system after moving the system to 2 x 3TB (RAID-1) disks.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd127        9:127  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd126        9:126  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     2M  0 part  <font></font>
‚îú‚îÄsdd2           8:50   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd127        9:127  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd3           8:51   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd126        9:126  0 222,4G  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now sections </font></font><code>/dev/sdc3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code> /dev/sdd3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">occupy 2.7 TB. </font><font style="vertical-align: inherit;">Since we created a new partitioning of disks with a GPT table, the size of the 3 partitions was immediately set to the maximum possible disk space, in this case we do not need to expand the partition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend the md126 array,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expand PV (physical volume),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend LV (logical-volume) vg0-root,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extend the file system.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Expand the array </font></font><code>md126</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the maximum.</font></font></i><br>
<br>
<pre><code class="bash hljs">mdadm --grow /dev/md126 --size=max
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After expanding the array, the </font></font><code>md126</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">size of the occupied space increased to 2.7 TB.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lsblk</span><font></font>
NAME           MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT<font></font>
sda              8:0    0 223,6G  0 disk  <font></font>
sdb              8:16   0 223,6G  0 disk  <font></font>
sdc              8:32   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdc1           8:33   0     2M  0 part  <font></font>
‚îú‚îÄsdc2           8:34   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd127        9:127  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdc3           8:35   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd126        9:126  0   2,7T  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
sdd              8:48   0   2,7T  0 disk  <font></font>
‚îú‚îÄsdd1           8:49   0     2M  0 part  <font></font>
‚îú‚îÄsdd2           8:50   0     1G  0 part  <font></font>
‚îÇ ‚îî‚îÄmd127        9:127  0  1023M  0 raid1 /boot<font></font>
‚îî‚îÄsdd3           8:51   0   2,7T  0 part  <font></font>
  ‚îî‚îÄmd126        9:126  0   2,7T  0 raid1 <font></font>
    ‚îú‚îÄvg0-root 253:0    0 206,4G  0 lvm   /<font></font>
    ‚îî‚îÄvg0-swap 253:1    0    16G  0 lvm   [SWAP]<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expanding </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">physical volume</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before expansion, we check the current value of the occupied space PV / </font></font><code>dev/md126</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># pvs</span><font></font>
  PV         VG  Fmt  Attr PSize   PFree<font></font>
  /dev/md126 vg0 lvm2 a--  222,40g    0 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expand PV with the following command.</font></font><br>
<br>
<pre><code class="bash hljs">pvresize /dev/md126
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the completed action.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># pvs</span><font></font>
  PV         VG  Fmt  Attr PSize  PFree<font></font>
  /dev/md126 vg0 lvm2 a--  &lt;2,73t 2,51t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expanding </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class logical volume vg0-root</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After expanding PV, we check the occupied space of VG.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># vgs</span>
  VG  <span class="hljs-comment">#PV #LV #SN Attr   VSize  VFree</span>
  vg0   1   2   0 wz--n- &lt;2,73t 2,51t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the space occupied by LV.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lvs</span><font></font>
  LV   VG  Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert<font></font>
  root vg0 -wi-ao---- &lt;206,41g                                                    <font></font>
  swap vg0 -wi-ao----  &lt;16,00g            </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The vg0-root volume takes up 206.41 GB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expand LV to maximum disk space.</font></font><br>
<br>
<pre><code class="bash hljs">lvextend -l +100%FREE /dev/mapper/vg0-root </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Checking the LV space after expansion.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># lvs</span><font></font>
  LV   VG  Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert<font></font>
  root vg0 -wi-ao----   2,71t                                                    <font></font>
  swap vg0 -wi-ao---- &lt;16,00g</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Extending the file system (ext4). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the current file system size.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># df -h</span><font></font>
          % C <font></font>
devtmpfs                16G            0   16G            0% /dev<font></font>
tmpfs                   16G            0   16G            0% /dev/shm<font></font>
tmpfs                   16G         9,6M   16G            1% /run<font></font>
tmpfs                   16G            0   16G            0% /sys/fs/cgroup<font></font>
/dev/mapper/vg0-root   204G         1,4G  192G            1% /<font></font>
/dev/md127            1007M         141M  816M           15% /boot<font></font>
tmpfs                  3,2G            0  3,2G            0% /run/user/0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The / dev / mapper / vg0-root volume takes up 204 GB after the LV extension. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expanding the file system.</font></font><br>
<br>
<pre><code class="bash hljs">resize2fs /dev/mapper/vg0-root 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the size of the file system after its expansion.</font></font><br>
<br>
<pre><code class="bash hljs">[root@localhost ~]<span class="hljs-comment"># df -h</span><font></font>
          % C <font></font>
devtmpfs                16G            0   16G            0% /dev<font></font>
tmpfs                   16G            0   16G            0% /dev/shm<font></font>
tmpfs                   16G         9,6M   16G            1% /run<font></font>
tmpfs                   16G            0   16G            0% /sys/fs/cgroup<font></font>
/dev/mapper/vg0-root   2,7T         1,4G  2,6T            1% /<font></font>
/dev/md127            1007M         141M  816M           15% /boot<font></font>
tmpfs                  3,2G            0  3,2G            0% /run/user/0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file system size is increased by the entire volume of the volume.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486070/index.html">ACL switches in detail</a></li>
<li><a href="../en486072/index.html">SQL HowTo: write a while-loop directly in the query, or "Elementary three-way"</a></li>
<li><a href="../en486076/index.html">From Ground to FPV Quadcopter: Introduction</a></li>
<li><a href="../en486080/index.html">Let me introduce: Veeam Availability Suite v10</a></li>
<li><a href="../en486082/index.html">Dagaz: The Sum of Technology</a></li>
<li><a href="../en486092/index.html">Marina Alex, CEO of University of Business Agility: ‚ÄúAgile is out of IT. Agile - More Than IT ‚Äù</a></li>
<li><a href="../en486094/index.html">House Democrat Fights Silicon Valley</a></li>
<li><a href="../en486098/index.html">How tech debt kills your projects</a></li>
<li><a href="../en486100/index.html">How to create a decentralized application that scales? Use less blockchain</a></li>
<li><a href="../en486106/index.html">Adaptive Backlight for Raspberry Pi TV - Ambilight Analog</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>