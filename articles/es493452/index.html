<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👺 ☦️ 🎼 Desenfoque de imagen de fondo de la unidad ☮️ ♋️ 🎿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una de las tareas que puede encontrar un desarrollador de aplicaciones de Unity es poner la imagen actual en segundo plano para cambiar la atención de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Desenfoque de imagen de fondo de la unidad</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493452/"><img src="https://habrastorage.org/webt/jb/sq/go/jbsqgovdy74rajkik0r_o24tre8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las tareas que puede encontrar un desarrollador de aplicaciones de Unity es poner la imagen actual en segundo plano para cambiar la atención del usuario a algo nuevo, como un menú o mensaje que aparece. El artículo habla sobre la experiencia de resolver este problema por un desarrollador que tiene conocimientos básicos en Unity, sin usar recursos externos o una licencia adicional de Unity. Espero que este material sea útil para quienes enfrentaron un problema similar y no encontraron soluciones efectivas en las diferentes etapas del mismo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Destacar elementos importantes de la interfaz (y eliminar los innecesarios) es una de las principales herramientas para mejorar la experiencia del usuario. Esto es especialmente pronunciado cuando se trabaja con aplicaciones móviles. Este cambio de atención se puede hacer de diferentes maneras: eliminando suavemente los botones más allá de los bordes de la pantalla, oscureciendo el fondo, el comportamiento dinámico, etc. Esto incluye desenfocar la imagen. Este efecto, por un lado, reduce el contraste de los elementos de fondo y hace que sea más difícil de captar. Por otro lado, el desenfoque tiene un efecto subconsciente cuando la imagen se desenfoca y la percibimos de manera diferente. Este enfoque se usa a menudo en juegos, y de ejemplos bien conocidos de juegos en Unity, podemos nombrar los momentos al elegir el menú de misiones de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hearthstone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o en</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pantalla de finalización de duelo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora imagine que queremos hacer lo mismo o similar en nuestra aplicación favorita. </font><font style="vertical-align: inherit;">Tampoco estamos sin presupuesto y tenemos poca experiencia con Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primera parte - Shader</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer pensamiento que surgió fue que todo ya debería estar realizado. </font><font style="vertical-align: inherit;">Seguramente usando un sombreador. </font><font style="vertical-align: inherit;">Y ciertamente debería estar en el cuadro Unidad. </font><font style="vertical-align: inherit;">Una búsqueda rápida y un intento de instalación mostraron que existe un sombreador en Unity, pero resulta que es parte de los Activos estándar y no está disponible para una licencia gratuita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero esto es borroso! </font><font style="vertical-align: inherit;">Un efecto básico que es matemáticamente simple y que también debe implementarse e integrarse fácilmente en el proyecto. </font><font style="vertical-align: inherit;">Incluso si no sabemos nada sobre sombreadores. </font><font style="vertical-align: inherit;">A continuación, vaya a Internet y la búsqueda mostró rápidamente que existen códigos fuente de sombreadores ya preparados para el efecto, e incluso diferentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la primera implementación, se tomó </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este sombreador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para probarlo, simplemente agregue el sombreador como un archivo fuente al proyecto, asócielo con el material, enlace el material a la imagen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segunda parte: interfaz de usuario</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nos preocupamos por el usuario de la aplicación, entonces es necesario prestar la debida atención a la interfaz de usuario. Si solo agrega un efecto de desenfoque al fondo y lo olvida, entonces esto no es todo coherente con los principios internos de la creación de un producto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, para acciones adicionales, debe tocar lo que sucedió, y luego pensar y ajustar de tal manera que cause la percepción necesaria del usuario. Este punto es altamente sensible al contexto. Dependiendo del contraste de la imagen, la variedad de colores y otros factores, se pueden seleccionar varios valores y herramientas adicionales. En nuestro caso, en esta etapa, se obtuvo un buen resultado con un radio de desenfoque de 25 (parámetro de sombreador) y un Transparente adicional del 70% (fuera del sombreador a través de una Imagen separada). Sin embargo, esta es solo la imagen de fondo final. La transición en sí, según los sentimientos en el teléfono, fue demasiado aguda.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sombreador instalado en la imagen se calcula en cada cuadro y, por lo tanto, para realizar un cambio suave, es suficiente cambiar dinámicamente el parámetro del radio de desenfoque y la transparencia. </font><font style="vertical-align: inherit;">Puede organizar esto de diferentes maneras, pero en esencia, el procesamiento es una actualización en los controladores de actualización, según la hora. </font><font style="vertical-align: inherit;">La transición en sí en la versión final de la aplicación es de 0.2 segundos, pero resulta que es importante para la percepción del usuario.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tercera parte - Productividad</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los últimos meses, he escuchado quejas de varios usuarios diferentes (ni siquiera programadores) de que los programas de juegos a menudo usan todos los recursos informáticos disponibles inactivos y sin frenos. Por ejemplo, esto se puede expresar en el uso máximo de la tarjeta de video en el caso de un programa minimizado en la bandeja, o independientemente de todo y la carga constante de un subproceso del procesador. Las razones para esto son intuitivamente claras: los ingresos del desarrollador o editor no dependen de la optimización (las personas no prestan atención a tales cosas cuando compran), y los desarrolladores comunes están más preocupados por los KPI locales y la necesidad de retrasar los plazos. Sin embargo, en la práctica, no me gustaría entrar en esta categoría.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de completar la etapa anterior en el próximo lanzamiento con un efecto de desenfoque de fondo, después de sostener el teléfono en la mano durante un tiempo, apareció una sensación de calentamiento. Si pasa más tiempo en el menú, todo se vuelve mucho peor. E incluso si el usuario en el menú presumiblemente y lo más probable es que no pase mucho tiempo, entonces no me gustaría dejar caer la batería. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El análisis mostró que el sombreador elegido anteriormente tiene una complejidad asintótica </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dependiendo del radio seleccionado. En otras palabras, el número de cálculos por punto se vuelve 625 veces mayor si aumenta el radio de desenfoque de 1 a 25. En este caso, los cálculos se producen en cada cuadro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer paso en la solución fue la idea de que no todos los sombreadores son igualmente útiles, y el efecto de desenfoque se puede implementar de diferentes maneras. Para hacer esto, puede tomar un desenfoque separado, cuya esencia es desenfocar primero solo las líneas horizontalmente y luego solo las líneas verticalmente. Como resultado, obtenemos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y ceteris paribus la complejidad cae en un orden de magnitud. Una forma adicional sería tomar un mipmap más pequeño, que ya toma parte del trabajo de desenfoque. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Este sombreador</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
fue tomado como base</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sin embargo, su efecto de desenfoque resultó ser insuficiente, y con un alto contraste del gráfico, la imagen se "astilló". </font><font style="vertical-align: inherit;">Para obtener mejores efectos, se ha cambiado la distribución (elementos GRABPIXEL). </font><font style="vertical-align: inherit;">Si en el sombreador, de 0.18 a 0.05, radio 4, en nuestra versión, de 0.14 a 0.03, radio 6 (ess, pero la suma de todos debería ser 1). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, la complejidad del procesamiento se redujo en 1-2 órdenes de magnitud. </font><font style="vertical-align: inherit;">Pero esto no es necesario parar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarta parte: fondo estático</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, si dejamos el sombreador en la imagen existente, entonces está constantemente trabajando, haciendo los mismos cálculos en cada cuadro. </font><font style="vertical-align: inherit;">Si algo sucede en el fondo, entonces debemos hacerlo. </font><font style="vertical-align: inherit;">Pero esto es completamente opcional si el fondo es estático. </font><font style="vertical-align: inherit;">Por lo tanto, después del desenfoque dinámico, puede recordar el resultado, ponerlo en el fondo y apagar el sombreador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación, intentemos con fragmentos de código. </font><font style="vertical-align: inherit;">La preparación de la textura de destino para toda la pantalla puede verse así:</font></font><br>
<br>
<pre><code class="cs hljs">_width = Screen.width / <span class="hljs-number">2</span>;<font></font>
_height = Screen.height / <span class="hljs-number">2</span>;<font></font>
_texture = <span class="hljs-keyword">new</span> Texture2D(_width, _height);<font></font>
<font></font>
<span class="hljs-keyword">var</span> fillColor = Color.white;
<span class="hljs-keyword">var</span> fillColorArray = _texture.GetPixels();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fillColorArray.Length; ++i)<font></font>
{<font></font>
	fillColorArray[i] = fillColor;<font></font>
}<font></font>
_texture.SetPixels(fillColorArray);<font></font>
_texture.Apply();<font></font>
<font></font>
_from.GetComponent&lt;Image&gt;().sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, aquí se prepara una textura que es 2 veces más pequeña horizontal y verticalmente desde la pantalla. </font><font style="vertical-align: inherit;">Esto se puede hacer casi siempre, ya que sabemos que los tamaños de pantalla de los dispositivos son múltiplos de 2, y si se hace, esto reducirá el tamaño de la textura y facilitará el desenfoque.</font></font><br>
<br>
<pre><code class="cs hljs">RenderTexture temp = RenderTexture.GetTemporary(_width, _height);<font></font>
Graphics.Blit(_from_image.mainTexture, temp, _material);<font></font>
RenderTexture.active = temp;<font></font>
<font></font>
_texture.ReadPixels(<span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, temp.width, temp.height), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
_texture.Apply();<font></font>
<font></font>
_to_image.sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));<font></font>
RenderTexture.ReleaseTemporary(temp);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para capturar una imagen con mainTexture usando un sombreador (en _material) se usa Graphics.Blit. A continuación, memorizamos el resultado en la textura preparada y lo colocamos en la imagen de destino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo estaría bien; en la práctica, se enfrentó a un efecto tal que, dependiendo del dispositivo, la imagen de fondo se voltea. La razón después de un estudio del problema y la depuración se vuelve clara: la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diferencia en los sistemas de coordenadas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct3D y OpenGL, que Unity no puede ocultar. Al mismo tiempo, nuestro sombreador detecta los rayos UV y los procesa correctamente, y la inversión ya ocurre en el entorno Unity (ReadPixels). Hay muchos consejos en la red, como "si te has puesto del revés, dale la vuelta" o "cambia el signo UV". El uso de la macro UNITY_UV_STARTS_AT_TOP no ayudó a obtener una buena generalización para todos los dispositivos bajo prueba. Además, por ejemplo, encontramos un caso tal que si prepara el ensamblaje para la emulación en Xcode en el iPhone, y Unity no usó Metal, sino solo OpenGLES, entonces debe interceptar casos como la emulación de un dispositivo que se ejecuta en otro software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de probar varias opciones, me decidí por dos tabletas. El primero es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forzar el renderizado de la cámara.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(configuración forceIntoRenderTexture en el momento de la captura de imagen). </font><font style="vertical-align: inherit;">El segundo es la determinación del tipo de sistema gráfico sobre la marcha a través de SystemInfo.graphicsDeviceType, que permite definir OpenGL-like o Direct3D-like (el primer grupo es OpenGLES2, OpenGLES3, OpenGLCore y Vulkan). </font><font style="vertical-align: inherit;">Además, en nuestra aplicación para Direct3D similar, tenemos que entregar, que se realiza de procedimiento (por ejemplo, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este artículo sea útil para que alguien supere un rastrillo desconocido, mejore la vida de los usuarios y comprenda Unity. </font><font style="vertical-align: inherit;">Si nos fijamos en el efecto en uso en combate, a continuación, en la unidad se ve como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En la aplicación, las sensaciones son algo diferentes, pero esta animación puede dar una idea suficiente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es493442/index.html">Recordatorio de PPE</a></li>
<li><a href="../es493444/index.html">El proyecto "Vidrio". Eficiencia energética Tazas de té / café desechables</a></li>
<li><a href="../es493446/index.html">Lectura de fin de semana: 10 historias de sonido inusuales: desde juegos de espías y teorías de conspiración hasta ASMR relajante</a></li>
<li><a href="../es493448/index.html">Primavera: enrutamiento eficiente</a></li>
<li><a href="../es493450/index.html">Cómo un inversor novato puede reducir impuestos legalmente: 4 métodos de trabajo</a></li>
<li><a href="../es493458/index.html">Libera tu Android - Alaverdi</a></li>
<li><a href="../es493462/index.html">Baño ultrasónico. Parte 2</a></li>
<li><a href="../es493468/index.html">No tengas miedo de respirar profundamente</a></li>
<li><a href="../es493470/index.html">Los científicos encuentran nuevos planetas menores fuera de Neptuno</a></li>
<li><a href="../es493478/index.html">Hack The Box - Tutorial del bosque. AS-REP Asado, DCSync y ataques Pass-The-Hash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>