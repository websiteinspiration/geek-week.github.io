<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕷️ 🧑🏽‍🤝‍🧑🏽 🤦🏿 Emergency light switch position sensor 👯 🏣 🏄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before everyone who designs an autonomous emergency lighting system, sooner or later, the problem arises of turning on and off the emergency lights. H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Emergency light switch position sensor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492808/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before everyone who designs an autonomous emergency lighting system, sooner or later, the problem arises of turning on and off the emergency lights. </font><font style="vertical-align: inherit;">How to do this in the most convenient and transparent way, so as not to spoil the design of the rooms with additional switches?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f4/90/kp/f490kpxmliwuhfpeeuf-lhmjhou.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the solutions under the cut.</font></font><br>
<a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the modern world, a lot of things have become tied to uninterrupted power supply. Most types of intellectual activity are already inconceivable without a computer and communications operating 24/7. This is neither good nor bad, it is, and you need to live with it. Especially if your workplace is not in a modern office, stuffed with UPS and backup diesel generators, but in an apartment of an ordinary residential high-rise building. And it so happened that the reliability of energy supply of housing in most cities of the former USSR leaves much to be desired. As a result, the thread connecting the home outlet and the nearest power station has a bad habit of breaking periodically. When once every six months, and when and three times a day.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is why, when starting repairs in a new apartment, I initially laid parallel wiring in the project for uninterrupted power supply and lighting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would very much like to have at my disposal a powerful generator with ICE, capable of providing normal power to the whole apartment, but I had to abandon this idea. In a private house, the question would not have been raised at all, but an apartment is quite another. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first problem is the removal of exhaust gases, which are absolutely nowhere to put in the apartment of a house with central heating. Well, you won’t throw away the hose just outside the window, where smoke instantly is sucked into the nearest open neighbor's window.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second problem is noise. Yes, modern inverter four-stroke generators, when you hear them on the street, can seem very quiet. And if you hang an additional silencer, then completely silent. But believe me, in a deenergized, which means completely quiet apartment building, even such a quiet rumble will be perfectly audible to all neighbors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, the idea with the generator died, so plainly and not born. Of the remaining real options, only batteries remained.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, I allow myself a simple narrative of my emotional ordeals and the decisions made in the first person without any claim to universal truth. </font><font style="vertical-align: inherit;">And I immediately warn that my arguments to someone may seem unconvincing, and the decisions made are controversial. </font><font style="vertical-align: inherit;">But, nevertheless, everything described here is currently implemented in hardware and successfully performs the tasks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if anyone is interested in the purely practical side of the issue and it doesn’t matter how I came to such a life, he can </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skip many letters and go straight to the description of the ready-made solution.</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Briefly about choosing the type of battery</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And although this issue has nothing to do with the topic of the article, I would like to insert my five cents here too. Moreover, that inevitably arise under such statements discussions often carries a lot </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of lulz</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> useful information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today, in the age of rapid development of alternative energy, relatively affordable industrially manufactured uninterruptible power supply systems for the home, combined with solar or wind mini-power plants, have begun to appear. The most advanced of them use lithium-ion batteries with a whole heap of electronic "enhancers" of the effectiveness of the entire system.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, there can’t be any talk about any mini-power plant for objective reasons, and only the backup source, renewable from an ordinary outlet during “enlightenment”, was interesting. Therefore, it was decided to collective farm all the electronic stuffing of the apartment UPS on their own. And since my hands were completely untied, the first thing that needed to be decided was what type of batteries to use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, I thought like this: “Why not lithium? </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stylish trendy youth</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sealed, energy efficient, durable. " But when I looked at the prices, my lithium fervor noticeably subsided. A quick search in combination with school arithmetic showed that even very “dumb” Chinese 26650 banks with (of course) the most honest 5000 mAH will cost five times more than an acid battery of the same energy consumption. And if you choose something not from the bottom of the price sorted by price, the difference easily reaches 8-10 times. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And how can you make up for such a big difference in value? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, lithium stores energy more efficiently for every kilogram and cubic meter, and a battery the size of a cigarette block easily devotes a ten-kilogram lead-acid battery. But is this fact so important for stationary use?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, a good "lithium", but with the right approach will last longer. But ten times? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, on the other side of the scale, the potential explosiveness of batteries of unknown origin, a more complex charging algorithm, problems with disposal (every homeless person knows where to use a lead battery for profit, while lithium is much more complicated). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, by the sum of the factors, I decided to postpone the idea of ​​lithium until the next iteration. Maybe in a few years something will change, but for now, lead is our everything.</font></font><br>
<br>
<blockquote>,      ,        .    ,    ,           ,           .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for lead batteries, there are also several options. The “right” option is specialized backup batteries, which are used in UPS, at cellular base stations, and other similar places where they are required to be able to take and deliver large currents, occasionally experience a strong discharge, and indeed work without distracting people for service. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another “right” option is traction batteries for electric auto-loaders or, what the hell, a diesel submarine. These batteries have high durability and good tolerance to deep discharge, while not taking away from the owner the opportunity to "top up some water."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the “wrong” option is the starter battery from the nearest car shop. Such a battery can briefly give up to a kilowatt of power to the mountain, but any discharge is stressful for it, like work for a lazy person. And the glory of disposable batteries is generally entrenched in modern calcium batteries: "discharged - change."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, then, I hope no one doubts which option I ultimately selected for implementation? Right, third. And the reasons here lie not only in the well-known warty amphibian, but also in a simple pragmatic calculation. Starter batteries are several times cheaper than all other options, sometimes approaching lithium in value. And instead of shaking over an expensive battery, you feel much freer in a situation of healthy indifference, when the replacement results in losses in the amount of going for food for a couple of weeks. Moreover, if you do not let these batteries run out before losing a pulse, then their service life in the role of backups is calculated for many years. You can always put a battery with a larger capacity, set the discharge limit softer, and still get a better price / capacity ratio than the “right” battery,suffering a deep discharge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main thing in this matter is to provide ventilation at least at the “hole in the wall” level at the place of installation of the batteries. </font><font style="vertical-align: inherit;">Well, to organize a banal short circuit protection, because the low voltage of the current source dulls vigilance and everything can end very badly.</font></font><br>
<br>
<h3><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current war</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in a single apartment</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After some moral reassurance caused by the final decision on the type of battery, a new reason immediately appeared to think carefully. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me remind you that initially I wanted to get an alternating current generator of 230 V. However, after reconciling with objective reality and mentally switching to batteries, the inertia of thinking already carried me to the well-known Chinese online market in order to choose a suitable DC to AC converter. And in the process of studying the characteristics, the term “modified sine wave”, which was forgotten, first surfaced, and then common sense began to throw up uncomfortable questions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of the questions was as follows. To cover all the energy needs of the apartment with a small battery will still not work. Boilers, a microwave, a washing machine, a powerful desktop computer will still be unbearable in power. And the refrigerator, the hood, and even the banal fan will not be able to work properly because of this very modified sine wave. Of course, there are inverters with a true sine wave, but they are not only more expensive, but also less efficient. And the issue of powerful consumers is still not resolved.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What consumers remain within the budget? There are not so many of them: consumer electronics such as laptops and phones / tablets, a router, an ARM server, the mood is a TV, and, of course, lighting. Moreover, the initial message of the article (and my personal motivation) is precisely to ensure the functioning of the backup workstation in the form of a laptop and minimal household comfort, such as light in the toilet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost all of these devices require a constant voltage from 5 to 21 V for their operation and there is no objective need to first increase the battery voltage to 230 V AC, then to lower and straighten it again to plus or minus the initial level. On these transformations, it is easy to lose up to 50% of energy, which I did not smile at all.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, that’s how smoothly the idea came to use a low-voltage direct current network as an alternative. </font><font style="vertical-align: inherit;">And after an approximate calculation of losses in the wires, the initial 12 (13.8) V turned into a more practical 24 (27.6) V.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At first I wanted to take even 36 (41.4) B, but after studying the characteristics of some electronic components that I planned to use to work with all this economy, I had to moderate my appetite.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, in an alternative wiring with a cross-section of 3.5 mm </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 of</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pure copper, voltage was ultimately applied from two car batteries connected in series.</font></font><br>
<br>
<blockquote>,        .           (   )   .                ,      .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To enable consumers in the rooms, one more outlet was added to each “large” block of outlets. And so that no one would confuse an ordinary outlet with a backup one, the “American” type products with flat contacts of different widths were installed as the latter. This, firstly, will not allow the vacuum cleaner to be connected to the DC network, and secondly, such an outlet, unlike the European one, always uses the same polarity when using the “correct” plug.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/sm/th/blsmthnmtxqcekbdftv8dfg3u2a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For these outlets laptop adapters were made, lowering the voltage to the desired 18-20 V and equipped with the corresponding connectors. </font><font style="vertical-align: inherit;">It is clear that heels were made of the usual five-volt USB-charges for every little thing. </font><font style="vertical-align: inherit;">Well, just in case, a pair of small 24/230 V converters was purchased, with a power of 50 and 200 watts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cases for charging with an American plug, the same power cords, and ready-made boards of pulse down converters were ordered from China. </font><font style="vertical-align: inherit;">A soldering iron was needed only to connect the wires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not talk about the power plant in this article, especially since there is nothing interesting in it, so I will go right to one of the "bottom" problems, namely the issue of utilizing the energy accumulated by the battery for lighting purposes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lighting</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, when wiring the apartment in parallel with the main wiring, wires of an alternative DC network with a voltage of 24 (27.6) V were drawn. Among other things, a loop consisting of a pair of such wires was wound into each switch box and then together with the 230 V network wires led to the ceiling lights (if there were several in the room, then the alternative wire led to only one).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do with the output of the DC network in the field of the lamp is a matter of an individual approach. As a light source, a regular 24-volt LED strip was chosen. Its segments of different lengths (in proportion to the area of ​​the room), depending on the design of the fixtures, were either mounted directly in their housings or glued to those surfaces from which it would shine well, and from where it would not be very striking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In any case, this is a more aesthetic than a technical problem, and now it’s something else. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, in the box of each switch, I have a loop of a phase wire of a 230 V network for switching on "ordinary" light, and a loop of both wires of a DC network for emergency lighting. From this and dance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the end, the challenge before me was to create a certain device that could separate three states from each other:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AC mains OK → turn off emergency lights.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AC network is de-energized, the switch contacts are closed → turn on the emergency light. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AC network is de-energized, the switch contacts are open → turn off the emergency light.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We consider the actions to be one-sided, that is, for example, turning off the already turned off lighting just does not change anything. </font><font style="vertical-align: inherit;">These states can be distinguished from each other if the tasks of determining the operation of the AC network and the position of the contacts of the switch are solved. </font><font style="vertical-align: inherit;">At the same time, I had the following initial conditions:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Management of both the main and emergency lighting should be completely transparent from one governing body, no “collective farm” of the additional buttons.</font></font></li>
<li> ,  ,   ,        .</li>
<li>      ,        .</li>
<li>      –    ,  .</li>
<li>-        .</li>
<li>        (    ),  .</li>
<li>      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the absence of AC mains in the zero boxes turned out to be a very complicated design miscalculation. </font><font style="vertical-align: inherit;">Without it, the determination of the presence of voltage at the input of the switch becomes impossible. </font><font style="vertical-align: inherit;">Technically, it would be possible to use the negative wire of a direct current network as zero, but this contradicts the completely indestructible paragraph 5 of my terms of reference.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, an alternative to measuring the mains voltage exists. It is not necessary for me to determine the presence of voltage, it is enough to determine the presence of current in the phase wire with the contacts of the switch closed. After all, if there is current, then there is voltage. Moreover, the “reading” of precisely the current allows emergency lighting to be activated not only in the event of a power failure, but also in the event of a banal bulb burnout. This method does not allow to determine the state of the AC network when the switch is off, but this state does not bother me, because once the switch is off, the emergency lighting should not work either.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To determine the presence of current in the wire is quite simple, especially if this current is alternating. </font><font style="vertical-align: inherit;">Here you can apply, for example, a Hall sensor that detects the magnetic field around the wire. </font><font style="vertical-align: inherit;">But you can get by with a commonplace </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current transformer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , consisting of a ring magnetic circuit with a winding. </font><font style="vertical-align: inherit;">An alternating current wire is passed through the ring, which creates a magnetic field in the magnetic circuit. </font><font style="vertical-align: inherit;">This field in turn induces a secondary current in the winding, proportional to the primary current in the wire. </font><font style="vertical-align: inherit;">Thus, this simple device allows you to measure the strength of alternating current in any wire, without breaking it and generally without any galvanic connection with the primary circuit.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The work of current clamps, a very useful tool for any electrician, is based on the same principle.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there is such a transformer near the switch, it is enough to measure the voltage on its secondary winding to find out if any current is flowing in the lamp circuit. The presence of current, as I said, in a first approximation indicates two facts: there is a voltage in the network 230 V, and the switch is closed. The first of these facts is essential for the operation of the emergency lighting activation device. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second "input parameter" of my future device should be the position of the switch contacts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The brainstorming initiated by hobby colleagues brought various options for determining the position of the circuit breaker, which basically came down to modifying the design in order to add another pair of contacts to it. Here the scope for imagination is quite large.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was possible to take a double one instead of a single switch and mechanically “parallelize” its halves so that they became a single whole. This option did not differ in external aesthetics and did not solve the problem in those rooms where the lighting was double-circuit and the switch was double initially. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other options involved the introduction of a micro switch or a reed switch with a magnet in the switch mechanism. But after studying the designs of the applied circuit breakers, these options also disappeared. The monolithic ceramic base of a good switch simply leaves no chance even for a compact microswitch, and the magnet and reed switch did not work due to too little key travel and hysteresis in the operation / release curve of the reed switch.</font></font><br>
<br>
<blockquote> «»        ,     . , ,       ,  .  ,   ,    ,               .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, it was necessary to come up with a method that would not require modification of the switch. And this method was found. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Above, I described a current transformer, which allows you to determine the presence of alternating current in a wire without rupture and galvanic contact. But any transformer is a bi-directional device (in contrast to the same Hall sensor), its primary and secondary windings are interchangeable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we apply alternating current to the secondary winding of such a transformer, it induces voltage at the ends of the wire threaded into the ring. And, most importantly, the energy consumed by the winding from the source will depend on whether the secondary current in the wire finds its way for circular motion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here it becomes more interesting. </font><font style="vertical-align: inherit;">A wire passes through the ring, which is immediately, in a few centimeters, connected to one of the contacts of the switch. </font><font style="vertical-align: inherit;">It remains only to provide this current with a return path from the other side of the switch in order to obtain a device for “sensing” the position of the contacts. </font><font style="vertical-align: inherit;">And for the reason that this current is alternating, a conventional capacitor can become a bridge for it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gs/tr/g1/gstrg12mwdwhgu0qmbnl3twrfjc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In principle, to close this circuit under certain conditions, a capacitor is not needed. </font><font style="vertical-align: inherit;">If a current of a sufficiently high frequency is “pumped” into the transformer, then the stray capacitance between the wires will be enough for passage.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/up/yp/ws/upypwscprb9xjbrlaye26xfkry8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, what is needed to organize such a detector:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current transformer.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformer output voltage meter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source of high-frequency alternating current.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current meter flowing through the winding of a reversed transformer.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most difficult in terms of selecting the optimal parameters is a transformer, which in the current transformer mode should give an acceptable voltage with a frequency of 50 Hz, and in the active “sensing” mode of the circuit breaker state, have an acceptable transmission coefficient at a frequency of hundreds of KHz. </font><font style="vertical-align: inherit;">This element is not possible to simulate in a program for modeling electronic circuits, and even with mathematical calculation everything turned out to be very difficult. </font><font style="vertical-align: inherit;">I had to take a soldering iron in my hands and spend hours driving various options in search of the best. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The number of turns and the optimal load resistance were selected empirically and not the fact that I did not miss the best ratio. </font><font style="vertical-align: inherit;">As a result of the experiments, the following construction appeared:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferrite core with a permeability of 10,000, size 10x6x4 mm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winding 30 turns with 0.25 mm enameled wire.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The active load of the winding is 1 kOhm.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The magnetic permeability is quite large, probably, it would make sense to use a ring for 5000 or even 2000 units, but in sufficient quantities I had these rings. </font><font style="vertical-align: inherit;">In general, permeability in this case is a compromise value. </font><font style="vertical-align: inherit;">Too low makes the transformer unsuitable for operation at a frequency of 50 Hz, and too high spoils everything at frequencies above hundreds of kilohertz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Multiple experiments confirmed the reality of the idea and the following results were obtained:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In current transformer mode, the transmission coefficient turned out to be about one millivolt per watt of flowing power (voltage 220-230 V).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In probe mode, depending on the frequency and capacitance of the leak, the current difference with closed and open contacts of the switch reached two to three times.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all. </font><font style="vertical-align: inherit;">Both values ​​are more than sufficient for reliable fixation of both the flowing current, and for determining the position of the switch contacts. </font><font style="vertical-align: inherit;">It is only up to the specific implementation.</font></font><br>
<br>
<a name="Solution"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In iron</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unlike most of its other designs, here already in the early stages of deliberation, it was decided to immediately use the microcontroller. </font><font style="vertical-align: inherit;">Based on the needs and experience, the choice fell on the ATtiny13A. </font><font style="vertical-align: inherit;">This chip has an ADC, and with the ability to use an internal reference source of 1.1 V instead of the supply voltage. </font><font style="vertical-align: inherit;">There is a PWM that is great for generating a sounding signal. </font><font style="vertical-align: inherit;">And, which later turned out to be important, there is an EEPROM that allows you to store calibration data.</font></font><br>
<br>
<blockquote>,          «  ,       ,       - «» ,  ».<br>
<br>
      .         .           .   ,   ,  ,         .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you need to combine at least a generator, a voltage meter, and some kind of trigger to store the current state between measurements. In general, any speculative sketch required at least three cases only on the "core", and the controller turned out to be much more practical. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The voltage from the current transformer with a load of 10-20 W is 10-20 mV and it is too small to supply it to the DAC input with a limit of even 1.1 V. Therefore, in addition to the controller, you also need an amplifier with a transfer coefficient of about 100 to increase the signal voltage at least up to hundreds of millivolts.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, the voltage of the output signal of a current transformer depends not only on the load power, but also on its nature. </font><font style="vertical-align: inherit;">A purely active load such as Ilyich’s bulb, for example, gives a millivolt level sine wave. </font><font style="vertical-align: inherit;">A LED bulb of the same power with simple pulse power gives short bursts to volts and above. </font><font style="vertical-align: inherit;">We could play on this, but, firstly, I wanted to make a universal device, and secondly, in the apartment there was one lamp with an external power supply unit equipped with a PFC circuit (that is, having a consumption characteristic close to active).</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not torment the reader with intermediate options and immediately give the final diagram of the device.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vd/at/a-/vdata-spt78rd_pzv7s5awoobya.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the DC voltage through the economical linear regulator LM2931-5.0 feeds the controller. In terms of housing, functionality, and pinout, this stabilizer is similar to the popular 78L05, but differs from it in lower intrinsic consumption (about 500 μA at a load of 10 mA) and greater tolerance to short bursts of input voltage. If you plan to work with a voltage of no more than 20 V, you can use an even more economical analogue of LP2950-5.0.</font></font><br>
<br>
<blockquote>   LP2950-5.0        30 .      24      .    -      ,     ,       ,     ,   .          50%,   100%.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The transformer is not shown in the diagram, but its winding is connected to the pins TR1 and TR2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a key element for switching the load, a low-current P-channel MOS transistor 2SJ196 is used (a current of up to 1 A should be sufficient for any LED lamp), but any other one suitable for the pinout, maximum current and maximum drain voltage can be used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the controller and the key from the active elements, two transistors are used. One is needed to control the shutter of the key, operating under the voltage of the emergency source. The second acts as an amplifier signal from the output of the current transformer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, you could use op-amps, but in terms of details the gain was minimal, and you would have to forget about working at frequencies above several hundred kilohertz.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is not the amplified signal from the transformer itself that is fed to the ADC, but its envelope, which can be measured by a single sample, and not by "streaming" digitization for some time. To isolate the envelope, two Schottky diodes are used, connected according to the voltage doubling circuit. Such an inclusion forms a classical amplitude detector, in which the voltage drop across the diodes themselves is largely compensated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The principle of operation of the sensor is simple. First, consider the algorithm of actions necessary to measure the current in the wire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In current measurement mode, pin PB0 is put into output mode and is grounded by a logic zero. This prevents any signals from the controller from being sent to point TR1. In parallel, the same actions are performed on pin PB3, as a result of which the top output of the capacitor C2 is grounded. This capacitor together with the resistor R1 creates a low-pass filter with a cutoff frequency of about 1500 Hz. Thanks to this filter, the role of various high-frequency noise in the formation of the measured signal is greatly reduced. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then a high level is applied to PB4 to power the signal amplifier. After the completion of transients, a current of 50 Hz from the transformer output is amplified and gets to the rectifier, where it charges the capacitor C8.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The charge of the capacitor C8 is measured using ADC1 and from the obtained voltage value a conclusion is drawn about the “primary” current flowing through the transformer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Active sensing is performed differently. First, pin PB0 is translated into a PWM solver, and a signal is fed to it with a frequency from hundreds of kilohertz to units of megahertz. This signal is somewhat attenuated by a resistive divider and fed to the current transformer winding at point TR1. Capacitor C1, together with one upper arm of the divider R4, creates a low-pass filter with a cutoff frequency of about 1.5 MHz, which reduces the level of high-frequency harmonics from rectangular pulses.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After passing through the transformer winding, the probing signal from point TR2 gets to the same amplifier and detector, likewise in the end charging the capacitor C8 to a voltage proportional to the load in the "external" transformer circuit. In the same way, the capacitor charge is measured using the ADC of the microcontroller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now explanations for some "loose". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resistor R5 is designed to limit the voltage at the gate of the power switch, which for low-voltage MOSFETs should usually not exceed 20 V. In my case, the DC network has a voltage of up to 30 V, which dictated the need for a 1: 3 divider, which is obtained in conjunction with R3. When powered from a source of less than 20 V, resistor R5 is not needed (replaced by a jumper).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Capacitors C4 and C5 are connected in parallel to achieve a capacitance of 2 μF. This pair of capacitors is noteworthy in that it must transmit signals of both low and high frequencies equally well. Here it would be possible to use a parallel connection of an electrolytic capacitor of several microfarads and a ceramic of a hundred or two nanofarads, but an "electrolyte" of such a small capacity does not give a gain in size when compared with microfarad "ceramics". True, it was not possible to buy a ceramic capacitor at 2 microfarads, so I put two of them the same.</font></font><br>
<br>
<blockquote>,   50     2  ,      .   ,        .               .    100   , ,   .       .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resistors R4 and R1 form a voltage divide, which more or less equalizes the five-volt alternating voltage at the PWM output with the output voltage of the current transformer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Capacitor C8, as mentioned earlier, accumulates the voltage to be measured. It is better if it is a high-quality capacitor with a minimum leakage current. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Special mention deserves the two-pin “comb” TP1 / TP2 connected to the microcontroller reset leg. These contacts are used not just to reboot, but to enter the calibration mode, which is described below. Simply, after the implementation of all the Wishlist, the controller no longer had free pins, and the need to add one simple control appeared during the debugging of the firmware. So I had to use the controller reset foot for this purpose.</font></font><br>
<br>
<blockquote> «»  AVR     RESET       GPIO.         ,       .         ,        .   ,        ,      ,      ,            RESET.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, the circuit turned out to be quite simple, and all the “magic” is implemented in the firmware of the microcontroller. However, after the manufacture of the prototype, it turned out that the wiring capacitance for reliable operation of the "probe" is often not enough. The difference in current through the transformer simply turns out to be comparable with the level of interference and the operation of the circuit becomes unreliable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, I had to abandon the ferrite ring freely hanging on the wires, and add a high-voltage circuit directly to the board in a new revision of the device to facilitate the probing task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The point here is to add a dedicated capacitor, turned on so that the shortest way to close the path to the RF current through the contacts of the switch.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/i-/_f/63/i-_f636miltufzwifkx4xaxnab0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Capacitor C10 must be designed for a voltage of at least kilovolts, and its capacitance should be chosen according to a compromise principle so that the operation reliability is sufficient for practical use, and so that the stray capacitive current through the lamp is not too large. </font><font style="vertical-align: inherit;">In practice, you can try to "play around" with this denomination, if necessary.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In any case, a switch equipped with such a sensor can no longer be perceived as ideal. </font><font style="vertical-align: inherit;">Rather, it is similar to a switch with an indicator, therefore, firstly, it can cause stray light or flicker of low-quality LED lamps, and secondly, it can cause an electric shock, though not a strong one. </font><font style="vertical-align: inherit;">Therefore, you never need to work with lighting wiring, relying only on the switch in the wall, always turn off the “switch” at the entrance.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, since I still had to add part of the AC network to the board, I added two shut-off chokes there, which will not let the high-frequency probing current pass into the wiring. The practical value of the frequency of the probing voltage can reach several MHz and I, as a radio amateur, are very sick of the idea of ​​increasing the amount of interference in the network with my own hands. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chokes L1 and L2 must be power, wound with a wire of noticeable thickness on the dumbbell or ring type cores. Signal chokes in the "resistor" axial design cannot be used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The primary turn of the current transformer is now a piece of wire threaded through the ring and soldered to points TR3 and TR4 on the board. It is better if this wire is shielded, while connecting the screen to TR5 and TR6 on both sides of the ring.</font></font><br>
<br>
<blockquote> TR6       ,   .    -   ,           .          ,          .</blockquote><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The firmware code and the assembled HEX file are attached at the end of the article along with the circuit and the layout of the printed circuit board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm of the tuned detector is simple. Once every three seconds, the controller wakes up from deep sleep, takes measurements, and, if necessary, changes the state of the control key in one direction or another. Thus, the reaction to a change in the position of the switch may have a delay of up to three seconds. Not very convenient, but this is done, firstly, to save energy of the backup source, and secondly, to significantly reduce the polling interval does not allow the duration of transients at different stages of measurement. The minimum interval can be considered equal to one second, but then the circuit will be in active consumption mode almost all the time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, in conclusion, about the configuration. Due to the fact that different sensors have to work in completely different conditions according to the current consumed by the lamp, the length and other wiring features, the level of interference, and the like, it was impossible to put a universal set of adaptive parameters into the firmware. Therefore, each sensor after installation requires a single calibration on site. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sensor enters calibration mode each time it is turned on, while there is no calibration data, or after closing the contacts TP1 and TP2. Entering the first stage of calibration is indicated by a five-time flashing emergency lamp.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After flashing five times, 7.5 seconds are given to set the switch to the “off” position, if it was turned on before. After this time, the level of interference always present in the AC network is measured. The obtained value is used as a starting point for measurements in the duty cycle. Also at this moment, the circuit breaker is sensed at different frequencies for the subsequent selection of the most "contrast" frequency.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, the second calibration stage begins and the emergency lamp flashes twice. 7.5 seconds of time is given to switch the switch to the “on” position and after the timeout the program measures the current consumed by the lamp. If the lamp has several brightness levels, then after switching on, you must immediately switch it to a minimum, so that in the future the sensor will work correctly with any of the available levels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The beginning of the third and final calibration stage is marked by a three-time flashing of the emergency lamp and requires that the switch remains in the “on” mode and the lighting network is de-energized at a level higher (that is, with the main or secondary circuit breaker on the panel) no later than through the same ones 7.5 seconds In this case, a second sounding of the circuit breaker already turned on at different frequencies is performed and taking into account the values ​​obtained at the first stage, the frequency is selected at which the current difference through the on and off switch is maximum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Successful completion of the calibration is indicated by a single blinking of the emergency lamp and, if the lighting network after the third stage is still de-energized, by switching on the emergency lighting in the next operating cycle of the survey.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the measured values ​​of currents and resistances in different conditions are too close and cannot be used for reliable detection, calibration fails. </font><font style="vertical-align: inherit;">In this case, the emergency lighting lamp blinks twice when the switch position is unsuccessful, or three times when the standard lighting lamp consumption is too low. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In case of persistent unwillingness of the sensor to calibrate with a double blink in the final, you should try to increase the capacity of C10.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The device turned out to be quite simple, compact enough to fit in a switch box, but not to say that it is very easy to configure. </font><font style="vertical-align: inherit;">Of course, it does not draw on the component of a modern "smart home", because it does not have 5G, cloud control, and even banal WiFi with GPS is not provided. </font><font style="vertical-align: inherit;">Nevertheless, eight of these devices perform their sole function, and nothing else is required of them in blackout conditions.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware source code (Atmel Studio 7)</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> F_CPU 9600000 <span class="hljs-comment">//   (  : avrdude.exe -U lfuse:w:0x7a:m -U hfuse:w:0xff:m)</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/wdt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/sleep.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;util/delay.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/eeprom.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">//#define PROTEUS</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-keyword">bool</span>; <span class="hljs-comment">//   </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> true  (0 == 0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> false (0 != 0)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_U10BIT 0b0000001111111111 <span class="hljs-comment">//      </span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INTERVAL         3   <span class="hljs-comment">//  , </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUR_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RES_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_DIV_OFFSET  2   <span class="hljs-comment">//     </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_MAXIMAL_DIV 6   <span class="hljs-comment">//     </span></span><font></font>
<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_cur_edge;<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_res_edge; <font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> EEPROM_frequency_dividor;<font></font>
<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_edge, res_edge; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frequency_dividor; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> clk = <span class="hljs-number">0</span>; <span class="hljs-comment">//   watchdog</span>
<span class="hljs-keyword">bool</span> tp_reset = <span class="hljs-literal">false</span>; <span class="hljs-comment">//   TP1  TP2</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_vars</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">if</span>(MCUSR &amp; (<span class="hljs-number">1</span> &lt;&lt; EXTRF)) { <span class="hljs-comment">// ,       TP1  TP2</span>
    tp_reset = <span class="hljs-literal">true</span>;<font></font>
    MCUSR &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; EXTRF); <span class="hljs-comment">//  EXTRF       ,   </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_pins</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB0) | (<span class="hljs-number">1</span> &lt;&lt; PB1) | (<span class="hljs-number">1</span> &lt;&lt; PB2) | (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//       </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    watchdog</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_interrupts</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  sleep_enable(); <span class="hljs-comment">//   </span><font></font>
<font></font>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDCE) | (<span class="hljs-number">1</span> &lt;&lt; WDE); <span class="hljs-comment">//  watchdog</span>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDTIE) | WDTO_1S; <span class="hljs-comment">// watchdog      ,  1 </span><font></font>
<font></font>
  sei(); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_settings</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  cur_edge = eeprom_read_word(&amp;EEPROM_cur_edge); <span class="hljs-comment">//   </span>
  res_edge = eeprom_read_word(&amp;EEPROM_res_edge); <span class="hljs-comment">//   </span>
  frequency_dividor = eeprom_read_byte(&amp;EEPROM_frequency_dividor); <span class="hljs-comment">//   </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_load</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">blink_load</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> count)</span> </span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">true</span>);<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">false</span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   (   )</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) sleep_cpu();<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_amp</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//     PB4</span>
    _delay_ms(<span class="hljs-number">250</span>);      <span class="hljs-comment">//       200 .</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB4);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_lpf</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    (  "0")     C2</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    ( )   C2  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_gen</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    TCCR0A |= (<span class="hljs-number">1</span> &lt;&lt; COM0A0) | (<span class="hljs-number">1</span> &lt;&lt; WGM01); <span class="hljs-comment">//    ( )    OC0A      OCR0A</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> PROTEUS</span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00); <span class="hljs-comment">//    1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00) | (<span class="hljs-number">1</span> &lt;&lt; CS02); <span class="hljs-comment">//    1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    OCR0A = FREQ_DIV_OFFSET + frequency_dividor; <span class="hljs-comment">//   ,         OC0A</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    TCCR0A = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_adc</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    ( )</span>
    ADMUX = <span class="hljs-number">0b01</span> | (<span class="hljs-number">1</span> &lt;&lt; REFS0); <span class="hljs-comment">// PB2, 1.1v reference</span>
    ADCSRA = (<span class="hljs-number">1</span> &lt;&lt; ADPS0) | (<span class="hljs-number">1</span> &lt;&lt; ADPS1) | (<span class="hljs-number">1</span> &lt;&lt; ADPS2) | <span class="hljs-comment">//       = 128 (75 )</span>
             (<span class="hljs-number">1</span> &lt;&lt; ADIE) |  <span class="hljs-comment">//    </span>
             (<span class="hljs-number">1</span> &lt;&lt; ADEN);   <span class="hljs-comment">//  </span>
  } <span class="hljs-keyword">else</span> {<font></font>
    ADCSRA = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    (  "0")   C8</span>
    _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//      C8</span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_adc</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_ADC); <span class="hljs-comment">//   "" </span>
  <span class="hljs-keyword">do</span> {<font></font>
    sleep_cpu(); <span class="hljs-comment">//      ,      ,   </span>
  } <span class="hljs-keyword">while</span>(ADCSRA &amp; (<span class="hljs-number">1</span> &lt;&lt; ADSC)); <span class="hljs-comment">//        ,  </span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> ADC;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*
//  
static void blink_bin(unsigned int value, unsigned char count) {
  for(unsigned char i = 0; i &lt; count; ++i) {
    _delay_ms(1000);
    toggle_load(true);
    if(value &amp; (1 &lt;&lt; (count - i - 1))) {
      _delay_ms(500);
    } else {
      _delay_ms(50);
    }
    toggle_load(false);
  }
}
*/</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur;<font></font>
<font></font>
  toggle_lpf(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  cur = do_adc(); <span class="hljs-comment">//  </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
  toggle_lpf(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> cur;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_resistance</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> res;<font></font>
<font></font>
  toggle_gen(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  toggle_gen(<span class="hljs-literal">false</span>); <span class="hljs-comment">//   ,   C8     </span>
  res = do_adc(); <span class="hljs-comment">//     </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> MAX_U10BIT - res; <span class="hljs-comment">//      ,      </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_current() &gt;= cur_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_toggled_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_resistance() &lt;= res_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">do_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is_current()) {<font></font>
    toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(is_toggled_on()) {<font></font>
      toggle_load(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  ,  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span><font></font>
    }<font></font>
  }<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">first_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (frequency_dividor == <span class="hljs-number">0xff</span>); <span class="hljs-comment">//   EEPROM   0xFF,        FREQ_MAXIMAL_DIV</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">calibrate</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_off, cur_on, res_off, res_on, res_on_tmp, res_off_array[FREQ_MAXIMAL_DIV + <span class="hljs-number">1</span>], diff, max_diff, frequency_dividor_tmp;<font></font>
<font></font>
  blink_load(<span class="hljs-number">5</span>); <span class="hljs-comment">//    ,    </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  cur_off = get_current(); <span class="hljs-comment">//      ( )</span><font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_off_array[frequency_dividor] = get_resistance();<font></font>
  }<font></font>
<font></font>
  blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  cur_on = get_current(); <span class="hljs-comment">//     </span><font></font>
<font></font>
  blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  <font></font>
  res_off = MAX_U10BIT;<font></font>
  res_on = MAX_U10BIT;<font></font>
  frequency_dividor_tmp = <span class="hljs-number">0</span>;<font></font>
  max_diff = <span class="hljs-number">0</span>;
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_on_tmp = get_resistance();<font></font>
<font></font>
    <span class="hljs-comment">//   ,      </span>
    <span class="hljs-keyword">if</span>(res_off_array[frequency_dividor] &gt; res_on_tmp) {<font></font>
      diff = res_off_array[frequency_dividor] - res_on_tmp;<font></font>
      <span class="hljs-keyword">if</span>(diff &gt; max_diff) {<font></font>
        res_off = res_off_array[frequency_dividor];<font></font>
        res_on = res_on_tmp;<font></font>
        frequency_dividor_tmp = frequency_dividor;<font></font>
        max_diff = diff;<font></font>
      }    <font></font>
    }<font></font>
  }<font></font>
  frequency_dividor = frequency_dividor_tmp;<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(cur_on &gt; cur_off + CUR_MINIMAL_DIFF) { <font></font>
    cur_edge = cur_off + (cur_on - cur_off) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,     </span><font></font>
 <font></font>
    <span class="hljs-keyword">if</span>(res_on + RES_MINIMAL_DIFF &lt; res_off) {<font></font>
      res_edge = res_off - (res_off - res_on) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,      </span><font></font>
<font></font>
      <span class="hljs-comment">//   </span><font></font>
      eeprom_write_word(&amp;EEPROM_cur_edge, cur_edge);<font></font>
      eeprom_write_word(&amp;EEPROM_res_edge, res_edge);<font></font>
      eeprom_write_byte(&amp;EEPROM_frequency_dividor, frequency_dividor);<font></font>
      <font></font>
      blink_load(<span class="hljs-number">1</span>); <span class="hljs-comment">//  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
  }<font></font>
}<font></font>
<font></font>
ISR(WDT_vect) {<font></font>
  WDTCR |= (<span class="hljs-number">1</span> &lt;&lt; WDTIE); <span class="hljs-comment">//    watchdog   ""    </span><font></font>
}<font></font>
<font></font>
EMPTY_INTERRUPT(ADC_vect); <span class="hljs-comment">//     ,     </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  init_vars();<font></font>
  init_pins();       <font></font>
  init_interrupts(); <font></font>
  init_settings();<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(tp_reset || first_on()) {<font></font>
    calibrate(); <span class="hljs-comment">//          </span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {<font></font>
    set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
    sleep_cpu(); <span class="hljs-comment">//   watchdog</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span>(++clk &gt;= INTERVAL) {<font></font>
      do_main(); <span class="hljs-comment">//  </span>
      clk = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archive with diagram, wiring, and the complete Atmel Studio 7 project</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492788/index.html">Tired, but: Germany completely stopped the first wave of COVID-19</a></li>
<li><a href="../en492798/index.html">People have gone to chat on the Internet, but now again they dream of offline. What's happening?</a></li>
<li><a href="../en492800/index.html">GSM IoT Provider in Housing and Public Utilities (Part 1)</a></li>
<li><a href="../en492804/index.html">On the issue of replication of social activity on the Internet as a key to minimizing the increase in incidence during a pandemic</a></li>
<li><a href="../en492806/index.html">How to link engagement to monetization in mobile games and apps</a></li>
<li><a href="../en492810/index.html">[COVID-19] Your task is to smooth the peak</a></li>
<li><a href="../en492812/index.html">Trying to run GAN networks in OpenVINO</a></li>
<li><a href="../en492816/index.html">IntelliJ IDEA Tips & Tricks: 4. Synchronize and share settings</a></li>
<li><a href="../en492820/index.html">.Net Core Api: getting data in a request from different sources</a></li>
<li><a href="../en492822/index.html">CSS developers - why do the world need them?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>