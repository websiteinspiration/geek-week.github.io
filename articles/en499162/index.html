<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëì ‚ÜîÔ∏è üîù How to reduce bundle size - single-letter class strategy in css-modules üîô üéè üßöüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We improve the compression of bundles by 40% of the file size, by replacing the standard hashing with a one-letter prefix + hash of the file path.
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to reduce bundle size - single-letter class strategy in css-modules</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499162/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We improve the compression of bundles by 40% of the file size, by replacing the standard hashing with a one-letter prefix + hash of the file path.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Css-modules allow you to write Bird and Cat components, with styles in files with the same name styles.css and .block classes in each, and these classes will be different for each of these components.</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird / styles.css */</span>
<span class="hljs-selector-class">.block</span> { }
<span class="hljs-selector-class">.name</span> { }
<span class="hljs-comment">/* Cat / styles.css */</span>
<span class="hljs-selector-class">.block</span> { }
<span class="hljs-selector-class">.name</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is nothing tricky here: the webpack hashes each class from all the files using the "[hash: base64: 8]" setting. </font><font style="vertical-align: inherit;">All classes will be renamed, and links affixed to understand which class came from. </font><font style="vertical-align: inherit;">In the basic version of the assembly, we will have a styles.css file for styles and styles.js for links when working with js. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuing the test case, we get 4 independent classes with strange names like k3bvEft8:</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird */</span>
<span class="hljs-selector-class">.k3bvEft8</span> { }
<span class="hljs-selector-class">.f2tp3lA9</span> { }
<span class="hljs-comment">/* Cat */</span>
<span class="hljs-selector-class">.epIUQ_6W</span> { }
<span class="hljs-selector-class">.oRzvA1Gb</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the production assembly and compress the files. </font><font style="vertical-align: inherit;">At the stand, a 300Kb css file was packaged in 70Kb using gzip [or 50Kb using brotli]. </font><font style="vertical-align: inherit;">Compression is small because hashes are randomly generated strings that compress very poorly. </font><font style="vertical-align: inherit;">Compression algorithms do not see sequences and are forced to remember the locations of each symbol, i.e. </font><font style="vertical-align: inherit;">transfer the contents of these sections as is, without compression.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Something needs to be done with this. </font><font style="vertical-align: inherit;">But what? </font><font style="vertical-align: inherit;">During operation, the webpack reads the file tree asynchronously, and also goes through class names. </font><font style="vertical-align: inherit;">Each time in a different way. </font><font style="vertical-align: inherit;">The only thing you can cling to is the order of names inside css - it is constant (otherwise everything will break, in css the order is important). </font><font style="vertical-align: inherit;">The class position number in the file is encoded in a one-letter prefix. </font><font style="vertical-align: inherit;">You can take encoding in 52 ([a-zA-Z] +) or 64 ([a-zA-Z0-9 _-] +) characters. </font><font style="vertical-align: inherit;">The main thing here is not to forget to put down a protective prefix in cases with a number or hyphen.</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird */</span>
<span class="hljs-selector-class">.a</span> { }
<span class="hljs-selector-class">.b</span> { }
<span class="hljs-comment">/* Cat */</span>
<span class="hljs-selector-class">.c</span> { }
<span class="hljs-selector-class">.d</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems to look good - the names are compressed as much as possible. </font><font style="vertical-align: inherit;">But the catch is that the webpack is asynchronous, and each launch, and especially when the server and client simultaneous assemblies are launched in parallel, receives files in a chaotic manner, as do the class names. </font><font style="vertical-align: inherit;">Thanks for the speed, but here it interferes.</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird */</span>
<span class="hljs-selector-class">.c</span> { }
<span class="hljs-selector-class">.d</span> { }
<span class="hljs-comment">/* Cat */</span>
<span class="hljs-selector-class">.a</span> { }
<span class="hljs-selector-class">.b</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You see, caught a file order mismatch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We fix this behavior by remembering the file, where the classes came from, and their position number.</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird */</span>
<span class="hljs-selector-class">.a</span> { }
<span class="hljs-selector-class">.b</span> { }
<span class="hljs-comment">/* Cat */</span>
<span class="hljs-selector-class">.a</span> { }
<span class="hljs-selector-class">.b</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saved the order inside the files. </font><font style="vertical-align: inherit;">But you need to somehow distinguish the files from each other. </font><font style="vertical-align: inherit;">A hash from the file path will help to avoid confusion.</font></font><br>
<br>
<pre><code class="css hljs"><span class="hljs-comment">/* Bird */</span>
<span class="hljs-selector-class">.a_k3bvEft8</span> { }
<span class="hljs-selector-class">.b_k3bvEft8</span> { }
<span class="hljs-comment">/* Cat */</span>
<span class="hljs-selector-class">.a_oRzvA1Gb</span> { }
<span class="hljs-selector-class">.b_oRzvA1Gb</span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
('_' is not needed here, it is only for illustrative purposes. The hash has a stable length, unlike the prefix, and there can be no collisions) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have obtained class names that are absolutely unique for the project, but containing repeated sequences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our project, from the files css 50 Kb and js 47 Kb we got css 30 Kb and js 28 Kb [58 Kb in total, brotli]. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saving almost 40Kb. The size of critical css and the size of html will slightly decrease. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to write a class for processing data from the webpack and throw a call in the css-loader config (getLocalIdent)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS You can go further and save the file paths, sort the paths, and also replace them using a single-letter strategy, but this is worse in terms of long-term caching, plus you need to make several passes in the assembly and assemble the client / server sequentially. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS2 You can </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try on your project now, if you take the code here</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PS3. In production, we compress * .css and * style.js files by 93%. </font><font style="vertical-align: inherit;">We transfer 71,6Kb from 1,1Mb of the unpacked file (brotli)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499148/index.html">Aerosol and chlorine dioxide (ClO2): how is this related?</a></li>
<li><a href="../en499150/index.html">And one warrior in the field: is it possible to provide quality hosting services without a team</a></li>
<li><a href="../en499152/index.html">DLL & Python</a></li>
<li><a href="../en499154/index.html">The digest of interesting materials for the mobile # 342 developer (on April 20 - 26)</a></li>
<li><a href="../en499160/index.html">Russian SCRUM. Senseless and merciless</a></li>
<li><a href="../en499164/index.html">Video advertising under the hood: what is VAST?</a></li>
<li><a href="../en499166/index.html">FOSS News No. 13 - a review of free and open source software for April 20-26, 2020</a></li>
<li><a href="../en499168/index.html">Alexey Kapterev: Critical Thinking 101 (Part 2)</a></li>
<li><a href="../en499170/index.html">Synergy of Graphviz and C / C ++ Preprocessor</a></li>
<li><a href="../en499174/index.html">Microservices: what is it, why is it and when do you need to implement them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>