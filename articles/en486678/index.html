<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚ÄçüöÄ üôÅ üîÅ Quartz in ASP.NET Core üî∂ üë©üèª‚Äç‚úàÔ∏è üë©üèæ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 I know that there are a lot of articles and some kind of tutorials on this subject, I'm not even talking about official documentation, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Quartz in ASP.NET Core</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486678/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I know that there are a lot of articles and some kind of tutorials on this subject, I'm not even talking about official documentation, but when working on my latest project I came across a very interesting problem, which is not mentioned very much. </font><font style="vertical-align: inherit;">Today we will talk about the problem of using Dependency Injection and Quartz in an ASP.NET Core platform project.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It all started with the fact that I did not think that any problems could arise and I would say right away that I tried to use various approaches: I added all the classes that Quartz included in services and used them through DI - by (but not completely, as it turned out later), I tried to add HostedService - it didn‚Äôt work either (in the end I‚Äôll attach some good links to useful articles about working with Quartz) and so on. </font><font style="vertical-align: inherit;">I already thought that I had a problem with the trigger - neither. </font><font style="vertical-align: inherit;">In this short article I will try to help those who may have had the same problem and hope that my solution will help them in their future work. </font><font style="vertical-align: inherit;">At the end of the introduction, I want to add that I will be very grateful if in the comments those who are well acquainted with the technology give some advice that will help improve what I proposed.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quartz</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a project (or take a finished one - it doesn't matter) and add two folders and several classes to it: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quartz </font></font></b><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--DataJob.cs </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--DataScheduler.cs </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--JobFactory.cs </font></font></i><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workers </font></font></b><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--EmailSender </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--IEmailSender</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the IEmailSender interface, which will serve as an example , create one method for sending letters to mail:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IEmailSender</span><font></font>
    {<font></font>
        <span class="hljs-function">Task <span class="hljs-title">SendEmailAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> email, <span class="hljs-keyword">string</span> subject, <span class="hljs-keyword">string</span> message</span>)</span>;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we describe the class that will implement this interface:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EmailSender</span> : <span class="hljs-title">IEmailSender</span><font></font>
    {<font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">SendEmailAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> email, <span class="hljs-keyword">string</span> subject, <span class="hljs-keyword">string</span> message</span>)</span><font></font>
		{<font></font>
			<span class="hljs-keyword">var</span> <span class="hljs-keyword">from</span> = <span class="hljs-string">"****@gmail.com"</span>;
			<span class="hljs-keyword">var</span> pass = <span class="hljs-string">"****"</span>;<font></font>
            SmtpClient client = <span class="hljs-keyword">new</span> SmtpClient(<span class="hljs-string">"smtp.gmail.com"</span>, <span class="hljs-number">587</span>);<font></font>
			client.DeliveryMethod = SmtpDeliveryMethod.Network;<font></font>
			client.UseDefaultCredentials = <span class="hljs-literal">false</span>;<font></font>
			client.Credentials = <span class="hljs-keyword">new</span> System.Net.NetworkCredential(<span class="hljs-keyword">from</span>, pass);<font></font>
			client.EnableSsl = <span class="hljs-literal">true</span>;
			<span class="hljs-keyword">var</span> mail = <span class="hljs-keyword">new</span> MailMessage(<span class="hljs-keyword">from</span>, email);<font></font>
			mail.Subject = subject;<font></font>
			mail.Body = message;<font></font>
			mail.IsBodyHtml = <span class="hljs-literal">true</span>;
			<span class="hljs-keyword">return</span> client.SendMailAsync(mail);<font></font>
		}<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we describe the classes DataJob.cs, DataScheduler.cs, JobFactory.cs. </font><font style="vertical-align: inherit;">The DataJob class will implement the IJob interface.</font></font><br>
<br>
<pre><code class="cs hljs"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataJob</span> : <span class="hljs-title">IJob</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IServiceScopeFactory serviceScopeFactory;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DataJob</span>(<span class="hljs-params">IServiceScopeFactory serviceScopeFactory</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">this</span>.serviceScopeFactory = serviceScopeFactory;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Execute</span>(<span class="hljs-params">IJobExecutionContext context</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = serviceScopeFactory.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> emailsender = scope.ServiceProvider.GetService&lt;IEmailSender&gt;();<font></font>
                <font></font>
                 <span class="hljs-keyword">await</span> emailsender.SendEmailAsync(<span class="hljs-string">"example@gmail.com"</span>,<span class="hljs-string">"example"</span>,<span class="hljs-string">"hello"</span>)<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we see a field of type IServiceScopeFactory, we will get services directly from Startup. </font><font style="vertical-align: inherit;">It was this approach that helped me solve my problem, go ahead and describe the DataScheduler class in which we will add job and trigger in the Sheduler of the quartz itself:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataScheduler</span><font></font>
    {<font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><font></font>
        {<font></font>
            IScheduler scheduler = <span class="hljs-keyword">await</span> StdSchedulerFactory.GetDefaultScheduler();<font></font>
            scheduler.JobFactory = serviceProvider.GetService&lt;JobFactory&gt;();<font></font>
            <span class="hljs-keyword">await</span> scheduler.Start();<font></font>
<font></font>
            IJobDetail jobDetail = JobBuilder.Create&lt;DataJob&gt;().Build();<font></font>
            ITrigger trigger = TriggerBuilder.Create()<font></font>
                .WithIdentity(<span class="hljs-string">"MailingTrigger"</span>, <span class="hljs-string">"default"</span>)<font></font>
                .StartNow()<font></font>
                .WithSimpleSchedule(x =&gt; x<font></font>
                .WithIntervalInMinutes(<span class="hljs-number">1</span>)<font></font>
                .RepeatForever())<font></font>
                .Build();<font></font>
<font></font>
            <span class="hljs-keyword">await</span> scheduler.ScheduleJob(jobDetail, trigger);<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now the JobFactory class, which implements the IJobFactory interface:</font></font><br>
<br>
<pre><code class="cs hljs"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JobFactory</span> : <span class="hljs-title">IJobFactory</span><font></font>
    {<font></font>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">readonly</span> IServiceScopeFactory serviceScopeFactory;<font></font>
<font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JobFactory</span>(<span class="hljs-params">IServiceScopeFactory serviceScopeFactory</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">this</span>.serviceScopeFactory = serviceScopeFactory;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> IJob <span class="hljs-title">NewJob</span>(<span class="hljs-params">TriggerFiredBundle bundle, IScheduler scheduler</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = serviceScopeFactory.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> job = scope.ServiceProvider.GetService(bundle.JobDetail.JobType) <span class="hljs-keyword">as</span> IJob;
                <span class="hljs-keyword">return</span> job;<font></font>
            }<font></font>
            <font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReturnJob</span>(<span class="hljs-params">IJob job</span>)</span><font></font>
        {<font></font>
           <span class="hljs-comment">//Do something if need</span><font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, I, in fact, get all the dependencies directly from serviceScopeFactory. </font><font style="vertical-align: inherit;">Everything is almost ready, it remains to change the Program class:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> host = BuildWebHost(args);
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = host.Services.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> serviceProvider = scope.ServiceProvider;
                <span class="hljs-keyword">try</span><font></font>
                {<font></font>
                    DataScheduler.Start(serviceProvider);<font></font>
                }<font></font>
                <span class="hljs-keyword">catch</span> (Exception)<font></font>
                {<font></font>
                    <span class="hljs-keyword">throw</span>;<font></font>
                }<font></font>
            }<font></font>
            host.Run();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWebHost <span class="hljs-title">BuildWebHost</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span> =&gt;<font></font>
           WebHost.CreateDefaultBuilder(args)<font></font>
               .UseStartup&lt;Startup&gt;()<font></font>
               .Build();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And add the following to Startup in the ConfigureServices method:</font></font><br>
<br>
<pre><code class="cs hljs">   services.AddTransient&lt;JobFactory&gt;();<font></font>
   services.AddScoped&lt;DataJob&gt;();<font></font>
   services.AddScoped&lt;IEmailSender,EmailSender&gt;();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done. </font><font style="vertical-align: inherit;">Now when you start the application, we create a task that will fire every minute. </font><font style="vertical-align: inherit;">The value can be changed in DataScheduler.Start (can also be specified in seconds, hours or use CRON). </font><font style="vertical-align: inherit;">For each new task with this approach, you need to create a new class that will implement IJob and register a new DataScheduler task. </font><font style="vertical-align: inherit;">You can also create a separate Scheduler class for a new task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would be very happy if I could help someone, but here are a couple of useful articles about Quartz and its use: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a Quartz.NET hosted service with ASP.NET Core </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using scoped services inside a Quartz.NET hosted service with ASP.NET Core</font></font></a><br>
<cut></cut></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486678/">https://habr.com/ru/post/en486678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486668/index.html">Embedded World 2020. Russians are coming</a></li>
<li><a href="../en486670/index.html">Electronic passport of the Russian Federation, 2020th part of Marleson ballet</a></li>
<li><a href="../en486672/index.html">OpenVINO Hackathon: Recognizing Voice and Emotion on the Raspberry Pi</a></li>
<li><a href="../en486674/index.html">The digest of fresh materials from the world of the front-end for the last week No. 400 (January 27 - February 2, 2020)</a></li>
<li><a href="../en486676/index.html">Inevitability of FPGA penetration into data centers</a></li>
<li><a href="../en486680/index.html">ML, VR & Robots (and a bit of cloud)</a></li>
<li><a href="../en486682/index.html">Docker Compose: Simplify Using Makefile</a></li>
<li><a href="../en486684/index.html">My answer to those who believe that the value of TDD is exaggerated</a></li>
<li><a href="../en486686/index.html">About implementing a deep learning library in Python</a></li>
<li><a href="../en486688/index.html">Node.js, Tor, Puppeteer and Cheerio: anonymous web scraping</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>