<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ó üëë ü¶à Administrar sensores dom√©sticos inteligentes con el Asistente de Google ‚ìÇÔ∏è üîÑ ‚öúÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, los colegas de esta gu√≠a le dir√°n c√≥mo controlar los sensores dom√©sticos inteligentes utilizando el Asistente de Google y el protocolo mqtt, uti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Administrar sensores dom√©sticos inteligentes con el Asistente de Google</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola, los colegas de esta gu√≠a le dir√°n c√≥mo controlar los sensores dom√©sticos inteligentes utilizando el Asistente de Google y el protocolo mqtt, utilizando la placa ESP8266 y el LED como ejemplo. </font><font style="vertical-align: inherit;">Tambi√©n crearemos nuestra propia aplicaci√≥n Asistente con scripts de blackjack y php. </font><font style="vertical-align: inherit;">Les pido a todos un gato.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, necesitamos el controlador ESP8266 u otros controladores con conexi√≥n a Internet, as√≠ como un servidor con un certificado SSL v√°lido (en lugar de un SSL v√°lido, puede usar un proxy inverso que ya tenga uno) y un servidor MQTT (intermediario). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la integraci√≥n con el asistente de Google, utilizaremos el servicio Google Actions y Dialogflow. </font><font style="vertical-align: inherit;">Vamos a empezar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/n4/so/7nn4sojacyuqznn0ngm2_az_tek.jpeg" alt="imagen"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear y configurar un proyecto</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consola de acci√≥n de Google</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero debe iniciar sesi√≥n en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servicio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y crear un proyecto, seleccionar un idioma y una regi√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/8d/8p/3c8d8pr_uuzir7e6jizg3cx-xf4.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que necesite elegir el alcance. </font><font style="vertical-align: inherit;">Eleg√≠ Kids &amp; Family. </font><font style="vertical-align: inherit;">Seg√∫n la experiencia de otra persona, dir√© que la categor√≠a que pregunta l√≥gicamente Smart Home solo funciona correctamente con dispositivos de Google, para proyectos con sus propios sensores, es mejor elegir una categor√≠a diferente para un funcionamiento correcto. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/jk/-x/qrjk-xl3cvbhcrpdocrfhyfiecm.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leemos y aceptamos el acuerdo. </font><font style="vertical-align: inherit;">En la categor√≠a Configuraci√≥n r√°pida, vaya a Decidir c√≥mo se invoca su Acci√≥n. </font><font style="vertical-align: inherit;">Creamos c√≥mo se llamar√° nuestro bot y seleccionamos una voz de las disponibles, gu√°rdala. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w1/oz/ue/w1ozueqhhrzh0y42i1xwfwk8330.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vaya a la pesta√±a Acciones, agregue una acci√≥n Intenci√≥n personalizada</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/sg/n4/ntsgn4ps4curjg5c0ociivilfma.png" alt="imagen"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dialogflow</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de hacer clic en el bot√≥n Construir, se nos redirige al recurso Dialogflow, tambi√©n se inicia sesi√≥n y se procede a la creaci√≥n del proyecto:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elija el idioma y la zona horaria predeterminados.</font></font></li>
<li>   Fulfillment   <abbr title="interfaz entre dos programas">Webhook</abbr>.       (     ,  )   Dialogflow   POST .<br>
<br>
<img src="https://habrastorage.org/webt/2e/tu/ij/2etuijbmkox37tup8de8t8sq694.png" alt="imagen"></li>
<li>3.    .<br>
<br>
 intets         .       .      +   Intents.       .</li>
</ol><br>
<img src="https://habrastorage.org/webt/ay/d4/zy/ayd4zyszkzl59pzklkt8ps34sh4.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La p√°gina en s√≠ se puede dividir en tres categor√≠as: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las frases de entrenamiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son palabras a las que el asistente responde con el equipo. </font><font style="vertical-align: inherit;">Pueden ser diferentes para un equipo. </font><font style="vertical-align: inherit;">Por ejemplo, haga brillar las palabras, apague la luz, encienda la l√°mpara, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/v8/mm/duv8mm1gpmvibh2w6fd0u7x777w.png" alt="imagen"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la acci√≥n en s√≠ misma o la palabra que el sensor comprender√°, es una y concreta. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las respuestas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son las respuestas del asistente despu√©s de ejecutar el comando. </font><font style="vertical-align: inherit;">Aqu√≠ hay solo un campo para la creatividad.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/vj/hp/yxvjhpwsqueymkbo-4llo9jfvh8.png" alt="imagen"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuraci√≥n de alojamiento </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como servidor, compr√© la gotita m√°s barata ($ 5) e instal√© Debian 10.2 en ella. </font><font style="vertical-align: inherit;">El alojamiento que elijas no importa.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurar proxy inverso y DNS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede omitir esta parte si tiene un hosting con un certificado v√°lido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servicio Cloudflare en s√≠ ofrece muchos nombres de nivel inferior, por lo que si tiene problemas con el paso 4, es posible que deba especificar su IP en lugar de la predeterminada en la columna de contenido cerca de www ***, https // www *** (*** es su dominio) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para interactuar con Dialogflow, necesita un certificado SSL. </font><font style="vertical-align: inherit;">No lo instal√© en el servidor, sino que us√© el proxy DNS Cloudflare (gratuito - b√°sico). </font><font style="vertical-align: inherit;">Para hacer esto, al configurar Cloudflare, agregu√© mi nombre de dominio adquirido anteriormente y le agregu√© la direcci√≥n IP de mi servidor (columna Contenido). </font><font style="vertical-align: inherit;">Tambi√©n se agregaron dos registros A (en la imagen es Valor) en la configuraci√≥n del proveedor de nombres. </font><font style="vertical-align: inherit;">Vale la pena se√±alar que agregar un registro no es cuesti√≥n de segundos y puede llevar varios d√≠as h√°biles.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yp/gz/qz/ypgzqzczh7qgdveopje4to1dtp8.png" alt="imagen"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalaci√≥n de software</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Lo primero despu√©s de iniciar el servidor por primera vez, no olvide actualizar la base de datos del paquete</font></font><br>
<br>
<pre><code class="bash hljs">apt update</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego actualice los paquetes instalados </font></font><pre><code class="bash hljs">apt upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Despu√©s de instalar LAMP </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache</font></font><br>
<br>
<pre><code class="bash hljs">apt install apache2 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Php / mysql</font></font><br>
<br>
<pre><code class="bash hljs">apt-get install php libapache2-mod-php php-mcrypt php-mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregue la direcci√≥n del servidor en apache2.conf. Esto se puede hacer con el comando nano /etc/apache2/apache2.conf, que indica al final del archivo ServerName *** al final de su archivo, donde en lugar de asteriscos debe sustituir la ip del servidor. Verifique la sintaxis y reinicie el servicio Apach. Obtenga m√°s informaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de completar con √©xito los pasos descritos anteriormente al ingresar su nombre de dominio en la barra del navegador, recibir√° la p√°gina de bienvenida de Apache2. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/3k/uw/wu3kuwqec_ykskpcqtqttzph6wm.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si esto no sucede, verifique si los comandos se ejecutaron correctamente y si la p√°gina funciona con una conexi√≥n http no segura. Si funciona, el servidor probablemente est√© escuchando en el puerto 80, no en el puerto 443. O alg√∫n servicio ya se est√° ejecutando en √©l. M√°s detalles </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Instalaci√≥n de la Biblioteca Mosquitto para PHP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los dispositivos IoT pueden usar diferentes protocolos para la interoperabilidad. </font><font style="vertical-align: inherit;">Uno de esos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que funciona sobre la base de editor-suscriptor. </font><font style="vertical-align: inherit;">En este caso, los suscriptores pueden recibir informaci√≥n de muchos editores. </font><font style="vertical-align: inherit;">Pero como el protocolo solo comprende ciertos tipos de mensajes, necesita un convertidor (intermediario). </font><font style="vertical-align: inherit;">Aqu√≠ lo configuramos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Si no tiene instalado PECL, inst√°lelo</font></font><br>
<br>
<pre><code class="bash hljs">apt install pecl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que nos convertimos en un corredor </font></font><br>
<br>
<pre><code class="bash hljs">pecl install Mosquitto-alpha</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego agregue extension = mosquitto.so a su php.ini. </font><font style="vertical-align: inherit;">Y no olvides al cliente</font></font><br>
<br>
<pre><code class="bash hljs">apt install mosquitto mosquitto-clients
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s detalles </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de script PHP, suscripci√≥n al tema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, el gui√≥n en s√≠. </font><font style="vertical-align: inherit;">Su prop√≥sito es aceptar una solicitud de publicaci√≥n de Dialogflow, aislar la acci√≥n y enviarla como un mensaje al agente en el asunto, cuyo nombre se indica al final del script. </font><font style="vertical-align: inherit;">Lo que llamas gui√≥n no importa. </font><font style="vertical-align: inherit;">Por cierto, este es el script que indicamos en la pesta√±a Cumplimiento. </font><font style="vertical-align: inherit;">Coloque el script en / var / www / html Los </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
temas son creados por suscriptores. Para crear un tema, use el comando:</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_sub -h localhost - t /<span class="hljs-built_in">test</span>/light</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En lugar de localhost, puede especificar cualquier otra direcci√≥n o dominio donde desee crear un editor (pub). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En lugar de / test / light, puede especificar cualquier tema. </font><font style="vertical-align: inherit;">En nuestro caso, lo principal es que se indique en el script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los mensajes son creados por los editores. </font><font style="vertical-align: inherit;">Para crear un mensaje, puede usar el comando.</font></font><br>
<br>
<pre><code class="bash hljs">mosquitto_pub -h localhost - t /<span class="hljs-built_in">test</span>/light -m ‚Äúlight‚Äù</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no lo necesitaremos, porque nuestro editor (pub) ser√° nuestra aplicaci√≥n. </font><font style="vertical-align: inherit;">El esquema es este, cuando nuestra aplicaci√≥n recibe un comando, env√≠a una solicitud a nuestro script. </font><font style="vertical-align: inherit;">El script es para el intermediario, y el intermediario es para el suscriptor (esp8266). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificaremos el env√≠o de mensajes a trav√©s de la pesta√±a Test Action Console.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/j0/ff/ljj0ffysayc5d3wfg8ui2rcc15w.png" alt="imagen"><br>
<br>
<img src="https://habrastorage.org/webt/j5/tf/xz/j5tfxzjm9gbh7toxf9wi6zah2zw.png" alt="imagen"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script PHP</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">//Make sure that it is a POST request.</span>
<span class="hljs-keyword">if</span>(strcasecmp($_SERVER[<span class="hljs-string">'REQUEST_METHOD'</span>], <span class="hljs-string">'POST'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Request method must be POST!'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Make sure that the content type of the POST request has been set to application/json</span>
$contentType = <span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>]) ? trim($_SERVER[<span class="hljs-string">"CONTENT_TYPE"</span>])                                                                                                              : <span class="hljs-string">''</span>;
<span class="hljs-keyword">if</span>(strcasecmp($contentType, <span class="hljs-string">'application/json'</span>) != <span class="hljs-number">0</span>){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Content type must be: application/json'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//Receive the RAW post data.</span>
$content = trim(file_get_contents(<span class="hljs-string">"php://input"</span>));<font></font>
<font></font>
<span class="hljs-comment">//Attempt to decode the incoming RAW post data from JSON.</span><font></font>
$decoded = json_decode($content);<font></font>
<font></font>
<span class="hljs-comment">//file_put_contents($filename, $data);</span><font></font>
var_dump($decoded);<font></font>
<font></font>
<span class="hljs-keyword">echo</span> $decoded-&gt;queryResult-&gt;action;<font></font>
<font></font>
define(<span class="hljs-string">'BROKER'</span>, <span class="hljs-string">'localhost'</span>);<font></font>
define(<span class="hljs-string">'PORT'</span>, <span class="hljs-number">1883</span>);<font></font>
define(<span class="hljs-string">'CLIENT_ID'</span>,  getmypid());<font></font>
  <font></font>
$client = <span class="hljs-keyword">new</span> Mosquitto\Client(CLIENT_ID);<font></font>
$client-&gt;connect(BROKER, PORT, <span class="hljs-number">60</span>);<font></font>
<font></font>
        $message = $decoded-&gt;queryResult-&gt;action;<font></font>
        $client-&gt;publish(<span class="hljs-string">'/test/light'</span>, $message, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
        $client-&gt;loop();<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware ESP8266</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el firmware usaremos el IDE de Arduino. </font><font style="vertical-align: inherit;">Si alguien instala el IDE por primera vez, no se olvide del controlador ch340. </font><font style="vertical-align: inherit;">Por defecto, no existe dicho pago en arduino. </font><font style="vertical-align: inherit;">En Archivo &gt;&gt; Configuraci√≥n, debe especificar la direcci√≥n de las placas adicionales: arduino.esp8266.com/stable/package_esp8266com_index.json. </font><font style="vertical-align: inherit;">En Herramientas &gt;&gt; placa &gt;&gt; administrador de placa, debe instalar el paquete esp8266. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el boceto despu√©s de const char * ssid, debe indicar el nombre de su red wi-fi. </font><font style="vertical-align: inherit;">Despu√©s de const char * contrase√±a, su contrase√±a. </font><font style="vertical-align: inherit;">Despu√©s de const char * mqtt_server, especifique la direcci√≥n IP de su servidor.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sketch Arduino IDE</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;ESP8266WiFi.h&gt;<font></font>
#include &lt;PubSubClient.h&gt;<font></font>
<font></font>
// Update these with values suitable for your network.<font></font>
<font></font>
const char* ssid = "***";<font></font>
const char* password = "********";<font></font>
const char* mqtt_server = "**.**.*.*";<font></font>
<font></font>
WiFiClient espClient;<font></font>
PubSubClient client(espClient);<font></font>
long lastMsg = 0;<font></font>
char msg[50];<font></font>
int value = 0;<font></font>
<font></font>
int led = D5;<font></font>
<font></font>
void setup_wifi() {<font></font>
<font></font>
  delay(10);<font></font>
  // We start by connecting to a WiFi network<font></font>
  Serial.println();<font></font>
  Serial.print("Connecting to ");<font></font>
  Serial.println(ssid);<font></font>
<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  while (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(500);<font></font>
    Serial.print(".");<font></font>
  }<font></font>
<font></font>
  randomSeed(micros());<font></font>
<font></font>
  Serial.println("");<font></font>
  Serial.println("WiFi connected");<font></font>
  Serial.println("IP address: ");<font></font>
  Serial.println(WiFi.localIP());<font></font>
}<font></font>
<font></font>
void callback(char* topic, byte* payload, unsigned int length) {<font></font>
  String msg="";<font></font>
  Serial.print("Message arrived [");<font></font>
  Serial.print(topic);<font></font>
  Serial.print("] ");<font></font>
  for (int i = 0; i &lt; length; i++) {<font></font>
    Serial.print((char)payload[i]);<font></font>
    msg+=(char)payload[i];<font></font>
  }<font></font>
  Serial.println();<font></font>
<font></font>
  // Switch on the LED if an 1 was received as first character<font></font>
//  if ((char)payload[0] == '1') {<font></font>
  if (msg == "light") {<font></font>
    digitalWrite(led, HIGH);   // Turn the LED on <font></font>
  } else {<font></font>
    digitalWrite(led, LOW);  // Turn the LED off <font></font>
  }<font></font>
<font></font>
}<font></font>
<font></font>
void reconnect() {<font></font>
  // Loop until we're reconnected<font></font>
  while (!client.connected()) {<font></font>
    Serial.print("Attempting MQTT connection...");<font></font>
    // Create a random client ID<font></font>
    String clientId = "ESP8266Client-";<font></font>
    clientId += String(random(0xffff), HEX);<font></font>
    // Attempt to connect<font></font>
    if (client.connect(clientId.c_str())) {<font></font>
      Serial.println("connected");<font></font>
      // ... and resubscribe<font></font>
      client.subscribe("/test/light");<font></font>
    } else {<font></font>
      Serial.print("failed, rc=");<font></font>
      Serial.print(client.state());<font></font>
      Serial.println(" try again in 5 seconds");<font></font>
      // Wait 5 seconds before retrying<font></font>
      delay(5000);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
void setup() {<font></font>
  pinMode(led, OUTPUT);     // Initialize the led pin as an output<font></font>
  Serial.begin(115200);<font></font>
  setup_wifi();<font></font>
  client.setServer(mqtt_server, 1883);<font></font>
  client.setCallback(callback);<font></font>
}<font></font>
<font></font>
void loop() {<font></font>
<font></font>
  if (!client.connected()) {<font></font>
    reconnect();<font></font>
  }<font></font>
  client.loop();<font></font>
<font></font>
}<font></font>
</code></pre></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resultado</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, despu√©s de compilar el boceto, obtenemos una aplicaci√≥n que est√° integrada en el asistente de Google y administra los sensores. </font><font style="vertical-align: inherit;">En lugar de un tel√©fono inteligente, utilic√© una aplicaci√≥n web, pero prob√© en Android: el resultado es el mismo. </font><font style="vertical-align: inherit;">Lo principal es que si est√° probando desde un tel√©fono inteligente, no olvide decir: "Hable con la aplicaci√≥n ***".</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/vh/ug/qfvhugumopat-isohcimmyujd08.jpeg" alt="imagen"><br>
<br>
<img src="https://habrastorage.org/webt/eh/or/mv/ehormvyz41fgzhgogas1yrszpvs.jpeg" alt="imagen"><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/g-S82CdMIrY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490472/index.html">Mientras escrib√≠a una criptomoneda semi descentralizada en PHP. (Parte 1 - Coleccionar bibliotecas)</a></li>
<li><a href="../es490474/index.html">STM32 Parte 1: Lo b√°sico</a></li>
<li><a href="../es490476/index.html">Sensor inal√°mbrico para abrir y cerrar con funcionalidad avanzada</a></li>
<li><a href="../es490478/index.html">Estaci√≥n de soldadura DIY DIY v2</a></li>
<li><a href="../es490480/index.html">O Tiling-wm en 2 palabras</a></li>
<li><a href="../es490490/index.html">Lectura de fin de semana: 10 materiales sobre los efectos del sonido en la salud, desde "higiene de ruido" hasta buen sue√±o y GTD</a></li>
<li><a href="../es490492/index.html">El robot de almac√©n aprende a clasificar cosas no est√°ndar</a></li>
<li><a href="../es490494/index.html">Comprar ratas, Widiots y jugadores: propaganda de los peligros de los videojuegos en los a√±os 80</a></li>
<li><a href="../es490496/index.html">Creaci√≥n de una tienda en l√≠nea en Nuxt.js 2 Tutorial Parte 1</a></li>
<li><a href="../es490498/index.html">Mientras escrib√≠a una criptomoneda semi descentralizada en PHP. (Parte 2 - Desarrollo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>