<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌂 👩🏻‍🔬 ☔️ RESTinioは非同期HTTPサーバーです。非同期 🚾 🛋️ 🕦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="数年前に、HTTPサーバーをC ++アプリケーションに埋め込むための小さなOpenSource C ++フレームワークであるRESTinioを公​​開しました。この間、REStinioは大人気になりませんでしたが、失われませんでした。誰かが「ネイティブ」のWindowsサポート、誰か（sendfil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>RESTinioは非同期HTTPサーバーです。非同期</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451728/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数年前に</font><font style="vertical-align: inherit;">、HTTPサーバーをC ++アプリケーションに埋め込むための小さなOpenSource C ++フレームワークである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RESTinio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を公​​開し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この間、REStinioは大人気になり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ませんでした</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、失わ</font></a><font style="vertical-align: inherit;">れ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ませんでした</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">誰かが「ネイティブ」のWindowsサポート、誰か（sendfileサポートなど）の個々の機能、機能の比率、使いやすさ、およびカスタマイズのために誰かを選択します。</font><font style="vertical-align: inherit;">しかし、最初は多くのRESTinioがこの簡潔な「Hello、World」に惹かれていると思います。</font></font></p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;restinio/all.hpp&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    restinio::run(<font></font>
        restinio::on_this_thread()<font></font>
        .port(<span class="hljs-number">8080</span>)<font></font>
        .address(<span class="hljs-string">"localhost"</span>)<font></font>
        .request_handler([](<span class="hljs-keyword">auto</span> req) {
            <span class="hljs-keyword">return</span> req-&gt;create_response().set_body(<span class="hljs-string">"Hello, World!"</span>).done();<font></font>
        }));<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、C ++アプリケーション内でHTTPサーバーを実行するために必要なすべてです。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、私たちがRESTinioを一般的に取り上げた主な機能は着信要求の非同期処理であるといつも言っていますが、request_handler内で長時間の操作を実行する必要がある場合の対処法についての質問が時々発生します。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、そのような質問は関連があるので、それについてもう一度話し、いくつかの小さな例を挙げてください。</font></font></p><a name="habracut"></a><br>
<h1 id="nebolshaya-otsylka-k-istokam"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起源への少しの言及</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">埋め込み可能なHTTPサーバーを数回続けて非常によく似たタスクに直面させることを決定しました。既存のC ++アプリケーションのHTTP入力を整理する必要があるか、既存の「重い」C ++を再利用する必要があるマイクロサービスを作成する必要がありました。コード。</font><font style="vertical-align: inherit;">これらのタスクの共通の特徴は、リクエストのアプリケーション処理が数十秒間伸びることでした。</font></font></p><br>
<p> , HTTP-      HTTP-,    HTTP-    -      -  .    HTTP-   ,  HTTP-      ,           .</p><br>
<p> ,  HTTP-       ,    /    .       -       HTTP-. ,  , -           ,   HTTP-,    HTTP-      .</p><br>
<p>         ,        ,      Windows  "" ,   -  , , ,       ,    2017    RESTinio.</p><br>
<p>     HTTP-,   ,    -  ,   - ,        .   ,      ...</p><br>
<h1 id="itak-est-vhodyaschiy-zapros-trebuyuschiy-mnogo-vremeni-na-obrabotku-chto-delat">,   ,     .  ?</h1><br>
<h2 id="rabochie-niti-restinioasio">  RESTinio/Asio</h2><br>
<p>  RESTinio    ,        RESTinio. , -  ,   RESTinio      ( <code>run(on_this_thread(...))</code>,    ),      RESTinio    .     - RESTinio " "   .              request_handler-.</p><br>
<p>    ,    RESTinio,      -,    request_handler-. ,    RESTinio-  <code>run(on_this_thread(...))</code>,   <code>run()</code>        -,   .</p><br>
<p> , RESTinio  Asio- event-loop,      ,        ,     ,     ..  ,  ,          ,        request_handler.</p><br>
<p>,  request_handler    ,         Asio- event-loop.  .</p><br>
<p> RESTinio      (..  <code>run(on_thread_pool(...))</code>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a>),     :       Asio- event-loop.   - request_handler    ,               -.</p><br>
<p>   RESTinio    ,   request_handler-    , ,    .</p><br>
<h2 id="nuzhen-li-vam-pul-rabochih-potokov-dlya-restinioasio">       RESTinio/Asio?</h2><br>
<p>,    request_handler     ,    ,        -.   ,  request_handler-      ? ,   -   ,         ?</p><br>
<p>-    ,   RESTinio      ,        .</p><br>
<p> ,       ,      .     .         (       ),    ,           .     -    .      "".    RESTinio    -,  RESTinio          .</p><br>
<p>,           ,     RESTinio    ,            .          - ,        .</p><br>
<p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">- Shrimp</a>    : "<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Shrimp:     HTTP    C++  ImageMagic++, SObjectizer  RESTinio</a>".</p><br>
<h2 id="primery-delegirovaniya-obrabotki-zaprosov-na-otdelnye-rabochie-niti">       </h2><br>
<p>   ,         request_handler-.    :       -   .    ,    .</p><br>
<p>           RESTinio          .     -        RESTinio    .</p><br>
<p>   thread-safe message queue           ,       SObjectizer-   mchain-,   CSP- .   mchain-   : "<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">      ? CSP-    </a>".</p><br>
<h3 id="sohranenie-obekta-request_handle">  request_handle</h3><br>
<p> ,      , —   -  <code>request_handle_t</code>.</p><br>
<p> RESTinio        request_handler,   request_handler    <code>request_handle_t</code>.      ,       .    -  ,  <code>request_handle_t</code> —  <code>shared_ptr</code>,     .  <code>shared_ptr</code>  .</p><br>
<p>  <code>request_handle_t</code> —  <code>shared_ptr</code>,        - .         .</p><br>
<p>,           .   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">//  SObjectizer.</span>
    so_5::<span class="hljs-keyword">wrapped_env_t</span> sobj;<font></font>
<font></font>
    <span class="hljs-comment">//  std::thread    .</span>
    <span class="hljs-built_in">std</span>::thread processing_thread;
    <span class="hljs-comment">//    main      join.</span>
    <span class="hljs-comment">//    RAII.</span>
    <span class="hljs-keyword">auto</span> processing_thread_joiner = so_5::auto_join(processing_thread);<font></font>
<font></font>
    <span class="hljs-comment">//      .</span>
    <span class="hljs-keyword">auto</span> req_ch = so_5::create_mchain(sobj);
    <span class="hljs-comment">//       main.</span>
    <span class="hljs-comment">//    RAII.</span>
    <span class="hljs-keyword">auto</span> ch_closer = so_5::auto_close_drop_content(req_ch);<font></font>
<font></font>
    <span class="hljs-comment">//     .</span>
    <span class="hljs-comment">//      main()  - ,</span>
    <span class="hljs-comment">//     ,      join().</span>
    processing_thread = <span class="hljs-built_in">std</span>::thread{<font></font>
            processing_thread_func, req_ch<font></font>
    };</code></pre><br>
<p>       <code>processing_thread_func()</code>,     .</p><br>
<p>             .   RESTinio-:</p><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ,     .</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">traits_t</span> :</span> <span class="hljs-keyword">public</span> restinio::<span class="hljs-keyword">default_traits_t</span><font></font>
    {<font></font>
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">logger_t</span> = restinio::<span class="hljs-keyword">shared_ostream_logger_t</span>;<font></font>
    };<font></font>
<font></font>
    restinio::run(<font></font>
        restinio::on_this_thread&lt;<span class="hljs-keyword">traits_t</span>&gt;()<font></font>
            .port(<span class="hljs-number">8080</span>)<font></font>
            .address(<span class="hljs-string">"localhost"</span>)<font></font>
            .request_handler([req_ch](<span class="hljs-keyword">auto</span> req) {
                <span class="hljs-comment">//   GET-   .</span>
                <span class="hljs-keyword">if</span>(restinio::<span class="hljs-keyword">http_method_t</span>::http_get == req-&gt;header().method() &amp;&amp;
                        <span class="hljs-string">"/"</span> == req-&gt;header().path())<font></font>
                {<font></font>
                    <span class="hljs-comment">//    .</span><font></font>
                    so_5::send&lt;handle_request&gt;(req_ch, req);<font></font>
                    <span class="hljs-keyword">return</span> restinio::request_accepted();<font></font>
                }<font></font>
                <span class="hljs-keyword">else</span>
                    <span class="hljs-keyword">return</span> restinio::request_rejected();<font></font>
            })<font></font>
            .cleanup_func([&amp;] {<font></font>
                <span class="hljs-comment">//      .</span>
                <span class="hljs-comment">//    , ..  req_ch</span>
                <span class="hljs-comment">//         </span>
                <span class="hljs-comment">//     .</span><font></font>
                so_5::close_drop_content(req_ch);<font></font>
            }));</code></pre><br>
<p>     .   GET-  '/',       .      :</p><br>
<ul>
<li>  <code>request_handle_t</code>  CSP- .      CSP-   - ,  RESTinio ,    ;</li>
<li>  <code>restinio::request_accepted()</code>   .   RESTinio ,           .</li>
</ul><br>
<p> ,  request_handler     RESTinio   .   <code>restinio::request_accepted()</code>,           -     .</p><br>
<p>     <code>restinio::request_rejected()</code>,  RESTinio ,          501.</p><br>
<p>,   :  <code>request_handle_t</code>    -,  ,  , <code>std::shared_ptr</code>.    , RESTinio ,     .     <code>restinio::request_accepted()</code>,  RESTinio     ,          .</p><br>
<p>         :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processing_thread_func</span><span class="hljs-params">(so_5::<span class="hljs-keyword">mchain_t</span> req_ch)</span>
</span>{
    <span class="hljs-comment">//      </span>
    <span class="hljs-comment">//    .</span>
    <span class="hljs-built_in">std</span>::random_device rd;
    <span class="hljs-built_in">std</span>::mt19937 generator{rd()};
    <span class="hljs-built_in">std</span>::uniform_int_distribution&lt;&gt; pause_generator{<span class="hljs-number">350</span>, <span class="hljs-number">3500</span>};<font></font>
<font></font>
    <span class="hljs-comment">//      timeout_elapsed.</span>
    <span class="hljs-keyword">auto</span> delayed_ch = so_5::create_mchain(req_ch-&gt;environment());<font></font>
<font></font>
    <span class="hljs-comment">//     -  .</span>
    <span class="hljs-keyword">bool</span> stop = <span class="hljs-literal">false</span>;<font></font>
    select(<font></font>
        so_5::from_all()<font></font>
            <span class="hljs-comment">//      .</span>
            .on_close([&amp;stop](<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> &amp;) { stop = <span class="hljs-literal">true</span>; })
            <span class="hljs-comment">//     select().</span>
            <span class="hljs-comment">//  select()     .</span>
            .stop_on([&amp;stop]{ <span class="hljs-keyword">return</span> stop; }),<font></font>
<font></font>
        <span class="hljs-comment">//   handle_request     RESTinio.</span><font></font>
        case_(req_ch,<font></font>
            [&amp;](handle_request cmd) {<font></font>
                <span class="hljs-comment">//     .</span>
                <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::chrono::milliseconds pause{pause_generator(generator)};<font></font>
<font></font>
                <span class="hljs-comment">//     .</span><font></font>
                so_5::send_delayed&lt;timeout_elapsed&gt;(delayed_ch,<font></font>
                        <span class="hljs-comment">//    timeout_elapsed.</span><font></font>
                        pause,<font></font>
                        <span class="hljs-comment">//      timeout_elapsed.</span><font></font>
                        cmd.m_req,<font></font>
                        pause);<font></font>
            }),<font></font>
<font></font>
        <span class="hljs-comment">//   timeout_elapsed.</span><font></font>
        case_(delayed_ch,<font></font>
            [](timeout_elapsed cmd) {<font></font>
                <span class="hljs-comment">//     .</span><font></font>
                cmd.m_req-&gt;create_response()<font></font>
                        .set_body(<span class="hljs-string">"Hello, World! (pause:"</span>
                                + <span class="hljs-built_in">std</span>::to_string(cmd.m_pause.count())<font></font>
                                + <span class="hljs-string">"ms)"</span>)<font></font>
                        .done();<font></font>
            })<font></font>
    );<font></font>
}</code></pre><br>
<p>   :        <code>handle_request</code>              <code>timeout_elapsed</code>.        <code>timeout_elapsed</code>.</p><br>
<p><strong>Upd.</strong>        <code>done()</code>,  RESTinio   ,    ,     TCP-. RESTinio   ,   I/O-    ,   <code>done()</code>,  ,  RESTinio  -   request_handler-. ..    <code>done()</code>     ,        , ,   <code>restinio::run()</code>.</p><br>
<p>     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">handle_request</span>
{</span>
    restinio::<span class="hljs-keyword">request_handle_t</span> m_req;<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeout_elapsed</span>
{</span>
    restinio::<span class="hljs-keyword">request_handle_t</span> m_req;
    <span class="hljs-built_in">std</span>::chrono::milliseconds m_pause;<font></font>
};</code></pre><br>
<p>..     <code>request_handle_t</code>      ,       .     ,   -  <code>create_response()</code>    RESTinio.   RESTinio            .</p><br>
<p>  <code>request_handle_t</code>     <code>timeout_elapsed</code>,         .    <code>request_handle_t</code>    -    - ,    .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   RESTinio</a>.</p><br>
<h4 id="neskolko-nebolshih-poyasneniy-po-kodu">    </h4><br>
<p>    RESTinio ,    RESTinio-:</p><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ,     .</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">traits_t</span> :</span> <span class="hljs-keyword">public</span> restinio::<span class="hljs-keyword">default_traits_t</span><font></font>
    {<font></font>
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">logger_t</span> = restinio::<span class="hljs-keyword">shared_ostream_logger_t</span>;<font></font>
    };<font></font>
<font></font>
    restinio::run(<font></font>
        restinio::on_this_thread&lt;<span class="hljs-keyword">traits_t</span>&gt;()</code></pre><br>
<p>    ,  RESTinio      .    <code>logger_t</code>,      <code>null_logger_t</code>.  .. RESTinio  , ,    (  RESTinio    ,          ),   thread-safe logger,    <code>shared_ostream_logger_t</code>.</p><br>
<p> <code>processing_thread_func()</code>  SObjectizer-  <code>select()</code>,  -  Go-  select:         .  <code>select()</code>    ,        .      ,   .</p><br>
<p>        RESTinio-,     .   <code>select()</code>       :   -  ,   stop.       <code>select()</code>    <code>processing_thread_func()</code>.</p><br>
<h3 id="sohranenie-obekta-response_builder">  response_builder</h3><br>
<p>      ,     <code>request_handle_t</code>   ,         .</p><br>
<p>      , , ,     . ..,   ,       .  . ,  - ,        . ,   - ,       ..</p><br>
<p>    ,        ,    . ..    ,     ,  ,    ..</p><br>
<p>RESTinio      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">responce_builder-  </a>.  ,  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">user_controlled_output</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">chunked_output</a>.</p><br>
<p>      <code>request_handle_t</code>,  <code>request_handle_t</code>       <code>create_reponse()</code>.      response_builder-.  ...</p><br>
<p>   . Response_builder —  moveable , -   unique_ptr.           ,    .   ,   ,     .  ,   <code>processing_thread_func()</code>   .</p><br>
<p>   .</p><br>
<p>     ,    <code>processing_thread_func()</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">handle_request</span>
{</span>
   restinio::<span class="hljs-keyword">request_handle_t</span> m_req;<font></font>
};<font></font>
<font></font>
<span class="hljs-comment">//     .</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">output_t</span> = restinio::<span class="hljs-keyword">chunked_output_t</span>;<font></font>
<font></font>
<span class="hljs-comment">//   reponse_builder-   .</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">response_t</span> = restinio::<span class="hljs-keyword">response_builder_t</span>&lt;<span class="hljs-keyword">output_t</span>&gt;;<font></font>
<font></font>
<span class="hljs-comment">//     .</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeout_elapsed</span>
{</span>
   <span class="hljs-keyword">response_t</span> m_resp;
   <span class="hljs-keyword">int</span> m_counter;<font></font>
};</code></pre><br>
<p> <code>handle_request</code>   .     <code>timeout_elapsed</code>     <code>request_handle_t</code>,  response_builder   .    .     ,   .</p><br>
<p>        <code>processing_thread_func()</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processing_thread_func</span><span class="hljs-params">(so_5::<span class="hljs-keyword">mchain_t</span> req_ch)</span>
</span>{
   <span class="hljs-built_in">std</span>::random_device rd;
   <span class="hljs-built_in">std</span>::mt19937 generator{rd()};
   <span class="hljs-built_in">std</span>::uniform_int_distribution&lt;&gt; pause_generator{<span class="hljs-number">350</span>, <span class="hljs-number">3500</span>};<font></font>
<font></font>
   <span class="hljs-keyword">auto</span> delayed_ch = so_5::create_mchain(req_ch-&gt;environment());<font></font>
<font></font>
   <span class="hljs-keyword">bool</span> stop = <span class="hljs-literal">false</span>;<font></font>
   select(<font></font>
      so_5::from_all()<font></font>
         .on_close([&amp;stop](<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> &amp;) { stop = <span class="hljs-literal">true</span>; })<font></font>
         .stop_on([&amp;stop]{ <span class="hljs-keyword">return</span> stop; }),<font></font>
<font></font>
      case_(req_ch,<font></font>
         [&amp;](handle_request cmd) {<font></font>
            <span class="hljs-comment">//    ,    .</span>
            <span class="hljs-keyword">auto</span> resp = cmd.m_req-&gt;create_response&lt;<span class="hljs-keyword">output_t</span>&gt;();<font></font>
<font></font>
            resp.append_header( restinio::http_field::server, <span class="hljs-string">"RESTinio"</span> )<font></font>
               .append_header_date_field()<font></font>
               .append_header( restinio::http_field::content_type,<font></font>
                     <span class="hljs-string">"text/plain; charset=utf-8"</span> );<font></font>
<font></font>
            <span class="hljs-comment">//    ,  RESTinio</span>
            <span class="hljs-comment">//   .</span><font></font>
            resp.flush();<font></font>
<font></font>
            <span class="hljs-comment">//       .</span><font></font>
            so_5::send_delayed&lt;so_5::mutable_msg&lt;timeout_elapsed&gt;&gt;(delayed_ch,<font></font>
                  <span class="hljs-comment">//     .</span>
                  <span class="hljs-built_in">std</span>::chrono::milliseconds{pause_generator(generator)},
                  <span class="hljs-comment">//    timeout_elapsed.</span>
                  <span class="hljs-comment">//     response_builder-  .</span>
                  <span class="hljs-built_in">std</span>::move(resp),
                  <span class="hljs-number">3</span>);<font></font>
         }),<font></font>
<font></font>
      case_(delayed_ch,<font></font>
         [&amp;](so_5::<span class="hljs-keyword">mutable_mhood_t</span>&lt;timeout_elapsed&gt; cmd) {
            <span class="hljs-comment">//      .</span>
            cmd-&gt;m_resp.append_chunk( <span class="hljs-string">"this is the next part of the response\n"</span> );
            <span class="hljs-comment">//  RESTinio   .</span><font></font>
            cmd-&gt;m_resp.flush();<font></font>
<font></font>
            cmd-&gt;m_counter -= <span class="hljs-number">1</span>;<font></font>
<font></font>
            <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> != cmd-&gt;m_counter )<font></font>
            {<font></font>
               <span class="hljs-comment">//        .</span><font></font>
               so_5::send_delayed(<font></font>
                     delayed_ch,<font></font>
                     <span class="hljs-built_in">std</span>::chrono::milliseconds{pause_generator(generator)},
                     <span class="hljs-built_in">std</span>::move(cmd));<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span>
               <span class="hljs-comment">// ,   .</span><font></font>
               cmd-&gt;m_resp.done();<font></font>
         })<font></font>
   );<font></font>
}</code></pre><br>
<p>..     ,        .       .         .</p><br>
<p><strong>Upd.</strong>   <code>flush()</code>   ,     <code>done()</code>: RESTinio   ,   I/O-    ,   <code>flush()</code>,  ,  RESTinio  -   request_handler-. ..    <code>flush()</code>     ,        , ,   <code>restinio::run()</code>.</p><br>
<p>      ,    RESTinio    :</p><br>
<pre><code class="plaintext hljs">[2019-05-13 15:02:35.106] TRACE: starting server on 127.0.0.1:8080<font></font>
[2019-05-13 15:02:35.106]  INFO: init accept #0<font></font>
[2019-05-13 15:02:35.106]  INFO: server started on 127.0.0.1:8080<font></font>
[2019-05-13 15:02:39.050] TRACE: accept connection from 127.0.0.1:49280 on socket #0<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] start connection with 127.0.0.1:49280<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] start waiting for request<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] continue reading request<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] received 78 bytes<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] request received (#0): GET /<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 1<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] start next write group for response (#0), size: 1<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] start response (#0): HTTP/1.1 200 OK<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] sending resp data, buf count: 1, total size: 167<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] outgoing data was sent: 167 bytes<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] finishing current write group<font></font>
[2019-05-13 15:02:39.050] TRACE: [connection:1] should keep alive<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] start next write group for response (#0), size: 3<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] outgoing data was sent: 42 bytes<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] finishing current write group<font></font>
[2019-05-13 15:02:40.190] TRACE: [connection:1] should keep alive<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] start next write group for response (#0), size: 3<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] outgoing data was sent: 42 bytes<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] finishing current write group<font></font>
[2019-05-13 15:02:43.542] TRACE: [connection:1] should keep alive<font></font>
[2019-05-13 15:02:46.297] TRACE: [connection:1] append response (#0), flags: { not_final_parts, connection_keepalive }, write group size: 3<font></font>
[2019-05-13 15:02:46.297] TRACE: [connection:1] start next write group for response (#0), size: 3<font></font>
[2019-05-13 15:02:46.297] TRACE: [connection:1] sending resp data, buf count: 3, total size: 42<font></font>
[2019-05-13 15:02:46.297] TRACE: [connection:1] append response (#0), flags: { final_parts, connection_keepalive }, write group size: 1<font></font>
[2019-05-13 15:02:46.297] TRACE: [connection:1] outgoing data was sent: 42 bytes<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] finishing current write group<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] should keep alive<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] start next write group for response (#0), size: 1<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] sending resp data, buf count: 1, total size: 5<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] outgoing data was sent: 5 bytes<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] finishing current write group<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] should keep alive<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] start waiting for request<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] continue reading request<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] EOF and no request, close connection<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] close<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] close: close socket<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] close: timer canceled<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] close: reset responses data<font></font>
[2019-05-13 15:02:46.298] TRACE: [connection:1] destructor called</code></pre><br>
<p>  ,  RESTinio           167 .          ,           , RESTinio          .</p><br>
<p>  ,    RESTinio   -     response_builder     ,        .</p><br>
<p>     .        , ,     .       response_builder   .     ,   responce_builder       ,          ..</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2 id="chto-budet-esli-obrabotka-zaprosa-zaymet-slishkom-mnogo-vremeni"> ,       ?</h2><br>
<p>,   request_handler-     -   .  ,      ,           ?</p><br>
<p> RESTinio    ,   -  request_handler-.    - ,     , RESTinio       . ,         . , :</p><br>
<pre><code class="plaintext hljs">[2019-05-13 15:32:23.618] TRACE: starting server on 127.0.0.1:8080<font></font>
[2019-05-13 15:32:23.618]  INFO: init accept #0<font></font>
[2019-05-13 15:32:23.618]  INFO: server started on 127.0.0.1:8080<font></font>
[2019-05-13 15:32:26.768] TRACE: accept connection from 127.0.0.1:49502 on socket #0<font></font>
[2019-05-13 15:32:26.768] TRACE: [connection:1] start connection with 127.0.0.1:49502<font></font>
[2019-05-13 15:32:26.768] TRACE: [connection:1] start waiting for request<font></font>
[2019-05-13 15:32:26.768] TRACE: [connection:1] continue reading request<font></font>
[2019-05-13 15:32:26.768] TRACE: [connection:1] received 78 bytes<font></font>
[2019-05-13 15:32:26.768] TRACE: [connection:1] request received (#0): GET /<font></font>
[2019-05-13 15:32:30.768] TRACE: [connection:1] handle request timed out<font></font>
[2019-05-13 15:32:30.768] TRACE: [connection:1] close<font></font>
[2019-05-13 15:32:30.768] TRACE: [connection:1] close: close socket<font></font>
[2019-05-13 15:32:30.768] TRACE: [connection:1] close: timer canceled<font></font>
[2019-05-13 15:32:30.768] TRACE: [connection:1] close: reset responses data<font></font>
[2019-05-13 15:32:31.768]  WARN: [connection:1] try to write response, while socket is closed<font></font>
[2019-05-13 15:32:31.768] TRACE: [connection:1] destructor called</code></pre><br>
<p>  -       . ,      ,  RESTinio   , ..     .</p><br>
<p>  -    <code>handle_request_timeout</code>,     RESTinio- ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>).</p><br>
<h1 id="zaklyuchenie"></h1><br>
<p>,   ,      RESTinio —   ,   .  ,     RESTinio,    ,        RESTinio,     .</p><br>
<p>     RESTinio        ,  , ,  :  ? -  ? -  ? - -  ?</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS。</font><font style="vertical-align: inherit;">Habréについては、これまでのところRESTinioについてはSObjectizerについて話すよりもずっと少ないですが、いくつかの出版物があります。</font><font style="vertical-align: inherit;">「：だから、ここでは、その後、誰かが最初RESTinioについて学んだ場合は、そのうちのいくつかで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">人間の顔を持つ組み込み非同期HTTPサーバーの実装の3階建てのC ++のパターン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、「」</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++での非同期HTTPリクエスト：送信、RESTinio通ってくるには、 libcurl経由。パート1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "、" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エビ：ImageMagic ++、SObjectizer、およびRESTinioを使用して最新のC ++でHTTPイメージをスケーリングおよび配布します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja451718/index.html">音声アシスタントを作成</a></li>
<li><a href="../ja451720/index.html">FIASは、MSSQLSERVER上のデータベースへの即興（SQLXMLBULKLOAD）によるロードです。（おそらく）それを行う必要がない方法</a></li>
<li><a href="../ja451722/index.html">Qt-非同期非同期ウィジェットライブラリ</a></li>
<li><a href="../ja451724/index.html">スキルミオンとスキルミオンの不和：強弾性における三次元極スキルミオン</a></li>
<li><a href="../ja451726/index.html">海外で仕事を探す：ITプロフェッショナル向けの7つの簡単なヒント</a></li>
<li><a href="../ja451738/index.html">記事「DeViSE：深い視覚意味的埋め込みモデル」の短いレビュー</a></li>
<li><a href="../ja451742/index.html">DotNext 2019 Piterの1日前。無料の放送アナウンス</a></li>
<li><a href="../ja451746/index.html">エンジニアと建築家のためのMegaSlerm Kubernetes</a></li>
<li><a href="../ja451748/index.html">QsanアレイでのSSDステータスの監視</a></li>
<li><a href="../ja451750/index.html">本「Elasticsearch、Kibana、Logstash、および次世代検索エンジン」</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>