<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõï üë¥ ü•ã Create a TODO API for Golang with Kubernetes üå´Ô∏è üëÇ üî©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! Ahead of the launch of the Kubernetes-based Infrastructure Platform course, we prepared a translation of another interesting material....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Create a TODO API for Golang with Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/498130/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font><font style="vertical-align: inherit;">Ahead of the launch of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes-based Infrastructure Platform course, we</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prepared a translation of another interesting material.</font></font></b></i><br>
<br>
<hr><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article is intended for newcomers to Kubernetes, who will be interested in understanding a practical example of how to write a Golang API to manage the TODO list, and then how to deploy it to Kubernetes. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every developer loves a good TODO list, right? </font><font style="vertical-align: inherit;">How else could we organize ourselves otherwise? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/jy/vw/gdjyvw5u8cexjnsseoybworcx7a.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Every developer loves a good TODO application, right? </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We'll start by reviewing the list of necessary components, then go on to configure Kubernetes, provide the Postgresql database, and then install an application framework that will help us easily deploy the Go API in Kubernetes, without focusing on the details.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will create two endpoints in the API - one to create a new TODO record, the other to select all TODO records. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All code from this tutorial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is available on GitHub.</font></font></a></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The list of necessary components:</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locally Installed Docker</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes runs code in container images, so you need to install Docker on your computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install Docker: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.docker.com</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Register a Docker Hub account to store your Docker images: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Cluster</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can choose either a local or remote cluster, but which one is better? </font><font style="vertical-align: inherit;">Simplified options, such as k3d, work on any computer that Docker can run on, so running a local cluster no longer requires a lot of RAM. </font><font style="vertical-align: inherit;">A remote cluster can also be a very efficient solution, but keep in mind that all of your Docker images will need to be uploaded and uploaded for each change. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install k3d: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/rancher/k3d</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
k3d will not install kubectl (this is the CLI for Kubernetes), so install it separately from here: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kubernetes.io/docs/tasks/tools / install-kubectl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You also need to install Golang with the IDE on your computer. </font><font style="vertical-align: inherit;">Go is free and you can download it for MacOS, Windows or Linux from the following link: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://golang.org/dl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDE</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would recommend using Visual Studio Code, it is free and has a set of plugins for Go that you can add. </font><font style="vertical-align: inherit;">Some colleagues prefer Goland from Jetbrains. </font><font style="vertical-align: inherit;">If you are a Java programmer, you probably would rather pay for Goland, as it will remind you of their other products. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSCode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You need to install all the software specified in the previous section.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a new cluster using k3d:</font></font></h4><br>
<code>k3d create</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configure kubectl so that it points to a new cluster. </font><font style="vertical-align: inherit;">Remember that multiple clusters can be used from the same computer, therefore it is extremely important to point to the correct one:</font></font><br>
<br>
<pre><code class="go hljs">export KUBECONFIG=<span class="hljs-string">"$(k3d get-kubeconfig --name='k3s-default')"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensure that the cluster has at least one node. </font><font style="vertical-align: inherit;">Here you can see that I have Kubernetes 1.17 installed - a relatively new version:</font></font><br>
<br>
<pre><code class="go hljs">kubectl get node<font></font>
NAME                     STATUS   ROLES    AGE   VERSION<font></font>
k3d-k3s-<span class="hljs-keyword">default</span>-server   Ready    master   <span class="hljs-number">48</span>s   v1<span class="hljs-number">.17</span><span class="hljs-number">.0</span>+k3s<span class="hljs-number">.1</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will store our TODO records in the database table, so now we need to install it. </font><font style="vertical-align: inherit;">Postgresql is a popular relational database that we can install in a cluster using the Helm chart.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install arkade</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arkade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a CLI Go, similar to "brew" or "apt-get", but for Kubernetes applications. </font><font style="vertical-align: inherit;">It uses a Helm, kubectl, or CLI project to install a project or product into your cluster.</font></font><br>
<br>
<pre><code class="go hljs">curl -sLS https:<span class="hljs-comment">//dl.get-arkade.dev | sudo sh</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now install Postgresql</font></font><br>
<br>
<pre><code class="go hljs">arkade install postgresql<font></font>
===================================================================== = PostgreSQL has been installed.                                    =<font></font>
=====================================================================</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will also see information about the connection string and how to start the Postgresql CLI through the Docker image inside the cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can get this information at any time using </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will design the table layout</font></font><br>
<br>
<pre><code class="go hljs">CREATE TABLE todo (<font></font>
 id              INT GENERATED ALWAYS AS IDENTITY,<font></font>
 description     text NOT NULL,<font></font>
 created_date    timestamp NOT NULL,<font></font>
 completed_date  timestamp NOT NULL<font></font>
);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to get connection information again. </font><font style="vertical-align: inherit;">It should look something like this:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
kubectl run postgresql-client --rm --tty -i --restart=<span class="hljs-string">'Never'</span> --namespace <span class="hljs-keyword">default</span> --image docker.io/bitnami/postgresql:<span class="hljs-number">11.6</span><span class="hljs-number">.0</span>-debian<span class="hljs-number">-9</span>-r0 --env=<span class="hljs-string">"PGPASSWORD=$POSTGRES_PASSWORD"</span> --command -- psql --host postgresql -U postgres -d postgres -p <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you have at the command prompt:, </font></font><code>postgres = #</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can create the table by copying it inside, then run </font></font><code>\dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to show the table:</font></font><br>
<br>
<pre><code class="go hljs">postgres=# \dt<font></font>
List of relations<font></font>
Schema | Name | Type  |  Owner<font></font>
--------+------+-------+----------<font></font>
public | todo | table | postgres<font></font>
(<span class="hljs-number">1</span> row)</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install application framework</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just as PHP developers accelerated their workflow using LAMP (Linux Apache + Mysql + PHP) and Rails developers using a pre-prepared stack, Kubernetes developers can use application frameworks. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The PLONK stack stands for Prometheus, Linux, OpenFaaS, NATS, and Kubernetes.</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus provides metrics, auto-scaling, and observability to test the health of your system, allows it to respond to surges in demand and cut costs by providing metrics to make decisions about scaling to zero.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux, although not the only option for running workloads in Kubernetes, is standard and easiest to use.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initially, OpenFaaS provided portable functions to developers, but it works great when deploying APIs and microservices. </font><font style="vertical-align: inherit;">Its versatility means that any Docker containers with an HTTP server can be deployed and managed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NATS is a popular CNCF project used for messaging and pub / sub. </font><font style="vertical-align: inherit;">In the PLONK stack, it provides the ability to execute requests asynchronously and for queuing.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes is the reason we are here. </font><font style="vertical-align: inherit;">It provides a scalable, self-healing, and declarative infrastructure. </font><font style="vertical-align: inherit;">And if you no longer need part of all this grandeur, its API is simplified with OpenFaaS.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the PLONK stack via arkade:</font></font><br>
<br>
<pre><code class="go hljs">arkade install openfaas</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read the informational message and run each command:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install faas-cli.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get your password.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redirect the OpenFaaS gateway UI (through port 8080)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And log in to the system through the CLI.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As before, you can receive an informational message using </font></font><code> info openfaas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy Your First Go API</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several ways to create a Go API using PLONK. </font><font style="vertical-align: inherit;">The first option is to use the Dockerfile and manually determine the TCP port, health check, HTTP server, and so on. </font><font style="vertical-align: inherit;">This can be done using </font></font><code>faas-cli new --lang dockerfile API_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but there is a simpler and more automated way. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second way is to use the built-in templates offered by the Function Store:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store list | grep <span class="hljs-keyword">go</span>
<span class="hljs-keyword">go</span>                       openfaas           Classic Golang template<font></font>
golang-http              openfaas-incubator Golang HTTP template<font></font>
golang-middleware        openfaas-incubator Golang Middleware template</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we want to create a traditional HTTP-style API, the golang-middleware template would be most appropriate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the beginning of the tutorial, you registered with your Docker Hub account to store your Docker images. </font><font style="vertical-align: inherit;">Each Kubernetes workload must be embedded in a Docker image before it can be deployed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pull up the special pattern:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store pull golang-middleware</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use Scaffold for your API with golang-middleware and your username in the Docker Hub:</font></font><br>
<br>
<pre><code class="go hljs">export PREFIX=alexellis2<font></font>
export LANG=golang-middleware<font></font>
export API_NAME=todo<font></font>
faas-cli <span class="hljs-built_in">new</span> --lang $LANG --prefix $PREFIX $API_NAME</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will see two generated files:</font></font><br>
<br>
<ul>
<li><code>./todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - provides a way to configure, deploy, and install the template and name</font></font></li>
<li><code>./todo/handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - here you write the code and add any other files or packages that you require</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's do some editing and then expand the code.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> function
<span class="hljs-keyword">import</span> (
   <span class="hljs-string">"net/http"</span>
   <span class="hljs-string">"encoding/json"</span><font></font>
)<font></font>
<span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   Description <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {<font></font>
   todos := []Todo{}<font></font>
   todos = <span class="hljs-built_in">append</span>(todos, Todo{Description: <span class="hljs-string">"Run faas-cli up"</span>})<font></font>
   res, _ := json.Marshal(todos)<font></font>
   w.WriteHeader(http.StatusOK)<font></font>
   w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)<font></font>
   w.Write([]<span class="hljs-keyword">byte</span>(res))<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you do not use VScode and its plugins for editing and formatting the code, then run it after each change to make sure that the file is formatted correctly.</font></font><br>
<br>
<pre><code class="go hljs">gofmt -w -s ./todo/handler.<span class="hljs-keyword">go</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now deploy the code - first create a new image, launch it in the Docker Hub and deploy it to the cluster using the OpenFaaS API:</font></font><br>
<br>
<pre><code class="go hljs">Invoke your endpoint when ready:<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo</span><font></font>
{<font></font>
<span class="hljs-string">"description"</span>: <span class="hljs-string">"Run faas-cli up"</span>
}</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allow users to create new TODO records</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's allow users to create new entries in their TODO list. </font><font style="vertical-align: inherit;">First you need to add the link or ‚Äúdependency‚Äù for Go to the Postgresql library. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can get it using the vending or Go modules that were introduced in Go 1.11 and installed by default in Go 1.13. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and add the module that we need to access Postgresql:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">import</span> (
   <span class="hljs-string">"database/sql"</span>
   _ <span class="hljs-string">"github.com/lib/pq"</span>
...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for Go modules to detect dependencies, we need to declare something inside the file, which we will use later. </font><font style="vertical-align: inherit;">If we do not, then VSCode will delete these lines when saved. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add this under the imports in the file</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">var</span> db *sql.DB</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Always run these commands in the </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">folder where it is located </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and not at the root level c </font></font><code>todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialize the new Go module:</font></font><br>
<br>
<pre><code class="go hljs">cd todo/<font></font>
ls<font></font>
handler.<span class="hljs-keyword">go</span><font></font>
export GO111MODULE=on<font></font>
<span class="hljs-keyword">go</span> mod init</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now update the file using the pq library:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cat <span class="hljs-keyword">go</span>.mod<font></font>
module github.com/alexellis/todo1/todo<font></font>
<span class="hljs-keyword">go</span> <span class="hljs-number">1.13</span>
require github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Whatever is inside </font></font><code>go.mod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, copy its contents to</font></font><code>GO_REPLACE.txt</code><br>
<br>
<pre><code class="go hljs">cat <span class="hljs-keyword">go</span>.mod &gt; GO_REPLACE.txt</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's make sure that the assembly still works before adding the insert code.</font></font><br>
<br>
<pre><code class="go hljs">faas-cli build -f todo.yml --build-arg GO111MODULE=on</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may notice that now we pass </font></font><code>--build-arg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in to report a pattern for using Go modules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During assembly, you will see that the modules are downloaded as needed from the Internet.</font></font><br>
<br>
<pre><code class="go hljs">Step <span class="hljs-number">16</span>/<span class="hljs-number">29</span> : RUN <span class="hljs-keyword">go</span> test ./... -cover<font></font>
---&gt; Running in <span class="hljs-number">9</span>a4017438500
<span class="hljs-keyword">go</span>: downloading github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: extracting github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: finding github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span><font></font>
?       github.com/alexellis/todo1/todo [no test files]<font></font>
Removing intermediate container <span class="hljs-number">9</span>a4017438500</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Secrets for Postgresql Access</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can create a connection pool in </font></font><code>init ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a method that will only run once when the program starts.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// init       .   ,     ,   /   /</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
       <span class="hljs-keyword">if</span> _, err := os.Stat(<span class="hljs-string">"/var/openfaas/secrets/password"</span>); err == <span class="hljs-literal">nil</span> {<font></font>
               password, _ := sdk.ReadSecret(<span class="hljs-string">"password"</span>)<font></font>
               user, _ := sdk.ReadSecret(<span class="hljs-string">"username"</span>)<font></font>
               host, _ := sdk.ReadSecret(<span class="hljs-string">"host"</span>)<font></font>
               dbName := os.Getenv(<span class="hljs-string">"postgres_db"</span>)<font></font>
               port := os.Getenv(<span class="hljs-string">"postgres_port"</span>)<font></font>
               sslmode := os.Getenv(<span class="hljs-string">"postgres_sslmode"</span>)<font></font>
               connStr := <span class="hljs-string">"postgres://"</span> + user + <span class="hljs-string">":"</span> + password + <span class="hljs-string">"@"</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/"</span> + dbName + <span class="hljs-string">"?sslmode="</span> + sslmode
<span class="hljs-keyword">var</span> err error<font></font>
               db, err = sql.Open(<span class="hljs-string">"postgres"</span>, connStr)
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
               err = db.Ping()<font></font>
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you noticed, some information is extracted from what is </font></font><code> os.Getenv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read from the environment. </font><font style="vertical-align: inherit;">I would consider these values ‚Äã‚Äãnon-confidential, they are set in the file </font></font><code>todo.y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rest, such as the password and host, which are confidential, are kept in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes secrets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can create them through </font></font><code>faas-cli secret create</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or through </font></font><code>kubectl create secret generic -n openfaas-fn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The string </font></font><code>sdk.ReadSecret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comes from OpenFaaS Cloud SDK, with the following import: </font></font><code>github.com/openfaas/openfaas-cloud/sdk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It reads a secret file from disk and returns a value or error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get the secret values ‚Äã‚Äãfrom </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now for each password, do the following:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
export USERNAME=<span class="hljs-string">"postgres"</span><font></font>
export PASSWORD=$POSTGRES_PASSWORD<font></font>
export HOST=<span class="hljs-string">"postgresql.default"</span><font></font>
faas-cli secret create username --from-literal $USERNAME<font></font>
faas-cli secret create password --from-literal $PASSWORD<font></font>
faas-cli secret create host --from-literal $HOST</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the secrets for availability and compliance:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli secret ls<font></font>
NAME<font></font>
username<font></font>
password<font></font>
host<font></font>
# And via kubectl:<font></font>
kubectl get secret -n openfaas-fn<font></font>
NAME                  TYPE                                  DATA   AGE<font></font>
username              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
password              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
host                  Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">12</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit our YAML file and add the following:</font></font><br>
<br>
<pre><code class="go hljs">secrets:<font></font>
   - host<font></font>
   - password<font></font>
   - username<font></font>
   environment:<font></font>
     postgres_db: postgres<font></font>
     postgres_sslmode: <span class="hljs-string">"disable"</span>
     postgres_port: <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, update the Go modules and run the build again:</font></font><br>
<br>
<pre><code class="go hljs">cd todo
<span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cd ..<font></font>
faas-cli build -f todo.yml --build-arg GO111MODULE=on<font></font>
Successfully built d2c609f8f559<font></font>
Successfully tagged alexellis2/todo:latest<font></font>
Image: alexellis2/todo:latest built.<font></font>
[<span class="hljs-number">0</span>] &lt; Building todo done in <span class="hljs-number">22.50</span>s.<font></font>
[<span class="hljs-number">0</span>] Worker done.<font></font>
Total build time: <span class="hljs-number">22.50</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The assembly worked as expected, so let's run it </font></font><code>faas-cli</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the same arguments to start and deploy the image. </font><font style="vertical-align: inherit;">If the credentials and the SQL configuration are correct, we will not see errors in the logs, however, if they are incorrect, we will get the panic code in init (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the logs:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z Forking - ./handler []
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stderr from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stdout from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> OperationalMode: http
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Timeouts: read: <span class="hljs-number">10</span>s, write: <span class="hljs-number">10</span>s hard: <span class="hljs-number">10</span>s.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Listening on port: <span class="hljs-number">8080</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Metrics listening on port: <span class="hljs-number">8081</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Writing lock-file to: /tmp/.lock</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While everything looks good, now let's try calling the endpoint:</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">11</span>:<span class="hljs-number">02</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">02</span> POST / - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">35</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, now we have established a successful connection to the database, and we can perform insert. </font><font style="vertical-align: inherit;">How do we know that? </font><font style="vertical-align: inherit;">Because it </font></font><code>db.Ping ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns an error, otherwise it would have thrown a panic:</font></font><br>
<br>
<pre><code class="go hljs">err = db.Ping()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
   <span class="hljs-built_in">panic</span>(err.Error())<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Follow the link for more details on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">database / sql</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing the insert code</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code inserts a new row into the table </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and uses special syntax in which the value is not enclosed in quotation marks, but instead is replaced by the db.Query code. </font><font style="vertical-align: inherit;">In the "old days" of LAMP programming, a common mistake that led to many systems becoming unsafe was the lack of sanitation of input data and the concatenation of user input directly into the SQL statement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine someone entering a description; </font></font><code>drop table todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It would not be very fun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we run </font></font><code>db.Query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then pass the SQL statement using </font></font><code>$1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc. for each value, and then we can get the result and / or error. </font><font style="vertical-align: inherit;">We must also close this result, so use defer for this.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insert</span><span class="hljs-params">(description <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> {<font></font>
       res, err := db.Query(<span class="hljs-string">`insert into todo (id, description, created_date) values (DEFAULT, $1, now());`</span>,<font></font>
               description)<font></font>
       <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
               <span class="hljs-keyword">return</span> err<font></font>
       }<font></font>
       <span class="hljs-keyword">defer</span> res.Close()
       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's connect this to the code.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
       <span class="hljs-keyword">if</span> r.Method == http.MethodPost &amp;&amp; r.URL.Path == <span class="hljs-string">"/create"</span> {
               <span class="hljs-keyword">defer</span> r.Body.Close()<font></font>
               body, _ := ioutil.ReadAll(r.Body)<font></font>
               <span class="hljs-keyword">if</span> err := insert(<span class="hljs-keyword">string</span>(body)); err != <span class="hljs-literal">nil</span> {<font></font>
                       http.Error(w, fmt.Sprintf(<span class="hljs-string">"unable to insert todo: %s"</span>, err.Error()), http.StatusInternalServerError)<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's deploy it and run it.</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli build"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli push"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli deploy"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the API logs:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">35</span>:<span class="hljs-number">29</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">29</span> POST /create - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the contents of the table using pgsql:</font></font><br>
<br>
<pre><code class="sql hljs">export POSTGRES_PASSWORD=$(kubectl get secret <span class="hljs-comment">--namespace default postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)</span>
kubectl run postgresql-client <span class="hljs-comment">--rm --tty -i --restart='Never' --namespace default --image docker.io/bitnami/postgresql:11.6.0-debian-9-r0 --env="PGPASSWORD=$POSTGRES_PASSWORD" --command -- psql --host postgresql -U postgres -d postgres -p 5432</span>
postgres=<span class="hljs-comment"># select * from todo;</span><font></font>
id |   description   |        created_date        | completed_date<font></font>
<span class="hljs-comment">----+-----------------+----------------------------+----------------</span><font></font>
1 | faas-cli build  | 2020-03-26 14:36:03.367789 |<font></font>
2 | faas-cli push   | 2020-03-26 14:36:03.389656 |<font></font>
3 | faas-cli deploy | 2020-03-26 14:36:03.797881 |</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Congratulations, you now have a TODO API that can accept incoming requests through </font></font><code>curl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or any other HTTP client and write them to the database table.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Record Request</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a new function to query TODO records from a table:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
   var error err<font></font>
   var todos []Todo<font></font>
   return todos, err<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We cannot name this select method because it is a reserved keyword for working with goroutines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now connect the method to the main handler:</font></font><br>
<br>
<pre><code class="sql hljs">} else if r.Method == http.MethodGet &amp;&amp; r.URL.Path == "/list" {<font></font>
   todos, err := selectTodos()<font></font>
   if err != nil {<font></font>
       http.Error(w, fmt.Sprintf("unable to get todos: %s", err.Error()), http.StatusInternalServerError)<font></font>
   }<font></font>
   out, _ := json.Marshal(todos)<font></font>
   w.Header().Set("Content-Type", "application/json")<font></font>
   w.Write(out)<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that there are additional fields for dates in our data schema, update the Todo structure:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   ID <span class="hljs-keyword">int</span> <span class="hljs-string">`json:"id"`</span>
   Description   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span>
   CreatedDate   *time.Time <span class="hljs-string">`json:"created_date"`</span>
   CompletedDate *time.Time <span class="hljs-string">`json:"completed_date"`</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's add the </font></font><code>selectTodos()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">request code </font><font style="vertical-align: inherit;">to our method </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
       rows, getErr := db.Query(`<span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, description, created_date, completed_date <span class="hljs-keyword">from</span> todo;`)<font></font>
   if getErr != nil {<font></font>
       return []Todo{}, errors.Wrap(getErr, "unable to get from todo table")<font></font>
   }<font></font>
   todos := []Todo{}<font></font>
   defer rows.Close()<font></font>
   for rows.Next() {<font></font>
       result := Todo{}<font></font>
       scanErr := rows.Scan(&amp;result.ID, &amp;result.Description, &amp;result.CreatedDate, &amp;result.CompletedDate)<font></font>
       if scanErr != nil {<font></font>
           log.Println("scan err:", scanErr)<font></font>
       }<font></font>
       todos = append(todos, result)<font></font>
   }<font></font>
   return todos, nil<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As before, we need to delay closing the rows for the request. </font><font style="vertical-align: inherit;">Each value is inserted into the new structure using the rows.Scan method. </font><font style="vertical-align: inherit;">At the end of the method, we have a piece of Todo content. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try:</font></font><br>
<br>
<pre><code class="sql hljs">faas-cli up -f todo.yml <span class="hljs-comment">--build-arg GO111MODULE=on</span>
curl http://127.0.0.1:8080/function/todo/list</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the result:</font></font><br>
<br>
<pre><code class="sql hljs">[<font></font>
 {<font></font>
   "id": 2,<font></font>
   "description": "faas-cli build",<font></font>
   "created_date": "2020-03-26T14:36:03.367789Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 3,<font></font>
   "description": "faas-cli push",<font></font>
   "created_date": "2020-03-26T14:36:03.389656Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 4,<font></font>
   "description": "faas-cli deploy",<font></font>
   "created_date": "2020-03-26T14:36:03.797881Z",<font></font>
   "completed_date": null<font></font>
 }<font></font>
]</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To remove the values, we can update the structure annotations by adding </font></font><code>omitempty</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="go hljs">CompletedDate *time.Time <span class="hljs-string">`json:"completed_date,omitempty"`</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize the work done</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have not finished yet, but this is a good moment to stop and review what we have achieved so far. </font><font style="vertical-align: inherit;">We:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installed Go, Docker, kubectl and VSCode (IDE)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployed Kubernetes on our local computer</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installed Postgresql using arkade and helm3</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installed OpenFaaS and the PLONK stack for Kubernetes application developers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Created the initial static REST API using Go and </font></font><code>golang-middleware</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the OpenFaaS template</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added ‚Äúinsert‚Äù functionality to our TODO API </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added select functionality to our TODO API </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full code sample that we have created so far is available on my GitHub account: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexellis / kubernetes-todo-go-app</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Then we can do much more, for example:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding Authentication Using a Static Bearer Token</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a web page using a static HTML or React template to render a TODO list and create new elements.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding multi-user support to the API</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And much more. </font><font style="vertical-align: inherit;">We could also delve into the PLONK stack and deploy the Grafana dashboard to begin to monitor our API and understand how many resources are being used with the Kubernetes dashboard or metric server (installed using </font></font><code>arkade install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Learn more about arkade: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://get-arkade.dev</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Attend the OpenFaaS workshop to learn more about the above: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/openfaas/workshop/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
You can subscribe to my premium Insiders Updates newsletter at </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https: / /www.alexellis.io/</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
and on my twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alex Ellis</font></font></a><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498120/index.html">Build Time Optimization - Part 1</a></li>
<li><a href="../en498122/index.html">How to test on a remote site so as not to ruin the product and your life</a></li>
<li><a href="../en498124/index.html">Telegram for tech support: tools and pitfalls</a></li>
<li><a href="../en498126/index.html">How Amazon is trying to get people to buy ... less</a></li>
<li><a href="../en498128/index.html">Issue # 36: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../en498132/index.html">PostgreSQL recipes: auto-failover and auto-rejoin in docker swarm</a></li>
<li><a href="../en498134/index.html">How to reuse code with symfony 5 bundles? Part 1. Minimum bundle</a></li>
<li><a href="../en498136/index.html">Conversation with Polina Gurtova about the future and present of Frontend. DUMP 2020 organizers ask some important questions.</a></li>
<li><a href="../en498138/index.html">Life after undergraduate studies: how I decided what to do next when higher education and work already exist</a></li>
<li><a href="../en498140/index.html">Replicate this. Webinars Apache Ignite and GridGain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>