<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•ºğŸ¿ ğŸ‘ƒğŸ¼ ğŸ‘ Big Appetites for Little Buffers at Node.js ğŸ‘©ğŸ½â€ğŸ”§ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦ ğŸ¤°ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I already talked about the service for monitoring queries to PostgreSQL , for which we implemented an online server log collector, whose main task is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Big Appetites for Little Buffers at Node.js</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488678/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I already talked about the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service for monitoring queries to PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , for which we implemented an online server log collector, whose main task is to simultaneously receive log streams from a large number of hosts at once, quickly </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parse</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> them </font><b><font style="vertical-align: inherit;">into lines</font></b><font style="vertical-align: inherit;"> , group them in packets according to certain rules, process and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write result in PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> storage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/dn/xj/vkdnxj5l8luuvnk31xevce4auae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, we are talking about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">several hundred servers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and millions of requests and plans that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generate more than 100GB of logs per day</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Therefore, it was not at all surprising when we found that the lion's share of the resources is spent precisely on these two operations: parsing into lines and writing to the database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We plunged into the bowels of the profiler and found some features of working with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>Buffer</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js, the knowledge of which can greatly save your time and server resources.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU load</font></font></h2><br>
<img src="https://habrastorage.org/webt/od/uv/lm/oduvlmuc8wmu5obyljyygjnc8vw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the processor time was spent processing the incoming log stream, which is understandable. </font><font style="vertical-align: inherit;">But what was not clear was the resource-intensiveness of the primitive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œslicingâ€ of the incoming stream of binary blocks into lines</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by </font></font><code>\r\n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dk/v4/tb/dkv4tbigt2rwylskt8x_iqzcurc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
attentive developer will immediately notice here a not-so-efficient </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">byte cycle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> through the incoming buffer. </font><font style="vertical-align: inherit;">Well, since the line can be â€œtornâ€ between neighboring blocks, there is also a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">functional â€œtail attachmentâ€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> left over from the previous processed block.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trying readline</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quick review of the available solutions brought us to the regular </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readline module</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exactly with the necessary functionality for slicing into lines: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/he/px/0v/hepx0v5do7wgj9osz0cwyhuljvg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After it was implemented, â€œslicingâ€ from the top of the profiler went deeper: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/5x/et/jc5xetsqi24hpgggyg0yss6ggww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, as it turned out, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readline forces the string to UTF-8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> internally </font><font style="vertical-align: inherit;">, which is impossible do if the log entry (request, plan, error text) has a different source encoding. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indeed, even on one PostgreSQL server, several databases can be active simultaneously, each of which generates output to a common server log exactly </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in its original encoding</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As a result, owners of databases on win-1251 (sometimes itâ€™s convenient to use it to save disk space if an â€œhonestâ€ multibyte UNICODE is not needed) were able to observe their plans with approximately the same â€œRussianâ€ names of tables and indexes:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mb/6w/ri/mb6wriic6gmbvaz0koz8vddn_gm.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modifying the bike</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itâ€™s a trouble ... Itâ€™s still necessary to do the cutting yourself, but with optimizations of the type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>Buffer.indexOf()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead of â€œbyte-scanâ€: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ii/kf/h0/iikfh0v9mn2pyjd56eislxit69a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that everything is fine, the load in the test circuit did not increase, win1251-names were repaired, we rolled out to the battle ... Ta-dam! </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU usage periodically breaks through the ceiling at 100%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0r/k_/3u/0rk_3ujn57ml6uf2qs5xiuztnto.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How is it? .. It turns out that it is our fault </font></font><code>Buffer.concat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with which we â€œstick the tailâ€ left over from the previous block: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/nx/hw/j6nxhw_xyt8rhrz9z9dlfbaz7fo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we only have a gluing </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when we pass a line through the block</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but they should not to be many - really, really? .. Well, almost. Only now sometimes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œstringsâ€ of several hundred 16KB segments</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> come </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iq/rk/54/iqrk54dnsrr9xhfgvawz5pptc90.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to fellow developers who took care to generate this. </font><font style="vertical-align: inherit;">It happens "rarely, but accurately", so it was not possible to see in advance in the test circuit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is clear that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pasting several hundred times to the buffer by several megabytes of</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> small pieces is a direct path to the abyss of memory reallocations with the consumption of CPU resources, which we observed. </font><font style="vertical-align: inherit;">So, let's just not glue it until the line ends completely. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> just </font><b><font style="vertical-align: inherit;">put the â€œpiecesâ€ in an array</font></b><font style="vertical-align: inherit;"> until it is time to give the entire line â€œoutâ€: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5i/d8/ol/5id8olet5wr0mxddkn4u3ieuwu0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the load has returned to the readline indicators.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memory consumption</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people who wrote in languages â€‹â€‹with dynamic memory allocation are aware that one of the most unpleasant "performance killers" is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">background activity of the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Garbage Collector (GC), which scans objects created in memory and deletes those that are larger no one is required. </font><font style="vertical-align: inherit;">This trouble also overtook us - at some point we began to notice that the GC activity was somehow too much, and out of place. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hg/pp/ht/hgppht17ouvqyv9xdqv7wf4n5kq.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traditional â€œtwistsâ€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> didnâ€™t really help ... â€œIf all else fails, dump!â€ </font><font style="vertical-align: inherit;">And folk wisdom did not disappoint - we saw a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud of Buffer of 8360 bytes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a total size of 520MB ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s7/ct/km/s7ctkmzfmorz0qhbsaw1v3aorpw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And they were generated inside CopyBinaryStream - the situation began to clear up ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COPY ... FROM STDIN WITH BINARY</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To reduce the amount of traffic transmitted to the database, we use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">binary format COPY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In fact, for each record, you need to send a buffer to the stream, consisting of â€œpiecesâ€ - the number of fields in the record (2 bytes) and then the binary representation of the values â€‹â€‹of each column (4 bytes per type ID + data). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since such a row of the table almost always has a variable length â€œsummed upâ€, immediately allocating a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffer of a fixed length is not an option</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; reallocation if there is a lack of size will easily â€œeat upâ€ the performance; </font><font style="vertical-align: inherit;">So, itâ€™s also worthwhile to â€œglue from piecesâ€ using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>Buffer.concat()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, since we have many pieces repeated over and over (for example, the number of fields in the records of the same table) - let's just </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remember</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> them </font><b><font style="vertical-align: inherit;">, and then take ready-made ones</font></b><font style="vertical-align: inherit;"> , generated once at the first call. </font><font style="vertical-align: inherit;">Based on the COPY format, there are few options - typical pieces are 1, 2 or 4 bytes in length: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dx/32/c2/dx32c2pramljew4m2x2ztitewio.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And ... bam, a rake has arrived! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5e/vd/mx/5evdmx_4gln9ccxajf2weqv2z4w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, yes, every time you create a Buffer, a 8KB piece of memory is allocated by default, so that </font><font style="vertical-align: inherit;">small buffers </font><font style="vertical-align: inherit;">that are created </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a row</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be stacked â€œnext toâ€ in the already allocated memory. </font><font style="vertical-align: inherit;">And our allocation worked â€œon demandâ€, and it turned out to be not at all â€œnearâ€ - that's why each of our </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1-2-4 bytes buffer physically occupied 8KB + header</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - here they are, our 520MB!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smart memo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm ... Why do we even have to wait until this or that 1/2-byte buffer is needed? </font><font style="vertical-align: inherit;">With 4-byte is a separate issue, but some of these different options for a total of 256 + 65536. So let </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nagenerim their </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">row</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all at once</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">At the same time, we cut the condition for the existence of each check - it will also work faster, since initialization is carried out only at the start of the process. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fs/yq/ge/fsyqgetrrresipf9qmqpifnt-ku.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, in addition to 1/2-byte buffers, we immediately initialize the most running values â€‹â€‹(lower 2 bytes and -1) for 4-byte ones. </font><font style="vertical-align: inherit;">And - it helped, only 10MB instead of 520MB!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7l/7h/ot/7l7hotlahibczpu7nvmjsdxxo7a.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488666/index.html">10 React Components for All Occasions</a></li>
<li><a href="../en488668/index.html">CI / CD chaining and Docker automation</a></li>
<li><a href="../en488670/index.html">About mask registers</a></li>
<li><a href="../en488672/index.html">Debugging ARM Cortex-M microcontrollers by UART</a></li>
<li><a href="../en488674/index.html">Infographic with Excel and PowerPoint</a></li>
<li><a href="../en488682/index.html">How to test Python programming skills? Tasks from Yandex</a></li>
<li><a href="../en488686/index.html">Using Flowmon Networks to Monitor the Performance of Distributed Applications and Databases</a></li>
<li><a href="../en488690/index.html">Levenshtein least distance character recognition</a></li>
<li><a href="../en488692/index.html">How to migrate a large process from IBM BPM to Camunda and not stop feature development</a></li>
<li><a href="../en488696/index.html">Leading the trends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>