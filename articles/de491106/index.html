<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐒 😒 🏡 Warum benötigen Sie möglicherweise eine halbsynchrone Replikation? 🙏🏽 🖐️ 👩🏾‍🤝‍👨🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen. In Kontakt Vladislav Rodin. Ich unterrichte derzeit Kurse über Softwarearchitektur und Hochlast-Softwarearchitektur auf dem OTUS-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Warum benötigen Sie möglicherweise eine halbsynchrone Replikation?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/491106/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen. </font><font style="vertical-align: inherit;">In Kontakt Vladislav Rodin. </font><font style="vertical-align: inherit;">Ich unterrichte derzeit Kurse über Softwarearchitektur und Hochlast-Softwarearchitektur auf dem OTUS-Portal. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Vorgriff auf den Start eines neuen Streams des Kurses </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Architekt hoher Lasten“ habe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ich beschlossen, ein kleines Autorenmaterial zu schreiben, das ich mit Ihnen teilen möchte.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/pi/ad/dp/piaddproyjjd7sel38p94k6p_qe.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aufgrund der Tatsache, dass auf der Festplatte nur etwa 400 bis 700 Vorgänge pro Sekunde ausgeführt werden können (was mit typischen RPS auf einem stark ausgelasteten System nicht zu vergleichen ist), ist die klassische Festplattendatenbank ein enger Architekturbereich. </font><font style="vertical-align: inherit;">Daher sollte den Skalierungsmustern dieses Repositorys besondere Aufmerksamkeit gewidmet werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Moment gibt es zwei Muster der Basisskalierung: Replikation und Sharding. </font><font style="vertical-align: inherit;">Durch Sharding können Sie den Schreibvorgang skalieren und dadurch die RPS für die Aufzeichnung pro Server in Ihrem Cluster reduzieren. </font><font style="vertical-align: inherit;">Mit der Replikation können Sie dasselbe tun, jedoch mit Lesevorgängen. </font><font style="vertical-align: inherit;">Dieser Artikel ist genau diesem Muster gewidmet.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reproduzieren</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie sich die Replikation auf höchster Ebene ansehen, ist dies eine einfache Sache: Sie hatten einen Server, die Daten befanden sich darauf, und dann hat dieser Server die Last des Lesens dieser Daten nicht mehr bewältigt. </font><font style="vertical-align: inherit;">Sie fügen ein paar weitere Server hinzu, synchronisieren Daten auf allen Servern und der Benutzer kann von jedem Server in Ihrem Cluster lesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der offensichtlichen Einfachheit gibt es verschiedene Klassifizierungsoptionen für verschiedene Implementierungen dieses Schemas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach Rollen im Cluster (Master-Master oder Master-Slave)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durch weitergeleitete Objekte (zeilenbasiert, anweisungsbasiert oder gemischt)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entsprechend dem Knotensynchronisationsmechanismus</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute werden wir uns mit dem 3. Punkt befassen. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie wird die Transaktion festgeschrieben?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Thema steht nicht in direktem Zusammenhang mit der Replikation. Es kann jedoch ein separater Artikel darüber geschrieben werden. Da jedoch ohne weiteres Verständnis des Transaktions-Commit-Mechanismus eine weitere Lektüre nutzlos ist, möchte ich Sie an die grundlegendsten Dinge erinnern. </font><font style="vertical-align: inherit;">Eine Transaktion wird in 3 Schritten festgeschrieben:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben einer Transaktion in das Datenbankprotokoll.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung einer Transaktion in einem Datenbankmodul.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden Sie dem Kunden eine Bestätigung über die erfolgreiche Anwendung der Transaktion zurück.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Algorithmus können in verschiedenen Datenbanken Nuancen auftreten: In der InnoDB-Engine der MySQL-Datenbank gibt es beispielsweise zwei Protokolle: eines für die Replikation (binäres Protokoll) und das andere für die Verwaltung von ACID (Undo / Redo-Protokoll), während in PostgreSQL ein Protokoll ausgeführt wird beide Funktionen (Write Ahead Log = WAL). </font><font style="vertical-align: inherit;">Aber oben ist es genau das allgemeine Konzept, das es erlaubt, solche Nuancen zu ignorieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchrone (Synchronisierungs-) Replikation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen wir die Logik zum Replizieren der empfangenen Änderungen zum Transaktions-Commit-Algorithmus hinzu:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben einer Transaktion in das Datenbankprotokoll.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung einer Transaktion in einem Datenbankmodul.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden von Daten an alle Replikate.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhalten Sie von allen Replikaten eine Bestätigung über die Transaktion auf ihnen.</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden Sie dem Kunden eine Bestätigung über die erfolgreiche Anwendung der Transaktion zurück.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Ansatz haben wir eine Reihe von Nachteilen: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Client wartet darauf, dass Änderungen auf alle Replikate angewendet werden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die Anzahl der Knoten im Cluster zunimmt, verringern wir die Wahrscheinlichkeit, dass der Schreibvorgang erfolgreich ist.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn mit dem 1. Absatz alles mehr oder weniger klar ist, sollten die Gründe für den 2. Absatz geklärt werden. </font><font style="vertical-align: inherit;">Wenn wir während der synchronen Replikation keine Antwort von mindestens einem Knoten erhalten, wird die Transaktion zurückgesetzt. </font><font style="vertical-align: inherit;">Wenn Sie also die Anzahl der Knoten im Cluster erhöhen, erhöhen Sie die Wahrscheinlichkeit, dass der Schreibvorgang fehlschlägt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Können wir nur von einem bestimmten Bruchteil der Knoten auf eine Bestätigung warten, beispielsweise von 51% (Quorum)? </font><font style="vertical-align: inherit;">Ja, das können wir, aber in der klassischen Version ist eine Bestätigung von allen Knoten erforderlich, da wir auf diese Weise die vollständige Konsistenz der Daten im Cluster sicherstellen können, was zweifellos ein Vorteil dieser Art der Replikation ist.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchrone Replikation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns den vorherigen Algorithmus ändern. </font><font style="vertical-align: inherit;">Wir werden Daten "irgendwann später" an die Replikate senden, und "irgendwann später" werden die Änderungen auf die Replikate angewendet:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben einer Transaktion in das Datenbankprotokoll.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung einer Transaktion in einem Datenbankmodul.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden Sie dem Kunden eine Bestätigung über die erfolgreiche Anwendung der Transaktion zurück.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden von Daten an Replikate und Anwenden von Änderungen auf diese.</font></font></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Ansatz führt dazu, dass der Cluster schnell ist, da der Client nicht darauf wartet, dass die Daten die Replikate erreichen und sogar kommuniziert werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Bedingung, Daten "irgendwann später" in Replikate zu löschen, kann jedoch zum Verlust der Transaktion und zum Verlust der dem Benutzer bestätigten Transaktion führen. Wenn die Daten keine Zeit zum Replizieren hatten, wurde dem Client eine Bestätigung über den Erfolg des Vorgangs gesendet, und der Knoten, an dem die Änderungen eingegangen sind, flog HDD, wir verlieren die Transaktion, was zu sehr unangenehmen Konsequenzen führen kann.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semisync-Replikation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schließlich kamen wir zur halbsynchronen Replikation. </font><font style="vertical-align: inherit;">Diese Art der Replikation ist nicht sehr bekannt und nicht sehr verbreitet, aber von erheblichem Interesse, da sie die Vorteile sowohl der synchronen als auch der asynchronen Replikation kombinieren kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir, die beiden vorherigen Ansätze zu kombinieren. </font><font style="vertical-align: inherit;">Wir werden den Client nicht lange behalten, aber wir verlangen, dass die Daten repliziert werden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben einer Transaktion in das Datenbankprotokoll.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung einer Transaktion in einem Datenbankmodul.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden von Daten an Replikate.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhalten einer Bestätigung vom Replikat über den Empfang von Änderungen (diese werden "einige Zeit später" angewendet).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden Sie dem Kunden eine Bestätigung über die erfolgreiche Anwendung der Transaktion zurück.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie, dass bei diesem Algorithmus ein Transaktionsverlust nur auftritt, wenn der Knoten die Änderungen und die Replikatknoten akzeptiert. </font><font style="vertical-align: inherit;">Die Wahrscheinlichkeit einer solchen Fehlfunktion wird als gering angesehen, und diese Risiken werden akzeptiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Ansatz ist jedoch das Risiko von Phantomablesungen möglich. </font><font style="vertical-align: inherit;">Stellen Sie sich das folgende Szenario vor: In Schritt 4 haben wir keine Bestätigung von einem Replikat erhalten. </font><font style="vertical-align: inherit;">Wir müssen diese Transaktion zurücksetzen und die Bestätigung nicht an den Kunden zurücksenden. </font><font style="vertical-align: inherit;">Da die Daten in Schritt 2 angewendet wurden, besteht zwischen dem Ende von Schritt 2 und dem Transaktions-Rollback eine Zeitlücke, in der parallele Transaktionen die Änderungen sehen können, die nicht in der Datenbank enthalten sein sollten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verlustfreie semisynchrone Replikation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie ein wenig nachdenken, können Sie die Schritte des Algorithmus nur an einigen Stellen ändern, um das Problem der Phantomablesungen in diesem Szenario zu beheben:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben einer Transaktion in das Datenbankprotokoll.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden von Replikatdaten.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhalten einer Bestätigung vom Replikat über den Empfang von Änderungen (diese werden "einige Zeit später" angewendet).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung einer Transaktion in einem Datenbankmodul.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Senden Sie dem Kunden eine Bestätigung über die erfolgreiche Anwendung der Transaktion zurück.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt übernehmen wir Änderungen nur, wenn sie repliziert werden. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie immer gibt es keine perfekten Lösungen, es gibt eine Reihe von Lösungen, von denen jede ihre eigenen Vor- und Nachteile hat und zur Lösung verschiedener Problemklassen geeignet ist. </font><font style="vertical-align: inherit;">Dies gilt auch für die Auswahl eines Mechanismus zum Synchronisieren der Daten einer replizierten Datenbank. </font><font style="vertical-align: inherit;">Die Vorteile der halbsynchronen Replikation sind solide und interessant genug, um trotz ihrer geringen Verbreitung als beachtlich angesehen zu werden. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das ist alles. </font><font style="vertical-align: inherit;">Wir sehen uns auf dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de491092/index.html">Wie Crash Bandicoot Playstation gehackt hat</a></li>
<li><a href="../de491094/index.html">Installation von Firebird 3 unter modernen Linux-Versionen: CentOS8 und Ubuntu 19</a></li>
<li><a href="../de491100/index.html">Auf Wanhao 5S druckten sie eine Puppe mit der Größe einer Person</a></li>
<li><a href="../de491102/index.html">Wie man einen Service entwickelt, wenn es harte Konkurrenten gibt</a></li>
<li><a href="../de491104/index.html">Wie ich einen Hardwarefehler auf meinem Lenovo MiiX 2 10 Tablet gefunden habe</a></li>
<li><a href="../de491108/index.html">Organisieren von Bereitstellungen in vielen k8s-Umgebungen mithilfe der Helmdatei</a></li>
<li><a href="../de491110/index.html">Konvertieren Sie RTF in XML in C #</a></li>
<li><a href="../de491112/index.html">Der Weg zur Unschuld im Netzwerk - Cisco DNA</a></li>
<li><a href="../de491114/index.html">Kluger Umzug oder wie man ein Unternehmen für die Arbeit auswählt und es nicht bereut</a></li>
<li><a href="../de491116/index.html">Moderne Identifikationsstandards: OAuth 2.0, OpenID Connect, WebAuthn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>