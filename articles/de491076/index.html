<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ú°Ô∏è üßóüèº üôà Clevere Arbeit mit RabbitMQ in NestJS üÖøÔ∏è üêæ üë©üèø‚Äçü§ù‚Äçüë©üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der Entwicklung von Finanzsystemen sind Standardmechanismen f√ºr die Verarbeitung abgeschlossener Aufgaben in den meisten Implementierungen des AMQ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Clevere Arbeit mit RabbitMQ in NestJS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491076/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei der Entwicklung von Finanzsystemen sind Standardmechanismen f√ºr die Verarbeitung abgeschlossener Aufgaben in den meisten Implementierungen des AMQP-Protokolls nicht immer geeignet. </font><font style="vertical-align: inherit;">Irgendwann stie√üen wir auf ein solches Problem, aber das Wichtigste zuerst.</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Standardimplementierung von RabbitMQ in NestJS erleichtert das Empfangen von Nachrichten in dekorierten Funktionen:</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-built_in">console</span>.log(context.getMessage());<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weitere Details dazu finden Sie hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auch die Arbeit mit Warteschlangen in Nest wurde in diesem Artikel √ºber Habr√© ausf√ºhrlich behandelt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass etwas anderes ben√∂tigt werden k√∂nnte. </font><font style="vertical-align: inherit;">Die derzeitige Implementierung weist jedoch eine Reihe von Nachteilen auf.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das Best√§tigungsergebnis an einen Kanal zu senden, m√ºssen Sie den Kanal manuell aus dem RmqContext-Kontext ziehen und ein Signal an ihn senden.</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-keyword">const</span> channel = context.getChannelRef();
  <span class="hljs-keyword">const</span> originalMsg = context.getMessage();<font></font>
  channel.ack(originalMsg);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entscheidung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie dasselbe Muster, das bei der Arbeit mit http-Handlern verwendet wurde, indem Sie das Ergebnis der Ausf√ºhrung direkt von der Funktion als regul√§res Objekt, Promise oder Observable zur√ºckgeben.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie das Ergebnis in einer separaten Warteschlange senden m√ºssen, m√ºssen Sie in jedem Controller, der Rabbit verwendet, dessen Namen kennen. </font><font style="vertical-align: inherit;">Mit anderen Worten, es ist nicht m√∂glich, dies w√§hrend der Modulinitialisierung an einer Stelle zu konfigurieren und implizit zu verwenden.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entscheidung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geben Sie in der Modulkonfigurationsphase die Warteschlangen f√ºr erfolgreiche Vorg√§nge und f√ºr Fehler an. </font><font style="vertical-align: inherit;">Wir haben beschlossen, die Ergebnisse erfolgreicher Vorg√§nge in eine Warteschlange und die Ergebnisse fehlerhafter Vorg√§nge in eine andere zu senden. </font><font style="vertical-align: inherit;">Unter Verwendung der L√∂sung f√ºr Problem 1 wird das Ergebnis an die erfolgreiche Operationswarteschlange gesendet, wenn der R√ºckgabewert Promise oder Observable erfolgreich ist. Wenn dies nicht der Fall ist, wird die Nachricht abgelehnt und f√§llt in die Fehlerwarteschlange. RabbitMQ macht dies mit den Optionen x-dead einfach -letter-Austausch und x-Dead-Letter-Routing-Schl√ºssel beim Erstellen der Warteschlange.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Bibliotheksbenutzer muss der Entwickler die Details des AMQP-Protokolls kennen, um die ID der n√§chsten Nachricht zu erhalten, zu verstehen, was ack ist und wann er sie aufrufen muss usw.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entscheidung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºgen Sie einen Dekorateur hinzu, um die ID der Nachricht zu erhalten. </font><font style="vertical-align: inherit;">Geben Sie anstelle von ack das Ergebnis der Ausf√ºhrung von der Handlerfunktion zur√ºck.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 4</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht das wichtigste Problem: eine Nachricht mehr als einmal an den Handler senden. Wenn es um Finanztransaktionen geht, ist dies ein sehr wichtiger Punkt, da eine Situation auftreten kann, wenn das Geld bereits gesendet wurde und der Vorgang im letzten Schritt fehlgeschlagen ist - beim Schreiben in die Datenbank oder beim Senden einer Best√§tigungsnachricht an den Broker. Eine der offensichtlichen L√∂sungen besteht darin, die vom Produzenten generierte Nachrichten-ID in die Datenbank zu schreiben, wenn die Nachricht vom Verbraucher empfangen wird, bevor die Nachricht verarbeitet wird. Wenn sie nicht bereits vorhanden ist, falls vorhanden, lehnen Sie die Nachricht ab. Das AMQP-Protokoll bietet jedoch ein erneut zugestelltes Flag, das angibt, ob diese Nachricht jemals an andere Clients √ºbermittelt wurde. Mit diesem Flag k√∂nnen wir erneut √ºbermittelte Nachrichten erkennen und sie mit Fehlern an die Warteschlange senden.In der aktuellen Implementierung in Nest gibt es keine M√∂glichkeit, solche Nachrichten nicht zuzustellen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entscheidung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liefern Sie diese Nachricht nicht an den Handler, sondern protokollieren Sie den Fehler beim Empfang der Nachricht vom Treiber. </font><font style="vertical-align: inherit;">Nat√ºrlich kann dieses Verhalten in der Phase des Dekorierens der Methode so konfiguriert werden, dass explizit angegeben wird, dass f√ºr diese Art von Aktion weiterhin Nachrichten empfangen werden sollen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um alle oben genannten Probleme zu l√∂sen, wurde eine eigene Implementierung des Protokolls geschrieben. </font><font style="vertical-align: inherit;">Wie die Initialisierung aussieht:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> amqp = <span class="hljs-keyword">await</span> NestFactory.create(<font></font>
 RabbitModule.forRoot({<font></font>
   <span class="hljs-attr">host</span>: process.env.AMQP_QUEUE_HOST,
   <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PORT, <span class="hljs-number">10</span>),
   <span class="hljs-attr">login</span>: process.env.AMQP_QUEUE_LOGIN,
   <span class="hljs-attr">password</span>: process.env.AMQP_QUEUE_PASSWORD,
   <span class="hljs-attr">tasksQueueNormal</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST,
   <span class="hljs-attr">tasksQueueRedelivery</span>: process.env.AMQP_QUEUE_REQUEST_ONCE_DELIVERY,
   <span class="hljs-attr">deadLetterRoutingKey</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_DEAD_LETTER,
   <span class="hljs-attr">deadLetterRoutingKeyRedelivery</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_ONCE_DELEVERY_DEAD_LETTER,
   <span class="hljs-attr">exchange</span>: process.env.AMQP_EXCHANGE_COMMAND,
   <span class="hljs-attr">prefetch</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PREFETCH, <span class="hljs-number">10</span>),<font></font>
 }),<font></font>
);<font></font>
<span class="hljs-keyword">const</span> transport = amqp.get&lt;RabbitTransport&gt;(RabbitTransport);<font></font>
app.connectMicroservice({<font></font>
 <span class="hljs-attr">strategy</span>: transport,
 <span class="hljs-attr">options</span>: {},<font></font>
});<font></font>
<font></font>
app.startAllMicroservices();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier geben wir die Namen der Warteschlangen f√ºr die Zustellung von Nachrichten, Ergebnissen und Fehlern sowie einzelne Warteschlangen an, die nicht f√ºr eine erneute Zustellung empfindlich sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf Controller-Ebene ist die Arbeit genauso √§hnlich wie die Arbeit mit http</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHay(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heyService.greet(requestId, q);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis der Aufgabe wird in die Ergebniswarteschlange gestellt, sobald diese Observable ausgef√ºhrt wird. </font><font style="vertical-align: inherit;">Der mit @AMQPRequest dekorierte Parameter entspricht dem Korrelations-ID-Feld des Protokolls. </font><font style="vertical-align: inherit;">Dies ist eine eindeutige Kennung f√ºr die zugestellte Nachricht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Parameter @AMQPParam entspricht dem Nachrichtentext selbst. </font><font style="vertical-align: inherit;">Wenn es sich um JSON handelt, kommt die Nachricht in der Funktion an, die bereits in das Objekt konvertiert wurde. </font><font style="vertical-align: inherit;">Wenn es sich um einen einfachen Typ handelt, wird die Nachricht unver√§ndert gesendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgende Nachricht wird im toten Brief stehen:</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHayErr(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> throwError(‚ÄòBuy‚Äô);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie geht's</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºgen Sie AMQPParam Type Reflection hinzu, damit der Nachrichtentext in die √ºbergebene Klasse konvertiert wird. </font><font style="vertical-align: inherit;">Jetzt ist es nur noch eine Kaste zum Tippen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Code- und Installationsanweisungen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sind auf GitHub verf√ºgbar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ñnderungen und Kommentare sind willkommen.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de491052/index.html">Wie und warum Kuratoren an der HSE in St. Petersburg Neulingen Programmierern helfen</a></li>
<li><a href="../de491054/index.html">So signieren Sie E-Mail-Korrespondenz mit einem GPG-Schl√ºssel mithilfe von PKCS # 11-Token</a></li>
<li><a href="../de491056/index.html">Ampere Altra - der weltweit erste 80-Kern-ARM-Prozessor</a></li>
<li><a href="../de491058/index.html">Mortalit√§t, Mortalit√§t, Coronavirus und Matan</a></li>
<li><a href="../de491062/index.html">Winkel: Erstellen eines benutzerdefinierten Formularelements und √úbergeben des Formularstatus an dieses</a></li>
<li><a href="../de491084/index.html">saneex.c: try / catch / finally basierend auf setjmp / longjmp (C99) schneller als Standard-C ++ - Ausnahmen ¬π</a></li>
<li><a href="../de491086/index.html">Webix JavaScript-Bibliothek mit den Augen eines Anf√§ngers. Teil 6. Serverinteraktion</a></li>
<li><a href="../de491088/index.html">GitHub: Neue Open Source Library f√ºr OSINT</a></li>
<li><a href="../de491090/index.html">Konvertieren Sie Textdokumente in C # in XML</a></li>
<li><a href="../de491092/index.html">Wie Crash Bandicoot Playstation gehackt hat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>