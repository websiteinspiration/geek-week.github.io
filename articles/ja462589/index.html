<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‚ ğŸ‘¨ ğŸŒ€ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ2 ğŸ’® ğŸ§–ğŸ¿ ğŸ—¨ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚ç‰¹ã«ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚³ãƒ¼ã‚¹ã®å­¦ç”Ÿå‘ã‘ã«æº–å‚™ã•ã‚ŒãŸã€è¨˜äº‹ã®æœ€å¾Œã®éƒ¨åˆ†ã®ç¿»è¨³ã‚’å…±æœ‰ã—ã¾ã™ã€‚æœ€åˆã®éƒ¨åˆ†ã¯ã“ã“ã«ã‚ã‚Šã¾ã™ã€‚
 
 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç”¨ã®Apache Beamã¨DataFlow
 
 
 
 Google Cloudã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 æ³¨ï¼šPython 3ã§ãƒ‘ã‚¤ãƒ—ãƒ©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç”¨ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/462589/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚</font><font style="vertical-align: inherit;">ç‰¹ã«</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ã‚¹ã®å­¦ç”Ÿå‘ã‘ã«æº–å‚™ã•ã‚ŒãŸã€è¨˜äº‹ã®æœ€å¾Œã®éƒ¨åˆ†ã®ç¿»è¨³ã‚’å…±æœ‰ã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æœ€åˆã®éƒ¨åˆ†ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã“ã«ã‚ã‚Šã¾ã™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç”¨ã®Apache Beamã¨DataFlow</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/9t/uy/au/9tuyauggjylmprwx7lxswwbqggi.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Cloudã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨ï¼šPython 3ã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«å•é¡ŒãŒç™ºç”Ÿã—ãŸãŸã‚ã€Google Cloud Shellã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’é–‹å§‹ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å…¬é–‹ã—ã¾ã—ãŸã€‚GoogleCloud Shellã¯ã€Apache Beamã¨ã®äº’æ›æ€§ã®é«˜ã„Python 2ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚³ãƒ³ãƒ™ã‚¢ã‚’èµ·å‹•ã™ã‚‹ã«ã¯ã€è¨­å®šã«ã¤ã„ã¦å°‘ã—æ˜ã‚Šä¸‹ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¾ã§ã«GCPã‚’ä½¿ç”¨ã—ãŸã“ã¨ãŒãªã„å ´åˆã¯ã€ã“ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒšãƒ¼ã‚¸ã§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¬¡ã®6ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚Š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã¾ã™</font></a><font style="vertical-align: inherit;">ã€‚</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’Google Cloud Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Google Cloud Shelã«ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯éå¸¸ã«ç°¡å˜ã§ã™ï¼ˆèª¬æ˜ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã“ã«ã‚ã‚Šã¾ã™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã«ã¯ã€ä¸‹ã®å›³2ã®å·¦å´ã«ã‚ã‚‹æœ€åˆã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰Google Cloud Shelã‚’é–‹ãã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/su/hz/hq/suhzhqrmyvi6c5hneokqhhhqjuw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›³2</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Copy file from cloud storage</span><font></font>
gsutil cp gs://&lt;YOUR-BUCKET&gt;/ * .<font></font>
sudo pip install apache-beam[gcp] oauth2client==<span class="hljs-number">3.0</span><span class="hljs-number">.0</span><font></font>
sudo pip install -U pip<font></font>
sudo pip install Faker==<span class="hljs-number">1.0</span><span class="hljs-number">.2</span>
<span class="hljs-comment"># Environment variables</span><font></font>
BUCKET=&lt;YOUR-BUCKET&gt;<font></font>
PROJECT=&lt;YOUR-PROJECT&gt;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã™ã¹ã¦ã®æ§‹æˆæ‰‹é †ãŒå®Œäº†ã—ãŸã‚‰ã€æ¬¡ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯ã€BigQueryã§ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€æœ€åˆã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¦Google Cloud Consoleã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªãƒ³ã‚¯ã®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰‹é †ã«å¾“ã£ã¦ã€</font><font style="vertical-align: inherit;">ã‚¹ã‚­ãƒ¼ãƒã‚’å«ã‚€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®è¡¨ã«ã¯</font><font style="vertical-align: inherit;">ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7ã¤ã®åˆ—</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŒã‚ã‚Š</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä¾¿å®œä¸Šã€timelocalå¤‰æ•°ã‚’é™¤ãã™ã¹ã¦ã®åˆ—ã‚’æ–‡å­—åˆ—ï¼ˆæ–‡å­—åˆ—å‹ï¼‰ã¨ã—ã¦å®šç¾©ã—ã€å‰ã«ç”Ÿæˆã—ãŸå¤‰æ•°ã«å¾“ã£ã¦åå‰ã‚’ä»˜ã‘ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯å›³3ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zw/ts/pz/zwtspziwiubrmz0c860bmvoe3so.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›³3.ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å…¬é–‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç›¸äº’ã«ã‚„ã‚Šå–ã‚Šã§ãã‚‹ãŸã‚ã€Pub / Subã¯ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®é‡è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ç‰¹ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€å—ä¿¡ã™ã‚‹ãŸã‚ã®ä»²ä»‹è€…ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚ã¾ãšã€ãƒˆãƒ”ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®Pub / Subã«ç§»å‹•ã—ã€CREATE TOPICã‚’æŠ¼ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã—ã¦ä¸Šè¨˜ã§å®šç¾©ã•ã‚ŒãŸãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã€æ¥ç¶šã—ã¦ãƒ­ã‚°ã‚’Pub / Subã«é€ä¿¡ã—ã¾ã™ã€‚ç§ãŸã¡ãŒè¡Œã†å¿…è¦ãŒã‚ã‚‹å”¯ä¸€ã®ã‚‚ã®ã¯ä½œæˆã•ã‚Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PublisherClientã®</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’</font><font style="vertical-align: inherit;">ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ”ãƒƒã‚¯ã¸ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã€</font></font><code> topic_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã—ã¦é–¢æ•°ã‚’å‘¼ã³å‡ºã™</font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><code>topic_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ãƒ‡ãƒ¼ã‚¿ã€‚</font></font><code>generate_log_line</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰</font><font style="vertical-align: inherit;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</font><font style="vertical-align: inherit;">ã™ã‚‹</font><font style="vertical-align: inherit;">ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„</font></font><code>stream_logs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãã†ã—ãªã„ã¨ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã«ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦Googleã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã“ã‚Œã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">python publish.py</code></pre><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> stream_logs <span class="hljs-keyword">import</span> generate_log_line
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> pubsub_v1
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<font></font>
PROJECT_ID=<span class="hljs-string">"user-logs-237110"</span>
TOPIC = <span class="hljs-string">"userlogs"</span><font></font>
<font></font>
<font></font>
publisher = pubsub_v1.PublisherClient()<font></font>
topic_path = publisher.topic_path(PROJECT_ID, TOPIC)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish</span>(<span class="hljs-params">publisher, topic, message</span>):</span>
    data = message.encode(<span class="hljs-string">'utf-8'</span>)
    <span class="hljs-keyword">return</span> publisher.publish(topic_path, data = data)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">callback</span>(<span class="hljs-params">message_future</span>):</span>
    <span class="hljs-comment"># When timeout is unspecified, the exception method waits indefinitely.</span>
    <span class="hljs-keyword">if</span> message_future.exception(timeout=<span class="hljs-number">30</span>):<font></font>
        print(<span class="hljs-string">'Publishing message on {} threw an Exception {}.'</span>.format(<font></font>
            topic_name, message_future.exception()))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        print(message_future.result())<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
<font></font>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        line = generate_log_line()<font></font>
        print(line)<font></font>
        message_future = publish(publisher, topic_path, line)<font></font>
        message_future.add_done_callback(callback)<font></font>
<font></font>
        sleep_time = random.choice(range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>))<font></font>
        time.sleep(sleep_time)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®å›³ã«ç¤ºã™ã‚ˆã†ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹å§‹ã™ã‚‹ã¨ã™ãã«ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã‚’ç¢ºèªã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL + C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨</font><font style="vertical-align: inherit;">ã—ã¦å®Œäº†ã™ã‚‹ã¾ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/4c/6n/ho4c6n5yfnnv8pvetgkidvut-q0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›³4.çµè«–</font></font><code>publish_logs.py</code><br>
</i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€æœ€ã‚‚èˆˆå‘³æ·±ã„éƒ¨åˆ†ã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚Beamã¨Pythonã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">Beamãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆpï¼‰ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãŸã‚‰ã€æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ã¦ã„ãã¤ã‹ã®é–¢æ•°ã‚’æ¬¡ã€…ã¨é©ç”¨ã§ãã¾ã™</font></font><code>pipe (|)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¸€èˆ¬ã«ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">[Final Output PCollection] = ([Initial Input PCollection] | [First Transform]<font></font>
             | [Second Transform]<font></font>
             | [Third Transform])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€2ã¤ã®ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚é–¢æ•°</font></font><code>regex_clean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€PATTERNSãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦å¯¾å¿œã™ã‚‹è¡Œã‚’å–å¾—ã™ã‚‹é–¢æ•°</font></font><code>re.search</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚é–¢æ•°ã¯ã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ã€‚æ­£è¦è¡¨ç¾ã®å°‚é–€å®¶ã§ãªã„å ´åˆã¯ã€ã“ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’èª­ã¿</font><font style="vertical-align: inherit;">ã€ãƒ¡ãƒ¢å¸³ã§ç·´ç¿’ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹</font><font style="vertical-align: inherit;">ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚ãã®å¾Œã€</font><b><font style="vertical-align: inherit;">Split</font></b><font style="vertical-align: inherit;">ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ ParDoé–¢æ•°ã‚’å®šç¾©ã—ã¾ã™</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€ä¸¦åˆ—å‡¦ç†ç”¨ã®ãƒ“ãƒ¼ãƒ å¤‰æ›ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ Pythonã§ã¯ã€ã“ã‚Œã¯ç‰¹åˆ¥ãªæ–¹æ³•ã§è¡Œã‚ã‚Œã¾ã™-DoFn Beamã‚¯ãƒ©ã‚¹ã‹ã‚‰ç¶™æ‰¿ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ Splité–¢æ•°ã¯ã€å‰ã®é–¢æ•°ã‹ã‚‰è§£æã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€BigQueryãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—åã«å¯¾å¿œã™ã‚‹ã‚­ãƒ¼ã‚’æŒã¤è¾æ›¸ã®ãƒªã‚¹ãƒˆã‚’è¿”ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã«ã¤ã„ã¦ã¯æ³¨æ„ã™ã‚‹ç‚¹ãŒã‚ã‚Š</font></font><code>datetime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ã™ã€‚é–¢æ•°ã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€é–¢æ•°å†…</font><font style="vertical-align: inherit;">ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</font><font style="vertical-align: inherit;">ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€åˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚æ¬¡ã«ã€ã“ã®ãƒªã‚¹ãƒˆã¯</font><b><font style="vertical-align: inherit;">WriteToBigQuery</font></b><font style="vertical-align: inherit;">é–¢æ•°ã«æ¸¡ã•ã‚Œã¾ã™</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãƒãƒƒãƒDataFlowã‚¸ãƒ§ãƒ–ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°DataFlowã‚¸ãƒ§ãƒ–ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒãƒƒãƒã‚³ãƒ¼ãƒ‰ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã®å”¯ä¸€ã®é•ã„ã¯ã€ãƒãƒƒãƒå‡¦ç†ã§</font><font style="vertical-align: inherit;">Beamã®</font></font><code>src_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦</font><font style="vertical-align: inherit;">CSVã‚’èª­ã¿å–ã‚‹ã“ã¨</font></font><code>ReadFromText</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒƒãƒDataFlowã‚¸ãƒ§ãƒ–ï¼ˆãƒ‘ã‚±ãƒƒãƒˆå‡¦ç†ï¼‰</font></font></h2><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> apache_beam <span class="hljs-keyword">as</span> beam
<span class="hljs-keyword">from</span> apache_beam.options.pipeline_options <span class="hljs-keyword">import</span> PipelineOptions
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> bigquery
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> sys<font></font>
<font></font>
PROJECT=<span class="hljs-string">'user-logs-237110'</span>
schema = <span class="hljs-string">'remote_addr:STRING, timelocal:STRING, request_type:STRING, status:STRING, body_bytes_sent:STRING, http_referer:STRING, http_user_agent:STRING'</span><font></font>
<font></font>
<font></font>
src_path = <span class="hljs-string">"user_log_fileC.txt"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regex_clean</span>(<span class="hljs-params">data</span>):</span><font></font>
<font></font>
    PATTERNS =  [<span class="hljs-string">r'(^\S+\.[\S+\.]+\S+)\s'</span>,<span class="hljs-string">r'(?&lt;=\[).+?(?=\])'</span>,
           <span class="hljs-string">r'\"(\S+)\s(\S+)\s*(\S*)\"'</span>,<span class="hljs-string">r'\s(\d+)\s'</span>,<span class="hljs-string">r"(?&lt;=\[).\d+(?=\])"</span>,
           <span class="hljs-string">r'\"[A-Z][a-z]+'</span>, <span class="hljs-string">r'\"(http|https)://[a-z]+.[a-z]+.[a-z]+'</span>]<font></font>
    result = []<font></font>
    <span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> PATTERNS:
      <span class="hljs-keyword">try</span>:<font></font>
        reg_match = re.search(match, data).group()<font></font>
        <span class="hljs-keyword">if</span> reg_match:<font></font>
          result.append(reg_match)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
          result.append(<span class="hljs-string">" "</span>)
      <span class="hljs-keyword">except</span>:<font></font>
        print(<span class="hljs-string">"There was an error with the regex search"</span>)<font></font>
    result = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    result = [x.replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    res = <span class="hljs-string">','</span>.join(result)
    <span class="hljs-keyword">return</span> res<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Split</span>(<span class="hljs-params">beam.DoFn</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self, element</span>):</span>
        <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<font></font>
        element = element.split(<span class="hljs-string">","</span>)<font></font>
        d = datetime.strptime(element[<span class="hljs-number">1</span>], <span class="hljs-string">"%d/%b/%Y:%H:%M:%S"</span>)<font></font>
        date_string = d.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> [{ 
            <span class="hljs-string">'remote_addr'</span>: element[<span class="hljs-number">0</span>],
            <span class="hljs-string">'timelocal'</span>: date_string,
            <span class="hljs-string">'request_type'</span>: element[<span class="hljs-number">2</span>],
            <span class="hljs-string">'status'</span>: element[<span class="hljs-number">3</span>],
            <span class="hljs-string">'body_bytes_sent'</span>: element[<span class="hljs-number">4</span>],
            <span class="hljs-string">'http_referer'</span>: element[<span class="hljs-number">5</span>],
            <span class="hljs-string">'http_user_agent'</span>: element[<span class="hljs-number">6</span>]<font></font>
    <font></font>
        }]<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
<font></font>
   p = beam.Pipeline(options=PipelineOptions())<font></font>
<font></font>
   (p<font></font>
      | <span class="hljs-string">'ReadData'</span> &gt;&gt; beam.io.textio.ReadFromText(src_path)<font></font>
      | <span class="hljs-string">"clean address"</span> &gt;&gt; beam.Map(regex_clean)<font></font>
      | <span class="hljs-string">'ParseCSV'</span> &gt;&gt; beam.ParDo(Split())<font></font>
      | <span class="hljs-string">'WriteToBigQuery'</span> &gt;&gt; beam.io.WriteToBigQuery(<span class="hljs-string">'{0}:userlogs.logdata'</span>.format(PROJECT), schema=schema,<font></font>
        write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND)<font></font>
   )<font></font>
<font></font>
   p.run()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
  logger = logging.getLogger().setLevel(logging.INFO)<font></font>
  main()</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°DataFlowã‚¸ãƒ§ãƒ–</font></font></h2><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> apache_beam.options.pipeline_options <span class="hljs-keyword">import</span> PipelineOptions
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> pubsub_v1
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> bigquery
<span class="hljs-keyword">import</span> apache_beam <span class="hljs-keyword">as</span> beam
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> re<font></font>
<font></font>
<font></font>
PROJECT=<span class="hljs-string">"user-logs-237110"</span>
schema = <span class="hljs-string">'remote_addr:STRING, timelocal:STRING, request_type:STRING, status:STRING, body_bytes_sent:STRING, http_referer:STRING, http_user_agent:STRING'</span>
TOPIC = <span class="hljs-string">"projects/user-logs-237110/topics/userlogs"</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regex_clean</span>(<span class="hljs-params">data</span>):</span><font></font>
<font></font>
    PATTERNS =  [<span class="hljs-string">r'(^\S+\.[\S+\.]+\S+)\s'</span>,<span class="hljs-string">r'(?&lt;=\[).+?(?=\])'</span>,
           <span class="hljs-string">r'\"(\S+)\s(\S+)\s*(\S*)\"'</span>,<span class="hljs-string">r'\s(\d+)\s'</span>,<span class="hljs-string">r"(?&lt;=\[).\d+(?=\])"</span>,
           <span class="hljs-string">r'\"[A-Z][a-z]+'</span>, <span class="hljs-string">r'\"(http|https)://[a-z]+.[a-z]+.[a-z]+'</span>]<font></font>
    result = []<font></font>
    <span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> PATTERNS:
      <span class="hljs-keyword">try</span>:<font></font>
        reg_match = re.search(match, data).group()<font></font>
        <span class="hljs-keyword">if</span> reg_match:<font></font>
          result.append(reg_match)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
          result.append(<span class="hljs-string">" "</span>)
      <span class="hljs-keyword">except</span>:<font></font>
        print(<span class="hljs-string">"There was an error with the regex search"</span>)<font></font>
    result = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    result = [x.replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    res = <span class="hljs-string">','</span>.join(result)
    <span class="hljs-keyword">return</span> res<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Split</span>(<span class="hljs-params">beam.DoFn</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self, element</span>):</span>
        <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<font></font>
        element = element.split(<span class="hljs-string">","</span>)<font></font>
        d = datetime.strptime(element[<span class="hljs-number">1</span>], <span class="hljs-string">"%d/%b/%Y:%H:%M:%S"</span>)<font></font>
        date_string = d.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> [{ 
            <span class="hljs-string">'remote_addr'</span>: element[<span class="hljs-number">0</span>],
            <span class="hljs-string">'timelocal'</span>: date_string,
            <span class="hljs-string">'request_type'</span>: element[<span class="hljs-number">2</span>],
            <span class="hljs-string">'body_bytes_sent'</span>: element[<span class="hljs-number">3</span>],
            <span class="hljs-string">'status'</span>: element[<span class="hljs-number">4</span>],
            <span class="hljs-string">'http_referer'</span>: element[<span class="hljs-number">5</span>],
            <span class="hljs-string">'http_user_agent'</span>: element[<span class="hljs-number">6</span>]<font></font>
    <font></font>
        }]<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(<span class="hljs-params">argv=None</span>):</span><font></font>
<font></font>
   parser = argparse.ArgumentParser()<font></font>
   parser.add_argument(<span class="hljs-string">"--input_topic"</span>)<font></font>
   parser.add_argument(<span class="hljs-string">"--output"</span>)<font></font>
   known_args = parser.parse_known_args(argv)<font></font>
<font></font>
<font></font>
   p = beam.Pipeline(options=PipelineOptions())<font></font>
<font></font>
   (p<font></font>
      | <span class="hljs-string">'ReadData'</span> &gt;&gt; beam.io.ReadFromPubSub(topic=TOPIC).with_output_types(bytes)<font></font>
      | <span class="hljs-string">"Decode"</span> &gt;&gt; beam.Map(<span class="hljs-keyword">lambda</span> x: x.decode(<span class="hljs-string">'utf-8'</span>))<font></font>
      | <span class="hljs-string">"Clean Data"</span> &gt;&gt; beam.Map(regex_clean)<font></font>
      | <span class="hljs-string">'ParseCSV'</span> &gt;&gt; beam.ParDo(Split())<font></font>
      | <span class="hljs-string">'WriteToBigQuery'</span> &gt;&gt; beam.io.WriteToBigQuery(<span class="hljs-string">'{0}:userlogs.logdata'</span>.format(PROJECT), schema=schema,<font></font>
        write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND)<font></font>
   )<font></font>
   result = p.run()<font></font>
   result.wait_until_finish()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
  logger = logging.getLogger().setLevel(logging.INFO)<font></font>
  main()<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ³ãƒ™ã‚¢ã‚¹ã‚¿ãƒ¼ãƒˆ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã„ãã¤ã‹ã®æ–¹æ³•ã§é–‹å§‹ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">å¿…è¦ã«å¿œã˜ã¦ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã€GCPã«ãƒªãƒ¢ãƒ¼ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">python -m main_pipeline_stream.py \<font></font>
 --input_topic <span class="hljs-string">"projects/user-logs-237110/topics/userlogs"</span> \<font></font>
 --streaming</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãŸã ã—ã€DataFlowã‚’ä½¿ç”¨ã—ã¦èµ·å‹•ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã®å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br>
<ul>
<li><code>project</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®IDã€‚</font></font></li>
<li><code>runner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’åˆ†æã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ã‚³ãƒ³ãƒ™ãƒ¤ãƒ¼ãƒ©ãƒ³ãƒãƒ£ãƒ¼ã€‚</font><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚¦ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ã«ã¯ã€DataflowRunnerã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font></li>
<li><code>staging_location</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ä½œæ¥­ã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ãƒƒã‚µãŒå¿…è¦ã¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚±ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸Cloud Dataflowã¸ã®ãƒ‘ã‚¹ã€‚</font></font></li>
<li><code>temp_location</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ“ä½œä¸­ã«ä½œæˆã•ã‚ŒãŸä¸€æ™‚ã‚¸ãƒ§ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸Cloud Dataflowã¸ã®ãƒ‘ã‚¹ã€‚</font></font></li>
<li><code>streaming</code></li>
</ul><br>
<pre><code class="python hljs">python main_pipeline_stream.py \<font></font>
--runner DataFlow \<font></font>
--project $PROJECT \<font></font>
--temp_location $BUCKET/tmp \<font></font>
--staging_location $BUCKET/staging<font></font>
--streaming<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œä¸­ã«ã€Googleã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®[DataFlow]ã‚¿ãƒ–ã«ç§»å‹•ã—ã¦ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å›³4ã®ã‚ˆã†ãªã‚‚ã®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒãƒƒã‚°ã®ç›®çš„ã§ã€ãƒ­ã‚°ã«ç§»å‹•ã—ã¦ã‹ã‚‰Stackdriverã«ç§»å‹•ã—ã€è©³ç´°ãªãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã¨éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€å¤šãã®å ´åˆã«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã—ãŸã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7p/ai/vu/7paivucaa-lfkgvfzta6aozjs1q.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›³4ï¼šãƒ“ãƒ¼ãƒ ã‚³ãƒ³ãƒ™ã‚¢</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BigQueryã§ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’é–‹å§‹ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€BigQueryã«ç§»å‹•ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æœ€åˆã®æ•°è¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">BigQueryã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚ŒãŸã®ã§ã€ã•ã‚‰ã«åˆ†æã‚’è¡Œã£ãŸã‚Šã€åŒåƒšã¨ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã—ãŸã‚Šã€ãƒ“ã‚¸ãƒã‚¹ã®è³ªå•ã«ç­”ãˆãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">SELECT * FROM `user-logs<span class="hljs-number">-237110.</span>userlogs.logdata` LIMIT <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ch/je/x_/chjex_xkpbc61hjrcft2qq06uuo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›³5ï¼šBigQuery</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çµè«–</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®æŠ•ç¨¿ãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹æœ‰ç”¨ãªä¾‹ã«ãªã‚‹ã“ã¨ã€ãŠã‚ˆã³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ãã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã«ãªã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚ã“ã®å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã¨ã€å¤šãã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã§ã€ãŸã¨ãˆã°ã€è£½å“ã‚’ä½•äººä½¿ç”¨ã™ã‚‹ã‹ãªã©ã®é‡è¦ãªè³ªå•ã«ç­”ãˆå§‹ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ã¯æ™‚é–“ã¨ã¨ã‚‚ã«æˆé•·ã—ã¦ã„ã¾ã™ã‹ï¼Ÿè£½å“ã®ã©ã®å´é¢ãŒæœ€ã‚‚ç›¸äº’ä½œç”¨ã—ã¾ã™ã‹ï¼Ÿãã—ã¦ã€ãã‚Œã‚‰ãŒã‚ã‚Šå¾—ãªã„ã¯ãšã®ã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã“ã‚Œã‚‰ã¯ã€çµ„ç¹”ã«ã¨ã£ã¦é–¢å¿ƒã®ã‚ã‚‹è³ªå•ã§ã™ã€‚ã“ã‚Œã‚‰ã®è³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸã‚¢ã‚¤ãƒ‡ã‚¢ã«åŸºã¥ã„ã¦ã€è£½å“ã‚’æ”¹å–„ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢å¿ƒã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beamã¯ã€ã“ã®ç¨®ã®ã‚¨ã‚¯ã‚µã‚µã‚¤ã‚ºã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã¾ãŸã€ä»–ã«ã‚‚å¤šãã®èˆˆå‘³æ·±ã„ä½¿ç”¨ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€å–å¼•æ‰€ãƒ†ã‚£ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åˆ†æã—ã€åˆ†æã«åŸºã¥ã„ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ãŠãã‚‰ãã€è»Šä¸¡ã‹ã‚‰ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã€äº¤é€šé‡ã®è¨ˆç®—ã‚’è¨ˆç®—ã—ãŸã„ã¨ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ä¸»è¦ãªãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¿½è·¡ã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ã‚²ãƒ¼ãƒ ä¼šç¤¾ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚ã‹ã‚Šã¾ã—ãŸã€çš†ã•ã‚“ã€ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã¯ã™ã§ã«åˆ¥ã®æŠ•ç¨¿ã«ã‚ã‚Šã¾ã™ã€‚ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã‚’ã”è¦§ã«ãªã‚ŠãŸã„æ–¹ã®ãŸã‚ã«ã€ä»¥ä¸‹ã«ç§ã®GitHubã¸ã®ãƒªãƒ³ã‚¯ã‚’ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/DFoly/User_log_pipeline</font></font><br>
</a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ä»¥ä¸Šã§ã™ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åˆã®ãƒ‘ãƒ¼ãƒˆã‚’ãŠèª­ã¿ãã ã•ã„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462577/index.html">ç§ã®Nimé–‹ç™ºçµŒé¨“</a></li>
<li><a href="../ja462581/index.html">æœ€åˆã®é›»å­ãƒªãƒ¼ã‚¹ã‚’ã©ã®ã‚ˆã†ã«çµ„ç¹”ã—ã€ãã‚ŒãŒä½•ã«ã¤ãªãŒã£ãŸã‹</a></li>
<li><a href="../ja462583/index.html">ç¢ºå®šçš„ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®ç´¹ä»‹</a></li>
<li><a href="../ja462585/index.html">nestã€@ nestjsx / crudãŠã‚ˆã³TestMaceã‚’ä½¿ç”¨ã—ãŸCRUDã®è¿…é€Ÿãªä½œæˆ</a></li>
<li><a href="../ja462587/index.html">AirTest IDEã¨ç”»åƒèªè­˜-ç”»åƒèªè­˜ã«åŸºã¥ããƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ ã®ãƒ†ã‚¹ãƒˆã®è‡ªå‹•åŒ–</a></li>
<li><a href="../ja462593/index.html">ã‚¹ã‚¿ãƒ³ãƒ‰ã®åå¯¾å´</a></li>
<li><a href="../ja462595/index.html">ãƒ¬ã‚¿ãƒ¼ã®ç›£æŸ»ã¨ãƒ†ã‚¹ãƒˆï¼šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸­ã«æ³¨æ„ã™ã¹ãã“ã¨</a></li>
<li><a href="../ja462597/index.html">ã‚¿ã‚¤ãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨åå¿œ</a></li>
<li><a href="../ja462601/index.html">AWSã§ã®Windowsã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</a></li>
<li><a href="../ja462605/index.html">æš—å·ã«ãŠã‘ã‚‹ã‚¤ã‚¿ãƒªã‚¢ã®ç—•è·¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>