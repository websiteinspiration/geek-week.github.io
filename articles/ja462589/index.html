<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐂 👨 🌀 ストリーミングデータ処理用のパイプラインを作成します。パート2 💮 🧖🏿 🗨️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは。特にデータエンジニアコースの学生向けに準備された、記事の最後の部分の翻訳を共有します。最初の部分はここにあります。
 
 リアルタイムパイプライン用のApache BeamとDataFlow
 
 
 
 Google Cloudのセットアップ
 注：Python 3でパイプラ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ストリーミングデータ処理用のパイプラインを作成します。パート2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/462589/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みなさん、こんにちは。</font><font style="vertical-align: inherit;">特に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データエンジニア</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの学生向けに準備された、記事の最後の部分の翻訳を共有し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">最初の部分は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リアルタイムパイプライン用のApache BeamとDataFlow</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/9t/uy/au/9tuyauggjylmprwx7lxswwbqggi.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Cloudのセットアップ</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：Python 3でパイプラインを実行するときに問題が発生したため、Google Cloud Shellを使用してパイプラインを開始し、ユーザーログデータを公開しました。GoogleCloud Shellは、Apache Beamとの互換性の高いPython 2を使用しています。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンベアを起動するには、設定について少し掘り下げる必要があります。</font><font style="vertical-align: inherit;">これまでにGCPを使用したことがない場合は、この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の6つのステップを完了する必要があり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、スクリプトをGoogle Cloud Storageにアップロードして、Google Cloud Shelにコピーする必要があります。</font><font style="vertical-align: inherit;">クラウドストレージへのアップロードは非常に簡単です（説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">ファイルをコピーするには、下の図2の左側にある最初のアイコンをクリックして、ツールバーからGoogle Cloud Shelを開きます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/su/hz/hq/suhzhqrmyvi6c5hneokqhhhqjuw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図2</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルをコピーして必要なライブラリをインストールするために必要なコマンドを以下に示します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Copy file from cloud storage</span><font></font>
gsutil cp gs://&lt;YOUR-BUCKET&gt;/ * .<font></font>
sudo pip install apache-beam[gcp] oauth2client==<span class="hljs-number">3.0</span><span class="hljs-number">.0</span><font></font>
sudo pip install -U pip<font></font>
sudo pip install Faker==<span class="hljs-number">1.0</span><span class="hljs-number">.2</span>
<span class="hljs-comment"># Environment variables</span><font></font>
BUCKET=&lt;YOUR-BUCKET&gt;<font></font>
PROJECT=&lt;YOUR-PROJECT&gt;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースとテーブルを作成する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての構成手順が完了したら、次に実行する必要があるのは、BigQueryでデータセットとテーブルを作成することです。</font><font style="vertical-align: inherit;">これにはいくつかの方法がありますが、最も簡単な方法は、最初にデータセットを作成してGoogle Cloud Consoleを使用することです。</font><font style="vertical-align: inherit;">次の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順に従って、</font><font style="vertical-align: inherit;">スキーマを含むテーブルを作成できます。</font><font style="vertical-align: inherit;">この表には</font><font style="vertical-align: inherit;">、各ユーザーログのコンポーネントに対応する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7つの列</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">便宜上、timelocal変数を除くすべての列を文字列（文字列型）として定義し、前に生成した変数に従って名前を付けます。</font><font style="vertical-align: inherit;">テーブルのレイアウトは図3のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zw/ts/pz/zwtspziwiubrmz0c860bmvoe3so.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図3.テーブルのレイアウト</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーログデータの公開</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
複数の独立したアプリケーションが相互にやり取りできるため、Pub / Subはパイプラインの重要なコンポーネントです。特に、アプリケーション間でメッセージを送受信するための仲介者として機能します。まず、トピックを作成する必要があります。コンソールのPub / Subに移動し、CREATE TOPICを押します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下のコードは、スクリプトを呼び出して上記で定義されたログデータを生成し、接続してログをPub / Subに送信します。私たちが行う必要がある唯一のものは作成され</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PublisherClientの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトを</font><font style="vertical-align: inherit;">、メソッドを使用してトピックへのパスを指定し、</font></font><code> topic_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして関数を呼び出す</font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>topic_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、データ。</font></font><code>generate_log_line</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトから</font><font style="vertical-align: inherit;">インポート</font><font style="vertical-align: inherit;">する</font><font style="vertical-align: inherit;">ことに注意してください</font></font><code>stream_logs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、これらのファイルが同じフォルダにあることを確認してください。そうしないと、インポートエラーが発生します。</font><font style="vertical-align: inherit;">次に、これを使用してGoogleコンソールからこれを実行できます。</font></font><br>
<br>
<pre><code class="python hljs">python publish.py</code></pre><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> stream_logs <span class="hljs-keyword">import</span> generate_log_line
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> pubsub_v1
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<font></font>
PROJECT_ID=<span class="hljs-string">"user-logs-237110"</span>
TOPIC = <span class="hljs-string">"userlogs"</span><font></font>
<font></font>
<font></font>
publisher = pubsub_v1.PublisherClient()<font></font>
topic_path = publisher.topic_path(PROJECT_ID, TOPIC)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">publish</span>(<span class="hljs-params">publisher, topic, message</span>):</span>
    data = message.encode(<span class="hljs-string">'utf-8'</span>)
    <span class="hljs-keyword">return</span> publisher.publish(topic_path, data = data)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">callback</span>(<span class="hljs-params">message_future</span>):</span>
    <span class="hljs-comment"># When timeout is unspecified, the exception method waits indefinitely.</span>
    <span class="hljs-keyword">if</span> message_future.exception(timeout=<span class="hljs-number">30</span>):<font></font>
        print(<span class="hljs-string">'Publishing message on {} threw an Exception {}.'</span>.format(<font></font>
            topic_name, message_future.exception()))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        print(message_future.result())<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
<font></font>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
        line = generate_log_line()<font></font>
        print(line)<font></font>
        message_future = publish(publisher, topic_path, line)<font></font>
        message_future.add_done_callback(callback)<font></font>
<font></font>
        sleep_time = random.choice(range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>))<font></font>
        time.sleep(sleep_time)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の図に示すように、ファイルが開始するとすぐに、コンソールへのログデータの出力を確認できます。</font><font style="vertical-align: inherit;">このスクリプトは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL + C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">して完了するまで機能します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/4c/6n/ho4c6n5yfnnv8pvetgkidvut-q0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図4.結論</font></font><code>publish_logs.py</code><br>
</i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイプラインのコードを書く</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての準備が整ったので、最も興味深い部分に進むことができます。BeamとPythonを使用してパイプラインのコードを記述します。</font><font style="vertical-align: inherit;">Beamパイプラインを作成するには、パイプラインオブジェクト（p）を作成する必要があります。</font><font style="vertical-align: inherit;">パイプラインオブジェクトを作成したら、演算子を使用していくつかの関数を次々と適用できます</font></font><code>pipe (|)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一般に、ワークフローは次の図のようになります。</font></font><br>
<br>
<pre><code class="python hljs">[Final Output PCollection] = ([Initial Input PCollection] | [First Transform]<font></font>
             | [Second Transform]<font></font>
             | [Third Transform])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードでは、2つのカスタム関数を作成します。関数</font></font><code>regex_clean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して、データをスキャンし、PATTERNSリストに基づいて対応する行を取得する関数</font></font><code>re.search</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。関数はコンマ区切りの文字列を返します。正規表現の専門家でない場合は、この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チュートリアル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読み</font><font style="vertical-align: inherit;">、メモ帳で練習してコードを確認する</font><font style="vertical-align: inherit;">ことをお勧めします</font><font style="vertical-align: inherit;">。その後、</font><b><font style="vertical-align: inherit;">Split</font></b><font style="vertical-align: inherit;">というカスタムParDo関数を定義します</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、並列処理用のビーム変換のバリエーションです。 Pythonでは、これは特別な方法で行われます-DoFn Beamクラスから継承するクラスを作成する必要があります。 Split関数は、前の関数から解析された文字列を受け取り、BigQueryテーブルの列名に対応するキーを持つ辞書のリストを返します。この関数については注意する点があり</font></font><code>datetime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。関数を機能させるには、関数内</font><font style="vertical-align: inherit;">にインポート</font><font style="vertical-align: inherit;">する必要がありました。ファイルの最初にインポートエラーが表示されました。次に、このリストは</font><b><font style="vertical-align: inherit;">WriteToBigQuery</font></b><font style="vertical-align: inherit;">関数に渡されます</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、データをテーブルに追加するだけです。</font><font style="vertical-align: inherit;">バッチDataFlowジョブとストリーミングDataFlowジョブのコードを以下に示します。</font><font style="vertical-align: inherit;">バッチコードとストリームコードの唯一の違いは、バッチ処理で</font><font style="vertical-align: inherit;">Beamの</font></font><code>src_path</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用して</font><font style="vertical-align: inherit;">CSVを読み取ること</font></font><code>ReadFromText</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッチDataFlowジョブ（パケット処理）</font></font></h2><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> apache_beam <span class="hljs-keyword">as</span> beam
<span class="hljs-keyword">from</span> apache_beam.options.pipeline_options <span class="hljs-keyword">import</span> PipelineOptions
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> bigquery
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> sys<font></font>
<font></font>
PROJECT=<span class="hljs-string">'user-logs-237110'</span>
schema = <span class="hljs-string">'remote_addr:STRING, timelocal:STRING, request_type:STRING, status:STRING, body_bytes_sent:STRING, http_referer:STRING, http_user_agent:STRING'</span><font></font>
<font></font>
<font></font>
src_path = <span class="hljs-string">"user_log_fileC.txt"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regex_clean</span>(<span class="hljs-params">data</span>):</span><font></font>
<font></font>
    PATTERNS =  [<span class="hljs-string">r'(^\S+\.[\S+\.]+\S+)\s'</span>,<span class="hljs-string">r'(?&lt;=\[).+?(?=\])'</span>,
           <span class="hljs-string">r'\"(\S+)\s(\S+)\s*(\S*)\"'</span>,<span class="hljs-string">r'\s(\d+)\s'</span>,<span class="hljs-string">r"(?&lt;=\[).\d+(?=\])"</span>,
           <span class="hljs-string">r'\"[A-Z][a-z]+'</span>, <span class="hljs-string">r'\"(http|https)://[a-z]+.[a-z]+.[a-z]+'</span>]<font></font>
    result = []<font></font>
    <span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> PATTERNS:
      <span class="hljs-keyword">try</span>:<font></font>
        reg_match = re.search(match, data).group()<font></font>
        <span class="hljs-keyword">if</span> reg_match:<font></font>
          result.append(reg_match)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
          result.append(<span class="hljs-string">" "</span>)
      <span class="hljs-keyword">except</span>:<font></font>
        print(<span class="hljs-string">"There was an error with the regex search"</span>)<font></font>
    result = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    result = [x.replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    res = <span class="hljs-string">','</span>.join(result)
    <span class="hljs-keyword">return</span> res<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Split</span>(<span class="hljs-params">beam.DoFn</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self, element</span>):</span>
        <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<font></font>
        element = element.split(<span class="hljs-string">","</span>)<font></font>
        d = datetime.strptime(element[<span class="hljs-number">1</span>], <span class="hljs-string">"%d/%b/%Y:%H:%M:%S"</span>)<font></font>
        date_string = d.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> [{ 
            <span class="hljs-string">'remote_addr'</span>: element[<span class="hljs-number">0</span>],
            <span class="hljs-string">'timelocal'</span>: date_string,
            <span class="hljs-string">'request_type'</span>: element[<span class="hljs-number">2</span>],
            <span class="hljs-string">'status'</span>: element[<span class="hljs-number">3</span>],
            <span class="hljs-string">'body_bytes_sent'</span>: element[<span class="hljs-number">4</span>],
            <span class="hljs-string">'http_referer'</span>: element[<span class="hljs-number">5</span>],
            <span class="hljs-string">'http_user_agent'</span>: element[<span class="hljs-number">6</span>]<font></font>
    <font></font>
        }]<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
<font></font>
   p = beam.Pipeline(options=PipelineOptions())<font></font>
<font></font>
   (p<font></font>
      | <span class="hljs-string">'ReadData'</span> &gt;&gt; beam.io.textio.ReadFromText(src_path)<font></font>
      | <span class="hljs-string">"clean address"</span> &gt;&gt; beam.Map(regex_clean)<font></font>
      | <span class="hljs-string">'ParseCSV'</span> &gt;&gt; beam.ParDo(Split())<font></font>
      | <span class="hljs-string">'WriteToBigQuery'</span> &gt;&gt; beam.io.WriteToBigQuery(<span class="hljs-string">'{0}:userlogs.logdata'</span>.format(PROJECT), schema=schema,<font></font>
        write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND)<font></font>
   )<font></font>
<font></font>
   p.run()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
  logger = logging.getLogger().setLevel(logging.INFO)<font></font>
  main()</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリーミングDataFlowジョブ</font></font></h2><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> apache_beam.options.pipeline_options <span class="hljs-keyword">import</span> PipelineOptions
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> pubsub_v1
<span class="hljs-keyword">from</span> google.cloud <span class="hljs-keyword">import</span> bigquery
<span class="hljs-keyword">import</span> apache_beam <span class="hljs-keyword">as</span> beam
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> re<font></font>
<font></font>
<font></font>
PROJECT=<span class="hljs-string">"user-logs-237110"</span>
schema = <span class="hljs-string">'remote_addr:STRING, timelocal:STRING, request_type:STRING, status:STRING, body_bytes_sent:STRING, http_referer:STRING, http_user_agent:STRING'</span>
TOPIC = <span class="hljs-string">"projects/user-logs-237110/topics/userlogs"</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regex_clean</span>(<span class="hljs-params">data</span>):</span><font></font>
<font></font>
    PATTERNS =  [<span class="hljs-string">r'(^\S+\.[\S+\.]+\S+)\s'</span>,<span class="hljs-string">r'(?&lt;=\[).+?(?=\])'</span>,
           <span class="hljs-string">r'\"(\S+)\s(\S+)\s*(\S*)\"'</span>,<span class="hljs-string">r'\s(\d+)\s'</span>,<span class="hljs-string">r"(?&lt;=\[).\d+(?=\])"</span>,
           <span class="hljs-string">r'\"[A-Z][a-z]+'</span>, <span class="hljs-string">r'\"(http|https)://[a-z]+.[a-z]+.[a-z]+'</span>]<font></font>
    result = []<font></font>
    <span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> PATTERNS:
      <span class="hljs-keyword">try</span>:<font></font>
        reg_match = re.search(match, data).group()<font></font>
        <span class="hljs-keyword">if</span> reg_match:<font></font>
          result.append(reg_match)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
          result.append(<span class="hljs-string">" "</span>)
      <span class="hljs-keyword">except</span>:<font></font>
        print(<span class="hljs-string">"There was an error with the regex search"</span>)<font></font>
    result = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    result = [x.replace(<span class="hljs-string">'"'</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> result]<font></font>
    res = <span class="hljs-string">','</span>.join(result)
    <span class="hljs-keyword">return</span> res<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Split</span>(<span class="hljs-params">beam.DoFn</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process</span>(<span class="hljs-params">self, element</span>):</span>
        <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<font></font>
        element = element.split(<span class="hljs-string">","</span>)<font></font>
        d = datetime.strptime(element[<span class="hljs-number">1</span>], <span class="hljs-string">"%d/%b/%Y:%H:%M:%S"</span>)<font></font>
        date_string = d.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> [{ 
            <span class="hljs-string">'remote_addr'</span>: element[<span class="hljs-number">0</span>],
            <span class="hljs-string">'timelocal'</span>: date_string,
            <span class="hljs-string">'request_type'</span>: element[<span class="hljs-number">2</span>],
            <span class="hljs-string">'body_bytes_sent'</span>: element[<span class="hljs-number">3</span>],
            <span class="hljs-string">'status'</span>: element[<span class="hljs-number">4</span>],
            <span class="hljs-string">'http_referer'</span>: element[<span class="hljs-number">5</span>],
            <span class="hljs-string">'http_user_agent'</span>: element[<span class="hljs-number">6</span>]<font></font>
    <font></font>
        }]<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>(<span class="hljs-params">argv=None</span>):</span><font></font>
<font></font>
   parser = argparse.ArgumentParser()<font></font>
   parser.add_argument(<span class="hljs-string">"--input_topic"</span>)<font></font>
   parser.add_argument(<span class="hljs-string">"--output"</span>)<font></font>
   known_args = parser.parse_known_args(argv)<font></font>
<font></font>
<font></font>
   p = beam.Pipeline(options=PipelineOptions())<font></font>
<font></font>
   (p<font></font>
      | <span class="hljs-string">'ReadData'</span> &gt;&gt; beam.io.ReadFromPubSub(topic=TOPIC).with_output_types(bytes)<font></font>
      | <span class="hljs-string">"Decode"</span> &gt;&gt; beam.Map(<span class="hljs-keyword">lambda</span> x: x.decode(<span class="hljs-string">'utf-8'</span>))<font></font>
      | <span class="hljs-string">"Clean Data"</span> &gt;&gt; beam.Map(regex_clean)<font></font>
      | <span class="hljs-string">'ParseCSV'</span> &gt;&gt; beam.ParDo(Split())<font></font>
      | <span class="hljs-string">'WriteToBigQuery'</span> &gt;&gt; beam.io.WriteToBigQuery(<span class="hljs-string">'{0}:userlogs.logdata'</span>.format(PROJECT), schema=schema,<font></font>
        write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND)<font></font>
   )<font></font>
   result = p.run()<font></font>
   result.wait_until_finish()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
  logger = logging.getLogger().setLevel(logging.INFO)<font></font>
  main()<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンベアスタート</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パイプラインはいくつかの方法で開始できます。</font><font style="vertical-align: inherit;">必要に応じて、ターミナルからローカルで実行し、GCPにリモートでログインすることもできます。</font></font><br>
<br>
<pre><code class="python hljs">python -m main_pipeline_stream.py \<font></font>
 --input_topic <span class="hljs-string">"projects/user-logs-237110/topics/userlogs"</span> \<font></font>
 --streaming</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、DataFlowを使用して起動します。</font><font style="vertical-align: inherit;">以下の必須パラメーターを設定することにより、以下のコマンドを使用してこれを行うことができます。</font></font><br>
<br>
<ul>
<li><code>project</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -GCPプロジェクトのID。</font></font></li>
<li><code>runner</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-プログラムを分析してパイプラインを構築するコンベヤーランチャー。</font><font style="vertical-align: inherit;">クラウドで実行するには、DataflowRunnerを指定する必要があります。</font></font></li>
<li><code>staging_location</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -作業を実行するプロセッサが必要とするコードパケットのインデックスを作成するためのクラウドストレージCloud Dataflowへのパス。</font></font></li>
<li><code>temp_location</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -パイプラインの操作中に作成された一時ジョブファイルを配置するためのクラウドストレージCloud Dataflowへのパス。</font></font></li>
<li><code>streaming</code></li>
</ul><br>
<pre><code class="python hljs">python main_pipeline_stream.py \<font></font>
--runner DataFlow \<font></font>
--project $PROJECT \<font></font>
--temp_location $BUCKET/tmp \<font></font>
--staging_location $BUCKET/staging<font></font>
--streaming<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコマンドの実行中に、Googleコンソールの[DataFlow]タブに移動して、パイプラインを表示できます。</font><font style="vertical-align: inherit;">パイプラインをクリックすると、図4のようなものが表示されます。デバッグの目的で、ログに移動してからStackdriverに移動し、詳細なログを表示すると非常に便利です。</font><font style="vertical-align: inherit;">これは、多くの場合にパイプラインの問題を解決するのに役立ちました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7p/ai/vu/7paivucaa-lfkgvfzta6aozjs1q.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図4：ビームコンベア</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BigQueryでデータにアクセスする</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、テーブルにデータを入力してパイプラインを開始しておく必要があります。</font><font style="vertical-align: inherit;">これをテストするには、BigQueryに移動してデータを表示します。</font><font style="vertical-align: inherit;">以下のコマンドを使用すると、データセットの最初の数行が表示されます。</font><font style="vertical-align: inherit;">BigQueryにデータが保存されたので、さらに分析を行ったり、同僚とデータを共有したり、ビジネスの質問に答えたりすることができます。</font></font><br>
<br>
<pre><code class="python hljs">SELECT * FROM `user-logs<span class="hljs-number">-237110.</span>userlogs.logdata` LIMIT <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ch/je/x_/chjex_xkpbc61hjrcft2qq06uuo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図5：BigQuery</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この投稿がストリーミングデータパイプラインを作成する有用な例になること、およびデータをよりアクセスしやすくする方法を見つけることになることを願っています。この形式でデータを保存すると、多くの利点があります。これで、たとえば、製品を何人使用するかなどの重要な質問に答え始めることができます。ユーザーベースは時間とともに成長していますか？製品のどの側面が最も相互作用しますか？そして、それらがあり得ないはずのエラーはありますか？これらは、組織にとって関心のある質問です。これらの質問に対する回答から生まれたアイデアに基づいて、製品を改善し、ユーザーの関心を高めることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beamは、この種のエクササイズに非常に役立ちます。また、他にも多くの興味深い使用例があります。</font><font style="vertical-align: inherit;">たとえば、取引所ティックのデータをリアルタイムで分析し、分析に基づいてトランザクションを実行できます。おそらく、車両からのセンサーデータがあり、交通量の計算を計算したいとします。</font><font style="vertical-align: inherit;">たとえば、ユーザーデータを収集し、それを使用して主要なメトリックを追跡するダッシュボードを作成するゲーム会社にすることもできます。</font><font style="vertical-align: inherit;">わかりました、皆さん、このトピックはすでに別の投稿にあります。お読みいただきありがとうございます。完全なコードをご覧になりたい方のために、以下に私のGitHubへのリンクを示します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/DFoly/User_log_pipeline</font></font><br>
</a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
以上です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のパートをお読みください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462577/index.html">私のNim開発経験</a></li>
<li><a href="../ja462581/index.html">最初の電子リースをどのように組織し、それが何につながったか</a></li>
<li><a href="../ja462583/index.html">確定的ガベージコレクターポインターの紹介</a></li>
<li><a href="../ja462585/index.html">nest、@ nestjsx / crudおよびTestMaceを使用したCRUDの迅速な作成</a></li>
<li><a href="../ja462587/index.html">AirTest IDEと画像認識-画像認識に基づくモバイルゲームのテストの自動化</a></li>
<li><a href="../ja462593/index.html">スタンドの反対側</a></li>
<li><a href="../ja462595/index.html">レターの監査とテスト：レイアウト中に注意すべきこと</a></li>
<li><a href="../ja462597/index.html">タイプスクリプトと反応</a></li>
<li><a href="../ja462601/index.html">AWSでのWindowsサーバーのバックアップ</a></li>
<li><a href="../ja462605/index.html">暗号におけるイタリアの痕跡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>