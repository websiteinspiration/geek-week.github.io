<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥩 🤷🏻 👨🏿 Une étude d'un comportement vague 📰 🚴🏻 👨‍👨‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'article explore les manifestations possibles d'un comportement non défini qui se produit dans c ++ lorsqu'une fonction non vide est terminée sans ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Une étude d'un comportement vague</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499020/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'article explore les manifestations possibles d'un comportement non défini qui se produit dans c ++ lorsqu'une fonction non vide est terminée sans appeler return avec une valeur appropriée. </font><font style="vertical-align: inherit;">L'article est plus scientifique et amusant que pratique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qui n'aime pas s'amuser à sauter sur un râteau - on passe, on ne s'arrête pas.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout le monde sait que lors du développement de code c ++, vous ne devez pas autoriser un comportement non défini. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutefois:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un comportement indéfini peut ne pas sembler suffisamment dangereux en raison de l'abstraction des conséquences possibles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on ne sait pas toujours où est la ligne.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons de spécifier les manifestations possibles d'un comportement indéfini qui se produit dans un cas assez simple - dans une fonction non vide, il n'y a pas de retour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, considérez le code généré par les compilateurs les plus populaires dans différents modes d'optimisation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche sous Linux sera effectuée à l'aide de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explorateur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">compilateur</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Recherche sur Windows et macOs X - sur le matériel dont je dispose directement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les versions seront effectuées pour x86-x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aucune mesure ne sera prise pour améliorer ou supprimer les avertissements / erreurs du compilateur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y aura beaucoup de code démonté. </font><font style="vertical-align: inherit;">Sa conception, malheureusement, est hétéroclite, car </font><font style="vertical-align: inherit;">Je dois utiliser plusieurs outils différents (enfin, au moins j'ai réussi à obtenir la syntaxe Intel partout). </font><font style="vertical-align: inherit;">Je donnerai des commentaires modérément détaillés sur le code désassemblé, qui, cependant, n'éliminent pas le besoin de connaître les registres du processeur et les principes de la pile.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lire la norme</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 11 version finale n3797, C ++ 14 version finale N3936:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.6.3 L'instruction return </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La sortie d'une fin de fonction équivaut à un retour sans valeur; </font><font style="vertical-align: inherit;">cela se traduit par un </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comportement </font><font style="vertical-align: inherit;">indéfini </font><font style="vertical-align: inherit;">dans une fonction de retour de valeur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atteindre la fin d'une fonction équivaut à retourner sans valeur de retour; </font><font style="vertical-align: inherit;">pour une fonction dont la valeur de retour est fournie, cela conduit à un comportement indéfini.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 17 draft n4713</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6.3 L'instruction return </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'écoulant de la fin d'un constructeur, d'un destructeur ou d'une fonction avec un type de retour cv void est équivalent à un retour sans opérande. </font><font style="vertical-align: inherit;">Sinon, la sortie d'une fin de fonction autre que main (6.8.3.1) entraîne un comportement indéfini. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atteindre la fin d'un constructeur, d'un destructeur ou d'une fonction avec une valeur de retour vide (éventuellement avec des qualificateurs const et volatile) équivaut à retourner sans valeur de retour. </font><font style="vertical-align: inherit;">Pour toutes les autres fonctions, cela conduit à un comportement indéfini (à l'exception de la fonction principale).</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce que cela signifie dans la pratique? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la signature de fonction fournit une valeur de retour:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">son exécution doit se terminer par une instruction return avec une instance du type approprié;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinon, comportement vague;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un comportement indéfini ne démarre pas au moment où la fonction est appelée et non pas au moment où la valeur retournée est utilisée, mais à partir du moment où la fonction n'est pas terminée correctement;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la fonction contient des chemins d'exécution corrects et incorrects - un comportement indéfini ne se produira que sur des chemins incorrects;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le comportement indéfini en question n'affecte pas l'exécution des instructions contenues dans le corps de la fonction.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'expression concernant la fonction principale n'est pas nouvelle dans c ++ 17 - dans les versions précédentes de la norme, une exception similaire était décrite dans la section 3.6.1 Fonction principale.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple 1 - bool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En c ++ il n'y a pas de type avec un état plus simple que bool. </font><font style="vertical-align: inherit;">Commençons par lui.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVC génère une erreur de compilation C4716 pour un tel exemple, donc le code pour MSVC devra être légèrement compliqué en fournissant au moins un chemin d'exécution correct:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilation:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plate-forme</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilateur</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat de la compilation</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 Clang 10.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avertissement: la fonction non-void ne renvoie pas de valeur [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 gcc 9.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avertissement: pas de déclaration de retour dans la fonction retournant non-void [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac OS X</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple clang version 11.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avertissement: la commande atteint la fin de la fonction non nulle [-Type de retour]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fenêtres</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC 2019 16.5.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exemple d'origine est l'erreur C4716, compliquée - avertissement C4715: tous les chemins de contrôle ne renvoient pas de valeur</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Résultats d'exécution:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retour du programme</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie console</font></font></b></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0, -O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemple d'origine</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Exemple compliqué</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même dans cet exemple le plus simple, quatre compilateurs ont démontré au moins trois façons d'afficher un comportement non défini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce que ces compilateurs ont compilé là-bas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/yc/pg/vw/ycpgvw4062ruxbxhec61lpr5oec.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière instruction de la fonction bad () est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Description des instructions du </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manuel du développeur du logiciel des architectures Intel 64 et IA-32</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>UD2—Undefined Instruction<br>
Generates an invalid opcode exception. This instruction is provided for software testing to explicitly generate an invalid opcode exception. The opcode for this instruction is reserved for this purpose.<br>
Other than raising the invalid opcode exception, this instruction has no effect on processor state or memory.<br>
<br>
Even though it is the execution of the UD2 instruction that causes the invalid opcode exception, the instruction pointer saved by delivery of the exception references the UD2 instruction (and not the following instruction).<br>
<br>
This instruction’s operation is the same in non-64-bit modes and 64-bit mode.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En bref, il s'agit d'une instruction spéciale pour lever une exception. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous devez terminer l'appel bad () dans un essai ... attraper! Bloquer </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peu importe comment. </font><font style="vertical-align: inherit;">Ce n'est pas une exception c ++. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est-il possible d'attraper ud2 en runtime? </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous Windows, __try doit être utilisé pour cela; sous Linux et macOs X, le gestionnaire de signal SIGILL.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/qg/al/gl/qgalgl3q6xaqajpp2kdjqxpbp9m.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de l'optimisation, le compilateur a simplement pris et jeté à la fois le corps de la fonction bad () et son appel.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/a7/ny/2g/a7ny2ghbcx-bj4a73pqzu_y_eam.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explications (dans l'ordre inverse, car dans ce cas la chaîne est plus facile à analyser depuis la fin): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. L'opérateur de sortie dans stream est appelé pour bool (ligne 14); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. L'adresse std :: cout est placée dans le registre edi - c'est le premier argument de l'opérateur de sortie dans stream (ligne 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Le contenu du registre eax est placé dans le registre esi - c'est le deuxième argument de l'opérateur de sortie dans le flux (ligne 12); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Les trois octets hauts de eax sont remis à zéro, la valeur de al ne change pas (ligne 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. La fonction bad () est appelée (ligne 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0. La fonction bad () devrait mettre la valeur de retour dans le registre al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, la ligne 4 affiche nop (aucune opération, factice). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un octet de déchets du registre al est envoyé à la console. </font><font style="vertical-align: inherit;">Le programme se termine normalement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O1, -O2, -O3</font></font></h4><br>
<img src="https://habrastorage.org/webt/dp/sl/yh/dpslyhnvjwxt2c24ifgw6lgpxnu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compilateur a tout jeté suite à l'optimisation.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fonction main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/kl/aw/eyklawd5cgswoa14yg-h8iotxkq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le chemin de l'argument booléen de l'opérateur de sortie vers le flux (cette fois dans l'ordre direct): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Le contenu du registre al est placé dans le registre edx (ligne 8); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Tous les bits du registre edx sont mis à zéro, à l'exception du plus petit (ligne 9); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Un pointeur vers std :: cout est placé dans le registre rdi - c'est le premier argument de l'opérateur de sortie dans stream (ligne 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Le contenu du registre edx est placé dans le registre esi - c'est le deuxième argument de l'opérateur de sortie dans le flux (ligne 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. L'instruction de sortie est appelée dans stream pour bool (ligne 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction principale s'attend à obtenir le résultat de la fonction bad () du registre al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction bad (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v5/tx/1p/v5tx1pohulp-fewcheimnj0wnkk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. La valeur de l'octet suivant de la pile, non encore allouée, est placée dans le registre al (ligne 4);</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Tous les bits du registre al sont exceptés, sauf le moins significatif (ligne 5); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un bit de déchets de la pile non allouée est sorti sur la console. </font><font style="vertical-align: inherit;">Il se trouve que lors d'un test, il s'est avéré être nul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le programme se termine normalement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/zh/mm/t0/zhmmt0z4yvmtiunqa287sdu9lky.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'argument booléen de l'opérateur de sortie dans stream est annulé (ligne 5). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel bad () a été lancé lors de l'optimisation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le programme affiche toujours zéro dans la console et se ferme normalement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemple avancé, / Od</font></font></h4><br>
<img src="https://habrastorage.org/webt/pb/iz/ku/pbizkuhiff8y37zk6i2ea1qrwb8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut voir que la fonction bad () doit fournir une valeur de retour dans le registre al. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/ej/zn/auejznebzsjq0n_e4kgtbkfd5ae.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La valeur renvoyée par la fonction bad () est d'abord poussée sur la pile puis dans le registre edx pour la sortie à diffuser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un octet de déchets du registre al est envoyé à la console (un peu plus précisément, puis l'octet de poids faible du résultat de rand ()). </font><font style="vertical-align: inherit;">Le programme se termine normalement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Exemple compliqué, / O1, / O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/mk/wr/jy/mkwrjyimc1tfaqfzq_hzuorcaba.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compilateur a forcé l'appel de bad (). </font><font style="vertical-align: inherit;">Fonction principale:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copie un octet de ebx de la mémoire située à [rsp + 30h];</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si rand () a retourné zéro, copiez l'unité d'ecx vers ebx (ligne 11);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copie la même valeur dans dl (plus précisément, son octet le moins significatif) (ligne 13);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appelle la fonction de sortie dans stream, qui produit la valeur dl (ligne 14).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un octet de déchets de la RAM (à partir de l'adresse rsp + 30h) est émis en flux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusion de l'exemple 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les résultats de l'examen des listes de désassembleurs sont présentés dans le tableau:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retour du programme</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie console</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cause</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La sortie de la console et l'appel à la fonction bad () ont été lancés à la suite de l'optimisation</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets du registre al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La sortie de la console et l'appel à la fonction bad () ont été lancés à la suite de l'optimisation</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu de déchets de la RAM</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de fonction bad () remplacé par zéro</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemple d'origine</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Exemple compliqué</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets du registre al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets de la RAM</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est avéré que les compilateurs n'ont pas démontré 3, mais pas moins de 6 variantes de comportement indéfini - juste avant d'envisager les listes de désassembleurs, nous n'avons pas pu en distinguer certaines.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple 1a - Gestion d'un comportement indéfini</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons de diriger un peu avec un comportement non défini - affectons la valeur retournée par la fonction bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ne peut être fait qu'avec des compilateurs qui génèrent des ordures. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, placez les valeurs souhaitées dans les emplacements d'où les compilateurs les prendront.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction bad () vide ne modifie pas la valeur du registre al, comme le code appelant l'exige. </font><font style="vertical-align: inherit;">Ainsi, si nous plaçons une certaine valeur dans al avant d'appeler bad (), nous nous attendons à voir cette valeur comme le résultat de l'exécution de bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute évidence, cela peut être fait en appelant toute autre fonction qui renvoie bool. </font><font style="vertical-align: inherit;">Mais cela peut aussi être fait en utilisant une fonction qui retourne, par exemple, un caractère non signé.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodTrue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> rand();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodFalse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> !goodTrue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
    <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    goodTrue();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodFalse();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple pour MSVC, la fonction bad () renvoie l'octet de poids faible du résultat de rand (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sans modifier la fonction bad (), le code externe peut affecter sa valeur de retour en modifiant le résultat de rand ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">control</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> value)</span>
</span>{
    <span class="hljs-keyword">uint32_t</span> count = <span class="hljs-number">0</span>;<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> ((rand() &amp; <span class="hljs-number">0xff</span>) != value) {<font></font>
        ++count;<font></font>
    }<font></font>
<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
        rand();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    control(<span class="hljs-number">1</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">0</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour influencer non la valeur «retournée» par la fonction bad (), il suffit de créer une variable de pile. </font><font style="vertical-align: inherit;">Pour que l'enregistrement ne soit pas supprimé lors de l'optimisation, vous devez le marquer comme volatile.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">85</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">240</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant d'appeler bad (), vous devez entrer une certaine valeur dans cette cellule mémoire qui sera une de moins que le haut de la pile au moment d'appeler bad ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putToStack</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> value)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> memory[<span class="hljs-number">1</span>]{value};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    putToStack(<span class="hljs-number">20</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">55</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">0xfe</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">11</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
      -O0,         memory.          ,    .<br>
<br>
   memory      ,   —       ,    ,   .<br>
<br>
   , ..        ,      —   putToStack     .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble être arrivé: il est possible de modifier la sortie de la fonction bad (), et seul le bit de poids faible est pris en compte.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusion de l'exemple 1a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple a permis de vérifier la bonne interprétation des listes de démonteurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple 1b - bool cassé</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, vous y pensez, "41" sera affiché dans la console au lieu de "1" ... Est-ce dangereux? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons vérifier deux compilateurs qui fournissent un octet entier de déchets.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> badBool1 = bad();
    <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 35 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , vrai, faux} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un comportement indéfini a conduit à l'apparition d'une variable booléenne qui rompt au moins:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opérateurs de comparaison pour les valeurs booléennes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonction de hachage de la valeur booléenne.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">213</span>;
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
  ch = <span class="hljs-number">137</span>;
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , vrai, faux} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le travail avec une variable booléenne corrompue n'a pas changé lorsque l'optimisation a été activée.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
  <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  goodChar(<span class="hljs-number">213</span>);
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
<font></font>
  goodChar(<span class="hljs-number">137</span>);
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sortie vers la console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , vrai, faux} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font><br>
</b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport à MSVC, gcc a également ajouté l'opération incorrecte de l'opérateur not.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusion de l'exemple 1b</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interruption des opérations de base avec des valeurs booléennes peut avoir de graves conséquences pour la logique de haut niveau. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi est-ce arrivé? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parce que certaines opérations avec des variables booléennes sont implémentées en supposant que true est strictement une unité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'aborderons pas cette question dans le démonteur - l'article s'est avéré volumineux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, nous allons clarifier le tableau avec le comportement des compilateurs:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retour du programme</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie console</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cause</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conséquences de l'utilisation du résultat de bad ()</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La sortie de la console et l'appel à la fonction bad () ont été lancés à la suite de l'optimisation</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets du registre al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violation du travail: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
non; </font><font style="vertical-align: inherit;">==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hachage.</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aucune sortie</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La sortie de la console et l'appel à la fonction bad () ont été lancés à la suite de l'optimisation</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang version 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu de déchets de la RAM</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appel de fonction bad () remplacé par zéro</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemple d'origine</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de construction</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Exemple compliqué</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets du registre al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violation du travail: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hachage.</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un octet de déchets de la RAM</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violation du travail: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hachage.</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quatre compilateurs ont donné 7 manifestations différentes d'un comportement indéfini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple 2 - struct</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons un exemple un peu plus compliqué:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La structure de test nécessite un seul paramètre de type int pour être construit. </font><font style="vertical-align: inherit;">Les messages de diagnostic sont émis par son constructeur et son destructeur. </font><font style="vertical-align: inherit;">La fonction bad (int) a deux chemins d'exécution valides, dont aucun ne sera implémenté dans un seul appel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fois - d'abord le tableau, puis l'analyse du désassembleur sur les points obscurs.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimisation</font></font></b></td>
<td><b>Program return</b></td>
<td><b>Console output</b></td>
<td><b></b></td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 Clang 10.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>255</td>
<td>rnd: 1804289383</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 gcc 9.3</b></td>
</tr>
<tr>
<td>-O0</td>
<td>0</td>
<td>rnd: 1804289383<br>
4198608<br>
Test::~Test()</td>
<td>nop       .<br>
value    .</td>
</tr>
<tr>
<td>-O1, -O2, -O3</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>macOs X Apple clang version 11.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>The program has unexpectedly finished.</td>
<td>rnd: 16807</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 16807<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Windows MSVC 2019 16.5.4</b></td>
</tr>
<tr>
<td>/Od /RTCs</td>
<td>Access violation reading location 0x00000000CCCCCCCC</td>
<td>rnd: 41</td>
<td>  MSVC stack frame run-time error checking</td>
</tr>
<tr>
<td>/Od, /O1, /O2</td>
<td>0</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791061810776 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ordures provenant d'un emplacement mémoire dont l'adresse est en rax</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, nous voyons de nombreuses options: en plus de l'ud2 déjà connu, il existe au moins 4 comportements différents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La manipulation du compilateur avec un constructeur est très intéressante:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans certains cas, l'exécution s'est poursuivie sans appeler le constructeur - dans ce cas, l'objet était dans un état aléatoire;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans d'autres cas, un appel constructeur n'a pas été prévu sur le chemin d'exécution, ce qui est plutôt étrange.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/z7/cq/ry/z7cqry23rk0ul156zrdhnedehl0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une seule comparaison est faite dans le code (ligne 14), et il n'y a qu'un seul saut conditionnel (ligne 15). </font><font style="vertical-align: inherit;">Le compilateur a ignoré la deuxième comparaison et le deuxième saut conditionnel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela conduit à la suspicion qu'un comportement indéfini a commencé plus tôt que la norme ne le prescrit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la vérification de la condition du second ne contient aucun effet secondaire et la logique du compilateur a fonctionné comme suit:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la deuxième condition est vraie - vous devez appeler le constructeur Test avec l'argument 142;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la deuxième condition n'est pas vraie, la fonction se fermera sans retourner de valeur, ce qui signifie un comportement indéfini dans lequel le compilateur peut faire n'importe quoi. </font><font style="vertical-align: inherit;">Y compris - appeler le même constructeur avec le même argument;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la vérification est superflue; le constructeur Test avec l'argument 142 peut être appelé sans vérifier la condition.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qui se passe si la deuxième vérification contient une condition avec des effets secondaires:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<img src="https://habrastorage.org/webt/j5/mi/-w/j5mi-w148l3tnejie9aaxus5nr8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compilateur a honnêtement reproduit tous les effets secondaires voulus en appelant rand () (ligne 16), dissipant ainsi les doutes sur le début incorrectement précoce d'un comportement non défini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'option / RTCs permet de vérifier les erreurs d'exécution du cadre de pile. Cette option est disponible uniquement dans l'assembly de débogage. Considérez le code désassemblé de la section main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/sr/4y/klsr4ygrimmzxwbwuqtvfd3xvmy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
avant d'appeler bad (int) (ligne 4), les arguments sont préparés - la valeur de la variable rnd est copiée dans le registre edx (ligne 2) et l'adresse effective d'une variable locale située à l'adresse est chargée dans le registre rcx rsp + 28h (ligne 3). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vraisemblablement, rsp + 28 est l'adresse d'une variable temporaire qui stocke le résultat de l'appel de bad (int). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette hypothèse est confirmée par les lignes 19 et 20 - l'adresse effective de la même variable est chargée dans rcx, après quoi le destructeur est appelé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, dans l'intervalle des lignes 4 à 18, cette variable n'est pas accessible, malgré la sortie de la valeur de son champ de données à diffuser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons vu dans les listes MSVC précédentes, l'argument de l'opérateur de sortie de flux doit être attendu dans le registre rdx. </font><font style="vertical-align: inherit;">Le registre rdx obtient le résultat du déréférencement de l'adresse située dans rax (ligne 9). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le code appelant attend de mauvais (int):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remplir une variable dont l'adresse est passée par le registre rcx (ici on voit RVO en action);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoyer l'adresse de cette variable via le registre rax.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons à la liste des mauvais (int):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c3/vm/-x/c3vm-xwuhghbvtp6byyqwf6l6xg.png" alt="image"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans eax, la valeur 0xCCCCCCCC est entrée, ce que nous avons vu dans le message de violation d'accès (ligne 9) (notez qu'il ne s'agit que de 4 octets, tandis que dans le message AccessViolation, l'adresse se compose de 8 octets);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la commande rep stos est appelée, exécutant des cycles 0xC d'écriture du contenu de eax dans la mémoire à partir de l'adresse rdi (ligne 10). </font><font style="vertical-align: inherit;">Ce sont 48 octets - exactement autant que ce qui est alloué sur la pile de la ligne 6;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur les bons chemins d'exécution, la valeur de rsp + 40h est entrée dans rax (lignes 23, 36);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la valeur du registre rcx (par laquelle main () a transmis l'adresse de destination) est poussée sur la pile à rsp + 8 (ligne 4);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdi est poussé sur la pile, ce qui réduit rsp de 8 (ligne 5);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30h octets sont alloués sur la pile en diminuant rsp (ligne 6).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc rsp + 8 à la ligne 4 et rsp + 40h dans le reste du code ont la même valeur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code est assez déroutant car </font><font style="vertical-align: inherit;">il n'utilise pas rbp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a deux accidents dans le message de violation d'accès:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zéros dans la partie supérieure de l'adresse - il pourrait y avoir des ordures;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'adresse s'est avérée accidentellement incorrecte.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparemment, l'option / RTCs permettait d'écraser la pile avec certaines valeurs non nulles, et le message de violation d'accès n'était qu'un effet secondaire aléatoire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment le code avec l'option / RTCs activée diffère du code sans lui. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ai/gh/r4aighkarr9kdcerpk60u6jvdya.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code des sections de main () ne diffère que par les adresses des variables locales sur la pile. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/oi/zt/kqoizt0khccfqovtmw6qn_--xiq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(pour plus de clarté, j'ai placé deux versions de la mauvaise fonction (int) à côté d'elle - avec / RTC et sans) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sans les / RTC, l'instruction rep stos a disparu et prépare des arguments pour elle au début de la fonction.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple 2a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, essayez de contrôler le comportement indéfini. </font><font style="vertical-align: inherit;">Cette fois pour un seul compilateur.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'option / RTCs, le compilateur insère au début du mauvais code de fonction (int) qui remplit la moitié inférieure de rax avec une valeur fixe, ce qui peut entraîner une violation d'accès. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour changer ce comportement, remplissez simplement rax avec une adresse valide. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci peut être réalisé avec une modification très simple: ajoutez la sortie de quelque chose à std :: cout au mauvais corps (int).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de code complet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; v &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791039331928 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'opérateur &lt;&lt; renvoie un lien vers le flux, qui est implémenté en plaçant l'adresse std :: cout dans rax. </font><font style="vertical-align: inherit;">L'adresse est correcte, elle peut être déréférencée. </font><font style="vertical-align: inherit;">La violation d'accès est empêchée.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant les exemples les plus simples, nous avons pu:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recueillir environ 10 manifestations différentes d'un comportement indéfini;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> découvrez en détail comment ces options seront exécutées.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les compilateurs ont démontré une stricte adhésion à la norme - en aucun cas le comportement indéfini n'a commencé plus tôt. </font><font style="vertical-align: inherit;">Mais vous ne pouvez pas refuser un fantasme aux développeurs de compilateurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Souvent, la manifestation dépend de nuances subtiles: il vaut la peine d'ajouter ou de supprimer une ligne de code apparemment non pertinente - et le comportement du programme change considérablement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute évidence, il est plus facile de ne pas écrire un tel code que de résoudre des énigmes plus tard.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499008/index.html">Pourquoi les développeurs sont si lents: problèmes courants et leurs solutions</a></li>
<li><a href="../fr499010/index.html">Nous étudions le moteur VoIP Mediastreamer2. Partie 11</a></li>
<li><a href="../fr499014/index.html">23 questions difficiles pour les interviews JavaScript</a></li>
<li><a href="../fr499016/index.html">Intégration avec ESIA pour .Net: plus simple qu'il n'y paraît</a></li>
<li><a href="../fr499018/index.html">6 applications de sport à domicile</a></li>
<li><a href="../fr499030/index.html">Surveillance des performances de MySQL pour Grafana sur isic en 20 minutes</a></li>
<li><a href="../fr499032/index.html">Comment utiliser Prometheus pour détecter des anomalies dans GitLab</a></li>
<li><a href="../fr499034/index.html">Comment déployer un refactoring dangereux pour produire avec un million d'utilisateurs?</a></li>
<li><a href="../fr499036/index.html">Travail du prestataire: une sélection de supports sur les protocoles, les infrastructures informatiques et réseau</a></li>
<li><a href="../fr499038/index.html">Mon expérience avec un moniteur vertical</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>