<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµ üë®üèº‚Äçüè≠ ‚ô¶Ô∏è Macros para um pythonist. Relat√≥rio Yandex üÜó ‚úçüèº üå°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como posso estender a sintaxe do Python e adicionar os recursos necess√°rios? No ver√£o passado, na PyCon, tentei entender esse t√≥pico. No relat√≥rio, vo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Macros para um pythonist. Relat√≥rio Yandex</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/495294/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como posso estender a sintaxe do Python e adicionar os recursos necess√°rios? </font><font style="vertical-align: inherit;">No ver√£o passado, na PyCon, tentei entender esse t√≥pico. </font><font style="vertical-align: inherit;">No relat√≥rio, voc√™ pode descobrir como as bibliotecas pytest, macropy e padr√µes s√£o organizadas e como elas alcan√ßam resultados t√£o interessantes. </font><font style="vertical-align: inherit;">No final, h√° um exemplo de gera√ß√£o de c√≥digo usando macros no HyLang, uma linguagem semelhante ao Lisp executando no Python.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IMkvg45Vw70" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Oi pessoal. </font><font style="vertical-align: inherit;">Antes de tudo, quero agradecer aos organizadores da PyCon. </font><font style="vertical-align: inherit;">Sou desenvolvedor da Yandex. </font><font style="vertical-align: inherit;">O relat√≥rio n√£o ser√° sobre trabalho, mas sobre coisas experimentais. </font><font style="vertical-align: inherit;">Talvez eles levem um de voc√™s √† id√©ia de que, em Python, voc√™ pode fazer coisas legais que voc√™ nem sabia antes, que n√£o pensavam nessa dire√ß√£o.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pouco para quem n√£o est√° ciente do que s√£o macros: esse √© um m√©todo de gera√ß√£o de c√≥digo quando alguma express√£o na linguagem √© expandida para um c√≥digo mais complexo. </font><font style="vertical-align: inherit;">Quais s√£o os presentes para voc√™? </font><font style="vertical-align: inherit;">Para voc√™, o registro macro √© conciso, expressa alguma abstra√ß√£o, mas faz muito trabalho para voc√™ e voc√™ n√£o precisa escrever todo esse c√≥digo com as m√£os.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pytest</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provavelmente, voc√™ se deparou com uma estrutura de teste pytest, muitos aqui quase certamente a usam. Eu n√£o sei se voc√™ j√° reparou, mas sob o cap√¥ ele tamb√©m faz alguma m√°gica. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/al/o6/qv/alo6qvpzofmabtejvqqojenx31a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, voc√™ tem um teste t√£o simples. Se voc√™ execut√°-lo sem pytest, ele lan√ßar√° um AssertionError simplesmente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ih/an/ck/ihanckzzqzelb5o87nfx9olt2vw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, meu exemplo √© um pouco degenerado, e aqui √© imediatamente √≥bvio que len √© retirado de uma lista de tr√™s elementos. Mas se alguma fun√ß√£o fosse chamada, voc√™ nunca saberia de um AssertionError que a fun√ß√£o retornou. Ela retornou apenas algo que n√£o √© igual a cem. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/ko/sa/cukosarqifegg5uvzo14xneczkc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, se isso for executado no pytest, ele exibir√° informa√ß√µes adicionais de depura√ß√£o. Como ele faz isso por dentro?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/g9/vr/6hg9vr5nedvvkvzxlsupjqor71a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa m√°gica funciona de maneira muito simples. O Pytest cria seu pr√≥prio gancho especial que √© acionado quando o m√≥dulo com o teste √© carregado. Depois disso, o pytest analisa independentemente esse arquivo Python e, como resultado da an√°lise, √© obtida sua representa√ß√£o intermedi√°ria, denominada √°rvore AST. A √°rvore AST √© um conceito b√°sico que permite alterar o c√≥digo Python rapidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de receber essa √°rvore, o pytest imp√µe uma transforma√ß√£o nela, que procura todas as express√µes chamadas assert. Ele as altera de uma certa maneira, compila a nova √°rvore AST resultante e obt√©m um m√≥dulo com testes, que s√£o executados em uma m√°quina virtual Python comum.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t3/fj/x-/t3fjx-trld3abinbaqxioiizptg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a √°rvore AST original n√£o convertida em pytest se parece. </font><font style="vertical-align: inherit;">A √°rea vermelha destacada √© a nossa afirma√ß√£o. </font><font style="vertical-align: inherit;">Se voc√™ olhar atentamente, ver√° as partes esquerda e direita, a pr√≥pria lista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o pytest converte isso e gera um novo ano, a √°rvore come√ßa a ficar assim. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/xh/qb/yvxhqbjsokha_vdwfn9-ksm0isi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem cerca de cem linhas de c√≥digo que o pytest gerou para voc√™. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/fc/zi/cufczioilng0zfzx05nbrtwgl8g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ converter essa √°rvore AST novamente em Python, ser√° algo parecido com isto. </font><font style="vertical-align: inherit;">As √°reas destacadas em vermelho aqui s√£o onde pytest calcula as partes esquerda e direita da express√£o, gera uma mensagem de erro e gera um AssertionError se algo der errado com essa mensagem de erro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correspond√™ncia de padr√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que mais voc√™ pode fazer com uma coisa dessas? Voc√™ pode converter qualquer c√≥digo Python. E h√° uma biblioteca maravilhosa que eu encontrei por acidente no PyPI, √© interessante cavar l√°. Ela faz a correspond√™ncia de padr√µes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez esse c√≥digo seja familiar para algu√©m. Ele considera fatorial recursivamente. Vamos ver como ele pode ser gravado usando a correspond√™ncia de padr√µes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, basta pendurar o decorador na fun√ß√£o. Aten√ß√£o: dentro do corpo, a fun√ß√£o j√° funciona de maneira diferente. Cada um desses ifs √© uma regra para correspond√™ncia de padr√µes, que analisa a express√£o que √© inserida na fun√ß√£o e a transforma de alguma forma. Al√©m disso, n√£o h√° retornos expl√≠citos do resultado. Como a biblioteca de padr√µes, quando transforma o corpo da fun√ß√£o, verifica primeiro se ela cont√©m apenas se, e segundo, adiciona retornos impl√≠citos do resultado, alterando assim a sem√¢ntica da linguagem. Ou seja, ela cria uma nova DSL, que funciona um pouco diferente. E, gra√ßas a isso, voc√™ pode escrever algumas coisas declarativamente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o anterior √© como se estivesse escrita em tr√™s linhas.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/pj/fm/ux/pjfmuxf4zsl_zpppzidv9oirkim.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o restante das linhas adiciona funcionalidade adicional que permite, por exemplo, ler fatorial de uma lista de valores ou pass√°-lo por uma fun√ß√£o arbitr√°ria. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como escrever convers√µes voc√™ mesmo? </font><font style="vertical-align: inherit;">macropy!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ provavelmente est√° se perguntando, mas como pode aplic√°-lo voc√™ mesmo? Como √© tedioso, como pytest: analisar manualmente os arquivos, procure o c√≥digo que precisa ser convertido. No pytest, isso √© feito por um m√≥dulo separado para mil ou mais linhas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para n√£o fazer isso por conta pr√≥pria, alguns caras inteligentes j√° criaram um m√≥dulo para n√≥s chamado macropy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta vers√£o do m√≥dulo √© para o segundo Python e o terceiro. Eles escreveram de volta no tempo do segundo Python. Ent√£o os caras fizeram uma piada para descobrir o que pode ser feito com o Python, e a biblioteca inclui v√°rios exemplos. Vamos olhar para eles, eles v√£o te dar uma id√©ia do que voc√™ pode fazer com esta t√©cnica. A primeira coisa interessante que eles descreveram no tutorial √© uma macro que implementa seq√º√™ncias de formato para o segundo Python, como no terceiro.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/3h/vv/er3hvvz7g-0edq1spxz5bukrk3q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A express√£o destacada em vermelho √© apenas a sintaxe da chamada de macro. A letra S √© o nome da macro e, entre colchetes, √© a express√£o que ela converte. Como resultado, as vari√°veis ‚Äã‚Äãs√£o substitu√≠das aqui. Isso funciona no segundo Python, mas o terceiro n√£o √© mais necess√°rio em uma macro. Assim, por exemplo, voc√™ pode criar sua pr√≥pria macro, que implementa sem√¢nticas mais complexas e faz coisas mais divertidas do que as seq√º√™ncias de formato padr√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jw/bf/hx/jwbfhxtuxzzrbjd-vvu3rhdsok8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando uma macro se expande, e isso acontece no momento do carregamento do m√≥dulo, ela simplesmente se converte nesse c√≥digo. Os espa√ßos reservados s√£o inseridos na cadeia de formata√ß√£o e o procedimento de substitui√ß√£o √© aplicado a ela. Al√©m disso, o Python, de maneira padr√£o, j√° compila tudo isso. No tempo de execu√ß√£o, nenhuma expans√£o de macro ocorre. Todos eles ocorrem quando o m√≥dulo √© carregado. Portanto, √© poss√≠vel fazer otimiza√ß√µes ou c√°lculos que ocorrer√£o no momento do carregamento do m√≥dulo e gerar um bytecode mais ideal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2i/gz/9t/2igz9tsitqjebyuxpln51mhknra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo exemplo tamb√©m √© interessante. Esta √© uma nota√ß√£o abreviada para escrever lambdas. A macro f pega uma s√©rie de argumentos e retorna uma fun√ß√£o. Cada express√£o que come√ßa com o nome da macro ‚Äúf‚Äù, colchetes e, em seguida, absolutamente qualquer express√£o √© convertida em um lambda.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l5/vq/ym/l5vqym-i-69vtjohomf2nsxfsj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na minha opini√£o, isso tamb√©m √© legal, especialmente para quem gosta de desenvolver e escrever c√≥digo em um estilo funcional e usar o MapReduce. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0j/fx/xc/0jfxxcdmblyze8e4bcxqrqrgaoy.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° outro exemplo familiar. Esta fun√ß√£o considera fatorial, o c√≥digo √© destacado em vermelho. O que acontecer√° quando ela for chamada? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/gj/v0/ovgjv0vqgcbzx0wxy5q-kuvozzg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ir√° gerar um erro no Python, porque ser√° executado no limite da pilha e haver√° um RecursionError t√£o feio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/zz/1h/wizz1haarmzw9is0q0k3n_r6mji.jpeg" width="600"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como isso pode ser consertado? Usando macropy, corrigir o problema √© muito simples. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/ej/-n/wcej-na40treik2p0hkdp1jfbns.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pendura o decorador, pega o corpo da fun√ß√£o e a transforma de alguma maneira m√°gica. Voc√™ n√£o precisa alterar nada na fun√ß√£o em si, a macropy far√° tudo por voc√™. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/c8/ld/xcc8ldcmcykmbaxjceek4xsgrka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E a fun√ß√£o retornar√° a si mesma um resultado bastante normal, indo muito para o subterr√¢neo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ek/uq/mi/ekuqmigu-x5hhmdyyy8q04wob5c.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como √© a macropia?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fz/1r/5f/fz1r5ff8_v-egywcvufzvw-zsec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele substitui todas as chamadas para a pr√≥pria fun√ß√£o por um objeto TailCall especial, que √© chamado em um loop pelo decorador TCO. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dg/25/5b/dg255bb2t_mzo9ku4ucwq-uz31o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O circuito se parece com isso. O decorador no loop chama a fun√ß√£o at√© retornar algum resultado normal em vez de TailCall. E se ela voltou, ent√£o devolve. E isso √© tudo. Essas coisas legais podem ser feitas com macros! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Macropy tamb√©m inclui outros exemplos. Espero que aqueles que t√™m curiosidade de voc√™ os vejam sozinhos. Digamos que h√° coisas √∫teis para depura√ß√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/hg/rq/wdhgrqonz6lfdcicgdynvnfipfs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou falar sobre outra coisa legal. Um exemplo √© essa macro de consulta. O que ele est√° fazendo? Dentro dele, voc√™ escreve c√≥digo Python regular, que pode ser usado como resultado regular da execu√ß√£o dessa express√£o. Mas por dentro, a macropy transforma esse c√≥digo e o transforma no c√≥digo da linguagem de consulta SQL Alchemy. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/qb/jk/agqbjkyzfbun_tbdnjxww5lutms.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele reescreve para voc√™, faz essa express√£o terr√≠vel. Pode ser reescrito √† m√£o, depois ser√° mais curto. Eu fiz isso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4k/ts/5w/4kts5wogftqmpcceukufkib56be.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° a express√£o original. Depois de expandir a macro, assume algo parecido com isto. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/i0/uv/dui0uvfpouzuuioj2tmirtfyg5c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez algu√©m esteja interessado em escrever c√≥digo mais parecido com o Python, e n√£o for√ßar seus desenvolvedores a escrever consultas no DSL SQL Alchemy.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da mesma maneira, voc√™ pode gerar qualquer coisa a partir do Python - SQL puro, JavaScript - e salv√°-lo em algum lugar pr√≥ximo ao arquivo e, em seguida, us√°-lo no frontend. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kk/s3/j3/kks3j3s2wwep0vejhof8-3fw-oq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos ver como fazer sua pr√≥pria macro. Com macropy, √© muito simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma macro √© uma fun√ß√£o que pega uma √°rvore AST na entrada e, de alguma forma, a transforma, retorna uma nova. Aqui est√° um exemplo de macro que adiciona uma descri√ß√£o √† chamada de declara√ß√£o que cont√©m a express√£o de origem, para que possamos entender por que ocorreu o erro AssertionError. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, a fun√ß√£o replace_assert interna √© auxiliar. Ela faz uma descida recursiva em uma √°rvore para voc√™. Dentro do replace_assert, o elemento da sub√°rvore √© passado.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3u/qn/wa/3uqnwavrca79l0wumgmnfxfcm58.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devido a isso, voc√™ pode verificar seu tipo e? se for uma chamada de afirma√ß√£o, fa√ßa algo com ela. Aqui darei um exemplo sint√©tico simples que pega a parte esquerda, a parte direita, envia uma mensagem de erro e grava tudo no atributo msg. Esta √© a mensagem que precisar√° ser retornada. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rf/re/hn/rfrehnypphthxdzqbjwehtj3fas.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/va/ak/jm/vaakjmq4tpgqjwttqmi8nepgtym.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/x7/hq/cs/x7hqcswjuj59uhp5thatiojofja.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao us√°-lo, voc√™ anexa essa macro a um bloco de c√≥digo usando o gerenciador de contexto with, e todo o c√≥digo que entra no gerenciador de contexto passa por essa transforma√ß√£o. √â visto abaixo que nossa mensagem de erro foi adicionada ao AssertionError, que formamos a partir da express√£o len ([1, 2, 3]).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yo/zo/zc/yozozclanvtdlinutuvnl58puve.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, este m√©todo tem uma limita√ß√£o que me deixa pessoalmente triste. </font><font style="vertical-align: inherit;">Tentei, como experimento, criar novos designs que funcionem na linguagem. </font><font style="vertical-align: inherit;">Por exemplo, algumas pessoas gostam de switch ou constru√ß√µes condicionais como a menos que. </font><font style="vertical-align: inherit;">Infelizmente, isso n√£o √© poss√≠vel: a macropia e outras ferramentas que funcionam com a √°rvore AST s√£o usadas quando o c√≥digo-fonte j√° est√° lido e dividido em tokens. </font><font style="vertical-align: inherit;">O c√≥digo √© lido pelo analisador Python, cuja gram√°tica √© fixada no int√©rprete. </font><font style="vertical-align: inherit;">Para alter√°-lo, voc√™ precisa recompilar o Python. </font><font style="vertical-align: inherit;">Obviamente, voc√™ pode fazer isso, mas j√° ser√° um fork do Python, e n√£o uma biblioteca que pode ser definida no PyPI. </font><font style="vertical-align: inherit;">Portanto, √© imposs√≠vel criar esses desenhos usando macropy.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, durante toda a minha vida, escrevi n√£o apenas em Python e estava interessado em v√°rias outras linguagens alternativas. H√° uma sintaxe que muitos n√£o gostam, mas mais simples e flex√≠vel. Essas s√£o express√µes s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente para n√≥s, existe um suplemento Python chamado HyLang. Isso lembra um pouco o Clojure, apenas o Clojure √© executado em cima da JVM e o HyLang √© executado em cima da M√°quina Virtual Python. Ou seja, ele fornece uma nova sintaxe para escrever c√≥digo. Mas, ao mesmo tempo, todo o c√≥digo que voc√™ escrever ser√° totalmente compat√≠vel com as bibliotecas Python existentes e poder√° ser usado nas bibliotecas Python. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/54/sc/rr/54scrrucaeden67utnbyx3jva0i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece algo assim.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/vr/w7/qovrw7a-mivofegxjhx61jtlky0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A parte √† esquerda escrita em Python, √† direita - no HyLang. E de baixo para os dois existe um bytecode, que √© o resultado. Voc√™ provavelmente notou que √© exatamente o mesmo, apenas a sintaxe muda. Express√µes HyLang, das quais muitos n√£o gostam. Os opositores dos "colchetes" n√£o entendem que essa sintaxe confere ao idioma um tremendo poder, pois uniformiza as constru√ß√µes do idioma. E a uniformidade permite usar macros para implementar qualquer design. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© alcan√ßado devido ao fato de que dentro de cada express√£o o primeiro elemento √© sempre algum tipo de a√ß√£o. E ent√£o seus argumentos v√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E todo o c√≥digo √© composto de express√µes aninhadas que s√£o f√°ceis de converter e abrir macros l√°. Devido a isso, absolutamente nenhuma constru√ß√£o pode ser feita no HyLang, nova, de forma alguma indistingu√≠vel no c√≥digo dos recursos padr√£o da linguagem. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/-u/rw/o5-urwww9tzewkt4ufq7krycxj8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como uma macro simples funciona no HyLang. Para fazer o mesmo que fizemos com o Assert usando macropy, voc√™ s√≥ precisa deste c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossa macro HyLang recebe entrada, que √© c√≥digo. Al√©m disso, uma macro pode facilmente usar qualquer parte desse c√≥digo para criar um novo c√≥digo. A principal diferen√ßa entre macros e fun√ß√µes: express√µes s√£o de entrada, n√£o de valores. Se chamarmos nossa macro como (√© (= 1 2)), ela receber√° uma express√£o (= 1 2) em vez de Falso.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uc/5b/az/uc5bazq37xtwjlsbaf54_kpe8zu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que possamos gerar uma mensagem de erro informando que algo deu errado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hn/a9/cm/hna9cmzwxvf87k5e4i0py87cs84.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o basta retornar o novo c√≥digo. Essa sintaxe backtick e til significa algo como o seguinte. A cita√ß√£o anterior diz: pegue esta express√£o como est√° e retorne como est√°. E o til diz: substitua o valor da vari√°vel aqui. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/qn/en/piqnenjm28v8jm0i-hfsdx3ib18.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, quando escrevemos isso, a macro ap√≥s a expans√£o retornar√° para n√≥s uma nova express√£o, que ser√° assim afirmada com uma mensagem de erro adicional.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HyLang √© uma coisa legal. </font><font style="vertical-align: inherit;">√â verdade que enquanto n√£o o usamos. </font><font style="vertical-align: inherit;">Talvez n√≥s nunca iremos. </font><font style="vertical-align: inherit;">Todos esses itens s√£o experimentais. </font><font style="vertical-align: inherit;">Quero que voc√™ saia daqui com a sensa√ß√£o de que, em Python, voc√™ pode fazer algumas coisas que talvez nem tenha pensado antes. </font><font style="vertical-align: inherit;">E talvez alguns deles encontrem aplica√ß√£o pr√°tica em seu trabalho cont√≠nuo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© tudo para mim. </font><font style="vertical-align: inherit;">Voc√™ pode ver os links:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Padr√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacroPy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O livro OnLisp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para um estudo avan√ßado dos recursos das macros. </font><font style="vertical-align: inherit;">Isto √© para aqueles especialmente interessados. </font><font style="vertical-align: inherit;">√â verdade que o livro n√£o √© inteiramente baseado em Python, mas em Common Lisp. </font><font style="vertical-align: inherit;">Mas, para um estudo mais aprofundado, isso ser√° at√© interessante.</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495278/index.html">Bancos de dados, cart√µes, listas de verifica√ß√£o ou Por que um gerente de conhecimento comercial</a></li>
<li><a href="../pt495280/index.html">Patrulha m√°xima SIEM. Vis√£o geral do sistema de gerenciamento de eventos de seguran√ßa da informa√ß√£o</a></li>
<li><a href="../pt495282/index.html">Valida√ß√£o de XML usando XSD, JAXB e Spring Framework</a></li>
<li><a href="../pt495290/index.html">Explorando a qualidade do c√≥digo do sistema operacional Zephyr</a></li>
<li><a href="../pt495292/index.html">Vers√£o InterSystems IRIS 2020.1</a></li>
<li><a href="../pt495296/index.html">Forense, inje√ß√£o de SQL e gato sofredor: an√°lise da tarefa n¬∫ 3 do est√°gio online NeoQUEST-2020</a></li>
<li><a href="../pt495298/index.html">Avalie as op√ß√µes de Monte Carlo Clojure</a></li>
<li><a href="../pt495302/index.html">Como aumentar as vendas 2,5 vezes em 4 meses em uma loja online - um caso de promo√ß√£o de SEO</a></li>
<li><a href="../pt495304/index.html">Rejuvenescimento das c√©lulas humanas devido √† sua reprograma√ß√£o</a></li>
<li><a href="../pt495308/index.html">Rake no caminho para se manter vivo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>