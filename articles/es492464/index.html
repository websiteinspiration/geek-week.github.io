<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìó üôèüèø üë®üèΩ‚Äç‚öñÔ∏è DBA: organice de manera competente la sincronizaci√≥n y las importaciones ‚å®Ô∏è üî¥ ‚úãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Con el procesamiento complejo de grandes conjuntos de datos (diferentes procesos ETL : importaciones, conversiones y sincronizaci√≥n con una fuente ext...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: organice de manera competente la sincronizaci√≥n y las importaciones</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con el procesamiento complejo de grandes conjuntos de datos (diferentes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procesos ETL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : importaciones, conversiones y sincronizaci√≥n con una fuente externa), a menudo es necesario </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"recordar" temporalmente y procesar inmediatamente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algo voluminoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una tarea t√≠pica de este tipo generalmente suena as√≠: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Aqu√≠ el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">departamento de contabilidad carg√≥ los</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √∫ltimos pagos recibidos </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">del banco del cliente</font></a><font style="vertical-align: inherit;"> , necesitamos subirlos r√°pidamente al sitio web y vincularlos a las cuentas".</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pero cuando el volumen de este "algo" comienza a medirse en cientos de megabytes, y el servicio Esto deber√≠a seguir funcionando con la base en modo 24x7, hay muchos efectos secundarios que arruinar√°n tu vida.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer frente a ellos en PostgreSQL (y no solo en √©l), puede usar algunas opciones de optimizaci√≥n que le permitir√°n procesar m√°s r√°pido y con menos recursos.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. ¬øD√≥nde enviar?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, decidamos d√≥nde podemos cargar los datos que queremos "procesar".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Tablas temporales (TABLA TEMPORAL)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principio, para PostgreSQL, las temporales son las mismas tablas que cualquier otra. </font><font style="vertical-align: inherit;">Por lo tanto, las supersticiones como </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"todo se almacena all√≠ solo en la memoria, pero puede terminar"</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son incorrectas </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pero hay varias diferencias significativas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espacio de nombres propio para cada conexi√≥n a la base de datos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si dos conexiones intentan hacer al mismo tiempo </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces alguien definitivamente obtendr√° un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objetos DB </font><b><font style="vertical-align: inherit;">no √∫nicos</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero si ambos intentan ejecutarse </font><font style="vertical-align: inherit;">, ambos lo har√°n normalmente y cada uno recibir√° </font><b><font style="vertical-align: inherit;">su propia copia de la</font></b><font style="vertical-align: inherit;"> tabla. </font><font style="vertical-align: inherit;">Y no habr√° nada en com√∫n entre ellos.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Autodestrucci√≥n" con desconexi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando cierra la conexi√≥n, todas las tablas temporales se eliminan autom√°ticamente, por lo que </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no tiene sentido </font><font style="vertical-align: inherit;">ejecutarlas "manualmente" </font><font style="vertical-align: inherit;">, excepto ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si trabaja a trav√©s de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en modo de transacci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la base de datos contin√∫a asumiendo que esta conexi√≥n todav√≠a est√° activa y La mesa todav√≠a existe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, un intento de recrearlo, desde otra conexi√≥n a pgbouncer, dar√° como resultado un error. </font><font style="vertical-align: inherit;">Pero esto se puede evitar aprovechando </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Es cierto que es mejor no hacerlo de todos modos, porque entonces puede "de repente" descubrir los datos que dej√≥ el "propietario anterior" all√≠. </font><font style="vertical-align: inherit;">En cambio, es mucho mejor leer el manual y ver que al crear la tabla hay una oportunidad para agregar</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - es decir, cuando se complete la transacci√≥n, la tabla se eliminar√° autom√°ticamente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No replicaci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debido a que solo pertenece una combinaci√≥n particular, las tablas temporales no se replican. </font><font style="vertical-align: inherit;">Pero </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esto elimina la necesidad de escribir dos veces datos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el mont√≥n + WAL, por lo que INSERT / UPDATE / DELETE es mucho m√°s r√°pido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero como la tabla temporal sigue siendo una tabla "casi normal", tampoco se puede crear en la r√©plica. </font><font style="vertical-align: inherit;">Al menos por ahora, aunque el parche correspondiente ha existido durante mucho tiempo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Tablas no registradas (TABLA DESBLOQUEADA)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øqu√© hacer, por ejemplo, si tiene alg√∫n tipo de proceso ETL engorroso que no se puede implementar dentro de una sola transacci√≥n, y todav√≠a tiene </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en modo de transacci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? ... ¬ø </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O el flujo de datos es tan grande que no hay </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suficiente ancho de banda por conexi√≥n?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la base de datos (lectura, un proceso en la CPU) ... ¬ø </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O parte de las operaciones se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realizan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><b><font style="vertical-align: inherit;">forma as√≠ncrona</font></b><font style="vertical-align: inherit;"> en diferentes conexiones? ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay una opci√≥n: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crear temporalmente una tabla no temporal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Juego de palabras, s√≠. </font><font style="vertical-align: inherit;">Es decir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cre√≥ "sus" tablas con nombres m√°ximamente aleatorios para no cruzarse con nadie</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extracto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : verti√≥ datos de una fuente externa en ellos</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : transformado, rellenado en campos de enlace clave</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : verti√≥ datos terminados en tablas de destino</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tablas "my" eliminadas</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora, una mosca en la pomada. </font><font style="vertical-align: inherit;">De hecho, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toda la escritura en PostgreSQL ocurre dos veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primero en el WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , luego en el cuerpo de la tabla / √≠ndice. </font><font style="vertical-align: inherit;">Todo esto se hace para admitir ACID y la visibilidad correcta de los datos entre </font><font style="vertical-align: inherit;">transacciones </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anidadas y </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anidadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Pero no necesitamos esto! </font><font style="vertical-align: inherit;">Tenemos todo el proceso </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o pasamos con √©xito, o no</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No importa cu√°ntas transacciones intermedias contenga, no estamos interesados ‚Äã‚Äãen "continuar el proceso desde el medio", especialmente cuando no est√° claro d√≥nde estaba. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, los desarrolladores de PostgreSQL introdujeron la versi√≥n 9.1, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">las tablas sin registro (UNLOGGED)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En resumen, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° mucho m√°s r√°pido</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero si el servidor de la base de datos "falla", ser√° desagradable. </font><font style="vertical-align: inherit;">Pero, ¬øcon qu√© frecuencia sucede esto y su proceso ETL sabe c√≥mo modificarlo correctamente "desde el medio" despu√©s de la "revitalizaci√≥n" de la base de datos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no es as√≠, y el caso anterior es similar al suyo, use </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero nunca </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incluya este atributo en tablas reales</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos de los que eres querido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">EN COMPROMISO {BORRAR FILAS | </font><font style="vertical-align: inherit;">SOLTAR}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este dise√±o permite al crear una tabla establecer un comportamiento autom√°tico cuando finaliza la transacci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre lo </font><font style="vertical-align: inherit;">que ya escrib√≠ anteriormente, genera </font><font style="vertical-align: inherit;">, pero la </font><font style="vertical-align: inherit;">situaci√≥n es m√°s interesante: aqu√≠ se genera </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Dado que toda la infraestructura para almacenar la meta descripci√≥n de la tabla temporal es exactamente la misma que la habitual, la </font><b><font style="vertical-align: inherit;">creaci√≥n y eliminaci√≥n constantes de tablas temporales conduce a una fuerte "</font></b><font style="vertical-align: inherit;"> expansi√≥n </font><b><font style="vertical-align: inherit;">" de las tablas del sistema</font></b><font style="vertical-align: inherit;"> pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Ahora imagine que tiene un trabajador en la l√≠nea conectarse a la base de datos, que cada segundo abre una nueva transacci√≥n, crea, llena, procesa y elimina la tabla temporal ... La basura en las tablas del sistema se acumular√° en exceso, y esto es frenos adicionales durante cada operaci√≥n.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, no lo hagas! </font><font style="vertical-align: inherit;">En este caso, es mucho m√°s eficiente </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sacarlo del ciclo de la transacci√≥n; luego, al comienzo de cada nueva transacci√≥n, la tabla ya </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existir√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (guarde la llamada </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), pero </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estar√° vac√≠a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , gracias a </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(tambi√©n salvamos la llamada) al final de la transacci√≥n anterior.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4. </font><font style="vertical-align: inherit;">COMO ... INCLUYENDO ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mencion√© al principio que uno de los casos de uso t√≠picos para las tablas temporales es varios tipos de importaciones, y el desarrollador copia y pega cansado la lista de campos de la tabla de destino en la declaraci√≥n de su temporal ... ¬° </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la pereza es el motor del progreso! </font><font style="vertical-align: inherit;">Por lo tanto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crear una nueva tabla "en el modelo"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede ser mucho m√°s simple:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede agregar muchos datos a esta tabla, las b√∫squedas en ella nunca ser√°n r√°pidas. Pero hay una soluci√≥n tradicional contra esto: ¬°√≠ndices! Y s√≠, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una tabla temporal tambi√©n puede tener √≠ndices</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que, a menudo, los √≠ndices deseados coinciden con los √≠ndices de la tabla de destino, simplemente puede escribir </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Si tambi√©n necesita </font><font style="vertical-align: inherit;">valores (por ejemplo, para completar los valores de la clave primaria), puede usar </font><font style="vertical-align: inherit;">. Bueno, o simplemente - </font><font style="vertical-align: inherit;">copiar√° valores predeterminados, √≠ndices, restricciones ... </font><font style="vertical-align: inherit;">
Pero aqu√≠ debe comprender que si cre√≥ una </font><b><font style="vertical-align: inherit;">tabla de importaci√≥n de inmediato con √≠ndices, los datos se completar√°n m√°s tiempo</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que si primero llena todo y luego rueda los √≠ndices; mire como un ejemplo de c√≥mo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hace </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">pg_dump</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En definitiva, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. ¬øC√≥mo escribir?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dir√© simplemente: use </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream en lugar de "paquetes" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aceleraci√≥n a veces</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Incluso puede directamente desde un archivo pregenerado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. ¬øC√≥mo manejarlo?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, dejemos que nuestra introducci√≥n se vea m√°s o menos as√≠:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene en su base de datos una placa con datos del cliente para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registros 1M</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los d√≠as el cliente le env√≠a una nueva </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"imagen" completa</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por experiencia usted sabe que </font><b><font style="vertical-align: inherit;">no m√°s de 10K registros cambian</font></b><font style="vertical-align: inherit;"> de vez en cuando</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ejemplo cl√°sico de tal situaci√≥n es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base de datos KLADR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : hay muchas direcciones, pero en cada carga semanal de cambios (cambio de nombre de asentamientos, asociaciones de calles, aparici√≥n de nuevas casas) hay muy pocas, incluso en todo el pa√≠s.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Algoritmo de sincronizaci√≥n completa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por simplicidad, supongamos que ni siquiera necesita reestructurar los datos, solo traiga la tabla en la forma correcta, es decir:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">borra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo lo que ya no es</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualice</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo lo que ya estaba, y necesita actualizar</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inserte</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo lo que no ha sido</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© en este orden vale la pena hacer operaciones? </font><font style="vertical-align: inherit;">Porque as√≠ es como el tama√±o de la tabla crece m√≠nimamente (¬° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recuerde acerca de MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BORRAR DE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, por supuesto, puedes hacer solo dos operaciones:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eliminar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) en absoluto</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pegar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo desde una nueva imagen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero al mismo tiempo, gracias a MVCC, ¬°el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tama√±o de la tabla aumentar√° exactamente dos veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obtenga registros de im√°genes de + 1M en la tabla debido a la actualizaci√≥n de 10K, m√°s o menos redundancia ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un desarrollador m√°s experimentado sabe que toda la placa se puede limpiar de manera bastante econ√≥mica:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">borrar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) toda la tabla</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pegar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todo desde una nueva imagen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El m√©todo es efectivo, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">veces es bastante aplicable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero hay un problema ... Completaremos 1M de registros, por lo que no podemos permitirnos dejar la tabla vac√≠a durante todo este tiempo (como suceder√° sin envolver en una sola transacci√≥n). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que significa:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comenzamos una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transacci√≥n larga</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impone </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hacemos el inserto durante mucho tiempo, y todos los dem√°s en este momento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ni siquiera</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algo esta mal ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTERAR TABLA ... RENOMBRAR ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como opci√≥n, llene todo en una nueva tabla separada y luego simplemente c√°mbiele el nombre a la anterior. </font><font style="vertical-align: inherit;">Un par de peque√±as cosas desagradables:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n </font><font style="vertical-align: inherit;">, aunque sustancialmente menos en el tiempo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los planes de consulta / estad√≠sticas de esta tabla se restablecen, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es necesario conducir ANALIZAR</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas las claves for√°neas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) se </font><b><font style="vertical-align: inherit;">rompen</font></b><font style="vertical-align: inherit;"> en la mesa</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubo un parche WIP de Simon Riggs, que sugiri√≥ hacer una </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operaci√≥n para reemplazar el cuerpo de la tabla a nivel de archivo, sin tocar las estad√≠sticas y FK, pero no recopil√≥ el qu√≥rum.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BORRAR, ACTUALIZAR, INSERTAR</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, nos detenemos en una versi√≥n sin bloqueo de tres operaciones. </font><font style="vertical-align: inherit;">Casi tres ... ¬øC√≥mo hacer esto de manera m√°s efectiva?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Importar procesamiento posterior</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el mismo KLADRE, todos los registros modificados deben ejecutarse adicionalmente a trav√©s del procesamiento posterior: normalizar, resaltar palabras clave y llevar a las estructuras necesarias. </font><font style="vertical-align: inherit;">Pero, ¬øc√≥mo sabes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu√© ha cambiado exactamente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sin complicar el c√≥digo de sincronizaci√≥n, idealmente sin tocarlo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si solo su proceso tiene acceso de escritura en el momento de la sincronizaci√≥n, puede usar un activador que recopilar√° todos los cambios para nosotros:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora podemos imponer disparadores (o habilitarlos </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">antes de comenzar la sincronizaci√≥n </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego, en silencio, de las tablas de registro extraemos todos los cambios que necesitamos y lo ejecutamos a trav√©s de controladores adicionales.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Importar conjuntos relacionados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba, consideramos casos en los que las estructuras de datos de la fuente y el receptor coinciden. </font><font style="vertical-align: inherit;">Pero, ¬øqu√© pasa si la descarga desde un sistema externo tiene un formato diferente de la estructura de almacenamiento en nuestra base de datos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tome el almacenamiento de los clientes y sus cuentas como ejemplo, la opci√≥n cl√°sica de muchos a uno:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la descarga de una fuente externa nos llega en forma de "todo en uno":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, los datos del cliente pueden duplicarse de esta manera, y el registro principal es la "cuenta":</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el modelo, simplemente inserte nuestros datos de prueba, pero recuerde, </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°de manera m√°s eficiente!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, seleccionamos aquellos "recortes" a los que se refieren nuestros "hechos". </font><font style="vertical-align: inherit;">En nuestro caso, las cuentas se refieren a clientes:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para asociar correctamente cuentas con ID de clientes, primero debemos descubrir o generar estos identificadores. </font><font style="vertical-align: inherit;">Agregue campos para ellos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizaremos el m√©todo de sincronizaci√≥n de tablas con la peque√±a correcci√≥n descrita anteriormente; no actualizaremos ni eliminaremos nada en la tabla de destino, porque la importaci√≥n de clientes es "solo para agregar":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, todo: </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ahora hemos completado el campo de comunicaci√≥n </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con el que insertaremos la cuenta.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492454/index.html">Vendemos refactorizaci√≥n de arquitectura a un cliente o cu√°l es el problema de los desarrolladores</a></li>
<li><a href="../es492456/index.html">C√≥mo visualizar y animar modelos (geof√≠sicos). Mostrar datos sin procesar</a></li>
<li><a href="../es492458/index.html">GUI simple para M5Stack (Arduino)</a></li>
<li><a href="../es492460/index.html">La programaci√≥n funcional es lo que (probablemente) le dijeron. Si escuchaste</a></li>
<li><a href="../es492462/index.html">Fuente de la verdad: c√≥mo un analista ense√±a a un gerente y un desarrollador a trabajar juntos</a></li>
<li><a href="../es492466/index.html">C√≥mo pasar de cualquier proveedor de host con cPanel a Plesk en Rusonix en solo cinco pasos</a></li>
<li><a href="../es492468/index.html">Lenovo Thinkserver SE350: un h√©roe de la periferia</a></li>
<li><a href="../es492474/index.html">Estructuramos la informaci√≥n en las cajas de Android y analizamos lo que deber√≠a ser capaz de hacer un prefijo normal.</a></li>
<li><a href="../es492478/index.html">Sin la gesti√≥n del conocimiento duele: 5 consecuencias principales de la falta de un sistema</a></li>
<li><a href="../es492480/index.html">C√≥mo luchamos con epidemias antes y qu√© hacemos contra el coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>