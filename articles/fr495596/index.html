<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äç‚úàÔ∏è üë∑üèº ü•™ Travail √† distance au bureau. RDP, Port Knocking, Mikrotik: simple et s√ªr üì∑ üö¥ ü§ß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le cadre de la pand√©mie du virus covid-19 et de la quarantaine universelle dans de nombreux pays, la seule issue pour de nombreuses entreprises p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Travail √† distance au bureau. RDP, Port Knocking, Mikrotik: simple et s√ªr</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495596/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le cadre de la pand√©mie du virus covid-19 et de la quarantaine universelle dans de nombreux pays, la seule issue pour de nombreuses entreprises pour continuer √† travailler est l'acc√®s √† distance aux emplois via Internet. Il existe de nombreuses m√©thodes relativement s√ªres pour le travail √† distance - mais √©tant donn√© l'ampleur du probl√®me, vous avez besoin d'une m√©thode simple pour tout utilisateur de se connecter √† distance au bureau et sans avoir besoin de param√®tres suppl√©mentaires, d'explications, de consultations fastidieuses et de longues instructions. Cette m√©thode est la pr√©f√©r√©e de nombreux administrateurs RDP (Remote Desktop Protocol). La connexion directe au lieu de travail via RDP r√©sout id√©alement notre probl√®me, √† l'exception d'une grosse mouche dans la pommade - garder le port RDP ouvert pour Internet est tr√®s dangereux. Par cons√©quent, je propose ci-dessous une m√©thode de protection simple mais fiable.</font></font><img src="https://habrastorage.org/webt/yv/o3/ut/yvo3utx5cj_wwte6jja-pe6swfw.jpeg" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 √âtant donn√© que je rencontre souvent de petites organisations o√π des appareils Mikrotik sont utilis√©s comme acc√®s Internet, il sera montr√© ci-dessous comment impl√©menter cela sur Mikrotik, mais la m√©thode de protection Port Knocking est facilement impl√©ment√©e sur d'autres appareils de classe sup√©rieure avec les m√™mes param√®tres pour le routeur d'entr√©e et pare-feu </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En bref sur Port Knocking</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Une protection externe id√©ale pour un r√©seau connect√© √† Internet est lorsque toutes les ressources et les ports sont ferm√©s en externe par un pare-feu. Et bien qu'un routeur avec un pare-feu configur√© de ce type ne r√©agisse en aucune fa√ßon aux paquets provenant de l'ext√©rieur, il les √©coute. Par cons√©quent, vous pouvez configurer le routeur de sorte que lorsqu'une certaine s√©quence (code) de paquets r√©seau est re√ßue sur diff√©rents ports, il (le routeur) pour IP d'o√π proviennent les paquets ouvre l'acc√®s √† certaines ressources (ports, protocoles, etc.).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant au point. </font><font style="vertical-align: inherit;">Je ne ferai pas une description d√©taill√©e des param√®tres du pare-feu sur Mikrotik - Internet regorge de sources de haute qualit√© pour cela. </font><font style="vertical-align: inherit;">Id√©alement, un pare-feu bloque tous les paquets entrants, mais</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=accept chain=input comment="established and related accept" connection-state=established,related</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autorise le trafic entrant √† partir de connexions √©tablies (li√©es). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurez maintenant Port Knocking sur Mikrotik:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
move [/ip firewall filter find comment=RemoteRules] 1<font></font>
/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant plus: les </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
deux premi√®res r√®gles</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
interdire les paquets entrants provenant d'adresses IP qui sont sur liste noire lors de l'analyse des ports; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La troisi√®me r√®gle:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoute ip √† la liste des h√¥tes qui ont effectu√© le premier coup correct sur le port souhait√© (19000); </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les quatre r√®gles suivantes:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cr√©er des ports de d√©routement pour ceux qui souhaitent analyser vos ports, et lorsque de telles tentatives sont d√©tect√©es, mettez leur adresse IP sur la liste noire pendant 60 minutes, pendant lesquelles les deux premi√®res r√®gles emp√™cheront ces h√¥tes de frapper sur les ports appropri√©s; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√®gle suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
met ip dans la liste des permis pendant 1 minute (suffisant pour √©tablir une connexion), car le deuxi√®me coup correct est effectu√© sur le port souhait√© (16000); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commande suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">move [/ip firewall filter find comment=RemoteRules] 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d√©place nos r√®gles vers le haut de la cha√Æne de traitement du pare-feu, car tr√®s probablement, nous aurons d√©j√† configur√© diff√©rentes r√®gles d'interdiction qui emp√™cheront les nouvelles de fonctionner. La toute premi√®re r√®gle dans Mikrotik part de z√©ro, mais sur mon appareil, z√©ro √©tait occup√© par la r√®gle int√©gr√©e et il √©tait impossible de se d√©placer - je suis pass√© √† 1. Par cons√©quent, nous examinons nos param√®tres - o√π vous pouvez vous d√©placer et sp√©cifier le nombre souhait√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le param√®tre suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp_to_33" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
transf√®re le port 33890 s√©lectionn√© au hasard vers un port RDP r√©gulier 3389 et l'adresse IP de l'ordinateur ou du serveur de terminaux dont nous avons besoin. </font><font style="vertical-align: inherit;">Nous cr√©ons de telles r√®gles pour toutes les ressources internes n√©cessaires, en exposant de pr√©f√©rence les ports externes non standard (et diff√©rents). </font><font style="vertical-align: inherit;">Naturellement, l'ip des ressources internes doit √™tre statique ou s√©curis√©e sur un serveur DHCP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, notre Mikrotik est configur√© et nous avons besoin d'une proc√©dure simple pour que l'utilisateur se connecte √† notre RDP interne. </font><font style="vertical-align: inherit;">√âtant donn√© que nous avons principalement des utilisateurs Windows, nous cr√©ons un simple fichier bat et l'appelons StartRDP.bat:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.htm<font></font>
1.rdp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en cons√©quence, 1.htm contient le code suivant:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:19000/1.jpg"</span>&gt;</span><font></font>
       RDP<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:16000/2.jpg"</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 il contient deux liens vers des images imaginaires qui se trouvent √† l'adresse my_router.sn.mynetname.net - nous prenons cette adresse du syst√®me DDNS de Mikrotik en le pr√©-activant dans notre Mikrotik: allez dans le menu IP-&gt; Cloud - cochez la case DDNS Enabled, cliquez sur Apply et copiez le nom DNS de notre routeur. Mais cela n'est n√©cessaire que lorsque l'IP externe du routeur est dynamique ou qu'une configuration avec plusieurs fournisseurs Internet est utilis√©e.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le port dans la premi√®re liaison: 19000 correspond au premier port sur lequel vous devez frapper, dans le second, respectivement, le second. Entre les liens est une courte instruction qui montre quoi faire si notre connexion se brise soudainement en raison de courts probl√®mes de r√©seau - nous rafra√Æchissons la page, le port RDP s'ouvre √† nouveau pour nous pendant 1 minute et notre session est restaur√©e. De plus, le texte entre les balises img forme un micro retard pour le navigateur, ce qui r√©duit la probabilit√© que le premier paquet soit livr√© au deuxi√®me port (16000) - jusqu'√† pr√©sent, il n'y a pas eu de tels cas en deux semaines d'utilisation (30 personnes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le fichier 1.rdp, que nous pouvons configurer un pour tous ou s√©par√©ment pour chaque utilisateur (je l'ai fait - il est plus facile de passer 15 minutes suppl√©mentaires que plusieurs heures pour consulter ceux qui n'ont pas pu le comprendre)</font></font><br>
<br>
<pre><code class="plaintext hljs">screen mode id:i:2<font></font>
use multimon:i:1<font></font>
.....<font></font>
connection type:i:6<font></font>
networkautodetect:i:0<font></font>
.....<font></font>
disable wallpaper:i:1<font></font>
.....<font></font>
full address:s:my_router.sn.mynetname.net:33890<font></font>
.....<font></font>
username:s:myuserlogin<font></font>
domain:s:mydomain</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
des param√®tres int√©ressants ici utilisent multimon: i: 1 - cela inclut l'utilisation de plusieurs moniteurs - certains en ont besoin, mais ils ne penseront pas √† l'allumer eux-m√™mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
type de connexion: i: 6 et networkautodetect: i: 0 - puisque la majorit√© d'Internet est sup√©rieure √† 10 Mbps, activez le type de connexion 6 (r√©seau local 10 Mbps et sup√©rieur) et d√©sactivez networkautodetect, car s'il est (auto) par d√©faut, il est m√™me rare le retard du r√©seau d√©finit automatiquement et de fa√ßon permanente une vitesse sous-estim√©e pour notre session, ce qui peut cr√©er des retards notables dans le travail, en particulier dans les programmes graphiques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d√©sactiver le fond d'√©cran: i: 1 - d√©sactiver le </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nom d'utilisateur de l' </font><font style="vertical-align: inherit;">image de bureau </font><font style="vertical-align: inherit;">: s: myuserlogin - sp√©cifier le nom d'utilisateur, car une partie importante de nos utilisateurs ne connaissent pas leur nom d'utilisateur</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
domain: s: mydomain - sp√©cifiez le nom de domaine ou d'ordinateur </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous voulons simplifier la t√¢che de cr√©ation d'une proc√©dure de connexion, nous pouvons √©galement utiliser PowerShell - StartRDP.ps1</font></font><br>
<br>
<pre><code class="plaintext hljs">Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 19000<font></font>
Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 16000<font></font>
mstsc /v:my_router.sn.mynetname.net:33890</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âgalement un peu sur le client RDP dans Windows: MS a parcouru un long chemin pour optimiser le protocole et ses parties serveur et client, a mis en ≈ìuvre de nombreuses fonctionnalit√©s utiles - telles que le travail avec du mat√©riel 3D, l'optimisation de la r√©solution d'√©cran pour votre moniteur, multi-√©cran, etc. Mais bien s√ªr, tout est impl√©ment√© en mode de compatibilit√© descendante et si le client est Windows 7 et le PC distant est Windows 10, alors RDP fonctionnera en utilisant la version 7.0 du protocole. Mais l'avantage est que vous pouvez mettre √† niveau les versions RDP vers des versions plus r√©centes - par exemple, vous pouvez mettre √† niveau la version du protocole de 7.0 (Windows 7) vers 8.1. Par cons√©quent, pour la commodit√© des clients, il est n√©cessaire de maximiser la version du c√¥t√© serveur, ainsi que de supprimer les liens pour mettre √† niveau vers les nouvelles versions des clients du protocole RDP.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons une technologie simple et relativement s√ªre pour la connexion √† distance √† un PC ou √† un serveur terminal fonctionnel. </font><font style="vertical-align: inherit;">Mais pour une connexion plus s√©curis√©e, notre m√©thode Port Knocking peut √™tre compliqu√©e pour des attaques de plusieurs ordres de grandeur, en ajoutant des ports pour v√©rification - vous pouvez ajouter 3,4,5,6 ... la m√™me logique et dans ce cas une intrusion directe dans votre r√©seau sera presque impossible . </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichiers vierges pour cr√©er une connexion √† distance √† RDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495576/index.html">Plate-forme automotrice sur l'esp8266 MK avec micropython</a></li>
<li><a href="../fr495580/index.html">JVM concombre - pas seulement BDD</a></li>
<li><a href="../fr495588/index.html">Cr√©er roguelike dans Unity √† partir de z√©ro: g√©n√©rateur de donjon</a></li>
<li><a href="../fr495592/index.html">Comment utiliser les dictionnaires (et pas seulement)</a></li>
<li><a href="../fr495594/index.html">Commencez √† gagner de l'argent avec les logiciels: cr√©er des mini-entreprises num√©riques</a></li>
<li><a href="../fr495602/index.html">Commencer avec Core Data! Difficile avec des mots simples [Partie 2]</a></li>
<li><a href="../fr495604/index.html">Localisation temporaire sur Symfony 4 + Twig</a></li>
<li><a href="../fr495606/index.html">"Surveillance sociale." Score 1: 0 en notre faveur</a></li>
<li><a href="../fr495608/index.html">[Infographie] Visualisation des pand√©mies dans l'histoire de l'humanit√©</a></li>
<li><a href="../fr495610/index.html">Pourquoi l'avenir n'est pas pour Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>