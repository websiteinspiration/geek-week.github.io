<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª üö† üë©üèΩ‚Äçü§ù‚Äçüë®üèº Do-it-yourself Bare-Metal Provisioning, or Automatic server preparation from scratch ‚öõÔ∏è üî´ üò¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, I‚Äôm Denis and one of my areas of activity is the development of infrastructure solutions in X5. Today I would like to share with you about how you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Do-it-yourself Bare-Metal Provisioning, or Automatic server preparation from scratch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/493124/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, I‚Äôm Denis and one of my areas of activity is the development of infrastructure solutions in X5. </font><font style="vertical-align: inherit;">Today I would like to share with you about how you can deploy an automated server preparation system based on publicly available tools. </font><font style="vertical-align: inherit;">In my opinion, this is an interesting, simple and flexible solution.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/aj/wx/csajwx5dsd-sdlngyst-pfrollu.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By preparation is meant: to make from a new server out of the box, a fully configured server with OS </font><font style="vertical-align: inherit;">Linux or with the ESXi hypervisor (Windows server casting is not discussed in this article). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servers - servers that need to be configured.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installation server - the main server that provides the entire preparation process over the network.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do you need automation?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say there is a problem: mass prepare the server from scratch, at the peak - 30 per day. </font><font style="vertical-align: inherit;">Servers of different manufacturers and models, different OSs can be installed on them, a hypervisor may or may not exist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What operations are included in the setup process (without automation):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connect the keyboard, mouse, monitor to the server;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configure BIOS, RAID, IPMI;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upgrade component firmware;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy a file system image (or install a hypervisor and copy virtual machines);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">Alternatively, deploying the OS is possible through installation with an auto-answer file. </font><font style="vertical-align: inherit;">But this will not be discussed in the article. </font><font style="vertical-align: inherit;">Although you will see below that adding this functionality is easy.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configure OS parameters (hostname, IP, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this approach, the same settings are performed sequentially on each server. </font><font style="vertical-align: inherit;">The effectiveness of such work is very low. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of automation is to exclude human involvement from the process of preparing the server. </font><font style="vertical-align: inherit;">As much as possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to automation, downtime between operations is reduced and it becomes possible to prepare several servers at the same time. </font><font style="vertical-align: inherit;">The likelihood of errors due to the human factor is also greatly reduced.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g7/ic/x1/g7icx1q3tb0yanpntf9jmw8n4p4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How are the servers configured automatically?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will analyze all the steps in detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You have a linux server that you use as the PXE installation server. </font><font style="vertical-align: inherit;">Services are installed and configured on it: DHCP, TFTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we load the server (which needs to be configured) by PXE. </font><font style="vertical-align: inherit;">Recall how it works:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The server selected to boot over the network.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The server loads the PXE-ROM of the network card and contacts the installation server via DHCP to obtain the network address.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP of the installation server gives the address, as well as instructions for further downloading via PXE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The server downloads the network bootloader from the installation server via PXE, further download occurs according to the PXE configuration file.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The download is performed based on the received parameters (kernel, initramfs, mount points, squashfs image, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">This article describes the PXE boot via BIOS mode. </font><font style="vertical-align: inherit;">Currently, manufacturers are actively introducing UEFI bootmode. </font><font style="vertical-align: inherit;">For PXE, the difference will be in the configuration of the DHCP server and the presence of an additional bootloader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider a PXE server configuration example (pxelinux menu). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File pxelinux.cfg / default:</font></font><br>
<br>
<pre><code class="plaintext hljs">default menu.c32<font></font>
prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
LABEL InstallServer Menu<font></font>
	MENU LABEL InstallServer<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/installserver<font></font>
LABEL VMware Menu<font></font>
	MENU LABEL VMware ESXi Install<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/vmware<font></font>
LABEL toolkit //   <font></font>
	MENU LABEL Linux Scripting Toolkits<font></font>
	MENU default<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/toolkit //    </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File pxelinux.cfg / toolkit:</font></font><br>
<br>
<pre><code class="plaintext hljs">prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
label mainmenu<font></font>
    menu label ^Return to Main Menu<font></font>
    kernel menu.c32<font></font>
    append pxelinux.cfg/default<font></font>
label x5toolkit-auto //   ‚Äî  <font></font>
        menu label x5 toolkit autoinstall<font></font>
        menu default<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tk-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=master-install.sh CMDIS2=‚Äù‚Ä¶‚Äù<font></font>
label x5toolkit-shell //   - <font></font>
        menu label x5 toolkit shell<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tkcustom-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=/bin/bash CMDIS2=‚Äù‚Ä¶‚Äù</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The kernel and initramfs at this stage are an intermediate linux-image, with the help of which the basic preparation and configuration of the server will take place. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the bootloader passes many parameters to the kernel. </font><font style="vertical-align: inherit;">Some of these parameters are used by the kernel itself. </font><font style="vertical-align: inherit;">And we can use some for our own purposes. </font><font style="vertical-align: inherit;">This will be described later, but for now you can just remember that all the parameters passed will be available in the intermediate linux image via / proc / cmdline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where to get them, the kernel and initramfs? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a basis, you can choose any linux distribution. </font><font style="vertical-align: inherit;">What we pay attention to when choosing:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the boot image must be universal (drivers available, the ability to install additional utilities);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">most likely, initramfs will need to be customized.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How is this done in our solution for X5? CentOS 7 was chosen as the basis. Let's do the following trick: prepare the future image structure, pack it into the archive and create initramfs, inside which will be our file system archive. When loading the image, the archive will be deployed to the created tmpfs section. Thus, we get a minimal, while full-fledged live-linux image with all the necessary utilities, consisting of only two files: vmkernel and initramfs.</font></font><br>
<br>
<pre><code class="plaintext hljs"># : <font></font>
<font></font>
mkdir -p /tftpboot/toolkit/CustomTK/rootfs /tftpboot/toolkit/CustomTK/initramfs/bin<font></font>
<font></font>
# :<font></font>
<font></font>
yum groups -y install "Minimal Install" --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y install nfs-utils mariadb ntpdate mtools syslinux mdadm tbb libgomp efibootmgr dosfstools net-tools pciutils openssl make ipmitool OpenIPMI-modalias rng-tools --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y remove biosdevname --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
<font></font>
#  initramfs:<font></font>
<font></font>
wget https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-x86_64 -O /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
chmod a+x /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
cp /tftpboot/toolkit/CustomTK/rootfs/boot/vmlinuz-3.10.0-957.el7.x86_64 /tftpboot/toolkit/tkcustom-kernel<font></font>
<font></font>
#  /tftpboot/toolkit/CustomTK/initramfs/init (  ):<font></font>
<font></font>
#!/bin/busybox sh<font></font>
/bin/busybox --install /bin<font></font>
mkdir -p /dev /proc /sys /var/run /newroot<font></font>
mount -t proc proc /proc<font></font>
mount -o mode=0755 -t devtmpfs devtmpfs /dev<font></font>
mkdir -p /dev/pts /dev/shm /dev/mapper /dev/vc<font></font>
mount -t devpts -o gid=5,mode=620 devpts /dev/pts<font></font>
mount -t sysfs sysfs /sys<font></font>
mount -t tmpfs -o size=4000m tmpfs /newroot<font></font>
echo -n "Extracting rootfs... "<font></font>
xz -d -c -f rootfs.tar.xz | tar -x -f - -C /newroot<font></font>
echo "done"<font></font>
mkdir -p /newroot/dev /newroot/proc /newroot/sys<font></font>
mount --move /sys  /newroot/sys<font></font>
mount --move /proc /newroot/proc<font></font>
mount --move /dev  /newroot/dev<font></font>
exec switch_root /newroot /sbin/init<font></font>
<font></font>
#  rootfs  initramfs:<font></font>
<font></font>
cd /tftpboot/toolkit/CustomTK/rootfs<font></font>
tar cJf /tftpboot/toolkit/CustomTK/initramfs/rootfs.tar.xz --exclude ./proc --exclude ./sys --exclude ./dev .<font></font>
cd /tftpboot/toolkit/CustomTK/initramfs<font></font>
find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; /tftpboot/toolkit/tkcustom-initramfs-new.gz</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have specified a kernel and initramfs which should be loaded. </font><font style="vertical-align: inherit;">As a result, at this stage, downloading the intermediate linux image via PXE, we get the OS console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, but now we need to transfer control to our ‚Äúautomation‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be done like this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose, after loading the image, we plan to transfer control to the mount.sh script. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We include the mount.sh script in autorun. </font><font style="vertical-align: inherit;">To do this, you need to modify initramfs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unpack initramfs (if we use the above version of initramfs, this is not required)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include in startup code that will analyze the parameters passed through / proc / cmdline and transfer control further;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pack initramfs.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. In the case of the X5 toolkit, the boot control is transferred to the script. </font></font><code>/opt/x5/toolkit/bin/hook.sh   override.conf  getty tty1 (ExecStart=‚Ä¶) </code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the image is loaded, in which the mount.sh script starts at startup. Next, the mount.sh script in the process of analysis analyzes the passed parameters (script_cmd =) and launches the necessary program / script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = master-install.sh</font></font><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = / bin / bash</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/w9/xc/8b/w9xc8b87fob_jooqjazqiyyiccm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Here on the left side is the PXE menu , on the right is the control transfer scheme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the transfer of control, we figured it out. </font><font style="vertical-align: inherit;">Depending on the choice of the PXE menu, either the auto-tuning script or the debugging console is launched. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of automatic configuration, the necessary directories from the installation server are mounted, in which there are:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scripts;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saved BIOS / UEFI templates of various servers;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firmware;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilities for servers;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logs.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, the mount.sh script transfers control to the master-install.sh script from the scripts directory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The script tree (the order of their launch) looks something like this:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master-install</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sharefunctions (common functions)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">info (information output)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">models (setting installation parameters based on the server model)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepare_utils (installing the necessary utilities)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwupdate (firmware update)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diag (elementary diagnosis)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biosconf (BIOS / UEFI setup)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clockfix (setting the time on the motherboard)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">srmconf (configuring the remote interface)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raidconf (configuring logical volumes)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
one of:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinstall (transferring control to the installer of the OS or hypervisor, for example ESXi)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">merged-install (direct start of unpacking the image)</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we know:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to boot the server via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to transfer control to your own script.</font></font></li>
</ul></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's continue. </font><font style="vertical-align: inherit;">The following issues have become relevant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to identify the server that we are preparing?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What utilities and how to configure the server?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to get settings for a specific server?</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to identify the server that we are preparing?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is simple - DMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">dmidecode ‚Äìs system-product-name<font></font>
dmidecode ‚Äìs system-manufacturer<font></font>
dmidecode ‚Äìs system-serial-number</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It has everything you need: a vendor, a model, a serial number. </font><font style="vertical-align: inherit;">If you are not sure that this information is presented in all servers, you can identify them by MAC address. </font><font style="vertical-align: inherit;">Or in both ways at the same time if the server vendors are different and on some models the serial number information is simply not available. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the information received, network folders from the installation server are mounted and everything necessary is loaded (utilities, firmware, etc.).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What utilities and how to configure the server?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will give utilities for linux for some manufacturers. </font><font style="vertical-align: inherit;">All utilities are available on the official websites of the vendors. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xx/xh/3f/xxxh3f0pg48elgtr8qn9r_wjp4q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With firmware, I think everything is clear. </font><font style="vertical-align: inherit;">They usually come in packaged executables. </font><font style="vertical-align: inherit;">The executable file controls the firmware update process and reports a return code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BIOS and IPMI are usually configured through templates. </font><font style="vertical-align: inherit;">If necessary, the template can be edited before loading. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAID utilities for some vendors can also configure according to the template. </font><font style="vertical-align: inherit;">If this is not the case, you will have to write a configuration script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The procedure for configuring RAID is most often as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We request the current configuration.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there are already logical arrays, we erase it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We look at what physical disks are present and how many of them.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a new logical array. </font><font style="vertical-align: inherit;">We interrupt the process in case of an error.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to get settings for a specific server?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose all server settings are stored on the installation server. </font><font style="vertical-align: inherit;">In this case, in order to answer our question, you first need to decide: how to transfer the settings to the installation server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, it is quite possible to do with text files. </font><font style="vertical-align: inherit;">(In the future, you can use a text file as a backup way to transfer settings). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can "share" a text file on the installation server. </font><font style="vertical-align: inherit;">And add it to the mount.sh script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The lines will, for example, look like this: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;serial number&gt; &lt;host name&gt; &lt;subnet&gt; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These lines will be transferred to the file by the engineer from his working machine. </font><font style="vertical-align: inherit;">And then, when setting up the server, the parameters for a specific server will be read from the file.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, in the future, it‚Äôs better to use the database to store the settings, states and server installation logs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, one database can not do, and you will need to create a client part, with the help of which the settings will be transferred to the database. This is harder to implement than a text file, but it's actually not as hard as it sounds. The minimum version of the client, which will simply transfer data to the database, is quite feasible to write yourself. In the future, it will be possible to improve the client program also in free mode (reports, printing labels, sending notifications, etc., whatever comes to mind). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having made a specific request to the database and indicating the serial number of the server, we obtain the necessary parameters for configuring the server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus, we don‚Äôt need to invent locks for simultaneous access, as is the case with a text file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can write the configuration log at all stages in the database and control the installation process through events and flags of the preparation stages. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we know how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load the server via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfer control to our script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identify the server to be prepared by serial number;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configure the server with appropriate utilities;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfer settings to the installation server database using the client part.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Found out how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the installed server receives the necessary settings from the database;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all preparation progress is recorded in the database (logs, events, stage flags).</font></font></li>
</ul></b><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What about the different types of software being installed? </font><font style="vertical-align: inherit;">How to install a hypervisor, copy a VM and configure all this?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of deploying a file system image (linux) to hardware, everything is quite simple:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After setting up all the server components, deploy the image.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install the grub bootloader.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We make chroot and configure everything that is necessary.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to transfer control to the OS installer (using ESXi as an example).</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We organize the transfer of control from our script to the hypervisor installer using the auto-response file (kickstart):</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete the current partitions on the disk.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a 500MB partition.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We mark it as boot.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Format in FAT32.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We copy the ESXi installation files to the root.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy syslinux.cfg to / syslinux /</font></font></li>
</ul><br>
<pre><code class="plaintext hljs">default esxi<font></font>
prompt 1<font></font>
timeout 50<font></font>
label esxi<font></font>
kernel mboot.c32<font></font>
append -c boot.cfg</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy mboot.c32 to / syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In boot.cfg there should be kernelopt = ks = ftp: // &lt;IP of the installation server&gt; /ks_esxi.cfg</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reboot the server.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the server reboots, the ESXi installer will boot from its hard drive. </font><font style="vertical-align: inherit;">All the necessary installer files will be loaded into memory and the installation of ESXi will begin, according to the specified auto-answer file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are a few lines from the ks_esxi.cfg auto answer file:</font></font><br>
<br>
<pre><code class="plaintext hljs">%firstboot --interpreter=busybox<font></font>
‚Ä¶<font></font>
#   <font></font>
<font></font>
SYSSN=$(esxcli hardware platform get | grep Serial | awk -F " " '{print $3}')<font></font>
<font></font>
#  IP<font></font>
<font></font>
IPADDRT=$(esxcli network ip interface ipv4 get | grep vmk0 | awk -F " " '{print $2}')<font></font>
LAST_OCTET=$(echo $IPADDRT | awk -F'.' '{print $4}')<font></font>
<font></font>
#  NFS -<font></font>
<font></font>
esxcli storage nfs add -H is -s /srv/nfs_share -v nfsshare1<font></font>
<font></font>
#    ssh,   ssh-<font></font>
<font></font>
mv /etc/ssh /etc/ssh.tmp<font></font>
cp -R /vmfs/volumes/nfsshare1/ssh /etc/<font></font>
chmod go-r /etc/ssh/ssh_host_rsa_key<font></font>
<font></font>
#  ovftool,    ,    <font></font>
<font></font>
cp -R /vmfs/volumes/nfsshare1/ovftool /vmfs/volumes/datastore1/<font></font>
<font></font>
#  <font></font>
<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM1 /vmfs/volumes/nfsshare1/VM_T/VM1.ova vi://root:esxi_password@127.0.0.1<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM2 /vmfs/volumes/nfsshare1/VM_T/VM2.ova vi://root:esxi_password@127.0.0.1<font></font>
<font></font>
#      <font></font>
<font></font>
ssh root@is "mysql -h'192.168.0.1' -D'servers' -u'user' -p'secretpassword' -e \"SELECT ... WHERE servers.serial='$SYSSN'\"" | grep -v ^$ | sed 's/NULL//g' &gt; /tmp/servers<font></font>
...<font></font>
#    <font></font>
<font></font>
echo '#!/bin/sh' &gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip interface ipv4 set -i=vmk0 -t=static --ipv4=$IPADDR --netmask=$S_SUB || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip route ipv4 add -g=$S_GW -n=default || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
chmod a+x /vmfs/volumes/datastore1/netconf.sh<font></font>
<font></font>
#   guestinfo.esxihost.id,     <font></font>
<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM1/VM1.vmx<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM2/VM2.vmx<font></font>
...<font></font>
#    <font></font>
<font></font>
SYSNAME=$(esxcli hardware platform get | grep Product | sed 's/Product Name://' | sed 's/^\ *//')<font></font>
UUID=$(vim-cmd hostsvc/hostsummary | grep uuid | sed 's/\ //g;s/,$//' | sed 's/^uuid="//;s/"$//')<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"UPDATE servers ... SET ... WHERE servers.serial='$SYSSN'\""<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"INSERT INTO events ...\""<font></font>
<font></font>
#   SSH<font></font>
<font></font>
rm -rf /etc/ssh<font></font>
mv /etc/ssh.tmp /etc/ssh<font></font>
<font></font>
#    <font></font>
<font></font>
esxcli system hostname set --fqdn=esx-${G_NICK}.x5.ru<font></font>
/vmfs/volumes/datastore1/netconf.sh<font></font>
reboot<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, a hypervisor is installed and configured, virtual machines are copied. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to configure virtual machines now? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We cheated a little: during the installation we set the guestinfo.esxihost.id = "$ SYSSN" parameter in the VM1.vmx file, indicated the serial number of the physical server in it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, after starting, the virtual machine (with the vmware-tools package installed) can access this parameter:</font></font><br>
<br>
<pre><code class="plaintext hljs">ESXI_SN=$(vmtoolsd --cmd "info-get guestinfo.esxihost.id")</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the VM will be able to identify itself (it knows the serial number of the physical host), make a request to the installation server database and get the parameters that need to be configured. </font><font style="vertical-align: inherit;">This is all executed in a script that should be launched automatically when guestos vm starts (but once: RunOnce). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we know how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load the server via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfer control to our script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identify the server to be prepared by serial number;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configure the server with appropriate utilities;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfer settings to the installation server database using the client part;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure various types of POs, including deploying the esxi hypervisor and configuring virtual machines (and all automatically).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Found out how:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the installed server receives the necessary settings from the database;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all preparation progress is recorded in the database (logs, events, stage flags).</font></font></li>
</ul></b><br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bottom line:</font></font></b></u><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I believe the uniqueness of this solution lies in its flexibility, simplicity, its capabilities and versatility. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please write in the comments what you think.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493112/index.html">How to start a new business in 6 months instead of 3 years</a></li>
<li><a href="../en493114/index.html">How Data Engineer Watched Data</a></li>
<li><a href="../en493116/index.html">‚ÄúMore interactivity!‚Äù or How was TeamLead Conf 2020</a></li>
<li><a href="../en493118/index.html">Overview of Memory Tagging Extension (Armv8.5-A)</a></li>
<li><a href="../en493122/index.html">Banzai Games office: Japan in the center of Moscow</a></li>
<li><a href="../en493126/index.html">Antipatterns of event-oriented architecture</a></li>
<li><a href="../en493130/index.html">–ü–æ—á–µ–º—É –Ω–µ —Å—Ç–æ–∏—Ç –±–æ—è—Ç—å—Å—è –∫–æ—Ä–æ–Ω–∞–≤–∏—Ä—É—Å–∞: –º–∏—Ñ—ã –∏ –ø–æ—á—Ç–∏ –ø—Ä–∞–≤–¥–∞ –æ COVID-2019</a></li>
<li><a href="../en493132/index.html">Around data.table</a></li>
<li><a href="../en493136/index.html">FAST VP in Unity Storage: How It Works</a></li>
<li><a href="../en493138/index.html">Talk to me: what voice bots can do today</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>