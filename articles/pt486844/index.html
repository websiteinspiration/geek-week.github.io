<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòµ üíö üßóüèΩ A evolu√ß√£o do processamento de webhook no Facebook: de zero a 25.000 por segundo ‚öìÔ∏è üåñ ‚õµÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Provavelmente, ningu√©m precisa dizer o que s√£o webhooks. Mas, apenas no caso: webhooks s√£o um mecanismo para relatar eventos em um sistema externo. Po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>A evolu√ß√£o do processamento de webhook no Facebook: de zero a 25.000 por segundo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente, ningu√©m precisa dizer o que s√£o webhooks. Mas, apenas no caso: webhooks s√£o um mecanismo para relatar eventos em um sistema externo. Por exemplo, sobre comprar em uma loja online atrav√©s de uma caixa online, enviar um c√≥digo para um reposit√≥rio GitHub ou a√ß√µes do usu√°rio em bate-papos. Em uma API t√≠pica, voc√™ precisa consultar constantemente o servidor se o usu√°rio escreveu algo no chat. Usando o mecanismo de webhook, voc√™ pode "assinar" as notifica√ß√µes, e o pr√≥prio servidor enviar√° uma solicita√ß√£o HTTP quando ocorrer um evento. Isso √© mais conveniente e r√°pido do que a solicita√ß√£o constante de novos dados no servidor.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat √© uma plataforma que ajuda as empresas a se comunicar com seus clientes via chat em mensagens instant√¢neas. Os webhooks s√£o uma das partes importantes do ManyChat, porque √© atrav√©s deles que a empresa se comunica com os clientes. E eles se comunicam muito - por exemplo, atrav√©s de um sistema, as empresas enviam bilh√µes de mensagens por m√™s para seus clientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maioria das mensagens √© enviada via Facebook Messenger. Ele tem um recurso - uma API lenta. Quando um cliente escreve uma mensagem para pedir pizza, o Facebook envia um webhook para o ManyChat. A plataforma a processa, envia a solicita√ß√£o de volta e o usu√°rio recebe uma mensagem. Devido √† lenta API, alguns pedidos demoram alguns segundos. Mas quando a plataforma n√£o responde por muito tempo, a empresa perde o cliente e o Facebook pode desconectar o aplicativo dos webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o processamento de webhooks √© uma das principais tarefas de engenharia da plataforma. </font><font style="vertical-align: inherit;">Para resolver o problema, o ManyChat mudou sua arquitetura de processamento v√°rias vezes ao longo de tr√™s anos, de um simples controlador no Yii para um sistema distribu√≠do com Galaxies. </font><font style="vertical-align: inherit;">Leia mais sobre isso sob o corte Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov lidera o desenvolvimento no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e programa profissionalmente em PHP desde 2001. </font><font style="vertical-align: inherit;">Dmitry lhe dir√° como a arquitetura mudou junto com o crescimento do servi√ßo e da carga, quais solu√ß√µes e tecnologias foram aplicadas em diferentes est√°gios, como o processamento do webhook evoluiu e como a plataforma consegue lidar com uma carga enorme usando recursos modestos em PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota. </font><font style="vertical-align: inherit;">O artigo √© baseado no relat√≥rio de Dmitry ‚ÄúA evolu√ß√£o do processamento de webhook no Facebook: de zero a 12.500 por segundo‚Äù no </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP R√∫ssia 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mas enquanto ele se preparava, os indicadores subiram para 25.000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que √© o ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, apresentarei voc√™ ao contexto de nossas tarefas. ManyChat √© um servi√ßo que ajuda as empresas a usar mensageiros instant√¢neos para marketing, vendas e suporte. O principal produto √© a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plataforma para o Messenger Marketing no Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Durante tr√™s anos, mais de 1 milh√£o de empresas de 100 pa√≠ses do mundo usaram o servi√ßo para se comunicar com 700 milh√µes de seus clientes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No lado do cliente,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fica assim. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bot√µes, imagens e galerias nas caixas de di√°logo do Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Esta √© a interface do Facebook Messenger. Al√©m das mensagens de texto, voc√™ pode enviar elementos interativos para interagir com os clientes, dialogar, aumentar o interesse em seus produtos e vender. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do lado comercial</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tudo parece diferente. </font><font style="vertical-align: inherit;">Essa √© a interface do nosso aplicativo da Web onde, usando uma interface visual, representantes comerciais criam e programam scripts de di√°logo. </font><font style="vertical-align: inherit;">A imagem √© um exemplo de cen√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cora√ß√£o do nosso sistema √© o componente Flow Builder. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O conjunto de scripts e regras de automa√ß√£o que chamamos de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, para simplificar, podemos dizer que o ManyChat √© um designer de bot. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo de um bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cliente da empresa que participa do di√°logo √© chamado de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assinante</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque, para intera√ß√£o, o cliente </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assina o bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que o Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que o Facebook Messenger, n√≥s somos o pa√≠s do Telegram sobrevivente? </font><font style="vertical-align: inherit;">H√° raz√µes para isso.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     ‚Ññ1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A intera√ß√£o com o Facebook √© organizada da seguinte maneira: os </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
neg√≥cios usam um aplicativo da web para configurar a l√≥gica do bot. </font><font style="vertical-align: inherit;">Quando um cliente interage com o bot por telefone, o Facebook recebe informa√ß√µes sobre isso e nos envia um webhook. </font><font style="vertical-align: inherit;">O ManyChat o processa, dependendo da l√≥gica programada pela empresa, e envia a solicita√ß√£o de volta. </font><font style="vertical-align: inherit;">Em seguida, o Facebook entrega a mensagem ao telefone do usu√°rio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilha tecnol√≥gica</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fazemos tudo isso em uma pilha modesta. </font><font style="vertical-align: inherit;">O n√∫cleo, √© claro, √© o PHP. </font><font style="vertical-align: inherit;">O servidor web executa o Nginx, o banco de dados principal √© o PostgreSQL e tamb√©m existem Redis e Elasticsearch. </font><font style="vertical-align: inherit;">Tudo gira nas nuvens do Amazon Web Services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipula√ß√£o do Facebook Webhook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a webcam do Facebook se parece: esta √© uma solicita√ß√£o com carga no formato JSON.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os webhooks representam apenas 10% da nossa carga, mas a parte mais importante do sistema. </font><font style="vertical-align: inherit;">Por meio deles, a empresa se comunica com os usu√°rios. </font><font style="vertical-align: inherit;">Se as mensagens diminuem a velocidade ou n√£o s√£o enviadas, o usu√°rio se recusa a interagir com o bot e a empresa perde o cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada na evolu√ß√£o de nossa arquitetura desde o lan√ßamento do produto. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maio de 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Acabamos de lan√ßar nosso servi√ßo: 20 bots, 10 dos quais s√£o de teste e 20 assinantes. </font><font style="vertical-align: inherit;">A carga foi 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O esquema de intera√ß√£o ficou assim:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A solicita√ß√£o vai para o nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Nginx acessa o PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O PHP-FPM leva o aplicativo at√© o Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O controlador webhook processa a l√≥gica e envia solicita√ß√µes ao Facebook de acordo com ela.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um monte de Nginx e PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Junho de 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um m√™s depois, anunciamos o ManyChat no ProductHunt e o n√∫mero de bots aumentou para 2 mil. </font><font style="vertical-align: inherit;">O n√∫mero de assinantes aumentou para 7 mil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse momento, o primeiro problema apareceu no sistema. </font><font style="vertical-align: inherit;">A API do Facebook n√£o √© muito r√°pida: algumas solicita√ß√µes podem levar v√°rios segundos e v√°rias solicita√ß√µes podem levar dezenas de segundos. </font><font style="vertical-align: inherit;">Mas o servidor webhook quer que respondamos rapidamente. </font><font style="vertical-align: inherit;">Devido √† lenta API, n√£o respondemos por um longo tempo: o servidor jura primeiro e, em seguida, pode desconectar completamente o aplicativo dos webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem poucos usu√°rios, ainda estamos desenvolvendo o aplicativo, estamos procurando nosso mercado, p√∫blico e o problema de carga j√° apareceu. </font><font style="vertical-align: inherit;">Mas fomos salvos por uma solu√ß√£o simples: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no momento em que o controlador √© iniciado, interrompemos o acesso ao Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dizemos ao Facebook que est√° tudo bem, mas em segundo plano processamos solicita√ß√µes e webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filas no PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dezembro de 2016. O</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servi√ßo cresceu 5 a 10 vezes: 10 mil bots e 700 mil assinantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, trabalhamos em novas tarefas: exibi√ß√£o de estat√≠sticas, entrega de mensagens, convers√£o de impress√µes e transi√ß√µes. </font><font style="vertical-align: inherit;">Tamb√©m implementou o Live Chat. </font><font style="vertical-align: inherit;">Al√©m de automatizar as intera√ß√µes, oferece √†s empresas a capacidade de escrever mensagens diretamente para seus assinantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o para esses problemas aumentou o n√∫mero de ganchos rastreados em 4 vezes. </font><font style="vertical-align: inherit;">Para cada mensagem que enviamos, recebemos 3 webhooks adicionais. </font><font style="vertical-align: inherit;">O sistema de processamento precisava ser aprimorado novamente. </font><font style="vertical-align: inherit;">Como somos uma plataforma pequena, apenas duas pessoas trabalhavam no back-end, por isso escolhemos a solu√ß√£o mais simples - filas no PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainda n√£o queremos implementar sistemas complexos, ent√£o simplesmente compartilhamos os fluxos de processamento. </font><font style="vertical-align: inherit;">Webhooks que precisam ser processados ‚Äã‚Äãrapidamente para que o usu√°rio receba uma resposta s√£o processados ‚Äã‚Äãde forma s√≠ncrona. </font><font style="vertical-align: inherit;">Todo o resto √© enviado em filas para solicita√ß√µes ass√≠ncronas.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filas na Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Junho de 2017. O</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servi√ßo est√° crescendo: 75 mil bots, 7 milh√µes de assinantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos implementando outro novo recurso. Todos os webhooks que processamos diziam apenas respeito a comunica√ß√µes no messenger. Mas agora decidimos dar √†s empresas a oportunidade de se comunicar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com os assinantes das p√°ginas comerciais</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e come√ßamos a processar novos tipos de webhooks - aqueles relacionados ao feed da pr√≥pria p√°gina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os feeds de p√°gina comercial n√£o s√£o atualizados com frequ√™ncia. Os profissionais de marketing costumam postar algo, ent√£o eles seguem cada um deles e os contam. N√£o h√° tr√°fego enorme nas p√°ginas comerciais. Mas h√° situa√ß√µes inversas, por exemplo, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry √© uma famosa cantora americana com um grande n√∫mero de f√£s em todo o mundo. </font><font style="vertical-align: inherit;">Existem 64 milh√µes de assinantes apenas no seu grupo no Facebook. </font><font style="vertical-align: inherit;">Em algum momento, os profissionais de marketing da cantora decidiram fazer um bot no Facebook Messenger e escolheram a nossa plataforma. </font><font style="vertical-align: inherit;">Nesse momento, quando eles publicaram uma mensagem pedindo para se inscrever no bot, nossa carga aumentou de 3 a 4 vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa situa√ß√£o nos ajudou a entender que, sem a implementa√ß√£o normal das filas, n√£o podemos fazer nada. </font><font style="vertical-align: inherit;">Como solu√ß√£o, eles escolheram o Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escolher Redis para filas √© uma decis√£o fantasticamente boa.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele ajudou a resolver um grande n√∫mero de problemas. Agora, a cada segundo em nosso cluster Redis, s√£o transmitidos 1 milh√£o de solicita√ß√µes diferentes. N√≥s o usamos n√£o apenas para todas as filas em cascata, mas tamb√©m para outras tarefas, por exemplo, monitoramento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Filas no Redis n√£o foram implementadas na primeira tentativa. Quando come√ßamos a dobrar webhooks no Redis e process√°-los em um processo, expandimos o funil na parte superior: havia mais webhooks recebidos processados ‚Äã‚Äãtamb√©m, mas o processo em si ainda levou algum tempo. Esta primeira decis√£o n√£o teve √™xito.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando eles tentaram escalar o n√∫mero desses pedidos, houve um leve colapso. A fila pode acumular solicita√ß√µes de p√°ginas diferentes, mas solicita√ß√µes de uma p√°gina podem seguir uma linha. Se um manipulador for lento, as solicita√ß√µes de um assinante e de um bot ser√£o processadas na ordem errada. O usu√°rio envia mensagens, executa algumas a√ß√µes com o bot, mas recebe uma resposta aleatoriamente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse parece ser um caso raro, mas os testes em nossas cargas de trabalho mostraram que isso acontecer√° com frequ√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a procurar outra solu√ß√£o. Aqui, a simplicidade e o poder dos Redis vieram em socorro - decidimos fazer uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fila para cada bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como funciona? Mensagens relacionadas a cada bot s√£o adicionadas √† fila. Para n√£o elevar o manipulador para cada fila, fizemos uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fila de controle</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ela trabalha assim. Cada vez que uma solicita√ß√£o vem de um bot, duas mensagens s√£o publicadas no Redis: uma na fila do bot e a segunda no controle. O manipulador monitora o controle e cada vez que inicia o daemon quando h√° uma tarefa para processar o bot. O dem√¥nio percorre a fila do bot correspondente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m da tarefa principal, resolvemos o problema dos ‚Äúvizinhos barulhentos‚Äù. √â quando um bot gera uma enorme massa de webhooks e torna o sistema mais lento, porque outras p√°ginas est√£o aguardando processamento. Para resolver o problema, basta </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escalar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : quando a fila de controle est√° cheia, adicionamos novos manipuladores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filas s√£o virtuais</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Estas s√£o apenas c√©lulas na mem√≥ria Redis. </font><font style="vertical-align: inherit;">Quando n√£o h√° nada na fila, ele n√£o existe, n√£o ocupa nada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janeiro de 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Atingimos 1 bilh√£o de posts por m√™s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A carga foi de 5 mil RPS por sistema. Isso n√£o √© carga de pico, mas padr√£o. Quando muitos artistas famosos aparecem, tudo j√° cresce v√°rias vezes a partir dessa figura. Mas n√£o √© um problema. O problema est√° no PHP-FPM: ele n√£o pode mais suportar a carga de 5 mil RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo mundo naquela √©poca estava falando sobre o processamento ass√≠ncrono da moda. Examinamos mais de perto, vimos o ReactPHP, realizamos testes r√°pidos, o substitu√≠mos pelo PHP-FPM e instantaneamente tivemos um aumento de 4 vezes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o reescrevemos o processamento do nosso processamento - o ReactPHP elevou a estrutura do Yii. Primeiro, criamos 4 servi√ßos ReactPHP e, mais tarde, atingimos 30. Por muito tempo, vivemos neles, e a estrutura lidou com a carga.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que expandimos o funil, ocorreu outro colapso: depois de iniciar o funil na recep√ß√£o, o processamento come√ßou a sofrer novamente. </font><font style="vertical-align: inherit;">Para resolver esse problema, decidimos separar o processamento em clusters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clusters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles pegaram bots, os distribu√≠ram em grupos e constru√≠ram cadeias l√≥gicas de Redis, Postgres e um manipulador. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, formamos o conceito de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Gal√°xia" - uma abstra√ß√£o f√≠sica l√≥gica sobre o processamento</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Consiste em inst√¢ncias: Redis, PostgreSQL e um conjunto de servi√ßos PHP. </font><font style="vertical-align: inherit;">Cada bot pertence a um cluster espec√≠fico e o ReactPHP sabe em qual cluster a mensagem para esse bot precisa ser inserida. </font><font style="vertical-align: inherit;">O esquema acima funciona mais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O universo est√° se expandindo, o universo de nossos sistemas tamb√©m, e adicionamos uma nova "gal√°xia" quando isso acontece.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gal√°xias s√£o a nossa maneira de escalar.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substituindo o ReactPHP por um monte de Nginx e Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos seis meses seguintes, continuamos a crescer: 200 milh√µes de assinantes e 3 bilh√µes de mensagens por m√™s. </font><font style="vertical-align: inherit;">Imagine um site para 200 milh√µes de usu√°rios registrados - a mesma carga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um novo problema surgiu. </font><font style="vertical-align: inherit;">Webhooks s√£o pequenas tarefas do mesmo tipo e o PHP n√£o √© adequado para resolv√™-las. </font><font style="vertical-align: inherit;">Mesmo o ReactPHP n√£o ajudou mais.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele n√£o conseguiu lidar com a carga de 10 mil RPS - desde a introdu√ß√£o do ReactPHP, a carga aumentou.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, era necess√°rio reinici√°-lo mesmo com implanta√ß√µes, sequencialmente, porque voc√™ n√£o pode interromper o processamento de webhooks de entrada. </font><font style="vertical-align: inherit;">O Facebook desativa o aplicativo quando percebe que est√° com problemas. </font><font style="vertical-align: inherit;">Para ManyChat, isso √© um desastre - 650 mil empresas que operam ativamente n√£o nos perdoar√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, gradualmente cortamos a l√≥gica diferente do ReactPHP, passamos para os processadores e isolamos novas filas. No processo, eles perceberam que o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP executa uma tarefa simples - pega um webhook e o coloca em uma fila</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Todo o resto √© feito por processamentos. Existem an√°logos para uma tarefa t√£o simples? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembramos que o Nginx possui m√≥dulos e notamos a biblioteca </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Al√©m de suportar a linguagem de programa√ß√£o Lua, ela tinha um m√≥dulo para trabalhar com Redis. Um teste escrito em 3 horas mostrou que todo o trabalho de 30 servi√ßos no ReactPHP pode ser feito diretamente no lado do nginx. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi assim: processamos algum tipo de terminal, selecionamos o corpo da solicita√ß√£o e o adicionamos diretamente ao Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty e Lua ajudaram a aumentar a taxa de transfer√™ncia. </font><font style="vertical-align: inherit;">Continuamos a lidar com a nossa carga de trabalho, o servi√ßo continua vivo, todos est√£o felizes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melhorando a solu√ß√£o em Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima etapa ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">observa√ß√£o: na √©poca do relat√≥rio</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fevereiro de 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 milh√µes de assinantes enviam e recebem 7 milh√µes de mensagens de um milh√£o de bots todos os meses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um passo para melhorar nossa solu√ß√£o em Lua. </font><font style="vertical-align: inherit;">Gradualmente, retire alguma l√≥gica das filas e transfira o processamento principal da distribui√ß√£o de webhooks entre sistemas para Lua. </font><font style="vertical-align: inherit;">Agora, nossos sistemas s√£o mais produtivos e menos dependentes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mantemos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processamento separado e processamento ass√≠ncrono</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O processamento diz respeito a estat√≠sticas e outras coisas - agora √© um sistema completamente diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema parece simples, mas n√£o √©. </font><font style="vertical-align: inherit;">Sob o cap√¥, existem 500 servi√ßos que processam seus pedidos. </font><font style="vertical-align: inherit;">Todo o sistema √© executado em 50 inst√¢ncias da Amazon: Redis, PostgreSQL e os pr√≥prios manipuladores de PHP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evolu√ß√£o do processamento</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highload pode ser legal de fazer em PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se brevemente de como fizemos isso no processo de desenvolvimento do sistema.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iniciado com Nginx e PHP-FPM regulares.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionadas filas ao PostgreSQL e depois ao Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster adicionado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP implementado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substitu√≠mos o ReactPHP por um monte de Nginx e Lua e depois movemos a l√≥gica para o grupo.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pela nossa experi√™ncia, descobrimos que √© poss√≠vel crescer e construir arquitetura alterando sucessivamente partes vulner√°veis, usando abordagens bem conhecidas e simples e, ao mesmo tempo, n√£o expandindo a pilha.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486824/index.html">Maus conselhos ao trabalhar com a ANTLR</a></li>
<li><a href="../pt486826/index.html">Criando um Viberbot completo no Django 2 e na API Riber do Viber. Parte Um - Webhook</a></li>
<li><a href="../pt486828/index.html">Food Design Digest, janeiro 2020</a></li>
<li><a href="../pt486832/index.html">Quantos anos taiga vai - n√£o entendo</a></li>
<li><a href="../pt486842/index.html">Consul + iptables =: 3</a></li>
<li><a href="../pt486850/index.html">Novo assento reservado - como um hotel c√°psula</a></li>
<li><a href="../pt486858/index.html">Criando um Viberbot completo. Parte dois - primeiro contato ou "conversion_started"</a></li>
<li><a href="../pt486860/index.html">ATX12VO - Comer uma nova maneira</a></li>
<li><a href="../pt486862/index.html">5 raz√µes pelas quais o design de movimento ajuda voc√™ a se conectar com as pessoas</a></li>
<li><a href="../pt486864/index.html">Migrando do OpenVPN para o WireGuard para ingressar em redes em uma rede L2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>