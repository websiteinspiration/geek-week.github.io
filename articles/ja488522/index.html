<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎻 😔 🤬 JOOQと彼のウサギの穴。冬眠なしで生き残る方法 🍩 🧑🏾‍🤝‍🧑🏽 😊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、JOOQに溺れることはありません。私はHibernateとその背後にあるすべてのSpring Data JPAパワーを好みます。しかし、記事はそれらについてではありません。
 
 
 
 HibernateとSpring Data JPAを使用する場合、内部プロセスについて考える必要は...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>JOOQと彼のウサギの穴。冬眠なしで生き残る方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488522/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、JOOQに溺れることはありません。</font><font style="vertical-align: inherit;">私はHibernateとその背後にあるすべてのSpring Data JPAパワーを好みます。</font><font style="vertical-align: inherit;">しかし、記事はそれらについてではありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wt/-0/co/wt-0condklmkd6zkb2ag_a46vb4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HibernateとSpring Data JPAを使用する場合、内部プロセスについて考える必要はありません。アノテーションを知っていて、リポジトリに正しいメソッド名を書き込む必要があります。これらの2つのモンスターが残りの作業を行います。</font><font style="vertical-align: inherit;">JOOQの場合、残念なことに、多くの人にとっては、少し緊張して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findAllByUserId（Long userId）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より多くを書く必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOOQとは何ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単なSQLクエリを書いてみましょう：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> countries c <span class="hljs-keyword">where</span> c.population &gt; <span class="hljs-number">10000000</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリクエストはコンソールで実行できます。</font><font style="vertical-align: inherit;">はい </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールのようには感じません。</font><font style="vertical-align: inherit;">アプリケーションにこのリクエストを送信してもらいます。</font><font style="vertical-align: inherit;">それは1回限りのスクリプトではなく、少なくとも構文について検証されたこと。</font><font style="vertical-align: inherit;">これは、Spring Data JPAを通じて行います。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllByPopulationAfter</span><span class="hljs-params">(Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記と同じリクエストがSpringによって実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの明確な利点は何ですか？</font><font style="vertical-align: inherit;">これは強力なフレームワークによって実行され、リクエストのエラーを検証します。</font><font style="vertical-align: inherit;">ただし、クエリ管理はフレームワークを処理します。</font><font style="vertical-align: inherit;">また、リクエストを完全に管理すると同時に、リクエストが完全に検証されるようにします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用する</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリ</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Query("select c from Country c where c.population &gt; :amount")</span>
<span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllPopulationGreaterThan</span><span class="hljs-params">(<span class="hljs-meta">@Param("amount")</span> Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLとDSLの間のそのようなトレードオフも良いです。</font><font style="vertical-align: inherit;">しかし、SQLをいじりたくない場合は、次のようなものを見て喜んでいます。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかのライブラリは、これに適している：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QueryDSL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speedment</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
QueryDSL Iについては</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書いた</font></font></u></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数年前。</font><font style="vertical-align: inherit;">私はスピードメントを掘りませんでしたが、それは単純なDSLジェネレーター以上のもののようであり、さらにSQLクエリコマンドを暗号化する方法を学ぶ必要があります。</font><font style="vertical-align: inherit;">一般的に、今日はJOOQについて話します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOOQクエリ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、すでに上記のクエリの1つを見てきました。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他に何がありますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、単純なgetリクエスト：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
またはリクエストを挿入：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、すべてが明確で、それ以上のものはありません。</font><font style="vertical-align: inherit;">しかし、これは一見しただけです。</font><font style="vertical-align: inherit;">このうさぎの穴がどのくらい深くなるかを調べるには、数週間かかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、最初から始めましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はい、それはメイブンになります</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はGradleを好みます。</font><font style="vertical-align: inherit;">しかし、何らかの理由で、JOOQ開発者はサードパーティのプラグインを提供することを提案し、Gradleにあまり注意を払っていません。</font><font style="vertical-align: inherit;">さて、トレーニングプロジェクトはMavenで行います。</font><font style="vertical-align: inherit;">しかし、あなた、親愛なる読者、それがgithubの奥深くであるはずのようにうろついており、Gradleで完全にカスタマイズされたプロジェクトを明らかにする準備ができている場合は、私に書いてください。あなたはこの記事の共著者になります。</font><font style="vertical-align: inherit;">同じことがH2にも当てはまります（トレーニングプロジェクトはPostgreSQL上にあります）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GradleとH2で成功しなかった理由</font></font></b><div class="spoiler_text">    ,      Gradle.           jooq-generator .          H2,  «  »   H2         ,   ,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なMaven依存関係：</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Spring Starters --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Database --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flywaydb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flyway-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Helpers --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${commons.lang3.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!--Test --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- JOOQ Generator --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-meta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Springには、application.ymlの指定された設定に従ってDataSourceを自己構成するJOOQスターターがすでにあります。</font><font style="vertical-align: inherit;">しかし、JOOQの完全な作業では、これだけでは不十分です。</font><font style="vertical-align: inherit;">エンティティを生成する必要があります。</font><font style="vertical-align: inherit;">はい、はい。エンティティは作成しませんが、生成します。</font><font style="vertical-align: inherit;">いわゆるテーブルファーストアプローチ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの操作に重点を置いた通常のアプリケーション構造は次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c-/pz/tp/c-pztpdxbkn5kxot-s_08tzlzbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスレイヤーまで、データはフラットモデル（DTO）の形式でアプリケーションを通過します。</font><font style="vertical-align: inherit;">さらに、サービスがデータベースと連携する必要がある場合、DTOをエンティティに変換し、それをリポジトリに送信します。そのサービスはすでにそれをデータベースに保存しています。</font><font style="vertical-align: inherit;">JOOQ開発者はすべてを異なる方法で見ています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/wy/4b/vvwy4bbp1ox57f4j0edmulfe7ni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、JOOQは標準パターンを真剣に改訂し、独自の方法を採用することにしました。</font><font style="vertical-align: inherit;">違いは重要です：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTOからエンティティへの変換は、すでにリポジトリで行われています。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのようにエンティティを作成することはありません。</font><font style="vertical-align: inherit;">これは、JOOQジェネレーターによって作成されました。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにこれで、JOOQはそれほど単純ではないと結論付けるのに十分です。</font><font style="vertical-align: inherit;">高度にカスタマイズ可能な生成されたエンティティ、DTOでの理解できないマッピング、およびその他の困難は、多くを驚かせます。</font><font style="vertical-align: inherit;">しかし、行き場がない場合、JOOQのこれらの側面に関する集中的な研究は、真剣に実行され、数日または数週間かかることもあります。</font><font style="vertical-align: inherit;">私の投稿によってあなたの時間を大幅に節約できると確信しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQでの作業の次の側面について説明します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンティティの生成。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRUDクエリの作成。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRUDリクエストの最適化。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そしてもう1つのCRUDリクエストの最適化。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準のJOOQライブラリを使用したエンティティのマッピング。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、なぜこれがすべて必要なのかを話し合います。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行こう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何を書くの？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトには2つのエンティティがあります：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
国：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Country</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> GovernmentForm governmentForm;
    <span class="hljs-keyword">private</span> Integer population;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> List&lt;City&gt; cities;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
市：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">City</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long countryId;
    <span class="hljs-keyword">private</span> String name;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1対多の関係。</font><font style="vertical-align: inherit;">国には多くの関連する市が含まれています。</font><font style="vertical-align: inherit;">市にはcountryIdが含まれています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flywayの移行は次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> countries<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>              bigserial primary <span class="hljs-keyword">key</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    government_form <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    population      <span class="hljs-built_in">int</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cities<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>         bigserial primary <span class="hljs-keyword">key</span>,<font></font>
    country_id <span class="hljs-built_in">bigint</span>,
    <span class="hljs-keyword">name</span>       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>)<font></font>
);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンティティの生成から始めましょう。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が言ったように、エンティティは別々に生成されます。</font><font style="vertical-align: inherit;">これを行うには2つの方法があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mavenプラグインを通じて。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javaコード。 </font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mavenでのエンティティの生成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトがビルドされると、Mavenがジェネレーターを起動してエンティティーを生成します。</font><font style="vertical-align: inherit;">また、いつでもジェネレータを呼び出してエンティティを生成できます。</font><font style="vertical-align: inherit;">これは、たとえばベースの構造が変更されたときに必要になります。</font><font style="vertical-align: inherit;">Mavenのプラグインは次のようになります。</font></font><br>
<br>
<pre><code class="xml hljs">            <span class="hljs-comment">&lt;!-- JOOQ Generator Plugin --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen-maven<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>generate-sources<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>generate<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">jdbc</span>&gt;</span>  <span class="hljs-comment">&lt;!--    --&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">driver</span>&gt;</span>${db.driver}<span class="hljs-tag">&lt;/<span class="hljs-name">driver</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>${db.url}<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>${db.username}<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>${db.password}<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">jdbc</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">generator</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">database</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>.*<span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span><font></font>
                                flyway_schema_history<font></font>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">inputSchema</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">inputSchema</span>&gt;</span>  <span class="hljs-comment">&lt;!--  --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">database</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">generate</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">records</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">records</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">generate</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--      --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">packageName</span>&gt;</span>ru.xpendence.jooqexample.domain<span class="hljs-tag">&lt;/<span class="hljs-name">packageName</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--  .    target. --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>target/generated-sources/jooq<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">generator</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを正しく行った場合は、Mavenを更新すると、プラグインの中にjooq-codegenが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/ch/pv/1nchpvafnxml7qle_dfsq1zsuje.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それを実行します。エンティティが生成されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/kf/la/cskfla2pzxfkm-vkot_dcggqoia.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは、データベースへのアクセスに使用するエンティティそのものです。最初の迷惑：それらは不変です。つまり、それらは変更可能ですが、タイプの変更はこのプロセスの説明が別の記事にプルされるような工夫された方法で発生します。したがって、テーブル生成の段階でデータ型について考え直してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンティティは奇妙に見えます。たとえば、以下はCountriesRecordクラスのシグネチャです。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountriesRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UpdatableRecordImpl</span>&lt;<span class="hljs-title">CountriesRecord</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Record4</span>&lt;<span class="hljs-title">Long</span>, <span class="hljs-title">String</span>, <span class="hljs-title">String</span>, <span class="hljs-title">Integer</span>&gt; </span>{
    <span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、CountriesRecordはRecord4を実装しています。これは4つの型で型付けされています。</font><font style="vertical-align: inherit;">国テーブルには4つの列があるため、Record4です。</font><font style="vertical-align: inherit;">都市には3つの列があるため、Record3です。</font><font style="vertical-align: inherit;">なぜこれが発明されたのか、私にはわかりません。</font><font style="vertical-align: inherit;">JOOQライブラリには22のそのようなレコード、Record1 ... Record22があります。</font><font style="vertical-align: inherit;">ここから、JOOQの機能は最大22列のテーブルの処理に限定されていると結論付けることができますが、これはそうではありません。</font><font style="vertical-align: inherit;">数十の列を持つテーブルがあり、JOOQはただちにRecordを実装します。</font><font style="vertical-align: inherit;">まあ、それは... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaコードでJOOQエンティティを生成することはこのようになります：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterStartupApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ContextRefreshedEvent</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.driver-class-name}")</span>
    <span class="hljs-keyword">private</span> String driver;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.url}")</span>
    <span class="hljs-keyword">private</span> String url;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.username}")</span>
    <span class="hljs-keyword">private</span> String username;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.password}")</span>
    <span class="hljs-keyword">private</span> String password;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.name}")</span>
    <span class="hljs-keyword">private</span> String databaseName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-includes}")</span>
    <span class="hljs-keyword">private</span> String databaseWithIncludes;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-input-schema}")</span>
    <span class="hljs-keyword">private</span> String databaseWithInputSchema;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.package-name}")</span>
    <span class="hljs-keyword">private</span> String targetPackageName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.directory}")</span>
    <span class="hljs-keyword">private</span> String targetDirectory;<font></font>
<font></font>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent contextRefreshedEvent)</span> </span>{
        <span class="hljs-keyword">new</span> GenerationTool().run(configureGenerator());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Configuration <span class="hljs-title">configureGenerator</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Configuration()<font></font>
                .withJdbc(<span class="hljs-keyword">new</span> Jdbc()<font></font>
                        .withDriver(driver)<font></font>
                        .withUrl(url)<font></font>
                        .withUser(username)<font></font>
                        .withPassword(password))<font></font>
                .withGenerator(<span class="hljs-keyword">new</span> Generator()<font></font>
                        .withDatabase(<span class="hljs-keyword">new</span> Database()<font></font>
                                .withName(databaseName)<font></font>
                                .withIncludes(databaseWithIncludes)<font></font>
                                .withExcludes(<span class="hljs-string">""</span>)<font></font>
                                .withInputSchema(databaseWithInputSchema))<font></font>
                        .withTarget(<span class="hljs-keyword">new</span> Target()<font></font>
                                .withPackageName(targetPackageName)<font></font>
                                .withDirectory(targetDirectory)));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の場合、すべての新しい移行がロールアップされ、データベースが最新の状態になったときに、アプリケーションが完全に起動した後にジェネレーターが起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、モデルがあり、エンティティがあり、ベースがあります。</font><font style="vertical-align: inherit;">リポジトリを作成してクエリを作成します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリを作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのリクエストはDslContextを通過します。</font><font style="vertical-align: inherit;">DslContextを繰り返します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Repository</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリが準備できました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRUDクエリの作成</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インサート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLを使用した場合、別の国を追加する要求は次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> countries(<span class="hljs-keyword">name</span>, government_form, population)
<span class="hljs-keyword">values</span> (<span class="hljs-string">' -'</span>, <span class="hljs-string">'UNITARY'</span>, <span class="hljs-number">100500</span>) <span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQでは、クエリはSQL構文に可能な限り近くなります。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertValues</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)  <span class="hljs-comment">//insert into countries</span>
                .values(country.getId(), country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))  <span class="hljs-comment">//values (? ? ? ?)</span>
                .returning()  <span class="hljs-comment">//returning</span>
                .fetchOne()  <span class="hljs-comment">//*</span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、複雑なことは何もありません。</font><font style="vertical-align: inherit;">ただし、このようなリクエストは適していません。私たちの場合、IDはデータベースで生成され、これを考慮する必要があるためです。</font><font style="vertical-align: inherit;">次のようなものを書いた場合：</font></font><br>
<br>
<pre><code class="java hljs">.values(<span class="hljs-keyword">null</span>, country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは得る </font></font><br>
<br>
<pre><code class="java hljs">org.postgresql.util.PSQLException: :     <span class="hljs-string">"id"</span>   NOT NULL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、アプリケーション側でIDを生成した場合、そのようなリクエストはライドになります。</font><font style="vertical-align: inherit;">各フィールドに特定の値を指定して、リクエストを書き直す必要があります。</font><font style="vertical-align: inherit;">だからあなたはできる：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne()<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、フィールドにオブジェクトを手動で設定します。</font><font style="vertical-align: inherit;">このオプションはかなり機能していますが、それよりも優れています。</font><font style="vertical-align: inherit;">Spring Data JPAで行われているように、オブジェクト全体を保存のために送信するのが理想的です：</font></font><br>
<br>
<pre><code class="java hljs">repository.save(country);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうかもしれません。</font><font style="vertical-align: inherit;">これを行うには、モデルをextends Recordエンティティにマップし、保存するために送信する必要があります。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))  <span class="hljs-comment">//   </span><font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法は、マッピングを構成する必要がない場合に最も簡単で最も理解しやすい方法です。</font><font style="vertical-align: inherit;">ただし、マッピングの設定は低くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
気づいたように、このクエリはエンティティ全体を返します。</font><font style="vertical-align: inherit;">fetch（）メソッドで正確に何を返す必要があるかを決定できます。</font><font style="vertical-align: inherit;">次のようになります。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">insertAndReturnId</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .returning(Countries.COUNTRIES.ID) <span class="hljs-comment">//  Record    - id</span><font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .get(Countries.COUNTRIES.ID); <span class="hljs-comment">// id</span>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し面倒ですが、何を比較するかについてです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残りのCRUDメソッドを記述します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLクエリ：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">update</span> countries
<span class="hljs-keyword">set</span> <span class="hljs-keyword">name</span>            = <span class="hljs-string">''</span>,<font></font>
    government_form = <span class="hljs-string">'CONFEDERATE'</span>,<font></font>
    population      = <span class="hljs-number">100500</span>
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">1</span>
<span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQリクエスト：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">update</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.update(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .where(Countries.COUNTRIES.ID.eq(country.getId()))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error updating entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLでのクエリは次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> *
<span class="hljs-keyword">from</span> countries c
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = ?;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQでは、クエリはそれに応じて検索されます。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES) <span class="hljs-comment">//select * from countries</span>
                .where(Countries.COUNTRIES.ID.eq(id))  <span class="hljs-comment">//where id = ?</span>
                .fetchAny()  <span class="hljs-comment">// ,    </span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">削除する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何も返さないというリクエストがあります。</font><font style="vertical-align: inherit;">このようなクエリは影響を受ける行の数を返します。</font><font style="vertical-align: inherit;">削除の場合、返されるものはありませんが、受け取った情報は引き続き役に立ちます。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">delete</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.deleteFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .execute() == <span class="hljs-number">1</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1行削除します。</font><font style="vertical-align: inherit;">したがって、SQLクエリは次のようなものを返します。</font></font><br>
<br>
<pre><code class="sql hljs">1 row affected in 5 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような回答を受け取ったので、行が削除されたことは確かです。</font><font style="vertical-align: inherit;">これで、操作が成功したと宣言できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おとぎ話ではなかった。</font><font style="vertical-align: inherit;">それは単なる潤滑剤でした。</font><font style="vertical-align: inherit;">通常のMaperを使用してRecord内のエンティティのシンマッピングを行う、またはその逆</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「わかりました」と読者は言う、「1対多のエモーはどこにあるの？」国が多くの都市とともに成長する瞬間を見たことがありませんでした。」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、あなたは正しいでしょう。これは休止状態ではなく、手動で行う必要があります。 ID = country.getId（）である市のリストを取得するだけです。通常のマッパーを使用してRecordをエンティティーにマップするinto（）メソッドはすでに示しました。ただし、JOOQには追加のmap（）メソッドがあり、これを使用してRecordで何でも好きなことができます。その機能を見て、都市の追加を追加しましょう：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; {<font></font>
                    Country country = r.into(Country.class);<font></font>
                    country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
                    <span class="hljs-keyword">return</span> country;<font></font>
                });<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、まずRecord in Countryをマップし、次に都市に別のリクエストを行います。この国のすべてのCityを取得して、それらを本質的に設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、そのようなセットは数十個存在する可能性があるため、要求は数十個存在する可能性があります。</font><font style="vertical-align: inherit;">そして、これらのリクエストをメソッドに直接記述することは、そのようなものです。</font><font style="vertical-align: inherit;">正しい解決策は、別のマッパーを記述し、そこにこれらすべてのリクエストを置くことです。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordMapper</span>&lt;<span class="hljs-title">CountriesRecord</span>, <span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CityRepository cityRepository;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">map</span><span class="hljs-params">(CountriesRecord record)</span> </span>{<font></font>
        Country country = record.into(Country.class);<font></font>
        country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
        <span class="hljs-keyword">return</span> country;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリは次のようになります。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">findWithCustomMapper</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; countryRecordMapper.map((CountriesRecord) r));<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より簡潔で、追加のロジックは含まれていません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OK、レコードをエンティティにマップする方法を学びましたが、レコード内のエンティティのマッピングを微調整するのはどうですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでのところ、次の設計になっています。</font></font><br>
<br>
<pre><code class="java hljs">.set(dsl.newRecord(Countries.COUNTRIES, country))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もういいですが、具体的にフィールドをマッピングする必要がある場合はどうでしょうか。</font><font style="vertical-align: inherit;">たとえば、LocalDateTimeがあり、TimestampのようなPostgreSQLのジェネレーターがOffsetDateTimeを生成しました。</font><font style="vertical-align: inherit;">この場合、フィールドは単にマッピングされず、データベースに記録されません。</font><font style="vertical-align: inherit;">そのような場合、同じことをするが反対方向の別のマッパーが必要になります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はい、マッパーごとにアンマッパーがあります</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼はそれと呼ばれています。</font><font style="vertical-align: inherit;">彼の相続人を書きましょう。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordUnmapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordUnmapper</span>&lt;<span class="hljs-title">Country</span>, <span class="hljs-title">CountriesRecord</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CountriesRecord <span class="hljs-title">unmap</span><span class="hljs-params">(Country country)</span> <span class="hljs-keyword">throws</span> MappingException </span>{<font></font>
        CountriesRecord record = dsl.newRecord(Countries.COUNTRIES, country);<font></font>
        record.setPopulation(-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> record;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションと一緒に挿入すると、次のようになります。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertWithUnmapper</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(countryRecordUnmapper.unmap(country))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見てのとおり、かなり。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論と結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
個人的には、Hibernateの方が好きです。</font><font style="vertical-align: inherit;">おそらく、アプリケーションの90 +％では、その使用はより正当化されます。</font><font style="vertical-align: inherit;">しかし、読者がすべての要求を制御したい場合は、JOOQまたは他の同様のライブラリーの方が適しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつものように、私はトレーニングプロジェクトを投稿します。</font><font style="vertical-align: inherit;">彼は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><u><font style="vertical-align: inherit;">ここに</font></u></a><font style="vertical-align: inherit;">横たわってい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja488504/index.html">Zabbixで制作カレンダーを接続します</a></li>
<li><a href="../ja488514/index.html">Androidリモートデバッガー-Androidアプリケーションのリモートデバッグ</a></li>
<li><a href="../ja488516/index.html">包括的なiframeタグガイド</a></li>
<li><a href="../ja488518/index.html">電子書籍の比較レビューONYX BOOX LivingstoneとAmazon Kindle Paperwhite（2018）</a></li>
<li><a href="../ja488520/index.html">BloopersとSquiggles。2</a></li>
<li><a href="../ja488528/index.html">AndroidプラットフォームでのPKCS＃11暗号トークンメカニズムの使用</a></li>
<li><a href="../ja488530/index.html">反応性とは何ですか？</a></li>
<li><a href="../ja488534/index.html">3Dフォトポリマーモデルの重合用DIY UVランプ400-405 nm</a></li>
<li><a href="../ja488536/index.html">Docker-in-DockerをCIまたはテスト環境で使用する前に注意深く検討してください。</a></li>
<li><a href="../ja488540/index.html">ガウス銃</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>