<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¬ ğŸ’ªğŸ½ ğŸ•¢ Top Fakapov Cyan ğŸ˜ âš«ï¸ ğŸ•¡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bon Ã  tous!Â 
 
 Je m'appelle Nikita, je suis chef d'Ã©quipe d'ingÃ©nieurs cyan. L'une de mes responsabilitÃ©s au sein de l'entreprise est de rÃ©duire Ã  zÃ©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Top Fakapov Cyan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cian/blog/499542/"><img src="https://habrastorage.org/webt/zy/iu/-q/zyiu-qkcptbeezgf_c5adiagete.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bon Ã  tous!&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je m'appelle Nikita, je suis chef d'Ã©quipe d'ingÃ©nieurs cyan. </font><font style="vertical-align: inherit;">L'une de mes responsabilitÃ©s au sein de l'entreprise est de rÃ©duire Ã  zÃ©ro le nombre d'incidents liÃ©s Ã  l'infrastructure de la prod. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui sera discutÃ© plus tard nous a apportÃ© beaucoup de souffrance, et le but de cet article est d'empÃªcher d'autres personnes de rÃ©pÃ©ter nos erreurs ou au moins de minimiser leur impact.&nbsp;</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PrÃ©ambule</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il Ã©tait une fois, lorsque Cyan consistait en monolithes, et qu'il n'y avait pas encore d'indices de microservices, nous avons mesurÃ© la disponibilitÃ© de la ressource en vÃ©rifiant 3-5 pages.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RÃ©ponse - tout va bien, ne rÃ©pondez pas longtemps - alerte. </font><font style="vertical-align: inherit;">Combien de temps ils ne devraient pas travailler pour que cela soit considÃ©rÃ© comme un incident, ont dÃ©cidÃ© les gens lors des rÃ©unions. </font><font style="vertical-align: inherit;">Une Ã©quipe d'ingÃ©nieurs a toujours Ã©tÃ© impliquÃ©e dans l'enquÃªte sur l'incident. </font><font style="vertical-align: inherit;">Une fois l'enquÃªte terminÃ©e, ils ont Ã©crit un post-mortem - une sorte de rapport au bureau de poste dans le format: ce qui Ã©tait, combien de temps, ce qu'ils ont fait sur le moment, ce que nous ferons Ã  l'avenir.&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les pages principales du site, ou si nous comprenons bien, ont cassÃ© le fond</font></font></h3>&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de comprendre d'une maniÃ¨re ou d'une autre la prioritÃ© de l'erreur, nous avons mis en Ã©vidence les pages les plus critiques du site pour la fonctionnalitÃ© commerciale. </font><font style="vertical-align: inherit;">Selon eux, nous considÃ©rons le nombre de demandes rÃ©ussies / infructueuses et de dÃ©lais d'attente. </font><font style="vertical-align: inherit;">Nous mesurons donc la disponibilitÃ©.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous dÃ©couvrions qu'il existe un certain nombre de sections super importantes du site qui sont responsables du service principal - recherche et soumission d'annonces. </font><font style="vertical-align: inherit;">Si le nombre de demandes qui ont Ã©chouÃ© est supÃ©rieur Ã  1%, il s'agit d'un incident critique. </font><font style="vertical-align: inherit;">Si, dans les 15 minutes en prime time, le pourcentage d'erreurs dÃ©passe 0,1%, cela est Ã©galement considÃ©rÃ© comme un incident critique. </font><font style="vertical-align: inherit;">Ces critÃ¨res couvrent la plupart des incidents, les autres dÃ©passent le cadre de cet article.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/mw/k9/otmwk90qyl-jcomorjhkofebrgq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les meilleurs incidents cyan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, nous avons prÃ©cisÃ©ment appris Ã  dÃ©terminer le fait que l'incident s'est produit.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, chaque incident dans notre pays est dÃ©crit en dÃ©tail et reflÃ©tÃ© dans l'Ã©popÃ©e de Jira. </font><font style="vertical-align: inherit;">Soit dit en passant: pour cela, nous avons lancÃ© un projet distinct, appelÃ© FAIL - seules des Ã©popÃ©es peuvent y Ãªtre crÃ©Ã©es.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous collectez tous les Ã©checs au cours des derniÃ¨res annÃ©es, les dirigeants sont:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incidents liÃ©s au mssql;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incidents causÃ©s par des facteurs externes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreurs d'administration.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArrÃªtons-nous plus en dÃ©tail sur les erreurs des administrateurs, ainsi que sur quelques autres Ã©checs intÃ©ressants.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CinquiÃ¨me place - Â«Mettre de l'ordre dans le DNSÂ»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'Ã©tait un mardi pluvieux. Nous avons dÃ©cidÃ© de nettoyer le cluster DNS.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voulais transfÃ©rer les serveurs DNS internes de bind vers powerdns, en mettant en Ã©vidence des serveurs complÃ¨tement sÃ©parÃ©s, oÃ¹ il n'y a rien Ã  part DNS.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons placÃ© un serveur DNS Ã  chaque emplacement de nos contrÃ´leurs de domaine et le moment est venu de dÃ©placer les zones de bind vers powerdns et de basculer l'infrastructure vers de nouveaux serveurs.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au plus fort du dÃ©mÃ©nagement, parmi tous les serveurs indiquÃ©s dans la liaison de mise en cache locale sur tous les serveurs, un seul se trouvait dans le centre de donnÃ©es de Saint-PÃ©tersbourg. Ce DC a Ã©tÃ© initialement dÃ©clarÃ© non critique pour nous, mais est soudainement devenu un point de dÃ©faillance unique.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juste au cours d'une telle pÃ©riode de dÃ©localisation, le canal entre Moscou et Saint-PÃ©tersbourg est tombÃ©. </font><font style="vertical-align: inherit;">Nous sommes restÃ©s sans DNS pendant cinq minutes et nous nous sommes levÃ©s lorsque l'hÃ©bergeur a rÃ©solu les problÃ¨mes.&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Si auparavant nous avons nÃ©gligÃ© les facteurs externes lors de la prÃ©paration du travail, maintenant ils sont Ã©galement inclus dans la liste de ce pour quoi nous nous prÃ©parons. </font><font style="vertical-align: inherit;">Et maintenant, nous nous efforÃ§ons de garantir que tous les composants sont rÃ©servÃ©s n-2, et pour la durÃ©e du travail, nous pouvons abaisser ce niveau Ã  n-1.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de l'Ã©laboration d'un plan d'action, marquez les points oÃ¹ le service peut tomber et rÃ©flÃ©chissez Ã  l'avance au scÃ©nario oÃ¹ tout s'est Â«pire que nulle partÂ».</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Distribuez les serveurs DNS internes par diffÃ©rentes gÃ©olocalisations / centres de donnÃ©es / racks / commutateurs / entrÃ©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur chaque serveur, placez un serveur DNS de mise en cache local, qui redirige les demandes vers les serveurs DNS principaux, et s'il n'est pas disponible, il rÃ©pondra Ã  partir du cache.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QuatriÃ¨me place - Â«Nettoyage de NginxÂ»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un beau jour, notre Ã©quipe a dÃ©cidÃ© que Â«assez pour le supporterÂ», et le processus de refactoring des configurations nginx a commencÃ©. </font><font style="vertical-align: inherit;">L'objectif principal est d'apporter des configs Ã  une structure intuitive. </font><font style="vertical-align: inherit;">Auparavant, tout Ã©tait Â«historiquement Ã©tabliÂ» et il n'y avait pas de logique en soi. </font><font style="vertical-align: inherit;">Maintenant, chaque nom_serveur a Ã©tÃ© extrait du fichier du mÃªme nom et distribuÃ© toutes les configurations dans des dossiers. </font><font style="vertical-align: inherit;">Ã€ propos, la configuration contient 253949 lignes ou 7836520 caractÃ¨res et occupe prÃ¨s de 7 mÃ©gaoctets. </font><font style="vertical-align: inherit;">Structure de haut niveau:&nbsp;</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure Nginx</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">â”œâ”€â”€ access<font></font>
â”‚ &nbsp; â”œâ”€â”€ allow.list<font></font>
...<font></font>
â”‚ &nbsp; â””â”€â”€ whitelist.conf<font></font>
â”œâ”€â”€ geobase<font></font>
â”‚ &nbsp; â”œâ”€â”€ exclude.conf<font></font>
...<font></font>
â”‚ &nbsp; â””â”€â”€ geo_ip_to_region_id.conf<font></font>
â”œâ”€â”€ geodb<font></font>
â”‚ &nbsp; â”œâ”€â”€ GeoIP.dat<font></font>
â”‚ &nbsp; â”œâ”€â”€ GeoIP2-Country.mmdb<font></font>
â”‚ &nbsp; â””â”€â”€ GeoLiteCity.dat<font></font>
â”œâ”€â”€ inc<font></font>
â”‚ &nbsp; â”œâ”€â”€ error.inc<font></font>
...<font></font>
â”‚ &nbsp; â””â”€â”€ proxy.inc<font></font>
â”œâ”€â”€ lists.d<font></font>
â”‚ &nbsp; â”œâ”€â”€ bot.conf<font></font>
...<font></font>
â”‚ &nbsp; â”œâ”€â”€ dynamic<font></font>
â”‚ &nbsp; â””â”€â”€ geo.conf<font></font>
â”œâ”€â”€ lua<font></font>
â”‚ &nbsp; â”œâ”€â”€ cookie.lua<font></font>
â”‚ &nbsp; â”œâ”€â”€ log<font></font>
â”‚ &nbsp; â”‚ &nbsp; â””â”€â”€ log.lua<font></font>
â”‚ &nbsp; â”œâ”€â”€ logics<font></font>
â”‚ &nbsp; â”‚ &nbsp; â”œâ”€â”€ include.lua<font></font>
â”‚ &nbsp; â”‚ &nbsp; â”œâ”€â”€ ...<font></font>
â”‚ &nbsp; â”‚ &nbsp; â””â”€â”€ utils.lua<font></font>
â”‚ &nbsp; â””â”€â”€ prom<font></font>
â”‚ &nbsp; &nbsp; &nbsp; â”œâ”€â”€ stats.lua<font></font>
â”‚ &nbsp; &nbsp; &nbsp; â””â”€â”€ stats_prometheus.lua<font></font>
â”œâ”€â”€ map.d<font></font>
â”‚ &nbsp; â”œâ”€â”€ access.conf<font></font>
â”‚ &nbsp; â”œâ”€â”€ ..&nbsp;<font></font>
â”‚ &nbsp; â””â”€â”€ zones.conf<font></font>
â”œâ”€â”€ nginx.conf<font></font>
â”œâ”€â”€ robots.txt<font></font>
â”œâ”€â”€ server.d<font></font>
â”‚ &nbsp; â”œâ”€â”€ cian.ru<font></font>
â”‚ &nbsp; â”‚ &nbsp; â”œâ”€â”€ cian.ru.conf<font></font>
â”‚ &nbsp; â”‚ &nbsp; â”œâ”€â”€ ...<font></font>
â”‚ &nbsp; â”‚ &nbsp; â””â”€â”€ my.cian.ru.conf<font></font>
â”œâ”€â”€ service.d<font></font>
â”‚ &nbsp; â”œâ”€â”€ ...<font></font>
â”‚ &nbsp; â””â”€â”€ status.conf<font></font>
â””â”€â”€ upstream.d<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;â”œâ”€â”€ cian-mcs.conf<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;â”œâ”€â”€ ...<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ wafserver.conf</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est devenu beaucoup mieux, mais dans le processus de changement de nom et de distribution des configurations, certaines d'entre elles avaient la mauvaise extension et ne tombaient pas dans la directive include * .conf. </font><font style="vertical-align: inherit;">En consÃ©quence, une partie des hÃ´tes est devenue indisponible et a renvoyÃ© 301 au principal. </font><font style="vertical-align: inherit;">Ã‰tant donnÃ© que le code de rÃ©ponse n'Ã©tait pas 5xx / 4xx, cela n'a pas Ã©tÃ© remarquÃ© immÃ©diatement, mais seulement le matin. </font><font style="vertical-align: inherit;">AprÃ¨s cela, nous avons commencÃ© Ã  Ã©crire des tests pour tester les composants d'infrastructure. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RÃ©sultats:</font></font></b>&nbsp;<br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structurez correctement les configurations (pas seulement nginx) et rÃ©flÃ©chissez Ã  la structure Ã  un stade prÃ©coce du projet. </font><font style="vertical-align: inherit;">Vous les rendrez ainsi plus comprÃ©hensibles pour l'Ã©quipe, ce qui rÃ©duira Ã  son tour le TTM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour certains composants d'infrastructure, Ã©crivez des tests. </font><font style="vertical-align: inherit;">Par exemple: vÃ©rifier que tous les noms de serveur clÃ©s renvoient l'Ã©tat correct, + corps de rÃ©ponse. </font><font style="vertical-align: inherit;">Il suffira d'avoir Ã  portÃ©e de main quelques scripts qui vÃ©rifient les fonctions de base du composant pour que vous ne vous souveniez pas frÃ©nÃ©tiquement Ã  3 heures du matin de ce qui doit Ãªtre vÃ©rifiÃ©.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TroisiÃ¨me place - Â«Place soudainement terminÃ©e Ã  CassandraÂ»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donnÃ©es augmentaient rÃ©guliÃ¨rement et tout allait bien jusqu'au moment oÃ¹ la rÃ©paration des gros cas a commencÃ© Ã  tomber dans le cluster Cassandra, car le compactage ne pouvait pas fonctionner sur eux.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un jour de pluie, la grappe s'est presque transformÃ©e en citrouille, Ã  savoir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les places sont restÃ©es environ 20% du cluster total;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il est impossible d'ajouter complÃ¨tement des nÅ“uds, car le nettoyage ne fonctionne pas aprÃ¨s l'ajout d'un nÅ“ud en raison du manque d'espace sur les partitions;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les performances diminuent lÃ©gÃ¨rement, car le compactage ne fonctionne pas;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le cluster est en mode d'urgence.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/lp/ah/ie/lpahie7bann64sajoibumpqbr5g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quitter - a ajoutÃ© 5 autres nÅ“uds sans nettoyage, aprÃ¨s quoi ils ont commencÃ© Ã  supprimer systÃ©matiquement du cluster et Ã  les ressaisir en tant que nÅ“uds vides sur lesquels la place s'est terminÃ©e. </font><font style="vertical-align: inherit;">Le temps a passÃ© beaucoup plus que nous ne le souhaiterions. </font><font style="vertical-align: inherit;">Il y avait un risque d'inaccessibilitÃ© partielle ou totale du cluster.&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RÃ©sultats:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les serveurs cassandra ne devraient pas occuper plus de 60% de l'espace sur chaque partition.&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils ne doivent pas Ãªtre chargÃ©s Ã  plus de 50% de CPU.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'obstruez pas la planification des capacitÃ©s et rÃ©flÃ©chissez-y pour chaque composant, en fonction de ses spÃ©cificitÃ©s.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus il y a de nÅ“uds dans le cluster, mieux c'est. </font><font style="vertical-align: inherit;">Les serveurs contenant une petite quantitÃ© de donnÃ©es sont migrÃ©s plus rapidement et un tel cluster est plus facile Ã  rÃ©animer.&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeuxiÃ¨me place - Â«Les donnÃ©es du stockage de valeur-clÃ© du consul ont disparuÂ»</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la dÃ©couverte de services, nous, comme beaucoup, utilisons le consul. Mais ici, sa valeur-clÃ© est Ã©galement utilisÃ©e pour les calculs de monolithes bleu-vert. Il stocke les informations en amont actives et inactives, qui changent de place pendant le dÃ©ploiement. Pour cela, un service de dÃ©ploiement a Ã©tÃ© Ã©crit qui interagit avec KV. Ã€ un moment donnÃ©, les donnÃ©es de KV ont disparu. RÃ©cupÃ©rÃ© de la mÃ©moire, mais avec un certain nombre d'erreurs. En consÃ©quence, lors du calcul, la charge sur l'amont a Ã©tÃ© inÃ©galement rÃ©partie et nous avons eu beaucoup d'erreurs 502 en raison de la surcharge des backends sur le CPU. En consÃ©quence, nous sommes passÃ©s du consul KV aux postgres, d'oÃ¹ il n'est pas si facile de les retirer.&nbsp;&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RÃ©sultats:</font></font><br>
</b><br>
<ul>
<li>  -           . ,       ES â€”        ,    ,   ,    action.destructive_requires_name: true.</li>
<li>      . ,    ( , &nbsp;python),      .</li>
</ul><br>
<h4>  â€” Â« Â»&nbsp;</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã€ un moment donnÃ©, nous avons remarquÃ© une rÃ©partition inÃ©gale de la charge sur le nginx en amont dans les cas oÃ¹ il y avait 10+ serveurs dans le backend. Ã‰tant donnÃ© que le round-robin envoyait les demandes de 1 au dernier en amont dans l'ordre, et que chaque rechargement de nginx commenÃ§ait depuis le dÃ©but, le premier en amont avait toujours plus de demandes que les autres. En consÃ©quence, ils travaillaient plus lentement et l'ensemble du site en souffrait. Cela est devenu plus visible Ã  mesure que la quantitÃ© de trafic augmentait. La simple mise Ã  jour de nginx pour activer random n'a pas fonctionnÃ© - vous devez refaire un tas de code lua qui n'a pas dÃ©collÃ© sur la version 1.15 (Ã  ce moment). J'ai dÃ» patcher notre nginx 1.14.2, en y introduisant un support alÃ©atoire. Cela a rÃ©solu le problÃ¨me. Ce bug remporte la nomination "non-Ã©vidence du capitaine". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il Ã©tait trÃ¨s intÃ©ressant et passionnant d'Ã©tudier ce bug).&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez la surveillance de sorte qu'elle aide Ã  trouver rapidement de telles fluctuations. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez utiliser ELK pour surveiller les rps sur chaque backend de chaque amont, et surveiller leur temps de rÃ©ponse du point de vue de nginx. </font><font style="vertical-align: inherit;">Dans ce cas, cela nous a aidÃ©s Ã  identifier le problÃ¨me.&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consÃ©quence, la plupart des Ã©checs auraient pu Ãªtre Ã©vitÃ©s avec une approche plus scrupuleuse de ce que vous faites. </font><font style="vertical-align: inherit;">Vous devez toujours vous souvenir de la loi de Murphy:&nbsp; </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout ce qui peut mal tourner va mal,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et construire des composants en fonction de cela.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499528/index.html">Un pont mathÃ©matique "Ã©tonnant" qui s'Ã©tend au-delÃ  du grand thÃ©orÃ¨me de Fermat</a></li>
<li><a href="../fr499532/index.html">Les mots en chiffres: blog gratuit analytics habravebinary avec Yandex.Metrica</a></li>
<li><a href="../fr499534/index.html">Guide de dÃ©veloppement du service backend Python</a></li>
<li><a href="../fr499536/index.html">Growbox comme mÃ©thode de se connaÃ®tre</a></li>
<li><a href="../fr499540/index.html">Fonctionnement du rendu de jeu 3D: texturation et filtrage de texture</a></li>
<li><a href="../fr499544/index.html">Apprenez les rÃ©seaux de neurones dans Google Sheets</a></li>
<li><a href="../fr499546/index.html">DÃ©veloppement de firmware pour une camÃ©ra vidÃ©o analogique EVR-Y2022F</a></li>
<li><a href="../fr499548/index.html">Masque - prendre soin des autres ou une illusion de sÃ©curitÃ©?</a></li>
<li><a href="../fr499550/index.html">Solutions Ã©co-low-code</a></li>
<li><a href="../fr499556/index.html">Serveur de jeu sur MS Orleans - Partie 3: RÃ©sumÃ©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>