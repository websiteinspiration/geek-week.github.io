<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙎🏽 🐠 ⏮️ Fehlende DNS Cloud Support Story aus Google Cloud 👶🏼 🤚🏼 😱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Von einem Google Blog-Editor: Haben Sie sich jemals gefragt, wie die Ingenieure von Google Cloud Technical Solutions (TSE) mit Ihren technischen Suppo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fehlende DNS Cloud Support Story aus Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Von einem Google Blog-Editor:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Haben Sie sich jemals gefragt, wie die Ingenieure von Google Cloud Technical Solutions (TSE) mit Ihren technischen Supportanrufen umgehen? Die technischen Support-Ingenieure von TSE sind dafür verantwortlich, die von den Benutzern identifizierten Problemquellen zu ermitteln und zu beheben. Einige dieser Probleme sind recht einfach, aber manchmal stößt man auf einen Appell, der die Aufmerksamkeit mehrerer Ingenieure gleichzeitig erfordert. In diesem Artikel wird uns einer der TSE-Mitarbeiter über ein sehr kniffliges Problem aus seiner jüngsten Praxis berichten - den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fall fehlender DNS-Pakete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Im Verlauf dieser Geschichte werden wir sehen, wie es den Ingenieuren gelungen ist, die Situation zu lösen, und welche neuen Dinge sie im Verlauf der Fehlerbehebung gelernt haben. Wir hoffen, dass diese Geschichte Ihnen nicht nur über einen tief verwurzelten Fehler berichtet, sondern auch ein Verständnis für die Prozesse vermittelt, die beim Senden einer Anfrage zur Unterstützung von Google Cloud auftreten.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Die Fehlerbehebung ist sowohl eine Wissenschaft als auch eine Kunst. Alles beginnt mit der Erstellung einer Hypothese über die Ursache des nicht standardmäßigen Verhaltens des Systems, wonach es auf Festigkeit geprüft wird. Bevor wir jedoch eine Hypothese formulieren, müssen wir das Problem klar identifizieren und genau formulieren. Wenn die Frage zu vage klingt, müssen Sie alles richtig analysieren. Dies ist die "Kunst" der Fehlerbehebung.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Kontext von Google Cloud sind solche Prozesse manchmal kompliziert, da Google Cloud Schwierigkeiten hat, die Privatsphäre seiner Nutzer zu gewährleisten. </font><font style="vertical-align: inherit;">Aus diesem Grund haben TSE-Ingenieure weder Zugriff auf die Bearbeitung Ihrer Systeme noch auf die Möglichkeit, Konfigurationen so umfassend anzuzeigen wie Benutzer. </font><font style="vertical-align: inherit;">Um eine unserer Hypothesen zu testen, können wir (Ingenieure) das System daher nicht schnell ändern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige Benutzer glauben, dass wir alles reparieren werden, als ob die Mechaniker im Autoservice, und uns einfach die ID der virtuellen Maschine senden würden, während der Prozess in Wirklichkeit in einem Konversationsformat abläuft: Sammeln von Informationen, Generieren und Bestätigen (oder Widerlegen) von Hypothesen und letztendlich Lösen Probleme beruhen auf der Kommunikation mit dem Kunden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem in Betracht gezogen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute haben wir eine Geschichte mit einem guten Ende. </font><font style="vertical-align: inherit;">Einer der Gründe für die erfolgreiche Lösung des vorgeschlagenen Falls ist eine sehr detaillierte und genaue Beschreibung des Problems. </font><font style="vertical-align: inherit;">Unten sehen Sie eine Kopie des ersten Tickets (bearbeitet, um vertrauliche Informationen zu verbergen): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Nachricht enthält viele nützliche Informationen für uns:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Angegebene VM</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Problem wird angezeigt - DNS funktioniert nicht</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es wird angezeigt, wo sich das Problem manifestiert - VM und Container</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Schritte, die der Benutzer unternommen hat, um das Problem zu identifizieren, werden angezeigt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Beschwerde wurde als „P1: Kritische Auswirkung - In der Produktion nicht verwendbarer Service“ registriert. Dies bedeutet eine ständige Überwachung der Situation rund um die Uhr gemäß dem Schema „Follow the Sun“ (der Link kann detaillierter über die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prioritäten von Benutzeranrufen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gelesen werden </font><font style="vertical-align: inherit;">), wobei die Übermittlung von einem technischen Supportteam erfolgt zum anderen bei jeder Zeitzonenverschiebung. </font><font style="vertical-align: inherit;">Als das Problem unser Team in Zürich erreichte, gelang es ihr tatsächlich, den Globus zu umrunden. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt ergriff der Benutzer Maßnahmen, um die Folgen zu verringern. Er befürchtete jedoch eine Wiederholung der Produktionssituation, da der Hauptgrund immer noch nicht gefunden wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als das Ticket Zürich erreichte, hatten wir bereits folgende Informationen zur Hand:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inhalt </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inhalt </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die vom Befehl kompilierte </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcap-Datei</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesen Daten waren wir bereit, mit der Phase der „Untersuchung“ und Fehlerbehebung zu beginnen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere ersten Schritte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst haben wir die Protokolle und den Status des Metadatenservers überprüft und sichergestellt, dass er ordnungsgemäß funktioniert. </font><font style="vertical-align: inherit;">Der Metadatenserver antwortet mit der IP-Adresse 169.254.169.254 und ist unter anderem für die Steuerung der Domainnamen verantwortlich. </font><font style="vertical-align: inherit;">Wir haben außerdem überprüft, ob die Firewall mit VM ordnungsgemäß funktioniert und keine Pakete blockiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war ein seltsames Problem: Der nmap-Test widerlegte unsere Haupthypothese über den Verlust von UDP-Paketen, sodass wir mental mehrere weitere Optionen und Möglichkeiten ableiteten, diese zu überprüfen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verschwinden Pakete selektiv? </font><font style="vertical-align: inherit;">=&gt; Überprüfen Sie die iptables-Regeln</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu klein </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Ausgabe prüfen</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betrifft das Problem nur UDP-Pakete oder TCP? </font><font style="vertical-align: inherit;">=&gt; Wegfahren</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Werden generierte Dig-Pakete zurückgegeben? </font><font style="vertical-align: inherit;">=&gt; Wegfahren</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktioniert libdns richtig? </font><font style="vertical-align: inherit;">=&gt; Fahren Sie weg </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um die Paketübertragung in beide Richtungen zu überprüfen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier beschließen wir, den Benutzer anzurufen, um Fehler live zu beheben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während des Anrufs können wir verschiedene Dinge überprüfen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach mehreren Überprüfungen schließen wir iptables-Regeln aus der Liste der Gründe aus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir überprüfen Netzwerkschnittstellen und Routing-Tabellen und überprüfen die MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir stellen fest, dass </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) so funktioniert, wie es sollte, aber </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) nicht funktioniert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachdem es </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ausgeführt wurde, während es funktioniert </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, stellen wir fest, dass UDP-Pakete zurückgegeben werden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir rennen </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und sehen, wie Dig richtig anruft </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der zweite wird jedoch durch Timeout unterbrochen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist die Schicht kurz vor dem Ende und wir sind gezwungen, das Problem in die nächste Zeitzone zu übertragen. Der Appell weckte jedoch das Interesse an unserem Team, und ein Kollege schlägt vor, das Quell-DNS-Paket mit dem Python-Modul Scrapy zu erstellen.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Fragment erstellt ein DNS-Paket und sendet die Anforderung an den Metadatenserver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Benutzer führt den Code aus, die DNS-Antwort wird zurückgegeben und die Anwendung empfängt sie, wodurch das Fehlen eines Problems auf Netzwerkebene bestätigt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der nächsten "Weltreise" kehrt der Appell zu unserem Team zurück, und ich übersetze ihn vollständig auf mich selbst, da ich glaube, dass es für den Benutzer bequemer ist, wenn der Appell nicht mehr von Ort zu Ort kreist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Zwischenzeit erklärt sich der Benutzer damit einverstanden, eine Momentaufnahme des Systemabbilds bereitzustellen. Dies sind sehr gute Nachrichten: Die Möglichkeit, das System selbst zu testen, beschleunigt die Fehlerbehebung erheblich, da Sie den Benutzer nicht mehr auffordern müssen, Befehle auszuführen, mir Ergebnisse zu senden und diese zu analysieren. Ich kann alles selbst tun!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kollegen beginnen mich ein wenig zu beneiden. </font><font style="vertical-align: inherit;">Beim Mittagessen besprechen wir den Appell, aber niemand hat eine Ahnung, was los ist. </font><font style="vertical-align: inherit;">Glücklicherweise hat der Benutzer selbst bereits Minderungsmaßnahmen ergriffen und hat es nicht eilig, sodass wir Zeit haben, das Problem vorzubereiten. </font><font style="vertical-align: inherit;">Und da wir ein Bild haben, können wir alle Tests durchführen, die uns interessieren. </font><font style="vertical-align: inherit;">Fein!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einen Schritt zurückgehen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der häufigsten Fragen in einem Interview für einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Systemingenieur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lautet: "Was passiert, wenn Sie </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">www.google.com anpingen</font></a><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">Die Frage ist vornehm, weil der Kandidat von der Shell über den Benutzerraum bis zum Kern des Systems und weiter zum Netzwerk beschrieben werden muss. </font><font style="vertical-align: inherit;">Ich lächle: Manchmal sind Interviewfragen auch im wirklichen Leben nützlich ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich beschließe, diese eychar-Frage auf das aktuelle Problem anzuwenden. </font><font style="vertical-align: inherit;">Wenn Sie versuchen, den DNS-Namen zu ermitteln, geschieht ungefähr Folgendes:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anwendung ruft die Systembibliothek auf, z. B. libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns überprüft die Systemkonfiguration, welchen DNS-Server es verwenden soll (im Diagramm ist es 169.254.169.254, Metadatenserver)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns verwendet Systemaufrufe, um einen UDP-Socket (SOKET_DGRAM) zu erstellen und UDP-Pakete mit einer DNS-Anforderung in beide Richtungen zu senden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Über die sysctl-Schnittstelle können Sie den UDP-Stack auf Kernelebene konfigurieren</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Kernel interagiert mit der Hardware, um Pakete über eine Netzwerkschnittstelle über das Netzwerk zu übertragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Hypervisor fängt das Paket ab und leitet es an den Metadatenserver weiter, wenn es damit in Kontakt kommt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Metadatenserver ermittelt den DNS-Namen anhand seiner Hexerei und gibt die Antwort auf die gleiche Weise zurück</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte Sie daran erinnern, welche Hypothesen wir bereits berücksichtigt haben: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Defekte Bibliotheken</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: Führen Sie strace im System aus und überprüfen Sie, ob dig die richtigen Systemaufrufe verursacht</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Richtige Systemaufrufe werden aufgerufen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Durch Srapy, um zu überprüfen, ob wir die Namen unter Umgehung der Systembibliotheken ermitteln können</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: wir können</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 3: Führen Sie rpm –V für das libdns-Paket und die md5sum-Bibliotheksdateien aus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Der Bibliothekscode ist vollständig identisch mit dem Code im funktionierenden Betriebssystem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 4: Mounten Sie das Image des Stammsystems des Benutzers ohne dieses Verhalten auf der VM, führen Sie chroot aus und prüfen Sie, ob DNS funktioniert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: DNS funktioniert ordnungsgemäß</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung basierend auf Tests: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht in Bibliotheken. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Es liegt ein Fehler in den DNS-Einstellungen vor</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: Überprüfen Sie tcpdump und prüfen Sie, ob DNS-Pakete nach dem Ausführen von dig korrekt gesendet und zurückgegeben werden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Pakete werden korrekt übertragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Überprüfen Sie den Server erneut </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: alles ist richtig</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testbasierte Schlussfolgerung: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht in der DNS-Konfigurationshypothese </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Kernel beschädigt</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test: Installieren Sie einen neuen Kernel, überprüfen Sie die Signatur und starten Sie ihn neu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: ähnliches Verhalten</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung basierend auf Tests: Der</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kernel ist nicht beschädigt </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Falsches Verhalten des Benutzernetzwerks (oder der Netzwerkschnittstelle des Hypervisors)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: Überprüfen Sie die Firewall-Einstellungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Firewall leitet DNS-Pakete sowohl auf dem Host als auch auf dem GCP weiter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Abfangen des Datenverkehrs und Verfolgen der Richtigkeit der Übertragung und Rückgabe von DNS-Abfragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: tcpdump bestätigt den Empfang von Rückpaketen durch den Host</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testbasierte Schlussfolgerung: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht im Netzwerk. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Der Metadatenserver funktioniert nicht</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: Überprüfen Sie die Metadatenserverprotokolle auf Anomalien</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Protokolle enthalten keine Anomalien</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Umgehen Sie den Metadatenserver </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Berechtigung wird auch ohne Verwendung eines Metadatenservers verletzt</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test-basiertes Fazit: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem ist nicht in dem Metadaten - </font><font style="vertical-align: inherit;">Server </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir alle Subsysteme mit </font><font style="vertical-align: inherit;">Ausnahme der getesteten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laufzeiteinstellungen!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eintauchen in die Kernel-Laufzeiteinstellungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Kernel-Laufzeit zu konfigurieren, können Sie die Befehlszeilenoptionen (grub) oder die sysctl-Schnittstelle verwenden. </font><font style="vertical-align: inherit;">Ich habe reingeschaut </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und nur gedacht, ich habe ein paar benutzerdefinierte Einstellungen gefunden. </font><font style="vertical-align: inherit;">Ich hatte das Gefühl, etwas ergriffen zu haben, und entließ alle Nicht-Netzwerk- oder Nicht-TCP-Einstellungen, die von den Bergeinstellungen übrig blieben </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dann wandte ich mich an die Stelle, an der die VM über die Host-Berechtigungen verfügt, und begann nacheinander die Einstellungen für die defekte VM anzuwenden, bis ich den Verbrecher erreichte:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist es, eine DNS-brechende Konfiguration! Ich habe ein Instrument des Verbrechens gefunden. Aber warum passiert das? Ich brauchte noch ein Motiv. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Festlegen der Basisgröße des DNS-Paketpuffers erfolgt über </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ein typischer Wert variiert irgendwo innerhalb von 200 KB. Wenn Ihr Server jedoch viele DNS-Pakete empfängt, können Sie den Puffer vergrößern. Wenn der Puffer zum Zeitpunkt des Eintreffens eines neuen Pakets voll ist, z. B. weil die Anwendung es nicht schnell genug verarbeitet, verlieren Sie Pakete. Unser Client hat die Puffergröße korrekt erhöht, weil er Angst vor Datenverlust hatte, weil er die Anwendung zum Sammeln von Metriken über DNS-Pakete verwendet hat. Der von ihm festgelegte Wert war das maximal mögliche: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (wenn Sie 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> festlegen </font><font style="vertical-align: inherit;">, gibt der Kernel "UNGÜLTIGES ARGUMENT" zurück).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plötzlich wurde mir klar, warum nmap und scapy richtig funktionierten: Sie verwendeten rohe Sockel! Raw-Sockets unterscheiden sich von normalen Sockets: Sie umgehen iptables und sind nicht gepuffert! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber warum verursacht ein „zu großer Puffer“ Probleme? Es funktioniert offensichtlich nicht wie beabsichtigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt konnte ich das Problem auf mehreren Kernen und mehreren Verteilungen reproduzieren. Das Problem hat sich bereits im 3.x-Kernel manifestiert und manifestiert sich nun auch im 5.x-Kernel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Tat beim Start</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS funktioniert nicht mehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich begann über einen einfachen binären Suchalgorithmus nach Arbeitswerten zu suchen und stellte fest, dass das System mit 2147481343 funktioniert. Diese Zahl war jedoch für mich ein bedeutungsloser Satz von Zahlen. Ich habe den Kunden eingeladen, diese Nummer auszuprobieren, und er antwortete, dass das System mit google.com funktioniert, aber dennoch einen Fehler mit anderen Domains gemeldet hat, sodass ich meine Untersuchung fortsetzte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installiert </font><font style="vertical-align: inherit;">, ein Tool, das ich vorher hätte verwenden sollen: Es zeigt, wo genau das Paket im Kernel ist. Die Funktion war schuldig </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ich habe die Kernelquellen heruntergeladen und verschiedene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionen</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hinzugefügt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">, um</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu verfolgen, wo das Paket speziell hinkommt. Ich fand schnell den richtigen Zustand</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und starrte ihn eine Weile einfach an, denn dann kam schließlich alles zu einem ganzen Bild zusammen: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, eine bedeutungslose Zahl, eine leere Domäne ... Es war ein Stück Code in </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat den Typ int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist vom Typ u16 (vorzeichenloses 16-Bit-Int) und speichert die Paketgröße</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist vom Typ int und speichert die Größe des Puffers, die per Definition gleich dem Wert in ist </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sich 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nähern </font><font style="vertical-align: inherit;">, kann das Summieren der Paketgröße zu einem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganzzahligen Überlauf führen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und da es sich um ein int handelt, wird sein Wert negativ, sodass die Bedingung wahr wird, wenn sie falsch sein sollte (mehr dazu finden Sie unter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bezugnahme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Fehler wird auf triviale Weise korrigiert: durch Casting auf </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ich habe den Patch angewendet und das System neu gestartet. Danach hat der DNS wieder funktioniert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geschmack des Sieges</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe meine Ergebnisse an den Client weitergeleitet und den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kernel-Patch </font><font style="vertical-align: inherit;">gesendet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ich bin zufrieden: Jedes Puzzleteil hat sich zu einem Ganzen zusammengeschlossen. Ich kann genau erklären, warum wir das beobachtet haben, was wir beobachtet haben, und vor allem konnten wir durch Zusammenarbeit eine Lösung für das Problem finden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist erwähnenswert, dass sich der Fall als selten herausstellte, und glücklicherweise werden solche komplexen Anrufe selten von Benutzern von uns empfangen.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503096/index.html">Warum möchten Manager, dass Mitarbeiter recyceln?</a></li>
<li><a href="../de503100/index.html">Internetkopf</a></li>
<li><a href="../de503106/index.html">Nicht standardmäßige Entdeckungsverdauung: Genealogie von Raubpflanzen, Pilzen auf Twitter und Lachgas aus Guano</a></li>
<li><a href="../de503108/index.html">Acht Farben des Regenbogens: Über Farbe in Bezug auf Mathematik</a></li>
<li><a href="../de503110/index.html">Digitale Epidemie: CoronaVirus gegen CoViper</a></li>
<li><a href="../de503118/index.html">David Yang - über Nicht-Invasivität, Krisen und verbrannte Erde</a></li>
<li><a href="../de503126/index.html">Likbez über VPS: So konfigurieren Sie den Remotedesktop, wenn Sie ein Win-Benutzer sind</a></li>
<li><a href="../de503128/index.html">Einbetten von ColorPicker in JavaScript Gantt zum Ändern von Farbaufgaben</a></li>
<li><a href="../de503132/index.html">Hochgeschwindigkeits-Apache-Parkett in Python mit Apache-Pfeil</a></li>
<li><a href="../de503134/index.html">Management = Team + Produkt. Wir enthüllen die Formel dieses Jahres: die nützlichste für Menschen und für Menschen bei DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>