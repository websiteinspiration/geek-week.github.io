<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôéüèΩ üê† ‚èÆÔ∏è Fehlende DNS Cloud Support Story aus Google Cloud üë∂üèº ü§öüèº üò±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Von einem Google Blog-Editor: Haben Sie sich jemals gefragt, wie die Ingenieure von Google Cloud Technical Solutions (TSE) mit Ihren technischen Suppo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fehlende DNS Cloud Support Story aus Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Von einem Google Blog-Editor:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Haben Sie sich jemals gefragt, wie die Ingenieure von Google Cloud Technical Solutions (TSE) mit Ihren technischen Supportanrufen umgehen? Die technischen Support-Ingenieure von TSE sind daf√ºr verantwortlich, die von den Benutzern identifizierten Problemquellen zu ermitteln und zu beheben. Einige dieser Probleme sind recht einfach, aber manchmal st√∂√üt man auf einen Appell, der die Aufmerksamkeit mehrerer Ingenieure gleichzeitig erfordert. In diesem Artikel wird uns einer der TSE-Mitarbeiter √ºber ein sehr kniffliges Problem aus seiner j√ºngsten Praxis berichten - den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fall fehlender DNS-Pakete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Im Verlauf dieser Geschichte werden wir sehen, wie es den Ingenieuren gelungen ist, die Situation zu l√∂sen, und welche neuen Dinge sie im Verlauf der Fehlerbehebung gelernt haben. Wir hoffen, dass diese Geschichte Ihnen nicht nur √ºber einen tief verwurzelten Fehler berichtet, sondern auch ein Verst√§ndnis f√ºr die Prozesse vermittelt, die beim Senden einer Anfrage zur Unterst√ºtzung von Google Cloud auftreten.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Die Fehlerbehebung ist sowohl eine Wissenschaft als auch eine Kunst. Alles beginnt mit der Erstellung einer Hypothese √ºber die Ursache des nicht standardm√§√üigen Verhaltens des Systems, wonach es auf Festigkeit gepr√ºft wird. Bevor wir jedoch eine Hypothese formulieren, m√ºssen wir das Problem klar identifizieren und genau formulieren. Wenn die Frage zu vage klingt, m√ºssen Sie alles richtig analysieren. Dies ist die "Kunst" der Fehlerbehebung.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Kontext von Google Cloud sind solche Prozesse manchmal kompliziert, da Google Cloud Schwierigkeiten hat, die Privatsph√§re seiner Nutzer zu gew√§hrleisten. </font><font style="vertical-align: inherit;">Aus diesem Grund haben TSE-Ingenieure weder Zugriff auf die Bearbeitung Ihrer Systeme noch auf die M√∂glichkeit, Konfigurationen so umfassend anzuzeigen wie Benutzer. </font><font style="vertical-align: inherit;">Um eine unserer Hypothesen zu testen, k√∂nnen wir (Ingenieure) das System daher nicht schnell √§ndern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige Benutzer glauben, dass wir alles reparieren werden, als ob die Mechaniker im Autoservice, und uns einfach die ID der virtuellen Maschine senden w√ºrden, w√§hrend der Prozess in Wirklichkeit in einem Konversationsformat abl√§uft: Sammeln von Informationen, Generieren und Best√§tigen (oder Widerlegen) von Hypothesen und letztendlich L√∂sen Probleme beruhen auf der Kommunikation mit dem Kunden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem in Betracht gezogen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute haben wir eine Geschichte mit einem guten Ende. </font><font style="vertical-align: inherit;">Einer der Gr√ºnde f√ºr die erfolgreiche L√∂sung des vorgeschlagenen Falls ist eine sehr detaillierte und genaue Beschreibung des Problems. </font><font style="vertical-align: inherit;">Unten sehen Sie eine Kopie des ersten Tickets (bearbeitet, um vertrauliche Informationen zu verbergen): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Nachricht enth√§lt viele n√ºtzliche Informationen f√ºr uns:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Angegebene VM</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Problem wird angezeigt - DNS funktioniert nicht</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es wird angezeigt, wo sich das Problem manifestiert - VM und Container</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Schritte, die der Benutzer unternommen hat, um das Problem zu identifizieren, werden angezeigt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Beschwerde wurde als ‚ÄûP1: Kritische Auswirkung - In der Produktion nicht verwendbarer Service‚Äú registriert. Dies bedeutet eine st√§ndige √úberwachung der Situation rund um die Uhr gem√§√ü dem Schema ‚ÄûFollow the Sun‚Äú (der Link kann detaillierter √ºber die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Priorit√§ten von Benutzeranrufen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gelesen werden </font><font style="vertical-align: inherit;">), wobei die √úbermittlung von einem technischen Supportteam erfolgt zum anderen bei jeder Zeitzonenverschiebung. </font><font style="vertical-align: inherit;">Als das Problem unser Team in Z√ºrich erreichte, gelang es ihr tats√§chlich, den Globus zu umrunden. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt ergriff der Benutzer Ma√ünahmen, um die Folgen zu verringern. Er bef√ºrchtete jedoch eine Wiederholung der Produktionssituation, da der Hauptgrund immer noch nicht gefunden wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als das Ticket Z√ºrich erreichte, hatten wir bereits folgende Informationen zur Hand:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inhalt </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inhalt </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die vom Befehl kompilierte </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcap-Datei</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesen Daten waren wir bereit, mit der Phase der ‚ÄûUntersuchung‚Äú und Fehlerbehebung zu beginnen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere ersten Schritte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst haben wir die Protokolle und den Status des Metadatenservers √ºberpr√ºft und sichergestellt, dass er ordnungsgem√§√ü funktioniert. </font><font style="vertical-align: inherit;">Der Metadatenserver antwortet mit der IP-Adresse 169.254.169.254 und ist unter anderem f√ºr die Steuerung der Domainnamen verantwortlich. </font><font style="vertical-align: inherit;">Wir haben au√üerdem √ºberpr√ºft, ob die Firewall mit VM ordnungsgem√§√ü funktioniert und keine Pakete blockiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es war ein seltsames Problem: Der nmap-Test widerlegte unsere Haupthypothese √ºber den Verlust von UDP-Paketen, sodass wir mental mehrere weitere Optionen und M√∂glichkeiten ableiteten, diese zu √ºberpr√ºfen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verschwinden Pakete selektiv? </font><font style="vertical-align: inherit;">=&gt; √úberpr√ºfen Sie die iptables-Regeln</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu klein </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Ausgabe pr√ºfen</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Betrifft das Problem nur UDP-Pakete oder TCP? </font><font style="vertical-align: inherit;">=&gt; Wegfahren</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Werden generierte Dig-Pakete zur√ºckgegeben? </font><font style="vertical-align: inherit;">=&gt; Wegfahren</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktioniert libdns richtig? </font><font style="vertical-align: inherit;">=&gt; Fahren Sie weg </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um die Paket√ºbertragung in beide Richtungen zu √ºberpr√ºfen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier beschlie√üen wir, den Benutzer anzurufen, um Fehler live zu beheben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
W√§hrend des Anrufs k√∂nnen wir verschiedene Dinge √ºberpr√ºfen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach mehreren √úberpr√ºfungen schlie√üen wir iptables-Regeln aus der Liste der Gr√ºnde aus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir √ºberpr√ºfen Netzwerkschnittstellen und Routing-Tabellen und √ºberpr√ºfen die MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir stellen fest, dass </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) so funktioniert, wie es sollte, aber </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) nicht funktioniert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachdem es </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ausgef√ºhrt wurde, w√§hrend es funktioniert </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, stellen wir fest, dass UDP-Pakete zur√ºckgegeben werden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir rennen </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und sehen, wie Dig richtig anruft </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der zweite wird jedoch durch Timeout unterbrochen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist die Schicht kurz vor dem Ende und wir sind gezwungen, das Problem in die n√§chste Zeitzone zu √ºbertragen. Der Appell weckte jedoch das Interesse an unserem Team, und ein Kollege schl√§gt vor, das Quell-DNS-Paket mit dem Python-Modul Scrapy zu erstellen.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Fragment erstellt ein DNS-Paket und sendet die Anforderung an den Metadatenserver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Benutzer f√ºhrt den Code aus, die DNS-Antwort wird zur√ºckgegeben und die Anwendung empf√§ngt sie, wodurch das Fehlen eines Problems auf Netzwerkebene best√§tigt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der n√§chsten "Weltreise" kehrt der Appell zu unserem Team zur√ºck, und ich √ºbersetze ihn vollst√§ndig auf mich selbst, da ich glaube, dass es f√ºr den Benutzer bequemer ist, wenn der Appell nicht mehr von Ort zu Ort kreist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Zwischenzeit erkl√§rt sich der Benutzer damit einverstanden, eine Momentaufnahme des Systemabbilds bereitzustellen. Dies sind sehr gute Nachrichten: Die M√∂glichkeit, das System selbst zu testen, beschleunigt die Fehlerbehebung erheblich, da Sie den Benutzer nicht mehr auffordern m√ºssen, Befehle auszuf√ºhren, mir Ergebnisse zu senden und diese zu analysieren. Ich kann alles selbst tun!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kollegen beginnen mich ein wenig zu beneiden. </font><font style="vertical-align: inherit;">Beim Mittagessen besprechen wir den Appell, aber niemand hat eine Ahnung, was los ist. </font><font style="vertical-align: inherit;">Gl√ºcklicherweise hat der Benutzer selbst bereits Minderungsma√ünahmen ergriffen und hat es nicht eilig, sodass wir Zeit haben, das Problem vorzubereiten. </font><font style="vertical-align: inherit;">Und da wir ein Bild haben, k√∂nnen wir alle Tests durchf√ºhren, die uns interessieren. </font><font style="vertical-align: inherit;">Fein!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einen Schritt zur√ºckgehen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der h√§ufigsten Fragen in einem Interview f√ºr einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Systemingenieur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lautet: "Was passiert, wenn Sie </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">www.google.com anpingen</font></a><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">Die Frage ist vornehm, weil der Kandidat von der Shell √ºber den Benutzerraum bis zum Kern des Systems und weiter zum Netzwerk beschrieben werden muss. </font><font style="vertical-align: inherit;">Ich l√§chle: Manchmal sind Interviewfragen auch im wirklichen Leben n√ºtzlich ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich beschlie√üe, diese eychar-Frage auf das aktuelle Problem anzuwenden. </font><font style="vertical-align: inherit;">Wenn Sie versuchen, den DNS-Namen zu ermitteln, geschieht ungef√§hr Folgendes:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anwendung ruft die Systembibliothek auf, z. B. libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns √ºberpr√ºft die Systemkonfiguration, welchen DNS-Server es verwenden soll (im Diagramm ist es 169.254.169.254, Metadatenserver)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns verwendet Systemaufrufe, um einen UDP-Socket (SOKET_DGRAM) zu erstellen und UDP-Pakete mit einer DNS-Anforderung in beide Richtungen zu senden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úber die sysctl-Schnittstelle k√∂nnen Sie den UDP-Stack auf Kernelebene konfigurieren</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Kernel interagiert mit der Hardware, um Pakete √ºber eine Netzwerkschnittstelle √ºber das Netzwerk zu √ºbertragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Hypervisor f√§ngt das Paket ab und leitet es an den Metadatenserver weiter, wenn es damit in Kontakt kommt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Metadatenserver ermittelt den DNS-Namen anhand seiner Hexerei und gibt die Antwort auf die gleiche Weise zur√ºck</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich m√∂chte Sie daran erinnern, welche Hypothesen wir bereits ber√ºcksichtigt haben: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Defekte Bibliotheken</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: F√ºhren Sie strace im System aus und √ºberpr√ºfen Sie, ob dig die richtigen Systemaufrufe verursacht</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Richtige Systemaufrufe werden aufgerufen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Durch Srapy, um zu √ºberpr√ºfen, ob wir die Namen unter Umgehung der Systembibliotheken ermitteln k√∂nnen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: wir k√∂nnen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 3: F√ºhren Sie rpm ‚ÄìV f√ºr das libdns-Paket und die md5sum-Bibliotheksdateien aus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Der Bibliothekscode ist vollst√§ndig identisch mit dem Code im funktionierenden Betriebssystem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 4: Mounten Sie das Image des Stammsystems des Benutzers ohne dieses Verhalten auf der VM, f√ºhren Sie chroot aus und pr√ºfen Sie, ob DNS funktioniert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: DNS funktioniert ordnungsgem√§√ü</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung basierend auf Tests: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht in Bibliotheken. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Es liegt ein Fehler in den DNS-Einstellungen vor</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: √úberpr√ºfen Sie tcpdump und pr√ºfen Sie, ob DNS-Pakete nach dem Ausf√ºhren von dig korrekt gesendet und zur√ºckgegeben werden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Pakete werden korrekt √ºbertragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: √úberpr√ºfen Sie den Server erneut </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: alles ist richtig</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testbasierte Schlussfolgerung: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht in der DNS-Konfigurationshypothese </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Kernel besch√§digt</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test: Installieren Sie einen neuen Kernel, √ºberpr√ºfen Sie die Signatur und starten Sie ihn neu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: √§hnliches Verhalten</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung basierend auf Tests: Der</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kernel ist nicht besch√§digt </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Falsches Verhalten des Benutzernetzwerks (oder der Netzwerkschnittstelle des Hypervisors)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: √úberpr√ºfen Sie die Firewall-Einstellungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Firewall leitet DNS-Pakete sowohl auf dem Host als auch auf dem GCP weiter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Abfangen des Datenverkehrs und Verfolgen der Richtigkeit der √úbertragung und R√ºckgabe von DNS-Abfragen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: tcpdump best√§tigt den Empfang von R√ºckpaketen durch den Host</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testbasierte Schlussfolgerung: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem liegt nicht im Netzwerk. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothese: Der Metadatenserver funktioniert nicht</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: √úberpr√ºfen Sie die Metadatenserverprotokolle auf Anomalien</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Protokolle enthalten keine Anomalien</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: Umgehen Sie den Metadatenserver </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis: Die Berechtigung wird auch ohne Verwendung eines Metadatenservers verletzt</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test-basiertes Fazit: Das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem ist nicht in dem Metadaten - </font><font style="vertical-align: inherit;">Server </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir alle Subsysteme mit </font><font style="vertical-align: inherit;">Ausnahme der getesteten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laufzeiteinstellungen!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eintauchen in die Kernel-Laufzeiteinstellungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Kernel-Laufzeit zu konfigurieren, k√∂nnen Sie die Befehlszeilenoptionen (grub) oder die sysctl-Schnittstelle verwenden. </font><font style="vertical-align: inherit;">Ich habe reingeschaut </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und nur gedacht, ich habe ein paar benutzerdefinierte Einstellungen gefunden. </font><font style="vertical-align: inherit;">Ich hatte das Gef√ºhl, etwas ergriffen zu haben, und entlie√ü alle Nicht-Netzwerk- oder Nicht-TCP-Einstellungen, die von den Bergeinstellungen √ºbrig blieben </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dann wandte ich mich an die Stelle, an der die VM √ºber die Host-Berechtigungen verf√ºgt, und begann nacheinander die Einstellungen f√ºr die defekte VM anzuwenden, bis ich den Verbrecher erreichte:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist es, eine DNS-brechende Konfiguration! Ich habe ein Instrument des Verbrechens gefunden. Aber warum passiert das? Ich brauchte noch ein Motiv. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Festlegen der Basisgr√∂√üe des DNS-Paketpuffers erfolgt √ºber </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ein typischer Wert variiert irgendwo innerhalb von 200 KB. Wenn Ihr Server jedoch viele DNS-Pakete empf√§ngt, k√∂nnen Sie den Puffer vergr√∂√üern. Wenn der Puffer zum Zeitpunkt des Eintreffens eines neuen Pakets voll ist, z. B. weil die Anwendung es nicht schnell genug verarbeitet, verlieren Sie Pakete. Unser Client hat die Puffergr√∂√üe korrekt erh√∂ht, weil er Angst vor Datenverlust hatte, weil er die Anwendung zum Sammeln von Metriken √ºber DNS-Pakete verwendet hat. Der von ihm festgelegte Wert war das maximal m√∂gliche: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (wenn Sie 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> festlegen </font><font style="vertical-align: inherit;">, gibt der Kernel "UNG√úLTIGES ARGUMENT" zur√ºck).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pl√∂tzlich wurde mir klar, warum nmap und scapy richtig funktionierten: Sie verwendeten rohe Sockel! Raw-Sockets unterscheiden sich von normalen Sockets: Sie umgehen iptables und sind nicht gepuffert! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber warum verursacht ein ‚Äûzu gro√üer Puffer‚Äú Probleme? Es funktioniert offensichtlich nicht wie beabsichtigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt konnte ich das Problem auf mehreren Kernen und mehreren Verteilungen reproduzieren. Das Problem hat sich bereits im 3.x-Kernel manifestiert und manifestiert sich nun auch im 5.x-Kernel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Tat beim Start</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS funktioniert nicht mehr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich begann √ºber einen einfachen bin√§ren Suchalgorithmus nach Arbeitswerten zu suchen und stellte fest, dass das System mit 2147481343 funktioniert. Diese Zahl war jedoch f√ºr mich ein bedeutungsloser Satz von Zahlen. Ich habe den Kunden eingeladen, diese Nummer auszuprobieren, und er antwortete, dass das System mit google.com funktioniert, aber dennoch einen Fehler mit anderen Domains gemeldet hat, sodass ich meine Untersuchung fortsetzte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installiert </font><font style="vertical-align: inherit;">, ein Tool, das ich vorher h√§tte verwenden sollen: Es zeigt, wo genau das Paket im Kernel ist. Die Funktion war schuldig </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ich habe die Kernelquellen heruntergeladen und verschiedene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionen</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hinzugef√ºgt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">, um</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu verfolgen, wo das Paket speziell hinkommt. Ich fand schnell den richtigen Zustand</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und starrte ihn eine Weile einfach an, denn dann kam schlie√ülich alles zu einem ganzen Bild zusammen: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, eine bedeutungslose Zahl, eine leere Dom√§ne ... Es war ein St√ºck Code in </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat den Typ int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist vom Typ u16 (vorzeichenloses 16-Bit-Int) und speichert die Paketgr√∂√üe</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist vom Typ int und speichert die Gr√∂√üe des Puffers, die per Definition gleich dem Wert in ist </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sich 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√§hern </font><font style="vertical-align: inherit;">, kann das Summieren der Paketgr√∂√üe zu einem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ganzzahligen √úberlauf f√ºhren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und da es sich um ein int handelt, wird sein Wert negativ, sodass die Bedingung wahr wird, wenn sie falsch sein sollte (mehr dazu finden Sie unter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bezugnahme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Fehler wird auf triviale Weise korrigiert: durch Casting auf </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ich habe den Patch angewendet und das System neu gestartet. Danach hat der DNS wieder funktioniert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geschmack des Sieges</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe meine Ergebnisse an den Client weitergeleitet und den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kernel-Patch </font><font style="vertical-align: inherit;">gesendet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ich bin zufrieden: Jedes Puzzleteil hat sich zu einem Ganzen zusammengeschlossen. Ich kann genau erkl√§ren, warum wir das beobachtet haben, was wir beobachtet haben, und vor allem konnten wir durch Zusammenarbeit eine L√∂sung f√ºr das Problem finden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist erw√§hnenswert, dass sich der Fall als selten herausstellte, und gl√ºcklicherweise werden solche komplexen Anrufe selten von Benutzern von uns empfangen.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503096/index.html">Warum m√∂chten Manager, dass Mitarbeiter recyceln?</a></li>
<li><a href="../de503100/index.html">Internetkopf</a></li>
<li><a href="../de503106/index.html">Nicht standardm√§√üige Entdeckungsverdauung: Genealogie von Raubpflanzen, Pilzen auf Twitter und Lachgas aus Guano</a></li>
<li><a href="../de503108/index.html">Acht Farben des Regenbogens: √úber Farbe in Bezug auf Mathematik</a></li>
<li><a href="../de503110/index.html">Digitale Epidemie: CoronaVirus gegen CoViper</a></li>
<li><a href="../de503118/index.html">David Yang - √ºber Nicht-Invasivit√§t, Krisen und verbrannte Erde</a></li>
<li><a href="../de503126/index.html">Likbez √ºber VPS: So konfigurieren Sie den Remotedesktop, wenn Sie ein Win-Benutzer sind</a></li>
<li><a href="../de503128/index.html">Einbetten von ColorPicker in JavaScript Gantt zum √Ñndern von Farbaufgaben</a></li>
<li><a href="../de503132/index.html">Hochgeschwindigkeits-Apache-Parkett in Python mit Apache-Pfeil</a></li>
<li><a href="../de503134/index.html">Management = Team + Produkt. Wir enth√ºllen die Formel dieses Jahres: die n√ºtzlichste f√ºr Menschen und f√ºr Menschen bei DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>