<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòç ü§üüèæ üé£ A tarefa do desenvolvedor ou como digitalizamos os scanners manuais sem um fornecedor üí¨ üë≠ üë®üèº‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° a todos. 
 
 Hoje, Victor Antipov e Ilya Aleshin, falaremos sobre nossa experi√™ncia com dispositivos USB atrav√©s do Python PyUSB e um pouco sobre ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>A tarefa do desenvolvedor ou como digitalizamos os scanners manuais sem um fornecedor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/490748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° a todos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, Victor Antipov e Ilya Aleshin, falaremos sobre nossa experi√™ncia com dispositivos USB atrav√©s do Python PyUSB e um pouco sobre engenharia reversa.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/ux/va/j4uxvafzrna4qe-37a6miqsyg1u.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 2019, entrou em vigor o Decreto do Governo da Federa√ß√£o Russa n.o 224, ‚ÄúAprova√ß√£o das regras de rotulagem de produtos de tabaco por meio de identifica√ß√£o e das especificidades da introdu√ß√£o de um sistema de informa√ß√£o estadual para monitorar a circula√ß√£o de mercadorias sujeitas a rotulagem obrigat√≥ria por meio de identifica√ß√£o em rela√ß√£o a produtos de tabaco‚Äù. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O documento explica que, a partir de 1 de julho de 2019, os fabricantes devem rotular cada embalagem de tabaco. E os distribuidores diretos devem receber esses produtos com o design de um documento de transfer√™ncia universal (UPD). As lojas, por sua vez, precisam registrar a venda de produtos rotulados por meio da caixa registradora.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, a partir de 1¬∫ de julho de 2020, produtos de tabaco n√£o marcados s√£o proibidos. Isso significa que todos os ma√ßos de cigarro devem ser etiquetados com um c√≥digo de barras especial Datamatrix. E - um ponto importante - aconteceu que o Datamatrix n√£o ser√° comum, mas inverso. Ou seja, n√£o um c√≥digo preto no branco, mas vice-versa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testamos nossos scanners, e verificou-se que a maioria deles precisa ser reflorestada / reciclada, caso contr√°rio, eles simplesmente n√£o conseguem trabalhar normalmente com esse c√≥digo de barras. Essa reviravolta nos garantiu uma forte dor de cabe√ßa, porque nossa empresa possui muitas lojas espalhadas por um vasto territ√≥rio. V√°rias dezenas de milhares de mesas de dinheiro - e com muito pouco tempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o que era para ser feito? </font><font style="vertical-align: inherit;">Existem duas op√ß√µes. </font><font style="vertical-align: inherit;">Primeiro: os engenheiros das instala√ß√µes realizam reflash manualmente e ajustam os scanners. </font><font style="vertical-align: inherit;">Segundo: trabalhamos remotamente e, de prefer√™ncia, cobrimos muitos scanners de uma s√≥ vez em uma itera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira op√ß√£o, obviamente, n√£o nos convinha: ter√≠amos de gastar dinheiro em viagens de campo de engenheiros, e √© dif√≠cil controlar e coordenar o processo nesse caso. </font><font style="vertical-align: inherit;">Mas o mais importante √© que as pessoas funcionariam, ou seja, potencialmente ter√≠amos muitos erros e, muito provavelmente, n√£o caberiam no prazo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda op√ß√£o √© boa para todos, se n√£o para um, mas. </font><font style="vertical-align: inherit;">Alguns fornecedores n√£o tinham as ferramentas intermitentes remotas necess√°rias para todos os sistemas operacionais necess√°rios. </font><font style="vertical-align: inherit;">E como os prazos estavam acabando, eu tive que pensar com minha pr√≥pria cabe√ßa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, descreveremos como desenvolvemos ferramentas para scanners de m√£o para o sistema operacional Debian 9.x (temos todas as bilheterias do Debian).</font></font><br>
<br>
<h3> :   </h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diz Victor Antipov.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O utilit√°rio oficial fornecido pelo fornecedor funciona no Windows e somente no IE. O utilit√°rio pode piscar e configurar o scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o sistema de destino √© o Debian, instalamos o servidor de redirecionador usb no servidor Debian e o cliente de redirecionador usb no Windows. Usando os utilit√°rios do redirecionador usb, o scanner foi encaminhado da m√°quina Linux para a m√°quina Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O utilit√°rio do fornecedor do Windows viu o scanner e at√© piscou normalmente. Assim, a primeira conclus√£o foi feita: nada depende do sistema operacional, o assunto est√° no protocolo intermitente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EST√Å BEM. Um piscar foi iniciado em uma m√°quina Windows e um despejo foi removido em uma m√°quina Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles colocaram o despejo no WireShark e ... ficaram tristes (omitirei parte dos detalhes do despejo, eles n√£o t√™m interesse). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que despejo nos mostrou:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/ut/sa/5cutsausebu86kbucq6rfksz7wu.png"><br>
<br>
<img src="https://habrastorage.org/webt/9z/ex/jo/9zexjowdglq6cjc88ln5r6tlkcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os endere√ßos 0000-0030, a julgar pelo Wireshark, s√£o informa√ß√µes de servi√ßo USB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√°vamos interessados ‚Äã‚Äãna parte 0040-0070. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nada ficou claro em um quadro de transmiss√£o, exceto os caracteres MOCFT. Esses s√≠mbolos acabaram sendo s√≠mbolos do arquivo de firmware, bem como o restante dos s√≠mbolos at√© o final do quadro (o arquivo de firmware √© destacado): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/ls/mf/yblsmf2htqk4n-lsa3u702yy5vm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que os s√≠mbolos fd 3e 02 01 fe significam, eu pessoalmente, como Ilya, n√£o fazia ideia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Olhei para o pr√≥ximo quadro (as informa√ß√µes de servi√ßo s√£o exclu√≠das aqui, o arquivo de firmware √© destacado): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/sr/ut/r3srutakf1ioytxspf1zurv9pww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que ficou claro? Que os dois primeiros bytes s√£o algum tipo de constante. Todos os blocos subsequentes confirmaram isso, mas antes do final do bloco de transmiss√£o:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/t6/ux/j7t6uxe8auhqxaxp5azeolv5jwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse quadro tamb√©m entrou em estupor, uma vez que a constante foi alterada (destacada) e, estranhamente, havia uma parte do arquivo. O tamanho dos bytes transmitidos do arquivo indica que 1024 bytes foram transferidos. O que os bytes restantes significavam - eu n√£o sabia novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro de tudo, como um antigo apelido do BBS, revisei os protocolos de transfer√™ncia padr√£o. 1024 bytes, nenhum protocolo foi passado. Ele come√ßou a estudar o material e encontrou o protocolo 1K Xmodem. Permitiu transmitir 1024, mas com uma nuance: a princ√≠pio apenas 128, e somente na aus√™ncia de erros o protocolo aumentou o n√∫mero de bytes transmitidos. Eu imediatamente tive uma transmiss√£o de 1024 bytes. Decidi estudar os protocolos de transmiss√£o e, especificamente, o X-modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia duas varia√ß√µes do modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, o formato do pacote XMODEM com suporte a CRC8 (XMODEM original):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/dq/7w/wudq7w7yg59duxo2ok3rcng5bga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, o formato de pacote XMODEM com suporte a CRC16 (XmodemCRC): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i2/cz/j3/i2czj3nd212vhlbms9uqrysd5xa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â semelhante, com exce√ß√£o de SOH, n√∫mero de pacote e CRC e o tamanho do pacote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Olhei para o in√≠cio do segundo bloco de transmiss√£o (e vi novamente o arquivo do firmware, mas com um recuo de 1024 bytes):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/lk/nb/5vlknbhbecr2d3d7uigb19dh_cg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu vi o cabe√ßalho familiar fd 3e 02, mas os pr√≥ximos dois bytes j√° foram alterados: era 01 fe e se tornou 02 fd. Ent√£o eu notei que o segundo bloco agora est√° numerado 02 e assim entendido: na minha frente est√° a numera√ß√£o do bloco de transmiss√£o. A primeira transmiss√£o 1024 √© 01, a segunda 02, a terceira 03 e assim por diante (mas em hexadecimal, √© claro). Mas o que significa a mudan√ßa de fe para fd? Os olhos viram uma diminui√ß√£o de 1, o c√©rebro lembrou que os programadores contam de 0, n√£o de 1. Mas ent√£o por que o primeiro bloco 1, n√£o 0? N√£o encontrei a resposta para esta pergunta. Mas eu entendi como o segundo bloco √© considerado. O segundo bloco nada mais √© do que FF - (menos) o n√∫mero do primeiro bloco. Assim, o segundo bloco foi designado como = 02 (FF-02) = 02 FD. A leitura subsequente do lix√£o confirmou meu palpite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, a seguinte imagem do programa come√ßou a surgir: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O in√≠cio do programa</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 02 - In√≠cio </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01 FE - contador de transmiss√£o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transmiss√£o (34 blocos, 1024 bytes s√£o transmitidos) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 1024 bytes de dados (divididos em blocos de 30 bytes). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fim da transmiss√£o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Restos de dados para alinhar a 1024 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como √© o quadro final da transfer√™ncia de blocos: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ee/t9/dmeet9sttaokhdirciuxag4p9y4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 - sinal para o final da transfer√™ncia de blocos. Pr√≥ximo 2f 52 - os restos do arquivo at√© 1024 bytes. 2f 52, a julgar pelo protocolo, √© uma soma de verifica√ß√£o CRC de 16 bits.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base na mem√≥ria antiga, criei um programa em C que extra√≠a 1024 bytes de um arquivo e lia o CRC de 16 bits. </font><font style="vertical-align: inherit;">O lan√ßamento do programa mostrou que este n√£o √© um CRC de 16 bits. </font><font style="vertical-align: inherit;">Novamente estupor - por cerca de tr√™s dias. </font><font style="vertical-align: inherit;">Durante todo esse tempo, tentei entender o que poderia ser, se n√£o uma soma de verifica√ß√£o. </font><font style="vertical-align: inherit;">Estudando sites em ingl√™s, descobri que o modem X usa seu pr√≥prio c√°lculo de soma de verifica√ß√£o - CRC-CCITT (XModem). </font><font style="vertical-align: inherit;">N√£o encontrei nenhuma implementa√ß√£o em C para esse c√°lculo, mas encontrei um site que lia essa soma de verifica√ß√£o online. </font><font style="vertical-align: inherit;">Ao carregar 1024 bytes do meu arquivo na p√°gina da web, o site me mostrou uma soma de verifica√ß√£o que coincidia completamente com a soma de verifica√ß√£o do arquivo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viva! </font><font style="vertical-align: inherit;">O √∫ltimo enigma foi resolvido, agora voc√™ tinha que criar seu pr√≥prio firmware. </font><font style="vertical-align: inherit;">Depois, transferi meu conhecimento (e eles permaneceram apenas na minha cabe√ßa) para Ilya, que conhece ferramentas poderosas - Python.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cria√ß√£o de programa</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Narrado por Ilya Aleshin. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo recebido as instru√ß√µes apropriadas, fiquei muito "feliz". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por onde come√ßar? </font><font style="vertical-align: inherit;">Certo, desde o come√ßo. </font><font style="vertical-align: inherit;">Dumping Ao descarregar de uma porta USB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o USB-pcap </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://desowin.org/usbpcap/tour.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Escolha a porta √† qual o dispositivo est√° conectado e o arquivo em que salvaremos o despejo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/ax/xp/gaaxxp3qdqajous7didfd7gwkg8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectamos o scanner √† m√°quina em que o software EZConfigScanning nativo para Windows est√° instalado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/oo/le/olooleeirgestw3q0gzvhqvzr58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nele encontramos o ponto de enviar comandos para o dispositivo. </font><font style="vertical-align: inherit;">Mas e as equipes? </font><font style="vertical-align: inherit;">Onde consegui-los? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o programa inicia, o equipamento √© interrogado automaticamente (veremos isso um pouco mais tarde). </font><font style="vertical-align: inherit;">E havia c√≥digos de barras de treinamento a partir de documentos oficiais do equipamento. </font><font style="vertical-align: inherit;">DEFALTO. </font><font style="vertical-align: inherit;">Esta √© a nossa equipe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/dv/gf/8vdvgfiuthogftttgzdsxym22_4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados necess√°rios s√£o recebidos. </font><font style="vertical-align: inherit;">Abra o dump.pcap atrav√©s do wireshark.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloquear na inicializa√ß√£o do EZConfigScanning. Os pontos vermelhos s√£o lugares para prestar aten√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/ju/0x/wpju0xwxz9_hgex0jnnyttjxqpa.png"><br>
<br>
<img src="https://habrastorage.org/webt/nw/6s/so/nw6ssotdpggn37qvn9kvayxhxde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vendo tudo isso pela primeira vez, eu perdi o cora√ß√£o. Onde cavar mais ainda n√£o est√° claro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pouco de brainstorming e-e-e ... Aha! Em um despejo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">out</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dentro</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fora</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pesquisou o que √© URB_INTERRUPT. Descobriu que este √© um m√©todo de transfer√™ncia de dados. E existem 4 m√©todos: controle, interrup√ß√£o, is√≥crono, a granel. Voc√™ pode ler sobre eles separadamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E os endere√ßos dos terminais na interface do dispositivo USB podem ser obtidos pelo comando "lsusb ‚Äìv" ou por meio do pyusb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ precisa encontrar todos os dispositivos com este VID. Voc√™ pode pesquisar especificamente por VID: PID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/xp/i_/fnxpi_m69b43p6yzpeoh3atps0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se parece com isso:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g0/h4/td/g0h4tdpscytduyzmj4xqe31r5s4.png"><br>
<br>
<img src="https://habrastorage.org/webt/d4/wf/5k/d4wf5k6asqr5nvofve-ntd5sm4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, temos as informa√ß√µes necess√°rias: comandos P_INFO. ou DEFALT, endere√ßos onde escrever os comandos endpoint = 03 e onde obter o endpoint de resposta = 86. Resta apenas traduzir os comandos em hexadecimal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/io/wf/ui/iowfuid0hhvl6q6zpb9kfds3tny.png"><br>
<br>
<img src="https://habrastorage.org/webt/0p/gr/2j/0pgr2jw1u6tj5vqetitjg3g6chw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como j√° encontramos o dispositivo, desconecte-o do kernel ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/xy/84/jixy849fy7l81g9tenjxpf7uymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qx/v0/nt/qxv0nttjmnddvekfmbnfq9vebfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
grave </font><font style="vertical-align: inherit;">no terminal com o endere√ßo 0x03, </font><font style="vertical-align: inherit;">... e depois leia a resposta do terminal com o endere√ßo 0x86. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kj/xn/e2/kjxne2x9ab6spmxnk2ac3bnroc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resposta estruturada:</font></font><br>
<br>
<pre><code class="plaintext hljs">P_INFOfmt: 1<font></font>
mode: app<font></font>
app-present: 1<font></font>
boot-present: 1<font></font>
hw-sn: 18072B44CA<font></font>
hw-rev: 0x20<font></font>
cbl: 4<font></font>
app-sw-rev: CP000116BBA<font></font>
boot-sw-rev: CP000014BAD<font></font>
flash: 3<font></font>
app-m_name: Voyager 1450g<font></font>
boot-m_name: Voyager 1450g<font></font>
app-p_name: 1450g<font></font>
boot-p_name: 1450g<font></font>
boot-time: 16:56:02<font></font>
boot-date: Oct 16 2014<font></font>
app-time: 08:49:30<font></font>
app-date: Mar 25 2019<font></font>
app-compat: 289<font></font>
boot-compat: 288<font></font>
csum: 0x6986</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos esses dados em dump.pcap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cr/z5/2y/crz52y_j0alhcohhokmry0bx7t8.png"><br>
<br>
<img src="https://habrastorage.org/webt/-s/np/cv/-snpcv4opok9jdsrj8thkshno_4.png"><br>
<br>
<img src="https://habrastorage.org/webt/qj/dq/zl/qjdqzlcwogon9yts12p5awr32ha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem! Traduzimos c√≥digos de barras do sistema para hexadecimal. Tudo, a funcionalidade de treinamento est√° pronta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que fazer com o firmware? Parece que tudo √© igual, mas h√° uma nuance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de remover um despejo completo do processo de piscar, entendemos mais ou menos com o que est√°vamos lidando. Aqui est√° um artigo sobre o XMODEM que realmente ajudou a entender como essa comunica√ß√£o acontece, embora em termos gerais: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://microsin.net/adminstuff/others/xmodem-protocol-overview.html Eu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recomendo a leitura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Olhando no dump, voc√™ pode ver que o tamanho do quadro √© 1024 e o tamanho dos dados URB √© 64. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/o6/uj/wio6ujyvlj_bnltlngxf24k9evk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, 1024/64, obtemos 16 linhas em um bloco, lemos o arquivo de firmware por 1 caractere e formam um bloco. Complementando 1 linha em um bloco com caracteres especiais fd3e02 + n√∫mero do bloco.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As pr√≥ximas 14 linhas s√£o complementadas com fd25 +, usando XMODEM.calc_crc () calculamos a soma de verifica√ß√£o de todo o bloco (demorou muito tempo para entender que ‚ÄúFF - 1‚Äù √© CSUM) e a √∫ltima 16¬™ linha √© complementada com fd3e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que tudo, leia o arquivo de firmware, atinja os blocos, desconecte o scanner do kernel e envie-o para o dispositivo. </font><font style="vertical-align: inherit;">Mas n√£o √© t√£o simples. </font><font style="vertical-align: inherit;">O scanner deve ser colocado no modo de firmware </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
enviando NEWAPP = '\\ xfd \\ x0a \\ x16 \\ x4e \\ x2c \\ x4e \\ x45 \\ x57 \\ x41 \\ x50 \\ x50 \\ x0d'. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De onde vem esse comando? </font><font style="vertical-align: inherit;">Do lix√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/sd/nd/ausdnd16ikur6ajzdiyk9-ntklw.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o podemos enviar o bloco inteiro para o scanner devido √† restri√ß√£o de 64: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/db/k6/qg/dbk6qgrapgsxiwdo9jyxqd0svwu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, o scanner no modo intermitente NEWAPP tamb√©m n√£o aceita hexadecimal. </font><font style="vertical-align: inherit;">Portanto, √© necess√°rio converter cada linha bytes_array</font></font><br>
<br>
<pre><code class="plaintext hljs">[253, 10, 22, 78, 44, 78, 69, 87, 65, 80, 80, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E j√° envie esses dados para o scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos a resposta:</font></font><br>
<br>
<pre><code class="plaintext hljs">[2, 1, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ verificar o artigo sobre o XMODEM, fica claro: os dados foram aceitos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/fd/gj/pofdgjvcgns7oxdeonuldkqbptg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a transfer√™ncia de todos os blocos, conclu√≠mos a transfer√™ncia END_TRANSFER = '\ xfd \ x01 \ x04'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, como esses blocos n√£o carregam informa√ß√µes para pessoas comuns, tornaremos o firmware no modo oculto por padr√£o. </font><font style="vertical-align: inherit;">E por precau√ß√£o, atrav√©s do tqdm, organizaremos uma barra de progresso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/18/g1/da18g1axnll2zps9qpx2s7opkha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, o resto √© pequeno. </font><font style="vertical-align: inherit;">Resta apenas agrupar a solu√ß√£o em scripts para replica√ß√£o em massa em um hor√°rio claramente definido, para n√£o desacelerar o processo de trabalho nas bilheterias e adicionar log.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de gastar muito tempo, energia </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e cabelos na cabe√ßa</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , fomos capazes de desenvolver as solu√ß√µes de que precis√°vamos, al√©m disso, cumprimos o prazo. </font><font style="vertical-align: inherit;">Ao mesmo tempo, os scanners s√£o remarcados e retreinados agora centralmente, controlamos claramente todo o processo. </font><font style="vertical-align: inherit;">A empresa economizou tempo e dinheiro e adquirimos uma experi√™ncia inestim√°vel em engenharia reversa desse tipo de equipamento.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt490736/index.html">9 ferramentas claras para aprender e aprimorar o vocabul√°rio em ingl√™s</a></li>
<li><a href="../pt490738/index.html">Princ√≠pio de substitui√ß√£o de Lisk</a></li>
<li><a href="../pt490740/index.html">Deserte *** *** n√£o √© apenas randomiza√ß√£o</a></li>
<li><a href="../pt490742/index.html">Uma nova era na rob√≥tica come√ßou</a></li>
<li><a href="../pt490746/index.html">Classifica√ß√£o no Yandex.Taxi: um pequeno post sobre um t√≥pico s√©rio</a></li>
<li><a href="../pt490750/index.html">Mikhail Salosin. Golang Meetup. Usando Go no back-end do aplicativo Watch +</a></li>
<li><a href="../pt490754/index.html">Editor de c√≥digo de c√≥digo do Visual Studio. O guia mais detalhado para configurar e instalar plugins para iniciantes</a></li>
<li><a href="../pt490756/index.html">Implantar Jenkins como c√≥digo</a></li>
<li><a href="../pt490758/index.html">Os matem√°ticos provaram a lei universal da turbul√™ncia</a></li>
<li><a href="../pt490760/index.html">Pesquisa visual de proje√ß√£o de raios (RCVS). Algoritmo simples e r√°pido para encontrar modelos 3D semelhantes em geometria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>