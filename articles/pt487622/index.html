<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÄ üë®‚Äçüíª üë®üèº‚Äçüéì Antipadr√µes para trabalhar com bancos de dados üè® üõÉ üéÖüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Apresento a voc√™ a tradu√ß√£o do meu artigo ‚ÄúDatabase: Anti-Patterns‚Äù . 
 
 Se voc√™ armazenar dados, essa √© uma parte cr√≠tica do seu aplicativ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipadr√µes para trabalhar com bancos de dados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487622/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° Habr! </font><font style="vertical-align: inherit;">Apresento a voc√™ a tradu√ß√£o do meu artigo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúDatabase: Anti-Patterns‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ armazenar dados, essa √© uma parte cr√≠tica do seu aplicativo. </font><font style="vertical-align: inherit;">Voc√™ pode facilmente e rapidamente corrigir uma corre√ß√£o de bug em um novo site de namoro, para que o fazendeiro Joe, do norte do Texas, possa finalmente ler a √∫ltima mensagem de seu amigo e descobrir que ela gosta de homens carecas. </font><font style="vertical-align: inherit;">Mas Deus n√£o permita que voc√™ perca ou estrague os dados do usu√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e2d/e07/3a3/e2de073a3ff6c38cf29617834cd2cd42.png" alt="imagem"><br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vale do Sil√≠cio, Temporada 2, Epis√≥dio 8</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, muitos desenvolvedores n√£o entendem completamente essa verdade simples. </font><font style="vertical-align: inherit;">N√£o sou programador profissional h√° muitos anos, mas j√° vi muitos, muitos erros cometidos por pessoas que trabalham com o banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√£o apenas aqueles que v√™m √† mente imediatamente.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de backups</font></font></h2><br>
<img src="https://habrastorage.org/getpro/habr/post_images/727/d48/742/727d487423bf0fb28b5a497d58cb2169.jpg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Fazer backups" √© uma dessas regras (como "n√£o trabalhe na raiz" ou "aperte os cintos de seguran√ßa") com as quais muitos de n√≥s concordam, mas n√£o os seguem, esperando que coisas ruins aconte√ßam aos outros e n√£o a n√≥s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, se voc√™ n√£o est√° testando a recupera√ß√£o de backups, pode assumir que n√£o possui nenhum backup. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprenda com os erros dos outros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em outras palavras, das cinco tecnologias de backup, ningu√©m trabalha de maneira confi√°vel ou n√£o est√° configurado. </font><font style="vertical-align: inherit;">No final, restauramos os dados do backup feito 6 horas atr√°s.</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perdemos os dados do banco de dados em 6 horas (problemas, solicita√ß√µes de mesclagem, usu√°rios, coment√°rios, trechos etc.) com o GitLab.com.</font></font></blockquote><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usu√°rios t√™m muito conte√∫do adulto e o assistem com muita frequ√™ncia.A</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quantidade de dados √© muito grande ou a carga √© alta demais para o banco de dados relacional. </font><font style="vertical-align: inherit;">Este √© o caso quando as tecnologias NoSQL entram em jogo. </font><font style="vertical-align: inherit;">Gigantes de software como o Google est√£o familiarizados com isso em primeira m√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ n√£o √© o Google</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Algumas centenas de gigabytes n√£o s√£o "big data", mas 1000 coment√°rios por dia n√£o s√£o "alta carga". </font><font style="vertical-align: inherit;">Provavelmente o PostgreSQL √© suficiente para seus dados. </font><font style="vertical-align: inherit;">Veja: ele </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suporta JSON e pode index√°-lo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos, voc√™ quer mesmo sacrificar uma estrutura confi√°vel por recursos que voc√™ n√£o precisa e, convenhamos, nunca ser√° necess√°rio? </font><font style="vertical-align: inherit;">Voc√™ n√£o se tornar√° o novo Google - voc√™ apenas tem uma bagun√ßa no banco de dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema muito frouxo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© mais relevante para o NoSQL, mas os usu√°rios de DBMSs relacionais geralmente esquecem ou t√™m pregui√ßa de criar todas as restri√ß√µes necess√°rias. </font><font style="vertical-align: inherit;">Devido a um erro no c√≥digo do aplicativo, ele </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser salvo onde um valor significativo √© esperado ou um link para uma entrada ausente pode ser criado. </font><font style="vertical-align: inherit;">Posteriormente, voc√™ percebe isso e corrige o c√≥digo, mas n√£o tem id√©ia de como corrigir os dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chaves prim√°rias naturais</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que queremos armazenar usu√°rios, cada um dos quais deve ter um email exclusivo. </font><font style="vertical-align: inherit;">A solu√ß√£o mais √≥bvia √© criar uma tabela </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com uma coluna </font></font><code>email</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que tamb√©m ser√° a chave prim√°ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, a chave natural pode se tornar inaceit√°vel como prim√°ria quando os requisitos mudam (e eles mudam constantemente). </font><font style="vertical-align: inherit;">Hoje </font></font><code>PRIMARY KEY(email)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona e amanh√£ decidimos adicionar o registro via Facebook e tornar o e-mail opcional. </font><font style="vertical-align: inherit;">Qual √© o melhor: gerar endere√ßos exclusivos e adicionar um sinalizador indicando um e-mail fict√≠cio ou alterar a chave prim√°ria, todas as chaves estrangeiras que se referem a </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc., etc.? </font><font style="vertical-align: inherit;">N√£o ter√≠amos que escolher o menor dos males se simplesmente us√°ssemos uma chave prim√°ria substituta.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≥gica no armazenamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o gosto disso por dois motivos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo do aplicativo geralmente √© muito mais f√°cil de atualizar do que um esquema de banco de dados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos esses SQL PLs me lembram Pascal, e s√£o igualmente feios.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migra√ß√£o espec√≠ficos do ambiente</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sei que √†s vezes n√£o h√° escolha, mas, em geral, √© melhor tentar garantir que todos os ambientes (dev, test, prod, etc.) sejam os mais semelhantes poss√≠veis. </font><font style="vertical-align: inherit;">Quanto maior a diferen√ßa entre os ambientes, maior a probabilidade de cometer um erro e encontr√°-lo apenas no produto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, mesmo os scripts DML podem ser universais. </font><font style="vertical-align: inherit;">Esquemas diferentes, na maioria das vezes, s√£o pura maldade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, quando vejo r√≥tulos espec√≠ficos do ambiente nos scripts liquibase, quero matar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migra√ß√£o tolerante</font></font></h2><br>
<code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e coisas semelhantes no DDL n√£o s√£o necess√°rias se em todos os ambientes esquemas id√™nticos, mas podem mascarar erros. </font><font style="vertical-align: inherit;">Se algo inesperado acontecer durante a atualiza√ß√£o do banco de dados, eu prefiro descobrir e corrigi-lo o mais r√°pido poss√≠vel, em vez de quebrar a cabe√ßa uma semana depois, como consertar a bagun√ßa.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualiza√ß√µes n√£o at√¥micas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que voc√™ execute o changeset em uma base de produ√ß√£o e a migra√ß√£o n√£o tenha sido bem-sucedida. Voc√™ est√° consertando algo e deseja tentar novamente. ser√° que vai dar certo? E se algumas opera√ß√µes de conjunto de altera√ß√µes forem confirmadas, enquanto outras n√£o? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode perceber que essa √© realmente uma hist√≥ria que o changeset deve ser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idempotente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e voc√™ estar√° certo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, muitos desenvolvedores, pensando em idempot√™ncia, usam </font></font><code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou algo assim. Na se√ß√£o anterior, expliquei por que isso √© ruim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, torne o conjunto de altera√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at√¥mico</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em caso de erro, as altera√ß√µes feitas ser√£o revertidas e voc√™ n√£o ter√° problemas com o aplicativo subsequente deste conjunto de altera√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas tenha cuidado ao contar com transa√ß√µes. Por exemplo,</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o suporte para express√µes DDL nas transa√ß√µes do MySQL √© sombrio e cheio de horrores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; portanto, sempre crio um conjunto de altera√ß√µes separado para cada express√£o DDL quando escrevo scripts Liquibase para MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais antipadr√µes voc√™ j√° viu?</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487606/index.html">Visualiza√ß√£o de linhas de tens√£o e movimentos de cargas eletrost√°ticas, simula√ß√£o de movimento planet√°rio do sistema solar</a></li>
<li><a href="../pt487610/index.html">RealWorld: aiohttp, Tortoise ORM</a></li>
<li><a href="../pt487612/index.html">Adicione, exclua e renomeie facilmente arquivos e metas em projetos do CMake</a></li>
<li><a href="../pt487616/index.html">Criando um item personalizado usando uma tabela de exemplo em C # para Windows Form</a></li>
<li><a href="../pt487620/index.html">Solu√ß√£o de problemas com pwnable.kr 27 - tiny_easy. Entendendo a pulveriza√ß√£o em pilha</a></li>
<li><a href="../pt487626/index.html">Como os sensores de estacionamento funcionam e como engan√°-lo</a></li>
<li><a href="../pt487628/index.html">Diagn√≥stico do envelhecimento com base em 9 caracter√≠sticas dos sinais de envelhecimento</a></li>
<li><a href="../pt487630/index.html">O algoritmo mais simples para criar um quebra-cabe√ßa de campo (parte 1)</a></li>
<li><a href="../pt487632/index.html">‚ÄúColegas, respirem mais silenciosamente‚Äù: por que o barulho do escrit√≥rio nos deixa loucos - discutimos pesquisas</a></li>
<li><a href="../pt487636/index.html">APIs para as quais finalmente vale a pena atualizar do Java 8. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>