<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎀 👨‍💻 👨🏼‍🎓 Antipadrões para trabalhar com bancos de dados 🏨 🛃 🎅🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá Habr! Apresento a você a tradução do meu artigo “Database: Anti-Patterns” . 
 
 Se você armazenar dados, essa é uma parte crítica do seu aplicativ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipadrões para trabalhar com bancos de dados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487622/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olá Habr! </font><font style="vertical-align: inherit;">Apresento a você a tradução do meu artigo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Database: Anti-Patterns”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você armazenar dados, essa é uma parte crítica do seu aplicativo. </font><font style="vertical-align: inherit;">Você pode facilmente e rapidamente corrigir uma correção de bug em um novo site de namoro, para que o fazendeiro Joe, do norte do Texas, possa finalmente ler a última mensagem de seu amigo e descobrir que ela gosta de homens carecas. </font><font style="vertical-align: inherit;">Mas Deus não permita que você perca ou estrague os dados do usuário. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e2d/e07/3a3/e2de073a3ff6c38cf29617834cd2cd42.png" alt="imagem"><br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vale do Silício, Temporada 2, Episódio 8</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, muitos desenvolvedores não entendem completamente essa verdade simples. </font><font style="vertical-align: inherit;">Não sou programador profissional há muitos anos, mas já vi muitos, muitos erros cometidos por pessoas que trabalham com o banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui estão apenas aqueles que vêm à mente imediatamente.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de backups</font></font></h2><br>
<img src="https://habrastorage.org/getpro/habr/post_images/727/d48/742/727d487423bf0fb28b5a497d58cb2169.jpg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Fazer backups" é uma dessas regras (como "não trabalhe na raiz" ou "aperte os cintos de segurança") com as quais muitos de nós concordam, mas não os seguem, esperando que coisas ruins aconteçam aos outros e não a nós. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A propósito, se você não está testando a recuperação de backups, pode assumir que não possui nenhum backup. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprenda com os erros dos outros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em outras palavras, das cinco tecnologias de backup, ninguém trabalha de maneira confiável ou não está configurado. </font><font style="vertical-align: inherit;">No final, restauramos os dados do backup feito 6 horas atrás.</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perdemos os dados do banco de dados em 6 horas (problemas, solicitações de mesclagem, usuários, comentários, trechos etc.) com o GitLab.com.</font></font></blockquote><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usuários têm muito conteúdo adulto e o assistem com muita frequência.A</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quantidade de dados é muito grande ou a carga é alta demais para o banco de dados relacional. </font><font style="vertical-align: inherit;">Este é o caso quando as tecnologias NoSQL entram em jogo. </font><font style="vertical-align: inherit;">Gigantes de software como o Google estão familiarizados com isso em primeira mão. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">você não é o Google</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Algumas centenas de gigabytes não são "big data", mas 1000 comentários por dia não são "alta carga". </font><font style="vertical-align: inherit;">Provavelmente o PostgreSQL é suficiente para seus dados. </font><font style="vertical-align: inherit;">Veja: ele </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suporta JSON e pode indexá-lo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos, você quer mesmo sacrificar uma estrutura confiável por recursos que você não precisa e, convenhamos, nunca será necessário? </font><font style="vertical-align: inherit;">Você não se tornará o novo Google - você apenas tem uma bagunça no banco de dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema muito frouxo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso é mais relevante para o NoSQL, mas os usuários de DBMSs relacionais geralmente esquecem ou têm preguiça de criar todas as restrições necessárias. </font><font style="vertical-align: inherit;">Devido a um erro no código do aplicativo, ele </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser salvo onde um valor significativo é esperado ou um link para uma entrada ausente pode ser criado. </font><font style="vertical-align: inherit;">Posteriormente, você percebe isso e corrige o código, mas não tem idéia de como corrigir os dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chaves primárias naturais</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que queremos armazenar usuários, cada um dos quais deve ter um email exclusivo. </font><font style="vertical-align: inherit;">A solução mais óbvia é criar uma tabela </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com uma coluna </font></font><code>email</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que também será a chave primária. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, a chave natural pode se tornar inaceitável como primária quando os requisitos mudam (e eles mudam constantemente). </font><font style="vertical-align: inherit;">Hoje </font></font><code>PRIMARY KEY(email)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona e amanhã decidimos adicionar o registro via Facebook e tornar o e-mail opcional. </font><font style="vertical-align: inherit;">Qual é o melhor: gerar endereços exclusivos e adicionar um sinalizador indicando um e-mail fictício ou alterar a chave primária, todas as chaves estrangeiras que se referem a </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc., etc.? </font><font style="vertical-align: inherit;">Não teríamos que escolher o menor dos males se simplesmente usássemos uma chave primária substituta.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lógica no armazenamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não gosto disso por dois motivos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O código do aplicativo geralmente é muito mais fácil de atualizar do que um esquema de banco de dados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos esses SQL PLs me lembram Pascal, e são igualmente feios.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migração específicos do ambiente</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sei que às vezes não há escolha, mas, em geral, é melhor tentar garantir que todos os ambientes (dev, test, prod, etc.) sejam os mais semelhantes possíveis. </font><font style="vertical-align: inherit;">Quanto maior a diferença entre os ambientes, maior a probabilidade de cometer um erro e encontrá-lo apenas no produto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, mesmo os scripts DML podem ser universais. </font><font style="vertical-align: inherit;">Esquemas diferentes, na maioria das vezes, são pura maldade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, quando vejo rótulos específicos do ambiente nos scripts liquibase, quero matar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migração tolerante</font></font></h2><br>
<code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e coisas semelhantes no DDL não são necessárias se em todos os ambientes esquemas idênticos, mas podem mascarar erros. </font><font style="vertical-align: inherit;">Se algo inesperado acontecer durante a atualização do banco de dados, eu prefiro descobrir e corrigi-lo o mais rápido possível, em vez de quebrar a cabeça uma semana depois, como consertar a bagunça.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualizações não atômicas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que você execute o changeset em uma base de produção e a migração não tenha sido bem-sucedida. Você está consertando algo e deseja tentar novamente. será que vai dar certo? E se algumas operações de conjunto de alterações forem confirmadas, enquanto outras não? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você pode perceber que essa é realmente uma história que o changeset deve ser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idempotente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e você estará certo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, muitos desenvolvedores, pensando em idempotência, usam </font></font><code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou algo assim. Na seção anterior, expliquei por que isso é ruim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, torne o conjunto de alterações </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atômico</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em caso de erro, as alterações feitas serão revertidas e você não terá problemas com o aplicativo subsequente deste conjunto de alterações. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas tenha cuidado ao contar com transações. Por exemplo,</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o suporte para expressões DDL nas transações do MySQL é sombrio e cheio de horrores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; portanto, sempre crio um conjunto de alterações separado para cada expressão DDL quando escrevo scripts Liquibase para MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais antipadrões você já viu?</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487606/index.html">Visualização de linhas de tensão e movimentos de cargas eletrostáticas, simulação de movimento planetário do sistema solar</a></li>
<li><a href="../pt487610/index.html">RealWorld: aiohttp, Tortoise ORM</a></li>
<li><a href="../pt487612/index.html">Adicione, exclua e renomeie facilmente arquivos e metas em projetos do CMake</a></li>
<li><a href="../pt487616/index.html">Criando um item personalizado usando uma tabela de exemplo em C # para Windows Form</a></li>
<li><a href="../pt487620/index.html">Solução de problemas com pwnable.kr 27 - tiny_easy. Entendendo a pulverização em pilha</a></li>
<li><a href="../pt487626/index.html">Como os sensores de estacionamento funcionam e como enganá-lo</a></li>
<li><a href="../pt487628/index.html">Diagnóstico do envelhecimento com base em 9 características dos sinais de envelhecimento</a></li>
<li><a href="../pt487630/index.html">O algoritmo mais simples para criar um quebra-cabeça de campo (parte 1)</a></li>
<li><a href="../pt487632/index.html">“Colegas, respirem mais silenciosamente”: por que o barulho do escritório nos deixa loucos - discutimos pesquisas</a></li>
<li><a href="../pt487636/index.html">APIs para as quais finalmente vale a pena atualizar do Java 8. Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>