<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÆÔ∏è ‚≠êÔ∏è ‚ôèÔ∏è Transparent Squid with SSL-Bump for Gentoo with nft üõ¨ üõÄüèª ü§±üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Background
 Recently, I undertook to translate the firewall on my PC with time-tested iptables to the brand new nftables. For a more in-depth study of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Transparent Squid with SSL-Bump for Gentoo with nft</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infowatch/blog/492260/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/6i/gj/ij/6igjijyvov-oxhfi4er8ecb6fu4.png" alt="image"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, I undertook to translate the firewall on my PC with time-tested iptables to the brand new nftables. </font><font style="vertical-align: inherit;">For a more in-depth study of nf tables, I set myself the task: to configure a transparent proxy server (Squid) with encrypted connection parsing (HTTPS) to distribute Internet access to virtual machines, Raspberry Pi PCs, as well as my smartphone (running Android 6th release) over a wireless connection (using the hostapd application).</font></font><br>
<a name="habracut"></a><br>
<h3></h3><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td>  </td>
<td>     .</td>
</tr>
<tr>
<td><b> </b></td>
<td>,     .</td>
</tr>
<tr>
<td><i> </i></td>
<td>,     (  ,     ,     . .).    ,  ,  .</td>
</tr>
<tr>
<td><u> </u></td>
<td>,      </td>
</tr>
</tbody></table></div><br>
<h3></h3><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td> </td>
<td>¬´Gentoo Linux¬ª     ¬´OpenRC¬ª.<br>
       <br>
</td>
</tr>
<tr>
<td></td>
<td>sys-kernel/gentoo-sources-5.3.1<br>
USE=""<br>
    USE-  <br>
</td>
</tr>
<tr>
<td>-</td>
<td>net-proxy/squid-4.8<br>
USE="<b>caps</b> ssl ssl-crtd"<br>
</td>
</tr>
<tr>
<td><u> </u></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev-libs / openssl-1.1.1c-r1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USE = "asm test zlib"</font></font><br>
</td>
</tr>
<tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nft app</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">net-firewall / nftables-0.9.2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USE = "doc gmp modern_kernel"</font></font><br>
</td>
</tr>
<tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ip application</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sys-apps / iproute2-5.2.0-r1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USE = "caps minimal"</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logging Service</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app-admin / ulogd-2.0.7-r1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USE = "nfct nflog"</font></font><br>
</td>
</tr>
</tbody></table></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernel tuning</font></font></h3><br>
<img src="https://habrastorage.org/webt/ji/de/sw/jideswukirdke8u-7ud5kv6zsya.png" alt="image"><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same thing but text</font></font></b><div class="spoiler_text"><code>[*] Networking support ---&gt;<br>
 Networking options ---&gt;<br>
 [*] TCP/IP networking<br>
 [*] IP: advanced router<br>
 [*] IP: policy routing<br>
 [*] Network packet filtering framework (Netfilter) ---&gt;<br>
 [*] Advanced netfilter configuration<br>
 Core Netfilter Configuration ---&gt;<br>
 #  ,         <br>
 [*] Netfilter ingress support<br>
 #  ,    <br>
 &lt;*&gt; Netfilter LOG over NFNETLINK interface<br>
 &lt;*&gt; Netfilter connection tracking support<br>
 &lt;*&gt; Netfilter nf_tables support<br>
 &lt;*&gt; Netfilter nf_tables set infrastructure<br>
 #  ,         <br>
 [*] Netfilter nf_tables netdev tables support<br>
 &lt;*&gt; Netfilter nf_tables conntrack module<br>
 #  ,    <br>
 &lt;*&gt; Netfilter nf_tables counter module<br>
 #  ,    <br>
 &lt;*&gt; Netfilter nf_tables log module<br>
 &lt;*&gt; Netfilter nf_tables masquerade support<br>
 &lt;*&gt; Netfilter nf_tables nat module<br>
 &lt;*&gt; Netfilter nf_tables socket match support<br>
 &lt;*&gt; Netfilter nf_tables tproxy support<br>
 IP: Netfilter Configuration ---&gt;<br>
 [*] IPv4 nf_tables support<br>
 #  ,        <br>
 &lt;*&gt; Ethernet Bridge nf_tables support ---&gt;<br>
</code><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For reference, I quote an excerpt from /usr/src/linux/.config:</font></font><br>
<br>
<pre><code class="plaintext hljs">CONFIG_NET=y<font></font>
CONFIG_INET=y<font></font>
&lt;b&gt;CONFIG_IP_ADVANCED_ROUTER=y<font></font>
CONFIG_IP_MULTIPLE_TABLES=y&lt;/b&gt;<font></font>
CONFIG_NETFILTER=y<font></font>
CONFIG_NETFILTER_ADVANCED=y<font></font>
CONFIG_NETFILTER_INGRESS=y<font></font>
CONFIG_NETFILTER_NETLINK=y<font></font>
CONFIG_NETFILTER_NETLINK_LOG=y<font></font>
CONFIG_NF_CONNTRACK=y<font></font>
CONFIG_NF_TABLES=y<font></font>
CONFIG_NF_TABLES_SET=y<font></font>
CONFIG_NF_TABLES_NETDEV=y<font></font>
CONFIG_NFT_CT=y<font></font>
CONFIG_NFT_COUNTER=y<font></font>
CONFIG_NFT_LOG=y<font></font>
CONFIG_NFT_MASQ=y<font></font>
CONFIG_NFT_NAT=y<font></font>
&lt;b&gt;CONFIG_NFT_SOCKET=y<font></font>
CONFIG_NFT_TPROXY=y&lt;/b&gt;<font></font>
CONFIG_NF_TABLES_BRIDGE=y<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network configuration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the net.lo service is not added to the boot runlevel, then it should be added there:</font></font><br>
<br>
<pre><code class="bash hljs">rc-config add net.lo boot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same way, they are created and configured to run for the net service default level. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">br0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (bridge for virtual machines and smartphone), net. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enp0s25</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (wired interface) and net. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wlp3s0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (wireless interface), for example:</font></font><br>
<br>
<pre><code class="bash hljs">ln -s net.lo /etc/init.d/net.br0<font></font>
rc-config add net.br0 default<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final configuration file /etc/conf.d/net in our example looks like this (minus the settings not related to our task):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/tr/ss/ijtrssmgqse8ds1utvhxm5pyafm.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same thing but text</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs"># TProxy<font></font>
routes_lo='local default dev lo table 3128'<font></font>
<font></font>
# Qemu bridge<font></font>
bridge_force_br0=''<font></font>
mac_br0='XX:XX:XX:XX:XX:XX'<font></font>
config_br0='192.168.120.1/24'<font></font>
<font></font>
# Ethernet<font></font>
config_enp0s25='dhcp'<font></font>
modules_enp0s25='udhcpc'<font></font>
dhcp_enp0s25='release nontp'<font></font>
udhcpc_enp0s25='--retries 8 --timeout 10'<font></font>
fallback_enp0s25='10.a.b.c/16'<font></font>
fallback_routes_enp0s25='default via 10.a.0.1'<font></font>
<font></font>
# Wi-Fi<font></font>
if [[ -f /var/lib/misc/hostapd ]]; then<font></font>
  modules_wlp3s0="!ifconfig !iwconfig !wpa_supplicant"<font></font>
  config_wlp3s0='null'<font></font>
else<font></font>
  config_wlp3s0='dhcp'<font></font>
  modules_wlp3s0='udhcpc'<font></font>
  wpa_supplicant_wlp3s0='-Dnl80211'<font></font>
fi<font></font>
<font></font>
postup() {<font></font>
  if [ "${IFACE}" == lo ]; then<font></font>
    ip rule add fwmark 3128 lookup 3128<font></font>
  fi<font></font>
  return 0<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The highlighted lines add a new routing table, in this example under number 3128, and the gate is the default for it (the loopback interface), and the rule is according to which packets marked with a firewall with the label number 3128 (decimal numbers in both cases) served by this schedule. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to prevent routed packets from being discarded due to network level addresses mismatch (transparent proxying keeps packets intact!), Add the following lines to /etc/sysctl.conf (or change existing ones): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hn/44/lp/hn44lpq6q4fnukzklzjnanliucy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need to apply these settings before rebooting, then you should additionally set them for both network interfaces with Internet access:</font></font><br>
<br>
<pre><code class="bash hljs">sysctl net.ipv4.conf.enp0s25.rp_filter=0<font></font>
sysctl net.ipv4.conf.wlp3s0.rp_filter=0</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxy settings</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the normal (opaque) port of the proxy server will be fixed to the bridge address ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.120.1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), add the following line to /etc/rc.conf:</font></font><br>
<br>
<pre><code class="bash hljs">rc_squid_need=<span class="hljs-string">"net.br0"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following proxy settings will not be considered in this article:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verification of the identity of users on a regular (non-transparent) port;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICAP to integrate with a data leak prevention device (e.g. InfoWatch Traffic Monitor);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generating encryption keys and creating a certificate.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configuration file /etc/squid/squid.conf in the end looks like this (just in case, I give it completely):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9l/q8/k3/9lq8k3q9zsxsp8iedwfxqdnvzeq.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/3t/4n/zz/3t4nzzhfayg0nz-fjnlyetksspy.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same thing but text</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">	#    <font></font>
1	acl virtual_machines src 192.168.120.0/24<font></font>
2	acl SSL_ports port 443<font></font>
	#      HTTPS <font></font>
3	acl SSL_ports port 1012        #  badssl.com<font></font>
	#      HTTPS <font></font>
4	acl SSL_ports port 33443       # getcourse.ru  artlinerschool.ru<font></font>
5	acl Safe_ports port 21         # ftp<font></font>
6	acl Safe_ports port 80         # http<font></font>
7	acl Safe_ports port 443        # https<font></font>
	#     <font></font>
8	acl Safe_ports port 1012       #  badssl.com<font></font>
9	acl Safe_ports port 1025-65535 #  <font></font>
10	acl CONNECT method CONNECT <font></font>
11	http_access deny !Safe_ports<font></font>
12	http_access deny CONNECT !SSL_ports<font></font>
13	http_access allow localhost manager<font></font>
14	http_access deny manager<font></font>
15	http_access allow localhost<font></font>
	#      -<font></font>
16	http_access allow virtual_machines<font></font>
17	http_access deny all<font></font>
	#   () .   ,       (,   - FTP)<font></font>
18	http_port 192.168.120.1:3128 ssl-bump options=ALL:NO_SSLv3:NO_TLSv1 cert=/etc/squid/squid.pem<font></font>
	#      .     ¬´loopback¬ª,         3128,  ,         <font></font>
19	http_port 127.0.0.1:3129 tproxy<font></font>
	#      .     ¬´loopback¬ª,         3128,  ,         <font></font>
20	https_port 127.0.0.1:3130 tproxy ssl-bump options=ALL:NO_SSLv3:NO_TLSv1 cert=/etc/squid/squid.pem<font></font>
	# -    ,   -<font></font>
21	always_direct allow all<font></font>
	#    ,   <font></font>
22	acl BrokenButTrustedServers dstdomain "/etc/squid/selfsigned.txt"<font></font>
	#      ,   <font></font>
23	sslproxy_cert_error allow BrokenButTrustedServers<font></font>
24	sslproxy_cert_error deny all<font></font>
	#       TLS<font></font>
25	tls_outgoing_options min-version=1.2<font></font>
	#    <font></font>
26	acl blocked ssl::server_name "/etc/squid/blocked_domains.txt"<font></font>
	#   ,    -   (          SSL)<font></font>
27	acl fragile dstdomain "/etc/squid/fragile_domains.txt"<font></font>
28	acl step1 at_step SslBump1<font></font>
29	ssl_bump peek step1<font></font>
	#     <font></font>
30	ssl_bump terminate blocked<font></font>
	#       ,    -  <font></font>
31	ssl_bump splice fragile<font></font>
	#     ,  <font></font>
32	ssl_bump bump all<font></font>
	#    <font></font>
33	sslcrtd_program /usr/libexec/squid/security_file_certgen -s /var/lib/squid/ssl -M 4MB<font></font>
34	cache_dir rock /var/cache/squid-r 512 max-size=32768<font></font>
35	cache_dir aufs /var/cache/squid 512 64 1024 min-size=32768<font></font>
36	coredump_dir /var/tmp/squid<font></font>
37	refresh_pattern    ^ftp:          1440 20% 10080<font></font>
38	refresh_pattern -i (/cgi-bin/|\?) 0    0%  0<font></font>
39	refresh_pattern    .              0    20% 4320<font></font>
40	memory_replacement_policy heap GDSF<font></font>
41	cache_replacement_policy LFUDA<font></font>
42	maximum_object_size 32 MB<font></font>
43	logfile_rotate 3<font></font>
44	debug_options ALL,1,rotate=3<font></font>
45	cache_mem 512 MB<font></font>
46	visible_hostname host.shadow.amn<font></font>
47	udp_incoming_address 127.0.0.1<font></font>
48	pinger_enable off<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall setup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set up the nftables and ulogd services at the ‚Äúdefault‚Äù run level (the latter is needed for package notification):</font></font><br>
<br>
<pre><code class="bash hljs">rc-config add nftables default<font></font>
rc-config add ulogd default</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since there will be a bridge in the firewall settings, add the following line to /etc/rc.conf:</font></font><br>
<br>
<pre><code class="bash hljs">rc_nftables_need=<span class="hljs-string">"net.br0"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the notification to work in /etc/sysctl.conf, add the following line:</font></font><br>
<br>
<pre><code class="bash hljs">net.netfilter.nf_log.2 = nfnetlink_log</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So that the configuration file is in the / etc / nftables folder, we make the following change in /etc/conf.d/nftables:</font></font><br>
<br>
<pre><code class="bash hljs">NFTABLES_SAVE=<span class="hljs-string">"/etc/nftables/rules-save"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To prevent temporary changes from being saved in the configuration file, make another change to /etc/conf.d/nftables:</font></font><br>
<br>
<pre><code class="bash hljs">SAVE_ON_STOP=<span class="hljs-string">"no"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will describe the tasks assigned to the firewall:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default rules in all chains of the ip filter table should remove packets (even in the chain of output!). </font><font style="vertical-align: inherit;">Similarly for netdev filter tables;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exchange of any kind, except for IPv4 and related service exchange (for example, ARP), is suppressed as soon as possible (neither IPv4 nor IPSec are used);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPv4 multicast packets are also removed as early as possible;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To protect the Android smartphone (when connected to the bridge using the hostapd application), the broadcast exchange made by virtual machines running under the Microsoft Windows operating system should not be transmitted to the wireless interface.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can only use our Wi-Fi devices with known MAC addresses.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The configuration file / etc / nftables / rules-save in the end looks like this (minus most of the explanations):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/wy/fw/chwyfwcn5nv_n7nlt2zxrpdm53w.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/l4/ne/7s/l4ne7sbb2axs_3d05e23aiq0qhg.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/sg/fi/tw/sgfitwvevtdo4fz54ggdjrmosn4.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/iu/o8/hs/iuo8hs0m7zteeidibt9auoamnca.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/ak/9j/xi/ak9jxifxhq1s44cuanzyfqgyxlu.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/lt/sb/iw/ltsbiweb6a1n-na0cabv2xegvjq.png" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same thing but text</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">1	#!/sbin/nft -f<font></font>
	#  ,     <font></font>
2	define icmp_types = { destination-unreachable, time-exceeded, parameter-problem, echo-request, echo-reply }<font></font>
3	define host = 192.168.120.1<font></font>
4	define br = br0<font></font>
5	define my_br_mac = XX:XX:XX:XX:XX:XX<font></font>
6	define eth = enp0s25<font></font>
7	define my_eth_mac = YY:YY:YY:YY:YY:YY<font></font>
8	define wifi = wlp3s0<font></font>
9	define my_wifi_mac = WW:WW:WW:WW:WW:WW<font></font>
10	define my_phone = TT:TT:TT:TT:TT:TT<font></font>
11	define virtual_machines = 192.168.120.0/24<font></font>
12	define privileged_vm = { 192.168.120.22, 192.168.120.129 }<font></font>
13	define dhcp_client = 192.168.120.224/27<font></font>
14	define transmission_port = 51413<font></font>
15	define no_track = { microsoft-ds, ms-wbt-server }<font></font>
16	define vm_ssh = 192.168.120.70<font></font>
17	define infowatch_pc = { 10.a.0.0/16, 10.h.0.0/16 }<font></font>
18	define infowatch_my = 10.a.b.c<font></font>
19	define squid_normal = 3128<font></font>
20	define squid_transp = 3129<font></font>
21	define squid_trassl = 3130<font></font>
22	define sslvpn.infowatch.com = 46.148.194.86<font></font>
23	define files.infowatch.ru = 178.16.25.15<font></font>
24	define iwprint.infowatch.ru = 10.d.e.f<font></font>
25	define s163.getcourses.ru = 95.213.153.163<font></font>
26	define tls-v1-2.badssl.com = 104.154.89.105<font></font>
27	flush ruleset<font></font>
28	table ip raw {<font></font>
29	  chain prerouting {<font></font>
30	    type filter hook prerouting priority -300;<font></font>
	    #      ,          <font></font>
31	    meta l4proto { tcp, udp } th dport $transmission_port notrack<font></font>
32	    tcp sport $no_track ip saddr != $iwprint.infowatch.ru notrack<font></font>
33	    ip saddr { $sslvpn.infowatch.com, $files.infowatch.ru } tcp sport https notrack<font></font>
34	  }<font></font>
35	}<font></font>
36	table ip filter {<font></font>
37	  chain input {<font></font>
38	    type filter hook input priority 0; policy drop;<font></font>
	    #         ,        ¬´loopback¬ª<font></font>
39	    iif lo accept<font></font>
	    #   ICMP       ,       ICMP<font></font>
40	    icmp type $icmp_types accept<font></font>
	    #   <font></font>
41	    ct state invalid counter drop<font></font>
	    #   ,     (SACK)  TCP.        ,       <font></font>
42	    tcp flags syn tcp option maxseg size &lt; 999 counter drop<font></font>
	    #   Bittorrent,         31<font></font>
43	    iif $eth meta l4proto { tcp, udp } th dport $transmission_port accept<font></font>
	    #  ,  ,       ,      <font></font>
44	    tcp flags &amp; (syn | ack) == syn ct state untracked log prefix "Untracked:" group 2 counter counter drop<font></font>
	    #    ,        32<font></font>
45	    tcp sport $no_track accept<font></font>
	    #    ,        33<font></font>
46	    ip saddr { $sslvpn.infowatch.com, $files.infowatch.ru } tcp sport https accept<font></font>
	    #     ,   3128 ( )<font></font>
47	    iif $br ip saddr $virtual_machines mark set 3128 counter accept<font></font>
	    #       ,      ()  -<font></font>
48	    iif $br ip daddr $host ip saddr $virtual_machines tcp dport { domain, http, microsoft-ds, nfs, $squid_normal } accept<font></font>
	    #     <font></font>
49	    ct state { established, related } accept<font></font>
	    #       ,   <font></font>
50	    iif $br udp dport { domain, bootps, tftp, 4011 } counter accept<font></font>
	    #    ,        ,   (.  38)<font></font>
51	    counter comment "  "<font></font>
52	  }<font></font>
53	  chain output {<font></font>
54	    type filter hook output priority 100; policy drop;<font></font>
	    #         ,        ¬´loopback¬ª<font></font>
55	    oif lo accept<font></font>
	    #   ICMP       ,       ICMP<font></font>
56	    icmp type $icmp_types counter accept<font></font>
	    #          (   48  50)<font></font>
57	    oif { $eth, $wifi } udp dport . udp sport { bootps . bootpc } counter accept<font></font>
58	    oif $br ip saddr $host ip daddr { $dhcp_client, 255.255.255.255 } udp sport . udp dport { bootps . bootpc } counter accept<font></font>
59	    oif $br ip saddr $host ip daddr $virtual_machines udp sport { domain, tftp } counter accept<font></font>
60	    oif $br ip saddr $host ip daddr $virtual_machines tcp sport { domain, http, microsoft-ds } accept<font></font>
	    #  -           .      HTTPS   ,            <font></font>
61	    oif $br ip daddr $virtual_machines tcp sport { http, https, 1012 } counter accept<font></font>
	    #      ,     ,    1024<font></font>
62	    meta l4proto { tcp, udp } th sport &gt;= 1025 accept<font></font>
	    #    ,        ,   (.  54)<font></font>
63	    counter comment "  "<font></font>
64	  }<font></font>
65	  chain forward {<font></font>
66	    type filter hook forward priority 0; policy drop;<font></font>
	    #        (MTU)<font></font>
67	    tcp flags syn tcp option maxseg size set rt mtu counter<font></font>
	    #         <font></font>
68	    iif $br ip daddr != $host meta l4proto { tcp, udp } th dport domain drop<font></font>
	    #      ( -)      ,     ,  ,   .    ,      ( 80  443)     -,    divert         forward (  66  81).  ,   96      ,      80  443<font></font>
69	    iif $br ip saddr { $privileged_vm, $dhcp_client } accept<font></font>
70	    oif $br ip daddr { $privileged_vm, $dhcp_client } accept<font></font>
	    #    ,        ,   (.  66)<font></font>
71	    counter comment "  "<font></font>
72	  }<font></font>
	  #    ¬´   ‚Ä¢ ¬ª     HTTPS  ,   443<font></font>
73	  set nonstandard_https {<font></font>
74	    type ipv4_addr . inet_service;<font></font>
75	    elements = {<font></font>
76	      $s163.getcourses.ru . 33443, #   artlinerschool.ru<font></font>
77	      $tls-v1-2.badssl.com . 1012, #   badssl.com<font></font>
78	  }<font></font>
79	}<font></font>
80	  chain divert {<font></font>
81	    type filter hook prerouting priority -150; policy accept;<font></font>
	    #   3128 (. .)   TCP,   ,    (  -)<font></font>
82	    meta l4proto tcp socket transparent 1 mark set 3128 accept<font></font>
	    #   3128 (. .)   TCP   ,   80.      -<font></font>
83	    ip daddr != { 127.0.0.1, $host } tcp dport http tproxy to 127.0.0.1:$squid_transp mark set 3128 counter accept<font></font>
	    #   3128 (. .)   TCP   ,   443.      -<font></font>
84	    ip daddr != { 127.0.0.1, $host } tcp dport https tproxy to 127.0.0.1:$squid_trassl mark set 3128 counter accept<font></font>
	    #    3128 (. .)   TCP        nonstandard_https (.  76  77  ).      -<font></font>
85	    ip daddr . tcp dport @nonstandard_https tproxy to 127.0.0.1:$squid_trassl mark set 3128 counter accept<font></font>
86	  }<font></font>
87	}<font></font>
88	table ip nat {<font></font>
89	  chain prerouting {<font></font>
90	    type nat hook prerouting priority 0; policy accept;<font></font>
	    #               SSH<font></font>
91	    iif $eth ip daddr $infowatch_my ip saddr $infowatch_pc tcp dport ssh counter dnat $vm_ssh<font></font>
92	  }<font></font>
93	  chain postrouting {<font></font>
94	    type nat hook postrouting priority 100; policy accept;<font></font>
	    #      ,   -,         .  -     UID  GID <font></font>
95	    oif { $eth, $wifi } ip saddr $virtual_machines skuid . skgid { squid . squid } counter masquerade<font></font>
	    #      ,     ,  ,     , (   69  70).     ,    ,       HTTPS .           nonstandard_https (.  76  77  ).<font></font>
96	    oif { $eth, $wifi } ip saddr { $privileged_vm, $dhcp_client } tcp dport != { http, https } log prefix "NAT:" group 2 counter masquerade<font></font>
97	  }<font></font>
98	}<font></font>
	<font></font>
99	table bridge filter {<font></font>
  #   ‚Ññ5:     Wi-Fi   <font></font>
100	  chain input {<font></font>
    type filter hook input priority -200; policy accept;<font></font>
    iif $wifi ether saddr != $my_phone counter drop<font></font>
  }<font></font>
  #   ‚Ññ4:    ,    IPv4,      <font></font>
  chain forward {<font></font>
101	    type filter hook forward priority -200; policy accept;<font></font>
102	    oif $wifi ether type arp accept<font></font>
103	    oif $wifi ip protocol { icmp, tcp, udp } ip daddr != 192.168.120.255 accept<font></font>
104	    oif $wifi drop<font></font>
105	  }<font></font>
  #   ‚Ññ5:   Wi-Fi     <font></font>
106	  chain output {<font></font>
    type filter hook input priority 200; policy accept;<font></font>
    oif $wifi ether daddr != $my_phone counter drop<font></font>
  }<font></font>
}<font></font>
	#   ‚Ññ2:     ,    IPv4<font></font>
107	table netdev filter {<font></font>
108	  chain enp0s25 {<font></font>
109	    type filter hook ingress device enp0s25 priority 0; policy drop;<font></font>
110	    ether type arp accept<font></font>
111	    ether daddr $my_eth_mac ip protocol { icmp, tcp, udp, gre } accept<font></font>
112	  }<font></font>
113	  chain wlp3s0 {<font></font>
114	    type filter hook ingress device wlp3s0 priority 0; policy drop;<font></font>
	    #  ARP  EAPOL  ,        <font></font>
115	    ether type { arp, 0x888e } accept<font></font>
	    #       ,         ,   <font></font>
116	    ether daddr { $my_br_mac, $my_wifi_mac, ff:ff:ff:ff:ff:ff } ip protocol { icmp, tcp, udp, gre } accept<font></font>
117	  }<font></font>
118	}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consumer customization</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the PC itself</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For more thorough tests of a transparent proxy server, I decided to use it for all applications (with some exceptions, more on that later) on the PC itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the proxy server certificate to the shared store:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p /usr/<span class="hljs-built_in">local</span>/share/ca-certificates<font></font>
cp /etc/squid/squid.pem /usr/<span class="hljs-built_in">local</span>/share/ca-certificates/squid.crt</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update the repository:</font></font><br>
<br>
<pre><code class="bash hljs">update-ca-certificates</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Applications - Firefox and Chromium web browsers do not use a common certificate store, therefore it should be added to the corresponding store of these applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the configuration file /etc/env.d/38proxy with the following lines:</font></font><br>
<br>
<pre><code class="bash hljs">http_proxy=http://192.168.120.1:3128<font></font>
https_proxy=http://192.168.120.1:3128<font></font>
ftp_proxy=http://192.168.120.1:3128<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update environment variables:</font></font><br>
<br>
<pre><code class="bash hljs">env-update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After re-entering the settings will be applied to all applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About exceptions:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just in case, let‚Äôs leave the Chromium web browser, it will always connect to the network directly, without a proxy server, for this we will change the / etc / chromium / default configuration file this way: </font></font><br>
<br>
<pre><code class="bash hljs">CHROMIUM_FLAGS=<span class="hljs-string">"--enable-seccomp-sandbox ‚Äîno-proxy-server"</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the presence of the https_proxy environment variable, the xfreerdp application tries to connect through a proxy server, so add the following line to the shell configuration file: </font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">alias</span> xfreerdp=<span class="hljs-string">'https_proxy= xfreerdp'</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The youtube-dl application cannot verify the certificate, probably due to the nature of the Python certificate store. </font><font style="vertical-align: inherit;">A permanent solution has not yet been found, so add the following line to the shell configuration file:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">alias</span> youtube-dl=<span class="hljs-string">'youtube-dl --no-check-certificate'</span></code></pre></li>
</ol><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On Red Hat Enterprise Linux OS 6 and 7 virtual machines</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the virtual machine, enable PEM certificates:</font></font><br>
<br>
<pre><code class="bash hljs">update-ca-trust force-enable</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We rewrite the proxy server certificate from the PC to the virtual machine:</font></font><br>
<br>
<pre><code class="bash hljs">scp squid.crt root@192.168.120.66:/etc/pki/ca-trust/<span class="hljs-built_in">source</span>/anchors/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the virtual machine we update the certificate:</font></font><br>
<br>
<pre><code class="bash hljs">update-ca-trust extract</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On virtual machines with Microsoft Windows operating systems of different editions</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The certificate is uploaded to the general certificate store of the machine (not the user!) In the "Trusted Roots ..." section. </font><font style="vertical-align: inherit;">The Firefox web browser does not use a common certificate store, so the certificate should be added to the corresponding store of this application.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On a Raspberry Pi PC with Raspbian OS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Application upgrade was successful without installing a certificate.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On smartphones with Android OS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The certificate is preloaded onto the device, then installed using the certificate management application. </font><font style="vertical-align: inherit;">After that, the user will be asked to enhance the security of entering the device (if not already done) with the help of a graphic key or password.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The new Linux firewall (nft) is a great example of free software that goes well with Squid, the de facto standard of a free proxy server.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primary sources</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://wiki.squid-cache.org/Features/Tproxy4</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2. /usr/src/linux/Documentation/networking/tproxy.txt </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://wiki.nftables.org</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
4. nft (8) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.bounca.org/tutorials/install_root_certificate.html </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Author:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Shamil Saitov</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nikodim_Tychoblin</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492244/index.html">Removal for the period of coronavirus: home "arrest" or time of opportunity?</a></li>
<li><a href="../en492246/index.html">Coronavirus: Possible Implications for Society, Economics, and Medicine</a></li>
<li><a href="../en492248/index.html">Debouncing with React Hooks</a></li>
<li><a href="../en492254/index.html">Project Management, Category 30+</a></li>
<li><a href="../en492258/index.html">What is Open Graph markup and how to implement it without a programmer</a></li>
<li><a href="../en492262/index.html">Conferences DotNext, Heisenbug, HolyJS, C ++ Russia, DevOops and JPoint are postponed due to coronavirus</a></li>
<li><a href="../en492268/index.html">Network Digest: Information Security, Protocols, and Quantum Internet</a></li>
<li><a href="../en492270/index.html">AI will protect seals and beluga whales</a></li>
<li><a href="../en492272/index.html">FragmentLifecycleCallbacks</a></li>
<li><a href="../en492274/index.html">What do we want from an analyst</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>