<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🎨 👊 👨🏽‍💼 FreePBX キュー内の不在着信コールの電子メール通知のためのアスタリスクの構成 💎 🔘 😡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IP ATCアスタリスクは、強力なIPテレフォニープロセッサです。また、Asterisk用に作成されたFreePBX Webインターフェイスは、構成を大幅に簡素化し、システムにログインするためのしきい値を下げます。
 IPテレフォニーに関連するある種のタスクを思い付くことができれば、ほぼ確実にアスタ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FreePBX キュー内の不在着信コールの電子メール通知のためのアスタリスクの構成</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463829/"><img src="https://habrastorage.org/webt/ke/dl/08/kedl08qszm8sgw39uk2zteenbja.png" alt="画像"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IP ATCアスタリスクは、強力なIPテレフォニープロセッサです。また、Asterisk用に作成されたFreePBX Webインターフェイスは、構成を大幅に簡素化し、システムにログインするためのしきい値を下げます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IPテレフォニーに関連するある種のタスクを思い付くことができれば、ほぼ確実にアスタリスクに実装できます。ただし、忍耐力と忍耐力が必要になることを確認してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不在着信の電子メール通知を設定するという課題に直面しました。より正確には、着信コールがキューに入れられたが、（エージェントからの）誰もこの着信コールに応答していない場合に、これらのケースを電子メールで通知するため。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驚いたことに、FreePBXでこの問題を解決するための通常のツールは見つかりませんでした。この問題をカットでどのように解決したかについてお話します。</font></font><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">序文</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
「直接」の課題を解決する前に、インターネットで情報を確実に検索しましたが、すぐに使える解決策は見つかりませんでした（おそらく見栄えがよくなかったが、何ができるか...）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アスタリスクには、希望するほど多くの作業スキルがないため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">提供さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れる</font></a><font style="vertical-align: inherit;">ソリューション</font><font style="vertical-align: inherit;">は完全には理解されておらず、破棄されました。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a><font style="vertical-align: inherit;">で</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提案さ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た解決策は気に入りましたが、</font><font style="vertical-align: inherit;">うまく</font><font style="vertical-align: inherit;">いき</font><font style="vertical-align: inherit;">ませんでした。ここから、キュー[ext-queues]のコンテキストでアスタリスクでの作業が必要であることを強調しました。また、Freepbxで作業するため、構成ファイル「extensions_override_freepbx.conf」で作業する必要があります。 hangupcallイベント（通話の終了）の前に「不在着信をキャッチ」すると便利であることに気付きました。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここで</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の議論を読んだ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、キュー内のすべてのエージェントについて、CDRの「Disposition」変数をフィルタリングする必要があるという考えが浮上しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情報</font><font style="vertical-align: inherit;">を読んだ後</font><font style="vertical-align: inherit;">、問題を解決するために非常に具体的な手順が取られました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちが持っているもの：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
アスタリスク13.12.1を使用するFreePBX 13.0.197があります。 OSバージョンSHMZリリース6.6（最終）。配布はCentOSに基づいています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アスタリスクは、IVR（音声メニュー）を使用して構成され、着信呼び出しをさまざまなキュー（キュー）に分散します。エージェント（エージェント）は、各キュー、つまりエージェントに割り当てられます。</font><b><font style="vertical-align: inherit;">アスタリスク</font></b></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">何が起こるかの</font></b><b><font style="vertical-align: inherit;">理論</font></b></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
着信コールがアスタリスクに到着すると、そのコールはIVRに送られます。発信者は、電話で特定の番号を押すことによって選択を行い、特定のキューに分類されます。その後、キューのすべてのフリーエージェントが同時にコールを受信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で何が起こっているのか、次に何が起きているのかをよりよく理解するには、「CDRの報告」を参照してください（図1）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/qg/86/svqg86ls1ot8x4lcl5syw7oq3w0.png" alt="画像"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図1</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
着信コールがキューに落ちたとき、すべてのエージェントについて、その時点でエージェントがビジーでなかった場合、変数「Disposition」の値は「NO ANSWER」に等しくなりました。変数「Disposition」は他の値を取ることができます（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">https://asterisk-pbx.ru/wiki/asterisk/cf/cdrを</font></a><font style="vertical-align: inherit;">参照</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、値「ANSWERED」を除きます。また、エージェントの1つが着信に応答した時点で、このエージェントの「Disposition」変数の値は「ANSWERED」に等しくなります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レポートCDRから、コールがキューに入れられると（App列で値が「Queue」になり）、すべてのイベントが同じ「一意」（システム列）で表示されることがわかります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CDRについて簡単に言うと、CDR</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
とは何か、およびCDRのどの時点でレポートCDRで観察されるデータが入力されるかを理解することが重要です。オペレーティングシステムに関連するCDRは、Asteriskが詳細な通話レポートを書き込むデータベースです（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">https://asterisk-pbx.ru/wiki/asterisk/cf/cdrを</font></a><font style="vertical-align: inherit;">参照）</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">私たちの場合、これはmysqlにあるasteriskcdrdbというデータベースです。</font><font style="vertical-align: inherit;">経験的に、特定の「一意」のコールに関するデータは、イベントの発生直後ではなく、hangupcallイベント（コールの終了）の後にアスタリスクcdrdbに入力されることがわかりました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成されたソリューションの原則</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アスタリスクの知識よりもバッシュの知識の方が多いので、主な考え方は以下の通りです。</font><font style="vertical-align: inherit;">hangupcallイベントの前に、bashスクリプトを呼び出します。</font><font style="vertical-align: inherit;">このスクリプトに3つのパラメーターを渡します。</font><font style="vertical-align: inherit;">最初のパラメータは「一意」で、CDRから受信したデータをフィルタリングします。</font><font style="vertical-align: inherit;">2番目のパラメーターは「CALLERID（num）」（発信者の番号）で、誰にコールバックするかを知っています。</font><font style="vertical-align: inherit;">3番目のパラメータは「NODEST」（キュー番号）であり、コールがどの問題で発生したか、および不在着信の電子メール通知を誰に送信するかを知るためにコールが到着しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bashスクリプトはmysqlのasteriskcdrdbデータベースに接続し、「Disposition」変数のすべての値を特定の「一意」で取得する必要があります。取得したデータから、「NO ANSWER」、「BUSY」、「FAILED」、「UNKNOWN」の値を除外する必要があります。その結果、「ANSWERED」が残り、着信コールに応答するか、まったく応答しなくなります-不在着信。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、電話に出られなかった場合、スクリプトは電子メール通知を送信する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先を見据えて、重要な点を指摘しておきます。アスタリスクはコマンドを順番に実行し、その実行を待機します（これは一般に論理的です）。そして、hangupcallコマンドが実行される前にbashスクリプトを呼び出します。したがって、スクリプトが直接実行された時点では、探している「一意の」情報はまだCDRに入力されていません。この問題を解決するには、「＆」パラメーターを使用してbashスクリプトを呼び出し、アスタリスクがすぐに次のステップ、つまりhangupcallに進むようにします。そして、bashスクリプト内では、最初に、アスタリスクがCDRで関心のある「一意の」データを入力するための時間を与えるために、小さな時間遅延を設定します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演習</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
アスタリスクの構成に進み、bashスクリプトを作成する前に、電子メール通知の送信を構成する必要があります。このため、postfixユーティリティを使用します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postfixの設定</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Yandexにメールドメイン「lucky.ru」があります。</font><font style="vertical-align: inherit;">postfixをsmtp-clientモードで構成し、asterisk @ lucky.ruアカウントから手紙を送信します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策はここから取得されます：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//www.dmosk.ru/miniinstruktions.php?mini=postfix-over-yandex</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のインストール/更新/パッケージの確認：</font></font><br>
<br>
<pre><code class="bash hljs">yum install postfix<font></font>
yum install mailx<font></font>
yum install cyrus-sasl cyrus-sasl-lib cyrus-sasl-plain</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインのPostfix構成ファイル「/etc/postfix/main.cf」は上書きしませんが、バックアップします。</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/postfix/main.cf /etc/postfix/main.cf.sav</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「/etc/postfix/main.cf」ファイルを編集して、次の形式にします。 </font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/postfix/main.cf
<span class="hljs-comment">#####################</span><font></font>
relayhost =<font></font>
smtp_sasl_auth_enable = yes<font></font>
smtp_sasl_password_maps = <span class="hljs-built_in">hash</span>:/etc/postfix/private/sasl_passwd<font></font>
smtp_sasl_security_options = noanonymous<font></font>
smtp_sasl_type = cyrus<font></font>
smtp_sasl_mechanism_filter = login<font></font>
smtp_sender_dependent_authentication = yes<font></font>
sender_dependent_relayhost_maps = <span class="hljs-built_in">hash</span>:/etc/postfix/private/sender_relay<font></font>
smtp_generic_maps = <span class="hljs-built_in">hash</span>:/etc/postfix/generic<font></font>
smtp_tls_CAfile = /etc/postfix/ca.pem<font></font>
smtp_use_tls = yes<font></font>
smtputf8_autodetect_classes = all<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「/etc/postfix/main.cf」のすべての行にコメントできるわけではありません。</font><font style="vertical-align: inherit;">一部の行のコメントはパーサーによって決定されず、処理に渡され、これによりエラーが発生します。</font><font style="vertical-align: inherit;">このファイル内のコメントは拒否することをお勧めします。</font><font style="vertical-align: inherit;">次のウィンドウで「tail -f / var / log / messages」を実行すると、これを試すことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「smtputf8_autodetect_classes = all」という行をマークします。</font><font style="vertical-align: inherit;">このエントリにはデフォルトでutf-8が含まれており、追加の操作を行わなくても、文字の本文と件名行の両方でキリル文字を使用できます（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.postfix.org/SMTPUTF8_README.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">参照</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイル用のディレクトリを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir /etc/postfix/private</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル「/ etc / postfix / private / sender_relay」を編集します。</font><font style="vertical-align: inherit;">その中で、メールドメインを使用するときに参照する必要のあるSMTPサーバーを指定する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/postfix/private/sender_relay
<span class="hljs-comment">#####################</span><font></font>
@lucky.ru smtp.yandex.ru<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル「/ etc / postfix / private / sasl_passwd」を編集します。</font><font style="vertical-align: inherit;">その中に、手紙の送信に使用する電子メールアドレスと、このアカウントのユーザー名とパスワードを示します（ユーザー名とパスワードはコロンで指定します）。</font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/postfix/private/sasl_passwd
<span class="hljs-comment">#####################</span><font></font>
asterisk@lucky.ru asterisk@lucky.ru:password_asterisk<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル/ etc / postfix / genericの編集。</font><font style="vertical-align: inherit;">その中に、送信アドレスを置き換えるためのルールを書き留めます（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://wiki.merionet.ru/ip-telephoniya/30/postfix-nastrojka-otpravki-pochty-v-asterisk/を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照</font><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/postfix/generic
<span class="hljs-comment">#####################</span><font></font>
root asterisk@lucky.ru<font></font>
root@localhost asterisk@lucky.ru<font></font>
root@localhost.localdomain asterisk@lucky.ru<font></font>
root@freepbx asterisk@lucky.ru<font></font>
root@freepbx.localdomain asterisk@lucky.ru<font></font>
root@asterisk asterisk@lucky.ru<font></font>
root@asterisk.localdomain asterisk@lucky.ru<font></font>
asterisk asterisk@lucky.ru<font></font>
asterisk@localhost asterisk@lucky.ru<font></font>
asterisk@localhost.localdomain asterisk@lucky.ru<font></font>
asterisk@freepbx asterisk@lucky.ru<font></font>
asterisk@freepbx.localdomain asterisk@lucky.ru<font></font>
asterisk@asterisk asterisk@lucky.ru<font></font>
asterisk@asterisk.localdomain asterisk@lucky.ru<font></font>
root@localdomain.localdomain asterisk@lucky.ru<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の発信アドレスは、「/ etc / hosts」と「/ etc / hostname」の内容、およびレターを送信するユーザーの名前によって異なります。</font><font style="vertical-align: inherit;">つまり、smtpクライアントを使用してasterisk@lucky.ruから手紙を送信するという事実にもかかわらず、Postfix送信者は最初に「自分のもの」を置換し、これはこの構成ファイルのルールで修正する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
my / etc / hostsファイルの内容は次のとおりです。</font></font><br>
<br>
<pre><code class="bash hljs">cat /etc/hosts
<span class="hljs-comment">#####################</span><font></font>
127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 asterisk.localdomain<font></font>
127.0.0.1 localhost.localdomain localhost<font></font>
::1 asterisk localhost localhost6<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メールユーティリティが「/ etc / hosts」でドメイン名を「検索」し、すぐに「検索」しない場合は、さらに数分間これを実行するため、サーバーにはドメイン（ピリオドの後の値）があることが重要です。その後、手紙を送ってください。</font><font style="vertical-align: inherit;">つまり、ドメインが登録されていない場合、手紙は数分遅れて残ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「/ etc / hostname」ファイルの内容をリストします。</font></font><br>
<br>
<pre><code class="bash hljs">cat /etc/hostname
<span class="hljs-comment">#####################</span><font></font>
asterisk<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、作成した構成ファイルをインデックス付きデータベースに転送する必要があります。これを行うには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">postmap /etc/postfix/generic &amp;&amp; postmap /etc/postfix/private/{sasl_passwd,sender_relay}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、smtp.yandex.ru証明書をダウンロードしてサーバーに配置する必要があります。これには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -starttls smtp -crlf -connect smtp.yandex.ru:25 &gt; /etc/postfix/ca.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、技術情報が画面に表示された後、チームは「ハングし続けます」。</font><font style="vertical-align: inherit;">Ctrl + Cキーを押して中止します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、結果のファイルからすべてのゴミを手動で削除し、証明書のみを残します。</font><font style="vertical-align: inherit;">あなたはこのようなものを得るはずです：</font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/postfix/ca.pem
<span class="hljs-comment">#####################</span><font></font>
-----BEGIN CERTIFICATE-----<font></font>
MIIGazCCBVOgAwIBAgIQcUU9mJXW4OUs5Gf0JfLtsjANBgkqhkiG9w0BAQsFADBf<font></font>
...<font></font>
nRG0DfdqYIuPGApFORYe<font></font>
-----END CERTIFICATE-----<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、postfixを再起動します。</font></font><br>
<br>
<pre><code class="bash hljs">service postfix restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストレターを送信します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">echo</span> <span class="hljs-string">"  "</span> | mail -s <span class="hljs-string">" "</span> admin@lucky.ru</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
admin@lucky.ru-宛先アドレス</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでposfixの設定が完了しました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bash-script</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を作成します</font><b><font style="vertical-align: inherit;">bash-script</font></b><font style="vertical-align: inherit;">を格納するためのディレクトリを作成します（こちらの方が好きです）。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir /home/asterisk/scripts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bashスクリプトファイルを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">touch /home/asterisk/scripts/noanswer.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトファイルに実行権限を与えます。</font></font><br>
<br>
<pre><code class="bash hljs">chmod +x /home/asterisk/scripts/noanswer.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルへのアクセス権に疑問がある場合は、デバッグ中にファイルへのフルアクセスを与えることができます。</font><font style="vertical-align: inherit;">しかし、それは「安全ではありません」。</font></font><br>
<br>
<pre><code class="bash hljs">chmod 777 /home/asterisk/scripts/noanswer.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bashスクリプトのテキスト：</font></font><br>
<br>
<pre><code class="bash hljs">nano /home/asterisk/scripts/noanswer.sh
<span class="hljs-comment">#####################</span>
<span class="hljs-meta">#!/bin/bash
</span><font></font>
sleep 7<font></font>
<font></font>
res_sql=<span class="hljs-string">"SELECT disposition FROM cdr WHERE uniqueid = '<span class="hljs-variable">$1</span>'"</span><font></font>
<font></font>
answer=`mysql -u freepbxuser -pPassword_freepbxuser -D asteriskcdrdb -B -N -e <span class="hljs-string">"<span class="hljs-variable">$res_sql</span>"</span> | grep -E -v <span class="hljs-string">"NO ANSWER|BUSY|FAILED|UNKNOWN"</span> | head -n 1`<font></font>
<font></font>
error_kod=0<font></font>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$answer</span>"</span> != <span class="hljs-string">"ANSWERED"</span> ]
<span class="hljs-keyword">then</span><font></font>
<font></font>
 <span class="hljs-keyword">case</span> <span class="hljs-variable">$3</span> <span class="hljs-keyword">in</span><font></font>
 68800)<font></font>
 address=<span class="hljs-string">"big_boss@lucky.ru"</span>
 subject=<span class="hljs-string">"  "</span><font></font>
 ;;<font></font>
 63100)<font></font>
 address=<span class="hljs-string">"debian@lucky.ru"</span>
 subject=<span class="hljs-string">"  linux debian"</span><font></font>
 ;;<font></font>
 63200)<font></font>
 address=<span class="hljs-string">"windows@lucky.ru"</span>
 subject=<span class="hljs-string">"  windows"</span><font></font>
 ;;<font></font>
 63300)<font></font>
 address=<span class="hljs-string">"freebsd@lucky.ru"</span>
 subject=<span class="hljs-string">"  freebsd"</span><font></font>
 ;;<font></font>
 63400)<font></font>
 address=<span class="hljs-string">"ubuntu@lucky.ru"</span>
 subject=<span class="hljs-string">"  linux ubuntu"</span><font></font>
 ;;<font></font>
 63500)<font></font>
 address=<span class="hljs-string">"centos@lucky.ru"</span>
 subject=<span class="hljs-string">"  linux centos"</span><font></font>
 ;;<font></font>
 *)<font></font>
 address=<span class="hljs-string">"admin@lucky.ru"</span><font></font>
 error_kod=1<font></font>
 ;;<font></font>
 <span class="hljs-keyword">esac</span><font></font>
<font></font>
 <span class="hljs-keyword">case</span> <span class="hljs-variable">$error_kod</span> <span class="hljs-keyword">in</span><font></font>
 0)<font></font>
 <span class="hljs-built_in">echo</span> <span class="hljs-string">"    <span class="hljs-variable">$2</span>,  <span class="hljs-variable">$subject</span>."</span> | mail -s <span class="hljs-string">"   <span class="hljs-variable">$2</span>"</span> <span class="hljs-variable">$address</span>
 <span class="hljs-built_in">echo</span> <span class="hljs-string">"   <span class="hljs-variable">$address</span>   <span class="hljs-variable">$2</span>,  <span class="hljs-variable">$subject</span>. uid=<span class="hljs-variable">$1</span>"</span> | mail -s <span class="hljs-string">"   <span class="hljs-variable">$2</span>"</span> admin@lucky.ru<font></font>
 ;;<font></font>
 1)<font></font>
 <span class="hljs-built_in">echo</span> <span class="hljs-string">"   <span class="hljs-variable">$2</span>.  . uid=<span class="hljs-variable">$1</span>"</span> | mail -s <span class="hljs-string">"   <span class="hljs-variable">$2</span>"</span> admin@lucky.ru<font></font>
 ;;<font></font>
 <span class="hljs-keyword">esac</span><font></font>
<font></font>
<span class="hljs-keyword">fi</span>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの簡単な分析：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「スリープ7」：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、前に書いたのと同じ時間遅延です。</font><font style="vertical-align: inherit;">7秒の遅延があります。</font><font style="vertical-align: inherit;">とはいえ、1秒で十分です。</font></font><br>
<br>
<pre><code class="sql hljs">«res_sql="<span class="hljs-keyword">SELECT</span> disposition <span class="hljs-keyword">FROM</span> cdr <span class="hljs-keyword">WHERE</span> uniqueid = <span class="hljs-string">'$1'</span><span class="hljs-string">"»:</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysqlのクエリは、便宜上、別の変数に入れています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、mysqlでリクエストを作成し、結果の出力をフィルタリングします。 「ANSWERED」以外のオプションがあれば削除します。 「ANSWERED」の値が複数ある場合は、1つだけ残してください。最後に、変数「answer」で「ANSWERED」または「」を取得します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数「answer」の値が「ANSWERED」と等しくない場合、これは不在着信です。キュー番号に応じて、case演算子を使用して、電子メール通知を送信する必要がある宛先と、このメッセージに書き込む内容（メッセージの可変部分）を設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、キューがアスタリスクで設定されているが、スクリプトで記述されていない場合のオプションです。この場合、admin @ lucky.ruは、キューがスクリプトに認識されていないことを示す手紙を受け取ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キューが記述されている場合は、宛先の手紙と重複した手紙がadmin@lucky.ruに送信され、「一意」であることを示します。これにより、必要に応じてこの通話のイベントを追跡できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでスクリプトが終了します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysqlへの接続には、事前に認識したユーザー名とパスワードを使用したことに注意してください。</font><font style="vertical-align: inherit;">FreePBXで、mysqlのAsteriskユーザーログインを見つけるには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">cat /etc/amportal.conf | grep AMPDBUSER</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mysqlでアスタリスクユーザーのパスワードを確認するには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">cat /etc/amportal.conf | grep AMPDBPASS</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アスタリスクの設定</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
私たちはFreePBXを使用しています。</font><font style="vertical-align: inherit;">FreePBXにはさまざまな種類の構成ファイル（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://asterisk-pbx.ru/wiki/freepbx/filesを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照</font><font style="vertical-align: inherit;">）があり、それらの一部は特別に設計されているため、再起動時にFreePBXによって上書きされ、一部は上書きされません（カスタムと呼ばれます）ユーザーのために。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タイプがカスタムであるため、構成ファイル「extensions_override_freepbx.conf」を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、「extensions_override_freepbx.conf」ファイルが「/etc/asterisk/extensions.conf」ファイルに接続されていることを確認します。</font><font style="vertical-align: inherit;">これを行うには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">cat /etc/asterisk/extensions.conf | grep extensions_override_freepbx.conf
<span class="hljs-comment">#####################</span>
<span class="hljs-comment">#include extensions_override_freepbx.conf</span>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「/etc/asterisk/extensions_override_freepbx.conf」ファイルを編集して、次の形式にします。</font></font><br>
<br>
<pre><code class="bash hljs">nano /etc/asterisk/extensions_override_freepbx.conf
<span class="hljs-comment">#####################</span><font></font>
[ext-queues]<font></font>
<font></font>
exten =&gt; h,1,System(/home/asterisk/scripts/noanswer.sh <span class="hljs-variable">${CDR(uniqueid)}</span> <span class="hljs-variable">${CALLERID(num)}</span> <span class="hljs-variable">${NODEST}</span> &amp;)<font></font>
exten =&gt; h,2,Macro(hangupcall,)<font></font>
<span class="hljs-comment">#####################</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先に書いたように、末尾の「＆」記号が必要です。 mysqlデータベースから直接CDRデータを使用してbashスクリプトで作業し、このデータは「exten =&gt; h、2、Macro（hangupcall、）」を実行した後にのみmysqlに入力されるため、bashスクリプトの完了を待つ必要はありません。 、アスタリスクの次のステップに進みます。そして、bashスクリプト自体には、その主要部分を実行する前の時間遅延が含まれている必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイル「/etc/asterisk/extensions_override_freepbx.conf」の変更を有効にするには、次のコマンドでAsteriskカーネルを再起動する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">/usr/sbin/asterisk -rx <span class="hljs-string">"core restart now"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、bashスクリプトが作成された後に行う必要があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
おそらく、これはアスタリスクで「不在着信をキャッチ」する1001番目の方法です。</font><font style="vertical-align: inherit;">この問題を解決する方法をコメントで共有してください。</font><font style="vertical-align: inherit;">そして、あなたの意見では、改善/やり直し/最適化できるものは何ですか？</font><font style="vertical-align: inherit;">建設的なアイデアに感謝いたします。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja463817/index.html">20人の製品マネージャーと、すべての中で最も多次元のマトリックス構造。スカイエンとの会話</a></li>
<li><a href="../ja463819/index.html">PostgreSQLロック：2.文字列ロック</a></li>
<li><a href="../ja463821/index.html">AMO、Bitrix、1Cなど：どこから始めればよいか？</a></li>
<li><a href="../ja463823/index.html">Rust 1.37.0リリース：プロファイルに基づく最適化、名前のない定数およびカーゴベンダー</a></li>
<li><a href="../ja463825/index.html">Googleスプレッドシートプロジェクト管理ツール</a></li>
<li><a href="../ja463831/index.html">ロシアのIT教育の何が問題になっていますか</a></li>
<li><a href="../ja463833/index.html">ブロッカーに関する簡単な調査</a></li>
<li><a href="../ja463835/index.html">この危険なIoT：ビジネスの脅威とソリューション</a></li>
<li><a href="../ja463839/index.html">ミュージアムデータアート。ルノレットとソビエトの計算機</a></li>
<li><a href="../ja463845/index.html">電報、誰ですか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>