<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕎 🍺 ☎️ Kurze Einführung in BPF und eBPF 🚌 🕺 👩‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! Wir informieren Sie, dass wir uns auf die Veröffentlichung des Buches " Linux Observability with BPF " vorbereiten .
 
 
 Da sich die virt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kurze Einführung in BPF und eBPF</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/495454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font><font style="vertical-align: inherit;">Wir informieren Sie, dass wir uns auf die Veröffentlichung des Buches " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Observability with BPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">vorbereiten </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/bv/rl/pwbvrl5-5goay7zxvi8tb3fisrc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da sich die virtuelle BPF-Maschine weiterentwickelt und in der Praxis aktiv angewendet wird, haben wir einen Artikel für Sie übersetzt, in dem die Hauptfunktionen und der aktuelle Status beschrieben werden.</font></font><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den letzten Jahren haben Programmiertools und -techniken an Popularität gewonnen, um die Einschränkungen des Linux-Kernels in Fällen auszugleichen, in denen eine leistungsstarke Paketverarbeitung erforderlich ist. Eine der beliebtesten Methoden dieser Art heißt das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Umgehen des Kernels</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Kernel-Bypass) und ermöglicht das Übergeben von Netzwerkschichtkernen die gesamte Paketverarbeitung vom Benutzerraum aus. Das Umgehen des Kernels umfasst auch das Verwalten der Netzwerkkarte vom </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benutzerbereich aus</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mit anderen Worten, wenn wir mit einer Netzwerkkarte arbeiten, verlassen wir uns auf den </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User Space-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Treiber </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch die Übertragung der vollständigen Kontrolle über die Netzwerkkarte aus dem Benutzerbereich auf das Programm reduzieren wir die mit dem Kernel verbundenen Kosten (Switching-Kontext, Verarbeitung der Netzwerkebene, Interrupts usw.), was bei Arbeiten mit einer Geschwindigkeit von 10 Gbit / s oder höher sehr wichtig ist. Der Kernel-Bypass sowie eine Kombination aus anderen Funktionen ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stapelverarbeitung</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) und einer genauen Leistungsoptimierung ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NUMA-Abrechnung</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU-Isolation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usw.) entsprechen den Grundlagen der Hochleistungs-Netzwerkverarbeitung im Benutzerbereich. Ein Musterbeispiel für diesen neuen Ansatz zur Paketverarbeitung ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">möglicherweise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> das </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">DPDK</font></a><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">Data Plane Development Kit) von</font></i><font style="vertical-align: inherit;"> Intel</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), obwohl es andere bekannte Tools und Techniken gibt, darunter VPP von Cisco (Vector Packet Processing), Netmap und natürlich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snabb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Organisation von Netzwerkinteraktionen im Benutzerbereich weist eine Reihe von Nachteilen auf:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Kernel des Betriebssystems ist die Abstraktionsebene für Hardwareressourcen. </font><font style="vertical-align: inherit;">Da User-Space-Programme ihre Ressourcen direkt verwalten müssen, müssen sie auch ihre eigene Hardware verwalten. </font><font style="vertical-align: inherit;">Dies bedeutet häufig, dass Sie Ihre eigenen Treiber programmieren müssen.</font></font></li>
<li>      ,        ,  .        , , ,      .</li>
<li>    ,               .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Wesentlichen wird beim Organisieren von Netzwerkinteraktionen im Benutzerbereich eine Steigerung der Produktivität erreicht, indem die Paketverarbeitung vom Kernel in den Benutzerbereich übertragen wird. XDP macht genau das Gegenteil: Verschiebt Netzwerkprogramme aus dem Benutzerbereich (Filter, Konverter, Routing usw.) in den Kernelbereich. Mit XDP können wir eine Netzwerkfunktion ausführen, sobald das Paket an der Netzwerkschnittstelle ankommt und bevor es in das Netzwerksubsystem des Kernels verschoben wird. Infolgedessen steigt die Paketverarbeitungsgeschwindigkeit erheblich an. Wie erlaubt der Kernel dem Benutzer jedoch, seine Programme im Kernelraum auszuführen? Bevor wir diese Frage beantworten, schauen wir uns an, was BPF ist. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF und eBPF</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz des nicht so klaren Namens BPF (Packet Filtering, Berkeley) handelt es sich tatsächlich um ein Modell einer virtuellen Maschine. </font><font style="vertical-align: inherit;">Diese virtuelle Maschine wurde ursprünglich für die Paketfilterung entwickelt, daher der Name. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines der bekanntesten Tools mit BPF ist </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Beim Erfassen von Paketen mit kann der </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benutzer einen Ausdruck zum Filtern von Paketen angeben. </font><font style="vertical-align: inherit;">Es werden nur Pakete erfasst, die diesem Ausdruck entsprechen. </font><font style="vertical-align: inherit;">Beispielsweise gilt der Ausdruck " </font></font><code>tcp dst port 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" für alle TCP-Pakete, die an Port 80 ankommen. Der Compiler kann diesen Ausdruck verkürzen, indem er ihn in BPF-Bytecode konvertiert. </font><font style="vertical-align: inherit;">
Das obige Programm macht im Grunde Folgendes:</font></font><br>
<br>
<code>$ sudo tcpdump -d "tcp dst port 80"<br>
(000) ldh [12]<br>
(001) jeq #0x86dd jt 2 jf 6<br>
(002) ldb [20]<br>
(003) jeq #0x6 jt 4 jf 15<br>
(004) ldh [56]<br>
(005) jeq #0x50 jt 14 jf 15<br>
(006) jeq #0x800 jt 7 jf 15<br>
(007) ldb [23]<br>
(008) jeq #0x6 jt 9 jf 15<br>
(009) ldh [20]<br>
(010) jset #0x1fff jt 15 jf 11<br>
(011) ldxb 4*([14]&amp;0xf)<br>
(012) ldh [x + 16]<br>
(013) jeq #0x50 jt 14 jf 15<br>
(014) ret #262144<br>
(015) ret #0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anweisung (000): Lädt ein Paket mit Offset 12 als 16-Bit-Wort in die Batterie herunter. </font><font style="vertical-align: inherit;">Ein Offset von 12 entspricht einem Ethertyp-Paket.</font></font></li>
<li> (001):      0x86dd,  ,  ethertype-  IPv6.    true,       (002),    –   (006).</li>
<li> (006):    0x800 (ethertype-  IPv4).   true,     (007),   –   (015).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und so weiter, bis das Paketfilterprogramm ein Ergebnis zurückgibt. Dies ist normalerweise ein Bulean. Die Rückgabe eines Wertes ungleich Null (Befehl (014)) bedeutet, dass sich das Paket nähert, und die Rückgabe von Null (Befehl (015)) bedeutet, dass das Paket nicht angekommen ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die virtuelle BPF-Maschine und ihr Bytecode wurden Ende 1992 von Steve McCann und Van Jacobson vorgeschlagen, als ihr Artikel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSD-Paketfilter: Eine neue Architektur für die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paketerfassung </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">auf Benutzerebene</font></a><font style="vertical-align: inherit;"> erstmals auf einer Usenix-Konferenz im Winter 1993 vorgestellt wurde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da BPF eine virtuelle Maschine ist, definiert es die Umgebung, in der Programme ausgeführt werden. Zusätzlich zum Bytecode werden ein Batch-Speichermodell (Startanweisungen werden implizit auf das Paket angewendet), Register (A und X; Batterie- und Indexregister), Arbeitsspeicher und ein impliziter Programmzähler definiert. Interessanterweise wurde der BPF-Bytecode dem Motorola 6502 ISA nachempfunden. Wie Steve McCann in seinem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plenarvortrag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf dem Sharkfest '11 erinnerte, war er seit der High School, als er in Apple II programmierte, mit dem 6502-Build vertraut, und dieses Wissen beeinflusste seine Arbeit beim Entwerfen von BPF-Bytecode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Unterstützung für BPF ist im Linux-Kernel ab Version 2.5 implementiert, was hauptsächlich durch die Bemühungen von Jay Schullist ergänzt wurde. Der BPF-Code blieb bis 2011 unverändert, als Eric Dumazett den BPF-Interpreter so überarbeitete, dass er im JIT-Modus arbeitet (Quelle: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT für Paketfilter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Danach könnte der Kernel anstelle der Interpretation des BPF-Bytecodes die BPF-Programme direkt in die Zielarchitektur konvertieren: x86, ARM, MIPS usw.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Später, im Jahr 2014, schlug Alexey Starovoitov einen neuen JIT-Mechanismus für BPF vor. </font><font style="vertical-align: inherit;">Tatsächlich ist diese neue JIT zur neuen BPF-basierten Architektur geworden und heißt eBPF. </font><font style="vertical-align: inherit;">Ich denke, dass beide virtuellen Maschinen für einige Zeit nebeneinander existierten, aber derzeit ist die Paketfilterung basierend auf eBPF implementiert. </font><font style="vertical-align: inherit;">In vielen Beispielen moderner Dokumentation wird unter BPF eBPF verstanden, und klassisches BPF wird heute als cBPF bezeichnet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF erweitert die klassische virtuelle BPF-Maschine auf verschiedene Weise:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basierend auf modernen 64-Bit-Architekturen. </font><font style="vertical-align: inherit;">eBPF verwendet 64-Bit-Register und erhöht die Anzahl der verfügbaren Register von 2 (Batterie und X) auf 10. eBPF bietet auch zusätzliche Betriebscodes (BPF_MOV, BPF_JNE, BPF_CALL ...).</font></font></li>
<li>    . BPF      .      ,     ,   . ,   eBPF            . ,   eBPF    tracepoint   kprobe.      eBPF,            .   eBPF    : kernel/bpf.</li>
<li>     .  –    «-»,         .  eBPF    .</li>
<li> .  ,   ,      .            .  ,   eBPF    .</li>
<li> .    eBPF  4096 .      eBPF    eBPF-       (     32 ).</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF: Ein Beispiel</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In den Linux-Kernelquellen gibt es mehrere Beispiele für eBPF. </font><font style="vertical-align: inherit;">Sie sind unter samples / bpf / verfügbar. </font><font style="vertical-align: inherit;">Um diese Beispiele zu kompilieren, geben Sie einfach </font></font><br>
<br>
<code>$ sudo make samples/bpf/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Folgendes </font><font style="vertical-align: inherit;">ein: </font><font style="vertical-align: inherit;">Ich werde selbst kein neues Beispiel für eBPF schreiben, sondern eines der in samples / bpf / verfügbaren Beispiele verwenden. </font><font style="vertical-align: inherit;">Ich werde mir einige Abschnitte des Codes ansehen und erklären, wie es funktioniert. </font><font style="vertical-align: inherit;">Als Beispiel habe ich ein Programm gewählt </font></font><code>tracex4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen besteht jedes der Beispiele in samples / bpf / aus zwei Dateien. </font><font style="vertical-align: inherit;">In diesem Fall:</font></font><br>
<br>
<ul>
<li><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, enthält den Quellcode, der im Kernel als eBPF-Bytecode ausgeführt werden muss.</font></font></li>
<li><code>tracex4_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, enthält ein Programm aus dem User Space.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall müssen wir den </font></font><code> tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF in Bytecode </font><font style="vertical-align: inherit;">kompilieren </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Derzeit gibt es </font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keinen Serverteil für eBPF. </font><font style="vertical-align: inherit;">Glücklicherweise kann es </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF-Bytecode ausgeben. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Makefile</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zum Kompilieren </font></font><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Objektdatei verwendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe oben erwähnt, dass eine der interessantesten Funktionen von eBPFs Karten sind. </font><font style="vertical-align: inherit;">tracex4_kern definiert eine Map:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> {</span><font></font>
    u64 val;<font></font>
    u64 ip;<font></font>
};  <font></font>
<font></font>
<span class="hljs-function">struct bpf_map_def <span class="hljs-title">SEC</span><span class="hljs-params">(<span class="hljs-string">"maps"</span>)</span> my_map </span>= {<font></font>
    .type = BPF_MAP_TYPE_HASH,<font></font>
    .key_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>),<font></font>
    .value_size = <span class="hljs-keyword">sizeof</span>(struct pair),<font></font>
    .max_entries = <span class="hljs-number">1000000</span>,<font></font>
};</code></pre><br>
<code>BPF_MAP_TYPE_HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Eine der vielen Arten von Karten, die von eBPF angeboten werden. </font><font style="vertical-align: inherit;">In diesem Fall ist es nur ein Hash. </font><font style="vertical-align: inherit;">Möglicherweise haben Sie auch eine Anzeige bemerkt </font></font><code>SEC("maps")</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">SEC ist ein Makro, mit dem ein neuer Abschnitt einer Binärdatei erstellt wird. </font><font style="vertical-align: inherit;">Tatsächlich </font></font><code>tracex4_kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definiert </font><font style="vertical-align: inherit;">das Beispiel </font><font style="vertical-align: inherit;">zwei weitere Abschnitte:</font></font><br>
<br>
<pre><code class="cpp hljs">SEC(<span class="hljs-string">"kprobe/kmem_cache_free"</span>)
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog1</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{   
    <span class="hljs-keyword">long</span> ptr = PT_REGS_PARM2(ctx);<font></font>
<font></font>
    bpf_map_delete_elem(&amp;my_map, &amp;ptr); <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
    <font></font>
SEC(<span class="hljs-string">"kretprobe/kmem_cache_alloc_node"</span>) 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog2</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{
    <span class="hljs-keyword">long</span> ptr = PT_REGS_RC(ctx);
    <span class="hljs-keyword">long</span> ip = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  ip-   kmem_cache_alloc_node() </span><font></font>
    BPF_KRETPROBE_READ_RET_IP(ip, ctx);<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> <span class="hljs-title">v</span> = {</span><font></font>
        .val = bpf_ktime_get_ns(),<font></font>
        .ip = ip,<font></font>
    };<font></font>
    <font></font>
    bpf_map_update_elem(&amp;my_map, &amp;ptr, &amp;v, BPF_ANY);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesen beiden Funktionen können Sie einen Eintrag von der Karte löschen ( </font></font><code>kprobe/kmem_cache_free</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) und </font><font style="vertical-align: inherit;">der Karte </font><font style="vertical-align: inherit;">einen neuen Datensatz ( </font></font><code>kretprobe/kmem_cache_alloc_node</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">hinzufügen </font><font style="vertical-align: inherit;">. Alle in Großbuchstaben geschriebenen Funktionsnamen entsprechen den in definierten Makros </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bpf_helpers.h</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ich einen Speicherauszug von Abschnitten der Objektdatei ausgebe, sollte ich sehen, dass diese neuen Abschnitte bereits definiert sind: </font><font style="vertical-align: inherit;">
Immer noch </font><font style="vertical-align: inherit;">das Hauptprogramm. Grundsätzlich hört dieses Programm Ereignisse ab </font><font style="vertical-align: inherit;">. Wenn ein solches Ereignis eintritt, wird der entsprechende eBPF-Code ausgeführt. Der Code speichert das IP-Attribut des Objekts in der Karte, und dieses Objekt wird dann zyklisch im Hauptprogramm angezeigt. Beispiel: </font><font style="vertical-align: inherit;">
Wie hängen das User Space-Programm und das eBPF-Programm zusammen? Bei der Initialisierung wird </font><font style="vertical-align: inherit;">eine Objektdatei </font><font style="vertical-align: inherit;">mithilfe einer Funktion geladen </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<code>$ objdump -h tracex4_kern.o<br>
<br>
tracex4_kern.o: file format elf64-little<br>
<br>
Sections:<br>
Idx Name Size VMA LMA File off Algn<br>
 0 .text 00000000 0000000000000000 0000000000000000 00000040 2**2<br>
 CONTENTS, ALLOC, LOAD, READONLY, CODE<br>
 1 kprobe/kmem_cache_free 00000048 0000000000000000 0000000000000000 00000040 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 2 kretprobe/kmem_cache_alloc_node 000000c0 0000000000000000 0000000000000000 00000088 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 3 maps 0000001c 0000000000000000 0000000000000000 00000148 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 4 license 00000004 0000000000000000 0000000000000000 00000164 2**0<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 5 version 00000004 0000000000000000 0000000000000000 00000168 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 6 .eh_frame 00000050 0000000000000000 0000000000000000 00000170 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</code><br>
<br><font style="vertical-align: inherit;"></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tracex4_user.c</a></code><font style="vertical-align: inherit;"></font><code>kmem_cache_alloc_node</code><font style="vertical-align: inherit;"></font><br>
<br>
<code>$ sudo ./tracex4<br>
obj 0xffff8d6430f60a00 is 2sec old was allocated at ip ffffffff9891ad90<br>
obj 0xffff8d6062ca5e00 is 23sec old was allocated at ip ffffffff98090e8f<br>
obj 0xffff8d5f80161780 is 6sec old was allocated at ip ffffffff98090e8f</code><br>
<br><font style="vertical-align: inherit;"></font><code>tracex4_user.c</code><font style="vertical-align: inherit;"></font><code>tracex4_kern.o</code><font style="vertical-align: inherit;"></font><code>load_bpf_file</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ac, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span> = {</span>RLIM_INFINITY, RLIM_INFINITY};
    <span class="hljs-keyword">char</span> filename[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), <span class="hljs-string">"%s_kern.o"</span>, argv[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;r)) {<font></font>
        perror(<span class="hljs-string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (load_bpf_file(filename)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, bpf_log_buf);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; i++) {<font></font>
        print_old_objects(map_fd[<span class="hljs-number">1</span>]);<font></font>
        sleep(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Ausführung werden die </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">load_bpf_file</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in der eBPF-Datei definierten Sonden hinzugefügt </font></font><code>/sys/kernel/debug/tracing/kprobe_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jetzt hören wir uns diese Ereignisse an und unser Programm kann etwas tun, wenn sie eintreten. </font><font style="vertical-align: inherit;">
Alle anderen Programme in sample / bpf / sind ähnlich aufgebaut. </font><font style="vertical-align: inherit;">Sie haben immer zwei Dateien:</font></font><br>
<br>
<code>$ sudo cat /sys/kernel/debug/tracing/kprobe_events<br>
p:kprobes/kmem_cache_free kmem_cache_free<br>
r:kprobes/kmem_cache_alloc_node kmem_cache_alloc_node</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><code>XXX_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: eBPF-Programm.</font></font></li>
<li><code>XXX_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Hauptprogramm.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das eBPF-Programm definiert die Karten und Funktionen, die dem Abschnitt zugeordnet sind. </font><font style="vertical-align: inherit;">Wenn der Kernel ein Ereignis eines bestimmten Typs auslöst (z. B. </font></font><code>tracepoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), werden die gebundenen Funktionen ausgeführt. </font><font style="vertical-align: inherit;">Maps ermöglichen den Datenaustausch zwischen dem Kernelprogramm und dem User Space-Programm. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlussfolgerung In</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
diesem Artikel wurden BPF und eBPF beschrieben. </font><font style="vertical-align: inherit;">Ich weiß, dass es heute viele Informationen und Ressourcen zu eBPF gibt, daher empfehle ich einige weitere Materialien für weitere Studien. Ich </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
empfehle zu lesen:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF: Die universelle virtuelle Maschine im Kernel von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jonathan Corbett. </font><font style="vertical-align: inherit;">Eine Einführung in BPF und wie es sich zu eBPF entwickelte.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">A thorough introduction to eBPF</a>  .    LWN.net.      eBPF           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Notes on BPF &amp; eBPF</a>  .      “The BSD Packet Filter: A New Architecture for User-level Packet Capture”.        .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eBPF, part1: Past, Present and Future</a>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>,   .      eBPF,   .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495438/index.html">R-Sprache für Excel-Benutzer (kostenloser Videokurs)</a></li>
<li><a href="../de495446/index.html">Antigravitation ist nicht das, was Sie dachten</a></li>
<li><a href="../de495448/index.html">Online-Mitaps für die ganze Woche ab hinten, vorne, QS, PM, DevOps und ein bisschen auf Robotern ab dem 3. April</a></li>
<li><a href="../de495450/index.html">Debuggen stark geladener Golang-Anwendungen oder wie wir nach einem Problem in Kubernetes gesucht haben, das nicht vorhanden war</a></li>
<li><a href="../de495452/index.html">So bereiten Sie eine Site für das Lastwachstum vor</a></li>
<li><a href="../de495456/index.html">Überprüfung von 14 neuen Plugins für Figma, die dazu beitragen werden, die Produktivität zu steigern, während wir alle</a></li>
<li><a href="../de495458/index.html">Wie schreibe ich Code, wenn Kinder um dich herumlaufen und fragen: "Wofür wirst du arbeiten?"</a></li>
<li><a href="../de495460/index.html">Auf Uranus explodierte eine 22.000-mal so große Gasblase wie die Erde</a></li>
<li><a href="../de495462/index.html">.NET Core: x86_64 Intrinsics auf virtuellen Maschinen</a></li>
<li><a href="../de495464/index.html">Informationsnachricht 404 - nicht nur ein Fehler, sondern auch ein Feiertag</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>