<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐿️ 👨🏾‍🏭 🎪 OpenVPNからWireGuardに移行してネットワークを1つのL2ネットワークに結合する 🐕 🖍️ 📴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="地理的に離れた3つのアパートでネットワークを組み合わせる経験を共有したいと思います。それぞれのOpenWRTを備えたルーターは、1つの共通ネットワークへのゲートウェイとして使用されます。ネットワークのすべてのノードが同じサブネット上にある場合、サブネットのルーティングを使用するL3とブリッジングを使...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>OpenVPNからWireGuardに移行してネットワークを1つのL2ネットワークに結合する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
地理的に離れた3つのアパートでネットワークを組み合わせる経験を共有したいと思います。それぞれのOpenWRTを備えたルーターは、1つの共通ネットワークへのゲートウェイとして使用されます。</font><font style="vertical-align: inherit;">ネットワークのすべてのノードが同じサブネット上にある場合、サブネットのルーティングを使用するL3とブリッジングを使用するL2の間でネットワークを結合する方法を選択する場合、2番目の方法が推奨されました。 Wake-on-LanおよびDLNA。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1：背景</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPNは当初、このタスクを実装するためのプロトコルとして選択されました。これは、まず、ブリッジに簡単に追加できるタップデバイスを作成でき、次に、OpenVPNがTCPプロトコル操作をサポートするためです。どのアパートメントにも専用IPアドレスがなく、STUNを使用できませんでした。理由は、プロバイダーがネットワークからのUDP経由の着信接続をブロックし、TCPがVPNサーバーのポートをSSHを使用してリースされたVPS。はい、データが2度暗号化されているため、このアプローチは大きな負荷を与えますが、私はVPSをプライベートネットワークに入力したくありませんでした。そのようなデバイスをホームネットワーク上に置くことは非常に望ましくなく、大きなオーバーヘッドでセキュリティの代償を払うことになった。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーの展開が計画されているルーターのポートを転送するために、sshtunnelプログラムが使用されました。その構成の微妙な点については説明しません。これは非常に簡単に実行できます。そのタスクは、TCPポート1194をルーターからVPSに転送することでした。次に、OpenVPNサーバーは、br-lanブリッジに巻き込まれたtap0デバイス上に構成されました。ラップトップから作成したばかりのサーバーへの接続を確認したところ、ポートフォワーディングのアイデアが実を結び、私のラップトップがルーターネットワークのメンバーになったことが明らかになりましたが、実際にはそこにはいませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は小さなままでした：競合しないようにIPアドレスを異なるアパートメントに分散し、ルーターをOpenVPNクライアントとして構成する必要がありました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のルーターのIPアドレスとDHCPサーバーの範囲が選択されました。</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の範囲と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のサーバ用</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の範囲と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アパート第2のルータのための</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の範囲と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アパート番号3におけるルータの</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、次の行を構成に追加して、OpenVPNサーバーのクライアントルーターにこれらのアドレスを割り当てる必要がありました。</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/etc/openvpn/ipp.txtファイルに次の行を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、flat1_idおよびflat2_idは、OpenVPNに接続するための証明書を作成するときに指定されたデバイス名です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、OpenVPNクライアントがルーターで構成され、両方のtap0デバイスがbr-lanブリッジに追加されました。この段階では、3つのネットワークすべてがお互いを認識し、全体として機能しているため、すべてが正常であるように見えました。ただし、これはあまり好ましい内容ではありませんでした。デバイスがルーターからIPアドレスを取得できない場合があり、その結果、次のような結果が生じました。何らかの理由で、一部のアパートメントのルーターはDHCPDISCOVERに応答する時間がなく、デバイスはそのアドレスを受信しませんでした。各ルーターのtap0でこのようなリクエストをフィルター処理する必要があることに気付きましたが、結局のところ、デバイスがブリッジの一部である場合、iptablesはデバイスで動作せず、ebtablesが助けになるはずです。残念ながら、ファームウェアには含まれていなかったため、デバイスごとにイメージを再構築する必要がありました。これを実行し、そのような行を各ルーターの/etc/rc.localに追加すると、問題は解決しました。</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構成は3年間続きました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2：WireGuardの紹介</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、インターネット上で、彼らはWireGuardについてますます話し始め、その構成の単純さ、高い伝送速度、同等のセキュリティを備えた低pingを賞賛しました。彼に関する追加情報を検索したところ、ブリッジメンバーとしての作業またはTCPとの作業のいずれもサポートしていないことが明らかになり、OpenVPNに代わるものはまだないと私に思わせました。だから私はWireGuardを知ることを延期した。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数日前、何らかの方法でITに接続されたリソースを介して、WireGuardがバージョン5.6以降のLinuxカーネルに最終的に含まれるというニュースが発表されました。いつものように、ニュース記事はWireGuardを賞賛しました。私は再び、古き良きOpenVPNを置き換える方法を模索しました。今回は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">この記事</font></a><font style="vertical-align: inherit;">に遭遇し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 GREを使用してL3上にイーサネットトンネルを構築することについて話しました。この記事は私に希望を与えました。 UDPプロトコルをどうするかは不明確なままでした。検索の結果、socatをSSHトンネルと組み合わせてUDPポートを転送する方法についての記事にたどり着きましたが、彼らはこのアプローチがシングル接続モードでのみ機能すること、つまり複数のVPNクライアントの機能は不可能であることを指摘しています。 VPSでVPNサーバーを作成し、クライアント用にGREを構成するというアイデアを得ましたが、GREは暗号化をサポートしていないため、サードパーティによるサーバーへのアクセスの場合、ネットワーク間のすべてのトラフィックが手元にあるという事実につながりますそれは原則的に私には合わなかった。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しになりますが、次のスキームに従ってVPNを介してVPNを使用することにより、過度の暗号化を支持する決定が行われました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1レベルのVPN：</font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">内部アドレスが192.168.30.1の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーです</font></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">内部アドレスが192.168.30.2 </font><i><font style="vertical-align: inherit;">の</font></i><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">クライアントです</font></i><b><font style="vertical-align: inherit;">。MK2</font></b><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">内部アドレスが192.168.30.3 </font><i><font style="vertical-align: inherit;">の</font></i><font style="vertical-align: inherit;"> VPS </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントです</font></font></i><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">。MK3</font></b><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">内部アドレスが192.168.30.3 </font><i><font style="vertical-align: inherit;">の</font></i><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">クライアントです</font></i></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><b><font style="vertical-align: inherit;">第2レベルのVPN：</font></b><b><font style="vertical-align: inherit;">MS</font></b><font style="vertical-align: inherit;">は</font><i><font style="vertical-align: inherit;">サーバーです</font></i><font style="vertical-align: inherit;">外部アドレスが192.168.30.2で内部が192.168.31.1の</font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、アドレスが192.168.30.2の</font><b><font style="vertical-align: inherit;">MS </font></b><i><font style="vertical-align: inherit;">クライアント</font></i><font style="vertical-align: inherit;">で、内部IPが192.168.31.2です</font><b><font style="vertical-align: inherit;">MK3</font></b><font style="vertical-align: inherit;">は</font><b><font style="vertical-align: inherit;">MS </font></b><i><font style="vertical-align: inherit;">クライアントです</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレス192.168.30.2と内部IP 192.168.31.3持って</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -アパート1ルータ・サーバを、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -アパート2内のルータは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -マンション3のルータ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*デバイスの構成は、記事の最後にスポイラーで公開されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ネットワーク192.168.31.0/24のノード間でpingを実行し、GREトンネルの設定に移ります。この前に、ルーターへのアクセスを失わないようにするために、VPSの22個のポートを転送するようにSSHトンネルを設定することは価値があります。たとえば、アパートメント2のルーターは10022番目のVPSポートで利用でき、11122番目のポートではVPSが利用可能になります。ルーターはアパートメント3からのものです。トンネルが落ちた場合に復元するため、同じsshtunnelで転送を構成するのが最適です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トンネルが構成され、転送されたポートを介してSSHに接続できます。</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、OpenVPNを無効にします。</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、アパートメント2のルーターにGREトンネルを構成します。</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成したインターフェースをブリッジに追加します。</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
router-serverでも同様の手順を実行します。</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、作成したインターフェースをブリッジに追加します。</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この瞬間から、pingは新しいネットワークにうまく行き始め、私は満足してコーヒーを飲みます。</font><font style="vertical-align: inherit;">次に、ワイヤーのもう一方の端でネットワークがどのように機能するかを評価するために、SSH経由でアパートメント2のコンピューターの1つに接続しようとしましたが、sshクライアントはパスワードを要求せずにフリーズします。</font><font style="vertical-align: inherit;">Telnetを介してこのコンピューターにポート22に接続しようとすると、接続が確立されていること、SSHサーバーが応答していることを理解できる行が表示されますが、何らかの理由で入力を求められません。</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VNC経由で接続しようとすると、黒い画面が表示されます。このアパートから内部アドレスでルーターに簡単に接続できるので、リモートコンピューターであることを確信しています。しかし、ルーターを介してこのコンピューターのSSHに接続することにしました。接続が成功し、リモートコンピューターが正常に動作しているのに、自分のコンピューターに接続できないことに驚いています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
grelan0デバイスをブリッジから削除し、アパートメント2のルーターでOpenVPNを実行して、ネットワークが期待どおりに機能し、接続が切断されないことを確認します。検索すると、同じ問題について人々が不満を言うフォーラムに出くわし、そこでMTUを上げるようにアドバイスされます。ただし、第1レベルのVPN（wg0）のMTUを増やすことができませんでした。MTUが1420を超えると、自動的に設定され、中断が始まりますが、同時に、wg0の上で動作する第2レベルのVPN wg1がMTU 1600で正しく動作しました。これでインストールは十分です。 GretapデバイスのMTUは1500であるため、このインターフェイスには、Gretapの追加が計画されていたbr-lanブリッジと同じMTU値があります。私が理解しているように、ブリッジはMTUをすべてのデバイスで使用可能な値の小さい方に設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アパート3のルーターでも同様の構成を行いましたが、唯一の違いは、ルーターでサーバーがgrelan1という名前の2番目のgretapインターフェースを追加したことです。これは、br-lanブリッジにも追加されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが機能しています。</font><font style="vertical-align: inherit;">これで、起動時にgretapアセンブリを配置できます。</font><font style="vertical-align: inherit;">これを行うには、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の行をアパートメント2のルーターの/etc/rc.localに配置します。</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをアパートメント3のルーターの/etc/rc.localに追加しました：</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてサーバールーター上で：</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントルーターを再起動した後、何らかの理由でサーバーに接続していません。</font><font style="vertical-align: inherit;">SSHに接続すると（幸いにも、このためにsshtunnelを事前に構成しました）、なんらかの理由でWireGuardがエンドポイントのルートを作成していることがわかりましたが、それは正しくありませんでした。</font><font style="vertical-align: inherit;">したがって、192.168.30.2の場合、ルートテーブルは、pppoe-wanインターフェイスを経由する、つまりインターネット経由のルートを示していますが、ルートテーブルはwg0インターフェイスを経由する必要がありました。</font><font style="vertical-align: inherit;">このルートを削除した後、接続が復元されました。</font><font style="vertical-align: inherit;">WireGuardがこれらのルートを作成しないようにする方法に関する指示がどこにも見つかりませんでした。</font><font style="vertical-align: inherit;">さらに、私も理解していなかった、機能はOpenWRT、またはWireGuard自体です。</font><font style="vertical-align: inherit;">この問題を長期間処理する必要はありませんでした。このルートを削除するために、タイマーによってループされるスクリプトにこのルーターに行を追加しました。</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPNを完全に拒否するまでには至っていません。ラップトップや電話から新しいネットワークに接続する必要がある場合があり、それらにGretapデバイスを設定することは一般的に不可能ですが、それにもかかわらず、アパートメント間のデータ転送速度には利点がありますそして、例えば、VNCの使用は不便を引き起こしません。</font><font style="vertical-align: inherit;">Pingはわずかに減少しましたが、より安定しました：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPNを使用する場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WireGuardを使用する場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPSの前の約61.5 msの高pingの影響がより</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大きくなりますが、速度は大幅に向上しています。</font><font style="vertical-align: inherit;">したがって、サーバールーターのあるアパートでは、インターネット接続速度は30 Mbit /秒、残りのアパートでは5 Mビット/秒です。</font><font style="vertical-align: inherit;">同時に、OpenVPNを使用している間、iperfによると、3.8 Mb /秒を超えるネットワーク間のデータ転送速度を達成できませんでしたが、WireGuardは同じ5 Mb /秒に「ポンプ」しました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPSでのWireGuard構成</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS上のWireGuard構成（/ etc / config / networkに追加）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2のWireGuard構成（/ etc / config / networkに追加）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3上のWireGuard構成（/ etc / config / networkに追加）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第2レベルVPNの説明された構成では、51821ポートをWireGuardクライアントに指定します。クライアントは任意の非特権ポートから接続を確立するため、これは原則的に必要ありませんが、すべてのルーターのwg0インターフェイスですべての着信接続をブロックできるように、ポート51821への着信UDP接続</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。この記事が誰かにとって役立つことを願っています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、新しいデバイスがネットワークに表示されたときに、電話のPUSH通知をWirePusherアプリケーションに送信するスクリプトを共有したいと思います。</font><font style="vertical-align: inherit;">これがスクリプトへのリンク</font><font style="vertical-align: inherit;">です</font><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OpenVPNサーバーとクライアントの設定</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPNサーバー</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPNクライアント</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
easy-rsaを使用して証明書を生成するには</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486844/index.html">Facebook Webhook処理の進化：1秒あたり0から25,000に</a></li>
<li><a href="../ja486850/index.html">新しい指定席-カプセルホテルのよう</a></li>
<li><a href="../ja486858/index.html">本格的なViberbotの作成。パート2-最初の連絡先または「conversion_started」</a></li>
<li><a href="../ja486860/index.html">ATX12VO-新しい方法を食べる</a></li>
<li><a href="../ja486862/index.html">モーションデザインが人とのつながりを助ける5つの理由</a></li>
<li><a href="../ja486866/index.html">同期フエテ：ナノテクノロジーにおける生物学的モーター</a></li>
<li><a href="../ja486868/index.html">スライムアジャイルを行う理由と対象者</a></li>
<li><a href="../ja486870/index.html">小屋から詐欺を取り除く方法</a></li>
<li><a href="../ja486872/index.html">Linux キーボードのセットアップ</a></li>
<li><a href="../ja486874/index.html">コロナウイルス2019-nCoV：低死亡率、高死亡率</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>