<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèø üßõüèø üçö Lemmatize it faster (PyMorphy2, PyMystem3 and some magic) ‚ÜòÔ∏è üëÑ üëêüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I work as a programmer, including machine learning in relation to text analysis. When processing a natural language, preliminary preparation of docume...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lemmatize it faster (PyMorphy2, PyMystem3 and some magic)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503420/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I work as a programmer, including machine learning in relation to text analysis. </font><font style="vertical-align: inherit;">When processing a natural language, preliminary preparation of documents is required, and one of the methods is lemmatization - bringing all words of the text to their normal forms, taking into account the context. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently, we were faced with the problem of large time costs for this process. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a specific task there were more than 100,000 documents, the average length of which was about 1000 characters, and it was necessary to implement processing on a regular local computer, and not on our server for calculations. </font><font style="vertical-align: inherit;">We could not find a solution on the Internet, but we found it ourselves, and I would like to share it - to demonstrate a comparative analysis of the two most popular lemmatization libraries in this article.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wq/t_/f9/wqt_f9iudgj6iemgovbkss1lkq4.png"><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pymorphy2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most popular is PyMorphy2 - it is found in almost every solution that can be found on the network. </font><font style="vertical-align: inherit;">We also used this library, and it showed itself perfectly, until it was required to do a lemmatization for the entire database (as I wrote above, these are more than 100 thousand small documents). </font><font style="vertical-align: inherit;">In order to analyze such a volume of documents, PyMorphy2 would take almost 10 hours, while the processor load all this time would be on average about 30% (Intel Core i7 7740X).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pymystem3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In search of another solution, we analyzed the library from Yandex PyMystem3, but the result was almost twice worse (in time) than PyMorphy2: it would take 16 hours to process 100 thousand documents.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some magic</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seemed strange to us that the load on the processor was almost zero. It was also strange that in order to get the result from one text, even a large one (3-4 thousand characters), PyMystem3 took about 1 second. Therefore, we decided to combine the texts by adding some kind of separator between them, by which we could again return the structure of our list of documents and give them for lemmatization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python solution code:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkExecTimeMystemOneText</span>(<span class="hljs-params">texts</span>):</span>
    lol = <span class="hljs-keyword">lambda</span> lst, sz: [lst[i:i+sz] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(lst), sz)]<font></font>
    txtpart = lol(texts, <span class="hljs-number">1000</span>)<font></font>
    res = []<font></font>
    <span class="hljs-keyword">for</span> txtp <span class="hljs-keyword">in</span> txtpart:<font></font>
        alltexts = <span class="hljs-string">' '</span>.join([txt + <span class="hljs-string">' br '</span> <span class="hljs-keyword">for</span> txt <span class="hljs-keyword">in</span> txtp])<font></font>
<font></font>
        words = mystem.lemmatize(alltexts)<font></font>
        doc = []<font></font>
        <span class="hljs-keyword">for</span> txt <span class="hljs-keyword">in</span> words:
            <span class="hljs-keyword">if</span> txt != <span class="hljs-string">'\n'</span> <span class="hljs-keyword">and</span> txt.strip() != <span class="hljs-string">''</span>:
                <span class="hljs-keyword">if</span> txt == <span class="hljs-string">'br'</span>:<font></font>
                    res.append(doc)<font></font>
                    doc = []<font></font>
                <span class="hljs-keyword">else</span>:<font></font>
                    doc.append(txt)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We took 1000 documents each for the union, the separator between them was ‚Äúbr‚Äù (it should be noted that the texts in Russian, and the Latin alphabet and special characters, we previously removed). </font><font style="vertical-align: inherit;">This solution significantly accelerated lemmatization: on average, it turned out about 25 minutes for all 100 thousand documents, the processor load was 20-40%. </font><font style="vertical-align: inherit;">True, this solution loads RAM more: on average, it is about 3-7GB, but this is a good result. </font><font style="vertical-align: inherit;">If there is not enough memory, then you can change the number of documents to be combined, although this will slow down processing, it will still be much faster than one text at a time. </font><font style="vertical-align: inherit;">Also, if the amount of memory allows, then you can increase this value and get the result even faster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The table shows a comparison of libraries during processing on a local computer (Intel Core i7 7740X, 32 GB of RAM):</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Time</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM (Mb)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Percent</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pymorphy2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ 9.5 hour</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">500 - 600</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25 - 30%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyMystem3 by 1 sentence</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ 16 hour</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">500 - 700</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 - 1%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyMystem3 with 1000 offers</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26 minutes</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2000 - 7000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25 - 40%</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is interesting to know the opinions of other specialists. </font><font style="vertical-align: inherit;">Perhaps someone found a more time-efficient way of lemmatizing short texts? </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Kabakov, Senior Software Engineer, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anna Mikhailova, Head of Data </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mining, Codex Consortium</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503406/index.html">Semantics and activity</a></li>
<li><a href="../en503408/index.html">Blazor Client Side Online Store: Part 7 - Updated to release version 3.2.0 and added image display</a></li>
<li><a href="../en503410/index.html">Polygons Another World: Sega Genesis</a></li>
<li><a href="../en503412/index.html">Project Loom: Java virtual threads are close</a></li>
<li><a href="../en503414/index.html">Hack The Box. Walkthrough Rope. PWN. Format strings and ROP using pwntools</a></li>
<li><a href="../en503426/index.html">44.2 Tb / s over fiber - how does it work?</a></li>
<li><a href="../en503428/index.html">How to Improve Written English for Communication Abroad: Linguix Business Project</a></li>
<li><a href="../en503430/index.html">MS Remote Desktop Gateway, HAProxy and password guessing</a></li>
<li><a href="../en503432/index.html">Cross-platform multi-threaded TCP / IP server in C ++</a></li>
<li><a href="../en503446/index.html">Where can you open a bank account for a non-resident company from the high-risk category in 2020?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>