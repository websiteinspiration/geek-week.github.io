<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéüÔ∏è ‚ú°Ô∏è üïù Unity Background Image Blur üí• üìº üï¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the tasks that a Unity application developer may encounter is to put the current image in the background in order to switch the user's attentio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unity Background Image Blur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493452/"><img src="https://habrastorage.org/webt/jb/sq/go/jbsqgovdy74rajkik0r_o24tre8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the tasks that a Unity application developer may encounter is to put the current image in the background in order to switch the user's attention to something new, such as a menu or message that appears. The article tells about the experience of solving this problem by a developer who has basic knowledge in Unity, without using external resources or an additional Unity license. I hope this material will be useful to those who faced a similar problem and did not find effective solutions at different stages of it.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Highlighting important interface elements (and removing unnecessary ones) is one of the main tools for improving user experience. This is especially pronounced when working with mobile applications. This switching of attention can be done in different ways - smoothly running away the buttons beyond the edges of the screen, darkening the background, dynamic behavior, etc. These include blurring the image. This effect, on the one hand, reduces the contrast of background elements, and it becomes harder for the eye to catch on. On the other hand, blurring has a subconscious effect when the image becomes out of focus, and we perceive it differently. This approach is often used in games, and from well-known examples of games on Unity, we can name the moments when choosing the menu of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hearthstone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quests </font><font style="vertical-align: inherit;">or</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duel completion screen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now imagine that we want to do the same or similar in our favorite application. </font><font style="vertical-align: inherit;">Nor are we without a budget and have little experience with Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part One - Shader</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thought that arose was that everything should already be realized. </font><font style="vertical-align: inherit;">Surely using a shader. </font><font style="vertical-align: inherit;">And it certainly should be in the Unity box. </font><font style="vertical-align: inherit;">A quick search and installation attempt showed that there is such a shader in Unity, but as it turns out, it is part of Standard Assets, and it is not available for a free license. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this is blur! </font><font style="vertical-align: inherit;">A basic effect that is mathematically simple and should also be easily implemented and integrated into the project. </font><font style="vertical-align: inherit;">Even if we don‚Äôt know anything about shaders. </font><font style="vertical-align: inherit;">Next, go to the Internet, and the search quickly showed that there are source codes of ready-made shaders for the effect, and even different ones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the first implementation, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this shader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was taken </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To test it, just add the shader as a source file to the project, associate it with the material, bind the material to Image.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part Two - User Interface</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we care about the user of the application, then it is necessary to pay due attention to the user interface. If you just add a blur effect to the background and forget about it, then this is not all consistent with the internal principles of creating a product.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, for further actions, you need to touch what happened, and then think and adjust in such a way as to cause the necessary perception of the user. This point is highly context sensitive. Depending on the contrast of the image, the variety of colors and other factors, various values ‚Äã‚Äãand additional tools can be selected. In our case, at this stage, a good result was obtained with a blur radius of 25 (shader parameter) and an additional Transparent of 70% (outside the shader through a separate Image). However, this is only the final background image. The transition itself, according to the feelings on the phone, was too sharp.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The installed shader in the image is calculated on each frame, and therefore, in order to make smooth switching, it is enough to dynamically change the blur radius parameter and transparency. </font><font style="vertical-align: inherit;">You can organize this in different ways, but in essence, processing is an update in Update handlers depending on the time. </font><font style="vertical-align: inherit;">The transition itself in the final version of the application is 0.2 seconds, but as it turns out, it is important for the perception of the user.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part Three - Productivity</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In recent months, I have heard complaints from several different users (not even programmers) that game programs often use all available computer resources idle and without brakes. For example, this can be expressed in the maximum use of the video card in the case of a program minimized to tray, or regardless of everything and the constant loading of one processor thread. The reasons for this are intuitive - the income of the developer or publisher does not depend on optimization (people do not pay attention to such things when buying), and ordinary developers are most likely more concerned about local KPIs and the need for delay. However, in practice, I would not want to fall into this category.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After completing the previous stage, at the next launch with a background blur effect, after holding the phone in your hand for some time, a feeling of warming appeared. If you spend more time on the menu, then everything becomes much worse. And even if the user in the menu presumably and most likely does not spend much time, then I would not want to drop the battery at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analysis showed that the shader chosen above has asymptotic complexity </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> depending on the selected radius. In other words, the number of calculations per point becomes 625 times larger if you increase the blur radius from 1 to 25. In this case, the calculations occur on each frame.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step in the solution was the idea that not all shaders are equally useful, and the blur effect can be implemented in different ways. To do this, you can take a separate blur, the essence of which is to blur first only the lines horizontally, and then only the lines vertically. As a result, we obtain </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O (r)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and ceteris paribus the complexity drops by an order of magnitude. An additional way would be to take a smaller mipmap, which already takes on some of the blur work. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">This shader</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
was taken as the basis</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">However, its blurring effect turned out to be insufficient, and with high contrast of the graphic the image became ‚Äúchipped‚Äù. </font><font style="vertical-align: inherit;">To obtain better effects, the distribution has been changed (GRABPIXEL elements). </font><font style="vertical-align: inherit;">If in the shader, from 0.18 to 0.05, radius 4, in our version, from 0.14 to 0.03, radius 6 (ess, but the sum of all should be 1). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the processing complexity was reduced by 1-2 orders of magnitude. </font><font style="vertical-align: inherit;">But this is not necessary to stop.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part Four - Static Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, if we leave the shader on the existing image, then it is constantly in work, doing the same calculations on each frame. </font><font style="vertical-align: inherit;">If something happens on the background, then we need to do it. </font><font style="vertical-align: inherit;">But this is completely optional if the background is static. </font><font style="vertical-align: inherit;">Thus, after dynamic blur, you can remember the result, put it on the background and turn off the shader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, let's try with code snippets. </font><font style="vertical-align: inherit;">Preparing the destination texture for the entire screen may look like this:</font></font><br>
<br>
<pre><code class="cs hljs">_width = Screen.width / <span class="hljs-number">2</span>;<font></font>
_height = Screen.height / <span class="hljs-number">2</span>;<font></font>
_texture = <span class="hljs-keyword">new</span> Texture2D(_width, _height);<font></font>
<font></font>
<span class="hljs-keyword">var</span> fillColor = Color.white;
<span class="hljs-keyword">var</span> fillColorArray = _texture.GetPixels();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; fillColorArray.Length; ++i)<font></font>
{<font></font>
	fillColorArray[i] = fillColor;<font></font>
}<font></font>
_texture.SetPixels(fillColorArray);<font></font>
_texture.Apply();<font></font>
<font></font>
_from.GetComponent&lt;Image&gt;().sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, a texture is prepared here that is 2 times smaller horizontally and vertically from the screen. </font><font style="vertical-align: inherit;">This can be done almost always, since we know that the screen sizes of devices are a multiple of 2, and if done, this will reduce the size of the texture and facilitate blurring.</font></font><br>
<br>
<pre><code class="cs hljs">RenderTexture temp = RenderTexture.GetTemporary(_width, _height);<font></font>
Graphics.Blit(_from_image.mainTexture, temp, _material);<font></font>
RenderTexture.active = temp;<font></font>
<font></font>
_texture.ReadPixels(<span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, temp.width, temp.height), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<font></font>
_texture.Apply();<font></font>
<font></font>
_to_image.sprite = Sprite.Create(_texture, <span class="hljs-keyword">new</span> Rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, _texture.width, _texture.height), <span class="hljs-keyword">new</span> Vector2(<span class="hljs-number">0.5f</span>, <span class="hljs-number">0.5f</span>));<font></font>
RenderTexture.ReleaseTemporary(temp);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To capture an image with mainTexture using a shader (on _material) Graphics.Blit is used. Next, we memorize the result in the prepared texture and place it in the target Image. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything would be fine; in practice, he was faced with such an effect that, depending on the device, the background image turns upside down. The reason after some study of the issue and debugging becomes clear - the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">difference in coordinate systems</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct3D and OpenGL, which Unity cannot hide. At the same time, our shader detects UV and correctly processes it, and the inversion occurs already in the Unity environment (ReadPixels). There are a lot of tips on the net, such as ‚Äúif you have turned upside down, turn it over yourself‚Äù, or ‚Äúchange the UV sign‚Äù. Using the UNITY_UV_STARTS_AT_TOP macro did not help to get a good generalization for all devices under test. In addition, for example, we encountered such a case that if you prepare the assembly for emulation in Xcode on the iPhone, and Unity did not use Metal, but only OpenGLES, then you need to intercept such cases as emulation of a device running on other software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After trying a number of options, I settled on two tablets. The first one is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forcing camera rendering</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(setting forceIntoRenderTexture at the time of image capture). </font><font style="vertical-align: inherit;">The second one is the determination of the type of the graphic system on the fly through SystemInfo.graphicsDeviceType, which makes it possible to define OpenGL-like or Direct3D-like (the first group is OpenGLES2, OpenGLES3, OpenGLCore and Vulkan). </font><font style="vertical-align: inherit;">Further, in our implementation for Direct3D-like, we need to turn over, which is done procedurally (for example, like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope this article will be useful to someone in overcoming an unknown rake, improving users' lives and understanding Unity. </font><font style="vertical-align: inherit;">If you look at the effect in combat use, then in Unity it looks like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In the application, the sensations are somewhat different, but this animation can give a sufficient idea.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493442/index.html">PPE Reminder</a></li>
<li><a href="../en493444/index.html">The project "Glass". Energy Efficiency Disposable Tea / Coffee Cups</a></li>
<li><a href="../en493446/index.html">Weekend Reading: 10 Unusual Sound Stories - From Spy Games and Conspiracy Theories to Relaxing ASMR</a></li>
<li><a href="../en493448/index.html">Spring - efficient routing</a></li>
<li><a href="../en493450/index.html">How a novice investor can legally reduce taxes: 4 working methods</a></li>
<li><a href="../en493458/index.html">Free your Android - Alaverdi</a></li>
<li><a href="../en493462/index.html">Ultrasonic bath. Part 2</a></li>
<li><a href="../en493468/index.html">Do not be afraid to breathe deeply</a></li>
<li><a href="../en493470/index.html">Scientists Find New Minor Planets Outside Neptune</a></li>
<li><a href="../en493478/index.html">Hack The Box - Walkthrough Forest. AS-REP Roasting, DCSync and Pass-The-Hash Attacks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>