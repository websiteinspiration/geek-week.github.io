<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äç‚öñÔ∏è üîù ü§∞üèæ Programmeurs plombiers, ou l'histoire d'une fuite et les difficult√©s √† y faire face üêê üë®üèæ‚Äçüíª üóíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C'√©tait le mardi 25 f√©vrier. La sortie difficile de la version le samedi 22 f√©vrier √©tait d√©j√† dans le pass√©. Il semblait que tout le pire √©tait derri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programmeurs plombiers, ou l'histoire d'une fuite et les difficult√©s √† y faire face</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'√©tait le mardi 25 f√©vrier. La sortie difficile de la version le samedi 22 f√©vrier √©tait d√©j√† dans le pass√©. Il semblait que tout le pire √©tait derri√®re, et rien n'annon√ßait de probl√®me. Mais tout a chang√© √† un moment donn√© lorsqu'une erreur de surveillance a provoqu√© une fuite de m√©moire sur le processus de coordination du service de contr√¥le d'acc√®s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'o√π? Les derniers changements majeurs dans la base de code du coordinateur √©taient dans la version pr√©c√©dente il y a plus de deux mois, et apr√®s cela, rien de remarquable n'est arriv√© √† la m√©moire. Mais, malheureusement, les horaires de surveillance √©taient inflexibles - la m√©moire du coordinateur a manifestement commenc√© √† couler quelque part, une grande flaque d'eau apparaissant sur le plancher de service, ce qui signifie que l'√©quipe de plomberie avait beaucoup de travail √† faire.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'abord, nous faisons une petite digression. </font><font style="vertical-align: inherit;">Entre autres choses, VLSI vous permet de suivre les heures de travail et de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">surveiller l'acc√®s</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par mod√®le de visage, empreinte digitale ou cartes d'acc√®s. </font><font style="vertical-align: inherit;">Dans le m√™me temps, VLSI communique avec les contr√¥leurs de terminaux (serrures, tourniquets, terminaux d'acc√®s, etc.). </font><font style="vertical-align: inherit;">Un service distinct communique avec les appareils. </font><font style="vertical-align: inherit;">Il est passif, interagit avec les dispositifs de contr√¥le d'acc√®s en fonction de leurs propres protocoles impl√©ment√©s via HTTP (S). </font><font style="vertical-align: inherit;">Il est √©crit sur la base de la pile standard des services de notre entreprise: la base de donn√©es PostgreSQL, Python 3 est utilis√© pour la logique m√©tier, √©tendu avec les m√©thodes C / C ++ de notre plateforme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un n≈ìud de service Web typique comprend les processus suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor est le processus racine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un coordinateur est un processus enfant d'un moniteur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processus de travail.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitor est le premier processus de service Web. </font><font style="vertical-align: inherit;">Sa t√¢che consiste √† appeler fork (), √† d√©marrer le processus du coordinateur enfant et √† surveiller son travail. </font><font style="vertical-align: inherit;">Le coordinateur est le principal processus du service Web, c'est lui qui re√ßoit les demandes des appareils externes, envoie les r√©ponses et √©quilibre la charge. </font><font style="vertical-align: inherit;">Le coordinateur envoie la demande aux processus de travail pour ex√©cution, ils l'ex√©cutent, transf√®rent la r√©ponse √† la m√©moire partag√©e et informent le coordinateur que la t√¢che est termin√©e et que vous pouvez r√©cup√©rer le r√©sultat.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui est √† bl√¢mer et que faire?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le coordinateur du service de contr√¥le d'acc√®s se distingue des coordinateurs des autres services de notre entreprise par la pr√©sence d'un serveur web. Les coordinateurs des autres services fonctionnaient sans fuites, le probl√®me a donc d√ª √™tre recherch√© dans notre configuration. Pire encore, sur les bancs d'essai, la nouvelle version existe depuis longtemps et personne n'a remarqu√© de probl√®mes de m√©moire. Ils ont commenc√© √† regarder de plus pr√®s et ont constat√© que la m√©moire ne circule que sur l'un des stands, et m√™me avec un succ√®s variable - ce qui signifie que le probl√®me n'est toujours pas si facilement reproduit.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faire? Comment trouver une raison? Tout d'abord, nous avons pris un vidage de m√©moire et l'avons envoy√© √† des sp√©cialistes de la plate-forme pour analyse. Le r√©sultat - il n'y a rien dans le d√©potoir: aucune raison, aucun indice dans quelle direction regarder plus loin. Nous avons v√©rifi√© les changements dans le code du coordinateur par rapport √† la version pr√©c√©dente - tout d'un coup, nous avons fait de terribles modifications, mais vous n'avez tout simplement pas compris tout de suite? Mais non - seuls quelques commentaires ont √©t√© ajout√©s au code du coordinateur, mais quelques m√©thodes ont √©t√© d√©plac√©es vers de nouveaux fichiers - en g√©n√©ral, rien de criminel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont commenc√© √† se tourner vers nos coll√®gues, les d√©veloppeurs du c≈ìur de notre service. Ils ont ni√© avec confiance la possibilit√© m√™me de participer √† notre malheur, mais ont propos√© d'implanter la surveillance tracemalloc dans le service. Aussit√¥t dit, aussit√¥t fait, lors du prochain hotfix, nous finalisons le service, testons rapidement, avant de lancer la bataille.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et que voyons-nous? Maintenant, notre m√©moire s'√©coule non seulement rapidement, mais tr√®s rapidement - la croissance est devenue exponentielle. Nous attribuons le premier pic aux forces du mal et aux facteurs qui les accompagnent, mais le deuxi√®me pic, plusieurs heures apr√®s le premier, indique clairement qu'il faut trop de temps pour attendre la publication du prochain correctif avec un tel comportement d'urgence du service. Par cons√©quent, nous prenons les r√©sultats de tracemalloc et corrigeons le service, annulant les modifications avec surveillance afin de revenir au moins √† une croissance lin√©aire.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblait que nous avions les r√©sultats de tracemalloc travaillant sur la m√©moire allou√©e en Python, maintenant nous allons les regarder et trouver le coupable de la fuite, mais ce n'√©tait pas l√† - les donn√©es collect√©es n'ont pas les pics de 5,5 Go que nous avons vus sur les graphiques de surveillance. La m√©moire maximale utilis√©e n'est que de 250 Mo, et m√™me traceMalloc en mange 130 Mo. Ceci est en partie explicable - tracemalloc vous permet de voir la dynamique de la m√©moire en Python, mais il ne conna√Æt pas l'allocation de m√©moire dans les packages C et C ++ qui sont impl√©ment√©s par notre plateforme. Il n'a pas √©t√© possible de trouver quelque chose d'int√©ressant dans les donn√©es obtenues, la m√©moire est allou√©e en volumes acceptables √† des objets ordinaires tels que des flux, des cha√Ænes et des dictionnaires - en g√©n√©ral, rien de suspect. Ensuite, nous avons d√©cid√© de supprimer tout ce qui √©tait superflu des donn√©es, ne laissant que la consommation totale de m√©moire et de temps, et de visualiser.Bien que la visualisation n'ait pas aid√© √† r√©pondre aux questions ¬´ce qui se passe¬ª et ¬´pourquoi¬ª, avec son aide, nous avons vu une corr√©lation avec les donn√©es de la surveillance - ce qui signifie que nous avons certainement un probl√®me quelque part et que nous devons le rechercher.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce moment-l√†, notre √©quipe de plombiers √©tait √† court d'id√©es pour savoir o√π chercher une fuite. Heureusement, l'oiseau nous a chant√© qu'un changement majeur de la plate-forme s'est produit - la version Python est pass√©e de 3.4 √† 3.7, et c'est un immense champ de recherche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons d√©cid√© de rechercher les probl√®mes li√©s aux fuites de m√©moire dans Python 3.7 sur Internet, car il est certain que quelqu'un a d√©j√† rencontr√© ce probl√®me. Pourtant, Python 3.7 a √©t√© publi√© il y a longtemps, nous n'y sommes pass√©s qu'avec la mise √† jour actuelle. Heureusement, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©ponse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† notre question a √©t√© trouv√©e rapidement, et il y avait un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probl√®me</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">tirage</font></a><font style="vertical-align: inherit;"> pour r√©soudre le probl√®me, et elle-m√™me √©tait dans les modifications apport√©es par les d√©veloppeurs Python. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-il arriv√©?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis la version 3.7, le comportement de la classe ThreadingMixIn a chang√©, dont nous h√©ritons de notre serveur Web pour traiter chaque demande dans un thread s√©par√©. Dans la classe ThreadingMixIn, ils ont ajout√© l'entr√©e de tous les threads cr√©√©s dans un tableau. En raison de ces modifications, les instances de classe qui g√®rent les connexions de p√©riph√©rique ne sont pas lib√©r√©es apr√®s la fin et le garbage collector en Python ne peut pas effacer la m√©moire des threads √©puis√©s. C'est ce qui a conduit √† la croissance lin√©aire de la m√©moire allou√©e en proportion directe avec le nombre de requ√™tes √† notre serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le voici, le code insidieux du module Python avec un gros trou (le code en Python 3.5 est affich√© √† gauche avant les changements, √† droite - en 3.7, apr√®s):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En d√©couvrant la raison, nous avons facilement √©limin√© la fuite: dans notre classe d'h√©ritiers, nous avons chang√© la valeur du drapeau qui renvoyait l'ancien comportement, et c'est tout - une victoire! </font><font style="vertical-align: inherit;">Les flux sont cr√©√©s comme auparavant, sans √©crire dans la variable de classe, mais nous observons une image agr√©able sur les graphiques de surveillance - la fuite a √©t√© corrig√©e! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est agr√©able d'√©crire √† ce sujet apr√®s une victoire. </font><font style="vertical-align: inherit;">Nous ne sommes probablement pas les premiers √† rencontrer ce probl√®me apr√®s le passage √† Python 3.7, mais probablement pas le dernier. </font><font style="vertical-align: inherit;">Pour nous, nous avons conclu que nous avions besoin de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adoptez une approche plus s√©rieuse pour √©valuer les cons√©quences possibles de changements majeurs, surtout si d'autres d√©cisions appliqu√©es d√©pendent de nous.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cas de changements globaux dans la plate-forme, tels que, par exemple, la modification de la version de Python, v√©rifiez votre code pour d'√©ventuels probl√®mes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©pondez √† tout changement suspect dans les calendriers de surveillance non seulement des services de combat, mais aussi des services de test. </font><font style="vertical-align: inherit;">Malgr√© le garbage collector actuel, il y a aussi des fuites de m√©moire dans Python.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il faut √™tre prudent avec les outils d'analyse de la m√©moire comme tracemalloc, car leur mauvaise utilisation peut aggraver les choses.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous devez √™tre pr√©par√© au fait que la d√©tection des fuites de m√©moire n√©cessitera de la patience, de la pers√©v√©rance et un peu de travail de d√©tective.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, je tiens √† exprimer ma gratitude √† tous ceux qui ont aid√© √† faire face aux travaux de plomberie d'urgence et √† revenir une fois de plus √† son ancienne capacit√© de travail √† notre service!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498136/index.html">Conversation avec Polina Gurtova sur l'avenir et le pr√©sent de Frontend. Les organisateurs de DUMP 2020 posent des questions importantes.</a></li>
<li><a href="../fr498138/index.html">La vie apr√®s les √©tudes de premier cycle: comment j'ai d√©cid√© quoi faire ensuite lorsque l'enseignement sup√©rieur et le travail existent d√©j√†</a></li>
<li><a href="../fr498140/index.html">R√©pliquez cela. Webinaires Apache Ignite et GridGain</a></li>
<li><a href="../fr498144/index.html">Votre premier BERT: un guide illustr√©</a></li>
<li><a href="../fr498146/index.html">Six tendances de s√©curit√© intelligentes √† surveiller</a></li>
<li><a href="../fr498154/index.html">Calendrier des √©v√©nements informatiques gratuits en ligne du 20 au 26 avril</a></li>
<li><a href="../fr498156/index.html">F #, morphologie des images binaires</a></li>
<li><a href="../fr498158/index.html">Remote Marathon Week 1: Lieu de travail</a></li>
<li><a href="../fr498160/index.html">GlusterFS comme stockage externe pour Kubernetes</a></li>
<li><a href="../fr498162/index.html">Nous vous invitons √† un stage informatique chez Alfa Bank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>