<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äç‚öïÔ∏è ü•ï üéÇ Imitating network problems in Linux üíö üìÆ üò´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, my name is Sasha, I lead the testing of the backend in FunCorp. We, like many, have implemented a service-oriented architecture. On th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Imitating network problems in Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/486136/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone, my name is Sasha, I lead the testing of the backend in FunCorp. </font><font style="vertical-align: inherit;">We, like many, have implemented a service-oriented architecture. </font><font style="vertical-align: inherit;">On the one hand, this simplifies the work, because </font><font style="vertical-align: inherit;">it is easier to test each service separately, but on the other, it becomes necessary to test the interaction of services among themselves, which often occurs over the network. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I will talk about two utilities with which you can check the basic scripts that describe the operation of the application in case of network problems.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hr/xq/l3/hrxql3ddt2sb2_2-x9mblcpjnbi.jpeg"><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mimicking network problems</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually the software is tested on test servers with a good Internet channel. In harsh conditions, production may not be so smooth, so sometimes you need to check the program in a poor connection. On Linux, the </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tc</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility will help you simulate such conditions </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tc ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">short for Traffic Control</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) allows you to configure the transmission of network packets in the system. This utility has great features, you can read more about them </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Immediately I will consider only a few of them: we are interested in traffic sheduling, for which we use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qdisc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and since we need to emulate an unstable network, we will use classless qdisc </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netem</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the echo server on the server (I used </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nmap-ncat</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for this </font><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="plaintext hljs">ncat -l 127.0.0.1 12345 -k -c 'xargs -n1 -i echo "Response: {}"'
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to display all timestamps in detail at each step of the client-server interaction, I wrote a simple Python script that sends a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> request </font><font style="vertical-align: inherit;">to our echo server.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client source code</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">#!/bin/python</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
HOST = <span class="hljs-string">'127.0.0.1'</span>
PORT = <span class="hljs-number">12345</span>
BUFFER_SIZE = <span class="hljs-number">1024</span>
MESSAGE = <span class="hljs-string">"Test\n"</span><font></font>
<font></font>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
t1 = time.time()<font></font>
<span class="hljs-keyword">print</span> <span class="hljs-string">"[time before connection: %.5f]"</span> % t1<font></font>
s.connect((HOST, PORT))<font></font>
<span class="hljs-keyword">print</span> <span class="hljs-string">"[time after connection, before sending: %.5f]"</span> % time.time()<font></font>
s.send(MESSAGE)<font></font>
<span class="hljs-keyword">print</span> <span class="hljs-string">"[time after sending, before receiving: %.5f]"</span> % time.time()<font></font>
data = s.recv(BUFFER_SIZE)<font></font>
<span class="hljs-keyword">print</span> <span class="hljs-string">"[time after receiving, before closing: %.5f]"</span> % time.time()<font></font>
s.close()<font></font>
t2 = time.time()<font></font>
<span class="hljs-keyword">print</span> <span class="hljs-string">"[time after closing: %.5f]"</span> % t2
<span class="hljs-keyword">print</span> <span class="hljs-string">"[total duration: %.5f]"</span> % (t2 - t1)<font></font>
<font></font>
<span class="hljs-keyword">print</span> data
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run it and look at the traffic on the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface </font><font style="vertical-align: inherit;">and port 12345:</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# python client.py<font></font>
[time before connection: 1578652979.44837]<font></font>
[time after connection, before sending: 1578652979.44889]<font></font>
[time after sending, before receiving: 1578652979.44894]<font></font>
[time after receiving, before closing: 1578652979.45922]<font></font>
[time after closing: 1578652979.45928]<font></font>
[total duration: 0.01091]<font></font>
Response: Test<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
10:42:59.448601 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [S], seq 3383332866, win 43690, options [mss 65495,sackOK,TS val 606325685 ecr 0,nop,wscale 7], length 0<font></font>
10:42:59.448612 IP 127.0.0.1.12345 &gt; 127.0.0.1.54054: Flags [S.], seq 2584700178, ack 3383332867, win 43690, options [mss 65495,sackOK,TS val 606325685 ecr 606325685,nop,wscale 7], length 0<font></font>
10:42:59.448622 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 606325685 ecr 606325685], length 0<font></font>
10:42:59.448923 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 606325685 ecr 606325685], length 5<font></font>
10:42:59.448930 IP 127.0.0.1.12345 &gt; 127.0.0.1.54054: Flags [.], ack 6, win 342, options [nop,nop,TS val 606325685 ecr 606325685], length 0<font></font>
10:42:59.459118 IP 127.0.0.1.12345 &gt; 127.0.0.1.54054: Flags [P.], seq 1:15, ack 6, win 342, options [nop,nop,TS val 606325696 ecr 606325685], length 14<font></font>
10:42:59.459213 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [.], ack 15, win 342, options [nop,nop,TS val 606325696 ecr 606325696], length 0<font></font>
10:42:59.459268 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [F.], seq 6, ack 15, win 342, options [nop,nop,TS val 606325696 ecr 606325696], length 0<font></font>
10:42:59.460184 IP 127.0.0.1.12345 &gt; 127.0.0.1.54054: Flags [F.], seq 15, ack 7, win 342, options [nop,nop,TS val 606325697 ecr 606325696], length 0<font></font>
10:42:59.460196 IP 127.0.0.1.54054 &gt; 127.0.0.1.12345: Flags [.], ack 16, win 342, options [nop,nop,TS val 606325697 ecr 606325697], length 0<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is standard: a three-way handshake, PSH / ACK and ACK in response twice - this is the exchange of request and response between the client and server, and twice FIN / ACK and ACK - the end of the connection.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet delay</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now set the delay to 500 milliseconds:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc add dev lo root netem delay 500ms
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start the client and see that now the script is executed for 2 seconds:</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# ./client.py<font></font>
[time before connection: 1578662612.71044]<font></font>
[time after connection, before sending: 1578662613.71059]<font></font>
[time after sending, before receiving: 1578662613.71065]<font></font>
[time after receiving, before closing: 1578662614.72011]<font></font>
[time after closing: 1578662614.72019]<font></font>
[total duration: 2.00974]<font></font>
Response: Test<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What about traffic? </font><font style="vertical-align: inherit;">We look:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">13:23:33.210520 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [S], seq 1720950927, win 43690, options [mss 65495,sackOK,TS val 615958947 ecr 0,nop,wscale 7], length 0<font></font>
13:23:33.710554 IP 127.0.0.1.12345 &gt; 127.0.0.1.58694: Flags [S.], seq 1801168125, ack 1720950928, win 43690, options [mss 65495,sackOK,TS val 615959447 ecr 615958947,nop,wscale 7], length 0<font></font>
13:23:34.210590 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 615959947 ecr 615959447], length 0<font></font>
13:23:34.210657 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 615959947 ecr 615959447], length 5<font></font>
13:23:34.710680 IP 127.0.0.1.12345 &gt; 127.0.0.1.58694: Flags [.], ack 6, win 342, options [nop,nop,TS val 615960447 ecr 615959947], length 0<font></font>
13:23:34.719371 IP 127.0.0.1.12345 &gt; 127.0.0.1.58694: Flags [P.], seq 1:15, ack 6, win 342, options [nop,nop,TS val 615960456 ecr 615959947], length 14<font></font>
13:23:35.220106 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [.], ack 15, win 342, options [nop,nop,TS val 615960957 ecr 615960456], length 0<font></font>
13:23:35.220188 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [F.], seq 6, ack 15, win 342, options [nop,nop,TS val 615960957 ecr 615960456], length 0<font></font>
13:23:35.720994 IP 127.0.0.1.12345 &gt; 127.0.0.1.58694: Flags [F.], seq 15, ack 7, win 342, options [nop,nop,TS val 615961457 ecr 615960957], length 0<font></font>
13:23:36.221025 IP 127.0.0.1.58694 &gt; 127.0.0.1.12345: Flags [.], ack 16, win 342, options [nop,nop,TS val 615961957 ecr 615961457], length 0<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see that in the interaction between the client and the server, the expected half-second lag appeared. </font><font style="vertical-align: inherit;">The system behaves much more interesting if there is more lag: the kernel starts resending some TCP packets. </font><font style="vertical-align: inherit;">Change the delay by 1 second and see the traffic (I won‚Äôt show the client‚Äôs output, there are expected 4 seconds in total duration):</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem delay 1s
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">13:29:07.709981 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [S], seq 283338334, win 43690, options [mss 65495,sackOK,TS val 616292946 ecr 0,nop,wscale 7], length 0<font></font>
13:29:08.710018 IP 127.0.0.1.12345 &gt; 127.0.0.1.39306: Flags [S.], seq 3514208179, ack 283338335, win 43690, options [mss 65495,sackOK,TS val 616293946 ecr 616292946,nop,wscale 7], length 0<font></font>
13:29:08.711094 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [S], seq 283338334, win 43690, options [mss 65495,sackOK,TS val 616293948 ecr 0,nop,wscale 7], length 0<font></font>
13:29:09.710048 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 616294946 ecr 616293946], length 0<font></font>
13:29:09.710152 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 616294947 ecr 616293946], length 5<font></font>
13:29:09.711120 IP 127.0.0.1.12345 &gt; 127.0.0.1.39306: Flags [S.], seq 3514208179, ack 283338335, win 43690, options [mss 65495,sackOK,TS val 616294948 ecr 616292946,nop,wscale 7], length 0<font></font>
13:29:10.710173 IP 127.0.0.1.12345 &gt; 127.0.0.1.39306: Flags [.], ack 6, win 342, options [nop,nop,TS val 616295947 ecr 616294947], length 0<font></font>
13:29:10.711140 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 616295948 ecr 616293946], length 0<font></font>
13:29:10.714782 IP 127.0.0.1.12345 &gt; 127.0.0.1.39306: Flags [P.], seq 1:15, ack 6, win 342, options [nop,nop,TS val 616295951 ecr 616294947], length 14<font></font>
13:29:11.714819 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [.], ack 15, win 342, options [nop,nop,TS val 616296951 ecr 616295951], length 0<font></font>
13:29:11.714893 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [F.], seq 6, ack 15, win 342, options [nop,nop,TS val 616296951 ecr 616295951], length 0<font></font>
13:29:12.715562 IP 127.0.0.1.12345 &gt; 127.0.0.1.39306: Flags [F.], seq 15, ack 7, win 342, options [nop,nop,TS val 616297952 ecr 616296951], length 0<font></font>
13:29:13.715596 IP 127.0.0.1.39306 &gt; 127.0.0.1.12345: Flags [.], ack 16, win 342, options [nop,nop,TS val 616298952 ecr 616297952], length 0<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that the client sent the SYN packet twice, and the server sent the SYN / ACK twice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the constant value, for the delay you can set the deviation, distribution function and correlation (with the value for the previous package). </font><font style="vertical-align: inherit;">This is done as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem delay 500ms 400ms 50 distribution normal
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we set the delay in the interval from 100 to 900 milliseconds, the values ‚Äã‚Äãwill be selected in accordance with the normal distribution and there will be a 50 percent correlation with the delay value for the previous packet.</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You might notice that in the first command I used </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and then </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">change</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The meaning of these commands is obvious, so I‚Äôll just add that there is still </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , with which you can remove the configuration.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet loss</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to do packet loss now. </font><font style="vertical-align: inherit;">As can be seen from the documentation, this can be done in three ways: to lose packets randomly with some probability, to use the Markov chain of 2, 3 or 4 states to calculate the packet loss, or to use the Elliot-Gilbert model. </font><font style="vertical-align: inherit;">In the article I will consider the first (simplest and most obvious) method, and about others you can read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's make a loss of 50% of packets with a correlation of 25%:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc add dev lo root netem loss 50% 25%
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tcpdump</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will not be able to show us packet loss, we will only assume that it really works. </font><font style="vertical-align: inherit;">And to verify this, the increased and unstable runtime of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">client.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script will help us </font><font style="vertical-align: inherit;">(it can be executed instantly, or maybe in 20 seconds), as well as the increased number of retransmitted packets:</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# netstat -s | grep retransmited; sleep 10; netstat -s | grep retransmited<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;17147 segments retransmited<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;17185 segments retransmited<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding noise to packages</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to packet loss, you can simulate their damage: noise will appear in the random position of the packet. </font><font style="vertical-align: inherit;">Let's do packet damage with a 50 percent probability and without correlation:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem corrupt 50%
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We launch the client script (there is nothing interesting, but it took 2 seconds), we look at the traffic:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
10:20:54.812434 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [S], seq 2023663770, win 43690, options [mss 65495,sackOK,TS val 1037001049 ecr 0,nop,wscale 7], length 0<font></font>
10:20:54.812449 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [S.], seq 2104268044, ack 2023663771, win 43690, options [mss 65495,sackOK,TS val 1037001049 ecr 1037001049,nop,wscale 7], length 0<font></font>
10:20:54.812458 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 1037001049 ecr 1037001049], length 0<font></font>
10:20:54.812509 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1037001049 ecr 1037001049], length 5<font></font>
10:20:55.013093 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1037001250 ecr 1037001049], length 5<font></font>
10:20:55.013122 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [.], ack 6, win 342, options [nop,nop,TS val 1037001250 ecr 1037001250], length 0<font></font>
10:20:55.014681 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [P.], seq 1:15, ack 6, win 342, options [nop,nop,TS val 1037001251 ecr 1037001250], length 14<font></font>
10:20:55.014745 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [.], ack 15, win 340, options [nop,nop,TS val 1037001251 ecr 1037001251], length 0<font></font>
10:20:55.014823 IP 127.0.0.1.43666 &gt; 127.0.0.5.12345: Flags [F.], seq 2023663776, ack 2104268059, win 342, options [nop,nop,TS val 1037001251 ecr 1037001251], length 0<font></font>
10:20:55.214088 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [P.], seq 1:15, ack 6, win 342, options [nop,unknown-65 0x0a3dcf62eb3d,[bad opt]&gt;<font></font>
10:20:55.416087 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [F.], seq 6, ack 15, win 342, options [nop,nop,TS val 1037001653 ecr 1037001251], length 0<font></font>
10:20:55.416804 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [F.], seq 15, ack 7, win 342, options [nop,nop,TS val 1037001653 ecr 1037001653], length 0<font></font>
10:20:55.416818 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [.], ack 16, win 343, options [nop,nop,TS val 1037001653 ecr 1037001653], length 0<font></font>
10:20:56.147086 IP 127.0.0.1.12345 &gt; 127.0.0.1.43666: Flags [F.], seq 15, ack 7, win 342, options [nop,nop,TS val 1037002384 ecr 1037001653], length 0<font></font>
10:20:56.147101 IP 127.0.0.1.43666 &gt; 127.0.0.1.12345: Flags [.], ack 16, win 342, options [nop,nop,TS val 1037002384 ecr 1037001653], length 0<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that some packets were resent and there is one packet with broken metadata: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">options [nop, unknown-65 0x0a3dcf62eb3d, [bad opt]&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But the main thing is that in the end everything worked correctly - TCP coped with its task.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Packet duplication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What else can you do with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">For example, to simulate a situation opposite to packet loss - duplication of packets. </font><font style="vertical-align: inherit;">This command also takes 2 arguments: probability and correlation.</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem duplicate 50% 25%
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reorder Packages</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can mix packages, and in two ways. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first part, packets are sent immediately, the rest with a specified delay. </font><font style="vertical-align: inherit;">Example from the documentation:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem delay 10ms reorder 25% 50%
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With a probability of 25% (and a correlation of 50%), the packet will go immediately, the rest will go with a delay of 10 milliseconds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second method is when each N-th packet is sent instantly with a given probability (and correlation), and the rest with a given delay. </font><font style="vertical-align: inherit;">Example from the documentation:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem delay 10ms reorder 25% 50% gap 5
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every fifth packet with a probability of 25% will be sent without delay.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bandwidth change</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually they are sent to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TBF</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> everywhere </font><font style="vertical-align: inherit;">, but using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can also change the interface bandwidth:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem rate 56kbit
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will make </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trips </font><font style="vertical-align: inherit;">as painful as surfing the Internet with a dial-up modem. </font><font style="vertical-align: inherit;">In addition to setting the bitrate, you can also emulate the data link layer protocol model: set the overhead for the packet, the cell size and the overhead for the cell. </font><font style="vertical-align: inherit;">For example, in this way you can simulate </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and a bit rate of 56 kbps:</font></font><br>
<br>
<pre><code class="plaintext hljs">tc qdisc change dev lo root netem rate 56kbit 0 48 5
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulate connection timeout</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another important point in the test plan for software acceptance is timeouts. This is important, because in distributed systems, when one of the services is turned off, the others must follow up on the others on time or return an error to the client, while in no case should they just hang, waiting for a response or establishing a connection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several ways to do this: for example, use a mock that does not respond, or connect to a process using a debugger, put a breakpoint in the right place and stop the process (this is probably the most perverted way). But one of the most obvious is to firewall ports or hosts. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help us with this </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For demonstration, we will firewall port 12345 and run our client script. </font><font style="vertical-align: inherit;">You can firewall outgoing packets to this port from the sender or incoming to the receiver. </font><font style="vertical-align: inherit;">In my examples, incoming packets will firewall (use chain INPUT and the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--dport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Such packages can be made DROP, REJECT or REJECT with the TCP flag RST, it is possible with ICMP host unreachable (in fact, the default behavior is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-port-unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and you can also send </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-net-unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-proto- in response unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-net-prohibited</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icmp-host-prohibited</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drop</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there is a rule with DROP, the packets will simply ‚Äúdisappear‚Äù.</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --dport 12345 -j DROP
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start the client and see that it freezes at the stage of connecting to the server. </font><font style="vertical-align: inherit;">We look traffic:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
08:28:20.213506 IP 127.0.0.1.32856 &gt; 127.0.0.1.12345: Flags [S], seq 3019694933, win 43690, options [mss 65495,sackOK,TS val 1203046450 ecr 0,nop,wscale 7], length 0<font></font>
08:28:21.215086 IP 127.0.0.1.32856 &gt; 127.0.0.1.12345: Flags [S], seq 3019694933, win 43690, options [mss 65495,sackOK,TS val 1203047452 ecr 0,nop,wscale 7], length 0<font></font>
08:28:23.219092 IP 127.0.0.1.32856 &gt; 127.0.0.1.12345: Flags [S], seq 3019694933, win 43690, options [mss 65495,sackOK,TS val 1203049456 ecr 0,nop,wscale 7], length 0<font></font>
08:28:27.227087 IP 127.0.0.1.32856 &gt; 127.0.0.1.12345: Flags [S], seq 3019694933, win 43690, options [mss 65495,sackOK,TS val 1203053464 ecr 0,nop,wscale 7], length 0<font></font>
08:28:35.235102 IP 127.0.0.1.32856 &gt; 127.0.0.1.12345: Flags [S], seq 3019694933, win 43690, options [mss 65495,sackOK,TS val 1203061472 ecr 0,nop,wscale 7], length 0<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that the client sends SYN packets with an exponentially increasing timeout. </font><font style="vertical-align: inherit;">So we found a small bug in the client: we need to use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">settimeout ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">to limit the time during which the client will try to connect to the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately delete the rule:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -D INPUT -p tcp --dport 12345 -j DROP</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can delete all the rules at once:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -F
</code></pre><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you use Docker and you need to firewall all traffic going to the container, then you can do this as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I DOCKER-USER -p tcp -d CONTAINER_IP -j DROP
</code></pre></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now add a similar rule, but with REJECT:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --dport 12345 -j REJECT
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client terminates after a second with the error </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Errno 111] Connection refused</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We look at ICMP traffic:</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn icmp<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
08:45:32.871414 IP 127.0.0.1 &gt; 127.0.0.1: ICMP 127.0.0.1 tcp port 12345 unreachable, length 68<font></font>
08:45:33.873097 IP 127.0.0.1 &gt; 127.0.0.1: ICMP 127.0.0.1 tcp port 12345 unreachable, length 68<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that the client received </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">port unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> twice </font><font style="vertical-align: inherit;">and after that ended with an error.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT with tcp-reset</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try adding the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--reject-with tcp-reset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> option </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with tcp-reset
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the client immediately exits with an error, because on the first request it received an RST packet:</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
09:02:52.766175 IP 127.0.0.1.60658 &gt; 127.0.0.1.12345: Flags [S], seq 1889460883, win 43690, options [mss 65495,sackOK,TS val 1205119003 ecr 0,nop,wscale 7], length 0<font></font>
09:02:52.766184 IP 127.0.0.1.12345 &gt; 127.0.0.1.60658: Flags [R.], seq 0, ack 1889460884, win 0, length 0<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT with icmp-host-unreachable</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try another use case for REJECT:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --dport 12345 -j REJECT --reject-with icmp-host-unreachable
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client ends in a second with the error </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Errno 113] No route to host</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in ICMP traffic we see </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICMP host 127.0.0.1 unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also try the rest of the REJECT parameters, and I will focus on these :)</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We simulate request timeout</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another situation is when the client was able to connect to the server, but cannot send a request to it. </font><font style="vertical-align: inherit;">How to filter packets so that filtering does not start immediately? </font><font style="vertical-align: inherit;">If you look at the traffic of any communication between the client and the server, you will notice that when establishing a connection, only the SYN and ACK flags are used, but when exchanging data, the PSH flag will be in the last request packet. </font><font style="vertical-align: inherit;">It is set automatically to avoid buffering. </font><font style="vertical-align: inherit;">You can use this information to create a filter: it will pass all packets except those that contain the PSH flag. </font><font style="vertical-align: inherit;">Thus, the connection will be established, but the client will not be able to send data to the server.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drop</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For DROP, the command will look like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --tcp-flags PSH PSH --dport 12345 -j DROP
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We launch the client and watch the traffic:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
10:02:47.549498 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [S], seq 2166014137, win 43690, options [mss 65495,sackOK,TS val 1208713786 ecr 0,nop,wscale 7], length 0<font></font>
10:02:47.549510 IP 127.0.0.1.12345 &gt; 127.0.0.1.49594: Flags [S.], seq 2341799088, ack 2166014138, win 43690, options [mss 65495,sackOK,TS val 1208713786 ecr 1208713786,nop,wscale 7], length 0<font></font>
10:02:47.549520 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 1208713786 ecr 1208713786], length 0<font></font>
10:02:47.549568 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1208713786 ecr 1208713786], length 5<font></font>
10:02:47.750084 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1208713987 ecr 1208713786], length 5<font></font>
10:02:47.951088 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1208714188 ecr 1208713786], length 5<font></font>
10:02:48.354089 IP 127.0.0.1.49594 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1208714591 ecr 1208713786], length 5<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the connection is established, and the client cannot send data to the server.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the behavior will be the same: the client will not be able to send the request, but it will receive </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ICMP 127.0.0.1 tcp port 12345 unreachable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and increase the time between sending the request exponentially. </font><font style="vertical-align: inherit;">The command looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --tcp-flags PSH PSH --dport 12345 -j REJECT
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT with tcp-reset</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The command is as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A INPUT -p tcp --tcp-flags PSH PSH --dport 12345 -j REJECT --reject-with tcp-reset
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We already know that when using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--reject-with tcp-reset, the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client will receive an RST packet in response, so we can predict the behavior: receiving an RST packet when a connection is established means the socket unexpectedly closed on the other hand, which means that the client should receive </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection reset by peer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We run our script and make sure of this. </font><font style="vertical-align: inherit;">And here the traffic will look:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic dump</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn port 12345<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
10:22:14.186269 IP 127.0.0.1.52536 &gt; 127.0.0.1.12345: Flags [S], seq 2615137531, win 43690, options [mss 65495,sackOK,TS val 1209880423 ecr 0,nop,wscale 7], length 0<font></font>
10:22:14.186284 IP 127.0.0.1.12345 &gt; 127.0.0.1.52536: Flags [S.], seq 3999904809, ack 2615137532, win 43690, options [mss 65495,sackOK,TS val 1209880423 ecr 1209880423,nop,wscale 7], length 0<font></font>
10:22:14.186293 IP 127.0.0.1.52536 &gt; 127.0.0.1.12345: Flags [.], ack 1, win 342, options [nop,nop,TS val 1209880423 ecr 1209880423], length 0<font></font>
10:22:14.186338 IP 127.0.0.1.52536 &gt; 127.0.0.1.12345: Flags [P.], seq 1:6, ack 1, win 342, options [nop,nop,TS val 1209880423 ecr 1209880423], length 5<font></font>
10:22:14.186344 IP 127.0.0.1.12345 &gt; 127.0.0.1.52536: Flags [R], seq 3999904810, win 0, length 0<font></font>
</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REJECT with icmp-host-unreachable</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think it‚Äôs already obvious to everyone how the team will look :) The behavior of the client in this case will be slightly different from the one with the simple REJECT: the client will not increase the timeout between attempts to resend the packet.</font></font><br>
<br>
<pre><code class="plaintext hljs">[user@host ~]# tcpdump -i lo -nn icmp<font></font>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<font></font>
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes<font></font>
10:29:56.149202 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:56.349107 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:56.549117 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:56.750125 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:56.951130 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:57.152107 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
10:29:57.353115 IP 127.0.0.1 &gt; 127.0.0.1: ICMP host 127.0.0.1 unreachable, length 65<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is not necessary to write a mock to test the interaction of the service with a hung client or server, sometimes it is enough to use the standard utilities that are on Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The utilities discussed in the article have even more features than described, so you can come up with some of your options for their use. </font><font style="vertical-align: inherit;">Personally, I always have enough of what I wrote about (in fact, even less). </font><font style="vertical-align: inherit;">If you use these or similar utilities in testing at your company, please write how. </font><font style="vertical-align: inherit;">If not, then I hope your software will become better if you decide to test it in the face of network problems using the proposed methods.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486136/">https://habr.com/ru/post/en486136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486122/index.html">Child ReactJS with 135 lines of code</a></li>
<li><a href="../en486124/index.html">Impala vs Hive vs Spark SQL: Choosing the right SQL engine to work properly in the Cloudera Data Warehouse</a></li>
<li><a href="../en486126/index.html">Microservices with Spring Boot. Part 5. Using the Eureka name server</a></li>
<li><a href="../en486128/index.html">Quality Architect: who is it and when is it needed</a></li>
<li><a href="../en486130/index.html">GSoC 2019: Checking Bipartite Counts and Monad Transformers</a></li>
<li><a href="../en486138/index.html">‚ÄúDo you have personal data?‚Äù And if I find it? ‚Äù Webinar on the localization of personal data in Russia - February 12, 2020</a></li>
<li><a href="../en486142/index.html">When code becomes legacy and how to live with it</a></li>
<li><a href="../en486144/index.html">Why do altcoins die and what can happen to cryptocurrency in the near future?</a></li>
<li><a href="../en486146/index.html">How to rewrite the front end of a loaded project and not lose the main thing</a></li>
<li><a href="../en486150/index.html">Development of IT-sphere in Slovakia. Work benefits for young professionals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>