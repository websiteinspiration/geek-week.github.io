<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•¦ ğŸ˜‰ â« Pascalã§ã®UDRã®è¨˜è¿° ğŸ¤·ğŸ½ ğŸ‘ŒğŸ¿ â˜ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firebirdã¯é•·ã„é–“ã€å¤–éƒ¨é–¢æ•°UDFï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€PSQLè¨€èªã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã¦ãã¾ã—ãŸã€‚UDFã¯ã€ã»ã¨ã‚“ã©ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§è¨˜è¿°ã§ãã¾ã™ã€‚
 

Firebird 3.0ã¯ã€Firebirdã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å°å…¥ã—ã¾ã—ãŸ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pascalã§ã®UDRã®è¨˜è¿°</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455375/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firebirdã¯é•·ã„é–“ã€å¤–éƒ¨é–¢æ•°UDFï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€PSQLè¨€èªã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã¦ãã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">UDFã¯ã€ã»ã¨ã‚“ã©ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§è¨˜è¿°ã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firebird 3.0ã¯ã€Firebirdã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å°å…¥ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®1ã¤ã¯ã€å¤–éƒ¨ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¤–éƒ¨ã‚¨ãƒ³ã‚¸ãƒ³ï¼‰ã§ã™ã€‚</font><font style="vertical-align: inherit;">UDRï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒãƒ³-ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ«ãƒ¼ãƒãƒ³ï¼‰ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¯ã€FirebirdExternalã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ä¸Šã«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€UDRã‚’å®£è¨€ã™ã‚‹æ–¹æ³•ã€ãã®å†…éƒ¨ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€æ©Ÿèƒ½ã€ãŠã‚ˆã³Pascalã§ã®UDRã®è¨˜è¿°ä¾‹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘APIã‚’ä½¿ç”¨ã™ã‚‹ã„ãã¤ã‹ã®å´é¢ã«ã¤ã„ã¦ã‚‚èª¬æ˜ã—ã¾ã™ã€‚</font></font></p><a name="habracut"></a><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ã“ã®è¨˜äº‹ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆFirebird APIã‚’ä½¿ç”¨ã—ã¦UDRã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’æ•™ãˆã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¨˜è¿°ã•ã‚ŒãŸé–¢æ•°ã¨æ‰‹é †ã¯ã€å®Ÿéš›çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</font></font></blockquote><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDRã«ã¯ã€ãƒ¬ã‚¬ã‚·ãƒ¼UDFã‚ˆã‚Šã‚‚æ¬¡ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ã‚«ãƒ©ãƒ¼ã®çµæœã‚’è¿”ã™é–¢æ•°ã ã‘ã§ãªãã€ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ï¼ˆå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã¨é¸æŠå¼ã®ä¸¡æ–¹ï¼‰ã€ãŠã‚ˆã³ãƒˆãƒªã‚¬ãƒ¼ã‚‚ä½œæˆã§ãã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¥åŠ›ãŠã‚ˆã³å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®åˆ¶å¾¡ã®æ”¹å–„ã€‚</font><font style="vertical-align: inherit;">å ´åˆã«ã‚ˆã£ã¦ã¯ï¼ˆè¨˜è¿°å­ã§æ¸¡ã™ï¼‰ã€å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã‚„ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã¾ã£ãŸãåˆ¶å¾¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸãŒã€UDFå†…ã§ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—ã§ãã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">UDRã¯ã€é€šå¸¸ã®PSQLé–¢æ•°ã¨ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®å ´åˆã¨åŒæ§˜ã«ã€å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å®£è¨€ã™ã‚‹ã‚ˆã‚Šçµ±ä¸€ã•ã‚ŒãŸæ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDRã¯ç¾åœ¨ã®æ¥ç¶šã¾ãŸã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Š</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€ã“ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</font><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦</font><font style="vertical-align: inherit;">ã„ãã¤ã‹ã®æ“ä½œ</font><font style="vertical-align: inherit;">ã‚’å®Ÿè¡Œã§ãã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firebirdã‚¨ãƒ©ãƒ¼ç”Ÿæˆã¯ã€ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸã¨ãã«ä½¿ç”¨ã§ãã€ç‰¹åˆ¥ãªå€¤ã‚’è¿”ã™å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤–éƒ¨ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¨é–¢æ•°ï¼ˆUDRï¼‰ã¯PSQLãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã§ãã¾ã™ã€‚</font></font></li>
<li>UDR        (    ),        External Engine . ,        Java     .NET .</li>
</ul><br>
<blockquote><strong></strong><br>
<br>
  UDR  PSQL . ,   <br>
       . <br>
  -      . <br>
    UDR  UDF ,  UDR  <br>
2.5         . <br>
UDR     PSQL .    <br>
  .         <br>
.</blockquote><p>          ,<br>
        UDR (  UDF).</p><br>
<blockquote><strong></strong><br>
<br>
     Delphi 2009  ,     Free Pascal. <br>
      Delphi,    Free Pascal,  <br>
  .</blockquote><br>
<h2 id="firebird-api">Firebird API</h2><br>
<p>   ,               API Firebird.       Firebird API.        ,    Firebird (<code>doc/Using_OO_API.html</code>).</p><br>
<p>     ,   API,      Firebird  Windows,         Linux  tarbar  (   <code>/opt/firebird/include/firebird/Firebird.pas</code>).</p><br>
<h3 id="cloop">CLOOP</h3><br>
<p>CLOOP â€” Cross Language Object Oriented Programming.       Firebird.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/FirebirdSQL/firebird/tree/B3_0_Release/extern/cloop</a>.      ,       <code>include/firebird/FirebirdInterface.idl</code>  API     (<code>IdlFbInterfaces.h</code>  <code>Firebird.pas</code>).</p><br>
<p> Object pascal    :</p><br>
<pre><code class="plaintext hljs">cloop FirebirdInterface.idl pascal Firebird.pas Firebird --uses SysUtils \<font></font>
  --interfaceFile Pascal.interface.pas \<font></font>
  --implementationFile Pascal.implementation.pas \<font></font>
  --exceptionClass FbException --prefix I \<font></font>
  --functionsFile fb_get_master_interface.pas</code></pre><br>
<p> <code>Pascal.interface.pas</code>, <code>Pascal.implementation.pas</code>  <code>fb_get_master_interface.pas</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/FirebirdSQL/firebird/tree/B3_0_Release/src/misc/pascal</a>.</p><br>
<blockquote><strong></strong><br>
<br>
     Firebird API    I,      Object Pascal.</blockquote><br>
<h4 id="konstanty"></h4><br>
<p>   <code>Firebird.pas</code>  <code>isc_*</code> .     C/C++     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/FirebirdSQL/firebird/blob/B3_0_Release/src/include/consts_pub.h</a>.      Pascal  AWK    .  Windows    Gawk for Windows   Windows Subsystem for Linux (  Windows 10).    :</p><br>
<pre><code class="plaintext hljs">awk -f Pascal.Constants.awk consts_pub.h &gt; const.pas</code></pre><br>
<p>        const  <code>Firebird.pas</code>   implementation.  <code>Pascal.Constants.awk</code>,    <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/FirebirdSQL/firebird/tree/B3_0_Release/src/misc/pascal</a>.</p><br>
<h3 id="upravlenie-vremenem-zhizni">  </h3><br>
<p> Firebird     COM,       .</p><br>
<p> Firebird   ,      : IDisposable  IReferenceCounted.       : IPlugin  ,     ,   .    ,      ,     SQL.</p><br>
<p>        . , IMaster,  ,   ,     API,      .    API        ;  IStatus  <br>
.            ,    dispose().</p><br>
<blockquote><strong></strong><br>
<br>
   ,   ,   ,    <br>
 IReferenceCounted,    .<br>
    ,      <br>
     release().</blockquote><br>
<h2 id="obyavlenie-udr"> UDR</h2><br>
<p>UDR           DDL   ,       PSQL ,   .                 EXTERNAL NAME.</p><br>
<p>   ,      ,   .</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">EXTERNAL NAME '&lt;extname&gt;' ENGINE &lt;engine&gt; [AS &lt;extbody&gt;]<font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt;[!&lt;misc info&gt;]'</code></pre><br>
<p>   EXTERNAL NAME  ,       .   ,   UDR,         ,        .       (!).</p><br>
<p>  ENGINE        .  Firebird          (C, C++, Pascal)   UDR.      Java   Java.</p><br>
<p>   AS      â€” ""   (,   ),         . ,    SQL               .</p><br>
<h3 id="vneshnie-funkcii"> </h3><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">{CREATE [OR ALTER] | RECREATE} FUNCTION funcname<font></font>
[(&lt;inparam&gt; [, &lt;inparam&gt; ...])] <font></font>
RETURNS &lt;type&gt; [COLLATE collation] [DETERMINISTIC] &nbsp; <font></font>
EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt;<font></font>
[AS &lt;extbody&gt;] <font></font>
<font></font>
&lt;inparam&gt; ::= &lt;param_decl&gt; [{= |DEFAULT} &lt;value&gt;] <font></font>
<font></font>
&lt;value&gt; ::= {literal | NULL | context_var} <font></font>
<font></font>
&lt;param_decl&gt; ::= paramname &lt;type&gt; [NOT NULL] [COLLATE collation] <font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt; [!&lt;misc info&gt;]' <font></font>
<font></font>
&lt;type&gt; ::= &lt;datatype&gt; | [TYPE OF] domain | TYPE OF COLUMN rel.col<font></font>
<font></font>
&lt;datatype&gt; ::= <font></font>
  {SMALLINT | INT[EGER] | BIGINT} <font></font>
| BOOLEAN <font></font>
| {FLOAT | DOUBLE PRECISION} <font></font>
| {DATE | TIME | TIMESTAMP} <font></font>
| {DECIMAL | NUMERIC} [(precision [, scale])] <font></font>
| {CHAR | CHARACTER | CHARACTER VARYING | VARCHAR} [(size)] [CHARACTER SET charset] <font></font>
| {NCHAR |NATIONAL CHARACTER | NATIONAL CHAR} [VARYING] [(size)] <font></font>
| BLOB [SUB_TYPE {subtype_num | subtype_name}] [SEGMENT SIZE seglen] [CHARACTER SET charset] <font></font>
| BLOB [(seglen [, subtype_num])]</code></pre></div></div><br>
<p>         ALTER FUNCTION.</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">ALTER FUNCTION funcname [(&lt;inparam&gt; [, &lt;inparam&gt; ...])]<font></font>
RETURNS &lt;type&gt; [COLLATE collation] [DETERMINISTIC]<font></font>
EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt;<font></font>
[AS &lt;extbody&gt;]<font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt;[!&lt;misc info&gt;]'</code></pre><br>
<p>       DROP FUNCTION.</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">DROP FUNCTION funcname</code></pre><br>
<div class="scrollable-table"><table>
<caption>   </caption>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>funcname</td>
<td>  .    31 .</td>
</tr>
<tr>
<td>inparam</td>
<td>  . </td>
</tr>
<tr>
<td>module name</td>
<td>  ,    .</td>
</tr>
<tr>
<td>routine name</td>
<td>     .</td>
</tr>
<tr>
<td>misc info</td>
<td>     <br>
  .</td>
</tr>
<tr>
<td>engine</td>
<td>     .    UDR.</td>
</tr>
<tr>
<td>extbody</td>
<td>  .      UDR   . </td>
</tr>
</tbody>
</table></div><br>
<p>          .       PSQL ,     "   SQL".         .</p><br>
<p><strong>   </strong></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> sum_args (<font></font>
    n1 <span class="hljs-built_in">integer</span>,<font></font>
    n2 <span class="hljs-built_in">integer</span>,<font></font>
    n3 <span class="hljs-built_in">integer</span>
) <span class="hljs-keyword">returns</span> <span class="hljs-built_in">integer</span>
    <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'udrcpp_example!sum_args'</span>
    <span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>     udrcpp_example.        sum_args.       UDR.</p><br>
<p><strong>   Java</strong></p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">function</span> regex_replace (<font></font>
  regex <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),
  <span class="hljs-keyword">str</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),<font></font>
  replacement <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>)<font></font>
) <span class="hljs-keyword">returns</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>)
  <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'org.firebirdsql.fbjava.examples.fbjava_example.FbRegex.replace(
      String, String, String)'</span>
  <span class="hljs-keyword">engine</span> <span class="hljs-keyword">java</span>;</code></pre><br>
<p>      replace  <code>org.firebirdsql.fbjava.examples.fbjava_example.FbRegex</code>.       Java.</p><br>
<h3 id="vneshnie-procedury"> </h3><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">{CREATE [OR ALTER] | RECREATE} PROCEDURE procname <font></font>
[(&lt;inparam&gt; [, &lt;inparam&gt; ...])] <font></font>
RETURNS (&lt;outparam&gt; [&lt;outparam&gt; ...]) <font></font>
EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt; <font></font>
[AS &lt;extbody&gt;] <font></font>
<font></font>
&lt;inparam&gt; ::= &lt;param_decl&gt; [{= | DEFAULT} &lt;value&gt;] <font></font>
<font></font>
&lt;outparam&gt; ::= &lt;param_decl&gt; &lt;value&gt; ::= {literal | NULL | context_var}<font></font>
<font></font>
&lt;param_decl&gt; ::= paramname &lt;type&gt; [NOT NULL] [COLLATE collation] <font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt;[!&lt;misc info&gt;]' <font></font>
<font></font>
&lt;type&gt; ::= &lt;datatype&gt; | [TYPE OF] domain | TYPE OF COLUMN rel.col <font></font>
<font></font>
&lt;datatype&gt; ::=<font></font>
    {SMALLINT | INT[EGER] | BIGINT} <font></font>
  | BOOLEAN <font></font>
  | {FLOAT | DOUBLE PRECISION}<font></font>
  | {DATE | TIME | TIMESTAMP} <font></font>
  | {DECIMAL | NUMERIC} [(precision [,scale])] <font></font>
  | {CHAR | CHARACTER | CHARACTER VARYING | VARCHAR} [(size)] [CHARACTER SET charset] <font></font>
  | {NCHAR | NATIONAL CHARACTER | NATIONAL CHAR} [VARYING] [(size)] <font></font>
  | BLOB [SUB_TYPE {subtype_num | subtype_name}] [SEGMENT SIZE seglen] [CHARACTER SET charset] <font></font>
  | BLOB [(seglen [, subtype_num])]</code></pre></div></div><br>
<p>         ALTER PROCEDURE.</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">ALTER PROCEDURE procname [(&lt;inparam&gt; [, &lt;inparam&gt; ...])]<font></font>
RETURNS (&lt;outparam&gt; [, &lt;outparam&gt; ...]) EXTERNAL NAME<font></font>
&lt;extname&gt; ENGINE &lt;engine&gt; [AS &lt;extbody&gt;]</code></pre><br>
<p>       DROP PROCEDURE.</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">DROP PROCEDURE procname</code></pre><br>
<div class="scrollable-table"><table>
<caption>   </caption>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>funcname</td>
<td>  .    31 .</td>
</tr>
<tr>
<td>inparam</td>
<td>  . </td>
</tr>
<tr>
<td>outparam</td>
<td>  . </td>
</tr>
<tr>
<td>module name</td>
<td>  ,    .</td>
</tr>
<tr>
<td>routine name</td>
<td>     .</td>
</tr>
<tr>
<td>misc info</td>
<td>     <br>
  .</td>
</tr>
<tr>
<td>engine</td>
<td>     .    UDR.</td>
</tr>
<tr>
<td>extbody</td>
<td>  .      UDR   . </td>
</tr>
</tbody>
</table></div><br>
<p>         .       PSQL ,     "   SQL".         .</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> gen_rows_pascal (<font></font>
    start_n <span class="hljs-built_in">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
    end_n <span class="hljs-built_in">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>
) <span class="hljs-keyword">returns</span> (
    <span class="hljs-keyword">result</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span><font></font>
)<font></font>
    <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'pascaludr!gen_rows'</span>
    <span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>     pascaludr.        gen_rows.       UDR.</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">procedure</span> write_log (<font></font>
  message <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>)<font></font>
)<font></font>
  <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'pascaludr!write_log'</span>
  <span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>     pascaludr.        write_log.       UDR.</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">procedure</span> employee_pgsql (
  <span class="hljs-comment">-- Firebird 3.0.0 has a bug with external procedures without parameters</span>
  dummy <span class="hljs-built_in">integer</span> = <span class="hljs-number">1</span>
) <span class="hljs-keyword">returns</span> (
  <span class="hljs-keyword">id</span> <span class="hljs-keyword">type</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">column</span> employee.id,
  <span class="hljs-keyword">name</span> <span class="hljs-keyword">type</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">column</span> employee.name<font></font>
)<font></font>
  <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'org.firebirdsql.fbjava.examples.fbjava_example.FbJdbc
    .executeQuery()!jdbc:postgresql:employee|postgres|postgres'</span>
  <span class="hljs-keyword">engine</span> <span class="hljs-keyword">java</span>
  <span class="hljs-keyword">as</span> <span class="hljs-string">'select * from employee'</span>;</code></pre><br>
<p>      executeQuery <br>
<code>org.firebirdsql.fbjava.examples.fbjava_example.FbJdbc</code>.    (!)          JDBC.       Java.    ""    SQL    .</p><br>
<blockquote><strong></strong><br>
<br>
    ,     .    ,   Firebird 3.0        .</blockquote><br>
<h3 id="razmeschenie-vneshnih-procedur-i-funkciy-vnutri-paketov">      </h3><br>
<p>        PSQL .       ,    PSQL   .</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">{CREATE [OR ALTER] | RECREATE} PACKAGE package_name<font></font>
AS<font></font>
BEGIN<font></font>
  [&lt;package_item&gt; ...]<font></font>
END<font></font>
<font></font>
{CREATE | RECREATE} PACKAGE BODY package_name<font></font>
AS<font></font>
BEGIN<font></font>
  [&lt;package_item&gt; ...]<font></font>
  [&lt;package_body_item&gt; ...]<font></font>
END<font></font>
<font></font>
&lt;package_item&gt; ::= &lt;function_decl&gt;; | &lt;procedure_decl&gt;;<font></font>
<font></font>
&lt;function_decl&gt; ::=<font></font>
  FUNCTION func_name [(&lt;in_params&gt;)]<font></font>
  RETURNS &lt;type&gt; [COLLATE collation] [DETERMINISTIC]<font></font>
<font></font>
&lt;procedure_decl&gt; ::=<font></font>
  PROCEDURE proc_name [(&lt;in_params&gt;)]<font></font>
  [RETURNS (&lt;out_params&gt;)]<font></font>
<font></font>
&lt;package_body_item&gt; ::= &lt;function_impl&gt; | &lt;procedure_impl&gt;<font></font>
<font></font>
&lt;function_impl&gt; ::=<font></font>
  FUNCTION func_name [(&lt;in_impl_params&gt;)]<font></font>
  RETURNS &lt;type&gt; [COLLATE collation] [DETERMINISTIC]<font></font>
  &lt;routine body&gt;<font></font>
<font></font>
&lt;procedure_impl&gt; ::= <font></font>
  PROCEDURE proc_name [(&lt;in_impl_params&gt;)]<font></font>
  [RETURNS (&lt;out_params&gt;)]<font></font>
  &lt;routine body&gt;<font></font>
<font></font>
&lt;routine body&gt; ::= &lt;sql routine body&gt; | &lt;external body reference&gt;<font></font>
<font></font>
&lt;sql routine body&gt; ::=<font></font>
AS &nbsp;&nbsp;&nbsp;<font></font>
  [&lt;declarations&gt;]<font></font>
BEGIN<font></font>
  [&lt;PSQL_statements&gt;] &nbsp;&nbsp;&nbsp;<font></font>
END<font></font>
<font></font>
&lt;declarations&gt; ::= &lt;declare_item&gt; [&lt;declare_item&gt; ...]<font></font>
<font></font>
&lt;declare_item&gt; ::=<font></font>
    &lt;declare_var&gt;;<font></font>
  | &lt;declare_cursor&gt;;<font></font>
  | &lt;subroutine declaration&gt;; <font></font>
  | &lt;subroutine implimentation&gt;<font></font>
<font></font>
&lt;subroutine declaration&gt; ::= &lt;subfunc_decl&gt; | &lt;subproc_decl&gt;<font></font>
<font></font>
&lt;subroutine implimentation&gt; ::= &lt;subfunc_impl&gt; | &lt;subproc_impl&gt;<font></font>
<font></font>
&lt;external body reference&gt; ::=<font></font>
  EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt;<font></font>
  [AS &lt;extbody&gt;]<font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt;[!&lt;misc info&gt;]'</code></pre></div></div><br>
<p>         ,  ,  ,   ,   ,       ,    ,        ( EXTERNAL NAME),  ,   "" /.</p><br>
<p>   UDR     ,      ( ) PCRE,       UDR   .      PSQL ,              ,     PSQL   .          ,     ,           . PSQL      .</p><br>
<div class="spoiler"><b class="spoiler_title">RegExp Package</b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SET</span> TERM ^;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">PACKAGE</span> REGEXP
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">PROCEDURE</span> preg_match(<font></font>
      APattern <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>), ASubject <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>))
    <span class="hljs-keyword">RETURNS</span> (Matches <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>));<font></font>
<font></font>
  FUNCTION preg_is_match(<font></font>
      APattern VARCHAR(8192), ASubject VARCHAR(8192))<font></font>
    RETURNS BOOLEAN;<font></font>
<font></font>
  FUNCTION preg_replace(<font></font>
      APattern VARCHAR(8192),<font></font>
      AReplacement VARCHAR(8192),<font></font>
      ASubject VARCHAR(8192))<font></font>
    RETURNS VARCHAR(8192);<font></font>
<font></font>
  PROCEDURE preg_split(<font></font>
      APattern VARCHAR(8192),<font></font>
      ASubject VARCHAR(8192))<font></font>
    RETURNS (Lines VARCHAR(8192));<font></font>
<font></font>
  FUNCTION preg_quote(<font></font>
      AStr VARCHAR(8192),<font></font>
      ADelimiter CHAR(10) DEFAULT NULL)<font></font>
    RETURNS VARCHAR(8192);<font></font>
<span class="hljs-keyword">END</span>^<font></font>
<font></font>
RECREATE <span class="hljs-keyword">PACKAGE</span> <span class="hljs-keyword">BODY</span> REGEXP
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">PROCEDURE</span> preg_match(<font></font>
      APattern <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>),<font></font>
      ASubject <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>))
    <span class="hljs-keyword">RETURNS</span> (Matches <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>))
    <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">NAME</span> <span class="hljs-string">'PCRE!preg_match'</span> <span class="hljs-keyword">ENGINE</span> UDR;<font></font>
<font></font>
  FUNCTION preg_is_match(<font></font>
      APattern VARCHAR(8192),<font></font>
      ASubject VARCHAR(8192))<font></font>
    RETURNS BOOLEAN<font></font>
  AS<font></font>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">EXISTS</span>(
      <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> preg_match(:APattern, :ASubject));
  <span class="hljs-keyword">END</span><font></font>
<font></font>
  <span class="hljs-keyword">FUNCTION</span> preg_replace(<font></font>
      APattern <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>),<font></font>
      AReplacement <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>),<font></font>
      ASubject <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>))
    <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8192</span>)
    <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">NAME</span> <span class="hljs-string">'PCRE!preg_replace'</span> <span class="hljs-keyword">ENGINE</span> UDR;<font></font>
<font></font>
  PROCEDURE preg_split(<font></font>
      APattern VARCHAR(8192),<font></font>
      ASubject VARCHAR(8192))<font></font>
    RETURNS (Lines VARCHAR(8192))<font></font>
    EXTERNAL NAME 'PCRE!preg_split' ENGINE UDR;<font></font>
<font></font>
  FUNCTION preg_quote(<font></font>
      AStr VARCHAR(8192),<font></font>
      ADelimiter CHAR(10))<font></font>
    RETURNS VARCHAR(8192)<font></font>
    EXTERNAL NAME 'PCRE!preg_quote' ENGINE UDR;<font></font>
<span class="hljs-keyword">END</span>^<font></font>
<font></font>
<span class="hljs-keyword">SET</span> TERM ;^</code></pre></div></div><br>
<h3 id="vneshnie-triggery"> </h3><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="plaintext hljs">{CREATE [OR ALTER] | RECREATE} TRIGGER trigname <font></font>
{&lt;relation_trigger_legacy&gt; | &lt;relation_trigger_sql2003&gt; | &lt;database_trigger&gt; | &lt;ddl_trigger&gt; } <font></font>
&lt;external-body&gt;<font></font>
<font></font>
&lt;external-body&gt; ::= <font></font>
  EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt; <font></font>
  [AS &lt;extbody&gt;] <font></font>
<font></font>
&lt;relation_trigger_legacy&gt; ::= <font></font>
  FOR {tablename | viewname} [ACTIVE | INACTIVE] <font></font>
  {BEFORE | AFTER} &lt;mutation_list&gt; [POSITION number]<font></font>
<font></font>
&lt;relation_trigger_sql2003&gt; ::= <font></font>
  [ACTIVE | INACTIVE] <font></font>
  {BEFORE | AFTER} &lt;mutation_list&gt; [POSITION number] <font></font>
  ON {tablename | viewname} <font></font>
<font></font>
&lt;database_trigger&gt; ::= <font></font>
  [ACTIVE | INACTIVE] ON db_event [POSITION number] <font></font>
<font></font>
&lt;ddl_trigger&gt; ::= <font></font>
  [ACTIVE | INACTIVE] <font></font>
  {BEFORE | AFTER} &lt;ddl_events&gt; [POSITION number]<font></font>
<font></font>
&lt;mutation_list&gt; ::= &lt;mutation&gt; [OR &lt;mutation&gt; [OR &lt;mutation&gt;]] <font></font>
<font></font>
&lt;mutation&gt; ::= INSERT | UPDATE | DELETE<font></font>
<font></font>
&lt;db_event&gt; ::= <font></font>
    CONNECT | DISCONNECT <font></font>
  | TRANSACTION START | TRANSACTION COMMIT | TRANSACTION ROLLBACK <font></font>
<font></font>
&lt;ddl_events&gt; ::= ANY DDL STATEMENT | &lt;ddl_event_item&gt; [{OR &lt;ddl_event_item&gt;} ...] <font></font>
<font></font>
&lt;ddl_event_item&gt; ::= <font></font>
    CREATE TABLE | ALTER TABLE | DROP TABLE <font></font>
  | CREATE PROCEDURE | ALTER PROCEDURE | DROP PROCEDURE <font></font>
  | CREATE FUNCTION | ALTER FUNCTION | DROP FUNCTION <font></font>
  | CREATE TRIGGER | ALTER TRIGGER | DROP TRIGGER <font></font>
  | CREATE EXCEPTION | ALTER EXCEPTION | DROP EXCEPTION <font></font>
  | CREATE VIEW | ALTER VIEW | DROP VIEW <font></font>
  | CREATE DOMAIN | ALTER DOMAIN | DROP DOMAIN <font></font>
  | CREATE ROLE | ALTER ROLE | DROP ROLE <font></font>
  | CREATE SEQUENCE | ALTER SEQUENCE | DROP SEQUENCE <font></font>
  | CREATE USER | ALTER USER | DROP USER <font></font>
  | CREATE INDEX | ALTER INDEX | DROP INDEX <font></font>
  | CREATE COLLATION | DROP COLLATION | ALTER CHARACTER SET <font></font>
  | CREATE PACKAGE | ALTER PACKAGE | DROP PACKAGE <font></font>
  | CREATE PACKAGE BODY | DROP PACKAGE BODY <font></font>
  | CREATE MAPPING | ALTER MAPPING | DROP MAPPING</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤–éƒ¨ãƒˆãƒªã‚¬ãƒ¼ã¯ã€ALTER TRIGGERã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦å¤‰æ›´ã§ãã¾ã™ã€‚</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ§‹æ–‡ï¼š</font></font></strong></p><br>
<pre><code class="plaintext hljs">ALTER TRIGGER trigname { <font></font>
  [ACTIVE | INACTIVE] [ {BEFORE | AFTER}<font></font>
  {&lt;mutation_list&gt; | &lt;ddl_events&gt;} | ON db_event ]<font></font>
  [POSITION number] <font></font>
  [&lt;external-body&gt;] <font></font>
<font></font>
&lt;external-body&gt; ::= <font></font>
  EXTERNAL NAME &lt;extname&gt; ENGINE &lt;engine&gt; <font></font>
  [AS &lt;extbody&gt;] <font></font>
<font></font>
&lt;extname&gt; ::= '&lt;module name&gt;!&lt;routine name&gt;[!&lt;misc info&gt;]' <font></font>
<font></font>
&lt;mutation_list&gt; ::= &lt;mutation&gt; [OR &lt;mutation&gt; [OR &lt;mutation&gt;]]<font></font>
<font></font>
&lt;mutation&gt; ::= { INSERT | UPDATE | DELETE }</code></pre></div></div><br>
<p>       DROP TRIGGER.</p><br>
<p><strong>:</strong></p><br>
<pre><code class="plaintext hljs">DROP TRIGGER trigname</code></pre><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>trigname</td>
<td> .    31 .</td>
</tr>
<tr>
<td>relation_trigger_legacy</td>
<td>   ().</td>
</tr>
<tr>
<td>relation_trigger_sql2003</td>
<td>     SQL-2003.</td>
</tr>
<tr>
<td>database_trigger</td>
<td>   .</td>
</tr>
<tr>
<td>ddl_trigger</td>
<td> DDL .</td>
</tr>
<tr>
<td>tablename</td>
<td> .</td>
</tr>
<tr>
<td>viewname</td>
<td> .</td>
</tr>
<tr>
<td>mutation_list</td>
<td>  .</td>
</tr>
<tr>
<td>mutation</td>
<td>   .</td>
</tr>
<tr>
<td>db_event</td>
<td>   .</td>
</tr>
<tr>
<td>ddl_events</td>
<td>   .</td>
</tr>
<tr>
<td>ddl_event_item</td>
<td>    .</td>
</tr>
<tr>
<td>number</td>
<td>  .  0  32767.</td>
</tr>
<tr>
<td>extbody</td>
<td>  .      UDR   .</td>
</tr>
<tr>
<td>module name</td>
<td>  ,    .</td>
</tr>
<tr>
<td>routine name</td>
<td>     .</td>
</tr>
<tr>
<td>misc info</td>
<td>        .</td>
</tr>
<tr>
<td>engine</td>
<td>     .    UDR.</td>
</tr>
</tbody>
</table></div><br>
<p>      .</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> <span class="hljs-string">'c:\temp\slave.fdb'</span>;<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> persons (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
    address <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),<font></font>
    info <span class="hljs-built_in">blob</span> sub_type <span class="hljs-built_in">text</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">commit</span>;<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> <span class="hljs-string">'c:\temp\master.fdb'</span>;<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> persons (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
    address <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),<font></font>
    info <span class="hljs-built_in">blob</span> sub_type <span class="hljs-built_in">text</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> replicate_config (
    <span class="hljs-keyword">name</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">31</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,<font></font>
    data_source <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> replicate_config (<span class="hljs-keyword">name</span>, data_source)
   <span class="hljs-keyword">values</span> (<span class="hljs-string">'ds1'</span>, <span class="hljs-string">'c:\temp\slave.fdb'</span>);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> persons_replicate
    <span class="hljs-keyword">after</span> <span class="hljs-keyword">insert</span> <span class="hljs-keyword">on</span> persons
    <span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'udrcpp_example!replicate!ds1'</span>
    <span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>     udrcpp_example.        replicate.       UDR.</p><br>
<p>        <code>ds1</code>,        <em>replicate_config</em>        .</p><br>
<h2 id="struktura-udr"> UDR</h2><br>
<p>     UDR.     UDR   Pascal.       UDR      <code>examples/udr/</code>   Pascal.</p><br>
<p>     ,   MyUdr.        <code>MyUdr.dpr</code> (     Delphi)   <code>MyUdr.lpr</code> (     Lazarus).           :</p><br>
<pre><code class="delphi hljs"><span class="hljs-keyword">library</span> MyUdr;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
  <span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span>
<span class="hljs-meta">{$IFDEF unix}</span><font></font>
    cthreads,<font></font>
    <span class="hljs-comment">// the c memory manager is on some systems much faster for multi-threading</span><font></font>
    cmem,<font></font>
<span class="hljs-meta">{$ENDIF}</span>
  UdrInit <span class="hljs-keyword">in</span> <span class="hljs-string">'UdrInit.pas'</span>,<font></font>
  SumArgsFunc <span class="hljs-keyword">in</span> <span class="hljs-string">'SumArgsFunc.pas'</span>;<font></font>
<font></font>
<span class="hljs-keyword">exports</span> firebird_udr_plugin;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre><br>
<p>        <code>firebird_udr_plugin</code>,         UDR.        UdrInit.</p><br>
<blockquote><strong></strong><br>
<br>
    UDR  Free Pascal,     .  <code>{$mode objfpc}</code>     Object Pascal.       <code>{$mode delphi}</code>     Delphi.         FPC,    Delphi    <code>{$mode delphi}</code>.<br>
<br>
 <code>{$H+}</code>    .        string, ansistring,    -  PChar, PAnsiChar, PWideChar.<br>
<br>
 ,          Linux   Unix-  .</blockquote><br>
<h3 id="registraciya-procedur-funkciy-ili-triggerov"> ,   </h3><br>
<p>   UdrInit,     :</p><br>
<pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> UdrInit;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
  <span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird;<font></font>
<font></font>
<span class="hljs-comment">//    External Engine  UDR</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  SumArgsFunc;<font></font>
<font></font>
<span class="hljs-keyword">var</span><font></font>
  myUnloadFlag: Boolean;<font></font>
  theirUnloadFlag: BooleanPtr;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TSumArgsFunctionFactory.Create());<font></font>
  <span class="hljs-comment">//   </span>
  <span class="hljs-comment">//AUdrPlugin.registerProcedure(AStatus, 'sum_args_proc',</span>
  <span class="hljs-comment">//  TSumArgsProcedureFactory.Create());</span>
  <span class="hljs-comment">//AUdrPlugin.registerProcedure(AStatus, 'gen_rows', TGenRowsFactory.Create());</span>
  <span class="hljs-comment">//   </span>
  <span class="hljs-comment">//AUdrPlugin.registerTrigger(AStatus, 'test_trigger',</span>
  <span class="hljs-comment">//  TMyTriggerFactory.Create());</span><font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">initialization</span><font></font>
<font></font>
myUnloadFlag := false;<font></font>
<font></font>
<span class="hljs-keyword">finalization</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> ((theirUnloadFlag &lt;&gt; <span class="hljs-keyword">nil</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> myUnloadFlag) <span class="hljs-keyword">then</span><font></font>
  theirUnloadFlag^ := true;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre><br>
<p>  <code>firebird_udr_plugin</code>      ,   .   ,       .       IUdrPlugin:</p><br>
<ul>
<li>registerFunction â€”   ;</li>
<li>registerProcedure â€”   ;</li>
<li>registerTrigger â€”   .</li>
</ul><br>
<p>        ,      (  ).       //  SQL.         (  ).</p><br>
<h3 id="realizaciya-vneshney-funkcii">  </h3><br>
<p>      .      SumArgsFunc.         .</p><br>
<div class="spoiler"><b class="spoiler_title">   SumArgsFunc</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> SumArgsFunc;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird;<font></font>
<font></font>
<span class="hljs-comment">// *********************************************************</span>
<span class="hljs-comment">//    create function sum_args (</span>
<span class="hljs-comment">//      n1 integer,</span>
<span class="hljs-comment">//      n2 integer,</span>
<span class="hljs-comment">//      n3 integer</span>
<span class="hljs-comment">//    ) returns integer</span>
<span class="hljs-comment">//    external name 'myudr!sum_args'</span>
<span class="hljs-comment">//    engine udr;</span>
<span class="hljs-comment">// *********************************************************</span><font></font>
<font></font>
<span class="hljs-keyword">type</span>
  <span class="hljs-comment">//       </span>
  TSumArgsInMsg = <span class="hljs-keyword">record</span><font></font>
    n1: Integer;<font></font>
    n1Null: WordBool;<font></font>
    n2: Integer;<font></font>
    n2Null: WordBool;<font></font>
    n3: Integer;<font></font>
    n3Null: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  PSumArgsInMsg = ^TSumArgsInMsg;<font></font>
<font></font>
  <span class="hljs-comment">//       </span>
  TSumArgsOutMsg = <span class="hljs-keyword">record</span><font></font>
    result: Integer;<font></font>
    resultNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  PSumArgsOutMsg = ^TSumArgsOutMsg;<font></font>
<font></font>
  <span class="hljs-comment">//       TSumArgsFunction</span>
  <span class="hljs-title">TSumArgsFunctionFactory</span> = <span class="hljs-keyword">class</span>(IUdrFunctionFactoryImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{          .
             .

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @param(AInBuilder     )
      @param(AOutBuilder     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      TSumArgsFunction

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @returns(  )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   TSumArgsFunction.</span>
  <span class="hljs-title">TSumArgsFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)
    <span class="hljs-comment">//     </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      execute  
              
       .        ,
        ExternalEngine::getCharSet.

      @param(AStatus  )
      @param(AContext    )
      @param(AName   )
      @param(AName    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{   

      @param(AStatus  )
      @param(AContext    )
      @param(AInMsg    )
      @param(AOutMsg    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AInMsg: Pointer; AOutMsg: Pointer)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-comment">{ TSumArgsFunctionFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span><font></font>
  Result := TSumArgsFunction.Create();<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TSumArgsFunction }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunction</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunction</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xInput: PSumArgsInMsg;<font></font>
  xOutput: PSumArgsOutMsg;<font></font>
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//        </span><font></font>
  xInput := PSumArgsInMsg(AInMsg);<font></font>
  xOutput := PSumArgsOutMsg(AOutMsg);<font></font>
  <span class="hljs-comment">//     NULL    NULL</span>
  xOutput^.resultNull := xInput^.n1Null <span class="hljs-keyword">or</span> xInput^.n2Null <span class="hljs-keyword">or</span> xInput^.n3Null;<font></font>
  xOutput^.result := xInput^.n1 + xInput^.n2 + xInput^.n3;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunction</span>.<span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AName: PAnsiChar; ANameSize: Cardinal)</span>;</span>
<span class="hljs-keyword">begin</span>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre></div></div><br>
<p>      IUdrFunctionFactory.      IUdrFunctionFactoryImpl.       . ,         ,        .       .</p><br>
<p> dispose    ,        .      .</p><br>
<p> setup          .            ,        .      .</p><br>
<p> newItem      .        ,       .   IRoutineMetadata        ,      .                 PSQL.           .          <code>TSumArgsFunction</code>.</p><br>
<p>     IExternalFunction.      <code>IExternalFunctionImpl</code>.</p><br>
<p> dispose     ,        .      .</p><br>
<p>     .</p><br>
<p> getCharSet   ,             .       ,               .</p><br>
<p> execute     .        ,     ,      .</p><br>
<p>            .             ,        ,      BLOB.     BLOB,          .</p><br>
<p>      ,            .         ,      .   ,          ,    ,      NULL ( Null ).          ,             ,       IMessageMetadata.        ,         execute.</p><br>
<p>        . <br>
   Null     Null <br>
   ,         NULL,  <br>
     </p><br>
<h3 id="realizaciya-vneshney-procedury">  </h3><br>
<p>     UDR   .       :         .     , ..           EXECUTE PROCEDURE       .</p><br>
<p>   UdrInit    <code>firebird_udr_plugin</code>      .</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TSumArgsFunctionFactory.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'sum_args_proc'</span>,<font></font>
    TSumArgsProcedureFactory.Create());<font></font>
  <span class="hljs-comment">//AUdrPlugin.registerProcedure(AStatus, 'gen_rows', TGenRowsFactory.Create());</span>
  <span class="hljs-comment">//   </span>
  <span class="hljs-comment">//AUdrPlugin.registerTrigger(AStatus, 'test_trigger',</span>
  <span class="hljs-comment">//  TMyTriggerFactory.Create());</span><font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<blockquote><strong></strong><br>
<br>
     uses  SumArgsProc,       .</blockquote><p>      IUdrProcedureFactory.      IUdrProcedureFactoryImpl.       . ,         ,        .       .</p><br>
<p> dispose    ,        .      .</p><br>
<p> setup          .            ,        .      .</p><br>
<p> newItem      .        ,       .   IRoutineMetadata        ,      .                 PSQL.           .          <code>TSumArgsProcedure</code>.</p><br>
<p>         SumArgsProc.</p><br>
<div class="spoiler"><b class="spoiler_title">   SumArgsProc</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> SumArgsProc;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird;<font></font>
<font></font>
  <span class="hljs-comment">{ **********************************************************

    create procedure sp_sum_args (
      n1 integer,
      n2 integer,
      n3 integer
    ) returns (result integer)
    external name 'myudr!sum_args_proc'
    engine udr;

    ********************************************************* }</span>
<span class="hljs-keyword">type</span>
  <span class="hljs-comment">//       </span>
  TSumArgsInMsg = <span class="hljs-keyword">record</span><font></font>
    n1: Integer;<font></font>
    n1Null: WordBool;<font></font>
    n2: Integer;<font></font>
    n2Null: WordBool;<font></font>
    n3: Integer;<font></font>
    n3Null: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  PSumArgsInMsg = ^TSumArgsInMsg;<font></font>
<font></font>
  <span class="hljs-comment">//       </span>
  TSumArgsOutMsg = <span class="hljs-keyword">record</span><font></font>
    result: Integer;<font></font>
    resultNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  PSumArgsOutMsg = ^TSumArgsOutMsg;<font></font>
<font></font>
  <span class="hljs-comment">//       TSumArgsProcedure</span>
  <span class="hljs-title">TSumArgsProcedureFactory</span> = <span class="hljs-keyword">class</span>(IUdrProcedureFactoryImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{          
             .

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @param(AInBuilder     )
      @param(AOutBuilder     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      TSumArgsProcedure

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @returns(  )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-title">TSumArgsProcedure</span> = <span class="hljs-keyword">class</span>(IExternalProcedureImpl)
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">//     </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      open  
              
       .        ,
        ExternalEngine::getCharSet.

      @param(AStatus  )
      @param(AContext    )
      @param(AName   )
      @param(AName    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{   

      @param(AStatus  )
      @param(AContext    )
      @param(AInMsg    )
      @param(AOutMsg    )
      @returns(     
               nil   )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext; AInMsg: Pointer;
      AOutMsg: Pointer)</span>:</span> IExternalResultSet; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-comment">{ TSumArgsProcedureFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsProcedureFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsProcedureFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure;
<span class="hljs-keyword">begin</span><font></font>
  Result := TSumArgsProcedure.create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsProcedureFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata; AInBuilder,
  AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TSumArgsProcedure }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsProcedure</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsProcedure</span>.<span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AName: PAnsiChar; ANameSize: Cardinal)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsProcedure</span>.<span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>:</span> IExternalResultSet;
<span class="hljs-keyword">var</span><font></font>
  xInput: PSumArgsInMsg;<font></font>
  xOutput: PSumArgsOutMsg;<font></font>
<span class="hljs-keyword">begin</span>
  Result := <span class="hljs-keyword">nil</span>;
  <span class="hljs-comment">//        </span><font></font>
  xInput := PSumArgsInMsg(AInMsg);<font></font>
  xOutput := PSumArgsOutMsg(AOutMsg);<font></font>
  <span class="hljs-comment">//     NULL    NULL</span>
  xOutput^.resultNull := xInput^.n1Null <span class="hljs-keyword">or</span> xInput^.n2Null <span class="hljs-keyword">or</span> xInput^.n3Null;<font></font>
  xOutput^.result := xInput^.n1 + xInput^.n2 + xInput^.n3;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre></div></div><br>
<p>     IExternalProcedure.      <code>IExternalProcedureImpl</code>.</p><br>
<p> dispose     ,        .      .</p><br>
<p> getCharSet                .       ,               .</p><br>
<p> open     .        ,     ,      .     ,      nil,           .          .      TSumArgsFunction.execute.</p><br>
<h3 id="hranimaya-procedura-vybora">  </h3><br>
<p>    UDR    .      <code>firebird_udr_plugin</code>.</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TSumArgsFunctionFactory.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'sum_args_proc'</span>,<font></font>
    TSumArgsProcedureFactory.Create());<font></font>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'gen_rows'</span>, TGenRowsFactory.Create());
  <span class="hljs-comment">//   </span>
  <span class="hljs-comment">//AUdrPlugin.registerTrigger(AStatus, 'test_trigger',</span>
  <span class="hljs-comment">//  TMyTriggerFactory.Create());</span><font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<blockquote><strong></strong><br>
<br>
     uses  GenRowsProc,       .</blockquote><p>          .     ,    open,    .</p><br>
<div class="spoiler"><b class="spoiler_title">   GenRowsProc</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> GenRowsProc;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird, SysUtils;<font></font>
<font></font>
<span class="hljs-keyword">type</span>
  <span class="hljs-comment">{ **********************************************************

    create procedure gen_rows (
      start  integer,
      finish integer
    ) returns (n integer)
    external name 'myudr!gen_rows'
    engine udr;

    ********************************************************* }</span><font></font>
<font></font>
  TInput = <span class="hljs-keyword">record</span><font></font>
    start: Integer;<font></font>
    startNull: WordBool;<font></font>
    finish: Integer;<font></font>
    finishNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  PInput = ^TInput;<font></font>
<font></font>
  TOutput = <span class="hljs-keyword">record</span><font></font>
    n: Integer;<font></font>
    nNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  POutput = ^TOutput;<font></font>
<font></font>
  <span class="hljs-comment">//       TGenRowsProcedure</span>
  <span class="hljs-title">TGenRowsFactory</span> = <span class="hljs-keyword">class</span>(IUdrProcedureFactoryImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{          .
             .

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @param(AInBuilder     )
      @param(AOutBuilder     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      TGenRowsProcedure

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @returns(  )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   TGenRowsProcedure.</span>
  <span class="hljs-title">TGenRowsProcedure</span> = <span class="hljs-keyword">class</span>(IExternalProcedureImpl)
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">//     </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      open  
              
       .        ,
        ExternalEngine::getCharSet.

      @param(AStatus  )
      @param(AContext    )
      @param(AName   )
      @param(AName    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{   

      @param(AStatus  )
      @param(AContext    )
      @param(AInMsg    )
      @param(AOutMsg    )
      @returns(     
               nil   )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext; AInMsg: Pointer;
      AOutMsg: Pointer)</span>:</span> IExternalResultSet; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//      TGenRowsProcedure</span>
  <span class="hljs-title">TGenRowsResultSet</span> = <span class="hljs-keyword">class</span>(IExternalResultSetImpl)<font></font>
    Input: PInput;<font></font>
    Output: POutput;<font></font>
<font></font>
    <span class="hljs-comment">//      </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      .
          SUSPEND.    
           .

      @param(AStatus  )
      @returns(True        ,
               False   )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">(AStatus: IStatus)</span>:</span> Boolean; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-comment">{ TGenRowsFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TGenRowsFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TGenRowsFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure;
<span class="hljs-keyword">begin</span><font></font>
  Result := TGenRowsProcedure.create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TGenRowsFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AMetadata: IRoutineMetadata; AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TGenRowsProcedure }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TGenRowsProcedure</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TGenRowsProcedure</span>.<span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AName: PAnsiChar; ANameSize: Cardinal)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TGenRowsProcedure</span>.<span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>:</span> IExternalResultSet;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//      NULL   </span>
  <span class="hljs-keyword">if</span> PInput(AInMsg).startNull <span class="hljs-keyword">or</span> PInput(AInMsg).finishNull <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span><font></font>
    POutput(AOutMsg).nNull := True;<font></font>
    Result := <span class="hljs-keyword">nil</span>;
    <span class="hljs-keyword">exit</span>;
  <span class="hljs-keyword">end</span>;
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">if</span> PInput(AInMsg).start &gt; PInput(AInMsg).finish <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">raise</span> Exception.Create(<span class="hljs-string">'First parameter greater then second parameter.'</span>);<font></font>
<font></font>
  Result := TGenRowsResultSet.create;<font></font>
  <span class="hljs-keyword">with</span> TGenRowsResultSet(Result) <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span><font></font>
    Input := AInMsg;<font></font>
    Output := AOutMsg;<font></font>
    <span class="hljs-comment">//  </span><font></font>
    Output.nNull := False;<font></font>
    Output.n := Input.start - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TGenRowsResultSet }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TGenRowsResultSet</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">//   True       .</span>
<span class="hljs-comment">//   False      </span>
<span class="hljs-comment">//        </span>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TGenRowsResultSet</span>.<span class="hljs-title">fetch</span><span class="hljs-params">(AStatus: IStatus)</span>:</span> Boolean;
<span class="hljs-keyword">begin</span><font></font>
  Inc(Output.n);<font></font>
  Result := (Output.n &lt;= Input.finish);<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre></div></div><br>
<p>  open   <code>TGenRowsProcedure</code>         NULL,      NULL,      NULL,              SELECT,      nil.</p><br>
<p>   ,       ,     .         UDR     Firebird.      UDR  Legacy UDF. </p><br>
<p>    ,   open     ,    IExternalResultSet.         <code>IExternalResultSetImpl</code>.</p><br>
<p> dispose     .      .</p><br>
<p> fetch       SELECT.        SUSPEND    PSQL  .     ,        .   true,       ,  <code>false</code>,      .             ,      .</p><br>
<blockquote><strong></strong><br>
<br>
 Delphi    yeild,         <br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(...) <span class="hljs-keyword">do</span> {<font></font>
  ...<font></font>
  yield result;<font></font>
}</code></pre><br>
<br>
     ,     open,  ,          fetch.            (   SELECT   FIRST/ROWS/FETCH FIRST   SELECT.)</blockquote><br>
<h3 id="realizaciya-vneshnego-triggera">  </h3><br>
<p>    UDR   .</p><br>
<blockquote><strong>Note</strong><br>
<br>
    C++        .  ,           .          .</blockquote><p>   UdrInit    <code>firebird_udr_plugin</code>      .</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TSumArgsFunctionFactory.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'sum_args_proc'</span>,<font></font>
    TSumArgsProcedureFactory.Create());<font></font>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'gen_rows'</span>, TGenRowsFactory.Create());
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerTrigger(AStatus, <span class="hljs-string">'test_trigger'</span>,<font></font>
    TMyTriggerFactory.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<blockquote><strong></strong><br>
<br>
     uses  TestTrigger,       .</blockquote><p>      IUdrTriggerFactory.      IUdrTriggerFactoryImpl.      <br>
.</p><br>
<p> dispose    ,        .      .</p><br>
<p> setup          .            ,        .      .</p><br>
<p> newItem      .        ,       .   IRoutineMetadata           ,      .                 PSQL.           .          <code>TMyTrigger</code>.</p><br>
<p>         TestTrigger.</p><br>
<div class="spoiler"><b class="spoiler_title">   TestTrigger</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> TestTrigger;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird, SysUtils;<font></font>
<font></font>
<span class="hljs-keyword">type</span>
  <span class="hljs-comment">{ **********************************************************
    create table test (
      id int generated by default as identity,
      a int,
      b int,
      name varchar(100),
      constraint pk_test primary key(id)
    );

    create or alter trigger tr_test_biu for test
    active before insert or update position 0
    external name 'myudr!test_trigger'
    engine udr;
  }</span><font></font>
<font></font>
  <span class="hljs-comment">//     NEW.*  OLD.*</span>
  <span class="hljs-comment">//      test</span>
  TFieldsMessage = <span class="hljs-keyword">record</span><font></font>
    Id: Integer;<font></font>
    IdNull: WordBool;<font></font>
    A: Integer;<font></font>
    ANull: WordBool;<font></font>
    B: Integer;<font></font>
    BNull: WordBool;<font></font>
    <span class="hljs-keyword">Name</span>: <span class="hljs-keyword">record</span><font></font>
      Length: Word;<font></font>
      Value: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">399</span>] <span class="hljs-keyword">of</span> AnsiChar;
    <span class="hljs-keyword">end</span>;<font></font>
    NameNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  PFieldsMessage = ^TFieldsMessage;<font></font>
<font></font>
  <span class="hljs-comment">//       TMyTrigger</span>
  <span class="hljs-title">TMyTriggerFactory</span> = <span class="hljs-keyword">class</span>(IUdrTriggerFactoryImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{          .
            .

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @param(AFieldsBuilder     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AFieldsBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      TMyTrigger

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @returns(  )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-title">TMyTrigger</span> = <span class="hljs-keyword">class</span>(IExternalTriggerImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      execute  
              
       .        ,
        ExternalEngine::getCharSet.

      @param(AStatus  )
      @param(AContext    )
      @param(AName   )
      @param(AName    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;

      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{   TMyTrigger

      @param(AStatus  )
      @param(AContext    )
      @param(AAction  ( ) )
      @param(AOldMsg      :OLD.*)
      @param(ANewMsg      :NEW.*)
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AAction: Cardinal; AOldMsg: Pointer; ANewMsg: Pointer)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-comment">{ TMyTriggerFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyTriggerFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TMyTriggerFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger;
<span class="hljs-keyword">begin</span><font></font>
  Result := TMyTrigger.create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyTriggerFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AMetadata: IRoutineMetadata; AFieldsBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TMyTrigger }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyTrigger</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyTrigger</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AAction: Cardinal; AOldMsg, ANewMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xOld, xNew: PFieldsMessage;<font></font>
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">// xOld := PFieldsMessage(AOldMsg);</span><font></font>
  xNew := PFieldsMessage(ANewMsg);<font></font>
  <span class="hljs-keyword">case</span> AAction <span class="hljs-keyword">of</span><font></font>
    IExternalTrigger.ACTION_INSERT:<font></font>
      <span class="hljs-keyword">begin</span>
        <span class="hljs-keyword">if</span> xNew.BNull <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> xNew.ANull <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">begin</span>
          xNew.B := xNew.A + <span class="hljs-number">1</span>;<font></font>
          xNew.BNull := False;<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    IExternalTrigger.ACTION_UPDATE:<font></font>
      <span class="hljs-keyword">begin</span>
        <span class="hljs-keyword">if</span> xNew.BNull <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> xNew.ANull <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">begin</span>
          xNew.B := xNew.A + <span class="hljs-number">1</span>;<font></font>
          xNew.BNull := False;<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    IExternalTrigger.ACTION_DELETE:<font></font>
      <span class="hljs-keyword">begin</span><font></font>
<font></font>
      <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TMyTrigger</span>.<span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AName: PAnsiChar; ANameSize: Cardinal)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre></div></div><br>
<p>     IExternalTrigger.      <code>IExternalTriggerImpl</code>.</p><br>
<p> dispose     ,        .      .</p><br>
<p> getCharSet                .       ,           .</p><br>
<p> execute            .        ,     ,  ()              .   ()      IExternalTrigger.      <code>ACTION_</code>.     ,   Firebird       .        ,  DDL ,      ,         ,           nil.                 .          ,          ,      .</p><br>
<blockquote><strong></strong><br>
<br>
 ,        ,             .             IMessageMetadata.        ,          .       ,      ,      /.</blockquote><p>       ,       PSQL </p><br>
<pre><code class="sql hljs">  if (:new.B IS NULL) THEN<font></font>
    :new.B = :new.A + 1;</code></pre><br>
<h2 id="soobscheniya"></h2><br>
<p>   UDR             ,    .                NEW  OLD.</p><br>
<p>       ,       ,      .<br>
        :</p><br>
<ul>
<li><p>          ( Delphi  , .. record);</p><br>
</li>
<li><p>        IMessageMetadata,  /   ,      .</p><br>
</li>
</ul><br>
<p>    ,  â€”  ,                        UDR.</p><br>
<h3 id="rabota-s-buferom-soobscheniya-s-ispolzovaniem-struktury">      </h3><br>
<p>            .     :</p><br>
<pre><code class="plaintext hljs">TMyStruct = record<font></font>
  &lt;var_1&gt;: &lt;type_1&gt;;<font></font>
  &lt;nullIndicator_1&gt;: WordBool;<font></font>
  &lt;var_2&gt;: &lt;type_1&gt;;<font></font>
  &lt;nullIndicator_2&gt;: WordBool;<font></font>
  ...<font></font>
  &lt;var_N&gt;: &lt;type_1&gt;;<font></font>
  &lt;nullIndicator_N&gt;: WordBool;<font></font>
end;<font></font>
PMyStruct = ^TMyStruct;</code></pre><br>
<p>      /    ( ). Null-     /,       NOT NULL. Null-  2 .  -1  <br>
/   NULL.      NULL-    NULL,      2-   .   SQL     :</p><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th> SQL  </th>
<th> Delphi  </th>
<th>  </th>
</tr>
<tr>
<td> BOOLEAN </td>
<td> Boolean, ByteBool </td>
<td></td>
</tr>
<tr>
<td> SMALLINT </td>
<td> Smallint </td>
<td></td>
</tr>
<tr>
<td> INTEGER </td>
<td> Integer </td>
<td></td>
</tr>
<tr>
<td> BIGINT </td>
<td> Int64 </td>
<td></td>
</tr>
<tr>
<td> FLOAT </td>
<td> Single </td>
<td></td>
</tr>
<tr>
<td> DOUBLE PRECISION </td>
<td> Double </td>
<td></td>
</tr>
<tr>
<td> NUMERIC(N, M) </td>
<td>       :<br>
<ul>
<li>1-4 â€” Smallint;</li>
<li>5-9 â€” Integer;</li>
<li>10-18 (3 ) â€” Int64;</li>
<li>10-15 (1 ) â€” Double.</li>
</ul><br>
 </td>
<td>          <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>10</mn><mi>M</mi></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.509ex" viewBox="0 -970.7 1844.5 1080.4" role="img" focusable="false" style="vertical-align: -0.255ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-30" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4D" x="1415" y="557"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mi>M</mi></msup></math></span></span><script type="math/tex" id="MathJax-Element-1">10^M</script>. </td>
</tr>
<tr>
<td> DECIMAL(N, M) </td>
<td>       :<br>
<ul>
<li>1-4 â€” Integer;</li>
<li>5-9 â€” Integer;</li>
<li>10-18 (3 ) â€” Int64;</li>
<li>10-15 (1 ) â€” Double.</li>
</ul><br>
 </td>
<td>          <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>10</mn><mi>M</mi></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.284ex" height="2.509ex" viewBox="0 -970.7 1844.5 1080.4" role="img" focusable="false" style="vertical-align: -0.255ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-30" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4D" x="1415" y="557"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>10</mn><mi>M</mi></msup></math></span></span><script type="math/tex" id="MathJax-Element-2">10^M</script>. </td>
</tr>
<tr>
<td> CHAR(N) </td>
<td> array[0â€¦ M] of AnsiChar </td>
<td>M    <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>M</mi><mo>=</mo><mi>N</mi><mo>&amp;#x2217;</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.996ex" height="2.509ex" viewBox="0 -809.3 12484.4 1080.4" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-3D" x="1329" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4E" x="2385" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-2217" x="3496" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-42" x="4219" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-79" x="4978" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-74" x="5476" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-65" x="5837" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-73" x="6304" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-50" x="6773" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-65" x="7525" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-72" x="7991" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-43" x="8443" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-68" x="9203" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-61" x="9780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-72" x="10309" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-2212" x="10983" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-31" x="11983" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>M</mi><mo>=</mo><mi>N</mi><mo>âˆ—</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mo>âˆ’</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-3">M = N * BytesPerChar - 1</script>,<br>
  BytesPerChar â€”    ,    /.   UTF-8 â€”  4 /,  WIN1251 â€” 1 /.</td>
</tr>
<tr>
<td> VARCHAR(N) </td>
<td> FbVarChar&lt;N&gt; </td>
<td>M    <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>M</mi><mo>=</mo><mi>N</mi><mo>&amp;#x2217;</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mo>&amp;#x2212;</mo><mn>1</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="28.996ex" height="2.509ex" viewBox="0 -809.3 12484.4 1080.4" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-3D" x="1329" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-4E" x="2385" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-2217" x="3496" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-42" x="4219" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-79" x="4978" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-74" x="5476" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-65" x="5837" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-73" x="6304" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-50" x="6773" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-65" x="7525" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-72" x="7991" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-43" x="8443" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-68" x="9203" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-61" x="9780" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMATHI-72" x="10309" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-2212" x="10983" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/455375/&amp;usg=ALkJrhgExUDmm3Oqx5gKH1QC6b2uSj34jA#MJMAIN-31" x="11983" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>M</mi><mo>=</mo><mi>N</mi><mo>âˆ—</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>C</mi><mi>h</mi><mi>a</mi><mi>r</mi><mo>âˆ’</mo><mn>1</mn></math></span></span><script type="math/tex" id="MathJax-Element-4">M = N * BytesPerChar - 1</script>,<br>
  BytesPerChar â€”    ,    /.   UTF-8 â€”  4 /,  WIN1251 â€” 1 /.  Length      .  Delphi        C++,<br>
    FbVarChar&lt;N&gt; , <br>
       .   .</td>
</tr>
<tr>
<td> DATE </td>
<td> ISC_DATE </td>
<td></td>
</tr>
<tr>
<td> TIME </td>
<td> ISC_TIME </td>
<td></td>
</tr>
<tr>
<td> TIMESTAMP </td>
<td> ISC_TIMESTAMP </td>
<td> ISC_TIMESTAMP    Firebird.pas,     .      .</td>
</tr>
<tr>
<td> BLOB </td>
<td> ISC_QUAD </td>
<td> BLOB    ,    BlobId.     BLOB   .</td>
</tr>
</tbody></table></div><br>
<pre><code class="delphi hljs"><span class="hljs-comment">//      VARCHAR(N)</span>
<span class="hljs-comment">// M = N * BytesPerChar - 1</span>
<span class="hljs-keyword">record</span><font></font>
     Length: Smallint;<font></font>
     Data: <span class="hljs-keyword">array</span>[<span class="hljs-number">0</span> .. M] <span class="hljs-keyword">of</span> AnsiChar;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">//      TIMESTAMP</span>
ISC_TIMESTAMP = <span class="hljs-keyword">record</span><font></font>
    date: ISC_DATE;<font></font>
    time: ISC_TIME;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>       <br>
   ,   .</p><br>
<p>        :</p><br>
<pre><code class="plaintext hljs">function SUM_ARGS(A SMALLINT, B INTEGER) RETURNS BIGINT<font></font>
....</code></pre><br>
<p>          <br>
:</p><br>
<pre><code class="plaintext hljs">TInput = record<font></font>
  A: Smallint;<font></font>
  ANull: WordBool;<font></font>
  B: Integer;<font></font>
  BNull: WordBool;<font></font>
end;<font></font>
PInput = ^TInput;<font></font>
<font></font>
TOutput = record<font></font>
  Value: Int64;<font></font>
  Null: WordBool;<font></font>
end;<font></font>
POutput = ^TOutput;</code></pre><br>
<p>         ( 3 ):</p><br>
<pre><code class="sql hljs">function SUM_ARGS(A NUMERIC(4, 2), B NUMERIC(9, 3)) RETURNS NUMERIC(18, 6)<font></font>
....</code></pre><br>
<p>          <br>
:</p><br>
<pre><code class="delphi hljs">TInput = <span class="hljs-keyword">record</span><font></font>
  A: Smallint;<font></font>
  ANull: WordBool;<font></font>
  B: Integer;<font></font>
  BNull: WordBool;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
PInput = ^TInput;<font></font>
<font></font>
TOutput = <span class="hljs-keyword">record</span><font></font>
  Value: Int64;<font></font>
  Null: WordBool;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
POutput = ^TOutput;</code></pre><br>
<p>        :</p><br>
<pre><code class="sql hljs">procedure SOME_PROC(A CHAR(3) CHARACTER <span class="hljs-keyword">SET</span> WIN1251, B <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8)<font></font>
....</code></pre><br>
<p>         :</p><br>
<pre><code class="delphi hljs">TInput = <span class="hljs-keyword">record</span>
  A: <span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>..<span class="hljs-number">2</span>] <span class="hljs-keyword">of</span> AnsiChar;<font></font>
  ANull: WordBool;<font></font>
  B: <span class="hljs-keyword">record</span><font></font>
    Length: Smallint;<font></font>
    Value: <span class="hljs-keyword">array</span>[<span class="hljs-number">0</span>..<span class="hljs-number">39</span>] <span class="hljs-keyword">of</span> AnsiChar;
  <span class="hljs-keyword">end</span>;<font></font>
  BNull: WordBool;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
PInput = ^TInput;</code></pre><br>
<h3 id="rabota-s-buferom-soobscheniy-s-pomoschyu-imessagemetadata">      IMessageMetadata</h3><br>
<p>         <br>
    <br>
IMessageMetadata.      /<br>
 :</p><br>
<ul>
<li> /;</li>
<li> ;</li>
<li>    ;</li>
<li>    BLOB;</li>
<li>     /;</li>
<li>  /   NULL;</li>
<li>     ;</li>
<li>     NULL-.</li>
</ul><br>
<h4 id="metody-interfeysa-imessagemetadata">  IMessageMetadata</h4><br>
<ol>
<li><p>getCount</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getCount</span><span class="hljs-params">(StatusType* status)</span></span></code></pre><br>
<p>  /  .   ,   ,    : 0 &lt;= index &lt; getCount().</p><br>
</li>
<li><p>getField</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">getField</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>  .</p><br>
</li>
<li><p>getRelation</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">getRelation</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>   (    ).</p><br>
</li>
<li><p>getOwner</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">getOwner</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>   .</p><br>
</li>
<li><p>getAlias</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* <span class="hljs-title">getAlias</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>  .</p><br>
</li>
<li><p>getType</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getType</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p> SQL  .</p><br>
</li>
<li><p>isNullable</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">FB_BOOLEAN <span class="hljs-title">isNullable</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p> true,      NULL.</p><br>
</li>
<li><p>getSubType</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getSubType</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>   BLOB (0 â€” , 1 â€”   . .).</p><br>
</li>
<li><p>getLength</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getLength</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>     .</p><br>
</li>
<li><p>getScale</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getScale</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>    .</p><br>
</li>
<li><p>getCharSet</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>        BLOB.</p><br>
</li>
<li><p>getOffset</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getOffset</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>       (        ).</p><br>
</li>
<li><p>getNullOffset</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getNullOffset</span><span class="hljs-params">(StatusType* status, <span class="hljs-keyword">unsigned</span> index)</span></span></code></pre><br>
<p>  NULL      .</p><br>
</li>
<li><p>getBuilder</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">IMetadataBuilder* <span class="hljs-title">getBuilder</span><span class="hljs-params">(StatusType* status)</span></span></code></pre><br>
<p>  IMetadataBuilder,    .</p><br>
</li>
<li><p>getMessageLength</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-title">getMessageLength</span><span class="hljs-params">(StatusType* status)</span></span></code></pre><br>
<p>    (      ).</p><br>
</li>
</ol><br>
<h4 id="poluchenie-i-ispolzovanie-imessagemetadata">   IMessageMetadata</h4><br>
<p>    IMessageMetadata          IRoutineMetadata.       ,   .        . :</p><br>
<div class="spoiler"><b class="spoiler_title">   RoutineMetadata</b><div class="spoiler_text"><pre><code class="delphi hljs">  <span class="hljs-comment">//       TSumArgsFunction</span>
  <span class="hljs-title">TSumArgsFunctionFactory</span> = <span class="hljs-keyword">class</span>(IUdrFunctionFactoryImpl)
    <span class="hljs-comment">//    </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{          

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @param(AInBuilder     )
      @param(AOutBuilder     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      TSumArgsFunction

      @param(AStatus  )
      @param(AContext    )
      @param(AMetadata   )
      @returns(  )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   TSumArgsFunction.</span>
  <span class="hljs-title">TSumArgsFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)
  <span class="hljs-keyword">private</span><font></font>
    FMetadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">public</span>
    <span class="hljs-keyword">property</span> Metadata: IRoutineMetadata <span class="hljs-keyword">read</span> FMetadata <span class="hljs-keyword">write</span> FMetadata;
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">//     </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{      execute  
              
       .        ,
        ExternalEngine::getCharSet.

      @param(AStatus  )
      @param(AContext    )
      @param(AName   )
      @param(AName    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{   

      @param(AStatus  )
      @param(AContext    )
      @param(AInMsg    )
      @param(AOutMsg    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AInMsg: Pointer; AOutMsg: Pointer)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
........................<font></font>
<font></font>
<span class="hljs-comment">{ TSumArgsFunctionFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span><font></font>
  Result := TSumArgsFunction.Create();<font></font>
  <span class="hljs-keyword">with</span> Result <span class="hljs-keyword">as</span> TSumArgsFunction <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span><font></font>
    Metadata := AMetadata;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p> IMessageMetadata           getInputMetadata  getOutputMetadata  IRoutineMetadata.    ,    ,      getTriggerMetadata.</p><br>
<blockquote><strong></strong><br>
<br>
 ,     IMessageMetadata     .    IReferenceCounted.  getInputMetadata  getOutputMetadata     1   ,             <code>xInputMetadata</code>  <code>xOutputMetadata</code>   release.</blockquote><p>          .      IMessageMetadata    getOffset        .         .   <br>
    null  ,       getNullOffset.</p><br>
<div class="spoiler"><b class="spoiler_title">     IMessageMetadata</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-comment">// ........................</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunction</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  n1, n2, n3: Integer;<font></font>
  n1Null, n2Null, n3Null: WordBool;<font></font>
  Result: Integer;<font></font>
  resultNull: WordBool;<font></font>
  xInputMetadata, xOutputMetadata: IMessageMetadata;<font></font>
<span class="hljs-keyword">begin</span><font></font>
  xInputMetadata := FMetadata.getInputMetadata(AStatus);<font></font>
  xOutputMetadata := FMetadata.getOutputMetadata(AStatus);<font></font>
  <span class="hljs-keyword">try</span>
    <span class="hljs-comment">//       </span>
    n1 := PInteger(PByte(AInMsg) + xInputMetadata.getOffset(AStatus, <span class="hljs-number">0</span>))^;<font></font>
    n2 := PInteger(PByte(AInMsg) + xInputMetadata.getOffset(AStatus, <span class="hljs-number">1</span>))^;<font></font>
    n3 := PInteger(PByte(AInMsg) + xInputMetadata.getOffset(AStatus, <span class="hljs-number">2</span>))^;
    <span class="hljs-comment">//   null-     </span><font></font>
    n1Null := PWordBool(PByte(AInMsg) +<font></font>
      xInputMetadata.getNullOffset(AStatus, <span class="hljs-number">0</span>))^;<font></font>
    n2Null := PWordBool(PByte(AInMsg) +<font></font>
      xInputMetadata.getNullOffset(AStatus, <span class="hljs-number">1</span>))^;<font></font>
    n3Null := PWordBool(PByte(AInMsg) +<font></font>
      xInputMetadata.getNullOffset(AStatus, <span class="hljs-number">2</span>))^;
    <span class="hljs-comment">//     = NULL,     nullFlag</span><font></font>
    resultNull := True;<font></font>
    Result := <span class="hljs-number">0</span>;
    <span class="hljs-comment">//     NULL    NULL</span>
    <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(n1Null <span class="hljs-keyword">or</span> n2Null <span class="hljs-keyword">or</span> n3Null) <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">begin</span><font></font>
      Result := n1 + n2 + n3;<font></font>
      <span class="hljs-comment">//   ,   NULL </span><font></font>
      resultNull := False;<font></font>
    <span class="hljs-keyword">end</span>;<font></font>
    PWordBool(PByte(AInMsg) + xOutputMetadata.getNullOffset(AStatus, <span class="hljs-number">0</span>))^ :=<font></font>
      resultNull;<font></font>
    PInteger(PByte(AInMsg) + xOutputMetadata.getOffset(AStatus, <span class="hljs-number">0</span>))^ := Result;
  <span class="hljs-keyword">finally</span><font></font>
    xInputMetadata.release;<font></font>
    xOutputMetadata.release;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<h2 id="fabriki"></h2><br>
<p>     .      .</p><br>
<p>     ,   .         IUdrProcedureFactory, IUdrFunctionFactory  IUdrTriggerFactory     UDR.          UDR   <code>firebird_udr_plugin</code>.</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TSumArgsFunctionFactory.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'gen_rows'</span>, TGenRowsFactory.Create());
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerTrigger(AStatus, <span class="hljs-string">'test_trigger'</span>,<font></font>
    TMyTriggerFactory.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>    <code>TSumArgsFunctionFactory</code>   IUdrFunctionFactory, <code>TGenRowsFactory</code>   IUdrProcedureFactory,  <code>TMyTriggerFactory</code>   IUdrTriggerFactory.</p><br>
<p>             ,   .         Firebird.  ,   SuperServer             ,  Classic  <br>
     .</p><br>
<p>        setup  newItem   IUdrProcedureFactory, IUdrFunctionFactory  IUdrTriggerFactory.</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="delphi hljs">  <span class="hljs-title">IUdrFunctionFactory</span> = <span class="hljs-keyword">class</span>(IDisposable)
    <span class="hljs-keyword">const</span> VERSION = <span class="hljs-number">3</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata; inBuilder: IMetadataBuilder;
        outBuilder: IMetadataBuilder)</span>;</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata)</span>:</span> IExternalFunction;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-title">IUdrProcedureFactory</span> = <span class="hljs-keyword">class</span>(IDisposable)
    <span class="hljs-keyword">const</span> VERSION = <span class="hljs-number">3</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata; inBuilder: IMetadataBuilder;
        outBuilder: IMetadataBuilder)</span>;</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata)</span>:</span> IExternalProcedure;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-title">IUdrTriggerFactory</span> = <span class="hljs-keyword">class</span>(IDisposable)
    <span class="hljs-keyword">const</span> VERSION = <span class="hljs-number">3</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata; fieldsBuilder: IMetadataBuilder)</span>;</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(status: IStatus; context: IExternalContext;
      metadata: IRoutineMetadata)</span>:</span> IExternalTrigger;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p> ,      IDisposable,       dispose.    Firebird   ,    .   dispose   ,   ,    .      <br>
  <code>IUdrProcedureFactoryImpl</code>, <code>IUdrFunctionFactoryImpl</code>, <code>IUdrTriggerFactoryImpl</code>.      .</p><br>
<h3 id="metod-newitem"> newItem</h3><br>
<p> newItem      ,   .   UDR        , ..    ,   .             .</p><br>
<p>           . ,      ,    ,    <code>IUdrFunctionFactory</code>.             .      .</p><br>
<p>  newItem     , <br>
 UDR   UDR.</p><br>
<p>      </p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//    </span><font></font>
  Result := TSumArgsFunction.Create();<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>  IRoutineMetadata        ,  UDR   .       UDR.         UDR      .</p><br>
<pre><code class="delphi hljs">  <span class="hljs-comment">//   TSumArgsFunction.</span>
  <span class="hljs-title">TSumArgsFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)
  <span class="hljs-keyword">private</span><font></font>
    FMetadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">public</span>
    <span class="hljs-keyword">property</span> Metadata: IRoutineMetadata <span class="hljs-keyword">read</span> FMetadata <span class="hljs-keyword">write</span> FMetadata;
  <span class="hljs-keyword">public</span><font></font>
  ...<font></font>
  <span class="hljs-keyword">end</span>;</code></pre><br>
<h3 id="metod-setup"> setup</h3><br>
<p> setup                 .     IMetadataBuilder,          ,    .      <br>
   setup,         setup      DLL ,   .         .</p><br>
<p>                   .        ,          SumArgs.</p><br>
<p>     ,    </p><br>
<pre><code class="delphi hljs"><span class="hljs-keyword">type</span>
  <span class="hljs-comment">//       </span>
  TSumArgsInMsg = <span class="hljs-keyword">record</span><font></font>
    n1: Integer;<font></font>
    n1Null: WordBool;<font></font>
    n2: Integer;<font></font>
    n2Null: WordBool;<font></font>
    n3: Integer;<font></font>
    n3Null: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  PSumArgsInMsg = ^TSumArgsInMsg;<font></font>
<font></font>
  <span class="hljs-comment">//       </span>
  TSumArgsOutMsg = <span class="hljs-keyword">record</span><font></font>
    result: Integer;<font></font>
    resultNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  PSumArgsOutMsg = ^TSumArgsOutMsg;</code></pre><br>
<p>   ,   setup    ,     .</p><br>
<div class="spoiler"><b class="spoiler_title">SumArgsFunctionFactory</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-comment">{ TSumArgsFunctionFactory }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span><font></font>
  Result := TSumArgsFunction.Create();<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunctionFactory</span>.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//     </span>
  AInBuilder.setType(AStatus, <span class="hljs-number">0</span>, Cardinal(SQL_LONG) + <span class="hljs-number">1</span>);<font></font>
  AInBuilder.setLength(AStatus, <span class="hljs-number">0</span>, sizeof(Int32));<font></font>
  AInBuilder.setType(AStatus, <span class="hljs-number">1</span>, Cardinal(SQL_LONG) + <span class="hljs-number">1</span>);<font></font>
  AInBuilder.setLength(AStatus, <span class="hljs-number">1</span>, sizeof(Int32));<font></font>
  AInBuilder.setType(AStatus, <span class="hljs-number">2</span>, Cardinal(SQL_LONG) + <span class="hljs-number">1</span>);<font></font>
  AInBuilder.setLength(AStatus, <span class="hljs-number">2</span>, sizeof(Int32));
  <span class="hljs-comment">//     </span>
  AOutBuilder.setType(AStatus, <span class="hljs-number">0</span>, Cardinal(SQL_LONG) + <span class="hljs-number">1</span>);<font></font>
  AOutBuilder.setLength(AStatus, <span class="hljs-number">0</span>, sizeof(Int32));
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<blockquote><strong> </strong><br>
<br>
   SQL  Firebird .   ,     SQL       NULL.          XSQLDA.</blockquote><p>  </p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSumArgsFunction</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xInput: PSumArgsInMsg;<font></font>
  xOutput: PSumArgsOutMsg;<font></font>
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//        </span><font></font>
  xInput := PSumArgsInMsg(AInMsg);<font></font>
  xOutput := PSumArgsOutMsg(AOutMsg);<font></font>
  <span class="hljs-comment">//     = NULL,     nullFlag</span><font></font>
  xOutput^.resultNull := True;<font></font>
  <span class="hljs-comment">//     NULL    NULL</span>
  <span class="hljs-comment">//      </span>
  xOutput^.resultNull := xInput^.n1Null <span class="hljs-keyword">or</span> xInput^.n2Null <span class="hljs-keyword">or</span> xInput^.n3Null;<font></font>
  xOutput^.result := xInput^.n1 + xInput^.n2 + xInput^.n3;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>       ,      ,          ,      setup.</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">function</span> FN_SUM_ARGS (<font></font>
    N1 <span class="hljs-built_in">varchar</span>(<span class="hljs-number">15</span>),<font></font>
    N2 <span class="hljs-built_in">varchar</span>(<span class="hljs-number">15</span>),<font></font>
    N3 <span class="hljs-built_in">varchar</span>(<span class="hljs-number">15</span>))
<span class="hljs-keyword">returns</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">15</span>)
<span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">NAME</span> <span class="hljs-string">'MyUdrSetup!sum_args'</span>
<span class="hljs-keyword">ENGINE</span> UDR;</code></pre><br>
<p>       </p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> FN_SUM_ARGS(<span class="hljs-string">'15'</span>, <span class="hljs-string">'21'</span>, <span class="hljs-string">'35'</span>) <span class="hljs-keyword">from</span> rdb$<span class="hljs-keyword">database</span></code></pre><br>
<h2 id="obobschyonnye-fabriki"> </h2><br>
<p>   UDR     ,          UDR.            .     Delphi 2009,  Free Pascal    FPC 2.2.</p><br>
<blockquote><strong></strong><br>
<br>
 Free Pascal      <br>
Delphi.    FPC 2.6.0    Delphi<br>
.</blockquote><p>        <br>
:</p><br>
<ul>
<li><p>  ,          ,         UDR,       ;</p><br>
</li>
<li><p>  ,       ,         UDR,        IMessageMetadata.</p><br>
</li>
</ul><br>
<p>           newItem   .          <code>IUdrFunctionFactoryImpl</code>, <code>IUdrProcedureFactoryImpl</code>, <code>IUdrTriggerFactoryImpl</code>.      :</p><br>
<div class="spoiler"><b class="spoiler_title">SimpleFactories</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> UdrFactories;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> SysUtils, Firebird;<font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  TFunctionSimpleFactory&lt;T: IExternalFunctionImpl, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrFunctionFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  TProcedureSimpleFactory&lt;T: IExternalProcedureImpl, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrProcedureFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  TTriggerSimpleFactory&lt;T: IExternalTriggerImpl, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrTriggerFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AFieldsBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>     setup   ,     ,    dispose   .     newItem          <code>T</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-comment">{ TProcedureSimpleFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TProcedureSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TProcedureSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TProcedureSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TFunctionFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFunctionSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TFunctionSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFunctionSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TTriggerSimpleFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TTriggerSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TTriggerSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TTriggerSimpleFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AFieldsBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>   1       ,   .          :</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'sum_args'</span>,<font></font>
    TFunctionSimpleFactory&lt;TSumArgsFunction&gt;.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'gen_rows'</span>,<font></font>
    TProcedureSimpleFactory&lt;TGenRowsProcedure&gt;.Create());<font></font>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerTrigger(AStatus, <span class="hljs-string">'test_trigger'</span>,<font></font>
    TTriggerSimpleFactory&lt;TMyTrigger&gt;.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>   .          ,   .         <code>newItem</code> .  UDR   <code>IRoutineMetadata</code>,       Firebird,        UDR.           ,    ,  UDR, ,   <br>
 UDR.      ,         ,      .</p><br>
<pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> UdrFactories;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> SysUtils, Firebird;<font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
...<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalProcedure</span> = <span class="hljs-keyword">class</span>(IExternalProcedureImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalTrigger</span> = <span class="hljs-keyword">class</span>(IExternalTriggerImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;</code></pre><br>
<p>      ,           .</p><br>
<pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> UdrFactories;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> SysUtils, Firebird;<font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
...<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalProcedure</span> = <span class="hljs-keyword">class</span>(IExternalProcedureImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-title">TExternalTrigger</span> = <span class="hljs-keyword">class</span>(IExternalTriggerImpl)<font></font>
    Metadata: IRoutineMetadata;<font></font>
  <span class="hljs-keyword">end</span>;</code></pre><br>
<p>      ,           .</p><br>
<p>      UDR   .</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> UdrFactories;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE DELPHI}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> SysUtils, Firebird;<font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
...<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  TFunctionFactory&lt;T: TExternalFunction, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrFunctionFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  TProcedureFactory&lt;T: TExternalProcedure, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrProcedureFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  TTriggerFactory&lt;T: TExternalTrigger, <span class="hljs-function"><span class="hljs-keyword">constructor</span>&gt; = <span class="hljs-title">class</span>
    <span class="hljs-params">(IUdrTriggerFactoryImpl)</span>
    <span class="hljs-title">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AFieldsBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>  newItem      , <br>
 ,      .</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">implementation</span><font></font>
...<font></font>
<font></font>
<span class="hljs-comment">{ TFunctionFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFunctionFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TFunctionFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
  (Result <span class="hljs-keyword">as</span> T).Metadata := AMetadata;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFunctionFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TProcedureFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TProcedureFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TProcedureFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalProcedure;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
  (Result <span class="hljs-keyword">as</span> T).Metadata := AMetadata;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TProcedureFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata;
  AInBuilder, AOutBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-comment">{ TTriggerFactory&lt;T&gt; }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TTriggerFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TTriggerFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AMetadata: IRoutineMetadata)</span>:</span> IExternalTrigger;
<span class="hljs-keyword">begin</span><font></font>
  Result := T.Create;<font></font>
  (Result <span class="hljs-keyword">as</span> T).Metadata := AMetadata;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TTriggerFactory</span>&lt;<span class="hljs-title">T</span>&gt;.<span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AMetadata: IRoutineMetadata; AFieldsBuilder: IMetadataBuilder)</span>;</span>
<span class="hljs-keyword">begin</span><font></font>
<font></font>
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/sim1984/udr-book/blob/master/examples/Common/UdrFactories.pas</a>.</p><br>
<h1 id="rabota-s-tipom-blob">   BLOB</h1><br>
<p>      BLOB    ( BLOB),    .  , BLOB    ,         .         BLOB .      BLOB  <br>
 <code>IBlob</code>.</p><br>
<p>     BLOB  ,  BLOB    ,      BLOB   ,     BLOB     .</p><br>
<p>    BLOB    ,   BLOB     (),     64 .     <code>getSegment</code>  <code>IBlob</code>.     <code>putSegment</code>  <code>IBlob</code>.</p><br>
<h2 id="chtenie-dannyh-iz-blob">   BLOB</h2><br>
<p>    BLOB    <br>
   (    <br>
 LIST).    </p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> <span class="hljs-keyword">split</span> (<font></font>
    txt <span class="hljs-built_in">blob</span> sub_type <span class="hljs-built_in">text</span> <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> utf8,<font></font>
    delimiter <span class="hljs-built_in">char</span>(<span class="hljs-number">1</span>) <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> utf8 = <span class="hljs-string">','</span>
) <span class="hljs-keyword">returns</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-built_in">integer</span><font></font>
)<font></font>
<span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'myudr!split'</span>
<span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>   :</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//   </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'split'</span>, TProcedureSimpleFactory&lt;TSplitProcedure&gt;.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>        ,         .      .</p><br>
<p>    .        .</p><br>
<pre><code class="delphi hljs">  TInput = <span class="hljs-keyword">record</span><font></font>
    txt: ISC_QUAD;<font></font>
    txtNull: WordBool;<font></font>
    delimiter: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">3</span>] <span class="hljs-keyword">of</span> AnsiChar;<font></font>
    delimiterNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  TInputPtr = ^TInput;<font></font>
<font></font>
  TOutput = <span class="hljs-keyword">record</span><font></font>
    Id: Integer;<font></font>
    Null: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  TOutputPtr = ^TOutput;</code></pre><br>
<p>    BLOB   BLOB,    <code>ISC_QUAD</code>.</p><br>
<p>       :</p><br>
<div class="spoiler"><b class="spoiler_title">   Split    </b><div class="spoiler_text"><pre><code class="delphi hljs">  <span class="hljs-title">TSplitProcedure</span> = <span class="hljs-keyword">class</span>(IExternalProcedureImpl)
  <span class="hljs-keyword">private</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">SaveBlobToStream</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      ABlobId: ISC_QUADPtr; AStream: TStream)</span>;</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readBlob</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      ABlobId: ISC_QUADPtr)</span>:</span> <span class="hljs-keyword">string</span>;
  <span class="hljs-keyword">public</span>
    <span class="hljs-comment">//     </span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext; AInMsg: Pointer;
      AOutMsg: Pointer)</span>:</span> IExternalResultSet; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-title">TSplitResultSet</span> = <span class="hljs-keyword">class</span>(IExternalResultSetImpl)
<span class="hljs-meta">{$IFDEF FPC}</span><font></font>
    OutputArray: TStringArray;<font></font>
<span class="hljs-meta">{$ELSE}</span>
    OutputArray: TArray&lt;<span class="hljs-keyword">string</span>&gt;;
<span class="hljs-meta">{$ENDIF}</span><font></font>
    Counter: Integer;<font></font>
    Output: TOutputPtr;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">(AStatus: IStatus)</span>:</span> Boolean; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>  <code>SaveBlobToStream</code>  <code>readBlob</code>    BLOB.   BLOB  ,  â€”           Delphi.       OutputArray     Counter.</p><br>
<p>  open  BLOB    .          <code>Split</code>    .        .</p><br>
<div class="spoiler"><b class="spoiler_title">TSplitProcedure.open</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSplitProcedure</span>.<span class="hljs-title">open</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>:</span> IExternalResultSet;
<span class="hljs-keyword">var</span><font></font>
  xInput: TInputPtr;<font></font>
  xText: <span class="hljs-keyword">string</span>;<font></font>
  xDelimiter: <span class="hljs-keyword">string</span>;
<span class="hljs-keyword">begin</span><font></font>
  xInput := AInMsg;<font></font>
  <span class="hljs-keyword">if</span> xInput.txtNull <span class="hljs-keyword">or</span> xInput.delimiterNull <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span>
    Result := <span class="hljs-keyword">nil</span>;
    <span class="hljs-keyword">Exit</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  xText := readBlob(AStatus, AContext, @xInput.txt);<font></font>
  xDelimiter := TFBCharSet.CS_UTF8.GetString(TBytes(@xInput.delimiter), <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);
  <span class="hljs-comment">//       </span>
  <span class="hljs-comment">//   </span>
  <span class="hljs-comment">//  - /4</span>
  SetLength(xDelimiter, <span class="hljs-number">1</span>);<font></font>
<font></font>
  Result := TSplitResultSet.Create;<font></font>
  <span class="hljs-keyword">with</span> TSplitResultSet(Result) <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span><font></font>
    Output := AOutMsg;<font></font>
    OutputArray := xText.Split([xDelimiter], TStringSplitOptions.ExcludeEmpty);<font></font>
    Counter := <span class="hljs-number">0</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<blockquote><strong></strong><br>
<br>
  <code>TFBCharSet</code>    Firebird.pas.   <br>
     Firebird.    <br>
       UTF-8.<br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">FbCharsets.pas</a></blockquote><p>      BLOB  .       BLOB   .      openBlob  <code>IAttachment</code>.    BLOB    ,        .              ,   <br>
( <code>IExternalContext</code>).</p><br>
<p>BLOB   (),     64 .     <code>getSegment</code>  <code>IBlob</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">TSplitProcedure.SaveBlobToStream</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSplitProcedure</span>.<span class="hljs-title">SaveBlobToStream</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; ABlobId: ISC_QUADPtr; AStream: TStream)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  att: IAttachment;<font></font>
  trx: ITransaction;<font></font>
  blob: IBlob;<font></font>
  buffer: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">32767</span>] <span class="hljs-keyword">of</span> AnsiChar;<font></font>
  l: Integer;<font></font>
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">try</span><font></font>
    att := AContext.getAttachment(AStatus);<font></font>
    trx := AContext.getTransaction(AStatus);<font></font>
    blob := att.openBlob(AStatus, trx, ABlobId, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);
    <span class="hljs-keyword">while</span> True <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">case</span> blob.getSegment(AStatus, SizeOf(buffer), @buffer, @l) <span class="hljs-keyword">of</span><font></font>
        IStatus.RESULT_OK:<font></font>
          AStream.WriteBuffer(buffer, l);<font></font>
        IStatus.RESULT_SEGMENT:<font></font>
          AStream.WriteBuffer(buffer, l);<font></font>
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
    AStream.Position := <span class="hljs-number">0</span>;<font></font>
    blob.close(AStatus);<font></font>
  <span class="hljs-keyword">finally</span>
    <span class="hljs-keyword">if</span> Assigned(att) <span class="hljs-keyword">then</span><font></font>
      att.release;<font></font>
    <span class="hljs-keyword">if</span> Assigned(trx) <span class="hljs-keyword">then</span><font></font>
      trx.release;<font></font>
    <span class="hljs-keyword">if</span> Assigned(blob) <span class="hljs-keyword">then</span><font></font>
      blob.release;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<blockquote><strong></strong><br>
<br>
 ,  <code>IAttachment</code>, <code>ITransaction</code>  <code>IBlob</code><br>
  <code>IReferenceCounted</code>,     <br>
 .     <br>
    1.     <br>
        release.</blockquote><p>   <code>SaveBlobToStream</code>    BLOB <br>
:</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSplitProcedure</span>.<span class="hljs-title">readBlob</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  ABlobId: ISC_QUADPtr)</span>:</span> <span class="hljs-keyword">string</span>;
<span class="hljs-keyword">var</span>
<span class="hljs-meta">{$IFDEF FPC}</span><font></font>
  xStream: TBytesStream;<font></font>
<span class="hljs-meta">{$ELSE}</span><font></font>
  xStream: TStringStream;<font></font>
<span class="hljs-meta">{$ENDIF}</span>
<span class="hljs-keyword">begin</span>
<span class="hljs-meta">{$IFDEF FPC}</span>
  xStream := TBytesStream.Create(<span class="hljs-keyword">nil</span>);
<span class="hljs-meta">{$ELSE}</span>
  xStream := TStringStream.Create(<span class="hljs-string">''</span>, <span class="hljs-number">65001</span>);
<span class="hljs-meta">{$ENDIF}</span>
  <span class="hljs-keyword">try</span><font></font>
    SaveBlobToStream(AStatus, AContext, ABlobId, xStream);<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
    Result := TEncoding.UTF8.GetString(xStream.Bytes, <span class="hljs-number">0</span>, xStream.Size);
<span class="hljs-meta">{$ELSE}</span><font></font>
    Result := xStream.DataString;<font></font>
<span class="hljs-meta">{$ENDIF}</span>
  <span class="hljs-keyword">finally</span><font></font>
    xStream.Free;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre><br>
<blockquote><strong></strong><br>
<br>
  Free Pascal     <br>
 Delphi   <code>TStringStream</code>.    FPC  <br>
     ,   <br>
       .</blockquote><p> <code>fetch</code>           Counter      ,       .      .           <code>isc_convert_error</code>.</p><br>
<div class="spoiler"><b class="spoiler_title"> isc_convert_error</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TSplitResultSet</span>.<span class="hljs-title">dispose</span>;</span>
<span class="hljs-keyword">begin</span>
  SetLength(OutputArray, <span class="hljs-number">0</span>);<font></font>
  Destroy;<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TSplitResultSet</span>.<span class="hljs-title">fetch</span><span class="hljs-params">(AStatus: IStatus)</span>:</span> Boolean;
<span class="hljs-keyword">var</span>
  statusVector: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">4</span>] <span class="hljs-keyword">of</span> NativeIntPtr;
<span class="hljs-keyword">begin</span>
  <span class="hljs-keyword">if</span> Counter &lt;= High(OutputArray) <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span><font></font>
    Output.Null := False;<font></font>
    <span class="hljs-comment">//         isc_random</span>
    <span class="hljs-comment">//        Firebird</span>
    <span class="hljs-comment">//  isc_convert_error</span>
    <span class="hljs-keyword">try</span><font></font>
      Output.Id := OutputArray[Counter].ToInteger();<font></font>
    <span class="hljs-keyword">except</span>
      <span class="hljs-keyword">on</span> e: EConvertError <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">begin</span><font></font>
<font></font>
        statusVector[<span class="hljs-number">0</span>] := NativeIntPtr(isc_arg_gds);<font></font>
        statusVector[<span class="hljs-number">1</span>] := NativeIntPtr(isc_convert_error);<font></font>
        statusVector[<span class="hljs-number">2</span>] := NativeIntPtr(isc_arg_string);<font></font>
        statusVector[<span class="hljs-number">3</span>] := NativeIntPtr(PAnsiChar(<span class="hljs-string">'Cannot convert string to integer'</span>));<font></font>
        statusVector[<span class="hljs-number">4</span>] := NativeIntPtr(isc_arg_end);<font></font>
<font></font>
        AStatus.setErrors(@statusVector);<font></font>
      <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
    inc(Counter);<font></font>
    Result := True;<font></font>
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span><font></font>
    Result := False;<font></font>
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<blockquote><strong></strong><br>
<br>
       <code>isc_random</code>  <br>
,      .</blockquote><p>     :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> ids.ID
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">SPLIT</span>((<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LIST</span>(<span class="hljs-keyword">ID</span>) <span class="hljs-keyword">FROM</span> MYTABLE), <span class="hljs-string">','</span>) ids</code></pre><br>
<blockquote><strong></strong><br>
<br>
      ,  BLOB <br>
  ,      <br>
   .      <br>
  ,     <br>
  .      <br>
   <code>fetch</code>     .</blockquote><br>
<h2 id="zapis-dannyh-v-blob">   BLOB</h2><br>
<p>    BLOB    <br>
BLOB  .</p><br>
<blockquote><strong></strong><br>
<br>
     UDF    <br>
 BLOB / .  UDF   <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">blobsaveload.zip</a></blockquote><p>     BLOB /     </p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PACKAGE</span> BlobFileUtils
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">PROCEDURE</span> SaveBlobToFile(ABlob <span class="hljs-built_in">BLOB</span>, AFileName <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8);<font></font>
<font></font>
  FUNCTION LoadBlobFromFile(AFileName VARCHAR(255) CHARACTER <span class="hljs-keyword">SET</span> UTF8) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">BLOB</span>;
<span class="hljs-keyword">END</span>^<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PACKAGE</span> <span class="hljs-keyword">BODY</span> BlobFileUtils
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">PROCEDURE</span> SaveBlobToFile(ABlob <span class="hljs-built_in">BLOB</span>, AFileName <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8)
  <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">NAME</span> <span class="hljs-string">'BlobFileUtils!SaveBlobToFile'</span>
  <span class="hljs-keyword">ENGINE</span> UDR;<font></font>
<font></font>
  FUNCTION LoadBlobFromFile(AFileName VARCHAR(255) CHARACTER <span class="hljs-keyword">SET</span> UTF8) <span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">BLOB</span>
  <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">NAME</span> <span class="hljs-string">'BlobFileUtils!LoadBlobFromFile'</span>
  <span class="hljs-keyword">ENGINE</span> UDR;
<span class="hljs-keyword">END</span>^</code></pre><br>
<p>     :</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">// </span>
  AUdrPlugin.registerProcedure(AStatus, <span class="hljs-string">'SaveBlobToFile'</span>, TSaveBlobToFileProcFactory.Create());<font></font>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'LoadBlobFromFile'</span>, TLoadBlobFromFileFuncFactory.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>         BLOB  ,   UDR     <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">06.BlobSaveLoad</a>.       LoadBlobFromFile   :</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird, Classes, SysUtils;<font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
<font></font>
  <span class="hljs-comment">//   </span>
  TInput = <span class="hljs-keyword">record</span>
    filename: <span class="hljs-keyword">record</span><font></font>
      len: Smallint;<font></font>
      str: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">1019</span>] <span class="hljs-keyword">of</span> AnsiChar;
    <span class="hljs-keyword">end</span>;<font></font>
    filenameNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  TInputPtr = ^TInput;<font></font>
<font></font>
  <span class="hljs-comment">//   </span>
  TOutput = <span class="hljs-keyword">record</span><font></font>
    blobData: ISC_QUAD;<font></font>
    blobDataNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
  TOutputPtr = ^TOutput;<font></font>
<font></font>
  <span class="hljs-comment">//   LoadBlobFromFile</span>
  <span class="hljs-title">TLoadBlobFromFileFunc</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)
  <span class="hljs-keyword">public</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AInMsg: Pointer; AOutMsg: Pointer)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  <span class="hljs-comment">//       LoadBlobFromFile</span>
  <span class="hljs-title">TLoadBlobFromFileFuncFactory</span> = <span class="hljs-keyword">class</span>(IUdrFunctionFactoryImpl)
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">setup</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata; AInBuilder: IMetadataBuilder;
      AOutBuilder: IMetadataBuilder)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newItem</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AMetadata: IRoutineMetadata)</span>:</span> IExternalFunction; <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>     <code>execute</code>  <code>TLoadBlobFromFile</code>,    .</p><br>
<div class="spoiler"><b class="spoiler_title">  execute</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TLoadBlobFromFileFunc</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AInMsg: Pointer; AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">const</span>
  MaxBufSize = <span class="hljs-number">16384</span>;
<span class="hljs-keyword">var</span><font></font>
  xInput: TInputPtr;<font></font>
  xOutput: TOutputPtr;<font></font>
  xFileName: <span class="hljs-keyword">string</span>;<font></font>
  xStream: TFileStream;<font></font>
  att: IAttachment;<font></font>
  trx: ITransaction;<font></font>
  blob: IBlob;<font></font>
  buffer: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">32767</span>] <span class="hljs-keyword">of</span> Byte;<font></font>
  xStreamSize: Integer;<font></font>
  xBufferSize: Integer;<font></font>
  xReadLength: Integer;<font></font>
<span class="hljs-keyword">begin</span><font></font>
  xInput := AInMsg;<font></font>
  xOutput := AOutMsg;<font></font>
  <span class="hljs-keyword">if</span> xInput.filenameNull <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span><font></font>
    xOutput.blobDataNull := True;<font></font>
    <span class="hljs-keyword">Exit</span>;
  <span class="hljs-keyword">end</span>;<font></font>
  xOutput.blobDataNull := False;<font></font>
  <span class="hljs-comment">//   </span>
  xFileName := TEncoding.UTF8.GetString(TBytes(@xInput.filename.str), <span class="hljs-number">0</span>,<font></font>
    xInput.filename.len * <span class="hljs-number">4</span>);<font></font>
  SetLength(xFileName, xInput.filename.len);<font></font>
  <span class="hljs-comment">//    </span>
  xStream := TFileStream.Create(xFileName, fmOpenRead <span class="hljs-keyword">or</span> fmShareDenyNone);<font></font>
  att := AContext.getAttachment(AStatus);<font></font>
  trx := AContext.getTransaction(AStatus);<font></font>
  blob := <span class="hljs-keyword">nil</span>;
  <span class="hljs-keyword">try</span><font></font>
    xStreamSize := xStream.Size;<font></font>
    <span class="hljs-comment">//     ()</span>
    <span class="hljs-keyword">if</span> xStreamSize &gt; MaxBufSize <span class="hljs-keyword">then</span><font></font>
      xBufferSize := MaxBufSize<font></font>
    <span class="hljs-keyword">else</span><font></font>
      xBufferSize := xStreamSize;<font></font>
    <span class="hljs-comment">//   blob</span>
    blob := att.createBlob(AStatus, trx, @xOutput.blobData, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);
    <span class="hljs-comment">//        BLOB  </span>
    <span class="hljs-keyword">while</span> xStreamSize &lt;&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-keyword">if</span> xStreamSize &gt; xBufferSize <span class="hljs-keyword">then</span><font></font>
        xReadLength := xBufferSize<font></font>
      <span class="hljs-keyword">else</span><font></font>
        xReadLength := xStreamSize;<font></font>
      xStream.ReadBuffer(buffer, xReadLength);<font></font>
<font></font>
      blob.putSegment(AStatus, xReadLength, @buffer[<span class="hljs-number">0</span>]);<font></font>
<font></font>
      Dec(xStreamSize, xReadLength);<font></font>
    <span class="hljs-keyword">end</span>;
    <span class="hljs-comment">//  BLOB</span><font></font>
    blob.close(AStatus);<font></font>
  <span class="hljs-keyword">finally</span>
    <span class="hljs-keyword">if</span> Assigned(blob) <span class="hljs-keyword">then</span><font></font>
      blob.release;<font></font>
    att.release;<font></font>
    trx.release;<font></font>
    xStream.Free;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>     BLOB     blobId     <code>createBlob</code>  <code>IAttachment</code>.       BLOB    ,        .              ,    ( <code>IExternalContext</code>).</p><br>
<p>          BLOB,        <code>putSegment</code>  <code>IBlob</code>   ,       .             <code>close</code>.</p><br>
<h2 id="helper-dlya-raboty-s-tipom-blob">     BLOB</h2><br>
<p>        BLOB <br>
,     BLOB  .   <br>
     BLOB,     <br>
      .</p><br>
<p>  Delphi  Free Pascal   <br>
         .<br>
    IBlob     <br>
 / Blob.</p><br>
<p>   FbBlob,     .</p><br>
<div class="spoiler"><b class="spoiler_title">BlobHelper</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> FbBlob;<font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> Classes, SysUtils, Firebird;<font></font>
<font></font>
<span class="hljs-keyword">const</span>
  MAX_SEGMENT_SIZE = <span class="hljs-number">$7FFF</span>;<font></font>
<font></font>
<span class="hljs-keyword">type</span>
  TFbBlobHelper = <span class="hljs-keyword">class</span> <span class="hljs-keyword">helper</span> <span class="hljs-keyword">for</span> IBlob
    <span class="hljs-comment">{   BLOB  

      @param(AStatus  )
      @param(AStream )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">LoadFromStream</span><span class="hljs-params">(AStatus: IStatus; AStream: TStream)</span>;</span>
    <span class="hljs-comment">{     BLOB

      @param(AStatus  )
      @param(AStream )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">SaveToStream</span><span class="hljs-params">(AStatus: IStatus; AStream: TStream)</span>;</span>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">implementation</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span> Math;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFbBlobHelper</span>.<span class="hljs-title">LoadFromStream</span><span class="hljs-params">(AStatus: IStatus; AStream: TStream)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xStreamSize: Integer;<font></font>
  xReadLength: Integer;<font></font>
  xBuffer: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. MAX_SEGMENT_SIZE] <span class="hljs-keyword">of</span> Byte;
<span class="hljs-keyword">begin</span><font></font>
  xStreamSize := AStream.Size;<font></font>
  AStream.Position := <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> xStreamSize &lt;&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span><font></font>
    xReadLength := Min(xStreamSize, MAX_SEGMENT_SIZE);<font></font>
    AStream.ReadBuffer(xBuffer, xReadLength);<font></font>
    Self.putSegment(AStatus, xReadLength, @xBuffer[<span class="hljs-number">0</span>]);<font></font>
    Dec(xStreamSize, xReadLength);<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TFbBlobHelper</span>.<span class="hljs-title">SaveToStream</span><span class="hljs-params">(AStatus: IStatus; AStream: TStream)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xInfo: TFbBlobInfo;<font></font>
  Buffer: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. MAX_SEGMENT_SIZE] <span class="hljs-keyword">of</span> Byte;<font></font>
  xBytesRead: Cardinal;<font></font>
  xBufferSize: Cardinal;<font></font>
<span class="hljs-keyword">begin</span>
  AStream.Position := <span class="hljs-number">0</span>;<font></font>
  xBufferSize := Min(SizeOf(Buffer), MAX_SEGMENT_SIZE);<font></font>
  <span class="hljs-keyword">while</span> True <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-keyword">case</span> Self.getSegment(AStatus, xBufferSize, @Buffer[<span class="hljs-number">0</span>], @xBytesRead) <span class="hljs-keyword">of</span><font></font>
      IStatus.RESULT_OK:<font></font>
        AStream.WriteBuffer(Buffer, xBytesRead);<font></font>
      IStatus.RESULT_SEGMENT:<font></font>
        AStream.WriteBuffer(Buffer, xBytesRead);<font></font>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">end</span>.</code></pre></div></div><br>
<p>        BLOB,     BLOB      :</p><br>
<div class="spoiler"><b class="spoiler_title">TLoadBlobFromFileFunc.execute</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TLoadBlobFromFileFunc</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus;
  AContext: IExternalContext; AInMsg: Pointer; AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xInput: TInputPtr;<font></font>
  xOutput: TOutputPtr;<font></font>
  xFileName: <span class="hljs-keyword">string</span>;<font></font>
  xStream: TFileStream;<font></font>
  att: IAttachment;<font></font>
  trx: ITransaction;<font></font>
  blob: IBlob;<font></font>
<span class="hljs-keyword">begin</span><font></font>
  xInput := AInMsg;<font></font>
  xOutput := AOutMsg;<font></font>
  <span class="hljs-keyword">if</span> xInput.filenameNull <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span><font></font>
    xOutput.blobDataNull := True;<font></font>
    <span class="hljs-keyword">Exit</span>;
  <span class="hljs-keyword">end</span>;<font></font>
  xOutput.blobDataNull := False;<font></font>
  <span class="hljs-comment">//   </span>
  xFileName := TEncoding.UTF8.GetString(TBytes(@xInput.filename.str), <span class="hljs-number">0</span>,<font></font>
    xInput.filename.len * <span class="hljs-number">4</span>);<font></font>
  SetLength(xFileName, xInput.filename.len);<font></font>
  <span class="hljs-comment">//    </span>
  xStream := TFileStream.Create(xFileName, fmOpenRead <span class="hljs-keyword">or</span> fmShareDenyNone);<font></font>
  att := AContext.getAttachment(AStatus);<font></font>
  trx := AContext.getTransaction(AStatus);<font></font>
  blob := <span class="hljs-keyword">nil</span>;
  <span class="hljs-keyword">try</span>
    <span class="hljs-comment">//   blob</span>
    blob := att.createBlob(AStatus, trx, @xOutput.blobData, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);
    <span class="hljs-comment">//     BLOB</span><font></font>
    blob.LoadFromStream(AStatus, xStream);<font></font>
    <span class="hljs-comment">//  BLOB</span><font></font>
    blob.close(AStatus);<font></font>
  <span class="hljs-keyword">finally</span>
    <span class="hljs-keyword">if</span> Assigned(blob) <span class="hljs-keyword">then</span><font></font>
      blob.release;<font></font>
    att.release;<font></font>
    trx.release;<font></font>
    xStream.Free;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<h1 id="kontekst-soedineniya-i-tranzakcii">   </h1><br>
<p>   ,              ,    ,        / .  ,            BLOB.</p><br>
<p>   ,          <code>IExternalContext</code>   execute   ,    open .  <code>IExternalContext</code>        <code>getAttachment</code>,       <code>getTransaction</code>.      UDR,              ,        ,     <code>startTransaction</code>  <code>IExternalContext</code>.              .  ,               , ..     (2PC).</p><br>
<p>         ,      SELECT    JSON.    :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> GetJson (<font></font>
    sql_text <span class="hljs-built_in">blob</span> sub_type <span class="hljs-built_in">text</span> <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> utf8,<font></font>
    sql_dialect <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3</span>
) <span class="hljs-keyword">returns</span> <span class="hljs-keyword">returns</span> <span class="hljs-built_in">blob</span> sub_type <span class="hljs-built_in">text</span> <span class="hljs-built_in">character</span> <span class="hljs-keyword">set</span> utf8
<span class="hljs-keyword">external</span> <span class="hljs-keyword">name</span> <span class="hljs-string">'JsonUtils!getJson'</span>
<span class="hljs-keyword">engine</span> udr;</code></pre><br>
<p>     SQL ,        ,         .         <code>IMessageMetadata</code>.      ,          ,   <br>
    Firebird.</p><br>
<blockquote><strong></strong><br>
<br>
 JSON        .<br>
   CHAR, VARCHAR  OCTETS NONE  BLOB SUB_TYPE BINARY<br>
       base64,<br>
     JSON.</blockquote><p>   :</p><br>
<pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firebird_udr_plugin</span><span class="hljs-params">(AStatus: IStatus; AUnloadFlagLocal: BooleanPtr;
  AUdrPlugin: IUdrPlugin)</span>:</span> BooleanPtr; <span class="hljs-keyword">cdecl</span>;
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//  </span>
  AUdrPlugin.registerFunction(AStatus, <span class="hljs-string">'getJson'</span>, TFunctionSimpleFactory&lt;TJsonFunction&gt;.Create());<font></font>
<font></font>
  theirUnloadFlag := AUnloadFlagLocal;<font></font>
  Result := @myUnloadFlag;<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
<p>       ,       :</p><br>
<div class="spoiler"><b class="spoiler_title">   GetJson</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-keyword">unit</span> JsonFunc;<font></font>
<font></font>
<span class="hljs-meta">{$IFDEF FPC}</span>
<span class="hljs-meta">{$MODE objfpc}</span><span class="hljs-meta">{$H+}</span>
<span class="hljs-meta">{$DEFINE DEBUGFPC}</span>
<span class="hljs-meta">{$ENDIF}</span><font></font>
<font></font>
<span class="hljs-keyword">interface</span><font></font>
<font></font>
<span class="hljs-keyword">uses</span><font></font>
  Firebird,<font></font>
  UdrFactories,<font></font>
  FbTypes,<font></font>
  FbCharsets,<font></font>
  SysUtils,<font></font>
  System.NetEncoding,<font></font>
  System.Json;<font></font>
<font></font>
<span class="hljs-comment">// *********************************************************</span>
<span class="hljs-comment">// create function GetJson (</span>
<span class="hljs-comment">//   sql_text blob sub_type text,</span>
<span class="hljs-comment">//   sql_dialect smallint not null default 3</span>
<span class="hljs-comment">// ) returns blob sub_type text character set utf8</span>
<span class="hljs-comment">// external name 'JsonUtils!getJson'</span>
<span class="hljs-comment">// engine udr;</span>
<span class="hljs-comment">// *********************************************************</span><font></font>
<font></font>
<span class="hljs-keyword">type</span><font></font>
<font></font>
  TInput = <span class="hljs-keyword">record</span><font></font>
    SqlText: ISC_QUAD;<font></font>
    SqlNull: WordBool;<font></font>
    SqlDialect: Smallint;<font></font>
    SqlDialectNull: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  InputPtr = ^TInput;<font></font>
<font></font>
  TOutput = <span class="hljs-keyword">record</span><font></font>
    Json: ISC_QUAD;<font></font>
    NullFlag: WordBool;<font></font>
  <span class="hljs-keyword">end</span>;<font></font>
<font></font>
  OutputPtr = ^TOutput;<font></font>
<font></font>
  <span class="hljs-comment">//   TSumArgsFunction.</span>
  <span class="hljs-title">TJsonFunction</span> = <span class="hljs-keyword">class</span>(IExternalFunctionImpl)
  <span class="hljs-keyword">public</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">getCharSet</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AName: PAnsiChar; ANameSize: Cardinal)</span>;</span> <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-comment">{        

      @param(AValue )
      @param(Scale )
      @returns(   )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MakeScaleInteger</span><span class="hljs-params">(AValue: Int64; Scale: Smallint)</span>:</span> <span class="hljs-keyword">string</span>;<font></font>
<font></font>
    <span class="hljs-comment">{       Json

      @param(AStatus  )
      @param(AContext    )
      @param(AJson   Json)
      @param(ABuffer  )
      @param(AMeta  )
      @param(AFormatSetting     )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">writeJson</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AJson: TJsonArray; ABuffer: PByte; AMeta: IMessageMetadata;
      AFormatSettings: TFormatSettings)</span>;</span><font></font>
<font></font>
    <span class="hljs-comment">{   

      @param(AStatus  )
      @param(AContext    )
      @param(AInMsg    )
      @param(AOutMsg    )
    }</span>
    <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
      AInMsg: Pointer; AOutMsg: Pointer)</span>;</span> <span class="hljs-keyword">override</span>;
  <span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>  <code>MakeScaleInteger</code>       ,  <code>writeJson</code>        Json        .     ,      <code>execute</code>    .</p><br>
<div class="spoiler"><b class="spoiler_title">TJsonFunction.execute</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TJsonFunction</span>.<span class="hljs-title">execute</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AInMsg, AOutMsg: Pointer)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  xFormatSettings: TFormatSettings;<font></font>
  xInput: InputPtr;<font></font>
  xOutput: OutputPtr;<font></font>
  att: IAttachment;<font></font>
  tra: ITransaction;<font></font>
  stmt: IStatement;<font></font>
  inBlob, outBlob: IBlob;<font></font>
  inStream: TBytesStream;<font></font>
  outStream: TStringStream;<font></font>
  cursorMetaData: IMessageMetadata;<font></font>
  rs: IResultSet;<font></font>
  msgLen: Cardinal;<font></font>
  msg: Pointer;<font></font>
  jsonArray: TJsonArray;<font></font>
<span class="hljs-keyword">begin</span><font></font>
  xInput := AInMsg;<font></font>
  xOutput := AOutMsg;<font></font>
  <span class="hljs-comment">//      NULL,    NULL</span>
  <span class="hljs-keyword">if</span> xInput.SqlNull <span class="hljs-keyword">or</span> xInput.SqlDialectNull <span class="hljs-keyword">then</span>
  <span class="hljs-keyword">begin</span><font></font>
    xOutput.NullFlag := True;<font></font>
    <span class="hljs-keyword">Exit</span>;
  <span class="hljs-keyword">end</span>;<font></font>
  xOutput.NullFlag := False;<font></font>
  <span class="hljs-comment">//     </span><font></font>
  xFormatSettings := TFormatSettings.Create;<font></font>
  xFormatSettings.DateSeparator := <span class="hljs-string">'-'</span>;<font></font>
  xFormatSettings.TimeSeparator := <span class="hljs-string">':'</span>;
  <span class="hljs-comment">//      blob</span>
  inStream := TBytesStream.Create(<span class="hljs-keyword">nil</span>);<font></font>
  outStream := TStringStream.Create(<span class="hljs-string">''</span>, <span class="hljs-number">65001</span>);<font></font>
  jsonArray := TJsonArray.Create;<font></font>
  <span class="hljs-comment">//     </span><font></font>
  att := AContext.getAttachment(AStatus);<font></font>
  tra := AContext.getTransaction(AStatus);<font></font>
  stmt := <span class="hljs-keyword">nil</span>;<font></font>
  inBlob := <span class="hljs-keyword">nil</span>;<font></font>
  outBlob := <span class="hljs-keyword">nil</span>;
  <span class="hljs-keyword">try</span>
    <span class="hljs-comment">//  BLOB  </span>
    inBlob := att.openBlob(AStatus, tra, @xInput.SqlText, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);<font></font>
    inBlob.SaveToStream(AStatus, inStream);<font></font>
    inBlob.close(AStatus);<font></font>
    <span class="hljs-comment">//  </span>
    stmt := att.prepare(AStatus, tra, inStream.Size, @inStream.Bytes[<span class="hljs-number">0</span>],<font></font>
      xInput.SqlDialect, IStatement.PREPARE_PREFETCH_METADATA);<font></font>
    <span class="hljs-comment">//    </span><font></font>
    cursorMetaData := stmt.getOutputMetadata(AStatus);<font></font>
    <span class="hljs-comment">//  </span>
    rs := stmt.openCursor(AStatus, tra, <span class="hljs-keyword">nil</span>, <span class="hljs-keyword">nil</span>, <span class="hljs-keyword">nil</span>, <span class="hljs-number">0</span>);
    <span class="hljs-comment">//    </span><font></font>
    msgLen := cursorMetaData.getMessageLength(AStatus);<font></font>
    msg := AllocMem(msgLen);<font></font>
    <span class="hljs-keyword">try</span>
      <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">while</span> rs.fetchNext(AStatus, msg) = IStatus.RESULT_OK <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">begin</span>
        <span class="hljs-comment">//     JSON</span><font></font>
        writeJson(AStatus, AContext, jsonArray, msg, cursorMetaData, xFormatSettings);<font></font>
      <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">finally</span>
      <span class="hljs-comment">//  </span><font></font>
      FreeMem(msg);<font></font>
    <span class="hljs-keyword">end</span>;
    <span class="hljs-comment">//  </span><font></font>
    rs.close(AStatus);<font></font>
    <span class="hljs-comment">//  JSON  </span><font></font>
    outStream.WriteString(jsonArray.ToJSON);<font></font>
<font></font>
    <span class="hljs-comment">//  json   blob</span>
    outBlob := att.createBlob(AStatus, tra, @xOutput.Json, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);<font></font>
    outBlob.LoadFromStream(AStatus, outStream);<font></font>
    outBlob.close(AStatus);<font></font>
  <span class="hljs-keyword">finally</span>
    <span class="hljs-keyword">if</span> Assigned(inBlob) <span class="hljs-keyword">then</span><font></font>
      inBlob.release;<font></font>
    <span class="hljs-keyword">if</span> Assigned(stmt) <span class="hljs-keyword">then</span><font></font>
      stmt.release;<font></font>
    <span class="hljs-keyword">if</span> Assigned(outBlob) <span class="hljs-keyword">then</span><font></font>
      outBlob.release;<font></font>
    tra.release;<font></font>
    att.release;<font></font>
    jsonArray.Free;<font></font>
    inStream.Free;<font></font>
    outStream.Free;<font></font>
  <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<p>               <code>getAttachment</code>  <code>getTransaction</code>  <code>IExternalContext</code>.    BLOB    SQL .      prepare  <code>IAttachment</code>.    SQL       .     <code>IStatement.PREPARE_PREFETCH_METADATA</code>,             .         <code>getOutputMetadata</code>  <code>IStatement</code>.</p><br>
<blockquote><strong></strong><br>
<br>
    getOutputMetadata      .<br>
 <code>IStatement.PREPARE_PREFETCH_METADATA</code>    <br>
       .    <br>
        ,    .</blockquote><p>      openCursor     ( 2).           <code>getMessageLength</code>  <code>IMessageMetadata</code>.      ,         .</p><br>
<p>      <code>fetchNext</code>  <code>IResultSet</code>.     <code>msg</code>      <code>IStatus.RESULT_OK</code>   ,     .       <code>writeJson</code>,     <code>TJsonObject</code>       <code>TJsonArray</code>.</p><br>
<p>    ,    <code>close</code>,   Json   ,     ,     Blob.</p><br>
<p>   <code>writeJson</code>.  <code>IUtil</code>    ,        .               <code>IMessageMetadata</code>.      <code>TJsonObject</code>        .          .   NullFlag,    null       ,            Json.</p><br>
<div class="spoiler"><b class="spoiler_title"> writeJson</b><div class="spoiler_text"><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TJsonFunction</span>.<span class="hljs-title">MakeScaleInteger</span><span class="hljs-params">(AValue: Int64; Scale: Smallint)</span>:</span> <span class="hljs-keyword">string</span>;
<span class="hljs-keyword">var</span><font></font>
  L: Integer;<font></font>
<span class="hljs-keyword">begin</span><font></font>
  Result := AValue.ToString;<font></font>
  L := Result.Length;<font></font>
  <span class="hljs-keyword">if</span> (-Scale &gt;= L) <span class="hljs-keyword">then</span>
    Result := <span class="hljs-string">'0.'</span> + Result.PadLeft(-Scale, <span class="hljs-string">'0'</span>)
  <span class="hljs-keyword">else</span>
    Result := Result.Insert(Scale + L, <span class="hljs-string">'.'</span>);
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">TJsonFunction</span>.<span class="hljs-title">writeJson</span><span class="hljs-params">(AStatus: IStatus; AContext: IExternalContext;
  AJson: TJsonArray; ABuffer: PByte; AMeta: IMessageMetadata;
  AFormatSettings: TFormatSettings)</span>;</span>
<span class="hljs-keyword">var</span><font></font>
  jsonObject: TJsonObject;<font></font>
  i: Integer;<font></font>
  FieldName: <span class="hljs-keyword">string</span>;<font></font>
  NullFlag: WordBool;<font></font>
  pData: PByte;<font></font>
  util: IUtil;<font></font>
  metaLength: Integer;<font></font>
  <span class="hljs-comment">// </span>
  CharBuffer: <span class="hljs-keyword">array</span> [<span class="hljs-number">0</span> .. <span class="hljs-number">35766</span>] <span class="hljs-keyword">of</span> Byte;<font></font>
  charLength: Smallint;<font></font>
  charset: TFBCharSet;<font></font>
  StringValue: <span class="hljs-keyword">string</span>;<font></font>
  SmallintValue: Smallint;<font></font>
  IntegerValue: Integer;<font></font>
  BigintValue: Int64;<font></font>
  Scale: Smallint;<font></font>
  SingleValue: Single;<font></font>
  DoubleValue: Double;<font></font>
  BooleanValue: Boolean;<font></font>
  DateValue: ISC_DATE;<font></font>
  TimeValue: ISC_TIME;<font></font>
  TimestampValue: ISC_TIMESTAMP;<font></font>
  DateTimeValue: TDateTime;<font></font>
  year, month, day: Cardinal;<font></font>
  hours, minutes, seconds, fractions: Cardinal;<font></font>
  blobId: ISC_QUADPtr;<font></font>
  BlobSubtype: Smallint;<font></font>
  blob: IBlob;<font></font>
  textStream: TStringStream;<font></font>
  binaryStream: TBytesStream;<font></font>
  att: IAttachment;<font></font>
  tra: ITransaction;<font></font>
<span class="hljs-keyword">begin</span>
  <span class="hljs-comment">//  IUtil</span><font></font>
  util := AContext.getMaster().getUtilInterface();<font></font>
  <span class="hljs-comment">//   TJsonObject   </span>
  <span class="hljs-comment">//    </span><font></font>
  jsonObject := TJsonObject.Create;<font></font>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> AMeta.getCount(AStatus) - <span class="hljs-number">1</span> <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">begin</span>
    <span class="hljs-comment">//     </span><font></font>
    FieldName := AMeta.getAlias(AStatus, i);<font></font>
    NullFlag := PWordBool(ABuffer + AMeta.getNullOffset(AStatus, i))^;<font></font>
    <span class="hljs-keyword">if</span> NullFlag <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">begin</span>
      <span class="hljs-comment">//  NULL    JSON     </span><font></font>
      jsonObject.AddPair(FieldName, TJsonNull.Create);<font></font>
      <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-comment">//     </span><font></font>
    pData := ABuffer + AMeta.getOffset(AStatus, i);<font></font>
    <span class="hljs-keyword">case</span> TFBType(AMeta.getType(AStatus, i)) <span class="hljs-keyword">of</span>
      <span class="hljs-comment">// VARCHAR</span><font></font>
      SQL_VARYING:<font></font>
        <span class="hljs-keyword">begin</span>
          <span class="hljs-comment">//    VARCHAR</span><font></font>
          metaLength := AMeta.getLength(AStatus, i);<font></font>
          charset := TFBCharSet(AMeta.getCharSet(AStatus, i));<font></font>
          <span class="hljs-comment">//  VARCHAR  2  - </span><font></font>
          charLength := PSmallint(pData)^;<font></font>
          <span class="hljs-comment">//     base64</span>
          <span class="hljs-keyword">if</span> charset = CS_BINARY <span class="hljs-keyword">then</span>
            StringValue := TNetEncoding.Base64.EncodeBytesToString((pData + <span class="hljs-number">2</span>),<font></font>
              charLength)<font></font>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span>
            <span class="hljs-comment">//       3 </span>
            Move((pData + <span class="hljs-number">2</span>)^, CharBuffer, metaLength - <span class="hljs-number">2</span>);<font></font>
            StringValue := charset.GetString(TBytes(@CharBuffer), <span class="hljs-number">0</span>,<font></font>
              charLength * charset.GetCharWidth)<font></font>
            SetLength(StringValue, charLength);<font></font>
          <span class="hljs-keyword">end</span>;<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// CHAR</span><font></font>
      SQL_TEXT:<font></font>
        <span class="hljs-keyword">begin</span>
          <span class="hljs-comment">//    CHAR</span><font></font>
          metaLength := AMeta.getLength(AStatus, i);<font></font>
          charset := TFBCharSet(AMeta.getCharSet(AStatus, i));<font></font>
          <span class="hljs-comment">//     base64</span>
          <span class="hljs-keyword">if</span> charset = CS_BINARY <span class="hljs-keyword">then</span>
            StringValue := TNetEncoding.Base64.EncodeBytesToString((pData + <span class="hljs-number">2</span>),<font></font>
              metaLength)<font></font>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span>
            <span class="hljs-comment">//    </span><font></font>
            Move(pData^, CharBuffer, metaLength);<font></font>
            StringValue := charset.GetString(TBytes(@CharBuffer), <span class="hljs-number">0</span>,<font></font>
              metaLength);<font></font>
            charLength := metaLength <span class="hljs-keyword">div</span> charset.GetCharWidth;<font></font>
            SetLength(StringValue, charLength);<font></font>
          <span class="hljs-keyword">end</span>;<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// FLOAT</span><font></font>
      SQL_FLOAT:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          SingleValue := PSingle(pData)^;<font></font>
          jsonObject.AddPair(FieldName, TJSONNumber.Create(SingleValue));<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// DOUBLE PRECISION</span>
      <span class="hljs-comment">// DECIMAL(p, s),  p = 10..15  1 </span><font></font>
      SQL_DOUBLE, SQL_D_FLOAT:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          DoubleValue := PDouble(pData)^;<font></font>
          jsonObject.AddPair(FieldName, TJSONNumber.Create(DoubleValue));<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// INTEGER</span>
      <span class="hljs-comment">// NUMERIC(p, s),  p = 1..4</span><font></font>
      SQL_SHORT:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          Scale := AMeta.getScale(AStatus, i);<font></font>
          SmallintValue := PSmallint(pData)^;<font></font>
          <span class="hljs-keyword">if</span> (Scale = <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">begin</span><font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(SmallintValue));<font></font>
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span><font></font>
            StringValue := MakeScaleInteger(SmallintValue, Scale);<font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(StringValue));<font></font>
          <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// INTEGER</span>
      <span class="hljs-comment">// NUMERIC(p, s),  p = 5..9</span>
      <span class="hljs-comment">// DECIMAL(p, s),  p = 1..9</span><font></font>
      SQL_LONG:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          Scale := AMeta.getScale(AStatus, i);<font></font>
          IntegerValue := PInteger(pData)^;<font></font>
          <span class="hljs-keyword">if</span> (Scale = <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">begin</span><font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(IntegerValue));<font></font>
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span><font></font>
            StringValue := MakeScaleInteger(IntegerValue, Scale);<font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(StringValue));<font></font>
          <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// BIGINT</span>
      <span class="hljs-comment">// NUMERIC(p, s),  p = 10..18  3 </span>
      <span class="hljs-comment">// DECIMAL(p, s),  p = 10..18  3 </span><font></font>
      SQL_INT64:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          Scale := AMeta.getScale(AStatus, i);<font></font>
          BigintValue := Pint64(pData)^;<font></font>
          <span class="hljs-keyword">if</span> (Scale = <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">begin</span><font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(BigintValue));<font></font>
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span><font></font>
            StringValue := MakeScaleInteger(BigintValue, Scale);<font></font>
            jsonObject.AddPair(FieldName, TJSONNumber.Create(StringValue));<font></font>
          <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// TIMESTAMP</span><font></font>
      SQL_TIMESTAMP:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          TimestampValue := PISC_TIMESTAMP(pData)^;<font></font>
          <span class="hljs-comment">//    -</span><font></font>
          util.decodeDate(TimestampValue.date, @year, @month, @day);<font></font>
          util.decodeTime(TimestampValue.time, @hours, @minutes, @seconds,<font></font>
            @fractions);<font></font>
          <span class="hljs-comment">//  -    Delphi</span><font></font>
          DateTimeValue := EncodeDate(year, month, day) +<font></font>
            EncodeTime(hours, minutes, seconds, fractions <span class="hljs-keyword">div</span> <span class="hljs-number">10</span>);
          <span class="hljs-comment">//  -   </span>
          StringValue := FormatDateTime(<span class="hljs-string">'yyyy/mm/dd hh:nn:ss'</span>, DateTimeValue,<font></font>
            AFormatSettings);<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// DATE</span><font></font>
      SQL_DATE:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          DateValue := PISC_DATE(pData)^;<font></font>
          <span class="hljs-comment">//    </span><font></font>
          util.decodeDate(DateValue, @year, @month, @day);<font></font>
          <span class="hljs-comment">//      Delphi</span><font></font>
          DateTimeValue := EncodeDate(year, month, day);<font></font>
          <span class="hljs-comment">//     </span>
          StringValue := FormatDateTime(<span class="hljs-string">'yyyy/mm/dd'</span>, DateTimeValue,<font></font>
            AFormatSettings);<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// TIME</span><font></font>
      SQL_TIME:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          TimeValue := PISC_TIME(pData)^;<font></font>
          <span class="hljs-comment">//    </span><font></font>
          util.decodeTime(TimeValue, @hours, @minutes, @seconds, @fractions);<font></font>
          <span class="hljs-comment">//      Delphi</span><font></font>
          DateTimeValue := EncodeTime(hours, minutes, seconds,<font></font>
            fractions <span class="hljs-keyword">div</span> <span class="hljs-number">10</span>);
          <span class="hljs-comment">//     </span>
          StringValue := FormatDateTime(<span class="hljs-string">'hh:nn:ss'</span>, DateTimeValue,<font></font>
            AFormatSettings);<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// BOOLEAN</span><font></font>
      SQL_BOOLEAN:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          BooleanValue := PBoolean(pData)^;<font></font>
          jsonObject.AddPair(FieldName, TJsonBool.Create(BooleanValue));<font></font>
        <span class="hljs-keyword">end</span>;
      <span class="hljs-comment">// BLOB</span><font></font>
      SQL_BLOB, SQL_QUAD:<font></font>
        <span class="hljs-keyword">begin</span><font></font>
          BlobSubtype := AMeta.getSubType(AStatus, i);<font></font>
          blobId := ISC_QUADPtr(pData);<font></font>
          att := AContext.getAttachment(AStatus);<font></font>
          tra := AContext.getTransaction(AStatus);<font></font>
          blob := att.openBlob(AStatus, tra, blobId, <span class="hljs-number">0</span>, <span class="hljs-keyword">nil</span>);
          <span class="hljs-keyword">if</span> BlobSubtype = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span>
          <span class="hljs-keyword">begin</span>
            <span class="hljs-comment">// </span><font></font>
            charset := TFBCharSet(AMeta.getCharSet(AStatus, i));<font></font>
            <span class="hljs-comment">//     </span>
            textStream := TStringStream.Create(<span class="hljs-string">''</span>, charset.GetCodePage);
            <span class="hljs-keyword">try</span><font></font>
              blob.SaveToStream(AStatus, textStream);<font></font>
              StringValue := textStream.DataString;<font></font>
            <span class="hljs-keyword">finally</span><font></font>
              textStream.Free;<font></font>
              blob.release;<font></font>
              tra.release;<font></font>
              att.release<font></font>
            <span class="hljs-keyword">end</span>;
          <span class="hljs-keyword">end</span>
          <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">begin</span>
            <span class="hljs-comment">//     </span><font></font>
            binaryStream := TBytesStream.Create;<font></font>
            <span class="hljs-keyword">try</span><font></font>
              blob.SaveToStream(AStatus, binaryStream);<font></font>
              <span class="hljs-comment">//    base64</span><font></font>
              StringValue := TNetEncoding.Base64.EncodeBytesToString<font></font>
                (binaryStream.Memory, binaryStream.Size);<font></font>
            <span class="hljs-keyword">finally</span><font></font>
              binaryStream.Free;<font></font>
              blob.release;<font></font>
              tra.release;<font></font>
              att.release<font></font>
            <span class="hljs-keyword">end</span>;
          <span class="hljs-keyword">end</span>;<font></font>
          jsonObject.AddPair(FieldName, StringValue);<font></font>
        <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">end</span>;
  <span class="hljs-keyword">end</span>;
  <span class="hljs-comment">//     Json  </span><font></font>
  AJson.AddElement(jsonObject);<font></font>
<span class="hljs-keyword">end</span>;</code></pre></div></div><br>
<blockquote><strong></strong><br>
<br>
  TFbType     <code>Firebird.pas</code>.<br>
     ,     <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">FbTypes</a>        .<br>
<br>
 TFBCharSet     <code>Firebird.pas</code>.<br>
   <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">FbCharsets</a>     .  ,    <br>
 ,      <br>
  ,  ,    ,<br>
  <code>TEncoding</code>   ,    <br>
      Delphi.</blockquote><p>   CHAR  VARCHAR  ,    OCTETS,     base64,          Delphi.  ,    VARCHAR  2      .</p><br>
<p> SMALLINT, INTEGER, BIGINT      ,  .      <code>getScale</code>  <code>IMessageMetadata</code>.     0,     ,    <code>MakeScaleInteger</code>.</p><br>
<p> DATE, TIME  TIMESTAMP           <code>decodeDate</code>  <code>decodeTime</code>  <code>IUtil</code>.        -   Delphi  <code>TDateTime</code>.</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delphiã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€šã˜ã¦BLOBå‹ã‚’æ“ä½œã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">BLOBãŒãƒã‚¤ãƒŠãƒªã®å ´åˆã€ã‚¿ã‚¤ãƒ—ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™</font></font><code>TBytesStream</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">çµæœã®ãƒã‚¤ãƒˆé…åˆ—ã¯ã€base64ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">BLOBãŒãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯</font></font><code>TStringStream</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€æ–‡å­—åˆ—</font><font style="vertical-align: inherit;">ç”¨ã®ç‰¹æ®Šãªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½¿ç”¨</font><font style="vertical-align: inherit;">ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">BLOB </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®</font><font style="vertical-align: inherit;">ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã‚Œã§å…¨éƒ¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">å¿…è¦ã«å¿œã˜ã¦ã€ç§ã®è¨˜äº‹ãŒFirebirdç”¨ã®UDRã®è¨˜è¿°ã«å½¹ç«‹ã¤ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja455361/index.html">è©¦é¨“ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µã‚’ä½œæˆã—ã¾ã™</a></li>
<li><a href="../ja455367/index.html">VueJs + MVCæœ€å°ã‚³ãƒ¼ãƒ‰æœ€å¤§æ©Ÿèƒ½</a></li>
<li><a href="../ja455369/index.html">è¨˜å¿µæ—¥DevConfXï¼ˆ6æœˆ21ã€œ22æ—¥ã€ãƒ¢ã‚¹ã‚¯ãƒ¯ï¼‰ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†è€…ãªã©ã®èªå®š</a></li>
<li><a href="../ja455371/index.html">5Î¼Aã‹ã‚‰20 mAã¾ã§ã®å®‰å®šã—ãŸé›»æµæº</a></li>
<li><a href="../ja455373/index.html">å°è¦æ¨¡ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å‘ã‘ã«æ˜‡æ ¼ã™ã‚‹ã‚ˆã†ã«æ˜¥ã®æ³•å‰‡ã‚’èª¿æ•´ã™ã‚‹æ–¹æ³•ã¯ï¼Ÿã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</a></li>
<li><a href="../ja455377/index.html">IoTã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
<li><a href="../ja455379/index.html">ï¼ˆé™çš„ï¼‰C ++ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã®æœ€é©ãªã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã®é¸æŠ</a></li>
<li><a href="../ja455381/index.html">3CXãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆã®å¿œç­”ï¼šPBXã‚µãƒ¼ãƒãƒ¼ã§ã®SIPãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã‚­ãƒ£ãƒ—ãƒãƒ£</a></li>
<li><a href="../ja455387/index.html">Elastic Stackã§ã®æ©Ÿæ¢°å­¦ç¿’ã®ç†è§£ï¼ˆElasticsearchã€åˆ¥åELKï¼‰</a></li>
<li><a href="../ja455389/index.html">Haxe 4ï¼šæ–°æ©Ÿèƒ½</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>