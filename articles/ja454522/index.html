<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🔬 😀 👌 Node.js：コンテナーで実行されているアプリケーションで利用可能なメモリの管理 👨🏽‍🏭 🎱 👌🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DockerコンテナでNode.jsアプリケーションを実行すると、従来のメモリ設定が期待どおりに機能しない場合があります。本日翻訳する資料は、なぜそうなのかという疑問に対する答えを見つけることに専念しています。また、コンテナで実行されているNode.jsアプリケーションで利用可能なメモリを管理するた...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Node.js：コンテナーで実行されているアプリケーションで利用可能なメモリの管理</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/454522/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DockerコンテナでNode.jsアプリケーションを実行すると、従来のメモリ設定が期待どおりに機能しない場合があります。</font><font style="vertical-align: inherit;">本日翻訳する資料は、なぜそうなのかという疑問に対する答えを見つけることに専念しています。</font><font style="vertical-align: inherit;">また、コンテナで実行されているNode.jsアプリケーションで利用可能なメモリを管理するための実用的な推奨事項も提供します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/9_/rp/-s/9_rp-s7libv7ncp6mubs2h_qjzu.png"></a><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推奨事項のレビュー</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node.jsアプリケーションが、メモリ制限が設定されたコンテナーで実行されているとします。 Dockerの場合は、この制限を設定するオプションを使用できます</font></font><code>--memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。コンテナーオーケストレーションシステムを使用する場合も、同様のことが可能です。この場合、Node.jsアプリケーションの起動時にオプションを使用することをお勧めします</font></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これにより、プラットフォームで使用可能なメモリの量をプラットフォームに通知し、この量がコンテナレベルで設定された制限よりも少ないことを考慮することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node.jsアプリケーションがコンテナー内で実行されている場合、アプリケーションが使用できるアクティブなメモリーのピーク値に従って、アプリケーションが使用できるメモリーの容量を設定します。これは、コンテナーのメモリー制限を構成できる場合に行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コンテナーでのメモリーの使用の問題について詳しく説明します。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerメモリ制限</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、コンテナにはリソースの制限がなく、オペレーティングシステムが許可する限りのメモリを使用できます。</font><font style="vertical-align: inherit;">コマンドに</font></font><code>docker run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、メモリまたはプロセッサリソースの使用に関する制限を設定できるコマンドラインオプションがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナの起動コマンドは次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory &lt;x&gt;&lt;y&gt; --interactive --tty &lt;imagename&gt; bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の点に注意してください：</font></font><br>
<br>
<ul>
<li><code>x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これは、測定単位で表された、コンテナで使用可能なメモリ量の制限です</font></font><code>y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><code>y</code><font style="vertical-align: inherit;"></font><code>b</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（バイト）、</font></font><code>k</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（キロバイト）、</font></font><code>m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（メガバイト）、</font></font><code>g</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ギガバイト）</font><font style="vertical-align: inherit;">の値を取ることができます</font><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナー起動コマンドの例を次に示します。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory <span class="hljs-number">1000000</span>b --interactive --tty &lt;imagename&gt; bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、メモリ制限が</font></font><code>1000000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイトに</font><font style="vertical-align: inherit;">設定されてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナーレベルで設定されたメモリ制限を確認するには、コンテナーで次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="javascript hljs">cat /sys/fs/cgroup/memory/memory.limit_in_bytes</code></pre><br><font style="vertical-align: inherit;"></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ制限</font><font style="vertical-align: inherit;">
キーを使用して</font><font style="vertical-align: inherit;">Node.jsアプリケーション</font><font style="vertical-align: inherit;">を指定するときのシステムの動作について説明します</font><font style="vertical-align: inherit;">。この場合、このメモリ制限はコンテナレベルで設定された制限に対応します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キー名で「古いスペース」と呼ばれるものは、V8によって制御されるヒープのフラグメントの1つです（「古い」JavaScriptオブジェクトが配置される場所）。このキーは、以下で説明する詳細に進まない場合、最大ヒープサイズを制御します。 Node.jsコマンドラインスイッチの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、アプリケーションがコンテナで利用可能なメモリよりも多くのメモリを使用しようとすると、その操作は終了します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の例（アプリケーションファイルはと呼ばれます</font></font><code>test-fatal-error.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）では、配列に</font></font><code>list</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、10ミリ秒の間隔でオブジェクトを配置します</font></font><code>MyRecord</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、制御されていないヒープの増加につながり、メモリリークをシミュレートします。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">const</span> list = [];<font></font>
setInterval(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span> {
 &nbsp;<span class="hljs-keyword">const</span> record = <span class="hljs-keyword">new</span> MyRecord();<font></font>
 &nbsp;list.push(record);<font></font>
},<span class="hljs-number">10</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MyRecord</span>(<span class="hljs-params"></span>) </span>{
 &nbsp;<span class="hljs-keyword">var</span> x=<span class="hljs-string">'hii'</span>;
 &nbsp;<span class="hljs-keyword">this</span>.name = x.repeat(<span class="hljs-number">10000000</span>);
 &nbsp;<span class="hljs-keyword">this</span>.id = x.repeat(<span class="hljs-number">10000000</span>);
 &nbsp;<span class="hljs-keyword">this</span>.account = x.repeat(<span class="hljs-number">10000000</span>);<font></font>
}<font></font>
setInterval(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span> {
 &nbsp;<span class="hljs-built_in">console</span>.log(process.memoryUsage())<font></font>
},<span class="hljs-number">100</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで説明するプログラムの例はすべて、Docker HubからダウンロードできるDockerイメージに配置されています。</font></font><br>
<br>
<pre><code class="javascript hljs">docker pull ravali1906/dockermemory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この画像は、独立した実験に使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、アプリケーションをDockerコンテナーにパックし、イメージを収集して、メモリー制限付きで実行できます。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory <span class="hljs-number">512</span>m --interactive --tty ravali1906/dockermemory bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これ</font></font><code>ravali1906/dockermemory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が画像の名前です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、コンテナの制限を超えるメモリ制限を指定して、アプリケーションを実行できます。</font></font><br>
<br>
<pre><code class="javascript hljs">$ node --max_old_space_size=<span class="hljs-number">1024</span> test-fatal-error.js<font></font>
{ <span class="hljs-attr">rss</span>: <span class="hljs-number">550498304</span>,
<span class="hljs-attr">heapTotal</span>: <span class="hljs-number">1090719744</span>,
<span class="hljs-attr">heapUsed</span>: <span class="hljs-number">1030627104</span>,
<span class="hljs-attr">external</span>: <span class="hljs-number">8272</span> }<font></font>
Killed</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、キー</font></font><code>--max_old_space_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はメガバイトで示されるメモリ制限を表します。</font><font style="vertical-align: inherit;">このメソッド</font></font><code>process.memoryUsage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、メモリ使用量に関する情報を提供します。</font><font style="vertical-align: inherit;">値はバイトで表されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある時点でアプリケーションが強制終了されます。</font><font style="vertical-align: inherit;">これが使用するメモリの量が特定の境界を越えると発生します。</font><font style="vertical-align: inherit;">この境界は何ですか？</font><font style="vertical-align: inherit;">話し合うことができるメモリの制限は何ですか？</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーで実行されているアプリケーションの予想される動作は-max-old-space-size</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、Node.js（バージョン11.xまで）の最大ヒープサイズは、32ビットプラットフォームでは700 MB、64ビットプラットフォームでは1400 MBです。</font><font style="vertical-align: inherit;">これらの値の設定については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的に</font></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、コンテナーのメモリ制限を超える</font><font style="vertical-align: inherit;">キー</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">メモリ制限</font><font style="vertical-align: inherit;">を設定した場合</font><font style="vertical-align: inherit;">、アプリケーションはLinux OOM Killerカーネルカーネルセキュリティメカニズムによって終了することが期待できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、これは起こらないかもしれません。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーで実行されているアプリケーションの実際の動作はmax-old-space-sizeです</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションは、起動直後は、すべてのメモリを割り当てません</font></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その上限はで示され</font><font style="vertical-align: inherit;">ます。 JavaScriptヒープのサイズは、アプリケーションのニーズによって異なります。アプリケーションが使用するメモリのサイズは</font></font><code>heapUsed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メソッドが返すオブジェクト</font><font style="vertical-align: inherit;">のフィールドの値によって判断できます</font></font><code>process.memoryUsage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。実際、オブジェクトのヒープに割り当てられたメモリについて話している。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、</font></font><code>--memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナーの起動時に</font><font style="vertical-align: inherit;">ヒープサイズがキーによって設定された制限より大きい場合、アプリケーションは強制的に終了されるという結論に達しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、実際にはこれも起こらないかもしれません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定のメモリ制限のあるコンテナで実行される、リソースを大量に消費するNode.jsアプリケーションをプロファイリングすると、次のパターンが観察されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値際にOOMキラーは、ずっと後にモーメントよりトリガさ</font></font><code>heapTotal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とは</font></font><code>heapUsed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大幅にメモリの量に制限を超えたことが判明します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OOM Killerは制限を超えても応答しません。</font></font></li>
</ol><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナー内のNode.jsアプリケーションの動作の説明</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナーは、コンテナー上で実行されるアプリケーションの1つの重要なインジケーターを監視します。</font><font style="vertical-align: inherit;">これは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（常駐セットサイズ）。</font><font style="vertical-align: inherit;">このインジケーターは、アプリケーションの仮想メモリの特定の部分を表します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、アプリケーションに割り当てられるのはメモリの一部です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それだけではありません。</font><font style="vertical-align: inherit;">RSSは、アプリケーションに割り当てられたアクティブなメモリの一部です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションに割り当てられたすべてのメモリがアクティブであるとは限りません。</font><font style="vertical-align: inherit;">「割り当てられたメモリ」は、プロセスが実際に使用し始めるまで必ずしも物理的に割り当てられるわけではないというのが事実です。</font><font style="vertical-align: inherit;">さらに、オペレーティングシステムは、他のプロセスからのメモリ割り当ての要求に応じて、アプリケーションメモリの非アクティブな部分をページファイルにダンプし、解放されたスペースを他のプロセスに転送できます。</font><font style="vertical-align: inherit;">そして、アプリケーションが再びこれらのメモリを必要とすると、それらはスワップファイルから取得され、物理メモリに戻されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RSSメトリックは、アプリケーションのアドレススペース内のアクティブで使用可能なメモリの量を示します。</font><font style="vertical-align: inherit;">アプリケーションの強制シャットダウンの決定に影響を与えるのは彼です。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の証明</font></font></font></h2><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍例1。</font><font style="vertical-align: inherit;">バッファにメモリを割り当てるアプリケーション</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の例で</font></font><code>buffer_example.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、バッファにメモリを割り当てるプログラムを示しています。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> buf = Buffer.alloc(+process.argv[<span class="hljs-number">2</span>] * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(buf.length / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(process.memoryUsage().rss / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムによって割り当てられたメモリの量が、コンテナの起動時に設定された制限を超えるようにするには、まず次のコマンドでコンテナを実行します。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory <span class="hljs-number">1024</span>m --interactive --tty ravali1906/dockermemory bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、プログラムを実行します。</font></font><br>
<br>
<pre><code class="javascript hljs">$ node buffer_example <span class="hljs-number">2000</span>
<span class="hljs-number">2000</span>
<span class="hljs-number">16</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、プログラムによって割り当てられたメモリもコンテナの制限を超えましたが、システムはプログラムを完了しませんでした。</font><font style="vertical-align: inherit;">これは、プログラムが割り当てられたすべてのメモリで機能しないために発生しました。</font><font style="vertical-align: inherit;">RSSインデックスは非常に小さく、コンテナのメモリ制限を超えません。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍例2。</font><font style="vertical-align: inherit;">バッファにデータを入力するアプリケーション</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の例では、</font></font><code>buffer_example_fill.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリは割り当てられているだけでなく、データで埋められています。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> buf = Buffer.alloc(+process.argv[<span class="hljs-number">2</span>] * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,<span class="hljs-string">'x'</span>)
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(buf.length / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(process.memoryUsage().rss / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナを実行します。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory <span class="hljs-number">1024</span>m --interactive --tty ravali1906/dockermemory bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、アプリケーションを実行します。</font></font><br>
<br>
<pre><code class="javascript hljs">$ node buffer_example_fill.js <span class="hljs-number">2000</span>
<span class="hljs-number">2000</span>
<span class="hljs-number">984</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやら、今でもアプリケーションは終了しません！どうして？実際には、アクティブなメモリの量がコンテナの起動時に設定された制限に達し、ページファイルに場所があると、プロセスメモリの古いページの一部がページファイルに移動されます。解放されたメモリは、同じプロセスで使用できます。デフォルトでは、Dockerはフラグを使用して設定されたメモリ制限に等しいスペースをスワップファイルに割り当てます</font></font><code>--memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これを考えると、プロセスには2 GBのメモリ（アクティブメモリに1 GB、スワップファイルに1 GB）があると言えます。つまり、アプリケーションは自身のメモリを使用でき、その内容は一時的にページファイルに移動されるため、RSSインジケーターのサイズはコンテナーの制限内です。その結果、アプリケーションは引き続き機能します。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍例その3。</font><font style="vertical-align: inherit;">ページングファイルが使用されていないコンテナで実行されているデータでバッファを埋めるアプリケーション</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ここで実験するコードを示します（これは同じファイルです</font></font><code>buffer_example_fill.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> buf = Buffer.alloc(+process.argv[<span class="hljs-number">2</span>] * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,<span class="hljs-string">'x'</span>)
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(buf.length / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))
<span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Math</span>.round(process.memoryUsage().rss / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回は、コンテナを実行し、スワップファイルを操作する機能を明示的に設定します。</font></font><br>
<br>
<pre><code class="javascript hljs">docker run --memory <span class="hljs-number">1024</span>m --memory-swap=<span class="hljs-number">1024</span>m --memory-swappiness=<span class="hljs-number">0</span> --interactive --tty ravali1906/dockermemory bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動します。</font></font><br>
<br>
<pre><code class="javascript hljs">$ node buffer_example_fill.js <span class="hljs-number">2000</span>
Killed</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージを参照してください</font></font><code>Killed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">キー値がキー値と</font></font><code>--memory-swap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等しい場合</font></font><code>--memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、これはコンテナにページファイルを使用しないように指示します。</font><font style="vertical-align: inherit;">さらに、デフォルトでは、コンテナー自体が実行されるオペレーティングシステムのカーネルは、コンテナーが使用する匿名メモリページの一定量をページファイルにダンプできます。</font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグを</font><font style="vertical-align: inherit;">設定すると</font></font><code>--memory-swappiness</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この機能が無効になります。</font><font style="vertical-align: inherit;">その結果、コンテナ内でスワップファイルが使用されていないことがわかります。</font><font style="vertical-align: inherit;">RSSスコアがコンテナのメモリ制限を超えると、プロセスは終了します。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な推奨事項</font></font></font></h2><br><font style="vertical-align: inherit;"></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナの起動時に設定されたメモリ制限を値が超える</font><font style="vertical-align: inherit;">
キー</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">Node.jsアプリケーションを起動すると、</font><font style="vertical-align: inherit;">Node.jsがコンテナの制限に「注意を払っていない」ように見える場合があります。ただし、前の例からわかるように、この動作の明らかな理由は、アプリケーションがフラグを使用して指定されたヒープボリューム全体を単に使用していないという事実です</font></font><code>--max-old-space-size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナーで使用可能なメモリよりも多くのメモリを使用する場合、アプリケーションは常に同じように動作するとは限らないことに注意してください。</font><font style="vertical-align: inherit;">どうして？</font><font style="vertical-align: inherit;">実際には、プロセスのアクティブメモリ（RSS）は、アプリケーション自体が影響できない多くの外部要因の影響を受けます。</font><font style="vertical-align: inherit;">それらは、システムの負荷と環境の特性に依存します。</font><font style="vertical-align: inherit;">たとえば、これらはアプリケーション自体の機能、システムの並列処理のレベル、オペレーティングシステムスケジューラの機能、ガベージコレクターの機能などです。</font><font style="vertical-align: inherit;">さらに、これらの要因は、リリースごとに変化する可能性があります。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このオプションを制御できるが、コンテナレベルのメモリ制限がない場合のNode.jsヒープのサイズ設定に関する推奨事項</font></font></font></h2><br>
<ul>
<li>  Node.js-       RSS (  ,  Node.js 10.x,   20 ).</li>
<li> Node.js     old_space,    (,  new_space, code_space,   ). ,     ,    ,      20  .     —     .</li>
<li>     (,   40 )   ,   . ,  ,   , ,       ,       <code>--max-old-space-size</code>.</li>
</ul><br>
<h2><font color="#3AC1EF">        ,     ,   Node.js- — </font></h2><br>
<ul>
<li>   ,       .</li>
<li>  RSS.  ,  ,    <code>process.memoryUsage()</code>,    Linux <code>top</code>.</li>
<li> ,   ,     ,      ,         .    ,       10%.</li>
</ul><br>
<h2><font color="#3AC1EF"></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node.js 12.xでは、利用可能なRAMの量に応じて実行されるヒープのサイズを適応的に調整することにより、ここで説明する問題のいくつかが解決されます。このメカニズムは、Node.jsアプリケーションをコンテナで実行するときにも機能します。ただし、設定はデフォルト設定と異なる場合があります。これは、たとえば、アプリケーションの起動時にキーが使用されたときに発生します</font></font><code>--max_old_space_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。そのような場合、上記のすべてが関連します。これは、コンテナでNode.jsアプリケーションを実行する場合は、メモリ設定について注意深く責任を負うべきであることを示唆しています。さらに、かなり控えめなメモリ使用量の標準的な制限の知識により、これらの制限を意図的に変更することにより、アプリケーションのパフォーマンスを向上させることができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読者の皆様！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DockerコンテナーでNode.jsアプリケーションを実行すると、メモリ不足の問題が発生しましたか？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/a09/9e4/5a8/a099e45a81c9dafd3a3673edd5ea415b.jpg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454512/index.html">チャールズウェザリーとの朝食レポート、プログラマーのためのカルトブックエチュードの著者</a></li>
<li><a href="../ja454514/index.html">ATMEGA8でのシンプルな音楽シンセサイザーの開発</a></li>
<li><a href="../ja454516/index.html">200ルーブルの良いテキストを取得する方法</a></li>
<li><a href="../ja454518/index.html">Wasmer：WebAssemblyコードを実行するための最速のGoライブラリ</a></li>
<li><a href="../ja454520/index.html">クリーンなJavaScriptコードを書くためのガイドライン</a></li>
<li><a href="../ja454524/index.html">ヘッドバンド修理プロのサムスンレベル</a></li>
<li><a href="../ja454530/index.html">DJIは映画を作成できるオクトコプターを作成しました</a></li>
<li><a href="../ja454532/index.html">エンジニアリングアプローチについて一言申し上げます</a></li>
<li><a href="../ja454534/index.html">モナドについて非科学的</a></li>
<li><a href="../ja454536/index.html">古典的な心拍数センサーへのアンプ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>