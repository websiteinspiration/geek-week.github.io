<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍛 🤦🏼 👉 在办公室的远程工作。RDP，Port Knocking，Mikrotik：简单又安全 🙇🏾 👩‍👩‍👧‍👦 👨🏿‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在许多国家中，与covid-19病毒大流行和普遍隔离有关，许多公司继续工作的唯一方法是通过Internet远程访问工作站。远程工作有许多相对安全的方法-但鉴于问题的严重性，您需要一种简单的方法让任何用户远程连接到办公室，而无需其他设置，说明，繁琐的协商和冗长的说明。此方法是许多管理员RDP（远程桌面...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>在办公室的远程工作。RDP，Port Knocking，Mikrotik：简单又安全</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495596/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在许多国家中，与covid-19病毒大流行和普遍隔离有关，许多公司继续工作的唯一方法是通过Internet远程访问工作站。远程工作有许多相对安全的方法-但鉴于问题的严重性，您需要一种简单的方法让任何用户远程连接到办公室，而无需其他设置，说明，繁琐的协商和冗长的说明。此方法是许多管理员RDP（远程桌面协议）的最爱。通过RDP直接连接到工作场所理想地解决了我们的问题，但美中不足的是-为Internet保持RDP端口开放非常不安全。因此，下面我提出一种简单但可靠的保护方法。</font></font><img src="https://habrastorage.org/webt/yv/o3/ut/yvo3utx5cj_wwte6jja-pe6swfw.jpeg" alt="图片"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 由于我经常遇到将Mikrotik设备用作Internet访问的小型组织，因此下面将说明如何在Mikrotik上实现此功能，但是端口敲入保护方法很容易在其他高级设备上实现，这些输入设备和输入路由器的设置相同防火墙</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">浅谈港口敲门</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。当所有资源和端口都被防火墙从外部关闭时，对于连接到Internet的网络的理想外部保护。而且，尽管具有这样配置的防火墙的路由器不会对来自外部的数据包做出任何反应，但它会侦听它们。因此，您可以配置路由器，以便当您在不同端口上收到某个（代码）网络数据包序列时，该路由器（路由器）用于获取来自数据包的IP地址，从而可以访问某些资源（端口，协议等）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在到了重点。</font><font style="vertical-align: inherit;">我不会在Mikrotik上进行防火墙设置的详细说明-互联网上有很多为此提供高质量的资源。</font><font style="vertical-align: inherit;">理想情况下，防火墙会阻止所有传入的数据包，但是</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=accept chain=input comment="established and related accept" connection-state=established,related</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
允许来自已建立（相关）连接的传入流量。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在在Mikrotik上配置端口敲门：</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
move [/ip firewall filter find comment=RemoteRules] 1<font></font>
/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在更多：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前两个规则</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=drop chain=input dst-port=19000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules<font></font>
add action=drop chain=input dst-port=16000 protocol=tcp src-address-list="Black_scanners" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
禁止扫描端口时将其列入黑名单的IP地址传入的数据包；</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第三条规则：</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="remote_port_1" address-list-timeout=1m chain=input dst-port=19000 protocol=tcp comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将ip添加到对所需端口进行首次正确敲打的主机列表（19000）；</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下四个规则：</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=19001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=18999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=16001 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules<font></font>
add action=add-src-to-address-list address-list="Black_scanners" address-list-timeout=60m chain=input dst-port=15999 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为想要扫描您的端口的人创建陷阱端口，当检测到此类尝试时，将其IP放入黑名单60分钟，在此期间，前两个规则将阻止此类主机敲击正确的端口；</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下规则：</font></font><br>
<br>
<pre><code class="plaintext hljs">add action=add-src-to-address-list address-list="allow_remote_users" address-list-timeout=1m chain=input dst-port=16000 protocol=tcp src-address-list="remote_port_1" comment=RemoteRules</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将ip放入允许的列表中1分钟（足以建立连接），因为第二次正确敲响到了所需的端口（16000）；</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一条命令：</font></font><br>
<br>
<pre><code class="plaintext hljs">move [/ip firewall filter find comment=RemoteRules] 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将我们的规则上移到防火墙处理链中，因为很可能我们已经配置了不同的禁止规则，这些规则将阻止我们新创建的规则起作用。 Mikrotik中的第一个规则从零开始，但是在我的设备上，内置规则占据了零，并且无法移动-我移至1。因此，我们查看设置-在这里可以移动并指定所需的数字。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下设置：</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat<font></font>
add action=dst-nat chain=dstnat comment="remote_rdp_to_33" src-address-list="allow_remote_users" dst-port=33890 in-interface-list=WAN protocol=tcp to-addresses=192.168.1.33 to-ports=3389</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将随机选择的端口33890转发到常规RDP端口3389和我们需要的计算机或终端服务器的IP。</font><font style="vertical-align: inherit;">我们为所有必要的内部资源创建此类规则，最好公开非标准（和不同）的外部端口。</font><font style="vertical-align: inherit;">自然，内部资源的ip必须是静态的或固定在DHCP服务器上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们的Mikrotik已配置完毕，我们需要一个简单的过程让用户连接到我们的内部RDP。</font><font style="vertical-align: inherit;">因为我们主要是Windows用户，所以我们创建一个简单的bat文件并将其命名为StartRDP.bat：</font></font><br>
<br>
<pre><code class="plaintext hljs">1.htm<font></font>
1.rdp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此1.htm包含以下代码：</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:19000/1.jpg"</span>&gt;</span><font></font>
       RDP<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://my_router.sn.mynetname.net:16000/2.jpg"</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 它包含两个指向虚拟图片的链接，这些图片位于地址my_router.sn.mynetname.net-我们从Mikrotik的DDNS系统获取此地址，之前已在我们的Mikrotik中启用了此地址：转到IP-&gt;云菜单-选中DDNS启用复选框，单击应用，然后复制我们路由器的dns名称。但这仅在路由器的外部IP是动态的或使用具有多个Internet提供商的配置时才需要。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个链接中的端口：19000对应于您需要敲击的第二个端口。链接之间有一条简短的说明，该说明显示了由​​于短暂的网络问题而突然断开连接时该怎么办-我们刷新页面，RDP端口再次为我们打开1分钟，并恢复了会话。同样，img标签之间的文本对浏览器形成了微小的延迟，这降低了将第一个程序包传递到第二个端口的可能性（16000）-到目前为止，在使用两周后就没有这种情况了（30人）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来是1.rdp文件，我们可以为每个用户全部配置一个文件，也可以为每个用户分别配置一个文件（我这样做了-多花15分钟而不是几个小时来咨询无法解决问题的人）</font></font><br>
<br>
<pre><code class="plaintext hljs">screen mode id:i:2<font></font>
use multimon:i:1<font></font>
.....<font></font>
connection type:i:6<font></font>
networkautodetect:i:0<font></font>
.....<font></font>
disable wallpaper:i:1<font></font>
.....<font></font>
full address:s:my_router.sn.mynetname.net:33890<font></font>
.....<font></font>
username:s:myuserlogin<font></font>
domain:s:mydomain</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这里有趣的设置中使用了multimon：i：1-这包括使用多台显示器-有些需要使用，但他们不会考虑自己打开它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
连接类型：i：6和networkautodetect：i：0-由于大多数Internet都在10 Mbps以上，因此请打开连接类型6（本地网络10 Mbps及更高）并禁用networkautodetect，因为默认情况下（自动），它甚至很少见网络延迟会自动为我们的会话永久设置一个被低估的速度，这会在工作中造成明显的延迟，尤其是在图形程序中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
禁用墙纸：i：1-禁用桌面图像</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用户名：s：myuserlogin-指定用户名，因为我们的用户中有很大一部分不知道其用户名</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
domain：s：mydomain-指定域或计算机名称</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果要简化创建连接过程的任务，我们也可以使用PowerShell-StartRDP.ps1</font></font><br>
<br>
<pre><code class="plaintext hljs">Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 19000<font></font>
Test-NetConnection -ComputerName my_router.sn.mynetname.net -Port 16000<font></font>
mstsc /v:my_router.sn.mynetname.net:33890</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于Windows中的RDP客户端也有一点：MS在优化协议及其服务器和客户端方面已经走了很长的路，已经实现了许多有用的功能-例如使用硬件3D，优化显示器的屏幕分辨率，多屏幕等等。但是，当然，所有内容都是在向后兼容模式下实现的，如果客户端是Windows 7，远程PC是Windows 10，则RDP将使用协议版本7.0进行工作。但是这样做的好处是您可以将RDP版本升级到最新版本-例如，可以将协议版本从7.0（Windows 7）升级到8.1。因此，为了方便客户端，必须最大化服务器端的版本，并断开链接以升级到RDP协议客户端的新版本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们拥有一种简单且相对安全的技术，可远程连接到工作中的PC或终端服务器。</font><font style="vertical-align: inherit;">但是为了获得更安全的连接，我们的端口敲门方法通过添加检查端口可以使攻击复杂几个数量级-您可以添加3、4、5、6 ...相同的逻辑，在这种情况下，直接入侵您的网络几乎是不可能的。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于创建与RDP的远程连接的文件空白</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN495576/index.html">带有micropython的esp8266 MK上的自推式平台</a></li>
<li><a href="../zh-CN495580/index.html">黄瓜JVM-不只是BDD</a></li>
<li><a href="../zh-CN495588/index.html">从零开始在Unity中创建类似于Rogue的游戏：地牢生成器</a></li>
<li><a href="../zh-CN495592/index.html">如何使用字典（不仅限于此）</a></li>
<li><a href="../zh-CN495594/index.html">开始在软件上赚钱：创建小型数字业务</a></li>
<li><a href="../zh-CN495602/index.html">从核心数据开始！难以用简单的语言表达[第二部分]</a></li>
<li><a href="../zh-CN495604/index.html">Symfony 4 + Twig的临时本地化</a></li>
<li><a href="../zh-CN495606/index.html">“社会监督。” 得分1：0，对我们有利</a></li>
<li><a href="../zh-CN495608/index.html">[Infographic]人类历史中大流行病的可视化</a></li>
<li><a href="../zh-CN495610/index.html">为什么未来不适合Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>