<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 🧓🏽 🖖 Entity Framework Coreの高速化 🚳 👨🏻‍🌾 🏎️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="欲を出すな！
 データを選択するときは、一度に必要な数だけ正確に選択する必要があります。テーブルからすべてのデータを取得しないでください！
 
 違う：
 
 

using var ctx = new EFCoreTestContext(optionsBuilder.Options); // ID...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Entity Framework Coreの高速化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487734/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">欲を出すな！</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを選択するときは、一度に必要な数だけ正確に選択する必要があります。</font><font style="vertical-align: inherit;">テーブルからすべてのデータを取得しないでください！</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">違う：</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);                
<span class="hljs-comment">//    ID  ,       !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.ID, x.Name, x.ShortName }).ToList();
</code></pre> <br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しく：</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);  
<span class="hljs-comment">//     ID     !</span>
ctx.FederalDistricts.Select(x=&gt; <span class="hljs-keyword">new</span> { x.Name, x.ShortName }).ToList();<font></font>
ctx.FederalDistricts.Select(x =&gt; <span class="hljs-keyword">new</span> MyClass { Name = x.Name, ShortName = x.ShortName }).ToList();
</code></pre><br>
<a name="habracut"></a><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">違う：</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blog.ToList(); <span class="hljs-comment">//       . ?</span>
<span class="hljs-comment">//     ?</span>
<span class="hljs-keyword">var</span> somePost = blogs.FirstOrDefault(x=&gt;x.Title.StartWidth(“Hello world!”));
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しく：</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> somePost = context.Blog.FirstOrDefault(x=&gt;x.Title.StartWidth(“Hello world!”));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリがいくつかのレコードを返す場合、統合データ検証を実行できます。</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">違う：</font></font></u><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">StandardizeUrl</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> url</span>)</span><font></font>
{<font></font>
    url = url.ToLower();<font></font>
    <span class="hljs-keyword">if</span> (!url.StartsWith(<span class="hljs-string">"http://"</span>))<font></font>
    {<font></font>
        url = <span class="hljs-keyword">string</span>.Concat(<span class="hljs-string">"http://"</span>, url);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> url;<font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しく：</font></font></u><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsEnumerable().Where(blog =&gt; StandardizeUrl(blog.Url).Contains(<span class="hljs-string">"dotnet"</span>)).ToList();<font></font>
 <font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">var</span> blogs = context.Blogs.Where(blog =&gt; blog.Contains(<span class="hljs-string">"dotnet"</span>))<font></font>
    .OrderByDescending(blog =&gt; blog.Rating)<font></font>
    .Select(blog =&gt; <span class="hljs-keyword">new</span><font></font>
    {<font></font>
        Id = blog.BlogId,<font></font>
        Url = StandardizeUrl(blog.Url)<font></font>
    })<font></font>
    .ToList();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すごい、すごい、すごい、クロックアップ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LINQテクニックの知識を少しリフレッシュする時がきました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList </font></font></i><i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsEnumerable</font></font></i></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AsQueryableの</font><font style="vertical-align: inherit;">違いを見てみましょう</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList</font></font></i><br>
<br>
<ul>
<li>  .</li>
<li> <i>.ToList()</i>           (lazy loading),            .</li>
</ul><br>
<i>AsEnumerable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li> : <i>Func &lt;TSource, bool&gt;</i></li>
<li>          (   <b>Where/Take/Skip</b>   , ,   select * from Table1, </li>
<li>    ,    N )</li>
<li>    : <i>Linq-to-SQL + Linq-to-Object</i>.</li>
<li> <i>IEnumerable </i>          (lazy loading).</li>
</ul><br>
<i>AsQueryable</i><br>
<br>
<ul>
<li>   (lazy loading)</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  :</a> <pre><code class="cs hljs">AsQueryable(IEnumerable)  AsQueryable&lt;TElement&gt;(IEnumerable&lt;TElement&gt;) </code></pre><br>
</li>
<li> Expression  T-SQL (   ),         .</li>
<li>  DbSet ( Entity Framework)    AsQueryable    .</li>
<li>   ,   <b>Take(5)</b>     <b>«select top 5 * SQL»</b>   .  ,       SQL  ,     .  <i>AsQueryable()</i>   ,  <i>AsEnumerable()</i>     T-SQL      Linq  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー側で実行する前に改善できるデータベースクエリが必要な場合は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsQueryableを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">します。</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純なケースでのAsQueryableの使用例：</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;EmailView&gt; <span class="hljs-title">GetEmails</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> <span class="hljs-keyword">int</span> totalRecords, Guid? deviceWorkGroupID,
                DateTime? timeStart, DateTime? timeEnd, <span class="hljs-keyword">string</span> search, <span class="hljs-keyword">int</span>? confirmStateID, <span class="hljs-keyword">int</span>? stateTypeID, <span class="hljs-keyword">int</span>? limitOffset, <span class="hljs-keyword">int</span>? limitRowCount, <span class="hljs-keyword">string</span> orderBy, <span class="hljs-keyword">bool</span> desc</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> List&lt;EmailView&gt;();<font></font>
<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> GJobEntities())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> query = db.Emails.AsQueryable();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (timeStart != <span class="hljs-literal">null</span> &amp;&amp; timeEnd != <span class="hljs-literal">null</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.Created &gt;= timeStart &amp;&amp; p.Created &lt;= timeEnd);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (stateTypeID != <span class="hljs-literal">null</span> &amp;&amp; stateTypeID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    query = query.Where(p =&gt; p.EmailStates.OrderByDescending(x =&gt; x.AtTime).FirstOrDefault().EmailStateTypeID == stateTypeID);<font></font>
                }<font></font>
<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (confirmStateID != <span class="hljs-literal">null</span> &amp;&amp; confirmStateID &gt; <span class="hljs-number">-1</span>)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> boolValue = confirmStateID == <span class="hljs-number">1</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<font></font>
                    query = query.Where(p =&gt; p.IsConfirmed == boolValue);<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrEmpty(search))<font></font>
                {<font></font>
                    search = search.ToLower();<font></font>
                    query = query.Where(p =&gt; (p.Subject + <span class="hljs-string">" "</span> + p.CopiesEmails + <span class="hljs-string">" "</span> + p.ToEmails + <span class="hljs-string">" "</span> + p.FromEmail + <span class="hljs-string">" "</span> + p.Body)<font></font>
                                        .ToLower().Contains(search));<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (deviceWorkGroupID != Guid.Empty)<font></font>
                {<font></font>
                    query = query.Where(x =&gt; x.SCEmails.FirstOrDefault().SupportCall.Device.DeviceWorkGroupDevices.FirstOrDefault(p =&gt; p.DeviceWorkGroupID == deviceWorkGroupID) != <span class="hljs-literal">null</span>);<font></font>
                }<font></font>
<font></font>
                totalRecords = query.Count();<font></font>
                query = query.OrderByDescending(p =&gt; p.Created);<font></font>
                <span class="hljs-keyword">if</span> (limitOffset.HasValue)<font></font>
                {<font></font>
                    query = query.Skip(limitOffset.Value).Take(limitRowCount.Value);<font></font>
                }<font></font>
                <span class="hljs-keyword">var</span> items = query.ToList(); <span class="hljs-comment">//    </span><font></font>
<font></font>
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> n = <span class="hljs-keyword">new</span> EmailView<font></font>
                    {<font></font>
                        ID = item.ID,<font></font>
                        SentTime = item.SentTime,<font></font>
                        IsConfirmed = item.IsConfirmed,<font></font>
                        Number = item.Number,<font></font>
                        Subject = item.Subject,<font></font>
                        IsDeleted = item.IsDeleted,<font></font>
                        ToEmails = item.ToEmails,<font></font>
                        Created = item.Created,<font></font>
                        CopiesEmails = item.CopiesEmails,<font></font>
                        FromEmail = item.FromEmail,<font></font>
                    };<font></font>
<font></font>
                    <span class="hljs-comment">//     - </span><font></font>
<font></font>
                    r.Add(n);<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> r;<font></font>
        }<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シンプルな読書の魔法</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを変更する必要がない場合は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AsNoTracking（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドを</font><font style="vertical-align: inherit;">使用して表示するだけ</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅いサンプリング</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.ToList();</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クイックフェッチ（読み取り専用）</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> blogs = context.Blogs.AsNoTracking().ToList();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう少しウォームアップしたと感じますか？ </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関連データの読み込みの種類</font></font></h4><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延読み込みが</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
何であるかを忘れた人のために</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遅延読み込み</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（遅延読み込み）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ナビゲーションのプロパティにアクセスするときに、関連するデータがデータベースから透過的に読み込まれることを意味します。詳細は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、他の種類の関連データの読み込みについても思い出させてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクティブロード</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">積極的な</font><i><font style="vertical-align: inherit;">読み込み）</font></i><font style="vertical-align: inherit;">は、関連するデータが最初のリクエストの一部としてデータベースから読み込まれることを意味します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blogs = context.Blogs<font></font>
        .Include(blog =&gt; blog.Posts)<font></font>
            .ThenInclude(post =&gt; post.Author)<font></font>
                .ThenInclude(author =&gt; author.Photo)<font></font>
        .Include(blog =&gt; blog.Owner)<font></font>
            .ThenInclude(owner =&gt; owner.Photo)<font></font>
        .ToList();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意！</font><font style="vertical-align: inherit;">バージョンEF Core 3.0.0以降、各インクルード</font><font style="vertical-align: inherit;">により、リレーショナルプロバイダーによって作成されたSQLクエリに</font><font style="vertical-align: inherit;">追加の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が追加</font><font style="vertical-align: inherit;">されますが、以前のバージョンでは追加のSQLクエリが生成されました。</font><font style="vertical-align: inherit;">これにより、クエリのパフォーマンスが大幅に変化する可能性があります。</font><font style="vertical-align: inherit;">特に、非常に多数の包含ステートメントを含むLINQクエリは、いくつかの個別のLINQクエリに分割できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明示的ロード</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（明示的ロード）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、関連するデータが後でデータベースから明示的にロードされることを意味します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> blog = context.Blogs<font></font>
        .Single(b =&gt; b.BlogId == <span class="hljs-number">1</span>);<font></font>
<font></font>
    <span class="hljs-keyword">var</span> goodPosts = context.Entry(blog)<font></font>
        .Collection(b =&gt; b.Posts)<font></font>
        .Query()<font></font>
        .Where(p =&gt; p.Rating &gt; <span class="hljs-number">3</span>)<font></font>
        .ToList();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジャークとブレークスルー！</font><font style="vertical-align: inherit;">続けますか？</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらにスピードアップする準備はできましたか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リレーショナルデータベースから複雑に構造化されたデータや異常なデータをフェッチする際に劇的にスピードアップするには、これを行う方法が2つあります。インデックス付きビュー（1）を使用するか、表示用に準備された（計算された）データを単純なフラットフォームで使用する（2）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（1）</font><font style="vertical-align: inherit;">MS SQL Serverのコンテキストでの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックス付きビュー</font></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックス付きビューには、一意のクラスター化インデックスがあります。</font><font style="vertical-align: inherit;">一意のクラスター化インデックスはSQL Serverに格納され、他のクラスター化インデックスと同様に更新されます。</font><font style="vertical-align: inherit;">インデックス付きビューは、大量のデータの集計や複数の行の結合など、多数の行の複雑な処理を含む標準ビューよりも重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなビューがクエリで頻繁に参照される場合、ビューに一意のクラスター化インデックスを作成することでパフォーマンスを向上させることができます。標準ビューの場合、結果セットはデータベースに保存されません。代わりに、クエリごとに結果セットが計算されますが、クラスター化インデックスの場合、結果セットはクラスター化インデックスを持つテーブルと同じ方法でデータベースに保存されます。インデックス付きビューを特に使用しないクエリは、ビューのクラスター化インデックスが存在することでメリットを得ることもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスの提示には、パフォーマンスという形で一定のコストがかかります。インデックス付きビューを作成する場合、ベーステーブルのデータを変更するたびに、SQL Serverはこれらのテーブルのインデックスレコードだけでなく、ビューのインデックスレコードもサポートする必要があります。開発者および企業向けのSQL Serverエディションでは、オプティマイザはビューインデックスを使用して、インデックス付きビューを指定しないクエリを最適化できます。ただし、SQL Serverの他のエディションでは、クエリにインデックス付きビューを含め、ビューでインデックスを利用するためのNOEXPANDヒントを提供する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（2）</font><b><font style="vertical-align: inherit;">CRUD</font></b><font style="vertical-align: inherit;">を増やして、3つ以上のレベルで3つ以上のレベルの関連テーブルを表示する必要がある要求を行う必要がある場合</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み込み、最善の方法は、結果セットを定期的に計算し、テーブルに保存して、表示に使用することです。</font><font style="vertical-align: inherit;">データが格納される結果のテーブルには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主キーとLINQの検索フィールドのインデックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期についてはどうですか？</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい！</font><font style="vertical-align: inherit;">可能な限り使用します！</font><font style="vertical-align: inherit;">次に例を示します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Do</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> myTask = GetFederalDistrictsAsync ();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> myTask.Result)<font></font>
    {<font></font>
         <span class="hljs-comment">// </span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
    optionsBuilder.UseSqlServer(conn);<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.ToListAsync();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、はい、生産性を向上させるために何かを忘れましたか？</font><font style="vertical-align: inherit;">ブーム！</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.&lt;b&gt;AsNoTracking()&lt;/b&gt;.ToListAsync();</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドは</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetFederalDistrictsAsync（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの操作性を示すために、デモ目的でのみ追加されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同僚が正しく述べたように、純粋な非同期の別の例が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ASP .NET Coreのビューコンポーネントの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">に</font></a><font style="vertical-align: inherit;">基づいてそれを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">示します</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PopularPosts</span> : <span class="hljs-title">ViewComponent</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IStatsRepository _statsRepository;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PopularPosts</span>(<span class="hljs-params">IStatsRepository statsRepository</span>)</span><font></font>
        {<font></font>
            _statsRepository = statsRepository;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IViewComponentResult&gt; <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
           <span class="hljs-comment">//         -</span>
            <span class="hljs-keyword">var</span> federalDistricts = <span class="hljs-keyword">await</span> _statsRepository.GetFederalDistrictsAsync(); 
            <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> TablePageModel()<font></font>
            {<font></font>
                FederalDistricts = federalDistricts,<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">return</span> View(model);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">// </span><font></font>
    <font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span>  -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span>
        <span class="hljs-function">IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span>;<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>        </span>
	<span class="hljs-comment"><span class="hljs-doctag">///</span> !!!</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span><span class="hljs-doctag">&lt;/returns&gt;</span></span><font></font>
        Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync();<font></font>
    }	<font></font>
	<font></font>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> -   .... -</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StatsRepository</span> : <span class="hljs-title">IStatsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;<font></font>
            optionsBuilder = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;EFCoreTestContext&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IConfigurationRoot configurationRoot;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StatsRepository</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            IConfigurationBuilder configurationBuilder = <span class="hljs-keyword">new</span> ConfigurationBuilder()<font></font>
                    .SetBasePath(Environment.CurrentDirectory)<font></font>
                    .AddJsonFile(<span class="hljs-string">"appsettings.json"</span>, optional: <span class="hljs-literal">true</span>, reloadOnChange: <span class="hljs-literal">true</span>);<font></font>
            configurationRoot = configurationBuilder.Build();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;FederalDistrict&gt;&gt; GetFederalDistrictsAsync()<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToListAsync();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;FederalDistrict&gt; <span class="hljs-title">FederalDistricts</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> conn = configurationRoot.GetConnectionString(<span class="hljs-string">"EFCoreTestContext"</span>);<font></font>
            optionsBuilder.UseSqlServer(conn);<font></font>
<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> ctx = <span class="hljs-keyword">new</span> EFCoreTestContext(optionsBuilder.Options);
            <span class="hljs-keyword">return</span> ctx.FederalDistricts.Include(x =&gt; x.FederalSubjects).ToList();<font></font>
        }<font></font>
    }<font></font>
<font></font>
   <span class="hljs-comment">//         Home\Index </span>
    &lt;div id=<span class="hljs-string">"tableContainer"</span>&gt;<font></font>
            @await Component.InvokeAsync(<span class="hljs-string">"PopularPosts"</span>)<font></font>
     &lt;/div&gt;<font></font>
  <span class="hljs-comment">//   HTML      Shared\Components\PopularPosts\Default.cshtml</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entity Framework Coreでクエリが実行されるタイミングをお知らせします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LINQステートメントを呼び出すときは、メモリ内にクエリビューを作成するだけです。</font><font style="vertical-align: inherit;">結果を処理した後でのみ、要求がデータベースに送信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、リクエストがデータベースに送信される最も一般的な操作を示します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forループで結果を反復します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToList、ToArray、Single、Countなどの演算子を使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリ結果のデータをユーザーインターフェイスにバインドします。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションアーキテクチャの観点からEF Coreコードを整理するにはどうすればよいですか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（1）アプリケーションのアーキテクチャの観点から、データベースへのアクセスコードが明確に定義された場所に（分離して）分離または分離されていることを確認する必要があります。</font><font style="vertical-align: inherit;">これにより、パフォーマンスに影響を与えるデータベースコードを見つけることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（2）データベースのアクセスコードを、ユーザーインターフェイスやAPIなど、アプリケーションの他の部分と混在させないでください。</font><font style="vertical-align: inherit;">したがって、データベースに関連しない他の問題を心配することなく、データベースアクセスコードを変更できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用して正確にかつ迅速にデータを保存する方法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のSaveChangesを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
挿入されたレコードが同じである場合、すべてのレコードに対して1つの保存操作を使用することは理にかなっています。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">違う</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
    <span class="hljs-comment">//   1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1);<font></font>
<font></font>
  <span class="hljs-comment">//          db.SaveChanges();</span><font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しく</font></font></i><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> NorthwindEntities())<font></font>
{<font></font>
<span class="hljs-keyword">var</span> transaction = db.Database.BeginTransaction();<font></font>
<font></font>
<span class="hljs-keyword">try</span><font></font>
{<font></font>
   <span class="hljs-comment">//  1</span>
    <span class="hljs-keyword">var</span>  obj1 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj1.CustomerID = <span class="hljs-string">"ABCDE"</span>;<font></font>
    obj1.CompanyName = <span class="hljs-string">"Company 1"</span>;<font></font>
    obj1.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj1); <font></font>
<font></font>
    <span class="hljs-comment">//   2</span>
    <span class="hljs-keyword">var</span>  obj2 = <span class="hljs-keyword">new</span> Customer();<font></font>
    obj2.CustomerID = <span class="hljs-string">"PQRST"</span>;<font></font>
    obj2.CompanyName = <span class="hljs-string">"Company 2"</span>;    <font></font>
    obj2.Country = <span class="hljs-string">"USA"</span>;<font></font>
    db.Customers.Add(obj2);<font></font>
<font></font>
   <span class="hljs-comment">//    N </span><font></font>
    db.SaveChanges();<font></font>
<font></font>
    transaction.Commit();<font></font>
}<font></font>
<span class="hljs-keyword">catch</span><font></font>
{<font></font>
    transaction.Rollback();<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルールには常に例外があります。</font><font style="vertical-align: inherit;">トランザクションコンテキストが複雑な場合、つまり複数の独立した操作で構成されている場合は、各操作の後に保存できます。</font><font style="vertical-align: inherit;">また、トランザクションで非同期ストレージを使用する方がより正確です。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;IActionResult&gt; <span class="hljs-title">AddDepositToHousehold</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> householdId, DepositRequestModel model</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> transaction = <span class="hljs-keyword">await</span> Context.Database.BeginTransactionAsync(IsolationLevel.Snapshot))<font></font>
    {<font></font>
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            <span class="hljs-comment">//     </span>
            <span class="hljs-keyword">var</span> deposit = <span class="hljs-keyword">this</span>.Mapper.Map&lt;Deposit&gt;(model);
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Deposits.AddAsync(deposit);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//    </span>
               <span class="hljs-keyword">var</span> debtsToPay = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.Debts.Where(d =&gt; d.HouseholdId == householdId &amp;&amp; !d.IsPaid).OrderBy(d =&gt; d.DateMade).ToListAsync();<font></font>
<font></font>
            debtsToPay.ForEach(d =&gt; d.IsPaid = <span class="hljs-literal">true</span>);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            <span class="hljs-comment">//   </span>
            <span class="hljs-keyword">var</span> household = <span class="hljs-keyword">this</span>.Context.Households.FirstOrDefaultAsync(h =&gt; h.Id == householdId);<font></font>
<font></font>
            household.Balance += model.DepositAmount;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.Context.SaveChangesAsync();<font></font>
<font></font>
            transaction.Commit();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.Ok();<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span><font></font>
        {<font></font>
            transaction.Rollback();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.BadRequest();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリガー、計算フィールド、カスタム関数、EFコア</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EF Coreを含むアプリケーションの負荷を減らすには、単純な計算フィールドとデータベーストリガーを使用するのが理にかなっていますが、アプリケーションが非常に混乱する可能性があるため、関与しない方がよいでしょう。</font><font style="vertical-align: inherit;">ただし、ユーザー定義関数は、特にフェッチ操作中に非常に役立ちます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EF Coreでの同時実行性</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを並列化して高速化する場合は、中断します。EFCoreは、コンテキストの1つのインスタンスでの複数の並列操作の実行をサポートしていません。</font><font style="vertical-align: inherit;">1つの操作が完了するのを待ってから、次の操作を開始してください。</font><font style="vertical-align: inherit;">このため、通常は各非同期操作でawaitキーワードを指定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EF Coreは非同期クエリを使用して、データベースでクエリを実行するときにフローのブロックを回避します。</font><font style="vertical-align: inherit;">非同期要求は、シッククライアントでのユーザーインターフェイス応答を迅速に行うために重要です。</font><font style="vertical-align: inherit;">また、スレッドを解放して他の要求を処理できるWebアプリケーションのスループットを向上させることもできます。</font><font style="vertical-align: inherit;">次に例を示します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;Blog&gt;&gt; GetBlogsAsync()<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
    {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> context.Blogs.ToListAsync();<font></font>
    }<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQコンパイル済みクエリについて何を知っていますか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entity Frameworkで構造的に類似したクエリを繰り返し実行するアプリケーションがある場合、クエリを1回コンパイルし、異なるパラメーターで数回実行することにより、パフォーマンスを向上させることができます。たとえば、アプリケーションで特定の都市のすべての顧客を取得する必要がある場合があります。都市は、実行時にユーザーによってフォームに示されます。 LINQ to Entitiesは、この目的でコンパイルされたクエリの使用をサポートしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.NET Framework 4.5以降、LINQクエリは自動的にキャッシュされます。</font><font style="vertical-align: inherit;">ただし、コンパイルされたLINQクエリを使用して、後続の実行でこのコストを削減できます。コンパイルされたクエリは、自動的にキャッシュされるLINQクエリよりも効率的です。</font><font style="vertical-align: inherit;">Enumerable.Contains演算子をメモリ内コレクションに適用するLINQ to Entitiesクエリは、自動的にキャッシュされないことに注意してください。</font><font style="vertical-align: inherit;">また、コンパイルされたLINQクエリでのメモリ内コレクションのパラメーター化は許可されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの例が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなDbContextコンテキストを作成しないでください。</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、怠惰なf_u__c_k__e_r__sと、データベース全体を1つのコンテキストに配置することは、ほとんどすべてではないにしても多くの人が知っています。特に、これは、データベースファーストのアプローチでは一般的です。</font><font style="vertical-align: inherit;">そして、あなたはそれを無駄にします！</font><font style="vertical-align: inherit;">以下は、コンテキストを分割する方法の例です。</font><font style="vertical-align: inherit;">もちろん、コンテキスト間の接続テーブルは複製する必要があります。これはマイナスです。</font><font style="vertical-align: inherit;">いずれにしても、コンテキストに50を超えるテーブルがある場合は、分割することを検討することをお勧めします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテキストグループの使用（DdContextのプール）</font></font></h4><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プールの意味は、プール</font><font style="vertical-align: inherit;">から</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インスタンス</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">再利用できるようにすることです</font><font style="vertical-align: inherit;">。これにより、</font><b><font style="vertical-align: inherit;">毎回</font></b><font style="vertical-align: inherit;">新しいインスタンスを作成するよりもパフォーマンスが向上する場合があります。</font><font style="vertical-align: inherit;">これはADO.NETで接続プールを作成する主な理由でもありますが、接続は一般により難しいリソースであるため、接続のパフォーマンス向上はより重要になります。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Demos</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Blog</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> BlogId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Url { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BloggingContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> InstanceCount;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BloggingContext</span>(<span class="hljs-params">DbContextOptions options</span>)
            : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span>
            =&gt; Interlocked.Increment(<span class="hljs-keyword">ref</span> InstanceCount);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Blog&gt; Blogs { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BlogController</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> BloggingContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BlogController</span>(<span class="hljs-params">BloggingContext context</span>)</span> =&gt; _context = context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ActionAsync</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> _context.Blogs.FirstAsync();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> ConnectionString<font></font>
            = <span class="hljs-string">@"Server=(localdb)\mssqllocaldb;Database=Demo.ContextPooling;Integrated Security=True;ConnectRetryCount=0"</span>;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            services.AddDbContext&lt;BloggingContext&gt;(c =&gt; c.UseSqlServer(ConnectionString));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Threads = <span class="hljs-number">32</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> Seconds = <span class="hljs-number">10</span>;<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> _requestsProcessed;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Main</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> serviceCollection = <span class="hljs-keyword">new</span> ServiceCollection();
            <span class="hljs-keyword">new</span> Startup().ConfigureServices(serviceCollection);
            <span class="hljs-keyword">var</span> serviceProvider = serviceCollection.BuildServiceProvider();<font></font>
<font></font>
            SetupDatabase(serviceProvider);<font></font>
<font></font>
            <span class="hljs-keyword">var</span> stopwatch = <span class="hljs-keyword">new</span> Stopwatch();<font></font>
<font></font>
            MonitorResults(TimeSpan.FromSeconds(Seconds), stopwatch);<font></font>
<font></font>
            <span class="hljs-keyword">await</span> Task.WhenAll(<font></font>
                Enumerable<font></font>
                    .Range(<span class="hljs-number">0</span>, Threads)<font></font>
                    .Select(_ =&gt; SimulateRequestsAsync(serviceProvider, stopwatch)));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetupDatabase</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> context = serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (context.Database.EnsureCreated())<font></font>
                {<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Dog Blog"</span>, Url = <span class="hljs-string">"http://sample.com/dogs"</span> });<font></font>
                    context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Name = <span class="hljs-string">"The Cat Blog"</span>, Url = <span class="hljs-string">"http://sample.com/cats"</span> });<font></font>
                    context.SaveChanges();<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SimulateRequestsAsync</span>(<span class="hljs-params">IServiceProvider serviceProvider, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.IsRunning)<font></font>
            {<font></font>
                <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> serviceScope = serviceProvider.CreateScope())<font></font>
                {<font></font>
                    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> BlogController(serviceScope.ServiceProvider.GetService&lt;BloggingContext&gt;()).ActionAsync();<font></font>
                }<font></font>
<font></font>
                Interlocked.Increment(<span class="hljs-keyword">ref</span> _requestsProcessed);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MonitorResults</span>(<span class="hljs-params">TimeSpan duration, Stopwatch stopwatch</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> lastInstanceCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastRequestCount = <span class="hljs-number">0L</span>;
            <span class="hljs-keyword">var</span> lastElapsed = TimeSpan.Zero;<font></font>
<font></font>
            stopwatch.Start();<font></font>
<font></font>
            <span class="hljs-keyword">while</span> (stopwatch.Elapsed &lt; duration)<font></font>
            {<font></font>
                <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">1</span>));<font></font>
<font></font>
                <span class="hljs-keyword">var</span> instanceCount = BloggingContext.InstanceCount;
                <span class="hljs-keyword">var</span> requestCount = _requestsProcessed;
                <span class="hljs-keyword">var</span> elapsed = stopwatch.Elapsed;
                <span class="hljs-keyword">var</span> currentElapsed = elapsed - lastElapsed;
                <span class="hljs-keyword">var</span> currentRequests = requestCount - lastRequestCount;<font></font>
<font></font>
                Console.WriteLine(<font></font>
                    <span class="hljs-string">$"[<span class="hljs-subst">{DateTime.Now:HH:mm:ss.fff}</span>] "</span>
                    + <span class="hljs-string">$"Context creations/second: <span class="hljs-subst">{instanceCount - lastInstanceCount}</span> | "</span>
                    + <span class="hljs-string">$"Requests/second: <span class="hljs-subst">{Math.Round(currentRequests / currentElapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
                lastInstanceCount = instanceCount;<font></font>
                lastRequestCount = requestCount;<font></font>
                lastElapsed = elapsed;<font></font>
            }<font></font>
<font></font>
            Console.WriteLine();<font></font>
            Console.WriteLine(<span class="hljs-string">$"Total context creations: <span class="hljs-subst">{BloggingContext.InstanceCount}</span>"</span>);<font></font>
            Console.WriteLine(<font></font>
                <span class="hljs-string">$"Requests per second:     <span class="hljs-subst">{Math.Round(_requestsProcessed / stopwatch.Elapsed.TotalSeconds)}</span>"</span>);<font></font>
<font></font>
            stopwatch.Stop();<font></font>
        }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EF CoreのCRUDで不要なエラーを回避するにはどうすればよいですか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じコードに計算を挿入しないでください。</font><font style="vertical-align: inherit;">オブジェクトの形成/準備とその挿入/更新は常に分離します。</font><font style="vertical-align: inherit;">ユーザーが入力したデータを確認し、必要な予備データを計算し、オブジェクトをマッピングまたは作成し、実際のCRUD操作を実行するだけで、それを機能別に展開できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションのパフォーマンスが本当に悪い場合はどうしますか？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビールは絶対にここでは役に立ちません。</font><font style="vertical-align: inherit;">しかし、役立つのは、アプリケーションアーキテクチャでの読み取りと書き込みの分離であり、その後、これらの操作がソケットに割り当てられます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command and Query Responsibility Segregation（CQRS）パターン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用することを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">検討し</font></a><font style="vertical-align: inherit;">、2つのデータベース間でテーブルを挿入と読み取りに分割してみてください。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなた、友人、同僚へのアプリケーションのスピードアップ！</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja487716/index.html">完璧なSAST。パーサー</a></li>
<li><a href="../ja487720/index.html">競争的コーティニズムについて（例としてリアクティブプログラミングを使用）</a></li>
<li><a href="../ja487724/index.html">BlazingPizza：最初から最後までBlazorアプリ。パート2.コンポーネントを追加する</a></li>
<li><a href="../ja487728/index.html">@Pythonetcコンパイル、2020年1月</a></li>
<li><a href="../ja487730/index.html">自然言語処理。2019年の結果と2020年の傾向</a></li>
<li><a href="../ja487738/index.html">SCADAのスキーマアニメーション</a></li>
<li><a href="../ja487740/index.html">ポータブル磁力計の組み立て</a></li>
<li><a href="../ja487742/index.html">アービトラージ取引（Bellman-Fordアルゴリズム）</a></li>
<li><a href="../ja487744/index.html">FAROがFOCUS S 70レーザー3Dスキャナーを発表</a></li>
<li><a href="../ja487746/index.html">永遠の</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>