<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎀 ✂️ 🎱 能源领域的机器学习，还是不仅每个人都能明天观看 👲 📲 ✍🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在许多领域，对未来事件的准确预测是一个充满希望和有趣的任务：从天气预报到金融科技（股票报价，汇率）。今天的机器学习可以显着减少制定管理决策所需的时间和人力。  大约半年的时间里，
 
 我们位于NORBIT的数据科学团队尝试使用各种机器学习模型来解决分类和回归问题，并优化b2b业务流程。但是，当出现...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>能源领域的机器学习，还是不仅每个人都能明天观看</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lanit/blog/487944/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在许多领域，对未来事件的准确预测是一个充满希望和有趣的任务：从天气预报到金融科技（股票报价，汇率）。今天的机器学习可以显着减少制定管理决策所需的时间和人力。&nbsp; </font><font style="vertical-align: inherit;">大约半年的时间里，</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们位于</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NORBIT的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据科学团队</font><font style="vertical-align: inherit;">尝试使用各种机器学习模型来解决分类和回归问题，并优化b2b业务流程。但是，当出现预测时间序列的任务时，事实证明，网络上有关此主题的可用材料不足以开发快速解决方案。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5bc/9c4/544/5bc9c4544398d7da8702bc31396a5a5f.jpg"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任务的实质是以最大的准确性（百分比的平均绝对误差或</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAPE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &lt;3％）预测一家大型发电公司未来三天（72小时）的整个城市每小时的用电量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3％的最大允许误差是预测准确性的非常高的指标。在使用机器学习之前，误差在3-23％的范围内，这直接导致了财务损失，因为电能发电不足，必须在批发电力市场上购买更多容量（比自发电要昂贵得多），并且生产过剩-在市场上出售比他们卖给城市便宜。同样，计划负载偏离实际负载的负面影响是网络中交流电频率的变化。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
许多因素阻碍了高精度的预测，例如，温度突然升高，人们立即从空调中拿取控制台，当他们跌落时，他们从中层取暖器。在假期或大型足球比赛中，包括电视等。尽管某些事件是周期性的并且可能是可预测的，但其他事件则完全不存在。假设突然由于一次事故，钢铁厂停工了，所有的预测都变成了南瓜（在我们的目标城市中没有大型生产企业）。能源领域的预测存在一个非常有趣的例子，当发电量变化的峰值之一是由一艘搁浅在湖上的船引起的，船长同意水力发电厂的所有者减少水的排放量时。自然，机器学习模型无法根据历史数据预测此事件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对我们而言，好消息是，客户提供了这样的“特殊日子”，从而使平均预测误差为8％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
客户提供的所有信息都是3年每小时用电量的历史数据以及城市名称。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c7c/85a/2b7/c7c85a2b744484fbd82af3e1bdb862c1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
准备构建机器学习模型的首要任务是可视化，并寻找可能影响预测的其他因素。</font><font style="vertical-align: inherit;">使用属性相关性的热图可以方便地从视觉上评估这种影响的程度。</font><font style="vertical-align: inherit;">在这种情况下，黑色正方形表示数量的无条件逆关系（一个值越大，另一个值越小，反之亦然），白色-直接：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># df - pandas DataFrame  </span>
sns.heatmap(df.corr());</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d67/1d1/306/d671d13066c5d1f0c338a2bb9be98f1b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
据我所知，在用于预测俄罗斯联邦电力消耗的模型中，使用了两个因素-消耗的历史和温度预测。&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e1/5ca/23a/3e15ca23a39908cf524e78005da4fd75.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在冬季和秋季，能耗较高-低温且白天相对较短。</font><font style="vertical-align: inherit;">“星期几”因素也会影响所消耗的能量-在周末，能量急剧下降。</font><font style="vertical-align: inherit;">消费高峰发生在周三或周四。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e09/f0f/a6a/e09f0fa6a5c2f9e31e71ee34e8dac852.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f96/e98/50c/f96e9850cf5ac194495fc8b53b4d75e1.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a09/51c/eab/a0951ceabb827dc253d38b4c647dc07e.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b86/e99/d10/b86e99d107cdbd1346b68559949b4792.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在工作日的一天之内，能量消耗的峰值出现在11-12小时，并在晚上9点后逐渐下降并急剧下降。&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6de/c6a/0a8/6dec6a0a8e0f111ae5e3ccd0a9e41d2e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切都和教科书中的一样：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b99/bb8/bb1/b99bb8bb1741dac3610d86d62cb31fea.jpg"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工业和文化中心的每日冬季和夏季每日消费时间表。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资源</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">造型</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预言家</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如何尽快完成任务的第一个想法是从Facebook上带走Prophet。</font><font style="vertical-align: inherit;">我已经有使用它的经验，并且我记得它是“一种简单，快速，可立即使用的东西”。</font><font style="vertical-align: inherit;">先知想在熊猫数据框中看到“ ds”和“ y”列，即 </font><font style="vertical-align: inherit;">日期格式为YYYY-MM-DD HH：MM：SS，目标分别是每小时的消耗量（工作示例在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="python hljs">df = pd.read_pickle(<span class="hljs-string">'full.pkl'</span>)<font></font>
pjme = df.loc[:<span class="hljs-string">'2018-06-01 23:00'</span>].rename(columns={<span class="hljs-string">'hour_value'</span>: <span class="hljs-string">'y'</span>})&nbsp;<font></font>
pjme[<span class="hljs-string">'ds'</span>] = pjme.index<font></font>
split_date = <span class="hljs-string">'2018-03-01 23:00'</span><font></font>
pjme_train = pjme.loc[pjme.index &lt;= split_date]<font></font>
pjme_test = pjme.loc[pjme.index &gt; split_date]<font></font>
<font></font>
<font></font>
playoffs = pd.DataFrame({<font></font>
&nbsp; <span class="hljs-string">'holiday'</span>: <span class="hljs-string">'playoff'</span>,
&nbsp; <span class="hljs-string">'ds'</span>: df[(df.rest_day == <span class="hljs-number">1</span>)|(df.is_weekend == <span class="hljs-number">1</span>)].index,
&nbsp; <span class="hljs-string">'lower_window'</span>: <span class="hljs-number">0</span>,
&nbsp; <span class="hljs-string">'upper_window'</span>: <span class="hljs-number">1</span>,<font></font>
})<font></font>
<font></font>
<font></font>
model = Prophet(holidays=playoffs)<font></font>
model.fit(pjme_train.reset_index())<font></font>
forecast = model.predict(df=pjme_test.reset_index())</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/736/115/46c/73611546c9eefe230cffebb3c65f3909.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/978/5ba/082/9785ba0828d2286f48c6fd4014a6039f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“先知”的预言看起来很客观，但是错误比允许的要高7-17％，因此，我没有在此框架上进行进一步的实验。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sarimaax</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解决此问题的第二种尝试是使用SARIMAX。</font><font style="vertical-align: inherit;">该方法在选择系数时非常耗时，但与“先知”相比，可以将预测误差降低到6-11％。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，仅保留了每周预测的结果，但是这些预测数据却被我用作提升模型中的其他功能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于预测，您需要选择SARIMA参数（p，d，q）（P，D，Q，s）：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p-自回归阶数（AR），它允许您添加时间序列的过去值（可以表示为``明天，如果最近几天下雪可能会下雪''）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d是源数据的积分顺序（它确定要从当前值中减去的先前时间点的数量）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">q是移动平均数（MA）的阶数，它允许您以先前观察到的误差值的线性组合的形式设置模型的误差；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P-p，但季节性；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D-d，但季节性；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q-q，但季节性；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s是季节性的维度（月，季度等）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在每周历史记录的季节性扩展中，您可以看到趋势和季节性，从而可以显示seasonal_decompose：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm<font></font>
sm.tsa.seasonal_decompose(df_week).plot()</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb5/41f/12d/fb541f12da571be70fe715fc97ab93e4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据自相关和部分自相关的图，他为SARIMAX模型选择了参数的初始近似值：p = 0，P = 1，q = 2，Q = 2。</font></font><br>
<br>
<pre><code class="python hljs">sm.graphics.tsa.plot_acf(df_week.diff_week[<span class="hljs-number">52</span>:].values.squeeze(), lags=<span class="hljs-number">60</span>, ax=ax)<font></font>
sm.graphics.tsa.plot_pacf(df_week.diff_week[<span class="hljs-number">52</span>:].values.squeeze(), lags=<span class="hljs-number">60</span>, ax=ax)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/87f/683/0d7/87f6830d7d1eafbecc5defa299f20011.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最终选择的值是（0，2，2）x（1,2，0，52）。</font><font style="vertical-align: inherit;">结果，消费预测图如下所示：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2f4/b66/920/2f4b66920297d473ed2493f5a2fa8d65.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">助推</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这一点上，很明显，如果不使用其他外部因素，就无法达到必要的精度。首先，这些是天气因素：温度，压力，湿度，风强度和方向，降水。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一次尝试是尝试购买</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Yandex</font></a><font style="vertical-align: inherit;">的天气档案</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。这些家伙拥有出色的API和技术支持，但特别是在我们所在的城市，数据之间存在很多差距。结果，我花了10美元在openweathermap.org服务中购买了档案。值得注意的是，尽管天气是一个非常有用的因素，但预测误差显然会破坏最终的MAPE模型。我得到的信息是，解决此问题的正确方法是训练而不是使用天气的实际历史值，而是使用三天的天气预报，但不幸的是，我没有这样的机会。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我还添加了一天中的时间，一周中的某天，节假日，一年中一天中的序列号以及以前时期的大量时滞和平均值的迹象。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
缩放后的所有数据（MinMaxScale）和一个Hot Encoding（每个分类项目的值变成具有0和1的单独列，因此具有三个值的项目成为三个不同的列，并且单位将仅位于其中之一）三种流行的增强模型XGBoost，LightGBM和CatBoost的竞争。&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XGBoost</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于XGBoost的文章很多。</font><font style="vertical-align: inherit;">在2016年SIGKDD会议上提出的他引起了轰动，仍然保持领先地位。</font><font style="vertical-align: inherit;">对于那些没有听说过的人来说很</font><font style="vertical-align: inherit;">有趣的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">材料</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们为模型准备数据：&nbsp;</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> MinMaxScaler, StandardScaler
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_data</span>(<span class="hljs-params">
&nbsp; &nbsp; stop_day = <span class="hljs-string">'2018-06-01 23:00'</span>,&nbsp;
&nbsp; &nbsp; drop_columns = [],
&nbsp; &nbsp; test_size=<span class="hljs-number">0.15</span>,
&nbsp; &nbsp; is_dummies=True,
&nbsp; &nbsp; is_target_scale=False</span>):</span><font></font>
<font></font>
&nbsp; &nbsp; df = pd.read_pickle(<span class="hljs-string">'full.pkl'</span>)<font></font>
&nbsp; &nbsp; df = df.loc[:stop_day]<font></font>
&nbsp; &nbsp; scaler = MinMaxScaler()<font></font>
&nbsp; &nbsp; target_scaler = StandardScaler()<font></font>
&nbsp; &nbsp; y = df.hour_total<font></font>
&nbsp; &nbsp;&nbsp;<font></font>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> is_target_scale: &nbsp; &nbsp; &nbsp; &nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; y = target_scaler.fit_transform(y.values.reshape(<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>)).reshape(<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>)[<span class="hljs-number">0</span>]<font></font>
&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<font></font>
&nbsp; &nbsp; X = df.drop([<span class="hljs-string">'hour_value'</span>, *drop_columns], axis=<span class="hljs-number">1</span>)<font></font>
&nbsp; &nbsp; num_columns = X.select_dtypes(include=[<span class="hljs-string">'float64'</span>]).columns<font></font>
&nbsp; &nbsp; X[num_columns] = scaler.fit_transform(X[num_columns])<font></font>
&nbsp; &nbsp;&nbsp;<font></font>
&nbsp; &nbsp; <span class="hljs-keyword">if</span> is_dummies:<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; X = pd.get_dummies(X)<font></font>
<font></font>
&nbsp; &nbsp; train_count_hours = len(X) - <span class="hljs-number">72</span>
&nbsp; &nbsp; valid_count_hours = len(X) - int(len(X) * <span class="hljs-number">0.2</span>)<font></font>
&nbsp; &nbsp; X_test &nbsp;= X[train_count_hours:]<font></font>
&nbsp; &nbsp; y_test &nbsp;= y[train_count_hours:]<font></font>
&nbsp; &nbsp; X = X[:train_count_hours]<font></font>
&nbsp; &nbsp; y = y[:train_count_hours]<font></font>
<font></font>
&nbsp; &nbsp; <span class="hljs-comment">#           ,       </span>
&nbsp; &nbsp; X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=test_size, random_state=<span class="hljs-number">42</span>)<font></font>
&nbsp; &nbsp; train_dates = X_train.index<font></font>
&nbsp; &nbsp; val_dates = X_test.index<font></font>
&nbsp; &nbsp; <span class="hljs-keyword">return</span> X, y, X_train, X_val, y_train, y_val, X_test, y_test, target_scaler</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我正在使用先前选择的最佳超参数来教授模型：</font></font><br>
<br>
<pre><code class="python hljs">X, y, X_train, X_val, y_train, y_val, X_test, y_test, _ = gen_data(<font></font>
&nbsp; &nbsp; stop_day = stop_day,&nbsp;<font></font>
&nbsp; &nbsp; drop_columns = drop_columns,<font></font>
&nbsp; &nbsp; test_size=<span class="hljs-number">0.1</span>,<font></font>
&nbsp; &nbsp; is_dump=<span class="hljs-literal">True</span>,<font></font>
&nbsp; &nbsp; is_target_scale=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
params_last = {<font></font>
&nbsp; &nbsp; <span class="hljs-string">'base_score'</span>: <span class="hljs-number">0.5</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'booster'</span>: <span class="hljs-string">'gbtree'</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'colsample_bylevel'</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'colsample_bynode'</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'colsample_bytree'</span>: <span class="hljs-number">0.4</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0</span>,
&nbsp; &nbsp; <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">2</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'min_child_weight'</span>: <span class="hljs-number">5</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'reg_alpha'</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'reg_lambda'</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'seed'</span>: <span class="hljs-number">38</span>,
&nbsp; &nbsp; <span class="hljs-string">'subsample'</span>: <span class="hljs-number">0.7</span>,&nbsp;
&nbsp; &nbsp; <span class="hljs-string">'verbosity'</span>: <span class="hljs-number">1</span>,
&nbsp; &nbsp; <span class="hljs-string">'learning_rate'</span>:<span class="hljs-number">0.01</span><font></font>
}<font></font>
<font></font>
<font></font>
reg = xgb.XGBRegressor(**params_last, n_estimators=<span class="hljs-number">2000</span>)<font></font>
print(X_train.columns)<font></font>
reg.fit(X_train, y_train,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; eval_set=[(X_val, y_val)],<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; early_stopping_rounds=<span class="hljs-number">20</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; verbose=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
y_pred = reg.predict(X_test)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41c/c3a/372/41cc3a372cc3c4cd7557637ffcea78f5.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lightgbm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LightGBM是Microsoft的框架，其主要优点是对大型数据集的学习速度。</font><font style="vertical-align: inherit;">而且，与XGBoost不同，LightGBM可以处理类别，使用较少的内存。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://medium.com/%40pushkarmandot/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font><font style="vertical-align: inherit;">有更多。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> lightgbm <span class="hljs-keyword">as</span> lgb
<span class="hljs-keyword">from</span> lightgbm <span class="hljs-keyword">import</span> LGBMRegressor
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error<font></font>
<font></font>
<font></font>
stop_day = <span class="hljs-string">'2018-06-01 23:00'</span>
start_day_for_iterate = datetime.strptime(stop_day, <span class="hljs-string">'%Y-%m-%d %H:%M'</span>)<font></font>
test_size = <span class="hljs-number">0.2</span><font></font>
<font></font>
X, y, X_train, X_val, y_train, y_val, X_test, y_test, _ = gen_data(<font></font>
&nbsp; &nbsp; stop_day = stop_day,&nbsp;<font></font>
&nbsp; &nbsp; drop_columns = drop_columns,<font></font>
&nbsp; &nbsp; test_size=test_size,<font></font>
&nbsp; &nbsp; is_dump=<span class="hljs-literal">True</span>,<font></font>
&nbsp; &nbsp; drop_weekend=<span class="hljs-literal">False</span>,<font></font>
&nbsp; &nbsp; is_target_scale=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
model = LGBMRegressor(boosting_type=<span class="hljs-string">'gbdt'</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_leaves=<span class="hljs-number">83</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_depth=<span class="hljs-number">-1</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; learning_rate=<span class="hljs-number">0.008</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n_estimators=<span class="hljs-number">15000</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; max_bin=<span class="hljs-number">255</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subsample_for_bin=<span class="hljs-number">50000</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_split_gain=<span class="hljs-number">0</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_child_weight=<span class="hljs-number">3</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; min_child_samples=<span class="hljs-number">10</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subsample=<span class="hljs-number">0.3</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; subsample_freq=<span class="hljs-number">1</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colsample_bytree=<span class="hljs-number">0.5</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reg_alpha=<span class="hljs-number">0.1</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reg_lambda=<span class="hljs-number">0</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; seed=<span class="hljs-number">38</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; silent=<span class="hljs-literal">False</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nthread=<span class="hljs-number">-1</span>)<font></font>
<font></font>
<font></font>
history = model.fit(X_train, y_train,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eval_metric=<span class="hljs-string">'rmse'</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eval_set=[(X_val, y_val)],<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; early_stopping_rounds=<span class="hljs-number">40</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose = <span class="hljs-number">0</span>)<font></font>
<font></font>
<font></font>
y_pred = model.predict(X_test, num_iteration=model.best_iteration_)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a11/9a0/0a0/a119a00a0e6637edef5c7e533024da8e.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catboost</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CatBoost是来自</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开放源决策树的高级梯度提升库</font><font style="vertical-align: inherit;">。该模型的优势在于，可以方便地处理包含分类特征的数据集-您可以将包含类别的数据传输到模型而无需转换为数字，并且可以手工显示模式无需扭曲，预测的质量仍然很高。</font></font><br>
<br>
<pre><code class="python hljs">cat_features=np.where(X.dtypes == <span class="hljs-string">'category'</span>)[<span class="hljs-number">0</span>]<font></font>
eval_dataset = Pool(X_test, y_test)<font></font>
<font></font>
model = CatBoostRegressor(learning_rate=<span class="hljs-number">0.5</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eval_metric=<span class="hljs-string">'RMSE'</span>,&nbsp;<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; leaf_estimation_iterations=<span class="hljs-number">3</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; depth=<span class="hljs-number">3</span>)<font></font>
<font></font>
model.fit(X_train, y_train,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eval_set=(X_val, y_val),<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cat_features=cat_features,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plot=<span class="hljs-literal">True</span>,<font></font>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verbose=<span class="hljs-literal">True</span>)<font></font>
<font></font>
y_pred = model.predict(X_test)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/986/11f/7f2/98611f7f25c035c0f44d5d99ac4a70b5.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XGBoost与 </font><font style="vertical-align: inherit;">LightGBM与 </font><font style="vertical-align: inherit;">Catboost</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了不重复大量文章，我</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将从此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">给出一个比较表</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/010/910/097/010910097094035b0bc891663bb4b867.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了计算MAPE的错误，我花费了最近的一个月（28天），然后以一个小时的分辨率移动窗口，对接下来的72小时进行了预测。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我的即兴比赛中，奖项是：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第三名：我最喜欢的-XGBoost-预测质量最低；</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二名：CatBoost是最方便的“开箱即用”产品；</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一名：LightGBM最快，最准确。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了更精确地比较模型，我使用了R2（R平方或确定系数，显示了模型的条件方差与实际值的方差相差多少）和RMSLE（均方根对数误差，或均方根对数误差，实际上是距离）在平面上的两个点之间-实际值和预测值）。&nbsp;</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指标</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lightgbm</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catboost</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XGBoost</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预言家</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sarimaax</font></font></b></td>
</tr>
<tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.94137</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.93984</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.92909</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.81435</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.73778</font></font></td>
</tr>
<tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">梅尔</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.02468</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.02477</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.01219</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.00829</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.00658</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，所有这些都与我的任务有关。</font><font style="vertical-align: inherit;">根据其他方面的数据，一切都可能完全不同。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下次，我将分享我们的另一个故事，即预测员工的离职，以完成公司的招聘计划。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺便说一句，我们的团队正在成长，我们正在寻找人才！</font></font></b><div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高级顾问（管理咨询和预算编制）</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高级整合顾问</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitrix24顾问</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRM项目经理</font></font></a></li>
</ul></div></div></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487930/index.html">演讲之夜我想gamedev</a></li>
<li><a href="../zh-CN487932/index.html">Unity（和其他程序）的理想法线贴图</a></li>
<li><a href="../zh-CN487934/index.html">我们如何使用GO工具优化DNS服务器</a></li>
<li><a href="../zh-CN487938/index.html">使用示例任务列表介绍效应器域</a></li>
<li><a href="../zh-CN487940/index.html">R中的可再现计算。如何分离代码和数据？</a></li>
<li><a href="../zh-CN487948/index.html">使用Telegram bot在OpenVPN中进行两因素身份验证</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>