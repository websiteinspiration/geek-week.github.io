<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏿 👎 🐳 Lernereignisverfolgung für Windows: Theorie und Praxis 🏤 🧑‍🤝‍🧑 🚥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag. Vor kurzem musste ich mich mit dem Windows-Ablaufverfolgungsdienst befassen. Dieser Dienst wurde in Windows 2000 veröffentlicht. Es gab jed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lernereignisverfolgung für Windows: Theorie und Praxis</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502362/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guten Tag. </font><font style="vertical-align: inherit;">Vor kurzem musste ich mich mit dem Windows-Ablaufverfolgungsdienst befassen. </font><font style="vertical-align: inherit;">Dieser Dienst wurde in Windows 2000 veröffentlicht. Es gab jedoch nur sehr wenige Artikel zu diesem Dienst im Internet. Daher kam die Idee, diesen Artikel zu schreiben. </font><font style="vertical-align: inherit;">Also fangen wir an! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute werde ich versuchen zu sprechen über:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Theorie des Windows-Ablaufverfolgungsdienstes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen Ihrer ETW-Sitzung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verwenden der Ereignisverfolgungs-API für die Arbeit mit ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verwenden von Tracerpt und Xperf für die Arbeit mit ETW</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theorie des Windows-Ablaufverfolgungsdienstes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event Tracing für Windows (ETW) ist ein Dienst, mit dem Sie Ereignisse von einem oder mehreren Ereignisanbietern in Echtzeit oder aus einer * .etl-Datei für einen bestimmten Zeitraum empfangen können. </font><font style="vertical-align: inherit;">Unverständlich? </font><font style="vertical-align: inherit;">Jetzt lass es uns herausfinden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, wie ETW funktioniert, müssen Sie die Struktur dieses Dienstes verstehen. Die </font></font><br>
<br>
<img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ETW-Architektur enthält 4 Elemente</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventanbieter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event-Konsumenten</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW-Controller</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW-Sitzungen (Event-Tracing-Sitzungen)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Funktionsprinzip ist wie folgt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine Anzahl von Ereignisanbietern ist im System registriert, d.h. </font><font style="vertical-align: inherit;">Anwendungen, die ihre Erfahrungen mit ETW-Sitzungen teilen können. </font><font style="vertical-align: inherit;">Auch in diesem System gibt es eine bestimmte Anzahl aktiver ETW-Sitzungen, die Ereignisse von einem oder mehreren Anbietern verarbeiten und dem Benutzer entweder in Echtzeit zur Verfügung stellen oder alle Ereignisse von Lieferanten in eine Protokolldatei (* .etl) schreiben können. </font><font style="vertical-align: inherit;">Und Controller steuern diese ganze Bewegung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt werden wir jedes Element der oben betrachteten Architektur genauer betrachten, um endlich das Prinzip der Arbeit zu verstehen!</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventanbieter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ereignisanbieter sind Anwendungen, die Ereignisverfolgungstools enthalten. Nachdem sich der Anbieter registriert hat, kann der Controller die Ereignisverfolgung im Anbieter aktivieren oder deaktivieren. Der Anbieter bestimmt seine Interpretation von Ein oder Aus. In der Regel generiert ein aktivierter Anbieter Ereignisse, ein deaktivierter Anbieter jedoch nicht. Auf diese Weise können Sie unserer Anwendung Ereignisverfolgung hinzufügen, ohne dass ständig Ereignisse generiert werden müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Anbieter kann seine Ereignisse für mehrere ETW-Sitzungen gleichzeitig freigeben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedes Ereignis besteht aus zwei Elementen: einem Header und Daten! </font><font style="vertical-align: inherit;">Der Ereigniskopf enthält Informationen zum Ereignis: Anbieterkennung, Ereigniskennung, Zeitstempel usw. </font><font style="vertical-align: inherit;">Der Rest der Daten wird von einem bestimmten Anbieter festgelegt: ETW empfängt alle Daten und schreibt sie in den Puffer, und ihre Interpretation wird den Verbrauchern von Informationen zugewiesen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt vier Haupttypen von Anbietern: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MOF-Anbieter (klassische) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anbieter WPP- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anbieter basierend auf den Manifest- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anbietern TraceLogging. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ereignisanbieter unterscheiden sich in den Feldtypen, die sie in Ereignisnutzdaten speichern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eventanbieter scheinen aussortiert zu sein. </font><font style="vertical-align: inherit;">Mach weiter!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controller </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Controller ist eine Anwendung, die für den Betrieb einer oder mehrerer ETW-Sitzungen verantwortlich ist. </font><font style="vertical-align: inherit;">Es ist der Controller, der die Größe und den Speicherort der Protokolldatei bestimmt, Ereignisverfolgungssitzungen (ETW-Sitzungen) startet und stoppt und es Anbietern ermöglicht, Ereignisse in der Sitzung aufzuzeichnen. </font><font style="vertical-align: inherit;">Wie bereits erwähnt, ist es der Controller, der es dem Anbieter ermöglicht, seine Ereignisse zu teilen!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbraucher </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verbraucher sind Anwendungen, die Ereignisse von einer oder mehreren Ablaufverfolgungssitzungen gleichzeitig empfangen und verarbeiten. </font><font style="vertical-align: inherit;">Verbraucher können Ereignisse empfangen, die in Protokolldateien oder aus Sitzungen gespeichert sind, die Ereignisse in Echtzeit liefern. </font><font style="vertical-align: inherit;">Wie wir bereits wissen, kann eine ETW-Sitzung mehrere Lieferanten haben. </font><font style="vertical-align: inherit;">Es stellt sich die Frage: Wird es Verwirrung geben? </font><font style="vertical-align: inherit;">In welcher Beziehung stehen die Ereignisse der verschiedenen ETW-Sitzungen zueinander? </font><font style="vertical-align: inherit;">Ereignisse werden nach dem Zeitpunkt ihres Auftretens sortiert, d. H. </font><font style="vertical-align: inherit;">Das System liefert Ereignisse in chronologischer Reihenfolge!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW-Sitzungen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ereignisverfolgungssitzungen (ETW-Sitzungen) zeichnen Ereignisse von einem oder mehreren Anbietern auf, die der Controller zulässt. </font><font style="vertical-align: inherit;">Die Sitzung ist auch für die Verwaltung und das Löschen von Puffern verantwortlich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Ereignisverfolgung unterstützt bis zu 64 Ereignisverfolgungssitzungen, die gleichzeitig ausgeführt werden. </font><font style="vertical-align: inherit;">Von diesen Sitzungen gibt es zwei spezielle Sitzungen. </font><font style="vertical-align: inherit;">Die verbleibenden Sitzungen stehen für den allgemeinen Gebrauch zur Verfügung. </font><font style="vertical-align: inherit;">Zwei spezielle Sitzungen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Globale Loggersitzung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NT Kernel Logger Session</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine Global Logger-Ereignisablaufverfolgungssitzung zeichnet Ereignisse auf, die zu Beginn des Startvorgangs des Betriebssystems auftreten, z. B. solche, die von Gerätetreibern generiert werden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Kernel Logger für NT-Ereignisverfolgungssitzungen zeichnet vordefinierte Systemereignisse auf, die vom Betriebssystem generiert wurden, z. B. Festplatten-E / A-Ereignisse oder Seitenfehler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, jetzt lass uns üben !!!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Ihrer ETW-Sitzung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor wir mit der Arbeit beginnen, benötigen wir Kenntnisse über verschiedene Dienstprogramme, nämlich: eine </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste der Anbieter, die auf einem bestimmten Betriebssystem verfügbar sind</font></font><br>
<br>
<pre><code class="bash hljs">logman query providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erhalten Sie vollständige Informationen über den Anbieter</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp &lt; &gt; /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste aller aktiven ETW-Sitzungen</font></font><br>
<br>
<pre><code class="bash hljs">xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Anzeigen von Dateien ist außerdem Notepad ++ ratsam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir uns die Liste der Anbieter auf Ihrem Computer angesehen haben (und es gibt mehr als 1000 unter Windows 10), wählen wir einen für unsere Sitzung aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/6e/wm/hl6ewmoxww9guutq7rt9m_rnfug.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe Microsoft-Windows-WinINet ausgewählt (dieser Dienst zeichnet alle unsere Aktionen auf, wenn Sie im Microsoft Edge-Browser arbeiten). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Win + R -&gt; compmgmt.msc </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. "Leistung" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. " </font><font style="vertical-align: inherit;">Datenkollektorsätze </font><font style="vertical-align: inherit;">" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. "Ereignisablaufverfolgungssitzungen" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. "Neu" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. "Datenkollektorsatz" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Geben Sie den Namen des Datenkollektors an. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. "Manuell erstellen (Erweitert)" (Manuell hinzufügen (für erfahrene) ") </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/ec/_w/gkec_w2zlyy-m_jo25bm2bfgx38.png" alt="Bild"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9. Interessant hinzufügen uns Anbieter pro Sitzung</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10. Geben Sie die für uns interessanten Schlüsselwörter in das Feld „Schlüsselwörter (beliebig)“ ein - 0xFFFFFFFFFFFFFFFFFFFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11. </font><font style="vertical-align: inherit;">Geben Sie </font><font style="vertical-align: inherit;">die Protokollierungsstufe 0xFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= </font></font><img src="https://habrastorage.org/webt/d7/yw/3w/d7yw3w3ondmdrmeb_avfvnafa7y.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12 an. Wählen Sie den Pfad aus, in dem die Sitzungsprotokolldatei gespeichert werden soll </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Starten Sie diesen Datenkollektorsatz jetzt. “(„ Führen Sie jetzt die Gruppe der Datenkollektoren aus “) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun funktioniert die von uns erstellte Sitzung. Microsoft Edge benötigt einige Arbeit, damit die Sitzung Informationen über uns sammelt! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einiger Zeit gehen wir zu dem Ort, an dem wir die Protokolldatei gespeichert haben. Wir führen dort den folgenden Befehl aus.</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">"   .etl"</span> -o -report -summary -lr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach Ausführung dieses Befehls werden 4 Dateien generiert. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/e_/rp/upe_rph8_bnkvfuemiai0lquv0w.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind derzeit an dumpfile.xml interessiert. </font><font style="vertical-align: inherit;">Sie können diese Datei entweder über Notepad ++ öffnen, dies können Sie auch in Excel tun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem Sie diese Datei sorgfältig studiert haben, können Sie sehen, dass diese Sitzung fast alle Informationen über unsere Bewegung im Internet gesammelt hat !!! </font><font style="vertical-align: inherit;">Hier können Sie mehr darüber lesen. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir studieren ETW und extrahieren Gewinne</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, und wir gehen weiter. </font><font style="vertical-align: inherit;">Wir haben gerade eine Sitzung mit einem einzelnen Ereignisanbieter erstellt. </font><font style="vertical-align: inherit;">Empfangene Sitzungsdaten aus der Protokolldatei. </font><font style="vertical-align: inherit;">Es ist Zeit zu codieren!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden der Ereignisverfolgungs-API für die Arbeit mit ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf habr gibt es einen interessanten Artikel, die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schlechteste API, die jemals erstellt wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel finden Sie Antworten auf viele Fragen, die Sie höchstwahrscheinlich beim Schreiben von Bewerbungen haben werden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden in C ++ codieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit dem einfachsten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurieren und starten Sie eine Ereignisverfolgungssitzung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Betrachten Sie zunächst die allgemeine Idee. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So starten Sie eine Ablaufverfolgungssitzung: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Legen Sie die Struktur EVENT_TRACE_PROPERTIES fest. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Starten Sie die Sitzung mit StartTrace </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Aktivieren Sie anschließend die Ereignisanbieter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Aktivieren Sie die Anbieter mit EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Ablaufverfolgungssitzung zu stoppen, müssen Sie: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Bevor Sie die Ablaufverfolgungssitzung beenden, müssen Sie die Anbieter mit EnableTrace | deaktivieren EnableTraceEx | EnableTraceEx2, EVENT_CONTROL_CODE_DISABLE_PROVIDER übergeben </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Rufen Sie die ControlTrace-Funktion auf und übergeben Sie sie EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im folgenden Beispiel erstelle ich eine Sitzung mit dem Namen MyEventTraceSession. </font><font style="vertical-align: inherit;">Die Protokolldatei im aktuellen Verzeichnis heißt WriteThePuth.etl. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Ereignisanbieter ist Microsoft-Windows-Kernel-Process. </font><font style="vertical-align: inherit;">Sie können seine GUID mit herausfinden</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp Microsoft-Windows-Kernel-Process /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code direkt:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#include &lt;windows.h&gt;</span>
<span class="hljs-meta">#include &lt;stdio.h&gt;</span>
<span class="hljs-meta">#include &lt;conio.h&gt;</span>
<span class="hljs-meta">#include &lt;strsafe.h&gt;</span>
<span class="hljs-meta">#include &lt;wmistr.h&gt;</span>
<span class="hljs-meta">#include &lt;evntrace.h&gt;</span>
<span class="hljs-meta">#include &lt;iostream&gt;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGFILE_PATH L"WriteThePuth.etl"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGSESSION_NAME L"MyEventTraceSession"</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,     .</span>
<span class="hljs-comment">//      GUID .</span><font></font>
<font></font>
<span class="hljs-comment">// {AE44CB98-BD11-4069-8093-770EC9258A12}</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID SessionGuid =<font></font>
{ <span class="hljs-number">0xae44cb98</span>, <span class="hljs-number">0xbd11</span>, <span class="hljs-number">0x4069</span>, { <span class="hljs-number">0x80</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xe</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x12</span> } };<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,   ,   </span>
<span class="hljs-comment">//    .</span><font></font>
<font></font>
<span class="hljs-comment">//{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} Microsoft-Windows-Kernel-Process</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID ProviderGuid =<font></font>
{ <span class="hljs-number">0xd22FB2CD6</span>, <span class="hljs-number">0x0E7B</span>, <span class="hljs-number">0x422B</span>, {<span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x16</span> } };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wmain</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span><font></font>
{<font></font>
    setlocale(LC_ALL, <span class="hljs-string">"ru"</span>);<font></font>
    ULONG status = ERROR_SUCCESS;<font></font>
    TRACEHANDLE SessionHandle = <span class="hljs-number">0</span>;<font></font>
    EVENT_TRACE_PROPERTIES* pSessionProperties = NULL;<font></font>
    ULONG BufferSize = <span class="hljs-number">0</span>;<font></font>
    BOOL TraceOn = TRUE;<font></font>
<font></font>
    <font></font>
    BufferSize = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    pSessionProperties = (EVENT_TRACE_PROPERTIES*)malloc(BufferSize);<font></font>
    <span class="hljs-keyword">if</span> (NULL == pSessionProperties)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"Unable to allocate %d bytes for properties structure.\n"</span>, BufferSize);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    ZeroMemory(pSessionProperties, BufferSize);<font></font>
    pSessionProperties-&gt;Wnode.BufferSize = BufferSize;<font></font>
    pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;<font></font>
    pSessionProperties-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>; <span class="hljs-comment">//QPC clock resolution</span><font></font>
    pSessionProperties-&gt;Wnode.Guid = SessionGuid;<font></font>
    pSessionProperties-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;<font></font>
    pSessionProperties-&gt;MaximumFileSize = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1024 MB</span>
    pSessionProperties-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);<font></font>
    pSessionProperties-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    StringCbCopy((LPWSTR)((<span class="hljs-keyword">char</span>*)pSessionProperties + pSessionProperties-&gt;LogFileNameOffset), <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH), LOGFILE_PATH);<font></font>
    <font></font>
<font></font>
    status = StartTrace((PTRACEHANDLE)&amp;SessionHandle, LOGSESSION_NAME, pSessionProperties);<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"StartTrace() failed with %lu\n"</span>, status);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ,   ,      .</span><font></font>
<font></font>
    status = EnableTraceEx2(<font></font>
        SessionHandle,<font></font>
        (LPCGUID)&amp;ProviderGuid,<font></font>
        EVENT_CONTROL_CODE_ENABLE_PROVIDER,<font></font>
        TRACE_LEVEL_INFORMATION,<font></font>
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,<font></font>
        NULL<font></font>
        );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"EnableTrace() failed with %lu\n"</span>, status);<font></font>
        TraceOn = FALSE;<font></font>
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   .    ,   </span>
    wprintf(L<span class="hljs-string">"Run the provider application. Then hit any key to stop the session.\n"</span>);<font></font>
    _getch();<font></font>
   <font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-keyword">if</span> (SessionHandle)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (TraceOn)<font></font>
        {<font></font>
            status = EnableTraceEx2(<font></font>
                SessionHandle,<font></font>
                (LPCGUID)&amp;ProviderGuid,<font></font>
                EVENT_CONTROL_CODE_DISABLE_PROVIDER,<font></font>
                TRACE_LEVEL_INFORMATION,<font></font>
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,<font></font>
                NULL<font></font>
                );<font></font>
        }<font></font>
<font></font>
        status = ControlTrace(SessionHandle, LOGSESSION_NAME, pSessionProperties, EVENT_TRACE_CONTROL_STOP);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
        {<font></font>
            wprintf(L<span class="hljs-string">"ControlTrace(stop) failed with %lu\n"</span>, status);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pSessionProperties)<font></font>
    {<font></font>
        free(pSessionProperties);<font></font>
        pSessionProperties = NULL;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden das obige Programm genauer analysieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Festlegen der Struktur EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eine Ereignisablaufverfolgungssitzung zu konfigurieren, müssen Sie die Struktur EVENT_TRACE_PROPERTIES verwenden, um Sitzungseigenschaften anzugeben. Der Speicher, den Sie für die Struktur EVENT_TRACE_PROPERTIES zuweisen, muss groß genug sein, um auch die Namen der Sitzungs- und Protokolldateien zu enthalten, die der Struktur im Speicher folgen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Starten Sie die Sitzung mit StartTrace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem Sie die Eigenschaften der Sitzung angegeben haben, rufen Sie die StartTrace-Funktion auf, um die Sitzung zu starten. Wenn die Funktion erfolgreich ist, enthält der Parameter SessionHandle den Sitzungsdeskriptor und die Eigenschaft LoggerNameOffset den Offset des Sitzungsnamens.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Schalten Sie Anbieter mit EnableTrace | ein EnableTraceEx | EnableTraceEx2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Anbieter zu aktivieren, denen das Aufzeichnen von Ereignissen in Ihrer Sitzung gestattet werden soll, rufen Sie die EnableTrace-Funktion auf, um klassische Anbieter zu aktivieren, und die EnableTraceEx-Funktion, um manifestbasierte Anbieter zu aktivieren. In anderen Fällen - EnableTraceEx2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Bevor Sie die Ablaufverfolgungssitzung beenden, müssen Sie Anbieter mit EnableTrace | deaktivieren EnableTraceEx | Aktivieren SieTraceEx2, indem Sie EVENT_CONTROL_CODE_DISABLE_PROVIDER übergeben</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Ablaufverfolgungssitzung nach dem Sammeln von Ereignissen zu stoppen, rufen Sie die ControlTrace-Funktion auf und übergeben Sie EVENT_TRACE_CONTROL_STOP als Steuercode. Um eine zu stoppende Sitzung anzugeben, können Sie den Sitzungsdeskriptor der Ereignisablaufverfolgung, der aus einem früheren Aufruf erhalten wurde, an die StartTrace-Funktion oder den Namen einer zuvor gestarteten Sitzung übergeben. Stellen Sie sicher, dass Sie alle Anbieter trennen, bevor Sie die Sitzung beenden. Wenn Sie die Sitzung beenden, bevor Sie den Provider zum ersten Mal ausschalten, trennt ETW den Provider und versucht, die Provider-Rückrufsteuerungsfunktion aufzurufen. Wenn die Anwendung, die die Sitzung gestartet hat, beendet wird, ohne den Anbieter zu trennen oder die ControlTrace-Funktion aufzurufen, bleibt der Anbieter aktiviert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Um die Ablaufverfolgungssitzung zu stoppen, rufen Sie die ControlTrace-Funktion auf und übergeben Sie sie EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir im obigen Beispiel gesehen haben, ist die Verwendung der Ereignisverfolgungs-API nicht die einfachste. </font><font style="vertical-align: inherit;">Je nachdem, was Sie tun, können Sie weiterhin Ereignisanbieter oder Ereigniskonsumenten schreiben. </font><font style="vertical-align: inherit;">Beide Aufgaben sind jedoch recht umfangreich und werden in diesem Artikel nicht berücksichtigt! </font><font style="vertical-align: inherit;">Zusätzliche Komplexität wird durch 4 Arten von Ereignisanbietern und dementsprechend 4 Optionen zum Schreiben von Ereignissen und 4 Optionen für deren Konsum erzeugt. </font><font style="vertical-align: inherit;">Die Arbeit mit der Event-Tracing-API wird auf der offiziellen Microsoft-Website </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit Event-Tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausführlich und ausführlich beschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich einige Zeit mit der Event-Tracing-API gearbeitet hatte, hatte ich die Frage: Gibt es Dienstprogramme, die mein Leben vereinfachen?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden von Tracerpt und Xperf für die Arbeit mit ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Kapitel werde ich diese Dienstprogramme aus theoretischer Sicht nicht betrachten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem Befehl Tracerpt können Sie Ereignisablaufverfolgungsprotokolle, vom Leistungsmonitor generierte Protokolldateien und Echtzeit-Ereignisablaufverfolgungsanbieter analysieren. </font><font style="vertical-align: inherit;">Es werden Speicherauszugsdateien, Berichtsdateien und Berichtsschemata erstellt. </font><font style="vertical-align: inherit;">Dieses Dienstprogramm verfügt über eine große Anzahl von Parametern, aber das folgende "Minimum" eignet sich zum Starten der Arbeit</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">" 1- .etl"</span> ... <span class="hljs-string">" n- .etl"</span> -o &lt;   &gt; -report &lt;    &gt; -summary&lt;    &gt; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Dienstprogramm xperf.exe ist ein vollwertiger Controller. </font><font style="vertical-align: inherit;">Es unterstützt Befehlszeilenargumente zum Verwalten von ETW-Anbietern und -Sitzungen. </font><font style="vertical-align: inherit;">Controller können den Status aktuell aktiver Sitzungen anfordern und Listen aller im System registrierten Anbieter empfangen. </font><font style="vertical-align: inherit;">Verwenden Sie beispielsweise den folgenden Befehl, um alle aktiven Sitzungen abzurufen:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwenden Sie den folgenden Befehl, um eine Liste aller im System registrierten Anbieter zu erhalten:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Controller verfügen über einige weitere wichtige Funktionen. </font><font style="vertical-align: inherit;">Sie können Sitzungen aktualisieren und Puffer auf die Festplatte leeren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles für jetzt! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider habe ich in diesem Artikel einige interessante Themen nicht angesprochen (z. B. den Verbrauch von Ereignissen in Echtzeit oder die Arbeit mit speziellen Sitzungen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können darüber auf den folgenden Websites lesen: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ereignisverfolgung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - offizielle Microsoft-Dokumentation. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir untersuchen ETW und extrahieren die Vorteile der </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ereignisverfolgung für Windows auf der bösen Seite. </font><font style="vertical-align: inherit;">Dies ist jedoch nicht gerade die </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schlechteste API, die jemals erstellt wurde</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502350/index.html">Reverse Engineering des Klangverstärkers einer beliebten tragbaren Konsole - Erörterung der wichtigsten Ergebnisse</a></li>
<li><a href="../de502352/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 344 (12. - 17. Mai)</a></li>
<li><a href="../de502354/index.html">IaaS-Anbieter kämpfen für den europäischen Markt und diskutieren die Situation und Branchenereignisse</a></li>
<li><a href="../de502358/index.html">Implementierung von MVP basierend auf ApplicationController und IoC in einer WinForms-Anwendung</a></li>
<li><a href="../de502360/index.html">Grizzly Discharges oder Super Drill</a></li>
<li><a href="../de502366/index.html">Vergleichen Sie die Arbeit von Open Source Python - Bibliotheken zur Erkennung benannter Entitäten</a></li>
<li><a href="../de502368/index.html">Wir pumpen das Laufband</a></li>
<li><a href="../de502370/index.html">Das Spiel "Snake" auf das Steckbrett legen. Teil 1: Zustandsautomaten</a></li>
<li><a href="../de502372/index.html">Probleme und Prinzipien der Anpassung der Box-Version von Bitrix24</a></li>
<li><a href="../de502374/index.html">FT8-Kommunikationsprotokoll - wie es funktioniert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>