<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Å üë©üèΩ‚Äçüè´ üë®üèø Packer, Terraform e Ansible: implanta√ß√£o do cluster Kubernetes em uma hora üôéüèø ‚ò∏Ô∏è üõ£Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Andrey Schukin, ajudo grandes empresas a migrar servi√ßos e sistemas para a CROC Cloud. Juntamente com colegas de Southbridge, que mini...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Packer, Terraform e Ansible: implanta√ß√£o do cluster Kubernetes em uma hora</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/492616/"><img src="https://habrastorage.org/webt/0m/2c/zt/0m2cztx1saqv1v7e8a3mrliht_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√°, meu nome √© Andrey Schukin, ajudo grandes empresas a migrar servi√ßos e sistemas para a CROC Cloud. Juntamente com colegas de Southbridge, que ministram cursos de Kubernetes no centro de treinamento Slerm, recentemente realizamos um webinar para nossos clientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi pegar os materiais de uma excelente palestra de Pavel Selivanov e escrever um post para aqueles que est√£o come√ßando a trabalhar com ferramentas de provisionamento em nuvem e n√£o sabem por onde come√ßar. Portanto, falarei sobre a pilha de tecnologias usadas em nosso treinamento e produ√ß√£o do CROC Cloud. Vamos falar sobre abordagens modernas para gerenciamento de infraestrutura, sobre o pacote de componentes Packer, Terraform e Ansible, bem como sobre a ferramenta Kubeadm com a qual executaremos a instala√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sob o corte, haver√° muito texto e configura√ß√µes. </font><font style="vertical-align: inherit;">H√° muito material, ent√£o eu adicionei a navega√ß√£o p√≥s. </font><font style="vertical-align: inherit;">Tamb√©m preparamos um pequeno reposit√≥rio onde colocamos tudo o que precisamos para nossa implanta√ß√£o de treinamento. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o d√™ nomes √†s galinhas. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bolos assados ‚Äã‚Äãs√£o mais saud√°veis ‚Äã‚Äãque fritos. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßamos o forno. </font><font style="vertical-align: inherit;">Packer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infraestrutura como c√≥digo </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iniciar a </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estrutura do </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Terraform </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Cluster </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Reposit√≥rio </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Kubernetes </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com todos os arquivos</font></font></a><br>
 <a name="habracut"></a><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o d√™ nomes a galinhas</font></font></h2><br>
<img src="https://habrastorage.org/webt/j0/0w/v1/j00wv1h7pcevviakk2iocfleqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos conceitos diferentes de gerenciamento de infraestrutura. Um deles √© chamado Pets vs. Gado, isto √©, "animais de estima√ß√£o contra animais". Este conceito descreve duas abordagens opostas √† infraestrutura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que temos um cachorro favorito. N√≥s cuidamos dela, o levamos ao veterin√°rio, penteamos o p√™lo e, em geral, √© √∫nico para n√≥s entre muitos outros c√£es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em outro caso, temos um galinheiro. Tamb√©m cuidamos de galinhas, alimentamos, aquecemos e tentamos criar as condi√ß√µes mais confort√°veis. No entanto, as galinhas s√£o um recurso sem rosto para n√≥s, que cumpre sua fun√ß√£o de p√¥r ovos, e, na melhor das hip√≥teses, as designamos como ‚Äúaquele preto em p√≥ que sempre bica cimento‚Äù. Se a galinha parar de p√¥r ovos ou quebrar a pata, provavelmente fornecer√° um delicioso caldo para o almo√ßo. De fato, n√£o nos importamos com o destino de uma galinha individual, mas com o galinheiro como um todo como uma linha de produ√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na √°rea de TI, uma abordagem semelhante come√ßou a ser aplicada assim que as ferramentas apareceram, reduzindo o limite de entrada para os engenheiros e possibilitando implantar e manter clusters complexos em um modo totalmente autom√°tico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, t√≠nhamos um pequeno n√∫mero de servidores que eram monitorados, ajustados manualmente e tratados de todas as maneiras poss√≠veis. No monitoramento, os logs dos servidores Cthulhu, Aylith e Dagon piscaram. Tradi√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o a virtualiza√ß√£o entrou firmemente em nossas vidas, e os nomes das obras de Lovecraft e Star Trek deram lugar ao mais vantajoso "vlg-vlt-vault01.company.ru". Existem muitos servidores, mas ainda aumentamos os servi√ßos mais ou menos manualmente, eliminando os problemas em cada m√°quina, se necess√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, a abordagem para manter a infraestrutura coincide completamente com a programa√ß√£o. </font><font style="vertical-align: inherit;">Adicionamos outro n√≠vel de abstra√ß√£o e paramos de nos preocupar com n√≥s individuais. </font><font style="vertical-align: inherit;">Cada um tem um √≠ndice sem rosto em vez de um nome e, no caso de um problema, a m√°quina virtual simplesmente mata e sobe a partir do instant√¢neo de trabalho. </font><font style="vertical-align: inherit;">Existem ferramentas que permitem implementar essa abordagem. </font><font style="vertical-align: inherit;">No nosso caso, a primeira ferramenta √© a nuvem CROC, a segunda √© a Terraform.</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bolos assados ‚Äã‚Äãs√£o mais saud√°veis ‚Äã‚Äãque fritos</font></font></h2><br>
<img src="https://habrastorage.org/webt/hs/pp/oa/hsppoaujv0lhrk0u3dt6ust0rry.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No gerenciamento de infraestrutura, h√° um contraste entre as duas abordagens Fried vs. Assado, ou seja, "frito contra assado". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A abordagem Fried implica que voc√™ tem uma imagem do SO baunilha, por exemplo, CentOS 7. Depois de implantar o SO, usamos o sistema de gerenciamento de configura√ß√£o para trazer o sistema ao estado de destino. Por exemplo, usando Ansible, Chef, Puppet ou SaltStack.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo funciona bem, especialmente quando n√£o h√° muitos servidores. Quando h√° necessidade de uma implanta√ß√£o maci√ßa, nos deparamos com problemas de desempenho. Centenas de servidores come√ßam a consumir sincronicamente recursos de rede, CPU, RAM e IOPS no processo de lan√ßamento de muitos pacotes novos. Al√©m disso, esse processo pode ser adiado por um longo tempo. Em resumo, o circuito √© absolutamente operacional, mas n√£o t√£o interessante do ponto de vista de minimizar o tempo de inatividade durante acidentes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A abordagem Baked implica que voc√™ possui imagens de SO prontas em que j√° instalou todos os pacotes necess√°rios, configurou a configura√ß√£o e tudo mais. </font><font style="vertical-align: inherit;">Na sa√≠da, temos um modelo de instant√¢neo abstrato, aprimorado para o desempenho de alguma fun√ß√£o. </font><font style="vertical-align: inherit;">A implanta√ß√£o da infraestrutura a partir dessas imagens processadas leva muito menos tempo e reduz ao m√≠nimo o tempo de inatividade. </font><font style="vertical-align: inherit;">Uma ideologia muito semelhante √© usada nas imagens Docker de v√°rias camadas, nas quais ningu√©m aperta as m√£os desnecessariamente. </font><font style="vertical-align: inherit;">Pregou o recipiente - pegou um novo.</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßamos o forno. </font><font style="vertical-align: inherit;">Packer</font></font></h2><br>
<img src="https://habrastorage.org/webt/xw/mr/im/xwmrimtkl-6qvfcrae3xo4zdf7q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nossa infraestrutura, usamos v√°rios produtos Hashicorp, alguns dos quais se mostraram extremamente bem-sucedidos. Vamos come√ßar nossa m√°gica com a prepara√ß√£o e o cozimento de uma imagem usando a ferramenta Packer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Packer usa um modelo JSON, ou seja, arquivos de modelo que cont√™m uma descri√ß√£o do que precisa ser obtido como uma m√°quina virtual "VM". Ap√≥s criar o modelo, o arquivo √© transferido para o Packer e as permiss√µes necess√°rias para criar o servidor na nuvem s√£o configuradas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Packer permite que voc√™ crie VMs localmente no KVM, VirtualBox, Vagrant, AWS, GCP, Alibaba Cloud, OpenStack etc. √â conveniente trabalhar com o Packer na CROC Cloud, pois implementa interfaces da AWS, ou seja, todas as ferramentas criadas para AWS, trabalhe com a CROC Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s definir os modelos necess√°rios, o Packer eleva o VM CROC na nuvem, aguarda o in√≠cio e, em seguida, o "provedor" entra no fornecedor de trabalho: um utilit√°rio que deve concluir a prepara√ß√£o da imagem. </font><font style="vertical-align: inherit;">No nosso caso, isso √© Ansible, embora o Packer possa trabalhar com outras op√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a VM est√° pronta, o Packer cria sua imagem e a coloca na nuvem CROC para que outras VMs possam ser iniciadas a partir da mesma imagem.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura Base.json</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No in√≠cio do arquivo, h√° uma se√ß√£o na qual as vari√°veis ‚Äã‚Äãs√£o declaradas:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"variables" : {<font></font>
 "source_ami_name": "{{env SOURCE_AMI_NAME}}",<font></font>
 "ami_name": "{{env AMI_NAME}}",<font></font>
 "instance_type": "{{env INSTANCE_TYPE}}",<font></font>
 "kubernetes_version": "{{env KUBERNETES_VERSION}}",<font></font>
 "docker_version": "{{env DOCKER_VERSION}}",<font></font>
 "subnet_id": "",<font></font>
 "availability_zone": "",<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O conjunto principal dessas vari√°veis ‚Äã‚Äãser√° definido no arquivo settings.json. </font><font style="vertical-align: inherit;">E aquelas vari√°veis ‚Äã‚Äãque mudam com frequ√™ncia s√£o mais convenientes de serem definidas no console ao iniciar o Packer e criar uma nova imagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir est√° a se√ß√£o Construtores:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"builders" : [<font></font>
 {<font></font>
  "type": "amazon-ebs",<font></font>
  "region": "croc",<font></font>
  "skip_region_validation": true,<font></font>
  "custom_endpoint_ec2": "https://api.cloud.croc.ru",<font></font>
  "source_ami": "",<font></font>
  "source_ami_filter": {<font></font>
   "filters": {<font></font>
    "name": "{{user `source_ami_name`}}"<font></font>
    "state": "available",<font></font>
    "virtualization-type": "kvm-virtio"<font></font>
     },<font></font>
...</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuvens de destino e o m√©todo de inicializa√ß√£o da VM s√£o descritos aqui. Observe que, neste caso, o tipo amazon-ebs √© declarado, mas para a opera√ß√£o do Packer com a nuvem CROC, o endere√ßo correspondente em custom_endpoint_ec2 √© definido. Nossa infraestrutura possui uma API que √© quase completamente compat√≠vel com o Amazon Web Services; portanto, se voc√™ tiver desenvolvimentos prontos para esta plataforma, na maioria das vezes precisar√° especificar apenas um ponto de entrada da API personalizado - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.cloud.croc.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em nosso exemplo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale a pena notar a se√ß√£o source_ami_filter separadamente. </font><font style="vertical-align: inherit;">Aqui √© definida a imagem inicial da VM, na qual as altera√ß√µes necess√°rias ser√£o feitas. </font><font style="vertical-align: inherit;">No entanto, o Packer requer uma AMI para esta imagem, ou seja, seu identificador aleat√≥rio. </font><font style="vertical-align: inherit;">Como esse identificador raramente √© conhecido com anteced√™ncia e muda a cada atualiza√ß√£o, a AMI de origem √© definida n√£o como um valor espec√≠fico, mas como uma vari√°vel source_ami_filter. </font><font style="vertical-align: inherit;">Nesse caso, o par√¢metro determinante do filtro √© o nome da imagem. </font><font style="vertical-align: inherit;">Este nome √© definido nas vari√°veis ‚Äã‚Äãatrav√©s do arquivo settings.json. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, as configura√ß√µes da VM s√£o definidas: o tipo de inst√¢ncia, processador, tamanho da mem√≥ria, espa√ßo alocado etc. s√£o especificados:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"instance_type": "{{user `instance_type`}}",<font></font>
"launch_block_device_mappings": [<font></font>
 {<font></font>
  "device_name": "disk1",<font></font>
  "volume_type": "io1",<font></font>
  "volume_size": "8",<font></font>
  "iops": "1000",<font></font>
  "delete_on_termination": "true"<font></font>
 }<font></font>
],</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, em base.json est√£o os par√¢metros para conectar-se a esta VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"availability_zone": "{{user `availability_zone`}}",<font></font>
"subnet_id": "{{user `subnet_id`}}",<font></font>
"associate_public_ip_address": true,<font></font>
"ssh_username": "ec2-user",<font></font>
"ami_name": "{{user `ami_name`}}"<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante observar o par√¢metro subnet_id aqui. </font><font style="vertical-align: inherit;">Ele deve ser definido manualmente, porque sem especificar a sub-rede da VM na nuvem CROC, √© imposs√≠vel criar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro par√¢metro que requer prepara√ß√£o pr√©via √© o endere√ßo_public_ip_administrativo. </font><font style="vertical-align: inherit;">Voc√™ precisa selecionar um endere√ßo IP branco, porque depois de criar o VM Packer come√ßar√° a aplicar as configura√ß√µes necess√°rias atrav√©s do Ansible. </font><font style="vertical-align: inherit;">Nesse caso, o Ansible se conecta √† VM via SSH, o que requer um endere√ßo IP ou VPN branco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima se√ß√£o √© dos Provisioners:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"provisioners": [<font></font>
 {<font></font>
  "type": "ansible",<font></font>
  "playbook_file": "playbook.yml",<font></font>
  "extra_arguments": [<font></font>
   "--extra-vars",<font></font>
   "kubernetes_version={{user `kubernetes_version`}}",<font></font>
   "--extra-vars",<font></font>
   "docker_version={{user `docker_version`}}"<font></font>
   ]<font></font>
  }<font></font>
]</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses s√£o os provedores, ou seja, os utilit√°rios com os quais o Packer configura o servidor. </font><font style="vertical-align: inherit;">Nesse caso, o provedor do tipo ansible √© usado. </font><font style="vertical-align: inherit;">A seguir, √© apresentado o par√¢metro playbook_file, que define as fun√ß√µes Ansible e os hosts nos quais as fun√ß√µes especificadas ser√£o aplicadas. </font><font style="vertical-align: inherit;">Op√ß√µes adicionais extra_arguments s√£o apresentadas abaixo, as quais, ao iniciar o Ansible, transmitem vers√µes do Kubernetes e Docker.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prepara√ß√£o para a nuvem CROC</font></font></h3><br>
 <img src="https://habrastorage.org/webt/23/_s/uo/23_suoef0us5ia6kjgn8xteomba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m dos nossos arquivos de configura√ß√£o, precisamos fazer algumas coisas na lateral do painel de controle da nuvem para que toda a m√°gica funcione. </font><font style="vertical-align: inherit;">Precisamos selecionar um IP branco e criar uma sub-rede funcional, que usaremos ao implantar.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clique em Real√ßar endere√ßo. </font><font style="vertical-align: inherit;">O Packer encontrar√° o endere√ßo IP branco desejado por conta pr√≥pria.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clique em Criar sub-rede e especifique uma sub-rede e uma m√°scara. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copie o ID da sub-rede. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insira esse valor no par√¢metro subnet_id do comando de inicializa√ß√£o do Packer. </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/24/0w/gp/240wgpvzi8oyy6ixwzdj8cougqk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, execute o Packer. </font><font style="vertical-align: inherit;">Ele encontra a imagem original da VM, a implanta na nuvem CROC e executa a fun√ß√£o Ansible nela. </font><font style="vertical-align: inherit;">A nova VM pode ser vista na nuvem CROC na se√ß√£o "Inst√¢ncias". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/aj/ui/olajuiprqljv50bi2opn4xlqcvs.png"> <br>
 <br>
<img src="https://habrastorage.org/webt/rq/0d/ri/rq0drint5cwvddjxbd7czcyfp9a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s concluir o trabalho, o Packer remove a VM da nuvem e deixa uma imagem pronta em seu lugar, que pode ser encontrada na se√ß√£o "Modelos". </font><font style="vertical-align: inherit;">Toda a infraestrutura do Kubernetes ser√° criada a partir desta imagem.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencionado anteriormente, o par√¢metro playbook √© passado nos par√¢metros do provedor Ansible. </font><font style="vertical-align: inherit;">O arquivo playbook.yml se parece com o seguinte:</font></font><br>
<br>
<pre><code class="plaintext hljs">- hosts: all<font></font>
  become: true<font></font>
<font></font>
  roles:<font></font>
  | - base</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo √© transferido para o Ansible que em todos os hosts √© necess√°rio cumprir a fun√ß√£o de base. </font><font style="vertical-align: inherit;">Se houver outras fun√ß√µes, voc√™ poder√° adicion√°-las ao mesmo arquivo que uma lista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o base permite que voc√™ obtenha um cluster pronto com um √∫nico comando. </font><font style="vertical-align: inherit;">O arquivo main.yml mostra o que exatamente essa fun√ß√£o faz:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adiciona um reposit√≥rio do Docker ao modelo do sistema. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adiciona o reposit√≥rio Kubernetes ao modelo do sistema. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instala os pacotes necess√°rios. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cria um diret√≥rio para configurar o daemon do Docker. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura a m√°quina de acordo com o arquivo de configura√ß√£o daemon.json.j2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carrega o kernel br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inclui as op√ß√µes necess√°rias para br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inclui componentes Docker e Kubelet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Executa o Docker na VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Executa um comando que baixa as imagens do Docker necess√°rias para o Kubernetes funcionar.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, os pacotes instalados s√£o configurados no arquivo main.yml no diret√≥rio vars. </font><font style="vertical-align: inherit;">No nosso caso, instalamos o pacote docker-ce, bem como os tr√™s pacotes necess√°rios para o Kubernetes funcionar: kubelet, kubeadm e kubectl.</font></font><br>
<br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infraestrutura como c√≥digo</font></font></h2><br>
<img src="https://habrastorage.org/webt/o4/um/wi/o4umwitq-qh_zpwr0thmcmejis0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform √© uma ferramenta muito funcional da HashiCorp para orquestra√ß√£o de nuvens. Ele possui seu pr√≥prio idioma HCL espec√≠fico, que √© frequentemente usado em outros produtos da empresa, por exemplo, no HashiCorp Vault e Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio b√°sico √© semelhante a todos os sistemas de gerenciamento de configura√ß√£o. Voc√™ simplesmente indica o estado de destino no formato desejado e o sistema calcula o algoritmo de como conseguir isso. Outra coisa √© que, ao contr√°rio do mesmo Ansible, que funciona como uma caixa preta em playbooks complexos, o Terraform pode fornecer um plano de a√ß√µes futuras de uma forma conveniente para an√°lise. Isso √© importante ao planejar altera√ß√µes complexas na infraestrutura. Ap√≥s planejar as a√ß√µes necess√°rias, execute o comando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terraform apply</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o Terraform implementar√° a infraestrutura descrita nos arquivos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o Packer, essa ferramenta oferece suporte √† AWS, GCP, Alibaba Cloud, Azure, OpenStack, VMware, etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s descrevemos o projeto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O diret√≥rio Terraform possui um conjunto de arquivos com a extens√£o .tf. </font><font style="vertical-align: inherit;">Esses arquivos descrevem os componentes da infraestrutura com a qual trabalharemos. </font><font style="vertical-align: inherit;">Divida o projeto em m√≥dulos funcionais. </font><font style="vertical-align: inherit;">Essa estrutura facilita o controle de vers√£o e a montagem de cada projeto a partir de blocos pr√°ticos prontos. </font><font style="vertical-align: inherit;">Para nossa op√ß√£o, a seguinte estrutura √© adequada:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security_groups.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tpl</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura do arquivo Main.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com o arquivo main.tf, no qual o acesso √† nuvem est√° configurado. </font><font style="vertical-align: inherit;">Em particular, s√£o anunciados v√°rios par√¢metros que configuram o Terraform para funcionar com a nuvem CROC:</font></font><br>
<br>
<pre><code class="plaintext hljs">provider "aws" {<font></font>
 endpoints {<font></font>
  ec2 = "https://api.cloud.croc.ru"<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, o arquivo descreve que o Terraform deve criar independentemente uma chave privada e fazer upload de sua parte p√∫blica para todos os servidores. </font><font style="vertical-align: inherit;">A pr√≥pria chave privada √© emitida no final do Terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "tls_private_key" "ssh" {<font></font>
 algorithm = "RSA"<font></font>
}<font></font>
resource "aws_key_pair" "kube" {<font></font>
 key_name = "terraform"<font></font>
 public_key = "${tls_private_key.ssh.public_key_openssh}"<font></font>
}<font></font>
output "ssh" {<font></font>
value = "${tls_private_key.ssh.private_key_pem}"<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A estrutura do arquivo network.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este arquivo descreve os componentes de rede necess√°rios para iniciar a VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">data "aws_availability_zones" "az" {<font></font>
 state = "available"<font></font>
}<font></font>
resource "aws_vpc" "kube" {<font></font>
 cidr_block = "${var.vpc_cidr}"<font></font>
}<font></font>
resource "aws_eip" "master" {<font></font>
 count = "1"<font></font>
 vpc = true<font></font>
}<font></font>
resource "aws_subnet" "private" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 count = "${length(data.aws_availability_zones.az.names)}"<font></font>
 cidr_block = "${var.private_subnet_cidr_list[count.index]}"<font></font>
 availability_zone = "${data.aws_availability_zones.az.names[count.index]}"<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Terraform usa dois tipos de componentes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recurso - o que precisa ser criado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dados - o que voc√™ precisa obter.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, o par√¢metro data indica que o Terraform deve receber as zonas de disponibilidade da nuvem especificada, que est√£o no estado dispon√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro recurso de par√¢metro descreve a cria√ß√£o de uma nuvem privada virtual e o pr√≥ximo par√¢metro descreve a cria√ß√£o de Endere√ßo IP El√°stico. Para o cluster Kubernetes, solicitamos esse endere√ßo IP atrav√©s do Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, em cada uma das zonas de acessibilidade e, no momento, o CROC possui dois servi√ßos em nuvem, sua pr√≥pria sub-rede √© criada. Um recurso do tipo aws_subnet √© declarado e o ID do aws_vpc gerado √© passado como parte desse par√¢metro. Mas, como o ID desse recurso ainda √© desconhecido, especificamos o par√¢metro aws_vpc.kube.id, que se refere ao recurso criado e substitui o valor do campo ID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o n√∫mero de sub-redes criadas √© determinado pelo n√∫mero de zonas de disponibilidade da nuvem e esse n√∫mero pode mudar com o tempo, esse par√¢metro √© definido atrav√©s da vari√°vel length (data.aws_availability_zones.az.names), ou seja, o comprimento da lista de zonas de acesso recebidas por meio do par√¢metro data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dois √∫ltimos par√¢metros s√£o cidr_block (a sub-rede alocada) e a zona de disponibilidade na qual essa sub-rede √© criada. </font><font style="vertical-align: inherit;">O √∫ltimo par√¢metro tamb√©m √© definido por meio de uma vari√°vel que obt√©m um valor da lista de dados de acordo com o √≠ndice do loop declarado por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[count.index]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura do arquivo Security_groups.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grupos de seguran√ßa s√£o um tipo de firewall para nuvens, que pode ser criado n√£o dentro da pr√≥pria VM, mas pela nuvem. </font><font style="vertical-align: inherit;">Nesse caso, o firewall descreve duas regras. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira regra cria um grupo de seguran√ßa chamado kube. </font><font style="vertical-align: inherit;">Esse grupo de seguran√ßa √© necess√°rio para permitir todo o tr√°fego de sa√≠da dos n√≥s do Kubernetes, permitindo que os n√≥s acessem livremente a Internet. </font><font style="vertical-align: inherit;">O tr√°fego de entrada para n√≥s Kubernetes das sub-redes dos pr√≥prios n√≥s tamb√©m √© permitido. </font><font style="vertical-align: inherit;">Assim, os n√≥s do Kubernetes podem trabalhar entre si sem restri√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda regra cria o grupo de seguran√ßa ssh. </font><font style="vertical-align: inherit;">Ele permite a conex√£o SSH de qualquer endere√ßo IP √† porta 22 da VM do cluster Kubernetes:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_security_group" "kube" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "kubernetes"<font></font>
 # Allow all outbound<font></font>
 egress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
 # Allow all internal<font></font>
 ingress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["${var.vpc_cidr}"]<font></font>
 }<font></font>
}<font></font>
resource "aws_security_group" "ssh" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "ssh"<font></font>
<font></font>
 # Allow all inbound<font></font>
 ingress {<font></font>
  from_port = 22<font></font>
  to_port = 22<font></font>
  protocol = "tcp"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥ mestre. </font><font style="vertical-align: inherit;">Estrutura de arquivos Master.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo master.tf descreve a cria√ß√£o de v√°rios modelos e inst√¢ncias. </font><font style="vertical-align: inherit;">Em particular, uma inst√¢ncia principal do Kubernetes est√° sendo criada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vari√°vel ami define a AMI da imagem de origem para a VM. </font><font style="vertical-align: inherit;">A seguir, descreve o tipo de VM e a sub-rede na qual ela √© criada. </font><font style="vertical-align: inherit;">Ao definir uma sub-rede, um ciclo √© novamente usado para criar VMs em cada zona de disponibilidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, os grupos de seguran√ßa usados ‚Äã‚Äãe a chave especificada no arquivo main.tf s√£o declarados. </font><font style="vertical-align: inherit;">O campo user_data cont√©m a execu√ß√£o de um conjunto de scripts cloud-init, cujos resultados ser√£o implementados na VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_instance" "master" {<font></font>
 count = "1"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"<font></font>
 disable_api_termination = false<font></font>
 instance_initiated_shutdown_behavior = "terminate"<font></font>
 source_dest_check = false<font></font>
 subnet_id = "${aws_subnet.private.*.id[count.index % length(data.aws_availability_zones.az.names)]}"<font></font>
 associate_public_ip_address = true<font></font>
 vpc_security_group_ids = [<font></font>
  "${aws_security_group.ssh.id}",<font></font>
  "${aws_security_group.kube.id}",<font></font>
 ]<font></font>
 key_name = "${aws_key_pair.kube.key_name}"<font></font>
 user_data = "${data.template_cloudinit_config.master.rendered}"<font></font>
 monitoring = "true"<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥ mestre. </font><font style="vertical-align: inherit;">Cloud init</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Cloud-init</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma ferramenta que a Canonical est√° desenvolvendo. </font><font style="vertical-align: inherit;">Ele permite que voc√™ execute automaticamente em uma infraestrutura de nuvem um determinado conjunto de comandos ap√≥s iniciar uma VM. </font><font style="vertical-align: inherit;">O Terraform possui mecanismos para se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integrar a ele usando modelos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como √© imposs√≠vel ‚Äúassar‚Äù tudo o que √© necess√°rio na VM, ap√≥s iniciar, dependendo do seu tipo, ele deve ingressar no cluster Kubernetes ou inicializar o cluster Kubernetes. </font><font style="vertical-align: inherit;">No modelo de arquivo cloud-init chamado master.tpl, v√°rias a√ß√µes s√£o executadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Os arquivos de configura√ß√£o do Kubeadm s√£o registrados:</font></font><br>
<br>
<pre><code class="plaintext hljs">#cloud-config<font></font>
<font></font>
    write_files:<font></font>
    - path: etc/kubernetes/kubeadm.conf<font></font>
      owner: root:root<font></font>
      content:<font></font>
    ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Um conjunto de comandos √© executado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o endere√ßo IP do assistente √© gravado no arquivo de configura√ß√£o gerado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o mestre no cluster Kubernetes √© inicializado com o comando kubeadm init;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no cluster Kubernetes, a rede de sobreposi√ß√£o Calico √© instalada com o comando kubectl apply.</font></font></li>
</ul><br>
 <pre><code class="plaintext hljs">runcmd:<font></font>
         - sed -i "s/CONTROL_PLANE_IP/$(curl http://169.254.169.254/latest/meta-data-local-ipv4)/g" /etc/kubernetes/kubeadm.conf<font></font>
         - kubeadm init --config /etc/kubernetes/kubeadm.conf<font></font>
         - mkdir -p $HOME/.kube<font></font>
         - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
         - sudo chown $(id -u):$(id -g) $HOME/.kube/config<font></font>
         - kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de executar os comandos ao iniciar a VM, um cluster Kubernetes em funcionamento √© obtido de um n√≥ principal. </font><font style="vertical-align: inherit;">Os n√≥s restantes ingressar√£o neste n√≥ principal.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s comuns. </font><font style="vertical-align: inherit;">node.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo node.tf √© semelhante ao arquivo master.tf. </font><font style="vertical-align: inherit;">Recursos tamb√©m s√£o criados aqui, que nesse caso s√£o chamados de n√≥. </font><font style="vertical-align: inherit;">A √∫nica diferen√ßa √© que o n√≥ principal √© criado em uma √∫nica inst√¢ncia e o n√∫mero de n√≥s em funcionamento criados √© definido atrav√©s da vari√°vel nodes_count:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "aws_instance" "node" {<font></font>
 count = "${var.nodes_count}"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo cloud-init para n√≥s de trabalho executa apenas um comando - kubeadm join. </font><font style="vertical-align: inherit;">Este comando anexa a m√°quina finalizada ao cluster Kubernetes usando o token de autoriza√ß√£o que enviamos.</font></font><br>
<br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lan√ßamento Terraform</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando lan√ßado, o Terraform usa v√°rios m√≥dulos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo AWS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulo de modelo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo TLS respons√°vel pela gera√ß√£o de chaves. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estes m√≥dulos devem ser instalados na m√°quina local:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform init terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juntamente com este comando, √© indicado o diret√≥rio em que todos os arquivos necess√°rios est√£o localizados. </font><font style="vertical-align: inherit;">Ao inicializar, o Terraform baixa todos os m√≥dulos especificados, ap√≥s o qual voc√™ precisa executar o comando plano de terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform plan -var-file terraform/vars/dev.tfvars terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que, al√©m do diret√≥rio com os arquivos do Terraform, √© indicado o arquivo var, que cont√©m os valores das vari√°veis ‚Äã‚Äãusadas nos arquivos do Terraform. </font><font style="vertical-align: inherit;">O diret√≥rio vars pode conter v√°rios arquivos .tfvars, o que permite gerenciar diferentes tipos de infra-estruturas com um conjunto de arquivos Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥prio arquivo dev.tfvars cont√©m as seguintes vari√°veis ‚Äã‚Äãimportantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_version (vers√£o instal√°vel do Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_ami (imagem AMI criada pelo Packer). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s definir os valores necess√°rios das vari√°veis, execute o comando do plano de terraform, ap√≥s o qual o Terraform apresentar√° uma lista de a√ß√µes necess√°rias para atingir o estado descrito nos arquivos do Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s verificar esta lista, aplique as altera√ß√µes propostas: </font></font><br>
<br>
<code>terraform apply -auto-approve -var-file terraform/vars/dev.tfvars terraform/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No comando do plano de terraform, ele se distingue pela presen√ßa de uma chave - aprova√ß√£o autom√°tica, que elimina a necessidade de confirmar as altera√ß√µes feitas. </font><font style="vertical-align: inherit;">Voc√™ pode omitir essa chave, mas cada a√ß√£o precisar√° ser confirmada manualmente.</font></font><br>
<br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura de Cluster Kubernetes</font></font></h2><br>
<img src="https://habrastorage.org/webt/zs/i-/c3/zsi-c326-ips2acfurg_trunzhm.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cluster Kubernetes consiste em um n√≥ mestre que executa fun√ß√µes de gerenciamento e n√≥s de trabalho que executam aplicativos instalados no cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quatro componentes s√£o instalados no n√≥ principal que garantem a opera√ß√£o deste sistema:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETCD, ou seja, banco de dados Kubernetes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor API, atrav√©s do qual armazenamos informa√ß√µes no Kubernetes e obtemos informa√ß√µes dele;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controller Manager</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agendador </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dois componentes adicionais s√£o instalados nos n√≥s de trabalho:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kube-proxy (respons√°vel por gerar regras de rede no cluster Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubelet (respons√°vel por enviar o comando ao daemon do Docker para executar aplicativos no cluster Kubernetes). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre os n√≥s, o plug-in de rede Calico funciona.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrama de fluxo de trabalho de cluster</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oz/ew/f3/ozewf310dnhdmnx2gg4ozhzb1rc.png"><br>
,      Kubernetes    replicaset.<br>
<br>
<ol>
<li>     API-,     ETCD.        .</li>
<li>API-      .</li>
<li>Controller-manager   API-   ,    ¬´¬ª,    .</li>
<li>Scheduler       .       ETCD  API-.</li>
<li>Kubelet  API-  Docker    .</li>
<li>Docker   .</li>
<li>Kubelet   API-   ,     .</li>
</ol><br>
 ,    Kubernetes  ,      .       ,           ,     YAML-.  ,   ,    API-.       .<br>
</div></div><br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm</font></font></h2><br>
<img src="https://habrastorage.org/webt/wd/sw/cu/wdswcujzvnx4ynnrbi_ec9c1gr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O √∫ltimo elemento que vale a pena mencionar √© o Kubeadm. </font><font style="vertical-align: inherit;">A implanta√ß√£o de um novo cluster Kubernetes √© sempre um processo minucioso. </font><font style="vertical-align: inherit;">Em cada est√°gio, h√° riscos de erros devido ao fator humano, e muitas tarefas s√£o simplesmente muito rotineiras e longas. </font><font style="vertical-align: inherit;">Por exemplo, servindo certificados para criptografia TLS entre n√≥s e mantendo-os atualizados. </font><font style="vertical-align: inherit;">√â aqui que os utilit√°rios para automa√ß√£o b√°sica de modelos s√£o √∫teis. </font><font style="vertical-align: inherit;">O truque do Kubeadm √© que ele √© oficialmente certificado para trabalhar com o Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele permite que voc√™:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instale, configure e execute todos os principais componentes de cluster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerenciar certificados, incluindo rotacion√°-los e redigir novos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerenciar vers√µes de componentes de cluster (atualiza√ß√£o e downgrade). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, o Kubeadm n√£o √© um sistema completo de gerenciamento de cluster Kubernetes, mas √© um tipo de componente b√°sico que permite configurar o Kubernetes no n√≥ no qual o utilit√°rio Kubeadm est√° sendo executado. </font><font style="vertical-align: inherit;">Isso significa que √© necess√°rio um sistema de orquestra√ß√£o que execute todas as VMs necess√°rias, configure-as e execute o Kubeadm em todos os n√≥s. </font><font style="vertical-align: inherit;">√â para esses fins que o Terraform √© usado.</font></font><br>
<br>
<a name="8"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reposit√≥rio com todos os arquivos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, colocamos todos os arquivos e configura√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em um √∫nico local, para que seja mais conveniente para voc√™. </font><font style="vertical-align: inherit;">Se voc√™ n√£o possui uma nuvem privada em m√£os, mas deseja executar todas essas etapas e testar a implanta√ß√£o na pr√°tica, escreva-nos para cloud@croc.ru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Forneceremos uma vers√£o demo para testes e aconselharemos sobre todos os problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em breve haver√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">novo Slurm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde voc√™ poder√° criar seu pr√≥prio cluster. </font><font style="vertical-align: inherit;">O c√≥digo promocional CROC tem um desconto de 10%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para quem j√° trabalha com o Kubernetes, h√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curso avan√ßado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O desconto √© o mesmo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colegas, Habraparser quebra a marca√ß√£o do c√≥digo. </font><font style="vertical-align: inherit;">Por favor, pegue a fonte do GitHub no link acima.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492600/index.html">Guia Semi-Cient√≠fico para Hospedar um Roteador WiFi</a></li>
<li><a href="../pt492604/index.html">Trabalhando com o View de forma ass√≠ncrona usando coroutine</a></li>
<li><a href="../pt492606/index.html">Problemas do kit de ferramentas em grandes projetos</a></li>
<li><a href="../pt492608/index.html">Apresenta recursos de entrega em grandes projetos</a></li>
<li><a href="../pt492612/index.html">Plafon decorativo Leek Celebrity</a></li>
<li><a href="../pt492628/index.html">Intervalo de confian√ßa para o n√∫mero de pacientes com coronav√≠rus (c√°lculo da mortalidade)</a></li>
<li><a href="../pt492632/index.html">Pequenas empresas em quarentena: o p√¢nico √© o inimigo da raz√£o</a></li>
<li><a href="../pt492636/index.html">O que significa ser eficaz?</a></li>
<li><a href="../pt492638/index.html">Escalando um aplicativo Redux com patos</a></li>
<li><a href="../pt492642/index.html">Crie uma arquitetura escal√°vel e resiliente com microsservi√ßos din√¢micos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>