<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê≠ üëã üç£ An√°lise de escape da mec√¢nica da linguagem ‚ù£Ô∏è üíü üåû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prel√∫dio
 Este √© o segundo dos quatro artigos de uma s√©rie que fornecer√° informa√ß√µes sobre a mec√¢nica e o design de ponteiros, pilhas, pilhas, an√°lise...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>An√°lise de escape da mec√¢nica da linguagem</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497994/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prel√∫dio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© o segundo dos quatro artigos de uma s√©rie que fornecer√° informa√ß√µes sobre a mec√¢nica e o design de ponteiros, pilhas, pilhas, an√°lise de escape e sem√¢ntica de Go / Value. </font><font style="vertical-align: inherit;">Este post √© sobre pilhas e an√°lise de escape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√çndice:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√¢nica da linguagem em pilhas e ponteiros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tradu√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√¢nica da linguagem na an√°lise de escape</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√¢nica da linguagem no perfil de mem√≥ria</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filosofia de Design em Dados e Sem√¢ntica</font></font></a></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro post desta s√©rie, falei sobre o b√°sico da mec√¢nica de ponteiros usando um exemplo em que o valor √© distribu√≠do na pilha entre goroutines. N√£o mostrei o que acontece quando voc√™ divide o valor na pilha. Para entender isso, voc√™ precisa descobrir sobre outra √°rea da mem√≥ria onde os valores podem estar: sobre a "pilha". Com esse conhecimento, voc√™ pode come√ßar a estudar "an√°lise de escape".</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A an√°lise de escape √© um processo que o compilador usa para determinar o posicionamento dos valores criados pelo seu programa. </font><font style="vertical-align: inherit;">Em particular, o compilador executa an√°lise de c√≥digo est√°tico para determinar se o valor pode ser colocado no quadro da pilha para a fun√ß√£o que o cria ou se o valor deve ser "escapado" para o heap. </font><font style="vertical-align: inherit;">N√£o existe uma √∫nica palavra-chave ou fun√ß√£o no Go que voc√™ possa usar para informar ao compilador qual decis√£o tomar. </font><font style="vertical-align: inherit;">Somente a maneira como voc√™ escreve seu c√≥digo condicionalmente permite influenciar essa decis√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mont√µes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um heap √© uma segunda √°rea de mem√≥ria, al√©m da pilha, usada para armazenar valores. A pilha n√£o √© auto-limpante como pilhas, portanto, usar essa mem√≥ria √© mais caro. Antes de tudo, os custos est√£o associados ao coletor de lixo (GC), que deve manter essa √°rea limpa. Quando o GC iniciar, ele usar√° 25% da energia dispon√≠vel do seu processador. Al√©m disso, pode potencialmente criar microssegundos de atrasos do tipo "pare o mundo". A vantagem de ter um GC √© que voc√™ n√£o precisa se preocupar em gerenciar a mem√≥ria heap que historicamente √© complexa e propensa a erros.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valores no heap provocam aloca√ß√µes de mem√≥ria no Go. </font><font style="vertical-align: inherit;">Essas aloca√ß√µes pressionam o GC porque todos os valores no heap aos quais o ponteiro n√£o se refere mais devem ser exclu√≠dos. </font><font style="vertical-align: inherit;">Quanto mais valores voc√™ precisar verificar e excluir, mais trabalho o GC deve realizar a cada in√≠cio. </font><font style="vertical-align: inherit;">Portanto, o algoritmo de estimula√ß√£o trabalha constantemente para equilibrar o tamanho da pilha e a velocidade de execu√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compartilhamento de pilha</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Go, nenhuma goroutine pode ter um ponteiro apontando para uma mem√≥ria na pilha de outra goroutine. </font><font style="vertical-align: inherit;">Isso se deve ao fato de que a mem√≥ria da pilha para goroutines pode ser substitu√≠da por um novo bloco de mem√≥ria, quando a pilha deve aumentar ou diminuir. </font><font style="vertical-align: inherit;">Se, em tempo de execu√ß√£o, voc√™ tivesse que rastrear os ponteiros da pilha em outra goroutine, teria que gerenciar demais, e o atraso "pare o mundo" ao atualizar os ponteiros para essas pilhas seria impressionante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um exemplo de uma pilha que √© substitu√≠da v√°rias vezes devido ao crescimento. </font><font style="vertical-align: inherit;">Observe a sa√≠da nas linhas 2 e 6. Voc√™ ver√° duas vezes as altera√ß√µes de endere√ßo do valor da string dentro do quadro principal da pilha. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/pxn5u4EBSI</font></font></a> <br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mec√¢nica de escape</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sempre que um valor √© compartilhado fora da regi√£o do quadro de pilha de uma fun√ß√£o, ele √© colocado (ou alocado) em um heap. A tarefa dos algoritmos de an√°lise de escape √© encontrar essas situa√ß√µes e manter o n√≠vel de integridade no programa. Integridade √© garantir que o acesso a qualquer valor seja sempre preciso, consistente e eficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√™ uma olhada neste exemplo para aprender os mecanismos b√°sicos da an√°lise de escape. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/Y_VZxYteKO</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Listagem 1</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">package</span> main
<span class="hljs-number">02</span>
<span class="hljs-number">03</span> <span class="hljs-keyword">type</span> user <span class="hljs-keyword">struct</span> {
<span class="hljs-number">04</span>     name  <span class="hljs-keyword">string</span>
<span class="hljs-number">05</span>     email <span class="hljs-keyword">string</span>
<span class="hljs-number">06</span> }
<span class="hljs-number">07</span>
<span class="hljs-number">08</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
<span class="hljs-number">09</span>     u1 := createUserV1()
<span class="hljs-number">10</span>     u2 := createUserV2()
<span class="hljs-number">11</span>
<span class="hljs-number">12</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"u1"</span>, &amp;u1, <span class="hljs-string">"u2"</span>, &amp;u2)
<span class="hljs-number">13</span> }
<span class="hljs-number">14</span>
<span class="hljs-number">15</span> <span class="hljs-comment">//go:noinline</span>
<span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }
<span class="hljs-number">25</span>
<span class="hljs-number">26</span> <span class="hljs-comment">//go:noinline</span>
<span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu uso a diretiva go: noinline para que o compilador n√£o incorpore o c√≥digo para essas fun√ß√µes diretamente no main. A incorpora√ß√£o remover√° chamadas de fun√ß√£o e complicar√° este exemplo. Vou falar sobre os efeitos colaterais da incorpora√ß√£o no pr√≥ximo post.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A Listagem 1 mostra um programa com duas fun√ß√µes diferentes que criam um valor do tipo usu√°rio e o devolvem ao chamador. A primeira vers√£o da fun√ß√£o usa a sem√¢ntica do valor ao retornar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 2</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu disse que a fun√ß√£o usa a sem√¢ntica de valores ao retornar, porque um valor do tipo usu√°rio criado por essa fun√ß√£o √© copiado e passado para a pilha de chamadas. Isso significa que a fun√ß√£o de chamada recebe uma c√≥pia do pr√≥prio valor.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ pode ver a cria√ß√£o de um valor do tipo usu√°rio, executado nas linhas 17 a 20. Em seguida, na linha 23, uma c√≥pia do valor √© passada para a pilha de chamadas e retornada ao chamador. Depois de retornar a fun√ß√£o, a pilha fica da seguinte maneira. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagem 1 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/me/pj/hsmepjswe1d_ggonuc8jkwscyk8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na Figura 1, voc√™ pode ver que existe um valor do tipo user nos dois quadros ap√≥s chamar createUserV1. Na segunda vers√£o da fun√ß√£o, a sem√¢ntica do ponteiro √© usada para retornar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 3</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu disse que uma fun√ß√£o usa sem√¢ntica de ponteiro ao retornar, porque um valor do tipo usu√°rio criado por essa fun√ß√£o √© compartilhado pela pilha de chamadas. Isso significa que a fun√ß√£o de chamada recebe uma c√≥pia do endere√ßo onde os valores est√£o localizados.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ pode ver o mesmo literal estrutural usado nas linhas 28 a 31 para criar um valor do tipo user, mas na linha 34 o retorno da fun√ß√£o √© diferente. Em vez de passar uma c√≥pia do valor de volta para a pilha de chamadas, uma c√≥pia do endere√ßo para o valor √© passada. Com base nisso, voc√™ pode pensar que ap√≥s a chamada a pilha fica assim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagem 2</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/ld/nh/muldnhq-xncjaz97pv-647tybme.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o que voc√™ v√™ na Figura 2 realmente estiver acontecendo, voc√™ ter√° um problema de integridade. </font><font style="vertical-align: inherit;">Um ponteiro aponta para uma pilha de chamadas para a mem√≥ria que n√£o s√£o mais v√°lidas. </font><font style="vertical-align: inherit;">Na pr√≥xima vez que a fun√ß√£o for chamada, a mem√≥ria indicada ser√° reformatada e reinicializada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que a an√°lise de escape come√ßa a manter a integridade. </font><font style="vertical-align: inherit;">Nesse caso, o compilador determinar√° que n√£o √© seguro criar um valor do tipo user dentro do quadro de pilha createUserV2, portanto, em vez disso, criar√° um valor no heap. </font><font style="vertical-align: inherit;">Isso acontecer√° imediatamente durante a constru√ß√£o na linha 28.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legibilidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ aprendeu em uma postagem anterior, uma fun√ß√£o tem acesso direto √† mem√≥ria dentro de seu quadro atrav√©s do ponteiro do quadro, mas o acesso √† mem√≥ria fora do quadro requer acesso indireto. Isso significa que o acesso aos valores que caem no heap tamb√©m deve ser feito indiretamente por meio de um ponteiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se da apar√™ncia do c√≥digo createUserV2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 4</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A sintaxe oculta o que realmente acontece neste c√≥digo. A vari√°vel u declarada na linha 28 representa um valor do tipo usu√°rio. A constru√ß√£o em Go n√£o informa exatamente onde o valor est√° armazenado na mem√≥ria; portanto, antes da declara√ß√£o de retorno na linha 34, voc√™ n√£o sabe que o valor ser√° empilhado. Isso significa que, embora u represente um valor do tipo usu√°rio, o acesso a esse valor deve ser por meio de um ponteiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode visualizar uma pilha que se parece com isso ap√≥s uma chamada de fun√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagem 3</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5u/ya/sv/5uyasv63ozdef8jclixqpv4anx4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vari√°vel u no quadro da pilha para createUserV2 representa o valor na pilha, n√£o na pilha. </font><font style="vertical-align: inherit;">Isso significa que usar u para acessar um valor requer acesso a um ponteiro, n√£o o acesso direto sugerido pela sintaxe. </font><font style="vertical-align: inherit;">Voc√™ pode pensar, por que n√£o fazer um ponteiro imediatamente, j√° que acessar o valor que ele representa ainda requer o uso de um ponteiro? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 5</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := &amp;user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ fizer isso, perder√° a legibilidade, que n√£o poderia ser perdida em seu c√≥digo. </font><font style="vertical-align: inherit;">Afaste-se do corpo da fun√ß√£o por um segundo e concentre-se apenas no retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 6</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre o que esse retorno est√° falando? </font><font style="vertical-align: inherit;">Tudo o que ele diz √© que uma c√≥pia de voc√™ √© colocada na pilha de chamadas. </font><font style="vertical-align: inherit;">Enquanto isso, o que return indica quando voc√™ usa o operador &amp;? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 7</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gra√ßas ao operador &amp; return, ele agora informa que voc√™ est√° compartilhando a pilha de chamadas e, portanto, sai para a pilha. Lembre-se de que os ponteiros devem ser usados ‚Äã‚Äãjuntos e, ao ler o c√≥digo, eles substituem o operador &amp; pela frase "compartilhamento". √â muito poderoso em termos de legibilidade. Isso √© algo que eu n√£o gostaria de perder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° outro exemplo em que a constru√ß√£o de valores usando a sem√¢ntica de ponteiros diminui a legibilidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 8</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">var</span> u *user
<span class="hljs-number">02</span> err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(r), &amp;u)
<span class="hljs-number">03</span> <span class="hljs-keyword">return</span> u, err</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que esse c√≥digo funcione, quando voc√™ chama json.Unmarshal na linha 02, deve passar um ponteiro para uma vari√°vel de ponteiro. Uma chamada json.Unmarshal criar√° um valor do tipo usu√°rio e atribuir√° seu endere√ßo a uma vari√°vel de ponteiro. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">play.golang.org/p/koI8EjpeIx</font></font></a> </i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O que este c√≥digo diz: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01: Crie um ponteiro do tipo usu√°rio com um valor nulo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
02: Compartilhe u vari√°vel com a fun√ß√£o json.Unmarshal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
03: Retorne uma c√≥pia da vari√°vel u para o chamador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© totalmente √≥bvio que um valor do tipo usu√°rio criado pela fun√ß√£o json.Unmarshal seja passado para o chamador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a legibilidade muda ao usar a sem√¢ntica de valores durante a declara√ß√£o de vari√°vel? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 9</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">01</span> <span class="hljs-keyword">var</span> u user
<span class="hljs-number">02</span> err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(r), &amp;u)
<span class="hljs-number">03</span> <span class="hljs-keyword">return</span> &amp;u, err</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que este c√≥digo diz: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01: Crie um valor do tipo user com um valor nulo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
02: Compartilhe u vari√°vel com a fun√ß√£o json.Unmarshal. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
03: Compartilhe a vari√°vel u com o chamador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo est√° muito claro. </font><font style="vertical-align: inherit;">A linha 02 divide o valor do usu√°rio do tipo na pilha de chamadas em json.Unmarshal e a linha 03 divide o valor da pilha de chamadas de volta para o chamador. </font><font style="vertical-align: inherit;">Esse compartilhamento far√° com que o valor seja movido para o heap. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use a sem√¢ntica dos valores ao criar valores e aproveite a legibilidade do operador &amp; para esclarecer como os valores s√£o separados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relat√≥rios do compilador</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ver as decis√µes tomadas pelo compilador, voc√™ pode solicitar ao compilador que forne√ßa um relat√≥rio. </font><font style="vertical-align: inherit;">Tudo o que voc√™ precisa fazer √© usar a op√ß√£o -gcflags com a op√ß√£o -m ao chamar go build. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, voc√™ pode usar 4 n√≠veis de -m, mas ap√≥s 2 n√≠veis de informa√ß√£o, isso se torna demais. </font><font style="vertical-align: inherit;">Vou usar 2 n√≠veis -m. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 10</font></font><br>
<br>
<pre><code class="bash hljs">$ go build -gcflags <span class="hljs-string">"-m -m"</span><font></font>
./main.go:16: cannot inline createUserV1: marked go:noinline<font></font>
./main.go:27: cannot inline createUserV2: marked go:noinline<font></font>
./main.go:8: cannot inline main: non-leaf <span class="hljs-keyword">function</span><font></font>
./main.go:22: createUserV1 &amp;u does not escape<font></font>
./main.go:34: &amp;u escapes to heap<font></font>
./main.go:34:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34<font></font>
./main.go:31: moved to heap: u<font></font>
./main.go:33: createUserV2 &amp;u does not escape<font></font>
./main.go:12: main &amp;u1 does not escape<font></font>
./main.go:12: main &amp;u2 does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ver que o compilador est√° relatando decis√µes para despejar o valor no heap. </font><font style="vertical-align: inherit;">O que o compilador diz? </font><font style="vertical-align: inherit;">Primeiro, observe novamente as fun√ß√µes createUserV1 e createUserV2 para atualiz√°-las na mem√≥ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 13</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">16</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV1</span><span class="hljs-params">()</span> <span class="hljs-title">user</span></span> {
<span class="hljs-number">17</span>     u := user{
<span class="hljs-number">18</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">19</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">20</span>     }
<span class="hljs-number">21</span>
<span class="hljs-number">22</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V1"</span>, &amp;u)
<span class="hljs-number">23</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">24</span> }<font></font>
<font></font>
<span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, &amp;u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> &amp;u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com esta linha no relat√≥rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 14</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:22: createUserV1 &amp;u does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso sugere que a chamada para a fun√ß√£o println dentro da fun√ß√£o createUserV1 n√£o faz com que o tipo de usu√°rio seja despejado no heap. Este caso teve que ser verificado porque √© usado em conjunto com a fun√ß√£o println. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, observe estas linhas no relat√≥rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 15</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:34: &amp;u escapes to heap<font></font>
./main.go:34:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34<font></font>
./main.go:31: moved to heap: u<font></font>
./main.go:33: createUserV2 &amp;u does not escape</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas linhas dizem que o valor do tipo de usu√°rio associado √† vari√°vel u, que tem o tipo de usu√°rio nomeado e √© criado na linha 31, √© despejado no heap devido ao retorno na linha 34. A √∫ltima linha diz o mesmo de antes, println call na linha 33 n√£o redefine o tipo de usu√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A leitura desses relat√≥rios pode ser confusa e pode variar um pouco, dependendo se o tipo da vari√°vel em quest√£o √© baseado em um tipo nomeado ou literal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifique a vari√°vel u para ser o usu√°rio do tipo literal * em vez do usu√°rio do tipo nomeado, como era antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 16</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-number">27</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">createUserV2</span><span class="hljs-params">()</span> *<span class="hljs-title">user</span></span> {
<span class="hljs-number">28</span>     u := &amp;user{
<span class="hljs-number">29</span>         name:  <span class="hljs-string">"Bill"</span>,
<span class="hljs-number">30</span>         email: <span class="hljs-string">"bill@ardanlabs.com"</span>,
<span class="hljs-number">31</span>     }
<span class="hljs-number">32</span>
<span class="hljs-number">33</span>     <span class="hljs-built_in">println</span>(<span class="hljs-string">"V2"</span>, u)
<span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> u
<span class="hljs-number">35</span> }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o relat√≥rio novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listagem 17</font></font><br>
<br>
<pre><code class="bash hljs">./main.go:30: &amp;user literal escapes to heap<font></font>
./main.go:30:     from u (assigned) at ./main.go:28<font></font>
./main.go:30:     from ~r0 (<span class="hljs-built_in">return</span>) at ./main.go:34</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, o relat√≥rio diz que o valor do tipo de usu√°rio referenciado pela vari√°vel u, que possui o tipo literal * user e criado na linha 28, √© despejado no heap devido ao retorno na linha 34.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criar um valor n√£o determina onde ele est√° localizado. </font><font style="vertical-align: inherit;">Somente como o valor √© dividido determinar√° o que o compilador far√° com esse valor. </font><font style="vertical-align: inherit;">Cada vez que voc√™ compartilha um valor na pilha de chamadas, ele √© despejado no heap. </font><font style="vertical-align: inherit;">H√° outras raz√µes pelas quais um valor pode escapar da pilha. </font><font style="vertical-align: inherit;">Vou falar sobre eles no pr√≥ximo post.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo dessas postagens √© fornecer orienta√ß√µes sobre como escolher usar sem√¢ntica de valor ou sem√¢ntica de ponteiro para qualquer tipo. </font><font style="vertical-align: inherit;">Cada sem√¢ntica √© combinada com lucro e valor. </font><font style="vertical-align: inherit;">A sem√¢ntica dos valores armazena os valores na pilha, o que reduz a carga no GC. </font><font style="vertical-align: inherit;">No entanto, existem c√≥pias diferentes do mesmo valor que devem ser armazenadas, rastreadas e mantidas. </font><font style="vertical-align: inherit;">A sem√¢ntica do ponteiro coloca valores em uma pilha, o que pode pressionar o GC. </font><font style="vertical-align: inherit;">No entanto, eles s√£o eficazes porque existe apenas um valor que precisa ser armazenado, rastreado e mantido. </font><font style="vertical-align: inherit;">O ponto principal √© o uso de cada sem√¢ntica de maneira correta, consistente e equilibrada.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt497982/index.html">Abordagem funcional e de processo para gerenciamento. Como e o que gerenciar?</a></li>
<li><a href="../pt497984/index.html">Migrando do reCAPTCHA para o hCaptcha no Cloudflare</a></li>
<li><a href="../pt497986/index.html">Monitorando toda a mem√≥ria usada por uma p√°gina da Web: performance.measureMemory ()</a></li>
<li><a href="../pt497988/index.html">React Profiling Application Profiling</a></li>
<li><a href="../pt497990/index.html">PostgreSQL: Desenvolvimento de extens√µes (fun√ß√µes) na linguagem C</a></li>
<li><a href="../pt497996/index.html">Voc√™ n√£o quer fortalecer a imunidade. Ou os extremos do corpo humano</a></li>
<li><a href="../pt498000/index.html">Coisas que eu gostaria de saber antes de desenvolver meu pr√≥prio jogo</a></li>
<li><a href="../pt498002/index.html">Guia de bolso para o Z3</a></li>
<li><a href="../pt498004/index.html">Esta√ß√£o de trabalho em um cont√™iner de docker</a></li>
<li><a href="../pt498006/index.html">Escolhendo um advogado de patentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>