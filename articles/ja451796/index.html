<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👏🏾 🔬 🐐 安全なブラウザ拡張を書く ✌🏼 👨🏿‍✈️ 👨🏿‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="一般的な「クライアント/サーバー」アーキテクチャとは対照的に、分散型アプリケーションは次の特徴があります。
 

- ユーザーのログインとパスワードをデータベースに保存する必要はありません。アクセス情報はユーザー自身によって排他的に保存され、ユーザーの信頼性の確認はプロトコルレベルで行われます。
-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>安全なブラウザ拡張を書く</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/waves/blog/451796/"><p><img src="https://habrastorage.org/webt/nt/7v/c8/nt7vc8scuypj0o2ngtj1n6fqjlw.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な「クライアント/サーバー」アーキテクチャとは対照的に、分散型アプリケーションは次の特徴があります。</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーのログインとパスワードをデータベースに保存する必要はありません。</font><font style="vertical-align: inherit;">アクセス情報はユーザー自身によって排他的に保存され、ユーザーの信頼性の確認はプロトコルレベルで行われます。</font></font></li>
<li>   .      -,       .</li>
</ul><br>
<p> 2       —     .       ,        ,            ,         . </p><br>
<p>  ,      ,     ,   API      .<br>
       . </p><br>
<p><strong>        ,     .</strong>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.       . </p><a name="habracut"></a><br>
<h2 id="kratkaya-istoriya-brauzernyh-rasshireniy">   </h2><br>
<p>    .  Internet Explorer     1999- ,  Firefox —  2004-.   ,        .</p><br>
<p> ,          Google Chrome. ,     ,   API Chrome   :          , Chrome      .</p><br>
<p> Mozilla   , ,     Chrome,     API.  2015    Mozilla   World Wide Web Consortium (W3C)          .</p><br>
<p>      API   hrome.     Microsoft (Google     ),      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p>   Edge, Firefox  Opera (,      Chrome).           Chrome,        .   WebExtensions API   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2 id="struktura-rasshireniya"> </h2><br>
<p> ,      —  (manifest.json).    “ ”  .</p><br>
<h3 id="manifest"></h3><br>
<p>      JSON .        ,       ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p>,    , “”   ( Chrome,  Firefox   ,    ).</p><br>
<p>        .</p><br>
<ol>
<li><strong>background</strong> — ,      :<br>
<ol>
<li><strong>scripts</strong> —  ,     background- (    );</li>
<li><strong>page</strong> —  ,      ,   html  .     script  ,         ;</li>
<li><strong>persistent</strong> —  , e  ,    "" background-,  ,     ,    .          .    Firefox.</li>
</ol></li>
<li><strong>content_scripts</strong> —  ,        .      :<br>
<ol>
<li><strong>matches</strong> — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> url</a>,   ,    content script  .</li>
<li><strong>js</strong> —        ;</li>
<li><strong>exclude_matches</strong> —    <code>match</code> URL,    .</li>
</ol></li>
<li><strong>page_action</strong> —   ,    ,        ,    .     popup ,      HTML, CSS  JS.<br>
<ol>
<li><strong>default_popup</strong> —   HTML   popup-,   CSS  JS.</li>
</ol></li>
<li><strong>permissions</strong> —     .  3  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></li>
<li><strong>web_accessible_resources</strong> —  ,     , , ,  JS, CSS, HTML. </li>
<li><strong>externally_connectable</strong> —     ID     -,    .       .    Firefox.</li>
</ol><br>
<h2 id="kontekst-vypolneniya"> </h2><br>
<p>      ,  ,           API .</p><br>
<h3 id="extension-context">Extension context</h3><br>
<p>    API.    "":</p><br>
<ol>
<li><strong>Background page</strong> — “backend”  .       “background”.</li>
<li><strong>Popup page</strong> — popup ,       .   <code>browser_action</code> -&gt; <code>default_popup</code>.</li>
<li><strong>Custom page</strong> —  , ""     <code>chrome-extension://&lt;id_&gt;/customPage.html</code>.</li>
</ol><br>
<p>        . <strong>Background page</strong>        ( — event page,  background-     ""   ). <strong>Popup page</strong> ,    popup,  <strong>Custom page</strong> —     .           .</p><br>
<h3 id="content-script-context">Content script context</h3><br>
<p> -      .       API    DOM- -.  -     . ,  DOM-,    - – ,    .  -       <code>postMessage</code>.</p><br>
<h3 id="web-page-context">Web page context</h3><br>
<p>   -.            ,  ,          (  — ).</p><br>
<h2 id="obmen-soobscheniyami"> </h2><br>
<p>       .    API <code>runtime.sendMessage</code>    <code>background</code>  <code>tabs.sendMessage</code>     (-, popup'      <code>externally_connectable</code>).       API Chrome.</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">//     JSON  </span><font></font>
<span class="hljs-keyword">const</span> msg = {<span class="hljs-attr">a</span>: <span class="hljs-string">'foo'</span>, <span class="hljs-attr">b</span>: <span class="hljs-string">'bar'</span>};<font></font>
<font></font>
<span class="hljs-comment">// extensionId   ,      ''  ( ui   )</span><font></font>
chrome.runtime.sendMessage(extensionId, msg);<font></font>
<font></font>
<span class="hljs-comment">//   </span><font></font>
chrome.runtime.onMessage.addListener(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-built_in">console</span>.log(msg))<font></font>
<font></font>
<span class="hljs-comment">//       id</span><font></font>
chrome.tabs.sendMessage(tabId, msg)<font></font>
<font></font>
<span class="hljs-comment">//      id , ,  </span><font></font>
chrome.tabs.query(<font></font>
    {<span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">active</span> : <span class="hljs-literal">true</span>},<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">tabArray</span>)</span>{<font></font>
      tabArray.forEach(<span class="hljs-function"><span class="hljs-params">tab</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(tab.id))<font></font>
    }<font></font>
)</code></pre><br>
<p>       <code>runtime.connect</code>.     <code>runtime.Port</code>,  ,   ,     .   , , <code>contentscript</code>,   :</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   extensionId        .   </span><font></font>
<span class="hljs-keyword">const</span> port = chrome.runtime.connect({<span class="hljs-attr">name</span>: <span class="hljs-string">"knockknock"</span>});<font></font>
port.postMessage({<span class="hljs-attr">joke</span>: <span class="hljs-string">"Knock knock"</span>});<font></font>
port.onMessage.addListener(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{<font></font>
    <span class="hljs-keyword">if</span> (msg.question === <span class="hljs-string">"Who's there?"</span>)<font></font>
        port.postMessage({<span class="hljs-attr">answer</span>: <span class="hljs-string">"Madame"</span>});<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.question === <span class="hljs-string">"Madame who?"</span>)<font></font>
        port.postMessage({<span class="hljs-attr">answer</span>: <span class="hljs-string">"Madame... Bovary"</span>});<font></font>
</code></pre><br>
<p>  background:</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">//    '' .  , popup   </span><font></font>
chrome.runtime.onConnect.addListener(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">port</span>) </span>{<font></font>
    <span class="hljs-built_in">console</span>.assert(port.name === <span class="hljs-string">"knockknock"</span>);<font></font>
    port.onMessage.addListener(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{<font></font>
        <span class="hljs-keyword">if</span> (msg.joke === <span class="hljs-string">"Knock knock"</span>)<font></font>
            port.postMessage({<span class="hljs-attr">question</span>: <span class="hljs-string">"Who's there?"</span>});<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.answer === <span class="hljs-string">"Madame"</span>)<font></font>
            port.postMessage({<span class="hljs-attr">question</span>: <span class="hljs-string">"Madame who?"</span>});<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.answer === <span class="hljs-string">"Madame... Bovary"</span>)<font></font>
            port.postMessage({<span class="hljs-attr">question</span>: <span class="hljs-string">"I don't get it."</span>});<font></font>
    });<font></font>
});<font></font>
<font></font>
<span class="hljs-comment">//     .     ,     </span><font></font>
chrome.runtime.onConnectExternal.addListener(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">port</span>) </span>{<font></font>
    ...<font></font>
});</code></pre><br>
<p>   <code>onDisconnect</code>   <code>disconnect</code>.</p><br>
<h2 id="shema-prilozheniya"> </h2><br>
<p>   ,    ,      (,            .</p><br>
<h2 id="razrabotka-prilozheniya"> </h2><br>
<p>      ,     API    (,   ).    <code>contentscript</code>  ,         DOM,    JS .   <code>runtime.connect</code>   ,   API    ,       .      :</p><br>
<p><img src="https://habrastorage.org/webt/fa/b3/gx/fab3gxq823kwybj9yk_kv8wlogy.png"></p><br>
<p>    — <code>inpage</code>,      .         API    .</p><br>
<h3 id="nachalo"></h3><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GitHub</a>.       .</p><br>
<p>  :</p><br>
<pre><code class="javascript hljs">{<font></font>
  <span class="hljs-comment">//   , .        chrome://extensions/?id=&lt;id &gt;</span><font></font>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Signer"</span>,<font></font>
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Extension demo"</span>,<font></font>
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.1"</span>,<font></font>
  <span class="hljs-string">"manifest_version"</span>: <span class="hljs-number">2</span>,<font></font>
<font></font>
  <span class="hljs-comment">// ,     background,    </span><font></font>
  <span class="hljs-string">"background"</span>: {<font></font>
    <span class="hljs-string">"scripts"</span>: [<span class="hljs-string">"background.js"</span>]<font></font>
  },<font></font>
<font></font>
  <span class="hljs-comment">//  html   popup</span><font></font>
  <span class="hljs-string">"browser_action"</span>: {<font></font>
    <span class="hljs-string">"default_title"</span>: <span class="hljs-string">"My Extension"</span>,<font></font>
    <span class="hljs-string">"default_popup"</span>: <span class="hljs-string">"popup.html"</span><font></font>
  },<font></font>
<font></font>
  <span class="hljs-comment">//  .</span><font></font>
  <span class="hljs-comment">//    :   url   http  https  </span><font></font>
  <span class="hljs-comment">// contenscript context   contentscript.js.        </span><font></font>
  <span class="hljs-string">"content_scripts"</span>: [<font></font>
    {<font></font>
      <span class="hljs-string">"matches"</span>: [<font></font>
        <span class="hljs-string">"http://*/*"</span>,<font></font>
        <span class="hljs-string">"https://*/*"</span><font></font>
      ],<font></font>
      <span class="hljs-string">"js"</span>: [<font></font>
        <span class="hljs-string">"contentscript.js"</span><font></font>
      ],<font></font>
      <span class="hljs-string">"run_at"</span>: <span class="hljs-string">"document_start"</span>,<font></font>
      <span class="hljs-string">"all_frames"</span>: <span class="hljs-literal">true</span><font></font>
    }<font></font>
  ],<font></font>
  <span class="hljs-comment">//    localStorage  idle api</span><font></font>
  <span class="hljs-string">"permissions"</span>: [<font></font>
    <span class="hljs-string">"storage"</span>,<font></font>
    <span class="hljs-comment">// "unlimitedStorage",</span><font></font>
    <span class="hljs-comment">//"clipboardWrite",</span><font></font>
    <span class="hljs-string">"idle"</span><font></font>
    <span class="hljs-comment">//"activeTab",</span><font></font>
    <span class="hljs-comment">//"webRequest",</span><font></font>
    <span class="hljs-comment">//"notifications",</span><font></font>
    <span class="hljs-comment">//"tabs"</span><font></font>
  ],<font></font>
  <span class="hljs-comment">//   ,       .      fetche'   xhr</span><font></font>
  <span class="hljs-string">"web_accessible_resources"</span>: [<span class="hljs-string">"inpage.js"</span>]<font></font>
}</code></pre><br>
<p>  background.js, popup.js, inpage.js  contentscript.js.  popup.html —        Google Chrome  ,   .</p><br>
<p>   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  ,   ,        webpack.     ,  chrome://extensions   load unpacked      —    dist.</p><br>
<p><img src="https://habrastorage.org/webt/ws/ng/qz/wsngqza3qdcjtxycbcwk4awpfqm.png"></p><br>
<p>     .         :</p><br>
<p>popup -&gt;</p><br>
<p><img src="https://habrastorage.org/webt/m3/pr/9d/m3pr9dww991nvn9jsfwj8mvndqq.png"> </p><br>
<p>   -     ,    .<img src="https://habrastorage.org/webt/3t/gn/6v/3tgn6vao3ilxdwyz9zxraegz9vo.png"></p><br>
<p><strong> </strong></p><br>
<p>,      : inpage &lt;-&gt; background  popup &lt;-&gt; background. , ,         ,     ,         metamask.</p><br>
<p>       Ethereum.        RPC    dnode.        ,       nodejs stream (   ,    ): </p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> Dnode <span class="hljs-keyword">from</span> <span class="hljs-string">"dnode/browser"</span>;<font></font>
<font></font>
<span class="hljs-comment">//           ,        </span><font></font>
<font></font>
<span class="hljs-comment">// C</span><font></font>
<span class="hljs-comment">// API,    </span><font></font>
<span class="hljs-keyword">const</span> dnode = Dnode({<font></font>
    <span class="hljs-attr">hello</span>: <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> cb(<span class="hljs-literal">null</span>, <span class="hljs-string">"world"</span>)<font></font>
})<font></font>
<span class="hljs-comment">// ,     dnode.  nodejs .     'readable-stream'</span><font></font>
connectionStream.pipe(dnode).pipe(connectionStream)<font></font>
<font></font>
<span class="hljs-comment">// </span><font></font>
<span class="hljs-keyword">const</span> dnodeClient = Dnode() <span class="hljs-comment">//         API   </span><font></font>
<font></font>
<span class="hljs-comment">//    world</span><font></font>
dnodeClient.once(<span class="hljs-string">'remote'</span>, remote =&gt; {<font></font>
    remote.hello(<span class="hljs-function">(<span class="hljs-params">(err, value</span>) =&gt;</span> <span class="hljs-built_in">console</span>.log(value)))<font></font>
})</code></pre><br>
<p>    .     API  popup  -,    dnode  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> Dnode <span class="hljs-keyword">from</span> <span class="hljs-string">'dnode/browser'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">//   API  ui</span><font></font>
    popupApi(){<font></font>
        <span class="hljs-keyword">return</span> {<font></font>
            <span class="hljs-attr">hello</span>: <span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'world'</span>)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   API  </span><font></font>
    pageApi(){<font></font>
        <span class="hljs-keyword">return</span> {<font></font>
            <span class="hljs-attr">hello</span>: <span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> cb(<span class="hljs-literal">null</span>, <span class="hljs-string">'world'</span>)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  popup ui</span><font></font>
    connectPopup(connectionStream){<font></font>
        <span class="hljs-keyword">const</span> api = <span class="hljs-keyword">this</span>.popupApi();<font></font>
        <span class="hljs-keyword">const</span> dnode = Dnode(api);<font></font>
<font></font>
        connectionStream.pipe(dnode).pipe(connectionStream);<font></font>
<font></font>
        dnode.on(<span class="hljs-string">'remote'</span>, (remote) =&gt; {<font></font>
            <span class="hljs-built_in">console</span>.log(remote)<font></font>
        })<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  </span><font></font>
    connectPage(connectionStream, origin){<font></font>
        <span class="hljs-keyword">const</span> api = <span class="hljs-keyword">this</span>.popupApi();<font></font>
        <span class="hljs-keyword">const</span> dnode = Dnode(api);<font></font>
<font></font>
        connectionStream.pipe(dnode).pipe(connectionStream);<font></font>
<font></font>
        dnode.on(<span class="hljs-string">'remote'</span>, (remote) =&gt; {<font></font>
            <span class="hljs-built_in">console</span>.log(origin);<font></font>
            <span class="hljs-built_in">console</span>.log(remote)<font></font>
        })<font></font>
    }<font></font>
}</code></pre><br>
<p>      Chrome   extentionApi,    Chrome    Google   browser  .    ,            ‘chrome.runtime.connect’.</p><br>
<p>    background :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> {SignerApp} <span class="hljs-keyword">from</span> <span class="hljs-string">"./SignerApp"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> SignerApp();<font></font>
<font></font>
<span class="hljs-comment">// onConnect    '' (contentscript, popup,   )</span><font></font>
extensionApi.runtime.onConnect.addListener(connectRemote);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectRemote</span>(<span class="hljs-params">remotePort</span>) </span>{<font></font>
    <span class="hljs-keyword">const</span> processName = remotePort.name;<font></font>
    <span class="hljs-keyword">const</span> portStream = <span class="hljs-keyword">new</span> PortStream(remotePort);<font></font>
    <span class="hljs-comment">//      ,          ,   ui</span><font></font>
    <span class="hljs-keyword">if</span> (processName === <span class="hljs-string">'contentscript'</span>){<font></font>
        <span class="hljs-keyword">const</span> origin = remotePort.sender.url<font></font>
        app.connectPage(portStream, origin)<font></font>
    }<span class="hljs-keyword">else</span>{<font></font>
        app.connectPopup(portStream)<font></font>
    }<font></font>
}</code></pre><br>
<p>  dnode   ,    ,   -.      readable-stream,   nodejs-  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Duplex} <span class="hljs-keyword">from</span> <span class="hljs-string">'readable-stream'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PortStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Duplex</span></span>{<font></font>
    <span class="hljs-keyword">constructor</span>(port){<font></font>
        <span class="hljs-keyword">super</span>({<span class="hljs-attr">objectMode</span>: <span class="hljs-literal">true</span>});<font></font>
        <span class="hljs-keyword">this</span>._port = port;<font></font>
        port.onMessage.addListener(<span class="hljs-keyword">this</span>._onMessage.bind(<span class="hljs-keyword">this</span>));<font></font>
        port.onDisconnect.addListener(<span class="hljs-keyword">this</span>._onDisconnect.bind(<span class="hljs-keyword">this</span>))<font></font>
    }<font></font>
<font></font>
    _onMessage(msg) {<font></font>
        <span class="hljs-keyword">if</span> (Buffer.isBuffer(msg)) {<font></font>
            <span class="hljs-keyword">delete</span> msg._isBuffer;<font></font>
            <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> Buffer(msg);<font></font>
            <span class="hljs-keyword">this</span>.push(data)<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            <span class="hljs-keyword">this</span>.push(msg)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    _onDisconnect() {<font></font>
        <span class="hljs-keyword">this</span>.destroy()<font></font>
    }<font></font>
<font></font>
    _read(){}<font></font>
<font></font>
    _write(msg, encoding, cb) {<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            <span class="hljs-keyword">if</span> (Buffer.isBuffer(msg)) {<font></font>
                <span class="hljs-keyword">const</span> data = msg.toJSON();<font></font>
                data._isBuffer = <span class="hljs-literal">true</span>;<font></font>
                <span class="hljs-keyword">this</span>._port.postMessage(data)<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                <span class="hljs-keyword">this</span>._port.postMessage(msg)<font></font>
            }<font></font>
        } <span class="hljs-keyword">catch</span> (err) {<font></font>
            <span class="hljs-keyword">return</span> cb(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'PortStream - disconnected'</span>))<font></font>
        }<font></font>
        cb()<font></font>
    }<font></font>
}</code></pre><br>
<p>    UI:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> Dnode <span class="hljs-keyword">from</span> <span class="hljs-string">'dnode/browser'</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;<font></font>
<font></font>
setupUi().catch(<span class="hljs-built_in">console</span>.error);<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupUi</span>(<span class="hljs-params"></span>)</span>{<font></font>
    <span class="hljs-comment">// ,       ,   stream,   dnode</span><font></font>
    <span class="hljs-keyword">const</span> backgroundPort = extensionApi.runtime.connect({<span class="hljs-attr">name</span>: <span class="hljs-string">'popup'</span>});<font></font>
    <span class="hljs-keyword">const</span> connectionStream = <span class="hljs-keyword">new</span> PortStream(backgroundPort);<font></font>
<font></font>
    <span class="hljs-keyword">const</span> dnode = Dnode();<font></font>
<font></font>
    connectionStream.pipe(dnode).pipe(connectionStream);<font></font>
<font></font>
    <span class="hljs-keyword">const</span> background = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {<font></font>
        dnode.once(<span class="hljs-string">'remote'</span>, api =&gt; {<font></font>
            resolve(api)<font></font>
        })<font></font>
    });<font></font>
<font></font>
    <span class="hljs-comment">//   API   </span><font></font>
    <span class="hljs-keyword">if</span> (DEV_MODE){<font></font>
        global.background = background;<font></font>
    }<font></font>
}</code></pre><br>
<p>     content script:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> PostMessageStream <span class="hljs-keyword">from</span> <span class="hljs-string">'post-message-stream'</span>;<font></font>
<font></font>
setupConnection();<font></font>
injectScript();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupConnection</span>(<span class="hljs-params"></span>)</span>{<font></font>
    <span class="hljs-keyword">const</span> backgroundPort = extensionApi.runtime.connect({<span class="hljs-attr">name</span>: <span class="hljs-string">'contentscript'</span>});<font></font>
    <span class="hljs-keyword">const</span> backgroundStream = <span class="hljs-keyword">new</span> PortStream(backgroundPort);<font></font>
<font></font>
    <span class="hljs-keyword">const</span> pageStream = <span class="hljs-keyword">new</span> PostMessageStream({<font></font>
        <span class="hljs-attr">name</span>: <span class="hljs-string">'content'</span>,<font></font>
        <span class="hljs-attr">target</span>: <span class="hljs-string">'page'</span>,<font></font>
    });<font></font>
<font></font>
    pageStream.pipe(backgroundStream).pipe(pageStream);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectScript</span>(<span class="hljs-params"></span>)</span>{<font></font>
    <span class="hljs-keyword">try</span> {<font></font>
        <span class="hljs-comment">// inject in-page script</span><font></font>
        <span class="hljs-keyword">let</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);<font></font>
        script.src = extensionApi.extension.getURL(<span class="hljs-string">'inpage.js'</span>);<font></font>
        <span class="hljs-keyword">const</span> container = <span class="hljs-built_in">document</span>.head || <span class="hljs-built_in">document</span>.documentElement;<font></font>
        container.insertBefore(script, container.children[<span class="hljs-number">0</span>]);<font></font>
        script.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> script.remove();<font></font>
    } <span class="hljs-keyword">catch</span> (e) {<font></font>
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Injection failed.'</span>, e);<font></font>
    }<font></font>
}</code></pre><br>
<p>  API     -,    ,    :</p><br>
<ol>
<li>  .  —   ,  postMessage.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   metamask.   —  background  ,   <code>runtime.connect</code>.  .       .</li>
<li>   DOM.   (      )    <code>script</code>    :</li>
</ol><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> PostMessageStream <span class="hljs-keyword">from</span> <span class="hljs-string">'post-message-stream'</span>;<font></font>
<span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<font></font>
setupConnection();<font></font>
injectScript();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupConnection</span>(<span class="hljs-params"></span>)</span>{<font></font>
    <span class="hljs-comment">//   </span><font></font>
    <span class="hljs-keyword">const</span> backgroundPort = extensionApi.runtime.connect({<span class="hljs-attr">name</span>: <span class="hljs-string">'contentscript'</span>});<font></font>
    <span class="hljs-keyword">const</span> backgroundStream = <span class="hljs-keyword">new</span> PortStream(backgroundPort);<font></font>
<font></font>
    <span class="hljs-comment">//   </span><font></font>
    <span class="hljs-keyword">const</span> pageStream = <span class="hljs-keyword">new</span> PostMessageStream({<font></font>
        <span class="hljs-attr">name</span>: <span class="hljs-string">'content'</span>,<font></font>
        <span class="hljs-attr">target</span>: <span class="hljs-string">'page'</span>,<font></font>
    });<font></font>
<font></font>
    pageStream.pipe(backgroundStream).pipe(pageStream);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectScript</span>(<span class="hljs-params"></span>)</span>{<font></font>
    <span class="hljs-keyword">try</span> {<font></font>
        <span class="hljs-comment">// inject in-page script</span><font></font>
        <span class="hljs-keyword">let</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);<font></font>
        script.src = extensionApi.extension.getURL(<span class="hljs-string">'inpage.js'</span>);<font></font>
        <span class="hljs-keyword">const</span> container = <span class="hljs-built_in">document</span>.head || <span class="hljs-built_in">document</span>.documentElement;<font></font>
        container.insertBefore(script, container.children[<span class="hljs-number">0</span>]);<font></font>
        script.onload = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> script.remove();<font></font>
    } <span class="hljs-keyword">catch</span> (e) {<font></font>
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Injection failed.'</span>, e);<font></font>
    }<font></font>
}</code></pre><br>
<p>   api  inpage    global:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> PostMessageStream <span class="hljs-keyword">from</span> <span class="hljs-string">'post-message-stream'</span>;<font></font>
<span class="hljs-keyword">import</span> Dnode <span class="hljs-keyword">from</span> <span class="hljs-string">'dnode/browser'</span>;<font></font>
<font></font>
setupInpageApi().catch(<span class="hljs-built_in">console</span>.error);<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupInpageApi</span>(<span class="hljs-params"></span>) </span>{<font></font>
    <span class="hljs-comment">//   </span><font></font>
    <span class="hljs-keyword">const</span> connectionStream = <span class="hljs-keyword">new</span> PostMessageStream({<font></font>
        <span class="hljs-attr">name</span>: <span class="hljs-string">'page'</span>,<font></font>
        <span class="hljs-attr">target</span>: <span class="hljs-string">'content'</span>,<font></font>
    });<font></font>
<font></font>
    <span class="hljs-keyword">const</span> dnode = Dnode();<font></font>
<font></font>
    connectionStream.pipe(dnode).pipe(connectionStream);<font></font>
<font></font>
    <span class="hljs-comment">//   API</span><font></font>
    <span class="hljs-keyword">const</span> pageApi = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {<font></font>
        dnode.once(<span class="hljs-string">'remote'</span>, api =&gt; {<font></font>
            resolve(api)<font></font>
        })<font></font>
    });<font></font>
<font></font>
    <span class="hljs-comment">//   window</span><font></font>
    global.SignerApp = pageApi;<font></font>
}</code></pre><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Remote Procedure Call (RPC)   API    UI</a>.      background    :</p><br>
<p><img src="https://habrastorage.org/webt/cy/r_/pm/cyr_pmgm-u5hes5lefaf85gk91m.png"></p><br>
<p> API  origin.        hello  : </p><br>
<p><img src="https://habrastorage.org/webt/3p/fd/tv/3pfdtv17ejnjzh94uajezgz0lce.png"></p><br>
<p>  callback-   JS — ,       dnode,      API  utils.</p><br>
<p> API     :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    popupApi() {<font></font>
        <span class="hljs-keyword">return</span> {<font></font>
            <span class="hljs-attr">hello</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-string">"world"</span><font></font>
        }<font></font>
    }<font></font>
<font></font>
...<font></font>
<font></font>
}</code></pre><br>
<p>   remote  :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {cbToPromise, transformMethods} <span class="hljs-keyword">from</span> <span class="hljs-string">"../../src/utils/setupDnode"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> pageApi = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {<font></font>
    dnode.once(<span class="hljs-string">'remote'</span>, remoteApi =&gt; {<font></font>
        <span class="hljs-comment">//      callback  promise</span><font></font>
        resolve(transformMethods(cbToPromise, remoteApi))<font></font>
    })<font></font>
});</code></pre><br>
<p>    :</p><br>
<p><img src="https://habrastorage.org/webt/g7/qq/og/g7qqogo60hrjqm5pre7f5miehs0.png"></p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p> ,   RPC     :    steam multiplexing     API   .  , dnode    ,  —     nodejs .</p><br>
<p>   JSON,    JSON RPC 2.       (TCP  HTTP(S)),      .</p><br>
<h3 id="vnutrenniy-steyt-i-localstorage">   localStorage</h3><br>
<p>      —  ,   .              popup API:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {setupDnode} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(){<font></font>
        <span class="hljs-keyword">this</span>.store = {<font></font>
            <span class="hljs-attr">keys</span>: [],<font></font>
        };<font></font>
    }<font></font>
<font></font>
    addKey(key){<font></font>
        <span class="hljs-keyword">this</span>.store.keys.push(key)<font></font>
    }<font></font>
<font></font>
    removeKey(index){<font></font>
        <span class="hljs-keyword">this</span>.store.keys.splice(index,<span class="hljs-number">1</span>)<font></font>
    }<font></font>
<font></font>
    popupApi(){<font></font>
        <span class="hljs-keyword">return</span> {<font></font>
            <span class="hljs-attr">addKey</span>: <span class="hljs-keyword">async</span> (key) =&gt; <span class="hljs-keyword">this</span>.addKey(key),<font></font>
            <span class="hljs-attr">removeKey</span>: <span class="hljs-keyword">async</span> (index) =&gt; <span class="hljs-keyword">this</span>.removeKey(index)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    ...<font></font>
<font></font>
} </code></pre><br>
<p> background          window,        :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> {SignerApp} <span class="hljs-keyword">from</span> <span class="hljs-string">"./SignerApp"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;<font></font>
<font></font>
setupApp();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupApp</span>(<span class="hljs-params"></span>) </span>{<font></font>
    <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> SignerApp();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (DEV_MODE) {<font></font>
        global.app = app;<font></font>
    }<font></font>
<font></font>
    extensionApi.runtime.onConnect.addListener(connectRemote);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectRemote</span>(<span class="hljs-params">remotePort</span>) </span>{<font></font>
        <span class="hljs-keyword">const</span> processName = remotePort.name;<font></font>
        <span class="hljs-keyword">const</span> portStream = <span class="hljs-keyword">new</span> PortStream(remotePort);<font></font>
        <span class="hljs-keyword">if</span> (processName === <span class="hljs-string">'contentscript'</span>) {<font></font>
            <span class="hljs-keyword">const</span> origin = remotePort.sender.url;<font></font>
            app.connectPage(portStream, origin)<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            app.connectPopup(portStream)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>   UI    ,    :</p><br>
<p><img src="https://habrastorage.org/webt/n7/xr/eb/n7xrebxybxbquxx8z8uozgwpfqm.png"></p><br>
<p>   ,      .</p><br>
<p>   localStorage,    .         UI,      .         (observable storage)     .</p><br>
<p>   mobx (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/mobxjs/mobx</a>).    ,       ,     .</p><br>
<p>      store observable:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {observable, action} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;<font></font>
<span class="hljs-keyword">import</span> {setupDnode} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(initState = {}) {<font></font>
        <span class="hljs-comment">//  store      ,       proxy,     </span><font></font>
        <span class="hljs-keyword">this</span>.store =  observable.object({<font></font>
            <span class="hljs-attr">keys</span>: initState.keys || [],<font></font>
        });<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// ,   observable   </span><font></font>
    @action<font></font>
    addKey(key) {<font></font>
        <span class="hljs-keyword">this</span>.store.keys.push(key)<font></font>
    }<font></font>
<font></font>
    @action<font></font>
    removeKey(index) {<font></font>
        <span class="hljs-keyword">this</span>.store.keys.splice(index, <span class="hljs-number">1</span>)<font></font>
    }<font></font>
<font></font>
    ...<font></font>
<font></font>
}</code></pre><br>
<p>" " mobx    store  proxy      .      .</p><br>
<p>      “ ”,     . Mobx     .     -,   .</p><br>
<p> action   : </p><br>
<ol>
<li>     enforceActions mobx    .        .</li>
<li>       – ,        , —      .     ,         .     ,     ,      .      ,     .</li>
</ol><br>
<p> background       localStorage:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {reaction, toJS} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;<font></font>
<span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> {SignerApp} <span class="hljs-keyword">from</span> <span class="hljs-string">"./SignerApp"</span>;<font></font>
<span class="hljs-comment">//  . /  / localStorage  JSON    'store'</span><font></font>
<span class="hljs-keyword">import</span> {loadState, saveState} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/localStorage"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;<font></font>
<font></font>
setupApp();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupApp</span>(<span class="hljs-params"></span>) </span>{<font></font>
    <span class="hljs-keyword">const</span> initState = loadState();<font></font>
    <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> SignerApp(initState);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (DEV_MODE) {<font></font>
        global.app = app;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// Setup state persistence</span><font></font>
<font></font>
    <span class="hljs-comment">//  reaction  ,     .    ,   </span><font></font>
    <span class="hljs-keyword">const</span> localStorageReaction = reaction(<font></font>
        <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> toJS(app.store), <span class="hljs-comment">// - </span><font></font>
        saveState <span class="hljs-comment">// ,      ,   </span><font></font>
    );<font></font>
<font></font>
    extensionApi.runtime.onConnect.addListener(connectRemote);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectRemote</span>(<span class="hljs-params">remotePort</span>) </span>{<font></font>
        <span class="hljs-keyword">const</span> processName = remotePort.name;<font></font>
        <span class="hljs-keyword">const</span> portStream = <span class="hljs-keyword">new</span> PortStream(remotePort);<font></font>
        <span class="hljs-keyword">if</span> (processName === <span class="hljs-string">'contentscript'</span>) {<font></font>
            <span class="hljs-keyword">const</span> origin = remotePort.sender.url<font></font>
            app.connectPage(portStream, origin)<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            app.connectPopup(portStream)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>   reaction.    :</p><br>
<ol>
<li> .</li>
<li>,        ,   .</li>
</ol><br>
<p>   redux,        , mobx     observable    ,       .</p><br>
<p> ,   mobx ,   observable  .         <code>() =&gt; app.store</code>,  reaction    ,         ,     .</p><br>
<p>      <code>() =&gt; app.store.keys</code>,      ,    /        .</p><br>
<p>Mobx            observable,     .     .      <code>toJS</code>.    ,        .         – ,  .</p><br>
<p>  popup    .         localStorage:</p><br>
<p><img src="https://habrastorage.org/webt/fr/dh/6t/frdh6tc_bt_v3zywmgjrnptngcw.png"></p><br>
<p>  background-    .</p><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2 id="bezopasnoe-hranenie-privatnyh-klyuchey">   </h2><br>
<p>      :    ,   ,        .   localStorage        .</p><br>
<p>      locked,        .        locked  .</p><br>
<p>Mobx      ,       .  —   computed properties.     view   :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {observable, action} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;<font></font>
<span class="hljs-keyword">import</span> {setupDnode} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;<font></font>
<span class="hljs-comment">//     .  crypto-js</span><font></font>
<span class="hljs-keyword">import</span> {encrypt, decrypt} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/cryptoUtils"</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
    <span class="hljs-keyword">constructor</span>(initState = {}) {<font></font>
        <span class="hljs-keyword">this</span>.store = observable.object({<font></font>
            <span class="hljs-comment">//     .   null -  locked</span><font></font>
            <span class="hljs-attr">password</span>: <span class="hljs-literal">null</span>,<font></font>
            <span class="hljs-attr">vault</span>: initState.vault,<font></font>
<font></font>
            <span class="hljs-comment">//    .     view  .</span><font></font>
            <span class="hljs-keyword">get</span> <span class="hljs-title">locked</span>(){<font></font>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.password == <span class="hljs-literal">null</span><font></font>
            },<font></font>
            <span class="hljs-keyword">get</span> <span class="hljs-title">keys</span>(){<font></font>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.locked ?<font></font>
                    <span class="hljs-literal">undefined</span> :<font></font>
                    SignerApp._decryptVault(<span class="hljs-keyword">this</span>.vault, <span class="hljs-keyword">this</span>.password)<font></font>
            },<font></font>
            <span class="hljs-keyword">get</span> <span class="hljs-title">initialized</span>(){<font></font>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.vault !== <span class="hljs-literal">undefined</span><font></font>
            }<font></font>
        })<font></font>
    }<font></font>
    <span class="hljs-comment">//     </span><font></font>
    @action<font></font>
    initVault(password){<font></font>
        <span class="hljs-keyword">this</span>.store.vault = SignerApp._encryptVault([], password)<font></font>
    }<font></font>
    @action<font></font>
    lock() {<font></font>
        <span class="hljs-keyword">this</span>.store.password = <span class="hljs-literal">null</span><font></font>
    }<font></font>
    @action<font></font>
    unlock(password) {<font></font>
        <span class="hljs-keyword">this</span>._checkPassword(password);<font></font>
        <span class="hljs-keyword">this</span>.store.password = password<font></font>
    }<font></font>
    @action<font></font>
    addKey(key) {<font></font>
        <span class="hljs-keyword">this</span>._checkLocked();<font></font>
        <span class="hljs-keyword">this</span>.store.vault = SignerApp._encryptVault(<span class="hljs-keyword">this</span>.store.keys.concat(key), <span class="hljs-keyword">this</span>.store.password)<font></font>
    }<font></font>
    @action<font></font>
    removeKey(index) {<font></font>
        <span class="hljs-keyword">this</span>._checkLocked();<font></font>
        <span class="hljs-keyword">this</span>.store.vault = SignerApp._encryptVault([<font></font>
                ...this.store.keys.slice(<span class="hljs-number">0</span>, index),<font></font>
                ...this.store.keys.slice(index + <span class="hljs-number">1</span>)<font></font>
            ],<font></font>
            <span class="hljs-keyword">this</span>.store.password<font></font>
        )<font></font>
    }<font></font>
<font></font>
    ... <span class="hljs-comment">//    api</span><font></font>
<font></font>
    <span class="hljs-comment">// private</span><font></font>
    _checkPassword(password) {<font></font>
        SignerApp._decryptVault(<span class="hljs-keyword">this</span>.store.vault, password);<font></font>
    }<font></font>
<font></font>
    _checkLocked() {<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.store.locked){<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'App is locked'</span>)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   / </span><font></font>
    <span class="hljs-keyword">static</span> _encryptVault(obj, pass){<font></font>
        <span class="hljs-keyword">const</span> jsonString = <span class="hljs-built_in">JSON</span>.stringify(obj)<font></font>
        <span class="hljs-keyword">return</span> encrypt(jsonString, pass)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">static</span> _decryptVault(str, pass){<font></font>
        <span class="hljs-keyword">if</span> (str === <span class="hljs-literal">undefined</span>){<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Vault not initialized'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            <span class="hljs-keyword">const</span> jsonString = decrypt(str, pass)<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(jsonString)<font></font>
        }<span class="hljs-keyword">catch</span> (e) {<font></font>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Wrong password'</span>)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>       .   .    locked        .   API     .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   rypto-js</a>:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> CryptoJS <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto-js'</span><font></font>
<font></font>
<span class="hljs-comment">//      .        5000 </span><font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strengthenPassword</span>(<span class="hljs-params">pass, rounds = <span class="hljs-number">5000</span></span>) </span>{<font></font>
    <span class="hljs-keyword">while</span> (rounds-- &gt; <span class="hljs-number">0</span>){<font></font>
        pass = CryptoJS.SHA256(pass).toString()<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> pass<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">str, pass</span>)</span>{<font></font>
    <span class="hljs-keyword">const</span> strongPass = strengthenPassword(pass);<font></font>
    <span class="hljs-keyword">return</span> CryptoJS.AES.encrypt(str, strongPass).toString()<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">str, pass</span>)</span>{<font></font>
    <span class="hljs-keyword">const</span> strongPass = strengthenPassword(pass)<font></font>
    <span class="hljs-keyword">const</span> decrypted = CryptoJS.AES.decrypt(str, strongPass);<font></font>
    <span class="hljs-keyword">return</span> decrypted.toString(CryptoJS.enc.Utf8)<font></font>
}</code></pre><br>
<p>   idle API,       —  . , ,   <code>idle</code>, <code>active</code>  <code>locked</code>.  idle   ,  locked ,    .        localStorage:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {reaction, toJS} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;<font></font>
<span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;<font></font>
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;<font></font>
<span class="hljs-keyword">import</span> {SignerApp} <span class="hljs-keyword">from</span> <span class="hljs-string">"./SignerApp"</span>;<font></font>
<span class="hljs-keyword">import</span> {loadState, saveState} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/localStorage"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;<font></font>
<span class="hljs-keyword">const</span> IDLE_INTERVAL = <span class="hljs-number">30</span>;<font></font>
<font></font>
setupApp();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupApp</span>(<span class="hljs-params"></span>) </span>{<font></font>
    <span class="hljs-keyword">const</span> initState = loadState();<font></font>
    <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> SignerApp(initState);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (DEV_MODE) {<font></font>
        global.app = app;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//     ,    , reaction  </span><font></font>
    reaction(<font></font>
        <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> ({<font></font>
            <span class="hljs-attr">vault</span>: app.store.vault<font></font>
        }),<font></font>
        saveState<font></font>
    );<font></font>
<font></font>
    <span class="hljs-comment">//  ,   </span><font></font>
    extensionApi.idle.setDetectionInterval(IDLE_INTERVAL);<font></font>
    <span class="hljs-comment">//            </span><font></font>
    extensionApi.idle.onStateChanged.addListener(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {<font></font>
        <span class="hljs-keyword">if</span> ([<span class="hljs-string">'locked'</span>, <span class="hljs-string">'idle'</span>].indexOf(state) &gt; <span class="hljs-number">-1</span>) {<font></font>
            app.lock()<font></font>
        }<font></font>
    });<font></font>
<font></font>
    <span class="hljs-comment">// Connect to other contexts</span><font></font>
    extensionApi.runtime.onConnect.addListener(connectRemote);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectRemote</span>(<span class="hljs-params">remotePort</span>) </span>{<font></font>
        <span class="hljs-keyword">const</span> processName = remotePort.name;<font></font>
        <span class="hljs-keyword">const</span> portStream = <span class="hljs-keyword">new</span> PortStream(remotePort);<font></font>
        <span class="hljs-keyword">if</span> (processName === <span class="hljs-string">'contentscript'</span>) {<font></font>
            <span class="hljs-keyword">const</span> origin = remotePort.sender.url<font></font>
            app.connectPage(portStream, origin)<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            app.connectPopup(portStream)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h3 id="tranzakcii"></h3><br>
<p>,     :      .     WAVES   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">waves-transactions</a>.</p><br>
<p>      ,   ,  —    ,    :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {action, observable, reaction} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;<font></font>
<span class="hljs-keyword">import</span> uuid <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid/v4'</span>;<font></font>
<span class="hljs-keyword">import</span> {signTx} <span class="hljs-keyword">from</span> <span class="hljs-string">'@waves/waves-transactions'</span><font></font>
<span class="hljs-keyword">import</span> {setupDnode} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;<font></font>
<span class="hljs-keyword">import</span> {decrypt, encrypt} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/cryptoUtils"</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    ...<font></font>
<font></font>
    @action<font></font>
    newMessage(data, origin) {<font></font>
        <span class="hljs-comment">//       id, ,    .</span><font></font>
        <span class="hljs-keyword">const</span> message = observable.object({<font></font>
            <span class="hljs-attr">id</span>: uuid(), <span class="hljs-comment">// ,  uuid</span><font></font>
            origin, <span class="hljs-comment">// Origin     </span><font></font>
            data, <span class="hljs-comment">//</span><font></font>
            <span class="hljs-attr">status</span>: <span class="hljs-string">'new'</span>, <span class="hljs-comment">//   : new, signed, rejected  failed</span><font></font>
            <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">Date</span>.now()<font></font>
        });<font></font>
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`new message: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(message, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}</span>`</span>);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.store.messages.push(message);<font></font>
<font></font>
        <span class="hljs-comment">//     mobx   .       </span><font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<font></font>
            reaction(<font></font>
                <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> message.status, <span class="hljs-comment">//   </span><font></font>
                (status, reaction) =&gt; { <span class="hljs-comment">//       reaction,       </span><font></font>
                    <span class="hljs-keyword">switch</span> (status) {<font></font>
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'signed'</span>:<font></font>
                            resolve(message.data);<font></font>
                            <span class="hljs-keyword">break</span>;<font></font>
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'rejected'</span>:<font></font>
                            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'User rejected message'</span>));<font></font>
                            <span class="hljs-keyword">break</span>;<font></font>
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'failed'</span>:<font></font>
                            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message.err.message));<font></font>
                            <span class="hljs-keyword">break</span>;<font></font>
                        <span class="hljs-keyword">default</span>:<font></font>
                            <span class="hljs-keyword">return</span><font></font>
                    }<font></font>
                    reaction.dispose()<font></font>
                }<font></font>
            )<font></font>
        })<font></font>
    }<font></font>
    @action<font></font>
    approve(id, keyIndex = <span class="hljs-number">0</span>) {<font></font>
        <span class="hljs-keyword">const</span> message = <span class="hljs-keyword">this</span>.store.messages.find(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> msg.id === id);<font></font>
        <span class="hljs-keyword">if</span> (message == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`No msg with id:<span class="hljs-subst">${id}</span>`</span>);<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            message.data = signTx(message.data, <span class="hljs-keyword">this</span>.store.keys[keyIndex]);<font></font>
            message.status = <span class="hljs-string">'signed'</span><font></font>
        } <span class="hljs-keyword">catch</span> (e) {<font></font>
            message.err = {<font></font>
                <span class="hljs-attr">stack</span>: e.stack,<font></font>
                <span class="hljs-attr">message</span>: e.message<font></font>
            };<font></font>
            message.status = <span class="hljs-string">'failed'</span><font></font>
            <span class="hljs-keyword">throw</span> e<font></font>
        }<font></font>
    }<font></font>
    @action<font></font>
    reject(id) {<font></font>
        <span class="hljs-keyword">const</span> message = <span class="hljs-keyword">this</span>.store.messages.find(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> msg.id === id);<font></font>
        <span class="hljs-keyword">if</span> (message == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`No msg with id:<span class="hljs-subst">${id}</span>`</span>);<font></font>
        message.status = <span class="hljs-string">'rejected'</span><font></font>
    }<font></font>
<font></font>
    ...<font></font>
}</code></pre><br>
<p>        ,  <code>observable</code>    <code>store.messages</code>.</p><br>
<p>   <code>observable</code> ,  mobx        messages.     ,       ,      .</p><br>
<p>   ,      .    reaction,    ""   .</p><br>
<p>  <code>approve</code>  <code>reject</code>  :     ,   ,  .</p><br>
<p>Approve  reject    API UI, newMessage —  API :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
    ...<font></font>
    popupApi() {<font></font>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">addKey</span>: <span class="hljs-keyword">async</span> (key) =&gt; <span class="hljs-keyword">this</span>.addKey(key),
            <span class="hljs-attr">removeKey</span>: <span class="hljs-keyword">async</span> (index) =&gt; <span class="hljs-keyword">this</span>.removeKey(index),<font></font>
<font></font>
            <span class="hljs-attr">lock</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">this</span>.lock(),
            <span class="hljs-attr">unlock</span>: <span class="hljs-keyword">async</span> (password) =&gt; <span class="hljs-keyword">this</span>.unlock(password),
            <span class="hljs-attr">initVault</span>: <span class="hljs-keyword">async</span> (password) =&gt; <span class="hljs-keyword">this</span>.initVault(password),<font></font>
<font></font>
            <span class="hljs-attr">approve</span>: <span class="hljs-keyword">async</span> (id, keyIndex) =&gt; <span class="hljs-keyword">this</span>.approve(id, keyIndex),
            <span class="hljs-attr">reject</span>: <span class="hljs-keyword">async</span> (id) =&gt; <span class="hljs-keyword">this</span>.reject(id)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    pageApi(origin) {<font></font>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">signTransaction</span>: <span class="hljs-keyword">async</span> (txParams) =&gt; <span class="hljs-keyword">this</span>.newMessage(txParams, origin)<font></font>
        }<font></font>
    }<font></font>
<font></font>
    ...<font></font>
}</code></pre><br>
<p>    :</p><br>
<p><img src="https://habrastorage.org/webt/jt/bp/nu/jtbpnu9tbhryijukstktnti3wbu.png"></p><br>
<p>   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  UI</a>.</p><br>
<h2 id="ui">UI</h2><br>
<p>     .   UI   <code>observable</code>     API ,     .  <code>observable</code>   API,   background:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {observable} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>
<span class="hljs-keyword">import</span> {extensionApi} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/extensionApi"</span>;
<span class="hljs-keyword">import</span> {PortStream} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/PortStream"</span>;
<span class="hljs-keyword">import</span> {cbToPromise, setupDnode, transformMethods} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;
<span class="hljs-keyword">import</span> {initApp} <span class="hljs-keyword">from</span> <span class="hljs-string">"./ui/index"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> DEV_MODE = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;<font></font>
<font></font>
setupUi().catch(<span class="hljs-built_in">console</span>.error);<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupUi</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">//   ,    </span>
    <span class="hljs-keyword">const</span> backgroundPort = extensionApi.runtime.connect({<span class="hljs-attr">name</span>: <span class="hljs-string">'popup'</span>});
    <span class="hljs-keyword">const</span> connectionStream = <span class="hljs-keyword">new</span> PortStream(backgroundPort);<font></font>
<font></font>
    <span class="hljs-comment">//   observable   background'a</span>
    <span class="hljs-keyword">let</span> backgroundState = observable.object({});
    <span class="hljs-keyword">const</span> api = {
        <span class="hljs-comment">//  ,    observable</span>
        <span class="hljs-attr">updateState</span>: <span class="hljs-keyword">async</span> state =&gt; {
            <span class="hljs-built_in">Object</span>.assign(backgroundState, state)<font></font>
        }<font></font>
    };<font></font>
<font></font>
    <span class="hljs-comment">//  RPC </span>
    <span class="hljs-keyword">const</span> dnode = setupDnode(connectionStream, api);
    <span class="hljs-keyword">const</span> background = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {<font></font>
        dnode.once(<span class="hljs-string">'remote'</span>, remoteApi =&gt; {<font></font>
            resolve(transformMethods(cbToPromise, remoteApi))<font></font>
        })<font></font>
    });<font></font>
<font></font>
    <span class="hljs-comment">//   background observable  </span><font></font>
    background.state = backgroundState;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (DEV_MODE) {<font></font>
        global.background = background;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">await</span> initApp(background)<font></font>
}<font></font>
</code></pre><br>
<p>      .  react-. Background-     props. , ,       store  ,       :</p><br>
<pre><code class="plaintext hljs">import {render} from 'react-dom'<font></font>
import App from './App'<font></font>
import React from "react";<font></font>
<font></font>
//    background     props<font></font>
export async function initApp(background){<font></font>
    render(<font></font>
        &lt;App background={background}/&gt;,<font></font>
        document.getElementById('app-content')<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<p>  mobx       .     observer   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">mobx-react</a>  ,         observable,    .    mapStateToProps  connect,   redux.    " ":</p><br>
<pre><code class="plaintext hljs">import React, {Component, Fragment} from 'react'<font></font>
import {observer} from "mobx-react";<font></font>
import Init from './components/Initialize'<font></font>
import Keys from './components/Keys'<font></font>
import Sign from './components/Sign'<font></font>
import Unlock from './components/Unlock'<font></font>
<font></font>
@observer //          render,    observable    <font></font>
export default class App extends Component {<font></font>
<font></font>
    //              ,<font></font>
    //   observable   background    ,   <font></font>
    render() {<font></font>
        const {keys, messages, initialized, locked} = this.props.background.state;<font></font>
        const {lock, unlock, addKey, removeKey, initVault, deleteVault, approve, reject} = this.props.background;<font></font>
<font></font>
        return &lt;Fragment&gt;<font></font>
            {!initialized<font></font>
                ?<font></font>
                &lt;Init onInit={initVault}/&gt;<font></font>
                :<font></font>
                locked<font></font>
                    ?<font></font>
                    &lt;Unlock onUnlock={unlock}/&gt;<font></font>
                    :<font></font>
                    messages.length &gt; 0<font></font>
                        ?<font></font>
                        &lt;Sign keys={keys} message={messages[messages.length - 1]} onApprove={approve} onReject={reject}/&gt;<font></font>
                        :<font></font>
                        &lt;Keys keys={keys} onAdd={addKey} onRemove={removeKey}/&gt;<font></font>
            }<font></font>
            &lt;div&gt;<font></font>
                {!locked &amp;&amp; &lt;button onClick={() =&gt; lock()}&gt;Lock App&lt;/button&gt;}<font></font>
                {initialized &amp;&amp; &lt;button onClick={() =&gt; deleteVault()}&gt;Delete all keys and init&lt;/button&gt;}<font></font>
            &lt;/div&gt;<font></font>
        &lt;/Fragment&gt;<font></font>
    }<font></font>
}</code></pre><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  UI</a>.</p><br>
<p>         UI      UI.     <code>getState</code>  <code>reaction</code>,  <code>remote.updateState</code>:</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {action, observable, reaction} <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>;
<span class="hljs-keyword">import</span> uuid <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid/v4'</span>;
<span class="hljs-keyword">import</span> {signTx} <span class="hljs-keyword">from</span> <span class="hljs-string">'@waves/waves-transactions'</span>
<span class="hljs-keyword">import</span> {setupDnode} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/setupDnode"</span>;
<span class="hljs-keyword">import</span> {decrypt, encrypt} <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/cryptoUtils"</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SignerApp</span> </span>{<font></font>
<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-comment">// public</span><font></font>
    getState() {<font></font>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">keys</span>: <span class="hljs-keyword">this</span>.store.keys,
            <span class="hljs-attr">messages</span>: <span class="hljs-keyword">this</span>.store.newMessages,
            <span class="hljs-attr">initialized</span>: <span class="hljs-keyword">this</span>.store.initialized,
            <span class="hljs-attr">locked</span>: <span class="hljs-keyword">this</span>.store.locked<font></font>
        }<font></font>
    }<font></font>
<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-comment">//</span><font></font>
    connectPopup(connectionStream) {<font></font>
        <span class="hljs-keyword">const</span> api = <span class="hljs-keyword">this</span>.popupApi();
        <span class="hljs-keyword">const</span> dnode = setupDnode(connectionStream, api);<font></font>
<font></font>
        dnode.once(<span class="hljs-string">'remote'</span>, (remote) =&gt; {
            <span class="hljs-comment">//  reaction   ,          ui </span>
            <span class="hljs-keyword">const</span> updateStateReaction = reaction(
                <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.getState(),<font></font>
                (state) =&gt; remote.updateState(state),<font></font>
                <span class="hljs-comment">//     . fireImmediatly   reaction    .</span>
                <span class="hljs-comment">//  ,    . Delay   debounce</span>
                {<span class="hljs-attr">fireImmediately</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">delay</span>: <span class="hljs-number">500</span>}<font></font>
            );<font></font>
            <span class="hljs-comment">//     </span>
            dnode.once(<span class="hljs-string">'end'</span>, () =&gt; updateStateReaction.dispose())<font></font>
<font></font>
        })<font></font>
    }<font></font>
<font></font>
    ...<font></font>
}</code></pre><br>
<p>   <code>remote</code>  <code>reaction</code>   ,      UI.</p><br>
<p>  —       :</p><br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupApp</span>(<span class="hljs-params"></span>) </span>{<font></font>
...<font></font>
<font></font>
    <span class="hljs-comment">// Reaction    .</span><font></font>
    reaction(<font></font>
        <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> app.store.newMessages.length &gt; <span class="hljs-number">0</span> ? app.store.newMessages.length.toString() : <span class="hljs-string">''</span>,<font></font>
        text =&gt; extensionApi.browserAction.setBadgeText({text}),<font></font>
        {<span class="hljs-attr">fireImmediately</span>: <span class="hljs-literal">true</span>}<font></font>
    );<font></font>
<font></font>
...<font></font>
}</code></pre><br>
<p>,  . -    :</p><br>
<p><img src="https://habrastorage.org/webt/yo/cz/9b/yocz9bncoevwxrict_3dl_vphek.png"></p><br>
<p><img src="https://habrastorage.org/webt/ee/8e/uj/ee8eujkmg5iwgfholkyxneqsim4.png"></p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p><strong></strong></p><br>
<p>     ,     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.         . </p><br>
<p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p><strong>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link">siemarell</a></strong></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja451784/index.html">エンタープライズストレージ用のハイブリッドドライブ。Seagate EXOSの使用経験</a></li>
<li><a href="../ja451786/index.html">Firebase Test Labで機器テストを実行します。パート1：iOSプロジェクト</a></li>
<li><a href="../ja451790/index.html">ゲーム内データ収集の危険性</a></li>
<li><a href="../ja451792/index.html">オンラインストアに閉じ込められる4つのJavaScriptスニファー</a></li>
<li><a href="../ja451794/index.html">テクスチャスキャンインデント</a></li>
<li><a href="../ja451798/index.html">mongoDBとSpring Bootによるデータ移行</a></li>
<li><a href="../ja451800/index.html">簡単なソナーモデムを作る</a></li>
<li><a href="../ja451802/index.html">.Net Community RaiffeisenbankがUPD mitap Broadcastに招待</a></li>
<li><a href="../ja451806/index.html">iOSダイジェストNo. 5（4月27日-5月16日）</a></li>
<li><a href="../ja451812/index.html">現在、優れた開発者は、ビューとサブスクライバーによって評価されています-これは悪いことです</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>