<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåû üå± üëçüèª Kubernetes tips & tricks: graceful shutdown runtime features in NGINX and PHP-FPM üëó üïã üìõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A typical condition for implementing CI / CD in Kubernetes: the application must be able to stop accepting new client requests before stopping, and mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes tips & tricks: graceful shutdown runtime features in NGINX and PHP-FPM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A typical condition for implementing CI / CD in Kubernetes: the application must be able to stop accepting new client requests before stopping, and most importantly, successfully complete existing ones. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ry/ef/karyefzfd99wtpxne9r_o73wies.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compliance with this condition allows you to achieve zero downtime during the deployment. </font><font style="vertical-align: inherit;">However, even when using very popular bundles (such as NGINX and PHP-FPM), you can encounter difficulties that will lead to a surge of errors with every deployment ...</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theory. </font><font style="vertical-align: inherit;">How pod lives</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have already published </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> detail about the pod life cycle </font><font style="vertical-align: inherit;">. In the context of this topic, we are interested in the following: at the moment when the pod enters the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminating</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state </font><font style="vertical-align: inherit;">, new requests cease to be sent to it (pod </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is removed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the list of endpoints for the service). Thus, to avoid downtime during the deployment, for our part, it is enough to solve the problem of the application stopping correctly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should also be remembered that the grace period is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 seconds</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by default </font><font style="vertical-align: inherit;">: after this, the pod will be terminated and the application should manage to process all requests before this period. </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: although any request that runs for more than 5-10 seconds is already problematic, and graceful shutdown will not help him anymore ...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
To better understand what happens when pod finishes its work, it is enough to study the following scheme: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/pt/ou/zxptou-qe7zxqgab6pszsdo5vlk.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A1, B1 - Getting changes about state of </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A2: Sending SIGTERM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B2 - Removing pod from endpoints </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B3 - Getting changes (endpoints list has changed) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B4 - Updating iptables rules</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Note: removing endpoint pod and sending SIGTERM is not done sequentially, but in parallel. And due to the fact that Ingress does not receive an updated list of Endpoints right away, new requests from clients will be sent to pod, which will cause 500 errors during pod termination</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(we </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translated</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> more detailed material on this issue </font><font style="vertical-align: inherit;">)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You need to solve this problem in the following ways:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Send in the headers of the Connection: close response (if it concerns an HTTP application).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If there is no way to make changes to the code, then the article describes a solution that will allow you to process requests until the end of the graceful period.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theory. </font><font style="vertical-align: inherit;">How NGINX and PHP-FPM End Their Processes</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with NGINX, as everything is more or less obvious with it. </font><font style="vertical-align: inherit;">Immersed in the theory, we learn that NGINX has one master process and several "workers" - these are child processes that process client requests. </font><font style="vertical-align: inherit;">A convenient feature is provided: using the command to </font></font><code>nginx -s &lt;SIGNAL&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminate processes either in fast shutdown mode or in graceful shutdown. </font><font style="vertical-align: inherit;">Obviously, we are interested in precisely the latter option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then everything is simple: you need to add a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">preStop hook</font></a><font style="vertical-align: inherit;"> that will send a graceful shutdown signal. </font><font style="vertical-align: inherit;">This can be done in Deployment, in the container block:</font></font><br>
<br>
<pre><code class="plaintext hljs">       lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /usr/sbin/nginx<font></font>
              - -s<font></font>
              - quit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, at the moment the pod completes its work in the NGINX container logs, we will see the following:</font></font><br>
<br>
<pre><code class="plaintext hljs">2018/01/25 13:58:31 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down<font></font>
2018/01/25 13:58:31 [notice] 11#11: gracefully shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And that will mean what we need: NGINX waits for the completion of queries, and then kills the process. </font><font style="vertical-align: inherit;">However, a common problem will be discussed below, because of which, even if there is a command, the </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process </font><font style="vertical-align: inherit;">does </font><font style="vertical-align: inherit;">not complete correctly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And at this stage we‚Äôve finished with NGINX: at least you can understand from the logs that everything works as it should. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What about PHP-FPM? </font><font style="vertical-align: inherit;">How does it handle graceful shutdown? </font><font style="vertical-align: inherit;">Let's get it right.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of PHP-FPM, a little less information. </font><font style="vertical-align: inherit;">If you focus on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on PHP-FPM, then it will tell you that the following POSIX signals are received:</font></font><br>
<br>
<ol>
<li> <code>SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- fast shutdown;</font></font></li>
<li> <code>SIGQUIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - graceful shutdown (what we need).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rest of the signals in this problem are not required, therefore, their analysis is omitted. </font><font style="vertical-align: inherit;">To complete the process correctly, you will need to write the following preStop hook:</font></font><br>
<br>
<pre><code class="plaintext hljs">        lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /bin/kill<font></font>
              - -SIGQUIT<font></font>
              - "1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, this is all that is required to perform a graceful shutdown in both containers. </font><font style="vertical-align: inherit;">However, the task is more complicated than it seems. </font><font style="vertical-align: inherit;">Next, we examined two cases in which the graceful shutdown did not work and caused a short-term inaccessibility of the project during the deployment.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice. </font><font style="vertical-align: inherit;">Possible problems with graceful shutdown</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, it is useful to remember: in addition to executing the command, </font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is another step that you should pay attention to. We ran into a problem when NGINX instead of a SIGQUIT signal sent SIGTERM anyway, due to which the requests did not complete correctly. Similar cases can be found, for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Unfortunately, we could not establish a specific reason for this behavior: there was a suspicion of the NGINX version, but it was not confirmed. The symptomatology was that in the logs of the NGINX container the messages </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúopen socket # 10 left in connection 5‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> were observed </font><font style="vertical-align: inherit;">, after which the pod stopped. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can observe such a problem, for example, by the answers to the Ingress we need: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/sz/ip/umszip1dlpudotn2dstg17qfnzs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Status code indicators at the time of the deployment</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we get just the 503 error code from Ingress itself: it cannot access the NGINX container, since it is no longer available. </font><font style="vertical-align: inherit;">If you look at the logs of the container with NGINX, they contain the following:</font></font><br>
<br>
<pre><code class="plaintext hljs">[alert] 13939#0: *154 open socket #3 left in connection 16<font></font>
[alert] 13939#0: *168 open socket #6 left in connection 13</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After changing the stop signal, the container starts to stop correctly: this is confirmed by the fact that a 503 error is no longer observed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you encounter a similar problem, it makes sense to figure out which stop signal is used in the container and how the preStop hook looks exactly. </font><font style="vertical-align: inherit;">It is possible that the reason lies precisely in this.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM ... and more</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem with PHP-FPM is described trivially: it does not wait for the completion of child processes, terminates them, because of which there are 502 errors during the deployment and other operations. Since 2005 there have been several error messages on bugs.php.net (for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) that describe this problem. But you probably will not see anything in the logs: PHP-FPM will announce the completion of its process without any errors or third-party notifications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth clarifying that the problem itself may, to a lesser or greater extent, depend on the application itself and may not appear, for example, in monitoring. If you still encounter it, then a simple workaround comes to mind: add a preStop hook with</font></font><code>sleep(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It will allow you to complete all requests that were before (we don‚Äôt accept new ones, since the pod is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminating</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state </font><font style="vertical-align: inherit;">), and after 30 seconds the pod itself will end with a signal </font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the container it will look like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">    lifecycle:<font></font>
      preStop:<font></font>
        exec:<font></font>
          command:<font></font>
          - /bin/sleep<font></font>
          - "30"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, due to the 30-second indication, </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significantly</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> increase the deployment time, since each pod will be terminated for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at least</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30 seconds, which is bad. What can be done with this? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us turn to the party responsible for the direct execution of the application. In our case, this is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by default does not monitor the execution of its child processes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the master process is terminated immediately. This behavior can be changed using a directive </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that specifies time limits for waiting for signals from the master by child processes. If you set the value to 20 seconds, this will cover most of the requests running in the container, and after their completion the master process will be stopped.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this knowledge, we will return to our last problem. As already mentioned, Kubernetes is not a monolithic platform: it takes some time for the interaction between its various components. This is especially true when we consider the work of Ingresss and other related components, because due to such a delay at the time of deployment it is easy to get a surge of 500 errors. For example, an error may occur at the stage of sending a request to upstream, but the ‚Äútime lag‚Äù of interaction between components is rather short - less than a second. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in conjunction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the already mentioned directive </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the following construction can be used for </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">lifecycle:<font></font>
  preStop:<font></font>
    exec:<font></font>
      command: ["/bin/bash","-c","/bin/sleep 1; kill -QUIT 1"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we compensate for the delay by the team </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and do not significantly increase the deployment time: is there a noticeable difference between 30 seconds and one? .. Essentially </font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">it takes on the ‚Äúmain job‚Äù </font><font style="vertical-align: inherit;">, but is </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used only as a ‚Äúsafety net‚Äù in case of lag. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generally speaking, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">described behavior and the corresponding workaround concern not only PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A similar situation may arise in one way or another when using other languages ‚Äã‚Äã/ frameworks. </font><font style="vertical-align: inherit;">If you cannot fix the graceful shutdown in other ways ‚Äî for example, rewrite the code so that the application correctly processes termination signals ‚Äî you can use the described method. </font><font style="vertical-align: inherit;">It may not be the most beautiful, but it works.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice. </font><font style="vertical-align: inherit;">Load testing to verify pod performance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Load testing is one way of checking how the container works, since this procedure brings you closer to real combat conditions when users visit the site. You can use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to test the above recommendations </font><font style="vertical-align: inherit;">: it perfectly covers all our needs. The following are tips and tricks for testing with a clear - thanks to the graphs of Grafana and Yandex.Tank itself - an example from our experience. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most important thing here is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to check for changes in stages.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After adding a new fix, run the test and see if the results have changed compared to the previous launch. Otherwise, it will be difficult to identify ineffective solutions, and in the future you can only do harm (for example, increase the deployment time). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another caveat - look at the logs of the container during its termination. Is graceful shutdown information recorded there? Are there any errors in the logs when accessing other resources (for example, a neighboring PHP-FPM container)? Errors of the application itself (as in the case of NGINX described above)? I hope that the introductory information from this article will help to better understand what happens to the container during its termination. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the first test run took place without </font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and without additional directives for the application server (</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in PHP-FPM). The purpose of this test was to identify the approximate number of errors (and whether they exist at all). Also, from additional information, it should be known that the average deployment time of each hearth was about 5-10 seconds to the state of full readiness. The results are as follows: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/yw/ap/ceywapg8q2kpztr-zdslhjy8brm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A splash of 502 errors is visible on the Yandex.Tank information panel, which occurred at the time of the deployment and lasted up to 5 seconds on average. Presumably this terminated the existing requests to the old pod when it was terminated. After that, 503 errors appeared, which was the result of a stopped NGINX container, which also disconnected due to the backend (because of which Ingress could not connect to it). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see how</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in PHP-FPM will help us wait for the completion of child processes, i.e. </font><font style="vertical-align: inherit;">fix such errors. </font><font style="vertical-align: inherit;">Repeated deployment using this directive: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/8g/0c/t58g0cs5b6umhjkmvlhjktbkio0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are no more errors during the deployment of the 500s! </font><font style="vertical-align: inherit;">The deployment is successful, the graceful shutdown works. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, it is worth remembering the moment with Ingress containers, a small percentage of errors in which we can get due to a time lag. </font><font style="vertical-align: inherit;">To avoid them, it remains to add the construction with </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and repeat the deployment. </font><font style="vertical-align: inherit;">However, in our particular case, no changes were visible (no errors again).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the correct completion of the process, we expect the following behavior from the application:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wait a few seconds, then stop accepting new connections.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wait for all requests to complete and close all keepalive connections that do not execute requests.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Complete your process.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, not all applications can work this way. </font><font style="vertical-align: inherit;">One solution to the problem in the realities of Kubernetes is:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adding a pre-stop hook that will wait a few seconds</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> studying the configuration file of our backend for the relevant parameters.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The NGINX example allows us to understand that even an application that initially must correctly process signals for completion may not do this, so it is critical to check for 500 errors during the deployment of the application. It also allows you to look at the problem more broadly and not concentrate on a separate pod or container, but look at the entire infrastructure as a whole. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Tank can be used as a testing tool in conjunction with any monitoring system (in our case, data from Grafana with a backend in the form of Prometheus were taken for the test). Problems with the graceful shutdown are clearly visible under heavy loads that the benchmark can generate, and monitoring helps to analyze the situation in more detail during or after the test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Responding to feedback on the article: it is worth mentioning that the problems and solutions are described here in relation to NGINX Ingress. </font><font style="vertical-align: inherit;">For other cases, there are other solutions that, perhaps, we will consider in the following materials of the cycle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other from the K8s tips &amp; tricks cycle:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalized error pages in NGINX Ingress</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the allocation of nodes and the load on the web application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access to dev-sites</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speeding up the bootstrap of large databases.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489984/index.html">AMA about udalenka: ask - we answer</a></li>
<li><a href="../en489986/index.html">Power Stage Designer Utility - Power Electronics Developer Tool</a></li>
<li><a href="../en489988/index.html">‚ÄúPut your hands up in the air!‚Äù: A mono review of the Playme TIO S dashcam</a></li>
<li><a href="../en489990/index.html">How did Service Desk save a service company, or What if your business grows?</a></li>
<li><a href="../en489992/index.html">Correct pod shutdown in Kubernetes cluster</a></li>
<li><a href="../en489998/index.html">11. Fortinet Getting Started v6.0. Licensing</a></li>
<li><a href="../en490002/index.html">How to GraphQL on Kotlin and Micronaut and create a single access point to the API of several microservices</a></li>
<li><a href="../en490006/index.html">Educational program for technical specifications</a></li>
<li><a href="../en490010/index.html">Examination of the type system for checking the correctness of music</a></li>
<li><a href="../en490012/index.html">Alert-s and Error-s of storage, how to deal with them?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>