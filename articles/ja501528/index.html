<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥢 💃🏿 🤾🏼 「Bash and cybersecurity：attack、Defense and analysis from the Linux command line」という本 🙎🏽 ☝🏿 🙋🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、habrozhiteli！コマンドラインは、サイバーセキュリティにとって理想的なツールです。優れた柔軟性と絶対的な可用性により、適切な経験があれば、標準のコマンドラインインターフェイス（CLI）が基本的なソリューションに変わります。
 
 著者のPaul TronkonとKarl Alb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>「Bash and cybersecurity：attack、Defense and analysis from the Linux command line」という本</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/501528/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/xx/ml/ir/xxmlirxciwbxahmteiy-9cslfxg.jpeg" align="left" alt="画像"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、habrozhiteli！</font><font style="vertical-align: inherit;">コマンドラインは、サイバーセキュリティにとって理想的なツールです。</font><font style="vertical-align: inherit;">優れた柔軟性と絶対的な可用性により、適切な経験があれば、標準のコマンドラインインターフェイス（CLI）が基本的なソリューションに変わります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
著者のPaul TronkonとKarl Albingは、プロアクティブな保護でデータを収集し、ログを分析し、ネットワークの状態を監視するのに役立つコマンドラインツールとトリックについて語っています。</font><font style="vertical-align: inherit;">ペンテスターは、ほとんどすべてのバージョンのLinuxに組み込まれている巨大な機能を使用して攻撃を行う方法を学びます。</font></font><br>
<a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この本は誰のためのものですか。</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本「Bash and cybersecurity」は、コンピューターのセキュリティのコンテキストでコマンドラインを使用する方法を学びたい人を対象としています。</font><font style="vertical-align: inherit;">私たちの目標は、既存のツールをコマンドラインスクリプトで置き換えることではなく、コマンドラインを効果的に使用して既存の機能を改善する方法を教えることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本全体を通して、データ収集、分析、侵入テストなどのセキュリティ手法の例を提供しています。</font><font style="vertical-align: inherit;">これらの例の目的は、コマンドライン機能を示し、上位レベルのツールで使用される基本的な方法のいくつかを紹介することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この本はプログラミングの入門書ではありませんが、一部の一般的な概念はパートIでカバーされています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リアルタイムのログ監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベント発生後に雑誌を分析する能力は重要なスキルです。</font><font style="vertical-align: inherit;">しかし、悪意のあるアクションまたは疑わしいアクションが発生したときにそれらを検出するために、ログファイルからリアルタイムで情報を抽出できることも同様に重要です。</font><font style="vertical-align: inherit;">この章では、分析を表示し、システムまたはネットワークの動作に関する既知の脅威インジケーター（侵害のインジケーター）に基づいてアラートを生成するように作成およびフォーマットされたジャーナルエントリーを読み取る方法について検討します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストログの監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログをリアルタイムで監視する最も簡単な方法は、–fパラメーターを指定してtailコマンドを使用することです。これは、ファイルを継続的に読み取り、新しい行が追加されるとそれらをstdoutに表示します。前の章と同様に、例としてApache Webサーバーアクセスログを使用しますが、説明されている方法はすべてのテキストログに関連します。 tailコマンドを使用してApacheアクセスログを追跡するには、次のように入力します</font></font><br>
<br>
<code>tail -f /var/logs/apache2/access.log</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。tailコマンドからの出力をgrepコマンドに渡すことができるため、特定の基準に一致するレコードのみが表示されます。次の例では、Apacheアクセスログを追跡し、特定のIPアドレスに対応するエントリを表示します。</font></font><br>
<br>
<code>tail -f /var/logs/apache2/access.log | grep '10.0.0.152'<br>
</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正規表現を使用することもできます。この例では、HTTP 404ステータスコード「ページが見つかりません」を返すレコードのみが表示されます。文字の大文字小文字を無視する-iオプションが追加されました。</font></font><br>
<br>
<code>tail -f /var/logs/apache2/access.log | egrep -i 'HTTP/.*" 404'</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
無関係な情報を消去するには、出力をcutコマンドに渡す必要があります。この例では、ステータスコード404につながるクエリのアクセスログを監視し、cutメソッドを使用して日付と時刻と要求されたページのみを表示します。</font><font style="vertical-align: inherit;">
次に、角かっこと二重引用符を削除して、出力をtr -d 'に送信できます。 []「」</font></font><br>
<br>
<code>$ tail -f access.log | egrep --line-buffered 'HTTP/.*" 404' | cut -d' ' -f4-7<br>
[29/Jul/2018:13:10:05 -0400] "GET /test<br>
[29/Jul/2018:13:16:17 -0400] "GET /test.txt<br>
[29/Jul/2018:13:17:37 -0400] "GET /favicon.ico</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注：ここでは、egrepコマンドの--line-bufferingオプションを使用しています。</font><font style="vertical-align: inherit;">これにより、egrepは改行が発生するたびにstdoutに出力します。</font><font style="vertical-align: inherit;">このパラメータがないと、バッファリングが発生し、バッファがいっぱいになるまで出力はカットコマンドに送信されません。</font><font style="vertical-align: inherit;">そんなに長く待ちたくない。</font><font style="vertical-align: inherit;">このオプションを使用すると、egrepコマンドは、各行が見つかったときにそれを書き込むことができます。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドライン</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファバッファリング中に何が起こりますか？</font><font style="vertical-align: inherit;">egrepが指定されたパターンに一致する多くの文字列を見つけると想像してください。</font><font style="vertical-align: inherit;">この場合、egrepは大量の出力を生成します。</font><font style="vertical-align: inherit;">ただし、出力（実際には任意の入力または出力）は、データ処理（テキスト検索）よりもはるかに高価です（時間がかかります）。</font><font style="vertical-align: inherit;">したがって、I / O呼び出しが少ないほど、プログラムはより効率的になります。</font></font><br>
<br>
     grep       ,  ,          .         .  grep       .   ,  grep   50    .   ,     50  ,     ,     .   50  !<br>
<br>
       egrep, ,             .  egrep       ,     ,     .    ,    ,   ,      ,      .      ,     .<br>
<br>
    ,    ,  tail -f        (    ),       . ,       « »,      .     .          .<br>
<br>
   ,        egrep     ,     .        ,   .</blockquote><br>
<h3>    </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tailコマンドとegrepコマンドを使用してログを監視し、疑わしいまたは悪意のあるアクティビティの既知のパターン（IOCと呼ばれることが多い）に対応するエントリを表示できます。単純な侵入検知システム（IDS）を作成できます。まず、例8.1に示すように、IOCの正規表現パターンを含むファイルを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.1。 ioc.txt </font><b><font style="vertical-align: inherit;">（1）</font></b><font style="vertical-align: inherit;">このテンプレート（../）は、ラウンドアバウトディレクトリ攻撃の指標です。攻撃者は現在の作業ディレクトリを終了し、アクセスできないファイルにアクセスしようとします。</font><b><font style="vertical-align: inherit;">（2）</font></b><font style="vertical-align: inherit;"> Linux etc / passwdおよびetc / shadowファイルはシステム認証に使用され、Webサーバーを介してアクセスすることはできません。</font><b><font style="vertical-align: inherit;">（3）</font></b></font><br>
<br>
<code>\.\./ <b>(1)</b><br>
etc/passwd <b>(2)</b><br>
etc/shadow<br>
cmd\.exe <b>(3)</b><br>
/bin/sh<br>
/bin/bash<br>
</code><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe、/ bin / sh、または/ bin / bashファイルを提供することは、Webサーバーから返された逆接続の指標です。リバース接続は、多くの場合、操作が成功したことを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後でegrepコマンドで使用されるため、IOCは正規表現形式である必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ioc.txtファイルは、egrep -fオプションで使用できます。このパラメーターは、指定されたファイルから正規表現パターンを検索するようにegrepに指示します。これにより、tailコマンドを使用してログファイルを監視でき、各レコードが追加されると、読み取り行がIOCファイル内のすべてのテンプレートと比較され、対応するレコードが表示されます。次に例を示します。</font></font><br>
<br>
<code>tail -f /var/logs/apache2/access.log | egrep -i -f ioc.txt</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、teeコマンドを使用して、画面に警告を同時に表示し、後で処理するために独自のファイルに保存</font><font style="vertical-align: inherit;">
することができます。この場合も、コマンドの出力のバッファリングによって問題が発生しないようにするには、-line-bufferedオプションが必要です。</font></font><br>
<br>
<code>tail -f /var/logs/apache2/access.log | egrep --line-buffered -i -f ioc.txt |<br>
tee -a interesting.txt</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windowsログモニタリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、Windowsイベントにアクセスするにはwevtutilコマンドを使用する必要があります。</font><font style="vertical-align: inherit;">このコマンドは汎用ですが、新しい着信レコードを取得するために使用できるテールなどの機能はありません。</font><font style="vertical-align: inherit;">ただし、解決策はあります。同じ機能を提供できる単純なbashスクリプトを使用してください（例8.2）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.2。</font><font style="vertical-align: inherit;">wintail.sh</font></font><br>
<br>
<pre><code class="java hljs">#!/bin/bash -<font></font>
#<font></font>
# Bash  <font></font>
# wintail.sh<font></font>
#<font></font>
# :<font></font>
#    tail   Windows<font></font>
#<font></font>
# : ./wintail.sh<font></font>
#<font></font>
<font></font>
WINLOG=<span class="hljs-string">"Application"</span> (<span class="hljs-number">1</span>)<font></font>
<font></font>
LASTLOG=$(wevtutil qe <span class="hljs-string">"$WINLOG"</span> <span class="hljs-comment">//c:1 //rd:true //f:text) (2)</span><font></font>
<font></font>
<span class="hljs-keyword">while</span> <span class="hljs-keyword">true</span>
<span class="hljs-keyword">do</span>
      CURRENTLOG=$(wevtutil qe <span class="hljs-string">"$WINLOG"</span> <span class="hljs-comment">//c:1 //rd:true //f:text) (3)</span>
      <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"$CURRENTLOG"</span> != <span class="hljs-string">"$LASTLOG"</span> ]]<font></font>
      then<font></font>
            echo <span class="hljs-string">"$CURRENTLOG"</span>
            echo <span class="hljs-string">"----------------------------------"</span>
            LASTLOG=<span class="hljs-string">"$CURRENTLOG"</span><font></font>
      fi<font></font>
done</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（1）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この変数は、追跡するWindowsログを定義します。システムで現在使用可能なログのリストについては、wevtutil elコマンドを使用できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは、指定したログファイルを要求するためにwevtutilを実行しています。 c：1パラメータは1つのログエントリのみを返します。 rd：trueパラメータにより、コマンドは最新のログエントリを読み取ることができます。最後に、f：textは結果をXML形式ではなくプレーンテキストで返すため、画面から結果を簡単に読み取ることができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の数行でwevtutilコマンドが再度実行され、新しく受信したログエントリが画面に出力された最後のログエントリと比較されます。</font><font style="vertical-align: inherit;">それらが互いに異なる場合、これはログに変更があったことを意味します。</font><font style="vertical-align: inherit;">この場合、新しいエントリが表示されます。</font><font style="vertical-align: inherit;">比較されるレコードが同じ場合、何も起こらず、wevtutilコマンドは戻って検索と比較を再開します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リアルタイムのヒストグラム作成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tail -fコマンドは、現在のデータストリームを提供します。</font><font style="vertical-align: inherit;">しかし、特定の期間にファイルに追加された行数をカウントしたい場合はどうでしょうか。</font><font style="vertical-align: inherit;">このデータストリームを観察し、タイマーを開始して、指定した期間にわたってカウントを実行できます。</font><font style="vertical-align: inherit;">その後、カウントを停止し、結果を報告する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この作業は2つのスクリプトプロセスに分割できます。1つのスクリプトは行を読み取り、もう1つのスクリプトは時間を監視します。タイマーは、シグナルと呼ばれる標準のPOSIXプロセス間通信メカニズムを使用してラインカウンターに通知します。信号はソフトウェア割り込みであり、さまざまな種類の信号があります。それらのいくつかは致命的です-それらはプロセスの終わりにつながります（たとえば、浮動小数点演算の例外）。これらの信号のほとんどは、無視することもキャッチすることもできます。シグナルがキャッチされたときにアクションが実行されます。これらの信号の多くには、オペレーティングシステムで事前定義された目的があります。ユーザーが使用できる2つの信号の1つを使用します。これはシグナルSIGUSR1です（もう1つはSIGUSR2です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シェルスクリプトは、組み込みのtrapコマンドを使用して割り込みをキャッチできます。これを使用して、信号を受信したときに実行するアクションを決定するコマンドと、このコマンドの呼び出しをトリガーする信号のリストを選択できます。例：</font></font><br>
<br>
<code>trap warnmsg SIGINT</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、たとえばCtrl + Cを押して実行中のプロセスを中断した場合など、シェルスクリプトがSIGINTシグナルを受信するたびにwarnmsgコマンド（独自のスクリプトまたは関数）が呼び出されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.3は、カウントを実行するスクリプトを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.3 looper.sh</font></font><br>
<br>
<pre><code class="java hljs">#!/bin/bash -<font></font>
#<font></font>
# Bash  <font></font>
# looper.sh<font></font>
#<font></font>
# :<font></font>
#    <font></font>
#<font></font>
# : ./looper.sh [filename]<font></font>
# filename —  ,   ,<font></font>
#  : log.file<font></font>
#<font></font>
<font></font>
<span class="hljs-function">function <span class="hljs-title">interval</span> <span class="hljs-params">()</span>                                           <span class="hljs-params">(<span class="hljs-number">1</span>)</span>
</span>{<font></font>
      echo $(date <span class="hljs-string">'+%y%m%d %H%M%S'</span>) $cnt                       (<span class="hljs-number">2</span>)<font></font>
      cnt=<span class="hljs-number">0</span><font></font>
}<font></font>
<font></font>
declare -i cnt=<span class="hljs-number">0</span>
<span class="hljs-function">trap interval <span class="hljs-title">SIGUSR1</span>                                          <span class="hljs-params">(<span class="hljs-number">3</span>)</span>

shopt -s <span class="hljs-title">lastpipe</span>                                              <span class="hljs-params">(<span class="hljs-number">4</span>)</span>

tail -f --pid</span>=$$ ${<span class="hljs-number">1</span>:-log.file} | <span class="hljs-function"><span class="hljs-keyword">while</span> read <span class="hljs-title">aline</span>             <span class="hljs-params">(<span class="hljs-number">5</span>)</span>
<span class="hljs-keyword">do</span>
     let cnt++
done</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（1）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターバル関数は、各シグナルの受信時に呼び出されます。もちろん、インターバルに名前を付けて式でトラップを使用する前に、インターバルを定義する必要があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dateコマンドが呼び出され、出力しているcnt変数の値のタイムスタンプが提供されます。カウンターが表示されたら、この値を0にリセットして、次の間隔のカウントダウンを開始します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間隔が定義されたので、プロセスがシグナルSIGUSR1を受信するたびに関数が呼び出されることを示すことができます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（4）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは非常に重要なステップです。通常、コマンドのパイプラインがある場合（たとえば、ls-l | grep rwx | wc）、パイプラインの一部（各コマンド）はサブネット上で実行され、各プロセスは独自のプロセス識別子で終了します。 whileループが異なるプロセス識別子を持つサブシェルにあるため、これはこのシナリオでは問題になる可能性があります。どのプロセスが開始しても、looper.shスクリプトは、信号を送信するためのwhileループプロセスの識別子を認識しません。さらに、サブシェルでcnt変数の値を変更しても、メインプロセスのcnt値は変更されないため、メインプロセスの信号は常に値を0に設定します。この問題は、（-s）パラメーターをlastpipeに設定するshoptコマンドで解決できます。パイプラインの最後のコマンドのサブシェルを作成しないようにシェルに指示します。スクリプトと同じプロセスでこのコマンドを実行します。この場合、これは、tailコマンドがサブシェル（つまり、別のプロセス）で実行され、whileループがメインスクリプトプロセスの一部になることを意味します。注：このシェルオプションは、bashバージョン4.x以降でのみ使用でき、非インタラクティブシェル（スクリプトなど）でのみ使用できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（5）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、別の--pidパラメータを指定したtail -fコマンドです。プロセスの識別子を示します。このプロセスが完了すると、tailコマンドが終了します。表示する現在のシェルスクリプト$$のプロセスIDを指定します。このアクションにより、プロセスをクリーンアップし、tailコマンドをバックグラウンドで実行したままにしないでください（たとえば、このスクリプトがバックグラウンドで実行される場合、例8.4）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tailcount.shスクリプトは、ストップウォッチ（タイマー）を使用してスクリプトを開始および停止し、時間間隔をカウントします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.4。 tailcount.sh</font></font><br>
<br>
<pre><code class="java hljs">#!/bin/bash -<font></font>
#<font></font>
# Bash  <font></font>
# tailcount.sh<font></font>
#<font></font>
# :<font></font>
#    n <font></font>
#<font></font>
# : ./tailcount.sh [filename]<font></font>
#     filename:  looper.sh<font></font>
#<font></font>
<font></font>
#  —    <font></font>
<span class="hljs-function">function <span class="hljs-title">cleanup</span> <span class="hljs-params">()</span>
</span>{<font></font>
      [[ -n $LOPID ]] &amp;&amp; kill $LOPID          (<span class="hljs-number">1</span>)<font></font>
}<font></font>
<font></font>
<span class="hljs-function">trap cleanup <span class="hljs-title">EXIT</span>                             <span class="hljs-params">(<span class="hljs-number">2</span>)</span>
bash looper.sh $1 &amp;                           <span class="hljs-params">(<span class="hljs-number">3</span>)</span>
LOPID</span>=$!                                      (<span class="hljs-number">4</span>)<font></font>
#   <font></font>
sleep <span class="hljs-number">3</span><font></font>
<font></font>
<span class="hljs-keyword">while</span> <span class="hljs-keyword">true</span>
<span class="hljs-keyword">do</span><font></font>
      kill -SIGUSR1 $LOPID<font></font>
      sleep <span class="hljs-number">5</span>
done &gt;&amp;<span class="hljs-number">2</span>                                      (<span class="hljs-number">5</span>)</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（1）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このスクリプトは他のスクリプトを実行するため、作業後にクリーンアップする必要があります。プロセス識別子がLOPIDに格納されている場合、変数は値を格納するため、関数はkillコマンドを使用してこのプロセスにシグナルを送信します。 killコマンドで特定のシグナルを指定しない場合、デフォルトでSIGTERMシグナルが送信されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> EXITコマンドはシグナルではありません。これは、このスクリプトを実行しているシェルがシャットダウンしようとしている場合に、trapステートメントがシェルにこの関数（この場合はクリーンアップ）を呼び出すように指示する特殊なケースです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今、本当の仕事が始まります。 looper.shスクリプトが起動され、バックグラウンドで実行されます。このスクリプトが（コマンドが作業を完了するのを待たずに）サイクル全体で機能するには、キーボードから切断されています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（4）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここには、バックグラウンドで開始したスクリプトプロセスの識別子が格納されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（5）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このリダイレクトは単なる予防策です。 whileループまたはkill / sleepステートメントからのすべての出力（期待されていませんが）は、looper.sh関数からの出力と混合しないでください。これは、バックグラウンドで機能しますが、いずれにしてもstdoutに送信します。したがって、データをstdoutからstderrにリダイレクトします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要約すると、looper.sh関数はバックグラウンドに配置されていますが、そのプロセス識別子はシェル変数に格納されています。 5秒ごとに、tailcount.shスクリプトはシグナルSIGUSR1をこのプロセスに送信し（これはlooper.sh関数で実行されます）、次に、looper.shスクリプトを呼び出して、修正されている現在の行数を出力し、カウントを再開します。終了後、tailcount.shスクリプトは、SIGTERMシグナルをlooper.sh関数に送信して中断することでクリアされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行カウントを実行するスクリプトと、最初のスクリプトを制御するストップウォッチ（タイマー）を備えたスクリプトの2つのスクリプトを使用して、出力（特定の期間の行数）を取得できます。これに基づいて、次のスクリプトがヒストグラムを作成します。それは次のように呼ばれます：</font></font><br>
<br>
<code>bash tailcount.sh | bash livebar.sh</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
livebar.shスクリプトは、stdinからデータを読み取り、出力をstdoutに出力します（入力行ごとに1行）（例8.5）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例8.5 </font><font style="vertical-align: inherit;">livebar.sh</font></font><br>
<br>
<pre><code class="java hljs">#!/bin/bash -<font></font>
#<font></font>
# Bash  <font></font>
# livebar.sh<font></font>
#<font></font>
# :<font></font>
#    «» <font></font>
#<font></font>
# :<font></font>
# &lt;output from other script or program&gt; | bash livebar.sh<font></font>
#<font></font>
<font></font>
<span class="hljs-function">function <span class="hljs-title">pr_bar</span> <span class="hljs-params">()</span>                                         <span class="hljs-params">(<span class="hljs-number">1</span>)</span>
</span>{<font></font>
      local raw maxraw scaled<font></font>
      raw=$<span class="hljs-number">1</span>
      maxraw=$<span class="hljs-number">2</span><font></font>
      ((scaled=(maxbar*raw)/maxraw))<font></font>
      ((scaled == <span class="hljs-number">0</span>)) &amp;&amp; scaled=<span class="hljs-number">1</span> #   
      <span class="hljs-keyword">for</span>((i=<span class="hljs-number">0</span>; i&lt;scaled; i++)) ; <span class="hljs-keyword">do</span> printf <span class="hljs-string">'#'</span> ; done<font></font>
      printf <span class="hljs-string">'\n'</span><font></font>
<font></font>
} # pr_bar<font></font>
<font></font>
maxbar=<span class="hljs-number">60</span>     #         (<span class="hljs-number">2</span>)<font></font>
MAX=<span class="hljs-number">60</span>
<span class="hljs-function"><span class="hljs-keyword">while</span> read dayst timst qty
<span class="hljs-keyword">do</span>
      <span class="hljs-title">if</span> <span class="hljs-params">(( qty &gt; MAX )</span>)                                   <span class="hljs-params">(<span class="hljs-number">3</span>)</span>
      then
           let MAX</span>=$qty+$qty/<span class="hljs-number">4</span>    #   <font></font>
           echo <span class="hljs-string">"                      **** rescaling: MAX=$MAX"</span><font></font>
      fi<font></font>
      printf <span class="hljs-string">'%6.6s %6.6s %4d:'</span> $dayst $timst $qty         (<span class="hljs-number">4</span>)<font></font>
      pr_bar $qty $MAX<font></font>
done<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（1）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr_bar関数は、指定されたパラメーターに基づいて最大サイズにスケーリングされたハッシュタグの文字列を表示します。</font><font style="vertical-align: inherit;">以前にhistogram.shスクリプトで使用していたため、この機能はなじみがあるように見えるかもしれません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、許容できる最長のハッシュタグ行サイズです（行の折り返しなしで行うため）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示される値はどのくらいの大きさですか？これを事前に知らなくても（このデータは引数としてスクリプトに提供できます）、スクリプトは最大値を追跡します。この最大値を超えると、値は「スケール」し始め、現在表示されている線と将来の線も新しい最大値にスケールされます。スクリプトは最大値に25％を追加するため、毎回次の新しい値が1〜2％しか増加しない場合、値をスケーリングする必要はありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（4）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printfは、印刷される最初の2つのフィールドの最小幅と最大幅を定義します。</font><font style="vertical-align: inherit;">これらは、幅の値を超えた場合に切り捨てられる日時スタンプです。</font><font style="vertical-align: inherit;">値全体を表示するには、4文字の幅を指定します。</font><font style="vertical-align: inherit;">この場合、制限にもかかわらず、すべての値が印刷されます。</font><font style="vertical-align: inherit;">値の文字数が4未満の場合、欠落している文字にはスペースが追加されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスクリプトはstdinから読み込まれるため、自分で実行して、その動作を確認できます。</font><font style="vertical-align: inherit;">次に例を示します。</font></font><br>
<br>
<pre><code class="java hljs">$ bash  livebar.sh
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">20</span>
<span class="hljs-number">201010</span>     <span class="hljs-number">1020</span> <span class="hljs-number">20</span>:####################
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">70</span>
                       **** rescaling: MAX=<span class="hljs-number">87</span>
<span class="hljs-number">201010</span>     <span class="hljs-number">1020</span> <span class="hljs-number">70</span>:################################################
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">75</span>
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">75</span>:###################################################<font></font>
^C</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、入力と出力が混在しています。</font><font style="vertical-align: inherit;">入力をファイルに入れてスクリプトにリダイレクトし、出力のみを表示することもできます。</font></font><br>
<br>
<pre><code class="java hljs">$ bash livebar.sh &lt; testdata.txt<font></font>
bash livebar.sh &lt; x.data<font></font>
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">20</span>:####################<font></font>
                 **** rescaling: MAX=<span class="hljs-number">87</span>
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">70</span>:################################################
<span class="hljs-number">201010</span> <span class="hljs-number">1020</span> <span class="hljs-number">75</span>:###################################################<font></font>
$</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
»本の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版社のWebサイトを参照してください</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目次</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抜粋</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ハブロジテリーのクーポンの25％割引- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッシュ</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
紙の本を支払うと、電子書籍が電子メールで送信されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja501516/index.html">掃除機を消しましょう！アレクセイ・レソフスキー</a></li>
<li><a href="../ja501520/index.html">C＃8およびnullの有効性。これをどうやって生きるの</a></li>
<li><a href="../ja501522/index.html">無料のスキルボックスウェビナー：PHP、Unity、Unreal Engineでゲームを書く</a></li>
<li><a href="../ja501524/index.html">地球と生物の電磁界を同期させる秘訣</a></li>
<li><a href="../ja501526/index.html">なぜカナダ英語は「汚い」と見なされ、キアヌ・リーブスはそれと何をしなければならないのですか？</a></li>
<li><a href="../ja501534/index.html">今COVID-19で発疹もあります</a></li>
<li><a href="../ja501536/index.html">カスタムメイド：コードの行がどのようにしてキロトンの石炭に変わったかについての物語</a></li>
<li><a href="../ja501538/index.html">Pythonのインデント-ソリューションオプション</a></li>
<li><a href="../ja501542/index.html">Nikolai Parukhin：「OpenStreetMapは人に優しすぎます。彼は彼らを信頼している...」</a></li>
<li><a href="../ja501544/index.html">完璧なスマートフォン</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>