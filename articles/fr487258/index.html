<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè≥Ô∏è‚Äçüåà ü•É üë®üèª‚Äçüî¨ PHP asynchrone ‚è∞ ‚õàÔ∏è üòê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a dix ans, nous avions une pile LAMP classique: Linux, Apache, MySQL et PHP, qui fonctionnait en mode lent de mod_php. Le monde a chang√©, et avec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHP asynchrone</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/487258/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a dix ans, nous avions une pile LAMP classique: Linux, Apache, MySQL et PHP, qui fonctionnait en mode lent de mod_php. Le monde a chang√©, et avec lui l'importance de la vitesse. PHP-FPM est apparu, ce qui a permis d'augmenter consid√©rablement les performances des solutions en PHP, et de ne pas r√©√©crire de toute urgence vers quelque chose de plus rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En parall√®le, la biblioth√®que ReactPHP a √©t√© d√©velopp√©e en utilisant le concept Event Loop pour traiter les signaux du syst√®me d'exploitation et pr√©senter les r√©sultats des op√©rations asynchrones. Le d√©veloppement de l'id√©e de ReactPHP - AMPHP. Cette biblioth√®que utilise la m√™me boucle d'√©v√©nement, mais prend en charge les coroutines, contrairement √† ReactPHP. Ils vous permettent d'√©crire du code asynchrone qui ressemble √† synchrone. C'est peut-√™tre le cadre le plus actuel pour d√©velopper des applications asynchrones en PHP.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/03/e6/tf03e6u08mt8gake9o4lbbfbdca.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la vitesse est de plus en plus n√©cessaire, les outils ne sont d√©j√† pas suffisants, donc l'id√©e de programmation asynchrone en PHP est l'un des moyens d'acc√©l√©rer le traitement des requ√™tes et de mieux utiliser les ressources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est ce dont </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Shabovta va</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parler </font><font style="vertical-align: inherit;">(</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zloyusr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Est d√©veloppeur chez Onliner. </font><font style="vertical-align: inherit;">Exp√©rience de plus de 10 ans: j'ai commenc√© avec des applications bureautiques en C / C ++, puis je suis pass√© au d√©veloppement web en PHP. </font><font style="vertical-align: inherit;">Il √©crit des projets "Home" en C # et Python 3, et en PHP il exp√©rimente DDD, CQRS, Event Sourcing, Async Multitasking.</font></font><br>
<a name="habracut"></a><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet article est bas√© sur une transcription du rapport d'Anton sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russie 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous y comprendrons les op√©rations bloquantes et non bloquantes en PHP, nous √©tudierons de l'int√©rieur la structure des boucles d'√©v√©nements et des primitives asynchrones, telles que Promise et coroutines. </font><font style="vertical-align: inherit;">Enfin, nous d√©couvrirons ce qui nous attend dans ext-async, AMPHP 3 et PHP 8.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/w75P9RrVgKg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous introduisons quelques d√©finitions. </font><font style="vertical-align: inherit;">Pendant longtemps, j'ai essay√© de trouver une d√©finition exacte des op√©rations asynchrones et asynchrones, mais je n'ai pas trouv√© et √©crit la mienne.</font></font><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'asynchronie</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la capacit√© d'un syst√®me logiciel √† ne pas bloquer le thread principal d'ex√©cution. </font></font><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une op√©ration asynchrone</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une op√©ration qui ne bloque pas le flux d'ex√©cution d'un programme tant qu'elle n'est pas termin√©e.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble simple, mais vous devez d'abord comprendre quelles op√©rations bloquent le flux d'ex√©cution.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√©rations de blocage</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP est un langage interpr√©teur. </font><font style="vertical-align: inherit;">Il lit le code ligne par ligne, traduit dans ses instructions et ex√©cute. </font><font style="vertical-align: inherit;">Sur quelle ligne de l'exemple ci-dessous le code sera-t-il bloqu√©?</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params">User $user</span>)
</span>{
    <span class="hljs-keyword">try</span> {<font></font>
        $sql = <span class="hljs-string">'UPDATE users SET ...'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;connection-&gt;execute($sql, $user-&gt;data());<font></font>
    } <span class="hljs-keyword">catch</span> (\PDOException $error) {<font></font>
        log($error-&gt;getMessage());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous nous connectons √† la base de </font><font style="vertical-align: inherit;">donn√©es via PDO, le thread d'ex√©cution sera bloqu√© sur la cha√Æne de requ√™te SQL serveur: </font></font><code>return $this-&gt;connection-&gt;execute($sql, $user-&gt;data());</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est parce que PHP ne sait pas combien de temps le serveur SQL traitera cette requ√™te et s'il s'ex√©cutera du tout. </font><font style="vertical-align: inherit;">Il attend une r√©ponse du serveur et le programme n'a pas √©t√© ex√©cut√© pendant tout ce temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP bloque √©galement le flux d'ex√©cution sur toutes les op√©rations d'E / S.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Syst√®me de fichiers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>fwrite</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>file_get_contents</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de donn√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Presque toutes les extensions pour connecter une base de donn√©es fonctionnent par d√©faut en mode blocage.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>exec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>proc_open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ce sont des op√©rations de blocage, car tout travail avec des processus est construit via des appels syst√®me.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travailler avec stdin / stdout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>readline</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>echo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, l'ex√©cution est bloqu√©e sur les </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temporisateurs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>usleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ce sont des op√©rations dans lesquelles nous disons explicitement au thread de s'endormir pendant un certain temps. </font><font style="vertical-align: inherit;">PHP sera inactif tout ce temps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client SQL asynchrone</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le PHP moderne est un langage √† usage g√©n√©ral, et pas seulement pour le Web comme PHP / FI en 1997. </font><font style="vertical-align: inherit;">Par cons√©quent, nous pouvons √©crire un client SQL asynchrone √† partir de z√©ro. </font><font style="vertical-align: inherit;">La t√¢che n'est pas la plus triviale, mais r√©soluble.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    <font></font>
    socket_write($socket, $data, strlen($data));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que fait un tel client? </font><font style="vertical-align: inherit;">Il se connecte √† notre serveur SQL, met le socket en mode non bloquant, emballe la requ√™te dans un format binaire que le serveur SQL comprend, √©crit des donn√©es dans le socket. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque le socket est en mode non bloquant, l'op√©ration d'√©criture depuis PHP est rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais que reviendra-t-il √† la suite d'une telle op√©ration? </font><font style="vertical-align: inherit;">Nous ne savons pas ce que le serveur SQL r√©pondra. </font><font style="vertical-align: inherit;">Le traitement de la demande peut prendre du temps ou pas du tout. </font><font style="vertical-align: inherit;">Mais quelque chose doit √™tre retourn√©? </font><font style="vertical-align: inherit;">Si nous utilisons PDO et appelons la </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requ√™te sur le serveur SQL, nous sommes renvoy√©s </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de lignes modifi√©es par cette requ√™te. </font><font style="vertical-align: inherit;">Nous ne pouvons pas encore le retourner, donc nous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promettons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seulement </font><strong><font style="vertical-align: inherit;">un</font></strong><font style="vertical-align: inherit;"> retour.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promettre</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un concept issu du monde de la programmation asynchrone.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promise est un objet wrapper sur le r√©sultat d'une op√©ration asynchrone. </font><font style="vertical-align: inherit;">De plus, le r√©sultat de l'op√©ration nous est encore inconnu.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malheureusement, il n'y a pas de norme Promise unique et il n'est pas possible de transf√©rer directement des normes du monde JavaScript vers PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonctionnement de Promise</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisqu'il n'y a pas encore de r√©sultat, nous pouvons seulement en √©tablir </font></font><code>callbacks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/n1/qq/ian1qqvr_xs0faonifptkfrd2jc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque des donn√©es sont disponibles, il est n√©cessaire d'ex√©cuter un rappel </font></font><code>onResolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/bk/sf/8vbksfxvsfxskeozp3jckft5rmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si une erreur se produit, un rappel sera ex√©cut√© </font></font><code>onReject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour g√©rer l'erreur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8x/hw/0v/8xhw0vsdhfryxyxalvsydiydfsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interface Promise ressemble √† ceci.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">const</span>
        STATUS_PENDING = <span class="hljs-number">0</span>,<font></font>
        STATUS_RESOLVED = <span class="hljs-number">1</span>,<font></font>
        STATUS_REJECTED = <span class="hljs-number">2</span><font></font>
    ;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResolve</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReject</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promise a un statut et des m√©thodes pour d√©finir des rappels et remplir ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Promise avec des donn√©es ou error ( </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Mais il y a des diff√©rences et des variations. </font><font style="vertical-align: inherit;">Les m√©thodes peuvent √™tre appel√©es diff√©remment, ou √† la place de m√©thodes distinctes pour √©tablir des rappels, </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et il </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut </font><font style="vertical-align: inherit;">y en </font><font style="vertical-align: inherit;">avoir une, comme dans AMPHP, par exemple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Souvent des techniques pour remplir Promise </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retirer dans un objet s√©par√© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonction asynchrone √† √©tat de stockage </font><strong><font style="vertical-align: inherit;">diff√©r√©</font></strong><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Elle peut √™tre consid√©r√©e comme une sorte d'usine pour Promise. </font><font style="vertical-align: inherit;">C'est unique: un diff√©r√© fait une promesse. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bq/on/aq/bqonaqi04ql4kdhakfezn9nu25g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment appliquer cela dans le client SQL si nous d√©cidons de l'√©crire nous-m√™mes?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client SQL asynchrone</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons cr√©√© Deferred, fait tout le travail avec les sockets, not√© les donn√©es et renvoy√© Promise - tout est simple.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    socket_write($socket, $data, strlen($data));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons Promise, nous pouvons par exemple:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finissez le rappel et obtenez ceux </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui nous reviennent </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g√©rer l'erreur, ajouter au journal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relancez la requ√™te si le serveur SQL r√©pond avec une erreur.</font></font></li>
</ul><br>
<pre><code class="php hljs">$promise = <span class="hljs-keyword">$this</span>-&gt;execAsync($sql, $user-&gt;data());<font></font>
<font></font>
$promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">int</span> $rows</span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Affected rows: {$rows}"</span>;<font></font>
});<font></font>
<font></font>
$promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>) </span>{<font></font>
    log($error-&gt;getMessage());<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question demeure: nous avons d√©fini le rappel, et qui appellera </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boucle d'√©v√©nement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a le concept de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boucle d'√©v√©nement - une boucle d'√©v√©nement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il est capable de traiter des messages dans un environnement asynchrone. </font><font style="vertical-align: inherit;">Pour les E / S asynchrones, ce seront des messages du syst√®me d'exploitation que le socket est pr√™t √† lire ou √† √©crire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment √ßa fonctionne.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le client indique √† Event Loop qu'il est int√©ress√© par une sorte de socket.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La boucle d'√©v√©nements interroge le syst√®me d'exploitation via un appel syst√®me </font></font><code>stream_select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: le socket est-il pr√™t, toutes les donn√©es sont-elles √©crites, les donn√©es proviennent-elles de l'autre c√¥t√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le syst√®me d'exploitation signale que le socket n'est pas pr√™t, bloqu√©, alors la boucle d'√©v√©nement r√©p√®te la boucle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque le syst√®me d'exploitation notifie que le socket est pr√™t, la boucle d'√©v√©nements renvoie le contr√¥le au client et active ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Promise.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ln/ey/bb/lneybbz-tylmfanfoizqm2hscik.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous exprimons ce concept dans le code: prenez le cas le plus simple, supprimez la gestion des erreurs et d'autres nuances, de sorte qu'il reste une boucle infinie. </font><font style="vertical-align: inherit;">√Ä chaque it√©ration, il interrogera le syst√®me d'exploitation sur les sockets qui sont pr√™tes √† lire ou √† √©crire, et appellera un rappel pour une socket sp√©cifique.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<font></font>
        stream_select($readSockets, $writeSockets, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">foreach</span> ($readSockets <span class="hljs-keyword">as</span> $i =&gt; $socket) {<font></font>
            call_user_func(<span class="hljs-built_in">self</span>::readCallbacks[$i], $socket);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">// Do same for write sockets</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous compl√©tons notre client SQL. </font><font style="vertical-align: inherit;">Nous informons Event Loop que d√®s que les donn√©es du serveur SQL arrivent sur le socket avec lequel nous travaillons, nous devons mettre Deferred √† l'√©tat ¬´termin√©¬ª et transf√©rer les donn√©es du socket vers Promise.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
    ...<font></font>
    Loop::onReadable($socket, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$socket</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$deferred</span>) </span>{<font></font>
        $deferred-&gt;resolve(socket_read($socket));<font></font>
    });<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La boucle d'√©v√©nements </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut g√©rer nos E / S</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctionne avec des sockets</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Que peut-il faire d'autre?</font></font><br>
<br>
<ul>
<li> JavaScript   <code>setTimeout</code>  <code>setInterval</code> ‚Äî .             N . <strong>Event Loop      </strong>.</li>
<li>Event Loop  <strong>   </strong>.    <code>process control</code>,       .</li>
</ul><br>
<h3> Event Loop</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©criture de votre boucle d'√©v√©nement est non seulement possible, mais √©galement n√©cessaire. Si vous souhaitez travailler avec PHP asynchrone, il est important d'√©crire votre propre impl√©mentation simple pour comprendre comment cela fonctionne. Mais en production, nous ne l'utiliserons bien s√ªr pas, mais nous prendrons des impl√©mentations toutes faites: stables, sans erreur et √©prouv√©es au travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe trois impl√©mentations principales. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le plus ancien projet, a commenc√© en PHP 5.3. Maintenant, la version minimale requise de PHP est 5.3.8. Le projet impl√©mente la norme </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promises / A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du monde JavaScript. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . C'est cette impl√©mentation que je pr√©f√®re utiliser. La configuration minimale requise est PHP 7.0, et puisque la prochaine version est d√©j√† 7.3. Il utilise des coroutines en plus de Promise. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il s'agit d'un cadre chinois int√©ressant dans lequel les d√©veloppeurs tentent de porter certains concepts du monde Go vers PHP. </font><font style="vertical-align: inherit;">La documentation en anglais est incompl√®te, la plupart sur GitHub en chinois. </font><font style="vertical-align: inherit;">Si vous connaissez la langue, allez-y, mais jusqu'√† pr√©sent, j'ai peur de travailler.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/n3/cq/zon3cqtbmsf-vnd0uliqqupphoo.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons √† quoi ressemblera le client en utilisant ReactPHP pour MySQL.</font></font><br>
<br>
<pre><code class="php hljs">$connection = (<span class="hljs-keyword">new</span> ConnectionFactory)-&gt;createLazyConnection();<font></font>
<font></font>
$promise = $connection-&gt;query(<span class="hljs-string">'UPDATE users SET ...'</span>);<font></font>
$promise-&gt;then(<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est presque le m√™me que nous avons √©crit: nous cr√©ons </font></font><code>onnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ex√©cutons la demande. </font><font style="vertical-align: inherit;">Nous pouvons d√©finir le rappel pour traiter les r√©sultats (retour </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et rappel pour la gestion des erreurs:</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä partir de ces rappels, vous pouvez cr√©er des cha√Ænes longues-longues, car chaque r√©sultat </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans ReactPHP renvoie √©galement Promise.</font></font><br>
<br>
<pre><code class="php hljs">$promise<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise(...);<font></font>
    })<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{<font></font>
        ...<font></font>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) </span>{<font></font>
        log($error);<font></font>
    })<font></font>
    ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une solution √† un probl√®me appel√© enfer de rappel. </font><font style="vertical-align: inherit;">Malheureusement, dans l'impl√©mentation de ReactPHP, cela conduit au probl√®me ¬´Promise hell¬ª, lorsque des </font><strong><font style="vertical-align: inherit;">rappels 10-11 sont </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√©cessaires pour connecter correctement RabbitMQ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il est difficile de travailler avec un tel code et de le corriger. </font><font style="vertical-align: inherit;">J'ai rapidement r√©alis√© que ce n'√©tait pas le mien et je suis pass√© √† AMPHP.</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amphp</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce projet est plus jeune que ReactPHP et promeut un concept diff√©rent - les </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coroutines</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si vous envisagez de travailler avec MySQL dans AMPHP, vous pouvez voir que c'est presque la m√™me chose que de travailler avec </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP.</font></font><br>
<br>
<pre><code class="php hljs">$pool = Mysql\pool(<span class="hljs-string">"host=127.0.0.1 port=3306 db=test"</span>);<font></font>
<font></font>
<span class="hljs-keyword">try</span> {<font></font>
    $result = <span class="hljs-keyword">yield</span> $pool-&gt;query(<span class="hljs-string">"UPDATE users SET ..."</span>);<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> $result-&gt;affectedRows . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
} <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $error) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous cr√©ons un pool, connectons et ex√©cutons la demande. </font><font style="vertical-align: inherit;">Nous pouvons g√©rer les erreurs via les erreurs habituelles </font></font><code>try...catch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous n'avons pas besoin de rappels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avant l'appel asynchrone, le mot-cl√© - appara√Æt ici </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rateurs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mot </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">cl√© </font><font style="vertical-align: inherit;">transforme notre fonction en g√©n√©rateur.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generator</span>(<span class="hljs-params">$counter = <span class="hljs-number">1</span></span>)
</span>{
    <span class="hljs-keyword">yield</span> $counter++;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"A"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $counter;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"B"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> ++$counter;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s que l'interpr√©teur PHP rencontre des </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctions dans le corps, il se rend compte qu'il s'agit d'une fonction de g√©n√©rateur. </font><font style="vertical-align: inherit;">Au lieu de s'ex√©cuter, un objet classe est cr√©√© lors de son appel </font></font><code>Generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les g√©n√©rateurs h√©ritent de l'interface de l'it√©rateur.</font></font><br>
<br>
<pre><code class="php hljs">$generator = <span class="hljs-built_in">generator</span>(<span class="hljs-number">1</span>);<font></font>
<font></font>
<span class="hljs-keyword">foreach</span> ($generator <span class="hljs-keyword">as</span> $value) {
    <span class="hljs-keyword">echo</span> $value;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span> ($generator-&gt;valid()) {
    <span class="hljs-keyword">echo</span> $generator-&gt;current();<font></font>
<font></font>
    $generator-&gt;next();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, il est possible d'ex√©cuter des </font><font style="vertical-align: inherit;">cycles </font></font><code>foreach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>while</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et d' </font><font style="vertical-align: inherit;">autres. </font><font style="vertical-align: inherit;">Mais, plus int√©ressant, l'it√©rateur a des m√©thodes </font></font><code>current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>next</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Passons-les en revue √©tape par √©tape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez notre fonction </font></font><code>generator($counter = 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous appelons la m√©thode du g√©n√©rateur </font></font><code>current()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La valeur de la variable sera retourn√©e </font></font><code>$counter++</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s que nous ex√©cutons le g√©n√©rateur </font></font><code>next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le code ira au prochain appel √† l'int√©rieur du g√©n√©rateur </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'ensemble du code entre les deux </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'ex√©cutera, et c'est cool. </font><font style="vertical-align: inherit;">En continuant de faire tourner le g√©n√©rateur, nous obtenons le r√©sultat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le g√©n√©rateur a une fonction plus int√©ressante - nous pouvons envoyer des donn√©es au g√©n√©rateur de l'ext√©rieur. </font><font style="vertical-align: inherit;">Dans ce cas, ce n'est pas tout √† fait un g√©n√©rateur, mais une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coroutine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou une coroutine.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{  
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {     
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;       <font></font>
    }                             <font></font>
}                                <font></font>
<font></font>
$print = printer();<font></font>
$print-&gt;send(<span class="hljs-string">'Hello'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' PHPRussia'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' 2019'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">'!'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette section du code, il est int√©ressant de noter qu'il </font></font><code>while (true)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne bloquera pas le flux d'ex√©cution, mais sera ex√©cut√© une seule fois. </font><font style="vertical-align: inherit;">Nous avons envoy√© les donn√©es √† Corutin et les avons re√ßues </font></font><code>'Hello'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Envoy√© plus - re√ßu </font></font><code>'PHPRussia'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le principe est clair. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus d'envoyer des donn√©es au g√©n√©rateur, vous pouvez envoyer des erreurs et les traiter de l'int√©rieur, ce qui est pratique.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;<font></font>
    } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $e) {
        <span class="hljs-keyword">echo</span> $e-&gt;getMessage();<font></font>
    }<font></font>
}<font></font>
<font></font>
printer()-&gt;throw(<span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Ooops...'</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©sumer. </font><font style="vertical-align: inherit;">Corutin est un composant d'un programme qui </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prend en charge l'arr√™t et la poursuite de l'ex√©cution tout en maintenant l'√©tat actuel</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Corutin se souvient de sa pile d'appels, des donn√©es qu'il contient et peut les utiliser √† l'avenir.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rateurs et promesse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le g√©n√©rateur et les interfaces Promise.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throw</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils se ressemblent, √† l'exception des noms de m√©thode diff√©rents. </font><font style="vertical-align: inherit;">Nous pouvons envoyer des donn√©es et envoyer une erreur au g√©n√©rateur et √† Promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment cela peut-il √™tre utilis√©? </font><font style="vertical-align: inherit;">√âcrivons une fonction.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recoil</span>(<span class="hljs-params">\<span class="hljs-built_in">Generator</span> $generator</span>)
</span>{<font></font>
    $promise = $generator-&gt;current();<font></font>
<font></font>
    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };<font></font>
<font></font>
    $promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;throw($error);<font></font>
        recoil($generator);<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction prend la valeur de </font><font style="vertical-align: inherit;">courant du g√©n√©rateur: </font></font><code> $promise = $generator-&gt;current();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai un peu exag√©r√©. </font><font style="vertical-align: inherit;">Oui, nous devons v√©rifier que la valeur actuelle qui nous est retourn√©e est une sorte de </font></font><code>instanceof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promesse. </font><font style="vertical-align: inherit;">Si oui, alors nous pouvons lui demander un rappel. </font><font style="vertical-align: inherit;">Il renvoie en interne les donn√©es au g√©n√©rateur lorsque Promise r√©ussit et d√©marre r√©cursivement la fonction </font></font><code>recoil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="php hljs">    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√™me chose peut √™tre faite avec des erreurs. </font><font style="vertical-align: inherit;">Si Promise a √©chou√©, par exemple, le serveur SQL a dit: ¬´Trop de connexions¬ª, alors nous pouvons jeter l'erreur √† l'int√©rieur du g√©n√©rateur et passer √† l'√©tape suivante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela nous am√®ne au concept important du multit√¢che coop√©ratif.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multit√¢che coop√©ratif</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un type de multit√¢che, dans lequel la t√¢che suivante n'est effectu√©e qu'apr√®s que la t√¢che en cours se d√©clare explicitement pr√™te √† donner du temps processeur √† d'autres t√¢ches. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je rencontre rarement quelque chose de simple, comme travailler avec une seule base de donn√©es. Le plus souvent, dans le processus de mise √† jour de l'utilisateur, vous devez mettre √† jour les donn√©es dans la base de donn√©es, dans l'index de recherche, puis nettoyer ou mettre √† jour le cache, puis envoyer 15 messages suppl√©mentaires √† RabbitMQ. En PHP, tout ressemble √† √ßa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m6/w7/5n/m6w75nkbjrduxzynamn9qiinfwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous effectuons les op√©rations une par une: nous avons mis √† jour la base de donn√©es, l'index, puis le cache. Mais par d√©faut, PHP bloque de telles op√©rations (E / S), donc si vous regardez attentivement, en fait, tout est ainsi. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wk/3d/wc/wk3dwckb_gjjfnoprw63gxnoxlm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les parties sombres, nous avons bloqu√©. Ils prennent le plus de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous travaillons en mode asynchrone, alors ces parties ne sont pas l√†, la chronologie d'ex√©cution est intermittente.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/mx/xv/qjmxxv9oiwkix-_oebyl48qbio4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez tout coller ensemble et faire des pi√®ces une par une. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t0/o0/x5/t0o0x5ddiw6pij4rlmvzst2oyaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä quoi tout cela sert-il? </font><font style="vertical-align: inherit;">Si vous regardez la taille de la chronologie, au d√©but, cela prend beaucoup de temps, mais d√®s que nous la collons ensemble, l'application acc√©l√®re. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le concept m√™me de boucle d'√©v√©nement et de multit√¢che coop√©ratif a longtemps √©t√© utilis√© dans diverses applications: Nginx, Node.js, Memcached, Redis. </font><font style="vertical-align: inherit;">Tous utilisent l'int√©rieur de la boucle d'√©v√©nements et sont construits sur le m√™me principe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis que nous avons commenc√© √† parler des serveurs Web Nginx et Node.js, rappelons comment se d√©roule le traitement des requ√™tes en PHP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traitement des demandes en PHP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le navigateur envoie une requ√™te, il arrive au serveur HTTP derri√®re lequel se trouve un pool de flux FPM. </font><font style="vertical-align: inherit;">L'un des threads met cette requ√™te en service, connecte notre code et commence √† l'ex√©cuter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/s1/p_/bgs1p_g8r9ytthxrst0mszi7_bw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la prochaine demande arrive, un autre thread FPM le r√©cup√©rera, connectera le code et il sera ex√©cut√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sch√©ma de travail pr√©sente des </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avantages</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion simple des erreurs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si quelque chose a mal tourn√© et qu'une des demandes est tomb√©e, nous n'avons rien √† faire - la prochaine viendra, et cela n'affectera pas son travail.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous ne pensons pas √† la m√©moire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous n'avons pas besoin de nettoyer ou de surveiller la m√©moire. </font><font style="vertical-align: inherit;">√Ä la prochaine demande, toute la m√©moire sera effac√©e.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est un sch√©ma sympa qui a fonctionn√© en PHP depuis le tout d√©but et qui fonctionne toujours avec succ√®s. </font><font style="vertical-align: inherit;">Mais il y a aussi des </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inconv√©nients</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limitez le nombre de processus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si nous avons 50 threads FPM sur le serveur, d√®s que la 51e requ√™te arrive, il attendra que l'un des threads devienne libre.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Co√ªts pour le changement de contexte</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le syst√®me d'exploitation bascule les demandes entre les flux FPM. </font><font style="vertical-align: inherit;">Cette op√©ration au niveau du processeur est appel√©e Context Switch. </font><font style="vertical-align: inherit;">Il co√ªte cher et ex√©cute un grand nombre de mesures. </font><font style="vertical-align: inherit;">Il faut sauvegarder tous les registres, la pile d'appels, tout ce qui se trouve dans le processeur, puis passer √† un autre processus, charger ses registres et sa pile d'appels, y refaire quelque chose, basculer √† nouveau, sauvegarder encore ... Longtemps.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abordons la question diff√©remment - nous √©crirons un serveur HTTP en PHP lui-m√™me.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur HTTP asynchrone</font></font></h2><br>
<img src="https://habrastorage.org/webt/nd/dy/yt/nddyyt6dhjy0dxnkmpokppvvcr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa peut √™tre fait. </font><font style="vertical-align: inherit;">Nous avons d√©j√† appris √† travailler avec des sockets en mode non bloquant, et une connexion HTTP est la m√™me socket. </font><font style="vertical-align: inherit;">√Ä quoi ressemblera-t-il et fonctionnera-t-il? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci est un exemple de d√©marrage de serveurs HTTP dans le cadre AMPHP.</font></font><br>
<br>
<pre><code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<font></font>
    $app = <span class="hljs-keyword">new</span> Application();<font></font>
    $app-&gt;bootstrap();<font></font>
<font></font>
    $sockets = [Socket\listen(<span class="hljs-string">'0.0.0.0:80'</span>)];<font></font>
<font></font>
    $server = <span class="hljs-keyword">new</span> Server($sockets, <span class="hljs-keyword">new</span> CallableRequestHandler(
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Request $request</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$app</span>) </span>{<font></font>
            $response = <span class="hljs-keyword">yield</span> $app-&gt;dispatch($request);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response(Status::OK, [], $response);<font></font>
        })<font></font>
    );<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $server-&gt;start();<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est assez simple: charger </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et cr√©er un pool de sockets (un ou plusieurs). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous d√©marrons notre serveur, le configurons </font></font><code>Handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui sera ex√©cut√© √† chaque demande et envoyons la demande √† la n√¥tre </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin d'obtenir une r√©ponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La derni√®re chose √† faire est de d√©marrer le serveur </font></font><code>yield $server-&gt;start();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ReactPHP, il aura √† peu pr√®s la m√™me apparence, mais il n'y aura que 150 rappels pour diff√©rentes options, ce qui n'est pas tr√®s pratique.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probl√®mes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a plusieurs probl√®mes avec l'asynchronie en PHP. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manque de normes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Chaque framework: Swoole, ReactPHP ou AMPHP, impl√©mente sa propre interface Promise et ils sont incompatibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMPHP pourrait th√©oriquement interagir avec Promise de ReactPHP, mais il y a une mise en garde. Si le code de ReactPHP n'est pas tr√®s bien √©crit, et quelque part appelle ou cr√©e implicitement une boucle d'√©v√©nement, il s'av√®re que deux boucles d'√©v√©nement tourneront √† l'int√©rieur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScript a une norme Promises / A + relativement bonne qui impl√©mente Guzzle. Ce serait bien si les frameworks le suivaient. Mais jusqu'√† pr√©sent, ce n'est pas le cas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuites de m√©moire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lorsque nous travaillons en PHP dans le mode FPM habituel, nous ne pensons peut-√™tre pas √† la m√©moire. M√™me si les d√©veloppeurs d'une extension ont oubli√© d'√©crire du bon code, ont oubli√© d'ex√©cuter Valgrind et quelque part √† l'int√©rieur de la m√©moire, alors √ßa va - la prochaine demande sera effac√©e et recommencera. Mais en mode asynchrone, vous ne pouvez pas vous le permettre, car t√¥t ou tard, nous tomberons simplement </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est possible de r√©parer, mais c'est difficile et douloureux. Dans certains cas, Xdebug aide, dans d'autres, √† analyser les erreurs qui ont caus√© </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√©rations de blocage</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il est essentiel de ne pas bloquer la boucle d'√©v√©nements lorsque nous √©crivons du code asynchrone. L'application ralentit d√®s que nous bloquons le flux d'ex√©cution, chacune de nos coroutines commence √† s'ex√©cuter plus lentement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquetage kelunik / loop-block</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aidera √† trouver de telles op√©rations pour AMPHP </font><font style="vertical-align: inherit;">. Il r√®gle la minuterie sur un tr√®s petit intervalle. Si la minuterie ne fonctionne pas, nous sommes bloqu√©s quelque part. Le package aide √† trouver des emplacements de blocage, mais pas toujours: le blocage dans certaines extensions peut ne pas √™tre remarqu√©. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge de la biblioth√®que: Cassandra, Influx, ClickHouse</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le principal probl√®me de tout PHP asynchrone est le support des biblioth√®ques. Nous ne pouvons pas utiliser les habituels </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, les </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pilotes d' </font><font style="vertical-align: inherit;">autres pour </font><font style="vertical-align: inherit;">tout le </font><font style="vertical-align: inherit;">monde </font><font style="vertical-align: inherit;">- nous avons besoin d' </font><font style="vertical-align: inherit;">impl√©mentations non-bloquant. Ils doivent √©galement √™tre √©crits en PHP en mode non bloquant, car les pilotes C fournissent rarement des interfaces pouvant √™tre int√©gr√©es dans du code asynchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exp√©rience la plus √©trange que j'ai eue avec le pilote de la base de donn√©es Cassandra. Ils fournissent des op√©rations</font></font><code>ExecuteAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>GetAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et d'autres, mais en m√™me temps, ils retournent un objet </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une seule m√©thode </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui bloque. </font><font style="vertical-align: inherit;">Il est possible d'obtenir quelque chose de mani√®re asynchrone, mais pour attendre le r√©sultat, nous bloquerons toujours toute notre boucle. </font><font style="vertical-align: inherit;">Pour le faire diff√©remment, par exemple, par le biais de rappels, cela ne fonctionne pas. </font><font style="vertical-align: inherit;">J'ai m√™me √©crit mon client pour Cassandra, car nous l'utilisons dans notre travail. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indication de type</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">C'est un probl√®me d'AMPHP et de corutine.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): \<span class="hljs-title">Generator</span>
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il se produit dans une fonction </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il devient alors un g√©n√©rateur. </font><font style="vertical-align: inherit;">√Ä ce stade, nous ne pouvons plus sp√©cifier les types de donn√©es de retour corrects.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP 8</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce qui nous attend en PHP 8? </font><font style="vertical-align: inherit;">Je vais vous parler de mes hypoth√®ses ou plut√¥t de mes envies ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDLR: Dmitry Stogov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sait</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce qui va r√©ellement appara√Ætre en PHP 8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boucle d'√©v√©nement </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a une chance qu'il apparaisse, car des travaux sont en cours pour apporter une boucle d'√©v√©nement sous une forme quelconque au noyau. </font><font style="vertical-align: inherit;">Si cela se produit, nous aurons une fonction </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comme en JavaScript ou C #, qui nous permettra d'attendre le r√©sultat de l'op√©ration asynchrone √† un certain endroit. </font><font style="vertical-align: inherit;">Dans ce cas, nous n'aurons pas besoin d'extensions, tout fonctionnera de mani√®re asynchrone au niveau du noyau.</font></font><br>
<br>
<pre><code class="php hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = await <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©riques </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go attend les g√©n√©riques, nous attendons les g√©n√©riques, tout le monde attend les g√©n√©riques.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous n'attendons pas Generics pour les collections, mais pour indiquer que le r√©sultat de Promise sera exactement l'objet User.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi tout √ßa?</font></font></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la vitesse et les performances.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP est un langage dans lequel la plupart des op√©rations sont li√©es aux E / S. </font><font style="vertical-align: inherit;">Nous √©crivons rarement du code qui est significativement li√© aux calculs dans le processeur. </font><font style="vertical-align: inherit;">Tr√®s probablement, nous travaillons avec des sockets: nous devons faire une demande √† la base de donn√©es, lire quelque chose, retourner une r√©ponse, envoyer un fichier. </font><font style="vertical-align: inherit;">L'asynchronie vous permet d'acc√©l√©rer un tel code. </font><font style="vertical-align: inherit;">Si nous regardons le temps de r√©ponse moyen pour 1 000 demandes, nous pouvons acc√©l√©rer d'environ 8 fois et de 10 000 demandes de pr√®s de 6!</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le 13 mai 2020, nous nous r√©unirons pour la deuxi√®me fois √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour discuter du langage, des biblioth√®ques et des cadres, des fa√ßons d'augmenter la productivit√© et des pi√®ges des solutions de battage m√©diatique. </font><font style="vertical-align: inherit;">Nous avons accept√© les 4 premiers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapports</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais l'appel √† communications arrive toujours. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postulez</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si vous souhaitez partager votre exp√©rience avec la communaut√©.</font></font></blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr487258/">https://habr.com/ru/post/fr487258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487246/index.html">L'autorit√© de certification Tensor peut compromettre les cl√©s priv√©es des clients</a></li>
<li><a href="../fr487248/index.html">Un peu plus sur les tests incorrects</a></li>
<li><a href="../fr487250/index.html">M√©lange Alpha retard√©</a></li>
<li><a href="../fr487254/index.html">Comment utiliser les cam√©ras de vid√©osurveillance non seulement pour surveiller les intrus</a></li>
<li><a href="../fr487256/index.html">Br√ªlez et revenez des cendres ou des Phoenix</a></li>
<li><a href="../fr487260/index.html">NoVerify: un linter PHP qui fonctionne rapidement</a></li>
<li><a href="../fr487262/index.html">Conf√©rence ouverte PHP Russia Online</a></li>
<li><a href="../fr487266/index.html">GitLab 12.7 publi√© avec les pipelines Parent-Child et la version b√™ta des gestionnaires de travaux courants pour Windows</a></li>
<li><a href="../fr487270/index.html">Les p√©rovskites peuvent prolonger la dur√©e de vie des √©crans de gadgets</a></li>
<li><a href="../fr487272/index.html">Signets - le d√©compte est termin√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>