<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≥ üëÇüèº üçÑ Kubernetes ConfigMaps: nuances a conhecer ü§® üå∫ üß£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota : este n√£o √© um artigo de guia completo, mas um lembrete / dica para quem j√° usa o ConfigMap no Kubernetes ou est√° apenas preparando seu aplicati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: nuances a conhecer</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : este n√£o √© um artigo de guia completo, mas um lembrete / dica para quem j√° usa o ConfigMap no Kubernetes ou est√° apenas preparando seu aplicativo para trabalhar nele.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hist√≥rico: do rsync ao ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que aconteceu antes? Na era da ‚Äúadministra√ß√£o cl√°ssica‚Äù, na vers√£o mais simples, o arquivo de configura√ß√£o foi colocado ao lado dos aplicativos (ou no reposit√≥rio, se voc√™ preferir). √â simples: fazemos entrega elementar (CD) para o nosso c√≥digo junto com a configura√ß√£o. Mesmo uma implementa√ß√£o condicional de rsync pode ser chamada de rudimentos de um CD.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a infraestrutura cresceu, diferentes configura√ß√µes foram necess√°rias para diferentes ambientes (dev / stage / production). O aplicativo foi treinado para entender qual configura√ß√£o usar, passando-os como argumentos para iniciar ou vari√°veis ‚Äã‚Äãde ambiente definidas no ambiente. Um CD ainda mais complicado √© o advento de um Chef / Marionete / Ansible t√£o √∫til. As fun√ß√µes aparecem nos servidores e os ambientes deixam de ser descritos em lugares diferentes - chegamos ao IaC (Infraestrutura como c√≥digo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que se seguiu? Se fosse poss√≠vel ver as vantagens cr√≠ticas do Kubernetes e chegar a um acordo com a necessidade de modificar aplicativos para funcionarem nesse ambiente, ocorreu a migra√ß√£o. No caminho, esperava muitas nuances e diferen√ßas na constru√ß√£o da arquitetura, mas quando consegui lidar com a parte principal, consegui o t√£o esperado aplicativo em execu√ß√£o no K8s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vez aqui, ainda podemos usar as configura√ß√µes preparadas no reposit√≥rio ao lado do aplicativo ou passando ENV para o cont√™iner. </font><font style="vertical-align: inherit;">No entanto, al√©m desses m√©todos, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m est√° dispon√≠vel </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Essa primitiva do K8s permite que voc√™ use modelos Go em configura√ß√µes, ou seja, </font><font style="vertical-align: inherit;">renderize-as como p√°ginas HTML e recarregue o aplicativo ao alterar a configura√ß√£o sem reiniciar. </font><font style="vertical-align: inherit;">Com o ConfigMaps, n√£o √© mais necess√°rio manter mais de 3 configura√ß√µes para diferentes ambientes e acompanhar a relev√¢ncia de cada uma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma introdu√ß√£o geral ao ConfigMaps pode ser encontrada, por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E neste artigo, focarei em alguns recursos do trabalho com eles.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps simples</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como eram as configura√ß√µes no Kubernetes? </font><font style="vertical-align: inherit;">O que eles obtiveram dos modelos em uso? </font><font style="vertical-align: inherit;">Por exemplo, aqui est√° um ConfigMap comum para um aplicativo implantado a partir de um gr√°fico Helm:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, os valores substitu√≠dos </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√£o retirados do arquivo </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por que exatamente de </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Como o mecanismo do modelo Go funciona? </font><font style="vertical-align: inherit;">J√° falamos sobre esses detalhes em mais detalhes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chamada </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuda a selecionar a linha necess√°ria no mapa:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, voc√™ pode pegar linhas espec√≠ficas e fragmentos inteiros da configura√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, o ConfigMap pode ser assim:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... e em </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o seguinte conte√∫do:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O envolvido aqui </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© o nome do ambiente. </font><font style="vertical-align: inherit;">Substituindo esse valor durante a implanta√ß√£o, √© poss√≠vel renderizar o ConfigMaps com conte√∫do diferente. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rio aqui porque </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorna uma lista, cujo primeiro elemento cont√©m o valor desejado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando h√° muitas configura√ß√µes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ConfigMap pode conter v√°rios arquivos de configura√ß√£o:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode at√© montar cada configura√ß√£o separadamente:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ou selecione todas as configura√ß√µes de uma s√≥ vez com o diret√≥rio:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ alterar a descri√ß√£o do recurso Deployment durante a implanta√ß√£o, o Kubernetes criar√° um novo ReplicaSet, diminuindo o antigo para 0 e aumentando o novo para o n√∫mero especificado de r√©plicas. </font><font style="vertical-align: inherit;">(Isso √© verdade para a estrat√©gia de implanta√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas a√ß√µes levar√£o √† recria√ß√£o do pod com uma nova descri√ß√£o. </font><font style="vertical-align: inherit;">Por exemplo: havia uma imagem </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas tornou-se - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">E n√£o importa o que exatamente mudamos na descri√ß√£o de nossa implanta√ß√£o: o principal √© que isso fez com que a replicaSet (e, como resultado, o pod) fosse recriada. </font><font style="vertical-align: inherit;">Nesse caso, a nova vers√£o do arquivo de configura√ß√£o na nova vers√£o do aplicativo √© montada automaticamente e n√£o haver√° problemas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resposta √† mudan√ßa do ConfigMap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em caso de altera√ß√µes no ConfigMap, quatro cen√°rios de eventos podem ser seguidos. </font><font style="vertical-align: inherit;">Considere-os:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap‚Äô,   Deployment,   pod  ,   ‚Äî        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod‚Äô   / pod‚Äô.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos analisar com mais detalhes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rio 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√∫nica</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corrigido configMap? </font><font style="vertical-align: inherit;">O aplicativo n√£o ser√° reiniciado. </font><font style="vertical-align: inherit;">No caso de montagem por, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o haver√° altera√ß√µes at√© que o pod seja reiniciado manualmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© simples: o Kubernetes monta nosso ConfigMap em um pod de uma vers√£o espec√≠fica do recurso. </font><font style="vertical-align: inherit;">Como √© montado </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, n√£o h√° mais "influ√™ncia" na configura√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rio 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© poss√≠vel atualizar o arquivo sem recriar o pod? </font><font style="vertical-align: inherit;">Ok, temos 6 r√©plicas em Implanta√ß√£o, para que possamos revezar manualmente fazendo tudo </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ent√£o, ao criar novos pods, eles "capturam" a nova vers√£o do ConfigMap.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rio 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cansado de executar essas opera√ß√µes manualmente? </font><font style="vertical-align: inherit;">Uma solu√ß√£o para esse problema √© descrita em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dicas e truques do Helm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash da configura√ß√£o da anota√ß√£o renderizada √© simplesmente gravado </font><font style="vertical-align: inherit;">no modelo pod ( </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As anota√ß√µes s√£o campos arbitr√°rios de valores-chave nos quais voc√™ pode armazenar seus valores. </font><font style="vertical-align: inherit;">Se voc√™ os registrar no modelo do </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pod futuro, esses campos cair√£o no ReplicaSet e no pr√≥prio pod. </font><font style="vertical-align: inherit;">O Kubernetes notar√° que o modelo do pod foi alterado (desde a configura√ß√£o do sha256) e ser√° iniciado </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no qual nada muda, exceto esta anota√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, salvamos a mesma vers√£o do aplicativo e da descri√ß√£o da Implanta√ß√£o e basicamente acionamos a recria√ß√£o do pod pela m√°quina - semelhante √† forma como far√≠amos manualmente </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas j√° "corretamente": automaticamente e com </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rio 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez o aplicativo j√° saiba como monitorar altera√ß√µes na configura√ß√£o e recarregar automaticamente? </font><font style="vertical-align: inherit;">Aqui est√° um recurso importante do ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Kubernetes, se a configura√ß√£o estiver montada </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ela n√£o ser√° atualizada at√© que o pod seja reiniciado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(consulte os tr√™s primeiros cen√°rios discutidos acima)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mas se voc√™ montar o ConfigMap como um diret√≥rio, sem </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dentro do cont√™iner, haver√° um diret√≥rio com uma configura√ß√£o atualizada sem reiniciar o pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem outros recursos que s√£o √∫teis para lembrar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um arquivo de configura√ß√£o atualizado dentro do cont√™iner √© atualizado com algum atraso. </font><font style="vertical-align: inherit;">Isso ocorre porque o arquivo n√£o est√° montado exatamente, mas o objeto Kubernetes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O arquivo dentro √© um link simb√≥lico. </font><font style="vertical-align: inherit;">Exemplo com </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o que acontecer√° sem </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quando montado pelo diret√≥rio?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atualize a configura√ß√£o (via deploy ou </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), aguarde 2 minutos (tempo de armazenamento em cache do apiserver) - e pronto:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe o carimbo de data / hora alterado no diret√≥rio criado pelo Kubernetes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alterar rastreamento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E finalmente - um exemplo simples de como voc√™ pode monitorar as altera√ß√µes na configura√ß√£o.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usaremos esse aplicativo Go</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... adicionando-o com essa configura√ß√£o:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se executado, o log ser√°:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora vamos instalar este aplicativo no Kubernetes, montando a configura√ß√£o do ConfigMap no pod, em vez do arquivo da imagem. </font><font style="vertical-align: inherit;">Um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemplo de gr√°fico Helm foi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> preparado no GitHub </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E mude apenas o ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atualize o gr√°fico Helm no cluster, por exemplo, assim:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que vai acontecer?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os aplicativos v1 e v2 n√£o s√£o reiniciados porque </font><font style="vertical-align: inherit;">para eles, nenhuma altera√ß√£o ocorreu na implanta√ß√£o - eles ainda recebem Alice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O aplicativo v3 foi reiniciado, releu a configura√ß√£o e cumprimentou Bob.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O aplicativo v4 n√£o foi reiniciado. </font><font style="vertical-align: inherit;">Como o ConfigMap √© montado como um diret√≥rio, foram notadas altera√ß√µes na configura√ß√£o e a configura√ß√£o foi alterada rapidamente, sem reiniciar o pod. </font><font style="vertical-align: inherit;">Sim, o aplicativo notou altera√ß√µes em nosso exemplo simples - veja a mensagem do evento de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ver como uma situa√ß√£o semelhante - rastreando as altera√ß√µes do ConfigMap - √© resolvida em um projeto mais adulto (e simplesmente "real"), </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m √© √∫til lembrar que tudo o que foi dito acima tamb√©m √© v√°lido para o Secret'ov no Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">): n√£o √© √† toa que eles s√£o t√£o semelhantes ao ConfigMap ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√¥nus! </font><font style="vertical-align: inherit;">Solu√ß√µes de Terceiros</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ est√° interessado no t√≥pico de rastreamento de altera√ß√µes nas configura√ß√µes, j√° existem utilit√°rios prontos para isso:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Envia uma solicita√ß√£o HTTP se o arquivo foi alterado. </font><font style="vertical-align: inherit;">O desenvolvedor tamb√©m planeja ensinar o SIGHUP a enviar, mas a falta de confirma√ß√µes a partir de outubro de 2019 deixa esses planos em quest√£o;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - monitora o ConfigMap / Secrets e executa a atualiza√ß√£o sem </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">interrup√ß√£o</font></a><font style="vertical-align: inherit;"> (como o autor o chama) nos recursos associados a eles.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ser√° conveniente iniciar esses aplicativos com um cont√™iner lateral para aplicativos existentes. </font><font style="vertical-align: inherit;">No entanto, se voc√™ conhece os recursos do Kubernetes / ConfigMap e configs para editar n√£o "ao vivo" (atrav√©s </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas apenas como parte da implanta√ß√£o ... os recursos desses utilit√°rios podem parecer sup√©rfluos, ou seja, </font><font style="vertical-align: inherit;">duplicar fun√ß√µes b√°sicas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o advento do ConfigMap no Kubernetes, as configura√ß√µes foram movidas para a pr√≥xima rodada de desenvolvimento: o uso de um mecanismo de modelo trouxe flexibilidade compar√°vel √† renderiza√ß√£o de p√°ginas HTML. </font><font style="vertical-align: inherit;">Felizmente, essas complica√ß√µes n√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">substitu√≠ram as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solu√ß√µes existentes, mas se tornaram seu </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complemento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, para administradores (ou melhor, at√© desenvolvedores) que consideram novos recursos redundantes, bons arquivos antigos ainda est√£o dispon√≠veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aqueles que j√° usam o ConfigMap'ami ou apenas os observam, o artigo fornece uma breve vis√£o geral de sua ess√™ncia e nuances de uso. </font><font style="vertical-align: inherit;">Se voc√™ tiver suas pr√≥prias dicas e truques sobre o assunto - ficarei feliz em ver nos coment√°rios.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia tamb√©m no nosso blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivos locais ao portar um aplicativo no Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   Kubernetes  Helm:    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498944/index.html">Telegrama, cachorro, ou como n√£o fazer espelhos</a></li>
<li><a href="../pt498948/index.html">Hora dos drag√µes. Auto-isolamento com quebra-cabe√ßas</a></li>
<li><a href="../pt498952/index.html">Convidamos o DINS JS EVENING: estamos falando sobre programa√ß√£o orientada a aspectos e a estrutura da API de composi√ß√£o do Vuejs 3</a></li>
<li><a href="../pt498958/index.html">O erro n√£o √© UIAlertController</a></li>
<li><a href="../pt498962/index.html">Sobre multitarefa: janelas sob controle</a></li>
<li><a href="../pt498974/index.html">Coronav√≠rus: uma perigosa ilus√£o de inseguran√ßa</a></li>
<li><a href="../pt498976/index.html">Apresentando o .NET 5.0 Preview 3</a></li>
<li><a href="../pt498978/index.html">Usando Graylog e NLog para coletar logs de aplicativos C #. Experi√™ncia pessoal</a></li>
<li><a href="../pt498982/index.html">Disquetes para Dreamcast</a></li>
<li><a href="../pt498984/index.html">Stealth School: 5 tipos de gadgets em jogos furtivos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>