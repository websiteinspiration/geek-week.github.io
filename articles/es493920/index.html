<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛒 🌍 〰️ Acerca de una vulnerabilidad en ... 🌈 🍌 🈹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace un año, 21 de marzo de 2019, en un programa de recompensas de errores Mail.ru en HackerOne llegó un muy buen informe de errores de maxarr . Al in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acerca de una vulnerabilidad en ...</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/493920/"><img src="https://habrastorage.org/webt/du/k3/h5/duk3h5leha8sz3qinzb3g_8yfsk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace un año, 21 de marzo de 2019, en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un programa de recompensas de errores Mail.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en HackerOne llegó un muy buen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informe de errores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxarr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Al incrustar un byte cero (ASCII 0) en el parámetro POST de una de las solicitudes de API de correo web que devolvió un redireccionamiento HTTP, se vieron fragmentos de memoria no inicializada en los datos de redireccionamiento, en los que fragmentos de parámetros GET y encabezados de otras solicitudes El mismo servidor.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una vulnerabilidad crítica porque Las solicitudes incluyen cookies de sesión. Unas horas más tarde, se realizó una corrección temporal, que filtró un byte cero (como resultó más tarde, esto no fue suficiente, porque existía la posibilidad de inyectar CRLF / ASCII 13, 10, que le permite manipular los encabezados y los datos de la respuesta HTTP, esto es menos crítico, pero sigue siendo desagradable) Al mismo tiempo, el problema se remitió a analistas de seguridad y desarrolladores para encontrar y eliminar las causas del error.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mail.ru mail es una aplicación muy complicada, una gran cantidad de componentes front-end / back-end diferentes, tanto de código abierto (muchas gracias a todos los desarrolladores de software libre) como de nuestro propio desarrollo, pueden participar en la respuesta. Fue posible excluir todos los componentes excepto nginx y openresty y localizar el problema antes de llamar a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ngx.req.set_uri ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un script OpenResty que no se comportó como se esperaba (pegue un byte cero o avance de línea a través de parámetros GET de reescribir a ngx_http_rewrite_module, que, según la documentación, se usa y, al parecer, debería funcionar absolutamente de la misma manera). Se eliminaron las posibles consecuencias, se agregó el filtrado más estricto y se verificó que el filtrado elimina todos los vectores posibles. Pero el mecanismo que condujo a la pérdida de contenido de la memoria siguió siendo un misterio. Un mes después, el informe de error se cerró según lo autorizado, y el análisis de las causas del error se pospuso hasta tiempos mejores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty es un complemento muy popular que le permite escribir scripts Lua dentro de nginx, y se usa en varios proyectos de Mail.ru, por lo que el problema no se consideró resuelto. Y después de un tiempo, sin embargo, volvieron a ella para comprender las verdaderas causas, las posibles consecuencias y hacer recomendaciones para los desarrolladores. El código fuente fue excavado por </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Denis Denisov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nikolai Ermishkin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Resultó que:</font></font><br>
<br>
<ul>
<li> nginx   rewrite      directory traversal (  SSRF)   ,    ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nginx Amplify</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gixy</a>   (,    , ).   OpenResty    ,      .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /rewrite</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-variable">$arg_x</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<br>
<code>curl localhost:8337/rewrite?x=/../../../../../../../etc/passwd<br>
root:x:0:0:root:/root:/bin/bash<br>
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br>
bin:x:2:2:bin:/bin:/usr/sbin/nologin<br>
...</code><br>
<br>
</li>
<li> nginx  ,     ,   rewrite   .    nginx    ,    ,       ,       ,       ,     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>.<br>
<br>
  (^@  )<br>
<pre><code class="nginx hljs">
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-string">"^<span class="hljs-variable">@asdfasdfasdfasdfasdfasdfasdfasdfasdfasdfasdasdf</span>"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<code>curl localhost:8337/secret -vv<br>
...<br>
curl localhost:8337/memleak -vv<br>
...<br>
Location: http://localhost:8337/secret<br>
...<br>
</code><br>
</li>
<li>Nginx  GET-          rewrite  GET-.         nginx  . POST     . OpenResty     GET   POST ,    POST   OpenResty     .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
        ngx.req.read_body();<font></font>
        <span class="hljs-attribute">local</span> args, err = ngx.req.get_post_args();<font></font>
        ngx.req.set_uri( args["url"], <span class="hljs-attribute">true</span> );<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}<font></font>
</code></pre><br>
<br>
:<br>
<br>
<code>curl localhost:8337 -d "url=secret" -vv<br>
...<br>
curl localhost:8337 -d "url=%00asdfasdfasdfasdfasdfasdfasdfasdf" -vv<br>
...<br>
Location: http://localhost:8337/{...  secret...}<br>
...<br>
</code><br>
</li>
</ul><br>
<h4> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema se informó a los desarrolladores de nginx y OpenResty, los desarrolladores no consideran el problema como un error de seguridad en nginx, porque en nginx en sí no hay forma de explotar el error mediante la inyección de caracteres especiales, la solución para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">revelar el contenido de la memoria</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se publicó el 16 de diciembre. En los 4 meses transcurridos desde el informe, no se realizaron cambios en OpenResty, aunque se entendió que se necesitaba una versión segura de la función ngx.req.set_uri (). El 18 de marzo de 2020, publicamos la información; el 21 de marzo, OpenResty lanzó la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versión 1.15.8.3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que agrega una verificación de URI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portswigger </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribió</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tomé un buen artículo de OpenResty y Nginx (aunque el comentario de que solo se revela un pequeño fragmento de memoria es incorrecto y engañoso, esto está determinado por la longitud de la línea que sigue al byte cero y, en ausencia de restricciones de longitud obvias, puede ser controlado por el atacante).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, ¿cuál fue el error y qué hacer para evitarlo?</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Hubo un error en nginx?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sí, lo fue, porque una pérdida de memoria es un error de todos modos. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Hubo un error en OpenResty?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sí, al menos el tema de la seguridad de la funcionalidad ofrecida por OpenResty no ha sido investigado ni documentado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Se ha cometido un error de configuración / uso de OpenResty?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sí, porque en ausencia de una indicación explícita, se hizo una suposición no verificada sobre la seguridad de la funcionalidad utilizada. </font></font><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cuál de estos errores es una vulnerabilidad de seguridad de recompensa de $ 10,000?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para nosotros, esto generalmente no es importante. </font><font style="vertical-align: inherit;">En cualquier software, especialmente en la unión de varios componentes, especialmente aquellos proporcionados por diferentes proyectos y desarrolladores, nadie puede garantizar que todas las características de su trabajo sean conocidas y documentadas y que no haya errores. </font><font style="vertical-align: inherit;">Por lo tanto, cualquier vulnerabilidad de seguridad surge exactamente donde afecta la seguridad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cualquier caso, es una buena práctica normalizar o limitar / filtrar los datos de entrada, que van a cualquier módulo / API externo, si no hay indicaciones explícitas y un claro entendimiento de que esto no es necesario.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errata</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acuerdo con la experiencia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del artículo anterior</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para preservar la pureza del lenguaje: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una recompensa de errores</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - concurso de búsqueda de errores </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informe de errores</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redirección de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> notificación de error </font><font style="vertical-align: inherit;">- redirección </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opensorsny</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - código abierto </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conocido como errata</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - trabajo en los errores</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es493898/index.html">"¿De dónde crecen las piernas" o qué precede a la programación?</a></li>
<li><a href="../es493904/index.html">Cómo perder la confianza en la inteligencia artificial o cómo intimidé con Gradient Photo Editor</a></li>
<li><a href="../es493906/index.html">Atajos tóxicos de Windows: un viejo artefacto no olvidado por los piratas informáticos, pero parcialmente olvidado por los forenses</a></li>
<li><a href="../es493914/index.html">Web2Text: extracción estructurada profunda del contenido de la página web</a></li>
<li><a href="../es493918/index.html">Cómo la pandemia afectó a los proveedores de VPN</a></li>
<li><a href="../es493922/index.html">Gafas de visión crepuscular. Android Camera2 API de Maker Part 5 Flash</a></li>
<li><a href="../es493924/index.html">¡Pare el transportador! Usted da proyectores Epson XGA al precio de SVGA</a></li>
<li><a href="../es493926/index.html">Trucos para probar aplicaciones web Laravel usando fábricas de modelos</a></li>
<li><a href="../es493928/index.html">Revisión y prueba de Huawei Dorado 5000V6</a></li>
<li><a href="../es493932/index.html">Descripción general de Google Surveys. Por qué no es adecuado para una investigación seria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>