<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‚ğŸ¼ âœŠğŸ» ğŸ½ Linuxç”¨ã®x86_64 ELFãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒƒã‚«ãƒ¼ã®ä½œæˆ ğŸ”º ğŸ’ˆ ğŸ‘²ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰æ›¸ã
 ã“ã®æŠ•ç¨¿ã§ã¯ã€Linux x86_64ç”¨ã®å˜ç´”ãªå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒƒã‚«ãƒ¼ã®ä½œæˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚èª­è€…ã¯ã€Cãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€x86_64ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã€ãŠã‚ˆã³ãƒ‡ãƒã‚¤ã‚¹ã®ELFãƒ•ã‚¡ã‚¤ãƒ«ã«ç²¾é€šã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«ã€è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå‰Šé™¤...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linuxç”¨ã®x86_64 ELFãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒƒã‚«ãƒ¼ã®ä½œæˆ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483368/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰æ›¸ã</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®æŠ•ç¨¿ã§ã¯ã€Linux x86_64ç”¨ã®å˜ç´”ãªå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒƒã‚«ãƒ¼ã®ä½œæˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">èª­è€…ã¯ã€Cãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€x86_64ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã€ãŠã‚ˆã³ãƒ‡ãƒã‚¤ã‚¹ã®ELFãƒ•ã‚¡ã‚¤ãƒ«ã«ç²¾é€šã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«ã€è¨˜äº‹ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå‰Šé™¤ã•ã‚Œã€ä¸€éƒ¨ã®é–¢æ•°ã®å®Ÿè£…ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚githubï¼ˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ­ãƒ¼ãƒ€ãƒ¼</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒƒã‚«ãƒ¼</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">ã¸ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¢ã‚¤ãƒ‡ã‚¢ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚ELFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒƒã‚«ãƒ¼ã«è»¢é€ã—ã€å‡ºåŠ›ã«æ¬¡ã®æ§‹é€ ã‚’æŒã¤æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td colspan="2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ELFãƒ˜ãƒƒãƒ€ãƒ¼</font></font></td>
</tr>
<tr>
<td colspan="2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«</font></font></td>
</tr>
<tr>
<td rowspan="3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">256ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿</font></font></td>
</tr>
</tbody></table></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ§ç¸®ã«ã¤ã„ã¦ã¯ã€æš—å·åŒ–ã®ãŸã‚ã«ãƒãƒ•ãƒãƒ³ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒæ±ºå®šã•ã‚Œã¾ã—ãŸ-256ãƒ“ãƒƒãƒˆã‚­ãƒ¼ã®AES-CTRã€ã¤ã¾ã‚Škokke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiny-AES-c</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‹ã‚‰ã®å®Ÿè£…</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«ã€256ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ã€ç–‘ä¼¼ä¹±æ•°ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦AESã‚­ãƒ¼ã¨åˆæœŸåŒ–ãƒ™ã‚¯ãƒˆãƒ«ã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) {<font></font>
    seed = (<span class="hljs-number">1103515245</span>*seed + <span class="hljs-number">12345</span>) % <span class="hljs-number">256</span>;<font></font>
    key[i] = buf[seed];<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®æ±ºå®šã¯ã€ãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚’è¤‡é›‘ã«ã—ãŸã„ã¨ã„ã†é¡˜æœ›ã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ä»Šæ—¥ã¾ã§ã€åˆä½µç—‡ã¯ã•ã•ã„ãªã“ã¨ã§ã‚ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸãŒã€æ™‚é–“ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è²»ã‚„ã—ãŸããªã‹ã£ãŸã®ã§ã€ãã‚Œã‚’å–ã‚Šé™¤ãã“ã¨ã‚’å§‹ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ­ãƒ¼ãƒ€</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãšã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å‹•ä½œã‚’æ¤œè¨ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ­ãƒ¼ãƒ€ãƒ¼ã«ã¯ä¾å­˜é–¢ä¿‚ãŒã‚ã£ã¦ã¯ãªã‚‰ãªã„ãŸã‚ã€æ¨™æº–Cãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å¿…è¦ãªã™ã¹ã¦ã®é–¢æ•°ã‚’å€‹åˆ¥ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã‚Œã‚‰ã®é–¢æ•°ã®å®Ÿè£…ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‚ç…§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«ã‚ˆã‚Šåˆ©ç”¨å¯èƒ½ã§ã™</font><font style="vertical-align: inherit;">ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€ä½ç½®çš„ã«ç‹¬ç«‹ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_Starté–¢æ•°</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¯_starté–¢æ•°ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ã“ã‚Œã¯å˜ã«argcã¨argvã‚’mainã«æ¸¡ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">.extern main<font></font>
.globl _start<font></font>
.text<font></font>
_start:<font></font>
    movq (%rsp), %rdi<font></font>
    movq %rsp, %rsi<font></font>
    addq $8, %rsi<font></font>
    call main<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸»ãªæ©Ÿèƒ½</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
main.cãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã„ãã¤ã‹ã®externå¤‰æ•°ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span>* loader_end;    <span class="hljs-comment">//    , .  </span>
                            <span class="hljs-comment">//  ELF .</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">size_t</span> payload_size; <span class="hljs-comment">//   ELF </span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">size_t</span> key_seed;     <span class="hljs-comment">//    </span>
                            <span class="hljs-comment">// -   .</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">size_t</span> iv_seed;      <span class="hljs-comment">//    </span>
                            <span class="hljs-comment">// -    </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‘ãƒƒã‚«ãƒ¼å†…ã®å¤‰æ•°ï¼ˆElf64_Symï¼‰ã«å¯¾å¿œã™ã‚‹æ–‡å­—ã®ä½ç½®ã‚’è¦‹ã¤ã‘ã€ãã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«ã€ãã‚Œã‚‰ã¯ã™ã¹ã¦externã¨ã—ã¦å®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ã‚¤ãƒ³é–¢æ•°è‡ªä½“ã¯éå¸¸ã«å˜ç´”ã§ã™ã€‚</font><font style="vertical-align: inherit;">æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ã€256ãƒã‚¤ãƒˆã®ãƒãƒƒãƒ•ã‚¡ãƒ¼ã€ãŠã‚ˆã³ã‚¹ã‚¿ãƒƒã‚¯ã®æœ€ä¸Šä½ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã«ã€ELFãƒ•ã‚¡ã‚¤ãƒ«ãŒå¾©å·åŒ–ã•ã‚Œã¦å±•é–‹ã•ã‚Œã€load_elfé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒ¢ãƒªã®é©åˆ‡ãªå ´æ‰€ã«é…ç½®ã•ã‚Œã¾ã™ã€‚æœ€å¾Œã«ã€rspãƒ¬ã‚¸ã‚¹ã‚¿ã®å€¤ãŒå…ƒã®çŠ¶æ…‹ã«æˆ»ã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SET_STACK(sp) __asm__ __volatile__ (<span class="hljs-meta-string">"movq %0, %%rsp"</span>::<span class="hljs-meta-string">"r"</span>(sp))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> JMP(addr) __asm__ __volatile__ (<span class="hljs-meta-string">"jmp *%0"</span>::<span class="hljs-meta-string">"r"</span>(addr))</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
    <span class="hljs-keyword">uint8_t</span> *payload = (<span class="hljs-keyword">uint8_t</span>*)&amp;loader_end; <span class="hljs-comment">//   </span>
                                              <span class="hljs-comment">// ELF </span>
    <span class="hljs-keyword">uint8_t</span> *entropy_buf = payload + payload_size; <span class="hljs-comment">//   256-</span>
                                                   <span class="hljs-comment">// </span>
    <span class="hljs-keyword">void</span> *rsp = argv<span class="hljs-number">-1</span>; <span class="hljs-comment">//    </span><font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AES_ctx</span> <span class="hljs-title">ctx</span>;</span>
    AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed); <span class="hljs-comment">//  AES</span>
    AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size);    <span class="hljs-comment">//  ELF</span>
    <span class="hljs-built_in">memset</span>(&amp;ctx, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ctx)); <span class="hljs-comment">//   AES</span><font></font>
<font></font>
    <span class="hljs-keyword">size_t</span> decoded_payload_size;
    <span class="hljs-comment">//  ELF</span>
    <span class="hljs-keyword">char</span> *decoded_payload = <font></font>
    huffman_decode((<span class="hljs-keyword">char</span>*)payload, payload_size, &amp;decoded_payload_size);<font></font>
<font></font>
    <span class="hljs-comment">//     ELF  ,</span>
    <span class="hljs-comment">//   ET_EXEC  NULL.</span>
    <span class="hljs-keyword">void</span> *load_addr = elf_load_addr(rsp, decoded_payload, decoded_payload_size);<font></font>
    load_addr = load_elf(load_addr, decoded_payload); <span class="hljs-comment">//  ELF  ,</span>
                                                      <span class="hljs-comment">//   </span>
                                                     <span class="hljs-comment">//  .</span>
    <span class="hljs-built_in">memset</span>(decoded_payload, <span class="hljs-number">0</span>, decoded_payload_size); <span class="hljs-comment">//   ELF</span>
    munmap(decoded_payload, decoded_payload_size); <span class="hljs-comment">//  </span>
                                                   <span class="hljs-comment">//   </span><font></font>
	<font></font>
    <span class="hljs-comment">//  ELF     AES</span><font></font>
    AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed);<font></font>
    AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size);<font></font>
    <span class="hljs-built_in">memset</span>(&amp;ctx, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ctx));<font></font>
<font></font>
    SET_STACK(rsp); <span class="hljs-comment">//   </span>
    JMP(load_addr); <span class="hljs-comment">//      </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AESãŠã‚ˆã³åœ§ç¸®è§£é™¤ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç›®çš„ã§è¡Œã‚ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚­ãƒ¼ã¨å¾©å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ä½¿ç”¨ä¸­ã®ã¿ãƒ¡ãƒ¢ãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ã„ãã¤ã‹ã®é–¢æ•°ã®å®Ÿè£…ã«ã¤ã„ã¦æ¤œè¨ã—ã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load_elf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§ã¯å½¼ã‹ã‚‰ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ bedigerã¨githubã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã“ã®é–¢æ•°ã‚’å–ã£ãŸ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">userlandexec</font></a><font style="vertical-align: inherit;">ãƒªãƒã‚¸ãƒˆãƒª</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…ƒã®é–¢æ•°ãŒã‚¿ã‚¤ãƒ—ET_DYNã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸãŸã‚ã€ãã‚Œã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã“ã®ã‚¨ãƒ©ãƒ¼ã¯ã€mmapã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®æœ€åˆã®å¼•æ•°ã®å€¤ãŒNULLã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®éå¸¸ã«è¿‘ãã«è¿”ã•ã‚ŒãŸãŸã‚ã€ãã®å¾Œã®mmapã®å‘¼ã³å‡ºã—ã¨ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã‚ˆã£ã¦è¿”ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ”ãƒ¼ä¸­ã«ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚³ãƒ¼ãƒ‰ãŒä¸Šæ›¸ãã•ã‚Œã€segfaultãŒç™ºç”Ÿã—ãŸãŸã‚ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãã®ãŸã‚ã€é–‹å§‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦load_elfé–¢æ•°ã«è¿½åŠ ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">é–¢æ•°è‡ªä½“ã¯ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€šéã—ã€ELFãƒ•ã‚¡ã‚¤ãƒ«ã®PT_LOADã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ãƒ¡ãƒ¢ãƒªã‚’å‰²ã‚Šå½“ã¦ï¼ˆãã®æ•°ã¯ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®å€æ•°ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ï¼‰ã€ãã®å†…å®¹ã‚’å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒ¡ãƒ¢ãƒªé ˜åŸŸã«ã‚³ãƒ”ãƒ¼ã—ã€å¯¾å¿œã™ã‚‹èª­ã¿å–ã‚Šã€æ›¸ãè¾¼ã¿ã€å®Ÿè¡Œæ¨©é™ã‚’ã“ã‚Œã‚‰ã®é ˜åŸŸã«è¨­å®šã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//     </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGEUP(x) (((unsigned long)x + 4095)&amp;(~4095))</span>
<span class="hljs-comment">//     </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGEDOWN(x) ((unsigned long)x&amp;(~4095))</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">load_elf</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *load_addr, <span class="hljs-keyword">void</span> *mapped)</span> </span>{<font></font>
    Elf64_Ehdr *ehdr = mapped;<font></font>
    Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff;<font></font>
    <span class="hljs-keyword">void</span> *text_segment = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> initial_vaddr = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> brk_addr = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; ehdr-&gt;e_phnum; i++, phdr++) {
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> rounded_len, k;
        <span class="hljs-keyword">void</span> *segment;<font></font>
<font></font>
        <span class="hljs-comment">//   PT_LOAD,   </span>
        <span class="hljs-keyword">if</span>(phdr-&gt;p_type != PT_LOAD)
            <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span>(text_segment != <span class="hljs-number">0</span> &amp;&amp; ehdr-&gt;e_type == ET_DYN) {
            <span class="hljs-comment">//  ET_DYN phdr-&gt;p_vaddr    ,</span>
            <span class="hljs-comment">//       </span>
            <span class="hljs-comment">//    ,     </span>
            <span class="hljs-comment">//    </span><font></font>
            load_addr = text_segment + phdr-&gt;p_vaddr - initial_vaddr;<font></font>
            load_addr = (<span class="hljs-keyword">void</span>*)PAGEDOWN(load_addr);<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ehdr-&gt;e_type == ET_EXEC) {
            <span class="hljs-comment">//  ET_EXEC phdr-&gt;p_vaddr    </span>
            load_addr = (<span class="hljs-keyword">void</span>*)PAGEDOWN(phdr-&gt;p_vaddr);<font></font>
        } <font></font>
<font></font>
        <span class="hljs-comment">//       </span>
        rounded_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % <span class="hljs-number">4096</span>);<font></font>
        rounded_len = PAGEUP(rounded_len);<font></font>
<font></font>
        <span class="hljs-comment">//       </span><font></font>
        segment = mmap(load_addr,<font></font>
                       rounded_len,<font></font>
                       PROT_WRITE,<font></font>
                       MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,<font></font>
                       <span class="hljs-number">-1</span>,
                        <span class="hljs-number">0</span>);<font></font>
<font></font>
        <span class="hljs-keyword">if</span>(ehdr-&gt;e_type == ET_EXEC)<font></font>
            load_addr = (<span class="hljs-keyword">void</span>*)phdr-&gt;p_vaddr;
        <span class="hljs-keyword">else</span>
            load_addr = segment + (phdr-&gt;p_vaddr % <span class="hljs-number">4096</span>);
        <span class="hljs-comment">//        </span>
        <span class="hljs-built_in">memcpy</span>(load_addr, mapped + phdr-&gt;p_offset, phdr-&gt;p_filesz);<font></font>
<font></font>
        <span class="hljs-keyword">if</span>(!text_segment) {<font></font>
            text_segment = segment;<font></font>
            initial_vaddr = phdr-&gt;p_vaddr;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> protflags = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span>(phdr-&gt;p_flags &amp; PF_R)<font></font>
            protflags |= PROT_READ;<font></font>
        <span class="hljs-keyword">if</span>(phdr-&gt;p_flags &amp; PF_W)<font></font>
            protflags |= PROT_WRITE;<font></font>
        <span class="hljs-keyword">if</span>(phdr-&gt;p_flags &amp; PF_X)<font></font>
            protflags |= PROT_EXEC;<font></font>
<font></font>
        mprotect(segment, rounded_len, protflags); <span class="hljs-comment">//   </span>
                                                   <span class="hljs-comment">// , , </span><font></font>
<font></font>
        k = phdr-&gt;p_vaddr + phdr-&gt;p_memsz;<font></font>
        <span class="hljs-keyword">if</span>(k &gt; brk_addr) brk_addr = k;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ehdr-&gt;e_type == ET_EXEC) {<font></font>
        brk(PAGEUP(brk_addr));<font></font>
        <span class="hljs-comment">//  ET_EXEC ehdr-&gt;e_entry    </span>
        load_addr = (<span class="hljs-keyword">void</span>*)ehdr-&gt;e_entry;<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//  ET_DYN ehdr-&gt;e_entry    ,</span>
        <span class="hljs-comment">//          </span>
        load_addr = (<span class="hljs-keyword">void</span>*)ehdr + ehdr-&gt;e_entry;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> load_addr; <span class="hljs-comment">//      </span><font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elf_load_addr</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ET_EXEC ELFãƒ•ã‚¡ã‚¤ãƒ«ç”¨ã®ã“ã®é–¢æ•°ã¯ã€ã“ã®ã‚¿ã‚¤ãƒ—ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã‚Œã‚‰ã§æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€NULLã‚’è¿”ã—ã¾ã™ã€‚ ET_DYNãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆã¤ã¾ã‚Šã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ï¼‰ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ELFã‚’ãƒ¡ãƒ¢ãƒªã«é…ç½®ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ¡ãƒ¢ãƒªã®é‡ã€ãŠã‚ˆã³4096ã€4096-ELFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã™ãéš£ã«é…ç½®ã—ãªã„ãŸã‚ã«å¿…è¦ãªã‚®ãƒ£ãƒƒãƒ—ã®å·®ã¨ç­‰ã—ã„ã§ã™ã€‚ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨ˆç®—ã—ãŸå¾Œã€ãƒ¡ãƒ¢ãƒªé ˜åŸŸãŒã€æŒ‡å®šã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ã€ã‚¢ãƒ³ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‹ã‚‰æœ€å¾Œã¾ã§ã®é ˜åŸŸã¨äº¤å·®ã™ã‚‹ã‹ã©ã†ã‹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚äº¤å·®ã™ã‚‹å ´åˆã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã‚¢ãƒ³ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸELFã®é–‹å§‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãã‚Œã‚’é…ç½®ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ¡ãƒ¢ãƒªé‡ã®å·®ã«ç­‰ã—ãè¿”ã•ã‚Œã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€ä»¥å‰ã«è¨ˆç®—ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¿”ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®ç’°å¢ƒå¤‰æ•°ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã®å¾Œã«ã‚ã‚‹è£œåŠ©ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆELFè£œåŠ©ãƒ™ã‚¯ãƒˆãƒ«ï¼‰ã‹ã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã—ã€ãã“ã‹ã‚‰ELFãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’å¼•ãã“ã¨ã§ã‚ã‹ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">                                          <font></font>
  ---------------------------------------------------------------------------<font></font>
     -&gt;  [ argc        ]                8<font></font>
                        [ argv[0]     ]                8<font></font>
                        [ argv[1]     ]                8<font></font>
                        [ argv[..]    ]                8 * x<font></font>
                        [ argv[n â€“ 1] ]                8<font></font>
                        [ argv[n]     ]                8   (= NULL)<font></font>
<font></font>
                        [ envp[0]    ]                 8<font></font>
                        [ envp[1]    ]                 8<font></font>
                        [ envp[..]   ]                 8<font></font>
                        [ envp[term] ]                 8   (= NULL)<font></font>
<font></font>
                        [ auxv[0] (Elf64_auxv_t)    ]  16<font></font>
                        [ auxv[1] (Elf64_auxv_t)    ]  16<font></font>
                        [ auxv[..] (Elf64_auxv_t)   ]  16<font></font>
                        [ auxv[term] (Elf64_auxv_t) ]  16  (= AT_NULL)<font></font>
<font></font>
                        [  ]               0 - 16<font></font>
<font></font>
                        [    ] &gt;= 0<font></font>
                        [   ]           &gt;= 0<font></font>
<font></font>
                        [   ]          8   (= NULL)<font></font>
<font></font>
                        &lt;    &gt;         0<font></font>
  ---------------------------------------------------------------------------<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è£œåŠ©ãƒ™ã‚¯ãƒˆãƒ«ã®å„è¦ç´ ãŒè¨˜è¿°ã•ã‚Œã‚‹æ§‹é€ ã¯ã€æ¬¡ã®å½¢å¼ã‚’æŒã£ã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-keyword">uint64_t</span> a_type; <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">uint64_t</span> a_val; <span class="hljs-comment">// </span><font></font>
    } a_un;<font></font>
} Elf64_auxv_t;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰åŠ¹ãªa_typeå€¤ã®1ã¤ã¯AT_PHDRã§ã‚ã‚Šã€a_valã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒ‡ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã¯ã€elf_load_addré–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">elf_base_addr</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *rsp)</span> </span>{
    <span class="hljs-keyword">void</span> *base_addr = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> argc = *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>*)rsp;
    <span class="hljs-keyword">char</span> **envp = rsp + (argc+<span class="hljs-number">2</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>); <span class="hljs-comment">//   </span>
                                                        <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">while</span>(*envp++); <span class="hljs-comment">//       </span>
    Elf64_auxv_t *aux = (Elf64_auxv_t*)envp; <span class="hljs-comment">//   </span>
                                             <span class="hljs-comment">// </span><font></font>
<font></font>
    <span class="hljs-keyword">for</span>(; aux-&gt;a_type != AT_NULL; aux++) {
        <span class="hljs-comment">//       </span>
        <span class="hljs-keyword">if</span>(aux-&gt;a_type == AT_PHDR) {
            <span class="hljs-comment">//   ELF ,    </span>
            <span class="hljs-comment">//     </span>
            base_addr = (<span class="hljs-keyword">void</span>*)(aux-&gt;a_un.a_val â€“ <span class="hljs-keyword">sizeof</span>(Elf64_Ehdr));
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> base_addr;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">size_t</span> <span class="hljs-title">elf_memory_size</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *mapped)</span> </span>{<font></font>
    Elf64_Ehdr *ehdr = mapped;<font></font>
    Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff;<font></font>
    <span class="hljs-keyword">size_t</span> mem_size = <span class="hljs-number">0</span>, segment_len;<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; ehdr-&gt;e_phnum; i++, phdr++) {
        <span class="hljs-keyword">if</span>(phdr-&gt;p_type != PT_LOAD)
            <span class="hljs-keyword">continue</span>;<font></font>
        segment_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % <span class="hljs-number">4096</span>);<font></font>
        mem_size += PAGEUP(segment_len);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> mem_size;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">elf_load_addr</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *rsp, <span class="hljs-keyword">void</span> *mapped, <span class="hljs-keyword">size_t</span> mapped_size)</span> </span>{<font></font>
    Elf64_Ehdr *ehdr = mapped;<font></font>
    <span class="hljs-keyword">if</span>(ehdr-&gt;e_type == ET_EXEC)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
    <span class="hljs-keyword">size_t</span> mem_size = elf_memory_size(mapped) + <span class="hljs-number">0x1000</span>;
    <span class="hljs-keyword">void</span> *load_addr = elf_base_addr(rsp);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(mapped &lt; load_addr &amp;&amp; mapped + mapped_size &gt; load_addr - mem_size)<font></font>
        load_addr = mapped;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> load_addr - mem_size;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªãƒ³ã‚«ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª¬æ˜</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸Šè¨˜ã®externå¤‰æ•°ã®æ–‡å­—ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¾Œã®ã‚³ãƒ¼ãƒ‰ã¨ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒåŒã˜.textã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’å˜ã«ã‚«ãƒƒãƒˆã™ã‚‹ã ã‘ã§ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒã‚·ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã‚’ç°¡å˜ã«æŠ½å‡ºã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ãƒªãƒ³ã‚«ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">ENTRY(_start)<font></font>
SECTIONS {<font></font>
    . = 0;<font></font>
    .text :{<font></font>
        *(.text) *(.text.startup) *(.data) *(.rodata)<font></font>
        payload_size = .;<font></font>
        QUAD(0)<font></font>
        key_seed = .;<font></font>
        QUAD(0)<font></font>
        iv_seed = .;<font></font>
        QUAD(0)<font></font>
        loader_end = .;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QUADï¼ˆ0ï¼‰ã¯8ãƒã‚¤ãƒˆã®ã‚¼ãƒ­ã‚’é…ç½®ã™ã‚‹ã“ã¨ã‚’èª¬æ˜ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚ä»£ã‚ã‚Šã«ã€ãƒ‘ãƒƒã‚«ãƒ¼ã¯ç‰¹å®šã®å€¤ã‚’ç½®ãæ›ãˆã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒã‚·ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šå–ã‚‹ãŸã‚ã«ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å…ˆé ­ã‹ã‚‰ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¸ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã®ã‚·ãƒ•ãƒˆã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å…ˆé ­ã‹ã‚‰ã®payload_sizeã€key_seedã€ãŠã‚ˆã³iv_seedæ–‡å­—ã®å€¤ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚ãƒã‚·ãƒ³ã‚³ãƒ¼ãƒ‰ã®å…ˆé ­ã«æ›¸ãè¾¼ã‚€å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã“ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã“ã¡ã‚‰ã‹ã‚‰å…¥æ‰‹ã§ã</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ã™</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã§ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®èª¬æ˜ã¯çµ‚äº†ã§ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç›´æ¥ãƒ‘ãƒƒã‚«ãƒ¼</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‘ãƒƒã‚«ãƒ¼ã®ä¸»ãªæ©Ÿèƒ½ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚</font><font style="vertical-align: inherit;">2ã¤ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã¯argv [1]ã§ã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã¯argv [2]ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãšã€å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ¡ãƒ¢ãƒªã«è¡¨ç¤ºã•ã‚Œã€packerã¨ã®äº’æ›æ€§ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ‘ãƒƒã‚«ãƒ¼ã¯ã€ET_EXECã¨ET_DYNã®2ç¨®é¡ã®ELFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å‡¦ç†ã—ã€é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å‡¦ç†ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®åˆ¶é™ãŒå°å…¥ã•ã‚ŒãŸç†ç”±ã¯ã€Linuxã‚·ã‚¹ãƒ†ãƒ ã”ã¨ã«å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹ãŸã‚ã§ã™ã€‚</font><font style="vertical-align: inherit;">å‹•çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒè¦ªã‚·ã‚¹ãƒ†ãƒ ä»¥å¤–ã®ã‚·ã‚¹ãƒ†ãƒ ã§èµ·å‹•ã—ãªã„å¯èƒ½æ€§ã¯éå¸¸ã«é«˜ã„ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ¡ã‚¤ãƒ³é–¢æ•°ã®å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">size_t</span> mapped_size;
<span class="hljs-keyword">void</span> *mapped = map_file(argv[<span class="hljs-number">1</span>], &amp;mapped_size);
<span class="hljs-keyword">if</span>(check_elf(mapped) &lt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œã€å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒäº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã™ã‚‹ã¨ã€åœ§ç¸®ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">size_t</span> comp_size;
<span class="hljs-keyword">uint8_t</span> *comp_buf = huffman_encode(mapped, &amp;comp_size);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€AESçŠ¶æ…‹ãŒç”Ÿæˆã•ã‚Œã€åœ§ç¸®ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ãŒæš—å·åŒ–ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">AESã®çŠ¶æ…‹ã¯ã€æ¬¡ã®æ§‹é€ ã«ã‚ˆã£ã¦æ±ºå®šã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> AES_ENTROPY_BUFSIZE 256</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-keyword">uint8_t</span> entropy_buf[AES_ENTROPY_BUFSIZE]; <span class="hljs-comment">// 256- </span>
    <span class="hljs-keyword">size_t</span> key_seed; <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">size_t</span> iv_seed; <span class="hljs-comment">//      </span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AES_ctx</span> <span class="hljs-title">ctx</span>;</span> <span class="hljs-comment">//  AES-CTR</span><font></font>
} AES_state_t;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ã‚¤ãƒ³ã®å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">AES_state_t aes_st;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; AES_ENTROPY_BUFSIZE; i++)<font></font>
    state.entropy_buf[i] = rand() % <span class="hljs-number">256</span>;<font></font>
state.key_seed = rand();<font></font>
state.iv_seed = rand();<font></font>
AES_init_ctx_iv(&amp;state.ctx, state.entropy_buf, state.key_seed, state.iv_seed);<font></font>
AES_CTR_xcrypt_buffer(&amp;aes_st.ctx, comp_buf, comp_size);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹æ§‹é€ ãŒåˆæœŸåŒ–ã•ã‚Œã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®payload_sizeã€key_seedã€iv_seedã®å€¤ãŒå‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç”Ÿæˆã•ã‚ŒãŸå€¤ã«å¤‰æ›´ã•ã‚Œã€ãã®å¾ŒAESçŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã¯ã€æ¬¡ã®æ§‹é€ ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-keyword">char</span> *loader_begin; <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">size_t</span> entry_offset; <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">size_t</span> *payload_size_patch_offset; <span class="hljs-comment">//    </span>
                                       <span class="hljs-comment">// ELF   </span>
    <span class="hljs-keyword">size_t</span> *key_seed_pacth_offset; <span class="hljs-comment">//    </span>
                                   <span class="hljs-comment">//      </span>
    <span class="hljs-keyword">size_t</span> *iv_seed_patch_offset; <span class="hljs-comment">//    </span>
                                  <span class="hljs-comment">//    </span>
                                  <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">size_t</span> loader_size; <span class="hljs-comment">//    </span>
} <span class="hljs-keyword">loader_t</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ã‚¤ãƒ³ã®å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">loader_t</span> loader;<font></font>
init_loader(&amp;loader);<font></font>
*loader.payload_size_patch_offset = comp_size;<font></font>
*loader.key_seed_pacth_offset = aes_st.key_seed;<font></font>
*loader.iv_seed_patch_offset = aes_st.iv_seed;<font></font>
<span class="hljs-built_in">memset</span>(&amp;aes_st.ctx, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(aes_st.ctx));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã®éƒ¨åˆ†ã§ã¯ã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ELFãƒ˜ãƒƒãƒ€ãƒ¼ã€1ã¤ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ¼ãƒ‰ã€åœ§ç¸®ãŠã‚ˆã³æš—å·åŒ–ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ã€ãŠã‚ˆã³256ãƒã‚¤ãƒˆã®ãƒãƒƒãƒ•ã‚¡ãƒ¼ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> out_fd = open(argv[<span class="hljs-number">2</span>], O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number">0755</span>); <span class="hljs-comment">// </span>
                                                                <span class="hljs-comment">//  </span>
write_elf_ehdr(out_fd, &amp;loader); <span class="hljs-comment">//  ELF </span>
write_elf_phdr(out_fd, &amp;loader, comp_size); <span class="hljs-comment">//   </span>
write(out_fd, loader.loader_begin, loader.loader_size); <span class="hljs-comment">//  </span>
write(out_fd, comp_buf, comp_size); <span class="hljs-comment">//     ELF</span>
write(out_fd, aes_st.entropy_buf, AES_ENTROPY_BUFSIZE); <span class="hljs-comment">// </span>
                                                        <span class="hljs-comment">// 256- </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã§ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒƒã‚«ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçµ‚äº†ã—ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼æƒ…å ±åˆæœŸåŒ–é–¢æ•°ã€ELFãƒ˜ãƒƒãƒ€ãƒ¼è¨˜éŒ²é–¢æ•°ã€ãŠã‚ˆã³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼è¨˜éŒ²é–¢æ•°ã®æ©Ÿèƒ½ãŒæ¤œè¨ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼æƒ…å ±ã®åˆæœŸåŒ–</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ­ãƒ¼ãƒ€ãƒ¼ãƒã‚·ãƒ³ã‚³ãƒ¼ãƒ‰ã¯ã€ä»¥ä¸‹ã®ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">.data<font></font>
.globl _loader_begin<font></font>
.globl _loader_end<font></font>
_loader_begin:<font></font>
.incbin "loader"<font></font>
_loader_end:<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¡ãƒ¢ãƒªå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã«ã€main.cãƒ•ã‚¡ã‚¤ãƒ«ã§æ¬¡ã®å¤‰æ•°ãŒå®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span>* _loader_begin;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span>* _loader_end;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€init_loaderé–¢æ•°ã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚</font><font style="vertical-align: inherit;">æœ€åˆã«ã€æ¬¡ã®å€¤ãŒé †ç•ªã«èª­ã¿å–ã‚‰ã‚Œã¾ã™ï¼šãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å…ˆé ­ã‹ã‚‰ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆentry_offsetï¼‰ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å…ˆé ­ã‹ã‚‰ã®ãƒ‘ãƒƒã‚¯ã•ã‚ŒãŸELFãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆpayload_size_patch_offsetï¼‰ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®å…ˆé ­ã‹ã‚‰ã®ã‚­ãƒ¼ã®åˆæœŸã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å€¤ã®ã‚·ãƒ•ãƒˆï¼ˆkey_seed_paâ€‹â€‹tch_offsetã®ãƒ™ã‚¯ãƒˆãƒ«ã®ã‚·ãƒ•ãƒˆå€¤ã€ãƒ™ã‚¯ãƒˆãƒ«ã®ã‚·ãƒ•ãƒˆï¼‰ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã®æœ€åˆã‹ã‚‰ã®åˆæœŸåŒ–ï¼ˆiv_seed_paâ€‹â€‹tch_offsetï¼‰ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã«ã€ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæœ€å¾Œã®3ã¤ã®å€¤ã«è¿½åŠ ã•ã‚Œã‚‹ãŸã‚ã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’é€†å‚ç…§ã—ã¦å€¤ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¨ãã«ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸ã§å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚¼ãƒ­ï¼ˆQUADï¼ˆ0ï¼‰ï¼‰ã‚’å¿…è¦ãªå€¤ã«ç½®ãæ›ãˆã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_loader</span><span class="hljs-params">(<span class="hljs-keyword">loader_t</span> *l)</span> </span>{
    <span class="hljs-keyword">void</span> *loader_begin = (<span class="hljs-keyword">void</span>*)&amp;_loader_begin;<font></font>
    l-&gt;entry_offset = *(<span class="hljs-keyword">size_t</span>*)loader_begin;<font></font>
    loader_begin += <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">size_t</span>);<font></font>
<font></font>
    l-&gt;payload_size_patch_offset = *(<span class="hljs-keyword">void</span>**)loader_begin;<font></font>
    loader_begin += <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*);<font></font>
<font></font>
    l-&gt;key_seed_pacth_offset = *(<span class="hljs-keyword">void</span>**)loader_begin;<font></font>
    loader_begin += <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*);<font></font>
<font></font>
    l-&gt;iv_seed_patch_offset = *(<span class="hljs-keyword">void</span>**)loader_begin;<font></font>
    loader_begin += <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*);<font></font>
<font></font>
    l-&gt;payload_size_patch_offset = (<span class="hljs-keyword">size_t</span>)l-&gt;payload_size_patch_offset +<font></font>
                                   loader_begin;<font></font>
    l-&gt;key_seed_pacth_offset = (<span class="hljs-keyword">size_t</span>)l-&gt;key_seed_pacth_offset +<font></font>
                               loader_begin;<font></font>
    l-&gt;iv_seed_patch_offset = (<span class="hljs-keyword">size_t</span>)l-&gt;iv_seed_patch_offset +<font></font>
                              loader_begin;<font></font>
<font></font>
    l-&gt;loader_begin = loader_begin;<font></font>
    l-&gt;loader_size = (<span class="hljs-keyword">void</span>*)&amp;_loader_end - loader_begin;<font></font>
}<font></font>
</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_elf_ehdr</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">write_elf_ehdr</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">loader_t</span> *loader)</span> </span>{
    <span class="hljs-comment">//  ELF </span><font></font>
    Elf64_Ehdr ehdr;<font></font>
    <span class="hljs-built_in">memset</span>(ehdr.e_ident, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ehdr.e_ident));
    <span class="hljs-built_in">memcpy</span>(ehdr.e_ident, ELFMAG, SELFMAG);<font></font>
    ehdr.e_ident[EI_CLASS] = ELFCLASS64;<font></font>
    ehdr.e_ident[EI_DATA] = ELFDATA2LSB;<font></font>
    ehdr.e_ident[EI_VERSION] = EV_CURRENT;<font></font>
    ehdr.e_ident[EI_OSABI] = ELFOSABI_NONE;<font></font>
<font></font>
    ehdr.e_type = ET_DYN;<font></font>
    ehdr.e_machine = EM_X86_64;<font></font>
    ehdr.e_version = EV_CURRENT;<font></font>
    ehdr.e_entry = <span class="hljs-keyword">sizeof</span>(Elf64_Ehdr) +
                   <span class="hljs-keyword">sizeof</span>(Elf64_Phdr) +<font></font>
                   loader-&gt;entry_offset;<font></font>
    ehdr.e_phoff = <span class="hljs-keyword">sizeof</span>(Elf64_Ehdr);<font></font>
    ehdr.e_shoff = <span class="hljs-number">0</span>;<font></font>
    ehdr.e_flags = <span class="hljs-number">0</span>;<font></font>
    ehdr.e_ehsize = <span class="hljs-keyword">sizeof</span>(Elf64_Ehdr);<font></font>
    ehdr.e_phentsize = <span class="hljs-keyword">sizeof</span>(Elf64_Phdr);<font></font>
    ehdr.e_phnum = <span class="hljs-number">1</span>;<font></font>
    ehdr.e_shentsize = <span class="hljs-keyword">sizeof</span>(Elf64_Shdr);<font></font>
    ehdr.e_shnum = <span class="hljs-number">0</span>;<font></font>
    ehdr.e_shstrndx = <span class="hljs-number">0</span>;<font></font>
<font></font>
    write(fd, &amp;ehdr, <span class="hljs-keyword">sizeof</span>(ehdr)); <span class="hljs-comment">//    </span><font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã“ã§ã¯ã€ELFãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¨™æº–çš„ãªåˆæœŸåŒ–ã¨ãã‚Œã«ç¶šããƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¨˜éŒ²ãŒè¡Œã‚ã‚Œã¾ã™ã€‚æ³¨æ„ãŒå¿…è¦ãªã®ã¯ã€ET_DYN ELFãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€æœ€åˆã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã£ã¦è¨˜è¿°ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å®Ÿè¡Œå¯èƒ½ã‚³ãƒ¼ãƒ‰ã ã‘ã§ãªãã€ELFãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã™ã¹ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚å«ã¾ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€æœ€åˆã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã¯ã‚¼ãƒ­ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚µã‚¤ã‚ºã¯ELFãƒ˜ãƒƒãƒ€ãƒ¼ã€ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãŠã‚ˆã³å®Ÿè¡Œå¯èƒ½ã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºã®åˆè¨ˆã§ã‚ã‚Šã€ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¯ã€ELFãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºã€ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºã€ãŠã‚ˆã³å®Ÿè¡Œå¯èƒ½ã‚³ãƒ¼ãƒ‰ã®å…ˆé ­ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã®åˆè¨ˆã¨ã—ã¦æ±ºå®šã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_elf_phdr</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">write_elf_phdr</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">loader_t</span> *loader, <span class="hljs-keyword">size_t</span> payload_size)</span> </span>{
    <span class="hljs-comment">//   </span><font></font>
    Elf64_Phdr phdr;<font></font>
    phdr.p_type = PT_LOAD;<font></font>
    phdr.p_offset = <span class="hljs-number">0</span>;<font></font>
    phdr.p_vaddr = <span class="hljs-number">0</span>;<font></font>
    phdr.p_paddr = <span class="hljs-number">0</span>;<font></font>
    phdr.p_filesz = <span class="hljs-keyword">sizeof</span>(Elf64_Ehdr) +
                    <span class="hljs-keyword">sizeof</span>(Elf64_Phdr) +<font></font>
                    loader-&gt;loader_size +<font></font>
                    payload_size +<font></font>
                    AES_ENTROPY_BUFSIZE;<font></font>
    phdr.p_memsz = phdr.p_filesz;<font></font>
    phdr.p_flags = PF_R | PF_W | PF_X;<font></font>
    phdr.p_align = <span class="hljs-number">0x1000</span>;<font></font>
<font></font>
    write(fd, &amp;phdr, <span class="hljs-keyword">sizeof</span>(phdr)); <span class="hljs-comment">//     </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã“ã§ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã§è¨˜è¿°ã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚µã‚¤ã‚ºã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">å‰ã®æ®µè½ã§èª¬æ˜ã—ãŸã‚ˆã†ã«ã€ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã£ã¦è¨˜è¿°ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã¯ã€å®Ÿè¡Œå¯èƒ½ã‚³ãƒ¼ãƒ‰ã ã‘ã§ãªãã€ELFãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚å«ã¾ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€æ›¸ãè¾¼ã¿å¯èƒ½ãªå®Ÿè¡Œå¯èƒ½ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã‚‹AESå®Ÿè£…ãŒãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«æš—å·åŒ–ãŠã‚ˆã³å¾©å·åŒ–ã™ã‚‹ãŸã‚ã§ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒƒã‚«ãƒ¼ã®ä»•äº‹ã«ã¤ã„ã¦ã®ã„ãã¤ã‹ã®äº‹å®Ÿ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ã‚¹ãƒˆä¸­ã«ã€glibcã§é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€æ¬¡ã®å‘½ä»¤ã§ã€èµ·å‹•æ™‚ã«segfaultã«ç§»å‹•ã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">movqï¼…fsï¼š0x28ã€ï¼…rax</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãªãœãã†ãªã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€ã“ã®ä»¶ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å…±æœ‰ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚</font><font style="vertical-align: inherit;">glibcã®ä»£ã‚ã‚Šã«ã€musl-libcã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã™ã¹ã¦ãŒç¢ºå®Ÿã«å‹•ä½œã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã€packerã¯ã€httpã‚µãƒ¼ãƒãƒ¼ãªã©ã®é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸgolangãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">golangãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Œå…¨ãªé™çš„ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®å ´åˆã€æ¬¡ã®ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CGO_ENABLED = 0 go build -a -ldflags '-extldflags "-static"'ã€‚</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‘ãƒƒã‚«ãƒ¼ãŒæœ€å¾Œã«ãƒ†ã‚¹ãƒˆã•ã‚ŒãŸã®ã¯ã€å‹•çš„ãƒªãƒ³ã‚«ãƒ¼ã®ãªã„ET_DYN ELFãƒ•ã‚¡ã‚¤ãƒ«ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ç¢ºã‹ã«ã€ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ“ä½œã™ã‚‹ã¨ãã€elf_load_addré–¢æ•°ã¯å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">å®Ÿéš›ã«ã¯ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã‹ã‚‰åˆ‡ã‚Šå–ã‚Šã€å›ºå®šã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ0x10000ãªã©ï¼‰ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çµè«–</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒ‘ãƒƒã‚«ãƒ¼ã¯ã€ä¿è­·ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç°¡å˜ã«å¾©å·åŒ–ã§ãã‚‹ãŸã‚ã€æ„å›³ã—ãŸç›®çš„ã«ä½¿ç”¨ã—ã¦ã‚‚æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„ã¯ã€ELFãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ä½œæ¥­ã€ãã‚Œã‚‰ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•ã€ãŠã‚ˆã³ã‚ˆã‚Šå®Œå…¨ãªãƒ‘ãƒƒã‚«ãƒ¼ã®ä½œæˆã®æº–å‚™ã‚’ã‚ˆã‚Šã‚ˆããƒã‚¹ã‚¿ãƒ¼ã™ã‚‹ã“ã¨ã§ã—ãŸã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483354/index.html">äºŒãƒ¶æœˆç›®ã®å‘ªã„</a></li>
<li><a href="../ja483356/index.html">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ•°ã€Œä½•ï¼Ÿã€ã©ã“ï¼Ÿã„ã¤ï¼Ÿ" ï¼ˆChGKï¼‰ã¾ãŸã¯å‹é”ã®å‰ã§ä½•å›æ¡æ‰‹ï¼Ÿ</a></li>
<li><a href="../ja483360/index.html">ãƒ‘ãƒ¯ãƒ¼é›»æ°—é§†å‹•åˆ¶å¾¡ã€‚ã‚¢ãƒãƒãƒ¥ã‚¢ä½“é¨“</a></li>
<li><a href="../ja483364/index.html">ä»•äº‹ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã€æ™‚é–“ã‚’ç¯€ç´„ã§ãã¾ã™ã€‚</a></li>
<li><a href="../ja483366/index.html">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã®æ­´å²ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°</a></li>
<li><a href="../ja483372/index.html">GPUã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒƒãƒ—ãƒˆãƒƒãƒ—ã§DeepPavlovãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja483374/index.html">REST APIã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³-JavaãŠã‚ˆã³Springã§ã®Webã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆã®ä¾‹</a></li>
<li><a href="../ja483376/index.html">ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ã®è¡¨é¢ã«</a></li>
<li><a href="../ja483378/index.html">C ++ 17ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®ãªã„ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãªä½œæ¥­ï¼šå€¤ãƒ™ãƒ¼ã‚¹ã®ãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</a></li>
<li><a href="../ja483380/index.html">ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ï¼šå¥‘ç´„ã®éµå®ˆæ–¹æ³•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>