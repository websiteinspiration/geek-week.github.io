<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸˆ‚ï¸ ğŸº ğŸ’§ LVMå’Œä¿„ç½—æ–¯å¥—å¨ƒæœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿ ğŸ•‰ï¸ ğŸ‘¨ğŸ»â€âœˆï¸ ğŸŒ…</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç¾å¥½çš„ä¸€å¤©ã€‚
 æˆ‘æƒ³ä¸ç¤¾åŒºåˆ†äº«ä½¿ç”¨md RAID + LVMä¸ºKVMæ„å»ºå­˜å‚¨ç³»ç»Ÿçš„å®è·µç»éªŒã€‚
 
 è¯¥ç¨‹åºå°†ï¼š
 
 

- ä»NVMe SSDæ„å»ºmd RAID 1ã€‚
- ä»SATA SSDå’Œå¸¸è§„é©±åŠ¨å™¨æ„å»ºmd RAID 6ã€‚
- SSD RAID 1/6ä¸ŠTRIM / DISCARDçš„åŠŸèƒ½ã€‚
-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>LVMå’Œä¿„ç½—æ–¯å¥—å¨ƒæœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492834/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¾å¥½çš„ä¸€å¤©ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘æƒ³ä¸ç¤¾åŒºåˆ†äº«ä½¿ç”¨md RAID + LVMä¸ºKVMæ„å»ºå­˜å‚¨ç³»ç»Ÿçš„å®è·µç»éªŒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥ç¨‹åºå°†ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»NVMe SSDæ„å»ºmd RAID 1ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»SATA SSDå’Œå¸¸è§„é©±åŠ¨å™¨æ„å»ºmd RAID 6ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD RAID 1/6ä¸ŠTRIM / DISCARDçš„åŠŸèƒ½ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¸€ç»„é€šç”¨ç£ç›˜ä¸Šåˆ›å»ºå¯å¯åŠ¨çš„md RAID 1/6é˜µåˆ—ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœBIOSä¸­æ²¡æœ‰NVMeæ”¯æŒï¼Œè¯·åœ¨NVMe RAID 1ä¸Šå®‰è£…ç³»ç»Ÿã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨LVMç¼“å­˜å’ŒLVMç²¾ç®€ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨BTRFSå¿«ç…§å¹¶å‘é€/æ¥æ”¶å¤‡ä»½ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨LVMç²¾ç®€å¿«ç…§å’Œthin_deltaè¿›è¡ŒBTRFSæ ·å¼çš„å¤‡ä»½ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæœ‰å…´è¶£ï¼Œè¯·åœ¨çŒ«ä¸‹ã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å£°æ˜</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½œè€…å¯¹ä½¿ç”¨æˆ–ä¸ä½¿ç”¨æœ¬æ–‡çš„ææ–™/ç¤ºä¾‹/ä»£ç /æŠ€å·§/æ•°æ®æ‰€é€ æˆçš„åæœä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚</font><font style="vertical-align: inherit;">é€šè¿‡ä»¥ä»»ä½•æ–¹å¼é˜…è¯»æˆ–ä½¿ç”¨æœ¬ææ–™ï¼Œæ‚¨åº”å¯¹è¿™äº›è¡Œä¸ºçš„æ‰€æœ‰åæœè´Ÿè´£ã€‚</font><font style="vertical-align: inherit;">å¯èƒ½çš„åæœåŒ…æ‹¬ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è„†çš®æ²¹ç‚¸NVMe SSDã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œå…¨è€—å°½äº†è®°å½•èµ„æºå’ŒSSDé©±åŠ¨å™¨çš„æ•…éšœã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œå…¨ä¸¢å¤±æ‰€æœ‰é©±åŠ¨å™¨ä¸Šçš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å¤‡ä»½ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®¡ç®—æœºç¡¬ä»¶æ•…éšœã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èŠ±æ—¶é—´ï¼Œç¥ç»å’Œé‡‘é’±ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šé¢æœªåˆ—å‡ºçš„ä»»ä½•å…¶ä»–æ•ˆæœã€‚</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é“</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åº“å­˜ä¸ºï¼š</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸»æ¿å°†äº20â€‹â€‹13å¹´å·¦å³åœ¨Z87èŠ¯ç‰‡ç»„ä¸Šé…å¤‡è‹±ç‰¹å°”é…·ç¿i7 / Haswellã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU 4æ ¸ï¼Œ8çº¿ç¨‹</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 32 GBçš„DDR3 RAM</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 x 16æˆ–2 x 8 PCIe 3.0</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 x 4 +1 x 1ä¸ªPCIe 2.0</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6 x 6 GBps SATA 3è¿æ¥å™¨ </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SASé€‚é…å™¨LSI SAS9211-8Ié—ªçƒåˆ°IT / HBAæ¨¡å¼ã€‚</font><font style="vertical-align: inherit;">æ”¯æŒRAIDçš„å›ºä»¶å·²è¢«HBAå›ºä»¶æ•…æ„æ›¿æ¢ä¸ºï¼š</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éšæ—¶å¯ä»¥æ‰”æ‰è¯¥é€‚é…å™¨ï¼Œå¹¶ç”¨å…¶ä»–ä»»ä½•ç¬¬ä¸€ä¸ªé€‚é…å™¨æ›¿æ¢å®ƒã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRIM / Discardåœ¨ç£ç›˜ä¸Šæ­£å¸¸å·¥ä½œï¼Œå› ä¸º </font><font style="vertical-align: inherit;">åœ¨RAIDå›ºä»¶ä¸­ï¼Œæ ¹æœ¬ä¸æ”¯æŒè¿™äº›å‘½ä»¤ï¼Œè€Œä¸”HBAé€šå¸¸å¹¶ä¸å…³å¿ƒåœ¨æ€»çº¿ä¸Šå‘é€ä»€ä¹ˆå‘½ä»¤ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¡¬ç›˜é©±åŠ¨å™¨-8ç‰‡HGST Travelstar 7K1000ï¼Œå®¹é‡ä¸º1 TBï¼Œå¤–å½¢å°ºå¯¸ä¸º2.5ï¼Œä¸ç¬”è®°æœ¬ç”µè„‘ç›¸åŒã€‚</font><font style="vertical-align: inherit;">è¿™äº›é©±åŠ¨å™¨ä»¥å‰ä½äºRAID 6é˜µåˆ—ä¸­ã€‚</font><font style="vertical-align: inherit;">åœ¨æ–°ç³»ç»Ÿä¸­ï¼Œä»–ä»¬è¿˜å°†æ‰¾åˆ°åº”ç”¨ç¨‹åºã€‚</font><font style="vertical-align: inherit;">ç”¨äºå­˜å‚¨æœ¬åœ°å¤‡ä»½ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦å¤–å®ƒè¢«æ·»åŠ ï¼š</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6ä»¶SATAå›ºæ€ç›˜Samsung 860 QVO 2TBã€‚</font><font style="vertical-align: inherit;">è¿™äº›SSDéœ€è¦å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”éœ€è¦SLCç¼“å­˜ï¼Œå¯é æ€§é«˜ä¸”ä»·æ ¼ä½å»‰ã€‚</font><font style="vertical-align: inherit;">å¼ºåˆ¶æ€§è¦æ±‚æ”¯æŒä¸¢å¼ƒ/é›¶ï¼Œè¿™ç”±dmesgä¸­çš„ä¸€è¡Œæ£€æŸ¥ï¼š</font></font><br>
<br>
<code>kernel: ata1.00: Enabling discard_zeroes_data</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2ä»¶NVMe SSDå‹å·Samsung SSD 970 EVO 500GBã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºè¿™äº›å›ºæ€ç¡¬ç›˜ï¼Œéšæœºè¯»å†™é€Ÿåº¦å’Œæ»¡è¶³æ‚¨éœ€æ±‚çš„èµ„æºéå¸¸é‡è¦ã€‚</font><font style="vertical-align: inherit;">æ•£çƒ­å™¨ç»™ä»–ä»¬ã€‚</font><font style="vertical-align: inherit;">å¿…é€‰ </font><font style="vertical-align: inherit;">ç»å¯¹æœ‰å¿…è¦ã€‚</font><font style="vertical-align: inherit;">å¦åˆ™ï¼Œåœ¨ç¬¬ä¸€æ¬¡RAIDaåŒæ­¥æœŸé—´å°†å…¶æ²¹ç‚¸ç›´è‡³å˜è„†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
StarTech PEX8M2E2é€‚é…å™¨ï¼Œç”¨äº2ä¸ªå…·æœ‰PCIe 3.0 8xæ’æ§½çš„NVMe SSDã€‚åŒæ ·ï¼Œè¿™åªæ˜¯HBAï¼Œä½†å¯¹äºNVMeã€‚å®ƒä¸å»‰ä»·é€‚é…å™¨çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œç”±äºé›†æˆäº†PCIeå¼€å…³ï¼Œå› æ­¤æ— éœ€ä¸»æ¿æä¾›PCIeåˆ†å‰æ”¯æŒã€‚å³ä½¿å®ƒæ˜¯x1 PCIe 1.0æ’æ§½ï¼Œå³ä½¿åœ¨æœ‰PCIeçš„æœ€æ—§ç³»ç»Ÿä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚è‡ªç„¶ï¼Œä»¥é€‚å½“çš„é€Ÿåº¦ã€‚é‚£é‡Œæ²¡æœ‰RAIDã€‚æ¿ä¸Šæ²¡æœ‰é›†æˆçš„BIOSã€‚å› æ­¤ï¼Œæ‚¨çš„ç³»ç»Ÿå°†ä¸ä¼šç¥å¥‡åœ°å­¦ä¹ å¦‚ä½•ä»NVMeå¯åŠ¨ï¼Œè€Œå€ŸåŠ©æ­¤è®¾å¤‡ï¼ŒNVMe RAIDçš„å·¥ä½œå°±æ›´å°‘äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥ç»„ä»¶ä»…ç”±ç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªå…è´¹çš„8x PCIe 3.0å¼•èµ·ï¼Œå¹¶ä¸”åœ¨æœ‰2ä¸ªç©ºé—²æ’æ§½çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“ç”±ä¸¤ä¸ªä¾¿å®œçš„PEX4M2E1æˆ–ç±»ä¼¼äº§å“ä»£æ›¿ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä»¥600å¢å¸ƒçš„ä»·æ ¼è´­ä¹°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ•…æ„æ‹’ç»ä½¿ç”¨å„ç§ç¡¬ä»¶æˆ–é›†æˆRAIDèŠ¯ç‰‡ç»„/ BIOSï¼Œä»¥ä¾¿èƒ½å¤Ÿå®Œå…¨æ›¿æ¢æ•´ä¸ªç³»ç»Ÿï¼ŒSSD / HDDæœ¬èº«é™¤å¤–ï¼Œä»¥ä¿å­˜æ‰€æœ‰æ•°æ®ã€‚</font><font style="vertical-align: inherit;">ç†æƒ³æƒ…å†µä¸‹ï¼Œå½“è½¬ç§»åˆ°å…¨æ–°/ä¸åŒçš„ç¡¬ä»¶æ—¶ï¼Œç”šè‡³å¯ä»¥ä¿ç•™å·²å®‰è£…çš„æ“ä½œç³»ç»Ÿã€‚</font><font style="vertical-align: inherit;">æœ€ä¸»è¦çš„æ˜¯æœ‰SATAå’ŒPCIeç«¯å£ã€‚</font><font style="vertical-align: inherit;">å®ƒå°±åƒä¸€ä¸ªå®æ—¶CDæˆ–å¯å¯åŠ¨çš„é—ªå­˜é©±åŠ¨å™¨ï¼Œåªæ˜¯é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”æœ‰ç‚¹è¿‡å¤§ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹½é»˜</font></font></b><div class="spoiler_text"> ,   , â€”          .     .            5.25  .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½å§ï¼Œå½“ç„¶ï¼Œè¦åœ¨Linuxä¸­è¯•éªŒä¸åŒçš„SSDç¼“å­˜æ–¹æ³•ã€‚</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¡¬ä»¶çªè¢­ï¼Œè¿™å¾ˆæ— èŠã€‚</font><font style="vertical-align: inherit;">æ‰“å¼€ã€‚</font><font style="vertical-align: inherit;">å®ƒæ˜¯å¦èµ·ä½œç”¨ã€‚</font><font style="vertical-align: inherit;">æœ‰äº†mdadmï¼Œæ€»ä¼šæœ‰é€‰æ‹©ã€‚</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŸ”è½¯çš„</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥å‰ï¼ŒDebian 8 Jessieå·²å®‰è£…åœ¨æ¥è¿‘EOLçš„ç¡¬ä»¶ä¸Šã€‚</font><font style="vertical-align: inherit;">ä¸Šè¿°HDDçš„RAID 6ä¸LVMé…å¯¹ã€‚</font><font style="vertical-align: inherit;">å®ƒåœ¨kvm / libvirtä¸­è¿è¡Œè™šæ‹Ÿæœºã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› ä¸º </font><font style="vertical-align: inherit;">ä½œè€…åœ¨åˆ›å»ºä¾¿æºå¼å¯å¯åŠ¨SATA / NVMeé—ªå­˜é©±åŠ¨å™¨æ–¹é¢å…·æœ‰é€‚å½“çš„ç»éªŒï¼Œå¹¶ä¸”ä¸ºäº†ä¸ç ´åé€šå¸¸çš„apt-templateï¼Œé€‰æ‹©äº†Ubuntu 18.04ä½œä¸ºç›®æ ‡ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå·²ç»è¶³å¤Ÿç¨³å®šï¼Œä½†æ˜¯åœ¨æœªæ¥ä»ä¼šè·å¾—3å¹´çš„æ”¯æŒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ä¸Šè¿°ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬æä¾›äº†æ‰€æœ‰éœ€è¦çš„ç¡¬ä»¶é©±åŠ¨ç¨‹åºã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹è½¯ä»¶å’Œé©±åŠ¨ç¨‹åºã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡†å¤‡å®‰è£…</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦å®‰è£…ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦Ubuntuæ¡Œé¢æ˜ åƒã€‚</font><font style="vertical-align: inherit;">æœåŠ¡å™¨ç³»ç»Ÿå…·æœ‰æŸç§å¼ºå¤§çš„å®‰è£…ç¨‹åºï¼Œå…¶è¡¨ç°å‡ºè¿‡åº¦çš„ï¼Œä¸å¯æ–­å¼€çš„ç‹¬ç«‹æ€§ï¼Œå§‹ç»ˆå°†UEFIç³»ç»Ÿåˆ†åŒºæ¨åˆ°æŸåæ‰€æœ‰åŠŸèƒ½çš„ç£ç›˜ä¹‹ä¸€ä¸Šã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå®ƒä»…ä»¥UEFIæ¨¡å¼å®‰è£…ã€‚</font><font style="vertical-align: inherit;">å®ƒä¸æä¾›é€‰é¡¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™ä¸é€‚åˆæˆ‘ä»¬ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆï¼Ÿ</font></font></b><div class="spoiler_text"> , UEFI        RAID, ..   UEFI ESP     .    ,    ESP     USB , ,   .      mdadm RAID 1    0.9    UEFI BIOS   , ,       BIOS       -  ESP     .<br>
<br>
 ,  UEFI   NVRAM,         , ..    .<br>
<br>
 ,      .     ,       Legacy/BIOS boot,    CSM  UEFI- .      , ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntuçš„æ¡Œé¢ç‰ˆæœ¬ä¹Ÿä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨Legacyå¼•å¯¼åŠ è½½ç¨‹åºæ­£å¸¸å®‰è£…ï¼Œä½†æ˜¯æ­£å¦‚ä»–ä»¬æ‰€è¯´çš„ï¼Œè¿™é‡Œè‡³å°‘æœ‰ä¸€äº›é€‰æ‹©ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæ”¶é›†ç¡¬ä»¶å¹¶ä»å¯å¯åŠ¨çš„Ubuntu Liveé—ªå­˜é©±åŠ¨å™¨åŠ è½½ç³»ç»Ÿã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†éœ€è¦ä¸‹è½½è½¯ä»¶åŒ…ï¼Œå› æ­¤æˆ‘ä»¬å»ºç«‹äº†ç½‘ç»œï¼Œä»è€Œä¸ºæ‚¨èµ¢å¾—äº†æ”¶ç›Šã€‚</font><font style="vertical-align: inherit;">å¦‚æœä¸èµ·ä½œç”¨ï¼Œæ‚¨å¯ä»¥æå‰å°†å¿…è¦çš„è½¯ä»¶åŒ…ä¸‹è½½åˆ°USBé—ªå­˜é©±åŠ¨å™¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬è¿›å…¥æ¡Œé¢ç¯å¢ƒï¼Œè¿è¡Œç»ˆç«¯ä»¿çœŸå™¨ï¼Œç„¶åå¼€å§‹ï¼š</font></font><br>
<br>
<code>#sudo bash</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€ä¹ˆæ ·...ï¼Ÿ</font></font></b><div class="spoiler_text">       sudo.  <b></b>    <b></b> .   ,       .     sudo   ,     . :<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W-tPTmdnc7E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<code>#apt-get install mdadm lvm2 thin-provisioning-tools btrfs-tools util-linux lsscsi nvme-cli mc</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ZFS ...ï¼Ÿ</font></font></b><div class="spoiler_text">       , â€”  ,         . <br>
        , â€”        ,   -  .<br>
<br>
    ZFS â€”  ,  mdadm+lvm    .<br>
<br>
           .      .   .  .  .  .      ,       . <br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆé‚£ä¹ˆBTRFS ...ï¼Ÿ</font></font></b><div class="spoiler_text">            Legacy/BIOS GRUB  , ,  ,   -.      /boot .  ,       / ()   ,           LVM     . <br>
<br>
   ,          .<br>
                       send/recieve.<br>
<br>
 ,                        GPU  PCI-USB Host-  KVM  IOMMU.<br>
<br>
    â€”  ,    .<br>
<br>
    ZFS, ,  ,     .<br>
<br>
  ,       / RAID      ZFS, BRTFS  LVM.<br>
<br>
   , BTRFS       ,         /    HDD.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é‡æ–°æ‰«ææ‰€æœ‰è®¾å¤‡ï¼šè®©æˆ‘ä»¬ç¯é¡¾å››å‘¨</font></font><br>
<br>
<code>#udevadm control --reload-rules &amp;&amp; udevadm trigger</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼š</font></font><br>
<br>
<code>#lsscsi &amp;&amp; nvme list<br>
[0:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sda <br>
[1:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdb <br>
[2:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdc <br>
[3:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdd <br>
[4:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sde <br>
[5:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdf <br>
[6:0:0:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdg <br>
[6:0:1:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdh <br>
[6:0:2:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdi <br>
[6:0:3:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdj <br>
[6:0:4:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdk <br>
[6:0:5:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdl <br>
[6:0:6:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdm <br>
[6:0:7:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdn <br>
Node SN Model Namespace Usage Format FW Rev <br>
---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------<br>
/dev/nvme0n1 S466NXXXXXXX15L Samsung SSD 970 EVO 500GB 1 0,00 GB / 500,11 GB 512 B + 0 B 2B2QEXE7<br>
/dev/nvme1n1 S5H7NXXXXXXX48N Samsung SSD 970 EVO 500GB 1 0,00 GB / 500,11 GB 512 B + 0 B 2B2QEXE7<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†åŒºâ€œé©±åŠ¨å™¨â€</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NVMeå›ºæ€ç¡¬ç›˜</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯æ— è®ºå¦‚ä½•æˆ‘ä»¬éƒ½ä¸ä¼šå¯¹å…¶è¿›è¡Œæ ‡è®°ã€‚</font><font style="vertical-align: inherit;">ä¸€æ ·ï¼Œæˆ‘ä»¬çš„BIOSçœ‹ä¸åˆ°è¿™äº›é©±åŠ¨å™¨ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå®ƒä»¬å°†å®Œå…¨ç”¨äºè½¯ä»¶RAIDã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç”šè‡³ä¸ä¼šåœ¨é‚£é‡Œåˆ›å»ºåˆ†åŒºã€‚</font><font style="vertical-align: inherit;">å¦‚æœè¦æ ¹æ®â€œä½³èƒ½â€æˆ–â€œåŸç†â€-åˆ›å»ºä¸€ä¸ªå¤§åˆ†åŒºï¼Œå¦‚HDDã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SATAç¡¬ç›˜</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å‘æ˜ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†ä¸ºæ‰€æœ‰å†…å®¹åˆ›å»ºä¸€ä¸ªéƒ¨åˆ†ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å°†åˆ›å»ºæ­¤éƒ¨åˆ†ï¼Œå› ä¸ºBIOSå¯ä»¥çœ‹åˆ°è¿™äº›ç£ç›˜ï¼Œç”šè‡³å¯ä»¥å°è¯•ä»å®ƒä»¬å¼•å¯¼ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ç”šè‡³ä»¥åä¼šåœ¨è¿™äº›ç£ç›˜ä¸Šå®‰è£…GRUBï¼Œä»¥ä¾¿ç³»ç»Ÿçªç„¶æˆåŠŸã€‚</font></font><br>
<br>
<code>#cat &gt;hdd.part &lt;&lt; EOF<br>
label: dos<br>
label-id: 0x00000000<br>
device: /dev/sdg<br>
unit: sectors<br>
<br>
/dev/sdg1 : start= 2048, size= 1953523120, type=fd, bootable<br>
EOF<br>
#sfdisk /dev/sdg &lt; hdd.part<br>
#sfdisk /dev/sdh &lt; hdd.part<br>
#sfdisk /dev/sdi &lt; hdd.part<br>
#sfdisk /dev/sdj &lt; hdd.part<br>
#sfdisk /dev/sdk &lt; hdd.part<br>
#sfdisk /dev/sdl &lt; hdd.part<br>
#sfdisk /dev/sdm &lt; hdd.part<br>
#sfdisk /dev/sdn &lt; hdd.part<br>
</code><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SATAå›ºæ€ç¡¬ç›˜</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰æœ€æœ‰è¶£çš„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬æœ‰2 TBé©±åŠ¨å™¨ã€‚</font><font style="vertical-align: inherit;">è¿™åœ¨æˆ‘ä»¬å°†ä½¿ç”¨çš„MBRçš„å…è®¸é™åˆ¶å†…ã€‚</font><font style="vertical-align: inherit;">å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥ç”¨GPTä»£æ›¿ã€‚</font><font style="vertical-align: inherit;">GPTç£ç›˜å…·æœ‰ä¸€ä¸ªå…¼å®¹å±‚ï¼Œå¦‚æœä¸MBRå…¼å®¹çš„ç³»ç»Ÿä½äºå‰2 TBä¹‹å†…ï¼Œåˆ™å®ƒä»¬å¯ä»¥æŸ¥çœ‹å‰4ä¸ªåˆ†åŒºã€‚</font><font style="vertical-align: inherit;">æœ€ä¸»è¦çš„æ˜¯ï¼Œè¿™äº›ç£ç›˜ä¸Šçš„å¼•å¯¼åˆ†åŒºå’Œbios_grubåˆ†åŒºåº”ä½äºå¼€å¤´ã€‚</font><font style="vertical-align: inherit;">è¿™æ ·ï¼Œæ‚¨ç”šè‡³å¯ä»¥ä»GPTæ—§ç‰ˆ/ BIOSé©±åŠ¨å™¨å¯åŠ¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„æƒ…å†µã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ªéƒ¨åˆ†ã€‚</font><font style="vertical-align: inherit;">ç¬¬ä¸€ä¸ªå¤§å°ä¸º1 GBï¼Œç”¨äºRAID 1 /å¯åŠ¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¬¬äºŒä¸ªå°†ç”¨äºRAID 6ï¼Œå¹¶å ç”¨æ‰€æœ‰å‰©ä½™çš„å¯ç”¨ç©ºé—´ï¼Œä½†é©±åŠ¨å™¨æœ«ç«¯çš„æœªåˆ†é…åŒºåŸŸå¾ˆå°ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»€ä¹ˆæ˜¯æœªåˆ†é…åŒºåŸŸï¼Ÿ</font></font></b><div class="spoiler_text">     SATA SSD      SLC    6  78 . 6    Â«Â»     Â«Â»  Â«Â»   .  72      . <br>
<br>
  ,     SLC,      4 bit MLC.     ,    4       1  SLC .<br>
<br>
 72   4   288 .           ,       SLC .<br>
<br>
 ,     312  SLC     .    2    RAID  .<br>
<br>
            ,      .        QLC , â€”          .      , ,       ,    SSD     TBW  .<br>
</div></div><br>
<code>#cat &gt;ssd.part &lt;&lt; EOF<br>
label: dos<br>
label-id: 0x00000000<br>
device: /dev/sda<br>
unit: sectors<br>
<br>
/dev/sda1 : start= 2048, size= 2097152, type=fd, bootable<br>
/dev/sda2 : start= 2099200, size= 3300950016, type=fd<br>
EOF<br>
#sfdisk /dev/sda &lt; ssd.part<br>
#sfdisk /dev/sdb &lt; ssd.part<br>
#sfdisk /dev/sdc &lt; ssd.part<br>
#sfdisk /dev/sdd &lt; ssd.part<br>
#sfdisk /dev/sde &lt; ssd.part<br>
#sfdisk /dev/sdf &lt; ssd.part<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ›å»ºæ•°ç»„</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦é‡å‘½åæ±½è½¦ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºä¸»æœºåæ˜¯mdadmå†…éƒ¨æŸä¸ªä½ç½®çš„æ•°ç»„åç§°çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ä¼šå½±å“æŸä¸ªä½ç½®çš„æŸäº›å†…å®¹ã€‚</font><font style="vertical-align: inherit;">å½“ç„¶ï¼Œä»¥åå¯ä»¥é‡å‘½åæ•°ç»„ï¼Œä½†æ˜¯ï¼Œè¿™äº›éƒ½æ˜¯ä¸å¿…è¦çš„æ“ä½œã€‚</font></font><br>
<br>
<code>#mcedit /etc/hostname <br>
#mcedit /etc/hosts<br>
#hostname<br>
vdesk0<br>
</code><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NVMeå›ºæ€ç¡¬ç›˜</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md0 --level=1 --raid-devices=2 /dev/nvme[0-1]n1</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆ-å‡è®¾å¹²å‡€...ï¼Ÿ</font></font></b><div class="spoiler_text">   .    RAID 1  6  .      ,    .  ,   SSD   â€”     TBW.   TRIM/DISCARD      SSD   Â«Â».<br>
<br>
  SSD RAID 1 DISCARD   .<br>
<br>
  SSD RAID 6 DISCARD      . <br>
<br>
      ,    SSD     4/5/6       discard_zeroes_data.    ,       , , -,  ,     .       , ,       .     DISCARD -   RAID 6.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œä»¥ä¸‹å‘½ä»¤å°†é€šè¿‡ä½¿ç”¨â€œé›¶â€â€œåˆå§‹åŒ–â€é˜µåˆ—æ¥ç ´åNVMeé©±åŠ¨å™¨ä¸Šçš„æ‰€æœ‰æ•°æ®ã€‚</font></font><br>
<br>
<code>#blkdiscard /dev/md0</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœå‡ºç°é—®é¢˜ï¼Œè¯·å°è¯•æŒ‡å®šä¸€ä¸ªæ­¥éª¤ã€‚</font></font><br>
<br>
<code>#blkdiscard --step 65536 /dev/md0</code><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SATAå›ºæ€ç¡¬ç›˜</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md1 --level=1 --raid-devices=6 /dev/sd[a-f]1</code><br>
<code>#blkdiscard /dev/md1</code><br>
<code>#mdadm --create --verbose --assume-clean /dev/md2 --chunk-size=512 --level=6 --raid-devices=6 /dev/sd[a-f]2</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§...ï¼Ÿ</font></font></b><div class="spoiler_text"> chunk-size         chunk-size .   ,              . , IOPS    .   99% IO   512K.<br>
<br>
 RAID 6 IOPS   <b></b>    IOPS   .      IOPS          ,       . <br>
           RAID 6 by-design     ,   RAID 6   .<br>
   RAID 6      NVMe    thin-provisioning.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°šæœªä¸ºRAID 6å¯ç”¨DISCARDã€‚å› æ­¤ï¼Œæˆ‘ä»¬è¿˜ä¸ä¼šâ€œåˆå§‹åŒ–â€è¯¥é˜µåˆ—ã€‚</font><font style="vertical-align: inherit;">å®‰è£…æ“ä½œç³»ç»Ÿåï¼Œæˆ‘ä»¬å°†åœ¨ä»¥ååšã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SATAç¡¬ç›˜</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md3 --chunk-size=512 --level=6 --raid-devices=8 /dev/sd[g-n]1</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NVMe RAIDä¸Šçš„LVM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†æé«˜é€Ÿåº¦ï¼Œæˆ‘ä»¬å¸Œæœ›å°†æ ¹FSæ”¾åœ¨/ dev / md0çš„NVMe RAID 1ä¸Šã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦æ­¤å¿«é€Ÿé˜µåˆ—æ¥æ»¡è¶³å…¶ä»–éœ€æ±‚ï¼Œä¾‹å¦‚äº¤æ¢ï¼Œå…ƒæ•°æ®ä»¥åŠLVMé«˜é€Ÿç¼“å­˜å’ŒLVMè–„å‹å…ƒæ•°æ®ï¼Œå› æ­¤ï¼Œåœ¨æ­¤é˜µåˆ—ä¸Šï¼Œæˆ‘ä»¬å°†åˆ›å»ºLVM VGã€‚</font><font style="vertical-align: inherit;">
ä¸ºæ ¹FSåˆ›å»ºä¸€ä¸ªåˆ†åŒºã€‚</font><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªéƒ¨åˆ†ä»¥äº¤æ¢RAMçš„å¤§å°ã€‚</font></font><br>
<br>
<code>#pvcreate /dev/md0<br>
#vgcreate root /dev/md0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 128G --name root root</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 32G --name swap root</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ“ä½œç³»ç»Ÿå®‰è£…</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ€»ä½“è€Œè¨€ï¼Œæˆ‘ä»¬æ‹¥æœ‰å®‰è£…ç³»ç»Ÿæ‰€éœ€çš„ä¸€åˆ‡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»Ubuntu Liveç¯å¢ƒå¯åŠ¨å®‰è£…å‘å¯¼ã€‚</font><font style="vertical-align: inherit;">æ­£å¸¸å®‰è£…ã€‚</font><font style="vertical-align: inherit;">ä»…åœ¨é€‰æ‹©è¦å®‰è£…çš„é©±åŠ¨å™¨çš„é˜¶æ®µï¼Œæ‰éœ€è¦æŒ‡å®šä»¥ä¸‹å†…å®¹ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / md1ï¼Œ-æŒ‚è½½ç‚¹/å¯åŠ¨ï¼ŒFS-BTRFS </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / root / rootï¼ˆåˆå/ dev / mapper / root-rootï¼‰ï¼Œ-æŒ‚è½½ç‚¹/ï¼ˆrootï¼‰ï¼ŒFS-BTRFS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / root / swapï¼ˆaka / dev / mapper / root-swapï¼‰ï¼Œ-ç”¨ä½œäº¤æ¢åˆ†åŒº</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bootloaderå®‰è£…åœ¨/ dev / sda</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœé€‰æ‹©BTRFSä½œä¸ºæ ¹FSï¼Œå®‰è£…ç¨‹åºå°†è‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªBTRFSå·ï¼Œå…¶ä¸­/ï¼ˆæ ¹ï¼‰çš„åç§°ä¸ºâ€œ @â€ï¼Œ/ homeçš„åç§°ä¸ºâ€œ @homeâ€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å¼€å§‹å®‰è£…... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®‰è£…å°†ä»¥ä¸€ä¸ªæ¨¡å¼å¯¹è¯æ¡†ç»“æŸï¼Œé€šçŸ¥å¯åŠ¨åŠ è½½ç¨‹åºå®‰è£…é”™è¯¯ã€‚</font><font style="vertical-align: inherit;">ä¸å¹¸çš„æ˜¯ï¼Œé€šè¿‡å¸¸è§„æ–¹æ³•é€€å‡ºæ­¤å¯¹è¯å¹¶ç»§ç»­å®‰è£…å°†å¤±è´¥ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬é€€å‡ºç³»ç»Ÿï¼Œç„¶åå†æ¬¡ç™»å½•ï¼Œè¿›å…¥å¹²å‡€çš„Ubuntu Liveæ¡Œé¢ã€‚</font><font style="vertical-align: inherit;">æ‰“å¼€ç»ˆç«¯ï¼Œç„¶åå†æ¬¡æ‰“å¼€ï¼š</font></font><br>
<br>
<code>#sudo bash</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºchrootç¯å¢ƒä»¥ç»§ç»­å®‰è£…ï¼š</font><font style="vertical-align: inherit;">
åœ¨chrootä¸­</font><font style="vertical-align: inherit;">è®¾ç½®</font><font style="vertical-align: inherit;">ç½‘ç»œå’Œä¸»æœºåï¼š</font><font style="vertical-align: inherit;">
è½¬åˆ°chrootç¯å¢ƒï¼š</font><font style="vertical-align: inherit;">
é¦–å…ˆæˆ‘ä»¬äº¤ä»˜äº†è½¯ä»¶åŒ…ï¼š</font><font style="vertical-align: inherit;">
æ£€æŸ¥å¹¶ä¿®å¤ç”±äºç³»ç»Ÿå®‰è£…ä¸å®Œæ•´è€Œå¼¯æ›²çš„æ‰€æœ‰è½¯ä»¶åŒ…ï¼š</font></font><br>
<br>
<code>#mkdir /mnt/chroot<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard,subvol=@ /dev/mapper/root-root /mnt/chroot<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard,subvol=@home /dev/mapper/root-root /mnt/chroot/home<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard /dev/md1 /mnt/chroot/boot<br>
#mount --bind /proc /mnt/chroot/proc <br>
#mount --bind /sys /mnt/chroot/sys<br>
#mount --bind /dev /mnt/chroot/dev<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat /etc/hostname &gt;/mnt/chroot/etc/hostname<br>
#cat /etc/hosts &gt;/mnt/chroot/etc/hosts<br>
#cat /etc/resolv.conf &gt;/mnt/chroot/etc/resolv.conf<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#chroot /mnt/chroot<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>apt-get install --reinstall mdadm lvm2 thin-provisioning-tools btrfs-tools util-linux lsscsi nvme-cli mc debsums hdparm</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#CORRUPTED_PACKAGES=$(debsums -s 2&gt;&amp;1 | awk '{print $6}' | uniq)<br>
#apt-get install --reinstall $CORRUPTED_PACKAGES<br>
</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ²¡æœ‰ä¸€èµ·å‡ºç°ï¼Œåˆ™å¯èƒ½éœ€è¦å…ˆ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¼–è¾‘</font><font style="vertical-align: inherit;">/etc/apt/sources.listã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬æ›´æ”¹RAID 6æ¨¡å—çš„å‚æ•°ä»¥å¯ç”¨TRIM / DISCARDï¼šæˆ‘ä»¬å°†</font><font style="vertical-align: inherit;">
ç•¥å¾®è°ƒæ•´é˜µåˆ—ï¼š</font></font><br>
<br>
<code>#cat &gt;/etc/modprobe.d/raid456.conf &lt;&lt; EOF<br>
options raid456 devices_handle_discard_safely=1<br>
EOF<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat &gt;/etc/udev/rules.d/60-md.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/stripe_cache_size", ATTR{md/stripe_cache_size}="32768"<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/sync_speed_min", ATTR{md/sync_speed_min}="48000"<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/sync_speed_max", ATTR{md/sync_speed_max}="300000"<br>
EOF<br>
#cat &gt;/etc/udev/rules.d/62-hdparm.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", RUN+="/sbin/hdparm -B 254 /dev/%k"<br>
EOF<br>
#cat &gt;/etc/udev/rules.d/63-blockdev.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", RUN+="/sbin/blockdev --setra 1024 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="0", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="nvme[0-9]n1", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="dm-*", ATTR{queue/rotational}=="0", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="md*", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
<br>
EOF<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒä»¥å‰å¦‚ä½•..ï¼Ÿ</font></font></b><div class="spoiler_text">   udev     :<br>
<br>
<ul>
<li>    2020-      RAID 6.  -, ,      Linux,     .</li>
<li>    /   IO.  ,           .</li>
<li>    /   IO.  ,  / SSD RAID-       .    NVMe. (   ?    . )</li>
<li>   APM     (HDD)         7 .    APM      (-B 255).   -      .      ,   , ,  -.       .    -        .     , , - Â«Â»,    -,    RAID-   mini-MAID-.</li>
<li> readahead   ()  1  â€”   /chunk RAID 6</li>
<li> readahead  SATA SSD</li>
<li> readahead  NVMe SSD</li>
<li> readahead   LVM    SSD.</li>
<li> readahead   RAID .</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¼–è¾‘/ etc / fstabï¼š</font></font><br>
<br>
<code>#cat &gt;/etc/fstab &lt;&lt; EOF<br>
# /etc/fstab: static file system information.<br>
#<br>
# Use 'blkid' to print the universally unique identifier for a<br>
# device; this may be used with UUID= as a more robust way to name devices<br>
# that works even if disks are added and removed. See fstab(5).<br>
# file-system mount-point type options dump pass<br>
/dev/mapper/root-root / btrfs defaults,space_cache,noatime,nodiratime,discard,subvol=@ 0 1<br>
UUID=$(blkid -o value -s UUID /dev/md1) /boot btrfs defaults,space_cache,noatime,nodiratime,discard 0 2<br>
/dev/mapper/root-root /home btrfs defaults,space_cache,noatime,nodiratime,discard,subvol=@home 0 2<br>
/dev/mapper/root-swap none swap sw 0 0<br>
EOF</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ˜¯ä¸ºä»€ä¹ˆ..ï¼Ÿ</font></font></b><div class="spoiler_text"> /boot     UUID ..     .<br>
<br>
      LVM    /dev/mapper/vg-lv, ..     . <br>
<br>
  UUID  LVM .. UUID  LVM      .</div></div><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä¸¤æ¬¡æŒ‚è½½/ dev / mapper / root-root ..ï¼Ÿ</font></font></b><div class="spoiler_text">.  .  BTRFS.         subvol.<br>
<br>
  -      LVM   BTRFS .     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬é‡æ–°ç”Ÿæˆmdadmé…ç½®ï¼š</font><font style="vertical-align: inherit;">
æ›´æ­£LVMè®¾ç½®ï¼š</font></font><br>
<br>
<code>#/usr/share/mdadm/mkconf | sed 's/#DEVICE/DEVICE/g' &gt;/etc/mdadm/mdadm.conf<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat &gt;&gt;/etc/lvm/lvmlocal.conf &lt;&lt; EOF<br>
<br>
activation {<br>
 thin_pool_autoextend_threshold=90<br>
 thin_pool_autoextend_percent=5<br>
}<br>
allocation {<br>
 cache_pool_max_chunks=2097152<br>
}<br>
devices {<br>
 global_filter=["r|^/dev/.*_corig$|","r|^/dev/.*_cdata$|","r|^/dev/.*_cmeta$|","r|^/dev/.*gpv$|","r|^/dev/images/.*$|","r|^/dev/mapper/images.*$|","r|^/dev/backup/.*$|","r|^/dev/mapper/backup.*$|"]<br>
 issue_discards=1<br>
}<br>
EOF<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒä»¥å‰å¦‚ä½•..ï¼Ÿ</font></font></b><div class="spoiler_text">     LVM thin   90%    5%  .<br>
<br>
       LVM cache.<br>
<br>
  LVM  LVM  (PV) :<br>
<br>
<ul>
<li>   LVM cache (cdata)</li>
<li>     LVM cache    (&lt;lv_name&gt;_corig).            ( &lt;lv_name&gt;).</li>
<li>    LVM cache (cmeta)</li>
<li>    VG   images.        , ,     LVM       .</li>
<li>    VG   backup.         .</li>
<li>       Â«gpvÂ» ( guest physical volume )</li>
</ul><br>
   DISCARD      LVM VG.  .    LV  SSD  .     SSD RAID 6. ,  ,    thin provisioning,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ›´æ–°initramfsæ˜ åƒï¼š</font></font><br>
<br>
<code>#update-initramfs -u -k all</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®‰è£…å’Œé…ç½®grubï¼š</font></font><br>
<br>
<code>#apt-get install grub-pc<br>
#apt-get purge os-prober<br>
#dpkg-reconfigure grub-pc</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€‰æ‹©ä»€ä¹ˆé©±åŠ¨å™¨ï¼Ÿ</font></font></b><div class="spoiler_text">  sd*.         SATA   SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆè¦é’‰Os-prober ..ï¼Ÿ</font></font></b><div class="spoiler_text">     . <br>
<br>
       RAID-    .      ,         .<br>
<br>
   ,   , ,    .         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ ·ï¼Œæˆ‘ä»¬å®Œæˆäº†åˆå§‹å®‰è£…ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨è¯¥é‡å¯åˆ°æ–°å®‰è£…çš„æ“ä½œç³»ç»Ÿäº†ã€‚</font><font style="vertical-align: inherit;">åˆ‡è®°åˆ é™¤å¯å¯åŠ¨çš„Live CD / USBã€‚</font><font style="vertical-align: inherit;">
ä½œä¸ºè¦å¼•å¯¼çš„è®¾å¤‡ï¼Œè¯·é€‰æ‹©ä»»ä½•SATA SSDã€‚</font></font><br>
<br>
<code>#exit<br>
#reboot</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVMè½¬SATA SSD</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯åŠ¨åˆ°æ–°çš„æ“ä½œç³»ç»Ÿï¼Œé…ç½®äº†ç½‘ç»œï¼Œå®‰è£…äº†aptï¼Œæ‰“å¼€äº†ç»ˆç«¯ä»¿çœŸå™¨ï¼Œå¹¶å¼€å§‹äº†ï¼š</font></font><br>
<br>
<code>#sudo bash</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»§ç»­ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»SATA SSDâ€œåˆå§‹åŒ–â€é˜µåˆ—ï¼š</font></font><br>
<br>
<code>#blkdiscard /dev/md2</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ²¡æœ‰ï¼Œè¯·å°è¯•ï¼š</font></font><br>
<br>
<code>#blkdiscard --step 65536 /dev/md2</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨SATA SSDä¸Šåˆ›å»ºLVM VGï¼š</font></font><br>
<br>
<code>#pvcreate /dev/md2<br>
#vgcreate data /dev/md2</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆå¦ä¸€ä¸ªvg ..ï¼Ÿ</font></font></b><div class="spoiler_text">  ,     VG   root.        VG?<br>
<br>
  VG   PV,     VG  PV   (online).   LVM RAID,     .<br>
<br>
  ,    (  )    RAID 6           .<br>
<br>
 ,           Â«Â»   VG.<br>
<br>
 -,   RAID     Â« Â».         ,    VG.<br>
<br>
 LVM  Â«Â»        RAID  -  . , â€”  <b></b> bcache + LVM thin, bcache + BTRFS, LVM cache + LVM thin,   ZFS       ,      .<br>
<br>
 Â«Â»   ,  - Â«Â» LVM-,   .    , ,     .<br>
<br>
,   ,     -   .<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVMè½¬SATAç¡¬ç›˜</font></font></h3><br>
<code>#pvcreate /dev/md3<br>
#vgcreate backup /dev/md3</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆæ˜¯æ–°çš„VG ..ï¼Ÿ</font></font></b><div class="spoiler_text">  ,     ,        ,      , -     . , -   VG, â€”    VG.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é…ç½®LVMç¼“å­˜</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨NVMe RAID 1ä¸Šåˆ›å»ºLVï¼Œä»¥å°†å…¶ç”¨ä½œç¼“å­˜è®¾å¤‡ã€‚</font></font><br>
<br>
<code>#lvcreate -L 70871154688B --name cache root</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆè¿™ä¹ˆå°‘...ï¼Ÿ</font></font></b><div class="spoiler_text">  ,    NVMe SSD   SLC . 4  Â«Â»  18         3-bit MLC. -   NVMe SSD       SATA SSD  . ,        LVM cache      SLC  NVMe .   NVMe      32-64  . <br>
<br>
      64  ,       .<br>
<br>
 ,      LVM         .  ,       lvchange       . ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬åœ¨SATA RAID 6ä¸Šåˆ›å»ºLVï¼Œä»¥å°†å…¶ç”¨ä½œç¼“å­˜è®¾å¤‡ã€‚</font></font><br>
<br>
<code>#lvcreate -L 3298543271936B --name cache data</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆåªæœ‰3 TBå‘¢ï¼Ÿ</font></font></b><div class="spoiler_text">,  ,    SATA SSD RAID 6  -  .      ,  ,    .         , ,   LVM-cache , , bcache,  ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªæ–°çš„VGè¿›è¡Œç¼“å­˜ã€‚</font><font style="vertical-align: inherit;">
åœ¨ç¼“å­˜çš„è®¾å¤‡ä¸Šåˆ›å»ºLVã€‚</font><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç«‹å³å ç”¨äº†/ dev / data / cacheä¸Šçš„æ‰€æœ‰å¯ç”¨ç©ºé—´ï¼Œä»¥ä¾¿ç«‹å³åœ¨/ dev / root / cacheä¸Šåˆ›å»ºäº†æ‰€æœ‰å…¶ä»–å¿…è¦çš„åˆ†åŒºã€‚</font><font style="vertical-align: inherit;">å¦‚æœåœ¨é‚£é‡Œæ²¡æœ‰åˆ›å»ºä»»ä½•ä¸œè¥¿ï¼Œåˆ™å¯ä»¥ä½¿ç”¨pvmoveå°†å…¶ç§»åŠ¨ã€‚</font><font style="vertical-align: inherit;">
åˆ›å»ºå¹¶å¯ç”¨ç¼“å­˜ï¼š</font></font><br>
<br>
<code>#pvcreate /dev/root/cache<br>
#pvcreate /dev/data/cache<br>
#vgcreate cache /dev/root/cache /dev/data/cache</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 3298539077632B --name cachedata cache /dev/data/cache</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -y -L 64G -n cache cache /dev/root/cache<br>
#lvcreate -y -L 1G -n cachemeta cache /dev/root/cache<br>
#lvconvert -y --type cache-pool --cachemode writeback --chunksize 64k --poolmetadata cache/cachemeta cache/cache<br>
#lvconvert -y --type cache --cachepool cache/cache cache/cachedata<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤§å—..ï¼Ÿ</font></font></b><div class="spoiler_text">     ,        LVM cache     LVM thin.  ,   ,        . <br>
<br>
64 â€”       LVM thin.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨æ„å†™å›..ï¼</font></font></b><div class="spoiler_text">.         .    , ,    ,      .   ,  ,  NVMe RAID 1  ,    . <br>
<br>
    ,     RAID 6   .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬éªŒè¯æ˜¯å¦æˆåŠŸï¼š</font><font style="vertical-align: inherit;">
/ dev / data / cacheä¸Šåªèƒ½æ”¾ç½®[cachedata_corig]ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæœ‰é—®é¢˜ï¼Œè¯·ä½¿ç”¨pvmoveã€‚</font><font style="vertical-align: inherit;">
å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç¦ç”¨ç¼“å­˜ï¼š</font><font style="vertical-align: inherit;">
è¿™æ˜¯åœ¨çº¿å®Œæˆçš„ã€‚</font><font style="vertical-align: inherit;">LVMåªéœ€å°†ç¼“å­˜åŒæ­¥åˆ°ç£ç›˜ï¼Œå°†å…¶åˆ é™¤ï¼Œç„¶åå°†cachedata_corigé‡å‘½åä¸ºcachedataã€‚</font></font><br>
<br>
<code>#lvs -a -o lv_name,lv_size,devices --units B cache<br>
 LV LSize Devices <br>
 [cache] 68719476736B cache_cdata(0) <br>
 [cache_cdata] 68719476736B /dev/root/cache(0) <br>
 [cache_cmeta] 1073741824B /dev/root/cache(16384)<br>
 cachedata 3298539077632B cachedata_corig(0) <br>
 [cachedata_corig] 3298539077632B /dev/data/cache(0) <br>
 [lvol0_pmspare] 1073741824B /dev/root/cache(16640)<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvconvert -y --uncache cache/cachedata</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVMç²¾ç®€è®¾ç½®</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†ä¼°è®¡LVMç²¾ç®€å…ƒæ•°æ®å°†éœ€è¦å¤šå°‘ç©ºé—´</font><font style="vertical-align: inherit;">
ï¼šèˆå…¥</font><font style="vertical-align: inherit;">
åˆ°4 GBï¼š4294967296B </font><font style="vertical-align: inherit;">ä¹˜ä»¥2ï¼Œå¹¶ä¸ºLVMå…ƒæ•°æ®PVæ·»åŠ 4194304Bï¼š8594128896B </font><font style="vertical-align: inherit;">
åœ¨NVMe RAID 1ä¸Šåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„åˆ†åŒºï¼Œä»¥åœ¨å…¶ä¸Šæ ‡è®°LVMç²¾ç®€å…ƒæ•°æ®å¹¶å¯¹å…¶è¿›è¡Œå¤‡ä»½ï¼š</font></font><br>
<br>
<code>#thin_metadata_size --block-size=64k --pool-size=6terabytes --max-thins=100000 -u bytes<br>
thin_metadata_size - 3385794560 bytes estimated metadata area size for "--block-size=64kibibytes --pool-size=6terabytes --max-thins=100000"</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 8594128896B --name images root</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åšä»€ä¹ˆçš„..ï¼Ÿ</font></font></b><div class="spoiler_text">   ,    LVM thin ,        NVMe    .<br>
<br>
     ,     .    ,  ,   .    - , ,   LVM thin  ,      .         .<br>
<br>
-    -,  , ,          .             ,      .           .<br>
<br>
 ,        , ,  ,       , ,      LVM thin,        . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªæ–°çš„VGï¼Œå®ƒå°†è´Ÿè´£ç²¾ç®€é…ç½®ï¼š</font><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªæ± ï¼š</font></font><br>
<br>
<code>#pvcreate /dev/root/images<br>
#pvcreate /dev/cache/cachedata<br>
#vgcreate images /dev/root/images /dev/cache/cachedata</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 274877906944B --poolmetadataspare y --poolmetadatasize 4294967296B --chunksize 64k -Z y -T images/thin-pool</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºä»€ä¹ˆ-Z y</font></font></b><div class="spoiler_text"> ,       , â€”               , â€” zeroing          64k.    64k           64K    .          .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬</font><font style="vertical-align: inherit;">
å°†LVç§»è‡³ç›¸åº”çš„PVï¼š</font><font style="vertical-align: inherit;">æ£€æŸ¥ï¼š</font><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„ç²¾ç®€å·ï¼š</font><font style="vertical-align: inherit;">
æ”¾ç½®æµ‹è¯•å’Œè§‚å¯ŸåŒ…ï¼š</font><font style="vertical-align: inherit;">
è¿™æ˜¯æ‚¨å¯ä»¥å®æ—¶è§‚å¯Ÿå­˜å‚¨é…ç½®è¡Œä¸ºçš„æ–¹å¼ï¼š</font><font style="vertical-align: inherit;">
è¿™æ˜¯æ‚¨å¯ä»¥æµ‹è¯•é…ç½®çš„æ–¹å¼ï¼š</font></font><br>
<br>
<code>#pvmove -n images/thin-pool_tdata /dev/root/images /dev/cache/cachedata<br>
#pvmove -n images/lvol0_pmspare /dev/cache/cachedata /dev/root/images<br>
#pvmove -n images/thin-pool_tmeta /dev/cache/cachedata /dev/root/images <br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvs -a -o lv_name,lv_size,devices --units B images<br>
 LV LSize Devices <br>
 [lvol0_pmspare] 4294967296B /dev/root/images(0) <br>
 thin-pool 274877906944B thin-pool_tdata(0) <br>
 [thin-pool_tdata] 274877906944B /dev/cache/cachedata(0) <br>
 [thin-pool_tmeta] 4294967296B /dev/root/images(1024)<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -V 64G --thin-pool thin-pool --name test images</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#apt-get install sysstat fio</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#watch 'lvs --rows --reportformat basic --quiet -ocache_dirty_blocks,cache_settings cache/cachedata &amp;&amp; (lvdisplay cache/cachedata | grep Cache) &amp;&amp; (sar -p -d 2 1 | grep -E "sd|nvme|DEV|md1|md2|md3|md0" | grep -v Average | sort)'</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#fio --loops=1 --size=64G --runtime=4 --filename=/dev/images/test --stonewall --ioengine=libaio --direct=1 \<br>
--name=4kQD32read --bs=4k --iodepth=32 --rw=randread \<br>
--name=8kQD32read --bs=8k --iodepth=32 --rw=randread \<br>
--name=16kQD32read --bs=16k --iodepth=32 --rw=randread \<br>
--name=32KQD32read --bs=32k --iodepth=32 --rw=randread \<br>
--name=64KQD32read --bs=64k --iodepth=32 --rw=randread \<br>
--name=128KQD32read --bs=128k --iodepth=32 --rw=randread \<br>
--name=256KQD32read --bs=256k --iodepth=32 --rw=randread \<br>
--name=512KQD32read --bs=512k --iodepth=32 --rw=randread \<br>
--name=4Kread --bs=4k --rw=read \<br>
--name=8Kread --bs=8k --rw=read \<br>
--name=16Kread --bs=16k --rw=read \<br>
--name=32Kread --bs=32k --rw=read \<br>
--name=64Kread --bs=64k --rw=read \<br>
--name=128Kread --bs=128k --rw=read \<br>
--name=256Kread --bs=256k --rw=read \<br>
--name=512Kread --bs=512k --rw=read \<br>
--name=Seqread --bs=1m --rw=read \<br>
--name=Longread --bs=8m --rw=read \<br>
--name=Longwrite --bs=8m --rw=write \<br>
--name=Seqwrite --bs=1m --rw=write \<br>
--name=512Kwrite --bs=512k --rw=write \<br>
--name=256Kwrite --bs=256k --rw=write \<br>
--name=128Kwrite --bs=128k --rw=write \<br>
--name=64Kwrite --bs=64k --rw=write \<br>
--name=32Kwrite --bs=32k --rw=write \<br>
--name=16Kwrite --bs=16k --rw=write \<br>
--name=8Kwrite --bs=8k --rw=write \<br>
--name=4Kwrite --bs=4k --rw=write \<br>
--name=512KQD32write --bs=512k --iodepth=32 --rw=randwrite \<br>
--name=256KQD32write --bs=256k --iodepth=32 --rw=randwrite \<br>
--name=128KQD32write --bs=128k --iodepth=32 --rw=randwrite \<br>
--name=64KQD32write --bs=64k --iodepth=32 --rw=randwrite \<br>
--name=32KQD32write --bs=32k --iodepth=32 --rw=randwrite \<br>
--name=16KQD32write --bs=16k --iodepth=32 --rw=randwrite \<br>
--name=8KQD32write --bs=8k --iodepth=32 --rw=randwrite \<br>
--name=4kQD32write --bs=4k --iodepth=32 --rw=randwrite \<br>
 | grep -E 'read|write|test' | grep -v ioengine<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è­¦å‘Šï¼</font><font style="vertical-align: inherit;">èµ„æºï¼</font></font></b><div class="spoiler_text">   36  ,       4 .     .  4   NVMe     .  3   .  ,           216   SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯»å’Œå†™éšæœºæ’­æ”¾ï¼Ÿ</font></font></b><div class="spoiler_text">.          .  ,   ,    ,        .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
éšç€ç¼“å­˜å’Œç²¾ç®€å·çš„å¡«æ»¡ï¼Œç»“æœå°†åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶å’Œéšåçš„ç»“æœä¸­æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œå¹¶ä¸”è¿˜å–å†³äºç³»ç»Ÿæ˜¯å¦è®¾æ³•åŒæ­¥ä¸Šæ¬¡å¯åŠ¨æ—¶å¡«å……çš„ç¼“å­˜ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é™¤å…¶ä»–å¤–ï¼Œæˆ‘å»ºè®®æµ‹é‡åˆšåˆšä»ä¸­åˆ›å»ºå¿«ç…§çš„å·²å¡«å……ç²¾ç®€å·çš„é€Ÿåº¦ã€‚</font><font style="vertical-align: inherit;">ä½œè€…æœ‰æœºä¼šè§‚å¯Ÿåˆ°åœ¨åˆ›å»ºç¬¬ä¸€ä¸ªå¿«ç…§åç«‹å³éšæœºè®°å½•å¦‚ä½•æ€¥å‰§åŠ é€Ÿï¼Œå°¤å…¶æ˜¯åœ¨ç¼“å­˜å°šæœªæ»¡æ—¶ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ç”±äºå†™å…¥æ—¶çš„å†™æ—¶å¤åˆ¶è¯­ä¹‰ï¼Œç¼“å­˜å—å’Œç²¾ç®€å·çš„å¯¹é½ä»¥åŠå¯¹RAID 6çš„éšæœºå†™å…¥å˜æˆä»RAID 6éšæœºè¯»å–ç„¶åå†™å…¥ç¼“å­˜çš„äº‹å®ã€‚</font><font style="vertical-align: inherit;">åœ¨æˆ‘ä»¬çš„é…ç½®ä¸­ï¼Œä»RAID 6éšæœºè¯»å–æœ€å¤š6æ¬¡ï¼ˆé˜µåˆ—ä¸­SATA SSDçš„æ•°é‡ï¼‰æ¯”å†™å…¥è¦å¿«ã€‚</font><font style="vertical-align: inherit;">å› ä¸º </font><font style="vertical-align: inherit;">ç”±äºCoWå—æ˜¯ä»ç²¾ç®€æ± ä¸­æŒ‰é¡ºåºåˆ†é…çš„ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¯¥è®°å½•ä¹Ÿå°†å˜æˆé¡ºåºçš„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯ä»¥æœ‰åˆ©åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªç‰¹å¾ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼“å­˜â€œè¿è´¯â€å¿«ç…§</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†å‡å°‘åœ¨ç¼“å­˜æŸå/ä¸¢å¤±çš„æƒ…å†µä¸‹æ•°æ®ä¸¢å¤±çš„é£é™©ï¼Œä½œè€…å»ºè®®é‡‡ç”¨æ—‹è½¬å¿«ç…§çš„åšæ³•ï¼Œä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ä¿è¯å…¶å®Œæ•´æ€§ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œç”±äºç²¾ç®€å·çš„å…ƒæ•°æ®ä½äºæœªç¼“å­˜çš„è®¾å¤‡ä¸Šï¼Œå› æ­¤å…ƒæ•°æ®å°†ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸”å¯èƒ½çš„æŸå¤±å°†åœ¨æ•°æ®å—å†…éƒ¨éš”ç¦»ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹å¿«ç…§å¾ªç¯å‘¨æœŸå¯ç¡®ä¿åœ¨ç¼“å­˜ä¸¢å¤±çš„æƒ…å†µä¸‹å¿«ç…§å†…éƒ¨çš„æ•°æ®å®Œæ•´æ€§ï¼š</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºæ¯ä¸ªåç§°ä¸º&lt;name&gt;çš„ç²¾ç®€å·ï¼Œè¯·åˆ›å»ºä¸€ä¸ªåç§°ä¸º&lt;name&gt; .cachedçš„å¿«ç…§ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†è¿ç§»é˜ˆå€¼è®¾ç½®ä¸ºåˆç†çš„é«˜å€¼ï¼š </font></font><code>#lvchange --quiet --cachesettings "migration_threshold=16384" cache/cachedata</code> </li>
<li>       : <code>#lvs --rows --reportformat basic --quiet -ocache_dirty_blocks cache/cachedata | awk '{print $2}'</code>    .     ,        writethrough . ,      SATA  NVMe SSD,  ,   TBW,            ,           . -          100%    .  NVMe SSD  100%        <b>3-4 </b>. SATA SSD  -    . ,   ,       ,     , â€”             .</li>
<li>   ( )  â€”  &lt;&gt;.cached  &lt;&gt;.committed.  &lt;&gt;.committed   .</li>
<li>,     100%,    ,   .         .</li>
<li> migration threshold  : <code>#lvchange --quiet --cachesettings "migration_threshold=0" cache/cachedata</code>        . </li>
<li>,        <code>#lvs --rows --reportformat basic --quiet -ocache_dirty_blocks cache/cachedata | awk '{print $2}'</code>   .</li>
<li> . </li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">   migration threshold...?</b><div class="spoiler_text">   ,     Â«Â»       .    -    4 ,   ,         -     (+- 32K) .<br>
<br>
 migration threshold        SATA SSD       64K  .      SATA SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">  ..?</b><div class="spoiler_text"> ,         bash     100%    Â«googleÂ»-driven development,  ,    ,      ,     .<br>
<br>
,               , ,  ,      systemd ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ­¤ç®€å•çš„å¿«ç…§è½®æ¢æ–¹æ¡ˆå°†ä½¿æˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿåœ¨SATA SSDä¸ŠæŒç»­ä¸æ–­åœ°å®Œå…¨åŒæ­¥ä¸€ä¸ªå¿«ç…§ï¼Œè€Œä¸”è¿˜ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨thin_deltaå®ç”¨å·¥å…·æ‰¾å‡ºåœ¨åˆ›å»ºåæ›´æ”¹äº†å“ªäº›å—ï¼Œä»è€Œåœ¨ä¸»å·ä¸Šå®šä½æŸåï¼Œä»è€Œå¤§å¤§ç®€åŒ–äº†æ¢å¤ã€‚ ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> libvirt / KVMä¸­çš„TRIM / DISCARD</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› ä¸º </font><font style="vertical-align: inherit;">ç”±äºæ•°æ®ä»“åº“å°†ç”¨äºè¿è¡Œlibvirtçš„KVMï¼Œå› æ­¤æœ€å¥½æ•™æˆ‘ä»¬çš„VMä¸ä»…è¦å ç”¨å¯ç”¨ç©ºé—´ï¼Œè¿˜è¦é‡Šæ”¾ä¸å†éœ€è¦çš„ç©ºé—´ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ˜¯é€šè¿‡åœ¨è™šæ‹Ÿç£ç›˜ä¸Šæ¨¡æ‹ŸTRIM / DISCARDæ”¯æŒæ¥å®Œæˆçš„ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œè¯·å°†æ§åˆ¶å™¨ç±»å‹æ›´æ”¹ä¸ºvirtio-scsiå¹¶ç¼–è¾‘xmlã€‚</font><font style="vertical-align: inherit;">
LVMå¯ä»¥æ­£ç¡®å¤„ç†æ¥è‡ªæ¥å®¾æ“ä½œç³»ç»Ÿçš„ç±»ä¼¼DISCARDï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç¼“å­˜å’Œç²¾ç®€æ± ä¸­æ­£ç¡®é‡Šæ”¾å—ã€‚</font><font style="vertical-align: inherit;">åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æƒ…å†µä¸»è¦æ˜¯åœ¨åˆ é™¤ä¸‹ä¸€ä¸ªå¿«ç…§æ—¶è¢«æ¨è¿Ÿäº†ã€‚</font></font><br>
<br>
<code>#virsh edit vmname<br>
&lt;disk type='block' device='disk'&gt;<br>
 &lt;driver name='qemu' type='raw' cache='writethrough' io='threads' <b>discard='unmap'</b>/&gt;<br>
 &lt;source dev='/dev/images/vmname'/&gt;<br>
 &lt;backingStore/&gt;<br>
 &lt;target dev='sda' bus='scsi'/&gt;<br>
 &lt;alias name='scsi0-0-0-0'/&gt;<br>
 &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;<br>
&lt;/disk&gt;<br>
<br>
&lt;controller type='scsi' index='0' <b>model='virtio-scsi'</b>&gt;<br>
 &lt;alias name='scsi0'/&gt;<br>
 &lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;<br>
&lt;/controller&gt;<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BTRFSå¤‡ä»½</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½¿ç”¨ç°æˆçš„è„šæœ¬æ—¶è¦</font></font><u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ¼å¤–</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è°¨æ…ï¼Œ</font></font><u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åæœè‡ªè´Ÿ</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä½œè€…äº²è‡ªä¸ºè‡ªå·±ç¼–å†™äº†æ­¤ä»£ç ã€‚</font><font style="vertical-align: inherit;">æˆ‘ç¡®ä¿¡è®¸å¤šç»éªŒä¸°å¯Œçš„Linuxç”¨æˆ·éƒ½å…·æœ‰è¿™æ ·</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»éªŒï¼Œä¸éœ€è¦å¤åˆ¶å…¶ä»–äººã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å¤‡ä»½è®¾å¤‡ä¸Šåˆ›å»ºå·ï¼š</font></font><br>
<br>
<code>#lvcreate -L 256G --name backup backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨BTRFSä¸­å¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–ï¼š</font></font><br>
<br>
<code>#mkfs.btrfs /dev/backup/backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºFSçš„å®‰è£…ç‚¹å¹¶å®‰è£…æ ¹å­é”®ï¼š</font><font style="vertical-align: inherit;">
åˆ›å»ºå¤‡ä»½</font><font style="vertical-align: inherit;">
ç›®å½•ï¼šä¸ºå¤‡ä»½è„šæœ¬åˆ›å»ºç›®å½•ï¼šå¤åˆ¶</font><font style="vertical-align: inherit;">
è„šæœ¬ï¼š</font></font><br>
<br>
<code>#mkdir /backup<br>
#mkdir /backup/btrfs<br>
#mkdir /backup/btrfs/root<br>
#mkdir /backup/btrfs/back<br>
#ln -s /boot /backup/btrfs<br>
# cat &gt;&gt;/etc/fstab &lt;&lt; EOF<br>
<br>
/dev/mapper/root-root /backup/btrfs/root btrfs defaults,space_cache,noatime,nodiratime 0 2<br>
/dev/mapper/backup-backup /backup/btrfs/back btrfs defaults,space_cache,noatime,nodiratime 0 2<br>
EOF<br>
#mount -a<br>
#update-initramfs -u<br>
#update-grub<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#mkdir /backup/btrfs/back/remote<br>
#mkdir /backup/btrfs/back/remote/root<br>
#mkdir /backup/btrfs/back/remote/boot<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#mkdir /root/btrfs-backup</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¾ˆå¤šå¯æ€•çš„bashä»£ç ã€‚</font><font style="vertical-align: inherit;">ä½¿ç”¨é£é™©è‡ªè´Ÿã€‚</font><font style="vertical-align: inherit;">ä½œè€…ä¸å†™ç”Ÿæ°”çš„ä¿¡...</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/btrfs-backup/btrfs-backup.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
LOCK_FILE="/dev/shm/$SCRIPT_NAME.lock"<br>
DATE_PREFIX='%Y-%m-%d'<br>
DATE_FORMAT=$DATE_PREFIX'-%H-%M-%S'<br>
DATE_REGEX='[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]'<br>
BASE_SUFFIX=".@base"<br>
PEND_SUFFIX=".@pend"<br>
SNAP_SUFFIX=".@snap"<br>
MOUNTS="/backup/btrfs/"<br>
BACKUPS="/backup/btrfs/back/remote/"<br>
<br>
function terminate ()<br>
{<br>
 echo "$1" &gt;&amp;2<br>
 exit 1<br>
}<br>
<br>
function wait_lock()<br>
{<br>
 flock 98<br>
}<br>
<br>
function wait_lock_or_terminate()<br>
{<br>
 echo "Wating for lock..."<br>
 wait_lock || terminate "Failed to get lock. Exiting..."<br>
 echo "Got lock..."<br>
}<br>
<br>
function suffix()<br>
{<br>
 FORMATTED_DATE=$(date +"$DATE_FORMAT")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function filter()<br>
{<br>
 FORMATTED_DATE=$(date --date="$1" +"$DATE_PREFIX")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function backup()<br>
{<br>
SOURCE_PATH="$MOUNTS$1"<br>
TARGET_PATH="$BACKUPS$1"<br>
SOURCE_BASE_PATH="$MOUNTS$1$BASE_SUFFIX"<br>
TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
TARGET_BASE_DIR="$(dirname $TARGET_BASE_PATH)"<br>
SOURCE_PEND_PATH="$MOUNTS$1$PEND_SUFFIX"<br>
TARGET_PEND_PATH="$BACKUPS$1$PEND_SUFFIX"<br>
 if [ -d "$SOURCE_BASE_PATH" ]<br>
 then<br>
 echo "$SOURCE_BASE_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_PATH File not found creating snapshot of $SOURCE_PATH to $SOURCE_BASE_PATH"<br>
 btrfs subvolume snapshot -r $SOURCE_PATH $SOURCE_BASE_PATH<br>
 sync<br>
 if [ -d "$TARGET_BASE_PATH" ]<br>
 then<br>
 echo "$TARGET_BASE_PATH found out of sync with source... removing..."<br>
 btrfs subvolume delete -c $TARGET_BASE_PATH<br>
 sync<br>
 fi<br>
 fi<br>
 if [ -d "$TARGET_BASE_PATH" ]<br>
 then<br>
 echo "$TARGET_BASE_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_PATH not found. Synching to $TARGET_BASE_DIR"<br>
 btrfs send $SOURCE_BASE_PATH | btrfs receive $TARGET_BASE_DIR<br>
 sync<br>
 fi<br>
 if [ -d "$SOURCE_PEND_PATH" ]<br>
 then<br>
 echo "$SOURCE_PEND_PATH found removing..."<br>
 btrfs subvolume delete -c $SOURCE_PEND_PATH<br>
 sync<br>
 fi<br>
 btrfs subvolume snapshot -r $SOURCE_PATH $SOURCE_PEND_PATH<br>
 sync<br>
 if [ -d "$TARGET_PEND_PATH" ]<br>
 then<br>
 echo "$TARGET_PEND_PATH found removing..."<br>
 btrfs subvolume delete -c $TARGET_PEND_PATH<br>
 sync<br>
 fi<br>
 echo "Sending $SOURCE_PEND_PATH to $TARGET_PEND_PATH"<br>
 btrfs send -p $SOURCE_BASE_PATH $SOURCE_PEND_PATH | btrfs receive $TARGET_BASE_DIR<br>
 sync<br>
 TARGET_DATE_SUFFIX=$(suffix)<br>
 btrfs subvolume snapshot -r $TARGET_PEND_PATH "$TARGET_PATH$TARGET_DATE_SUFFIX"<br>
 sync<br>
 btrfs subvolume delete -c $SOURCE_BASE_PATH<br>
 sync<br>
 btrfs subvolume delete -c $TARGET_BASE_PATH<br>
 sync<br>
 mv $SOURCE_PEND_PATH $SOURCE_BASE_PATH<br>
 mv $TARGET_PEND_PATH $TARGET_BASE_PATH<br>
 sync<br>
}<br>
<br>
function list()<br>
{<br>
LIST_TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
LIST_TARGET_BASE_DIR="$(dirname $LIST_TARGET_BASE_PATH)"<br>
LIST_TARGET_BASE_NAME="$(basename -s .$BASE_SUFFIX $LIST_TARGET_BASE_PATH)"<br>
find "$LIST_TARGET_BASE_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | grep "${LIST_TARGET_BASE_NAME/$BASE_SUFFIX/$SNAP_SUFFIX}.$DATE_REGEX"<br>
}<br>
<br>
function remove()<br>
{<br>
REMOVE_TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
REMOVE_TARGET_BASE_DIR="$(dirname $REMOVE_TARGET_BASE_PATH)"<br>
btrfs subvolume delete -c $REMOVE_TARGET_BASE_DIR/$2<br>
sync<br>
}<br>
<br>
function removeall()<br>
{<br>
DATE_OFFSET="$2"<br>
FILTER="$(filter "$DATE_OFFSET")"<br>
while read -r SNAPSHOT ; do<br>
 remove "$1" "$SNAPSHOT"<br>
done &lt; &lt;(list "$1" | grep "$FILTER")<br>
<br>
}<br>
<br>
(<br>
 COMMAND="$1"<br>
 shift<br>
 <br>
 case "$COMMAND" in<br>
 "--help") <br>
 echo "Help"<br>
 ;;<br>
 "suffix") <br>
 suffix<br>
 ;;<br>
 "filter") <br>
 filter "$1"<br>
 ;;<br>
 "backup") <br>
 wait_lock_or_terminate<br>
 backup "$1"<br>
 ;;<br>
 "list") <br>
 list "$1"<br>
 ;;<br>
 "remove") <br>
 wait_lock_or_terminate<br>
 remove "$1" "$2"<br>
 ;;<br>
 "removeall") <br>
 wait_lock_or_terminate<br>
 removeall "$1" "$2"<br>
 ;;<br>
 *)<br>
 echo "None.."<br>
 ;;<br>
 esac<br>
) 98&gt;$LOCK_FILE <br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒç”šè‡³åšä»€ä¹ˆ..ï¼Ÿ</font></font></b><div class="spoiler_text">       BTRFS        BTRFS send/recieve.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¬¬ä¸€æ¬¡å¯åŠ¨å¯èƒ½ä¼šç›¸å¯¹è¾ƒé•¿ï¼Œå› ä¸º </font><font style="vertical-align: inherit;">åœ¨å¼€å§‹æ—¶ï¼Œå°†å¤åˆ¶æ‰€æœ‰æ•°æ®ã€‚</font><font style="vertical-align: inherit;">è¿›ä¸€æ­¥çš„å‘å°„å°†éå¸¸å¿«ï¼Œå› ä¸º </font><font style="vertical-align: inherit;">ä»…æ›´æ”¹å°†è¢«å¤åˆ¶ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦ä¸€ä¸ªè½½å…¥cronçš„è„šæœ¬ï¼š</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€äº›bashä»£ç </font></font></b><div class="spoiler_text"><code>#cat &gt;/root/btrfs-backup/cron-daily.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
BACKUP_SCRIPT="$SCRIPT_DIR/btrfs-backup.sh"<br>
RETENTION="-60 day"<br>
$BACKUP_SCRIPT backup root/@<br>
$BACKUP_SCRIPT removeall root/@ "$RETENTION"<br>
$BACKUP_SCRIPT backup root/@home<br>
$BACKUP_SCRIPT removeall root/@home "$RETENTION"<br>
$BACKUP_SCRIPT backup boot/<br>
$BACKUP_SCRIPT removeall boot/ "$RETENTION"<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒåœ¨åšä»€ä¹ˆ..ï¼Ÿ</font></font></b><div class="spoiler_text">     backup     BTRFS-.       60  .     /backup/btrfs/back/remote/     . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬èµ‹äºˆä»£ç æ‰§è¡Œæƒï¼š</font><font style="vertical-align: inherit;">
æ£€æŸ¥å¹¶æŒ¤å…¥é¡¶éƒ¨ï¼š</font></font><br>
<br>
<code>#chmod +x /root/btrfs-backup/cron-daily.sh<br>
#chmod +x /root/btrfs-backup/btrfs-backup.sh<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#/usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/btrfs-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t btrfs-backup<br>
#cat /var/log/syslog | grep btrfs-backup<br>
#crontab -e<br>
0 2 * * * /usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/btrfs-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t btrfs-backup<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVMç²¾ç®€å¤‡ä»½</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å¤‡ä»½è®¾å¤‡ä¸Šåˆ›å»ºç²¾ç®€æ± ï¼š</font></font><br>
<br>
<code>#lvcreate -L 274877906944B --poolmetadataspare y --poolmetadatasize 4294967296B --chunksize 64k -Z y -T backup/thin-pool</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®‰è£…ddrescueï¼Œå› ä¸º </font><font style="vertical-align: inherit;">è„šæœ¬å°†ä½¿ç”¨æ­¤å·¥å…·ï¼š</font></font><br>
<br>
<code>#apt-get install gddrescue</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºè„šæœ¬åˆ›å»ºç›®å½•ï¼š</font></font><br>
<br>
<code>#mkdir /root/lvm-thin-backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤åˆ¶è„šæœ¬ï¼š</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡Œé¢æœ‰å¾ˆå¤šé‡å‡»...</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/lvm-thin-backup/lvm-thin-backup.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
LOCK_FILE="/dev/shm/$SCRIPT_NAME.lock"<br>
DATE_PREFIX='%Y-%m-%d'<br>
DATE_FORMAT=$DATE_PREFIX'-%H-%M-%S'<br>
DATE_REGEX='[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]'<br>
BASE_SUFFIX=".base"<br>
PEND_SUFFIX=".pend"<br>
SNAP_SUFFIX=".snap"<br>
BACKUPS="backup"<br>
BACKUPS_POOL="thin-pool"<br>
<br>
export LVM_SUPPRESS_FD_WARNINGS=1<br>
<br>
function terminate ()<br>
{<br>
 echo "$1" &gt;&amp;2<br>
 exit 1<br>
}<br>
<br>
function wait_lock()<br>
{<br>
 flock 98<br>
}<br>
<br>
function wait_lock_or_terminate()<br>
{<br>
 echo "Wating for lock..."<br>
 wait_lock || terminate "Failed to get lock. Exiting..."<br>
 echo "Got lock..."<br>
}<br>
<br>
function suffix()<br>
{<br>
 FORMATTED_DATE=$(date +"$DATE_FORMAT")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function filter()<br>
{<br>
 FORMATTED_DATE=$(date --date="$1" +"$DATE_PREFIX")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function read_thin_id {<br>
lvs --rows --reportformat basic --quiet -othin_id "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_pool_lv {<br>
lvs --rows --reportformat basic --quiet -opool_lv "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_dm_path {<br>
lvs --rows --reportformat basic --quiet -olv_dm_path "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_active {<br>
lvs --rows --reportformat basic --quiet -olv_active "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_chunk_size {<br>
lvs --rows --reportformat basic --quiet --units b --nosuffix -ochunk_size "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_size {<br>
lvs --rows --reportformat basic --quiet --units b --nosuffix -olv_size "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function activate_volume {<br>
lvchange -ay -Ky "$1/$2"<br>
}<br>
<br>
function deactivate_volume {<br>
lvchange -an "$1/$2"<br>
}<br>
<br>
function read_thin_metadata_snap {<br>
dmsetup status "$1" | awk '{print $7}'<br>
}<br>
<br>
function thindiff()<br>
{<br>
DIFF_VG="$1"<br>
DIFF_SOURCE="$2"<br>
DIFF_TARGET="$3"<br>
DIFF_SOURCE_POOL=$(read_pool_lv $DIFF_VG $DIFF_SOURCE)<br>
DIFF_TARGET_POOL=$(read_pool_lv $DIFF_VG $DIFF_TARGET)<br>
<br>
if [ "$DIFF_SOURCE_POOL" == "" ]<br>
then<br>
 (&gt;&amp;2 echo "Source LV is not thin.")<br>
 exit 1<br>
fi<br>
<br>
if [ "$DIFF_TARGET_POOL" == "" ]<br>
then<br>
 (&gt;&amp;2 echo "Target LV is not thin.")<br>
 exit 1<br>
fi<br>
<br>
if [ "$DIFF_SOURCE_POOL" != "$DIFF_TARGET_POOL" ]<br>
then<br>
 (&gt;&amp;2 echo "Source and target LVs belong to different thin pools.")<br>
 exit 1<br>
fi<br>
<br>
DIFF_POOL_PATH=$(read_lv_dm_path $DIFF_VG $DIFF_SOURCE_POOL)<br>
DIFF_SOURCE_ID=$(read_thin_id $DIFF_VG $DIFF_SOURCE)<br>
DIFF_TARGET_ID=$(read_thin_id $DIFF_VG $DIFF_TARGET)<br>
DIFF_POOL_PATH_TPOOL="$DIFF_POOL_PATH-tpool"<br>
DIFF_POOL_PATH_TMETA="$DIFF_POOL_PATH"_tmeta<br>
DIFF_POOL_METADATA_SNAP=$(read_thin_metadata_snap $DIFF_POOL_PATH_TPOOL)<br>
<br>
if [ "$DIFF_POOL_METADATA_SNAP" != "-" ]<br>
then<br>
 (&gt;&amp;2 echo "Thin pool metadata snapshot already exist. Assuming stale one. Will release metadata snapshot in 5 seconds.")<br>
 sleep 5<br>
 dmsetup message $DIFF_POOL_PATH_TPOOL 0 release_metadata_snap<br>
fi<br>
<br>
dmsetup message $DIFF_POOL_PATH_TPOOL 0 reserve_metadata_snap<br>
DIFF_POOL_METADATA_SNAP=$(read_thin_metadata_snap $DIFF_POOL_PATH_TPOOL)<br>
<br>
if [ "$DIFF_POOL_METADATA_SNAP" == "-" ]<br>
then<br>
 (&gt;&amp;2 echo "Failed to create thin pool metadata snapshot.")<br>
 exit 1<br>
fi<br>
<br>
#We keep output in variable because metadata snapshot need to be released early.<br>
DIFF_DATA=$(thin_delta -m$DIFF_POOL_METADATA_SNAP --snap1 $DIFF_SOURCE_ID --snap2 $DIFF_TARGET_ID $DIFF_POOL_PATH_TMETA)<br>
<br>
dmsetup message $DIFF_POOL_PATH_TPOOL 0 release_metadata_snap<br>
<br>
echo $"$DIFF_DATA" | grep -E 'different|left_only|right_only' | sed 's/&lt;/"/g' | sed 's/ /"/g' | awk -F'\"' '{print $6 "\t" $8 "\t" $11}' | sed 's/different/copy/g' | sed 's/left_only/copy/g' | sed 's/right_only/discard/g'<br>
<br>
}<br>
<br>
function thinsync()<br>
{<br>
SYNC_VG="$1"<br>
SYNC_PEND="$2"<br>
SYNC_BASE="$3"<br>
SYNC_TARGET="$4"<br>
SYNC_PEND_POOL=$(read_pool_lv $SYNC_VG $SYNC_PEND)<br>
SYNC_BLOCK_SIZE=$(read_lv_chunk_size $SYNC_VG $SYNC_PEND_POOL)<br>
SYNC_PEND_PATH=$(read_lv_dm_path $SYNC_VG $SYNC_PEND)<br>
<br>
activate_volume $SYNC_VG $SYNC_PEND<br>
<br>
while read -r SYNC_ACTION SYNC_OFFSET SYNC_LENGTH ; do<br>
 SYNC_OFFSET_BYTES=$((SYNC_OFFSET * SYNC_BLOCK_SIZE))<br>
 SYNC_LENGTH_BYTES=$((SYNC_LENGTH * SYNC_BLOCK_SIZE))<br>
 if [ "$SYNC_ACTION" == "copy" ]<br>
 then<br>
 ddrescue --quiet --force --input-position=$SYNC_OFFSET_BYTES --output-position=$SYNC_OFFSET_BYTES --size=$SYNC_LENGTH_BYTES "$SYNC_PEND_PATH" "$SYNC_TARGET"<br>
 fi<br>
<br>
if [ "$SYNC_ACTION" == "discard" ]<br>
 then<br>
 blkdiscard -o $SYNC_OFFSET_BYTES -l $SYNC_LENGTH_BYTES "$SYNC_TARGET"<br>
 fi<br>
done &lt; &lt;(thindiff "$SYNC_VG" "$SYNC_PEND" "$SYNC_BASE")<br>
}<br>
<br>
function discard_volume()<br>
{<br>
DISCARD_VG="$1"<br>
DISCARD_LV="$2"<br>
DISCARD_LV_PATH=$(read_lv_dm_path "$DISCARD_VG" "$DISCARD_LV")<br>
if [ "$DISCARD_LV_PATH" != "" ]<br>
then<br>
 echo "$DISCARD_LV_PATH found"<br>
else<br>
 echo "$DISCARD_LV not found in $DISCARD_VG"<br>
 exit 1<br>
fi<br>
DISCARD_LV_POOL=$(read_pool_lv $DISCARD_VG $DISCARD_LV)<br>
DISCARD_LV_SIZE=$(read_lv_size "$DISCARD_VG" "$DISCARD_LV")<br>
lvremove -y --quiet "$DISCARD_LV_PATH" || exit 1<br>
lvcreate --thin-pool "$DISCARD_LV_POOL" -V "$DISCARD_LV_SIZE"B --name "$DISCARD_LV" "$DISCARD_VG" || exit 1<br>
}<br>
<br>
function backup()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
SOURCE_PEND_LV="$SOURCE_LV$PEND_SUFFIX"<br>
TARGET_PEND_LV="$TARGET_LV$PEND_SUFFIX"<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
SOURCE_PEND_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
TARGET_PEND_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_PEND_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "Source base not found creating snapshot of $SOURCE_VG/$SOURCE_LV to $SOURCE_VG/$SOURCE_BASE_LV"<br>
 lvcreate --quiet --snapshot --name "$SOURCE_BASE_LV" "$SOURCE_VG/$SOURCE_LV" || exit 1<br>
 SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 echo "Discarding $SOURCE_BASE_LV_PATH as we need to bootstrap."<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SOURCE_BASE_CHUNK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
 discard_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 sync<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found out of sync with source... removing..."<br>
 lvremove -y --quiet $TARGET_BASE_LV_PATH || exit 1<br>
 TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
 sync<br>
 fi<br>
 fi<br>
SOURCE_BASE_SIZE=$(read_lv_size "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_VG/$TARGET_LV not found. Creating empty volume."<br>
 lvcreate --thin-pool "$BACKUPS_POOL" -V "$SOURCE_BASE_SIZE"B --name "$TARGET_BASE_LV" "$TARGET_VG" || exit 1<br>
 echo "Have to rebootstrap. Discarding source at $SOURCE_BASE_LV_PATH"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SOURCE_BASE_CHUNK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
 discard_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 TARGET_BASE_POOL=$(read_pool_lv $TARGET_VG $TARGET_BASE_LV)<br>
 TARGET_BASE_CHUNK_SIZE=$(read_lv_chunk_size $TARGET_VG $TARGET_BASE_POOL)<br>
 TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
 echo "Discarding target at $TARGET_BASE_LV_PATH"<br>
 discard_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 sync<br>
 fi<br>
 if [ "$SOURCE_PEND_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_PEND_LV_PATH found removing..."<br>
 lvremove -y --quiet "$SOURCE_PEND_LV_PATH" || exit 1<br>
 sync<br>
 fi<br>
 lvcreate --quiet --snapshot --name "$SOURCE_PEND_LV" "$SOURCE_VG/$SOURCE_LV" || exit 1<br>
SOURCE_PEND_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
 sync<br>
 if [ "$TARGET_PEND_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_PEND_LV_PATH found removing..."<br>
 lvremove -y --quiet $TARGET_PEND_LV_PATH<br>
 sync<br>
 fi<br>
 lvcreate --quiet --snapshot --name "$TARGET_PEND_LV" "$TARGET_VG/$TARGET_BASE_LV" || exit 1<br>
TARGET_PEND_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_PEND_LV")<br>
SOURCE_PEND_LV_SIZE=$(read_lv_size "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
 lvresize -L "$SOURCE_PEND_LV_SIZE"B "$TARGET_PEND_LV_PATH"<br>
 activate_volume "$TARGET_VG" "$TARGET_PEND_LV"<br>
 echo "Synching $SOURCE_PEND_LV_PATH to $TARGET_PEND_LV_PATH"<br>
 thinsync "$SOURCE_VG" "$SOURCE_PEND_LV" "$SOURCE_BASE_LV" "$TARGET_PEND_LV_PATH" || exit 1<br>
 sync<br>
<br>
TARGET_DATE_SUFFIX=$(suffix)<br>
 lvcreate --quiet --snapshot --name "$TARGET_LV$TARGET_DATE_SUFFIX" "$TARGET_VG/$TARGET_PEND_LV" || exit 1<br>
 sync<br>
 lvremove --quiet -y "$SOURCE_BASE_LV_PATH" || exit 1<br>
 sync<br>
 lvremove --quiet -y "$TARGET_BASE_LV_PATH" || exit 1<br>
 sync<br>
 lvrename -y "$SOURCE_VG/$SOURCE_PEND_LV" "$SOURCE_BASE_LV" || exit 1<br>
 lvrename -y "$TARGET_VG/$TARGET_PEND_LV" "$TARGET_BASE_LV" || exit 1<br>
 sync<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function verify()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 activate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 echo Comparing "$SOURCE_BASE_LV_PATH" with "$TARGET_BASE_LV_PATH"<br>
 cmp "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH"<br>
 echo Done...<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function resync()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 activate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SYNC_BLOCK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
<br>
echo Syncronizing "$SOURCE_BASE_LV_PATH" to "$TARGET_BASE_LV_PATH"<br>
<br>
CMP_OFFSET=0<br>
 while [[ "$CMP_OFFSET" != "" ]] ; do<br>
 CMP_MISMATCH=$(cmp -i "$CMP_OFFSET" "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH" | grep differ | awk '{print $5}' | sed 's/,//g' )<br>
 if [[ "$CMP_MISMATCH" != "" ]] ; then<br>
 CMP_OFFSET=$(( CMP_MISMATCH + CMP_OFFSET ))<br>
 SYNC_OFFSET_BYTES=$(( ( CMP_OFFSET / SYNC_BLOCK_SIZE ) * SYNC_BLOCK_SIZE ))<br>
 SYNC_LENGTH_BYTES=$(( SYNC_BLOCK_SIZE ))<br>
 echo "Synching $SYNC_LENGTH_BYTES bytes at $SYNC_OFFSET_BYTES from $SOURCE_BASE_LV_PATH to $TARGET_BASE_LV_PATH"<br>
 ddrescue --quiet --force --input-position=$SYNC_OFFSET_BYTES --output-position=$SYNC_OFFSET_BYTES --size=$SYNC_LENGTH_BYTES "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH"<br>
 else<br>
 CMP_OFFSET=""<br>
 fi<br>
 done<br>
 echo Done...<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function list()<br>
{<br>
LIST_SOURCE_VG="$1"<br>
LIST_SOURCE_LV="$2"<br>
LIST_TARGET_VG="$BACKUPS"<br>
LIST_TARGET_LV="$LIST_SOURCE_VG-$LIST_SOURCE_LV"<br>
LIST_TARGET_BASE_LV="$LIST_TARGET_LV$SNAP_SUFFIX"<br>
lvs -olv_name | grep "$LIST_TARGET_BASE_LV.$DATE_REGEX"<br>
}<br>
<br>
function remove()<br>
{<br>
REMOVE_TARGET_VG="$BACKUPS"<br>
REMOVE_TARGET_LV="$1"<br>
lvremove -y "$REMOVE_TARGET_VG/$REMOVE_TARGET_LV"<br>
sync<br>
}<br>
<br>
function removeall()<br>
{<br>
DATE_OFFSET="$3"<br>
FILTER="$(filter "$DATE_OFFSET")"<br>
while read -r SNAPSHOT ; do<br>
 remove "$SNAPSHOT"<br>
done &lt; &lt;(list "$1" "$2" | grep "$FILTER")<br>
<br>
}<br>
<br>
(<br>
 COMMAND="$1"<br>
 shift<br>
 <br>
 case "$COMMAND" in<br>
 "--help") <br>
 echo "Help"<br>
 ;;<br>
 "suffix") <br>
 suffix<br>
 ;;<br>
 "filter") <br>
 filter "$1"<br>
 ;;<br>
 "backup") <br>
 wait_lock_or_terminate<br>
 backup "$1" "$2"<br>
 ;;<br>
 "list") <br>
 list "$1" "$2"<br>
 ;;<br>
 "thindiff") <br>
 thindiff "$1" "$2" "$3"<br>
 ;;<br>
 "thinsync") <br>
 thinsync "$1" "$2" "$3" "$4"<br>
 ;;<br>
 "verify") <br>
 wait_lock_or_terminate<br>
 verify "$1" "$2"<br>
 ;;<br>
 "resync") <br>
 wait_lock_or_terminate<br>
 resync "$1" "$2"<br>
 ;;<br>
 "remove") <br>
 wait_lock_or_terminate<br>
 remove "$1"<br>
 ;;<br>
 "removeall") <br>
 wait_lock_or_terminate<br>
 removeall "$1" "$2" "$3"<br>
 ;;<br>
 *)<br>
 echo "None.."<br>
 ;;<br>
 esac<br>
) 98&gt;$LOCK_FILE <br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒåœ¨åšä»€ä¹ˆ...ï¼Ÿ</font></font></b><div class="spoiler_text">             ,   thin_delta,       ddrescue  blkdiscard.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†å¡å…¥å† å†•çš„å¦ä¸€ä¸ªè„šæœ¬ï¼š</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€äº›æ›´å¤šçš„æ‰“å‡»</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/lvm-thin-backup/cron-daily.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
BACKUP_SCRIPT="$SCRIPT_DIR/lvm-thin-backup.sh"<br>
RETENTION="-60 days"<br>
<br>
$BACKUP_SCRIPT backup images linux-dev<br>
$BACKUP_SCRIPT backup images win8<br>
$BACKUP_SCRIPT backup images win8-data<br>
#etc<br>
<br>
$BACKUP_SCRIPT removeall images linux-dev "$RETENTION"<br>
$BACKUP_SCRIPT removeall images win8 "$RETENTION"<br>
$BACKUP_SCRIPT removeall images win8-data "$RETENTION"<br>
#etc<br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒåœ¨åšä»€ä¹ˆ...ï¼Ÿ</font></font></b><div class="spoiler_text">  ,         .      ,        .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥è„šæœ¬éœ€è¦ç¼–è¾‘ï¼ŒæŒ‡ç¤ºéœ€è¦å¤‡ä»½çš„ç²¾ç®€å·çš„åˆ—è¡¨ã€‚</font><font style="vertical-align: inherit;">ç»™å‡ºçš„åç§°ä»…ç”¨äºè¯´æ˜ç›®çš„ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ„¿æ„ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥åŒæ­¥æ‰€æœ‰å·ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æˆäºˆæƒåˆ©ï¼š</font><font style="vertical-align: inherit;">
æ£€æŸ¥å¹¶å¡å…¥å† å†•ï¼š</font><font style="vertical-align: inherit;">
ç¬¬ä¸€æ¬¡å‘å°„å°†å¾ˆé•¿ï¼Œå› ä¸º </font><font style="vertical-align: inherit;">ç²¾ç®€å·å°†é€šè¿‡å¤åˆ¶æ•´ä¸ªå·²ç”¨ç©ºé—´æ¥å®Œå…¨åŒæ­¥ã€‚</font><font style="vertical-align: inherit;">å¤šäºäº†LVMç²¾ç®€å…ƒæ•°æ®ï¼Œæˆ‘ä»¬çŸ¥é“å®é™…ä½¿ç”¨äº†å“ªäº›å—ï¼Œå› æ­¤ä»…ä¼šå¤åˆ¶ç²¾ç®€å·çš„å®é™…å—ã€‚</font><font style="vertical-align: inherit;">
éšåçš„å¯åŠ¨å°†é€šè¿‡LVMç˜¦å…ƒæ•°æ®è·Ÿè¸ªæ›´æ”¹æ¥å¢é‡å¤åˆ¶æ•°æ®ã€‚</font></font><br>
<br>
<code>#chmod +x /root/lvm-thin-backup/cron-daily.sh<br>
#chmod +x /root/lvm-thin-backup/lvm-thin-backup.sh</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#/usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/lvm-thin-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t lvm-thin-backup<br>
#cat /var/log/syslog | grep lvm-thin-backup<br>
#crontab -e<br>
0 3 * * * /usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/lvm-thin-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t lvm-thin-backup<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æˆ‘ä»¬çœ‹çœ‹å‘ç”Ÿä»€ä¹ˆäº†ï¼š</font></font></h3><br>
<code>#time /root/btrfs-backup/cron-daily.sh<br>
real 0m2,967s<br>
user 0m0,225s<br>
sys 0m0,353s<br>
<br>
#time /root/lvm-thin-backup/cron-daily.sh<br>
real 1m2,710s<br>
user 0m12,721s<br>
sys 0m6,671s<br>
<br>
#ls -al /backup/btrfs/back/remote/*<br>
/backup/btrfs/back/remote/boot:<br>
total 0<br>
drwxr-xr-x 1 root root 1260  26 09:11 .<br>
drwxr-xr-x 1 root root 16  6 09:30 ..<br>
drwxr-xr-x 1 root root 322  26 02:00 .@base<br>
drwxr-xr-x 1 root root 516  6 09:39 .@snap.2020-03-06-09-39-37<br>
drwxr-xr-x 1 root root 516  6 09:39 .@snap.2020-03-06-09-39-57<br>
...<br>
/backup/btrfs/back/remote/root:<br>
total 0<br>
drwxr-xr-x 1 root root 2820  26 09:11 .<br>
drwxr-xr-x 1 root root 16  6 09:30 ..<br>
drwxr-xr-x 1 root root 240  26 09:11 @.@base<br>
drwxr-xr-x 1 root root 22  26 09:11 @home.@base<br>
drwxr-xr-x 1 root root 22  6 09:39 @home.@snap.2020-03-06-09-39-35<br>
drwxr-xr-x 1 root root 22  6 09:39 @home.@snap.2020-03-06-09-39-57<br>
...<br>
drwxr-xr-x 1 root root 240  6 09:39 @.@snap.2020-03-06-09-39-26<br>
drwxr-xr-x 1 root root 240  6 09:39 @.@snap.2020-03-06-09-39-56<br>
...<br>
<br>
#lvs -olv_name,lv_size images &amp;&amp; lvs -olv_name,lv_size backup<br>
 LV LSize <br>
 linux-dev 128,00g<br>
 linux-dev.base 128,00g<br>
 thin-pool 1,38t<br>
 win8 128,00g<br>
 win8-data 2,00t<br>
 win8-data.base 2,00t<br>
 win8.base 128,00g<br>
 LV LSize <br>
 backup 256,00g<br>
 images-linux-dev.base 128,00g<br>
 images-linux-dev.snap.2020-03-08-10-09-11 128,00g<br>
 images-linux-dev.snap.2020-03-08-10-09-25 128,00g<br>
...<br>
 images-win8-data.base 2,00t<br>
 images-win8-data.snap.2020-03-16-14-11-55 2,00t<br>
 images-win8-data.snap.2020-03-16-14-19-50 2,00t<br>
...<br>
 images-win8.base 128,00g<br>
 images-win8.snap.2020-03-17-04-51-46 128,00g<br>
 images-win8.snap.2020-03-18-03-02-49 128,00g<br>
...<br>
 thin-pool &lt;2,09t<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‚£åµŒå¥—å¨ƒå¨ƒå‘¢ï¼Ÿ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡æœ€å¯èƒ½çš„æ˜¯LVM LVé€»è¾‘å·å¯ä»¥æ˜¯å…¶ä»–VGçš„ç‰©ç†LVM PVå·ã€‚</font><font style="vertical-align: inherit;">LVMå¯ä»¥æ˜¯é€’å½’çš„ï¼Œå°±åƒåµŒå¥—å¨ƒå¨ƒä¸€æ ·ã€‚</font><font style="vertical-align: inherit;">è¿™ä¸ºLVMæä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èšè‹¯ä¹™çƒ¯</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•ä½¿ç”¨å‡ ç§ç±»ä¼¼çš„ç§»åŠ¨å­˜å‚¨ç³»ç»Ÿ/ KVMä½œä¸ºåŸºç¡€ï¼Œä»¥åˆ›å»ºåœ°ç†åˆ†å¸ƒçš„å­˜å‚¨/è™šæ‹Ÿæœºé›†ç¾¤ï¼Œå¹¶é€šè¿‡å®¶åº­å°å¼æœºï¼Œå®¶åº­Internetå’ŒP2Pç½‘ç»œåœ¨å¤šä¸ªå¤§æ´²å®ç°å†—ä½™ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN492820/index.html">.Net Core Apiï¼šåœ¨æ¥è‡ªä¸åŒæ¥æºçš„è¯·æ±‚ä¸­è·å–æ•°æ®</a></li>
<li><a href="../zh-CN492822/index.html">CSSå¼€å‘äººå‘˜-ä¸ºä»€ä¹ˆä¸–ç•Œéœ€è¦å®ƒä»¬ï¼Ÿ</a></li>
<li><a href="../zh-CN492828/index.html">å¦‚ä½•åœ¨ä¸€ä¸ªå°é—­çš„ä¸–ç•Œä¸­ç”Ÿå­˜</a></li>
<li><a href="../zh-CN492830/index.html">é»˜è®¤æƒ…å†µä¸‹ï¼ŒSameSite = Lax-å·²åœ¨Chrome 80ç¨³å®šç‰ˆä¸­è¿è¡Œï¼ˆå°½ç®¡å¹¶éæ‰€æœ‰äººï¼‰</a></li>
<li><a href="../zh-CN492832/index.html">ç”¨äºåŸºäºi.MX6å’ŒLinuxçš„å·¥ä¸šåè®®çš„IoTç½‘å…³</a></li>
<li><a href="../zh-CN492838/index.html">å°†M5Stackè¿æ¥åˆ°ç”µè§†</a></li>
<li><a href="../zh-CN492844/index.html">å¦‚ä½•å¯è§†åŒ–å’ŒåŠ¨ç”»åŒ–ï¼ˆåœ°çƒç‰©ç†ï¼‰æ¨¡å‹ã€‚3DåŠ¨ç”»å’Œ4Dæ•°æ®å¯è§†åŒ–</a></li>
<li><a href="../zh-CN492850/index.html">å¹¶éæ¯ä¸ªäººéƒ½æƒ³åˆ‡æ¢åˆ°è¿œç¨‹å·¥ä½œ</a></li>
<li><a href="../zh-CN492856/index.html">Covid19ï¼Œä»æ•°æ®ç§‘å­¦çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨å’Œæ‚¨çš„ç¤¾ä¼šéƒ½æ˜¯å¦‚æ­¤ã€‚æ°é‡Œç±³Â·éœåå¾·ï¼ˆJeremy Howardï¼‰å’Œç‘ç§‹Â·æ‰˜é©¬æ–¯ï¼ˆRachel Thomasï¼‰çš„ç¿»è¯‘æ–‡ç« ï¼ˆfast.aiï¼‰</a></li>
<li><a href="../zh-CN492862/index.html">é’ˆå¯¹å¼€å‘äººå‘˜çš„15ä¸ªæœ€ä½³Oracle APEXæ€§èƒ½è°ƒä¼˜æŠ€å·§</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>