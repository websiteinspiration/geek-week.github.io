<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñáÔ∏è üë®üèø‚Äçüåæ ‚òùüèæ Autentica√ß√£o b√°sica de login e HTTP novamente üèì üë®üèæ‚Äçüî¨ üßóüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Os desenvolvedores da Web est√£o cientes do problema de efetuar logon e logon em sites protegidos pela HTTP Basic Authorization. Embora existam outros ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Autentica√ß√£o b√°sica de login e HTTP novamente</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488388/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os desenvolvedores da Web est√£o cientes do problema de efetuar logon e logon em sites protegidos pela HTTP Basic Authorization. </font><font style="vertical-align: inherit;">Embora existam outros m√©todos de autentica√ß√£o que n√£o sofrem com esse problema, a Autoriza√ß√£o B√°sica ainda √© frequentemente a melhor op√ß√£o. </font><font style="vertical-align: inherit;">A rede possui materiais suficientes que descrevem v√°rias solu√ß√µes gerais e particulares. </font><font style="vertical-align: inherit;">Mas todos eles, que encontrei, infelizmente, descrevem apenas algumas solu√ß√µes parciais que funcionam em um navegador e n√£o em outro. </font><font style="vertical-align: inherit;">Sob gato, dou um resultado final generalizado da minha pesquisa sobre esse problema</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Farei uma reserva imediatamente de que n√£o sou desenvolvedor front-end e n√£o mergulhei em toda a variedade de "marcas" e vers√µes de navegadores. </font><font style="vertical-align: inherit;">Somente mainstream com vers√µes relevantes no momento da reda√ß√£o. </font><font style="vertical-align: inherit;">Para a maioria das tarefas da Web, isso √© suficiente. </font><font style="vertical-align: inherit;">Para os desenvolvedores que precisam de suporte para todo o "zool√≥gico" de navegadores, o artigo pode ser um bom ponto de partida: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a ess√™ncia do problema √© que o padr√£o de autoriza√ß√£o b√°sica de HTTP n√£o fornece log. </font><font style="vertical-align: inherit;">Geralmente. </font><font style="vertical-align: inherit;">Quando voc√™ acessa uma p√°gina protegida pela Autoriza√ß√£o B√°sica, o pr√≥prio navegador exibe sua pr√≥pria janela com uma solicita√ß√£o de login / senha e, com um login bem-sucedido, as salva em algum lugar profundo. </font><font style="vertical-align: inherit;">Em seguida, todas as solicita√ß√µes subsequentes para outras p√°ginas protegidas deste site usar√£o automaticamente esses valores no cabe√ßalho da Autoriza√ß√£o:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriza√ß√£o: Basic bm9uZTpub25l</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onde bm9uZTpub25l √© o link de login / senha codificado em base64 none: none (seu nome de usu√°rio e senha podem ser diferentes) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer login, voc√™ s√≥ precisa redefinir o nome de usu√°rio / senha antigo nessas profundidades do navegador e neles lugar para gravar novos. </font><font style="vertical-align: inherit;">√â aqui que uma surpresa nos espera. </font><font style="vertical-align: inherit;">Como nenhum padr√£o regula essa a√ß√£o, cada navegador faz isso de acordo com seu pr√≥prio entendimento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pior, como a janela de solicita√ß√£o de login / senha √© sua pr√≥pria janela do navegador, que j√° responde apenas aos cabe√ßalhos de p√°gina HTTP, essa janela √© exibida antes de qualquer processamento do corpo da p√°gina. </font><font style="vertical-align: inherit;">Ou seja, executar algum javascript ao receber uma resposta do servidor com um status 401 n√£o funciona. </font><font style="vertical-align: inherit;">Antes do usu√°rio, essa janela ser√° exibida repetidas vezes com uma solicita√ß√£o repetida de login / senha.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, esse ponto √© cr√≠tico, pois para quase todos os navegadores a √∫nica maneira de sair √© enviar uma solicita√ß√£o ao servidor com login / senha obviamente incorreta, receber uma resposta do servidor com o status 401 e redefinir o cache de login / senha do navegador. </font><font style="vertical-align: inherit;">Mas se, ao mesmo tempo, o navegador n√£o permitir que voc√™ processe a resposta 401 e continue o processo de login j√° para o novo usu√°rio, assumindo o controle mesmo no est√°gio de leitura dos cabe√ßalhos HTTP e lan√ßando a pr√≥pria forma de autoriza√ß√£o na qual voc√™ o digita n√£o funcionar√° na sua cara, ent√£o isso j√° √© um problema. </font><font style="vertical-align: inherit;">N√£o importa se essa √© uma solicita√ß√£o normal por refer√™ncia ou XMLHttpRequest ou busca. </font><font style="vertical-align: inherit;">O navegador ainda assume o controle na fase de an√°lise dos cabe√ßalhos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim‚Ä¶</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dados iniciais:</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° uma p√°gina logout.html separada, na qual toda a l√≥gica est√° localizada no script javascript, partes das quais s√£o fornecidas no decorrer da apresenta√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL especificado - endere√ßo da p√°gina a ser redirecionado ap√≥s o login bem-sucedido</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Url401 √© especificado - o endere√ßo da p√°gina que sempre retorna o erro HTTP 401 (n√£o autorizado)</font></font></li>
</ol><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// file logout.html</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/"</span>);
<span class="hljs-keyword">const</span> url401 = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/401"</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet Explorer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso produto n√£o requer suporte para este navegador, portanto, a solu√ß√£o que eu n√£o testei pessoalmente. </font><font style="vertical-align: inherit;">No entanto, segundo o Google, existe uma solu√ß√£o para isso, e talvez seja o mais simples e mais elegante de todos. </font><font style="vertical-align: inherit;">Al√©m disso, nunca encontrei nenhuma informa√ß√£o de que essa solu√ß√£o para navegadores da Microsoft tenha perdido sua relev√¢ncia:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.execCommand(<span class="hljs-string">"ClearAuthenticationCache"</span>)) {
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No IE, existe um m√©todo ClearAuthenticationCache que descarta "esses intestinos muito profundos". </font><font style="vertical-align: inherit;">Simples e elegante. </font><font style="vertical-align: inherit;">E nada de dan√ßar com a p√°gina auxiliar 401. N√£o sei se esse m√©todo funciona no Edge. </font><font style="vertical-align: inherit;">Provavelmente sim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A constru√ß√£o document.execCommand retorna true se o m√©todo existe e "funcionou". </font><font style="vertical-align: inherit;">Ent√£o window.location.assign (url) redireciona o usu√°rio para inserir um novo nome de usu√°rio e senha</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firefox (72.0.1)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No contexto de nossa tarefa, este √© o navegador mais problem√°tico. </font><font style="vertical-align: inherit;">Para ele, ainda n√£o existe uma solu√ß√£o completa. </font><font style="vertical-align: inherit;">Por 15 a 20 anos, uma solicita√ß√£o para o problema indicado est√° pendurada no rastreador de erros da equipe de seus desenvolvedores. </font><font style="vertical-align: inherit;">Mas "as coisas ainda est√£o l√°". </font><font style="vertical-align: inherit;">O m√°ximo que pode ser alcan√ßado √© a curva razlogin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entrada: O </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firefox n√£o libera o cache de senhas ap√≥s receber uma resposta 401 por meio do XMLHttpRequest ou da solicita√ß√£o de busca. </font><font style="vertical-align: inherit;">Somente atrav√©s de uma solicita√ß√£o regular com o login / senha no pr√≥prio URL. </font><font style="vertical-align: inherit;">Ou seja, algo como</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // nenhum: none@meusite.com/</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O c√≥digo:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/firefox|iceweasel|fxios/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    url.username = <span class="hljs-string">'none'</span>;<font></font>
    url.password = <span class="hljs-string">'none'</span>;
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s o qual o usu√°rio recebe um formul√°rio de login / senha, no qual quer que voc√™ insira, ele ser√° exibido novamente. </font><font style="vertical-align: inherit;">O fato √© que os valores inseridos n√£o substituir√£o os valores de login / senha especificados na URL. </font><font style="vertical-align: inherit;">Ou seja, em vez dos valores inseridos, um monte de nenhum: nenhum ir√° para o servidor a cada vez. </font><font style="vertical-align: inherit;">E para fazer login com um nome diferente, o usu√°rio deve clicar em cancelar, ir para a p√°gina inicial (http: //mysite.com/) e inserir um novo login / senha l√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Torto? </font><font style="vertical-align: inherit;">Mas, infelizmente, n√£o h√° outra solu√ß√£o</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Chrome (79.0.3945.88)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o Chrome, o m√©todo de busca funciona muito bem. </font><font style="vertical-align: inherit;">Mas XMLHttpRequest n√£o funciona (((o cache n√£o est√° liberado e o log n√£o ocorre. Al√©m disso, tentei definir o login / senha como par√¢metros para o m√©todo aberto e para definir o cabe√ßalho).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/chrome/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    fetch(url401, {<font></font>
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Basic '</span> + btoa(<span class="hljs-string">'none:none'</span>),
        <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span><font></font>
      }<font></font>
    }).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.error(err));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fazemos uma solicita√ß√£o de busca para a p√°gina 401 com nome de usu√°rio / senha obviamente incorretos, obtemos uma resposta 401 do servidor, o navegador libera seu cache. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMPORTANTE! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O servidor N√ÉO deve retornar um cabe√ßalho </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWW-Authenticate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Caso contr√°rio, o navegador assumir√° o controle e os redirecionamentos da p√°gina 401 nunca acontecer√£o. </font><font style="vertical-align: inherit;">Por conven√ß√£o, o servidor n√£o deve retornar esse cabe√ßalho se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With: XMLHttpRequest for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especificado na solicita√ß√£o </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Portanto, o cabe√ßalho </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foi adicionado √† solicita√ß√£o </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safari (12)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o Safari, a situa√ß√£o √© exatamente o oposto: XMLHttpRequest funciona, mas a busca n√£o funciona</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
    xhr.open(<span class="hljs-string">"GET"</span>, url401, <span class="hljs-literal">true</span>, <span class="hljs-string">'none'</span>, <span class="hljs-string">'none'</span>);<font></font>
    xhr.setRequestHeader(<span class="hljs-string">'X-Requested-With'</span>, <span class="hljs-string">'XMLHttpRequest'</span>);<font></font>
    xhr.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-built_in">console</span>.error(err);<font></font>
    };<font></font>
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    };<font></font>
    xhr.send()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a√ß√µes s√£o iguais √†s do Chrome, apenas atrav√©s do XMLHttpRequest. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dever√° funcionar para as vers√µes do Safari 6+. </font><font style="vertical-align: inherit;">As vers√µes anteriores tinham seus pr√≥prios bugs. </font><font style="vertical-align: inherit;">Em particular, por exemplo, nas vers√µes 5.1, com cada redirecionamento, o navegador solicitou for√ßosamente a autoriza√ß√£o, raz√£o pela qual a autoriza√ß√£o com redirecionamento para a p√°gina final n√£o funcionava em princ√≠pio. </font><font style="vertical-align: inherit;">E nas vers√µes anteriores √† 5.0, o log n√£o funcionava.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt488376/index.html">Quando o princ√≠pio "para o inferno com tudo, pegue e fa√ßa!" n√£o funciona: notas de procrastinador</a></li>
<li><a href="../pt488378/index.html">Brevemente sobre nomea√ß√£o em JS</a></li>
<li><a href="../pt488380/index.html">O in√≠cio mais f√°cil no STM atrav√©s de "um local"</a></li>
<li><a href="../pt488382/index.html">Eu adiciono um atraso de 3-25 segundos aos sites que visito</a></li>
<li><a href="../pt488386/index.html">Casos para aplicar ferramentas de an√°lise de anomalias de rede: ataques atrav√©s de plug-ins de navegador</a></li>
<li><a href="../pt488390/index.html">Como fazer amigos do Telegram bot com o OpenId Connect</a></li>
<li><a href="../pt488392/index.html">Imagens prontas para produ√ß√£o para k8s</a></li>
<li><a href="../pt488404/index.html">Jogos que vale a pena esperar em 2020</a></li>
<li><a href="../pt488406/index.html">IPv6 - voc√™ est√° fazendo errado</a></li>
<li><a href="../pt488408/index.html">Gateway IoT Ethernet-RS485 STM32</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>