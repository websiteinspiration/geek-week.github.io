<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍖 🍘 😟 Consulを使用してNomadクラスターを構成し、Gitlabと統合する 👩🏿 👩‍🏭 🔵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 
 最近、Kubernetesの人気が急速に高まっています-自宅で実装するプロジェクトが増えています。私はNomadのようなオーケストレーターに触れたかったです。これは、VaultやConsulなど、HashiCorpの他のソリューションをすでに使用しているプロジェクトに最適であり、プロジ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Consulを使用してNomadクラスターを構成し、Gitlabと統合する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453322/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、Kubernetesの人気が急速に高まっています-自宅で実装するプロジェクトが増えています。</font><font style="vertical-align: inherit;">私はNomadのようなオーケストレーターに触れたかったです。これは、VaultやConsulなど、HashiCorpの他のソリューションをすでに使用しているプロジェクトに最適であり、プロジェクト自体はインフラストラクチャの点で複雑ではありません。</font><font style="vertical-align: inherit;">この記事では、Nomadのインストール、2つのノードのクラスターへの結合、およびNomadとGitlabの統合について説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/yn/4v/buyn4vqshurhgc9kavloja-fzsm.png"><br>
<br>
<a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストスタンド</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストベンチについて少し説明します。3つの仮想サーバーが、2つのCPU、4つのRAM、50 Gb SSDの特性で使用され、共通のローカルネットワークに統合されています。</font><font style="vertical-align: inherit;">それらの名前とIPアドレス：</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nomad-livelinux-01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：172.30.0.5</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nomad-livelinux-02</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：172.30.0.10</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul-livelinux-01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：172.30.0.15</font></font></li>
</ol><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノマド領事の設置。</font><font style="vertical-align: inherit;">ノマドクラスターの作成</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本的なインストールに進みましょう。インストールは簡単ですが、記事の完全性のために説明します。実際には、必要に応じてすばやくアクセスできるように、下書きとメモから作成されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階では将来の構造を理解することが重要であるため、演習を始める前に、理論的な部分について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの遊牧ノードがあり、それらをクラスターにマージしたいのですが、将来的にはクラスターの自動スケーリングも必要になります-これにはConsulが必要です。このツールを使用すると、新しいノードのクラスタリングと追加は非常に単純なタスクになります。作成されたNomadノードはConsulエージェントに接続し、次に既存のNomadクラスタに接続します。したがって、最初にConsulサーバーをインストールし、Webパネルの基本的なhttp認証（デフォルトでは認証なしで外部アドレスでアクセスできます）と、Nomadサーバー上のConsulエージェント自体を構成します。その後、Nomadを起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HashiCorpツールのインストールは非常に簡単です。実際には、バイナリファイルをbinディレクトリに移動し、ツールの構成ファイルを構成して、サービスファイルを作成するだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バイナリファイルConsulをロードし、ユーザーのホームディレクトリに解凍します。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip</span>
root@consul-livelinux-01:~<span class="hljs-comment"># unzip consul_1.5.0_linux_amd64.zip</span>
root@consul-livelinux-01:~<span class="hljs-comment"># mv consul /usr/local/bin/</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、さらに構成するための既製のバイナリ領事ファイルができました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consulを使用するには、keygenコマンドを使用して一意のキーを作成する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"># consul keygen</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consulの設定に進み、次の構造で/etc/consul.d/ディレクトリを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">/etc/consul.d/<font></font>
├── bootstrap<font></font>
│   └── config.json</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブートストラップディレクトリにはconfig.json設定ファイルが含まれます-その中にConsul設定を設定します。</font><font style="vertical-align: inherit;">その内容：</font></font><br>
<br>
<pre><code class="javascript hljs">{
<span class="hljs-string">"bootstrap"</span>: <span class="hljs-literal">true</span>,
<span class="hljs-string">"server"</span>: <span class="hljs-literal">true</span>,
<span class="hljs-string">"datacenter"</span>: <span class="hljs-string">"dc1"</span>,
<span class="hljs-string">"data_dir"</span>: <span class="hljs-string">"/var/consul"</span>,
<span class="hljs-string">"encrypt"</span>: <span class="hljs-string">"your-key"</span>,
<span class="hljs-string">"log_level"</span>: <span class="hljs-string">"INFO"</span>,
<span class="hljs-string">"enable_syslog"</span>: <span class="hljs-literal">true</span>,
<span class="hljs-string">"start_join"</span>: [<span class="hljs-string">"172.30.0.15"</span>]<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主なディレクティブとその意味を個別に調べてみましょう。</font></font><br>
<br>
<ul>
<li><b>bootstrap</b>: true.         . ,         .</li>
<li><b>server</b>: true.   . Consul             ,  Nomad’a  .</li>
<li><b>datacenter</b>: dc1.      .       ,   .</li>
<li><b>encrypt</b>: your-key. ,            .     consul keygen.</li>
<li><b>start_join</b>.       IP ,     .       .</li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、コマンドラインを使用して領事を開始できます。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"># /usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは今すぐにデバッグするための良い方法ですが、継続的にこの方法を使用しても、明らかな理由で機能しません。</font><font style="vertical-align: inherit;">systemdを使用してConsulを管理するためのサービスファイルを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"># nano /etc/systemd/system/consul.service</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
consul.serviceファイルの内容： </font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Description=Consul Startup process<font></font>
After=network.target<font></font>
 <font></font>
[Service]<font></font>
Type=simple<font></font>
ExecStart=/bin/bash -c <span class="hljs-string">'/usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui'</span> <font></font>
TimeoutStartSec=0<font></font>
 <font></font>
[Install]<font></font>
WantedBy=default.target</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
systemctlを使用してConsulを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"># systemctl start consul</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスを開始し、consul membersコマンドを実行してサーバーを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">root@consul-livelinux:/etc/consul.d<span class="hljs-comment"># consul members</span>
consul-livelinux    172.30.0.15:8301  alive   server  1.5.0  2         dc1  &lt;all&gt;</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のステップ：Nginxのインストールとプロキシの設定、http認証。</font><font style="vertical-align: inherit;">パッケージマネージャーを使用してnginxをインストールし、ディレクトリ/ etc / nginx / sites-enabledに次の内容で構成ファイルconsul.confを作成します。</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">upstream</span> consul-auth {
    <span class="hljs-attribute">server</span> localhost:<span class="hljs-number">8500</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {<font></font>
<font></font>
    <span class="hljs-attribute">server_name</span> consul.doman.name;<font></font>
    <font></font>
    <span class="hljs-attribute">location</span> / {
      <span class="hljs-attribute">proxy_pass</span> http://consul-auth;
      <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
      <span class="hljs-attribute">auth_basic_user_file</span> /etc/nginx/.htpasswd;
      <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">"Password-protected Area"</span>;<font></font>
    }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.htpasswdファイルを作成し、そのユーザー名とパスワードを生成することを忘れないでください。</font><font style="vertical-align: inherit;">このアイテムは、ドメインを知っている誰もがWebパネルにアクセスできないようにするために必要です。</font><font style="vertical-align: inherit;">ただし、Gitlabを構成するときは、これを放棄する必要があります。そうしないと、アプリケーションをNomadにデプロイできなくなります。</font><font style="vertical-align: inherit;">私のプロジェクトでは、GitlabとNomadの両方が灰色のネットワーク上にあるだけなので、そのような問題はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他の2台のサーバーで、次の手順に従ってConsulエージェントをインストールします。</font><font style="vertical-align: inherit;">バイナリファイルで手順を繰り返します。</font></font><br>
<br>
<pre><code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># unzip consul_1.5.0_linux_amd64.zip</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># mv consul /usr/local/bin/</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のサーバーと同様に、構成ファイル/etc/consul.dのディレクトリを次の構造で作成します。</font></font><br>
<br>
<pre><code class="bash hljs">/etc/consul.d/<font></font>
├── client<font></font>
│   └── config.json</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
config.jsonファイルの内容：</font></font><br>
<br>
<pre><code class="javascript hljs">{
    <span class="hljs-string">"datacenter"</span>: <span class="hljs-string">"dc1"</span>,
    <span class="hljs-string">"data_dir"</span>: <span class="hljs-string">"/opt/consul"</span>,
    <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"DEBUG"</span>,
    <span class="hljs-string">"node_name"</span>: <span class="hljs-string">"nomad-livelinux-01"</span>,
    <span class="hljs-string">"server"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"encrypt"</span>: <span class="hljs-string">"your-private-key"</span>,
    <span class="hljs-string">"domain"</span>: <span class="hljs-string">"livelinux"</span>,
    <span class="hljs-string">"addresses"</span>: {
      <span class="hljs-string">"dns"</span>: <span class="hljs-string">"127.0.0.1"</span>,
      <span class="hljs-string">"https"</span>: <span class="hljs-string">"0.0.0.0"</span>,
      <span class="hljs-string">"grpc"</span>: <span class="hljs-string">"127.0.0.1"</span>,
      <span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1"</span><font></font>
    },<font></font>
    <span class="hljs-string">"bind_addr"</span>: <span class="hljs-string">"172.30.0.5"</span>, #   
    <span class="hljs-string">"start_join"</span>: [<span class="hljs-string">"172.30.0.15"</span>], #    
    <span class="hljs-string">"ports"</span>: {
      <span class="hljs-string">"dns"</span>: <span class="hljs-number">53</span><font></font>
     }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更を保存し、サービスファイルとその内容の構成に進みます：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/etc/systemd/system/consul.service：</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Description=<span class="hljs-string">"HashiCorp Consul - A service mesh solution"</span><font></font>
Documentation=https://www.consul.io/<font></font>
Requires=network-online.target<font></font>
After=network-online.target<font></font>
<font></font>
[Service]<font></font>
User=root<font></font>
Group=root<font></font>
ExecStart=/usr/<span class="hljs-built_in">local</span>/bin/consul agent -config-dir=/etc/consul.d/client<font></font>
ExecReload=/usr/<span class="hljs-built_in">local</span>/bin/consul reload<font></font>
KillMode=process<font></font>
Restart=on-failure<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーで領事を始めます。これで、開始後、構成されたサービスがnsulメンバーに表示されます。これは、彼がクライアントとしてクラスターに正常に接続したことを意味します。 2台目のサーバーでも同じ手順を繰り返します。その後、Nomadのインストールと構成を開始できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nomadのより詳細なインストールは、公式ドキュメントに記載されています。従来のインストール方法には、バイナリファイルのダウンロードとソースからのコンパイルの2つがあります。最初の方法を選びます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：プロジェクトは非常に速く開発されており、新しいアップデートが頻繁に出てきます。おそらく、この記事が完了するまでに新しいバージョンがリリースされるでしょう。したがって、読む前に、現時点でのNomadの現在のバージョンを確認してダウンロードすることをお勧めします。</font></font><br>
<br>
<pre><code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"># wget https://releases.hashicorp.com/nomad/0.9.1/nomad_0.9.1_linux_amd64.zip</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># unzip nomad_0.9.1_linux_amd64.zip</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># mv nomad /usr/local/bin/</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># nomad -autocomplete-install</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># complete -C /usr/local/bin/nomad nomad</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># mkdir /etc/nomad.d</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解凍すると、重量が65 MBのNomadバイナリファイルが作成されます。このファイルを/ usr / local / binに移動する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nomadのデータディレクトリを作成し、そのサービスファイルを編集します（おそらく最初は存在しません）。</font></font><br>
<br>
<pre><code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"># mkdir --parents /opt/nomad</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># nano /etc/systemd/system/nomad.service</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこに次の行を挿入します。</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Description=Nomad<font></font>
Documentation=https://nomadproject.io/docs/<font></font>
Wants=network-online.target<font></font>
After=network-online.target<font></font>
<font></font>
[Service]<font></font>
ExecReload=/bin/<span class="hljs-built_in">kill</span> -HUP <span class="hljs-variable">$MAINPID</span>
ExecStart=/usr/<span class="hljs-built_in">local</span>/bin/nomad agent -config /etc/nomad.d<font></font>
KillMode=process<font></font>
KillSignal=SIGINT<font></font>
LimitNOFILE=infinity<font></font>
LimitNPROC=infinity<font></font>
Restart=on-failure<font></font>
RestartSec=2<font></font>
StartLimitBurst=3<font></font>
StartLimitIntervalSec=10<font></font>
TasksMax=infinity<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、nomadを実行するのは急いでいません。構成ファイルはまだ作成していません。</font></font><br>
<br>
<pre><code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"># mkdir --parents /etc/nomad.d</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># chmod 700 /etc/nomad.d</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># nano /etc/nomad.d/nomad.hcl</span>
root@nomad-livelinux-01:~<span class="hljs-comment"># nano /etc/nomad.d/server.hcl</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的なディレクトリ構造は次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">/etc/nomad.d/<font></font>
├── nomad.hcl<font></font>
└── server.hcl</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nomad.hclファイルには、次の構成が含まれている必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">datacenter = <span class="hljs-string">"dc1"</span>
data_dir = <span class="hljs-string">"/opt/nomad"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
server.hclファイルの内容：</font></font><br>
<br>
<pre><code class="bash hljs">server {<font></font>
  enabled = <span class="hljs-literal">true</span><font></font>
  bootstrap_expect = 1<font></font>
}<font></font>
<font></font>
consul {<font></font>
  address             = <span class="hljs-string">"127.0.0.1:8500"</span>
  server_service_name = <span class="hljs-string">"nomad"</span>
  client_service_name = <span class="hljs-string">"nomad-client"</span>
  auto_advertise      = <span class="hljs-literal">true</span>
  server_auto_join    = <span class="hljs-literal">true</span>
  client_auto_join    = <span class="hljs-literal">true</span><font></font>
}<font></font>
<font></font>
bind_addr = <span class="hljs-string">"127.0.0.1"</span> <font></font>
<font></font>
advertise {<font></font>
  http = <span class="hljs-string">"172.30.0.5"</span><font></font>
}<font></font>
<font></font>
client {<font></font>
  enabled = <span class="hljs-literal">true</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のサーバーの設定ファイルを変更することを忘れないでください-そこで、httpディレクティブの値を変更する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階の最後は、http認証をプロキシおよび設定するためのNginxの構成です。</font><font style="vertical-align: inherit;">nomad.confファイルの内容：</font></font><br>
<br>
<pre><code class="bash hljs">upstream nomad-auth {<font></font>
        server 172.30.0.5:4646;<font></font>
}<font></font>
<font></font>
server {<font></font>
<font></font>
        server_name nomad.domain.name;<font></font>
        <font></font>
        location / {<font></font>
	        proxy_pass http://nomad-auth;<font></font>
	        proxy_set_header Host <span class="hljs-variable">$host</span>;<font></font>
	        auth_basic_user_file /etc/nginx/.htpasswd;<font></font>
		   auth_basic <span class="hljs-string">"Password-protected Area"</span>;<font></font>
        }<font></font>
        <font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、外部ネットワーク経由でWebパネルにアクセスできます。</font><font style="vertical-align: inherit;">接続してサーバーページに移動します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/en/uq/ck/enuqck8krqstsbt8b6uwbytoy0e.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像1.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nomadクラスター内のサーバーのリスト</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のサーバーがパネルに正常に表示され、nomad node statusコマンドの出力に同じものが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c1/gv/82/c1gv82tjvwtw0onqxqv3huchv1w.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像2.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nomad node statusコマンドの出力</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consulは何をしますか？</font><font style="vertical-align: inherit;">見てみましょう。</font><font style="vertical-align: inherit;">Consulコントロールパネルのノードページに移動します。</font></font><br>
<img src="https://habrastorage.org/webt/m5/6w/tj/m56wtjjgkos9ed5e_jy9lidmutg.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像3.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consulクラスター内のノード</font><b><font style="vertical-align: inherit;">の</font></b><font style="vertical-align: inherit;">リスト</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これ</font><font style="vertical-align: inherit;">で、Consul </font><font style="vertical-align: inherit;">と連携して動作する準備されたNomadができました。</font><font style="vertical-align: inherit;">最後の段階では、最も興味深いものから始めます。GitlabからNomadへのDockerコンテナーの配信を構成し、その他の特徴的な機能について説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitlabランナーの作成</font></font><br>
</h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DockerイメージをNomadにデプロイするために、Nomadバイナリファイルを内部に持つ別のランナーを使用します（ちなみに、ここで、Hashicorpアプリケーションのもう1つの機能に注目できます-個別に唯一のバイナリファイルです）。</font><font style="vertical-align: inherit;">それをランナーディレクトリにダウンロードします。</font><font style="vertical-align: inherit;">彼のために、次の内容で最も単純なDockerfileを作成します。</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
FROM alpine:3.9<font></font>
RUN apk add --update --no-cache libc6-compat gettext<font></font>
COPY nomad /usr/<span class="hljs-built_in">local</span>/bin/nomad
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じプロジェクトで、.gitlab-ci.ymlを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">variables:<font></font>
  DOCKER_IMAGE: nomad/nomad-deploy<font></font>
  DOCKER_REGISTRY: registry.domain.name<font></font>
 <font></font>
<font></font>
stages:<font></font>
  - build<font></font>
<font></font>
build:<font></font>
  stage: build<font></font>
  image: <span class="hljs-variable">${DOCKER_REGISTRY}</span>/nomad/alpine:3<font></font>
  script:<font></font>
    - tag=<span class="hljs-variable">${DOCKER_REGISTRY}</span>/<span class="hljs-variable">${DOCKER_IMAGE}</span>:latest<font></font>
    - docker build --pull -t <span class="hljs-variable">${tag}</span> -f Dockerfile .<font></font>
    - docker push <span class="hljs-variable">${tag}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、GitlabレジストリにNomadランナーのアクセス可能なイメージが作成されます。これで、プロジェクトリポジトリに直接移動して、パイプラインを作成し、NomadジョブNomadを構成できます。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトのセットアップ</font></font><br>
</h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nomad用のジョブのファイルから始めましょう。</font><font style="vertical-align: inherit;">この記事の私のプロジェクトは非常に原始的なものになります。1つのタスクで構成されます。</font><font style="vertical-align: inherit;">.gitlab-ciの内容は次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">variables:<font></font>
  NOMAD_ADDR: http://nomad.address.service:4646<font></font>
  DOCKER_REGISTRY: registry.domain.name<font></font>
  DOCKER_IMAGE: example/project<font></font>
<font></font>
stages:<font></font>
  - build<font></font>
  - deploy<font></font>
<font></font>
build:<font></font>
  stage: build<font></font>
  image: <span class="hljs-variable">${DOCKER_REGISTRY}</span>/nomad-runner/alpine:3<font></font>
  script:<font></font>
    - tag=<span class="hljs-variable">${DOCKER_REGISTRY}</span>/<span class="hljs-variable">${DOCKER_IMAGE}</span>:<span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span>
    - docker build --pull -t <span class="hljs-variable">${tag}</span> -f Dockerfile .<font></font>
    - docker push <span class="hljs-variable">${tag}</span><font></font>
<font></font>
<font></font>
deploy:<font></font>
  stage: deploy<font></font>
  image: registry.example.com/nomad/nomad-runner:latest<font></font>
  script:<font></font>
    - envsubst <span class="hljs-string">'${CI_COMMIT_SHORT_SHA}'</span> &lt; project.nomad &gt; job.nomad<font></font>
    - cat job.nomad<font></font>
    - nomad validate job.nomad<font></font>
    - nomad plan job.nomad || <span class="hljs-keyword">if</span> [ $? -eq 255 ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span> 255; <span class="hljs-keyword">else</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"success"</span>; <span class="hljs-keyword">fi</span><font></font>
    - nomad run job.nomad<font></font>
  environment:<font></font>
    name: production<font></font>
  allow_failure: <span class="hljs-literal">false</span>
  when: manual</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、デプロイメントは手動モードで行われますが、プロジェクトディレクトリの内容を変更するように構成できます。</font><font style="vertical-align: inherit;">パイプラインは2つの段階で構成されます。イメージの組み立てから、遊牧民への展開までです。</font><font style="vertical-align: inherit;">最初の段階では、Dockerイメージを収集してレジストリにプッシュし、2番目の段階では、Nomadでジョブを起動します。</font></font><br>
<br>
<pre><code class="bash hljs">job <span class="hljs-string">"monitoring-status"</span> {<font></font>
    datacenters = [<span class="hljs-string">"dc1"</span>]<font></font>
    migrate {<font></font>
        max_parallel = 3<font></font>
        health_check = <span class="hljs-string">"checks"</span>
        min_healthy_time = <span class="hljs-string">"15s"</span>
        healthy_deadline = <span class="hljs-string">"5m"</span><font></font>
    }<font></font>
<font></font>
    group <span class="hljs-string">"zhadan.ltd"</span> {<font></font>
        count = 1<font></font>
        update {<font></font>
            max_parallel      = 1<font></font>
            min_healthy_time  = <span class="hljs-string">"30s"</span>
            healthy_deadline  = <span class="hljs-string">"5m"</span>
            progress_deadline = <span class="hljs-string">"10m"</span>
            auto_revert       = <span class="hljs-literal">true</span><font></font>
        }<font></font>
        task <span class="hljs-string">"service-monitoring"</span> {<font></font>
            driver = <span class="hljs-string">"docker"</span><font></font>
<font></font>
            config {<font></font>
                image = <span class="hljs-string">"registry.domain.name/example/project:<span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span>"</span>
                force_pull = <span class="hljs-literal">true</span><font></font>
                auth {<font></font>
                    username = <span class="hljs-string">"gitlab_user"</span>
                    password = <span class="hljs-string">"gitlab_password"</span><font></font>
                }<font></font>
                port_map {<font></font>
                    http = 8000<font></font>
                }<font></font>
            }<font></font>
            resources {<font></font>
                network {<font></font>
                    port <span class="hljs-string">"http"</span> {}<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私がプライベートレジストリを持っていることに注意してください。Dockerイメージプールを成功させるには、ログインする必要があります。</font><font style="vertical-align: inherit;">この場合の最良の解決策は、Nomadとのその後の統合でVaultにログインとパスワードを入力することです。</font><font style="vertical-align: inherit;">NomadはVaultをネイティブでサポートしています。</font><font style="vertical-align: inherit;">ただし、最初に、Vault自体にNomadに必要なポリシーをインストールします。これらをダウンロードできます。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># Download the policy and token role</span><font></font>
$ curl https://nomadproject.io/data/vault/nomad-server-policy.hcl -O -s -L<font></font>
$ curl https://nomadproject.io/data/vault/nomad-cluster-role.json -O -s -L<font></font>
<font></font>
<span class="hljs-comment"># Write the policy to Vault</span><font></font>
$ vault policy write nomad-server nomad-server-policy.hcl<font></font>
<font></font>
<span class="hljs-comment"># Create the token role with Vault</span>
$ vault write /auth/token/roles/nomad-cluster @nomad-cluster-role.json</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なポリシーを作成したら、job.nomadファイルのタスクブロックにVaultとの統合を追加します。</font></font><br>
<br>
<pre><code class="bash hljs">vault {<font></font>
  enabled = <span class="hljs-literal">true</span>
  address = <span class="hljs-string">"https://vault.domain.name:8200"</span>
  token = <span class="hljs-string">"token"</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はトークンによる承認を使用して、ここに直接書き込みます。遊牧民エージェントを実行するときに、トークンを変数として指定するオプションもあります。</font></font><br>
<br>
<pre><code class="bash hljs">$ VAULT_TOKEN=&lt;token&gt; nomad agent -config /path/to/config
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、Vaultでキーを使用できます。</font><font style="vertical-align: inherit;">操作の原理は簡単です：変数の値を格納するファイルをNomadジョブで作成します、例えば：</font></font><br>
<br>
<pre><code class="bash hljs">template {<font></font>
                data = &lt;&lt;EOH<font></font>
{{with secret <span class="hljs-string">"secrets/pipeline-keys"</span>}}<font></font>
REGISTRY_LOGIN=<span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}"</span>
REGISTRY_PASSWORD=<span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}{{ end }}"</span><font></font>
<font></font>
EOH<font></font>
    destination = <span class="hljs-string">"secrets/service-name.env"</span>
    env = <span class="hljs-literal">true</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような単純なアプローチを使用して、コンテナーをNomadクラスターに配信するように構成し、将来的にそれを処理することができます。</font><font style="vertical-align: inherit;">私はある程度、Nomadに共感します。Kubernetesが追加の問題を引き起こし、その可能性を最後まで認識できない小規模なプロジェクトに適しています。</font><font style="vertical-align: inherit;">さらに、Nomadは初心者に最適です。インストールと設定が簡単です。</font><font style="vertical-align: inherit;">ただし、一部のプロジェクトでテストすると、以前のバージョンの問題が発生します。基本的な機能が多くないか、正しく機能しません。</font><font style="vertical-align: inherit;">それでも、Nomadは今後も開発を続け、将来的には必要な機能をすべて獲得していくと思います。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ilya Andreevによる投稿、Alexei Zhadanによる編集およびLive Linuxチーム</font></font><br>
</i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453310/index.html">RxJSライブラリを使用してReactコンポーネント間でデータを交換する</a></li>
<li><a href="../ja453312/index.html">XMLデータに基づくPDFビジネスメールジェネレーター</a></li>
<li><a href="../ja453314/index.html">DIY Black Mirror-チャットの履歴に基づいてボットを教える</a></li>
<li><a href="../ja453316/index.html">イギリスのARMチップメーカー、Huaweiとのコラボレーションを中止</a></li>
<li><a href="../ja453318/index.html">モバイルアプリケーションのプッシュ通知の実装における5つのエラー</a></li>
<li><a href="../ja453324/index.html">整流器としてのダイオード</a></li>
<li><a href="../ja453326/index.html">ITインフラストラクチャ管理を自動化する方法-3つのトレンドについて話し合う</a></li>
<li><a href="../ja453328/index.html">リモートサイトで10年</a></li>
<li><a href="../ja453330/index.html">RAMに障害が発生した場合の対処方法。既往歴と治療法</a></li>
<li><a href="../ja453332/index.html">ハードディスク容量を節約する奇妙な方法について</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>