<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👎🏾 🈶 😉 Laravel + Docker + Gitlab 从哪里开始 😟 🙋🏻 🦀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我通常总是没有docker，并认为只有大型公司中的大型项目才需要docker。但是有一天，我看到了码头工人如何与朋友的gitlab协同工作，并意识到我仍然应该研究它。但是，通常情况下，我找不到合适的文章-它们太复杂或不完整，或暗示大家都知道。我不得不长期寻找各种资源，将它们放在一起，最后我设法为其编...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Laravel + Docker + Gitlab 从哪里开始</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491532/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我通常总是没有docker，并认为只有大型公司中的大型项目才需要docker。</font><font style="vertical-align: inherit;">但是有一天，我看到了码头工人如何与朋友的gitlab协同工作，并意识到我仍然应该研究它。</font><font style="vertical-align: inherit;">但是，通常情况下，我找不到合适的文章-它们太复杂或不完整，或暗示大家都知道。</font><font style="vertical-align: inherit;">我不得不长期寻找各种资源，将它们放在一起，最后我设法为其编写了一个简单的项目和CI / CD。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有工作可以分为三个部分：在本地计算机上，在hitlab上和在服务器上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，对于项目的实施，我们需要一个gitlab帐户和一个具有KVM或XEN虚拟化功能的远程服务器。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1部分。本地计算机</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本地计算机上，您需要安装docker。 </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">评论</font></font></b><div class="spoiler_text">  . Docker     Linux  ( Ubuntu, ),    Windows  MacOS.   macos     ,     Windows      .   - ,        linux .   - ,           .       VirtualBox.          Ubuntu     <br>
</div></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要在Linux环境中安装，必须运行以下命令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
删除旧容器：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get remove docker docker-engine docker.io containerd runc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新apt：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
安装以下软件包，以便您可以通过https从存储库下载docker：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install \<font></font>
    apt-transport-https \<font></font>
    ca-certificates \<font></font>
    curl \<font></font>
    gnupg-agent \<font></font>
    software-properties-common</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
添加官方GPG Docker密钥：</font></font><br>
<br>
<pre><code class="bash hljs">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
确保打印正确：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-key fingerprint 0EBFCD88</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答：</font></font><br>
<br>
<pre><code class="bash hljs">pub   rsa4096 2017-02-22 [SCEA]<font></font>
      9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88<font></font>
uid           [ unknown] Docker Release (CE deb) &lt;docker@docker.com&gt;<font></font>
sub   rsa4096 2017-02-22 [S]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下载稳定版：</font></font><br>
<br>
<pre><code class="bash hljs">sudo add-apt-repository \
   <span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="hljs-subst">$(lsb_release -cs)</span> \
   stable"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再次更新apt：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
安装最新的docker引擎：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install docker-ce docker-ce-cli containerd.io</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
检查docker操作：</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker run hello-world</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果一切正确，将开始下载Hello World图像。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker官方文档中的完整说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还需要安装docker-compose。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">官方说明在这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要安装它，请在终端中执行命令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从资源库下载：</font></font><br>
<br>
<pre><code class="bash hljs">sudo curl -L <span class="hljs-string">"https://github.com/docker/compose/releases/download/1.25.4/docker-compose-<span class="hljs-subst">$(uname -s)</span>-<span class="hljs-subst">$(uname -m)</span>"</span> -o /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
添加行使权：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
版本检查：</font></font><br>
<br>
<pre><code class="bash hljs">sudo docker-compose --version</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们安装了泊坞窗，现在有必要收集映像。</font><font style="vertical-align: inherit;">为此，我使用了digitalocean网站上的文章：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.digitalocean.com/community/tutorials/how-to-set-up-laravel-nginx-and-mysql-with-docker-compose-ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">本文将重印。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下载Laravel并安装依赖项</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
第一步，我们下载最新版本的Laravel并安装项目依赖项，包括应用程序级PHP包管理器Composer。</font><font style="vertical-align: inherit;">我们将使用Docker安装这些依赖项，以免执行Composer的全局安装。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
转到主目录，并将最新版本的Laravel克隆到名为laravel-app的目录中：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~<font></font>
git <span class="hljs-built_in">clone</span> https://github.com/laravel/laravel.git laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进入laravel-app目录：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后将Docker中的composer映像挂载到Laravel项目所需的目录中，以避免全局安装Composer的开销：</font></font><br>
<br>
<pre><code class="bash hljs">docker run --rm -v $(<span class="hljs-built_in">pwd</span>):/app composer install</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
docker run命令的-v和--rm标志创建一个虚拟容器，该虚拟容器绑定到当前目录，直到将其删除。</font><font style="vertical-align: inherit;">〜/ laravel-app目录的内容将被复制到容器，并且在供应商文件夹容器内创建的Composer的内容将被复制到当前目录。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，在项目目录中设置权限级别，以使其由没有root特权的用户拥有：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>:<span class="hljs-variable">$USER</span> ~/laravel-app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当您为应用程序的映像编写Dockerfile时，这将很重要，因为它将允许您使用应用程序代码并在没有root特权的情况下启动容器中的进程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您已经放置了应用程序代码，并且可以使用Docker Compose进行服务的定义。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Docker Compose创建Docker Compose File</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Building应用程序可简化基础架构中的配置和版本控制过程。为了自定义我们的Laravel应用程序，我们将创建一个docker-compose文件，其中包含Web服务器服务，数据库和应用程序的定义。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
打开文件：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/docker-compose.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在docker-compose文件中定义了三个服务：app，webserver和db。</font><font style="vertical-align: inherit;">将以下代码添加到文件中，同时用您选择的密码替换定义为db服务环境变量的MYSQL_ROOT_PASSWORD的根密码：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">version: '3'<font></font>
services:<font></font>
<font></font>
  #PHP Service<font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #Nginx Service<font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "80:80"<font></font>
      - "443:443"<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  #MySQL Service<font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: true<font></font>
    ports:<font></font>
      - "3306:3306"<font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
#Docker Networks<font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这里包括以下服务：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应用程序：此服务定义包含Laravel应用程序，并启动个性化的Docker映像digitalocean.com/php。</font><font style="vertical-align: inherit;">还将容器中的working_dir参数设置为/ var / www。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网络服务器：此服务定义从Docker获取nginx：alpine映像，并打开端口80和443。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">db：此服务定义从Docker检索mysql：5.7.22映像，并定义新的环境变量，包括应用程序的laravel数据库和该数据库的root密码。</font><font style="vertical-align: inherit;">您可以使用所需的任何数据库名称，还应使用自己的强密码替换your_mysql_root_password。</font><font style="vertical-align: inherit;">此服务定义还将主机端口3306映射到容器端口3306。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个container_name属性定义一个与服务名称相对应的容器名称。</font><font style="vertical-align: inherit;">如果您未定义此属性，则Docker将为每个容器提供由历史人物的名称和随机单词组成的名称，并用下划线分隔。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了简化容器之间的交互，服务连接到名为app-network的连接网络。连接网络使用软件桥接器，该软件桥接器允许连接到该网络的容器相互通信。桥驱动程序会自动设置主机规则，以使不同连接网络上的容器无法直接相互通信。因为只有相关的服务才能相互通信，所以可以提高应用程序的安全性。这也意味着您可以指定连接到相关功能的不同网络和服务：例如，客户端应用程序服务可以使用前端网络，而服务器服务可以使用后端网络。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，让我们看一下如何添加卷并将绑定的映像绑定到服务定义以永久保存应用程序数据。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">持久数据存储</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Docker具有强大而便捷的持久数据存储方式。</font><font style="vertical-align: inherit;">在我们的应用程序中，我们将使用卷和装入的映像永久保存数据库文件，应用程序和配置。</font><font style="vertical-align: inherit;">卷在容器的生命周期终止时提供了备份灵活性和保存性，可安装的可安装映像通过立即反映容器中的主机文件或目录的更改，简化了开发过程中的代码更改。</font><font style="vertical-align: inherit;">我们同时使用这两种选择。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告！</font></font></b><div class="spoiler_text">             ,   ,        .      ,       Docker   .       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在db服务定义的docker-compose文件中定义名为dbdata的卷，以保留MySQL数据库：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
    networks:<font></font>
      - app-network<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名为dbdata的卷用于将/ var / lib / mysql文件夹的内容永久保存在容器内。</font><font style="vertical-align: inherit;">这使您可以停止并重新启动数据库服务，而不会丢失数据。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在文件末尾添加dbdata卷定义：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#Volumes<font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: local</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用此定义，您可以将此卷用于不同的服务。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后将安装映像绑定添加到MySQL配置文件的db服务：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">...<font></font>
#MySQL Service<font></font>
db:<font></font>
  ...<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该挂载的映像将〜/ laravel-app / mysql / my.cnf文件绑定到容器中的/etc/mysql/my.cnf目录。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后将安装的映像添加到Web服务器服务。</font><font style="vertical-align: inherit;">将有两个：一个用于应用程序代码，另一个用于确定Nginx配置</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#Nginx Service<font></font>
webserver:<font></font>
  ...<font></font>
  volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
  networks:<font></font>
      - app-network</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个安装的映像将〜/ laravel-app目录中的应用程序代码绑定到容器内的/ var / www目录。添加到〜/ laravel-app / nginx / conf.d /中的配置文件也安装在容器中的/etc/nginx/conf.d/中，该文件允许您根据需要添加和更改配置目录的内容。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总之，将以下已安装的映像安装添加到应用程序服务中的应用程序代码和配置文件：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="xml hljs">#PHP Service<font></font>
app:<font></font>
  ...<font></font>
  volumes:<font></font>
       - ./:/var/www<font></font>
       - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini<font></font>
  networks:<font></font>
      - app-network<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
应用程序服务将包含应用程序代码的〜/ laravel-app文件夹的安装映像绑定到/ var / www文件夹。这将加速开发过程，因为本地应用程序目录中的任何更改都将立即反映在容器中。您还可以将PHP配置文件〜/ laravel-app / php / local.ini链接到容器中的/usr/local/etc/php/conf.d/local.ini文件。稍后，您将创建本地PHP配置文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您的docker-compose文件现在将如下所示：</font></font><br>
<br>
<code>~/laravel-app/docker-compose.yml</code><br>
<br>
<pre><code class="bash hljs">version: <span class="hljs-string">'3'</span><font></font>
services:<font></font>
<font></font>
  <span class="hljs-comment">#PHP Service</span><font></font>
  app:<font></font>
    build:<font></font>
      context: .<font></font>
      dockerfile: Dockerfile<font></font>
    image: digitalocean.com/php<font></font>
    container_name: app<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    environment:<font></font>
      SERVICE_NAME: app<font></font>
      SERVICE_TAGS: dev<font></font>
    working_dir: /var/www<font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./php/local.ini:/usr/<span class="hljs-built_in">local</span>/etc/php/conf.d/local.ini<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#Nginx Service</span><font></font>
  webserver:<font></font>
    image: nginx:alpine<font></font>
    container_name: webserver<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"80:80"</span>
      - <span class="hljs-string">"443:443"</span><font></font>
    volumes:<font></font>
      - ./:/var/www<font></font>
      - ./nginx/conf.d/:/etc/nginx/conf.d/<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
  <span class="hljs-comment">#MySQL Service</span><font></font>
  db:<font></font>
    image: mysql:5.7.22<font></font>
    container_name: db<font></font>
    restart: unless-stopped<font></font>
    tty: <span class="hljs-literal">true</span><font></font>
    ports:<font></font>
      - <span class="hljs-string">"3306:3306"</span><font></font>
    environment:<font></font>
      MYSQL_DATABASE: laravel<font></font>
      MYSQL_ROOT_PASSWORD: your_mysql_root_password<font></font>
      SERVICE_TAGS: dev<font></font>
      SERVICE_NAME: mysql<font></font>
    volumes:<font></font>
      - dbdata:/var/lib/mysql/<font></font>
      - ./mysql/my.cnf:/etc/mysql/my.cnf<font></font>
    networks:<font></font>
      - app-network<font></font>
<font></font>
<span class="hljs-comment">#Docker Networks</span><font></font>
networks:<font></font>
  app-network:<font></font>
    driver: bridge<font></font>
<span class="hljs-comment">#Volumes</span><font></font>
volumes:<font></font>
  dbdata:<font></font>
    driver: <span class="hljs-built_in">local</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建Dockerfile</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Docker允许您使用Dockerfile在单个容器内定义环境。</font><font style="vertical-align: inherit;">Dockerfile允许您创建个性化映像。</font><font style="vertical-align: inherit;">可以用来安装所需的应用程序软件并根据需要更改设置。</font><font style="vertical-align: inherit;">您可以将创建的映像传输到Docker Hub或任何私有注册表。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerfile将位于〜/ laravel-app目录中。</font><font style="vertical-align: inherit;">创建一个文件：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/Dockerfile</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该Dockerfile将指定基本映像以及构建Laravel应用程序映像所需的命令和说明。</font><font style="vertical-align: inherit;">将以下代码添加到文件中：</font></font><br>
<br>
<code>~/laravel-app/php/Dockerfile</code><br>
<br>
<pre><code class="xml hljs">FROM php:7.2-fpm<font></font>
<font></font>
# Copy composer.lock and composer.json<font></font>
COPY composer.lock composer.json /var/www/<font></font>
<font></font>
# Set working directory<font></font>
WORKDIR /var/www<font></font>
<font></font>
# Install dependencies<font></font>
RUN apt-get update &amp;&amp; apt-get install -y \<font></font>
    build-essential \<font></font>
    mysql-client \<font></font>
    libpng-dev \<font></font>
    libjpeg62-turbo-dev \<font></font>
    libfreetype6-dev \<font></font>
    locales \<font></font>
    zip \<font></font>
    jpegoptim optipng pngquant gifsicle \<font></font>
    vim \<font></font>
    unzip \<font></font>
    git \<font></font>
    curl<font></font>
<font></font>
# Clear cache<font></font>
RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*<font></font>
<font></font>
# Install extensions<font></font>
RUN docker-php-ext-install pdo_mysql mbstring zip exif pcntl<font></font>
RUN docker-php-ext-configure gd --with-gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/<font></font>
RUN docker-php-ext-install gd<font></font>
<font></font>
# Install composer<font></font>
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer<font></font>
<font></font>
# Add user for laravel application<font></font>
RUN groupadd -g 1000 www<font></font>
RUN useradd -u 1000 -ms /bin/bash -g www www<font></font>
<font></font>
# Copy existing application directory contents<font></font>
COPY . /var/www<font></font>
<font></font>
# Copy existing application directory permissions<font></font>
COPY --chown=www:www . /var/www<font></font>
<font></font>
# Change current user to www<font></font>
USER www<font></font>
<font></font>
# Expose port 9000 and start php-fpm server<font></font>
EXPOSE 9000<font></font>
CMD ["php-fpm"]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，Dockerfile在php之上创建映像：7.2-fpm Docker映像。这是基于已安装的PHP FastCGI PHP-FPM实例的映像。该文件还会安装Laravel所需的软件包：带有composer的mcrypt，pdo_mysql，mbstring和imagick。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RUN指令指定用于更新，安装和配置容器内部参数的命令，这些命令包括专用用户和名为www的组。 WORKDIR语句将目录/ var / www设置为应用程序的工作目录。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建具有受限访问权限的单独用户和组可减少启动Docker容器时的漏洞，默认情况下，该容器以root特权运行。我们没有以root用户权限运行此容器，而是使用带有--chown标志的COPY命令创建了一个对/ var / www文件夹具有读写权限的www用户，以复制应用程序文件夹的权限。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EXPOSE命令在php-fpm服务器的容器中打开端口9000。 CMD指示在创建容器后应运行的命令。在此，CMD表示启动服务器的php-fpm命令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成更改后，保存文件并关闭编辑器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以继续定义PHP配置。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP设置</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您已经在docker-compose文件中定义了基础架构，现在您可以将PHP服务配置为充当传入Nginx请求的PHP处理器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要配置PHP，您将在php文件夹中创建一个local.ini文件。</font><font style="vertical-align: inherit;">这是您链接到上面容器中的/usr/local/etc/php/conf.d/local.ini文件的文件。</font><font style="vertical-align: inherit;">创建此文件将使您可以忽略PHP在启动时读取的默认php.ini文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建一个php目录：</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/php</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后打开local.ini文件：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/php/local.ini</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了演示PHP的设置，我们将添加以下代码来设置文件上传大小限制：</font></font><br>
<br>
<code>~/laravel-app/php/local.ini</code><br>
<br>
<pre><code class="xml hljs">upload_max_filesize=40M<font></font>
post_max_size=40M</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
upload_max_filesize和post_max_size指令设置了上载文件的最大允许大小，并显示了如何从local.ini文件设置php.ini配置。您可以在local.ini文件中插入要忽略的任何PHP配置参数。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置Nginx</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
配置PHP服务时，可以修改Nginx服务以将PHP-FPM用作FastCGI服务器来提供动态内容。 FastCGI服务器基于二进制协议，用于交互程序与Web服务器的交互。在文章“在Nginx中理解和实现FastCGI代理”中可以找到更多信息。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要配置Nginx，您将使用〜/ laravel-app / nginx / conf.d /文件夹中的服务配置创建一个app.conf文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先创建nginx / conf.d /目录：</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p ~/laravel-app/nginx/conf.d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后创建app.conf配置文件：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/nginx/conf.d/app.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将以下代码添加到文件中以配置Nginx：</font></font><br>
<br>
<code>~/laravel-app/nginx/conf.d/app.conf</code><br>
<br>
<pre><code class="xml hljs">server {<font></font>
    listen 80;<font></font>
    index index.php index.html;<font></font>
    error_log  /var/log/nginx/error.log;<font></font>
    access_log /var/log/nginx/access.log;<font></font>
    root /var/www/public;<font></font>
    location ~ \.php$ {<font></font>
        try_files $uri =404;<font></font>
        fastcgi_split_path_info ^(.+\.php)(/.+)$;<font></font>
        fastcgi_pass app:9000;<font></font>
        fastcgi_index index.php;<font></font>
        include fastcgi_params;<font></font>
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<font></font>
        fastcgi_param PATH_INFO $fastcgi_path_info;<font></font>
    }<font></font>
    location / {<font></font>
        try_files $uri $uri/ /index.php?$query_string;<font></font>
        gzip_static on;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
服务器块使用以下指令配置Nginx Web服务器：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listen：此伪指令定义服务器侦听传入请求的端口。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error_log和access_log：这些指令定义用于记录的文件。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root：此伪指令将路径设置为根文件夹，从而形成本地文件系统中任何请求的文件的完整路径。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在php location块中，fastcgi_pass指令指示该应用服务正在侦听端口9000上的TCP套接字。使用它，PHP-FPM服务器将在网络上侦听，而不是在Unix套接字上侦听。尽管Unix套接字比TCP套接字在速度上有一点优势，但它没有网络协议，并且会跳过网络堆栈。如果主机位于同一系统上，则可以使用Unix套接字，但是如果服务在不同的主机上运行，​​则TCP套接字通过允许您连接到分布式服务而具有优势。由于我们的应用程序和Web服务器容器在不同的主机上运行，​​因此在我们的配置中使用TCP套接字效率更高。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成更改后，保存文件并关闭编辑器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于先前创建的绑定，nginx / conf.d /文件夹中的任何更改都直接反映在webserver容器中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在让我们看一下MySQL参数。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置MySQL</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
设置PHP和Nginx之后，您可以将MySQL激活为应用程序的数据库。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要配置MySQL，您需要在mysql文件夹中创建my.cnf文件。</font><font style="vertical-align: inherit;">这是您在数据库配置步骤中附加到容器内的/etc/mysql/my.cnf文件的文件。</font><font style="vertical-align: inherit;">如果需要，在需要时，通过挂载挂载的映像，您可以忽略任何my.cnf选项。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了演示它是如何工作的，我们将在my.cnf中添加包括常规请求日志的设置并设置日志文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建一个mysql目录：</font></font><br>
<br>
<pre><code class="bash hljs">mkdir ~/laravel-app/mysql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建my.cnf文件：</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/laravel-app/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将以下代码添加到文件中以激活查询日志并设置日志文件的位置：</font></font><br>
<br>
<code>~/laravel-app/mysql/my.cnf</code><br>
<br>
<pre><code class="xml hljs">[mysqld]<font></font>
general_log = 1<font></font>
general_log_file = /var/lib/mysql/general.log</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
my.cnf文件通过将general_log参数设置为1（启用常规日志）来支持日志。</font><font style="vertical-align: inherit;">general_log_file参数指定日志的存储位置。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动容器并更改环境设置</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
您已在docker-compose文件中定义了所有服务，并为这些服务创建了配置文件。</font><font style="vertical-align: inherit;">现在您可以运行容器。</font><font style="vertical-align: inherit;">总之，我们将创建Laravel默认包含的.env.example文件的副本，并将其命名为.env，因为Laravel使用此类文件来确定环境：</font></font><br>
<br>
<pre><code class="bash hljs">cp .env.example .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
启动容器后，我们将在此文件中配置特定的安装参数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，所有服务都在docker-compose文件中定义，您只需要运行一个命令即可启动所有容器，创建卷以及配置和连接网络：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose up -d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首次启动docker-compose up时，将下载所有必要的Docker映像，这可能需要一些时间。</font><font style="vertical-align: inherit;">下载图像并将其保存在本地计算机上之后，Compose将创建您的容器。</font><font style="vertical-align: inherit;">-d标志将进程转换为守护程序，容器将继续在后台运行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该过程完成后，使用以下命令列出所有正在运行的容器：</font></font><br>
<pre><code class="bash hljs">docker ps</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您将在应用程序，Web服务器和数据库容器上看到以下结果以及数据：</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
CONTAINER ID        NAMES               IMAGE                             STATUS              PORTS<font></font>
c31b7b3251e0        db                  mysql:5.7.22                      Up 2 seconds        0.0.0.0:3306-&gt;3306/tcp<font></font>
ed5a69704580        app                 digitalocean.com/php              Up 2 seconds        9000/tcp<font></font>
5ce4ee31d7c0        webserver           nginx:alpine                      Up 2 seconds        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这些结果中，CONTAINER ID是每个容器的唯一标识符，并且NAMES列出了每个容器的服务名称。</font><font style="vertical-align: inherit;">您可以使用这两个标识符来访问容器。</font><font style="vertical-align: inherit;">IMAGE定义每个容器的映像名称，STATUS提供有关容器状态的信息：启动，重新启动或停止。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以修改应用容器中的.env文件，以将特定参数添加到系统中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用docker-compose exec打开文件，这使您可以在容器中运行特定命令。</font><font style="vertical-align: inherit;">在这种情况下，您可以打开文件进行编辑：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app nano .env</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
找到指定DB_CONNECTION的块并进行更新以反映您的系统设置。</font><font style="vertical-align: inherit;">您将更改以下字段：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_HOST将是您的数据库数据库容器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_DATABASE将是laravel数据库。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_USERNAME将是您的数据库的用户名。</font><font style="vertical-align: inherit;">在这种情况下，我们将使用laraveluser。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DB_PASSWORD将是为此用户帐户保护的密码。</font></font></li>
</ol><br>
<code>/var/www/.env</code><br>
<br>
<pre><code class="xml hljs">DB_CONNECTION=mysql<font></font>
DB_HOST=db<font></font>
DB_PORT=3306<font></font>
DB_DATABASE=laravel<font></font>
DB_USERNAME=laraveluser<font></font>
DB_PASSWORD=your_laravel_db_password</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还需要更正.env.example文件中的相同变量，因为稍后将在部署到服务器时使用它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后使用php artisan键为Laravel配置应用程序键：generate命令。</font><font style="vertical-align: inherit;">此命令将生成一个密钥并将其复制到.env文件，该文件将保护用户会话和加密的数据：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan key:generate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您具有运行该应用程序所需的所有必要环境设置。</font><font style="vertical-align: inherit;">要将这些设置缓存在可以加快应用程序加载速度的文件中，请运行以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan config:cache</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配置设置将被加载到容器中的/var/www/bootstrap/cache/config.php文件中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，在浏览器中打开</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">站点</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Laravel应用程序的主页打开。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建MySQL用户</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
安装MySQL时，默认情况下，仅创建一个具有无限特权的管理根帐户来访问数据库服务器。</font><font style="vertical-align: inherit;">通常，在使用数据库时，最好避免使用管理根帐户。</font><font style="vertical-align: inherit;">相反，我们将为应用程序的Laravel数据库创建一个特殊的数据库用户。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要创建新用户，请使用docker-compose exec命令在db容器中启动bash交互式shell：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> db bash</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在容器内，登录到MySQL根管理帐户：</font></font><br>
<br>
<pre><code class="sql hljs">mysql -u root -p</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
安装在docker-compose文件中时，系统将提示您输入为MySQL根帐户指定的密码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，检查docker-compose文件中定义的laravel数据库。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行show database命令以验证现有数据库：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">show</span> <span class="hljs-keyword">databases</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在结果中，您应该看到laravel数据库：</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
+--------------------+<font></font>
| Database           |<font></font>
+--------------------+<font></font>
| information_schema |<font></font>
| laravel            |<font></font>
| mysql              |<font></font>
| performance_schema |<font></font>
| sys                |<font></font>
+--------------------+<font></font>
5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后创建一个将被允许访问该数据库的用户帐户。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们使用laraveluser用户名，但您可以将其替换为任何首选名称。</font><font style="vertical-align: inherit;">只要确保用户名和密码与上一步中的.env文件中的用户名和密码匹配即可：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> laravel.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'laraveluser'</span>@<span class="hljs-string">'%'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'your_laravel_db_password'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新特权以通知MySQL服务器更改：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">FLUSH</span> <span class="hljs-keyword">PRIVILEGES</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关闭MySQL：</font></font><br>
<br>
<pre><code class="sql hljs">EXIT;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
退出容器：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">exit</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以进行迁移以测试数据库：</font></font><br>
<br>
<pre><code class="bash hljs">docker-compose <span class="hljs-built_in">exec</span> app php artisan migrate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
迁移确认的结果如下：</font></font><br>
<br>
<pre><code class="bash hljs">Output<font></font>
<font></font>
Migration table created successfully.<font></font>
Migrating: 2014_10_12_000000_create_users_table<font></font>
Migrated:  2014_10_12_000000_create_users_table<font></font>
Migrating: 2014_10_12_100000_create_password_resets_table<font></font>
Migrated:  2014_10_12_100000_create_password_resets_table</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2部分。Gitlab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Hitlab中，您需要创建一个新项目。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们需要将项目保存在hitlab存储库中。</font><font style="vertical-align: inherit;">为此，请从本地计算机上的项目文件夹中调用以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">git init<font></font>
git remote add origin git@gitlab.com:&lt;&gt;/&lt;&gt;  <font></font>
git remote add origin https://gitlab.com/&lt;&gt;/&lt;&gt;      SSH<font></font>
git add .<font></font>
git commit -m <span class="hljs-string">"Initial commit"</span>
git push -u origin master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该项目应该出现在“项目概述-&gt;详细信息”中，</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了方便立即获得完成的环境，我们将环境的docker映像保存在命中列表注册表中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为此，您必须执行以下操作：</font></font><br>
<br>
<pre><code class="bash hljs">docker login registry.gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并将图像扔到gitlab上：</font></font><br>
<br>
<pre><code class="bash hljs">docker build -t registry.gitlab.com/&lt;&gt;/&lt;&gt; .<font></font>
docker push registry.gitlab.com/&lt;&gt;/&lt;&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该图像位于Packages-&gt; Container Registry。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要完成gitlab，我们立即获得gitlab-runner的密钥。</font><font style="vertical-align: inherit;">为此，请转至设置-&gt; CI / CD-&gt;运行器。</font><font style="vertical-align: inherit;">密钥位于“手动配置”部分（手动设置特定的运行器）的第3步中。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3部分。服务器配置</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPS服务器必须采用虚拟化类型KVM或XEN。</font><font style="vertical-align: inherit;">像OpenVZ这样的虚拟化在所有用户之间共享系统的核心，因此它无法更改内核参数。</font><font style="vertical-align: inherit;">为了进行测试，我选择了预先安装了Docker的KVM服务器。</font><font style="vertical-align: inherit;">但是，服务器上可能没有泊坞窗。</font><font style="vertical-align: inherit;">在这种情况下，您必须手动安装它。</font><font style="vertical-align: inherit;">该算法与在本地计算机上安装时的算法相同。</font><font style="vertical-align: inherit;">还需要检查php版本。</font><font style="vertical-align: inherit;">对于Laravel，您至少需要7.2。</font><font style="vertical-align: inherit;">我还必须单独安装php ext-mbstring的扩展名（以我的php 7.3为例）：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update<font></font>
sudo apt-get install php7.3-mbstring<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我们需要安装gitlab-runner。</font><font style="vertical-align: inherit;">Runner是一项服务，当接收到新版本时，它将接受来自hitlab的webhook，并将所有内容部署在我们的服务器上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要安装gitlab-runner，您需要执行以下操作：</font></font><br>
<br>
<pre><code class="bash hljs">curl -L --output /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下载后，设置执行权限：</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod +x /usr/<span class="hljs-built_in">local</span>/bin/gitlab-runner
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，创建gitlab-runner用户并运行gitlabRunner服务：</font></font><br>
<br>
<pre><code class="bash hljs">sudo useradd --comment <span class="hljs-string">'GitLab Runner'</span> --create-home gitlab-runner --shell /bin/bash<font></font>
sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner<font></font>
sudo gitlab-runner start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注册跑步者。</font><font style="vertical-align: inherit;">为此，我们需要本文第2部分中的令牌：</font></font><br>
<br>
<pre><code class="bash hljs">sudo gitlab-runner register</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为回应，他们会要求您提供Hitlab的地址。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gitlab.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )<font></font>
https://gitlab.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，您需要输入令牌。</font><font style="vertical-align: inherit;">输入第2部分中的令牌。</font></font><br>
<br>
<pre><code class="bash hljs">Please enter the gitlab-ci token <span class="hljs-keyword">for</span> this runner<font></font>
xxx<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，指定描述和以逗号分隔的标签。</font><font style="vertical-align: inherit;">然后我们被提供选择执行者。</font><font style="vertical-align: inherit;">在这里，您需要选择一个外壳：</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
Please enter the executor:<font></font>
shell</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
据我了解，执行器是一个环境，在其中执行.gitlab-ci.yml文件中的代码。</font><font style="vertical-align: inherit;">有bash，ssh，docker，parallels，virtualbox和kubernets供您选择。</font><font style="vertical-align: inherit;">该文档建议，如果您不知道使用什么，请使用bash。</font><font style="vertical-align: inherit;">这是在服务器上的命令行上运行的通用选项。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我们需要将gitlab-runner用户添加到docker用户组。</font></font><br>
<br>
<pre><code class="bash hljs">sudo usermod -aG docker gitlab-runner</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为避免访问错误，请添加到sudoers</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/sudoers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
线 </font></font><br>
<br>
<pre><code class="bash hljs">gitlab-runner ALL=(ALL) NOPASSWD: ALL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们可以创建.gitlab-ci.yml文件。</font><font style="vertical-align: inherit;">执行所谓的管道是必需的：用于部署项目的一系列命令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为此，请转到命中列表上的项目存储库，然后单击“创建新文件”。</font><font style="vertical-align: inherit;">Gitlab本人将提供文件模板，您必须在其中选择.gitlab-ci.yml。</font><font style="vertical-align: inherit;">在gitlab中创建文件后，可以为文件内容选择模板。</font><font style="vertical-align: inherit;">我选择了laravel并为自己重做一点：</font></font><br>
<br>
<pre><code class="xml hljs"><font></font>
# This file is a template, and might need editing before it works on your project.<font></font>
# Official framework image. Look for the different tagged releases at:<font></font>
# https://hub.docker.com/r/library/php<font></font>
# .    ,        <font></font>
image: registry.gitlab.com/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name"></span>&gt;</span>:latest<font></font>
<font></font>
# Pick zero or more services to be used on all builds.<font></font>
# Only needed when using a docker container to run your tests in.<font></font>
# Check out: http://docs.gitlab.com/ce/ci/docker/using_docker_images.html#what-is-a-service<font></font>
services:<font></font>
  - mysql:latest<font></font>
#    <font></font>
variables:<font></font>
  MYSQL_DATABASE: laravel<font></font>
  MYSQL_ROOT_PASSWORD: ***********<font></font>
<font></font>
# This folder is cached between builds<font></font>
# ,      <font></font>
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache<font></font>
cache:<font></font>
  paths:<font></font>
    - vendor/<font></font>
    - node_modules/<font></font>
<font></font>
# This is a basic example for a gem or script which doesn't use<font></font>
# services such as redis or postgres<font></font>
#     <font></font>
before_script:<font></font>
  #   <font></font>
  - sudo apt-get update -yqq<font></font>
  #    nodejs<font></font>
  - sudo apt-get install gnupg -yqq<font></font>
  #  Node   12<font></font>
  - curl -sL https://deb.nodesource.com/setup_12.x | sudo bash -<font></font>
  #  <font></font>
  - sudo apt-get install git nodejs libcurl4-gnutls-dev libicu-dev libmcrypt-dev libvpx-dev libjpeg-dev libpng-dev libxpm-dev zlib1g-dev libfreetype6-dev libxml2-dev libexpat1-dev libbz2-dev libgmp3-dev libldap2-dev unixodbc-dev libpq-dev libsqlite3-dev libaspell-dev libsnmp-dev libpcre3-dev libtidy-dev -yqq<font></font>
  #  composer<font></font>
  - curl -sS https://getcomposer.org/installer | php<font></font>
  - php composer.phar install<font></font>
  - composer install<font></font>
  #   Node<font></font>
  - npm install<font></font>
  # Copy over testing configuration.<font></font>
  # Don't forget to set the database config in .env.testing correctly<font></font>
  - DB_HOST=mysql<font></font>
  - DB_DATABASE=laravel<font></font>
  - DB_USERNAME=root<font></font>
  - DB_PASSWORD=*********<font></font>
  #  .env.example    .env<font></font>
  - cp .env.example .env<font></font>
  #  npm build<font></font>
  - npm run dev<font></font>
  #       laravel<font></font>
  - php artisan key:generate<font></font>
  - php artisan config:cache<font></font>
  - php artisan route:clear<font></font>
  - php artisan config:clear<font></font>
  - php artisan cache:clear<font></font>
  #  .<font></font>
  - docker-compose exec app php artisan migrate<font></font>
  #   <font></font>
  #- docker-compose exec app php artisan db:seed<font></font>
<font></font>
#<font></font>
test:<font></font>
  script:<font></font>
    #  <font></font>
    - php vendor/bin/phpunit --coverage-text --colors=never<font></font>
    #  npm<font></font>
    - npm test<font></font>
<font></font>
#       <font></font>
deploying:<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - echo "Deployed"<font></font>
    - docker-compose stop<font></font>
    - docker-compose up -d<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在服务器的IP地址成功执行管道（CI / CD-&gt;管道）后，您应该看到laravel页面。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要配置CI / CD，我使用了Sean Bradley的说明：</font></font><br>
<br>
<div class="oembed"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://youtu.be/RV0845KmsNI</font></font></a></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">medium.com/@sean_bradley/auto-devops-with-gitlab-ci-and-docker-compose-f931233f080f</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN491520/index.html">在C＃中将xls转换为xlsx和xml</a></li>
<li><a href="../zh-CN491522/index.html">女人为什么寿命更长</a></li>
<li><a href="../zh-CN491524/index.html">Stas Afanasyev。朱诺 基于io.Reader / io.Writer的管道。第2部分</a></li>
<li><a href="../zh-CN491528/index.html">我的经验是进行1000次面试。Yegor Bugaenko的报告摘要</a></li>
<li><a href="../zh-CN491530/index.html">再次关于433 MHz发射机和接收机</a></li>
<li><a href="../zh-CN491534/index.html">使用GDB的简要指南</a></li>
<li><a href="../zh-CN491536/index.html">YouTube-错误。请稍后再试。播放ID：<...></a></li>
<li><a href="../zh-CN491540/index.html">面向新手IT专家的网络。强制性基地</a></li>
<li><a href="../zh-CN491542/index.html">颜色转换：稀疏表搜索</a></li>
<li><a href="../zh-CN491544/index.html">在剩余的周末里读些什么-有关病毒，黑客和“数字”卡特尔历史的书籍</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>