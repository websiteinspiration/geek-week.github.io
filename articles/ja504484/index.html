<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕛 👩🏼‍💼 ❤️ IPSec全能 🛳️ 👨‍🚀 🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは。私たちの多くが少なくとも一度は持っていることは秘密ではありませんが、VPNを構成する必要性に対処しなければなりませんでした。Habrのアクティブリーダーである私は、IPSecに関する記事が豊富であるにもかかわらず、多くの人にとって、まだ複雑で過負荷になっているように見えます。この記事では...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec全能</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは。</font><font style="vertical-align: inherit;">私たちの多くが少なくとも一度は持っていることは秘密ではありませんが、VPNを構成する必要性に対処しなければなりませんでした。</font><font style="vertical-align: inherit;">Habrのアクティブリーダーである私は、IPSecに関する記事が豊富であるにもかかわらず、多くの人にとって、まだ複雑で過負荷になっているように見えます。</font><font style="vertical-align: inherit;">この記事では、例として独自の完全に機能する構成を使用して、これらの神話を払拭することを試みます。</font><font style="vertical-align: inherit;">4つの例では、PSKキーを使用したサイド認証を使用する単純なトンネルから、Let's Encryptの証明書に基づいて両側を認証するホスト間接続まで、最も一般的なLinux（Strongswan）ソリューションをセットアップするプロセス全体を実行します。</font><font style="vertical-align: inherit;">面白い？</font><font style="vertical-align: inherit;">猫へようこそ！</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックグラウンド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当初、VPNは、親のミニルーターとルーターとしても機能するホーム "ベッドサイド"サーバーとの間のチャネルの編成のためにのみ計画されていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくして、Keeneticは2つのデバイスからこの会社に追加されました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、いったん開始すると、止めるのは難しいことがわかり、すぐに図に電話とラップトップが現れ、MT_Freeや他の暗号化されていないWiFiネットワークのすべてを見ている広告の目から隠したいと考えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、最愛のILVはようやく、あらゆる方向に公的に振る舞うことに非常に夢中になったBanhammerを強くし、単なる人間に対する懸念を打ち消す</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ために、海外のIT部門</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が海外でVPSを取得するの</font><font style="vertical-align: inherit;">を</font><s><font style="vertical-align: inherit;">サポート</font></s><font style="vertical-align: inherit;">する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、Shapoklyakのように見える特定の市民が</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージ</font><s><font style="vertical-align: inherit;">によって</font></s><font style="vertical-align: inherit;">彼女の</font><s><font style="vertical-align: inherit;">レチクルで</font></s><font style="vertical-align: inherit;">どこでも走り回っていて</font><font style="vertical-align: inherit;">、おそらく「だれが人々を助けるかは時間を浪費していると信じています。</font><font style="vertical-align: inherit;">あなたは善行で有名になることはできません。「私は他人の交通をこっそり覗いて鉛筆で見たかったのです。</font><font style="vertical-align: inherit;">私達はまた、この場合医師が命じたそのような頼まれていない愛とVPNから身を守る必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
短い要約を要約します。</font><font style="vertical-align: inherit;">理想的には、一度に複数のタスクを閉じることができるソリューションを見つける必要がありました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linuxルーター間の相互接続</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LinuxとKeenetic Householdの間にトンネルを構築する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 信頼できないネットワークからウェアラブルデバイス（電話、ラップトップ）へのホームリソースとインターネットへのアクセスを許可する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 安全に暗号化されたリモートVPSへのトンネルを作成する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
素晴らしいKISSの原則を忘れないでください。KeepIt Simple、Stupidです。</font><font style="vertical-align: inherit;">含まれるコンポーネントが少なくなり、各コンポーネントの構成が簡単になり、信頼性が高くなります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存のソリューションの概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのプロトコルの</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Grandfather Leninについて</font><font style="vertical-align: inherit;">
簡単に説明</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">死んで、「カビとリンデンの蜂蜜に分解された」。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1つのプロバイダー以外の誰かがこれを使用していますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wireguard</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プロジェクトが開発中です。</font><font style="vertical-align: inherit;">積極的に製材。</font><font style="vertical-align: inherit;">静的IPを持つ2つのピア間にトンネルを作成するのは簡単です。</font><font style="vertical-align: inherit;">他の場合では、松葉杖、四角い車輪の付いた自転車、青い電気テープがいつでも役に立ちますが、これは私たちのやり方ではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プロ：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 複数のプラットフォームのサポート-Windows、Linux、OpenWRTおよびその派生物、Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 強力な暗号化と証明書のサポート。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> カスタマイズの柔軟性。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 そして短所：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 完全にユーザー空間で作業します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ホームルーターからの限定サポート-Mikrotikでのkrenenko-kosenko（腺の他の利点を損なうことなく）およびOpenWRTでの通常。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> モバイルクライアントの設定の難しさ：独自のインストーラーをダウンロードまたは作成し、どこかに設定をコピーする必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> トンネルが複数ある場合は、サーバー上でsystemdユニットを編集してダンスを待ちます。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect（Cisco Anyconnectプロトコルのオープンソース実装）</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
非常に興味深いソリューションですが、残念ながら、これはかなりの情報です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長所：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ストアのネイティブCisco Anyconnectアプリケーションに基づくWindows、Android、Macなどのさまざまなプラットフォームの比較的幅広いサポートは、ウェアラブルデバイスの内部ネットワークへのアクセスを提供する理想的なオプションです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 強力な暗号化、証明書のサポート、2FA接続</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコル自体は完全にTLSベースです（OpenVPNはポート443で簡単に検出されます）。</font><font style="vertical-align: inherit;">TLSに加えて、DTLSもサポートされます-確立されたセッション中に、クライアントはUDPを介したデータの送信に切り替えることができ、その逆も可能です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPNとsniproxyを使用した本格的なWebサーバーの両方の1つのポートでの優れた共存。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> サーバーとクライアントの両方の簡単なセットアップ。</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここにも短所がありました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 完全にユーザー空間で作業します。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCPの上にTCPを置くことは悪い考えです。</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> カスタマーグレードの機器からのサポートはありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つのLinuxの間にトンネルをインストールすることの複雑さ：理論的には可能であり、実際には-より有用なものに時間を費やすことをお勧めします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 複数のトンネルがある場合、いくつかの構成とsystemdユニットの編集によるダンスが待っています。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行き止まりのように見えますが、よく見て調査に少し時間をかけたところ、IKEv2ベースのIPSecで他のすべてのものを置き換えることができることに気付きました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プロ：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IKEv2の登場により、プロトコル自体は以前のバージョンに比べて構成が簡単になりましたが、下位互換性が失われています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準化のおかげで、作業はいつでもどこでも提供されます-リストは無期限に維持できます。</font><font style="vertical-align: inherit;">Linux、Mikrotik（RouterOSの最新バージョン）、OpenWRT、Android、iPhone。</font><font style="vertical-align: inherit;">Windowsには、Windows 7以降のネイティブサポートもあります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速：完全にカーネル空間でのトラフィック処理。</font><font style="vertical-align: inherit;">ユーザースペース部分は、接続パラメータの設定とチャネルの状態の監視にのみ必要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PSKと証明書の両方、および任意の組み合わせを使用して、いくつかの認証方法を使用する機能。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの操作モード：トンネルと輸送。</font><font style="vertical-align: inherit;">それらがどのように異なるかは、Habréを含めて読むことができます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中間ノードの要求の厳しくない設定：IKEの最初のバージョンでNATが原因で問題が発生した場合、IKEv2には、NATおよびIKEメッセージのネイティブフラグメンテーションを克服するための組み込みメカニズムがあり、MTUカーブを使用してチャネルで接続を確立できます。</font><font style="vertical-align: inherit;">今後は、クライアントが接続を確立できるところならどこでも、WiFiネットワークに出会ったことはありません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、短所もあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> あなたはそれがどのように機能するかを勉強して理解するのに少し時間を費やす必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初心者を混乱させる可能性がある機能：IPSecは、従来のVPNソリューションとは異なり、ネットワークインターフェイスを作成しません。</font><font style="vertical-align: inherit;">トラフィック処理ポリシーのみが設定され、それ以外はファイアウォールによって解決されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セットアップを進める前に、読者は基本的な概念と用語にすでに少し慣れていると想定しています。</font><font style="vertical-align: inherit;">初心者を助けるために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とHabr自身</font><font style="vertical-align: inherit;">からの記事を推奨できます</font><font style="vertical-align: inherit;">。この記事には、このトピックに関する非常に興味深く有用な記事が既にあります。</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セットアップの開始</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
決定が決まったら、構成に進みます。</font><font style="vertical-align: inherit;">私の場合のネットワーク図は次の形式です（スポイラーの下で削除されています）</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク図</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ネットワークの中心であるホームサーバーです。外部IP 1.1.1.1。 VPSとのプライベートBGPセッションを設定するための内部ネットワーク10.0.0.0/23および別のアドレス10.255.255.1/30。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ママ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、親がインストールした小さなサイレントネットトップに基づくLinuxルーターです。 ISPは動的IPアドレスを発行します。内部ネットワーク10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -IPSecがインストールされた</font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;">ルーター。 ISPは動的IPアドレスを発行します。内部ネットワーク10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードウォリアー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -信頼できないネットワークから接続するポータブルデバイス。アドレスは、内部プール（10.1.1.0/24）から接続されたときに動的にクライアントに発行されます。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-尊敬されるILVの管轄外のVPS。</font><font style="vertical-align: inherit;">外部IP-5.5.5.5、内部BGPセッションを設定するための内部アドレス10.255.255.2/30。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の一歩。</font><font style="vertical-align: inherit;">単純なものから複雑なものへ：事前共有キー（PSK）を使用したトンネル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のLinuxボックスに、必要なパッケージをインストールします。</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のホストで、ポート500 / udp、4500 / udpを開き、ESPプロトコルの通過を許可します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/etc/strongswan/ipsec.secrectsファイル（ホスト側のipsecgw.example.com）を編集し、次の行を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、2番目の側：</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、IDは架空の電子メールアドレスです。</font><font style="vertical-align: inherit;">詳細は公式</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィキを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
秘密は保存され、次に進みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ipsecgw.example.comホストで、/ etc / strongswan / ipsec.confファイルを編集します。</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、リモートピア/etc/strongswan/ipsec.confを編集します。</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成を比較すると、ほとんどミラーリングされており、ピアの定義のみが交換されていることがわかります。</font><b><font style="vertical-align: inherit;">auto = route</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ディレクティブ</font><font style="vertical-align: inherit;">により、charonは、left / rightsubnet（トラフィックセレクター）ディレクティブに分類されるトラフィックのトラップを設定します。</font><font style="vertical-align: inherit;">トンネルパラメータとキー交換の調整は、特定の条件に該当するトラフィックが出現した直後に開始されます。</font><font style="vertical-align: inherit;">
ファイアウォール設定のipsecgw.example.comサーバーでは、10.0.3.0 / 24ネットワークのマスカレードを禁止しています。</font><font style="vertical-align: inherit;">10.0.0.0/23と10.0.3.0/24の間のパケット転送、およびその逆を許可します。</font><font style="vertical-align: inherit;">リモートホストで、10.0.0.0 / 23ネットワークのマスカレードを無効にし、転送を設定することにより、同様の設定を実行します。</font><font style="vertical-align: inherit;">
両方のサーバーでstrongswanを再起動し、セントラルノードにpingを実行します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてが機能することを確認します。</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのピアの/etc/strongswan/strongswan.d/charon.confファイルでmake_before_breakパラメータがyesに設定されていることを確認することも役立ちます。</font><font style="vertical-align: inherit;">この場合、IKEv2プロトコルを提供するcharonデーモンは、キー変更手順中に現在のセキュリティアソシエーションを削除しませんが、最初に新しいセキュリティアソシエーションを作成します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2 </font><font style="vertical-align: inherit;">キーネティックの登場</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
嬉しい驚きは、公式のKeeneticファームウェアに組み込まれたIPSec VPNでした。</font><font style="vertical-align: inherit;">これをアクティブにするには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KeeneticOSコンポーネント設定に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移動し</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージを追加します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このために、セントラルノードで設定を準備します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。/etc/strongswan/ipsec.secrectsを編集し、新しいピアのPSKを追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/etc/strongswan/ipsec.confを編集して、最後に別の接続を追加します。</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keenetic側では、設定はWebUIでパス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">→インターネット→接続→ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その他の接続に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">沿って実行され</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">とても簡単です。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3枚）</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トンネルを介して大量のトラフィックを駆動する予定の場合は、多くのモデルでサポートされているハードウェアアクセラレーションを有効にしてみてください。</font><font style="vertical-align: inherit;">CLI </font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto engine hardware</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドによって有効化され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">汎用CPU命令を使用して暗号化およびハッシュプロセスを無効にして処理するには- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗号化エンジンソフトウェア</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
設定を保存した後、strongswanを復元し、Keeneticに30分間考えさせます。</font><font style="vertical-align: inherit;">次に、ターミナルで接続が成功したことがわかります：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてが機能しています：</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ3 </font><font style="vertical-align: inherit;">モバイルデバイスの保護</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一連のマニュアルと一連の記事を読んだ後、Let's Encryptからの無料の証明書の束を利用して、サーバーとクライアントのログインとパスワードによる従来の認証を認証することにしました。</font><font style="vertical-align: inherit;">したがって、信頼できるリストに自己署名証明書をインストールすることで、独自のPKIインフラストラクチャを維持し、証明書の有効期限を監視し、モバイルデバイスで不要なジェスチャーを実行する必要がなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不足しているパッケージをインストールします。</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スタンドアロン証明書を取得します（最初にiptables設定で80 / tcpを開くことを忘れないでください）：</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
certbotの作業が完了したら、Strongswanに証明書を表示するように指示する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/strongswan/ipsec.d/cacertsディレクトリに2つのシンボリックリンクを作成します。1つは/ etc / pki / tls / certsにある信頼できる証明書のルートストアへのリンクです。</font><font style="vertical-align: inherit;">もう1つは/etc/letsencrypt/live/ipsecgw.example.com/chain.pemを指すca.pemという名前です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/strongswan/ipsec.d/certsディレクトリに2つのシンボリックリンクも作成されます。最初のシンボリックリンクは、certificate.pemという名前で、/ etc / letsencrypt / live / ipsecgw.example.com / cert.pemファイルを参照します。</font><font style="vertical-align: inherit;">そして、2番目はfullchain.pemという名前で、/ etc / letsencrypt / live / ipsecgw.example.com / fullchain.pemにリンクしています</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/strongswan/ipsec.d/privateディレクトリに、certbotによって生成された秘密鍵を指し、パス/etc/letsencrypt/live/ipsecgw.example.com/privkey.pemに沿って横たわるkey.pemシンボリックリンクを配置します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RSA経由の認証をipsec.secretsに追加し、新しいユーザーのログイン/パスワードの束を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Strongswanを再起動します。sudostrongswan listcertsを呼び出すと、証明書情報が表示されます。</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.confで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい接続について説明し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル/ etc / sysconfig / certbotを編集して、証明書もスタンドアロンとして更新し、それにCERTBOT_ARGS = "-standalone"を追加することを忘れないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、certbot-renew.timerタイマーをオンにし、新しい証明書を発行する場合にStrongswanを再起動するようにフックを設定することを忘れないでください。</font><font style="vertical-align: inherit;">これを行うには、/ etc / letsencrypt / renewal-hooks / deploy /に単純なbashスクリプトを配置するか、/ etc / sysconfig / certbotファイルを再度編集します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Strongswanを再起動し、iptablesで10.1.1.0/24ネットワークのマスカレードをオンにして、モバイルデバイスの構成に進みます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンドロイド</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Playから</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションをインストールします</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいものを立ち上げて作成します</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロフィール</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロファイルを保存して接続します。1秒経つと、誰かが私たちをスパイできることを心配する必要がなくなります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはチェックします：</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のバージョンのウィンドウズはうれしい驚きでした。</font><font style="vertical-align: inherit;">新しいVPNのすべての構成は、2つのPowerShellコマンドレットを呼び出すことによって行われます。</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてもう1つ、St​​rongswanがクライアントにIPv6アドレスを発行するように構成されている場合（そう、彼もそれを行うことができます）：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート4、最終。</font><font style="vertical-align: inherit;">私たちはヨーロッパへの窓を切りました</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーのスタブ「サイトは、Bogozabyt郡のTrudovye Mozoli村の5番目の検察官の左踵の決定によってブロックされた」を見て、小さくて目立たないVPSが（鳴り響くドメイン名rkn.example.comで）バンハンマーで大規模なネットワークを振るうサルから1000キロ離れたところに現れました/ 16ずつ。そして、この小さなVPSで回転することは、BIRDと呼ばれるNIC.CZからの同僚の素晴らしい創造でした。最初のバージョンの鳥は、バトンを持ったサルの活動から絶えずパニック状態で死亡しました。バトンは、労働活動のピーク時にインターネットのほぼ4％を禁止し、再構成中に深い配慮を行ったため、バージョン2.0.7に更新されました。読者が興味を持っている場合は、構成形式が劇的に変更されたBIRDからBIRD2への移行に関する記事を公開します。しかし、新しいバージョンはより高速になり、多数のルートを使用したreconfigで問題はありません。また、動的ルーティングプロトコルを使用するため、トラフィックをルーティングするためのネットワークインターフェイスが必要です。デフォルトでは、IPSecはインターフェイスを作成しませんが、その柔軟性により、将来的に保護する従来のGREトンネルを使用できます。おまけとして、ipsecgw.example.comとrkn.example.comのホストは、Lets Encryptの自己更新証明書を使用して相互に認証します。 PSKなし、証明書のみ、ハードコアのみ、セキュリティはあまりありません。デフォルトでは、IPSecはインターフェイスを作成しませんが、その柔軟性により、将来的に保護する従来のGREトンネルを使用できます。おまけとして、ipsecgw.example.comとrkn.example.comホストは、Lets Encrypt自己更新証明書を使用して相互に認証します。 PSKなし、証明書のみ、ハードコアのみ、セキュリティはあまりありません。デフォルトでは、IPSecはインターフェイスを作成しませんが、その柔軟性により、将来的に保護する従来のGREトンネルを使用できます。おまけとして、ipsecgw.example.comとrkn.example.comのホストは、Lets Encryptの自己更新証明書を使用して相互に認証します。 PSKなし、証明書のみ、ハードコアのみ、セキュリティはあまりありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPSが準備され、StrongswanとCertbotがすでにインストールされていると思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ipsecgw.example.comホスト（IPは1.1.1.1）で、新しいgif0インターフェースについて説明します。</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストvps.example.comでミラーリング（IPは5.5.5.5）：</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェースを上げますが、iptablesにはGREプロトコルを許可するルールがないため、トラフィックは送信されません（これは、法的「パッケージ」の愛好家からのGRE内の保護がないためです）。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPSの調理</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ドメイン名rkn.example.comの別の証明書を取得します。</font><font style="vertical-align: inherit;">前のセクションで説明したように、/ etc / strongswan / ipsec.dにシンボリックリンクを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1行追加してipsec.secretsを編集します。</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ipsec.confを編集します。</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホスト側では、セットアップセクションのstrictcrlpolicy = yesパラメータのipsec.confにipsecgw.example.comも追加され、厳密なCRLチェックが含まれています。</font><font style="vertical-align: inherit;">そして、別の接続について説明します。</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定はほとんどミラーリングされています。</font><font style="vertical-align: inherit;">注意深い読者は、すでにいくつかの点に注意を払うことができます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =％dynamic-Strongswanに、ピア間のすべてのタイプのトラフィックにポリシーを適用するように指示します</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイアウォールの設定と証明書の自動更新を忘れないでください。</font><font style="vertical-align: inherit;">両方のサーバーでStrongswanを再起動した後、GREトンネルの向こう側にpingを開始し、接続が成功することを確認します。</font><font style="vertical-align: inherit;">VPS（rkn）の場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ホスト側でipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スポイラーの下</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トンネルがインストールされ、pingが実行されます。tcpdumpでは、ESPのみがホスト間を移動しているように見えます。</font><font style="vertical-align: inherit;">喜ぶことは可能だと思われます。</font><font style="vertical-align: inherit;">しかし、最後まですべてをチェックせずにリラックスすることはできません。</font><font style="vertical-align: inherit;">VPSの証明書を再発行しようとしています...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェフ、全部壊れてる</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、Let's Encryptの不愉快な機能の1つを理解し、つまずき始めます。これは他のすべての点で優れています。証明書を再発行すると、それに関連する秘密鍵も変更されます。秘密鍵が変更され、公開鍵が変更されました。一見したところ、この状況は絶望的です。certbotのフックを使用して証明書を再発行しているときに公開鍵を簡単に抽出し、SSH経由でリモート側に渡すことができたとしても、リモートのStrongswanにそれを再読み取りさせる方法は明確ではありません。しかし、助けは彼らが待たなかったところから来ました-systemdはファイルシステムへの変更を監視し、イベントに関連するサービスを実行することができます。これを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も制限された権限を持つ各ホストでkeywatcherサービスユーザーを作成し、各ホストのSSHキーを生成して、ホスト間で交換します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ipsecgw.example.comホストで、2つのスクリプトを配置する/ opt / ipsec-pubkeyディレクトリを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPS（ホストrkn.example.com）で、同じ名前のディレクトリを同様に作成します。ここで、同様のスクリプトを作成し、キーの名前のみを変更します。</font><font style="vertical-align: inherit;">コードは、記事が乱雑にならないように、</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネタバレ</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい証明書を発行するときに、キーの公開部分を抽出してリモートホストにコピーするには、pubkey-copy.shスクリプトが必要です。</font><font style="vertical-align: inherit;">これを行うには、両方のサーバーの/ etc / letsencrypt / renewal-hooks / deployディレクトリで、別のマイクロスクリプトを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題の半分が解決され、証明書が再発行され、公開鍵が抽出されてサーバー間でコピーされ、pathdユニットでsystemdを実行する時が来ました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ etc / systemd / systemディレクトリのipsecgw.example.comサーバーで、keyupdater.pathファイルを作成します</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様にVPSホスト上：</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、各サーバーでこのユニットに関連付けられたサービスを作成します。このサービスは、条件（PathChanged）が満たされたときに起動されます-ファイルを変更し、記録後に閉じます。</font><font style="vertical-align: inherit;">/etc/systemd/system/keyupdater.serviceファイルを作成して、次のように記述します。</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sudo systemctl daemon-reloadを使用してsystemd設定を再度読み取り、sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater.pathを介してパス起動ユニットを割り当てることを忘れないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リモートホストが公開鍵を含むファイルをkeywatcherユーザーのホームディレクトリに書き込み、ファイル記述子が閉じられるとすぐに、systemdは対応するサービスを自動的に開始し、目的の場所に鍵をコピーして、Strongswanを再起動します。</font><font style="vertical-align: inherit;">トンネルは、2番目のサイドの正しい公開鍵を使用してインストールされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果を吐き出して楽しむことができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の代わりに</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先ほど見たように、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地獄の</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSecは塗装されているほど怖くない。</font><font style="vertical-align: inherit;">説明されているのは、現在使用されている完全に動作可能な構成です。</font><font style="vertical-align: inherit;">多くの知識がなくても、VPNを構成してデータを確実に保護できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、iptablesセットアップの瞬間は記事の範囲外に留まりましたが、記事自体はすでに膨大であることが判明し、iptablesについては多くのことが書かれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事には、Strongswanデーモンの再起動を拒否し、構成と証明書を再度読​​み取ることを拒否しても、改善できる点がありますが、これは実現できませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、デーモンの再起動はそれほど怖いものではありません。ピア間の1つまたは2つのpingが失われ、モバイルクライアント自身が接続を復元します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメントの同僚が正しい解決策を促してくれることを願っています。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504468/index.html">Raspberry Piのパフォーマンス：ZRAMを追加してカーネルパラメーターを変更する</a></li>
<li><a href="../ja504472/index.html">私のトップ無料開発者ツール</a></li>
<li><a href="../ja504478/index.html">「大学・企業」の関係構築の経験</a></li>
<li><a href="../ja504480/index.html">仕事をすることで利益を生むマーケティング担当者を見つける方法は？</a></li>
<li><a href="../ja504482/index.html">Спросите нас: ДИТ ответит на вопросы</a></li>
<li><a href="../ja504486/index.html">プロセス：Vue 3の作成</a></li>
<li><a href="../ja504488/index.html">COVID-19の問題を解決した後、どの産業や技術が急速に発展し始めるか</a></li>
<li><a href="../ja504490/index.html">6月のオンラインイベントダイジェスト</a></li>
<li><a href="../ja504492/index.html">ボタンを押す：電子投票の理論と実践-5月30日の円卓会議</a></li>
<li><a href="../ja504494/index.html">新しいWindows 10アップデートの7つの機能</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>