<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸš¼ ğŸ•µğŸ» ğŸŒ´ Ù„Ø¹Ø¨Ø© Ù†Ù…ÙˆØ°Ø¬ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø³Ø§Ø¹Ø© 3 Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±ØŸ ğŸ›ï¸ ğŸ£ ğŸ—»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ù…Ø±Ø­Ø¨Ø§ Ù…Ø¬Ø¯Ø¯Ø§! Ù‡Ù„ ØºØ§Ù„Ø¨Ø§ Ù…Ø§ ØªØ£ØªÙŠ Ø¨Ø£ÙÙƒØ§Ø± Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØªÙ…Ù†Ø¹Ùƒ Ø­Ø±ÙÙŠØ§ Ù…Ù† Ø§Ù„Ù†ÙˆÙ…ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø¹ÙˆØ± Ø¹Ù†Ø¯Ù…Ø§ ØªÙ‚Ù„Ù‚ ØŒ ØªÙ‚Ù„Ù‚ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£Ø´ÙŠØ§Ø¡ Ø£Ø®Ø±Ù‰ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ. ÙŠØ­Ø¯Ø« Ù„ÙŠ Ø¹Ø¯Ø©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ù„Ø¹Ø¨Ø© Ù†Ù…ÙˆØ°Ø¬ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ø³Ø§Ø¹Ø© 3 Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±ØŸ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488152/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù…Ø±Ø­Ø¨Ø§ Ù…Ø¬Ø¯Ø¯Ø§! Ù‡Ù„ ØºØ§Ù„Ø¨Ø§ Ù…Ø§ ØªØ£ØªÙŠ Ø¨Ø£ÙÙƒØ§Ø± Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ØªÙ…Ù†Ø¹Ùƒ Ø­Ø±ÙÙŠØ§ Ù…Ù† Ø§Ù„Ù†ÙˆÙ…ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø´Ø¹ÙˆØ± Ø¹Ù†Ø¯Ù…Ø§ ØªÙ‚Ù„Ù‚ ØŒ ØªÙ‚Ù„Ù‚ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£Ø´ÙŠØ§Ø¡ Ø£Ø®Ø±Ù‰ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ. ÙŠØ­Ø¯Ø« Ù„ÙŠ Ø¹Ø¯Ø© Ù…Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù†Ø©. ØªØ®ØªÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙÙƒØ§Ø± Ù…Ù† ØªÙ„Ù‚Ø§Ø¡ Ù†ÙØ³Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ÙˆØ¶ ÙÙŠ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ÙˆÙÙ‡Ù… Ø£Ù†Ù‡ Ø³ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„ØµØ¹Ø¨ Ù„Ù„ØºØ§ÙŠØ© Ø§Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©. ÙˆÙ„ÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙÙƒØ§Ø± ØŒ Ø§Ù„ØªÙŠ ØªØªØ·ÙˆØ± Ø­ØªÙ‰ Ø¨Ø¶Ø¹ Ø³Ø§Ø¹Ø§Øª ØŒ ØªØ¬Ø°Ø¨Ù†ÙŠ ÙƒØ«ÙŠØ±Ù‹Ø§ Ù„Ø¯Ø±Ø¬Ø© Ø£Ù†Ù†ÙŠ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø·Ø¹Ø§Ù… Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ¯ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø­ÙˆÙ„ ÙƒÙŠÙ ØªÙ…ÙƒÙ†Øª Ù…Ù† ØªØ­Ù‚ÙŠÙ‚ Ø¥Ø­Ø¯Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙÙƒØ§Ø± ÙÙŠ Ø£Ù…Ø³ÙŠØªÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆÙ„Ù… Ø£Ù…ÙˆØª Ù…Ù† Ø§Ù„Ø¬ÙˆØ¹. Ù„ÙƒÙ† Ø§Ù„ÙÙƒØ±Ø© Ù†ÙØ³Ù‡Ø§ Ø¨Ø¯Øª Ø·Ù…ÙˆØ­Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù„Ø¹Ø¨Ø© Ù„Ø§Ø¹Ø¨ Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ ÙŠØªÙ†Ø§ÙØ³ ÙÙŠÙ‡Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ù…Ø¹ Ø¨Ø¹Ø¶Ù‡Ù… Ø§Ù„Ø¨Ø¹Ø¶ ØŒ ÙˆÙŠØ¬ÙŠØ¨ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.</font></font></strong></p><br>
<p><img src="https://habrastorage.org/webt/6t/lx/nv/6tlxnvshyavyiioz_ofsltrkwae.jpeg"></p><a name="habracut"></a><br>
<p>       " -   Botlify",         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> </a>  .        -   ,   .  ,   14-15         ,         .</p><br>
<h3 id="ideya"></h3><br>
<p>           ,         2013 .   ,    ,       ,       "100  1".   ,  ,       ,        .  ,        ,             -.             Telegram API,         -.</p><br>
<p>,    :   -,  ,  ,    (  ,     1% â€” <strong>YAGNI</strong>),     ,   ,   . ,    ,           .               .              <em> 3 </em>.    â€” ,    -         . ,       : "    ,       , <strong> </strong>".     ,       .      , , .   â€”       . <strong>     10   ,   ,   ,      .</strong></p><br>
<p> ,        ,             ,      Telegram.</p><br>
<h3 id="shag-1-pravila"> 1. </h3><br>
<p>  ,             .  Telegram    .        .           :</p><br>
<p>    <strong>3 </strong>.             .   ,             .  <strong>   6 </strong>,        3     .</p><br>
<ol>
<li>  â€” 8 </li>
<li>   â€” 5 </li>
<li> â€” 3 </li>
<li> â€” 2 </li>
<li> â€” 1 </li>
<li> â€” 1 </li>
<li>   â€” 0 </li>
</ol><br>
<p>  ,    ,     .       â€”   .     ,    1 "".        â€”         "".      â€”     .    ,    ,  <strong>    20 .</strong>  ?    ,     0 .   3      .</p><br>
<p>     ,   ,    ,     " ",       (,  ,     ).     ,    ,  ,   <br>
<img src="https://habrastorage.org/webt/ai/0h/mm/ai0hmmnxcggfv6gp1w685b5jsq0.jpeg" alt="Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠ Ø£ØµÙ„ÙŠ"></p><br>
<h3 id="shag-2-abstrakcii"> 2. </h3><br>
<p>                ,           .       ,  ,  ,      "":</p><br>
<ul>
<li>(Player) â€”     id ,   , , ,     ,      .</li>
<li>(Game) â€”      ,  ,    ,   ,      ..</li>
<li>(Round) â€”     .          ,    ,   .</li>
<li>(Question) â€”  ,  -  .  </li>
<li>(Answer) â€”    ,  -           </li>
</ul><br>
<p>         .  ,       ,       ,      ,     - ,    , , , (,  ?),  â€”  .</p><br>
<p>     ,     : "       ,       ?".  ,      :</p><br>
<ul>
<li> </li>
<li>  </li>
<li>  </li>
<li>          </li>
<li>      </li>
</ul><br>
<p>     -       ,  :      ,        ,   ,   .          :<br>
  /start       . ,            ,             â€” .   N-       ,          .      â€”            ,      "  ".           .</p><br>
<h3 id="poehali">!</h3><br>
<p>,          .       ,       â€” ,     .         <strong>NodeJS c TypeScript</strong>   .      ?    . 10         :</p><br>
<pre><code class="javascript hljs">interface Player {
    <span class="hljs-attr">id</span>: string; <span class="hljs-comment">//   </span>
    rating: number;  <span class="hljs-comment">//  </span>
    username: string; <span class="hljs-comment">//   </span>
    games: number; <span class="hljs-comment">// -  </span>
    wins: number; <span class="hljs-comment">// - </span>
    losses: number; <span class="hljs-comment">// - </span>
    createdAt: number; <span class="hljs-comment">// timestamp "" </span>
    lastGame: number|<span class="hljs-literal">null</span>; <span class="hljs-comment">// timestamp    </span>
}</code></pre><br>
<p>      ,      ,  -     .     ,    ,    ""   MySQL, Postgres  MongoDB   .       <strong>Redis</strong>.         ,      ,       key-value     JSON.         ,    Redis     .  ,   Redis      "" ,     ,      ""(scores), pub/sub,     Redis  ,     .</p><br>
<p> ,           ,   ,     winGame  looseGame,         .     ,   ,  Redis     <strong>sorted set</strong>,       ,      (<strong>score</strong>).       .           sorted set    id  ,  (score)   .</p><br>
<p>,      ,     .      ,            ,       .     ?                "Rating system".     -    ,      <strong>ELO Rating.</strong>  ,       ,   ,     .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">npmjs.com</a>    elo-rating    <strong>!</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://www.npmjs.com/package/elo-rating</a>.      ,   . ,           â€” , .     ,        , !    "" player.service.ts      ,  ,  ,    ""  ""   130  .   ,   ,    â€”   ,      ,   ,     Player          - .</p><br>
<pre><code class="javascript hljs">interface IPlayerService {<font></font>
  createPlayer(id: string, name?: string): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  getPlayerName(id: string): <span class="hljs-built_in">Promise</span>&lt;string&gt;;<font></font>
  countPlayers(): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getRatingPosition(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getTopPlayerIds(): <span class="hljs-built_in">Promise</span>&lt;string[]&gt;;<font></font>
  getTopPlayerScores(): <span class="hljs-built_in">Promise</span>&lt;{<span class="hljs-attr">id</span>: string, <span class="hljs-attr">value</span>: number}[]&gt;;<font></font>
  listPlayers(): <span class="hljs-built_in">Promise</span>&lt;Player[]&gt;;<font></font>
  getPlayerRating(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerScores(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerScorePosition(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerGames(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerWins(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  winGame(id: string, <span class="hljs-attr">newRating</span>: number): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  looseGame(id: string, <span class="hljs-attr">newRating</span>: number): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  setSession(id: string, <span class="hljs-attr">data</span>: any): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;<font></font>
  getSession(id: string): <span class="hljs-built_in">Promise</span>&lt;any&gt;;<font></font>
}</code></pre><br>
<p>   ,        ,   ""      ,             .       .</p><br>
<h3 id="vtoroy-vecher"> </h3><br>
<p>        ,       â€”    .       .  ,    ,     ,        :</p><br>
<ul>
<li>    \</li>
<li>  </li>
<li> </li>
</ul><br>
<p>       . -,      .       -  ,    (  ).</p><br>
<pre><code class="javascript hljs">interface Question {
  <span class="hljs-attr">id</span>: string;<font></font>
  message: string;<font></font>
  createdAt: number;<font></font>
}</code></pre><br>
<p>      key-value,    â€” ID,    JSON-  .     <strong> (set)</strong>    ID   ,     .      ?   :</p><br>
<ul>
<li> </li>
<li>   ID</li>
<li>  </li>
</ul><br>
<p>      ,           :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QuestionService</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of question by id
   * <span class="hljs-doctag">@param <span class="hljs-variable">id</span></span>
   */</span>
  public <span class="hljs-keyword">static</span> getQuestionKey(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`questions:<span class="hljs-subst">${id}</span>`</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of questions list
   */</span>
  public <span class="hljs-keyword">static</span> getQuestionsListKey() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'questions'</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return question object
   * <span class="hljs-doctag">@param <span class="hljs-variable">id</span></span>
   */</span>
  <span class="hljs-keyword">async</span> getQuestion(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient().get(QuestionService.getQuestionKey(id))<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Add new question to the store
   * <span class="hljs-doctag">@param <span class="hljs-variable">question</span></span>
   */</span>
  <span class="hljs-keyword">async</span> addQuestion(message: string): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
    <span class="hljs-keyword">const</span> data =  {
      <span class="hljs-attr">id</span>: randomStringGenerator(),
      <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">Date</span>.now(),<font></font>
      message,<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .set(QuestionService.getQuestionKey(data.id), <span class="hljs-built_in">JSON</span>.stringify(data));
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .sadd(QuestionService.getQuestionsListKey(), data.id);<font></font>
    <span class="hljs-keyword">return</span> data.id;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return ID of the random question
   */</span>
  <span class="hljs-keyword">async</span> getRandomQuestionId(): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .srandmember(QuestionService.getQuestionsListKey());<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return random question
   */</span>
  <span class="hljs-keyword">async</span> getRandomQuestion() {
    <span class="hljs-keyword">const</span> id = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getRandomQuestionId(gameId);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getQuestion(id);<font></font>
  }<font></font>
<font></font>
}</code></pre></div></div><br>
<p>   ,          Redis. ,         ,         . ,     â€”   .</p><br>
<p>-,      . -,     ,    ,    . , ,       . ,  ,        ,    ,    ,  -        ,         .      -  ,        ,    .      ,              - .   5                <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/aceakash/string-similarity</a>    .  ,    â€”   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>.     ,     ,    0.75   ,          .    â€” ,  .</p><br>
<p>        <strong> (sorted set)</strong>        .                QuestionService,     ,     ,   -(   ),         ,  ,      ..</p><br>
<p>,                       .  ,   -     .  ,  QuestionService   :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="javascript hljs">private turnScores: number[] = [<span class="hljs-number">8</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>];<font></font>
<font></font>
<span class="hljs-comment">/**
 * Get key of list of the answers
 * @param questionId
 */</span>
public <span class="hljs-keyword">static</span> getAnswersKey(questionId: string): string {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`answers:<span class="hljs-subst">${questionId}</span>`</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> addAnswer(questionId: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .zincrby(QuestionService.getAnswersKey(questionId), <span class="hljs-number">1</span>, answer);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Get all answers for the given question
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 */</span>
<span class="hljs-keyword">async</span> getQuestionAnswers(questionId: string): <span class="hljs-built_in">Promise</span>&lt;string[]&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .zrevrange(QuestionService.getAnswersKey(questionId), <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Top 6 answers
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 */</span>
<span class="hljs-keyword">async</span> getTopAnswers(gameId: string, <span class="hljs-attr">questionId</span>: string): <span class="hljs-built_in">Promise</span>&lt;string[]&gt; {
  <span class="hljs-keyword">const</span> copiedAnswers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .get(<span class="hljs-string">`answers:game:<span class="hljs-subst">${gameId}</span>:q:<span class="hljs-subst">${questionId}</span>`</span>);
  <span class="hljs-keyword">if</span> (!copiedAnswers) {
    <span class="hljs-keyword">const</span> ans = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zrevrange(QuestionService.getAnswersKey(questionId), <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .set(<span class="hljs-string">`answers:game:<span class="hljs-subst">${gameId}</span>:q:<span class="hljs-subst">${questionId}</span>`</span>, <span class="hljs-built_in">JSON</span>.stringify(ans));
    <span class="hljs-keyword">return</span> ans;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(copiedAnswers);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Find if answer already exists and return it if found
 * null if answer doesnt exist
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> existingAnswer(questionId: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;string | <span class="hljs-literal">null</span>&gt; {
  <span class="hljs-keyword">const</span> answers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getQuestionAnswers(questionId);
  <span class="hljs-keyword">const</span> matches = stringSimilarity.findBestMatch(answer, answers);
  <span class="hljs-keyword">return</span> matches.bestMatch.rating &gt;= <span class="hljs-number">0.75</span><font></font>
    ? <font></font>
    matches.bestMatch.target<font></font>
    :<font></font>
    <span class="hljs-literal">null</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Existing answer scores
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> getExistingAnswerScore(<font></font>
  gameId: string, <span class="hljs-attr">questionId</span>: string, <span class="hljs-attr">answer</span>: string<font></font>
): <span class="hljs-built_in">Promise</span>&lt;number&gt; {
    <span class="hljs-keyword">const</span> topAnswers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getTopAnswers(gameId, questionId);
    <span class="hljs-keyword">const</span> matches = stringSimilarity.findBestMatch(answer, topAnswers);
    <span class="hljs-keyword">return</span> matches.bestMatch.rating &gt;= <span class="hljs-number">0.75</span><font></font>
      ?<font></font>
      <span class="hljs-keyword">this</span>.turnScores[matches.bestMatchIndex]<font></font>
      :<font></font>
      <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Submit the new answer. Updates answer counter, save if doesn't exist, return answer score
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> submitAnswer(gameId: string, <span class="hljs-attr">questionId</span>: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;number&gt; {<font></font>
  answer = answer.toLowerCase();<font></font>
  <span class="hljs-keyword">const</span> existingAnswer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.existingAnswer(questionId, answer);
  <span class="hljs-keyword">if</span> (!existingAnswer) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addAnswer(questionId, answer);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addAnswer(questionId, existingAnswer);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getExistingAnswerScore(gameId, questionId, existingAnswer);<font></font>
  }<font></font>
}</code></pre></div></div><br>
<p>     ,     :     . ,      ,   â€”       0   .    ,   ""  ,       ,        . ,   ,       .           ,     ,    â‰¥ 0.75   .  ""          ,    -             .       getTopAnswers? ,    â€”    ;)       ,      &lt; 300            ,              (   - gameId,       ).</p><br>
<p> ,       ?     ,                    .       ,   ?</p><br>
<h3 id="igra"></h3><br>
<p>    ,  ()     .      2  â€” player1  player2 .     :  ,  , .         ,     ,   " "   ,           .     â€”     .</p><br>
<pre><code class="javascript hljs">enum GameStatus {<font></font>
  WaitingForPlayers,<font></font>
  Active,<font></font>
  Finished,<font></font>
}</code></pre><br>
<p>     <em>key-value</em>,     = ID,  value = JSON.stringify(data).  ,      </p><br>
<pre><code class="javascript hljs">interface Game {
    <span class="hljs-attr">id</span>: string;<font></font>
    player1: string;<font></font>
    player2: string;<font></font>
    joined: string[];<font></font>
    status: GameStatus;<font></font>
    round?: number;<font></font>
    winner?: string;<font></font>
    createdAt: number;<font></font>
    updatedAt?: number;<font></font>
}</code></pre><br>
<p>      ,    ,  (? 1  â€” 1 ),    .</p><br>
<pre><code class="javascript hljs">interface GameRound {
    <span class="hljs-attr">index</span>: number;<font></font>
    question: string;<font></font>
    currentPlayer: string;<font></font>
    turn: number;<font></font>
    answers: UserAnswer[];<font></font>
    updatedAt?: number;<font></font>
}</code></pre><br>
<p>     <em>game.service.ts</em>      ,  :  ,  ,  ,  ,       .     ,       - , ,        .        Redis pub/sub.    ,     .       ,     â€”  ,      -  ,     ,     .</p><br>
<div class="spoiler"><b class="spoiler_title"> GameService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GameService</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">//       </span>
  public <span class="hljs-keyword">static</span> CHANNEL_G_CREATED = <span class="hljs-string">'game-created'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_STARTED = <span class="hljs-string">'game-started'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_ENDED = <span class="hljs-string">'game-ended'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_NEXT_ROUND = <span class="hljs-string">'game-next-round'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_NEXT_TURN = <span class="hljs-string">'game-next-turn'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_ANSWER_SUBMIT = <span class="hljs-string">'game-next-turn'</span>;<font></font>
<font></font>
  private defaultRounds: number; <span class="hljs-comment">//  </span>
  private defaultTurns: number; <span class="hljs-comment">//     </span><font></font>
<font></font>
  private timers: any = {}; <span class="hljs-comment">// . -, any - </span><font></font>
<font></font>
    <span class="hljs-comment">//  ,       </span>
    <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">constructor</span>(<font></font>
    private readonly redisService: RedisService,<font></font>
    private readonly playerService: PlayerService,<font></font>
    private readonly questionService: QuestionService,<font></font>
    @Inject('EventPublisher') private readonly eventPublisher,<font></font>
  ) {<font></font>
    <span class="hljs-keyword">this</span>.defaultRounds = config.game.defaultRounds;
    <span class="hljs-keyword">this</span>.defaultTurns = config.game.defaultTurns;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of game
   * <span class="hljs-doctag">@param </span>id string identifier of game
   */</span>
  public <span class="hljs-keyword">static</span> getGameKey(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`game:<span class="hljs-subst">${id}</span>`</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get game object by id
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   */</span>
  <span class="hljs-keyword">async</span> getGame(gameId: string): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
    <span class="hljs-keyword">const</span> game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .get(GameService.getGameKey(gameId));<font></font>
    <span class="hljs-keyword">if</span> (!game) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Game <span class="hljs-subst">${gameId}</span> not found`</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Save the game state to database
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> saveGame(game: Game) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().set(<font></font>
      GameService.getGameKey(game.id),<font></font>
      <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Save round
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">round</span></span>
   */</span>
  <span class="hljs-keyword">async</span> saveRound(gameId: string, <span class="hljs-attr">round</span>: GameRound) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().set(<font></font>
      GameService.getRoundKey(gameId, round.index),<font></font>
      <span class="hljs-built_in">JSON</span>.stringify(round)<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Initialize default game structure, generate id
   * and save new game to the storage
   *
   * <span class="hljs-doctag">@param <span class="hljs-variable">player1</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">player2</span></span>
   */</span>
  <span class="hljs-keyword">async</span> initGame(player1: string, <span class="hljs-attr">player2</span>: string): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
    <span class="hljs-keyword">const</span> game: Game = {
      <span class="hljs-attr">id</span>: randomStringGenerator(),<font></font>
      player1,<font></font>
      player2,<font></font>
      <span class="hljs-attr">joined</span>: [],
      <span class="hljs-attr">status</span>: GameStatus.WaitingForPlayers,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">Date</span>.now(),<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_CREATED, <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> game;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * When the game is created and is in the  "Waiting for players" state
   * users can approve participation
   * <span class="hljs-doctag">@param <span class="hljs-variable">playerId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   */</span>
  <span class="hljs-keyword">async</span> joinGame(playerId: string, <span class="hljs-attr">gameId</span>: string) {
    <span class="hljs-keyword">const</span> game: Game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getGame(gameId);
    <span class="hljs-keyword">if</span> (!game) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Game not found err'</span>)
    <span class="hljs-keyword">if</span> (isUndefined(game.joined.find(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> element === playerId))) {<font></font>
      game.joined.push(playerId);<font></font>
      game.updatedAt = <span class="hljs-built_in">Date</span>.now();
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (game.joined.length === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.startGame(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Start the game
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> startGame(game: Game) {<font></font>
    game.round = <span class="hljs-number">0</span>;<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();<font></font>
    game.status = GameStatus.Active;<font></font>
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_STARTED, <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.pickQuestionsForGame(game.id);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.nextRound(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Start the next round
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> nextRound(game: Game) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);
    <span class="hljs-keyword">if</span> (game.round &gt;= <span class="hljs-keyword">this</span>.defaultRounds) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.endGame(game);<font></font>
    }<font></font>
    game.round++;<font></font>
    <span class="hljs-keyword">const</span> round: GameRound = {
      <span class="hljs-attr">index</span>: game.round,
      <span class="hljs-attr">question</span>: <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.getRandomQuestionId(game.id),
      <span class="hljs-attr">currentPlayer</span>: game.player1,
      <span class="hljs-attr">turn</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">answers</span>: [],<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveRound(game.id, round);<font></font>
<font></font>
    <span class="hljs-comment">//        </span>
    <span class="hljs-comment">//     20    </span>
    <span class="hljs-comment">//        0 </span>
    <span class="hljs-keyword">this</span>.timers[game.id] = setTimeout(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.submitAnswer(round.currentPlayer, game.id, <span class="hljs-string">''</span>);<font></font>
    }, <span class="hljs-number">20000</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_NEXT_ROUND,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, round})<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Switch round to next turn
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">round</span></span>
   */</span>
  <span class="hljs-keyword">async</span> nextTurn(game: Game, <span class="hljs-attr">round</span>: GameRound) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);
    <span class="hljs-keyword">if</span> (round.turn &gt;= <span class="hljs-keyword">this</span>.defaultTurns) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextRound(game);<font></font>
    }<font></font>
    round.turn++;<font></font>
    round.currentPlayer = <span class="hljs-keyword">this</span>.anotherPlayer(round.currentPlayer, game);<font></font>
    round.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_NEXT_TURN,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, round})<font></font>
    );<font></font>
    <span class="hljs-keyword">this</span>.timers[game.id] = setTimeout(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.submitAnswer(round.currentPlayer, game.id, <span class="hljs-string">''</span>);<font></font>
    }, <span class="hljs-number">20000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.saveRound(game.id, round);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> answerExistInRound(round: GameRound, <span class="hljs-attr">answer</span>: string) {
    <span class="hljs-keyword">const</span> existingKey = round.answers.find(
      <span class="hljs-function"><span class="hljs-params">rAnswer</span> =&gt;</span> stringSimilarity.compareTwoStrings(answer, rAnswer.value) &gt;= <span class="hljs-number">0.85</span><font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> !isUndefined(existingKey);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> submitAnswer(playerId: string, <span class="hljs-attr">gameId</span>: string, <span class="hljs-attr">answer</span>: string) {
    <span class="hljs-keyword">const</span> game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getGame(gameId);
    <span class="hljs-keyword">const</span> round = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getCurrentRound(gameId);
    <span class="hljs-keyword">if</span> (playerId !== round.currentPlayer) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Its not your turn'</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (answer.length === <span class="hljs-number">0</span>) {<font></font>
      round.updatedAt = <span class="hljs-built_in">Date</span>.now();
      <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
        GameService.CHANNEL_G_ANSWER_SUBMIT,<font></font>
        <span class="hljs-built_in">JSON</span>.stringify({game, answer, <span class="hljs-attr">score</span>: <span class="hljs-number">0</span>, playerId})<font></font>
      );<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextTurn(game, round);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.answerExistInRound(round, answer)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'       '</span>);<font></font>
    }<font></font>
    round.answers.push({ <span class="hljs-attr">value</span>: answer, playerId, <span class="hljs-attr">turn</span>: round.turn });
    <span class="hljs-keyword">const</span> score = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.submitAnswer(<font></font>
      gameId, round.question, answer<font></font>
    );<font></font>
    <span class="hljs-keyword">if</span> (score &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addGameScore(gameId, playerId, score);<font></font>
    }<font></font>
    round.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_ANSWER_SUBMIT,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, answer, score, playerId})<font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextTurn(game, round);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Adds game score in specified game for specified player
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">playerId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">score</span></span>
   */</span>
  <span class="hljs-keyword">async</span> addGameScore(gameId: string, <span class="hljs-attr">playerId</span>: string, <span class="hljs-attr">score</span>: number) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zincrby(<span class="hljs-string">`game:<span class="hljs-subst">${gameId}</span>:player:scores`</span>, score, playerId);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> endGame(game: Game) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();<font></font>
    game.status = GameStatus.Finished;<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">const</span> places = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zrevrange(<span class="hljs-string">`game:<span class="hljs-subst">${game.id}</span>:player:scores`</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
    game.winner = places[<span class="hljs-number">0</span>];
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">const</span> winnerRating: number = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(game.winner);
    <span class="hljs-keyword">const</span> looserRating: number = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(places[<span class="hljs-number">1</span>]);
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">const</span> newRatings = rating.calculate(winnerRating, looserRating);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.winGame(game.winner, newRatings.playerRating); 
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.looseGame(places[<span class="hljs-number">1</span>], newRatings.opponentRating);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient().expire(GameService.getGameKey(game.id), <span class="hljs-number">600</span>)
    <span class="hljs-keyword">this</span>.eventPublisher.emit(GameService.CHANNEL_G_ENDED, <span class="hljs-built_in">JSON</span>.stringify(game));
    <span class="hljs-keyword">return</span> game;<font></font>
  }<font></font>
}</code></pre></div></div><br>
<p>,  -.      ,      .        ,          â€”    . ,       ,      ,          .      Redis    (sorted sets).              (          ,    ).           .      .             <em>game.service.ts</em>,    </p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> addPlayerToMatchmakingList(id: string) {
  <span class="hljs-keyword">const</span> playerRating = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(id);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zadd(<span class="hljs-string">'matchmaking-1-1'</span>, playerRating, id);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> removePlayerFromMatchmakingList(id: string) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zrem(<span class="hljs-string">'matchmaking-1-1'</span>, id);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> getMatchmakingListData() {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zrange(<span class="hljs-string">'matchmaking-1-1'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> matchPlayers(): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
  <span class="hljs-keyword">const</span> players = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
        .zrevrange(<span class="hljs-string">'matchmaking-1-1'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);
  <span class="hljs-keyword">while</span> (players.length &gt; <span class="hljs-number">0</span>) {
     <span class="hljs-keyword">const</span> pair = players.splice(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
     <span class="hljs-keyword">if</span> (pair.length === <span class="hljs-number">2</span>) {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.coinflip() <font></font>
         ?<font></font>
         <span class="hljs-keyword">this</span>.initGame(pair[<span class="hljs-number">0</span>], pair[<span class="hljs-number">1</span>])<font></font>
         :<font></font>
         <span class="hljs-keyword">this</span>.initGame(pair[<span class="hljs-number">1</span>], pair[<span class="hljs-number">0</span>]);<font></font>
     }<font></font>
  }<font></font>
}</code></pre><br>
<p>,   ,          . ,              .          , -   .</p><br>
<p> ,     .        ,       .</p><br>
<h3 id="polzovatelskiy-interfeys"> </h3><br>
<p>- â€”   .    ,     -     ,  css   JS- â€”        Telegram.        .   ,    API       .   ,       ,    .</p><br>
<p> ,   ,      -  ,        .</p><br>
<blockquote>    "100  1", AndreyDegtyaruk!<br>
        , ,     !    ,     .   /help            </blockquote><p>  ,           ,   :</p><br>
<blockquote>  "100  1"              .   !    ,      <br>
    3 .              .    ,             .     6 ,        3     <br>
   <br>
<ol>
<li>  â€” 8 </li>
<li>   â€” 5 </li>
<li>   â€” 3 </li>
<li>   â€” 2 .</li>
<li> â€” 1 .</li>
<li> â€” 1 .</li>
<li>   â€” 0 </li>
</ol><br>
<br>
!    !     20   .   ?   0      .   3       ,        </blockquote><p>  ,    ,     -  ,    ,     ( ,   ).  2 : pull  push. Pull  ,   "" Telegram   ,    API Telegram   getUpdates. Push       ,   ,   â€”  webhook.      ,      ""        ,           . ,  !</p><br>
<p>        SDK   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Telegraf</a>,   ,           â€” ,    .      ,    .</p><br>
<p>  ,  ""   ,  API key   ,      ,       .         â€” <em>bot.service.ts</em>,          Telegram.  ,     ,      .            :</p><br>
<ul>
<li>/start â€”      (-    inline, , custom keyboard     )</li>
<li>/help â€”      </li>
<li>/player_info â€”   (, , )   </li>
<li>/global_rating â€”       </li>
<li>/go â€”      </li>
</ul><br>
<p> ,        . ,          -  </p><br>
<pre><code class="javascript hljs">    getMainMenuKeyboard() {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">inline_keyboard</span>: [<font></font>
            [<font></font>
            {<font></font>
                    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'go'</span>})<font></font>
            }<font></font>
             ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">'  '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'player-rating'</span>})<font></font>
            }<font></font>
             ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">' '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'rules'</span>})<font></font>
            }<font></font>
              ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">'  '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'stats'</span>})<font></font>
            }<font></font>
             ],<font></font>
          ],<font></font>
        };<font></font>
      }</code></pre><br>
<p>     <em>callback_data.</em> Telegram       ,  ,              .</p><br>
<p>        ,    switch/case statement   type,      .       start  help,           ,     .    ,  Telegram     https,    -     .  ,                 <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Ngrok</a></strong>     .</p><br>
<pre><code class="javascript hljs">    <span class="hljs-keyword">async</span> commandStart(ctx) {
      <span class="hljs-keyword">let</span> name = <span class="hljs-string">`<span class="hljs-subst">${escapeHtml(ctx.<span class="hljs-keyword">from</span>.first_name)}</span>`</span>;<font></font>
      name += ctx.from.last_name ? escapeHtml(ctx.from.last_name) : <span class="hljs-string">''</span>;
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.createPlayer(ctx.from.id.toString(<span class="hljs-number">10</span>), name);
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.bot.telegram.sendMessage(ctx.from.id, messages.start(name), {
        <span class="hljs-attr">parse_mode</span>: <span class="hljs-string">'HTML'</span>,
        <span class="hljs-attr">reply_markup</span>: <span class="hljs-keyword">this</span>.getMainMenuKeyboard(),<font></font>
      });<font></font>
    }</code></pre><br>
<p> ,              .   ,        .       ,   ,        . ,  ,  .  ,         .</p><br>
<p>    ,      Redis pub/sub.       .     ,        ,  ,   (        ).        main.ts,    ,     ,  .      .  ""    </p><br>
<pre><code class="javascript hljs">    <span class="hljs-keyword">const</span> redisClient = app.get(<span class="hljs-string">'EventSubscriber'</span>);<font></font>
    redisClient.on(GameService.CHANNEL_G_CREATED, <span class="hljs-keyword">async</span> (data) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> botService.sendGameCreated(<span class="hljs-built_in">JSON</span>.parse(data));<font></font>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error in CHANNEL_G_CREATED'</span>);
        <span class="hljs-built_in">console</span>.log(error);<font></font>
      }<font></font>
    });</code></pre><br>
<p> BotService.sendGameCreated,             ,          .</p><br>
<p>       (    ,  ),   -   ,   ,     ,   .    ,   ?     Stages  Scenes,  Telegraf,         ,   . ,  ,  30               ,     Redis.</p><br>
<p>      ,  ,       .  ,       ,   ,    â€”  (    ).      â€”    ,    ,   .</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">this</span>.bot.on(<span class="hljs-string">'text'</span>, <span class="hljs-keyword">async</span> (ctx: any) =&gt; {<font></font>
  ctx.message.text = escapeHtml(ctx.message.text);<font></font>
  ctx.message.text = ctx.message.text.toLowerCase();<font></font>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getSession(ctx.from.id.toString());
    <span class="hljs-keyword">if</span> (!state.currentGame) {
      <span class="hljs-keyword">return</span> ctx.reply(
        <span class="hljs-string">' ,   . 
          /help,     '</span><font></font>
        );<font></font>
    }<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.gameIncomingMessage(ctx, state);<font></font>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error during processing TEXT message'</span>);
    <span class="hljs-built_in">console</span>.log(error);<font></font>
  }<font></font>
});<font></font>
<span class="hljs-keyword">this</span>.bot.on(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">async</span> ctx =&gt; {<font></font>
    ctx.reply(<span class="hljs-string">'   '</span>);<font></font>
});</code></pre><br>
<p>  ,    ,    .</p><br>
<p> Telegram-  ,         . ,    - .   ,           &lt;/&gt;,     parseMode HTML,     : "   html"       .             ,    .                localhost    50 .     ,  NodeJS        .                     - , ,    -    .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø¢Ù…Ù„ Ø­Ù‚Ù‹Ø§ Ø£Ù† ÙŠÙ„Ù‡Ù… Ù…Ù†Ø´ÙˆØ±ÙŠ Ø´Ø®ØµÙ‹Ø§ Ù…Ø§ Ø¨ØªÙ†ÙÙŠØ° Ø£ÙÙƒØ§Ø±Ù‡ ØŒ Ø£Ùˆ Ø¬Ø¹Ù„ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø£Ù„ÙŠÙØ© ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹ ÙˆØ¥Ø·Ù„Ø§Ù‚Ù‡ ØŒ Ø£Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ÙÙƒØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ†ÙÙŠØ° ØŒ Ø£Ùˆ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù‚Ù„ÙŠÙ„ Ù…Ù† Ù…ØªØ¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©. </font><font style="vertical-align: inherit;">Ø£Ù†Ø§ Ù…ØªØ£ÙƒØ¯ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙˆØª Ù„Ù† ÙŠØªØ­Ù…Ù„ Ø¹Ø¯Ø¯Ù‹Ø§ ÙƒØ¨ÙŠØ±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. </font><font style="vertical-align: inherit;">Ù„Ø§ ÙŠØ²Ø§Ù„ ØŒ Ù…Ø¤Ù‚ØªØ§Øª ØŒ Ù…Ø´ØªØ±Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø´ÙƒÙ„ Ø±Ø¦ÙŠØ³ÙŠ ØŒ Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ØŒ Ø¥Ù„Ø® ØŒ Ø¥Ù„Ø®. </font><font style="vertical-align: inherit;">ÙˆÙ…Ø¹ Ø°Ù„Ùƒ ØŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´Ø®Øµ Ù…Ø§ Ù…Ù‡ØªÙ…Ù‹Ø§ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø¨Ø§Ù„Ø§Ø·Ù„Ø§Ø¹</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© ØŒ ÙØ§Ø¨Ø­Ø« Ø¹Ù† </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">QuizMatchGameBot</font></a><font style="vertical-align: inherit;"> bot </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ø³Ù„Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹!</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar488140/index.html">ÙƒÙŠÙÙŠØ© ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø­ÙŠØ§Ø© Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ù‚Ø§Ù†ÙˆÙ† Ø¨Ø§Ø±ÙŠØªÙˆ</a></li>
<li><a href="../ar488142/index.html">Ø£ÙØ§Ù„ÙˆÙ†ÙŠØ§ Ù…ØªØ£Ù…Ù„</a></li>
<li><a href="../ar488146/index.html">[Ù…Ù†Ø§Ù‚Ø´Ø©]: Ù‡Ù„ Ù…Ù‡Ù†Ø¯Ø³Ùˆ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ù… Ù…Ù‡Ù†Ø¯Ø³Ùˆ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŸ</a></li>
<li><a href="../ar488148/index.html">HighLoad ++ ØŒ Mikhail Raichenko (ManyChat): Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø³Ø­Ø± ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ØŒ Ø£Ùˆ Ù…Ø¯Ù‰ Ø³Ù‡ÙˆÙ„Ø© ØªÙˆØ²ÙŠØ¹ Ø¯ÙÙ‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ø¨Ø± terabit</a></li>
<li><a href="../ar488150/index.html">Ø§Ù„Ø¢Ø«Ø§Ø±: ThinkPad X200 ÙˆÙ…ØµØ¯Ø± Ù…ØºÙ„Ù‚</a></li>
<li><a href="../ar488154/index.html">Ù†ØµÙ„ Ø¥Ù„Ù‰ Ø­Ø°Ø§Ø¡ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</a></li>
<li><a href="../ar488160/index.html">Windows Server 2019 Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù‚Ø·Ø§Øª VMware Ù…Ø¹ Ø§Ù„Ù‡Ø¯ÙˆØ¡: Ø­Ù„ Ø£Ù†ÙŠÙ‚ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©</a></li>
<li><a href="../ar488162/index.html">ÙƒÙ„Ù…Ø§ Ø§Ø±ØªÙØ¹ Ø§Ù„ØªØµÙ†ÙŠÙ ØŒ Ø²Ø§Ø¯ Ø§Ù„Ù…Ø§Ù„ ÙˆØ§Ù„Ø¹ÙƒØ³ ØµØ­ÙŠØ­</a></li>
<li><a href="../ar488164/index.html">Ù…Ø¹Ø±ÙƒØ© SEC Ø¶Ø¯ Ø¨Ø±Ù‚ÙŠØ©</a></li>
<li><a href="../ar488190/index.html">Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù† Ø§Ù„Ø¥Ø±Ù‡Ø§Ù‚ Ø§Ù„Ø¹Ø§Ø·ÙÙŠ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>