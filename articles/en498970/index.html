<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüî¨ üç∂ üóëÔ∏è Kubernetes ConfigMaps: Nuances to Know ü§Ω üë∞üèº üêæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note : this is not a full-fledged guide article, but rather a reminder / hint for those who already use ConfigMap in Kubernetes or are just preparing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: Nuances to Know</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : this is not a full-fledged guide article, but rather a reminder / hint for those who already use ConfigMap in Kubernetes or are just preparing their application to work in it.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background: From rsync to ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happened before? In the era of ‚Äúclassical administration‚Äù, in the simplest version, the config file was placed right next to the applications (or in the repository, if you like). It's simple: we make elementary delivery (CD) for our code along with the config. Even a conditional rsync implementation can be called the rudiments of a CD.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the infrastructure grew, different configs were required for different environments (dev / stage / production). The application was trained to understand which config to use, passing them as arguments to start or environment variables set in the environment. Even more CD is complicated with the advent of such useful Chef / Puppet / Ansible. Roles appear at servers, and environments cease to be described in different places - we come to IaC (Infrastructure as code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What followed? If it was possible to see Kubernetes critical advantages for itself and even come to terms with the need to modify applications to work in this environment, migration occurred. On the way, I expected a lot of nuances and differences in the construction of the architecture, but when I managed to cope with the main part, I got the long-awaited application running in K8s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once here, we can still use the configs prepared in the repository next to the application or passing ENV to the container. </font><font style="vertical-align: inherit;">However, in addition to these methods, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are also available </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This K8s primitive allows you to use Go templates in configs, i.e. </font><font style="vertical-align: inherit;">render them like HTML pages and reload the application when changing the config without restart. </font><font style="vertical-align: inherit;">With ConfigMaps, there is no longer a need to keep 3+ configs for different environments and keep track of the relevance of each. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A general introduction to ConfigMaps can be found, for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And in this article I will focus on some features of working with them.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple ConfigMaps</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What did configs look like in Kubernetes? </font><font style="vertical-align: inherit;">What did they get from the go templates? </font><font style="vertical-align: inherit;">For example, here is an ordinary ConfigMap for an application deployed from a Helm chart:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the values ‚Äã‚Äãsubstituted in </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be taken from the file </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Why exactly from </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">How does the Go template engine work? </font><font style="vertical-align: inherit;">We have already talked about these details in more detail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The call </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helps to select the necessary line from the map:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, you can take both specific lines and entire fragments of the config. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, ConfigMap might be like this:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and in </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the following contents:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The one involved here </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the name of the environment. </font><font style="vertical-align: inherit;">Substituting this value during the deployment, you can render ConfigMaps with different content. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needed here because </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns a list, the first element of which contains the desired value.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When there are a lot of configs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One ConfigMap can contain several config files:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can even mount each config separately:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... or pick up all the configs at once with the directory:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you change the description of the Deployment resource during the deployment, Kubernetes will create a new ReplicaSet, decreasing the old one to 0 and increasing the new one to the specified number of replicas. </font><font style="vertical-align: inherit;">(This is true for the deployment strategy </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such actions will lead to the re-creation of the pod with a new description. </font><font style="vertical-align: inherit;">For example: there was an image </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but became - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And it doesn‚Äôt matter at all what exactly we changed in the description of our Deployment: the main thing is that this caused the replicaSet (and, as a result, the pod) to be recreated. </font><font style="vertical-align: inherit;">In this case, the new version of the config file in the new version of the application is automatically mounted and there will be no problem.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap Change Response</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In case of changes in ConfigMap four event scenarios can follow. </font><font style="vertical-align: inherit;">Consider them:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap‚Äô,   Deployment,   pod  ,   ‚Äî        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod‚Äô   / pod‚Äô.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will analyze in more detail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scenario 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corrected ConfigMap? </font><font style="vertical-align: inherit;">The application will not restart. </font><font style="vertical-align: inherit;">In the case of mounting by, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there will be no changes until the pod is manually restarted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is simple: Kubernetes mounts our ConfigMap in a pod of a specific version of the resource. </font><font style="vertical-align: inherit;">Since it is mounted with </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no additional "influence" on the config is no longer provided.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scenario 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Can't update the file without recreating the pod? </font><font style="vertical-align: inherit;">Okay, we have 6 replicas in Deployment, so we can take turns manually doing everything </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Then when creating new pods, they will ‚Äúpick up‚Äù the new version of ConfigMap.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scenario 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tired of performing such operations manually? </font><font style="vertical-align: inherit;">A solution to this problem is described in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm tips and tricks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash of the rendered annotation config is simply written </font><font style="vertical-align: inherit;">into the pod ( </font><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">template </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Annotations are arbitrary key-value fields in which you can store your values. </font><font style="vertical-align: inherit;">If you register them in the template of the </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">future pod, these fields will fall into the ReplicaSet and the pod itself. </font><font style="vertical-align: inherit;">Kubernetes will notice that the pod template has changed (since the sha256 config has changed) and will start </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in which nothing changes except this annotation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we save the same version of the Deployment‚Äôs application and description and essentially just trigger the re-creation of the pod by the machine - similar to how we would do it manually through </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but already ‚Äúcorrectly‚Äù: automatically and with </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scenario 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the application already knows how to monitor changes in the config and automatically reload? </font><font style="vertical-align: inherit;">Here lies an important feature of ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Kubernetes, if the config is mounted with </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it will not be updated until the pod is restarted </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(see the first three scenarios discussed above)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But if you mount ConfigMap as a directory, without </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then inside the container there will be a directory with an updated config without restarting pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are other features that are useful to remember:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Such an updated config file inside the container is updated with some delay. </font><font style="vertical-align: inherit;">This is due to the fact that the file is not mounted exactly, but the Kubernetes object.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The file inside is a symlink. </font><font style="vertical-align: inherit;">Example with </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And what will happen without </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when mounted by the directory?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update the config (via deploy or </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), wait 2 minutes (apiserver caching time) - and voila:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note the changed timestamp in the directory created by Kubernetes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change tracking</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally - a simple example of how you can monitor changes in the config.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will use such a Go-application</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... adding it with such a config:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If run, the log will be:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now we will install this application in Kubernetes, having mounted the ConfigMap config in the pod instead of the file from the image. </font><font style="vertical-align: inherit;">An </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example of a Helm chart has been</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prepared on GitHub </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And change only ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update the Helm chart in the cluster, for example, like this:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will happen?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Applications v1 and v2 do not restart, because </font><font style="vertical-align: inherit;">for them, no change has occurred in Deployment - they still welcome Alice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The v3 application restarted, re-read the config, and greeted Bob.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The v4 application did not restart. </font><font style="vertical-align: inherit;">Since ConfigMap is mounted as a directory, changes in the config were noticed and the config changed on the fly, without restarting the pod. </font><font style="vertical-align: inherit;">Yes, the application noticed changes in our simple example - see the event message from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can look at how a similar situation - tracking ConfigMap's changes - is being solved in a more adult (and just ‚Äúreal‚Äù) project, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is also useful to recall that all of the above in the article is also true for Secret'ov in Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">): it is not for nothing that they are so similar to ConfigMap ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus! </font><font style="vertical-align: inherit;">Third Party Solutions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in the topic of tracking changes in configs, there are already ready-made utilities for this:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Sends an HTTP request if the file has changed. </font><font style="vertical-align: inherit;">The developer also plans to teach SIGHUP to send, but the lack of commits from October 2019 leave these plans in question;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - monitors ConfigMap / Secrets and performs rolling upgrade (as its author calls it) on the resources associated with them.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will be convenient to launch such applications with a sidecar-container to existing applications. </font><font style="vertical-align: inherit;">However, if you know the features of Kubernetes / ConfigMap and configs to edit not ‚Äúlive‚Äù (through </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but only as part of the deployment ... then the capabilities of such utilities may seem superfluous, i.e. </font><font style="vertical-align: inherit;">duplicating basic functions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the advent of ConfigMap in Kubernetes, configs moved to the next round of development: using a template engine brought them flexibility comparable to rendering HTML pages. </font><font style="vertical-align: inherit;">Fortunately, such complications did not </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">replace the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> existing solutions, but became their </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, for administrators (or rather, even developers) who consider new features redundant, good old files are still available. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who already use ConfigMap'ami or just looking at them, the article gives a brief overview of their essence and nuances of use. </font><font style="vertical-align: inherit;">If you have your own tips &amp; tricks on the topic - I will be glad to see in the comments.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Local files when porting an application to Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   Kubernetes  Helm:    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498944/index.html">Telegram. Dog, or how not to make mirrors</a></li>
<li><a href="../en498948/index.html">Time for the dragons. Self-isolation with puzzles</a></li>
<li><a href="../en498952/index.html">We invite to DINS JS EVENING: we are talking about aspect-oriented programming and the Vuejs 3 composition API framework</a></li>
<li><a href="../en498958/index.html">Error is not UIAlertController</a></li>
<li><a href="../en498962/index.html">About multitasking: windows under control</a></li>
<li><a href="../en498974/index.html">Coronavirus: a dangerous illusion of insecurity</a></li>
<li><a href="../en498976/index.html">Introducing .NET 5.0 Preview 3</a></li>
<li><a href="../en498978/index.html">Using Graylog and NLog to collect logs from C # applications. Personal experience</a></li>
<li><a href="../en498982/index.html">Floppies for Dreamcast</a></li>
<li><a href="../en498984/index.html">Stealth School: 5 types of gadgets in stealth games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>