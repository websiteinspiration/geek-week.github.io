<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ñ üí® üïú C√°lculo r√°pido de f√≥rmulas do Excel em C # üåÅ ü§æüèΩ üïπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Com que frequ√™ncia voc√™ ouve os clientes que eles enviar√£o dados para o Excel ou solicitar√£o que voc√™ importe ou fa√ßa o upload em um formato compat√≠ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√°lculo r√°pido de f√≥rmulas do Excel em C #</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/498032/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com que frequ√™ncia voc√™ ouve os clientes que eles enviar√£o dados para o Excel ou solicitar√£o que voc√™ importe ou fa√ßa o upload em um formato compat√≠vel com o Excel? </font><font style="vertical-align: inherit;">Estou certo de que, na maioria das √°reas, o Excel √© uma das ferramentas mais populares, poderosas e, ao mesmo tempo, simples e convenientes. </font><font style="vertical-align: inherit;">Mas o ponto mais problem√°tico √© sempre a integra√ß√£o desses dados com v√°rios sistemas automatizados. </font><font style="vertical-align: inherit;">Nossa equipe foi solicitada a considerar a possibilidade de realizar c√°lculos de dados usando as configura√ß√µes de um arquivo personalizado do Excel.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8g/to/wx/8gtowxbs0dnpmjvr59epns8b0sq.jpeg" alt="C√°lculo r√°pido de f√≥rmulas do Excel em C #"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ precisar escolher uma biblioteca produtiva para trabalhar com arquivos do Excel ou se estiver procurando uma solu√ß√£o para calcular dados financeiros complexos (e n√£o apenas) com uma ferramenta conveniente para gerenciar e visualizar f√≥rmulas prontas para uso, seja bem-vindo ao gato.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estudando os requisitos de um novo projeto na empresa, encontramos um ponto muito interessante: ‚ÄúA solu√ß√£o desenvolvida deve ser capaz de calcular o custo do produto (a varanda) ao alterar a configura√ß√£o e exibir instantaneamente o novo custo na interface. √â necess√°rio fornecer a capacidade de baixar um arquivo do Excel com todas as fun√ß√µes de c√°lculo e listas de pre√ßos de componentes. ‚Äù O cliente precisava desenvolver um portal para projetar a configura√ß√£o das varandas, dependendo dos tamanhos, formas, tipos de vidros e materiais utilizados, tipos de fixa√ß√µes, al√©m de muitos outros par√¢metros relacionados que s√£o usados ‚Äã‚Äãpara calcular o custo exato dos indicadores de produ√ß√£o e confiabilidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formalizamos os requisitos de entrada para que seja mais f√°cil entender em que contexto foi necess√°rio resolver o problema:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√°lculo r√°pido de pre√ßos na interface ao alterar os par√¢metros da varanda;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√°lculo r√°pido de dados de projeto, incluindo muitas configura√ß√µes diferentes de varandas e ofertas individuais, fornecidas por um arquivo de c√°lculo separado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A longo prazo - o desenvolvimento da funcionalidade usando v√°rias opera√ß√µes que consomem recursos (tarefas de otimiza√ß√£o de par√¢metros etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo isso em um servidor remoto com sa√≠da via API, porque </font><font style="vertical-align: inherit;">Todas as f√≥rmulas s√£o de propriedade intelectual do cliente e n√£o devem ser vis√≠veis para terceiros;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fluxo de dados de entrada com pico de carga: o usu√°rio pode alterar os par√¢metros com freq√º√™ncia e rapidez para selecionar a configura√ß√£o do produto de acordo com seus requisitos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece muito incomum e super tentador, vamos come√ßar!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solu√ß√µes chave na m√£o e prepara√ß√£o de dados</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qualquer pesquisa para resolver problemas complexos come√ßa com a navega√ß√£o no StackOverflow, GitHub e em muitos f√≥runs que procuram solu√ß√µes prontas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√°rias solu√ß√µes prontas foram selecionadas que suportam a leitura de dados de arquivos do Excel, al√©m de poderem executar c√°lculos com base nas f√≥rmulas especificadas na biblioteca. </font><font style="vertical-align: inherit;">Entre essas bibliotecas, existem solu√ß√µes totalmente gratuitas e desenvolvimentos comerciais.&nbsp;</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liga√ß√£o</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documenta√ß√£o</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Licen√ßa</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/JanKallman/EPPlus</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/JanKallman/EPPlus/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Licen√ßa P√∫blica Geral da Biblioteca GNU&nbsp;</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/EPPlusSoftware/EPPlus</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/EPPlusSoftware/EPPlus/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Licen√ßa N√£o Comercial Polyform 1.0.0 ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.epplussoftware.com/LicenseOverview</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )&nbsp;</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/tonyqus/npoi</font></font></a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/tonyqus/npoi/wiki</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Licen√ßa Apache 2.0</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.e-iceblue.com/Introduce/excel-for-net-introduce.html</a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.e-iceblue.com/Tutorials/Spire.XLS/Spire.XLS-Program-Guide/Spire.XLS-Program-Guide-Content.html</a></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">www.e-iceblue.com/Tutorials/Licensing/License-Agreement.html</a>&nbsp;</td>
</tr>
<tr>
<td><strong>Excel Interop</strong><i>(Microsoft.Office.Interop.Excel)</i></td>
<td>n/a</td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docs.microsoft.com/ru-ru/dotnet/api/microsoft.office.interop.excel._workbook?view=excel-pia</a></td>
<td><i>  Excel     </i></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo passo √© escrever testes de carga e medir o tempo de execu√ß√£o de cada biblioteca. Para fazer isso, prepare os dados do teste. Criamos um novo arquivo do Excel, definimos 10 c√©lulas para os par√¢metros de entrada e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> f√≥rmula </font><font style="vertical-align: inherit;">( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lembre-se deste momento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) para obter um resultado que use todos os par√¢metros de entrada. Na f√≥rmula, tentamos usar todas as fun√ß√µes matem√°ticas poss√≠veis de v√°rias complexidades computacionais e as combinamos de uma maneira complicada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Porque tamb√©m se trata de dinheiro (o custo do produto), √© importante observar a precis√£o dos resultados. Nesse caso, tomaremos os valores resultantes que foram obtidos usando o </font><strong><font style="vertical-align: inherit;">Excel Interop</font></strong><font style="vertical-align: inherit;"> como refer√™ncia</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porque Os dados obtidos dessa maneira s√£o calculados atrav√©s do n√∫cleo do Excel e s√£o iguais aos valores que os clientes veem ao desenvolver f√≥rmulas e calcular manualmente o custo.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como tempo de execu√ß√£o de refer√™ncia, usaremos o c√≥digo nativo escrito manualmente em C # puro para exibir a mesma f√≥rmula escrita no Excel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√≥rmula de teste inicial traduzida:</font></font><br>
<br>
<pre><code class="plaintext hljs">public double Execute(double[] p)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return Math.Pow(p[0] * p[8] / p[4] * Math.Sin(p[5]) * Math.Cos(p[2]) +<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Math.Abs(p[1] - (p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8]))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Math.Sqrt(p[0] * p[0] + p[1] * p[1]) / 2.0 * Math.PI, p[9]);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formamos um fluxo de dados de entrada aleat√≥rios para N itera√ß√µes (neste caso, usamos 10.000 vetores). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iniciamos os c√°lculos para cada vetor de par√¢metros de entrada em todo o fluxo, obtemos os resultados e medimos o tempo de inicializa√ß√£o da biblioteca e o c√°lculo geral. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comparar a precis√£o dos resultados, usamos dois indicadores - o desvio padr√£o e a porcentagem de valores correspondentes com uma certa etapa de precis√£o epsilon. Se voc√™ gerar aleatoriamente uma lista de valores de entrada com um ponto flutuante ap√≥s o ponto decimal, dever√° determinar a precis√£o dos par√¢metros de entrada - isso permitir√° obter os resultados corretos. Caso contr√°rio, os n√∫meros aleat√≥rios podem ter uma grande diferen√ßa de ordens de magnitude - isso pode afetar muito a precis√£o dos resultados e afetar a estimativa do erro do resultado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Porque Inicialmente, assumimos que √© necess√°rio operar com valores constantes do custo dos materiais, bem como algumas constantes de diferentes campos do conhecimento, podemos aceitar que todos os par√¢metros de entrada ter√£o valores precisos com tr√™s casas decimais. Idealmente, voc√™ precisa especificar um intervalo v√°lido de valores para cada um dos par√¢metros e us√°-los apenas para gerar valores aleat√≥rios, mas como a f√≥rmula para o teste foi compilada aleatoriamente sem nenhuma justificativa matem√°tica e f√≠sica; portanto, n√£o √© poss√≠vel calcular esse intervalo de valores para todos os 10 par√¢metros em um per√≠odo de tempo razo√°vel. Portanto, em c√°lculos, √†s vezes √© poss√≠vel obter um erro de c√°lculo. Exclu√≠mos esses vetores de dados de entrada j√° no momento do c√°lculo para indicadores de precis√£o,mas contaremos esses erros como uma caracter√≠stica separada.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura de Teste&nbsp;</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada biblioteca separada, foi criada sua pr√≥pria classe que implementa uma interface </font></font><code>ITestExecutor </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que inclui 3 m√©todos - </font></font><code>SetUp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Execute </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>TearDown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">public interface ITestExecutor<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//      <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;void SetUp();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//   ,           <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;double Execute(double[] p);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;//    ,      <font></font>
&nbsp;&nbsp;&nbsp;&nbsp;void TearDown();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√©todos </font></font><code>SetUp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>TearDown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usados ‚Äã‚Äãapenas uma vez no processo de teste da biblioteca e n√£o s√£o considerados ao medir c√°lculos de tempo em todo o conjunto de dados de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, o algoritmo de teste se resumiu ao seguinte:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prepara√ß√£o de dados (formamos um fluxo de vetores de entrada de uma determinada precis√£o);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aloca√ß√£o de mem√≥ria para os dados resultantes (uma matriz de resultados para cada biblioteca, uma matriz com o n√∫mero de erros);&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializa√ß√£o de bibliotecas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obten√ß√£o de resultados de c√°lculo para cada uma das bibliotecas, salvando o resultado em uma matriz pr√©-preparada e registrando o tempo de execu√ß√£o;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o do trabalho com o c√≥digo das bibliotecas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise dos dados:</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma representa√ß√£o gr√°fica deste algoritmo √© apresentada abaixo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sl/yg/e0/slyge0dloc1dednqql-hgga6um4.png" alt="Fluxograma de testes de desempenho e precis√£o das bibliotecas de suporte do Excel"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultados da primeira itera√ß√£o</font></font></h1><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√çndice</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nativo</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4</font></font></strong><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interoperabilidade do Excel</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tempo de inicializa√ß√£o (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">257</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">266</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">632</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1653</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Casar </font><font style="vertical-align: inherit;">tempo para 1 passagem (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0002</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,4086</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,6847</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6,9782</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">38,8423</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©dia </font><font style="vertical-align: inherit;">desvio</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000394</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000395</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000237</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000631</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Precis√£o</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99,99%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99,92%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99,97%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">99,84%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,94%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,94%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,52%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,94%</font></font></td>
</tr>
</tbody></table></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que os resultados do EPPlus 5 e EPPlus 4 s√£o combinados?</font></font></b>
                        <div class="spoiler_text">      EPPlus      .    ,       ,         .    ,         .     EPPlus 5     ,       .          ,      EPPlus,    .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira itera√ß√£o dos testes mostrou um bom resultado, no qual os l√≠deres entre as bibliotecas ficaram imediatamente vis√≠veis. </font><font style="vertical-align: inherit;">Como pode ser visto pelos dados acima, o l√≠der absoluto nesta situa√ß√£o √© a biblioteca EPPlus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resultados n√£o s√£o impressionantes em compara√ß√£o com o c√≥digo nativo, mas voc√™ pode viver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso poderia ter sido interrompido, mas depois de conversar com os clientes, surgiram as primeiras d√∫vidas: os resultados foram bons demais.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zp/7s/ry/zp7sryxdmhkg5rp8xfhwf537kti.jpeg"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursos para trabalhar com a biblioteca Spire</font></font></b>
                        <div class="spoiler_text">     Spire  ,             InvalidCastException.      ,          Excel-    ,     ,      ,     .                    try...catch.       ,         .<br>
</div>
                    </div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rake da primeira itera√ß√£o de testes</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima, pedi que voc√™ chamasse sua aten√ß√£o para um ponto que teve um papel importante na obten√ß√£o de resultados. Suspeitamos que as f√≥rmulas usadas no arquivo real do Excel do cliente estivessem longe de ser primitivas, com muitas depend√™ncias internas, mas n√£o suspeit√°vamos que isso pudesse afetar muito os indicadores. No entanto, inicialmente, ao compilar os dados de teste, eu n√£o previ isso, e os dados do cliente (pelo menos as informa√ß√µes de que pelo menos 120 par√¢metros de entrada s√£o usados ‚Äã‚Äãno arquivo final) sugeriram que precisamos pensar e adicionar f√≥rmulas com depend√™ncias entre c√©lulas .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a preparar novos dados para a pr√≥xima itera√ß√£o de teste. </font><font style="vertical-align: inherit;">Vamos nos concentrar em 10 par√¢metros de entrada e adicionar 4 novas f√≥rmulas adicionais com depend√™ncia apenas de par√¢metros e 1 f√≥rmula de agrega√ß√£o, que se baseia nessas quatro c√©lulas com f√≥rmulas e tamb√©m depender√° dos valores dos dados de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A nova f√≥rmula que ser√° usada para testes subsequentes:</font></font><br>
<br>
<pre><code class="plaintext hljs">public double Execute(double[] p)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price1 = Math.Pow(p[0] * p[8] / p[4] * Math.Sin(p[5]) * Math.Cos(p[2]) +<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Math.Abs(p[1] - (p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8]))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* Math.Sqrt(p[0] * p[0] + p[1] * p[1]) / 2.0 * Math.PI, p[9]);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price2 = p[4] * p[5] * p[2] / Math.Max(1, Math.Abs(p[7]));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price3 = Math.Abs(p[7] - p[3]) * p[2];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price4 = Math.Sqrt(Math.Abs(p[1] * p[2] + p[3] * p[4] + p[5] * p[6]) + 1.0);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price5 = p[0] * Math.Cos(p[1]) + p[2] * Math.Sin(p[1]);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var sum = p[0] + p[1] + p[2] + p[3] + p[4] + p[5] + p[6] + p[7] + p[8] + p[9];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var price6 = sum / Math.Max(1, Math.Abs((p[0] + p[1] + p[2] + p[3]) / 4.0))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ sum / Math.Max(1, Math.Abs((p[4] + p[5] + p[6] + p[7] + p[8] + p[9]) / 6.0));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var pricingAverage = (price1 + price2 + price3 + price4 + price5 + price6) / 6.0;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return pricingAverage / Math.Max(1, Math.Abs(price1 + price2 + price3 + price4 + price5 + price6));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, a f√≥rmula resultante acabou sendo muito mais complicada, o que naturalmente afetou os resultados - n√£o para melhor. </font><font style="vertical-align: inherit;">Uma tabela com os resultados √© apresentada abaixo:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√çndice</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nativo</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 4 </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus 5</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NPOI</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spire</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interoperabilidade do Excel</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tempo de inicializa√ß√£o (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">241</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">368</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">722</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1640</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Casar </font><font style="vertical-align: inherit;">tempo para 1 passagem (ms)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0004</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,9174 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 124%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,8996 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 177%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7,7647 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 11%)</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50,7194 </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(+ 30%)</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©dia </font><font style="vertical-align: inherit;">desvio</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,035884</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,000000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Precis√£o</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98,79%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,00%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,28%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
</tr>
</tbody></table></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xg/l5/ye/xgl5yefp3_meak1f4qzj1mctjsm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota: Porque </font><font style="vertical-align: inherit;">A interoperabilidade do Excel √© muito grande e precisou ser exclu√≠da do gr√°fico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como pode ser visto nos resultados, a situa√ß√£o se tornou completamente inadequada para uso na produ√ß√£o. </font><font style="vertical-align: inherit;">Um pouco triste, compre caf√© e mergulhe mais fundo no estudo - direto na gera√ß√£o do c√≥digo.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nv/d_/kh/nvd_khyfluufkuwh64vikgafdpe.jpeg"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gera√ß√£o de c√≥digo</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se de repente voc√™ nunca enfrentou uma tarefa semelhante, realizaremos uma breve excurs√£o.&nbsp;</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A gera√ß√£o de c√≥digo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma maneira de resolver um problema, gerando dinamicamente o c√≥digo fonte com base nos dados de entrada, com subsequente compila√ß√£o e execu√ß√£o. </font><font style="vertical-align: inherit;">H√° gera√ß√£o de c√≥digo est√°tico que ocorre durante a constru√ß√£o do projeto (como exemplo, posso citar o T4MVC, que cria um novo c√≥digo com base em modelos e metadados que podem ser usados ‚Äã‚Äãao escrever o c√≥digo principal do aplicativo) e c√≥digo din√¢mico que √© executado durante o tempo de execu√ß√£o.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossa tarefa √© formar uma nova fun√ß√£o com base nos dados de origem (f√≥rmulas do Excel), que recebe o resultado com base no vetor de valores de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, voc√™ deve:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leia a f√≥rmula do arquivo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Colete todas as depend√™ncias;</font></font></li>
<li>       C#;</li>
<li>     ;</li>
<li>            ;</li>
<li>     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as bibliotecas apresentadas s√£o adequadas para a leitura de f√≥rmulas; no entanto, a biblioteca </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acabou sendo a interface mais conveniente para essa funcionalidade </font><font style="vertical-align: inherit;">. Tendo vasculhado um pouco o c√≥digo fonte desta biblioteca, descobri as classes p√∫blicas para formar uma lista de tokens e sua transforma√ß√£o adicional em uma √°rvore de express√£o. Bingo, pensei! Uma √°rvore de express√£o pronta da caixa √© ideal, basta passar por ela e formar nosso c√≥digo C #.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas um grande problema estava me esperando quando comecei a estudar os n√≥s da √°rvore de express√£o resultante. Alguns n√≥s, em particular a chamada para fun√ß√µes do Excel, encapsularam informa√ß√µes sobre a fun√ß√£o usada e seus par√¢metros de entrada e n√£o forneceram nenhum acesso aberto a esses dados. Portanto, o trabalho com a √°rvore de express√£o final teve que ser adiado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subimos um n√≠vel abaixo e tentamos trabalhar com a lista de tokens. Tudo √© bem simples aqui: temos tokens com tipo e valor. Porque recebemos uma fun√ß√£o e precisamos formar uma fun√ß√£o; ent√£o, podemos converter os tokens da √°rvore para o equivalente em C #. O principal nesta abordagem √© organizar fun√ß√µes compat√≠veis. A maioria das fun√ß√µes matem√°ticas j√° era compat√≠vel - como calcular o cosseno, o seno, obter a raiz e aumentar a pot√™ncia. Mas as fun√ß√µes de agrega√ß√£o - como valor m√°ximo, m√≠nimo e valor - precisavam ser finalizadas. A principal diferen√ßa √© que, no Excel, essas fun√ß√µes funcionam com uma faixa de valores. Para simplificar o prot√≥tipo, criaremos fun√ß√µes que recebem uma lista de par√¢metros como entrada, expandindo anteriormente o intervalo de valores em uma lista linear.Dessa forma, obtemos a convers√£o correta e compat√≠vel da sintaxe do Excel para a sintaxe C #.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° o c√≥digo principal para converter uma lista de tokens de uma f√≥rmula do Excel em um c√≥digo C # v√°lido.</font></font><br>
<br>
<pre><code class="plaintext hljs">private string TransformToSharpCode(string formula, ParsingContext parsingContext)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize basic compile components, e.g. lexer<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var lexer = new Lexer(parsingContext.Configuration.FunctionRepository, parsingContext.NameValueProvider);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// List of dependency variables that can be filled during formula transformation<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var variables = new Dictionary&lt;string, string&gt;();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;using (var scope = parsingContext.Scopes.NewScope(RangeAddress.Empty))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Take resulting code line<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var compiledResultCode = TransformToSharpCode(formula, parsingContext, scope, lexer, variables);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var output = new StringBuilder();<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Define dependency variables in reverse order.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (var variableDefinition in variables.Reverse())<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.AppendLine($"var {variableDefinition.Key} = {variableDefinition.Value};");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Take the result<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.AppendLine($"return {compiledResultCode};");<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return output.ToString();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
}<font></font>
<font></font>
private string TransformToSharpCode(ICollection&lt;Token&gt; tokens, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var output = new StringBuilder();<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;foreach (Token token in tokens)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch (token.TokenType)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Function:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(BuildFunctionName(token.Value));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.OpeningParenthesis:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append("(");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.ClosingParenthesis:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(")");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Comma:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(", ");<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.ExcelAddress:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var address = token.Value;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(TransformAddressToSharpCode(address, parsingContext, scope, lexer, variables));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Decimal:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Integer:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Boolean:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(token.Value);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case TokenType.Operator:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output.Append(token.Value);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return output.ToString();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√≥xima nuance na convers√£o foi o uso de constantes do Excel - elas s√£o fun√ß√µes; portanto, em C # elas tamb√©m precisam ser agrupadas em uma fun√ß√£o.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta resolver apenas uma quest√£o: a convers√£o de refer√™ncias de c√©lulas em um par√¢metro. No caso em que o token cont√©m informa√ß√µes sobre a c√©lula, primeiro determinamos o que est√° armazenado nessa c√©lula. Se essa √© uma f√≥rmula, expanda-a recursivamente. Se a constante for substitu√≠da por um link anal√≥gico em C #, no formul√°rio </font></font><code>p[row, column]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, em que </font></font><code>p</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poder√° ser uma matriz bidimensional ou uma classe de acesso indexada para o mapeamento correto dos dados. Com um intervalo de c√©lulas, fazemos o mesmo, basta expandir previamente o intervalo em c√©lulas individuais e process√°-las separadamente. Assim, abordamos a principal funcionalidade ao traduzir uma fun√ß√£o do Excel.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/kk/hz/gwkkhzpfeudqdzcbfsgsdzdtolo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° o c√≥digo para converter um link em uma c√©lula da planilha do Excel em um c√≥digo C # v√°lido:</font></font><br>
<br>
<pre><code class="plaintext hljs">private string TransformAddressToSharpCode(string excelAddress, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Try to parse excel range of addresses<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Currently, reference to another worksheet in address string is not supported<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var rangeParts = excelAddress.Split(':');<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (rangeParts.Length == 1)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Unpack single excel address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return UnpackExcelAddress(excelAddress, parsingContext, scope, lexer, variables);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Parse excel range address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(rangeParts[0], out int startRowIndex, out int startColumnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(rangeParts[1], out int endRowIndex, out int endColumnIndex);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var rowDelta = endRowIndex - startRowIndex;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var columnDelta = endColumnIndex - startColumnIndex;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var allAccessors = new List&lt;string&gt;(Math.Abs(rowDelta * columnDelta));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// TODO This part of code doesn't support reverse-ordered range address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;for (var rowIndex = startRowIndex; rowIndex &lt;= endRowIndex; rowIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (var columnIndex = startColumnIndex; columnIndex &lt;= endColumnIndex; columnIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Unpack single excel address<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allAccessors.Add(UnpackExcelAddress(rowIndex, columnIndex, parsingContext, scope, lexer, variables));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return string.Join(", ", allAccessors);<font></font>
}<font></font>
<font></font>
private string UnpackExcelAddress(string excelAddress, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;ParseAddressToIndexes(excelAddress, out int rowIndex, out int columnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return UnpackExcelAddress(rowIndex, columnIndex, parsingContext, scope, lexer, variables);<font></font>
}<font></font>
<font></font>
private string UnpackExcelAddress(int rowIndex, int columnIndex, ParsingContext parsingContext, ParsingScope scope, ILexer lexer, Dictionary&lt;string, string&gt; variables)<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var formula = parsingContext.ExcelDataProvider.GetRangeFormula(_worksheet.Name, rowIndex, columnIndex);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (string.IsNullOrWhiteSpace(formula))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// When excel address doesn't contain information about any excel formula, we should just use external input data parameter provider.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $"p[{rowIndex},{columnIndex}]";<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// When formula is provided, try to identify that variable is not defined yet<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// TODO Worksheet name is not included in variable name, potentially that can cause conflicts<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Extracting and reusing calculations via local variables improves performance for 0.0045ms<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var cellVariableId = $"C{rowIndex}R{columnIndex}";<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;if (variables.ContainsKey(cellVariableId))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return cellVariableId;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// When variable does not exist, transform new formula and register that to variable scope<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;variables.Add(cellVariableId, TransformToSharpCode(formula, parsingContext, scope, lexer, variables));<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return cellVariableId;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta apenas envolver o c√≥digo convertido resultante em uma fun√ß√£o est√°tica, vincular o assembly a fun√ß√µes de compatibilidade e compilar o assembly din√¢mico. </font><font style="vertical-align: inherit;">Carregue-o na mem√≥ria, obtenha um link para nossa fun√ß√£o - e voc√™ pode us√°-lo.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s escrevemos uma classe de inv√≥lucro para testar e executar testes com medi√ß√£o de tempo.&nbsp;</font></font><br>
<br>
<pre><code class="plaintext hljs">public void SetUp()<font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize excel package by EPPlus library<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_package = new ExcelPackage(new FileInfo(_fileName));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_workbook = _package.Workbook;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_worksheet = _workbook.Worksheets[1];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_inputRange = new ExcelRange[10];<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;for (int rowIndex = 0; rowIndex &lt; 10; rowIndex++)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_inputRange[rowIndex] = _worksheet.Cells[rowIndex + 1, 2];<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Access to result cell and extract formula string<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_resultRange = _worksheet.Cells[11, 2];<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var formula = _resultRange.Formula;<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Initialize parsing context and setup data provider<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var parsingContext = ParsingContext.Create();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;parsingContext.ExcelDataProvider = new EpplusExcelDataProvider(_package);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Transform Excel formula to CSharp code<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;var sourceCode = TransformToSharpCode(formula, parsingContext);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;// Compile CSharp code to IL dynamic assembly via helper wrappers<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;_code = CodeGenerator.CreateCode&lt;double&gt;(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sourceCode,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new string[]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// List of used namespaces<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"System", // Required for Math functions<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ExcelCalculations.PerformanceTests" // Required for Excel function wrappers stored at ExcelCompiledFunctions static class<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new string[]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Add reference to current compiled assembly, that is required to use Excel function wrappers located at ExcelCompiledFunctions static class<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"....\\bin\\Debug\\ExcelCalculations.PerformanceTests.exe"<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Notify that this source code should use parameter;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Use abstract p parameter - interface for values accessing.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new CodeParameter("p", typeof(IExcelValueProvider))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, temos um prot√≥tipo dessa solu√ß√£o e o marcamos como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-I</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ap√≥s a execu√ß√£o dos testes, obtemos o resultado esperado. A acelera√ß√£o √© quase 300 vezes. J√° n√£o √© ruim, mas o c√≥digo resultante ainda √© 16 vezes mais lento que o nativo. Poderia ser melhor? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim voc√™ pode! Vamos tentar melhorar o resultado devido ao fato de substituirmos todos os links para c√©lulas adicionais por f√≥rmulas com vari√°veis. Nosso teste usa o uso m√∫ltiplo de c√©lulas dependentes na f√≥rmula; portanto, na primeira vers√£o do tradutor, recebemos v√°rios c√°lculos dos mesmos dados. Portanto, decidiu-se usar vari√°veis ‚Äã‚Äãintermedi√°rias nos c√°lculos. Ap√≥s expandir o c√≥digo usando a gera√ß√£o de vari√°veis ‚Äã‚Äãdependentes, obtivemos um aumento de desempenho de mais duas vezes. Essa melhoria √© chamada</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-II</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A tabela de compara√ß√£o √© apresentada abaixo:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Casar </font><font style="vertical-align: inherit;">tempo (ms)</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coef. </font><font style="vertical-align: inherit;">lentid√£o</font></font></strong></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nativo</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,00004</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 1</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-II</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,003</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlusCompiled, Mark-I</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0061</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dezesseis</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPPlus</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2089</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3023</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sob essas condi√ß√µes e os prazos alocados para a tarefa, obtivemos um resultado que nos aproxima do desempenho do c√≥digo nativo com um pequeno atraso - 8 vezes em compara√ß√£o com a vers√£o original - um atraso de v√°rias ordens de magnitude, 3028 vezes. </font><font style="vertical-align: inherit;">Mas √© poss√≠vel melhorar o resultado e chegar o mais pr√≥ximo poss√≠vel do c√≥digo nativo, se voc√™ remover os limites de tempo e quanto ser√° apropriado?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minha resposta √© sim, mas, infelizmente, n√£o tive mais tempo para implementar essas t√©cnicas. </font><font style="vertical-align: inherit;">Talvez eu devote um artigo separado para esse t√≥pico. </font><font style="vertical-align: inherit;">No momento, s√≥ posso falar sobre as principais id√©ias e op√ß√µes, escrevendo-as na forma de resumos curtos que foram verificados por transforma√ß√£o reversa. </font><font style="vertical-align: inherit;">Por convers√£o reversa, quero dizer a degrada√ß√£o do c√≥digo nativo escrito √† m√£o na dire√ß√£o do c√≥digo gerado. </font><font style="vertical-align: inherit;">Essa abordagem permite que voc√™ verifique algumas teses com bastante rapidez e n√£o exige altera√ß√µes significativas no c√≥digo. </font><font style="vertical-align: inherit;">Tamb√©m permite responder √† pergunta de como o desempenho do c√≥digo nativo se deteriorar√° sob certas condi√ß√µes, o que significa que, se o c√≥digo gerado for aprimorado automaticamente na dire√ß√£o oposta, podemos obter uma melhoria de desempenho com um coeficiente semelhante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumos</font></font></h2><br>
<ol>
<li>  ,                     ;</li>
<li>           inline      ;</li>
<li> -     Sum, Max, Min   ;</li>
<li>  Sum  inline     ;</li>
<li>   (         )    .</li>
</ol><br>
<h1></h1><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong></strong></td>
<td><strong>Native</strong></td>
<td><strong>EPPlus Compiled, Mark-II</strong></td>
<td><strong>EPPlus 4</strong><strong>EPPlus 5</strong></td>
<td><strong>NPOI</strong></td>
<td><strong>Spire</strong></td>
<td><strong>Excel Interop</strong></td>
</tr>
<tr>
<td><strong>  ()</strong></td>
<td>0</td>
<td>239</td>
<td>241</td>
<td>368</td>
<td>722</td>
<td>1640</td>
</tr>
<tr>
<td><strong>.   1  ()</strong></td>
<td>0,0004</td>
<td>0,003</td>
<td>0,9174</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.8996</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.7647</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50.7194</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©dia </font><font style="vertical-align: inherit;">desvio</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,035884</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Precis√£o</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98,79%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n / D</font></font></td>
</tr>
<tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros</font></font></strong></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,0%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,28%</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,3%</font></font></td>
</tr>
</tbody></table></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kd/py/vy/kdpyvy0-qfqtfbwgtvbwjo28coo.png" alt="C√°lculo r√°pido de f√≥rmulas do Excel em C #"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumindo as etapas, temos um mecanismo para converter f√≥rmulas diretamente de um documento personalizado do Excel em c√≥digo de trabalho no servidor. </font><font style="vertical-align: inherit;">Isso permite que voc√™ use a incr√≠vel flexibilidade de integrar o Excel a qualquer solu√ß√£o de neg√≥cios sem perder a poderosa interface do usu√°rio com a qual um grande n√∫mero de usu√°rios est√° acostumado a trabalhar. </font><font style="vertical-align: inherit;">Foi poss√≠vel desenvolver uma interface t√£o conveniente com o mesmo conjunto de ferramentas para analisar e visualizar dados como no Excel por um per√≠odo t√£o curto de desenvolvimento? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E quais foram as integra√ß√µes mais incomuns e interessantes com os documentos do Excel que voc√™ teve que implementar?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498022/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 341 (de 13 a 19 de abril)</a></li>
<li><a href="../pt498024/index.html">Construindo cidades com um clique do mouse com Houdini e Python</a></li>
<li><a href="../pt498026/index.html">FOSS News No. 12 - revis√£o de not√≠cias gratuitas e de c√≥digo aberto de 13 a 19 de abril de 2020</a></li>
<li><a href="../pt498028/index.html">Simula√ß√£o pand√™mica de Python COVID-19</a></li>
<li><a href="../pt498030/index.html">Backup: onde, como e por qu√™?</a></li>
<li><a href="../pt498034/index.html">As modernas aeronaves projetadas s√£o protegidas contra amea√ßas biol√≥gicas (COVID-19) melhor do que voc√™ pensa</a></li>
<li><a href="../pt498036/index.html">Mark Andriessen: √â hora de criar para n√≥s mesmos (√© hora de construir)</a></li>
<li><a href="../pt498038/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 411 (13-19 de abril de 2020)</a></li>
<li><a href="../pt498042/index.html">Analisar, n√£o validar</a></li>
<li><a href="../pt498046/index.html">Pesquisadores est√£o desenvolvendo uma abordagem para reduzir o vi√©s nos conjuntos de dados de vis√£o computacional</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>