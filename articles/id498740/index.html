<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐅 🚾 🤜🏻 Antipattern PostgreSQL: Navigasi Registri 🤳 🙇🏿 🤛🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari ini tidak akan ada kasus rumit dan algoritma SQL canggih. Semuanya akan sangat sederhana, di tingkat Kapten Bukti - kami melakukan peninjauan reg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipattern PostgreSQL: Navigasi Registri</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498740/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hari ini tidak akan ada kasus rumit dan algoritma SQL canggih. </font><font style="vertical-align: inherit;">Semuanya akan sangat sederhana, di tingkat Kapten Bukti - kami melakukan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peninjauan register acara</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan mengurutkan berdasarkan waktu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artinya, ada piring di pangkalan </font></font><code>events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan bidangnya </font></font><code>ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tepat waktu yang sama dengan mana kami ingin menampilkan catatan ini secara tertib:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">events</span>(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, ts<font></font>
    <span class="hljs-built_in">timestamp</span>
, <span class="hljs-keyword">data</span>
    <span class="hljs-keyword">json</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">events</span>(ts <span class="hljs-keyword">DESC</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jelas bahwa kita tidak akan memiliki selusin entri di sana, jadi kita akan membutuhkan semacam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">navigasi halaman</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 0 </font><font style="vertical-align: inherit;">"Aku seorang pogrommist di ibuku"</font></font></h2><br>
<pre><code class="python hljs">cur.execute(<span class="hljs-string">"SELECT * FROM events;"</span>)<font></font>
rows = cur.fetchall();<font></font>
rows.sort(key=<span class="hljs-keyword">lambda</span> row: row.ts, reverse=<span class="hljs-literal">True</span>);<font></font>
limit = <span class="hljs-number">26</span><font></font>
print(rows[offset:offset+limit]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hampir tidak ada lelucon - jarang, tetapi ditemukan di alam liar. </font><font style="vertical-align: inherit;">Kadang-kadang setelah bekerja dengan ORM bisa sulit untuk beralih ke pekerjaan "langsung" dengan SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi mari kita beralih ke masalah yang lebih umum dan kurang jelas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1. </font><font style="vertical-align: inherit;">MENGIMBANGI</font></font></h2><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ...<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">events</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  ts <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">26</span> <span class="hljs-keyword">OFFSET</span> $<span class="hljs-number">1</span>; <span class="hljs-comment">-- 26 -   , $1 -  </span></code></pre><br>
<blockquote>    26?        . , 25  ,  1, ,      -       .<br>
<br>
,     «»   ,    .      PostgreSQL     ,      , —     .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sementara di antarmuka aplikasi tampilan registri diimplementasikan sebagai peralihan antara "halaman" visual, tidak ada seorang pun untuk waktu yang lama memperhatikan sesuatu yang mencurigakan. Tepat sampai saat ketika, dalam perjuangan untuk kenyamanan, UI / UX tidak memutuskan untuk membuat ulang antarmuka menjadi "gulir tanpa akhir" - yaitu, semua entri registri digambar dalam satu daftar yang pengguna dapat putar ke atas dan ke bawah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang, selama tes berikutnya, Anda terjebak </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entri duplikat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di registri. Mengapa, karena tabel memiliki indeks normal </font></font><code>(ts)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang menjadi dasar kueri Anda? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tepat karena Anda tidak mempertimbangkan apa yang </font></font><b><code>ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bukan kunci unik</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam tabel ini. Sebenarnya, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maknanya tidak unik</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, seperti "waktu" dalam kondisi nyata - itulah sebabnya catatan yang sama di dua kueri tetangga dengan mudah "melompat" dari halaman ke halaman karena urutan akhir yang berbeda sebagai bagian dari pengurutan nilai kunci yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan, masalah kedua juga tersembunyi di sini, yang jauh lebih sulit untuk diperhatikan - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa entri tidak akan ditampilkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sama sekali! </font><font style="vertical-align: inherit;">Lagi pula, catatan "duplikat" mengambil tempat seseorang. </font><font style="vertical-align: inherit;">Penjelasan terperinci dengan gambar-gambar indah dapat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ditemukan di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memperluas Indeks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengembang yang licik memahami bahwa Anda perlu membuat kunci indeks unik, dan cara termudah adalah mengembangkannya dengan bidang unik yang sengaja dibuat, yang cocok untuk PK:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">events</span>(ts <span class="hljs-keyword">DESC</span>, <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan permintaan bermutasi:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ...<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  ts <span class="hljs-keyword">DESC</span>, <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">26</span> <span class="hljs-keyword">OFFSET</span> $<span class="hljs-number">1</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">Transisi ke "kursor"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa waktu kemudian, DBA mendatangi Anda dan “senang” bahwa permintaan Anda sedang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membebani server dengan OFFSET yang ditarik kuda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan secara umum, saatnya untuk beralih ke </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">navigasi dari nilai terakhir yang ditunjukkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Permintaan Anda bermutasi lagi:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ...<font></font>
<span class="hljs-keyword">WHERE</span>
  (ts, <span class="hljs-keyword">id</span>) &lt; ($<span class="hljs-number">1</span>, $<span class="hljs-number">2</span>) <span class="hljs-comment">--      </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  ts <span class="hljs-keyword">DESC</span>, <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">26</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda menghela napas lega sebelum itu datang ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3 </font><font style="vertical-align: inherit;">Pembersihan indeks</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena suatu hari DBA Anda membaca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel tentang menemukan indeks yang tidak efisien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan menyadari bahwa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cap waktu "terakhir" tidak baik</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dan dia mendatangi Anda lagi - sekarang dengan pemikiran bahwa indeks ini akan berubah menjadi </font></font><code>(ts DESC)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi apa yang harus dilakukan dengan masalah awal "melompat" catatan antara halaman? .. Dan semuanya sederhana - Anda harus memilih blok dengan jumlah catatan yang tidak terbatas! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, siapa yang melarang kita membaca bukan “tepat 26”, tetapi “tidak kurang dari 26”? </font><font style="vertical-align: inherit;">Misalnya, sehingga di blok berikutnya ada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catatan dengan nilai yang jelas berbeda</font></font><code>ts</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - maka tidak akan ada masalah dengan "melompat" di antara blok! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inilah cara melakukannya:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ...<font></font>
<span class="hljs-keyword">WHERE</span>
  ts &lt; $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span>
  ts &gt;= <span class="hljs-keyword">coalesce</span>((
    <span class="hljs-keyword">SELECT</span><font></font>
      ts<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">events</span>
    <span class="hljs-keyword">WHERE</span>
      ts &lt; $<span class="hljs-number">1</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
      ts <span class="hljs-keyword">DESC</span>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">OFFSET</span> <span class="hljs-number">25</span>
  ), <span class="hljs-string">'-infinity'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  ts <span class="hljs-keyword">DESC</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang terjadi disini?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mundur 25 catatan dan mendapatkan nilai "batas" </font></font><code>ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika tidak ada apa-apa di sana, ganti nilai NULL dengan </font></font><code>-infinity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangi seluruh segmen nilai antara nilai yang diterima </font></font><code>ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan parameter $ 1 yang dilewatkan dari antarmuka (nilai yang ditarik sebelumnya "terakhir").</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika satu blok dikembalikan dengan kurang dari 26 entri, itu adalah yang terakhir.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atau gambar yang sama:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/37/y3/ep37y34-saszrynp8jujarqyrzq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena sekarang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sampel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami </font><b><font style="vertical-align: inherit;">tidak memiliki "permulaan" yang pasti</font></b><font style="vertical-align: inherit;"> , tidak ada yang mencegah kami dari "membalikkan" permintaan ini di arah yang berlawanan dan menerapkan pemuatan dinamis blok data dari "titik referensi" di kedua arah - baik turun dan naik.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Komentar</font></font></h4><br>
<ol>
<li>,        ,   «  ».       <b>   Index Only Scan</b>.</li>
<li> ,     ,      <code>ts</code>    ,  <b> </b>.      — «   00:00:00.000»,    .  ,     .     ,     .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498724/index.html">Cara menjaga kesehatan mata: panduan untuk programmer</a></li>
<li><a href="../id498726/index.html">Bagaimana cara belajar Ilmu Data dan Intelijen Bisnis secara gratis? Bicara pada Hari Open House di Ozon Masters</a></li>
<li><a href="../id498730/index.html">Kesalahan dalam mendesain antarmuka VR, VR untuk desainer antarmuka</a></li>
<li><a href="../id498732/index.html">Jika bahasa pemrograman bisa menceritakan tentang diri mereka sendiri</a></li>
<li><a href="../id498738/index.html">Membuat mini PC di Ryzen APU atau komputer pengemudi truk</a></li>
<li><a href="../id498746/index.html">Upah industri 3D turun</a></li>
<li><a href="../id498750/index.html">Posisi win-win: meningkatkan pengalaman pengguna dan membuat bisnis online lebih bahagia</a></li>
<li><a href="../id498754/index.html">Adalah baik bahwa pencipta instrumen favorit Anda tidak mendengarkan keledai ketika ia menemukan sepeda</a></li>
<li><a href="../id498758/index.html">Benda aneh Oumuamua mungkin adalah sebuah fragmen dari planet mati</a></li>
<li><a href="../id498760/index.html">Kursus pendidikan karantina gratis: bisnis, manajemen, pemasaran</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>