<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤲🏾 ⏪ 🍫 STM32のインターフェイスソフトウェアコントローラー 🗡️ 📷 🎹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="下位互換性の問題は常にある可能性があります。
 
 エレクトロニクス開発の分野では、30年前（時にはそれより古い）のデバイスをサポートする必要がある場合があります。
 
 このようなデバイスでは、すべてのものがプログラマブルエレメントなしでロジック上に組み立てられることがあります。
 さらに、古いテ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32のインターフェイスソフトウェアコントローラー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491434/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下位互換性の問題は常にある可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エレクトロニクス開発の分野では、30年前（時にはそれより古い）のデバイスをサポートする必要がある場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなデバイスでは、すべてのものがプログラマブルエレメントなしでロジック上に組み立てられることがあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、古いテクノロジーには、市販のコントローラーでは実装されない独自のインターフェースがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような場合、互換性のあるコントローラーをCPLD \ FPGA \ ASICに実装する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のツールがなくても、STM32F4シリーズのマイクロコントローラーにインターフェイスコントローラーをプログラムで実装できると思います。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主なアイデアは、TIM + DMA + GPIOバンドルを使用することです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイマーは目的の周波数に調整し、DMAの要求を生成します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイマー要求時のDMAは、メモリからGPIOレジスタにデータを転送します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その結果、必要な値が必要な周波数でGPIOラインに設定されます</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32の制限：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMA2のみがGPIOレジスタにアクセスでき、TIM1とTIM8のみがDMA2へのリクエストを生成できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリからペリフェラルレジスタへの、またはその逆のDMAトランザクションには、約10〜12バスサイクルかかります（アプリケーションノートAN4031で説明されている一連の条件によって異なります）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、このソリューションの最大値は、周波数が12〜14 MHzの16ラインです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイデアの実現可能性をテストするために、MIL-STD 1573インターフェイス（MCOとして知られている）が選択されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェイスは、マンチェスター2コードの差動ペアです。各ビット（1μsを占める）の場合、信号は0から1またはその逆に遷移します。つまり、2レベルです（ビット値は信号レベルではなく、その差の方向によって決まります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データは、16ビットワード+ 1パリティビット+ 3ビットのクロック信号（異なるレベルでは1.5 + 1.5ビット）で送信され、合計20μsです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロック周波数は2 MHzであり、理論上の有効帯域幅は1 Mbps（約0.8）よりわずかに小さいです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hv/nu/ja/hvnujauwagmc-0xcnz8bntzrruu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、これはマスタースレーブバスであり、交換のイニシエーターは常にマスターであり、デバイスの応答時間の要件は約数マイクロ秒です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
交換は、常に「要求-応答」の意味。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下、明確にするために、交換のオシログラムは、バイポーラ±15ボルトの電源を有する国内MCOコントローラを有する装置と、得られたソフトウェア・コントローラとの間に示されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはパケットマスターによる要求であり、この要求に対するスレーブの応答（パケットの最初のワードと2番目のワードのクロック信号のみ、その後にさらに30ワードが続く）が表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/w_/8u/duw_8ufrhblvyjwpmsieidwvfvu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見られるように、電圧レベルが2（CCITTに積層された2つ）の略因子によって異なるが時間</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ信号特性にE。デバイスは互いに正常に「理解」します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
物理インターフェイスを実装しているため、リアルタイムの要件は非常に厳しくなっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割り込み内で非常に迅速に多くのことを行う必要があります（数マイクロ秒以下、つまり最大1000クロックサイクル）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、物理インターフェイスに関連する割り込みは、最高の優先度を持ち、他のすべてのものを横取りする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期とキャリブレーションのメカニズムを実装する必要があります（初期段階）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は次の構成を選択しました：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信：TIM1（2 MHz）+ DMA2_Stream5_DMA_CHANNEL_6 + GPIOD-&gt; ODR（PD0-差動ペアの直接信号; PD1-反転（1つの出力+インバーターで実行できます））。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリ内の配列はMCOプロトコルに従って満たされ、次にタイマー+ DMAが開始され、メモリから配列（各1バイト）がGPIOレッグに送信されます。最後に、0がさらに膨らんでラインを押しつぶします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信：TIM8（1 MHz）+ DMA2_Stream1_DMA_CHANNEL_7 + GPIOB-&gt; IDR（PB6は差動ペアの直接信号です。反転入力はまったく使用されません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPIOフットでは、割り込みが入力レベルを変更するように構成されています（これは、誰かがチャネルで何かを送信し始めたことを意味します。これは、リスニングを開始する時です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割り込みがトリガーされると、タイマーが起動し、DMA（MCOで可能な最大パケット長に対して）が開始されます。これにより、足からGPIOレベル（各1バイト）がメモリ内の配列に収集されます。配列は後で解析されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信用に、補助タイマーTIM2も導入されています（1/20 MHz-CIEの1ワードの期間に対応）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、チャネルから受信した最初のワードを処理するために使用されます（これにより、受信を停止して送信に進むか、それともパケットを受け入れるかが決定されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のワードを分析した後、受信が続く場合、同じタイマーは、最初の受信ワードで示された数のワードを受信した後、+ DMAタイマーを停止します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、このタイマーがトリガーされた後、応答ワード（または応答パケット全体）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
が引き出されます。データを受信して​​+ DMAタイマーを停止した後、packet_received_lengthが設定されます。これは、受信データがあり、解析して最上位に送信する必要があることを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信中、受信はオフになります（レッグトラップの中断は無効になります）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーキテクチャを大まかに見積もったので、実装を取り上げました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はGPIOレジスタを1バイトで操作し、1ビットまたは2ビットの有用なレジスタがあるため、有用なデータをDMAを使用してGPIOに転送するデータに変換できるようにする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、MCOのワード形式を簡単に操作するためにいくつかのマクロが必要でした。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_RX_GPIO_OFFSET  6 <span class="hljs-comment">//PB6</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_RX_1  (long long)(1 &lt;&lt; MKO_RX_GPIO_OFFSET)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_RX_BYTE_MASK  ((MKO_RX_1 &lt;&lt; 56) + (MKO_RX_1 &lt;&lt; 48) + (MKO_RX_1 &lt;&lt; 40) + (MKO_RX_1 &lt;&lt; 32) + (MKO_RX_1 &lt;&lt; 24) + (MKO_RX_1 &lt;&lt; 16) + (MKO_RX_1 &lt;&lt; 8) + MKO_RX_1)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_LOW   (long long)(2)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_HIGH  (long long)(1)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_0 ((MKO_HIGH &lt;&lt; 8) + MKO_LOW)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_1 ((MKO_LOW &lt;&lt; 8) + MKO_HIGH)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_0x0 ((MKO_0 &lt;&lt; 48) + (MKO_0 &lt;&lt; 32) + (MKO_0 &lt;&lt; 16) + MKO_0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_0x1 ((MKO_1 &lt;&lt; 48) + (MKO_0 &lt;&lt; 32) + (MKO_0 &lt;&lt; 16) + MKO_0)</span><font></font>
.<font></font>
.<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MKO_0xF ((MKO_1 &lt;&lt; 48) + (MKO_1 &lt;&lt; 32) + (MKO_1 &lt;&lt; 16) + MKO_1)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CMD_ACK_WORD  ((MKO_LOW &lt;&lt; 56) + (MKO_LOW &lt;&lt; 48) + (MKO_LOW &lt;&lt; 40) + (MKO_HIGH &lt;&lt; 32) + (MKO_HIGH &lt;&lt; 24) + (MKO_HIGH &lt;&lt; 16))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DATA_WORD     ((MKO_HIGH &lt;&lt; 56) + (MKO_HIGH &lt;&lt; 48) + (MKO_HIGH &lt;&lt; 40) + (MKO_LOW &lt;&lt; 32) + (MKO_LOW &lt;&lt; 24) + (MKO_LOW &lt;&lt; 16))</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> mko_tetrades[<span class="hljs-number">16</span>] = {MKO_0x0, MKO_0x1, MKO_0x2, MKO_0x3, MKO_0x4, MKO_0x5, MKO_0x6, MKO_0x7, MKO_0x8, MKO_0x9, MKO_0xA, MKO_0xB, MKO_0xC, MKO_0xD, MKO_0xE, MKO_0xF};
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データのパック/アンパックの機能も必要でした：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">short_to_mko</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> start_pos, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> command_word, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> input_data)</span>
</span>{
  <span class="hljs-keyword">if</span> (command_word)<font></font>
    *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)&amp;data[start_pos] |= CMD_ACK_WORD;
  <span class="hljs-keyword">else</span>
    *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>*)&amp;data[start_pos] |= DATA_WORD;<font></font>
<font></font>
  *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos +  <span class="hljs-number">8</span>] = mko_tetrades[(input_data &gt;&gt; <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0xf</span>];<font></font>
  *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos + <span class="hljs-number">16</span>] = mko_tetrades[(input_data &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xf</span>];<font></font>
  *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos + <span class="hljs-number">24</span>] = mko_tetrades[(input_data &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0xf</span>];<font></font>
  *(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos + <span class="hljs-number">32</span>] = mko_tetrades[(input_data &gt;&gt; <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xf</span>];<font></font>
<font></font>
  input_data -= (input_data &gt;&gt; <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0x5555</span>;<font></font>
  input_data = ((input_data &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0x3333</span>) + (input_data &amp; <span class="hljs-number">0x3333</span>);<font></font>
  input_data = ((input_data &gt;&gt; <span class="hljs-number">4</span>) + input_data) &amp; <span class="hljs-number">0x0f0f</span>;<font></font>
  input_data = ((input_data &gt;&gt; <span class="hljs-number">8</span>) + input_data) &amp; <span class="hljs-number">0x00ff</span>;<font></font>
    <font></font>
  <span class="hljs-keyword">if</span> (input_data &amp; <span class="hljs-number">1</span>)<font></font>
    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>*)&amp;data[start_pos + <span class="hljs-number">40</span>] = MKO_0;
  <span class="hljs-keyword">else</span>
    *(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>*)&amp;data[start_pos + <span class="hljs-number">40</span>] = MKO_1;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">mko_to_short</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* data, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> start_pos)</span>
</span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> output_data;
  <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> byte;
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> crc;<font></font>
  <font></font>
  byte = (*(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos]) &amp; MKO_RX_BYTE_MASK;<font></font>
  output_data = MKO_RX_BYTE_PACK(byte);<font></font>
  output_data &lt;&lt;= <span class="hljs-number">8</span>;<font></font>
  byte = (*(<span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> *)&amp;data[start_pos + <span class="hljs-number">8</span>]) &amp; MKO_RX_BYTE_MASK;<font></font>
  output_data |= MKO_RX_BYTE_PACK(byte) &amp; <span class="hljs-number">0xff</span>;<font></font>
  crc = output_data &amp; <span class="hljs-number">0xffff</span>;<font></font>
  <font></font>
  crc -= (crc &gt;&gt; <span class="hljs-number">1</span>) &amp; <span class="hljs-number">0x5555</span>;<font></font>
  crc = ((crc &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0x3333</span>) + (crc &amp; <span class="hljs-number">0x3333</span>);<font></font>
  crc = ((crc &gt;&gt; <span class="hljs-number">4</span>) + crc) &amp; <span class="hljs-number">0x0f0f</span>;<font></font>
  crc = ((crc &gt;&gt; <span class="hljs-number">8</span>) + crc) &amp; <span class="hljs-number">0x00ff</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> ((crc &amp; <span class="hljs-number">1</span>) == (data[start_pos + <span class="hljs-number">16</span>] &gt;&gt; MKO_RX_GPIO_OFFSET))<font></font>
    packet_error = <span class="hljs-number">1</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">return</span> output_data &amp; <span class="hljs-number">0xffff</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、コントローラー部分に直接アクセスできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信信号の前面のキャッチャー、受信DMAおよびTIM2タイマーの充電（補助、受信量を決定するため）</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mko_start_receive</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i;<font></font>
  <font></font>
  (EXTI-&gt;IMR) &amp;= (~RX_START_INT);<span class="hljs-comment">//  ( ,    (   )</span><font></font>
      <font></font>
  <span class="hljs-comment">// DMA      (  -        TIM2)</span>
  htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;NDTR = <span class="hljs-number">660</span>;<font></font>
  htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;CR |= DMA_IT_TC;<font></font>
  htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;CR |= DMA_SxCR_EN;<font></font>
<font></font>
  i = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">while</span>(i--);<span class="hljs-comment">//  DMA    1  ( 1.5 )</span><font></font>
<font></font>
  TIM8-&gt;CNT = <span class="hljs-number">80</span>;<span class="hljs-comment">// (  )  DMA (   -   250  ( ))</span><font></font>
<font></font>
  __HAL_TIM_ENABLE_DMA(&amp;htim8, TIM_DMA_UPDATE);<font></font>
  __HAL_TIM_ENABLE(&amp;htim8);<font></font>
   <font></font>
  TIM2-&gt;SR = <span class="hljs-number">0</span>;<span class="hljs-comment">//       </span>
  TIM2-&gt;ARR = <span class="hljs-number">1400</span> - <span class="hljs-number">1</span>;<span class="hljs-comment">//   20  (1 ) (     ,   )</span>
  TIM2-&gt;CNT = <span class="hljs-number">0</span>;<font></font>
  HAL_TIM_Base_Start_IT(&amp;htim2);<span class="hljs-comment">//  20  (1 )</span><font></font>
  <font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_GPIO_EXTI_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> GPIO_Pin)</span>
</span>{  
  <span class="hljs-comment">/* EXTI line interrupt detected */</span>
  <span class="hljs-keyword">if</span>(__HAL_GPIO_EXTI_GET_IT(GPIO_Pin) != RESET)<font></font>
  {<font></font>
    __HAL_GPIO_EXTI_CLEAR_IT(GPIO_Pin);<font></font>
    <font></font>
    <span class="hljs-keyword">if</span> ((GPIO_Pin == GPIO_PIN_6) &amp;&amp; ((GPIOB-&gt;IDR) &amp; GPIO_PIN_6))<font></font>
      mko_start_receive();<font></font>
<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のピン状態チェックがアンチバウンスとして追加されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マジック定数-受信タイマー+ DMAのキャリブレーション結果（詳細は以下を参照）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、最終的なGPIOアドレス（現在はGPIOBとGPIOD）の設定を含む、送受信DMAを開始および構成する関数</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">HAL_StatusTypeDef <span class="hljs-title">HAL_TIM_Base_Start_DMA</span><span class="hljs-params">(TIM_HandleTypeDef *htim, <span class="hljs-keyword">uint32_t</span> *pData, <span class="hljs-keyword">uint16_t</span> Length)</span>
</span>{<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>((htim-&gt;State == HAL_TIM_STATE_BUSY))
     <span class="hljs-keyword">return</span> HAL_BUSY;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((htim-&gt;State == HAL_TIM_STATE_READY))<font></font>
  {<font></font>
    <span class="hljs-keyword">if</span>((pData == <span class="hljs-number">0U</span>) &amp;&amp; (Length &gt; <span class="hljs-number">0U</span>)) 
      <span class="hljs-keyword">return</span> HAL_ERROR;                                    
    <span class="hljs-keyword">else</span><font></font>
      htim-&gt;State = HAL_TIM_STATE_BUSY;<font></font>
  }  <font></font>
<font></font>
  htim-&gt;hdma[TIM_DMA_ID_UPDATE]-&gt;XferCpltCallback = TIM_DMAPeriodElapsedCplt;<font></font>
  htim-&gt;hdma[TIM_DMA_ID_UPDATE]-&gt;XferErrorCallback = TIM_DMAError ;<font></font>
<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (htim-&gt;Instance == TIM1)<font></font>
    HAL_DMA_Start_IT(htim-&gt;hdma[TIM_DMA_ID_UPDATE], (<span class="hljs-keyword">uint32_t</span>)pData, (<span class="hljs-keyword">uint32_t</span>)&amp;(GPIOD-&gt;ODR), Length);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (htim-&gt;Instance == TIM8)<font></font>
  {<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> RX_CALIB</span>
    HAL_DMA_Start_IT(htim-&gt;hdma[TIM_DMA_ID_UPDATE], (<span class="hljs-keyword">uint32_t</span>)pData, (<span class="hljs-keyword">uint32_t</span>)&amp;(GPIOB-&gt;ODR), Length);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    HAL_DMA_Start_IT(htim-&gt;hdma[TIM_DMA_ID_UPDATE], (<span class="hljs-keyword">uint32_t</span>)&amp;(GPIOB-&gt;IDR), (<span class="hljs-keyword">uint32_t</span>)pData, Length);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  }<font></font>
    <font></font>
  __HAL_TIM_ENABLE_DMA(htim, TIM_DMA_UPDATE);<font></font>
  __HAL_TIM_ENABLE(htim);  <font></font>
  <span class="hljs-keyword">return</span> HAL_OK;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RX_CALIBマクロを開始して、受信タイマー+ DMAを調整しました。つまり、サンプルが入力信号のどこにあるかを確認しました（理想的には、ビットの中央にあるはずです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでICEのメインロジック：採用された最初の単語の分析、次に残りを受け取るための回答または課金。</font><font style="vertical-align: inherit;">残りを受け取り、packet_received_lengthを設定した後の答え</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mko_slave_receive</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">register</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> data;
  <span class="hljs-keyword">register</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> first = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> mko_data_length;<font></font>
  <font></font>
  data = mko_to_short(&amp;in_arr[<span class="hljs-number">0</span>] ,<span class="hljs-number">0</span>);<font></font>
    <font></font>
  <span class="hljs-keyword">if</span> (first)<span class="hljs-comment">//     -      ,   </span><font></font>
  {<font></font>
    <span class="hljs-keyword">if</span> (!packet_error)<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> (data &amp; MASTER_DATA_REQUEST)<span class="hljs-comment">//    </span><font></font>
      {<font></font>
        first = <span class="hljs-number">1</span>;<font></font>
        HAL_TIM_Base_Stop_IT(&amp;htim2);<font></font>
        HAL_TIM_Base_Stop_DMA(&amp;htim8);<font></font>
        htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;CR &amp;= ~DMA_SxCR_EN;      <font></font>
            <font></font>
        mko_send((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)&amp;out_arr[i][<span class="hljs-number">0</span>], out_array_data_length[i]);<span class="hljs-comment">// ,    DMA,      </span><font></font>
        <font></font>
        <span class="hljs-built_in">memcpy</span>(in_arr_copy, in_arr, IN_ARRAY_LENGTH);
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> RX_CALIB <span class="hljs-comment">//   in_arr,      </span></span>
        <span class="hljs-built_in">memset</span>(in_arr, <span class="hljs-number">0</span>, IN_ARRAY_LENGTH);<span class="hljs-comment">//   4 ,   </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
        <font></font>
        packet_received_length = <span class="hljs-number">1</span>;<font></font>
        <font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><span class="hljs-comment">//  ,      </span><font></font>
      {<font></font>
        first = <span class="hljs-number">0</span>;<font></font>
        data = data &amp; <span class="hljs-number">0x1F</span>;
        <span class="hljs-keyword">if</span> (!data)<font></font>
          data = <span class="hljs-number">32</span>;<font></font>
        TIM2-&gt;ARR = (data * <span class="hljs-number">1680</span>) - <span class="hljs-number">1</span>;<font></font>
        mko_data_length = data;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
      packet_received_length = <span class="hljs-number">1</span>;<span class="hljs-comment">//,        </span><font></font>
      HAL_TIM_Base_Stop_IT(&amp;htim2);<font></font>
      HAL_TIM_Base_Stop_DMA(&amp;htim8);<font></font>
      htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;CR &amp;= ~DMA_SxCR_EN;<font></font>
      EXTI-&gt;IMR |= RX_START_INT;<span class="hljs-comment">//enable interrupt -  </span><font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><span class="hljs-comment">//   -    ,        (  packet_received_length)</span><font></font>
  {<font></font>
    first = <span class="hljs-number">1</span>;<font></font>
    HAL_TIM_Base_Stop_IT(&amp;htim2);<font></font>
    HAL_TIM_Base_Stop_DMA(&amp;htim8);<font></font>
    htim8.hdma[TIM_DMA_ID_UPDATE]-&gt;Instance-&gt;CR &amp;= ~DMA_SxCR_EN;   <font></font>
            <font></font>
    mko_send((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>*)&amp;out_arr[i][<span class="hljs-number">0</span>], out_array_data_length[i]);<span class="hljs-comment">// ,    DMA,      </span><font></font>
    <font></font>
    <span class="hljs-built_in">memcpy</span>(in_arr_copy, in_arr, IN_ARRAY_LENGTH);
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> RX_CALIB <span class="hljs-comment">//   in_arr,      </span></span>
    <span class="hljs-built_in">memset</span>(in_arr, <span class="hljs-number">0</span>, IN_ARRAY_LENGTH);<span class="hljs-comment">//   4 ,   </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
      <font></font>
    packet_received_length = mko_data_length;<font></font>
    <font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM2_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">if</span> (interface == INTERFACE_MKO_SLAVE)<span class="hljs-comment">//       -   (  )</span><font></font>
    mko_slave_receive();<font></font>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interface == INTERFACE_MKO_MASTER)<span class="hljs-comment">//       -   (  )</span><font></font>
    mko_master_receive();<font></font>
  <font></font>
  TIM2-&gt;SR = ~(TIM_IT_UPDATE);<font></font>
  HAL_NVIC_ClearPendingIRQ(TIM2_IRQn);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは圧縮された形式で提供されます。プロジェクト全体は、多数の追加機能を備えたMKO-Ethernetコンバーターです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、上記の説明とコードはアイデアの本質を理解するには十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、最小限のロジックを実装しました。GOSTでは、MCOにより多くの情報が記述されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、特定のデバイスとの下位互換性については、これで十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、プロジェクトは非常に成功し、コントローラーはマスターモードとスレーブモードの両方で割り当てられた機能に完全に対応しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全体として、古くて標準的でないものとの互換性を確保したい場合は、ダクトを使用する必要はありません。</font><font style="vertical-align: inherit;">かなりの数のケースで、コントローラーのソフトウェア実装で十分です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja491422/index.html">ボランティアだけが一歩前進です</a></li>
<li><a href="../ja491426/index.html">C ++の世界でのJinja2、パート3。「今、あなたはコナンにいます」</a></li>
<li><a href="../ja491428/index.html">スラムアジャイル。責任、開放性、勇気、尊敬の3日間</a></li>
<li><a href="../ja491430/index.html">ITのソフトスキルを開発するための3つの作業フレームワーク</a></li>
<li><a href="../ja491432/index.html">ウイルスと衛生：ロジックをオンにする</a></li>
<li><a href="../ja491438/index.html">記憶メカニズムが解明されました：何かを思い出そうとすると、記憶シーケンスで脳ニューロンが活性化されます</a></li>
<li><a href="../ja491440/index.html">「すべての行を説明」-ライブビデオゲーム開発</a></li>
<li><a href="../ja491442/index.html">フードデザインダイジェスト、2020年2月</a></li>
<li><a href="../ja491444/index.html">Azure DevOpsパイプラインでの変数の使用</a></li>
<li><a href="../ja491446/index.html">RedBullを「ハッキング」する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>