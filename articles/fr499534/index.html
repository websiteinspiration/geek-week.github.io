<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüç≥ üôèüèº üê• Guide de d√©veloppement du service backend Python üò© ‚õπüèΩ üèáüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, je m'appelle Alexander Vasin, je suis d√©veloppeur backend √† Edadil. L'id√©e de ce mat√©riel a commenc√© avec le fait que je voulais analyser le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guide de d√©veloppement du service backend Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, je m'appelle Alexander Vasin, je suis d√©veloppeur backend √† Edadil. L'id√©e de ce mat√©riel a commenc√© avec le fait que je voulais analyser le travail d'introduction ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dans l'√©cole de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">d√©veloppement</font></a><font style="vertical-align: inherit;"> Yandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Backend</font></a><font style="vertical-align: inherit;"> . J'ai commenc√© √† d√©crire toutes les subtilit√©s du choix de certaines technologies, la m√©thodologie de test ... Il s'est av√©r√© ne pas √™tre du tout une analyse, mais un guide tr√®s d√©taill√© sur la fa√ßon d'√©crire des backends en Python. De l'id√©e initiale, il n'y avait que des exigences pour le service, sur l'exemple duquel il est pratique de d√©monter les outils et les technologies. En cons√©quence, je me suis r√©veill√© sur cent mille caract√®res. Il fallait tellement de choses pour tout examiner en d√©tail. Ainsi, le programme pour les 100 prochains kilo-octets: comment construire un backend de service, du choix des outils au d√©ploiement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voici </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un repr√©sentant GitHub avec application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et qui aime les (vrais) longs livres - s'il vous pla√Æt, sous cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons d√©velopper et tester le service API REST en Python, le placer dans un conteneur Docker l√©ger et le d√©ployer √† l'aide d'Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez impl√©menter le service API REST de diff√©rentes mani√®res √† l'aide de diff√©rents outils. </font><font style="vertical-align: inherit;">La solution d√©crite n'est pas la seule bonne, j'ai choisi la mise en ≈ìuvre et les outils en fonction de mon exp√©rience et de mes pr√©f√©rences personnelles.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'on fait?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels outils choisir?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©veloppement</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi avez-vous besoin de commencer avec setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment sp√©cifier des versions de d√©pendances?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de donn√©es</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous concevons le sch√©ma</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©crire le sch√©ma dans SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personnaliser Alembic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous g√©n√©rons des migrations</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©rialisation des donn√©es</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembl√©e</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test de r√©sistance</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que peut-on faire d'autre?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalement</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'on fait?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez qu'une boutique de cadeaux en ligne pr√©voit de lancer une action dans diff√©rentes r√©gions. </font><font style="vertical-align: inherit;">Pour qu'une strat√©gie de vente soit efficace, une analyse de march√© est n√©cessaire. </font><font style="vertical-align: inherit;">Le magasin a un fournisseur qui envoie r√©guli√®rement (par exemple, par courrier) le d√©chargement des donn√©es avec des informations sur les r√©sidents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©veloppons un service d'API REST Python qui analysera les donn√©es fournies et identifiera la demande de cadeaux de r√©sidents de diff√©rents groupes d'√¢ge dans diff√©rentes villes par mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous impl√©mentons les gestionnaires suivants dans le service:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoute un nouveau t√©l√©chargement avec des donn√©es;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Renvoie les r√©sidents de la sortie sp√©cifi√©e;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifie les informations sur le r√©sident (et ses proches) dans le d√©chargement sp√©cifi√©;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©crivons donc un service en Python en utilisant des frameworks, des biblioth√®ques et des SGBD familiers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 conf√©rences du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cours vid√©o, divers SGBD et leurs fonctionnalit√©s sont d√©crits. Pour ma mise en ≈ìuvre, j'ai choisi le SGBD </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'est impos√© comme une solution fiable avec une excellente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation en russe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une forte communaut√© russe (vous pouvez toujours trouver la r√©ponse √† une question en russe), et m√™me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des cours gratuits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le mod√®le relationnel est assez polyvalent et bien compris par de nombreux d√©veloppeurs. Bien que la m√™me chose puisse √™tre faite sur n'importe quel SGBD NoSQL, dans cet article, nous consid√©rerons PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal du service - la transmission de donn√©es sur le r√©seau entre la base de donn√©es et les clients - n'implique pas une charge importante sur le processeur, mais n√©cessite la capacit√© de traiter plusieurs demandes √† la fois. Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 conf√©rences</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consid√©r√©es comme une approche asynchrone. Il vous permet de servir efficacement plusieurs clients dans le m√™me processus de syst√®me d'exploitation (contrairement, par exemple, au mod√®le de pr√©-fork utilis√© dans Flask / Django, qui cr√©e plusieurs processus pour traiter les demandes des utilisateurs, chacun consomme de la m√©moire, mais est inactif la plupart du temps ) Par cons√©quent, en tant que biblioth√®que pour l'√©criture du service, j'ai choisi l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asynchrone </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
La </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">5e conf√©rence du</font></a><font style="vertical-align: inherit;"> cours vid√©o raconte que </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de d√©composer des requ√™tes complexes en parties, de les r√©utiliser, de g√©n√©rer des requ√™tes avec un ensemble dynamique de champs (par exemple, le processeur PATCH permet la mise √† jour partielle d'un r√©sident avec des champs arbitraires) et de se concentrer directement sur la logique m√©tier. Le pilote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg peut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©rer ces demandes et transf√©rer les donn√©es le plus rapidement possible </font><font style="vertical-align: inherit;">, et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les aidera √† se faire des amis </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon outil pr√©f√©r√© pour g√©rer l'√©tat de la base de donn√©es et travailler avec les migrations est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Au fait, j'en ai r√©cemment parl√© √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscou Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La logique de validation a √©t√© succinctement d√©crite par les programmes de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guimauve</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y compris les v√©rifications des liens familiaux). Utilisation du module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai li√© des gestionnaires et des sch√©mas aiohttp pour la validation des donn√©es, et le bonus √©tait de g√©n√©rer de la documentation au format </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de l'afficher dans une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface graphique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les tests d'√©criture, j'ai choisi </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, plus √† ce sujet en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 conf√©rences</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©boguer et profiler ce projet, j'ai utilis√© le d√©bogueur PyCharm ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cours 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7, la conf√©rence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©crit comment n'importe quel ordinateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou m√™me sur un syst√®me d'exploitation diff√©rent) peut fonctionner en mode pack sans avoir √† ajuster l'environnement d'application pour d√©marrer et facile √† installer / mettre √† jour / supprimer l'application sur le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le d√©ploiement, j'ai choisi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il vous permet de d√©crire de mani√®re d√©clarative l'√©tat souhait√© du serveur et de ses services, fonctionne via ssh et ne n√©cessite pas de logiciel sp√©cial.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©veloppement</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© de donner un nom au package Python </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et d'utiliser la structure suivante: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le fichier, </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai post√© des informations g√©n√©rales sur le package: description ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docstring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), version, licence, contacts d√©veloppeur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il peut √™tre consult√© avec l'aide int√©gr√©e</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le package a deux points d'entr√©e - le service API REST ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et l'utilitaire de gestion d'√©tat de la base de donn√©es ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Les fichiers sont appel√©s </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour une raison - tout d'abord, un tel nom attire l'attention, il indique clairement que le fichier est un point d'entr√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement, gr√¢ce √† cette approche des points d'entr√©e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi avez-vous besoin de commencer avec setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'avenir, nous r√©fl√©chirons √† la fa√ßon de distribuer l'application: elle peut √™tre emball√©e dans une archive zip (ainsi que wheel / egg-), un package rpm, un fichier pkg pour macOS et install√© sur un ordinateur distant, une machine virtuelle, MacBook ou Docker- r√©cipient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal du fichier </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est de d√©crire le package avec l'application pour </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Le fichier doit contenir des informations g√©n√©rales sur le package (nom, version, auteur, etc.), mais vous pouvez √©galement y sp√©cifier les modules requis pour le travail, les d√©pendances ¬´suppl√©mentaires¬ª (par exemple, pour les tests), les points d'entr√©e (par exemple, les commandes ex√©cutables ) et les exigences de l'interpr√®te. </font><font style="vertical-align: inherit;">
Les plugins Setuptools vous permettent de collecter des artefacts √† partir du package d√©crit. Il existe des plugins int√©gr√©s: zip, egg, rpm, paquet macOS. Les plugins restants sont distribu√©s via PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">wheel</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fin de compte, en d√©crivant un fichier, nous obtenons de grandes opportunit√©s. </font><font style="vertical-align: inherit;">C'est pourquoi le d√©veloppement d'un nouveau projet doit commencer </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction, </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les modules d√©pendants sont indiqu√©s par une liste:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais j'ai d√©crit les d√©pendances dans des fichiers s√©par√©s </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont le contenu est utilis√© dans </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il me semble plus flexible, en plus il y a un secret: plus tard, il vous permettra de construire une image Docker plus rapidement. </font><font style="vertical-align: inherit;">Les d√©pendances seront d√©finies en tant qu'√©tape distincte avant d'installer l'application elle-m√™me et lors de la reconstruction du conteneur Docker, il se trouve dans le cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvoir lire les d√©pendances des fichiers </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la fonction s'√©crit:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est int√©ressant de </font><font style="vertical-align: inherit;">noter que </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lorsque la distribution des sources d'assemblage par d√©faut inclut uniquement les fichiers d'assemblage </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour un fichier de d√©pendance </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frapper le sac, ils doivent √™tre clairement sp√©cifi√©s dans le fichier </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py enti√®rement</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez installer le projet en mode d√©veloppement √† l'aide de la commande suivante (en mode √©ditable, Python n'installera pas le package entier dans un dossier </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais cr√©era uniquement des liens, donc toutes les modifications apport√©es aux fichiers du package seront imm√©diatement visibles):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment sp√©cifier des versions de d√©pendances?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est formidable lorsque les d√©veloppeurs travaillent activement sur leurs packages - les bogues y sont activement corrig√©s, de nouvelles fonctionnalit√©s apparaissent et les commentaires peuvent √™tre obtenus plus rapidement. Mais parfois, les changements dans les biblioth√®ques d√©pendantes ne sont pas r√©trocompatibles et peuvent entra√Æner des erreurs dans votre application si vous n'y pensez pas au pr√©alable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, pour chaque package d√©pendant, vous pouvez sp√©cifier une version sp√©cifique </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, l'application sera garantie d'√™tre construite sp√©cifiquement avec les versions des biblioth√®ques d√©pendantes avec lesquelles elle a √©t√© test√©e. Mais cette approche a un inconv√©nient - si les d√©veloppeurs corrigent un bogue critique dans un package d√©pendant qui n'affecte pas la compatibilit√© descendante, ce correctif n'entrera pas dans l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une approche pour le contr√¥le de version </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version s√©mantique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui sugg√®re de soumettre la version au format </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - augmente lorsque des modifications incompatibles vers l'arri√®re sont ajout√©es;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Augmente lors de l'ajout de nouvelles fonctionnalit√©s avec prise en charge de la compatibilit√© descendante;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - augmente lors de l'ajout de corrections de bogues avec prise en charge de la compatibilit√© descendante.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si un paquet d√©pendant suit cette approche (dont les auteurs sont g√©n√©ralement signal√©s dans les fichiers README et Changelog), il suffit de fixer la valeur de </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de limiter la valeur minimale pour PATCH version: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle exigence peut √™tre impl√©ment√©e √† l'aide de l'op√©rateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, cela </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permettra √† PIP de s'installer pour la </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version 3.6.3, mais pas 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous sp√©cifiez l'intervalle des versions de d√©pendance, cela donnera un avantage suppl√©mentaire - il n'y aura pas de conflits de version entre les biblioth√®ques d√©pendantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous d√©veloppez une biblioth√®que qui n√©cessite un package de d√©pendance diff√©rent, autorisez-le non pas une version sp√©cifique, mais un intervalle. </font><font style="vertical-align: inherit;">Il sera alors beaucoup plus facile pour les utilisateurs de votre biblioth√®que de l'utiliser (tout d'un coup leur application n√©cessite le m√™me package de d√©pendance, mais d'une version diff√©rente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le versioning s√©mantique n'est qu'un accord entre les auteurs et les consommateurs de packages. </font><font style="vertical-align: inherit;">Cela ne garantit pas que les auteurs √©crivent du code sans bogues et ne peuvent pas faire d'erreur dans la nouvelle version de leur package.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de donn√©es</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous concevons le sch√©ma</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La description du gestionnaire POST / imports fournit un exemple de d√©chargement avec des informations sur les r√©sidents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de t√©l√©chargement</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re pens√©e a √©t√© de stocker toutes les informations sur le r√©sident dans une seule table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o√π la relation serait repr√©sent√©e par un champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forme d'une liste d'entiers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais cette m√©thode pr√©sente plusieurs inconv√©nients</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, j'ai d√©cid√© de rassembler toutes les donn√©es n√©cessaires au travail sous une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">troisi√®me forme normale</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et la structure suivante a √©t√© obtenue:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le tableau des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importations se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compose d'une colonne √† incr√©mentation automatique </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est n√©cessaire de cr√©er une v√©rification de cl√© √©trang√®re dans le tableau </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La table des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citoyens</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stocke </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des donn√©es scalaires</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le r√©sident (tous les champs sauf les informations sur les relations familiales). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une paire ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">est utilis√©e comme cl√© primaire </font><font style="vertical-align: inherit;">, garantissant l'unicit√© des r√©sidents </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le cadre </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une cl√© √©trang√®re </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">garantit que le champ </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient uniquement les d√©chargements existants.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette structure garantit l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int√©grit√© des donn√©es √† l'aide des outils PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , elle vous permet d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenir efficacement des r√©sidents avec des proches</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la base de donn√©es, mais est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soumise √† une condition</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de concurrence lors de la mise √† jour des informations sur les r√©sidents avec des requ√™tes comp√©titives (nous examinerons de plus pr√®s la mise en ≈ìuvre du gestionnaire PATCH).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©crire le sch√©ma dans SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chapitre 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai expliqu√© comment cr√©er des requ√™tes √† l'aide de SQLAlchemy, vous devez d√©crire le sch√©ma de la base de donn√©es √† l'aide d'objets sp√©ciaux: les tables sont d√©crites √† l'aide </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et li√©es √† un registre </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui stocke toutes les m√©ta-informations sur la base de donn√©es. Soit dit en passant, le registre </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut non seulement stocker les m√©ta-informations d√©crites en Python, mais √©galement repr√©senter l'√©tat r√©el de la base de donn√©es sous la forme d'objets SQLAlchemy. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fonctionnalit√© permet √©galement √† Alembic de comparer les conditions et de g√©n√©rer automatiquement un code de migration.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, chaque base de donn√©es a son propre sch√©ma de d√©nomination des contraintes par d√©faut. </font><font style="vertical-align: inherit;">Pour que vous ne perdiez pas de temps √† nommer de nouvelles contraintes ou √† rechercher / rappeler quelle contrainte vous √™tes sur le point de supprimer, SQLAlchemy sugg√®re d'utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mod√®les de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">d√©nomination pour les conventions de d√©nomination</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ils peuvent √™tre d√©finis dans le registre </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er un registre MetaData et lui passer des mod√®les de d√©nomination</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous sp√©cifiez des mod√®les de d√©nomination, Alembic les utilisera lors de la g√©n√©ration automatique des migrations et nommera toutes les contraintes en fonction d'eux. </font><font style="vertical-align: inherit;">√Ä l'avenir, le registre cr√©√© </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera n√©cessaire pour d√©crire les tables:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous d√©crivons le sch√©ma de base de donn√©es avec des objets SQLAlchemy</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personnaliser Alembic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le sch√©ma de la base de donn√©es est d√©crit, il est n√©cessaire de g√©n√©rer des migrations, mais pour cela, vous devez d'abord configurer Alembic, qui est √©galement abord√© au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chapitre 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour utiliser la commande </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous devez effectuer les √©tapes suivantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer le paquet: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize Alambic: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette commande cr√©era un fichier de configuration </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et un dossier </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec le contenu suivant:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Appel√© chaque fois que vous d√©marrez Alembic. </font><font style="vertical-align: inherit;">Se connecte au registre Alembic </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une description de l'√©tat souhait√© de la base de donn√©es et contient des instructions pour d√©marrer les migrations.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le mod√®le sur la base duquel les migrations sont g√©n√©r√©es.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le dossier dans lequel Alembic recherchera (et g√©n√©rera) les migrations.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sp√©cifiez l'adresse de la base de donn√©es dans le fichier alembic.ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sp√©cifiez une description de l'√©tat souhait√© de la base de donn√©es (registre </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) afin qu'Alembic puisse g√©n√©rer automatiquement des migrations:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic est configur√© et peut d√©j√† √™tre utilis√©, mais dans notre cas, cette configuration pr√©sente plusieurs inconv√©nients:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilitaire </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherche </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le r√©pertoire de travail actuel. </font><font style="vertical-align: inherit;">Vous </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvez sp√©cifier le </font><font style="vertical-align: inherit;">chemin d'acc√®s √† l' </font><font style="vertical-align: inherit;">argument de ligne de commande, mais cela n'est pas pratique: je veux pouvoir appeler la commande √† partir de n'importe quel dossier sans param√®tres suppl√©mentaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour configurer Alembic pour fonctionner avec une base de donn√©es sp√©cifique, vous devez modifier le fichier </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il serait beaucoup plus pratique de sp√©cifier les param√®tres de base de donn√©es pour la variable d'environnement et / ou un argument de ligne de commande, par exemple </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le nom de l'utilitaire </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne correspond pas tr√®s bien au nom de notre service (et l'utilisateur peut en fait ne pas avoir du tout Python et ne rien savoir sur Alembic). </font><font style="vertical-align: inherit;">Il serait beaucoup plus pratique pour l'utilisateur final que toutes les commandes ex√©cutables du service aient un pr√©fixe commun, par exemple </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces probl√®mes sont r√©solus avec un petit wrapper. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic utilise un module standard pour traiter les arguments de ligne de commande </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il vous permet d'ajouter un argument facultatif </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur par d√©faut √† partir d'une variable d'environnement </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le chemin d'acc√®s au fichier </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut √™tre calcul√© par rapport √† l'emplacement du fichier ex√©cutable et non au r√©pertoire de travail actuel de l'utilisateur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilitaire de gestion de l'√©tat de la base de donn√©es</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est pr√™t, il peut √™tre enregistr√© en </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tant que commande ex√©cutable avec un nom compr√©hensible pour l'utilisateur final, par exemple </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enregistrez une commande ex√©cutable dans setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir r√©install√© le module, un fichier sera g√©n√©r√© </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et la commande </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deviendra disponible:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous g√©n√©rons des migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour g√©n√©rer des migrations, deux √©tats sont requis: l'√©tat souhait√© (que nous avons d√©crit avec des objets SQLAlchemy) et l'√©tat r√©el (la base de donn√©es, dans notre cas, est vide). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© que le moyen le plus simple d'augmenter Postgres √©tait avec Docker, et pour plus de commodit√©, j'ai ajout√© une commande </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui ex√©cute un conteneur en arri√®re-plan avec PostgreSQL sur le port 5432:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Augmentez PostgreSQL et g√©n√©rez la migration</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic fait g√©n√©ralement un bon travail de routine pour g√©n√©rer des migrations, mais je voudrais attirer l'attention sur les points suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les types de donn√©es utilisateur sp√©cifi√©s dans les tables cr√©√©es sont cr√©√©s automatiquement (dans notre cas - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais le code pour les supprimer n'est </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas g√©n√©r√©. </font><font style="vertical-align: inherit;">Si vous appliquez, annulez, puis appliquez √† nouveau la migration, cela provoquera une erreur car le type de donn√©es sp√©cifi√© existe d√©j√†.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimer le type de donn√©es de genre dans la m√©thode de r√©trogradation</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la m√©thode, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certaines actions peuvent parfois √™tre supprim√©es (si nous supprimons la table enti√®re, vous ne pouvez pas supprimer ses index s√©par√©ment):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exemple</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la migration est fixe et pr√™te, nous l'appliquons:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer √† cr√©er des gestionnaires, vous devez configurer l'application aiohttp.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous regardez le d√©marrage rapide aiohttp, vous pouvez √©crire quelque chose comme ceci</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code soul√®ve un certain nombre de questions et pr√©sente un certain nombre d'inconv√©nients:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment configurer l'application? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au minimum, vous devez sp√©cifier l'h√¥te et le port de connexion des clients, ainsi que les informations de connexion √† la base de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'aime vraiment r√©soudre ce probl√®me avec l'aide du module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: il √©tend le standard </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et permet d'utiliser des arguments de ligne de commande, des variables d'environnement (indispensables pour configurer les conteneurs Docker) et m√™me des fichiers de configuration (ainsi que la combinaison de ces m√©thodes) pour la configuration. </font><font style="vertical-align: inherit;">En l'utilisant </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez √©galement valider les valeurs des param√®tres de configuration d'application.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de traitement des param√®tres √† l'aide de ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             ‚Äî ,    ¬´¬ª     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   ‚Äî    )    ,      <code>nobody</code>.      ‚Äî     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les r√©ponses de gestionnaire r√©ussies seront renvoy√©es au format JSON. </font><font style="vertical-align: inherit;">Il serait √©galement pratique pour les clients de recevoir des informations sur les erreurs sous une forme s√©rialis√©e (par exemple, pour voir quels champs n'ont pas pass√© la validation). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propose une m√©thode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui prend un objet, le s√©rialise en JSON et renvoie un nouvel objet </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un en-t√™te </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et des donn√©es s√©rialis√©es √† l'int√©rieur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment s√©rialiser des donn√©es √† l'aide de json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il existe un autre moyen: aiohttp vous permet d'enregistrer un s√©rialiseur arbitraire pour un type sp√©cifique de donn√©es de r√©ponse dans le registre </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez sp√©cifier un s√©rialiseur </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour les objets de type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, il suffira que le gestionnaire retourne un objet </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les donn√©es de r√©ponse dans le param√®tre </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp trouvera un s√©rialiseur qui correspond au type de donn√©es et s√©rialisera la r√©ponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outre le fait que la s√©rialisation des objets est d√©crite en un seul endroit, cette approche est √©galement plus flexible - elle vous permet d'impl√©menter des solutions tr√®s int√©ressantes (nous consid√©rerons l'un des cas d'utilisation dans le gestionnaire </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment s√©rialiser des donn√©es √† l'aide de aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de comprendre que </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, par exemple </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ils utilisent une </font><font style="vertical-align: inherit;">m√©thode </font><font style="vertical-align: inherit;">standard </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui ne peut pas s√©rialiser des types de donn√©es complexes, par exemple, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie des enregistrements de la base de donn√©es en tant qu'instances de cette classe). </font><font style="vertical-align: inherit;">De plus, certains objets complexes peuvent en contenir d'autres: dans un enregistrement de la base de donn√©es, il peut y avoir un champ type </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les d√©veloppeurs Python ont r√©solu ce probl√®me: la m√©thode </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet d'utiliser l'argument </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour sp√©cifier une fonction qui est appel√©e lorsqu'il est n√©cessaire de s√©rialiser un objet inconnu. </font><font style="vertical-align: inherit;">La fonction devrait convertir un objet inconnu en un type qui peut s√©rialiser le module json.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √©tendre JsonPayload pour s√©rialiser des objets arbitraires</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      ‚Äî  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttp vous permet d'impl√©menter des gestionnaires avec des fonctions et classes asynchrones. </font><font style="vertical-align: inherit;">Les classes sont plus extensibles: premi√®rement, le code appartenant √† un gestionnaire peut √™tre plac√© √† un endroit, et deuxi√®mement, les classes vous permettent d'utiliser l'h√©ritage pour vous d√©barrasser de la duplication de code (par exemple, chaque gestionnaire n√©cessite une connexion √† la base de donn√©es).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe de base du gestionnaire</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme il est difficile de lire un gros fichier, j'ai d√©cid√© de diviser les gestionnaires en fichiers. </font><font style="vertical-align: inherit;">Les petits fichiers encouragent une faible connectivit√© et, par exemple, s'il y a des importations en anneau √† l'int√©rieur des gestionnaires, cela signifie que quelque chose ne va pas dans la composition des entit√©s.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire d'entr√©e re√ßoit json avec des donn√©es sur les r√©sidents. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La taille de requ√™te maximale autoris√©e</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans aiohttp est contr√¥l√©e par l'option </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhgM96xEtxuNqLAsnOFyqLZm0SnDiA#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est de 2 Mo par d√©faut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si la limite est d√©pass√©e, aiohttp retournera une r√©ponse HTTP avec un √©tat de 413: Erreur d'entit√© trop grande demand√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En m√™me temps, le json correct avec les lignes et les nombres les plus longs p√®sera ~ 63 m√©gaoctets, donc les restrictions sur la taille de la demande doivent √™tre √©tendues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifier et d√©s√©rialiser les donn√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . S'ils sont incorrects, vous devez renvoyer une r√©ponse HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais besoin de deux r√©gimes </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le premier </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifie les donn√©es de chaque r√©sident individuel et d√©s√©rialise √©galement la cha√Æne joyeux anniversaire dans l'objet </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type de donn√©es, format et disponibilit√© de tous les champs obligatoires;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manque de champs inconnus;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance doit √™tre indiqu√©e dans le format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne peut avoir aucune signification pour l'avenir;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La liste des proches de chaque r√©sident doit contenir des identifiants uniques des r√©sidents pr√©sents dans ce t√©l√©chargement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me sch√©ma </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,, v√©rifie le d√©chargement dans son ensemble:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chaque r√©sident du d√©chargement doit √™tre unique;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les liens familiaux doivent √™tre √† double sens (si le r√©sident n ¬∞ 1 a un r√©sident n ¬∞ 2 dans la liste des parents, le r√©sident n ¬∞ 2 doit √©galement avoir un parent n ¬∞ 1).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si les donn√©es sont correctes, elles doivent √™tre ajout√©es √† la base</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">donn√©es</font></strong><font style="vertical-align: inherit;"> avec une nouvelle unique </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ajouter des donn√©es, vous devrez effectuer plusieurs requ√™tes dans diff√©rentes tables. </font><font style="vertical-align: inherit;">Afin d'√©viter des donn√©es partiellement partiellement ajout√©es dans la base de donn√©es en cas d'erreur ou d'exception (par exemple, lorsque vous d√©connectez un client qui n'a pas re√ßu de r√©ponse compl√®te, aiohttp l√®vera </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une exception CancelledError</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez utiliser une transaction</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est n√©cessaire d'ajouter des donn√©es aux tables par parties</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car dans une requ√™te √† PostgreSQL, il ne peut y avoir plus de 32 767 arguments. </font><font style="vertical-align: inherit;">Il y a </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 champs </font><font style="vertical-align: inherit;">dans le tableau </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par cons√©quent, pour 1 requ√™te, seules 32 767/9 = 3 640 lignes peuvent √™tre ins√©r√©es dans ce tableau, et en un t√©l√©chargement, il peut y avoir jusqu'√† 10 000 habitants.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire renvoie tous les r√©sidents pour d√©chargement avec le sp√©cifi√© </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©chargement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sp√©cifi√© </font><b><font style="vertical-align: inherit;">n'existe pas</font></b><font style="vertical-align: inherit;"> , vous devez renvoyer la r√©ponse HTTP 404: Not Found. </font><font style="vertical-align: inherit;">Ce comportement semble √™tre courant pour les gestionnaires qui ont besoin d'un d√©chargement existant, j'ai donc extrait le code de v√©rification dans une classe distincte.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe de base pour les gestionnaires avec d√©chargements</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir une liste de parents pour chaque r√©sident, vous devrez effectuer </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en table </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en agr√©geant le champ </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regroup√© par </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le r√©sident n'a pas de parents, il </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retournera la </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeur </font><font style="vertical-align: inherit;">pour lui sur le terrain </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et, √† la suite de l'agr√©gation, la liste des parents ressemblera </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour corriger cette valeur incorrecte, j'ai utilis√© la fonction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de donn√©es stocke la date dans un format </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais nous avons besoin d'un format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Techniquement, vous pouvez formater la date avec une requ√™te SQL ou du c√¥t√© Python au moment de la s√©rialisation de la r√©ponse avec </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg renvoie la valeur du champ en </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tant </font><font style="vertical-align: inherit;">qu'instance </font><font style="vertical-align: inherit;">de la classe</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai choisi la s√©rialisation c√¥t√© Python, √©tant donn√© que c'est </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le seul objet </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du projet avec un seul format (voir la section </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´S√©rialisation des donn√©es¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© le fait que le processeur ex√©cute deux requ√™tes (v√©rification de l'existence d'un d√©chargement et d'une demande de liste de r√©sidents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'est pas n√©cessaire d'utiliser une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par d√©faut, PostgreSQL utilise le niveau d'isolement, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et m√™me au sein d'une transaction, toutes les modifications apport√©es √† d'autres transactions termin√©es avec succ√®s seront visibles (ajout de nouvelles lignes, modification de celles existantes).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le t√©l√©chargement le plus important dans une vue texte peut prendre environ 63 m√©gaoctets, ce qui est beaucoup, surtout si l'on consid√®re que plusieurs demandes de r√©ception de donn√©es peuvent arriver en m√™me temps. </font><font style="vertical-align: inherit;">Il existe un moyen assez int√©ressant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'obtenir des donn√©es de la base de donn√©es √† l'aide du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curseur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de les envoyer au client en plusieurs parties</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, nous devons impl√©menter deux objets:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui renvoie des enregistrements de la base de donn√©es. </font><font style="vertical-align: inherit;">Au premier appel, il se connecte √† la base de donn√©es, ouvre une transaction et cr√©e un curseur; lors d'une nouvelle it√©ration, il renvoie les enregistrements de la base de donn√©es. </font><font style="vertical-align: inherit;">Il est retourn√© par le gestionnaire.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code SelectQuery</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un s√©rialiseur </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui peut parcourir les g√©n√©rateurs asynchrones, s√©rialiser les donn√©es d'un g√©n√©rateur asynchrone vers JSON et envoyer des donn√©es aux clients en plusieurs parties. </font><font style="vertical-align: inherit;">Il est enregistr√© </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme s√©rialiseur d'objets </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code AsyncGenJSONListPayload</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans le gestionnaire, il sera possible de cr√©er un objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de lui passer une requ√™te SQL et une fonction pour ouvrir la transaction et la renvoyer √† </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code gestionnaire</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il d√©tecte un </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©rialiseur </font><font style="vertical-align: inherit;">enregistr√© </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour les objets de type </font><font style="vertical-align: inherit;">dans le registre </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, le s√©rialiseur parcourt l'objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et envoie des donn√©es au client. Lors du premier appel, l'objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">re√ßoit une connexion √† la base de donn√©es, ouvre une transaction et cr√©e un curseur; lors d'une nouvelle it√©ration, il recevra les donn√©es de la base de donn√©es avec le curseur et les renverra ligne par ligne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche permet de ne pas allouer de m√©moire pour la totalit√© du volume de donn√©es √† chaque requ√™te, mais elle a une particularit√©: l'application ne pourra pas renvoyer l'√©tat HTTP correspondant au client en cas d'erreur (apr√®s tout, l'√©tat HTTP, les en-t√™tes ont d√©j√† √©t√© envoy√©s au client et les donn√©es sont en cours d'√©criture).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une exception se produit, il ne reste plus qu'√† se d√©connecter. </font><font style="vertical-align: inherit;">Une exception, bien s√ªr, peut √™tre s√©curis√©e, mais le client ne pourra pas comprendre exactement quelle erreur s'est produite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'un autre c√¥t√©, une situation similaire peut se produire m√™me si le processeur re√ßoit toutes les donn√©es de la base de donn√©es, mais le r√©seau clignote lors de la transmission des donn√©es au client - personne n'est √† l'abri de cela.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire re√ßoit l'identifiant du d√©chargement </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le r√©sident </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ainsi que json avec les nouvelles donn√©es sur le r√©sident. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©chargement inexistant ou d'un r√©sident</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une r√©ponse HTTP doit √™tre retourn√©e </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es transmises par le client doivent √™tre </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifi√©es et d√©s√©rialis√©es</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">S'ils sont incorrects, vous devez renvoyer une r√©ponse HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai impl√©ment√© un sch√©ma Marshmallow </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui v√©rifie:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le type et le format des donn√©es pour les champs sp√©cifi√©s.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date de naissance. </font><font style="vertical-align: inherit;">Il doit √™tre sp√©cifi√© dans un format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne peut √™tre significatif √† l'avenir.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une liste des proches de chaque r√©sident. </font><font style="vertical-align: inherit;">Il doit avoir des identifiants uniques pour les r√©sidents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'existence des parents indiqu√©s dans le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut pas √™tre v√©rifi√©e s√©par√©ment: si un </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©sident inexistant est </font><font style="vertical-align: inherit;">ajout√© √† la table, </font><font style="vertical-align: inherit;">PostgreSQL renvoie une erreur </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui peut √™tre trait√©e et le statut HTTP peut √™tre retourn√© </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quel statut doit √™tre retourn√© si le client a envoy√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des donn√©es incorrectes pour un r√©sident inexistant ou un d√©chargement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Il est s√©mantiquement plus correct de v√©rifier d'abord l'existence d'un d√©chargement et d'un r√©sident (s'il n'y en a pas, retour </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et ensuite seulement si le client a envoy√© les donn√©es correctes (sinon, retour </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). En pratique, il est souvent moins co√ªteux de v√©rifier d'abord les donn√©es, et seulement si elles sont correctes, d'acc√©der √† la base de donn√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux options sont acceptables, mais j'ai d√©cid√© de choisir une deuxi√®me option moins ch√®re, car dans tous les cas, le r√©sultat de l'op√©ration est une erreur qui n'affecte rien (le client corrigera les donn√©es et d√©couvrira ensuite que le r√©sident n'existe pas). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les donn√©es sont correctes, il est n√©cessaire de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† </font><strong><font style="vertical-align: inherit;">jour les informations sur le r√©sident dans la base de donn√©es</font></strong><font style="vertical-align: inherit;"> . Dans le gestionnaire, vous devrez effectuer plusieurs requ√™tes sur diff√©rentes tables. Si une erreur ou une exception se produit, les modifications apport√©es √† la base de donn√©es doivent √™tre annul√©es, de sorte que les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requ√™tes doivent √™tre effectu√©es dans une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de transf√©rer uniquement certains champs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour un r√©sident.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit √™tre √©crit de telle mani√®re qu'il ne se bloque pas lors de l'acc√®s aux donn√©es que le client n'a pas sp√©cifi√© et n'ex√©cute pas non plus les requ√™tes sur les tables dans lesquelles les donn√©es n'ont pas chang√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le client a pr√©cis√© le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il est n√©cessaire d'obtenir une liste des proches existants. S'il a chang√©, d√©terminez les enregistrements de la table qui </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doivent √™tre supprim√©s et ceux √† ajouter afin d'aligner la base de donn√©es sur la demande du client. Par d√©faut, PostgreSQL utilise l'isolement des transactions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela signifie que dans le cadre de la transaction en cours, les modifications seront visibles pour les enregistrements existants (ainsi que les nouveaux) des autres transactions termin√©es. Cela peut conduire √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une condition de concurrence entre les demandes concurrentielles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'il y ait un d√©chargement avec les r√©sidents</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sans parent√©. Le service re√ßoit deux demandes simultan√©es de changement de r√©sident n ¬∞ 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp cr√©era deux gestionnaires qui recevront simultan√©ment l'√©tat actuel du r√©sident de PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque gestionnaire ne d√©tectera pas une seule relation associ√©e et d√©cidera d'ajouter une nouvelle relation avec le parent sp√©cifi√©. En cons√©quence, le r√©sident n ¬∞ 1 a le m√™me domaine que les proches </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce comportement ne peut pas √™tre qualifi√© d'√©vident. Deux options sont pr√©vues pour d√©cider du r√©sultat de la course: pour terminer uniquement la premi√®re demande, et pour la seconde, renvoyer une r√©ponse HTTP </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(afin que le client r√©p√®te la demande), ou pour ex√©cuter les demandes √† tour de r√¥le (la deuxi√®me demande ne sera trait√©e qu'apr√®s la fin de la premi√®re). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re option peut √™tre impl√©ment√©e en activant le mode d'isolement</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si au cours du traitement de la demande, quelqu'un a d√©j√† r√©ussi √† modifier et √† valider les donn√©es, une exception sera lev√©e, qui peut √™tre trait√©e et le statut HTTP correspondant retourn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'inconv√©nient de cette solution - un grand nombre de verrous dans PostgreSQL, </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√®vera une exception, m√™me si les requ√™tes concurrentielles modifient les enregistrements des r√©sidents de diff√©rents d√©chargements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©galement utiliser le m√©canisme de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrouillage des recommandations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si vous obtenez un tel verrouillage </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, les demandes concurrentielles de diff√©rents d√©chargements pourront s'ex√©cuter en parall√®le. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour traiter les demandes concurrentielles en un seul t√©l√©chargement, vous pouvez impl√©menter le comportement de l'une des options: la fonction </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">essaie d'obtenir un verrou et</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il renvoie le r√©sultat bool√©en imm√©diatement (s'il n'√©tait pas possible d'obtenir le verrou - une exception peut √™tre lev√©e), mais il </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend que la </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ressource soit disponible pour le blocage (dans ce cas, les requ√™tes seront ex√©cut√©es s√©quentiellement, j'ai opt√© pour cette option). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, le gestionnaire doit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoyer les informations actuelles sur le r√©sident mis √† jour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il a √©t√© possible de nous limiter au retour des donn√©es de sa demande au client (puisque nous renvoyons une r√©ponse au client, cela signifie qu'il n'y a eu aucune exception et que toutes les demandes ont √©t√© trait√©es avec succ√®s). Ou - utilisez le mot cl√© RETURNING dans les requ√™tes qui modifient la base de donn√©es et g√©n√®rent une r√©ponse √† partir des r√©sultats. Mais ces deux approches ne nous permettraient pas de voir et de tester le cas de la race des √âtats.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y avait aucune exigence de charge √©lev√©e pour le service, j'ai donc d√©cid√© de demander √† nouveau toutes les donn√©es sur le r√©sident et de renvoyer au client un r√©sultat honn√™te de la base de donn√©es. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire calcule le nombre de cadeaux que chaque r√©sident du d√©chargement recevra √† ses proches (premi√®re commande). </font><font style="vertical-align: inherit;">Le num√©ro est group√© par mois pour le t√©l√©chargement avec le sp√©cifi√© </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©chargement inexistant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une r√©ponse HTTP doit √™tre retourn√©e </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux options de mise en ≈ìuvre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez des donn√©es pour les r√©sidents avec des proches dans la base de donn√©es et du c√¥t√© Python, agr√©gez les donn√©es par mois et g√©n√©rez des listes pour les mois pour lesquels il n'y a pas de donn√©es dans la base de donn√©es.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilez une requ√™te json dans la base de donn√©es et ajoutez des stubs pour les mois manquants.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai opt√© pour la premi√®re option - visuellement, elle semble plus compr√©hensible et prise en charge. Le nombre d'anniversaires dans un mois donn√© peut √™tre obtenu en faisant </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du tableau avec les liens familiaux ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le r√©sident pour lequel nous consid√©rons les anniversaires des proches) dans le tableau </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(contenant la date de naissance √† partir de laquelle vous souhaitez obtenir le mois). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les valeurs de mois ne doivent pas contenir de z√©ros en t√™te. Le mois obtenu √† partir du champ </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisant la fonction </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut contenir un z√©ro non significatif. Pour l' </font><font style="vertical-align: inherit;">enlever, je fis </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la requ√™te SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© le fait que le gestionnaire doive r√©pondre √† deux demandes (v√©rifier l'existence du d√©chargement et obtenir des informations sur les anniversaires et les cadeaux), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucune transaction n'est requise</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par d√©faut, PostgreSQL utilise le mode READ COMMITTED, dans lequel tous les nouveaux enregistrements (ajout√©s par d'autres transactions) et existants (modifi√©s par d'autres transactions) sont visibles dans la transaction en cours une fois qu'ils sont termin√©s avec succ√®s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, si un nouveau t√©l√©chargement est ajout√© au moment de la r√©ception des donn√©es, cela n'affectera pas les donn√©es existantes. </font><font style="vertical-align: inherit;">Si, au moment de la r√©ception des donn√©es, une demande de changement de r√©sident est satisfaite, soit les donn√©es ne seront pas encore visibles (si la transaction modifiant les donn√©es n'est pas termin√©e), soit la transaction se terminera compl√®tement et toutes les modifications seront imm√©diatement visibles. </font><font style="vertical-align: inherit;">L'int√©grit√© obtenue de la base de donn√©es ne sera pas viol√©e.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire calcule les 50e, 75e et 99e centiles de l'√¢ge (ann√©es enti√®res) des r√©sidents par ville dans l'√©chantillon avec l'id_import_id sp√©cifi√©. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©chargement inexistant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une r√©ponse HTTP doit √™tre retourn√©e </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© le fait que le processeur ex√©cute deux requ√™tes (v√©rification de l'existence du d√©chargement et obtention d'une liste de r√©sidents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'est pas n√©cessaire d'utiliser une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux options de mise en ≈ìuvre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez l'√¢ge des r√©sidents √† partir de la base de donn√©es, regroup√©s par ville, puis du c√¥t√© Python, calculez les centiles en utilisant numpy (qui est sp√©cifi√© comme r√©f√©rence dans la t√¢che) et arrondissez √† deux d√©cimales.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me option n√©cessite de transf√©rer moins de donn√©es entre l'application et PostgreSQL, mais elle n'a pas d'√©cueil tr√®s √©vident: dans PostgreSQL, l'arrondi est math√©matique, ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie 3), et en Python - comptabilit√©, √† l'entier le plus proche ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retourne 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester le gestionnaire, l'impl√©mentation doit √™tre la m√™me dans PostgreSQL et Python (l'impl√©mentation d'une fonction avec arrondi math√©matique en Python semble plus facile). </font><font style="vertical-align: inherit;">Il convient de noter que lors du calcul des centiles, numpy et PostgreSQL peuvent renvoyer des nombres l√©g√®rement diff√©rents, mais en tenant compte de l'arrondissement, cette diff√©rence ne sera pas perceptible.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faut-il v√©rifier dans cette application? Premi√®rement, que les gestionnaires r√©pondent aux exigences et effectuent le travail requis dans un environnement aussi proche que possible de l'environnement de combat. Deuxi√®mement, les migrations qui modifient l'√©tat de la base de donn√©es fonctionnent sans erreur. Troisi√®mement, il existe un certain nombre de fonctions auxiliaires qui pourraient √©galement √™tre correctement couvertes par des tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© d'utiliser le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">framework pytest en raison</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de sa flexibilit√© et de sa facilit√© d'utilisation. Il offre un m√©canisme puissant pour pr√©parer l'environnement aux tests - les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">luminaires</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est-√†-dire qu'il fonctionne avec un d√©corateur</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont les noms peuvent √™tre sp√©cifi√©s par le param√®tre du test. </font><font style="vertical-align: inherit;">Si pytest d√©tecte un param√®tre avec un nom de luminaire dans l'annotation de test, il ex√©cutera ce luminaire et transmettra le r√©sultat dans la valeur de ce param√®tre. </font><font style="vertical-align: inherit;">Et si le luminaire est un g√©n√©rateur, le param√®tre de test prendra la valeur renvoy√©e </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et une fois le test termin√©, la deuxi√®me partie du </font><font style="vertical-align: inherit;">luminaire sera </font><font style="vertical-align: inherit;">ex√©cut√©e, ce qui peut effacer les ressources ou fermer les connexions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la plupart des tests, nous avons besoin d'une base de donn√©es PostgreSQL. </font><font style="vertical-align: inherit;">Pour isoler les tests les uns des autres, vous pouvez cr√©er une base de donn√©es distincte avant chaque test et la supprimer apr√®s l'ex√©cution.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er une base de donn√©es d'appareils pour chaque test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait un excellent travail de cette t√¢che </font><font style="vertical-align: inherit;">, en tenant compte des caract√©ristiques des diff√©rentes bases de donn√©es et pilotes. Par exemple, PostgreSQL ne permet pas l'ex√©cution </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un bloc de transaction. Lors de la cr√©ation d'une base de donn√©es, il </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traduit </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(qui ex√©cute g√©n√©ralement toutes les demandes dans une transaction) en mode de validation automatique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre caract√©ristique importante: si au moins un client est connect√© √† PostgreSQL, la base de donn√©es ne peut pas √™tre supprim√©e, mais </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©connecte tous les clients avant de supprimer la base de donn√©es. La base de donn√©es sera supprim√©e avec succ√®s m√™me si un test avec des connexions actives s'y bloque.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons besoin de PostgreSQL dans diff√©rents √©tats: pour tester les migrations, nous avons besoin d'une base de donn√©es propre, tandis que les gestionnaires exigent que toutes les migrations soient appliqu√©es. </font><font style="vertical-align: inherit;">Vous pouvez modifier par programme l'√©tat d'une base de donn√©es √† l'aide des commandes Alembic; elles n√©cessitent l'objet de configuration Alembic pour les appeler.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er un objet de configuration de luminaire Alembic</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que les appareils </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont un param√®tre </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permet non seulement d'indiquer la d√©pendance du test sur les appareils, mais aussi les d√©pendances entre appareils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce m√©canisme vous permet de s√©parer de mani√®re flexible la logique et d'√©crire du code tr√®s concis et r√©utilisable.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test des gestionnaires n√©cessite une base de donn√©es avec des tables et des types de donn√©es cr√©√©s. Pour appliquer des migrations, vous devez appeler par programme la commande de mise √† niveau d'Alembic. Pour l'appeler, vous avez besoin d'un objet avec la configuration Alembic, que nous avons d√©j√† d√©fini avec des fixtures </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La base de donn√©es avec migrations ressemble √† une entit√© compl√®tement ind√©pendante, et elle peut √™tre repr√©sent√©e comme un appareil:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'il y a de nombreuses migrations dans le projet, leur application pour chaque test peut prendre trop de temps. Pour acc√©l√©rer le processus, vous pouvez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©er une base de donn√©es avec des migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une fois </font><font style="vertical-align: inherit;">, puis l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliser comme mod√®le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de la base de donn√©es pour tester les gestionnaires, vous aurez besoin d'une application en cours d'ex√©cution, ainsi que d'un client configur√© pour fonctionner avec cette application. Pour rendre l'application facile √† tester, j'ai mis sa cr√©ation dans une fonction </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui prend des param√®tres √† ex√©cuter: une base de donn√©es, un port pour l'API REST, et autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les arguments pour lancer l'application peuvent √©galement √™tre repr√©sent√©s comme un appareil distinct. Pour les cr√©er, vous devrez d√©terminer le port libre pour ex√©cuter l'application de test et l'adresse de la base de donn√©es temporaire migr√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©terminer le port libre, j'ai utilis√© le luminaire </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du package aiomisc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un appareil standard </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conviendrait √©galement, mais il renvoie une fonction pour d√©terminer les ports libres, tandis qu'il </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie imm√©diatement le num√©ro de port. </font><font style="vertical-align: inherit;">Pour notre application, nous devons d√©terminer un seul port libre, j'ai donc d√©cid√© de ne pas √©crire une ligne de code suppl√©mentaire avec un appel </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les tests avec des gestionnaires impliquent des demandes √† l'API REST; travailler directement avec l'application n'est </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas requis. </font><font style="vertical-align: inherit;">Par cons√©quent, j'ai cr√©√© un appareil qui lance l'application et, en utilisant l'usine, </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cr√©e et renvoie un client de test standard connect√© √† l'application </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, si vous sp√©cifiez le luminaire dans les param√®tres de test </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, les √©v√©nements suivants se produisent:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les appareils peuvent √©viter la duplication de code, mais en plus de pr√©parer l'environnement dans les tests, il y a un autre endroit potentiel o√π il y aura beaucoup du m√™me code - les demandes d'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, en faisant une demande, nous nous attendons √† obtenir un certain statut HTTP. Deuxi√®mement, si l'√©tat correspond √† celui attendu, avant de travailler avec les donn√©es, vous devez vous assurer qu'elles ont le bon format. Il est facile de faire une erreur ici et d'√©crire un gestionnaire qui effectue les calculs corrects et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie le r√©sultat correct, mais ne passe pas la validation automatique en raison du format de r√©ponse incorrect</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (par exemple, oubliez d'envelopper la r√©ponse dans un dictionnaire avec une cl√© </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Toutes ces v√©rifications pourraient √™tre effectu√©es en un seul endroit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le module</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J'ai pr√©par√© pour chaque gestionnaire une fonction d'aide qui v√©rifie l'√©tat de HTTP, ainsi que le format de r√©ponse √† l'aide de Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© de commencer avec un gestionnaire qui renvoie des r√©sidents, car il est tr√®s utile pour v√©rifier les r√©sultats d'autres gestionnaires qui modifient l'√©tat de la base de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai intentionnellement pas utilis√© de code qui ajoute des donn√©es √† la base de donn√©es du gestionnaire </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bien qu'il ne soit pas difficile d'en faire une fonction distincte. </font><font style="vertical-align: inherit;">Le code du gestionnaire a la propri√©t√© de changer et s'il y a une erreur dans le code qui s'ajoute √† la base de donn√©es, il y a une chance que le test cesse de fonctionner comme pr√©vu et implicitement pour les d√©veloppeurs arr√™te d'afficher des erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce test, j'ai d√©fini les ensembles de donn√©es de test suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec plusieurs proches. </font><font style="vertical-align: inherit;">V√©rifie que pour chaque r√©sident une liste avec les identifiants des proches sera correctement constitu√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec un r√©sident sans parents. </font><font style="vertical-align: inherit;">V√©rifie que le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est une liste vide (en raison </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la requ√™te SQL, la liste des parents peut √™tre √©gale </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec un r√©sident qui est un parent de lui-m√™me.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement vide. </font><font style="vertical-align: inherit;">V√©rifie que le gestionnaire autorise l'ajout de d√©chargement vide et ne se bloque pas avec une erreur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ex√©cuter le m√™me test s√©par√©ment √† chaque t√©l√©chargement, j'ai utilis√© un autre m√©canisme Pytest tr√®s puissant - le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param√©trage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce m√©canisme vous permet d'envelopper la fonction de test dans le d√©corateur </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de d√©crire les param√®tres que la fonction de test doit prendre pour chaque cas de test individuel.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment param√©trer un test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le test ajoutera le t√©l√©chargement √† la base de donn√©es, puis, √† l'aide d'une demande au gestionnaire, il recevra des informations sur les r√©sidents et comparera le t√©l√©chargement de r√©f√©rence avec celui re√ßu. Mais comment comparez-vous les r√©sidents? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque r√©sident se compose de champs scalaires et d'un champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une liste d'identifiants de parents. Une liste en Python est un type ordonn√©, et lors de la comparaison de l'ordre des √©l√©ments de chaque liste importe, mais lors de la comparaison des listes avec les fr√®res et s≈ìurs, l'ordre ne devrait pas avoir d'importance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous apportez </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† l'ensemble avant la comparaison, alors lors de la comparaison, cela ne fonctionne pas pour trouver une situation o√π l'un des habitants sur le terrain </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a des doublons. Si vous triez la liste avec les identifiants des proches, cela √©vitera le probl√®me de l'ordre diff√©rent des identifiants des proches, mais en m√™me temps d√©tectera les doublons.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la comparaison de deux listes avec des r√©sidents, l'un peut rencontrer un probl√®me similaire: techniquement, l'ordre des r√©sidents dans le d√©chargement n'est pas important, mais il est important de d√©tecter s'il y a deux r√©sidents avec les m√™mes identifiants dans un d√©chargement et pas dans l'autre. </font><font style="vertical-align: inherit;">Ainsi, en plus d'organiser la liste avec des proches, les proches de chaque r√©sident doivent organiser les r√©sidents √† chaque d√©chargement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque la t√¢che de comparer les r√©sidents se posera plus d'une fois, j'ai mis en place deux fonctions: une pour comparer deux r√©sidents, et la seconde pour comparer deux listes avec des r√©sidents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparez les r√©sidents</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que ce gestionnaire ne retourne pas les r√©sidents d'autres d√©chargements, j'ai d√©cid√© d'ajouter un d√©chargement suppl√©mentaire avec un habitant avant chaque test.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©fini les jeux de donn√©es suivants pour tester le gestionnaire:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donn√©es correctes, cens√©es √™tre ajout√©es avec succ√®s √† la base de donn√©es.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement vide </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit prendre en compte un tel cas et ne pas tomber, en essayant d'effectuer une insertion vide dans la table avec les habitants.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donn√©es avec des erreurs, attendez-vous √† une r√©ponse HTTP de 400: Bad Request.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance est incorrecte (futur).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id n'est pas unique dans le t√©l√©chargement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une parent√© est indiqu√©e de mani√®re incorrecte (il n'y a qu'un r√©sident √† l'autre, mais il n'y a pas de retour).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√©sident a un parent inexistant au d√©chargement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les liens familiaux ne sont pas uniques.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le processeur a fonctionn√© correctement et que les donn√©es ont √©t√© ajout√©es, vous devez ajouter les r√©sidents √† la base de donn√©es et les comparer avec le d√©chargement standard. </font><font style="vertical-align: inherit;">Pour obtenir des r√©sidents, j'ai utilis√© le gestionnaire d√©j√† test√© </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et, √† titre de comparaison, une fonction </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La validation des donn√©es est √† bien des √©gards similaire √† celle d√©crite dans le gestionnaire </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† quelques exceptions pr√®s: il n'y a qu'un seul r√©sident et le client ne peut passer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que les champs qu'il souhaite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©cid√© d'utiliser les ensembles suivants avec des donn√©es incorrectes pour v√©rifier que le gestionnaire retournera une r√©ponse HTTP </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le champ est sp√©cifi√©, mais a un type et / ou un format de donn√©es incorrects</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance est incorrecte (heure future).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient un parent qui n'existe pas dans le d√©chargement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √©galement n√©cessaire de v√©rifier que le gestionnaire met correctement √† jour les informations sur le r√©sident et ses proches. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, cr√©ez un t√©l√©chargement avec trois habitants, dont deux sont des parents, et envoyez une demande avec de nouvelles valeurs pour tous les champs scalaires et un nouvel identifiant relatif dans le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire distingue les r√©sidents de d√©chargements diff√©rents avant le test (et, par exemple, ne change pas les r√©sidents avec les m√™mes identifiants d'un autre d√©chargement), j'ai cr√©√© un d√©chargement suppl√©mentaire avec trois r√©sidents qui ont les m√™mes identifiants.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit enregistrer les nouvelles valeurs des champs scalaires, ajouter un nouveau parent sp√©cifi√© et supprimer la relation avec un ancien parent non sp√©cifi√©. </font><font style="vertical-align: inherit;">Tous les changements de parent√© devraient √™tre bilat√©raux. </font><font style="vertical-align: inherit;">Il ne devrait pas y avoir de changement dans les autres d√©chargements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© qu'un tel gestionnaire peut √™tre soumis √† des conditions de concurrence (cela a √©t√© discut√© dans la section D√©veloppement), j'ai ajout√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deux tests suppl√©mentaires</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'un reproduit le probl√®me avec l'√©tat de race (√©tend la classe de gestionnaire et supprime le verrou), le second prouve que le probl√®me avec l'√©tat de race n'est pas reproduit.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester ce gestionnaire, j'ai s√©lectionn√© les jeux de donn√©es suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un d√©chargement dans lequel un r√©sident a un parent en un mois et deux parents en un autre.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec un r√©sident sans parents. </font><font style="vertical-align: inherit;">V√©rifie que le gestionnaire n'en tient pas compte dans les calculs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement vide. </font><font style="vertical-align: inherit;">V√©rifie que le gestionnaire n'√©chouera pas et renverra le dictionnaire correct avec 12 mois dans la r√©ponse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec un r√©sident qui est un parent de lui-m√™me. </font><font style="vertical-align: inherit;">V√©rifie qu'un r√©sident ach√®tera un cadeau pour le mois de sa naissance.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit retourner tous les mois dans la r√©ponse, m√™me s'il n'y a pas d'anniversaire au cours de ces mois. </font><font style="vertical-align: inherit;">Pour √©viter les doublons, j'ai cr√©√© une fonction √† laquelle vous pouvez passer le dictionnaire afin qu'il le compl√®te avec des valeurs pour les mois manquants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire fait la distinction entre les r√©sidents de d√©chargements diff√©rents, j'ai ajout√© un d√©chargement suppl√©mentaire avec deux parents. </font><font style="vertical-align: inherit;">Si le gestionnaire les utilise par erreur dans les calculs, les r√©sultats seront incorrects et le gestionnaire tombera avec une erreur.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La particularit√© de ce test est que les r√©sultats de son travail d√©pendent de l'heure actuelle: l'√¢ge des habitants est calcul√© en fonction de la date du jour. </font><font style="vertical-align: inherit;">Pour s'assurer que les r√©sultats des tests ne changent pas au fil du temps, la date actuelle, les dates de naissance des r√©sidents et les r√©sultats attendus doivent √™tre enregistr√©s. </font><font style="vertical-align: inherit;">Cela facilitera la reproduction de tous les cas de bord, m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle est la meilleure date de correction? </font><font style="vertical-align: inherit;">Le gestionnaire utilise la fonction PostgreSQL pour calculer l'√¢ge des r√©sidents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui prend le premier param√®tre comme date pour laquelle il est n√©cessaire de calculer l'√¢ge et le second comme date de base (d√©finie par une constante </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous rempla√ßons la date de base dans le gestionnaire par l'heure du test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester le gestionnaire, j'ai s√©lectionn√© les ensembles de donn√©es suivants (pour tous les r√©sidents, j'ai indiqu√© une ville, car le gestionnaire agr√®ge les r√©sultats par ville):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec plusieurs r√©sidents dont l'anniversaire est demain (√¢ge - plusieurs ann√©es et 364 jours). </font><font style="vertical-align: inherit;">V√©rifie que le processeur utilise uniquement le nombre d'ann√©es compl√®tes dans les calculs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement avec un r√©sident dont l'anniversaire est aujourd'hui (√¢ge - exactement quelques ann√©es). </font><font style="vertical-align: inherit;">Il v√©rifie le cas r√©gional - l'√¢ge d'un r√©sident dont l'anniversaire est aujourd'hui ne doit pas √™tre calcul√© comme r√©duit d'un an.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©chargement vide. </font><font style="vertical-align: inherit;">Le gestionnaire ne doit pas tomber dessus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©f√©rence </font><font style="vertical-align: inherit;">pour le calcul des centiles - </font><font style="vertical-align: inherit;">avec interpolation lin√©aire, et les r√©sultats de r√©f√©rence pour les tests que j'ai calcul√©s pour eux. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez √©galement arrondir les valeurs de percentile fractionnaire √† deux d√©cimales. </font><font style="vertical-align: inherit;">Si vous avez utilis√© PostgreSQL pour l'arrondi dans le gestionnaire et Python pour le calcul des donn√©es de r√©f√©rence, vous remarquerez peut-√™tre que l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arrondi dans Python 3 et PostgreSQL peut donner des r√©sultats diff√©rents</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exemple</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que Python utilise l'arrondi de banque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au pair le plus proche</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et PostgreSQL </font><font style="vertical-align: inherit;">utilise </font><font style="vertical-align: inherit;">math√©matique (demi-hausse). </font><font style="vertical-align: inherit;">Si les calculs et l'arrondi sont effectu√©s dans PostgreSQL, il serait correct d'utiliser √©galement l'arrondi math√©matique dans les tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au d√©but, j'ai d√©crit des ensembles de donn√©es avec des dates de naissance dans un format texte, mais il n'√©tait pas pratique de lire un test dans ce format: chaque fois, je devais calculer l'√¢ge de chaque habitant dans mon esprit afin de me rappeler ce qu'un ensemble de donn√©es particulier v√©rifiait. </font><font style="vertical-align: inherit;">Bien s√ªr, vous pouviez vous en sortir avec les commentaires du code, mais j'ai d√©cid√© d'aller un peu plus loin et j'ai √©crit une fonction </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui vous permet de d√©crire la date de naissance sous forme d'√¢ge: le nombre d'ann√©es et de jours.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, comme ceci</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire distingue les r√©sidents de d√©chargements diff√©rents, j'ai ajout√© un d√©chargement suppl√©mentaire avec un r√©sident d'une autre ville: si le gestionnaire l'utilise par erreur, une ville suppl√©mentaire appara√Ætra dans les r√©sultats et le test se cassera.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un fait int√©ressant: lorsque j'ai √©crit ce test le 29 f√©vrier 2020, j'ai soudainement cess√© de g√©n√©rer des d√©charges avec les r√©sidents en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raison d'un bug dans Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 est une ann√©e bissextile, et d'autres ann√©es que Faker a choisies n'√©taient pas toujours des ann√©es bissextiles aussi) n'√©tait pas le 29 f√©vrier). </font><font style="vertical-align: inherit;">N'oubliez pas d'enregistrer les dates et de tester les cas limites!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de migration √† premi√®re vue semble √©vident et le moins sujet aux erreurs, pourquoi le tester? Il s'agit d'une erreur tr√®s dangereuse: les erreurs de migration les plus insidieuses peuvent se manifester au moment le plus inopportun. M√™me s'ils ne g√¢chent pas les donn√©es, ils peuvent entra√Æner des temps d'arr√™t inutiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font><font style="vertical-align: inherit;">migration </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initiale</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> existante dans le projet </font><font style="vertical-align: inherit;">modifie la structure de la base de donn√©es, mais ne modifie pas les donn√©es. Quelles erreurs courantes peuvent √™tre prot√©g√©es contre de telles migrations?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        ‚Äî    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart de ces erreurs seront d√©tect√©es par le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test d'escalier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Son id√©e - d'utiliser une seule migration, effectuer syst√©matiquement les m√©thodes </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour chaque migration. </font><font style="vertical-align: inherit;">Un tel test suffit √† √™tre ajout√© au projet une fois, il ne n√©cessite pas de support et servira fid√®lement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si la migration, en plus de la structure, modifiait les donn√©es, il faudrait alors √©crire au moins un test distinct, en v√©rifiant que les donn√©es changent correctement dans la m√©thode </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et reviennent √† l'√©tat initial dans </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Juste au cas o√π: un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet avec des exemples de tests de diff√©rentes migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que j'ai pr√©par√© pour un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapport sur Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† Moscou Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembl√©e</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'artefact final que nous allons d√©ployer et que nous voulons obtenir √† la suite de l'assemblage est une image Docker. Pour construire, vous devez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©lectionner l'image de base</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec Python. L'image officielle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p√®se ~ 1 Go et, si elle est utilis√©e comme image de base, l'image avec l'application sera √©norme. Il existe des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images bas√©es sur Alpine OS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dont la taille est beaucoup plus petite. Mais avec un nombre croissant de packages install√©s, la taille de l'image finale augmentera et, par cons√©quent, m√™me l'image collect√©e sur la base d'Alpine ne sera pas si petite. J'ai choisi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme image de base </font><font style="vertical-align: inherit;">- elle p√®se un peu plus que les images alpines, mais est bas√©e sur Ubuntu, qui propose une vaste s√©lection de packages et de biblioth√®ques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©duire la taille de l'image avec l'application</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - n'incluez pas dans l'image finale le compilateur, les biblioth√®ques et les fichiers avec des en-t√™tes pour l'assemblage, qui ne sont pas n√©cessaires au fonctionnement de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, vous pouvez utiliser l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assemblage en plusieurs √©tapes de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'aide d'une image ¬´lourde¬ª </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 Go, ~ 500 Mo compress√©s), cr√©ez un environnement virtuel, installez-y toutes les d√©pendances et le package d'application. </font><font style="vertical-align: inherit;">Cette image est n√©cessaire exclusivement pour l'assemblage, elle peut contenir un compilateur, toutes les biblioth√®ques et fichiers n√©cessaires avec des en-t√™tes.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous copions l'environnement virtuel fini dans une image ¬´l√©g√®re¬ª </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 Mo, compress√©e ~ 50 Mo), qui ne contient que l'interpr√©teur de la version requise de Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important: dans un environnement virtuel, des chemins absolus sont utilis√©s, il doit donc √™tre copi√© √† la m√™me adresse √† laquelle il a √©t√© assembl√© dans le conteneur collecteur.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©duire le temps n√©cessaire √† la cr√©ation de l'image</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les modules d√©pendants de l'application peuvent √™tre install√©s avant d'√™tre install√©s dans l'environnement virtuel. </font><font style="vertical-align: inherit;">Docker les mettra en cache et ne r√©installera pas s'ils n'ont pas chang√©.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile enti√®rement</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  ‚Äî ¬´¬ª (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    ¬´¬ª (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour faciliter l'assemblage, j'ai ajout√© une commande </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui collecte l'image Docker et la t√©l√©charge sur hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que le code est couvert de tests et que nous pouvons construire une image Docker, il est temps d'automatiser ces processus. La premi√®re chose qui vous vient √† l'esprit: ex√©cutez des tests pour cr√©er des demandes de pool et, lorsque vous ajoutez des modifications √† la branche principale, collectez une nouvelle image Docker et t√©l√©chargez-la sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packages GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si vous n'allez pas distribuer l'image publiquement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai r√©solu ce probl√®me avec les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actions GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pour ce faire, il a fallu cr√©er un fichier YAML dans un dossier </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et y d√©crire un workflow (avec deux t√¢ches: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que j'ai nomm√© </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est ex√©cut√©e √† chaque d√©marrage du workflow </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √† l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">services</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©cup√®re un conteneur avec PostgreSQL, attend qu'il soit disponible et se lance </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le conteneur </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'est ex√©cut√©e que si les modifications ont √©t√© ajout√©es √† la branche </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et si la t√¢che </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a r√©ussi. </font><font style="vertical-align: inherit;">Il collecte la distribution source par le conteneur </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis collecte et charge l'image Docker avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description compl√®te du workflow</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, lorsque vous ajoutez des modifications au ma√Ætre dans l'onglet Actions sur GitHub, vous pouvez voir le lancement des tests, l'assemblage et le chargement de l'image Docker: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et lors de la cr√©ation d'une demande de pool dans la branche principale, les r√©sultats de la t√¢che y seront √©galement affich√©s </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©ployer l'application sur le serveur fourni, vous devez installer Docker, Docker Compose, d√©marrer les conteneurs avec l'application et PostgreSQL et appliquer les migrations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces √©tapes peuvent √™tre automatis√©es √† l'aide du syst√®me de gestion de configuration d'Ansible. Il est √©crit en Python, ne n√©cessite pas d'agents sp√©ciaux (se connecte directement via ssh), utilise des mod√®les jinja et permet de d√©crire de mani√®re d√©clarative l'√©tat souhait√© dans les fichiers YAML. L'approche d√©clarative vous permet de ne pas penser √† l'√©tat actuel du syst√®me et aux actions n√©cessaires pour amener le syst√®me √† l'√©tat souhait√©. Tout ce travail repose sur les √©paules des modules Ansible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible vous permet de regrouper les t√¢ches logiquement li√©es en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√¥les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis de les r√©utiliser. Nous aurons besoin de deux r√¥les:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installe et configure Docker) et </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installe et configure l'application). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√¥le</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajoute un r√©f√©rentiel avec Docker au syst√®me, installe et configure les packages </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©ventuellement configurer l'API REST pour qu'elle reprenne automatiquement apr√®s un red√©marrage du serveur. Ubuntu vous permet de r√©soudre ce probl√®me √† l'aide d'un syst√®me d'initialisation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il contr√¥le des unit√©s repr√©sentant diverses ressources (d√©mons, sockets, points de montage et autres). Pour ajouter une nouvelle unit√© √† systemd, vous devez d√©crire sa configuration dans un fichier .service distinct et placer ce fichier dans l'un des dossiers sp√©ciaux, par exemple, dans </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, l'unit√© peut √™tre lanc√©e et activer le chargement automatique pour elle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paquet</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lors de l'installation, il cr√©era automatiquement un fichier avec la configuration de l'unit√© - il vous suffit de vous assurer qu'il est en cours d'ex√©cution et qu'il s'allume au d√©marrage du syst√®me. </font><font style="vertical-align: inherit;">Pour Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera cr√©√© par Ansible. </font><font style="vertical-align: inherit;">Le symbole </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le nom indique √† systemd que l'unit√© est un mod√®le. </font><font style="vertical-align: inherit;">Cela vous permet de d√©marrer le service </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un param√®tre - par exemple, avec le nom de notre service, qui sera remplac√© √† la place du </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier de configuration de l'unit√©:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le r√¥le</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©n√©rera un fichier √† partir du mod√®le </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† l'adresse </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, enregistrera l'application en tant que service lanc√© automatiquement </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et appliquera la migration. </font><font style="vertical-align: inherit;">Lorsque les r√¥les sont pr√™ts, vous devez d√©crire le playbook.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste des h√¥tes, ainsi que les variables utilis√©es dans les r√¥les, peuvent √™tre sp√©cifi√©es dans le fichier d'inventaire </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois tous les fichiers Ansible pr√™ts, ex√©cutez-le:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä propos des tests de r√©sistance</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.     :      ,    ‚Äî   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( ‚Äî 95 ,  ‚Äî ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      ‚Äî     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que peut-on faire d'autre?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le profilage de l'application a montr√© qu'environ un quart du temps total d'ex√©cution des requ√™tes est consacr√© √† la s√©rialisation et √† la d√©s√©rialisation de JSON: de nombreuses donn√©es sont envoy√©es et re√ßues du service. </font><font style="vertical-align: inherit;">Ces processus peuvent √™tre consid√©rablement acc√©l√©r√©s √† l'aide de la biblioth√®que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais le service devra √™tre un peu pr√©par√© - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il ne s'agit pas d'un remplacement </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">direct</font></a><font style="vertical-align: inherit;"> pour le module standard. </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, la production n√©cessite plusieurs copies du service pour garantir la tol√©rance aux pannes et faire face √† la charge. </font><font style="vertical-align: inherit;">Pour g√©rer un groupe de services, vous avez besoin d'un outil qui indique si une copie du service est "vivante". </font><font style="vertical-align: inherit;">Ce probl√®me peut √™tre r√©solu par un gestionnaire </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui interroge toutes les ressources n√©cessaires au travail, dans notre cas, une base de donn√©es. </font><font style="vertical-align: inherit;">Si</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ex√©cut√© en moins d'une seconde, puis le service est vivant. Sinon, vous devez y pr√™ter attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une application fonctionne de mani√®re tr√®s intensive avec un r√©seau, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut augmenter froidement les performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un facteur important est la lisibilit√© du code. Un de mes coll√®gues, Yuri Shikanov, a √©crit un module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> combinant plusieurs outils </font><font style="vertical-align: inherit;">pour la v√©rification automatique et l'ex√©cution de code, qui est facile √† ajouter √† un </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hook Git, mis en place avec un seul fichier de configuration ou des variables d'environnement. Gray vous permet de trier les importations ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), optimise les expressions python en fonction des nouvelles versions du langage ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), ajoute des virgules √† la fin des appels de fonction, les importations, les listes, etc. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-virgule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), ainsi que des guillemets √† un seul formulaire ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unifier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour moi: nous avons d√©velopp√©, couvert de tests, assembl√© et d√©ploy√© le service, et √©galement effectu√© des tests de charge.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remerciements</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voudrais exprimer ma profonde gratitude aux gars qui ont pris le temps de participer √† la r√©daction de cet article, de revoir le code, de pr√©senter mes id√©es et commentaires: √† Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et surtout √† Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499518/index.html">La vid√©oconf√©rence est d√©sormais un march√© et de nouvelles technologies. Longrid, premi√®re partie</a></li>
<li><a href="../fr499522/index.html">Toutes les innovations de Windows 10 2004 (20H1)</a></li>
<li><a href="../fr499524/index.html">Quarkus: mises √† niveau d'applications utilisant l'exemple helloworld de JBoss EAP Quickstart</a></li>
<li><a href="../fr499528/index.html">Un pont math√©matique "√©tonnant" qui s'√©tend au-del√† du grand th√©or√®me de Fermat</a></li>
<li><a href="../fr499532/index.html">Les mots en chiffres: blog gratuit analytics habravebinary avec Yandex.Metrica</a></li>
<li><a href="../fr499536/index.html">Growbox comme m√©thode de se conna√Ætre</a></li>
<li><a href="../fr499540/index.html">Fonctionnement du rendu de jeu 3D: texturation et filtrage de texture</a></li>
<li><a href="../fr499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../fr499544/index.html">Apprenez les r√©seaux de neurones dans Google Sheets</a></li>
<li><a href="../fr499546/index.html">D√©veloppement de firmware pour une cam√©ra vid√©o analogique EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>