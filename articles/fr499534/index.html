<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🍳 🙏🏼 🐥 Guide de développement du service backend Python 😩 ⛹🏽 🏇🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, je m'appelle Alexander Vasin, je suis développeur backend à Edadil. L'idée de ce matériel a commencé avec le fait que je voulais analyser le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guide de développement du service backend Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, je m'appelle Alexander Vasin, je suis développeur backend à Edadil. L'idée de ce matériel a commencé avec le fait que je voulais analyser le travail d'introduction ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dans l'école de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">développement</font></a><font style="vertical-align: inherit;"> Yandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Backend</font></a><font style="vertical-align: inherit;"> . J'ai commencé à décrire toutes les subtilités du choix de certaines technologies, la méthodologie de test ... Il s'est avéré ne pas être du tout une analyse, mais un guide très détaillé sur la façon d'écrire des backends en Python. De l'idée initiale, il n'y avait que des exigences pour le service, sur l'exemple duquel il est pratique de démonter les outils et les technologies. En conséquence, je me suis réveillé sur cent mille caractères. Il fallait tellement de choses pour tout examiner en détail. Ainsi, le programme pour les 100 prochains kilo-octets: comment construire un backend de service, du choix des outils au déploiement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voici </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un représentant GitHub avec application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et qui aime les (vrais) longs livres - s'il vous plaît, sous cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons développer et tester le service API REST en Python, le placer dans un conteneur Docker léger et le déployer à l'aide d'Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez implémenter le service API REST de différentes manières à l'aide de différents outils. </font><font style="vertical-align: inherit;">La solution décrite n'est pas la seule bonne, j'ai choisi la mise en œuvre et les outils en fonction de mon expérience et de mes préférences personnelles.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'on fait?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels outils choisir?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développement</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi avez-vous besoin de commencer avec setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment spécifier des versions de dépendances?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de données</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous concevons le schéma</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décrire le schéma dans SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personnaliser Alembic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous générons des migrations</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sérialisation des données</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblée</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployer</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test de résistance</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que peut-on faire d'autre?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalement</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'on fait?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez qu'une boutique de cadeaux en ligne prévoit de lancer une action dans différentes régions. </font><font style="vertical-align: inherit;">Pour qu'une stratégie de vente soit efficace, une analyse de marché est nécessaire. </font><font style="vertical-align: inherit;">Le magasin a un fournisseur qui envoie régulièrement (par exemple, par courrier) le déchargement des données avec des informations sur les résidents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Développons un service d'API REST Python qui analysera les données fournies et identifiera la demande de cadeaux de résidents de différents groupes d'âge dans différentes villes par mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous implémentons les gestionnaires suivants dans le service:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoute un nouveau téléchargement avec des données;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Renvoie les résidents de la sortie spécifiée;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifie les informations sur le résident (et ses proches) dans le déchargement spécifié;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous écrivons donc un service en Python en utilisant des frameworks, des bibliothèques et des SGBD familiers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 conférences du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cours vidéo, divers SGBD et leurs fonctionnalités sont décrits. Pour ma mise en œuvre, j'ai choisi le SGBD </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'est imposé comme une solution fiable avec une excellente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation en russe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une forte communauté russe (vous pouvez toujours trouver la réponse à une question en russe), et même </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des cours gratuits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le modèle relationnel est assez polyvalent et bien compris par de nombreux développeurs. Bien que la même chose puisse être faite sur n'importe quel SGBD NoSQL, dans cet article, nous considérerons PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal du service - la transmission de données sur le réseau entre la base de données et les clients - n'implique pas une charge importante sur le processeur, mais nécessite la capacité de traiter plusieurs demandes à la fois. Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 conférences</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considérées comme une approche asynchrone. Il vous permet de servir efficacement plusieurs clients dans le même processus de système d'exploitation (contrairement, par exemple, au modèle de pré-fork utilisé dans Flask / Django, qui crée plusieurs processus pour traiter les demandes des utilisateurs, chacun consomme de la mémoire, mais est inactif la plupart du temps ) Par conséquent, en tant que bibliothèque pour l'écriture du service, j'ai choisi l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asynchrone </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
La </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">5e conférence du</font></a><font style="vertical-align: inherit;"> cours vidéo raconte que </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de décomposer des requêtes complexes en parties, de les réutiliser, de générer des requêtes avec un ensemble dynamique de champs (par exemple, le processeur PATCH permet la mise à jour partielle d'un résident avec des champs arbitraires) et de se concentrer directement sur la logique métier. Le pilote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg peut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gérer ces demandes et transférer les données le plus rapidement possible </font><font style="vertical-align: inherit;">, et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les aidera à se faire des amis </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon outil préféré pour gérer l'état de la base de données et travailler avec les migrations est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Au fait, j'en ai récemment parlé à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscou Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La logique de validation a été succinctement décrite par les programmes de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guimauve</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y compris les vérifications des liens familiaux). Utilisation du module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai lié des gestionnaires et des schémas aiohttp pour la validation des données, et le bonus était de générer de la documentation au format </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de l'afficher dans une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface graphique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les tests d'écriture, j'ai choisi </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, plus à ce sujet en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 conférences</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour déboguer et profiler ce projet, j'ai utilisé le débogueur PyCharm ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cours 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7, la conférence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> décrit comment n'importe quel ordinateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou même sur un système d'exploitation différent) peut fonctionner en mode pack sans avoir à ajuster l'environnement d'application pour démarrer et facile à installer / mettre à jour / supprimer l'application sur le serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le déploiement, j'ai choisi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il vous permet de décrire de manière déclarative l'état souhaité du serveur et de ses services, fonctionne via ssh et ne nécessite pas de logiciel spécial.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Développement</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé de donner un nom au package Python </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et d'utiliser la structure suivante: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le fichier, </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai posté des informations générales sur le package: description ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docstring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), version, licence, contacts développeur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il peut être consulté avec l'aide intégrée</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le package a deux points d'entrée - le service API REST ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et l'utilitaire de gestion d'état de la base de données ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Les fichiers sont appelés </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour une raison - tout d'abord, un tel nom attire l'attention, il indique clairement que le fichier est un point d'entrée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxièmement, grâce à cette approche des points d'entrée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi avez-vous besoin de commencer avec setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'avenir, nous réfléchirons à la façon de distribuer l'application: elle peut être emballée dans une archive zip (ainsi que wheel / egg-), un package rpm, un fichier pkg pour macOS et installé sur un ordinateur distant, une machine virtuelle, MacBook ou Docker- récipient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal du fichier </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est de décrire le package avec l'application pour </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Le fichier doit contenir des informations générales sur le package (nom, version, auteur, etc.), mais vous pouvez également y spécifier les modules requis pour le travail, les dépendances «supplémentaires» (par exemple, pour les tests), les points d'entrée (par exemple, les commandes exécutables ) et les exigences de l'interprète. </font><font style="vertical-align: inherit;">
Les plugins Setuptools vous permettent de collecter des artefacts à partir du package décrit. Il existe des plugins intégrés: zip, egg, rpm, paquet macOS. Les plugins restants sont distribués via PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">wheel</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fin de compte, en décrivant un fichier, nous obtenons de grandes opportunités. </font><font style="vertical-align: inherit;">C'est pourquoi le développement d'un nouveau projet doit commencer </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fonction, </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les modules dépendants sont indiqués par une liste:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais j'ai décrit les dépendances dans des fichiers séparés </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont le contenu est utilisé dans </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il me semble plus flexible, en plus il y a un secret: plus tard, il vous permettra de construire une image Docker plus rapidement. </font><font style="vertical-align: inherit;">Les dépendances seront définies en tant qu'étape distincte avant d'installer l'application elle-même et lors de la reconstruction du conteneur Docker, il se trouve dans le cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvoir lire les dépendances des fichiers </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la fonction s'écrit:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est intéressant de </font><font style="vertical-align: inherit;">noter que </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lorsque la distribution des sources d'assemblage par défaut inclut uniquement les fichiers d'assemblage </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour un fichier de dépendance </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frapper le sac, ils doivent être clairement spécifiés dans le fichier </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py entièrement</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez installer le projet en mode développement à l'aide de la commande suivante (en mode éditable, Python n'installera pas le package entier dans un dossier </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais créera uniquement des liens, donc toutes les modifications apportées aux fichiers du package seront immédiatement visibles):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment spécifier des versions de dépendances?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est formidable lorsque les développeurs travaillent activement sur leurs packages - les bogues y sont activement corrigés, de nouvelles fonctionnalités apparaissent et les commentaires peuvent être obtenus plus rapidement. Mais parfois, les changements dans les bibliothèques dépendantes ne sont pas rétrocompatibles et peuvent entraîner des erreurs dans votre application si vous n'y pensez pas au préalable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, pour chaque package dépendant, vous pouvez spécifier une version spécifique </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, l'application sera garantie d'être construite spécifiquement avec les versions des bibliothèques dépendantes avec lesquelles elle a été testée. Mais cette approche a un inconvénient - si les développeurs corrigent un bogue critique dans un package dépendant qui n'affecte pas la compatibilité descendante, ce correctif n'entrera pas dans l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une approche pour le contrôle de version </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version sémantique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui suggère de soumettre la version au format </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - augmente lorsque des modifications incompatibles vers l'arrière sont ajoutées;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Augmente lors de l'ajout de nouvelles fonctionnalités avec prise en charge de la compatibilité descendante;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - augmente lors de l'ajout de corrections de bogues avec prise en charge de la compatibilité descendante.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si un paquet dépendant suit cette approche (dont les auteurs sont généralement signalés dans les fichiers README et Changelog), il suffit de fixer la valeur de </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de limiter la valeur minimale pour PATCH version: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle exigence peut être implémentée à l'aide de l'opérateur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par exemple, cela </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permettra à PIP de s'installer pour la </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version 3.6.3, mais pas 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous spécifiez l'intervalle des versions de dépendance, cela donnera un avantage supplémentaire - il n'y aura pas de conflits de version entre les bibliothèques dépendantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous développez une bibliothèque qui nécessite un package de dépendance différent, autorisez-le non pas une version spécifique, mais un intervalle. </font><font style="vertical-align: inherit;">Il sera alors beaucoup plus facile pour les utilisateurs de votre bibliothèque de l'utiliser (tout d'un coup leur application nécessite le même package de dépendance, mais d'une version différente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le versioning sémantique n'est qu'un accord entre les auteurs et les consommateurs de packages. </font><font style="vertical-align: inherit;">Cela ne garantit pas que les auteurs écrivent du code sans bogues et ne peuvent pas faire d'erreur dans la nouvelle version de leur package.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de données</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous concevons le schéma</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La description du gestionnaire POST / imports fournit un exemple de déchargement avec des informations sur les résidents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple de téléchargement</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première pensée a été de stocker toutes les informations sur le résident dans une seule table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, où la relation serait représentée par un champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forme d'une liste d'entiers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais cette méthode présente plusieurs inconvénients</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, j'ai décidé de rassembler toutes les données nécessaires au travail sous une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">troisième forme normale</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et la structure suivante a été obtenue:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le tableau des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importations se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compose d'une colonne à incrémentation automatique </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est nécessaire de créer une vérification de clé étrangère dans le tableau </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La table des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citoyens</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stocke </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des données scalaires</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le résident (tous les champs sauf les informations sur les relations familiales). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une paire ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">est utilisée comme clé primaire </font><font style="vertical-align: inherit;">, garantissant l'unicité des résidents </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le cadre </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une clé étrangère </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">garantit que le champ </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient uniquement les déchargements existants.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette structure garantit l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intégrité des données à l'aide des outils PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , elle vous permet d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenir efficacement des résidents avec des proches</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la base de données, mais est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soumise à une condition</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de concurrence lors de la mise à jour des informations sur les résidents avec des requêtes compétitives (nous examinerons de plus près la mise en œuvre du gestionnaire PATCH).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décrire le schéma dans SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chapitre 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai expliqué comment créer des requêtes à l'aide de SQLAlchemy, vous devez décrire le schéma de la base de données à l'aide d'objets spéciaux: les tables sont décrites à l'aide </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et liées à un registre </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui stocke toutes les méta-informations sur la base de données. Soit dit en passant, le registre </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut non seulement stocker les méta-informations décrites en Python, mais également représenter l'état réel de la base de données sous la forme d'objets SQLAlchemy. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fonctionnalité permet également à Alembic de comparer les conditions et de générer automatiquement un code de migration.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, chaque base de données a son propre schéma de dénomination des contraintes par défaut. </font><font style="vertical-align: inherit;">Pour que vous ne perdiez pas de temps à nommer de nouvelles contraintes ou à rechercher / rappeler quelle contrainte vous êtes sur le point de supprimer, SQLAlchemy suggère d'utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modèles de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">dénomination pour les conventions de dénomination</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ils peuvent être définis dans le registre </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer un registre MetaData et lui passer des modèles de dénomination</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous spécifiez des modèles de dénomination, Alembic les utilisera lors de la génération automatique des migrations et nommera toutes les contraintes en fonction d'eux. </font><font style="vertical-align: inherit;">À l'avenir, le registre créé </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera nécessaire pour décrire les tables:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous décrivons le schéma de base de données avec des objets SQLAlchemy</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personnaliser Alembic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le schéma de la base de données est décrit, il est nécessaire de générer des migrations, mais pour cela, vous devez d'abord configurer Alembic, qui est également abordé au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chapitre 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour utiliser la commande </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous devez effectuer les étapes suivantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer le paquet: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize Alambic: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette commande créera un fichier de configuration </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et un dossier </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec le contenu suivant:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Appelé chaque fois que vous démarrez Alembic. </font><font style="vertical-align: inherit;">Se connecte au registre Alembic </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une description de l'état souhaité de la base de données et contient des instructions pour démarrer les migrations.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le modèle sur la base duquel les migrations sont générées.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le dossier dans lequel Alembic recherchera (et générera) les migrations.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Spécifiez l'adresse de la base de données dans le fichier alembic.ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spécifiez une description de l'état souhaité de la base de données (registre </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) afin qu'Alembic puisse générer automatiquement des migrations:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic est configuré et peut déjà être utilisé, mais dans notre cas, cette configuration présente plusieurs inconvénients:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilitaire </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recherche </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le répertoire de travail actuel. </font><font style="vertical-align: inherit;">Vous </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvez spécifier le </font><font style="vertical-align: inherit;">chemin d'accès à l' </font><font style="vertical-align: inherit;">argument de ligne de commande, mais cela n'est pas pratique: je veux pouvoir appeler la commande à partir de n'importe quel dossier sans paramètres supplémentaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour configurer Alembic pour fonctionner avec une base de données spécifique, vous devez modifier le fichier </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il serait beaucoup plus pratique de spécifier les paramètres de base de données pour la variable d'environnement et / ou un argument de ligne de commande, par exemple </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le nom de l'utilitaire </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne correspond pas très bien au nom de notre service (et l'utilisateur peut en fait ne pas avoir du tout Python et ne rien savoir sur Alembic). </font><font style="vertical-align: inherit;">Il serait beaucoup plus pratique pour l'utilisateur final que toutes les commandes exécutables du service aient un préfixe commun, par exemple </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces problèmes sont résolus avec un petit wrapper. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic utilise un module standard pour traiter les arguments de ligne de commande </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il vous permet d'ajouter un argument facultatif </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur par défaut à partir d'une variable d'environnement </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le chemin d'accès au fichier </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut être calculé par rapport à l'emplacement du fichier exécutable et non au répertoire de travail actuel de l'utilisateur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilitaire de gestion de l'état de la base de données</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est prêt, il peut être enregistré en </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tant que commande exécutable avec un nom compréhensible pour l'utilisateur final, par exemple </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enregistrez une commande exécutable dans setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir réinstallé le module, un fichier sera généré </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et la commande </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deviendra disponible:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous générons des migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour générer des migrations, deux états sont requis: l'état souhaité (que nous avons décrit avec des objets SQLAlchemy) et l'état réel (la base de données, dans notre cas, est vide). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé que le moyen le plus simple d'augmenter Postgres était avec Docker, et pour plus de commodité, j'ai ajouté une commande </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui exécute un conteneur en arrière-plan avec PostgreSQL sur le port 5432:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Augmentez PostgreSQL et générez la migration</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic fait généralement un bon travail de routine pour générer des migrations, mais je voudrais attirer l'attention sur les points suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les types de données utilisateur spécifiés dans les tables créées sont créés automatiquement (dans notre cas - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais le code pour les supprimer n'est </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas généré. </font><font style="vertical-align: inherit;">Si vous appliquez, annulez, puis appliquez à nouveau la migration, cela provoquera une erreur car le type de données spécifié existe déjà.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimer le type de données de genre dans la méthode de rétrogradation</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la méthode, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certaines actions peuvent parfois être supprimées (si nous supprimons la table entière, vous ne pouvez pas supprimer ses index séparément):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exemple</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la migration est fixe et prête, nous l'appliquons:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer à créer des gestionnaires, vous devez configurer l'application aiohttp.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous regardez le démarrage rapide aiohttp, vous pouvez écrire quelque chose comme ceci</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code soulève un certain nombre de questions et présente un certain nombre d'inconvénients:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment configurer l'application? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au minimum, vous devez spécifier l'hôte et le port de connexion des clients, ainsi que les informations de connexion à la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'aime vraiment résoudre ce problème avec l'aide du module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: il étend le standard </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et permet d'utiliser des arguments de ligne de commande, des variables d'environnement (indispensables pour configurer les conteneurs Docker) et même des fichiers de configuration (ainsi que la combinaison de ces méthodes) pour la configuration. </font><font style="vertical-align: inherit;">En l'utilisant </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez également valider les valeurs des paramètres de configuration d'application.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de traitement des paramètres à l'aide de ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             — ,    «»     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   —    )    ,      <code>nobody</code>.      —     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les réponses de gestionnaire réussies seront renvoyées au format JSON. </font><font style="vertical-align: inherit;">Il serait également pratique pour les clients de recevoir des informations sur les erreurs sous une forme sérialisée (par exemple, pour voir quels champs n'ont pas passé la validation). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propose une méthode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui prend un objet, le sérialise en JSON et renvoie un nouvel objet </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un en-tête </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et des données sérialisées à l'intérieur.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment sérialiser des données à l'aide de json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il existe un autre moyen: aiohttp vous permet d'enregistrer un sérialiseur arbitraire pour un type spécifique de données de réponse dans le registre </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez spécifier un sérialiseur </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour les objets de type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, il suffira que le gestionnaire retourne un objet </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les données de réponse dans le paramètre </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp trouvera un sérialiseur qui correspond au type de données et sérialisera la réponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outre le fait que la sérialisation des objets est décrite en un seul endroit, cette approche est également plus flexible - elle vous permet d'implémenter des solutions très intéressantes (nous considérerons l'un des cas d'utilisation dans le gestionnaire </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment sérialiser des données à l'aide de aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de comprendre que </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, par exemple </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ils utilisent une </font><font style="vertical-align: inherit;">méthode </font><font style="vertical-align: inherit;">standard </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui ne peut pas sérialiser des types de données complexes, par exemple, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie des enregistrements de la base de données en tant qu'instances de cette classe). </font><font style="vertical-align: inherit;">De plus, certains objets complexes peuvent en contenir d'autres: dans un enregistrement de la base de données, il peut y avoir un champ type </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les développeurs Python ont résolu ce problème: la méthode </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet d'utiliser l'argument </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour spécifier une fonction qui est appelée lorsqu'il est nécessaire de sérialiser un objet inconnu. </font><font style="vertical-align: inherit;">La fonction devrait convertir un objet inconnu en un type qui peut sérialiser le module json.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment étendre JsonPayload pour sérialiser des objets arbitraires</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      —  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttp vous permet d'implémenter des gestionnaires avec des fonctions et classes asynchrones. </font><font style="vertical-align: inherit;">Les classes sont plus extensibles: premièrement, le code appartenant à un gestionnaire peut être placé à un endroit, et deuxièmement, les classes vous permettent d'utiliser l'héritage pour vous débarrasser de la duplication de code (par exemple, chaque gestionnaire nécessite une connexion à la base de données).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe de base du gestionnaire</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme il est difficile de lire un gros fichier, j'ai décidé de diviser les gestionnaires en fichiers. </font><font style="vertical-align: inherit;">Les petits fichiers encouragent une faible connectivité et, par exemple, s'il y a des importations en anneau à l'intérieur des gestionnaires, cela signifie que quelque chose ne va pas dans la composition des entités.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire d'entrée reçoit json avec des données sur les résidents. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La taille de requête maximale autorisée</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans aiohttp est contrôlée par l'option </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhgM96xEtxuNqLAsnOFyqLZm0SnDiA#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est de 2 Mo par défaut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si la limite est dépassée, aiohttp retournera une réponse HTTP avec un état de 413: Erreur d'entité trop grande demandée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En même temps, le json correct avec les lignes et les nombres les plus longs pèsera ~ 63 mégaoctets, donc les restrictions sur la taille de la demande doivent être étendues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vérifier et désérialiser les données</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . S'ils sont incorrects, vous devez renvoyer une réponse HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais besoin de deux régimes </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le premier </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vérifie les données de chaque résident individuel et désérialise également la chaîne joyeux anniversaire dans l'objet </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type de données, format et disponibilité de tous les champs obligatoires;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manque de champs inconnus;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance doit être indiquée dans le format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne peut avoir aucune signification pour l'avenir;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La liste des proches de chaque résident doit contenir des identifiants uniques des résidents présents dans ce téléchargement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxième schéma </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,, vérifie le déchargement dans son ensemble:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> chaque résident du déchargement doit être unique;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les liens familiaux doivent être à double sens (si le résident n ° 1 a un résident n ° 2 dans la liste des parents, le résident n ° 2 doit également avoir un parent n ° 1).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si les données sont correctes, elles doivent être ajoutées à la base</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><strong><font style="vertical-align: inherit;">données</font></strong><font style="vertical-align: inherit;"> avec une nouvelle unique </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ajouter des données, vous devrez effectuer plusieurs requêtes dans différentes tables. </font><font style="vertical-align: inherit;">Afin d'éviter des données partiellement partiellement ajoutées dans la base de données en cas d'erreur ou d'exception (par exemple, lorsque vous déconnectez un client qui n'a pas reçu de réponse complète, aiohttp lèvera </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une exception CancelledError</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez utiliser une transaction</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est nécessaire d'ajouter des données aux tables par parties</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car dans une requête à PostgreSQL, il ne peut y avoir plus de 32 767 arguments. </font><font style="vertical-align: inherit;">Il y a </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 champs </font><font style="vertical-align: inherit;">dans le tableau </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par conséquent, pour 1 requête, seules 32 767/9 = 3 640 lignes peuvent être insérées dans ce tableau, et en un téléchargement, il peut y avoir jusqu'à 10 000 habitants.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire renvoie tous les résidents pour déchargement avec le spécifié </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">téléchargement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> spécifié </font><b><font style="vertical-align: inherit;">n'existe pas</font></b><font style="vertical-align: inherit;"> , vous devez renvoyer la réponse HTTP 404: Not Found. </font><font style="vertical-align: inherit;">Ce comportement semble être courant pour les gestionnaires qui ont besoin d'un déchargement existant, j'ai donc extrait le code de vérification dans une classe distincte.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe de base pour les gestionnaires avec déchargements</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir une liste de parents pour chaque résident, vous devrez effectuer </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en table </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en agrégeant le champ </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regroupé par </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le résident n'a pas de parents, il </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retournera la </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeur </font><font style="vertical-align: inherit;">pour lui sur le terrain </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et, à la suite de l'agrégation, la liste des parents ressemblera </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour corriger cette valeur incorrecte, j'ai utilisé la fonction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de données stocke la date dans un format </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais nous avons besoin d'un format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Techniquement, vous pouvez formater la date avec une requête SQL ou du côté Python au moment de la sérialisation de la réponse avec </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg renvoie la valeur du champ en </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tant </font><font style="vertical-align: inherit;">qu'instance </font><font style="vertical-align: inherit;">de la classe</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai choisi la sérialisation côté Python, étant donné que c'est </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le seul objet </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du projet avec un seul format (voir la section </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Sérialisation des données»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le fait que le processeur exécute deux requêtes (vérification de l'existence d'un déchargement et d'une demande de liste de résidents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'est pas nécessaire d'utiliser une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par défaut, PostgreSQL utilise le niveau d'isolement, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et même au sein d'une transaction, toutes les modifications apportées à d'autres transactions terminées avec succès seront visibles (ajout de nouvelles lignes, modification de celles existantes).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le téléchargement le plus important dans une vue texte peut prendre environ 63 mégaoctets, ce qui est beaucoup, surtout si l'on considère que plusieurs demandes de réception de données peuvent arriver en même temps. </font><font style="vertical-align: inherit;">Il existe un moyen assez intéressant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'obtenir des données de la base de données à l'aide du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curseur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de les envoyer au client en plusieurs parties</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, nous devons implémenter deux objets:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui renvoie des enregistrements de la base de données. </font><font style="vertical-align: inherit;">Au premier appel, il se connecte à la base de données, ouvre une transaction et crée un curseur; lors d'une nouvelle itération, il renvoie les enregistrements de la base de données. </font><font style="vertical-align: inherit;">Il est retourné par le gestionnaire.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code SelectQuery</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un sérialiseur </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui peut parcourir les générateurs asynchrones, sérialiser les données d'un générateur asynchrone vers JSON et envoyer des données aux clients en plusieurs parties. </font><font style="vertical-align: inherit;">Il est enregistré </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme sérialiseur d'objets </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code AsyncGenJSONListPayload</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans le gestionnaire, il sera possible de créer un objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de lui passer une requête SQL et une fonction pour ouvrir la transaction et la renvoyer à </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code gestionnaire</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il détecte un </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sérialiseur </font><font style="vertical-align: inherit;">enregistré </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour les objets de type </font><font style="vertical-align: inherit;">dans le registre </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, le sérialiseur parcourt l'objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et envoie des données au client. Lors du premier appel, l'objet </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reçoit une connexion à la base de données, ouvre une transaction et crée un curseur; lors d'une nouvelle itération, il recevra les données de la base de données avec le curseur et les renverra ligne par ligne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche permet de ne pas allouer de mémoire pour la totalité du volume de données à chaque requête, mais elle a une particularité: l'application ne pourra pas renvoyer l'état HTTP correspondant au client en cas d'erreur (après tout, l'état HTTP, les en-têtes ont déjà été envoyés au client et les données sont en cours d'écriture).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une exception se produit, il ne reste plus qu'à se déconnecter. </font><font style="vertical-align: inherit;">Une exception, bien sûr, peut être sécurisée, mais le client ne pourra pas comprendre exactement quelle erreur s'est produite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'un autre côté, une situation similaire peut se produire même si le processeur reçoit toutes les données de la base de données, mais le réseau clignote lors de la transmission des données au client - personne n'est à l'abri de cela.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire reçoit l'identifiant du déchargement </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le résident </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ainsi que json avec les nouvelles données sur le résident. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déchargement inexistant ou d'un résident</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une réponse HTTP doit être retournée </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les données transmises par le client doivent être </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vérifiées et désérialisées</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">S'ils sont incorrects, vous devez renvoyer une réponse HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai implémenté un schéma Marshmallow </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui vérifie:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le type et le format des données pour les champs spécifiés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date de naissance. </font><font style="vertical-align: inherit;">Il doit être spécifié dans un format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne peut être significatif à l'avenir.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une liste des proches de chaque résident. </font><font style="vertical-align: inherit;">Il doit avoir des identifiants uniques pour les résidents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'existence des parents indiqués dans le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut pas être vérifiée séparément: si un </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">résident inexistant est </font><font style="vertical-align: inherit;">ajouté à la table, </font><font style="vertical-align: inherit;">PostgreSQL renvoie une erreur </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui peut être traitée et le statut HTTP peut être retourné </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quel statut doit être retourné si le client a envoyé </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des données incorrectes pour un résident inexistant ou un déchargement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Il est sémantiquement plus correct de vérifier d'abord l'existence d'un déchargement et d'un résident (s'il n'y en a pas, retour </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et ensuite seulement si le client a envoyé les données correctes (sinon, retour </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). En pratique, il est souvent moins coûteux de vérifier d'abord les données, et seulement si elles sont correctes, d'accéder à la base de données.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux options sont acceptables, mais j'ai décidé de choisir une deuxième option moins chère, car dans tous les cas, le résultat de l'opération est une erreur qui n'affecte rien (le client corrigera les données et découvrira ensuite que le résident n'existe pas). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les données sont correctes, il est nécessaire de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à </font><strong><font style="vertical-align: inherit;">jour les informations sur le résident dans la base de données</font></strong><font style="vertical-align: inherit;"> . Dans le gestionnaire, vous devrez effectuer plusieurs requêtes sur différentes tables. Si une erreur ou une exception se produit, les modifications apportées à la base de données doivent être annulées, de sorte que les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requêtes doivent être effectuées dans une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de transférer uniquement certains champs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour un résident.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit être écrit de telle manière qu'il ne se bloque pas lors de l'accès aux données que le client n'a pas spécifié et n'exécute pas non plus les requêtes sur les tables dans lesquelles les données n'ont pas changé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le client a précisé le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il est nécessaire d'obtenir une liste des proches existants. S'il a changé, déterminez les enregistrements de la table qui </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doivent être supprimés et ceux à ajouter afin d'aligner la base de données sur la demande du client. Par défaut, PostgreSQL utilise l'isolement des transactions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela signifie que dans le cadre de la transaction en cours, les modifications seront visibles pour les enregistrements existants (ainsi que les nouveaux) des autres transactions terminées. Cela peut conduire à </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une condition de concurrence entre les demandes concurrentielles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'il y ait un déchargement avec les résidents</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sans parenté. Le service reçoit deux demandes simultanées de changement de résident n ° 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp créera deux gestionnaires qui recevront simultanément l'état actuel du résident de PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque gestionnaire ne détectera pas une seule relation associée et décidera d'ajouter une nouvelle relation avec le parent spécifié. En conséquence, le résident n ° 1 a le même domaine que les proches </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce comportement ne peut pas être qualifié d'évident. Deux options sont prévues pour décider du résultat de la course: pour terminer uniquement la première demande, et pour la seconde, renvoyer une réponse HTTP </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(afin que le client répète la demande), ou pour exécuter les demandes à tour de rôle (la deuxième demande ne sera traitée qu'après la fin de la première). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première option peut être implémentée en activant le mode d'isolement</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si au cours du traitement de la demande, quelqu'un a déjà réussi à modifier et à valider les données, une exception sera levée, qui peut être traitée et le statut HTTP correspondant retourné. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'inconvénient de cette solution - un grand nombre de verrous dans PostgreSQL, </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lèvera une exception, même si les requêtes concurrentielles modifient les enregistrements des résidents de différents déchargements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez également utiliser le mécanisme de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrouillage des recommandations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si vous obtenez un tel verrouillage </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, les demandes concurrentielles de différents déchargements pourront s'exécuter en parallèle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour traiter les demandes concurrentielles en un seul téléchargement, vous pouvez implémenter le comportement de l'une des options: la fonction </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">essaie d'obtenir un verrou et</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il renvoie le résultat booléen immédiatement (s'il n'était pas possible d'obtenir le verrou - une exception peut être levée), mais il </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attend que la </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ressource soit disponible pour le blocage (dans ce cas, les requêtes seront exécutées séquentiellement, j'ai opté pour cette option). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, le gestionnaire doit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoyer les informations actuelles sur le résident mis à jour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il a été possible de nous limiter au retour des données de sa demande au client (puisque nous renvoyons une réponse au client, cela signifie qu'il n'y a eu aucune exception et que toutes les demandes ont été traitées avec succès). Ou - utilisez le mot clé RETURNING dans les requêtes qui modifient la base de données et génèrent une réponse à partir des résultats. Mais ces deux approches ne nous permettraient pas de voir et de tester le cas de la race des États.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y avait aucune exigence de charge élevée pour le service, j'ai donc décidé de demander à nouveau toutes les données sur le résident et de renvoyer au client un résultat honnête de la base de données. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire calcule le nombre de cadeaux que chaque résident du déchargement recevra à ses proches (première commande). </font><font style="vertical-align: inherit;">Le numéro est groupé par mois pour le téléchargement avec le spécifié </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">téléchargement inexistant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une réponse HTTP doit être retournée </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux options de mise en œuvre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez des données pour les résidents avec des proches dans la base de données et du côté Python, agrégez les données par mois et générez des listes pour les mois pour lesquels il n'y a pas de données dans la base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilez une requête json dans la base de données et ajoutez des stubs pour les mois manquants.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai opté pour la première option - visuellement, elle semble plus compréhensible et prise en charge. Le nombre d'anniversaires dans un mois donné peut être obtenu en faisant </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du tableau avec les liens familiaux ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le résident pour lequel nous considérons les anniversaires des proches) dans le tableau </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(contenant la date de naissance à partir de laquelle vous souhaitez obtenir le mois). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les valeurs de mois ne doivent pas contenir de zéros en tête. Le mois obtenu à partir du champ </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisant la fonction </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut contenir un zéro non significatif. Pour l' </font><font style="vertical-align: inherit;">enlever, je fis </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la requête SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le fait que le gestionnaire doive répondre à deux demandes (vérifier l'existence du déchargement et obtenir des informations sur les anniversaires et les cadeaux), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucune transaction n'est requise</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par défaut, PostgreSQL utilise le mode READ COMMITTED, dans lequel tous les nouveaux enregistrements (ajoutés par d'autres transactions) et existants (modifiés par d'autres transactions) sont visibles dans la transaction en cours une fois qu'ils sont terminés avec succès. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, si un nouveau téléchargement est ajouté au moment de la réception des données, cela n'affectera pas les données existantes. </font><font style="vertical-align: inherit;">Si, au moment de la réception des données, une demande de changement de résident est satisfaite, soit les données ne seront pas encore visibles (si la transaction modifiant les données n'est pas terminée), soit la transaction se terminera complètement et toutes les modifications seront immédiatement visibles. </font><font style="vertical-align: inherit;">L'intégrité obtenue de la base de données ne sera pas violée.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire calcule les 50e, 75e et 99e centiles de l'âge (années entières) des résidents par ville dans l'échantillon avec l'id_import_id spécifié. </font><font style="vertical-align: inherit;">Dans le cas d'un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">téléchargement inexistant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , une réponse HTTP doit être retournée </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le fait que le processeur exécute deux requêtes (vérification de l'existence du déchargement et obtention d'une liste de résidents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'est pas nécessaire d'utiliser une transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux options de mise en œuvre:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez l'âge des résidents à partir de la base de données, regroupés par ville, puis du côté Python, calculez les centiles en utilisant numpy (qui est spécifié comme référence dans la tâche) et arrondissez à deux décimales.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième option nécessite de transférer moins de données entre l'application et PostgreSQL, mais elle n'a pas d'écueil très évident: dans PostgreSQL, l'arrondi est mathématique, ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie 3), et en Python - comptabilité, à l'entier le plus proche ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retourne 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester le gestionnaire, l'implémentation doit être la même dans PostgreSQL et Python (l'implémentation d'une fonction avec arrondi mathématique en Python semble plus facile). </font><font style="vertical-align: inherit;">Il convient de noter que lors du calcul des centiles, numpy et PostgreSQL peuvent renvoyer des nombres légèrement différents, mais en tenant compte de l'arrondissement, cette différence ne sera pas perceptible.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essai</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faut-il vérifier dans cette application? Premièrement, que les gestionnaires répondent aux exigences et effectuent le travail requis dans un environnement aussi proche que possible de l'environnement de combat. Deuxièmement, les migrations qui modifient l'état de la base de données fonctionnent sans erreur. Troisièmement, il existe un certain nombre de fonctions auxiliaires qui pourraient également être correctement couvertes par des tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé d'utiliser le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">framework pytest en raison</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de sa flexibilité et de sa facilité d'utilisation. Il offre un mécanisme puissant pour préparer l'environnement aux tests - les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">luminaires</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est-à-dire qu'il fonctionne avec un décorateur</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont les noms peuvent être spécifiés par le paramètre du test. </font><font style="vertical-align: inherit;">Si pytest détecte un paramètre avec un nom de luminaire dans l'annotation de test, il exécutera ce luminaire et transmettra le résultat dans la valeur de ce paramètre. </font><font style="vertical-align: inherit;">Et si le luminaire est un générateur, le paramètre de test prendra la valeur renvoyée </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et une fois le test terminé, la deuxième partie du </font><font style="vertical-align: inherit;">luminaire sera </font><font style="vertical-align: inherit;">exécutée, ce qui peut effacer les ressources ou fermer les connexions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la plupart des tests, nous avons besoin d'une base de données PostgreSQL. </font><font style="vertical-align: inherit;">Pour isoler les tests les uns des autres, vous pouvez créer une base de données distincte avant chaque test et la supprimer après l'exécution.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer une base de données d'appareils pour chaque test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait un excellent travail de cette tâche </font><font style="vertical-align: inherit;">, en tenant compte des caractéristiques des différentes bases de données et pilotes. Par exemple, PostgreSQL ne permet pas l'exécution </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un bloc de transaction. Lors de la création d'une base de données, il </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traduit </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(qui exécute généralement toutes les demandes dans une transaction) en mode de validation automatique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre caractéristique importante: si au moins un client est connecté à PostgreSQL, la base de données ne peut pas être supprimée, mais </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déconnecte tous les clients avant de supprimer la base de données. La base de données sera supprimée avec succès même si un test avec des connexions actives s'y bloque.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons besoin de PostgreSQL dans différents états: pour tester les migrations, nous avons besoin d'une base de données propre, tandis que les gestionnaires exigent que toutes les migrations soient appliquées. </font><font style="vertical-align: inherit;">Vous pouvez modifier par programme l'état d'une base de données à l'aide des commandes Alembic; elles nécessitent l'objet de configuration Alembic pour les appeler.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer un objet de configuration de luminaire Alembic</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que les appareils </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont un paramètre </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permet non seulement d'indiquer la dépendance du test sur les appareils, mais aussi les dépendances entre appareils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce mécanisme vous permet de séparer de manière flexible la logique et d'écrire du code très concis et réutilisable.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestionnaires</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test des gestionnaires nécessite une base de données avec des tables et des types de données créés. Pour appliquer des migrations, vous devez appeler par programme la commande de mise à niveau d'Alembic. Pour l'appeler, vous avez besoin d'un objet avec la configuration Alembic, que nous avons déjà défini avec des fixtures </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La base de données avec migrations ressemble à une entité complètement indépendante, et elle peut être représentée comme un appareil:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'il y a de nombreuses migrations dans le projet, leur application pour chaque test peut prendre trop de temps. Pour accélérer le processus, vous pouvez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">créer une base de données avec des migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une fois </font><font style="vertical-align: inherit;">, puis l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliser comme modèle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de la base de données pour tester les gestionnaires, vous aurez besoin d'une application en cours d'exécution, ainsi que d'un client configuré pour fonctionner avec cette application. Pour rendre l'application facile à tester, j'ai mis sa création dans une fonction </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui prend des paramètres à exécuter: une base de données, un port pour l'API REST, et autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les arguments pour lancer l'application peuvent également être représentés comme un appareil distinct. Pour les créer, vous devrez déterminer le port libre pour exécuter l'application de test et l'adresse de la base de données temporaire migrée.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour déterminer le port libre, j'ai utilisé le luminaire </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du package aiomisc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un appareil standard </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conviendrait également, mais il renvoie une fonction pour déterminer les ports libres, tandis qu'il </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie immédiatement le numéro de port. </font><font style="vertical-align: inherit;">Pour notre application, nous devons déterminer un seul port libre, j'ai donc décidé de ne pas écrire une ligne de code supplémentaire avec un appel </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les tests avec des gestionnaires impliquent des demandes à l'API REST; travailler directement avec l'application n'est </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas requis. </font><font style="vertical-align: inherit;">Par conséquent, j'ai créé un appareil qui lance l'application et, en utilisant l'usine, </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crée et renvoie un client de test standard connecté à l'application </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, si vous spécifiez le luminaire dans les paramètres de test </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, les événements suivants se produisent:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les appareils peuvent éviter la duplication de code, mais en plus de préparer l'environnement dans les tests, il y a un autre endroit potentiel où il y aura beaucoup du même code - les demandes d'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, en faisant une demande, nous nous attendons à obtenir un certain statut HTTP. Deuxièmement, si l'état correspond à celui attendu, avant de travailler avec les données, vous devez vous assurer qu'elles ont le bon format. Il est facile de faire une erreur ici et d'écrire un gestionnaire qui effectue les calculs corrects et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie le résultat correct, mais ne passe pas la validation automatique en raison du format de réponse incorrect</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (par exemple, oubliez d'envelopper la réponse dans un dictionnaire avec une clé </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Toutes ces vérifications pourraient être effectuées en un seul endroit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le module</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J'ai préparé pour chaque gestionnaire une fonction d'aide qui vérifie l'état de HTTP, ainsi que le format de réponse à l'aide de Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé de commencer avec un gestionnaire qui renvoie des résidents, car il est très utile pour vérifier les résultats d'autres gestionnaires qui modifient l'état de la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai intentionnellement pas utilisé de code qui ajoute des données à la base de données du gestionnaire </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bien qu'il ne soit pas difficile d'en faire une fonction distincte. </font><font style="vertical-align: inherit;">Le code du gestionnaire a la propriété de changer et s'il y a une erreur dans le code qui s'ajoute à la base de données, il y a une chance que le test cesse de fonctionner comme prévu et implicitement pour les développeurs arrête d'afficher des erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce test, j'ai défini les ensembles de données de test suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec plusieurs proches. </font><font style="vertical-align: inherit;">Vérifie que pour chaque résident une liste avec les identifiants des proches sera correctement constituée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec un résident sans parents. </font><font style="vertical-align: inherit;">Vérifie que le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est une liste vide (en raison </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la requête SQL, la liste des parents peut être égale </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec un résident qui est un parent de lui-même.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement vide. </font><font style="vertical-align: inherit;">Vérifie que le gestionnaire autorise l'ajout de déchargement vide et ne se bloque pas avec une erreur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour exécuter le même test séparément à chaque téléchargement, j'ai utilisé un autre mécanisme Pytest très puissant - le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paramétrage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce mécanisme vous permet d'envelopper la fonction de test dans le décorateur </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de décrire les paramètres que la fonction de test doit prendre pour chaque cas de test individuel.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment paramétrer un test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le test ajoutera le téléchargement à la base de données, puis, à l'aide d'une demande au gestionnaire, il recevra des informations sur les résidents et comparera le téléchargement de référence avec celui reçu. Mais comment comparez-vous les résidents? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque résident se compose de champs scalaires et d'un champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une liste d'identifiants de parents. Une liste en Python est un type ordonné, et lors de la comparaison de l'ordre des éléments de chaque liste importe, mais lors de la comparaison des listes avec les frères et sœurs, l'ordre ne devrait pas avoir d'importance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous apportez </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à l'ensemble avant la comparaison, alors lors de la comparaison, cela ne fonctionne pas pour trouver une situation où l'un des habitants sur le terrain </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a des doublons. Si vous triez la liste avec les identifiants des proches, cela évitera le problème de l'ordre différent des identifiants des proches, mais en même temps détectera les doublons.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la comparaison de deux listes avec des résidents, l'un peut rencontrer un problème similaire: techniquement, l'ordre des résidents dans le déchargement n'est pas important, mais il est important de détecter s'il y a deux résidents avec les mêmes identifiants dans un déchargement et pas dans l'autre. </font><font style="vertical-align: inherit;">Ainsi, en plus d'organiser la liste avec des proches, les proches de chaque résident doivent organiser les résidents à chaque déchargement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque la tâche de comparer les résidents se posera plus d'une fois, j'ai mis en place deux fonctions: une pour comparer deux résidents, et la seconde pour comparer deux listes avec des résidents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparez les résidents</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que ce gestionnaire ne retourne pas les résidents d'autres déchargements, j'ai décidé d'ajouter un déchargement supplémentaire avec un habitant avant chaque test.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai défini les jeux de données suivants pour tester le gestionnaire:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Données correctes, censées être ajoutées avec succès à la base de données.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement vide </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit prendre en compte un tel cas et ne pas tomber, en essayant d'effectuer une insertion vide dans la table avec les habitants.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Données avec des erreurs, attendez-vous à une réponse HTTP de 400: Bad Request.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance est incorrecte (futur).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id n'est pas unique dans le téléchargement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une parenté est indiquée de manière incorrecte (il n'y a qu'un résident à l'autre, mais il n'y a pas de retour).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le résident a un parent inexistant au déchargement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les liens familiaux ne sont pas uniques.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le processeur a fonctionné correctement et que les données ont été ajoutées, vous devez ajouter les résidents à la base de données et les comparer avec le déchargement standard. </font><font style="vertical-align: inherit;">Pour obtenir des résidents, j'ai utilisé le gestionnaire déjà testé </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et, à titre de comparaison, une fonction </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citoyens / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La validation des données est à bien des égards similaire à celle décrite dans le gestionnaire </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à quelques exceptions près: il n'y a qu'un seul résident et le client ne peut passer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que les champs qu'il souhaite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai décidé d'utiliser les ensembles suivants avec des données incorrectes pour vérifier que le gestionnaire retournera une réponse HTTP </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le champ est spécifié, mais a un type et / ou un format de données incorrects</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La date de naissance est incorrecte (heure future).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient un parent qui n'existe pas dans le déchargement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est également nécessaire de vérifier que le gestionnaire met correctement à jour les informations sur le résident et ses proches. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, créez un téléchargement avec trois habitants, dont deux sont des parents, et envoyez une demande avec de nouvelles valeurs pour tous les champs scalaires et un nouvel identifiant relatif dans le champ </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire distingue les résidents de déchargements différents avant le test (et, par exemple, ne change pas les résidents avec les mêmes identifiants d'un autre déchargement), j'ai créé un déchargement supplémentaire avec trois résidents qui ont les mêmes identifiants.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit enregistrer les nouvelles valeurs des champs scalaires, ajouter un nouveau parent spécifié et supprimer la relation avec un ancien parent non spécifié. </font><font style="vertical-align: inherit;">Tous les changements de parenté devraient être bilatéraux. </font><font style="vertical-align: inherit;">Il ne devrait pas y avoir de changement dans les autres déchargements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné qu'un tel gestionnaire peut être soumis à des conditions de concurrence (cela a été discuté dans la section Développement), j'ai ajouté </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deux tests supplémentaires</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'un reproduit le problème avec l'état de race (étend la classe de gestionnaire et supprime le verrou), le second prouve que le problème avec l'état de race n'est pas reproduit.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importations / $ import_id / citoyens / anniversaires</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester ce gestionnaire, j'ai sélectionné les jeux de données suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un déchargement dans lequel un résident a un parent en un mois et deux parents en un autre.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec un résident sans parents. </font><font style="vertical-align: inherit;">Vérifie que le gestionnaire n'en tient pas compte dans les calculs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement vide. </font><font style="vertical-align: inherit;">Vérifie que le gestionnaire n'échouera pas et renverra le dictionnaire correct avec 12 mois dans la réponse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec un résident qui est un parent de lui-même. </font><font style="vertical-align: inherit;">Vérifie qu'un résident achètera un cadeau pour le mois de sa naissance.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le gestionnaire doit retourner tous les mois dans la réponse, même s'il n'y a pas d'anniversaire au cours de ces mois. </font><font style="vertical-align: inherit;">Pour éviter les doublons, j'ai créé une fonction à laquelle vous pouvez passer le dictionnaire afin qu'il le complète avec des valeurs pour les mois manquants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire fait la distinction entre les résidents de déchargements différents, j'ai ajouté un déchargement supplémentaire avec deux parents. </font><font style="vertical-align: inherit;">Si le gestionnaire les utilise par erreur dans les calculs, les résultats seront incorrects et le gestionnaire tombera avec une erreur.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La particularité de ce test est que les résultats de son travail dépendent de l'heure actuelle: l'âge des habitants est calculé en fonction de la date du jour. </font><font style="vertical-align: inherit;">Pour s'assurer que les résultats des tests ne changent pas au fil du temps, la date actuelle, les dates de naissance des résidents et les résultats attendus doivent être enregistrés. </font><font style="vertical-align: inherit;">Cela facilitera la reproduction de tous les cas de bord, même. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle est la meilleure date de correction? </font><font style="vertical-align: inherit;">Le gestionnaire utilise la fonction PostgreSQL pour calculer l'âge des résidents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui prend le premier paramètre comme date pour laquelle il est nécessaire de calculer l'âge et le second comme date de base (définie par une constante </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous remplaçons la date de base dans le gestionnaire par l'heure du test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester le gestionnaire, j'ai sélectionné les ensembles de données suivants (pour tous les résidents, j'ai indiqué une ville, car le gestionnaire agrège les résultats par ville):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec plusieurs résidents dont l'anniversaire est demain (âge - plusieurs années et 364 jours). </font><font style="vertical-align: inherit;">Vérifie que le processeur utilise uniquement le nombre d'années complètes dans les calculs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement avec un résident dont l'anniversaire est aujourd'hui (âge - exactement quelques années). </font><font style="vertical-align: inherit;">Il vérifie le cas régional - l'âge d'un résident dont l'anniversaire est aujourd'hui ne doit pas être calculé comme réduit d'un an.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déchargement vide. </font><font style="vertical-align: inherit;">Le gestionnaire ne doit pas tomber dessus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">référence </font><font style="vertical-align: inherit;">pour le calcul des centiles - </font><font style="vertical-align: inherit;">avec interpolation linéaire, et les résultats de référence pour les tests que j'ai calculés pour eux. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez également arrondir les valeurs de percentile fractionnaire à deux décimales. </font><font style="vertical-align: inherit;">Si vous avez utilisé PostgreSQL pour l'arrondi dans le gestionnaire et Python pour le calcul des données de référence, vous remarquerez peut-être que l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arrondi dans Python 3 et PostgreSQL peut donner des résultats différents</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par exemple</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que Python utilise l'arrondi de banque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au pair le plus proche</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et PostgreSQL </font><font style="vertical-align: inherit;">utilise </font><font style="vertical-align: inherit;">mathématique (demi-hausse). </font><font style="vertical-align: inherit;">Si les calculs et l'arrondi sont effectués dans PostgreSQL, il serait correct d'utiliser également l'arrondi mathématique dans les tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début, j'ai décrit des ensembles de données avec des dates de naissance dans un format texte, mais il n'était pas pratique de lire un test dans ce format: chaque fois, je devais calculer l'âge de chaque habitant dans mon esprit afin de me rappeler ce qu'un ensemble de données particulier vérifiait. </font><font style="vertical-align: inherit;">Bien sûr, vous pouviez vous en sortir avec les commentaires du code, mais j'ai décidé d'aller un peu plus loin et j'ai écrit une fonction </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui vous permet de décrire la date de naissance sous forme d'âge: le nombre d'années et de jours.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, comme ceci</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour m'assurer que le gestionnaire distingue les résidents de déchargements différents, j'ai ajouté un déchargement supplémentaire avec un résident d'une autre ville: si le gestionnaire l'utilise par erreur, une ville supplémentaire apparaîtra dans les résultats et le test se cassera.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un fait intéressant: lorsque j'ai écrit ce test le 29 février 2020, j'ai soudainement cessé de générer des décharges avec les résidents en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raison d'un bug dans Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 est une année bissextile, et d'autres années que Faker a choisies n'étaient pas toujours des années bissextiles aussi) n'était pas le 29 février). </font><font style="vertical-align: inherit;">N'oubliez pas d'enregistrer les dates et de tester les cas limites!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de migration à première vue semble évident et le moins sujet aux erreurs, pourquoi le tester? Il s'agit d'une erreur très dangereuse: les erreurs de migration les plus insidieuses peuvent se manifester au moment le plus inopportun. Même s'ils ne gâchent pas les données, ils peuvent entraîner des temps d'arrêt inutiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font><font style="vertical-align: inherit;">migration </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initiale</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> existante dans le projet </font><font style="vertical-align: inherit;">modifie la structure de la base de données, mais ne modifie pas les données. Quelles erreurs courantes peuvent être protégées contre de telles migrations?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        —    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart de ces erreurs seront détectées par le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test d'escalier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Son idée - d'utiliser une seule migration, effectuer systématiquement les méthodes </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour chaque migration. </font><font style="vertical-align: inherit;">Un tel test suffit à être ajouté au projet une fois, il ne nécessite pas de support et servira fidèlement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si la migration, en plus de la structure, modifiait les données, il faudrait alors écrire au moins un test distinct, en vérifiant que les données changent correctement dans la méthode </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et reviennent à l'état initial dans </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Juste au cas où: un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet avec des exemples de tests de différentes migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que j'ai préparé pour un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapport sur Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à Moscou Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assemblée</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'artefact final que nous allons déployer et que nous voulons obtenir à la suite de l'assemblage est une image Docker. Pour construire, vous devez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sélectionner l'image de base</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec Python. L'image officielle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pèse ~ 1 Go et, si elle est utilisée comme image de base, l'image avec l'application sera énorme. Il existe des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images basées sur Alpine OS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dont la taille est beaucoup plus petite. Mais avec un nombre croissant de packages installés, la taille de l'image finale augmentera et, par conséquent, même l'image collectée sur la base d'Alpine ne sera pas si petite. J'ai choisi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme image de base </font><font style="vertical-align: inherit;">- elle pèse un peu plus que les images alpines, mais est basée sur Ubuntu, qui propose une vaste sélection de packages et de bibliothèques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réduire la taille de l'image avec l'application</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - n'incluez pas dans l'image finale le compilateur, les bibliothèques et les fichiers avec des en-têtes pour l'assemblage, qui ne sont pas nécessaires au fonctionnement de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, vous pouvez utiliser l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assemblage en plusieurs étapes de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À l'aide d'une image «lourde» </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 Go, ~ 500 Mo compressés), créez un environnement virtuel, installez-y toutes les dépendances et le package d'application. </font><font style="vertical-align: inherit;">Cette image est nécessaire exclusivement pour l'assemblage, elle peut contenir un compilateur, toutes les bibliothèques et fichiers nécessaires avec des en-têtes.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous copions l'environnement virtuel fini dans une image «légère» </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 Mo, compressée ~ 50 Mo), qui ne contient que l'interpréteur de la version requise de Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important: dans un environnement virtuel, des chemins absolus sont utilisés, il doit donc être copié à la même adresse à laquelle il a été assemblé dans le conteneur collecteur.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réduire le temps nécessaire à la création de l'image</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , les modules dépendants de l'application peuvent être installés avant d'être installés dans l'environnement virtuel. </font><font style="vertical-align: inherit;">Docker les mettra en cache et ne réinstallera pas s'ils n'ont pas changé.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile entièrement</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  — «» (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    «» (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour faciliter l'assemblage, j'ai ajouté une commande </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui collecte l'image Docker et la télécharge sur hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que le code est couvert de tests et que nous pouvons construire une image Docker, il est temps d'automatiser ces processus. La première chose qui vous vient à l'esprit: exécutez des tests pour créer des demandes de pool et, lorsque vous ajoutez des modifications à la branche principale, collectez une nouvelle image Docker et téléchargez-la sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packages GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si vous n'allez pas distribuer l'image publiquement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai résolu ce problème avec les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actions GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pour ce faire, il a fallu créer un fichier YAML dans un dossier </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et y décrire un workflow (avec deux tâches: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que j'ai nommé </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est exécutée à chaque démarrage du workflow </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, à l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">services</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">récupère un conteneur avec PostgreSQL, attend qu'il soit disponible et se lance </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le conteneur </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'est exécutée que si les modifications ont été ajoutées à la branche </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et si la tâche </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a réussi. </font><font style="vertical-align: inherit;">Il collecte la distribution source par le conteneur </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis collecte et charge l'image Docker avec </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description complète du workflow</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, lorsque vous ajoutez des modifications au maître dans l'onglet Actions sur GitHub, vous pouvez voir le lancement des tests, l'assemblage et le chargement de l'image Docker: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et lors de la création d'une demande de pool dans la branche principale, les résultats de la tâche y seront également affichés </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployer</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour déployer l'application sur le serveur fourni, vous devez installer Docker, Docker Compose, démarrer les conteneurs avec l'application et PostgreSQL et appliquer les migrations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces étapes peuvent être automatisées à l'aide du système de gestion de configuration d'Ansible. Il est écrit en Python, ne nécessite pas d'agents spéciaux (se connecte directement via ssh), utilise des modèles jinja et permet de décrire de manière déclarative l'état souhaité dans les fichiers YAML. L'approche déclarative vous permet de ne pas penser à l'état actuel du système et aux actions nécessaires pour amener le système à l'état souhaité. Tout ce travail repose sur les épaules des modules Ansible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible vous permet de regrouper les tâches logiquement liées en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rôles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis de les réutiliser. Nous aurons besoin de deux rôles:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installe et configure Docker) et </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installe et configure l'application). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rôle</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajoute un référentiel avec Docker au système, installe et configure les packages </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez éventuellement configurer l'API REST pour qu'elle reprenne automatiquement après un redémarrage du serveur. Ubuntu vous permet de résoudre ce problème à l'aide d'un système d'initialisation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il contrôle des unités représentant diverses ressources (démons, sockets, points de montage et autres). Pour ajouter une nouvelle unité à systemd, vous devez décrire sa configuration dans un fichier .service distinct et placer ce fichier dans l'un des dossiers spéciaux, par exemple, dans </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, l'unité peut être lancée et activer le chargement automatique pour elle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paquet</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lors de l'installation, il créera automatiquement un fichier avec la configuration de l'unité - il vous suffit de vous assurer qu'il est en cours d'exécution et qu'il s'allume au démarrage du système. </font><font style="vertical-align: inherit;">Pour Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera créé par Ansible. </font><font style="vertical-align: inherit;">Le symbole </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le nom indique à systemd que l'unité est un modèle. </font><font style="vertical-align: inherit;">Cela vous permet de démarrer le service </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec un paramètre - par exemple, avec le nom de notre service, qui sera remplacé à la place du </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier de configuration de l'unité:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rôle</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> générera un fichier à partir du modèle </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à l'adresse </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, enregistrera l'application en tant que service lancé automatiquement </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et appliquera la migration. </font><font style="vertical-align: inherit;">Lorsque les rôles sont prêts, vous devez décrire le playbook.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste des hôtes, ainsi que les variables utilisées dans les rôles, peuvent être spécifiées dans le fichier d'inventaire </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois tous les fichiers Ansible prêts, exécutez-le:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos des tests de résistance</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.     :      ,    —   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( — 95 ,  — ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      —     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que peut-on faire d'autre?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le profilage de l'application a montré qu'environ un quart du temps total d'exécution des requêtes est consacré à la sérialisation et à la désérialisation de JSON: de nombreuses données sont envoyées et reçues du service. </font><font style="vertical-align: inherit;">Ces processus peuvent être considérablement accélérés à l'aide de la bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais le service devra être un peu préparé - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il ne s'agit pas d'un remplacement </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">direct</font></a><font style="vertical-align: inherit;"> pour le module standard. </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, la production nécessite plusieurs copies du service pour garantir la tolérance aux pannes et faire face à la charge. </font><font style="vertical-align: inherit;">Pour gérer un groupe de services, vous avez besoin d'un outil qui indique si une copie du service est "vivante". </font><font style="vertical-align: inherit;">Ce problème peut être résolu par un gestionnaire </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui interroge toutes les ressources nécessaires au travail, dans notre cas, une base de données. </font><font style="vertical-align: inherit;">Si</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécuté en moins d'une seconde, puis le service est vivant. Sinon, vous devez y prêter attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une application fonctionne de manière très intensive avec un réseau, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut augmenter froidement les performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un facteur important est la lisibilité du code. Un de mes collègues, Yuri Shikanov, a écrit un module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> combinant plusieurs outils </font><font style="vertical-align: inherit;">pour la vérification automatique et l'exécution de code, qui est facile à ajouter à un </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hook Git, mis en place avec un seul fichier de configuration ou des variables d'environnement. Gray vous permet de trier les importations ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), optimise les expressions python en fonction des nouvelles versions du langage ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), ajoute des virgules à la fin des appels de fonction, les importations, les listes, etc. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-virgule</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), ainsi que des guillemets à un seul formulaire ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unifier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour moi: nous avons développé, couvert de tests, assemblé et déployé le service, et également effectué des tests de charge.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remerciements</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voudrais exprimer ma profonde gratitude aux gars qui ont pris le temps de participer à la rédaction de cet article, de revoir le code, de présenter mes idées et commentaires: à Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et surtout à Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499518/index.html">La vidéoconférence est désormais un marché et de nouvelles technologies. Longrid, première partie</a></li>
<li><a href="../fr499522/index.html">Toutes les innovations de Windows 10 2004 (20H1)</a></li>
<li><a href="../fr499524/index.html">Quarkus: mises à niveau d'applications utilisant l'exemple helloworld de JBoss EAP Quickstart</a></li>
<li><a href="../fr499528/index.html">Un pont mathématique "étonnant" qui s'étend au-delà du grand théorème de Fermat</a></li>
<li><a href="../fr499532/index.html">Les mots en chiffres: blog gratuit analytics habravebinary avec Yandex.Metrica</a></li>
<li><a href="../fr499536/index.html">Growbox comme méthode de se connaître</a></li>
<li><a href="../fr499540/index.html">Fonctionnement du rendu de jeu 3D: texturation et filtrage de texture</a></li>
<li><a href="../fr499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../fr499544/index.html">Apprenez les réseaux de neurones dans Google Sheets</a></li>
<li><a href="../fr499546/index.html">Développement de firmware pour une caméra vidéo analogique EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>