<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🔧 🖐🏿 😿 从Similink调用共享库 🚭 👨🏻‍🎨 🍞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="嗨，哈伯！
 我向您介绍了我的同事Mikhail撰写的一篇文章的翻译，该文章涉及在Simulink中调用共享库的方法。为什么要创建它？事实是，许多公司已经拥有许多我们想重复使用的遗留模型，并且经常被问到以下问题：“如何将遗留模型集成到Simulink？如果我的遗产是DLL形式的？”因此，撰写了原始文...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>从Similink调用共享库</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嗨，哈伯！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我向您介绍了我的同事Mikhail撰写的一篇文章的翻译，该文章涉及在Simulink中调用共享库的方法。为什么要创建它？事实是，许多公司已经拥有许多我们想重复使用的遗留模型，并且经常被问到以下问题：“如何将遗留模型集成到Simulink？如果我的遗产是DLL形式的？”因此，撰写了原始文章。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在指导下，讨论了在Simulink中调用共享库的几种方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对代码的所有更改都是在Mikhail的允许下进行的，以免使本文过重。</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文介绍如何在Simulink模型中使用共享库中的函数。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设我们需要将exlib库嵌入Simulink中。</font><font style="vertical-align: inherit;">其代码包含在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的源代码中</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是一个非常简单的库，其中包含三个函数：</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_init（void）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -打开文件进行写入。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print（浮动数据）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -将数据写入文件。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term（void）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -关闭文件。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图书馆组装</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，编译库。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果库已预编译并以二进制文件形式提供，则无需执行此步骤。在这种情况下，您可以立即转到步骤3，但是请记住，要使用该库，您需要从库提供程序获取.dll文件（对于Linux为.so）和相应的头文件（.h）。对于Windows，您还需要一个.lib文件，该文件不是静态库，而是所谓的导入库。隐式链接需要此导入库。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们将使用MATLAB mex命令，该命令调用当前的活动主机编译器以编译共享库（Windows上为exlib.dll，Linux上为exlib.so）。确保首先执行命令很重要。</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
选择一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">支持的编译器</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在使用mex编译库：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">建立图书馆的代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查编译的库</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
编译后，您需要确保可以在MATLAB中加载和使用生成的库：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查库的代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们确保一切正常，让我们开始使用Simulink！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用S函数调用共享库</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S函数使您可以在Simulink中使用C代码。</font><font style="vertical-align: inherit;">这种方法允许用户开发加载库和调用其函数所需的任何C代码。</font><font style="vertical-align: inherit;">然后，将此代码编译为二进制文件，Simulink可以识别该二进制文件并将其链接到共享库。</font><font style="vertical-align: inherit;">此二进制文件称为S函数。</font><font style="vertical-align: inherit;">Simulink有一个用于调用此S函数的块。</font><font style="vertical-align: inherit;">有几种方法可以在Simulink中创建S函数。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用旧版代码工具</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一种方法是使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传统代码工具</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，该工具可帮助您根据使用MATLAB创建的规范自动创建S函数。</font><font style="vertical-align: inherit;">在此示例中，S函数链接到导入库（在Windows上，我们需要相应的* .lib文件），然后调用该库函数。</font><font style="vertical-align: inherit;">这种方法称为隐式链接。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，您需要初始化旧版代码工具的结构</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于初始化旧版代码工具结构的代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建一个S函数，进行编译和链接：</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，创建Simulink块：</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行模拟：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动编写S函数</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二种方法是编写自己的S函数，以加载共享库并从该库中调用函数。</font><font style="vertical-align: inherit;">这种方法将使用显式链接，也称为运行时链接。</font><font style="vertical-align: inherit;">最简单的解决方案是采用旧版代码工具之前自动生成的S函数。</font><font style="vertical-align: inherit;">在此示例中，修改了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlStart</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
修改后这些功能的外观如下：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
编译生成的S函数：</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并运行模拟：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用S-Function Builder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一种方法是使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模块</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是一个特殊的单元，就复杂性而言，它可以看作是传统代码工具和手写S函数之间的交叉。</font><font style="vertical-align: inherit;">S-Function Builder提供了一个图形界面，描述了S-function的特性，并且S-function是自动创建的。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用S-Function Builder有一些性能限制和问题。</font><font style="vertical-align: inherit;">当前，这被认为是创建S函数的一种过时方法。</font><font style="vertical-align: inherit;">建议使用C功能块，该功能块出现在R2020a的发行版中，稍后进行讨论。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用MATLAB Function调用共享库 </font></font></h2><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB Function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
模块</font><font style="vertical-align: inherit;">允许您使用MATLAB语言来描述Simulink中的自定义算法。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要从MATLAB函数调用共享库，请使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">只能在MATLAB函数的主体（而非MATLAB）中使用。</font><font style="vertical-align: inherit;">Coder.ceval不需要MATLAB Coder即可工作。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用于调用共享库的MATLAB Function模块的代码：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种方法有一个缺点-缺乏在仿真结束时调用完成函数的好方法（与MATLAB System块相比）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以通过设置exlib_term（）来定义模型的完成函数。在模型设置中的</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模拟目标-&gt;自定义代码-&gt;终止功能</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类别中</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。如果在模型设置中设置了“导入自定义代码”参数，则需要在“模拟目标”面板中指定所有代码依赖性（而不是使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。如果未设置此参数，则可以组合来自Simulation Target，coder.cinclude和coder.updateBuildInfo的设置。</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
另一种方法是使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">按照</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">约定</font><font style="vertical-align: inherit;">调用</font><i><font style="vertical-align: inherit;">exlib_term（）</font></i><font style="vertical-align: inherit;">，如上面的示例所示。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行模拟：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从Stateflow调用共享库 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果要在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图中使用共享库函数，</font><font style="vertical-align: inherit;">则应直接从Stateflow调用这些函数。 Stateflow文档中有一些示例显示了如何执行此操作。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Stateflow中调用外部函数非常简单-您需要在Stateflow图中指定函数的名称：</font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，您需要配置模型参数，以便Stateflow知道在哪里寻找这些外部函数。在</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation</font></font></i></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Target- </font></font></i><font style="vertical-align: inherit;"><b><i><font style="vertical-align: inherit;">&gt;自定义代码-&gt;库的设置中，您</font></i></b><font style="vertical-align: inherit;">需要输入</font><i><font style="vertical-align: inherit;">exlib.lib（或Linux中的exlib.so）</font></i><font style="vertical-align: inherit;">。在</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation</font></font></i></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Target- </font></font></i><font style="vertical-align: inherit;"><b><i><font style="vertical-align: inherit;">&gt;自定义代码-&gt;头文件中，您</font></i></b><font style="vertical-align: inherit;">需要输入</font><i><font style="vertical-align: inherit;">#include“ exlib.h”</font></i><font style="vertical-align: inherit;">。同样重要的是不要忘记指定完成功能。在</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation</font></font></i></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Target- </font></font></i><font style="vertical-align: inherit;"><b><i><font style="vertical-align: inherit;">&gt;自定义代码-&gt; Terminate函数</font></i></b><font style="vertical-align: inherit;">必须指定</font><i><font style="vertical-align: inherit;"> exlib_term（）; </font></i><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行模拟：</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意，本节中的信息适用于使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C操作语言的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stateflow图</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果Stateflow图使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB动作语言</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，与MATLAB Function一样。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用MATLAB System模块调用共享库 </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB System模块</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许您在Simulink中使用系统对象。</font><font style="vertical-align: inherit;">有关此块的更多信息，请参见文档。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对系统对象的支持出现在R2013b的Simulink中。</font><font style="vertical-align: inherit;">许多人使用系统对象是因为它们可以轻松定义初始化，仿真和完成功能。</font><font style="vertical-align: inherit;">而且，系统对象可以将辅助MATLAB代码用于这些功能（例如，用于步进函数的预处理和后处理），而无需编写C代码，</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是MATLAB System模块中使用的系统对象的样子：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统目标代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行模拟：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用C调用程序块调用共享库 </font></font></h2> <br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C调用程序</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
块</font><font style="vertical-align: inherit;">允许您直接从Simulink调用C函数。有关此块的更多信息，请参见文档。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一种相对较新的方法，最早出现在MATLAB R2018b中。其主要目的是使Simulink中的函数调用和C库变得非常简单。但是它有局限性，您可以在此块的文档中阅读。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加到</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation</font></font></i></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;"> Target- </font></i><b><i><font style="vertical-align: inherit;">&gt;库</font></i></b><font style="vertical-align: inherit;">并</font><font style="vertical-align: inherit;">在模型设置的</font><b><i><font style="vertical-align: inherit;">Simulation</font></i></b></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Target- </font></font></i><font style="vertical-align: inherit;"></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; Header</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中包含</font><i><font style="vertical-align: inherit;">#include“ exlib.h”</font></i><font style="vertical-align: inherit;">后</font><font style="vertical-align: inherit;">，只需单击C调用程序块中的“刷新自定义代码”按钮，查看库中包含的所有功能。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
选择</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_print</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数后</font><font style="vertical-align: inherit;">，将自动填写端口规范对话框：</font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同样，您需要将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数调用添加</font><font style="vertical-align: inherit;">到Simulation Target。</font><font style="vertical-align: inherit;">您还可以添加几个其他的C调用程序块来直接调用初始化和终止函数。</font><font style="vertical-align: inherit;">这些C调用程序块需要放置在Initialize Function和Terminate Function子系统中。</font><font style="vertical-align: inherit;">您还可以考虑Stateflow中的以下示例：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">计划子系统在特定时间执行</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
运行模拟：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用C功能块调用共享库</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将外部代码集成到Simulink中的最新</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">功能</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><b><font style="vertical-align: inherit;">C功能</font></b><font style="vertical-align: inherit;">块</font><font style="vertical-align: inherit;">。他出现在R2020a中。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就易用性而言，它类似于C调用程序块，但允许您围绕导入的函数创建C包装器（因此，此块类似于S-Function Builder）。但是，很可能，使用C功能块的主要场景不是调用现有的C函数，而是编写小段C代码（如果应用程序中需要这样的代码）。例如，您可能需要访问硬件寄存器或编译器的内置函数。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不要忘记将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font><font style="vertical-align: inherit;">到设置</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“模拟目标-&gt;库”</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include“ exlib.h”中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><font style="vertical-align: inherit;">模型设置</font><font style="vertical-align: inherit;">中的</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“仿真目标-&gt;头文件”</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置中。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，在C功能块的设置中，您需要为数据类型为single的输入数据添加一个字符，并指定输出，开始和结束代码：</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用使用嵌入式编码器生成的共享库 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用嵌入式编码器的一种方案是从Simulink模型自动生成C代码并将此代码打包在共享库中。该文档中还有一个示例，展示了如何自动生成共享库并从用C编写的外部应用程序中调用它。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意，如果您只需要在同一Simulink模型中将算法或算法的一部分作为C代码运行，那么最好使用Simulink Coder的S功能或</font><i><font style="vertical-align: inherit;">软件在环</font></i><font style="vertical-align: inherit;">仿真</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，如果将Embedded Coder生成的共享库用于半自然建模，则可能有必要将同一库集成到其他开发人员使用的较大模型中，从而保护其知识产权。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用由Embedded Coder生成的共享库与使用本文中使用的共享库没有什么不同。</font><font style="vertical-align: inherit;">考虑一个具有两个输入和一个输出的简单模型：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
建立模型后，我们得到一个.dll文件（在Linux上为.so），一个.lib文件（用于.dll的导入库）和一个.exp文件（用于与.dll链接的导出文件）。</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生成的共享库导出以下字符：</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
默认情况下，输入和输出被导出为全局字符，并且初始化，步骤和完成功能遵循模型命名约定。</font><font style="vertical-align: inherit;">如有必要，您可以配置函数原型，符号名称等（有关这些设置的讨论不在本文讨论范围之内）。</font><font style="vertical-align: inherit;">在此模型中，模型的阶跃函数的原型定义为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step（In1，In2）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要调用这些函数，您需要使用上面列出的方法之一。</font><font style="vertical-align: inherit;">例如，您可以使用MATLAB函数（为简单起见，我们仅调用step函数）：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看代码</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行模拟并查看其结果：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文介绍了从Simulink模型调用共享库的各种方法。</font><font style="vertical-align: inherit;">隐式和显式链接都被考虑了。</font><font style="vertical-align: inherit;">所有方法都各有利弊，其适用性取决于特定的工作流程，要求和目标。</font><font style="vertical-align: inherit;">当使用共享库实现隐式链接时</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传统代码工具</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法最有效，因为在这种情况下，我们可以直接从库中直接调用函数，而链接器将负责其余的工作。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB System模块</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是另一种提供以下好处的方法：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与初始化，步骤和完成功能的范例完全兼容，可让您将所有这些功能维护在模块本身内，而不是在模型范围内</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用MATLAB Function模块的缺点在于，其使用会导致代码生成过程中产生额外的开销。因此，传统代码工具和S函数仍然是生成产品代码的首选。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手写的S函数最适合用于实现到共享库的显式链接。在这种情况下，您需要使用诸如</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose之类的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数才能调用这些函数。</font><font style="vertical-align: inherit;">到目前为止，R2018b中引入</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的C调用程序块</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是调用C函数的最简单方法，但是它有其局限性。</font><b><font style="vertical-align: inherit;">C功能</font></b><font style="vertical-align: inherit;">块也可以这样说。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是R2020a的最新产品。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">在此处</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
下载源代码和模型</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503894/index.html">在线会议NskTechTalks＃12的公告：前端开发人员可以在哪里发展，如果什么都没有呢？</a></li>
<li><a href="../zh-CN503898/index.html">一日远程前端</a></li>
<li><a href="../zh-CN503902/index.html">如何让邻居从事他们的项目或银行的InnerSource工作</a></li>
<li><a href="../zh-CN503904/index.html">世界和n个世界，或人文科学</a></li>
<li><a href="../zh-CN503906/index.html">LabVIEW NXG-简单数据类型和类型强制</a></li>
<li><a href="../zh-CN503910/index.html">对去过“ udalenka”的人进行实验</a></li>
<li><a href="../zh-CN503916/index.html">学习在交易所交易。第一部分：建立测试环境</a></li>
<li><a href="../zh-CN503918/index.html">使用Go模块管理软件包：实用指南</a></li>
<li><a href="../zh-CN503920/index.html">我们如何在STM32上测试麦克风系统：Yandex设备开发人员的经验</a></li>
<li><a href="../zh-CN503922/index.html">欧盟为何要铲除饼干墙</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>