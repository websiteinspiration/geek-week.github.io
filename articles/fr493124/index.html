<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔈 💮 🤙🏻 Provisioning Bare-Metal à faire soi-même ou préparation de serveur automatique à partir de zéro 🐽 🍎 🐮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, je suis Denis et l’un de mes domaines d’activité est le développement de solutions d’infrastructure en X5. Aujourd'hui, je voudrais partager ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Provisioning Bare-Metal à faire soi-même ou préparation de serveur automatique à partir de zéro</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/493124/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, je suis Denis et l’un de mes domaines d’activité est le développement de solutions d’infrastructure en X5. </font><font style="vertical-align: inherit;">Aujourd'hui, je voudrais partager avec vous comment vous pouvez déployer un système de préparation de serveur automatisé basé sur des outils accessibles au public. </font><font style="vertical-align: inherit;">À mon avis, c'est une solution intéressante, simple et flexible.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/aj/wx/csajwx5dsd-sdlngyst-pfrollu.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par préparation, on entend: faire d'un nouveau serveur prêt à l'emploi, un serveur entièrement configuré avec OS </font><font style="vertical-align: inherit;">Linux ou avec l'hyperviseur ESXi (la diffusion de serveur Windows n'est pas abordée dans cet article). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Termes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveurs - serveurs qui doivent être configurés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur d'installation - le serveur principal qui fournit l'ensemble du processus de préparation sur le réseau.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi avez-vous besoin d'automatisation?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disons qu'il y a un problème: préparer en masse le serveur à partir de zéro, au pic - 30 par jour. </font><font style="vertical-align: inherit;">Des serveurs de différents fabricants et modèles, différents systèmes d'exploitation peuvent y être installés, un hyperviseur peut ou non exister. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelles opérations sont incluses dans le processus de configuration (sans automatisation):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connectez le clavier, la souris et le moniteur au serveur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurer le BIOS, RAID, IPMI;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre à niveau le firmware des composants;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déployer une image de système de fichiers (ou installer un hyperviseur et copier des machines virtuelles);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Alternativement, le déploiement du système d'exploitation est possible grâce à l'installation avec un fichier de réponse automatique. </font><font style="vertical-align: inherit;">Mais cela ne sera pas discuté dans l'article. </font><font style="vertical-align: inherit;">Bien que vous puissiez voir ci-dessous, l'ajout de cette fonctionnalité est facile.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurer les paramètres du système d'exploitation (nom d'hôte, IP, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette approche, les mêmes paramètres sont effectués séquentiellement sur chaque serveur. </font><font style="vertical-align: inherit;">L'efficacité d'un tel travail est très faible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'essence de l'automatisation consiste à exclure l'implication humaine du processus de préparation du serveur. </font><font style="vertical-align: inherit;">Autant que possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à l'automatisation, les temps d'arrêt entre les opérations sont réduits et il devient possible de préparer plusieurs serveurs en même temps. </font><font style="vertical-align: inherit;">La probabilité d'erreurs dues au facteur humain est également considérablement réduite.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g7/ic/x1/g7icx1q3tb0yanpntf9jmw8n4p4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment les serveurs sont-ils configurés automatiquement?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous analyserons toutes les étapes en détail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous disposez d'un serveur Linux que vous utilisez comme serveur d'installation PXE. </font><font style="vertical-align: inherit;">Les services y sont installés et configurés: DHCP, TFTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, nous chargeons le serveur (qui doit être configuré) par PXE. </font><font style="vertical-align: inherit;">Rappelez-vous comment cela fonctionne:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur sélectionné pour démarrer sur le réseau.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur charge la PXE-ROM de la carte réseau et contacte le serveur d'installation via DHCP pour obtenir l'adresse réseau.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP du serveur d'installation donne l'adresse, ainsi que des instructions pour un téléchargement ultérieur via PXE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur télécharge le chargeur de démarrage réseau à partir du serveur d'installation via PXE, le téléchargement se poursuit en fonction du fichier de configuration PXE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le téléchargement s'effectue en fonction des paramètres reçus (noyau, initramfs, points de montage, image squashfs, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. </font><font style="vertical-align: inherit;">Cet article décrit le démarrage PXE via le mode BIOS. </font><font style="vertical-align: inherit;">Actuellement, les fabricants introduisent activement le mode de démarrage UEFI. </font><font style="vertical-align: inherit;">Pour PXE, la différence sera dans la configuration du serveur DHCP et la présence d'un chargeur de démarrage supplémentaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons un exemple de configuration de serveur PXE (menu pxelinux). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fichier pxelinux.cfg / défaut:</font></font><br>
<br>
<pre><code class="plaintext hljs">default menu.c32<font></font>
prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
LABEL InstallServer Menu<font></font>
	MENU LABEL InstallServer<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/installserver<font></font>
LABEL VMware Menu<font></font>
	MENU LABEL VMware ESXi Install<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/vmware<font></font>
LABEL toolkit //   <font></font>
	MENU LABEL Linux Scripting Toolkits<font></font>
	MENU default<font></font>
	KERNEL menu.c32<font></font>
	APPEND pxelinux.cfg/toolkit //    </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fichier pxelinux.cfg / toolkit:</font></font><br>
<br>
<pre><code class="plaintext hljs">prompt 0<font></font>
timeout 100<font></font>
menu title X5 PXE Boot Menu<font></font>
label mainmenu<font></font>
    menu label ^Return to Main Menu<font></font>
    kernel menu.c32<font></font>
    append pxelinux.cfg/default<font></font>
label x5toolkit-auto //   —  <font></font>
        menu label x5 toolkit autoinstall<font></font>
        menu default<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tk-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=master-install.sh CMDIS2=”…”<font></font>
label x5toolkit-shell //   - <font></font>
        menu label x5 toolkit shell<font></font>
        kernel toolkit/tkcustom-kernel<font></font>
        append initrd=toolkit/tkcustom-initramfs.gz quiet net.ifnames=0 biosdevname=0 nfs_toolkit_ip=192.168.200.1 nfs_toolkit_path=tftpboot/toolkit nfs_toolkit_script=scripts/mount.sh script_cmd=/bin/bash CMDIS2=”…”</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le noyau et initramfs à ce stade sont une image linux intermédiaire, à l'aide de laquelle la préparation et la configuration de base du serveur auront lieu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, le chargeur de démarrage transmet de nombreux paramètres au noyau. </font><font style="vertical-align: inherit;">Certains de ces paramètres sont utilisés par le noyau lui-même. </font><font style="vertical-align: inherit;">Et nous pouvons en utiliser à nos propres fins. </font><font style="vertical-align: inherit;">Cela sera décrit plus tard, mais pour l'instant, vous pouvez simplement vous rappeler que tous les paramètres passés seront disponibles dans l'image linux intermédiaire via / proc / cmdline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où les trouver, le noyau et les initramfs? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme base, vous pouvez choisir n'importe quelle distribution Linux. </font><font style="vertical-align: inherit;">Ce à quoi nous prêtons attention lors du choix:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'image de démarrage doit être universelle (pilotes disponibles, possibilité d'installer des utilitaires supplémentaires);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">très probablement, les initramfs devront être personnalisés.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment cela se fait-il dans notre solution pour X5? CentOS 7 a été choisi comme base. Faisons l'astuce suivante: préparer la future structure de l'image, l'intégrer dans l'archive et créer des initramfs, à l'intérieur desquels sera notre archive de système de fichiers. Lors du chargement de l'image, l'archive sera déployée dans la section tmpfs créée. Ainsi, nous obtenons une image live-linux minimale, mais à part entière avec tous les utilitaires nécessaires, composée de seulement deux fichiers: vmkernel et initramfs.</font></font><br>
<br>
<pre><code class="plaintext hljs"># : <font></font>
<font></font>
mkdir -p /tftpboot/toolkit/CustomTK/rootfs /tftpboot/toolkit/CustomTK/initramfs/bin<font></font>
<font></font>
# :<font></font>
<font></font>
yum groups -y install "Minimal Install" --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y install nfs-utils mariadb ntpdate mtools syslinux mdadm tbb libgomp efibootmgr dosfstools net-tools pciutils openssl make ipmitool OpenIPMI-modalias rng-tools --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
yum -y remove biosdevname --installroot=/tftpboot/toolkit/CustomTK/rootfs/<font></font>
<font></font>
#  initramfs:<font></font>
<font></font>
wget https://busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-x86_64 -O /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
chmod a+x /tftpboot/toolkit/CustomTK/initramfs/bin/busybox<font></font>
cp /tftpboot/toolkit/CustomTK/rootfs/boot/vmlinuz-3.10.0-957.el7.x86_64 /tftpboot/toolkit/tkcustom-kernel<font></font>
<font></font>
#  /tftpboot/toolkit/CustomTK/initramfs/init (  ):<font></font>
<font></font>
#!/bin/busybox sh<font></font>
/bin/busybox --install /bin<font></font>
mkdir -p /dev /proc /sys /var/run /newroot<font></font>
mount -t proc proc /proc<font></font>
mount -o mode=0755 -t devtmpfs devtmpfs /dev<font></font>
mkdir -p /dev/pts /dev/shm /dev/mapper /dev/vc<font></font>
mount -t devpts -o gid=5,mode=620 devpts /dev/pts<font></font>
mount -t sysfs sysfs /sys<font></font>
mount -t tmpfs -o size=4000m tmpfs /newroot<font></font>
echo -n "Extracting rootfs... "<font></font>
xz -d -c -f rootfs.tar.xz | tar -x -f - -C /newroot<font></font>
echo "done"<font></font>
mkdir -p /newroot/dev /newroot/proc /newroot/sys<font></font>
mount --move /sys  /newroot/sys<font></font>
mount --move /proc /newroot/proc<font></font>
mount --move /dev  /newroot/dev<font></font>
exec switch_root /newroot /sbin/init<font></font>
<font></font>
#  rootfs  initramfs:<font></font>
<font></font>
cd /tftpboot/toolkit/CustomTK/rootfs<font></font>
tar cJf /tftpboot/toolkit/CustomTK/initramfs/rootfs.tar.xz --exclude ./proc --exclude ./sys --exclude ./dev .<font></font>
cd /tftpboot/toolkit/CustomTK/initramfs<font></font>
find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; /tftpboot/toolkit/tkcustom-initramfs-new.gz</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc spécifié un noyau et des initramfs qui devraient être chargés. </font><font style="vertical-align: inherit;">En conséquence, à ce stade, en téléchargeant l'image linux intermédiaire via PXE, nous obtenons la console OS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Très bien, mais maintenant nous devons transférer le contrôle à notre «automatisation». </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut être fait comme ça. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'après le chargement de l'image, nous prévoyons de transférer le contrôle au script mount.sh. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous incluons le script mount.sh dans l'exécution automatique. </font><font style="vertical-align: inherit;">Pour ce faire, vous devez modifier initramfs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décompressez initramfs (si nous utilisons la version ci-dessus d'initramfs, ce n'est pas obligatoire)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inclure dans le code de démarrage qui analysera les paramètres passés via / proc / cmdline et transférera le contrôle plus loin;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pack initramfs.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque. Dans le cas de la boîte à outils X5, le contrôle de démarrage est transféré au script. </font></font><code>/opt/x5/toolkit/bin/hook.sh   override.conf  getty tty1 (ExecStart=…) </code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'image est donc chargée, dans laquelle le script mount.sh démarre au démarrage. Ensuite, le script mount.sh en cours d'analyse analyse les paramètres passés (script_cmd =) et lance le programme / script nécessaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = master-install.sh</font></font><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
label toolkit- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shell</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
kernel ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
append ... nfs_toolkit_script = scripts / mount.sh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script_cmd = / bin / bash</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/w9/xc/8b/w9xc8b87fob_jooqjazqiyyiccm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici sur le côté gauche se trouve le menu PXE , à droite, le schéma de transfert de contrôle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec le transfert de contrôle, nous l'avons compris. </font><font style="vertical-align: inherit;">Selon le choix du menu PXE, le script de réglage automatique ou la console de débogage est lancé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas d'une configuration automatique, les répertoires nécessaires du serveur d'installation sont montés, dans lesquels il y a:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scripts;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèles BIOS / UEFI enregistrés de divers serveurs;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firmware;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilitaires pour serveurs;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">journaux.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le script mount.sh transfère le contrôle au script master-install.sh à partir du répertoire scripts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'arbre de script (l'ordre de leur lancement) ressemble à ceci:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installation principale</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sharefunctions (fonctions communes)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">info (sortie d'informations)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèles (définition des paramètres d'installation en fonction du modèle de serveur)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepare_utils (installation des utilitaires nécessaires)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fwupdate (mise à jour du firmware)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diag (diagnostic élémentaire)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biosconf (configuration BIOS / UEFI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clockfix (réglage de l'heure sur la carte mère)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">srmconf (configuration de l'interface distante)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raidconf (configuration des volumes logiques)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
un des:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">préinstallation (transfert du contrôle au programme d'installation du système d'exploitation ou de l'hyperviseur, par exemple ESXi)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fusion-installation (démarrage direct du déballage de l'image)</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, nous savons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment démarrer le serveur via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment transférer le contrôle sur votre propre script.</font></font></li>
</ul></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons continuer. </font><font style="vertical-align: inherit;">Les problèmes suivants sont devenus pertinents:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment identifier le serveur que nous préparons?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels utilitaires et comment configurer le serveur?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment obtenir les paramètres d'un serveur spécifique?</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment identifier le serveur que nous préparons?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est simple - DMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">dmidecode –s system-product-name<font></font>
dmidecode –s system-manufacturer<font></font>
dmidecode –s system-serial-number</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a tout ce dont vous avez besoin: un fournisseur, un modèle, un numéro de série. </font><font style="vertical-align: inherit;">Si vous n'êtes pas sûr que ces informations soient présentées sur tous les serveurs, vous pouvez les identifier par adresse MAC. </font><font style="vertical-align: inherit;">Ou dans les deux sens en même temps si les fournisseurs de serveurs sont différents et sur certains modèles, les informations sur le numéro de série ne sont tout simplement pas disponibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base des informations reçues, les dossiers réseau du serveur d'installation sont montés et tout le nécessaire est chargé (utilitaires, firmware, etc.).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quels utilitaires et comment configurer le serveur?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais donner des utilitaires pour Linux pour certains fabricants. </font><font style="vertical-align: inherit;">Tous les utilitaires sont disponibles sur les sites Web officiels des fournisseurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xx/xh/3f/xxxh3f0pg48elgtr8qn9r_wjp4q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec le firmware, je pense que tout est clair. </font><font style="vertical-align: inherit;">Ils viennent généralement dans des exécutables emballés. </font><font style="vertical-align: inherit;">Le fichier exécutable contrôle le processus de mise à jour du micrologiciel et signale un code retour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le BIOS et IPMI sont généralement configurés via des modèles. </font><font style="vertical-align: inherit;">Si nécessaire, le modèle peut être modifié avant le chargement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les utilitaires RAID pour certains fournisseurs peuvent également être configurés en fonction du modèle. </font><font style="vertical-align: inherit;">Si ce n'est pas le cas, vous devrez écrire un script de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La procédure de configuration du RAID est le plus souvent la suivante:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous demandons la configuration actuelle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il existe déjà des tableaux logiques, nous les effaçons.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous regardons quels disques physiques sont présents et combien d'entre eux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez un nouveau tableau logique. </font><font style="vertical-align: inherit;">Nous interrompons le processus en cas d'erreur.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment obtenir les paramètres d'un serveur spécifique?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que tous les paramètres du serveur soient stockés sur le serveur d'installation. </font><font style="vertical-align: inherit;">Dans ce cas, pour répondre à notre question, vous devez d'abord décider: comment transférer les paramètres vers le serveur d'installation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début, il est tout à fait possible de faire avec des fichiers texte. </font><font style="vertical-align: inherit;">(À l'avenir, vous pouvez utiliser un fichier texte comme moyen de sauvegarde pour transférer les paramètres). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez "partager" un fichier texte sur le serveur d'installation. </font><font style="vertical-align: inherit;">Et ajoutez-le au script mount.sh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les lignes ressembleront, par exemple, à ceci: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&lt;numéro de série&gt; &lt;nom d'hôte&gt; &lt;sous-réseau&gt; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces lignes seront transférées dans le fichier par l'ingénieur depuis sa machine de travail. </font><font style="vertical-align: inherit;">Et puis, lors de la configuration du serveur, les paramètres d'un serveur spécifique seront lus dans le fichier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais, à l'avenir, il est préférable d'utiliser la base de données pour stocker les paramètres, les états et les journaux d'installation du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, une base de données ne peut pas le faire, et vous devrez créer une partie client, à l'aide de laquelle les paramètres seront transférés dans la base de données. C'est plus difficile à mettre en œuvre qu'un fichier texte, mais ce n'est pas aussi difficile qu'il y paraît. La version minimale du client, qui transfèrera simplement les données à la base de données, est tout à fait faisable pour vous écrire. À l'avenir, il sera possible d'améliorer le programme client également en mode libre (rapports, impression d'étiquettes, envoi de notifications, etc., quoi que l'on pense). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir fait une demande spécifique à la base de données et en indiquant le numéro de série du serveur, nous obtenons les paramètres nécessaires à la configuration du serveur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous n'avons pas besoin d'inventer des verrous pour un accès simultané, comme c'est le cas avec un fichier texte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons écrire le journal de configuration à toutes les étapes de la base de données et contrôler le processus d'installation à travers les événements et les drapeaux des étapes de préparation. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, nous savons comment:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charger le serveur via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transférer le contrôle sur notre script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identifier le serveur à préparer par numéro de série;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurer le serveur avec les utilitaires appropriés;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transférer les paramètres vers la base de données du serveur d'installation à l'aide de la partie client.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai découvert comment:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le serveur installé reçoit les paramètres nécessaires de la base de données;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les progrès de la préparation sont enregistrés dans la base de données (journaux, événements, indicateurs de stade).</font></font></li>
</ul></b><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'en est-il des différents types de logiciels installés? </font><font style="vertical-align: inherit;">Comment installer un hyperviseur, copier une VM et configurer tout cela?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas du déploiement d'une image de système de fichiers (linux) sur du matériel, tout est assez simple:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après avoir configuré tous les composants du serveur, déployez l'image.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez le chargeur de démarrage grub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous faisons chroot et configurons tout ce qui est nécessaire.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment transférer le contrôle vers le programme d'installation du système d'exploitation (en utilisant ESXi comme exemple).</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous organisons le transfert de contrôle de notre script vers le programme d'installation de l'hyperviseur à l'aide du fichier de réponse automatique (kickstart):</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimez les partitions actuelles sur le disque.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez une partition de 500 Mo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous le marquons comme démarrage.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Format en FAT32.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous copions les fichiers d'installation ESXi à la racine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiez syslinux.cfg dans / syslinux /</font></font></li>
</ul><br>
<pre><code class="plaintext hljs">default esxi<font></font>
prompt 1<font></font>
timeout 50<font></font>
label esxi<font></font>
kernel mboot.c32<font></font>
append -c boot.cfg</code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiez mboot.c32 dans / syslinux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans boot.cfg, il devrait y avoir kernelopt = ks = ftp: // &lt;IP du serveur d'installation&gt; /ks_esxi.cfg</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redémarrez le serveur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après le redémarrage du serveur, le programme d'installation ESXi démarre à partir de son disque dur. </font><font style="vertical-align: inherit;">Tous les fichiers d'installation nécessaires seront chargés en mémoire et l'installation d'ESXi commencera, selon le fichier de réponse automatique spécifié. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici quelques lignes du fichier de réponse automatique ks_esxi.cfg:</font></font><br>
<br>
<pre><code class="plaintext hljs">%firstboot --interpreter=busybox<font></font>
…<font></font>
#   <font></font>
<font></font>
SYSSN=$(esxcli hardware platform get | grep Serial | awk -F " " '{print $3}')<font></font>
<font></font>
#  IP<font></font>
<font></font>
IPADDRT=$(esxcli network ip interface ipv4 get | grep vmk0 | awk -F " " '{print $2}')<font></font>
LAST_OCTET=$(echo $IPADDRT | awk -F'.' '{print $4}')<font></font>
<font></font>
#  NFS -<font></font>
<font></font>
esxcli storage nfs add -H is -s /srv/nfs_share -v nfsshare1<font></font>
<font></font>
#    ssh,   ssh-<font></font>
<font></font>
mv /etc/ssh /etc/ssh.tmp<font></font>
cp -R /vmfs/volumes/nfsshare1/ssh /etc/<font></font>
chmod go-r /etc/ssh/ssh_host_rsa_key<font></font>
<font></font>
#  ovftool,    ,    <font></font>
<font></font>
cp -R /vmfs/volumes/nfsshare1/ovftool /vmfs/volumes/datastore1/<font></font>
<font></font>
#  <font></font>
<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM1 /vmfs/volumes/nfsshare1/VM_T/VM1.ova vi://root:esxi_password@127.0.0.1<font></font>
/vmfs/volumes/datastore1/ovftool/tools/ovftool --acceptAllEulas --noSSLVerify --datastore=datastore1 --name=VM2 /vmfs/volumes/nfsshare1/VM_T/VM2.ova vi://root:esxi_password@127.0.0.1<font></font>
<font></font>
#      <font></font>
<font></font>
ssh root@is "mysql -h'192.168.0.1' -D'servers' -u'user' -p'secretpassword' -e \"SELECT ... WHERE servers.serial='$SYSSN'\"" | grep -v ^$ | sed 's/NULL//g' &gt; /tmp/servers<font></font>
...<font></font>
#    <font></font>
<font></font>
echo '#!/bin/sh' &gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip interface ipv4 set -i=vmk0 -t=static --ipv4=$IPADDR --netmask=$S_SUB || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
echo "esxcli network ip route ipv4 add -g=$S_GW -n=default || exit 1" &gt;&gt; /vmfs/volumes/datastore1/netconf.sh<font></font>
chmod a+x /vmfs/volumes/datastore1/netconf.sh<font></font>
<font></font>
#   guestinfo.esxihost.id,     <font></font>
<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM1/VM1.vmx<font></font>
echo "guestinfo.esxihost.id = \"$SYSSN\"" &gt;&gt; /vmfs/volumes/datastore1/VM2/VM2.vmx<font></font>
...<font></font>
#    <font></font>
<font></font>
SYSNAME=$(esxcli hardware platform get | grep Product | sed 's/Product Name://' | sed 's/^\ *//')<font></font>
UUID=$(vim-cmd hostsvc/hostsummary | grep uuid | sed 's/\ //g;s/,$//' | sed 's/^uuid="//;s/"$//')<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"UPDATE servers ... SET ... WHERE servers.serial='$SYSSN'\""<font></font>
ssh root@is "mysql -D'servers' -u'user' -p'secretpassword' -e \"INSERT INTO events ...\""<font></font>
<font></font>
#   SSH<font></font>
<font></font>
rm -rf /etc/ssh<font></font>
mv /etc/ssh.tmp /etc/ssh<font></font>
<font></font>
#    <font></font>
<font></font>
esxcli system hostname set --fqdn=esx-${G_NICK}.x5.ru<font></font>
/vmfs/volumes/datastore1/netconf.sh<font></font>
reboot<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, un hyperviseur est installé et configuré, les machines virtuelles sont copiées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment configurer des machines virtuelles maintenant? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons un peu triché: lors de l'installation, nous avons défini le paramètre guestinfo.esxihost.id = "$ SYSSN" dans le fichier VM1.vmx, indiqué le numéro de série du serveur physique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, après le démarrage, la machine virtuelle (avec le package vmware-tools installé) peut accéder à ce paramètre:</font></font><br>
<br>
<pre><code class="plaintext hljs">ESXI_SN=$(vmtoolsd --cmd "info-get guestinfo.esxihost.id")</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, la machine virtuelle pourra s'identifier (elle connaît le numéro de série de l'hôte physique), faire une demande à la base de données du serveur d'installation et obtenir les paramètres qui doivent être configurés. </font><font style="vertical-align: inherit;">Tout cela est exécuté dans un script qui devrait être lancé automatiquement au démarrage de guestos vm (mais une fois: RunOnce). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, nous savons comment:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charger le serveur via PXE;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transférer le contrôle sur notre script;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identifier le serveur à préparer par numéro de série;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurer le serveur avec les utilitaires appropriés;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transférer les paramètres vers la base de données du serveur d'installation à l'aide de la partie client;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurez différents types de bons de commande, notamment le déploiement de l'hyperviseur esxi et la configuration des machines virtuelles (et tout cela automatiquement).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai découvert comment:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le serveur installé reçoit les paramètres nécessaires de la base de données;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les progrès de la préparation sont enregistrés dans la base de données (journaux, événements, indicateurs de stade).</font></font></li>
</ul></b><br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion:</font></font></b></u><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
je crois que le caractère unique de cette solution réside dans sa flexibilité, sa simplicité, ses capacités et sa polyvalence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez écrire dans les commentaires ce que vous en pensez.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493112/index.html">Comment démarrer une nouvelle entreprise en 6 mois au lieu de 3 ans</a></li>
<li><a href="../fr493114/index.html">Comment Data Engineer a regardé les données</a></li>
<li><a href="../fr493116/index.html">"Plus d'interactivité!" ou comment était TeamLead Conf 2020</a></li>
<li><a href="../fr493118/index.html">Présentation de l'extension d'étiquetage de mémoire (Armv8.5-A)</a></li>
<li><a href="../fr493122/index.html">Bureau des Jeux de Banzai: le Japon au centre de Moscou</a></li>
<li><a href="../fr493126/index.html">Antipatterns de l'architecture événementielle</a></li>
<li><a href="../fr493130/index.html">Pourquoi ne pas avoir peur du coronavirus: mythes et presque la vérité sur COVID-2019</a></li>
<li><a href="../fr493132/index.html">Autour de data.table</a></li>
<li><a href="../fr493136/index.html">FAST VP dans Unity Storage: comment cela fonctionne</a></li>
<li><a href="../fr493138/index.html">Parlez-moi: ce que les robots vocaux peuvent faire aujourd'hui</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>