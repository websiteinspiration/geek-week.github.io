<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🏫 👊🏿 🐽 Optimisation de la charge sur un projet Highload avec ElasticSearch ✊🏼 🧘🏽 🗨️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je m'appelle Maxim Vasiliev, je travaille comme analyste et chef de projet chez FINCH. Aujourd'hui, je voudrais vous dire comment, grâc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimisation de la charge sur un projet Highload avec ElasticSearch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503214/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Je m'appelle Maxim Vasiliev, je travaille comme analyste et chef de projet chez FINCH. </font><font style="vertical-align: inherit;">Aujourd'hui, je voudrais vous dire comment, grâce à ElasticSearch, nous avons pu traiter 15 millions de requêtes en 6 minutes et optimiser la charge quotidienne sur le site d'un de nos clients. </font><font style="vertical-align: inherit;">Malheureusement, nous devrons nous passer de noms, puisque nous avons le NDA, nous espérons que le contenu de l'article ne sera pas affecté. </font><font style="vertical-align: inherit;">Allons-y.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment le projet est organisé</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur notre backend, nous créons des services qui assurent la performance des sites et des applications mobiles de notre client. </font><font style="vertical-align: inherit;">La structure générale peut être vue dans le diagramme: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/yw/mx/svywmxdiqxb59mwxobsses8vrc8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le processus, nous traitons un grand nombre de transactions: achats, paiements, opérations avec des soldes d'utilisateurs, sur lesquels nous stockons beaucoup de journaux, et importons et exportons également ces données vers des systèmes externes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe également des processus inverses lorsque nous recevons des données d'un client et les transmettons à l'utilisateur. </font><font style="vertical-align: inherit;">De plus, il existe encore des processus pour travailler avec les programmes de paiement et de bonus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte court</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au départ, nous avons utilisé PostgreSQL comme seul entrepôt de données. Ses avantages standards pour les SGBD: disponibilité des transactions, langage développé d'échantillonnage des données, larges outils d'intégration; couplé à de bonnes performances, des personnes satisfaites satisfont depuis longtemps nos besoins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons stocké absolument toutes les données dans Postgres: des transactions aux nouvelles. Mais le nombre d'utilisateurs a augmenté, et avec lui le nombre de demandes. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la compréhension, le nombre annuel de sessions en 2017 sur le seul site de bureau est de 131 millions. En 2018, 125 millions 2019 est à nouveau de 130 millions. Ajoutez-y 100 à 200 millions supplémentaires à partir de la version mobile du site et de l'application mobile, et vous obtiendrez un grand nombre de demandes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec la croissance du projet, Postgres a cessé de faire face à la charge, nous n'avons pas eu le temps - un grand nombre de requêtes diverses sont apparues, sous lesquelles nous n'avons pas pu créer un nombre suffisant d'index. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons réalisé qu'il y avait un besoin pour d'autres entrepôts de données qui répondraient à nos besoins et allégeraient PostgreSQL. </font><font style="vertical-align: inherit;">Elasticsearch et MongoDB ont été considérés comme des options possibles. </font><font style="vertical-align: inherit;">Ce dernier a perdu sur les points suivants:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vitesse d'indexation lente avec augmentation du volume de données dans les index. </font><font style="vertical-align: inherit;">La vitesse d'Elastic est indépendante de la quantité de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas de recherche plein texte</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc choisi Elastic pour nous-mêmes et préparé la transition. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passer à l'élastique</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Nous avons entamé la transition avec un service de recherche de points de vente. </font><font style="vertical-align: inherit;">Notre client dispose d'un total d'environ 70 000 points de vente, et il nécessite plusieurs types de recherches sur le site et dans l'application:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche de texte par nom de ville</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Géo-recherche dans un rayon donné à partir d'un certain point. </font><font style="vertical-align: inherit;">Par exemple, si un utilisateur souhaite voir quels points de vente sont les plus proches de son domicile.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche par un carré donné - l'utilisateur dessine un carré sur la carte, et on lui montre tous les points dans ce rayon. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherchez des filtres supplémentaires. </font><font style="vertical-align: inherit;">Les points de vente diffèrent les uns des autres dans l'assortiment</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ce qui concerne l'organisation, à Postgres, nous avons une source de données à la fois sur la carte et sur les actualités, et dans Elastic Snapshots sont faites à partir des données originales. Le fait est qu'au départ, Postgres ne pouvait pas faire face à la recherche selon tous les critères. Non seulement il y avait de nombreux index, mais ils pouvaient également se croiser, de sorte que l'ordonnanceur Postgres s'est perdu et n'a pas compris quel index utiliser pour cela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Ensuite, la section des nouvelles. Chaque jour, des publications apparaissent sur le site afin que l'utilisateur ne se perde pas dans le flux d'informations, les données doivent être triées avant d'être publiées. Pour cela, vous avez besoin d'une recherche: sur le site, vous pouvez rechercher par correspondance de texte, et en même temps connecter des filtres supplémentaires, car ils sont également créés via Elastic.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Ensuite, nous avons déplacé le traitement des transactions. </font><font style="vertical-align: inherit;">Les utilisateurs peuvent acheter un produit spécifique sur le site et participer au tirage au sort. </font><font style="vertical-align: inherit;">Après de tels achats, nous traitons une grande quantité de données, en particulier le week-end et les jours fériés. </font><font style="vertical-align: inherit;">À titre de comparaison, si les jours ordinaires le nombre d'achats se situe entre 1,5 et 2 millions, les jours fériés peuvent atteindre 53 millions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, les données doivent être traitées en un minimum de temps - les utilisateurs n'aiment pas attendre un résultat pendant plusieurs jours. </font><font style="vertical-align: inherit;">Vous n'atteindrez pas de tels délais grâce à Postgres - nous avons souvent des verrous, et même si nous traitons toutes les demandes, les utilisateurs ne peuvent pas vérifier s'ils ont reçu des prix ou non. </font><font style="vertical-align: inherit;">Ce n'est pas très agréable pour l'entreprise, nous avons donc déplacé le traitement vers Elasticsearch.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Périodicité</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mises à jour sont désormais configurées par événement, dans les conditions suivantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point de vente. </font><font style="vertical-align: inherit;">Dès que des données provenant d'une source externe nous parviennent, nous commençons immédiatement la mise à jour.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouvelles. </font><font style="vertical-align: inherit;">Dès qu'une nouvelle est éditée sur le site, elle est automatiquement envoyée à Elastic.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Là encore, il convient de mentionner les avantages d'Elastic. </font><font style="vertical-align: inherit;">Dans Postgres, lors de l'envoi d'une demande, vous devez attendre jusqu'à ce qu'il traite honnêtement tous les enregistrements. </font><font style="vertical-align: inherit;">Vous pouvez envoyer 10 000 enregistrements à Elastic et commencer immédiatement à travailler, sans attendre que les enregistrements soient distribués sur tous les fragments. </font><font style="vertical-align: inherit;">Bien sûr, certains fragments ou répliques peuvent ne pas voir les données tout de suite, mais très bientôt, tout sera disponible.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthodes d'intégration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a 2 façons d'intégrer avec Elastic:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Via le client natif sur TCP. </font><font style="vertical-align: inherit;">Le pilote natif s'éteint progressivement: il n'est plus supporté, il a une syntaxe très gênante. </font><font style="vertical-align: inherit;">Par conséquent, nous ne l'utilisons pratiquement pas et essayons de l'abandonner complètement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Via une interface HTTP dans laquelle vous pouvez utiliser à la fois les requêtes JSON et la syntaxe Lucene. </font><font style="vertical-align: inherit;">Ce dernier est un moteur de texte qui utilise Elastic. </font><font style="vertical-align: inherit;">Dans cette option, nous avons la possibilité de regrouper des requêtes JSON via HTTP. </font><font style="vertical-align: inherit;">C'est l'option que nous essayons d'utiliser.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à l'interface HTTP, nous pouvons utiliser des bibliothèques qui fournissent une implémentation asynchrone du client HTTP. </font><font style="vertical-align: inherit;">Nous pouvons profiter de Batch et de l'API asynchrone, qui au final donne des performances élevées, ce qui a beaucoup aidé pendant les jours d'une grande action (plus de détails ci-dessous) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques chiffres à comparer:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enregistrement des utilisateurs qui ont reçu des prix dans Postgres en 20 flux sans regroupements: 460 713 entrées en 42 secondes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client élastique + réactif pour 10 threads + batch pour 1000 éléments: 596749 enregistrements en 11 secondes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client élastique + réactif pour 10 threads + batch pour 1000 éléments: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23801684 enregistrements en 4 minutes</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous avons écrit un gestionnaire de requêtes HTTP qui construit JSON comme Batch / not Batch et l'envoie via n'importe quel client HTTP, quelle que soit la bibliothèque. </font><font style="vertical-align: inherit;">Vous pouvez également choisir d'envoyer des demandes de manière synchrone ou asynchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans certaines intégrations, nous utilisons toujours le client de transport officiel, mais ce n'est qu'une question de refactoring à venir. </font><font style="vertical-align: inherit;">Dans le même temps, un client personnalisé construit sur la base de Spring WebClient est utilisé pour le traitement.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/sx/qg/x2sxqgijaic0-ldqbrjlwse_tp0.jpeg" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grande promotion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois par an, une grande campagne pour les utilisateurs a lieu sur le projet - c'est le même Highload, car à ce moment nous travaillons avec des dizaines de millions d'utilisateurs en même temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, les pics de charge se produisent pendant les vacances, mais cette promotion est d'un niveau complètement différent. L'année précédente, le jour de la promotion, nous avons vendu 27 580 890 unités de marchandises. Les données ont été traitées pendant plus d'une demi-heure, ce qui a gêné les utilisateurs. Les utilisateurs ont reçu des prix pour leur participation, mais il est devenu clair que le processus devait être accéléré. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Début 2019, nous avons décidé que nous avions besoin d'ElasticSearch. Pendant toute une année, nous avons organisé le traitement des données reçues dans Elastic et leur sortie dans l'api de l'application mobile et du site. En conséquence, l'année suivante pendant la campagne, nous avons traité </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15 131 783 enregistrements en 6 minutes.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous avons beaucoup de gens qui veulent acheter des marchandises et participer au tirage au sort dans les promotions, il s'agit d'une mesure temporaire. </font><font style="vertical-align: inherit;">Nous envoyons maintenant des informations pertinentes à Elastic, mais à l'avenir, nous prévoyons de transférer les informations d'archives des derniers mois vers Postgres en tant que référentiel permanent. </font><font style="vertical-align: inherit;">Afin de ne pas obstruer l'indice élastique, qui a aussi ses limites.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion / Conclusions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le moment, nous avons transféré à Elastic tous les services que nous voulions et avons suspendu pour l'instant. </font><font style="vertical-align: inherit;">Nous construisons maintenant un index dans Elastic au-dessus du stockage persistant principal dans Postgres, qui prend la charge de l'utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'avenir, nous prévoyons de transférer des services si nous comprenons que la demande de données devient trop diversifiée et est recherchée par un nombre illimité de colonnes. </font><font style="vertical-align: inherit;">Ce n'est plus une tâche pour Postgres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous avons besoin d'une recherche en texte intégral dans la fonctionnalité, ou si nous avons beaucoup de critères de recherche différents, alors nous savons déjà que cela doit être traduit en Elastic.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">⌘⌘⌘</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci d'avoir lu. </font><font style="vertical-align: inherit;">Si votre entreprise utilise également ElasticSearch et possède ses propres cas d'implémentation, dites-le nous. </font><font style="vertical-align: inherit;">Il sera intéressant de savoir comment les autres ont :-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503200/index.html">YOLOv4 - le réseau neuronal en temps réel le plus précis du jeu de données Microsoft COCO</a></li>
<li><a href="../fr503204/index.html">Comment flasher Xiaomi Redmi 4 Prime / Pro / Premium sur Android 10</a></li>
<li><a href="../fr503208/index.html">Quel est le meilleur moment pour investir?</a></li>
<li><a href="../fr503210/index.html">Les sites de phishing peuvent-ils être éradiqués?</a></li>
<li><a href="../fr503212/index.html">30 astuces pour terminer le cours en ligne</a></li>
<li><a href="../fr503218/index.html">GlobalSign présente Atlas - plate-forme PKI de nouvelle génération</a></li>
<li><a href="../fr503226/index.html">Qu'est-ce qui empêche une entreprise de passer à un «nombre» et qu'est-ce que cela a à voir avec la réputation</a></li>
<li><a href="../fr503228/index.html">Contrôle de la fréquence cardiaque tout en faisant du jogging grâce à la rétroaction musicale - ou «les testeurs qui aiment courir recherchent»</a></li>
<li><a href="../fr503230/index.html">Systèmes de classe Incident Response Platform: application et fonctions principales</a></li>
<li><a href="../fr503232/index.html">Comment devenir ingénieur DevOps en six mois ou plus vite. Partie 6. Lancement de l'application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>