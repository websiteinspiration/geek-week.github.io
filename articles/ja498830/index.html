<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤞🏿 🧠 💃🏻 ハッシュ+キャッシュ：ストリーム処理の最適化 🚪 🙆🏽 👸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="データベースに、耐えられないほど大量の「事実」を書き留めたい場合はどうすればよいですか？まず、当然のことながら、我々はより経済的にデータを持って、通常のフォームと「辞書」、取得我々は一度書きますが。しかし、それを最も効果的に行う方法は？
 
 これは、PostgreSQLサーバーログの監視と分析を開...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ハッシュ+キャッシュ：ストリーム処理の最適化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498830/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースに、耐えられないほど大量の「事実」を書き留めたい場合はどうすればよいですか？まず、当然のことながら、我々はより経済的にデータを持って</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、通常のフォーム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と「辞書」、取得</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我々は一度書きますが</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。しかし、それを最も効果的に行う方法は？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、PostgreSQLサーバーログの監視と分析を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">する</font></a><font style="vertical-align: inherit;">際に直面した問題</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">であり、データベース内のレコードを最適化する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">方法を</font></a><font style="vertical-align: inherit;">使い果たしたときに発生しました。</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0y/34/cp/0y34cps5t4nqozitxa0xb7urypm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コレクターが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実行していることをすぐに予約して</font><font style="vertical-align: inherit;">、プロセッサーのレジスターやキャッシュと対話しないようにします。</font><font style="vertical-align: inherit;">また、「100」または外部のキャッシングサービス/データベースを使用するオプションでは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、数百Mbpsの着信ストリーム</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に対して非常に長い遅延が発生し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてをRAMに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、特にJavaScriptプロセスのメモリ</font><font style="vertical-align: inherit;">に</font><b><font style="vertical-align: inherit;">キャッシュ</font></b><font style="vertical-align: inherit;">しようとし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これをより効率的に整理する方法について、さらに説明します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可用性キャッシング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの主なタスクは、オブジェクトの唯一のインスタンスがデータベースに入るようにすることです。これらは、繰り返し繰り返されるSQLクエリの元のテキスト、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらの実装計画の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレート</font><font style="vertical-align: inherit;">、これらの計画のノード、つまり、いくつかの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストブロック</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
歴史的に、識別子</font></font><code>UUID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として</font><font style="vertical-align: inherit;">、オブジェクトのテキストから</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5ハッシュ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を直接計算した結果として得られ</font><font style="vertical-align: inherit;">た</font><font style="vertical-align: inherit;">-value </font><font style="vertical-align: inherit;">を使用しました</font><font style="vertical-align: inherit;">。その後</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プロセスメモリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内のローカルの</font><b><font style="vertical-align: inherit;">「辞書」でその</font></b><font style="vertical-align: inherit;">ようなハッシュが利用可能かどうかを確認し、</font><font style="vertical-align: inherit;">ない場合は「辞書」テーブルにデータベースに書き込みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、元のテキスト値自体を保存する必要はありません（数十キロバイトかかることもあります）</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対応するハッシュ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が辞書に</font><b><font style="vertical-align: inherit;">存在するという事実</font></b><font style="vertical-align: inherit;">だけで十分</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー辞書</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなディクショナリはに保持し</font></font><code>Array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>Array.includes()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可用性を確認するために使用できますが、これはかなり冗長です。検索は（少なくとも以前のバージョンのV8では）配列のサイズO（N）から線形的に低下します。</font><font style="vertical-align: inherit;">また、最新の実装では、すべての最適化にもかかわらず、2〜3％の速度で損失が発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ES6より前の時代では、</font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">格納された値をキーとして使用する</font><font style="vertical-align: inherit;">ストレージが従来のソリューションでした</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、誰もが彼が望むもののキーの値を割り当てました-例えば</font></font><code>Boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> dict = {};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span>(<span class="hljs-params">key</span>) </span>{
  <span class="hljs-keyword">return</span> dict[key] !== <span class="hljs-literal">undefined</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">key</span>) </span>{<font></font>
  dict[key] = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ここで超過分を明確に格納していることは明らかです。つまり、誰も必要としないキーの価値そのものです。しかし、それがまったく保存されていない場合はどうなりますか？そのため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setオブジェクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が表示されました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストによると、ヘルプを使用した検索は</font></font><code>Set.has()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、鍵の検証よりも約20〜25％速いc </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。しかし、これは彼の唯一の利点ではありません。格納する量が少ないので、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なメモリも少なくする必要があり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。このようなキーが数十万になると、パフォーマンスに直接影響します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキスト表現に100個のUUIDキーがある場合、メモリ内で</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6,216バイト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を占有します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1e/n6/ge/1en6gefozucw86wki6odp-j3ria.png"><br>
<br>
<code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ内容で</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2,632バイト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/59/cb/ri59cbgqbmmbqhivlopro2gspuu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、</font></font><code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より高速</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">動作し、同時に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリが2.5倍少ない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -勝者は明白です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUIDキーのストレージを最適化します</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、分散システムの自然の中で、UUIDキーはかなり共通している- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのVLSIに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、彼らは文書との規制を識別するために使用される最小、で、ある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電子文書管理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、人々</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のメッセージを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今度は上の写真を注意深く見てみましょう-各UUID- 16進表記で保存されたキーは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56バイトのメモリを消費します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。しかし、私たちは数十万人を抱えているため、「可能性は低いですか？」と質問するのが妥当です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、UUIDが16バイトの識別子であることを思い出してください。本質的にバイナリデータの一部。そして、例えば、電子メールによる送信の場合、バイナリデータは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base64</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でエンコードされ</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;"> -適用しようとします：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> str = Buffer.from(uuidstr, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'base64'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/pd/jc/ks/pdjckslsoycw92xnx4moahgmweg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにそれぞれ48バイトの方が優れていますが、不完全です。</font><font style="vertical-align: inherit;">16進数表現を文字列に直接変換してみましょう。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> str = Buffer.from(uuidstr, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'binary'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/6i/nn/_5/6inn_5k8y3pnogatsv-r5ntrdzo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーあたり56バイトの代わりに-40バイト、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">約30％節約</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マスター、労働者-辞書をどこに保存しますか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーからの語彙データが非常に強く交差することを考慮して、辞書を保存してマスタープロセスでデータベースに書き込み</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、IPCメッセージメカニズムを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">ワーカーからデータを送信しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、マスターの時間のかなりの部分が費やされました。</font></font><code>channel.onread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つまり、子プロセスからの「辞書」情報を含むパケットの受信の処理です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/kr/nr/sdkrnrm1c_amswktwm57kl3qsfo.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デュアルセット書き込みバリア</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今度は少し考えてみましょう-ワーカーはマスターに同じ語彙データを送信および送信します（基本的にこれらはプランテンプレートと繰り返し要求の本文です）、彼は汗をかいてそれらを解析し、...何もしません。 ！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで</font></font><code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、マスターを辞書から再録音しないようにデータベース</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">「保護」する場合、同じ方法を使用して、マスターがワーカーから転送されないように「保護」してみませんか？.. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、それは行われ、</font><font style="vertical-align: inherit;">交換チャネル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスに</font><b><font style="vertical-align: inherit;">直接費やすコストが3倍になりました</font></b><font style="vertical-align: inherit;">：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y1/h4/aj/y1h4ajs-o3hdg1xfoyf9j_kflpc.png"><br>
<br>
<img src="https://habrastorage.org/webt/vl/be/na/vlbenalj_sd_2jk36xdkhaouhp8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、今や労働者はより多くの仕事をしているようです-辞書を保存してそれらでフィルターしますか？</font><font style="vertical-align: inherit;">そうでない？..実際には、大量の転送（IPC経由でも！）は安価ではないので、それらは大幅に機能しなくなりました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/7k/mb/dz7kmbdj5jnirhajahmwrpcwzfw.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いいボーナス</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウィザードが受け取る情報の量が大幅に減少したため、これらのコンテナーに割り当てるメモリが大幅に減少しました。つまり、ガベージコレクターの作業に費やされる時間が大幅に減少し、システム全体のレイテンシにプラスの影響を与えました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fg/af/el/fgafel26_6der0h-knhglqckt8k.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなスキームは、コレクターレベルでの繰り返しのエントリに対する保護を提供しますが、複数のコレクターがある場合はどうなりますか？</font><font style="vertical-align: inherit;">ここで役立つのはトリガー付きのものだけです</font></font><code>INSERT ... ON CONFLICT DO NOTHING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュ計算の高速化</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのアーキテクチャでは、1つのPostgreSQLサーバーからのログストリーム全体が1人のワーカーによって処理されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、1つのサーバーがワーカーの1つのタスクです。同時に、ワーカーの負荷はサーバータスクの目的によって分散されるため、すべてのコレクターのワーカーによるCPU消費はほぼ同じになります。これは別のサービスディスパッチャーです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「平均して」各ワーカーは、ほぼ同じ合計負荷を生成する数十のタスクを処理します。ただし、ログエントリの数が他のサーバーを大幅に上回るサーバーもあります。そして、ディスパッチャーがこのタスクをワーカー上の唯一のタスクのままにしても、そのダウンロードは他のタスクよりもはるかに高くなります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/p1/9a/olp19ahpqzn4e5aaek0oyg1tjt0.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このワーカーのCPUプロファイルを削除しまし</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/zk/fs/2qzkfsaqceti_tietxizjhfmioi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
た。一番上の行は、MD5ハッシュの計算です。</font><font style="vertical-align: inherit;">そして、それらは実際には非常に大量に計算されます-入ってくるオブジェクトのストリーム全体に対して。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxHash</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのハッシュを除いて、この部分を最適化する方法はできませんか？</font><i><font style="vertical-align: inherit;">非常に高速な非暗号化ハッシュアルゴリズム</font></i><font style="vertical-align: inherit;">を実装する</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のハッシュ関数</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxHash</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を試すことにしました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、Node.jsのモジュールは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">xxhash-addon</font></a><font style="vertical-align: inherit;">で、新しいXXH3アルゴリズムを備えたxxHash 0.7.3ライブラリの最新バージョンを使用しています。</font><font style="vertical-align: inherit;">
長さの異なる行のセットで各オプションを実行して確認します。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">const</span> { XXHash3, XXHash64 } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xxhash-addon'</span>);
<span class="hljs-keyword">const</span> hasher3 = <span class="hljs-keyword">new</span> XXHash3(<span class="hljs-number">0xDEADBEAF</span>);
<span class="hljs-keyword">const</span> hasher64 = <span class="hljs-keyword">new</span> XXHash64(<span class="hljs-number">0xDEADBEAF</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> buf = Buffer.allocUnsafe(<span class="hljs-number">16</span>);
<span class="hljs-keyword">const</span> getBinFromHash = <span class="hljs-function">(<span class="hljs-params">hash</span>) =&gt;</span> buf.fill(hash, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'binary'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> funcs = {
  <span class="hljs-attr">xxhash64</span> : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> hasher64.hash(Buffer.from(str)).toString(<span class="hljs-string">'binary'</span>)<font></font>
, <span class="hljs-attr">xxhash3</span>  : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> hasher3.hash(Buffer.from(str)).toString(<span class="hljs-string">'binary'</span>)<font></font>
, <span class="hljs-attr">md5</span>      : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> getBinFromHash(crypto.createHash(<span class="hljs-string">'md5'</span>).update(str).digest(<span class="hljs-string">'hex'</span>))<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> check = <span class="hljs-function">(<span class="hljs-params">hash</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> log = [];
  <span class="hljs-keyword">let</span> cnt = <span class="hljs-number">10000</span>;
  <span class="hljs-keyword">while</span> (cnt--) log.push(crypto.randomBytes(cnt).toString(<span class="hljs-string">'hex'</span>));<font></font>
<font></font>
  <span class="hljs-built_in">console</span>.time(hash);<font></font>
  log.forEach(funcs[hash]);<font></font>
  <span class="hljs-built_in">console</span>.timeEnd(hash);<font></font>
};<font></font>
<font></font>
<span class="hljs-built_in">Object</span>.keys(funcs).forEach(check);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果：</font></font><br>
<pre><code class="plaintext hljs">xxhash64 : 148.268ms<font></font>
xxhash3  : 108.337ms<font></font>
md5      : 317.584ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">期待される</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、xxhash3だっ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はるかに高速MD5よりも</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
衝突に対する耐性をチェックするために残っています。</font><font style="vertical-align: inherit;">辞書のテーブルのセクションは毎日作成されているので、その日の範囲外では、ハッシュの交差を安全に許可できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、念のため、3日の間隔でマージンを確認しました</font><font style="vertical-align: inherit;">。私たちに適し</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た単一の競合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><b><font style="vertical-align: inherit;">はありません</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュ置換</font></font></h4><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3d/rz/ga/3drzgasyjhevujtp-etsjcwlnz8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、データベースと既存のフロントエンドの両方がオブジェクトがUUIDによって識別され続けるのを待つため、古いUUIDフィールドを取得してディクショナリテーブルの新しいハッシュに変更することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もう1つのキャッシュ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をコレクターに追加し</font><font style="vertical-align: inherit;">ます-すでに計算されたMD5の場合。今では次のようになります</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地図</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のキーがxxhash3された、値はMD5です。同一の行については、「高価な」MD5を再度数えることはせず、キャッシュから取得します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> getHashFromBin = <span class="hljs-function">(<span class="hljs-params">bin</span>) =&gt;</span> Buffer.from(bin, <span class="hljs-string">'binary'</span>).toString(<span class="hljs-string">'hex'</span>);
<span class="hljs-keyword">const</span> dictmd5 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
<span class="hljs-keyword">const</span> getmd5 = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> hash = xxhash(data);
  <span class="hljs-keyword">let</span> md5hash = dictmd5.get(hash);
  <span class="hljs-keyword">if</span> (!md5hash) {<font></font>
    md5hash = md5(data);<font></font>
    dictmd5.set(hash, getBinFromHash(md5hash));<font></font>
    <span class="hljs-keyword">return</span> md5hash;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> getHashFromBin(md5hash);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロファイルを削除します-ハッシュを計算する時間の割合が著しく減少しました、乾杯！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/el/5q/ce/el5qcei3ahbakyyerswutw2rulk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、xxhash3をカウントし、MD5キャッシュをチェックして目的のMD5を取得し、ディクショナリキャッシュをチェックします。このmd5がそこにない場合は、データベースに送信して書き込みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェックが多すぎます... MD5キャッシュをすでにチェックしているのに、なぜ辞書キャッシュをチェックしますか？</font><font style="vertical-align: inherit;">すべてのディクショナリキャッシュは不要になり、1つのキャッシュがあれば十分で</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wl/e_/uc/wle_ucs0o22wpxmrjlg_2sokzvm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あることがわかります。MD5の場合、</font><font style="vertical-align: inherit;">すべての基本操作が実行されます。</font><font style="vertical-align: inherit;">その結果、複数の「オブジェクト」ディクショナリディクショナリのチェックを1つのMD5キャッシュに置き換え、MD5を計算するリソース集約的な操作を行いました。ハッシュは、着信ストリームに対してはるかに効率的なxxhashを使用して、新しいエントリに対してのみ実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感謝</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キロ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 記事の準備を手伝ってください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja498816/index.html">まず第一に真実、またはデータベースシステムに基づいてシステムを設計する必要がある理由</a></li>
<li><a href="../ja498820/index.html">.NETとCに関するさらにトリッキーな質問＃</a></li>
<li><a href="../ja498822/index.html">4人用のアーケードマシンをゼロから開発および作成</a></li>
<li><a href="../ja498826/index.html">SILとSalesforce</a></li>
<li><a href="../ja498828/index.html">食塩とタンパク質がインプラントの生存率をどのように高めるか</a></li>
<li><a href="../ja498832/index.html">マイクロコントローラーをプログラミングするためのQt Creator 4.12およびQBS 1.16の可能性の概要</a></li>
<li><a href="../ja498834/index.html">今週の33のオンラインmitap。1つ選択するか、すべての時間をお持ちですか？</a></li>
<li><a href="../ja498836/index.html">[インフォグラフィック] 10億以上の収益を誇るトップ50のゲームフランチャイズ</a></li>
<li><a href="../ja498840/index.html">ボットは電報を介してコンピュータを監視および制御します</a></li>
<li><a href="../ja498842/index.html">コメントのモデレート：それでも、ユーザーを信頼できますか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>