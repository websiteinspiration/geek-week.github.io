<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊🏼 🧑🏽‍🤝‍🧑🏼 👶🏼 Not a day without sports: reprogramming a Chinese heart rate monitor 🤷🏼 🎏 🧝🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="“Listen, what kind of heart rate should you have while jogging?” 
 - Well, I don’t know - 150 hits. 
 - Yes? Why do I have 840? 
 - 840 per minute ?! ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Not a day without sports: reprogramming a Chinese heart rate monitor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493384/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Listen, what kind of heart rate should you have while jogging?” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Well, I don’t know - 150 hits. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Yes? Why do I have 840? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- 840 per minute ?! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- And what, it was necessary to consider in a minute or what? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“What did you think?” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Well, I just counted until I got lost ... So, okay, I went to recount.” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(film "Election Day") </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost exactly about the Chinese heart rate monitor. As the saying goes, if you want to do something well, then do it yourself. And if the device does not work as it is required from, then maybe it will be possible to improve it?</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fe/pp/23/fepp230sxqy_lyvvcnoihcc1_ey.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people who are interested in sports monitor their heart rate during exercise. </font><font style="vertical-align: inherit;">For this, heart rate monitors are used. </font><font style="vertical-align: inherit;">It is not the task of this article to consider all their types, but one of the most reliable and proven ones is chest pulse sensors that receive electrical signals from the heart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In connection with my greatly increased physical activity, the </font><font style="vertical-align: inherit;">Kyto 2809 </font></font><abbr title="Heart rate"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heart rate</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> monitor was also acquired </font><font style="vertical-align: inherit;">. The pulse is good, but there was a need for accurate measurement of RR intervals. </font><font style="vertical-align: inherit;">The heart rate monitor supports two protocols: ANT + and BLE. </font><font style="vertical-align: inherit;">According to the specifications, both of them, in addition to directly heart rate, transmit the duration of RR intervals.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are RR intervals</font></font></b><div class="spoiler_text">RR  –     R    .<br>
<br>
<img src="https://habrastorage.org/webt/yd/in/ea/ydineadtr4darurwgdkucttqlse.png"><br>
 RR   ,  .     .        ,   (.    «  RR »   « »).         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To record data from both channels, an Android application was written to fit your needs with a data log to text files. </font><font style="vertical-align: inherit;">An analogue heart rate monitor was sent as a more or less adequate standard, sending a signal at a frequency of 5.3 kHz, connected directly to a PC via an arduino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first comparison was slightly saddened.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kf/yp/xw/kfypxwjqzbjd1jif9yp-dh9kto0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The “device” for one real heart beat showed 4-5 nonexistent (on the blue graph you can see an abundance of points). </font><font style="vertical-align: inherit;">The pulse, even taking into account the possible averaging, does not shine with accuracy. </font><font style="vertical-align: inherit;">About measuring RR intervals of speech does not go at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Communication with the manufacturer did not bring results. </font><font style="vertical-align: inherit;">In addition to several videos, attempts to convince me that everything is fine, and phrases: "KYTO2809 heart rate datas are accurate!", I did not get anything from them. </font><font style="vertical-align: inherit;">Then his gaze fell on the box with screwdrivers. </font><font style="vertical-align: inherit;">Opening the case, I discovered the nRF51422 chip.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/au/wi/0b/auwi0bchg8cuiqj74jaz-elv49g.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Knowing that there is an SDK for these MKs, I decided to try to reflash it. </font><font style="vertical-align: inherit;">The simplest program is needed there: from the electric signal amplifier of the heart (a black drop in the photo), the signal goes to the MK input, and then it’s a technical matter, we catch the pulses through interrupts, measure the time between them and output all this through BLE and ANT +. </font><font style="vertical-align: inherit;">Everything is simple, but apparently something went wrong with the Chinese programmers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These chips are programmed via SWD. </font><font style="vertical-align: inherit;">Native firmware was protected from reading. </font><font style="vertical-align: inherit;">Therefore, without hesitation, the command </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“format c:”</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> “--eraseall” was executed. </font><font style="vertical-align: inherit;">The board even displays the corresponding contacts. </font><font style="vertical-align: inherit;">Input from the amplifier of electric signals of the heart P0.07. </font><font style="vertical-align: inherit;">The pinout of the BLE module itself is (top to bottom):</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.30</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.00</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.01</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.02</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.03</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.04</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.05</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.06</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.07</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.08</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SDK contains many examples sufficient to write your own firmware. The chip is quite old and the SDK for it is also outdated, version 10. Using them, the BLE services were raised on the heart rate monitor: Device Information, Battery Service, Heart Rate. A HeartRate profile has been added for ANT +. We measure RR intervals with a timer, send data to the BLE and ANT + profiles. To save charge in the absence of external stimuli (within 5 seconds), the heart rate monitor is put into sleep mode. When a pulse appears (interruptions at the input), the MK wakes up. In the firmware from the manufacturer, Kyto2809 constantly transmitted advertising packets via BLE, i.e. when using only the ANT + channel, BLE continued to send packets and drain the battery. I limited the advertising time to 5 minutes, which should have a positive effect on profitability.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tests showed that for the Calculated Heart Rate parameter, it is better to introduce filtering (discard deliberately inaccurate data, i.e., a pulse below 30 and above 240) and averaging with a moving average. The final comparison with the analog heart rate monitor below. Differences in measurements of RR intervals of 0-2 ms, which is quite acceptable.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aa/rw/qw/aarwqwkdl2sg16sbflzjv2itsw0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of useful functions, the ability to update OTA firmware (original name DFU OTA) has been added. </font><font style="vertical-align: inherit;">Now, having sewn up the OTA-bootloader, you can easily update the firmware if you want to change something in the code. </font><font style="vertical-align: inherit;">The firmware is done from the smartphone through the proprietary utility nRFConnect. </font><font style="vertical-align: inherit;">Also, if I'm not mistaken, you can make OTA support in your Android application, there are libraries for this. </font><font style="vertical-align: inherit;">Unfortunately, to fill the bootloader in memory, you need to connect via SWD, because </font><font style="vertical-align: inherit;">OTA was not originally provided by the manufacturer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firmware order:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we sew </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SoftDevice310</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is BLE and ANT + a stack from Nordic;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we sew Kyto_DFU_bootloader.hex (the case can be assembled);</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">through nRFConnect fill the finished package kyto_hr_dfu.zip</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last two files are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There is also firmware without OTA (KytoHR.hex).</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493374/index.html">Coronavirus - practical tips and a bit of theory</a></li>
<li><a href="../en493376/index.html">The Big Initiative Theory - Russian Experience in Digital Transformation of Industrial Enterprises</a></li>
<li><a href="../en493378/index.html">Steam has you: how digital distribution takes away our games</a></li>
<li><a href="../en493380/index.html">Julia and quantum computing</a></li>
<li><a href="../en493382/index.html">.NET Core Windows Forms Designer Updates</a></li>
<li><a href="../en493386/index.html">How is coronavirus treated?</a></li>
<li><a href="../en493390/index.html">Introducing .NET 5 Preview 1</a></li>
<li><a href="../en493392/index.html">Machine Learning in Kazan, or how machine learning specialists are trained in Tatarstan</a></li>
<li><a href="../en493394/index.html">God’s syndrome: the story of how the main infectious disease specialist of the Stavropol Territory coronavirus spread (a) *</a></li>
<li><a href="../en493396/index.html">Abstract on forecasting methods</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>