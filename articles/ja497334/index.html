<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕍 👖 💍 悪名高いバグとClickHouseの例でそれらを回避する方法 🕵️ 🛷 👇🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="コードを記述している場合は、問題に備えてください。それらは間違いなくそうであり、コードとコンパイラから、オペレーティングシステムとハードウェアから、そしてユーザーが時々「驚き」を投げかけるという、あらゆる面から期待されるはずです。クラスタを宇宙規模にスケーリングした場合は、「スペース」のバグが予想さ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>悪名高いバグとClickHouseの例でそれらを回避する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497334/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを記述している場合は、問題に備えてください。</font><font style="vertical-align: inherit;">それらは間違いなくそうであり、コードとコンパイラから、オペレーティングシステムとハードウェアから、そしてユーザーが時々「驚き」を投げかけるという、あらゆる面から期待されるはずです。</font><font style="vertical-align: inherit;">クラスタを宇宙規模にスケーリングした場合は、「スペース」のバグが予想されます。</font><font style="vertical-align: inherit;">特にインターネットトラフィックからのデータに関しては。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ooBAQIe0KlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アレクセイミロビドフ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）ClickHouseの開発とサポートにおける彼の経験から、最もばかげた、落胆し、絶望的な問題について話します。</font><font style="vertical-align: inherit;">それらをデバッグする方法と、開発者が最初からとるべき対策を見てみましょう。そうすることで、問題が少なくなります。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪名高いバグ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを書いたら、すぐに問題に備えてください。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードのエラー。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらが必要になります。しかし、完璧なコードを記述してコンパイルしたとしましょう。しかし、バグが</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示さ</font><strong><font style="vertical-align: inherit;">れ</font></strong><font style="vertical-align: inherit;">、コードが正しく機能しません。コンパイラを修正し、すべてをコンパイルしました-実行してください。しかし、（予想外に）</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSのカーネルにもバグがある</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、すべてが正しく</font><strong><font style="vertical-align: inherit;">動作しません</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OSにバグがない場合、必然的</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にハードウェアにあり</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。完璧なハードウェアで完全に機能する完璧なコードを書いたとしても、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成エラー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの問題が</font><strong><font style="vertical-align: inherit;">発生し</font></strong><font style="vertical-align: inherit;">ます。あなたはすべてを正しく行ったようですが、誰かが設定ファイルを間違えたので、すべてが再び機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのバグが修正されると、ユーザーはコードを「誤って」使用し続けるため、ユーザーはそれを終了します。</font><font style="vertical-align: inherit;">しかし、問題はユーザーではなくコード</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にあります</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><strong><font style="vertical-align: inherit;">使いにくいものを書いたのです</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの例でこれらのバグを見てみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成のバグ</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データの削除</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。練習からの最初のケース。幸いにも、私やYandexではなく、心配する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はじめに。クラスター（Hadoopなど）のmap-reduceアーキテクチャは、データを格納するいくつかのデータサーバー（データノード）と、サーバー上のすべてのデータの場所を知っている1つ以上のマスターサーバーで構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データノードはマスターのアドレスを知っており、それに接続します。ウィザードは、データの場所と場所を監視し、データノードにさまざまなコマンドを提供します。「データXをダウンロードします。データYが必要で、データZを削除します」。何がうまくいかないのでしょうか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい構成ファイルがすべてのデータノードにアップロードされたとき、それらは誤って別のクラスターからのマスターに接続し、自分のノードには接続していません。</font><font style="vertical-align: inherit;">マスターは、データノードに通知されたデータを見て、データが正しくないため削除する必要があると判断しました。</font><font style="vertical-align: inherit;">データの半分が消去されたときに問題に気づきました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/ii/6i/s8ii6igrww4j3zdjhrfyyqrl2nk.png" width="350"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も壮大なバグは、不注意によるデータの削除につながるバグです。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これを回避するのは非常に簡単です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データは削除しないでください</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。たとえば、別のディレクトリに保存するか、遅延して削除します。まず、ユーザーに表示されないように転送します。数日以内に何かが消えたことがわかった場合は、元に戻します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因が不明な場合は、予期しないデータを削除しないでください</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。不明なデータの削除の開始をプログラムで制限します：予期しない、奇妙な名前の場合、またはそれらが多すぎる場合。管理者は、サーバーが起動せず、メッセージを書き込むことに気づき、理解します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムが破壊的なアクションを実行する場合-テストと本番環境をネットワークレベルで分離する</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（iptables）。たとえば、ファイルを削除したり、電子メールを送信したりすると、誰かの注意を「奪う」ため、破壊的なアクションになります。それらにしきい値を設定します。100通の文字を送信できます。1,000通の場合、安全チェックボックスをオンにしてください。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 2番目の例は、すでに私の実践からのものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある良い会社には、どういうわけか奇妙なClickHouseクラスタがありました。奇妙なことに、レプリカは同期しませんでした。サーバーを再起動すると、サーバーが起動せず、すべてのデータが正しくないというメッセージが表示されました。「予期しないデータがたくさんあるため、起動しません。私たちは旗</font></font><code>force_restore_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">立て、</font><font style="vertical-align: inherit;">それを理解し</font><font style="vertical-align: inherit;">なければなりません</font><font style="vertical-align: inherit;">。」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰も会社でそれを理解することができませんでした-彼らはフラグを立てるだけです。同時に、データの半分がどこかに消えてしまい、グラフにギャップが生じました。開発者は私に目を向け、何か面白いことが起こっていると思い、調査することにしました。数時間後に朝が来て鳥が窓の外で歌い始めたとき、私は何も理解していないことに気付きました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseサーバーは、調整のためにZooKeeperサービスを使用します。 ClickHouseはデータを保存し、ZooKeeperはどのサーバーにどのデータを置くかを決定します。どのレプリカにどのデータを置くかに関するメタデータを保存します。 ZooKeeperもクラスターです。これは、非常に優れた分散コンセンサスアルゴリズムに従って複製され、厳密な一貫性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、ZooKeeperは3台のマシン、場合によっては5台です。ClickHouse構成では、すべてのマシンが一度に示され、ランダムなマシンとの接続が確立されて相互作用し、このサーバーがすべてのリクエストを複製します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうした？会社には3つのZooKeeperサーバーがありました。しかし、それらは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3つのノードのクラスター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてではなく</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3つの独立したノード（</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1つのノードからの3つのクラスター）</font><font style="vertical-align: inherit;">として機能しました</font><font style="vertical-align: inherit;">。 1つのClickHouseが1つのサーバーに接続し、データを書き込みます。レプリカはこのデータをダウンロードしたいのですが、どこにも見つかりません。再起動すると、サーバーは別のZooKeeperに接続します。以前に処理したデータが不必要であることがわかり、どこかに延期する必要があります。彼はそれらを削除しませんが、別のディレクトリに転送します-ClickHouseではデータは簡単に削除されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZooKeeperの設定を修正することにしました。</font><font style="vertical-align: inherit;">すべてのデータの名前を変更</font></font><code>ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、ディレクトリからデータの一部を</font><font style="vertical-align: inherit;">要求し</font><font style="vertical-align: inherit;">ます</font></font><code>detached/unexpeted_*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、すべてのデータが復元され、レプリカは同期され、損失はなく、グラフは連続的でした。</font><font style="vertical-align: inherit;">会社は、まるですべてが以前にうまくいかなかったかを忘れてしまったかのように、満足しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは単純な構成のバグでした。</font><font style="vertical-align: inherit;">より多くのバグがコードに含まれます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードのバグ</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードはC ++で記述します。</font><font style="vertical-align: inherit;">これは、すでに問題があることを意味します。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の例は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Yandex.Metricaクラスター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（2015）での</font><font style="vertical-align: inherit;">本番のバグです</font><font style="vertical-align: inherit;">-C ++コードの結果です。</font><font style="vertical-align: inherit;">バグは、リクエストに応答する代わりに、ユーザーがエラーメッセージを受け取ることがあったことです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「チェックサムが一致しない、データが破損している」-チェックサムが一致しない、データが壊れている-怖い！</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「LRUCacheは不整合になりました。</font><font style="vertical-align: inherit;">そこにバグがあるはずです」-キャッシュは一貫性がなくなり、おそらくバグになりました。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが書いたコードは、そこにバグがあることを知らせています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックサムが一致せず、データが破損しています</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。」</font><font style="vertical-align: inherit;">圧縮データブロックのチェックサムは、解凍される前にチェックされます。</font><font style="vertical-align: inherit;">通常、このエラーは、ファイルシステムでデータが壊れている場合に表示されます。</font><font style="vertical-align: inherit;">さまざまな理由により、サーバーの再起動時に一部のファイルが不要になることがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは別のケースです：私はファイルを手動で読み取り、チェックサムは一致し、エラーはありません。</font><font style="vertical-align: inherit;">エラーが表示されると、要求が繰り返されるとエラーが安定して再現されます。</font><font style="vertical-align: inherit;">サーバーを再起動すると、エラーがしばらく消えてから、再び安定して表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく問題はRAMにありますか？</font><font style="vertical-align: inherit;">典型的な状況は、ビットがその中で暴れているときです。</font><font style="vertical-align: inherit;">私は</font><strong><font style="vertical-align: inherit;">dmesg</font></strong><font style="vertical-align: inherit;">を調べます</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（kern.log）、ただし、マシンチェックの例外はありません-通常、RAMに問題があるときに書き込みます。サーバーがRAMを破っていた場合、私のプログラムは正しく動作しないだけでなく、他のすべてのプログラムがランダムにエラーを生成します。ただし、エラーの他の兆候はありません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「LRUCacheは不整合になりました。そこにバグがあるに違いない。」</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはコードの明らかな間違いであり、C ++で記述している-おそらくメモリアクセスですか？ただし、CIのAddressSanitizer、ThreadSanitizer、MemorySanitizer、UndefinedBehaviorSanitizerでのテストでは何も示されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらくいくつかのテストケースはカバーされていませんか？私はAddressSanitizerでサーバーを収集し、本番環境で実行します-何もキャッチしません。しばらくの間、いくつかのマークキャッシュ（サシェキャッシュ）をリセットすることにより、エラーがクリアされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラミングルールの1つに、バグが何であるかが明確でない場合は、コードを詳しく調べて、そこに何かがあることを期待しています。私はそうしました、バグを見つけ、それを修正しました-それは助けにはなりませんでした。コードの別の場所を調べます-バグもあります。修正、再び助けにはならなかった。さらにいくつか修正しましたが、コードは改善されましたが、エラーはまだ消えませんでした！</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーごと、時間ごと、負荷の性質ごとにパターンを見つけようとしても、何の役にも立ちません。その後、問題はクラスターの1つにのみ現れ、他のクラスターには決して現れないことに気付きました。エラーはそれほど頻繁には再現されませんが、再起動後は常に1つのクラスターに表示され、他のクラスターはすべて正常です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その理由は、「問題のある」クラスターで新機能を使用したことが判明した- </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシュ辞書</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">手書きのメモリ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アロケータArenaWithFreeLists</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">C ++で記述するだけでなく、ある種のカスタムアロケーターも確認しました。問題に2回失敗しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArenaWithFreeListsはメモリの一部であり、メモリは2、16、32、64バイトで割り切れるサイズで連続的に割り当てられます。</font><font style="vertical-align: inherit;">メモリが解放された場合、それらは単一のリンクされた空きFreeListsブロックのリストを形成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArenaWithFreeLists</span>
{</span>
    Block * free_lists[<span class="hljs-number">16</span>] {};
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">sizeToPreviousPowerOfTwo</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">return</span> _bit_scan_reverse(size - <span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">char</span> * <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> list_idx = findFreeListIndex(size);<font></font>
        free_lists[list_idx] -&gt;...<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><code>_bit_scan_reverse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">冒頭にアンダースコアが付い</font><font style="vertical-align: inherit;">
た関数</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用しています</font><font style="vertical-align: inherit;">。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「関数に最初にアンダースコアが1つある場合は、そのドキュメントを1回読んでください。2つある場合は2回読んでください。」</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを聞いて読みます：「int _bit_scan_reverse（int a）。 dstを32ビット整数aの最上位セットビットのインデックスに設定します。 aにビットが設定されていない場合、dstは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未定義</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。問題を見つけたようです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++では、この状況はコンパイラーにとって不可能と見なされています。コンパイラーは、コードを最適化するための前提として、未定義の動作、つまりこの「不可能性」を使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラは何も問題はありません-アセンブリ命令を正直に生成します</font></font><code>bsr %edi, %eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ただし、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペランドがゼロの場合、命令は</font></font></strong><code><strong>bsr</strong></code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++レベルではなく、CPUレベルで未定義の動作をします。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースレジスタがゼロの場合、デスティネーションレジスタは変更されません。入力にガベージがあった場合、このガベージも出力に残ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は、コンパイラーがこの命令を配置する場所によって異なります。</font><font style="vertical-align: inherit;">この命令を含む関数はインラインの場合とそうでない場合があります。</font><font style="vertical-align: inherit;">2番目のケースでは、次のコードのようになります。</font></font><br>
<br>
<pre><code class="cpp hljs">bsrl %edi, %eax<font></font>
retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、を使用して、バイナリ内の同様のコードの例を確認しました</font></font><code>objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/6k/4f/lq6k4fg0lwpm2nhwhxbyauyjt2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果によると、ソースレジスタとデスティネーションレジスタが同じである場合があります。</font><font style="vertical-align: inherit;">ゼロがあった場合、結果もゼロになります-すべて正常です。</font><font style="vertical-align: inherit;">しかし、レジスタが異なる場合があり、結果はガベージになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このバグはどのように現れますか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLists配列のインデックスとしてガベージを使用します。</font><font style="vertical-align: inherit;">配列の代わりに、離れたアドレスに移動してメモリアクセスを取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">幸運なことに、近くのほとんどすべてのアドレスがキャッシュからのデータで満たされています-キャッシュを破壊します。</font><font style="vertical-align: inherit;">キャッシュにはファイルのオフセットが含まれています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間違ったオフセットでファイルを読み取りました。</font><font style="vertical-align: inherit;">間違ったオフセットから、チェックサムを取得します。</font><font style="vertical-align: inherit;">しかし、チェックサムはありませんが、何か他のものがあります-このチェックサムは次のデータと一致しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「チェックサムが一致しない、データが破損している」というエラーが表示されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、データは破損していませんが、RAMのキャッシュのみが破損しています。</font><font style="vertical-align: inherit;">データをチェックサムするため、エラーについてすぐに通知されました。</font><font style="vertical-align: inherit;">エラーは</font><font style="vertical-align: inherit;">2015年12月27日</font><font style="vertical-align: inherit;">に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">修正さ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、祝いに行きました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、間違ったコードは少なくとも修正できます。</font><font style="vertical-align: inherit;">しかし、ハードウェアのバグを修正する方法は？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鉄のバグ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらはバグではなく、物理法則-避けられない影響です。物理法則によると、鉄は不可避的にバギーです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAIDへの非アトミックな書き込み</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。たとえば、RAID1を作成しました。 2つのハードドライブで構成されています。これは、1つのサーバーが分散システムであることを意味します。データは、あるハードドライブと別のハードドライブに書き込まれます。しかし、データが1つのディスクに書き込まれ、2番目のディスクへの記録中に電源が失われた場合はどうなりますか？ RAID1アレイ上のデータは一貫していません。どちらかのバイトを読み取るため、どのデータが正しいかを理解できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログを配置することでこれに対処できます。たとえば、ZFSではこの問題は解決されていますが、それについては後で詳しく説明します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HDDとSSDのビット腐敗</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ハードドライブとSSDのビットは、そのように悪くなる可能性があります。最新のSSD、特にマルチレベルセルを備えたSSDは、セルが常に劣化するように設計されています。エラー訂正コードは役立ちますが、セルが劣化しすぎて保存できない場合もあります。未検出のエラーが取得されます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMのビットフリップ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ただし、ECCについてはどうですか？）サーバーのRAMでは、ビットも破損しています。また、エラー修正コードもあります。エラーが発生した場合、それらは通常、dmesgのLinuxカーネルログのメッセージから確認できます。エラーが多い場合、「メモリのN、000,000エラーが修正されました。」のようなメッセージが表示されます。しかし、個々のビットは気づかれず、確かに何かがバグを起こします。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPUおよびネットワークレベルでビットが反転します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 CPUレベル、CPUキャッシュ、そしてもちろん、ネットワークを介してデータを送信する際のエラーがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鉄のエラーは通常どのように現れますか？ 「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不正なznodeがClickHouseの起動を妨げています</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」というチケットがGitHubに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">届きます-ZooKeeper</font></a><font style="vertical-align: inherit;">ノードのデータが破損しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZooKeeperでは、通常、メタデータをプレーンテキストで記述します。彼には何か問題があります-「</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レプリカ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」は非常に奇妙に書かれています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/gk/zk/8_gkzkxlb1dzwhiph0saer-0d50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードのバグが原因で1ビットが変更されることはほとんどありません。もちろん、そのようなコードを書くこともできます。ブルームフィルターを使用して、特定のアドレスのビットを変更し、アドレスを誤って計算し、間違ったビットを変更し、データに落ちます。それはそれだ、今ClickHouseでは「ありません</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レプリカ」</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、「</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REPLI </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bの</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」とその上のすべてのデータが間違っています。しかし、通常、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1ビットの変化は鉄の問題の症状です</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらくあなたはビットスクワッティングの例を知っています。</font><font style="vertical-align: inherit;">Artyom Dinaburg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は実験を行いました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ユーザーが自分でこれらのドメインにアクセスすることはありませんが、トラフィックが多いインターネット上のドメインがあります。</font><font style="vertical-align: inherit;">たとえば、そのようなドメインFB-CDN.comはFacebook CDNです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artyomは同様のドメイン（および他の多くのドメイン）を登録しましたが、1つ変更しました。</font><font style="vertical-align: inherit;">たとえば、FB-CDN.comではなくFA-CDN.comです。</font><font style="vertical-align: inherit;">ドメインはどこにも公開されていませんでしたが、トラフィックはそれに来ました。</font><font style="vertical-align: inherit;">FB-CDNホストがHTTPヘッダーに書き込まれ、ユーザーのデバイスのRAMのエラーが原因でリクエストが別のホストに送信されることがありました。</font><font style="vertical-align: inherit;">エラー訂正機能付きのRAMは必ずしも役立つとは限りません。</font><font style="vertical-align: inherit;">時にはそれが干渉し、脆弱性につながります（Rowhammer、ECCploit、RAMBleedについて読んでください）。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論：データは常に自分でチェックサムしてください。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムに書き込む場合は必ずチェックサムしてください。</font><font style="vertical-align: inherit;">ネットワーク経由で送信する場合は、チェックサムも実行します。チェックサムがあることを期待しないでください。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その他のバグ！..</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロダクションクラスタメトリック</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リクエストに応答してユーザーが例外を受け取ることがあります。「チェックサムが一致しません：データが破損しています」-チェックサムが正しくなく、データが破損しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/lb/wz/jylbwzqxrbk-g3hgygq4bktgdr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーメッセージには、詳細なデータが表示されます。予想される小切手金額、このデータに実際に含まれる小切手金額、小切手金額を確認するブロックのサイズ、および例外コンテキスト。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のサーバーからネットワーク経由でパケットを受信すると、例外が表示されました。</font><font style="vertical-align: inherit;">おそらく、再び記憶、競合状態、または何か他のものを通過します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例外は2015年に発生しました。バグが修正され、表示されなくなりました。 2019年2月、彼は突然再び現れました。このとき、私は会議の1つにいて、同僚が問題に対処しました。エラーは、ClickHouseを備えた1000台のサーバー間で1日に数回再現されました。あるサーバーで統計を収集してから、別のサーバーで統計を収集することはできません。同時に、現時点では新しいリリースはありませんでした。それはうまくいかず、問題を解決しませんでしたが、数日後にエラー自体は消えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らはエラーを忘れ、2019年5月15日にそれが繰り返されました。私たちは彼女との付き合いを続けました。最初に行ったのは、使用可能なすべてのログとグラフを確認することでした。彼は一日中それらを研究し、何も理解せず、どんなパターンも見つけませんでした。問題を再現できない場合、唯一のオプションはすべてのケースを収集し</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てパターンを探すことです</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして中毒。</font><font style="vertical-align: inherit;">おそらく、Linuxカーネルがプロセッサで正しく動作せず、レジスタを誤って保存またはロードします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説とパターン</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E5-2683 v4を搭載した9台のサーバーのうち7台が失敗しました。しかし、エラーが発生しやすいのは、E5-2683 v4の約半分だけが空の仮説であるということです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間違いは通常繰り返されません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 mtauxyzクラスターに加えて、実際に破損したデータ（ディスク上の不良データ）があります。これは別のケースであり、仮説を棄却します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーはLinuxカーネルに依存しません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -別のサーバーで確認したところ、何も見つかりませんでした。 kern.logに興味深いものはなく、メッセージ</font></font><code>machine check exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もありません。再送信機、CPU、IO、ネットワークを含むネットワークグラフィックスでは、何も興味深いものはありません。エラーが発生し、表示されないサーバー上のすべてのネットワークアダプターは同じです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パターンはありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。何をすべきか？引き続きパターンを探します。 2回目の試み。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は稼働時間サーバーを調べます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稼働時間は</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長く</font><strong><font style="vertical-align: inherit;">、サーバーは安定して動作し</font></strong><font style="vertical-align: inherit;">、segfaultなどはそうではありません。プログラムがsegfaultでクラッシュしたのを見たときはいつも喜んでいます。少なくともクラッシュしました。さらに悪いことに、エラーがあると、何かを台無しにしますが、誰もそれに気づきません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーは日ごとにグループ化さ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、数日以内に発生します。いくつかの2日間で、より多くのデータが表示され、いくつかのデータが表示され、その後、さらに表示されます。エラーの発生時間を正確に特定することはできません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部のエラーは、パッケージと予想した小切手金額に一致します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどのエラーには、2つのパッケージオプションしかありません。エラーメッセージにチェックサムの値そのものを追加したのは幸運でした。これは統計のコンパイルに役立ちました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーパターンなし</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを読み取る場所。チェックサムする圧縮ブロックのサイズは1キロバイト未満です。 HEXでパッケージサイズを見ました。これは私には役に立ちませんでした-パケットサイズとチェックサムのバイナリ表現は目立ちません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーは修正しませんでした-もう一度パターンを探していました。 3回目の試み。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何らかの理由で、エラー</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はクラスターの1つ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Vladimir DCの3番目のレプリカ）で</font><font style="vertical-align: inherit;">のみ表示さ</font><strong><font style="vertical-align: inherit;">れ</font></strong><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">（都市名でデータセンターを呼び出します）。 2019年2月に、Vladimirs DCでもエラーが発生しましたが、ClickHouseの別のバージョンです。これは、間違ったコードを書いたという仮説に対するもう1つの議論です。すでに2月から5月までに3回書き直しました- </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーはおそらくコードにありません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワーク経由でパケットを読み取るときのすべてのエラー-</font></font><code>while receiving packet from</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">エラーが発生したパッケージは、リクエストの構造によって異なります。</font><font style="vertical-align: inherit;">構造が異なるリクエストの場合、異なるチェックサムでのエラー。</font><font style="vertical-align: inherit;">ただし、エラーが同じチェックサムにあるリクエストでは、定数は異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つを除いて、エラーのあるすべての要求は</font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">しかし、比較のために、1つの非常に単純な要求があり、そのための圧縮ブロックサイズは75バイトだけです。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(ReceiveTimestamp) <span class="hljs-keyword">FROM</span> tracking_events_all 
<span class="hljs-keyword">WHERE</span> APIKey = <span class="hljs-number">1111</span> <span class="hljs-keyword">AND</span> (OperatingSystem <span class="hljs-keyword">IN</span> (<span class="hljs-string">'android'</span>, <span class="hljs-string">'ios'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
影響力の仮説を棄却する</font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も興味深いのは、影響を受けるサーバー</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が名前によって範囲にグループ化されていること</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です</font></font><br>
<code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は疲れていて、絶望的で、完全に妄想的なパターンを探し始めました。</font><font style="vertical-align: inherit;">数秘術を使用してコードをデバッグできなかったのは良いことです。</font><font style="vertical-align: inherit;">しかし、まだリードがありました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題のあるサーバーのグループは2月と同じです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題のあるサーバーは、データセンターの特定の場所にあります。</font><font style="vertical-align: inherit;">DCウラジミールにはいわゆるラインがあります-その異なる部分：VLA-02、VLA-03、VLA-04。</font><font style="vertical-align: inherit;">エラーは明確にグループ化されています。一部のキューでは問題あり（VLA-02）、その他の問題（VLA-03、VLA-04）では問題があります。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイピングのデバッグ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「spear」メソッドを使用してデバッグするだけでした。</font><font style="vertical-align: inherit;">これは、「そうしようとするとどうなるか」という仮説を立てることを意味します。</font><font style="vertical-align: inherit;">データを収集します。</font><font style="vertical-align: inherit;">たとえば</font></font><code>query_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パケットサイズが</font></font><code>size of compressed block</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に小さい（= 107）</font><font style="vertical-align: inherit;">テーブルに</font><font style="vertical-align: inherit;">エラー</font><font style="vertical-align: inherit;">がある</font><font style="vertical-align: inherit;">単純なクエリ</font><font style="vertical-align: inherit;">を見つけました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/zz/fd/cszzfdvfkob2rhon1-n_xfnqtn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストを受け取ってコピーし、clickhouse-localを使用して手動で実行しました。</font></font><br>
<br>
<pre><code class="sql hljs">strace -f -e trace=network -s 1000 -x \<font></font>
clickhouse-local <span class="hljs-comment">--query "</span>
    <span class="hljs-keyword">SELECT</span> uniqIf(DeviceIDHash, SessionType = <span class="hljs-number">0</span>)
    <span class="hljs-keyword">FROM</span> remote(<span class="hljs-string">'127.0.0.{2,3}'</span>, mobile.generic_events)
    <span class="hljs-keyword">WHERE</span> StartDate = <span class="hljs-string">'2019-02-07'</span> <span class="hljs-keyword">AND</span> APIKey <span class="hljs-keyword">IN</span> (<span class="hljs-number">616988</span>,<span class="hljs-number">711663</span>,<span class="hljs-number">507671</span>,<span class="hljs-number">835591</span>,<span class="hljs-number">262098</span>,<span class="hljs-number">159700</span>,<span class="hljs-number">635121</span>,<span class="hljs-number">509222</span>)
        <span class="hljs-keyword">AND</span> EventType = <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> TOTALS<span class="hljs-string">" --config config.xml</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
straceの助けを借りて、ネットワーク経由でブロックのスナップショット（ダンプ）を受け取りました。このリクエストが実行されたときに受け取ったのとまったく同じパケットであり、それらを調べることができます。これにはtcpdumpを使用できますが、不便です。本番トラフィックから特定のリクエストを分離するのは困難です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
straceを使用すると、ClickHouseサーバー自体をトレースできます。しかし、このサーバーは運用環境で機能します。これを実行すると、理解できない一連の情報が表示されます。したがって、1つの要求を実行する別のプログラムを起動しました。このプログラムではすでにstraceを実行して、ネットワーク経由で送信されたものを取得しています。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストはエラーなしで実行されます-エラーは再生されません</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。再現されれば、問題は解決されます。したがって、パケットをテキストファイルにコピーし、手動でプロトコルの解析を開始しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f5/0y/-8/f50y-8qvloj4brnns-nvgydpbsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小切手金額は予想通りでした。</font><font style="vertical-align: inherit;">これは、時折、別のときに他のリクエストでエラーが発生したパッケージです。</font><font style="vertical-align: inherit;">しかし、これまでのところエラーはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージを受け取り、各バイトの1ビットを置き換えるときにチェック量をチェックする単純なプログラムを作成しました。</font><font style="vertical-align: inherit;">プログラムは、可能なすべての位置でビットフリップを実行し、チェック金額を読み取りました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/fn/wr/3mfnwrp1udvm_ecrw0lnpcyoz0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はプログラムを開始しましたが、1ビットの値を変更すると、そのチェックサムが壊れてしまいます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハードウェアの問題</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアにエラーがある場合（たとえば、メモリを介した駆動）、シングルビットフリップは起こりそうにありません。</font><font style="vertical-align: inherit;">したがって、新しい仮説が現れました-問題は腺にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラップトップのふたを閉じて、次のように言うことができます。「問題は私たちの側ではありませんが、ハードウェアでは、これを行いません。」</font><font style="vertical-align: inherit;">しかし、いいえ、問題がどこにあるかを理解してみましょう：RAM、ハードドライブ、プロセッサ、ネットワークカード、またはネットワーク機器のネットワークカードRAM。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハードウェアの問題を特定する方法は？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題は発生し、特定の日に消えました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影響を受けるサーバーは、名前でグループ化されています</font></font><code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題のあるサーバーのグループは2月と同じです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題のあるサーバーは、データセンターの特定のキューにのみあります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークエンジニアに質問がありました-データがネットワークスイッチを打っています。その日、ネットワークエンジニアがスイッチを他のスイッチと正確に交換したことがわかりました。質問の後、彼らはそれらを以前のものに置き換え、問題は消えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は解決されましたが、質問はまだ残っています（エンジニア向けではなくなりました）。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークスイッチでECC（エラー修正メモリ）が役に立たないのはなぜですか？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のビットフリップが相互に補正できるため、エラーが検出されません。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCPチェックサムが役に立たないのはなぜですか？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼らは弱いです。データの1ビットのみが変更されている場合、TCPチェックサムは常に変更を確認します。 2つのビットが変更された場合、変更は検出されない可能性があります-それらは互いにキャンセルします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージで変更されたビットは1つだけですが、エラーは表示されません。これは、TCPセグメントで2ビットが変更されたためです。彼らはそこからチェックサムを計算し、それが一致しました。しかし、1つのTCPセグメントに、アプリケーションの複数のパケットが配置されています。そのうちの1つについては、すでにチェックサムを検討しています。このパケットで変更されたのは1ビットだけです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イーサネットチェックサムが役に立たない理由-それらはTCPよりも強力ですか？</font></font></strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イーサネットチェック金額</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのセグメントを介した送信中にデータが壊れないように、データをチェックサマリーします（用語が間違っていることがあります。私はネットワークエンジニアではありません）。</font><font style="vertical-align: inherit;">ネットワーク機器はこれらのパケットを転送し、転送中に一部のデータを転送できます。</font><font style="vertical-align: inherit;">したがって、小切手金額は単純に再集計されます。</font><font style="vertical-align: inherit;">確認したところ、パッケージは変更されていません。</font><font style="vertical-align: inherit;">しかし、ネットワークスイッチ自体に打ち勝つと、チェック金額が再計算され（それは異なります）、パケットがさらに転送されます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたを救うものは何もありません-自分でチェックサムしてください。</font><font style="vertical-align: inherit;">誰かがあなたのためにこれをすることを期待しないでください。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データブロックの場合、128ビットのチェックサムが考慮されます（念のため、これはやり過ぎです）。</font><font style="vertical-align: inherit;">エラーについてユーザーに正しく通知します。</font><font style="vertical-align: inherit;">データはネットワーク経由で送信され、破損しますが、どこにも記録されません。すべてのデータは整然としており、心配する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseに保存されているデータは一貫しています。</font><font style="vertical-align: inherit;">ClickHouseでチェックサムを使用します。</font><font style="vertical-align: inherit;">チェックサムが大好きなので、次の3つのオプションをすぐに検討します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル、ネットワークへの書き込み時の圧縮データブロック用。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計チェックは、調整検証用の圧縮データの合計です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計チェックは、照合検証のための非圧縮データの合計です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ圧縮アルゴリズムにはバグがあり、これは既知のケースです。</font><font style="vertical-align: inherit;">したがって、データが複製されるときに、圧縮データの合計チェックサムと非圧縮データの合計量も考慮します。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小切手の金額を数えることを恐れないでください、彼らは遅くなりません。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もちろん、どれをどのようにカウントするかによって異なります。</font><font style="vertical-align: inherit;">ニュアンスはありますが、小切手金額は必ず考慮してください。</font><font style="vertical-align: inherit;">たとえば、圧縮データから数えると、データが少なくなり、速度が低下することはありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーメッセージの改善</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがハードウェアの問題であるというエラーメッセージを受け取ったときに、ユーザーにどのように説明しますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t4/f6/rj/t4f6rj1mtuo38kojydfgddfh2nc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェックサムが一致しない場合、例外を送信する前に、念のためすべてのビットを変更しようとします。変更時にチェックサムが収束し、1ビットが変更された場合、問題はおそらくハードウェアにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このエラーを検出でき、1つのビットが変更されたときにエラーが変更された場合は、修正してみませんか？私たちはこれを行うことができますが、常にエラーを修正した場合、ユーザーは機器に問題があることを知りません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スイッチに問題があることがわかったとき、他の部門の人々は報告を始めました。そして、PostgreSQLで何かが実現しました！」これは良いことですが、問題を早期に報告することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい診断リリースをリリースしたとき、それが機能した最初のユーザーが1週間後に書きました。「メッセージです-問題は何ですか？」</font><font style="vertical-align: inherit;">残念ながら、彼はそれを読みませんでした。</font><font style="vertical-align: inherit;">しかし、99％の確率で読んで、エラーが1つのサーバーに表示される場合、問題はハードウェアにあると提案しました。</font><font style="vertical-align: inherit;">私がコードを間違って書いた場合に備えて、残りのパーセンテージを残します-これは起こります。</font><font style="vertical-align: inherit;">その結果、ユーザーはSSDを交換し、問題は解消しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ内の「デリリウム」</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この興味深く予期しない問題は私を心配させました。 Yandex.Metricaデータがあります。単純なJSONは、列の1つ（データベースのカウンターのJavaScriptコードからのユーザーパラメーター）でデータベースに書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある種のリクエストをすると、ClickHouseサーバーがsegfaultでクラッシュしました。スタックトレースから、問題が何であるかを理解しました-他の国からの外部の貢献者からの新たなコミット。コミットが修正され、segfaultが消えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は同じリクエストを実行します：</font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseでJSONを取得しますが、ここでもナンセンス、すべてがゆっくりと動作します。 JSONを取得しましたが、10 MBです。私はそれを表示して、より注意深く見ます。</font></font><code>{"jserrs": cannot find property of object undefind...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それから、メガバイトのバイナリコードが落ちました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/ab/1g/ntab1gtbj8eialtctjq4nu-ucdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これもまた、記憶や競争状態からの一節であるとの考えがありました。</font><font style="vertical-align: inherit;">そのようなバイナリデータの多くは悪いです、それは何でも含むことができます。</font><font style="vertical-align: inherit;">もしそうなら、今私はそこにパスワードと秘密鍵を見つけるでしょう。</font><font style="vertical-align: inherit;">しかし、何も見つからなかったため、すぐに仮説を却下しました。</font><font style="vertical-align: inherit;">多分これはClickHouseサーバー上の私のプログラムのバグですか？</font><font style="vertical-align: inherit;">おそらく、書き込みを行うプログラム（C ++でも書き込まれます）で-突然、突然、彼女がダンプメモリをClickHouseに入れましたか？</font><font style="vertical-align: inherit;">この地獄で、私は文字を注意深く見始め、それがそれほど単純ではないことに気付きました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手がかりの道</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じゴミが、互いに独立して2つのクラスターで記録されました。</font><font style="vertical-align: inherit;">データはジャンクですが、有効なUTF-8です。</font><font style="vertical-align: inherit;">このUTF-8には、奇妙なURL、フォント名、および「I」という文字が連続して含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さなキリル文字「私」の何が特別なのですか？</font><font style="vertical-align: inherit;">いいえ、これはYandexではありません。</font><font style="vertical-align: inherit;">実際には、Windows 1251のエンコーディングでは、255番目の文字です。</font><font style="vertical-align: inherit;">Linuxサーバーでは、Windows 1251エンコーディングを使用する人はいません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはブラウザのダンプであることがわかります。メトリックカウンタのJavaScriptコードがJavaScriptエラーを収集します。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結局のところ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、答えは簡単</font><font style="vertical-align: inherit;">です。</font><strong><font style="vertical-align: inherit;">すべてユーザーからのもの</font></strong><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここからも結論を出すことができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターネット上のバグ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Metricaは、インターネット上の10億のデバイス（PC上のブラウザー、携帯電話、タブレット）からトラフィックを収集します。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゴミは必然的に</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発生します。ユーザーデバイスには、信頼できないRAMと過熱する恐ろしいハードウェアの至る所にバグがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースには30兆を超える行（ページビュー）が格納されます。このテーブルのデータを分析すると、そこに何でも見つけることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、データベースに書き込む前に、このガベージを単にフィルタリングするのが正しいです。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースにゴミを書き込む必要はありません-彼女はそれが好きではありません。</font></font></b><br>
<br>
<blockquote> HighLoad++   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 133 </a>   ),       -  ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">++</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PHP Russia 2020 Online</a>. <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Badoo</a>, <b> PHP Russia 2020 Online  </b>. PHP Russia 2020 Online  13 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.<br>
<br>
          — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,     . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja497324/index.html">「目の前のりんごのように...」またはマイクロコントローラー（CannyまたはArduino）とRaspberry PIに基づいてシンプルなセキュリティシステムを作成します</a></li>
<li><a href="../ja497326/index.html">DNSSECによるより安全なSSH接続</a></li>
<li><a href="../ja497328/index.html">言語を学習する簡単な方法（すべて）</a></li>
<li><a href="../ja497330/index.html">Chromeリモートデスクトップ。リモートサポート</a></li>
<li><a href="../ja497332/index.html">ヒューストン、問題があります。システム設計の失敗</a></li>
<li><a href="../ja497336/index.html">90年代のコンピュータブランド、パート3、最終</a></li>
<li><a href="../ja497338/index.html">先週交通機関に何が起こったのか-危機が進展している</a></li>
<li><a href="../ja497340/index.html">COVID-19：ニュースの読み取りを停止してデータの分析を開始する方法</a></li>
<li><a href="../ja497342/index.html">APIリクエストを監視するブラウザー：フロントエンドとバックエンド間の安全な通信の構築</a></li>
<li><a href="../ja497346/index.html">RustとLLVMでnumpy、scikit、pandasを100倍高速化：開発者Weldへのインタビュー</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>