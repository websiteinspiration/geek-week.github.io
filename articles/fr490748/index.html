<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèº üè© ü§≥üèΩ La t√¢che du d√©veloppeur ou comment nous avons num√©ris√© des scanners manuels sans fournisseur üßôüèΩ üåπ üôåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous. 
 
 Nous, Victor Antipov et Ilya Aleshin, parlerons aujourd'hui de notre exp√©rience avec les p√©riph√©riques USB via Python PyUSB et un ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>La t√¢che du d√©veloppeur ou comment nous avons num√©ris√© des scanners manuels sans fournisseur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/490748/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour √† tous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous, Victor Antipov et Ilya Aleshin, parlerons aujourd'hui de notre exp√©rience avec les p√©riph√©riques USB via Python PyUSB et un peu de r√©tro-ing√©nierie.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/ux/va/j4uxvafzrna4qe-37a6miqsyg1u.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2019, le d√©cret n ¬∞ 224 du gouvernement de la F√©d√©ration de Russie sur l'approbation des r√®gles d'√©tiquetage des produits du tabac au moyen de l'identification et les modalit√©s de mise en place d'un syst√®me national d'information pour le contr√¥le de la circulation des marchandises soumises √† l'√©tiquetage obligatoire au moyen de l'identification des produits du tabac est entr√© en vigueur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le document explique qu'√† partir du 1er juillet 2019, les fabricants sont tenus d'√©tiqueter chaque paquet de tabac. Et les distributeurs directs devraient recevoir ces produits avec la conception d'un document de transfert universel (UPD). Les magasins, √† leur tour, doivent enregistrer la vente de produits √©tiquet√©s via la caisse enregistreuse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, √† partir du 1er juillet 2020, les produits du tabac non marqu√©s sont interdits. Cela signifie que tous les paquets de cigarettes doivent √™tre √©tiquet√©s avec un code-barres Datamatrix sp√©cial. Et - un point important - il s'est av√©r√© que Datamatrix ne sera pas ordinaire, mais inverse. Ce n'est pas un code noir sur blanc, mais vice versa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons test√© nos scanners, et il s'est av√©r√© que la plupart d'entre eux doivent √™tre reflash√©s / recycl√©s, sinon ils ne peuvent tout simplement pas fonctionner normalement avec ce code-barres. Cette tournure des √©v√©nements nous a garanti un mal de t√™te s√©v√®re, car notre entreprise compte de nombreux magasins diss√©min√©s sur un vaste territoire. Plusieurs dizaines de milliers de caisses - et extr√™mement peu de temps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que fallait-il faire? </font><font style="vertical-align: inherit;">Il y a deux options. </font><font style="vertical-align: inherit;">Premi√®rement: les ing√©nieurs de l'installation reflasher et ajuster manuellement les scanners. </font><font style="vertical-align: inherit;">Deuxi√®mement: nous travaillons √† distance et, de pr√©f√©rence, nous couvrons plusieurs scanners en une seule fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re option, √©videmment, ne nous convenait pas: il faudrait d√©penser de l'argent pour des visites d'ing√©nieurs sur le terrain, et il est difficile de contr√¥ler et de coordonner le processus dans ce cas. </font><font style="vertical-align: inherit;">Mais la chose la plus importante est que les gens travailleraient, c'est-√†-dire que potentiellement nous aurions beaucoup d'erreurs et, tr√®s probablement, ne respecterions pas la date limite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me option est bonne pour tout le monde, sinon pour un mais. </font><font style="vertical-align: inherit;">Certains fournisseurs ne disposaient pas des outils de flash √† distance dont nous avions besoin pour tous les syst√®mes d'exploitation requis. </font><font style="vertical-align: inherit;">Et comme les d√©lais √©taient serr√©s, j'ai d√ª r√©fl√©chir de ma propre t√™te.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous d√©crirons comment nous avons d√©velopp√© des outils pour les scanners portables pour le syst√®me d'exploitation Debian 9.x (nous avons tout le box-office Debian).</font></font><br>
<br>
<h3> :   </h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dit Victor Antipov.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'utilitaire officiel fourni par le vendeur fonctionne sous Windows, et uniquement avec IE. L'utilitaire peut flasher et configurer le scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme le syst√®me cible est Debian, nous avons install√© le serveur de redirection USB sur le serveur Debian et le client de redirection USB sur Windows. √Ä l'aide des utilitaires de redirection USB, le scanner a √©t√© transf√©r√© de la machine Linux √† la machine Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilitaire du fournisseur Windows a vu le scanner et l'a m√™me fait clignoter normalement. Ainsi, la premi√®re conclusion a √©t√© tir√©e: rien ne d√©pend de l'OS, l'affaire est dans le protocole clignotant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'ACCORD. Un clignotement a √©t√© lanc√© sur une machine Windows et un vidage a √©t√© supprim√© sur une machine Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont bourr√© le vidage dans WireShark et ... √©taient tristes (je vais omettre une partie des d√©tails du vidage, ils ne sont d'aucun int√©r√™t). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quel vidage nous a montr√©:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/ut/sa/5cutsausebu86kbucq6rfksz7wu.png"><br>
<br>
<img src="https://habrastorage.org/webt/9z/ex/jo/9zexjowdglq6cjc88ln5r6tlkcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les adresses 0000-0030, √† en juger par Wireshark, sont des informations de service USB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©tions int√©ress√©s par la pi√®ce 0040-0070. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rien n'√©tait clair √† partir d'une trame de transmission, √† l'exception des caract√®res MOCFT. Ces symboles se sont av√©r√©s √™tre des symboles du fichier du firmware, ainsi que du reste des symboles jusqu'√† la fin du cadre (le fichier du firmware est mis en surbrillance): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/ls/mf/yblsmf2htqk4n-lsa3u702yy5vm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que signifiaient les symboles fd 3e 02 01 fe, personnellement, comme Ilya, je n'en avais aucune id√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai regard√© le cadre suivant (les informations de service sont supprim√©es ici, le fichier du firmware est mis en surbrillance): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/sr/ut/r3srutakf1ioytxspf1zurv9pww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">ce qui est devenu clair? Que les deux premiers octets sont une sorte de constante. Tous les blocs suivants l'ont confirm√©, mais avant la fin du bloc de transmission:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j7/t6/ux/j7t6uxe8auhqxaxp5azeolv5jwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce cadre est √©galement entr√© dans une stupeur, car la constante a chang√© (mise en √©vidence) et, curieusement, il y avait une partie du fichier. La taille des octets transmis du fichier indique que 1024 octets ont √©t√© transf√©r√©s. Ce que les octets restants signifiaient - je ne savais pas encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, comme un ancien surnom BBS, j'ai r√©vis√© les protocoles de transfert standard. 1024 octets, aucun protocole transmis. Il a commenc√© √† √©tudier le mat√©riel et est tomb√© sur le protocole 1K Xmodem. Il a permis de transmettre 1024, mais avec une nuance: au d√©but seulement 128, et seulement en l'absence d'erreurs le protocole a augment√© le nombre d'octets transmis. J'ai imm√©diatement eu une transmission de 1024 octets. J'ai d√©cid√© d'√©tudier les protocoles de transmission, et plus particuli√®rement le X-modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait deux variantes du modem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, le format du package XMODEM avec prise en charge CRC8 (XMODEM d'origine):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/dq/7w/wudq7w7yg59duxo2ok3rcng5bga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement, le format de paquet XMODEM avec prise en charge CRC16 (XmodemCRC): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i2/cz/j3/i2czj3nd212vhlbms9uqrysd5xa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il semble similaire, √† l'exception de SOH, du num√©ro de paquet et du CRC et de la longueur du paquet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai regard√© le d√©but du deuxi√®me bloc de transmission (et j'ai encore vu le fichier du firmware, mais avec un retrait de 1024 octets):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/lk/nb/5vlknbhbecr2d3d7uigb19dh_cg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai vu l'en-t√™te familier fd 3e 02, mais les deux octets suivants ont d√©j√† chang√©: c'√©tait 01 fe, et il est devenu 02 fd. Puis j'ai remarqu√© que le deuxi√®me bloc est maintenant num√©rot√© 02 et ainsi compris: devant moi se trouve la num√©rotation du bloc de transmission. La premi√®re transmission 1024 est 01, la deuxi√®me 02, la troisi√®me 03 et ainsi de suite (mais en hexad√©cimal, bien s√ªr). Mais que signifie le passage de fe √† fd? Les yeux ont vu une diminution de 1, le cerveau a rappel√© que les programmeurs comptent √† partir de 0, pas √† partir de 1. Mais alors pourquoi le premier bloc 1, pas 0? Je n'ai pas trouv√© la r√©ponse √† cette question. Mais j'ai compris comment le deuxi√®me bloc est consid√©r√©. Le deuxi√®me bloc n'est rien de plus que FF - (moins) le num√©ro du premier bloc. Ainsi, le deuxi√®me bloc a √©t√© d√©sign√© comme = 02 (FF-02) = 02 FD. La lecture ult√©rieure de la d√©charge a confirm√© mon intuition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis l'image suivante du programme a commenc√© √† √©merger: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le d√©but du programme</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 02 - D√©but </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
01 FE - compteur de transmission </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transmission (34 blocs, 1024 octets sont transmis) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 3e 1024 octets de donn√©es (divis√©s en blocs de 30 octets). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fin de transmission </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reste de donn√©es √† aligner sur 1024 octets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä quoi ressemble la trame de fin de transfert de bloc: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ee/t9/dmeet9sttaokhdirciuxag4p9y4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
fd 25 - signal √† la fin du transfert de bloc. 2f 52 suivant - les restes du fichier jusqu'√† 1024 octets. 2f 52, √† en juger par le protocole, est une somme de contr√¥le CRC de 16 bits.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base de l'ancienne m√©moire, j'ai cr√©√© un programme en C qui a extrait 1024 octets d'un fichier et lu le CRC 16 bits. </font><font style="vertical-align: inherit;">Le lancement du programme a montr√© qu'il ne s'agit pas d'un CRC 16 bits. </font><font style="vertical-align: inherit;">Encore une fois stupeur - pendant environ trois jours. </font><font style="vertical-align: inherit;">Pendant tout ce temps, j'ai essay√© de comprendre ce que cela pouvait √™tre sinon une somme de contr√¥le. </font><font style="vertical-align: inherit;">En √©tudiant des sites en anglais, j'ai d√©couvert que le X-modem utilise son propre calcul de somme de contr√¥le - CRC-CCITT (XModem). </font><font style="vertical-align: inherit;">Je n'ai trouv√© aucune impl√©mentation en C pour ce calcul, mais j'ai trouv√© un site qui lisait cette somme de contr√¥le en ligne. </font><font style="vertical-align: inherit;">En t√©l√©chargeant 1024 octets de mon fichier sur la page Web, le site m'a montr√© une somme de contr√¥le qui co√Øncidait compl√®tement avec la somme de contr√¥le du fichier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hourra! </font><font style="vertical-align: inherit;">La derni√®re √©nigme est r√©solue, maintenant vous deviez cr√©er votre propre firmware. </font><font style="vertical-align: inherit;">Ensuite, j'ai transf√©r√© mes connaissances (et elles ne sont rest√©es que dans ma t√™te) √† Ilya, qui est famili√®re avec des outils puissants - Python.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation de programme</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rapport√© par Ilya Aleshin. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ayant re√ßu les instructions appropri√©es, j'√©tais tr√®s ¬´heureux¬ª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O√π commencer? </font><font style="vertical-align: inherit;">D'accord, depuis le d√©but. </font><font style="vertical-align: inherit;">ÔÅä Du dumping √† partir d'un port USB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez USB-pcap </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://desowin.org/usbpcap/tour.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Choisissez le port auquel l'appareil est connect√© et le fichier o√π nous enregistrerons le vidage. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/ax/xp/gaaxxp3qdqajous7didfd7gwkg8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous connectons le scanner √† la machine sur laquelle le logiciel natif EZConfigScanning pour Windows est install√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/oo/le/olooleeirgestw3q0gzvhqvzr58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On y trouve l'int√©r√™t d'envoyer des commandes √† l'appareil. </font><font style="vertical-align: inherit;">Mais qu'en est-il des √©quipes? </font><font style="vertical-align: inherit;">O√π les obtenir? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le programme d√©marre, l'√©quipement est interrog√© automatiquement (nous le verrons un peu plus tard). </font><font style="vertical-align: inherit;">Et il y avait des codes √† barres de formation √† partir de documents d'√©quipement officiels. </font><font style="vertical-align: inherit;">DEFALT. </font><font style="vertical-align: inherit;">Voici notre √©quipe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/dv/gf/8vdvgfiuthogftttgzdsxym22_4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es n√©cessaires sont re√ßues. </font><font style="vertical-align: inherit;">Ouvrez dump.pcap via Wireshark.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloquer au d√©marrage EZConfigScanning. Les points rouges sont des endroits √† surveiller. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/ju/0x/wpju0xwxz9_hgex0jnnyttjxqpa.png"><br>
<br>
<img src="https://habrastorage.org/webt/nw/6s/so/nw6ssotdpggn37qvn9kvayxhxde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyant tout cela pour la premi√®re fois, j'ai perdu courage. O√π creuser plus loin n'est pas clair. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu de brainstorming et-et-et ... Aha! Dans une d√©charge publique </font><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recherche sur Google ce qu'est URB_INTERRUPT. J'ai d√©couvert qu'il s'agit d'une m√©thode de transfert de donn√©es. Et il existe 4 m√©thodes de ce type: contr√¥le, interruption, isochrone, en vrac. Vous pouvez les lire s√©par√©ment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et les adresses des points de terminaison dans l'interface du p√©riph√©rique USB peuvent √™tre obtenues soit via la commande ¬´lsusb ‚Äìv¬ª, soit au moyen de pyusb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant trouver tous les appareils avec ce VID. Vous pouvez rechercher sp√©cifiquement par VID: PID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/xp/i_/fnxpi_m69b43p6yzpeoh3atps0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemble √† ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g0/h4/td/g0h4tdpscytduyzmj4xqe31r5s4.png"><br>
<br>
<img src="https://habrastorage.org/webt/d4/wf/5k/d4wf5k6asqr5nvofve-ntd5sm4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc les informations n√©cessaires: les commandes P_INFO. ou DEFALT, indique o√π √©crire les commandes endpoint = 03 et o√π obtenir la r√©ponse endpoint = 86. Il ne reste plus qu'√† traduire les commandes en hexad√©cimal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/io/wf/ui/iowfuid0hhvl6q6zpb9kfds3tny.png"><br>
<br>
<img src="https://habrastorage.org/webt/0p/gr/2j/0pgr2jw1u6tj5vqetitjg3g6chw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous avons d√©j√† trouv√© le p√©riph√©rique, d√©connectez-le du noyau ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/xy/84/jixy849fy7l81g9tenjxpf7uymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... et √©crivez au point de terminaison avec l'adresse 0x03, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qx/v0/nt/qxv0nttjmnddvekfmbnfq9vebfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... puis lisez la r√©ponse du point de terminaison avec l'adresse 0x86. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kj/xn/e2/kjxne2x9ab6spmxnk2ac3bnroc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©ponse structur√©e:</font></font><br>
<br>
<pre><code class="plaintext hljs">P_INFOfmt: 1<font></font>
mode: app<font></font>
app-present: 1<font></font>
boot-present: 1<font></font>
hw-sn: 18072B44CA<font></font>
hw-rev: 0x20<font></font>
cbl: 4<font></font>
app-sw-rev: CP000116BBA<font></font>
boot-sw-rev: CP000014BAD<font></font>
flash: 3<font></font>
app-m_name: Voyager 1450g<font></font>
boot-m_name: Voyager 1450g<font></font>
app-p_name: 1450g<font></font>
boot-p_name: 1450g<font></font>
boot-time: 16:56:02<font></font>
boot-date: Oct 16 2014<font></font>
app-time: 08:49:30<font></font>
app-date: Mar 25 2019<font></font>
app-compat: 289<font></font>
boot-compat: 288<font></font>
csum: 0x6986</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons ces donn√©es dans dump.pcap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cr/z5/2y/crz52y_j0alhcohhokmry0bx7t8.png"><br>
<br>
<img src="https://habrastorage.org/webt/-s/np/cv/-snpcv4opok9jdsrj8thkshno_4.png"><br>
<br>
<img src="https://habrastorage.org/webt/qj/dq/zl/qjdqzlcwogon9yts12p5awr32ha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien! Nous traduisons les codes-barres du syst√®me en hexad√©cimal. Tout, la fonctionnalit√© de formation est pr√™te. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faire avec le firmware? Il semble que tout soit pareil, mais il y a une nuance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir supprim√© un vidage complet du processus de clignotement, nous avons √† peu pr√®s compris √† quoi nous faisions face. Voici un article sur XMODEM qui a vraiment aid√© √† comprendre comment cette communication se produit, bien qu'en termes g√©n√©raux: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://microsin.net/adminstuff/others/xmodem-protocol-overview.html Je</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recommande de le lire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En regardant dans le vidage, vous pouvez voir que la taille de la trame est 1024 et la taille des donn√©es URB est 64. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/o6/uj/wio6ujyvlj_bnltlngxf24k9evk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, 1024/64, nous obtenons 16 lignes dans un bloc, lisons le fichier du firmware par 1 caract√®re et formons un bloc. Compl√©ter 1 ligne dans un bloc avec des caract√®res sp√©ciaux fd3e02 + num√©ro de bloc.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les 14 lignes suivantes sont compl√©t√©es par fd25 +, en utilisant XMODEM.calc_crc (), nous calculons la somme de contr√¥le de l'ensemble du bloc (il a fallu beaucoup de temps pour comprendre que ¬´FF - 1¬ª est CSUM) et la derni√®re 16e ligne est compl√©t√©e par fd3e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait que tout, lisez le fichier du firmware, frappez les blocs, d√©connectez le scanner du noyau et envoyez-le √† l'appareil. </font><font style="vertical-align: inherit;">Mais pas si simple. </font><font style="vertical-align: inherit;">Le scanner doit √™tre mis en mode firmware en lui </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
envoyant NEWAPP = '\\ xfd \\ x0a \\ x16 \\ x4e \\ x2c \\ x4e \\ x45 \\ x57 \\ x41 \\ x50 \\ x50 \\ x0d'. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'o√π vient cette commande ?? </font><font style="vertical-align: inherit;">De la d√©charge. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/sd/nd/ausdnd16ikur6ajzdiyk9-ntklw.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous ne pouvons pas envoyer le bloc entier au scanner en raison de la restriction de 64: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/db/k6/qg/dbk6qgrapgsxiwdo9jyxqd0svwu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, le scanner en mode clignotant NEWAPP n'accepte pas non plus l'hex. </font><font style="vertical-align: inherit;">Il est donc n√©cessaire de traduire chaque ligne bytes_array</font></font><br>
<br>
<pre><code class="plaintext hljs">[253, 10, 22, 78, 44, 78, 69, 87, 65, 80, 80, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et envoyez d√©j√† ces donn√©es au scanner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons la r√©ponse:</font></font><br>
<br>
<pre><code class="plaintext hljs">[2, 1, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous consultez l'article sur XMODEM, cela devient clair: les donn√©es ont √©t√© accept√©es. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/fd/gj/pofdgjvcgns7oxdeonuldkqbptg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois tous les blocs transf√©r√©s, nous terminons le transfert END_TRANSFER = '\ xfd \ x01 \ x04'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, puisque ces blocs ne contiennent aucune information pour les gens ordinaires, nous ferons le firmware en mode cach√© par d√©faut. </font><font style="vertical-align: inherit;">Et juste au cas o√π, via tqdm, nous organiserons une barre de progression. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/18/g1/da18g1axnll2zps9qpx2s7opkha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le reste est petit. </font><font style="vertical-align: inherit;">Il ne reste plus qu'√† encapsuler la solution dans des scripts de r√©plication de masse √† une heure clairement d√©finie, afin de ne pas ralentir le processus de travail au box-office, et ajouter la journalisation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir pass√© beaucoup de temps et d'√©nergie </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de cheveux sur la t√™te</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous avons pu d√©velopper les solutions dont nous avions besoin, de plus, nous avons respect√© le d√©lai. </font><font style="vertical-align: inherit;">Dans le m√™me temps, les scanners sont reflash√©s et recycl√©s maintenant de mani√®re centralis√©e, nous contr√¥lons clairement l'ensemble du processus. </font><font style="vertical-align: inherit;">L'entreprise a √©conomis√© du temps et de l'argent et nous avons acquis une exp√©rience inestimable dans la r√©tro-ing√©nierie de ce type d'√©quipement.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490736/index.html">9 outils clairs pour apprendre et pomper le vocabulaire anglais</a></li>
<li><a href="../fr490738/index.html">Principe de substitution de Lisk</a></li>
<li><a href="../fr490740/index.html">Les d√©fauts *** ne sont pas seulement de la randomisation</a></li>
<li><a href="../fr490742/index.html">Une nouvelle √®re en robotique a commenc√©</a></li>
<li><a href="../fr490746/index.html">√âvaluation dans Yandex.Taxi: un court article sur un sujet s√©rieux</a></li>
<li><a href="../fr490750/index.html">Mikhail Salosin. Meetup Golang. Utiliser Go dans le backend de l'application Watch +</a></li>
<li><a href="../fr490754/index.html">√âditeur de code de code Visual Studio. Le guide le plus d√©taill√© pour configurer et installer des plugins pour les d√©butants</a></li>
<li><a href="../fr490756/index.html">D√©ployer Jenkins comme code</a></li>
<li><a href="../fr490758/index.html">Les math√©maticiens ont prouv√© la loi universelle de la turbulence</a></li>
<li><a href="../fr490760/index.html">Recherche visuelle Ray Casting (RCVS). Algorithme simple et rapide pour trouver des mod√®les 3D similaires en g√©om√©trie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>