<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏙️ 🤚🏼 👩‍✈️ Mejores prácticas de Redis, parte 2 👩🏾‍🎓 🌲 👩🏽‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La segunda parte del ciclo de traducción Redis Best Practices de Redis Labs, y analiza los patrones de interacción y los patrones de almacenamiento de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mejores prácticas de Redis, parte 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487570/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La segunda parte del ciclo de traducción Redis Best Practices de Redis Labs, y analiza los patrones de interacción y los patrones de almacenamiento de datos.</font></font><div style="text-align:center;"><img src="https://habrastorage.org/webt/hr/6y/f5/hr6yf5w1hp0fh-i5vfa0p1pxeuy.png" width="15%"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera parte está </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patrones de interacción</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis puede funcionar no solo como un DBMS tradicional, sino que también sus estructuras y comandos se pueden usar para intercambiar mensajes entre microservicios o procesos. </font><font style="vertical-align: inherit;">El uso generalizado de los clientes de Redis, la velocidad y la eficiencia del servidor y el protocolo, así como las estructuras clásicas integradas le permiten crear sus propios flujos de trabajo y mecanismos de eventos. </font><font style="vertical-align: inherit;">En este capítulo, cubriremos los siguientes temas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cola de eventos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueo con Redlock;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pub / Sub;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventos distribuidos.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cola de eventos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las listas en Redis son listas de líneas ordenadas, muy similares a las listas vinculadas con las que puede estar familiarizado. Agregar un valor a una lista (push) y eliminar un valor de una lista (pop) son operaciones muy livianas. Como puede imaginar, esta es una muy buena estructura para administrar una cola: agregue elementos al principio y léalos desde el final (FIFO). Redis también proporciona características adicionales que hacen que este patrón sea más eficiente, confiable y fácil de usar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las listas tienen un subconjunto de comandos que le permiten ejecutar el comportamiento de "bloqueo". </font><font style="vertical-align: inherit;">El término "bloqueo" se refiere a una conexión con un solo cliente. </font><font style="vertical-align: inherit;">De hecho, estos comandos no permiten que el cliente haga nada hasta que aparezca un valor en la lista o hasta que expire el tiempo de espera. </font><font style="vertical-align: inherit;">Esto elimina la necesidad de sondear Redis, esperando el resultado. </font><font style="vertical-align: inherit;">Como el cliente no puede hacer nada mientras espera un valor, necesitaremos dos clientes abiertos para ilustrar esto:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># #</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[espere valor]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><pre><code class="plaintext hljs">&gt; LPUSH my-q hello<font></font>
(integer) 1</code></pre></td>
<td><pre><code class="plaintext hljs">1) "my-q"<font></font>
2) "hello"</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[cliente desbloqueado, listo para aceptar comandos]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[espere valor]</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este ejemplo, en el paso 1, vemos que el cliente bloqueado no devuelve nada inmediatamente, ya que no contiene nada. </font><font style="vertical-align: inherit;">El argumento final es el tiempo de espera. </font><font style="vertical-align: inherit;">Aquí 0 significa expectativa eterna. </font><font style="vertical-align: inherit;">En la segunda línea </font><font style="vertical-align: inherit;">, se ingresa un valor </font><font style="vertical-align: inherit;">en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my-q</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y el primer cliente sale inmediatamente del estado de bloqueo. </font><font style="vertical-align: inherit;">En la tercera línea, se vuelve a llamar a BRPOP (puede hacer esto en un bucle en la aplicación), y el cliente también espera el siguiente valor. </font><font style="vertical-align: inherit;">Al presionar "Ctrl + C" puede romper el bloqueo y salir del cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos a revertir el ejemplo y ver cómo funciona BRPOP con una lista no vacía:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># #</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><pre><code class="plaintext hljs">&gt; LPUSH my-q hello<font></font>
(integer) 1</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><pre><code class="plaintext hljs">&gt; LPUSH my-q hej<font></font>
(integer) 2</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><pre><code class="plaintext hljs">&gt; LPUSH my-q bonjour<font></font>
(integer) 3</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 4</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0<font></font>
1) "my-q"<font></font>
2) "hello"</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 5</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0<font></font>
1) "my-q"<font></font>
2) "hej"</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 6</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0<font></font>
1) "my-q"<font></font>
2) "bonjour"</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 7</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOP my-q 0</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[espere valor]</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los pasos 1-3, agregamos 3 valores a la lista y vemos que la respuesta crece, indicando el número de elementos en la lista. El paso 4, a pesar de llamar a BRPOP, devuelve el valor de inmediato. Esto se debe a que el comportamiento de bloqueo ocurre solo cuando no hay valores en la cola. Podemos ver la misma respuesta instantánea en los pasos 5-6 porque esto se hace para cada elemento de la cola. En el paso 7, BRPOP no encuentra nada en la cola y bloquea al cliente hasta que se agrega algo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A menudo, las colas representan un trabajo que debe hacerse en otro proceso (trabajador). </font><font style="vertical-align: inherit;">En este tipo de carga de trabajo, es importante que el trabajo no desaparezca si el trabajador cae por algún motivo durante la ejecución. </font><font style="vertical-align: inherit;">Redis admite este tipo de cola. </font><font style="vertical-align: inherit;">Para hacer esto, use el comando BRPOPLPUSH en lugar de BRPOP. </font><font style="vertical-align: inherit;">Ella espera un valor en una lista, y tan pronto como aparece allí, lo coloca en otra lista. </font><font style="vertical-align: inherit;">Esto se hace atómicamente, por lo que es imposible que dos trabajadores cambien el mismo valor. </font><font style="vertical-align: inherit;">Vamos a ver cómo funciona:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># #</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; LINDEX worker-q 0<font></font>
(nil)</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Si el resultado no es nulo, de alguna manera trátelo y vaya al paso 4]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; LREM worker-q -1 [   1]<font></font>
(integer) 1</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[volver al paso 1]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 4</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; BRPOPLPUSH my-q worker-q 0</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[espere valor]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 5</font></font></td>
<td><pre><code class="plaintext hljs">&gt; LPUSH my-q hello</code></pre></td>
<td><pre><code class="plaintext hljs">"hello"</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[cliente desbloqueado, listo para aceptar comandos]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 6</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[manejar hola]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 7</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; LREM worker-q -1 hello<font></font>
(integer) 1</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[volver al paso 1]</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los pasos 1-2, no hacemos nada, porque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajador-q está</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vacío. Si algo ha regresado, lo procesamos y lo eliminamos, y nuevamente volvemos al paso 1 para verificar si algo ha entrado en la cola. Por lo tanto, primero limpiamos la cola del trabajador y realizamos el trabajo existente. En el paso 4, esperamos hasta que el valor aparezca en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my-q</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y cuando lo hace, se transfiere atómicamente a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajador-q</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Luego, de alguna manera procesamos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"hola"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , después de eso lo eliminamos de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajador-q</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y volvemos al paso 1. Si el proceso muere en el paso 6, el valor aún permanece en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajador-q</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Después de reiniciar el proceso, eliminaremos inmediatamente todo lo que no se eliminó en el paso 7.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este patrón reduce en gran medida la probabilidad de pérdida de empleo, pero solo si el trabajador muere entre los pasos 2 y 3 o 5 y 6, lo cual es poco probable, pero las </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mejores prácticas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lo tendrán en cuenta en la lógica del trabajador.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cerradura con redlock</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunas veces en el sistema es necesario bloquear algunos recursos. </font><font style="vertical-align: inherit;">Esto puede ser necesario para aplicar cambios importantes que no pueden resolverse en un entorno competitivo. </font><font style="vertical-align: inherit;">Objetivos de bloqueo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permitir que un solo trabajador capture el recurso;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser capaz de liberar de manera confiable el objeto de bloqueo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No bloquee el recurso firmemente (debe desbloquearse después de un cierto período de tiempo).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis es una buena opción para implementar el bloqueo, ya que tiene un modelo de datos simple basado en claves, y cada fragmento es de un solo subproceso y bastante rápido. Hay una excelente implementación de bloqueo usando Redis llamada Redlock. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los clientes de Redlock están disponibles para casi todos los idiomas, sin embargo, es importante saber cómo funciona Redlock para usarlo de manera segura y efectiva.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, debe comprender que Redlock está diseñado para ejecutarse en al menos 3 máquinas con instancias de Redis independientes. Esto elimina el único punto de falla en su mecanismo de bloqueo, lo que puede llevar a un punto muerto de todos los recursos. Otro punto a entender es que aunque los relojes en las máquinas no deben estar 100% sincronizados, deben funcionar de la misma manera: el tiempo se mueve a la misma velocidad: un segundo en la máquina y lo mismo que un segundo en la máquina B.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Establecer un objeto de bloqueo con Redlock comienza obteniendo una marca de tiempo con una precisión de milisegundos. También debe indicar de antemano el tiempo de bloqueo. Luego, el objeto de bloqueo se establece configurando (SET) la clave con un valor aleatorio (solo si esta clave aún no existe) y configurando el tiempo de espera para la clave. Esto se repite para cada instancia independiente. Si la instancia cae, se omite inmediatamente. Si el objeto de bloqueo se instaló correctamente en la mayoría de los casos antes de que expire el tiempo de espera, se considera capturado. El tiempo para instalar o actualizar el objeto de bloqueo es la cantidad de tiempo que lleva alcanzar el estado de bloqueo, menos el tiempo de bloqueo predefinido. En caso de error o tiempo de espera, desbloquee todas las instancias e intente nuevamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para liberar un objeto de bloqueo, es mejor usar un script Lua que verificará si el valor aleatorio esperado está en el conjunto de claves. </font><font style="vertical-align: inherit;">Si lo hay, puede eliminarlo, de lo contrario es mejor dejar las llaves, ya que estos pueden ser objetos de bloqueo más nuevos.</font></font><br>
<br>
<pre><code class="plaintext hljs">if redis.call("get",KEYS[1]) == ARGV[1] then<font></font>
    return redis.call("del",KEYS[1])<font></font>
else<font></font>
    return 0<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proceso Redlock proporciona buenas garantías y la ausencia de un solo punto de falla, por lo que puede estar completamente seguro de que se distribuirán objetos de bloqueo único y que no se producirán bloqueos mutuos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pub / Sub</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además del almacenamiento de datos, Redis también se puede utilizar como plataforma Pub / Sub (editor / suscriptor). </font><font style="vertical-align: inherit;">En este patrón, un editor puede emitir mensajes a cualquier número de suscriptores del canal. </font><font style="vertical-align: inherit;">Estos son mensajes basados ​​en el principio de "disparar y olvidar", es decir, si el mensaje se libera y el suscriptor no existe, el mensaje desaparece sin posibilidad de recuperación. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al suscribirse al canal, el cliente ingresa al modo de suscriptor y ya no puede llamar a los comandos; se vuelve de solo lectura. </font><font style="vertical-align: inherit;">El editor no tiene tales restricciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puedes suscribirte a más de un canal. </font><font style="vertical-align: inherit;">Comenzamos suscribiéndonos a los dos canales meteorológicos y deportivos utilizando el comando SUBSCRIBE:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; SUBSCRIBE weather sports<font></font>
Reading messages... (press Ctrl-C to quit)<font></font>
1) "subscribe"<font></font>
2) "weather"<font></font>
3) (integer) 1<font></font>
1) "subscribe"<font></font>
2) "sports"<font></font>
3) (integer) 2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un cliente separado (otra ventana de terminal, por ejemplo) podemos publicar mensajes en cualquiera de estos canales usando el comando PUBLICAR:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PUBLISH sports oilers/7:leafs/1<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer argumento es el nombre del canal, el segundo es el mensaje. </font><font style="vertical-align: inherit;">El mensaje puede ser cualquiera, en este caso es una cuenta codificada en el juego. </font><font style="vertical-align: inherit;">El comando devuelve el número de clientes a los que se entregará el mensaje. </font><font style="vertical-align: inherit;">En el cliente suscriptor, vemos inmediatamente el mensaje:</font></font><br>
<br>
<pre><code class="plaintext hljs">1) "message"<font></font>
2) "sports"<font></font>
3) "oilers/7:leafs/1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La respuesta contiene tres elementos: una indicación de que se trata de un mensaje, un canal de suscripción y, de hecho, un mensaje. </font><font style="vertical-align: inherit;">El cliente inmediatamente después de recibir vuelve a escuchar el canal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volviendo al editor, podemos publicar otro mensaje:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PUBLISH weather snow/-4c<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el suscriptor veremos el mismo formato, pero con un canal diferente con el mensaje:</font></font><br>
<br>
<pre><code class="plaintext hljs">1) "message"<font></font>
2) "weather"<font></font>
3) "snow/-4c"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Publiquemos un mensaje en un canal donde no hay suscriptores:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PUBLISH currency CADUSD/0.787<font></font>
(integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como nadie está escuchando el canal de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moneda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la respuesta será 0. Este mensaje se ha ido, y los clientes que después de suscribirse a este canal no recibirán una notificación sobre este mensaje: fue enviado y olvidado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además de suscribirse a un solo canal, Redis permite suscribirse a canales por máscara. </font><font style="vertical-align: inherit;">La máscara de estilo glob se pasa al comando PSUBSCRIBE:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PSUBSCRIBE sports:*</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cliente recibirá los mensajes de todos los canales, empezando por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los deportes:</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En otro cliente, llame a los siguientes comandos:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PUBLISH sports:hockey oilers/7:leafs/1<font></font>
(integer) 1<font></font>
&gt; PUBLISH sports:basketball raptors/33:pacers/7<font></font>
(integer) 1<font></font>
&gt; PUBLISH weather:edmonton snow/-4c<font></font>
(integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que los dos primeros equipos devuelven 1, mientras que el último devuelve 0. Y aunque no estamos suscritos directamente a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deportes: hockey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deportes: baloncesto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el cliente recibe mensajes a través de una suscripción por máscara. </font><font style="vertical-align: inherit;">En la ventana cliente-suscriptor, podemos ver que solo hay resultados para los canales que coinciden con la máscara.</font></font><br>
<br>
<pre><code class="plaintext hljs">1) "pmessage"<font></font>
2) "sports:*"<font></font>
3) "sports:hockey"<font></font>
4) "oilers/7:leafs/1"<font></font>
1) "pmessage"<font></font>
2) "sports:*"<font></font>
3) "sports:basketball"<font></font>
4) "raptors/33:pacers/7"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta salida es ligeramente diferente de la salida del comando SUBSCRIBE porque contiene la máscara en sí, así como el nombre real del canal.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventos distribuidos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema de mensajes de Pub / Sub de Redis se puede ampliar para crear eventos distribuidos interesantes. </font><font style="vertical-align: inherit;">Digamos que tenemos una estructura que se almacena en una tabla hash, pero queremos actualizar clientes solo cuando un solo campo excede el valor numérico establecido por el suscriptor. </font><font style="vertical-align: inherit;">Escucharemos los canales por máscara y extraeremos el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hash </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En este ejemplo, estamos interesados ​​en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">update_status</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con valores 5-9.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PSUBSCRIBE update_status:[5-9]<font></font>
1) "psubscribe"<font></font>
2) "update_status:[5-9]"<font></font>
3) (integer) 1<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cambiar el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor de status / error_level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , necesitamos dos comandos que se puedan ejecutar secuencialmente o en el bloque MULTI / EXEC. </font><font style="vertical-align: inherit;">El primer comando establece el nivel, y el segundo publica una notificación con el valor codificado en el propio canal.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; HSET status error_level 5<font></font>
(integer) 1<font></font>
&gt; PUBLISH update_status:5 0<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la primera ventana, vemos que el mensaje ha sido recibido, y luego puede cambiar a otro cliente y llamar al comando HGETALL:</font></font><br>
<br>
<pre><code class="plaintext hljs">...<font></font>
1) "pmessage"<font></font>
2) "update_status:[5-9]"<font></font>
3) "update_status:5"<font></font>
4) "0"<font></font>
<font></font>
&gt; HGETALL status<font></font>
1) "error_level"<font></font>
2) "5"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También podemos usar este método para actualizar la variable local de algún proceso largo. </font><font style="vertical-align: inherit;">Esto puede permitir que varias instancias del mismo proceso intercambien datos en tiempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Por qué es este patrón mejor que usar Pub / Sub? </font><font style="vertical-align: inherit;">Cuando el proceso se reinicia, puede obtener todo el estado y comenzar a escuchar. </font><font style="vertical-align: inherit;">Los cambios se sincronizarán entre cualquier número de procesos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patrones de almacenamiento de datos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen varios patrones para almacenar datos estructurados en Redis. </font><font style="vertical-align: inherit;">En este capítulo consideraremos lo siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">almacenamiento de datos en JSON;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instalaciones de almacenamiento.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento de datos JSON</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay varias opciones para almacenar datos JSON en Redis. </font><font style="vertical-align: inherit;">La forma más común es serializar el objeto de antemano y guardarlo en una clave especial:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; SET car "{\"colour\":\"blue\",\"make\":\"saab\",\"model\":93,\"features\":[\"powerlocks\",\"moonroof\"]}"<font></font>
OK<font></font>
&gt; GET car<font></font>
"{\"colour\":\"blue\",\"make\":\"saab\",\"model\":93,\"features\":[\"powerlocks\",\"moonroof\"]}"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece simple, pero tiene algunos inconvenientes muy serios:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la serialización requiere recursos informáticos del cliente para leer y escribir;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El formato JSON aumenta el tamaño de los datos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis solo tiene una forma indirecta de manejar los datos en JSON.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los primeros puntos pueden ser insignificantes en pequeñas cantidades de datos, pero los costos aumentarán a medida que los datos crezcan. </font><font style="vertical-align: inherit;">Sin embargo, el tercer punto es el más crítico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de Redis 4.0, la única forma de trabajar con JSON dentro de Redis era usar un script Lua en el módulo cjson. </font><font style="vertical-align: inherit;">Esto resolvió parcialmente el problema, aunque todavía seguía siendo un cuello de botella y creaba problemas adicionales con el aprendizaje de Lua. </font><font style="vertical-align: inherit;">Además, muchas aplicaciones simplemente recibieron la cadena JSON completa, la deserializaron, trabajaron con los datos, los serializaron de nuevo y los volvieron a guardar. </font><font style="vertical-align: inherit;">Este es un antipatrón. </font><font style="vertical-align: inherit;">Existe un gran riesgo de perder datos de esta manera.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># #</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instancia de aplicación n. ° 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instancia de aplicación # 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><pre><code class="plaintext hljs">&gt; GET my-car</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[deserializar, cambiar el color de la máquina y volver a serializar]</font></font></td>
<td><pre><code class="plaintext hljs">&gt; GET my-car</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><pre><code class="plaintext hljs">&gt; SET my-car</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[nuevo valor de la instancia # 1]</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[deserializar, cambiar el modelo de máquina y serializar nuevamente]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 4</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; SET my-car</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[nuevo valor de la instancia # 2]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 5</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; GET my-car</code></pre></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado en la línea 5 mostrará cambios solo en la instancia 2, y el cambio de color por la instancia 1 se perderá. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis versión 4.0 y superior tiene la capacidad de usar módulos. </font><font style="vertical-align: inherit;">ReJSON es un módulo que proporciona un tipo de datos y comandos especiales para la interacción directa con él. </font><font style="vertical-align: inherit;">ReJSON guarda los datos en formato binario, lo que reduce el tamaño de los datos almacenados, proporciona un acceso más rápido a los elementos sin perder tiempo en la des / serialización. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar ReJSON, debe instalarlo en un servidor Redis o habilitarlo en Redis Enterprise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ejemplo anterior usando ReJSON se vería así:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># #</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instancia de aplicación n. ° 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instancia de aplicación # 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><pre><code class="plaintext hljs">&gt; JSON.SET car2 . '{"colour": "blue",  "make":"saab", "model":93,  "features": ["powerlocks",  "moonroof"]}‘<font></font>
OK</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><pre><code class="plaintext hljs">&gt; JSON.SET car2 colour '"red"'<font></font>
OK</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; JSON.SET car2 model '95'<font></font>
OK<font></font>
&gt; JSON.GET car2 .<font></font>
"{\"colour\":\"red",\"make\":\"saab\",\"model\":95,\"features\":[\"powerlocks\",\"moonroof\"]}"</code></pre></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ReJSON proporciona una forma más segura, rápida e intuitiva de trabajar con datos JSON en Redis, especialmente en los casos en que son necesarios cambios atómicos en elementos anidados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento de objetos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primera vista, el tipo de datos estándar de la "tabla hash" de Redis puede parecer muy similar a un objeto JSON u otro tipo. </font><font style="vertical-align: inherit;">Es mucho más fácil hacer que los campos sean una cadena o un número y evitar estructuras anidadas. </font><font style="vertical-align: inherit;">Sin embargo, después de calcular la "ruta" a cada campo, puede "aplanar" el objeto y guardarlo en la tabla hash de Redis.</font></font><br>
<br>
<pre><code class="plaintext hljs">{<font></font>
    "colour": "blue",<font></font>
    "make": "saab",<font></font>
    "model": {<font></font>
        "trim": "aero",<font></font>
        "name": 93<font></font>
    },<font></font>
    "features": ["powerlocks", "moonroof"]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSONPath</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (XPath para JSON), podemos representar cada elemento en el mismo nivel de la tabla hash:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; HSET car3 colour blue<font></font>
&gt; HSET car3 make saab<font></font>
&gt; HSET car3 model.trim aero<font></font>
&gt; HSET car3 model.name 93<font></font>
&gt; HSET car3 features[0] powerlocks<font></font>
&gt; HSET car3 features[1] moonroof</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mayor claridad, los comandos se enumeran por separado, pero se pueden pasar muchos parámetros a HSET. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puede solicitar el objeto completo o su campo individual:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; HGETALL car3<font></font>
 1) "colour"<font></font>
 2) "blue"<font></font>
 3) "make"<font></font>
 4) "saab"<font></font>
 5) "model.trim"<font></font>
 6) "aero"<font></font>
 7) "model.name"<font></font>
 8) "93"<font></font>
 9) "features[0]"<font></font>
10) "powerlocks"<font></font>
11) "features[1]"<font></font>
12) "moonroof"<font></font>
<font></font>
&gt; HGET car3 model.trim<font></font>
"aero"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque esto proporciona una forma rápida y útil de recuperar un objeto almacenado en Redis, tiene sus inconvenientes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En diferentes lenguajes y bibliotecas, la implementación de JSONPath puede ser diferente, causando incompatibilidad. </font><font style="vertical-align: inherit;">En este caso, vale la pena serializar y deserializar los datos con una herramienta;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soporte de matriz:</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matrices dispersas pueden ser problemáticas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es imposible realizar muchas operaciones, como insertar un elemento en el medio de una matriz.</font></font></li>
</ul><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consumo innecesario de recursos en claves JSONPath.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este patrón es más o menos lo mismo que ReJSON. </font><font style="vertical-align: inherit;">Si ReJSON está disponible, en la mayoría de los casos es mejor usarlo. </font><font style="vertical-align: inherit;">Sin embargo, almacenar objetos en la forma anterior tiene una ventaja sobre ReJSON: la integración con el equipo Redis SORT. </font><font style="vertical-align: inherit;">Sin embargo, este comando es computacionalmente complejo y es un tema complejo separado más allá del alcance de este patrón. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La siguiente parte concluyente cubrirá patrones de series de tiempo, patrones de límite de velocidad, patrones de filtro Bloom, contadores y el uso de Lua en Redis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PD: Traté de adaptar el texto de estos artículos en inglés "bárbaro" lo más posible al ruso, pero si crees que en algún lugar la idea es incomprensible o incorrecta, corrígeme en los comentarios.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es487558/index.html">Paul Graham: Niños y Startups</a></li>
<li><a href="../es487560/index.html">Bank of America: la capitalización de Yandex crecerá en $ 1.4 mil millones</a></li>
<li><a href="../es487564/index.html">Paul Graham: "La idea principal en tu mente"</a></li>
<li><a href="../es487566/index.html">Comprender la cuadrícula CSS (1 parte): contenedor de cuadrícula</a></li>
<li><a href="../es487568/index.html">Case Full HP: cómo aparecer en Google Play y adaptar ASO a diferentes países</a></li>
<li><a href="../es487574/index.html">Trabajando con audio: progreso y visualización de datos</a></li>
<li><a href="../es487578/index.html">Optimización de CMake para bibliotecas estáticas</a></li>
<li><a href="../es487582/index.html">Ningún dios quema ollas</a></li>
<li><a href="../es487584/index.html">Githabificación de la seguridad de la información</a></li>
<li><a href="../es487588/index.html">Quarkus: veterinario subatómico supersónico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>