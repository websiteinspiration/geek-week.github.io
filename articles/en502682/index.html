<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßôüèª üëºüèª üõë Computer vision on Intel OWT WebRTC server with hardware acceleration üîõ ‚ú® üëµüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WebRTC has simplified (for the most part) receiving and sending video streams in real time. So, you can have some fun with them using machine learning...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Computer vision on Intel OWT WebRTC server with hardware acceleration</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/Voximplant/blog/502682/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/8-/ee/qk/8-eeqkqsmvrre32oeutnpjwyjcg.gif"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebRTC has simplified (for the most part) receiving and sending video streams in real time. So, you can have some fun with them using machine learning. Last month, I showed how to run Computer Vision (CV) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">locally in a browser</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As I mentioned, locally is, of course, good, but sometimes higher performance is required, and for this we need a remote server. In this post I will talk about how to run OpenCV server models with hardware acceleration on Intel chipsets using the Open WebRTC Toolkit (OWT) with open source code.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted to play with the OWT server since Intel demonstrated the computer vision features of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kranky Geek</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and now I was fortunate enough to work with their development team to explore the capabilities of the server. </font><font style="vertical-align: inherit;">Below I will talk about how to install OWT locally for quick testing, as well as demonstrate some models.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open WebRTC Toolkit (OWT)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intel released its Intel Collaboration Suite for WebRTC around 2014. </font><font style="vertical-align: inherit;">This package consisted of server and client SDKs designed to use Intel hardware. </font><font style="vertical-align: inherit;">The company continued to expand this set of software, adding new features and improving its capabilities. </font><font style="vertical-align: inherit;">Later, in 2018, Intel opened the source code for the entire project under the Open WebRTC Toolkit (OWT) brand. </font><font style="vertical-align: inherit;">They still propose using Collaborate Suite for WebRTC, according to them, the only difference is bundling with additional Intel QA (which is not so rare in open source projects supported by commercial companies). </font><font style="vertical-align: inherit;">In this post, we will focus on open source OWT.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0e/yp/zk/0eypzkg4suqoygg_xf0sustxsfm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can go to the OWT homepage at: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01.org/open-webrtc-toolkit</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does a media server do</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An OWT media server can act as a Multipoint control unit (MCU) server, where media files are decoded, processed, and transcoded before being sent back to clients in addition to the more typical </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selective Forwarding Unit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (SFU) </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Intel's OWT is seen as a real-time media processor with features for the following applications:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multipoint conferences</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SFUs have</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proven to be the predominant architecture for WebRTC conferences, but MCUs are still needed in scenarios where client side processing is limited (for example, on an IoT device), or in combination with one of the points below.</font></font><br>
</li>
<li><b></b> ‚Äì MCU      ,       .</li>
<li><b> </b> ‚Äì    -WebRTC ,   ,   RTSP, RTMP, HLS, MPEG-DASH.</li>
<li><b></b> ‚Äì       .</li>
<li><b>SIP-gateway</b> ‚Äì  WebRTC     ,      VoIP-.</li>
<li><b></b> ‚Äì      ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server is built on node.js with MongoDB for the database and RabbitMQ as a message broker. </font><font style="vertical-align: inherit;">The functions listed in the list above, as well as those not included in the list, are implemented as various Agents connected to the OWT architecture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, OWT has a client SDK for interacting with a media server. </font><font style="vertical-align: inherit;">It can also be used in P2P mode.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acceleration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The architecture was designed to use Intel hardware. </font><font style="vertical-align: inherit;">This includes most modern Intel processors and an even more accelerated processors with integrated graphics, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPLDs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FPGAs) and specialized processors machine vision Intel (Vision Processing Unit - VPU) . </font><font style="vertical-align: inherit;">(Here's </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project I created using one of their Movidius chips with the Google Vision Kit).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/ng/fh/zzngfhpuqfi_7kwmkztftwrcwsq.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analytics and Computer Vision (CV)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anyone who has worked seriously with computer vision has come across </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenCV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">OpenCV was originally a project of Intel and still remains so. </font><font style="vertical-align: inherit;">Intel has a set of tools called OpenVINO (Open Visual Inference and Neural Network Optimization) for optimizing deep learning models on its hardware. </font><font style="vertical-align: inherit;">It is part of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the OpenCV repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">OpenCV includes dozens of pre-trained models, from basic text recognition to self-driving applications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OWT Analytics Agent is a module for receiving real-time predictions on OpenVINO models. </font><font style="vertical-align: inherit;">Analystics Agent can send output metadata to the cloud, or you yourself can send it back to the media server to make, for example, annotations for real-time video (I will show it a bit later). </font><font style="vertical-align: inherit;">The well-known </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GStreamer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library is </font><font style="vertical-align: inherit;">used to manage a multimedia pipeline.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2j/yw/b2/2jywb2ihtjq5dv4ck9h05qqzjog.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above diagram is taken from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server analytics guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It looks complicated, but here you just need to remember that the Analytics Agent acts as another conference participant who can subscribe to the video channel in this conference. </font><font style="vertical-align: inherit;">After he receives the video stream, you can direct the processing of the stream to various stages using the GStreamer pipeline. </font><font style="vertical-align: inherit;">In most cases, you will want to perform prediction and classification before returning the video stream back to the MCU, but you can also send the stream and / or output data somewhere else.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation will take a little time, since you will need to install the OWT server and Analytics Agent. Fortunately, they have </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker build instructions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for easy installation. If you want, you can run OWT + Analytics Agent as 4 separate containers for distributed environments. I decided to leave all my locally in one container in order to simplify the evaluation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, Intel initially gave me an image </font></font><code>gst-owt-all:run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for work, since at the time of writing my article they were updating the documentation for installing the Analytics Agent. The new set is much more understandable. I still recommend that you first familiarize yourself with the standard OWT installation to understand its components and options.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, you need to compile a lot with gcc. </font><font style="vertical-align: inherit;">Make sure that you have the latest version by running the following command: </font></font><code>brew install gcc</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, nothing compiled, but after running this command everything worked. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the end, I started building everything on my own. </font><font style="vertical-align: inherit;">To create an OWT server with Analytics, run the following command:</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/open-webrtc-toolkit/owt-server.git<font></font>
 <font></font>
<span class="hljs-built_in">cd</span> owt-server<font></font>
git branch gst-analytics<font></font>
<span class="hljs-built_in">cd</span> /owt-server/docker/gst<font></font>
curl -o l_openvino_toolkit_p_2019.3.334.tgz http://registrationcenter-download.intel.com/akdlm/irc_nas/15944/l_openvino_toolkit_p_2019.3.334.tgz<font></font>
http://registrationcenter-download.intel.com/akdlm/irc_nas/15944/l_openvino_toolkit_p_2019.3.334.tgz<font></font>
docker build --target owt-run-all -t gst-owt-all:run \<font></font>
  --build-arg http_proxy=<span class="hljs-variable">${HTTP_PROXY}</span> \<font></font>
  --build-arg https_proxy=<span class="hljs-variable">${HTTPS_PROXY}</span> \<font></font>
  .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After setting up the main OWT server and the Analytics service, you will need to download the necessary models from OpenCV Open Model Zoo and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">build an analytical pipeline</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for their use. </font><font style="vertical-align: inherit;">For the attached examples, all this includes simply running the collector command in bash and copying some files.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Health Check on macOS</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure docker ports</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The docker option </font></font><code>--net=host</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not work on macOS, so for local launch you need to open the corresponding ports:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Port</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8080</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web socket signal port for WebRTC</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3004</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web server to download the demo page</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30000-30050</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDP Ports for WebRTC</font></font></td>
</tr>
</tbody></table></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch docker</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I installed my container like this:</font></font><br>
<br>
<pre><code class="bash hljs">docker run -p 8080:8080 -p 3004:3004  -p 30000-30050:30000-30050/udp --name owtwebrtchacks --privileged -tid gst-owt-all:run bash</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Editing default OWT settings for running locally on MacOS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you must edit the file </font></font><code>webrtc_agent/agent.toml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to recognize these ports.</font></font><br>
<br>
<pre><code class="bash hljs">docker start owtwebrtchacks<font></font>
docker <span class="hljs-built_in">exec</span> -it owtwebrtchacks bash<font></font>
vi /home/owt/webrtc_agent/agent.toml<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then replace </font></font><code>0acf7c0560d8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the container name or id. </font><font style="vertical-align: inherit;">And change the following:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qd/n6/nn/qdn6nnrxidpop7m5zhdbx75ebi0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to tell the web resource so that the browser displays ‚Äúlocalhost‚Äù instead of the docker's internal IP bridge (172.17.0.2):</font></font><br>
<br>
<pre><code class="bash hljs">vi /home/owt/portal/portal.toml</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ix/jq/ly/ixjqlyml39p2oujrnbl0txf25qq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Again, on other platforms, you can use the default configuration if you run your container with the option </font></font><code>--net=host</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start server</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can start the server:</font></font><br>
<br>
<pre><code class="bash hljs">./home/start.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may receive these errors:</font></font><br>
<br>
<pre><code class="bash hljs">2020-03-31T01:47:20.814+0000 E QUERY    [thread1] Error: couldn<span class="hljs-string">'t connect to server 127.0.0.1:27017, connection attempt failed :
connect@src/mongo/shell/mongo.js:251:13
@(connect):1:21
exception: connect failed
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is normal while the server is connecting. </font><font style="vertical-align: inherit;">You will understand that everything works if you see something like:</font></font><br>
<br>
<pre><code class="bash hljs">starting app, stdout -&gt; /home/owt/logs/app.stdout<font></font>
0 rooms <span class="hljs-keyword">in</span> this service.<font></font>
Created room: 5e82a13b402df00313685e3a<font></font>
sampleRoom Id: 5e82a13b402df00313685e3a<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test in browser</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https: // localhost: 3004 /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in a browser on the local machine. </font><font style="vertical-align: inherit;">You will need to enable the certificate, as the browser will have problems with it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/4r/oa/oe4roahxjkisfhxj4h7ugjtfhts.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And besides this, you need to enable the websocket server on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost: 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You can do this by clicking on the link ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Click this for testing certificate and refresh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù. </font><font style="vertical-align: inherit;">Alternatively, you can also set </font></font><code>#allow-insecure-localhost</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chrome: // flags to avoid flag issues in Chrome.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cj/vy/rk/cjvyrk4gcyds4f712iiej7sb_n8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once you do this, go back to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https: // localhost: 3004 /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and accept the camera resolution. </font><font style="vertical-align: inherit;">Immediately select your video channel identifier in the ‚Äúvideo from‚Äù drop-down list and click ‚ÄústartAnalytics‚Äù.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pv/lb/3l/pvlb3l3e853bo0upee2gea44ln0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, go to the ‚Äúsubsribe video‚Äù drop-down list, select the long line </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pipeline + video ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and click subscribe:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fy/sa/on/fysaonxg1btumjzisuyixvsg_xm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the image received from the server, you should see that the face is recognized.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pc/r_/xe/pcr_xehmfawc0du0o7pqsnqo4qm.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding OpenCV Models</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Analytics Agent contains the architecture of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the OpenCV GStreamer Video Analytics (GVA) plugin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">GVA includes a variety of modules that allow you to use various prediction schemes, such as detection, classification and identification, as well as input and output modules for sending video to users (in this case, back to OWT), providing image overlay or data streaming over mqtt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pipelining</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In practice, these pipelines are implemented by changing some C ++ code. </font><font style="vertical-align: inherit;">For example, if we look at it </font></font><code>/home/owt/analytics_agent/plugins/samples/cpu_pipeline/mypipeline.cc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we will see various pipeline elements:</font></font><br>
<br>
<pre><code class="cpp hljs"> source = gst_element_factory_make(<span class="hljs-string">"appsrc"</span>, <span class="hljs-string">"appsource"</span>);<font></font>
 h264parse = gst_element_factory_make(<span class="hljs-string">"h264parse"</span>,<span class="hljs-string">"parse"</span>);<font></font>
 decodebin = gst_element_factory_make(<span class="hljs-string">"avdec_h264"</span>,<span class="hljs-string">"decode"</span>);<font></font>
 postproc = gst_element_factory_make(<span class="hljs-string">"videoconvert"</span>,<span class="hljs-string">"postproc"</span>);<font></font>
 detect = gst_element_factory_make(<span class="hljs-string">"gvadetect"</span>,<span class="hljs-string">"detect"</span>);<font></font>
 classify = gst_element_factory_make(<span class="hljs-string">"gvaclassify"</span>,<span class="hljs-string">"classify"</span>);<font></font>
 watermark = gst_element_factory_make(<span class="hljs-string">"gvawatermark"</span>,<span class="hljs-string">"rate"</span>);<font></font>
 converter = gst_element_factory_make(<span class="hljs-string">"videoconvert"</span>,<span class="hljs-string">"convert"</span>);<font></font>
 encoder = gst_element_factory_make(<span class="hljs-string">"x264enc"</span>,<span class="hljs-string">"encoder"</span>);<font></font>
 outsink = gst_element_factory_make(<span class="hljs-string">"appsink"</span>,<span class="hljs-string">"appsink"</span>);x</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And these pipelines are located in a certain sequence:</font></font><br>
<br>
<pre><code class="cpp hljs">gst_bin_add_many(GST_BIN (pipeline), source,decodebin,watermark,postproc,h264parse,detect,classify,converter, encoder,outsink, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to change any of their elements, you will need to recompile the pipeline using the command:</font></font><br>
<br>
<pre><code class="bash hljs">./home/owt/analytics_agent/plugins/samples/build_samples.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then just copy the compiled libraries on top of the current one used in </font></font><code>/home/owt/analytics_agent/lib/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting other models</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a huge set of models hosted under the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenCV Open Model Zoo on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In addition to all the popular </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">public CV models</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , such as mobilenet, resnet, squeezenet, vgg and many others, Intel also supports a suite that includes a wide range of models useful for detecting objects, for unmanned vehicles and for processing human actions:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">action-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">head-pose-estimation</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-detection-action-recognition-teacher</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semantic segmentation</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">age-gender-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">human-pose-estimation</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-detection-asl</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">single-image-super-resolution</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asl-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image-retrieval</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-detection-raisinghand-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text-detection</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">driver-action-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instance-segmentation-security</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-detection</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text-image-super-resolution</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emotions-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">landmarks-regression</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-reidentification</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text recognition</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">face-detection</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">license-plate-recognition-barrier</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-vehicle-bike-detection-crossroad</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text-spotting</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">face-reidentification</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pedestrian-and-vehicle-detector</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">product-detection</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vehicle-attributes-recognition-barrier</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">facial-landmarks-35</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pedestrian-detection</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resnet18-xnor-binary-onnx</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vehicle-detection</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gaze-estimation</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-attributes-recognition-crossroad</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resnet50-binary</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vehicle-detection-binary</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">handwritten-score-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">person-detection-action-recognition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-segmentation</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vehicle-license-plate-detection-barrier</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intel has more information about this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding Models to OWT Analytics Agent</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To add models, you need to clone the repository, and then get the corresponding ones using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open Model Zoo Downloader tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After this, you need to make sure that your pipeline contains the appropriate elements (classification, detection, identification) and configure the file </font></font><code>/home/owt/analytics_agent/plugin.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the appropriate parameters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plugin testing</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried several models of face and emotion recognition.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reference points of the face</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since I already </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">played with the detection of touches to the face</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I decided to check out the model </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">facial-landmarks-35-adas-0002</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This model detects 35 reference points of the face.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/el/kl/si/elklsiar5t-oowpbrjzjvsejhra.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my face touch monitoring application, I could add MQTT streaming to the pipeline using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gstreamer generic metadata publisher</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to capture and process anchor points. </font><font style="vertical-align: inherit;">For example, I could see if the points around the eyes, nose and mouth are darkened, or even combine all this with a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model for evaluating a person‚Äôs posture</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emotion Recognition</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is another cool thing. </font><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emotions-recognition-retail-0003</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> model </font><font style="vertical-align: inherit;">uses a convolutional network to recognize neutral, happy, sad, surprised, and furious expressions.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/ku/1_/blku1_a54hzp6sttdswp1q1two4.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that my facial expression is not perceived as neutral, but as sad - perhaps such a long stay in isolation begins to get me :(</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acceleration Optimization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To take advantage of OWT hardware acceleration capabilities, be sure to install the appropriate device in </font></font><code>/home/owt/analytics_agent/plugin.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- that is, write:</font></font><br>
<br>
<pre><code class="bash hljs">device = <span class="hljs-string">"MULTI:HDDL,GPU,CPU"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, I didn‚Äôt have enough time to test this, but in addition to CPU and GPU acceleration, you can also take advantage of various machine vision processor (VPU) hardware. </font><font style="vertical-align: inherit;">These are specialized chips for the efficient operation of neural networks. </font><font style="vertical-align: inherit;">I bought </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an Intel Neural Computing Card (NCS) a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> couple of years ago to launch more advanced CV models on the Raspberry Pi 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, you can always find a compromise between processing power and frame rate / resolution.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenCV has a long history with a huge community of developers, it ranked 4th among all Machine Learning open source projects at the time of my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">popularity analysis in mid-2018</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Similarly, gstreamer is another project that has been around for ages. The Intel OWT Analytics Agent is ideally placed to help these communities add real-time streaming analysis to their projects through WebRTC. They should be able to take existing GST models and run them in real-time streaming using OWT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are just starting to experiment with computer vision and want to run models on an OWT server, I recommend starting with more basic OpenCV tutorials. Then you can get to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GVA plugins.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">They will require a lot of effort if you are just starting to work with OpenCV, but later you will have no trouble changing the Analytics Agent to launch them. </font><font style="vertical-align: inherit;">You can optimize the stack to work with your target platform and use various Intel hardware acceleration options to improve performance.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502668/index.html">Measure seven times - cut once, or use the saying in practice</a></li>
<li><a href="../en502670/index.html">A little story about biodegradable bags in Russia</a></li>
<li><a href="../en502672/index.html">DGTL Communications Online Meetup 28/05</a></li>
<li><a href="../en502678/index.html">The book "Patterns of object-oriented design"</a></li>
<li><a href="../en502680/index.html">PostgreSQL Recipes: Get Column Types in One Query</a></li>
<li><a href="../en502684/index.html">Why he: 5 questions for teachers at Ozon Go</a></li>
<li><a href="../en502686/index.html">RIT ++ 2020: consultations with Avito engineers at Zuma</a></li>
<li><a href="../en502696/index.html">How Internet Service Providers Avoid Global Blackout During Outbreaks</a></li>
<li><a href="../en502700/index.html">Stack Overflow creator: ‚ÄúDevelopers are the ones who write the script for the future‚Äù</a></li>
<li><a href="../en502702/index.html">About storing JWT tokens in browsers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>