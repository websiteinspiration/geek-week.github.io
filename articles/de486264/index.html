<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏼 🕗 👨🏽 PostgreSQL 13: Paralleles VAKUUM 🌠 🧗🏻 🏙️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neulich hat Amit Kapila einen Masahiko Sawada-Patch angebracht, der eine parallele Reinigung ermöglicht. Die Tabelle selbst wird weiterhin von einem (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL 13: Paralleles VAKUUM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/486264/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neulich hat Amit Kapila einen Masahiko Sawada-Patch angebracht, der eine parallele Reinigung ermöglicht. </font><font style="vertical-align: inherit;">Die Tabelle selbst wird weiterhin von einem (führenden) Prozess gelöscht. Um jedoch Indizes zu bereinigen, können jetzt Hintergrundworkflows gestartet werden, einer für jeden Index. </font><font style="vertical-align: inherit;">Im manuellen Modus können Sie so die Bereinigung großer Tabellen mit mehreren Indizes beschleunigen. </font><font style="vertical-align: inherit;">Die automatische Reinigung nutzt diese Funktion noch nicht.</font></font><br>
<a name="habracut"></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwandte Links:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commitfest</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diskussion</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haupt Commit</font></font></a></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wissen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , besteht der Tischreinigungsprozess aus mehreren Phasen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst wird die Tabelle gescannt und Links zu unnötigen ("toten") Versionen von Zeilen werden im Speicher gesammelt. </font><font style="vertical-align: inherit;">Der Speicher wird durch die begrenzten </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenance_work_mem</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parameter </font><font style="vertical-align: inherit;">, so dass alle Links nicht auf einmal passen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann werden alle Indizes nacheinander sortiert (wie zuvor) und Zeiger auf gefundene tote Versionen von Zeichenfolgen werden aus ihnen gelöscht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann wird der bereits angezeigte Teil der Tabelle erneut gescannt und tote Versionen der Zeilen werden bereits daraus gelöscht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn es zu einem Zeitpunkt nicht möglich war, alle toten Versionen von Zeichenfolgen zu verarbeiten, wird der Speicher gelöscht und der gesamte Vorgang wird an der Stelle wiederholt, an der wir das letzte Mal angehalten haben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses gesamte Schema bleibt unverändert, aber jetzt können Indizes parallel gelöscht werden. </font><font style="vertical-align: inherit;">Zu diesem Zweck startet der Lead-Prozess mehrere Workflows, die vorhandene Indizes analysieren und verarbeiten. </font><font style="vertical-align: inherit;">Ein Index wird nur von einem Prozess verarbeitet. </font><font style="vertical-align: inherit;">Nachdem alle Indizes gelöscht wurden, sind die Workflows abgeschlossen und der Moderator fährt mit der nächsten Phase fort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nehmen Sie zum Beispiel die </font></font><code>ticket_flights</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demobase-Flugtabelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es gibt einen Index, aber Sie können noch ein paar mehr erstellen.</font></font><br>
<br>
<pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">on</span> ticket_flights (fare_conditions);<font></font>
demo=# <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">index</span> <span class="hljs-keyword">on</span> ticket_flights (amount);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An der Parallelverarbeitung sind nur Indizes beteiligt, deren Größe den Wert des Parameters </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">min_parallel_index_scan_size</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> überschreitet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Unsere Indizes sind geeignet:</font></font><br>
<br>
<pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">SHOW</span> min_parallel_index_scan_size;
</code></pre><pre><code class="plaintext hljs"> min_parallel_index_scan_size <font></font>
------------------------------<font></font>
 512kB<font></font>
(1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">SELECT</span> pg_size_pretty(pg_relation_size(indexname::<span class="hljs-type">regclass</span>))
<span class="hljs-keyword">FROM</span> pg_indexes
<span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'ticket_flights'</span>;
</code></pre><pre><code class="plaintext hljs"> pg_size_pretty <font></font>
----------------<font></font>
 325 MB<font></font>
 187 MB<font></font>
 180 MB<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aktualisieren Sie die Hälfte der Zeilen, um die Bereinigungsarbeiten zu laden:</font></font><br>
<br>
<pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">UPDATE</span> ticket_flights <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> random() &gt; <span class="hljs-number">0.5</span>;
</code></pre><pre><code class="plaintext hljs">UPDATE 4194262
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen.</font></font><br>
<br>
<pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">VACUUM</span> <span class="hljs-keyword">VERBOSE</span> ticket_flights;
</code></pre><pre><code class="plaintext hljs">INFO:  vacuuming "bookings.ticket_flights"<font></font>
INFO:  launched 2 parallel vacuum workers for index vacuuming (planned: 2)<font></font>
INFO:  scanned index "ticket_flights_fare_conditions_idx" to remove 4194262 row versions by parallel vacuum worker<font></font>
DETAIL:  CPU: user: 1.84 s, system: 0.41 s, elapsed: 11.82 s<font></font>
INFO:  scanned index "ticket_flights_amount_idx" to remove 4194262 row versions by parallel vacuum worker<font></font>
DETAIL:  CPU: user: 2.31 s, system: 0.44 s, elapsed: 12.95 s<font></font>
INFO:  scanned index "ticket_flights_pkey" to remove 4194262 row versions<font></font>
...<font></font>
INFO:  "ticket_flights": found 4194262 removable, 8391852 nonremovable row versions in 104885 out of 104885 pages<font></font>
DETAIL:  0 dead row versions cannot be removed yet, oldest xmin: 630<font></font>
There were 0 unused item identifiers.<font></font>
Skipped 0 pages due to buffer pins, 0 frozen pages.<font></font>
0 pages are entirely empty.<font></font>
CPU: user: 9.91 s, system: 4.40 s, elapsed: 121.40 s.<font></font>
VACUUM<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist ersichtlich, dass der führende Prozess zwei Arbeiter ins Leben gerufen und einen Index genommen hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Anzahl der Arbeitsprozesse kann explizit angegeben werden (in jedem Fall wird natürlich </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_parallel_maintenance_workers</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nicht überschritten </font><font style="vertical-align: inherit;">, was </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_worker_processes</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nicht überschreitet </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Ein expliziter Hinweis kann insbesondere verwendet werden, um die Parallelität zu deaktivieren:</font></font><br>
<br>
<pre><code class="pgsql hljs">demo=# <span class="hljs-keyword">VACUUM</span> (PARALLEL <span class="hljs-number">0</span>, <span class="hljs-keyword">VERBOSE</span>) ticket_flights;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dass dieses Thema weiterentwickelt wird. </font><font style="vertical-align: inherit;">Die Tabelle konnte durch mehrere Prozesse parallel gescannt werden (dies war im ursprünglichen Savada-Patch enthalten, war aber im letzten nicht enthalten). Jeder Index konnte auch parallel gelöscht werden. </font><font style="vertical-align: inherit;">Es ist auch notwendig, die automatische Reinigung zu lehren, um Parallelität zu verwenden.</font></font><br>
<br>
<blockquote><b>P. S.</b> ,       .       . -  ,   ,   .<br>
</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de486264/">https://habr.com/ru/post/de486264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de486252/index.html">Was passiert, wenn Sie eineinhalb Mal beschleunigen?</a></li>
<li><a href="../de486256/index.html">Elektronische Ausweise</a></li>
<li><a href="../de486258/index.html">PIndastrial Shield - Netzteil und RS-485-Schnittstellenmodul für Raspberry PI</a></li>
<li><a href="../de486260/index.html">Zeigen Sie Nachrichten im Spiel mit dem Partikelsystem an</a></li>
<li><a href="../de486262/index.html">5G-Netzwerkschwachstellen</a></li>
<li><a href="../de486268/index.html">Rust 1.41.0 Release: Neue Garantien für Box <T> in FFI, Verbesserungen bei der Frachtinstallation, Lockerung der Einschränkungen für Merkmale</a></li>
<li><a href="../de486274/index.html">Wird Bitcoin als sicherer Vermögenswert angesehen, nachdem der Markt auf den Konflikt zwischen dem Iran und den Vereinigten Staaten reagiert hat?</a></li>
<li><a href="../de486278/index.html">Materialien von Kafka mitap: СDC-Steckverbinder, Wachstumsprobleme, Kubernetes</a></li>
<li><a href="../de486288/index.html">Überwachung von Apache Ignite. Richtig gemacht</a></li>
<li><a href="../de486298/index.html">Ketogene Ernährung: von der Behandlung von Epilepsie bis zu einer ungesunden Art und Weise</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>