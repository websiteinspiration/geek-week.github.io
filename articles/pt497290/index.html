<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèπ üë©üèø‚Äçüöí üõê Melhorando o desempenho usando o cache uop no Sandy Bridge + üåè üëèüèæ ‚ôìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos modernos processadores Intel x86, o pipeline pode ser dividido em 2 partes: Front End e Back End. 
 
 O Front End √© respons√°vel por carregar o c√≥d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Melhorando o desempenho usando o cache uop no Sandy Bridge +</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497290/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos modernos processadores Intel x86, o pipeline pode ser dividido em 2 partes: Front End e Back End. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Front End √© respons√°vel por carregar o c√≥digo da mem√≥ria e decodific√°-lo em micro-opera√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Back-End √© respons√°vel por realizar micro-opera√ß√µes no Front-End. </font><font style="vertical-align: inherit;">Como essas micro-opera√ß√µes podem ser executadas pelo kernel fora de ordem, o Back-end tamb√©m garante que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resultado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dessas micro-opera√ß√µes corresponda estritamente √† ordem na qual elas s√£o inseridas no c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na maioria dos casos, o uso ineficiente do Front End'a n√£o tem um efeito percept√≠vel no desempenho. </font><font style="vertical-align: inherit;">O pico de largura de banda na maioria dos processadores Intel √© de 4 micro opera√ß√µes por ciclo; portanto, por exemplo, para um c√≥digo ligado √† mem√≥ria / L3, a CPU n√£o poder√° utiliz√°-lo completamente.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pro relativamente novo Ice Lake</font></font></b><div class="spoiler_text">   ,      Ice Lake    4  5   .  ,        ,         . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, em alguns casos, a diferen√ßa no desempenho pode ser bastante significativa. </font><font style="vertical-align: inherit;">Sob o corte est√° uma an√°lise do impacto do cache de microopera√ß√£o no desempenho.</font></font><br>
<a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O conte√∫do do artigo</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meio Ambiente</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vis√£o geral dos processadores Front-End Intel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise de pico de largura de banda ¬µop cache -&gt; IDQ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meio Ambiente</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para todas as medi√ß√µes neste artigo ser√£o usadas </font></font><code>i7-8550U Kaby Lake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, HT ativado / </font></font><code>Ubuntu 18.04/Linux Kernel 5.3.0-45-generic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nesse caso, esse ambiente pode ser significativo, porque </font><font style="vertical-align: inherit;">cada modelo de CPU possui seu pr√≥prio evento de desempenho. </font><font style="vertical-align: inherit;">Em particular, para microarquiteturas mais antigas que Sandy Bridge, alguns dos eventos usados ‚Äã‚Äãno futuro simplesmente n√£o fazem sentido.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vis√£o geral dos processadores Front-End Intel</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A organiza√ß√£o de alto n√≠vel da linha de montagem √© uma informa√ß√£o publicamente dispon√≠vel e √© publicada na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o oficial da Intel sobre otimiza√ß√£o de software</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Uma descri√ß√£o mais detalhada de alguns dos recursos omitidos na documenta√ß√£o oficial pode ser encontrada em outras fontes respeit√°veis, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agner Fog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis Downs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ent√£o, por exemplo, o esquema de montagem de dutos para a Skylake na documenta√ß√£o da Intel se parece com: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qe/jr/xa/qejrxaieyvky3yjl5yps8toljme.png" alt="Gasoduto Skylake"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma </font><font style="vertical-align: inherit;">olhada </font><font style="vertical-align: inherit;">mais de perto </font><font style="vertical-align: inherit;">no </font><font style="vertical-align: inherit;">topo desse esquema - Front End. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dp/ya/yw/dpyaywk2lq0qub5zh4dvjlqwjn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pipeline de decodifica√ß√£o herdado √© respons√°vel por decodificar o c√≥digo em micro-opera√ß√µes. </font><font style="vertical-align: inherit;">Consiste nos seguintes componentes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unidade de busca de instru√ß√µes - IFU</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de instru√ß√µes de primeiro n√≠vel - L1i</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de Endere√ßo de Tradu√ß√£o de Log de Instru√ß√£o - ITLB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefeito do Instrutor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instru√ß√µes de pr√©-decodificador</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fila de instru√ß√µes pr√©-decodificadas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodificadores de instru√ß√µes pr√©-decodificados para micro-opera√ß√£o</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere cada uma das partes do pipeline de decodifica√ß√£o herdada individualmente. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unidade de busca de instru√ß√µes. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele √© respons√°vel por carregar o c√≥digo, pr√©-codificar (determinar o comprimento da instru√ß√£o e propriedades como "se a instru√ß√£o √© uma ramifica√ß√£o") e fornecer instru√ß√µes pr√©-decodificadas para a fila. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de instru√ß√µes de primeiro n√≠vel - L1i</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para baixar o c√≥digo, o IFU usa L1i, o cache de instru√ß√µes de primeiro n√≠vel, e L2 / LLC, o cache de segundo n√≠vel e o cache offcore de n√≠vel superior, comuns a c√≥digos e dados. O download √© realizado em partes de 16 bytes, tamb√©m alinhadas em 16 bytes. Quando o pr√≥ximo trecho de c√≥digo de 16 bytes √© carregado em ordem, √© feita uma chamada para L1i e, se a linha correspondente n√£o for encontrada, uma pesquisa √© realizada em L2 e, em caso de falha, em LLC e mem√≥ria. Antes da Skylake LLC, o cache era inclusivo - cada linha em L1 (i / d) e L2 deveria estar contida na LLC. Assim, a LLC ‚Äúsabia‚Äù sobre todas as linhas em todos os n√∫cleos e, no caso de um deslizamento da LLC, era sabido se os caches em outros n√∫cleos continham a linha necess√°ria no estado Modificado, o que significa que essa linha poderia ser carregada de outro n√∫cleo. O Skylake LLC se tornou um cache n√£o inclusivo de v√≠tima de L2, mas o tamanho de L2 foi aumentado 4 vezes. Eu n√£o seise L2 √© inclusivo em rela√ß√£o a L1i. L2</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inclui em rela√ß√£o a L1d. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tradu√ß√£o de endere√ßos l√≥gicos de instru√ß√µes - ITLB</font></font></b> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Antes de baixar dados do cache, voc√™ deve procurar a linha correspondente. Para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caches associativos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cada linha pode estar em </font></font><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lugares diferentes no pr√≥prio cache. Para determinar as posi√ß√µes poss√≠veis no cache, um √≠ndice √© usado (geralmente alguns bits mais baixos do endere√ßo). Para determinar se a linha corresponde ao endere√ßo que precisamos, uma tag √© usada (o restante do endere√ßo). Quais endere√ßos usar: f√≠sico ou l√≥gico - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">depende da implementa√ß√£o do cache</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O uso de endere√ßos f√≠sicos requer tradu√ß√£o de endere√ßos. Para convers√£o de endere√ßo, √© usado um buffer TLB, que armazena em cache os resultados de percursos de p√°gina, reduzindo assim o atraso no recebimento de um endere√ßo f√≠sico de um endere√ßo l√≥gico nas chamadas subsequentes. Para obter instru√ß√µes, existe seu pr√≥prio buffer TLB de instru√ß√£o, localizado separadamente do Data TLB. O n√∫cleo da CPU tamb√©m possui um TLB de segundo n√≠vel comum para c√≥digo e dados - STLB. N√£o sei se o STLB √© inclusivo para mim (h√° rumores de que n√£o √© um cache de v√≠tima inclusivo em rela√ß√£o ao D / I TLB). Usando instru√ß√µes de pr√©-busca de software</font></font><code>prefetcht1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ pode puxar a linha com o c√≥digo em L2; no entanto, o registro TLB correspondente ser√° puxado apenas em DTLB. </font><font style="vertical-align: inherit;">Se o STLB n√£o for inclusivo, quando voc√™ procurar esta linha com o c√≥digo nos caches, receber√° ITLB miss -&gt; STLB miss -&gt; page walk (na verdade, n√£o √© t√£o simples, porque o kernel pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iniciar uma p√°gina especulativa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes que isso aconte√ßa Falta de TLB). </font><font style="vertical-align: inherit;">A documenta√ß√£o da Intel tamb√©m desencoraja o uso de prefets de SW para c√≥digo, Intel Software Optimization Manual / 2.5.5.4:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pr√©-busca controlada por software destina-se √† pr√©-busca de dados, mas n√£o ao c√≥digo de pr√©-busca.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, Travis D. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencionou</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que essa pr√©-busca pode ser muito eficaz (e provavelmente √©), mas por enquanto isso n√£o √© √≥bvio para mim e, para ter certeza, precisarei examinar separadamente esse problema. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefeito do Instrutor</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O carregamento de dados no cache (L1d / i, L2, etc) ocorre ao acessar um local de mem√≥ria n√£o armazenada em cache. </font><font style="vertical-align: inherit;">No entanto, se isso acontecesse apenas sob essas condi√ß√µes, como resultado, obter√≠amos um uso ineficiente da largura de banda do cache. </font><font style="vertical-align: inherit;">Por exemplo, no Sandy Bridge para opera√ß√µes de leitura L1d - 2, 1 grava 16 bytes por ciclo; </font><font style="vertical-align: inherit;">para a opera√ß√£o de leitura L1i - 1 de 16 bytes, a taxa de transfer√™ncia de grava√ß√£o n√£o est√° especificada na documenta√ß√£o, o Agner Fog tamb√©m n√£o foi encontrado. </font><font style="vertical-align: inherit;">Para resolver esse problema, existem pr√©-buscadores de hardware que podem determinar o padr√£o de acesso √† mem√≥ria e puxar as linhas necess√°rias para o cache antes que o c√≥digo realmente as resolva. </font><font style="vertical-align: inherit;">A documenta√ß√£o da Intel define 4 pr√©-buscadores: 2 para L1d, 2 para L2:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L1 DCU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Prefixa linhas de cache serial. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encaminhar somente leitura</font></font></b></li>
<li><b>L1 IP</b> ‚Äî              (. 0x5555555545a0, 0x5555555545b0, 0x5555555545c0, ...),    ,   ,  </li>
<li><b>L2 Spatial</b> ‚Äî       L2    -,        128-.       LLC</li>
<li><b>L2 Streamer</b> ‚Äî    .    L1 DCU      ¬´¬ª.       LLC</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A documenta√ß√£o da Intel n√£o descreve o princ√≠pio do prefeito L1i. </font><font style="vertical-align: inherit;">Tudo o que se sabe √© que a Unidade de Previs√£o de Filial (BPU) est√° envolvida nesse processo, Manual de Otimiza√ß√£o de Software Intel / 2.6.2: O </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/js/y3/sdjsy3jrgseyeuukletr84i2gyu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agner Fog tamb√©m n√£o v√™ nenhum detalhe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√©-busca de c√≥digo no L2 / LLC √© explicitamente definida apenas para o Streamer. </font><font style="vertical-align: inherit;">Manual de otimiza√ß√£o / 2.5.5.4 Prefectching de dados:</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streamer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : esse pr√©-buscador monitora solicita√ß√µes de leitura do cache L1 para sequ√™ncias ascendentes e descendentes de endere√ßos. </font><font style="vertical-align: inherit;">As solicita√ß√µes de leitura monitorada incluem solicita√ß√µes L1 DCache iniciadas por opera√ß√µes de carregamento e armazenamento e pelos pr√©-buscadores de hardware e solicita√ß√µes L1 ICache para busca de c√≥digo.</font></font></blockquote> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o pr√©-buscador espacial, isso claramente n√£o est√° explicitado:</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©-buscador espacial:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esse pr√©-buscador se esfor√ßa para concluir todas as linhas de cache buscadas no cache L2 com a linha de pares que o completa em um bloco alinhado de 128 bytes.</font></font></blockquote> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso pode ser verificado. </font><font style="vertical-align: inherit;">Cada um desses pr√©-buscadores pode ser desativado usando </font></font><code>MSR 0x1A4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, conforme descrito no manual </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Registradores Espec√≠ficos</font></a><font style="vertical-align: inherit;"> do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo.</font></font></a><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre MSR 0x1A4</font></font></b><div class="spoiler_text">  MSR     L2 Spatial    L1i.     .              ,    LLC.     L2 Streamer       2.5 . <br>
<br>
 Linux  msr ,   msr     .  <code>$ sudo wrmsr -p 1 0x1a4 1</code>  L2 Streamer   1.<br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instru√ß√µes de pr√©-decodificador</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Depois que o pr√≥ximo c√≥digo de 16 bytes √© carregado, eles se enquadram nas instru√ß√µes de pr√©-decodificador. </font><font style="vertical-align: inherit;">Sua tarefa √© determinar o comprimento da instru√ß√£o, decodificar os prefixos e marcar se a instru√ß√£o correspondente √© uma ramifica√ß√£o (provavelmente ainda existem muitas propriedades diferentes, mas a documenta√ß√£o sobre elas √© silenciosa). </font><font style="vertical-align: inherit;">Manual de otimiza√ß√£o de software Intel / 2.6.2.2:</font></font><br>
<blockquote>The predecode unit accepts the sixteen bytes from the instruction cache or prefetch buffers and carries out the following tasks:<br>
<br>
<ul>
<li>Determine the length of the instructions</li>
<li>Decode all prefixes associated with instructions</li>
<li>Mark various properties of instructions for the decoders (for example, ‚Äúis branch.‚Äù)</li>
</ul></blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma linha de instru√ß√µes pr√©-decodificadas. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No IFU, as instru√ß√µes s√£o adicionadas √† fila de instru√ß√µes pr√©-codificadas. </font><font style="vertical-align: inherit;">Essa fila aparece desde a Nehalem, de acordo com a documenta√ß√£o da Intel, seu tamanho √© 18 instru√ß√µes. </font><font style="vertical-align: inherit;">Agner Fog tamb√©m menciona que essa fila n√£o cont√©m mais que 64 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m no Core2, essa fila foi usada como um cache de loop. </font><font style="vertical-align: inherit;">Se todas as microopera√ß√µes do ciclo estiverem na fila, em alguns casos, o custo de carregamento e pr√©-codifica√ß√£o poder√° ser evitado. </font><font style="vertical-align: inherit;">O LSD (Loop Stream Detector) pode fornecer instru√ß√µes que j√° est√£o na fila at√© a BPU sinalizar que o ciclo terminou. </font><font style="vertical-align: inherit;">Agner Fog tem v√°rias notas interessantes sobre o LSD no Core2:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consiste em 4 linhas de 16 bytes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Taxa de transfer√™ncia m√°xima de at√© 32 bytes de c√≥digo por ciclo</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßando com o Sandy Bridge, esse cache de loop foi movido da fila de instru√ß√µes pr√©-decodificada de volta para o IDQ. </font></font><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodificadores de instru√ß√µes pr√©-decodificadas em microopera√ß√£o</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Na fila de instru√ß√µes pr√©-decodificadas, o c√≥digo √© enviado para decodifica√ß√£o em microopera√ß√£o. Os decodificadores s√£o respons√°veis ‚Äã‚Äãpela decodifica√ß√£o - existem 4. No total, de acordo com a documenta√ß√£o da Intel, um dos decodificadores pode decodificar instru√ß√µes que consistem em 4 micro-opera√ß√µes ou menos. O restante decodifica instru√ß√µes que consistem em uma microopera√ß√£o (micro / macro fundida), Intel Software Optimization Manual / 2.5.2.1:</font></font><br>
<blockquote>There are four decoding units that decode instruction into micro-ops. The first can decode all IA-32 and Intel 64 instructions up to four micro-ops in size. The remaining three decoding units handle single-micro-op instructions. All four decoding units support the common cases of single micro-op flows including micro-fusion and macro-fusion.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As instru√ß√µes decodificadas em um grande n√∫mero de micro-opera√ß√µes (por exemplo, rep movsb usadas na implementa√ß√£o do memcpy in libc em certos tamanhos de mem√≥ria copiada) s√£o fornecidas pelo Microcode Sequencer (MS ROM). A largura de banda de pico do seq√ºenciador √© de 4 micro-opera√ß√µes por ciclo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver no diagrama da linha de montagem, o Legacy Decode Pipeline pode decodificar at√© 5 micro opera√ß√µes por ciclo no Skylake. Em Broadwell e mais antigos, o pico de produtividade do Legacy Decode Pipeline era de 4 micro-opera√ß√µes por ciclo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de microopera√ß√£o</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que as instru√ß√µes s√£o decodificadas nas microopera√ß√µes, no pipeline de decodifica√ß√£o herdado, elas caem na fila de microopera√ß√µes especial - fila de decodifica√ß√£o de instru√ß√µes (IDQ), bem como no chamado cache de microopera√ß√£o (ICache decodificado, cache ¬µop). O cache de microopera√ß√£o foi originalmente introduzido no Sandy Bridge e √© usado para evitar instru√ß√µes de busca e decodifica√ß√£o em microopera√ß√µes, aumentando assim a taxa de transfer√™ncia para a entrega de microopera√ß√µes em IDQ - at√© 6 por ciclo. Depois de entrar no IDQ, as microopera√ß√µes v√£o para o Back-end para execu√ß√£o com uma taxa de transfer√™ncia m√°xima de 4 micro-opera√ß√µes por ciclo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com a documenta√ß√£o da Intel, o cache de microopera√ß√£o consiste em 32 conjuntos, cada conjunto cont√©m 8 linhas, cada linha pode armazenar em cache at√© 6 micro opera√ß√µes (micro / macro fundida), permitindo um cache total de at√© 32 * 8 * 6 = 1536 micro opera√ß√µes . </font><font style="vertical-align: inherit;">O cache de microopera√ß√£o ocorre com uma granularidade de 32 bytes, ou seja, </font><font style="vertical-align: inherit;">as micro-opera√ß√µes que seguem instru√ß√µes de diferentes regi√µes de 32 bytes n√£o podem cair em uma linha. </font><font style="vertical-align: inherit;">No entanto, at√© 3 linhas de cache diferentes podem corresponder a uma regi√£o de 32 bytes. </font><font style="vertical-align: inherit;">Assim, at√© 18 microopera√ß√µes no cache ¬µop podem corresponder a cada regi√£o de 32 bytes.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual de otimiza√ß√£o de software Intel / 2.5.5.2</font></font></b><div class="spoiler_text"><blockquote>The Decoded ICache consists of 32 sets. Each set contains eight Ways. Each Way can hold up to six micro-ops. The Decoded ICache can ideally hold up to 1536 micro-ops. The following are some of the rules how the Decoded ICache is filled with micro-ops:<br>
<br>
<ul>
<li>ll micro-ops in a Way represent instructions which are statically contiguous in the code and have their EIPs within the same aligned 32-byte region.</li>
<li>Up to three Ways may be dedicated to the same 32-byte aligned chunk, allowing a total of 18 micro-ops to be cached per 32-byte region of the original IA program.</li>
<li>A multi micro-op instruction cannot be split across Ways.</li>
<li>Up to two branches are allowed per Way. </li>
<li>An instruction which turns on the MSROM consumes an entire Way.</li>
<li>A non-conditional branch is the last micro-op in a Way. </li>
<li>Micro-fused micro-ops (load+op and stores) are kept as one micro-op.</li>
<li>A pair of macro-fused instructions is kept as one micro-op.</li>
<li>Instructions with 64-bit immediate require two slots to hold the immediate.</li>
</ul></blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agner Fog tamb√©m menciona que apenas micro-opera√ß√µes de linha √∫nica podem ser baixadas por ciclo (n√£o explicitamente declarado na documenta√ß√£o da Intel, embora possa ser facilmente verificado manualmente).</font></font><br>
<br>
<h4>    ¬µop cache --&gt; IDQ</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em alguns casos, √© muito conveniente usar </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comprimentos de 1 byte </font><font style="vertical-align: inherit;">para estudar o comportamento do Front End </font><font style="vertical-align: inherit;">. Ao mesmo tempo, podemos ter certeza de que estamos investigando o Front End, e n√£o o Barramento de Recursos no Back End, por qualquer motivo. O fato √© que </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, al√©m de outras instru√ß√µes, eles s√£o decodificados no pipeline de decodifica√ß√£o herdado, misturados no cache ¬µop e enviados ao IDQ. Al√©m disso </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, assim como outras instru√ß√µes, leva de volta ao final. A diferen√ßa significativa √© que, dos recursos no back-end, ele </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa apenas o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffer de reordena√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e n√£o requer um slot na esta√ß√£o de reserva (tamb√©m conhecido como Scheduler). Assim, imediatamente ap√≥s entrar no Reordenar Buffer, ele estar√° </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pronto para a aposentadoria, o que ser√° executado de acordo com a ordem no c√≥digo do programa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar a taxa de transfer√™ncia, declare uma fun√ß√£o </font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_decoded_icache</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> iteration_count)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
com implementa√ß√£o em </font></font><code>nasm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">align 32<font></font>
test_decoded_icache:<font></font>
    ;nop',  0  23 <font></font>
    dec rdi<font></font>
    ja test_decoded_icache<font></font>
    ret</code></pre><br>
<code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o foi escolhido por acaso. </font></font><code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>dec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usar diferentes bandeiras - </font></font><code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√™ </font></font><code>CF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>ZF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>dec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o registrando na CF, de modo Macro fus√£o n√£o se aplica. </font><font style="vertical-align: inherit;">Isso √© feito exclusivamente para a conveni√™ncia de contar as micro-opera√ß√µes em um ciclo - cada instru√ß√£o corresponde a uma micro-opera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para medi√ß√µes, precisamos dos seguintes eventos perf: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. </font></font><code>uops_issued.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Usado para contar as micro-opera√ß√µes que o Renamer realiza do IDQ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Intel System Programming Guide documenta esse evento como o n√∫mero de micro-opera√ß√µes que a Renamer coloca na esta√ß√£o de reserva:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conta o n√∫mero de uops que a Tabela de Aloca√ß√£o de Recursos (RAT) emite para a Esta√ß√£o de Reserva (RS).</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta descri√ß√£o n√£o se correlaciona completamente com os valores que podem ser obtidos em experimentos. Em particular, eles </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caem nesse balc√£o, embora seja apenas um fato que eles n√£o s√£o necess√°rios na Esta√ß√£o de Reserva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. </font></font><code>uops_retired.retire_slots</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero total de micro-opera√ß√µes aposentadas, levando em considera√ß√£o a micro / macro-fus√£o </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. </font></font><code>uops_retired.stall_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de ticks para os quais n√£o houve uma √∫nica microopera√ß√£o aposentada </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. </font></font><code>resource_stalls.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de ticks do transportador inativo devido √† inacessibilidade de qualquer um dos recursos Back End </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Manual de otimiza√ß√£o de software da Intel / B .4.1 existe um diagrama de conte√∫do que caracteriza os eventos descritos acima: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wq/j9/y3/wqj9y3jj7aeisnmdjxxxjwsl_jk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. </font></font><code>idq.all_dsb_cycles_4_uops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de ciclos de rel√≥gio para os quais 4 (ou mais) instru√ß√µes foram entregues do ¬µop cache.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato de essa m√©trica levar em considera√ß√£o a entrega de mais de 4 microopera√ß√µes por ciclo n√£o √© descrito na documenta√ß√£o da Intel, mas concorda muito bem com os experimentos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. </font></font><code>idq.all_dsb_cycles_any_uops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o n√∫mero de medidas para as quais foi entregue pelo menos uma micro opera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. </font></font><code>idq.dsb_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- O n√∫mero total de medidas nas quais a entrega foi realizada no ¬µop cache </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. </font></font><code>idq_uops_not_delivered.cycles_le_N_uop_deliv.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- O n√∫mero de medidas pelas quais a Renamer realizou uma </font></font><code>N</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou menos microopera√ß√µes e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o houve tempo de inatividade no lado do back-end</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><code>N</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- 1, 2, 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fazemos pesquisas </font></font><code>iteration_count = 1 &lt;&lt; 31</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Come√ßamos a an√°lise do que est√° acontecendo na CPU examinando o n√∫mero de micro-opera√ß√µes e, primeiro, medindo a largura de banda m√©dia da aposentadoria, ou seja, </font></font><code>uops_retired.retire_slots/uops_retired.total_cycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xi/b2/0s/xib20shepbr334i1xmhka10rjeg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que imediatamente chama sua aten√ß√£o √© a subsid√™ncia do rendimento da aposentadoria em um tamanho de ciclo de 7 micro-opera√ß√µes. Para entender qual √© o problema, vamos dar uma olhada em como a velocidade m√©dia de entrega do ¬µop cache - muda </font></font><code>idq.all_dsb_cycles_any_uops / idq.dsb_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xm/5s/su/xm5ssuzamxr4th-xs7e0ixrisfm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e como est√£o o n√∫mero total de medidas e medidas para o qual o ¬µop cache entregue ao IDQ est√° relacionado: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/it/w5/va/itw5vasl9ogpslneyoclxzasu4k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, podemos ver que, com um ciclo de 6 micro opera√ß√µes, obtemos uma efici√™ncia utiliza√ß√£o da largura de banda do cache ¬µop - 6 micro opera√ß√µes por ciclo. Devido ao fato de o Renamer n√£o suportar tanto quanto o ¬µop cache entrega, parte dos ciclos do ¬µop cache n√£o fornece nada, o que √© claramente vis√≠vel no gr√°fico anterior.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com um ciclo de 7 microopera√ß√µes, obtemos uma queda acentuada na taxa de transfer√™ncia do cache ¬µop - 3,5 microopera√ß√µes por ciclo. Ao mesmo tempo, como pode ser visto no gr√°fico anterior, o ¬µop cache est√° constantemente em opera√ß√£o. Assim, com um ciclo de 7 microopera√ß√µes, obtemos uma utiliza√ß√£o ineficiente do cache de largura de banda ¬µop. O fato √© que, como observado anteriormente, o ¬µop cache por ciclo pode oferecer microopera√ß√µes a partir de apenas uma linha. No caso de microopera√ß√µes 7 - as 6 primeiras caem em uma linha e as 7¬™ restantes - em outra. Dessa forma, obtemos 7 micro-opera√ß√µes por 2 ciclos ou 3,5 micro-opera√ß√µes por ciclo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, vamos ver como a Renamer obt√©m micro-opera√ß√µes da IDQ. Para isso, precisamos </font></font><code>idq_uops_not_delivered.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>idq_uops_not_delivered.cycles_le_N_uop_deliv.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kv/mg/qv/kvmgqvwgra-j4qgpxia46mwlsh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode notar que, com 7 microopera√ß√µes, apenas 3 microopera√ß√µes por vez levam metade dos ciclos da Renamer. A partir daqui, obtemos um rendimento de aposentadoria de uma m√©dia de 3,5 micro-opera√ß√µes por ciclo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro ponto interessante relacionado a este exemplo pode ser visto se considerarmos o </font><font style="vertical-align: inherit;">rendimento </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">efetivo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da aposentadoria. Essa. sem considerar </font></font><code>uops_retired.stall_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uo/hy/gt/uohygtod0xknhsvolqjnig7tfos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode-se notar que, com 7 microopera√ß√µes, a cada 7 medidas de aposentadoria de 4 microopera√ß√µes √© executada e a cada 8 medidas √© inativa sem microopera√ß√µes aposentadas (estol de aposentadoria). </font><font style="vertical-align: inherit;">Ap√≥s a realiza√ß√£o de uma s√©rie de experimentos, foi poss√≠vel descobrir que esse comportamento sempre era observado durante 7 microopera√ß√µes, independentemente do layout 1-6, 6-1, 2-5, 5-2, 3-4, 4-3. </font><font style="vertical-align: inherit;">N√£o sei por que esse √© exatamente o caso, e n√£o, por exemplo, a retirada de tr√™s microopera√ß√µes √© realizada em um ciclo de rel√≥gio e quatro no seguinte. </font><font style="vertical-align: inherit;">Agner Fog mencionou que as transi√ß√µes de ramifica√ß√£o s√≥ podem usar parte dos slots da esta√ß√£o de aposentadoria. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> essa restri√ß√£o seja a raz√£o desse comportamento de aposentadoria.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender se tudo isso tem efeito na pr√°tica, considere o seguinte exemplo um pouco mais pr√°tico do que com </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duas matrizes s√£o fornecidas </font></font><code>unsigned</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">√â necess√°rio acumular a soma das m√©dias aritm√©ticas de cada √≠ndice e grav√°-la na terceira matriz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo de implementa√ß√£o pode ser assim:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> arr1[] = { ... };<font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> arr2[] = { ... };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arithmetic_mean</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> *arr1, <span class="hljs-keyword">unsigned</span> *arr2, <span class="hljs-keyword">unsigned</span> *out, <span class="hljs-keyword">size_t</span> sz)</span></span>{
    <span class="hljs-keyword">unsigned</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">size_t</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(idx &lt; sz){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
    }<font></font>
    __asm__ __volatile__(<span class="hljs-string">""</span> ::: <span class="hljs-string">"memory"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>{
    <span class="hljs-keyword">unsigned</span> out[<span class="hljs-keyword">sizeof</span> arr1 / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span>)];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4096</span> * <span class="hljs-number">4096</span>; i++){<font></font>
        arithmetic_mean(arr1, arr2, out, <span class="hljs-keyword">sizeof</span> arr1 / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span>));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilar com sinalizadores do gcc </font></font><br>
<br>
<pre><code class="plaintext hljs">-Werror<font></font>
-Wextra<font></font>
-Wall<font></font>
-pedantic<font></font>
-Wno-stack-protector<font></font>
-g3<font></font>
-O3<font></font>
-Wno-unused-result<font></font>
-Wno-unused-parameter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â bastante √≥bvio que a fun√ß√£o </font></font><code>arithmetic_mean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o estar√° presente no c√≥digo e ser√° inserida diretamente em </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">(gdb) disas main<font></font>
Dump of assembler code for function main:<font></font>
   #...<font></font>
   0x00000000000005dc &lt;+60&gt;:    nop    DWORD PTR [rax+0x0]<font></font>
   0x00000000000005e0 &lt;+64&gt;:    mov    edx,DWORD PTR [rdi+rax*4]<font></font>
   0x00000000000005e3 &lt;+67&gt;:    add    edx,DWORD PTR [r8+rax*4]<font></font>
   0x00000000000005e7 &lt;+71&gt;:    shr    edx,1<font></font>
   0x00000000000005e9 &lt;+73&gt;:    add    ecx,edx<font></font>
   0x00000000000005eb &lt;+75&gt;:    mov    DWORD PTR [rsi+rax*4],ecx<font></font>
   0x00000000000005ee &lt;+78&gt;:    add    rax,0x1<font></font>
   0x00000000000005f2 &lt;+82&gt;:    cmp    rax,0x80<font></font>
   0x00000000000005f8 &lt;+88&gt;:    jne    0x5e0 &lt;main+64&gt;<font></font>
   0x00000000000005fa &lt;+90&gt;:    sub    r9,0x1<font></font>
   0x00000000000005fe &lt;+94&gt;:    jne    0x5d8 &lt;main+56&gt;<font></font>
   #...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que o compilador alinhou o c√≥digo do loop a 32 bytes ( </font></font><code>nop DWORD PTR [rax+0x0]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que √© exatamente o que precisamos. </font><font style="vertical-align: inherit;">Tendo assegurado que n√£o h√° </font></font><code>resource_stalls.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Back-End (todas as medi√ß√µes s√£o realizadas levando em considera√ß√£o o cache L1d aquecido), podemos come√ßar a considerar os contadores associados √† entrega ao IDQ:</font></font><br>
<br>
<pre><code class="plaintext hljs"> Performance counter stats for './test_decoded_icache':<font></font>
<font></font>
     2‚ÄØ273‚ÄØ343‚ÄØ251      idq.all_dsb_cycles_4_uops                                     (15,94%)<font></font>
     4‚ÄØ458‚ÄØ322‚ÄØ025      idq.all_dsb_cycles_any_uops                                     (16,26%)<font></font>
    15‚ÄØ473‚ÄØ065‚ÄØ238      idq.dsb_uops                                                  (16,59%)<font></font>
     4‚ÄØ358‚ÄØ690‚ÄØ532      idq.dsb_cycles                                                (16,91%)<font></font>
     2‚ÄØ528‚ÄØ373‚ÄØ243      idq_uops_not_delivered.core                                     (16,93%)<font></font>
        73‚ÄØ728‚ÄØ040      idq_uops_not_delivered.cycles_0_uops_deliv.core                                     (16,93%)<font></font>
       107‚ÄØ262‚ÄØ304      idq_uops_not_delivered.cycles_le_1_uop_deliv.core                                     (16,93%)<font></font>
       108‚ÄØ454‚ÄØ043      idq_uops_not_delivered.cycles_le_2_uop_deliv.core                                     (16,65%)<font></font>
     2‚ÄØ248‚ÄØ557‚ÄØ762      idq_uops_not_delivered.cycles_le_3_uop_deliv.core                                     (16,32%)<font></font>
     2‚ÄØ385‚ÄØ493‚ÄØ805      idq_uops_not_delivered.cycles_fe_was_ok                                     (16,00%)<font></font>
    15‚ÄØ147‚ÄØ004‚ÄØ678     uops_retired.retire_slots<font></font>
    4‚ÄØ724‚ÄØ790‚ÄØ623      uops_retired.total_cycles<font></font>
       <font></font>
     1,228684264 seconds time elapsed<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que a largura da aposentadoria nesse caso = 15147004678/4724790623 = 3.20585733562 e tamb√©m que apenas tr√™s microopera√ß√µes levam metade dos rel√≥gios da Renamer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora adicione a promo√ß√£o manual do loop √† implementa√ß√£o:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arithmetic_mean</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> *arr1, <span class="hljs-keyword">unsigned</span> *arr2, <span class="hljs-keyword">unsigned</span> *out, <span class="hljs-keyword">size_t</span> sz)</span></span>{
    <span class="hljs-keyword">unsigned</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">size_t</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(sz &amp; <span class="hljs-number">2</span>){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
    }<font></font>
    <span class="hljs-keyword">while</span>(idx &lt; sz){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;  <span class="hljs-comment">//   idx++     idx+=2</span><font></font>
    }<font></font>
    __asm__ __volatile__(<span class="hljs-string">""</span> ::: <span class="hljs-string">"memory"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os contadores de desempenho resultantes s√£o parecidos com:</font></font><br>
<br>
<pre><code class="plaintext hljs">Performance counter stats for './test_decoded_icache':<font></font>
<font></font>
     2‚ÄØ152‚ÄØ818‚ÄØ549      idq.all_dsb_cycles_4_uops                                     (14,79%)<font></font>
     3‚ÄØ207‚ÄØ203‚ÄØ856      idq.all_dsb_cycles_any_uops                                     (15,25%)<font></font>
    12‚ÄØ855‚ÄØ932‚ÄØ240      idq.dsb_uops                                                  (15,70%)<font></font>
     3‚ÄØ184‚ÄØ814‚ÄØ613      idq.dsb_cycles                                                (16,15%)<font></font>
        24‚ÄØ946‚ÄØ367      idq_uops_not_delivered.core                                     (16,24%)<font></font>
         3‚ÄØ011‚ÄØ119      idq_uops_not_delivered.cycles_0_uops_deliv.core                                     (16,24%)<font></font>
         5‚ÄØ239‚ÄØ222      idq_uops_not_delivered.cycles_le_1_uop_deliv.core                                     (16,24%)<font></font>
         7‚ÄØ373‚ÄØ563      idq_uops_not_delivered.cycles_le_2_uop_deliv.core                                     (16,24%)<font></font>
         7‚ÄØ837‚ÄØ764      idq_uops_not_delivered.cycles_le_3_uop_deliv.core                                     (16,24%)<font></font>
     3‚ÄØ418‚ÄØ529‚ÄØ799      idq_uops_not_delivered.cycles_fe_was_ok                                     (16,24%)<font></font>
     3‚ÄØ444‚ÄØ833‚ÄØ440      uops_retired.total_cycles                                     (18,18%)<font></font>
    13‚ÄØ037‚ÄØ919‚ÄØ196      uops_retired.retire_slots                                     (18,17%)<font></font>
<font></font>
    0,871040207 seconds time elapsed</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, temos largura de banda de aposentadoria = 13037919196/3444833440 = 3.78477491672, al√©m de utiliza√ß√£o eficiente da largura de banda Renamer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, n√£o apenas nos livramos de uma opera√ß√£o de ramifica√ß√£o e um incremento em um loop, mas tamb√©m aumentamos a largura de banda de aposentadoria usando a utiliza√ß√£o eficiente da taxa de transfer√™ncia do cache de microopera√ß√£o, o que proporcionou um aumento total de 28% no desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que apenas uma redu√ß√£o em uma opera√ß√£o de ramifica√ß√£o e incremento fornece um aumento de desempenho m√©dio de 9%.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pequena observa√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na CPU usada para realizar essas experi√™ncias, o LSD est√° desativado. </font><font style="vertical-align: inherit;">Parece que o LSD poderia lidar com essa situa√ß√£o. </font><font style="vertical-align: inherit;">Para CPUs com LSD ativado, esses casos precisar√£o ser investigados separadamente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt497278/index.html">Flutter. Assincronia e paralelismo</a></li>
<li><a href="../pt497280/index.html">Como eu parei de ter medo e me apaixonei por colesterol</a></li>
<li><a href="../pt497282/index.html">Limpe o c√≥digo em Angular. Cozinha ESLint, codelyzer, stylelint, husky, com fiapos e mais bonita</a></li>
<li><a href="../pt497286/index.html">Ludum Dare: lista de verifica√ß√£o uma semana antes do in√≠cio</a></li>
<li><a href="../pt497288/index.html">Plafon decorativo Feron AL5000</a></li>
<li><a href="../pt497292/index.html">Pilha de tecnologia Shiro Games</a></li>
<li><a href="../pt497296/index.html">Erros populares em ingl√™s entre profissionais de TI. Parte 2: Pron√∫ncia</a></li>
<li><a href="../pt497302/index.html">Navega√ß√£o aut√¥noma de um rob√¥ m√≥vel</a></li>
<li><a href="../pt497304/index.html">Intercepter-NG 2.5 lan√ßado para Android</a></li>
<li><a href="../pt497306/index.html">Falsifica√ß√£o de DLL (seq√ºestro de DLL)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>