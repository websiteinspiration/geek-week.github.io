<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèø üìé üéá HLS en MP4 en utilisant ffmpeg dans un navigateur ‚õ≤Ô∏è üíé üîπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="salut! Depuis plus de deux mois maintenant, pendant mon temps libre, je scie une application Web pour convertir HLS et DASH en MP4 en utilisant emscri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HLS en MP4 en utilisant ffmpeg dans un navigateur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504722/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! </font><font style="vertical-align: inherit;">Depuis plus de deux mois maintenant, pendant mon temps libre, je scie une application Web pour convertir HLS et DASH en MP4 en utilisant emscripten et ffmpeg, ce qui me donne envie de partager comment j'ai r√©ussi √† le faire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je ne citerai pas le code source des modifications et correctifs ffmpeg, comme </font><font style="vertical-align: inherit;">la plupart d'entre elles ont √©t√© faites sur le genou, et je ne suis pas tr√®s bon en C. Mais maintenant il y a assez d'articles pour vous aider.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a deux ans, j'avais pour objectif de combiner une piste audio et vid√©o en un seul fichier mp4. Ensuite, je me suis plong√© dans emscripten et pour les bases, j'ai trouv√© le r√©f√©rentiel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg.js √†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir duquel j'ai beaucoup appris. Ensuite, j'ai presque pu atteindre l'objectif, bien que j'√©tais tr√®s conditionnellement orient√© en C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprendre le code source, ffmpeg a cr√©√© un correctif pour travailler avec le syst√®me de fichiers, o√π la lecture d'un fichier a provoqu√© une fonction asynchrone en js √† partir de laquelle j'ai lu le blob du fichier et transf√©r√© le tampon, et lorsque l'√©criture a √©t√© appel√©e Fonction js qui a envoy√© des donn√©es de tampon au r√©f√©rentiel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y avait un probl√®me avec les fonctions asynchrones, que je ne pouvais pas r√©soudre correctement, elles fonctionnaient via asyncify (fastcomp), qui ne fonctionnait pas correctement dans certains cas, √† savoir, l'ex√©cution de code dans wasm ne s'arr√™tait pas, sans attendre un r√©sultat de la fonction js, c'est tout est tomb√© en panne. </font><font style="vertical-align: inherit;">Ce probl√®me a √©t√© r√©solu via l'indicateur EMTERPRETIFY_WHITELIST, qui a apparemment d√©plac√© le code de wasm vers asm en m√™me temps et l'a ralenti, et il √©tait n√©cessaire de d√©boguer la pile d'appels et d'ajouter une fonction cass√©e √† la liste √† chaque exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, avec de tels probl√®mes, cela ne pouvait pas √™tre appel√© une solution de travail, sur laquelle tout cela restait une petite d√©monstration.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/gu/z-/y-guz-s_vswdqlgfbt8vbshowcg.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un an et demi plus tard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir regard√© un rapport sur Google Dev Summit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur les nouvelles fonctionnalit√©s de WebAssambly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , je suis all√© voir comment allait emscripten et j'ai vu un message:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscripten √©met WebAssembly en utilisant le backend de wasm LLVM en amont, depuis la version 1.39.0 (octobre 2019), et l'ancien backend fastcomp est obsol√®te</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voulais aller essayer de reconstruire mes formats de reconditionnement. </font><font style="vertical-align: inherit;">Environ une semaine, j'ai cherch√© sur Google comment r√©soudre de nouveaux probl√®mes de compilation et finalement tout mettre ensemble. </font><font style="vertical-align: inherit;">Les changements n'√©taient pas si nombreux, mais cela n'allait pas √† cause du nouveau lieur de biblioth√®ques, et d√©j√† d√©sesp√©r√© de collecter au moins quelque chose, je viens de voir les biblioth√®ques probl√©matiques (comme il s'est av√©r√©, les biblioth√®ques elles-m√™mes sont connect√©es et vous n'avez plus besoin de les pointer √† la main pendant l'assemblage). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, le moment est venu o√π il s'est rassembl√© et a gagn√©! </font><font style="vertical-align: inherit;">Le probl√®me avec le code asynchrone avait disparu, il n'√©tait pas n√©cessaire de d√©boguer quoi que ce soit, cela a fonctionn√© comme il se doit depuis le d√©but. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, il me semble avoir atteint mon objectif, mais ... un nouveau est apparu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©√©crire le protocole HTTP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle pens√©e est dans mon esprit depuis longtemps. </font><font style="vertical-align: inherit;">Cela peut vous permettre de t√©l√©charger HLS ou DASH, et non seulement une liste de lecture pr√™te √† l'emploi, mais aussi un flux en direct. </font><font style="vertical-align: inherit;">Et je n'ai jamais rien vu de tel sur Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela m'a pris environ trois semaines pour faire au moins quelque chose qui fonctionne avec moi avec de courtes pauses. </font><font style="vertical-align: inherit;">Je connaissais C (tout en n'ayant aucune exp√©rience), il y avait beaucoup de probl√®mes avec les pointeurs (il est difficile de suivre ce qui va o√π, et m√™me dans le code de quelqu'un d'autre), mais enfin quelque chose a √©t√© compil√© sans erreurs. </font><font style="vertical-align: inherit;">Apr√®s les premiers succ√®s, cela a donn√© encore plus d'enthousiasme pour compl√©ter l'id√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juste quelques semaines, et finalement j'ai r√©ussi √† faire la premi√®re it√©ration du protocole http de travail, et cela semble √™tre tout?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand le plus dur est fini</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce stade, j'avais un framework pr√™t, un petit formulaire html avec un champ de saisie url et un bouton de d√©marrage, en gros √ßa fonctionnait. Mais il √©tait toujours n√©cessaire d'√©crire une extension pour contourner CORS et charger les donn√©es, cr√©er un stockage qui √©crirait les donn√©es en morceaux, cr√©er une interface avec affichage de la progression, d√©boguer le tout pour r√©soudre les probl√®mes dans diff√©rents navigateurs. D'une mani√®re g√©n√©rale, le moment est venu de permettre enfin de l'utiliser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fondamentalement, un script utilisateur a √©t√© cr√©√©, qui √©tait un proxy pour les demandes de r√©cup√©ration de ffmpeg pour t√©l√©charger des donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques jours plus tard, une extension pour Chrome et Firefox √©tait pr√™te, qui √† l'aide de webRequest a collect√© tous les liens hls que le navigateur charge lors du visionnage d'une vid√©o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Firefox, il s'est av√©r√© que l'API d'extension ne vous permet pas de g√©rer l'alimentation, √† partir de laquelle vous ne pouvez pas emp√™cher l'ordinateur de s'endormir, h√©las. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'extension ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/a6/ig/vua6igsxprko_lw12jwmstkfq48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vient d'am√©liorer la page sur laquelle le site √©tait un peu, du mat√©riel viss√©-ui, a finalis√© tous les endroits qui ont √©t√© fouett√©s. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/s1/il/tqs1iltzg0y1-h1hmmatewctvyo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir test√© diff√©rentes fa√ßons de stocker des donn√©es, j'ai r√©v√©l√© un certain nombre de probl√®mes: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Chrome les √©crit sur la RAM et tombe sur le disque lorsqu'il d√©borde, mais uniquement dans OSX lorsque la m√©moire d√©borde, le syst√®me d'exploitation quitte le compte et ferme toutes les applications ouvertes. Et Firefox a g√©n√©ralement toujours gard√© les donn√©es en m√©moire. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage du cache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- cela fonctionne comme IndexedDb, mais apr√®s avoir √©crit des donn√©es, dans le blob Chrome, ils restent dans la RAM (soit un bogue, soit une fitcha), mais il s'av√®re que les donn√©es sont √©crites sur le stockage en cache (sur le disque) et sont √©galement supprim√©es lorsque la m√©moire est pleine volume sur disque en tant qu'objet blob. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexedDb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fonctionne comme une horloge, sait stocker le blob, √©crit des donn√©es sans fioritures, mais Firefox limite strictement la quantit√© de 2 Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'y ai travaill√© un peu, j'ai r√©ussi √† interrompre le processus ffmpeg (via un pointeur), j'ai trouv√© comment faire un choix de formats (ffprobe) et g√©rer les erreurs r√©seau. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/80/eo/ut80eoy4c02vuelxcfrx9ngswga.png"><br>
<br>
<img src="https://habrastorage.org/webt/ae/b7/qi/aeb7qikdlqnzfhuyiy6_-onisro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, vous pouvez essayer le r√©sultat vous-m√™me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour moi, c'est une chose indispensable lorsque vous devez enregistrer un flux sur un tweet ou t√©l√©charger un VOD. </font><font style="vertical-align: inherit;">Il fonctionne √©galement avec un ordinateur portable, un m√©langeur et tout autre site qui diffuse du contenu en HLS ou DASH (h√©las, l'impl√©mentation DASH dans ffmpeg est tr√®s conditionnelle et en direct peut ne pas t√©l√©charger correctement, car elle ne prend pas en compte l'intervalle de demande de fragment). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci pour la lecture! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez des questions sur ffmpeg et emscripten - √©crivez, je vais essayer de r√©pondre.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504712/index.html">Pourquoi je n'utilise pas SharedViewModel pour les fragments?</a></li>
<li><a href="../fr504714/index.html">Go outils de mesure logiciels</a></li>
<li><a href="../fr504716/index.html">Acc√®s s√©curis√© √† une maison intelligente en l'absence d'une adresse IP publique (partie 1)</a></li>
<li><a href="../fr504718/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 417 (25 - 31 mai 2020)</a></li>
<li><a href="../fr504720/index.html">Le moteur de template le plus rapide pour PHP</a></li>
<li><a href="../fr504724/index.html">Connectionisme</a></li>
<li><a href="../fr504726/index.html">4 accords</a></li>
<li><a href="../fr504728/index.html">Sortie du port Godot Editor pour WebAssembly</a></li>
<li><a href="../fr504730/index.html">Il se peut que vous achetiez des ordures sur Amazon - et litt√©ralement</a></li>
<li><a href="../fr504732/index.html">Solarographie num√©rique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>