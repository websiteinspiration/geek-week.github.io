<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🎓 🔝 😒 PostgreSQLのインデックスのすべての機能を使用する 🐰 🤴🏿 🤵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Postgresの世界では、インデックスはデータベースリポジトリを効率的にナビゲートするために重要です（ヒープ、ヒープと呼ばれます）。Postgresはクラスタリングをサポートしていません。MVCCアーキテクチャでは、同じタプルの多くのバージョンが蓄積されます。したがって、アプリケーションをサポート...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLのインデックスのすべての機能を使用する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/453046/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/sm/1h/ajsm1hnpv2mljoxorbwxshprkog.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postgresの世界では、インデックスはデータベースリポジトリを効率的にナビゲートするために重要です（ヒープ、ヒープと呼ばれます）。</font><font style="vertical-align: inherit;">Postgresはクラスタリングをサポートしていません。MVCCアーキテクチャでは、同じタプルの多くのバージョンが蓄積されます。</font><font style="vertical-align: inherit;">したがって、アプリケーションをサポートするための効果的なインデックスを作成および維持できることが非常に重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスの使用を最適化および改善するためのヒントをいくつか紹介します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：以下に示すクエリは、変更されていない</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pagilaサンプルデータベースで機能します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カバリングインデックスの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非アクティブなユーザーのメールアドレスを取得するリクエストを確認してみましょう。</font><font style="vertical-align: inherit;">テーブル</font><font style="vertical-align: inherit;">に</font></font><code>customer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列</font><font style="vertical-align: inherit;">があり</font></font><code>active</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リクエストは簡単です：</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># EXPLAIN SELECT email FROM customer WHERE active=0;</span><font></font>
                        QUERY PLAN<font></font>
<span class="hljs-comment">-----------------------------------------------------------</span><font></font>
 Seq Scan on customer  (cost=0.00..16.49 rows=15 width=32)<font></font>
   Filter: (active = 0)<font></font>
(2 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリでは、テーブル全体のスキャンシーケンスが呼び出されます</font></font><code>customer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">列のインデックスを作成しましょう</font></font><code>active</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_cust1 ON customer(active);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT email FROM customer WHERE active=0;</span>
                                 <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">-----------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">using</span> idx_cust1 <span class="hljs-keyword">on</span> customer  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.28</span>.<span class="hljs-number">.12</span><span class="hljs-number">.29</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">15</span> width=<span class="hljs-number">32</span>)
   <span class="hljs-keyword">Index</span> Cond: (active = <span class="hljs-number">0</span>)<font></font>
(<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは助け、それ以降のスキャンは " </font></font><code>index scan</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"に</font><font style="vertical-align: inherit;">変わりました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">つまり、Postgresは " </font></font><code>idx_cust1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font><font style="vertical-align: inherit;">インデックスをスキャンし</font><font style="vertical-align: inherit;">、テーブルのヒープの検索を続行し</font></font><code>email</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て、クエリに必要な</font><font style="vertical-align: inherit;">他の列（この場合は列</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の値を読み取り</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL 11では、インデックスのカバーが導入されました。</font><font style="vertical-align: inherit;">インデックス自体に1つ以上の追加の列を含めることができます-それらの値はインデックスデータストアに格納されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能を使用してインデックス内に電子メールの値を追加した場合、Postgresはテーブルヒープの値を検索する必要がなくなります</font></font><code>email</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これがうまくいくか見てみましょう：</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_cust2 ON customer(active) INCLUDE (email);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT email FROM customer WHERE active=0;</span>
                                    <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">----------------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Only</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">using</span> idx_cust2 <span class="hljs-keyword">on</span> customer  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.28</span>.<span class="hljs-number">.12</span><span class="hljs-number">.29</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">15</span> width=<span class="hljs-number">32</span>)
   <span class="hljs-keyword">Index</span> Cond: (active = <span class="hljs-number">0</span>)<font></font>
(<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
" </font></font><code>Index Only Scan</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"は、クエリに必要なインデックスは1つだけであることを示しています。これにより、すべてのディスクI / Oがテーブルヒープを読み取るのを回避できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、カバリングインデックスはBツリーでのみ使用できます。</font><font style="vertical-align: inherit;">ただし、この場合、エスコートの労力は高くなります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部分インデックスの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部分インデックスは、テーブル内の行のサブセットのみにインデックスを付けます。</font><font style="vertical-align: inherit;">これにより、インデックスのサイズと高速なスキャンが節約されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カリフォルニアの顧客からメールアドレスのリストを取得する必要があるとします。</font><font style="vertical-align: inherit;">リクエストは次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> c.email <span class="hljs-keyword">FROM</span> customer c
<span class="hljs-keyword">JOIN</span> address a <span class="hljs-keyword">ON</span> c.address_id = a.address_id
<span class="hljs-keyword">WHERE</span> a.district = <span class="hljs-string">'California'</span>;<font></font>
which has a query plan that involves scanning both the tables that are joined:<font></font>
pagila=<span class="hljs-comment"># EXPLAIN SELECT c.email FROM customer c</span>
pagila-<span class="hljs-comment"># JOIN address a ON c.address_id = a.address_id</span>
pagila-<span class="hljs-comment"># WHERE a.district = 'California';</span><font></font>
                              QUERY PLAN<font></font>
<span class="hljs-comment">----------------------------------------------------------------------</span><font></font>
 Hash Join  (cost=15.65..32.22 rows=9 width=32)<font></font>
   Hash Cond: (c.address_id = a.address_id)<font></font>
   -&gt;  Seq Scan on customer c  (cost=0.00..14.99 rows=599 width=34)<font></font>
   -&gt;  Hash  (cost=15.54..15.54 rows=9 width=4)<font></font>
         -&gt;  Seq Scan on address a  (cost=0.00..15.54 rows=9 width=4)<font></font>
               Filter: (district = 'California'::text)<font></font>
(6 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のインデックスが与えるもの：</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_address1 ON address(district);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT c.email FROM customer c</span>
pagila-<span class="hljs-comment"># JOIN address a ON c.address_id = a.address_id</span>
pagila-<span class="hljs-comment"># WHERE a.district = 'California';</span>
                                      <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">---------------------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Hash</span> <span class="hljs-keyword">Join</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">12.98</span>.<span class="hljs-number">.29</span><span class="hljs-number">.55</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">32</span>)
   <span class="hljs-keyword">Hash</span> Cond: (c.address_id = a.address_id)<font></font>
   -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> customer c  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.14</span><span class="hljs-number">.99</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">599</span> width=<span class="hljs-number">34</span>)<font></font>
   -&gt;  <span class="hljs-keyword">Hash</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">12.87</span>.<span class="hljs-number">.12</span><span class="hljs-number">.87</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">4</span>)<font></font>
         -&gt;  <span class="hljs-keyword">Bitmap</span> <span class="hljs-keyword">Heap</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> address a  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">4.34</span>.<span class="hljs-number">.12</span><span class="hljs-number">.87</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">4</span>)<font></font>
               Recheck Cond: (district = <span class="hljs-string">'California'</span>::<span class="hljs-built_in">text</span>)<font></font>
               -&gt;  <span class="hljs-keyword">Bitmap</span> <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> idx_address1  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.4</span><span class="hljs-number">.34</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">0</span>)
                     <span class="hljs-keyword">Index</span> Cond: (district = <span class="hljs-string">'California'</span>::<span class="hljs-built_in">text</span>)<font></font>
(<span class="hljs-number">8</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキャン</font></font><code>address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はインデックス</font><font style="vertical-align: inherit;">スキャン</font><font style="vertical-align: inherit;">に置き換えられ</font></font><code>idx_address1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ヒープがスキャンされました</font></font><code>address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは頻繁なクエリであり、最適化する必要があるため、disstrictが住所である行のみにインデックスを付ける部分インデックスを使用できます</font></font><code>‘California’</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_address2 ON address(address_id) WHERE district='California';</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT c.email FROM customer c</span>
pagila-<span class="hljs-comment"># JOIN address a ON c.address_id = a.address_id</span>
pagila-<span class="hljs-comment"># WHERE a.district = 'California';</span>
                                           <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">------------------------------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Hash</span> <span class="hljs-keyword">Join</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">12.38</span>.<span class="hljs-number">.28</span><span class="hljs-number">.96</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">32</span>)
   <span class="hljs-keyword">Hash</span> Cond: (c.address_id = a.address_id)<font></font>
   -&gt;  Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> customer c  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.14</span><span class="hljs-number">.99</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">599</span> width=<span class="hljs-number">34</span>)<font></font>
   -&gt;  <span class="hljs-keyword">Hash</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">12.27</span>.<span class="hljs-number">.12</span><span class="hljs-number">.27</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">4</span>)<font></font>
         -&gt;  <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Only</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">using</span> idx_address2 <span class="hljs-keyword">on</span> address a  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.14</span>.<span class="hljs-number">.12</span><span class="hljs-number">.27</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">9</span> width=<span class="hljs-number">4</span>)<font></font>
(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、クエリは読み取りのみを</font></font><code>idx_address2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行い、テーブルには触れません</font></font><code>address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数値インデックスの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスを作成する必要がある一部の列には、スカラーデータ型が含まれていない場合があります。列のタイプが似ている</font></font><code>jsonb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>arrays</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>tsvector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のまたは複数の値を含みます。そのような列にインデックスを付ける必要がある場合は、通常、これらの列のすべての個々の値を検索する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
失敗したテイクからのカットを含むすべてのフィルムの名前を見つけてみましょう。テーブルに</font></font><code>film</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、というテキスト列があります</font></font><code>special_features</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。映画にこの「特別なプロパティ」がある場合、列にはテキスト配列の形式の要素が含まれます</font></font><code>Behind The Scenes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このようなすべての映画を検索するには</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列の値の</font><font style="vertical-align: inherit;">「シーンの背後」にあるすべての行を選択する必要があり</font><font style="vertical-align: inherit;">ます</font></font><code>special_features</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> title <span class="hljs-keyword">FROM</span> film <span class="hljs-keyword">WHERE</span> special_features @&gt; <span class="hljs-string">'{"Behind The Scenes"}'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
包含演算子</font></font><code>@&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、右側が左側のサブセットであるかどうかをチェックします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストプラン：</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># EXPLAIN SELECT title FROM film</span>
pagila-<span class="hljs-comment"># WHERE special_features @&gt; '{"Behind The Scenes"}';</span><font></font>
                           QUERY PLAN<font></font>
<span class="hljs-comment">-----------------------------------------------------------------</span><font></font>
 Seq Scan on film  (cost=0.00..67.50 rows=5 width=15)<font></font>
   Filter: (special_features @&gt; '{"Behind The Scenes"}'::text[])<font></font>
(2 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、67のコストでフルヒープスキャンを要求します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のBツリーインデックスが役立つかどうかを見てみましょう。</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_film1 ON film(special_features);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT title FROM film</span>
pagila-<span class="hljs-comment"># WHERE special_features @&gt; '{"Behind The Scenes"}';</span>
                           <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">-----------------------------------------------------------------</span>
 Seq <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> film  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.67</span><span class="hljs-number">.50</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5</span> width=<span class="hljs-number">15</span>)<font></font>
   Filter: (special_features @&gt; <span class="hljs-string">'{"Behind The Scenes"}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
(<span class="hljs-number">2</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスも考慮されていませんでした。</font><font style="vertical-align: inherit;">Bツリーインデックスは、インデックス付きの値に個々の要素が存在することを認識しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GINインデックスが必要です。</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX idx_film2 ON film USING GIN(special_features);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>
pagila=<span class="hljs-comment"># EXPLAIN SELECT title FROM film</span>
pagila-<span class="hljs-comment"># WHERE special_features @&gt; '{"Behind The Scenes"}';</span>
                                <span class="hljs-keyword">QUERY</span> PLAN
<span class="hljs-comment">---------------------------------------------------------------------------</span>
 <span class="hljs-keyword">Bitmap</span> <span class="hljs-keyword">Heap</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> film  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">8.04</span>.<span class="hljs-number">.23</span><span class="hljs-number">.58</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5</span> width=<span class="hljs-number">15</span>)<font></font>
   Recheck Cond: (special_features @&gt; <span class="hljs-string">'{"Behind The Scenes"}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
   -&gt;  <span class="hljs-keyword">Bitmap</span> <span class="hljs-keyword">Index</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> idx_film2  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.8</span><span class="hljs-number">.04</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">5</span> width=<span class="hljs-number">0</span>)
         <span class="hljs-keyword">Index</span> Cond: (special_features @&gt; <span class="hljs-string">'{"Behind The Scenes"}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
(<span class="hljs-number">4</span> <span class="hljs-keyword">rows</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GINインデックスは、個々の値とインデックス付きの複合値の比較をサポートしているため、クエリプランのコストが半分以上削減されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重複するインデックスを取り除く</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスは時間の経過とともに蓄積され、新しいインデックスには以前のものと同じ定義が含まれる場合があります。</font><font style="vertical-align: inherit;">カタログビューを使用して、人間が読めるインデックスのSQL定義を取得できます</font></font><code>pg_indexes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同じ定義を簡単に見つけることもできます。</font></font><br>
<br>
<pre><code class="sql hljs"> <span class="hljs-keyword">SELECT</span> array_agg(indexname) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">indexes</span>, <span class="hljs-keyword">replace</span>(indexdef, indexname, <span class="hljs-string">''</span>) <span class="hljs-keyword">AS</span> defn
    <span class="hljs-keyword">FROM</span> pg_indexes
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> defn
  <span class="hljs-keyword">HAVING</span> <span class="hljs-keyword">count</span>(*) &gt; <span class="hljs-number">1</span>;<font></font>
And here’s the result when run on the stock pagila database:<font></font>
pagila=<span class="hljs-comment">#   SELECT array_agg(indexname) AS indexes, replace(indexdef, indexname, '') AS defn</span>
pagila-<span class="hljs-comment">#     FROM pg_indexes</span>
pagila-<span class="hljs-comment"># GROUP BY defn</span>
pagila-<span class="hljs-comment">#   HAVING count(*) &gt; 1;</span><font></font>
                                indexes                                 |                                defn<font></font>
<span class="hljs-comment">------------------------------------------------------------------------+------------------------------------------------------------------</span>
 {payment_p2017_01_customer_id_idx,idx_fk_payment_p2017_01_customer_id} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_01 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
 {payment_p2017_02_customer_id_idx,idx_fk_payment_p2017_02_customer_id} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_02 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
 {payment_p2017_03_customer_id_idx,idx_fk_payment_p2017_03_customer_id} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_03 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
 {idx_fk_payment_p2017_04_customer_id,payment_p2017_04_customer_id_idx} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_04 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
 {payment_p2017_05_customer_id_idx,idx_fk_payment_p2017_05_customer_id} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_05 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
 {idx_fk_payment_p2017_06_customer_id,payment_p2017_06_customer_id_idx} | <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span>  <span class="hljs-keyword">ON</span> public.payment_p2017_06 <span class="hljs-keyword">USING</span> btree (customer_id<font></font>
(<span class="hljs-number">6</span> <span class="hljs-keyword">rows</span>)
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スーパーセットインデックス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くのインデックスを蓄積する場合があります。そのうちの1つは、他のインデックスにインデックスを付ける列のサブセットにインデックスを付けます。</font><font style="vertical-align: inherit;">これは望ましい場合と望ましくない場合があります。スーパーセットはインデックスのみによるスキャンにつながる可能性がありますが、これはスペースを取りすぎたり、このスーパーセットの最適化を目的としたクエリが使用されなくなったりする可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなインデックスの定義を自動化する必要がある場合</font><font style="vertical-align: inherit;">は、テーブルの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_index</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から</font><font style="vertical-align: inherit;">始めることができ</font><font style="vertical-align: inherit;">ます</font></font><code>pg_catalog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未使用のインデックス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースを使用するアプリケーションが開発されるにつれて、使用するクエリも開発されます。</font><font style="vertical-align: inherit;">以前に追加されたインデックスは、どのクエリにも適用されなくなる可能性があります。</font><font style="vertical-align: inherit;">インデックスがスキャンされるたびに、統計マネージャーによってマークが付けられ、システムカタログ</font></font><code>pg_stat_user_indexes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビュー</font></font><code>idx_scan</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、累積カウンターである</font><font style="vertical-align: inherit;">値を確認できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一定期間（たとえば、1か月）にわたってこの値を追跡すると、どのインデックスが使用されておらず、削除できるかがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、スキーマ内のすべてのインデックスの現在のスキャンカウンターを取得するリクエスト</font></font><code>‘public’</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> relname, indexrelname, idx_scan
<span class="hljs-keyword">FROM</span>   pg_catalog.pg_stat_user_indexes
<span class="hljs-keyword">WHERE</span>  schemaname = <span class="hljs-string">'public'</span>;
<span class="hljs-keyword">with</span> <span class="hljs-keyword">output</span> <span class="hljs-keyword">like</span> this:<font></font>
pagila=<span class="hljs-comment"># SELECT relname, indexrelname, idx_scan</span>
pagila-<span class="hljs-comment"># FROM   pg_catalog.pg_stat_user_indexes</span>
pagila-<span class="hljs-comment"># WHERE  schemaname = 'public'</span>
pagila-<span class="hljs-comment"># LIMIT  10;</span><font></font>
    relname    |    indexrelname    | idx_scan<font></font>
<span class="hljs-comment">---------------+--------------------+----------</span>
 customer      | customer_pkey      |    <span class="hljs-number">32093</span>
 actor         | actor_pkey         |     <span class="hljs-number">5462</span>
 address       | address_pkey       |      <span class="hljs-number">660</span>
 <span class="hljs-keyword">category</span>      | category_pkey      |     <span class="hljs-number">1000</span>
 city          | city_pkey          |      <span class="hljs-number">609</span>
 country       | country_pkey       |      <span class="hljs-number">604</span>
 film_actor    | film_actor_pkey    |        <span class="hljs-number">0</span>
 film_category | film_category_pkey |        <span class="hljs-number">0</span>
 film          | film_pkey          |    <span class="hljs-number">11043</span>
 inventory     | inventory_pkey     |    <span class="hljs-number">16048</span>
(<span class="hljs-number">10</span> <span class="hljs-keyword">rows</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より少ないロックでインデックスを再作成します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、インデックスのサイズが大きくなっている場合など、インデックスを再作成する必要があることが多く、再作成するとスキャンの速度が向上します。</font><font style="vertical-align: inherit;">また、インデックスが破損している可能性があります。</font><font style="vertical-align: inherit;">インデックスパラメータを変更すると、インデックスの再作成が必要になる場合もあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列インデックス作成を有効にする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL 11では、Bツリーインデックスの作成は競争力があります。</font><font style="vertical-align: inherit;">作成プロセスを高速化するために、いくつかの並列ワーカーを使用できます。</font><font style="vertical-align: inherit;">ただし、以下の構成パラメーターが正しく設定されていることを確認してください。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> max_parallel_workers = <span class="hljs-number">32</span>;
<span class="hljs-keyword">SET</span> max_parallel_maintenance_workers = <span class="hljs-number">16</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルト値は小さすぎます。</font><font style="vertical-align: inherit;">理想的には、これらの数はプロセッサコアの数とともに増加する必要があります。</font><font style="vertical-align: inherit;">詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックグラウンドインデックスの作成</font></font></h3><br><font style="vertical-align: inherit;"></font><code>CONCURRENTLY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">
パラメータを使用して、バックグラウンドでインデックスを作成できます</font></font><code>CREATE INDEX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs">pagila=<span class="hljs-comment"># CREATE INDEX CONCURRENTLY idx_address1 ON address(district);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このインデックス作成手順は、通常の手順とは異なり、テーブルロックを必要としないため、書き込み操作がブロックされません。</font><font style="vertical-align: inherit;">一方で、より多くの時間とリソースを消費します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postgresは、インデックスを作成するための多くの柔軟なオプションと特定のケースを解決する方法を提供し、アプリケーションが急増した場合にデータベースを管理する方法を提供します。</font><font style="vertical-align: inherit;">これらのヒントが、クエリを迅速に作成し、データベースを拡張できるようになることを願っています。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453030/index.html">3Dプリンターを使用して、1914年のグランプリに参加した車を救うことができました</a></li>
<li><a href="../ja453032/index.html">私たちは大人の車を再生します-2：カーシェアリングのテレマティクスサプライヤーになり、世界中に5つのオフィスを開設した方法</a></li>
<li><a href="../ja453034/index.html">父親は3DプリンターとX-Boxを使用して息子の生体義肢を作成しました</a></li>
<li><a href="../ja453038/index.html">ソフトウェア無線-それはどのように機能しますか？パート4</a></li>
<li><a href="../ja453044/index.html">複雑に構造化されたドキュメント（+ビデオ）への待望のステップ</a></li>
<li><a href="../ja453056/index.html">モバイルゲームのプロトタイピング、どこから始め、どのように行うか。パート1</a></li>
<li><a href="../ja453058/index.html">AIは1つのフレームからビデオを作成することを学びました。古い絵を生き生きとさせることができます</a></li>
<li><a href="../ja453064/index.html">善への害：ヒトの脳癌との闘いにおけるランプリーの免疫系</a></li>
<li><a href="../ja453066/index.html">文字体裁UI-ユーザーインターフェイスを開発する新しい方法</a></li>
<li><a href="../ja453068/index.html">主観</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>