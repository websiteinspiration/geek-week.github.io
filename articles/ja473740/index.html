<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¡ ğŸ’‡ğŸ¼ ğŸ Linuxç”¨ã®CreateRemoteThread ğŸš¦ ğŸ‘› â°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WinAPIã«ã¯ã€åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“ã§æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã§ãã‚‹CreateRemoteThreadé–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚æ‚ªæ„ã®ã‚ã‚‹ç›®çš„ï¼ˆã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ãƒˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç›—é›£ãªã©ï¼‰ã¨ã€å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚°ã‚’ãã®å ´ã§ä¿®æ­£ã™ã‚‹ãŸã‚ã€ã¾ãŸã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ã„ãªã„å ´æ‰€ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ä¸¡æ–¹ã§...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linuxç”¨ã®CreateRemoteThread</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473740/"><p><img src="https://habrastorage.org/webt/qu/fi/43/qufi43ym9g9-ptbmm43ajv-e_-4.jpeg" width="300" align="right" alt="ãƒŸãƒ„ãƒã¯æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinAPIã«ã¯ã€</font><font style="vertical-align: inherit;">åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“ã§æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹ã§ãã‚‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–¢æ•°</font><font style="vertical-align: inherit;">ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ‚ªæ„ã®ã‚ã‚‹ç›®çš„ï¼ˆã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ãƒˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç›—é›£ãªã©ï¼‰ã¨ã€å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒã‚°ã‚’ãã®å ´ã§ä¿®æ­£ã™ã‚‹ãŸã‚ã€ã¾ãŸã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¦ã„ãªã„å ´æ‰€ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ä¸¡æ–¹ã§ã€ã•ã¾ã–ã¾ãªDLLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ã§ãã¾ã™ã€‚æä¾›ã•ã‚Œã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€èˆ¬ã«ã€ã“ã®é–¢æ•°ã«ã¯ç–‘ã‚ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒã‚ã‚‹ãŸã‚ã€Linuxã«CreateRemoteThreadã®æ—¢æˆã®é¡ä¼¼ç‰©ãŒãªã„ã“ã¨ã¯é©šãã«å€¤ã—ã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ã©ã†ã‚„ã£ã¦å®Ÿè£…ã§ãã‚‹ã®ã‹ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãƒˆãƒ”ãƒƒã‚¯ã‚’å­¦ã¶ã“ã¨ã¯è‰¯ã„å†’é™ºã«ãªã‚Šã¾ã—ãŸã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ELFä»•æ§˜ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€x86_64ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨Linuxã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®çŸ¥è­˜ã‚’æ´»ç”¨ã—ã¦ã€ã™ã§ã«å®Ÿè¡Œä¸­ã®ä½œæ¥­ãƒ—ãƒ­ã‚»ã‚¹ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œã§ãã‚‹ç‹¬è‡ªã®å°ã•ãªãƒ‡ãƒãƒƒã‚¬ãƒ¼ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã—ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ã‚­ã‚¹ãƒˆã‚’ç†è§£ã™ã‚‹ã«ã¯ã€Linuxã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«é–¢ã™ã‚‹åŸºæœ¬çš„ãªçŸ¥è­˜ãŒå¿…è¦ã§ã™ã€‚Cè¨€èªã€ãã®ä¸Šã§ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä½œæˆã¨ãƒ‡ãƒãƒƒã‚°ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã§ã®ãƒã‚·ãƒ³ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒ¢ãƒªã®å½¹å‰²ã®ç†è§£ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®æ¦‚å¿µã€ãƒ¡ã‚¤ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®çŸ¥è­˜ã€ãŠã‚ˆã³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€èƒ½åŠ›ã§ã™ã€‚</font></font></p><a name="habracut"></a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸»ãªã‚¢ã‚¤ãƒ‡ã‚¢</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚±ãƒƒãƒ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒ†ãƒƒãƒ—1.ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®æ¥ç¶š</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 2.    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 3.  ELF- </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 4.  -</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 5.   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></li>
</ul><br>
<p>     Â«Â»     Gnome Control Center:</p><br>
<p><img src="https://habrastorage.org/webt/0v/gu/we/0vguwedoumnnjh89zw5jtpaaltw.gif" alt="Gnome Control Centerã§ã®å°„å‡ºãƒ‡ãƒ¢"></p><br>
<h2 id="osnovnye-idei"> </h2><br>
<p>             ,      : LD_PRELOAD.          .      <em>-</em>,    .</p><br>
<p> LD_PRELOAD         ,   .     ,    . ,       ,   malloc()  free(),       .</p><br>
<p> , LD_PRELOAD      .          .          dlopen(), , ,        .</p><br>
<blockquote><strong>   </strong><br>
<br>
LD_PRELOAD    ,   .      <code>-static</code>,        .                        ,   .<br>
<br>
         ,     - -.     ,          .</blockquote><p> ,    ,    .        :)</p><br>
<p>,      - ,    :</p><br>
<ol>
<li>    .</li>
<li>     .</li>
<li>       .</li>
<li>     .</li>
</ol><br>
<p>...</p><br>
<h3 id="poluchenie-upravleniya-v-processe">   </h3><br>
<p>        .        ,    ,   JIT-.     .</p><br>
<p>   â€”   -   ,   .    :  ,      .  ,   ,      .</p><br>
<p>   ,    : <em>  </em>.       ,  ,    .   â€”   .</p><br>
<p> Linux      <strong>ptrace()</strong>.     ,   ,    . ptrace()      ,         .</p><br>
<h3 id="zagruzka-koda-v-pamyat-processa">    </h3><br>
<p>       (<em>-</em>)    ,    .           .  WinAPI      WriteProcessMemory. Linux      UNIX way:        <strong>/proc/$pid/mem</strong>,    .  -        -.</p><br>
<h3 id="podgotovka-koda-k-ispolneniyu">   </h3><br>
<p>     .     <em>  </em>.          ,         ,           Â«Â» .</p><br>
<p>    â€”   -.       -   ,  -,  ,   . ,      ,               .    ?</p><br>
<p>         ,       (    <em>- </em>).      .</p><br>
<p>          <em></em>,  <em></em>. ,       .      ,     <em> </em>,         . ,      .</p><br>
<p> ,       :</p><br>
<ul>
<li>   ,      </li>
<li>  -    </li>
<li>    </li>
<li>        </li>
</ul><br>
<p>  ,    ,      .     ,    ,   ,   .</p><br>
<h3 id="peredacha-upravleniya-kodu">  </h3><br>
<p>ptrace()    ,             :     %rip    â€”  ! ,      .    ,    -         - ,      .</p><br>
<h2 id="eskiz-resheniya"> </h2><br>
<p>,          :</p><br>
<ol>
<li>     .</li>
<li>    :<br>
<ul>
<li>libdl â€”    </li>
<li>libpthread â€”    </li>
</ul></li>
<li>    :<br>
<ul>
<li>libdl: dlopen(), dlsym()</li>
<li>libpthread: pthread_create(), pthread_detach()</li>
</ul></li>
<li><p>     -:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">void</span> *payload = dlopen(<span class="hljs-string">"/path/to/payload.so"</span>, RTLD_LAZY);
    <span class="hljs-keyword">void</span> *entry = dlsym(payload, <span class="hljs-string">"entry_point"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">pthread_t</span> thread;<font></font>
    pthread_create(&amp;thread, <span class="hljs-literal">NULL</span>, entry, <span class="hljs-literal">NULL</span>);<font></font>
    pthread_detach(thread);<font></font>
}</code></pre><br>
</li>
<li> - .</li>
</ol><br>
<p>       :             ,   .</p><br>
<h3 id="ogranicheniya"></h3><br>
<p>     :</p><br>
<ul>
<li>         .</li>
<li>   libdl (    ).</li>
<li>   libpthread (  ).</li>
<li>  ,  .</li>
</ul><br>
<p> ,       - ,      x86_64. ( 32- x86   .)</p><br>
<p>  ,          . ,              .</p><br>
<h3 id="otstuplenie-ob-ispolzovanii-libdl-i-libpthread">:   libdl  libpthread</h3><br>
<p> -   :    libdl,   glibc     __libc_dlopen_mode()  __libc_dlsym(),  libdl â€”     ? ,   libpthread,           clone()?</p><br>
<p>        ,   :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://github.com/gaffe23/linux-inject</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://github.com/TsarFox/hypodermic</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://hick.org/code/skape/papers/needle.txt</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://github.com/ice799/injectso64</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://www.ouah.org/subversiveld.pdf</a></li>
</ul><br>
<p>      :</p><br>
<ul>
<li>Learning Linux Binary Analysis</li>
<li>The Art of Memory Forensics</li>
</ul><br>
<p>  ? ,   ,      ,   ,  90% ,   20   ,     80% .  ,      .</p><br>
<p>, libdl   <em></em>      glibc.      ,        .    ,  ,   libdl   (,         glibc).</p><br>
<blockquote><strong>  dlopen()  glibc?</strong><br>
<br>
    .  :  .<br>
<br>
  <em>name service switch</em> (NSS) â€”    glibc,    :  , , ,  ,  . .        getaddrinfo()   IP-     getpwuid()         .<br>
<br>
 NSS      . ,    glibc       .  ,     getaddrinfo()    ,   Â«Â» :<br>
<pre><font></font>
/tmp/build/socket.o: In function `Socket::bind':<font></font>
socket.o:(.text+0x374): warning: Using 'getaddrinfo' in statically linked<font></font>
applications requires at runtime the shared libraries from glibc version<font></font>
used for linking<font></font>
</pre><br>
</blockquote><p>  ,   â€”        ,     ,   <em>thread-local storage</em> (TLS).         ,       .    clone()    ,     Â«Hello world!Â»,         ,     TLS    ,     .</p><br>
<p>  ,    â€”   .  ,       ,     ? ,  .     -    ,        .    ,    libpthread,       ,         (  ,   ).</p><br>
<h2 id="shag-1-podklyuchenie-k-processu"> 1.   </h2><br>
<p>         ,   â€”    .       <em>ptrace</em>().</p><br>
<h3 id="pervyy-kontakt-s-ptrace">   ptrace()</h3><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   ptrace()</a>      :</p><br>
<pre>  Attaching and detaching<font></font>
       A thread can be attached to the tracer using the call<font></font>
<font></font>
           ptrace(PTRACE_ATTACH, pid, 0, 0);<font></font>
<font></font>
       or<font></font>
<font></font>
           ptrace(PTRACE_SEIZE, pid, 0, PTRACE_O_flags);<font></font>
<font></font>
       PTRACE_ATTACH sends SIGSTOP to this thread.  If the tracer wants this<font></font>
       SIGSTOP to have  no effect,  it needs  to suppress it.   Note that if<font></font>
       other signals are concurrently sent to this thread during attach, the<font></font>
       tracer may see the tracee enter signal-delivery-stop  with other sigâ€<font></font>
       nal(s) first!   The usual practice is to reinject these signals until<font></font>
       SIGSTOP  is seen,  then suppress  SIGSTOP injection.  The design  bug<font></font>
       here is that a ptrace attach and a concurrently delivered SIGSTOP may<font></font>
       race and the concurrent SIGSTOP may be lost.<font></font>
</pre><br>
<p>    â€”   PTRACE_ATTACH:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ptrace_attach</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-comment">/*     */</span>
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_ATTACH, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-comment">/*    */</span>
        <span class="hljs-keyword">if</span> (wait_for_process_stop(pid, SIGSTOP) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p> ptrace()        .    ,          . ptrace()    SIGSTOP,        .</p><br>
<p>      <em>waitpid</em>().        . -,      ,     SIGSTOP.        . -,      -  .          (  PTRACE_CONT),   â€”     SIGSTOP:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">wait_for_process_stop</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">int</span> expected_signal)</span>
</span>{
        <span class="hljs-keyword">for</span> (;;) {
                <span class="hljs-keyword">int</span> status = <span class="hljs-number">0</span>;<font></font>
<font></font>
                <span class="hljs-comment">/* ,    -  */</span>
                <span class="hljs-keyword">if</span> (waitpid(pid, &amp;status, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
                <span class="hljs-comment">/*      â€”   */</span>
                <span class="hljs-keyword">if</span> (WIFSIGNALED(status) || WIFEXITED(status))
                        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
                <span class="hljs-comment">/*   ,     */</span>
                <span class="hljs-keyword">if</span> (WIFSTOPPED(status)) {
                        <span class="hljs-comment">/*
                         *  WSTOPSIG()   ,
                         *   ptrace()  
                         *     .
                         */</span>
                        <span class="hljs-keyword">int</span> stop_signal = status &gt;&gt; <span class="hljs-number">8</span>;<font></font>
<font></font>
                        <span class="hljs-comment">/*    ,    */</span>
                        <span class="hljs-keyword">if</span> (stop_signal == expected_signal)
                                <span class="hljs-keyword">break</span>;<font></font>
<font></font>
                        <span class="hljs-comment">/*        */</span>
                        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid, <span class="hljs-number">0</span>, stop_signal) &lt; <span class="hljs-number">0</span>)
                                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
                        <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-comment">/*   â€”   */</span>
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<h3 id="otklyuchenie-ot-processa">  </h3><br>
<p>    :   PTRACE_DETACH:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ptrace_detach</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_DETACH, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p> ,      .    ,       ,     ,     ptrace(). ,           SIGSTOP   ptrace(),        SIGCONT  PTRACE_DETACH.        .</p><br>
<h3 id="nastroyka-ptrace_scope"> ptrace_scope</h3><br>
<p>      .        ,        ! ,    â€”    ,    .           .</p><br>
<p>  ,             .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  <strong>Yama</strong></a>,    /proc/sys/kernel/yama/ptrace_scope.     :</p><br>
<ul>
<li>0 â€”     ,   </li>
<li>1 â€”   ,    ,  </li>
<li>2 â€”      root   </li>
<li>3 â€”    ,      </li>
</ul><br>
<p>,        ,    ,            ,  0    ptrace_scope (   ):</p><br>
<pre><code class="plaintext hljs">$ sudo sh -c 'echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope'</code></pre><br>
<p>      :</p><br>
<pre><code class="plaintext hljs">$ sudo ./inject-thread ...</code></pre><br>
<h3 id="rezultaty-pervogo-shaga">  </h3><br>
<p> ,                 .</p><br>
<p>       ,        :</p><br>
<pre><code class="plaintext hljs">$ sudo ./inject-thread --target $(pgrep docker)<font></font>
<font></font>
$ cat /proc/$(pgrep docker)/status | head<font></font>
Name:   docker<font></font>
State:  t (tracing stop)                &lt;---   <font></font>
Tgid:   31330<font></font>
Ngid:   0<font></font>
Pid:    31330<font></font>
PPid:   1<font></font>
TracerPid:      2789                    &lt;--- PID  <font></font>
Uid:    0       0       0       0<font></font>
Gid:    0       0       0       0<font></font>
FDSize: 64<font></font>
<font></font>
$ ps a | grep [2]789<font></font>
 2789 pts/5    S+     0:00 ./inject-thread --target 31330</code></pre><br>
<h2 id="shag-2-poisk-bibliotek-v-pamyati"> 2.    </h2><br>
<p>   :           .  - ,      ?</p><br>
<h3 id="fayl-procpidmaps"> /proc/$pid/maps</h3><br>
<p>     ,      ,        . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,   /proc     .     ,  <em> </em> :</p><br>
<pre>$ cat /proc/self/maps<font></font>
00400000-0040c000 r-xp 00000000 fe:01 1044592                            /bin/cat<font></font>
0060b000-0060c000 r--p 0000b000 fe:01 1044592                            /bin/cat<font></font>
0060c000-0060d000 rw-p 0000c000 fe:01 1044592                            /bin/cat<font></font>
013d5000-013f6000 rw-p 00000000 00:00 0                                  [heap]<font></font>
7f9920bd1000-7f9920d72000 r-xp 00000000 fe:01 920019                     /lib/x86_64-linux-gnu/libc-2.19.so<font></font>
7f9920d72000-7f9920f72000 ---p 001a1000 fe:01 920019                     /lib/x86_64-linux-gnu/libc-2.19.so<font></font>
7f9920f72000-7f9920f76000 r--p 001a1000 fe:01 920019                     /lib/x86_64-linux-gnu/libc-2.19.so<font></font>
7f9920f76000-7f9920f78000 rw-p 001a5000 fe:01 920019                     /lib/x86_64-linux-gnu/libc-2.19.so<font></font>
7fc3f8381000-7fc3f8385000 rw-p 00000000 00:00 0<font></font>
7fc3f8385000-7fc3f83a6000 r-xp 00000000 fe:01 920012                     /lib/x86_64-linux-gnu/ld-2.19.so<font></font>
7fc3f83ec000-7fc3f840e000 rw-p 00000000 00:00 0<font></font>
7fc3f840e000-7fc3f8597000 r--p 00000000 fe:01 657286                     /usr/lib/locale/locale-archive<font></font>
7fc3f8597000-7fc3f859a000 rw-p 00000000 00:00 0<font></font>
7fc3f85a3000-7fc3f85a5000 rw-p 00000000 00:00 0<font></font>
7fc3f85a5000-7fc3f85a6000 r--p 00020000 fe:01 920012                     /lib/x86_64-linux-gnu/ld-2.19.so<font></font>
7fc3f85a6000-7fc3f85a7000 rw-p 00021000 fe:01 920012                     /lib/x86_64-linux-gnu/ld-2.19.so<font></font>
7fc3f85a7000-7fc3f85a8000 rw-p 00000000 00:00 0<font></font>
7ffdb6f0e000-7ffdb6f2f000 rw-p 00000000 00:00 0                          [stack]<font></font>
7ffdb6f7f000-7ffdb6f81000 r-xp 00000000 00:00 0                          [vdso]<font></font>
7ffdb6f81000-7ffdb6f83000 r--p 00000000 00:00 0                          [vvar]<font></font>
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]<font></font>
</pre><br>
<p>           ,      ,    :</p><br>
<ul>
<li> ,  </li>
<li>   <br>
<ul>
<li><code>r/-</code>: </li>
<li><code>w/-</code>: </li>
<li><code>x/-</code>: </li>
<li><code>p/s</code>:     </li>
</ul></li>
<li>   ( )</li>
<li> ,    </li>
<li> inode   ( )</li>
<li>    ( )</li>
</ul><br>
<p>     :     ,             .     ,            ( <em>copy-on-write</em>,  <code>p</code> â€” private),      ( <code>s</code> â€” shared).</p><br>
<p>   <em></em> â€”      .        ,   .   , ,  Â«Â»  :   .        ,       ( <em>shared memory</em>).</p><br>
<p> ,      ,   [vdso]  [vsyscall].       .</p><br>
<p>  ,      .              ,     ,    .                 scanf():</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">read_proc_line</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *line, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *library,
                struct memory_region *region)</span>
</span>{
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vaddr_low = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vaddr_high = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">char</span> read = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">char</span> write = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">char</span> execute = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">int</span> path_offset = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-comment">/*    /proc/$pid/maps */</span>
        <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"%lx-%lx %c%c%c%*c %*lx %*x:%*x %*d %n"</span>,<font></font>
                &amp;vaddr_low, &amp;vaddr_high, &amp;read, &amp;write, &amp;execute,<font></font>
                &amp;path_offset);<font></font>
<font></font>
        <span class="hljs-comment">/* ,       */</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strstr</span>(line + path_offset, library))
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
<font></font>
        <span class="hljs-comment">/*           */</span>
        <span class="hljs-keyword">if</span> (region) {<font></font>
                region-&gt;vaddr_low = vaddr_low;<font></font>
                region-&gt;vaddr_high = vaddr_high;<font></font>
                region-&gt;readable = (read == <span class="hljs-string">'r'</span>);<font></font>
                region-&gt;writeable = (write == <span class="hljs-string">'w'</span>);<font></font>
                region-&gt;executable = (execute == <span class="hljs-string">'x'</span>);<font></font>
                region-&gt;content = <span class="hljs-literal">NULL</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}</code></pre><br>
<h3 id="tayna-tretey-planety">  </h3><br>
<p>     ,  libc-2.19.so,     :</p><br>
<p><img src="https://habrastorage.org/webt/vf/lw/4m/vflw4m5jy3pwtbcxu0foudxnh3o.png" alt="libc-2.19.soã®ç©´"></p><br>
<p>       2   -    ?  51?   ?  ?</p><br>
<p>,    ,          .</p><br>
<p> ,     <em></em>   ,         .  <em> </em>         ,    ,   ,           (, ,        ).</p><br>
<p>     ,  <em></em> (  4  ).    ,            .</p><br>
<p> ,           .       â€”    â€”      .           2    â€”   ,        ( x86_64    4 , 2 , 1 ).                  .</p><br>
<h3 id="rezultaty-vtorogo-shaga">  </h3><br>
<p>    ,          :</p><br>
<ul>
<li> libdl: dlopen()  dlsym()</li>
<li> libpthread: pthread_create()  pthread_detach()</li>
</ul><br>
<p>   ,       ,   .      Linux       (<em>address space layout randomization</em>, ASLR).        (- ,     ),             â€”    - .</p><br>
<p>      ,           ,      ,     /proc/$pid/maps.     ,          .</p><br>
<h2 id="shag-3-razbor-elf-obrazov-bibliotek"> 3.  ELF- </h2><br>
<p>,      ,        ,   .</p><br>
<p>  :</p><br>
<pre><code class="plaintext hljs">$ nm -D /lib/x86_64-linux-gnu/libdl-2.19.so | grep dlopen<font></font>
0000000000001090 T dlopen</code></pre><br>
<p> <em>nm</em>             .                .</p><br>
<p>  -  ,      nm     ,        .  ,      dlsym().</p><br>
<h3 id="chtenie-pamyati-celevogo-processa">   </h3><br>
<p>  â€”    ELF-,    .        procfs.    UNIX way,         <strong>/proc/$pid/mem</strong>,    â€”      (     /proc/$pid/maps).</p><br>
<p>  Linux           mmap(),         (    ,   ).            :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">map_region</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, struct memory_region *region)</span>
</span>{
        <span class="hljs-keyword">size_t</span> length = region-&gt;vaddr_high - region-&gt;vaddr_low;
        <span class="hljs-keyword">off_t</span> offset = region-&gt;vaddr_low;<font></font>
<font></font>
        <span class="hljs-keyword">char</span> path[<span class="hljs-number">32</span>] = {<span class="hljs-number">0</span>};
        <span class="hljs-built_in">snprintf</span>(path, <span class="hljs-keyword">sizeof</span>(path), <span class="hljs-string">"/proc/%d/mem"</span>, pid);<font></font>
<font></font>
        <span class="hljs-comment">/*     */</span>
        <span class="hljs-keyword">int</span> fd = open(path, O_RDONLY);
        <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">goto</span> error;<font></font>
<font></font>
        <span class="hljs-comment">/*      */</span>
        <span class="hljs-keyword">void</span> *buffer = <span class="hljs-built_in">malloc</span>(length);
        <span class="hljs-keyword">if</span> (!buffer)
                <span class="hljs-keyword">goto</span> error_close_file;<font></font>
<font></font>
        <span class="hljs-comment">/*   */</span>
        <span class="hljs-keyword">if</span> (read_region(fd, offset, buffer, length) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">goto</span> error_free_buffer;<font></font>
<font></font>
        region-&gt;content = buffer;<font></font>
<font></font>
        close(fd);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
<font></font>
error_free_buffer:<font></font>
        <span class="hljs-built_in">free</span>(buffer);<font></font>
error_close_file:<font></font>
        close(fd);<font></font>
error:<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">read_region</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> offset, <span class="hljs-keyword">void</span> *buffer, <span class="hljs-keyword">size_t</span> length)</span>
</span>{
        <span class="hljs-comment">/*      */</span>
        <span class="hljs-keyword">if</span> (lseek(fd, offset, SEEK_SET) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">size_t</span> remaining = length;
        <span class="hljs-keyword">char</span> *ptr = buffer;<font></font>
<font></font>
        <span class="hljs-comment">/*
         *     .   ,
         *      ,  .
         */</span>
        <span class="hljs-keyword">while</span> (remaining &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">ssize_t</span> count = read(fd, ptr, remaining);<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)
                        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
                remaining -= count;<font></font>
                ptr += count;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>     ELF- .    , -,       ,  -,       .</p><br>
<h3 id="dvulikiy-elf"> ELF</h3><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   ELF</a> â€”         Linux.      ,    ,      .</p><br>
<p>     ELF   .    ELF    <em></em>    .    â€”   <em></em>,        .      ,  â€”    .        ELF-.</p><br>
<p>,   libdl-2.19.so  :</p><br>
<p><img src="https://habrastorage.org/webt/at/zw/up/atzwupwipysw3kip1yx95aa-eps.png" alt="ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆlibdl-2.19.so"></p><br>
<p>(          <code>readelf --headers</code>.)</p><br>
<p>  ,    ,   (29  9).    â€”    ,           ,     .  ELF â€”    ,      .  Linux, ,    LOAD,      (     ).</p><br>
<p>  ELF-     ,         . ,       .</p><br>
<p>      ,   . Â«Â»    .     .bss,   ,      (    ).</p><br>
<p> ,   ELF     â€”  ,     .       ...</p><br>
<h3 id="gde-lezhit-tablica-simvolov">   ?</h3><br>
<p>         ()   .        ,     dlsym(),       .  -   .</p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> ELF</a> (. 2-10).   ,        <strong>.dynamic</strong>,     <strong>DYNAMIC</strong>.   .dynamic     ,  :</p><br>
<ul>
<li><strong>.dynsym</strong> â€”     ;</li>
<li><strong>.dynstr</strong> â€”     ;</li>
<li><strong>.hash</strong> â€” -,   .</li>
</ul><br>
<p>   ,     ,       ELF:</p><br>
<p><img src="https://habrastorage.org/webt/yw/y9/7d/ywy97dqzszhxz1jmoe45851oebe.png" alt="å‹•çš„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¤œç´¢"></p><br>
<p>    ELF,      (1),      (2),      (3),      (4) <del> ,   </del>.</p><br>
<h4 id="zagolovok-elf--tablica-segmentov"> ELF â†’  </h4><br>
<p>()   ELF      &lt;elf.h&gt;, ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>.   ,  ELF â€”      .    32-  64- ,      ,      ,   .          x86_64,    ELF  .</p><br>
<p> ELF-    ( <strong>Elf64_Ehdr</strong>).          (<em>program headers</em>),    <strong>e_phoff</strong>  <strong>e_phnum</strong>:</p><br>
<p><img src="https://habrastorage.org/webt/1z/al/rn/1zalrn30vwfxce_smmy4vylj55g.png" alt="ELFãƒ˜ãƒƒãƒ€ãƒ¼"></p><br>
<p>  â€”    ,   ,  ELF-   â€”     ,    ,     ,  ,    .</p><br>
<p>       e_phoff,       ,      .    e_phnum   e_phentsize  .</p><br>
<p>   (   ),        ELF â€”    64 .</p><br>
<h4 id="tablica-segmentov--segment-dynamic">  â†’  DYNAMIC</h4><br>
<p>     .   â€”      <strong>Elf64_Phdr</strong> ( 64- ELF-),   .      <strong>PT_DYNAMIC</strong>   <strong>p_type</strong>:</p><br>
<p><img src="https://habrastorage.org/webt/i0/rg/cp/i0rgcpji9bl9wbsvegzrree9zfm.png" alt="ELFã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«"></p><br>
<p>         :</p><br>
<ul>
<li><strong>p_vaddr</strong> â€”   ,    ;</li>
<li><strong>p_memsz</strong> â€”      .</li>
</ul><br>
<p>    .dynamic      0x2D88 (     ).        DYNAMIC     â€”   0x202D88.    0x210 (8448) .                .</p><br>
<h4 id="segment-dynamic--sekcii-dynsym-dynstr-hash"> DYNAMIC â†’  .dynsym, .dynstr, .hash</h4><br>
<p> .dynamic,    DYNAMIC,      .       <strong>Elf64_Dyn</strong>,   :</p><br>
<p><img src="https://habrastorage.org/webt/dd/jp/th/ddjpthosvl8irw8ekelw0bdkaug.png" alt="DYNAMICã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚°"></p><br>
<p>   8     <strong>d_val</strong>  <strong>d_ptr</strong>,   8-  <strong>d_tag</strong>,  ,    .      :</p><br>
<ul>
<li><strong>DT_HASH</strong> (4) â€”    .hash ( d_ptr)</li>
<li><strong>DT_STRTAB</strong> (5) â€”    .dynstr ( d_ptr)</li>
<li><strong>DT_SYMTAB</strong> (6) â€”    .dynsym ( d_ptr)</li>
<li><strong>DT_STRSZ</strong> (10) â€”     .dynstr ( d_val)</li>
<li><strong>DT_NULL</strong> (0) â€”    </li>
</ul><br>
<p>      .     .dynamic     :  ,   ,    ,    .</p><br>
<p>   ,   DYNAMIC   <em></em>          ,    .      ,            ,  - ,   .</p><br>
<p>   .dynamic         ,          . -,   .dynstr   ,      ?     .</p><br>
<h3 id="poisk-funkciy-v-biblioteke">   </h3><br>
<p>           .     ,    <strong>.dynsym</strong>   ,        . (  Â«Â»   .symtab,      , ,  .    .)</p><br>
<h4 id="tablica-simvolov"> </h4><br>
<p>     <strong>Elf64_Sym</strong>,        ELF â€” , , , .       <code>dlopen</code>:</p><br>
<p><img src="https://habrastorage.org/webt/pd/5_/qh/pd5_qhcculmqmjk7p6krar1czjy.png" alt="ELFæ–‡å­—ãƒ†ãƒ¼ãƒ–ãƒ«"></p><br>
<p>     :</p><br>
<ul>
<li><strong>st_name</strong> â€”  ,      </li>
<li><strong>st_info</strong> â€”     (   )</li>
<li><strong>st_value</strong> â€”    </li>
</ul><br>
<p>(  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  nm</a>   ,  dlopen()     .text,   0x1090   .)</p><br>
<p>    ,       .</p><br>
<h4 id="tablica-strok"> </h4><br>
<p>  â€”     - ,    .            (   ).        <strong>.dynstr</strong>,      libdl-2.19.so  :</p><br>
<p><img src="https://habrastorage.org/webt/mg/b9/1v/mgb91vjtwrr_kqrncnrojgg6jum.png" alt="ELFè¡Œãƒ†ãƒ¼ãƒ–ãƒ«"></p><br>
<p>,           ( Â«dlopenÂ»,   0xA5)      ,    .        .</p><br>
<h4 id="hesh-tablica">-</h4><br>
<p> <strong>.hash</strong>  <em>-</em>,       .   - â€”    â€”      ELF-,       . ,         .dynsym,       ,      .   ( )     - .</p><br>
<p> -      &lt;elf.h&gt;,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a> (. 2-19).   -   ,   :</p><br>
<p><img src="https://habrastorage.org/webt/ez/a3/ku/eza3ku71zydhqm_e3je0xbtjec8.png" alt="ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ELF"></p><br>
<p></p><br>
<ul>
<li>nbuckets â€”    buckets</li>
<li>nchains â€”    chains (  )</li>
<li>buckets â€”     </li>
<li>chains â€”     </li>
</ul><br>
<p> -  :</p><br>
<ol>
<li>  <strong>h</strong>    .</li>
<li>  <strong>i</strong>  <code>buckets[h % nbuckets]</code>,     .</li>
<li>     (     )  ,   .</li>
<li>   â€”  <code>chains[i % nchains]</code>.</li>
<li>  3â€”4           ,       .</li>
</ol><br>
<p> -,  ELF:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">uint32_t</span> <span class="hljs-title">elf_hash</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name)</span>
</span>{
        <span class="hljs-keyword">uint32_t</span> h = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">uint32_t</span> g;
        <span class="hljs-keyword">while</span> (*name) {<font></font>
                h = (h &lt;&lt; <span class="hljs-number">4</span>) + *name++;<font></font>
                g = h &amp; <span class="hljs-number">0xF0000000</span>;
                <span class="hljs-keyword">if</span> (g)<font></font>
                        h ^= g &gt;&gt; <span class="hljs-number">24</span>;<font></font>
                h &amp;= ~g;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> h;<font></font>
}</code></pre><br>
<p>,   <code>"dlopen"</code> -   112420542     :</p><br>
<p><img src="https://habrastorage.org/webt/zu/ch/4i/zuch4ibwuspxmog6_erhbq1evyg.png" alt="ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§æ–‡å­—ã‚’æ¤œç´¢ã™ã‚‹"></p><br>
<p>libdl â€”    ,    39   ,      .  -           .</p><br>
<h3 id="rezultaty-tretego-shaga">  </h3><br>
<p>             ,          :</p><br>
<ul>
<li>dlopen()  dlsym()   libdl</li>
<li>pthread_create()  pthread_detach()   libpthread</li>
</ul><br>
<p>  ,    .</p><br>
<p>        .            .      ,       .</p><br>
<p>    ELF-    .       ,      (  ).        ,    . ,    ,     .               .</p><br>
<h2 id="shag-4-vnedrenie-shell-koda"> 4.  -</h2><br>
<p>  ,    ,    <em>-</em>,     :         ,   .   -  .</p><br>
<h3 id="soderzhimoe-shell-koda"> -</h3><br>
<p>,   -:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        <span class="hljs-keyword">void</span> *payload = dlopen(<span class="hljs-string">"/path/to/payload.so"</span>, RTLD_LAZY);
        <span class="hljs-keyword">void</span> (*entry)(<span class="hljs-keyword">void</span>) = dlsym(payload, <span class="hljs-string">"entry_point"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">pthread_t</span> thread;<font></font>
        pthread_create(&amp;thread, <span class="hljs-literal">NULL</span>, entry, <span class="hljs-literal">NULL</span>);<font></font>
        pthread_detach(thread);<font></font>
}</code></pre><br>
<p>      ?</p><br>
<p>,        â€”   .    ,     ,      ,       -  â€”  -     !    .</p><br>
<p>   â€”   -  .         ,    ,           :        .</p><br>
<pre><code class="javascript hljs"><span class="hljs-comment">/*
 *      .rodata:  
 * .         ,
 *        .
 */</span><font></font>
.section .rodata<font></font>
<font></font>
<span class="hljs-comment">/*
 *   .       .
 *      -:    , 
 *  ,       .
 */</span><font></font>
.global shellcode_start<font></font>
.global shellcode_address_dlopen<font></font>
.global shellcode_address_dlsym<font></font>
.global shellcode_address_pthread_create<font></font>
.global shellcode_address_pthread_detach<font></font>
.global shellcode_address_payload<font></font>
.global shellcode_address_entry<font></font>
.global shellcode_end<font></font>
<font></font>
<span class="hljs-comment">/*
 *   dlopen().     #include &lt;dlfcn.h&gt;,
 *       .
 */</span>
.set RTLD_LAZY, <span class="hljs-number">1</span><font></font>
<font></font>
        .align <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_start</span>:
        <span class="hljs-comment">/*
         * void *payload = dlopen(shellcode_address_payload, RTLD_LAZY);
         *
         *        x86_64:
         *
         *     -     %rdi, %rsi, %rdx, %rcx
         *     -     %rax
         *     -     
         *
         *         .
         *
         *       %rax,   
         *     .
         */</span><font></font>
        lea     shellcode_address_payload(%rip),%rdi<font></font>
        mov     $RTLD_LAZY,%rsi<font></font>
        mov     shellcode_address_dlopen(%rip),%rax<font></font>
        callq   *%rax<font></font>
<font></font>
        <span class="hljs-comment">/*
         * void (*entry)(void) = dlsym(payload, shellcode_address_entry);
         */</span><font></font>
        mov     %rax,%rdi<font></font>
        lea     shellcode_address_entry(%rip),%rsi<font></font>
        mov     shellcode_address_dlsym(%rip),%rax<font></font>
        callq   *%rax<font></font>
<font></font>
        <span class="hljs-comment">/*
         * pthread_t thread;
         * pthread_create(&amp;thread, NULL, entry, NULL);
         *
         *           
         * ,     pthread_create().
         */</span>
        sub     $<span class="hljs-number">8</span>,%rsp<font></font>
        mov     %rsp,%rdi<font></font>
        xor     %rsi,%rsi<font></font>
        mov     %rax,%rdx<font></font>
        xor     %rcx,%rcx<font></font>
        mov     shellcode_address_pthread_create(%rip),%rax<font></font>
        callq   *%rax<font></font>
<font></font>
        <span class="hljs-comment">/*
         * pthread_detach(thread);
         *
         *    ,   , 
         *     .
         */</span><font></font>
        mov     (%rsp),%rdi<font></font>
        add     $<span class="hljs-number">8</span>,%rsp<font></font>
        mov     shellcode_address_pthread_detach(%rip),%rax<font></font>
        callq   *%rax<font></font>
<font></font>
        <span class="hljs-comment">/*
         *   - â€”    ,    
         *      ret.   
         *     , 
         *      .
         */</span>
        int     $<span class="hljs-number">3</span><font></font>
<font></font>
        <span class="hljs-comment">/*
         *       ,  
         *   ,    -
         *     .   â€œ 
         *  â€ (global offset table, GOT),  
         *           .
         */</span>
        .align <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_address_dlopen</span>:<font></font>
        .space <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_address_dlsym</span>:<font></font>
        .space <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_address_pthread_create</span>:<font></font>
        .space <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_address_pthread_detach</span>:<font></font>
        .space <span class="hljs-number">8</span>
<span class="hljs-attr">shellcode_address_payload</span>:<font></font>
        .space <span class="hljs-number">256</span>
<span class="hljs-attr">shellcode_address_entry</span>:<font></font>
        .space <span class="hljs-number">256</span><font></font>
<font></font>
        <span class="hljs-comment">/*
         *  - .
         */</span>
<span class="hljs-attr">shellcode_end</span>:<font></font>
<font></font>
.end</code></pre><br>
<p>,   .      :</p><br>
<pre><code class="plaintext hljs">$ as -o shellcode.o shellcode.S</code></pre><br>
<p> ,      ,  ,   .            :   <em>  </em> (procedure linkage table, PLT),        .</p><br>
<p>    -    ,         (, )       .  <em>-</em>  <em></em> .</p><br>
<h3 id="razmeschenie-shell-koda-v-pamyati"> -  </h3><br>
<p>    <em>-</em>    . ,       ,   ,          .      ?</p><br>
<h4 id="trebovaniya-k-pamyati-pod-shell-kod">    -</h4><br>
<p>     ,       .      <em></em> ,       .    ,         .         ,       .</p><br>
<p>             (-  ),         :   ,    ,    . , ,   JIT-   ,       .    ?</p><br>
<h4 id="podhody-k-razmescheniyu-v-pamyati">    </h4><br>
<p>        :</p><br>
<ul>
<li> -  ,    </li>
<li>  - ,   </li>
</ul><br>
<p>     ,  . -,    - ,     . -,       . -,      ,  -    -,     .</p><br>
<p>  ,      .     .  x86_64  <code>int $3</code>     â€” 0xCC â€”          .  ptrace()         PTRACE_POKETEXT â€” ,     8   , . ,          ,     .</p><br>
<p>,  ,   ,       :        .     -       ,  .</p><br>
<h4 id="kak-vydelit-novuyu-pamyat">   ?</h4><br>
<p> ,  !    malloc()!</p><br>
<p>.      ,      -,    .       .          ,     mmap():</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">inject_shellcode</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *shellcode_src, <span class="hljs-keyword">size_t</span> shellcode_size)</span>
</span>{
        <span class="hljs-keyword">void</span> *shellcode_dst = mmap(<span class="hljs-literal">NULL</span>, shellcode_size,<font></font>
                PROT_READ | PROT_WRITE | PROT_EXEC,<font></font>
                MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
        copy_shellcode(shellcode_dst, shellcode_src, shellcode_size);<font></font>
}</code></pre><br>
<p> ,   ptrace()         ,     .</p><br>
<h3 id="vypolnenie-sistemnyh-vyzovov">  </h3><br>
<p>     ,     ?    ,            . Linux  x86_64   :</p><br>
<ul>
<li>      %rax</li>
<li>   â€”    â€”      %rsi, %rdi, %rdx, %r10, %r8, %r9</li>
<li>  SYSCALL,    </li>
<li>      %rax</li>
</ul><br>
<p> ptrace()           PTRACE_GETREGS  PTRACE_SETREGS.  ,        .   -   SYSCALL.</p><br>
<p>    :      ,       %rip.   ,   ,   SYSCALL.</p><br>
<h4 id="poisk-instrukcii-syscall">  SYSCALL</h4><br>
<p>   SYSCALL? ,    .   -   ,   <em>-</em>      .    â€”   libc.  ,  ,      ,   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-title">find_syscall_instruction</span><span class="hljs-params">(struct library *library)</span>
</span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; library-&gt;region_count; i++) {
                <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memory_region</span> *<span class="hljs-title">region</span> = &amp;<span class="hljs-title">library</span>-&gt;<span class="hljs-title">regions</span>[<span class="hljs-title">i</span>];</span><font></font>
<font></font>
                <span class="hljs-keyword">if</span> (!(region-&gt;readable &amp;&amp; region-&gt;executable))
                        <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
                <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span> *region_data = region-&gt;content;
                <span class="hljs-keyword">size_t</span> region_size = region-&gt;vaddr_high - region-&gt;vaddr_low;<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (region_size &lt; <span class="hljs-number">2</span>)
                        <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
                <span class="hljs-comment">/*
                 * 0F 05 syscall
                 */</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> offset = <span class="hljs-number">0</span>; offset &lt; region_size - <span class="hljs-number">1</span>; offset++) {
                        <span class="hljs-keyword">if</span> (region_data[offset + <span class="hljs-number">0</span>] == <span class="hljs-number">0x0F</span> &amp;&amp;<font></font>
                            region_data[offset + <span class="hljs-number">1</span>] == <span class="hljs-number">0x05</span>)<font></font>
                        {<font></font>
                                <span class="hljs-keyword">return</span> region-&gt;vaddr_low + offset;<font></font>
                        }<font></font>
                }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>       , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  /proc/$pid/maps</a>.  x86_64     ,    -   .     <em></em>   ,    0x0F 0x05.     , ,  ARM,       0xDF 0x00 ( SVC #0),  <em>  </em>.</p><br>
<h4 id="ispolzovanie-ptrace_getsetregs"> PTRACE_{GET,SET}REGS</h4><br>
<p>     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">get_registers</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, struct user_regs_struct *registers)</span>
</span>{
        <span class="hljs-keyword">int</span> err = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_GETREGS, pid, registers, registers) &lt; <span class="hljs-number">0</span>)<font></font>
                err = -errno;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> err;<font></font>
}</code></pre><br>
<p>    <code>struct user_regs_struct</code>,    &lt;sys/user.h&gt;.     .          .     ,        <em>varargs</em>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">set_regs_for_syscall</span><span class="hljs-params">(struct user_regs_struct *registers,
                <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> syscall_insn_vaddr,
                <span class="hljs-keyword">long</span> syscall_number, <span class="hljs-keyword">int</span> args_count, va_list args)</span>
</span>{<font></font>
        registers-&gt;rip = syscall_insn_vaddr;<font></font>
        registers-&gt;rax = syscall_number;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args_count; i++) {
                <span class="hljs-keyword">switch</span> (i) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<font></font>
                        registers-&gt;rdi = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
                        registers-&gt;rsi = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
                        registers-&gt;rdx = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<font></font>
                        registers-&gt;r10 = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
                        registers-&gt;r8 = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<font></font>
                        registers-&gt;r9 = va_arg(args, <span class="hljs-keyword">long</span>);
                        <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                        <span class="hljs-keyword">return</span> -E2BIG;<font></font>
                }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">perform_syscall</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> syscall_insn_vaddr,
                <span class="hljs-keyword">long</span> syscall_number, <span class="hljs-keyword">int</span> args_count, ...)</span>
</span>{
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">old_registers</span>;</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">new_registers</span>;</span><font></font>
<font></font>
        <span class="hljs-comment">/*
         *    ,  
         *      .
         */</span><font></font>
        get_registers(pid, &amp;old_registers);<font></font>
<font></font>
        <span class="hljs-comment">/*
         *      ,  
         * ,     .
         */</span><font></font>
        new_registers = old_registers;<font></font>
<font></font>
        va_list args;<font></font>
        va_start(args, args_count);<font></font>
        set_regs_for_syscall(&amp;new_registers, syscall_insn_vaddr,<font></font>
                syscall_number, args_count, args);<font></font>
        va_end(args);<font></font>
<font></font>
        set_registers(pid, &amp;new_registers);<font></font>
<font></font>
        <span class="hljs-comment">/*
         *    ,   
         *   ,   
         * (  ),    .
         *     .
         */</span><font></font>
        wait_for_syscall_completion(pid);<font></font>
<font></font>
        <span class="hljs-comment">/*
         *      
         *    .
         *        .
         */</span><font></font>
        get_registers(pid, &amp;new_registers);<font></font>
<font></font>
        <span class="hljs-keyword">long</span> result = new_registers.rax;<font></font>
<font></font>
        set_registers(pid, &amp;old_registers);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<h4 id="ispolzovanie-ptrace_syscall"> PTRACE_SYSCALL</h4><br>
<p>      :        ,    ?</p><br>
<p>     PTRACE_SYSCALL.   PTRACE_CONT,     .   ,    - :    ,    .</p><br>
<p>PTRACE_SYSCALL    SIGTRAP    :      (     )       (      ).  , ptrace()   ,          ,         .</p><br>
<p> ,           SIGTRAP:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">wait_for_syscall_enter_exit_stop</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (wait_for_process_stop(pid, SIGTRAP) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wait_for_syscall_completion</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{<font></font>
        wait_for_syscall_enter_exit_stop(pid);<font></font>
<font></font>
        wait_for_syscall_enter_exit_stop(pid);<font></font>
}</code></pre><br>
<p>  â€”   ,    â€”       (wait_for_process_stop() <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>).           .       ,     .</p><br>
<h4 id="opciya-ptrace_o_tracesysgood"> PTRACE_O_TRACESYSGOOD</h4><br>
<p>  , PTRACE_SYSCALL      :       ,   ,  -  .  ,      SIGTRAP       (    ).</p><br>
<p>    SIGTRAP       <em></em>.        PTRACE_O_TRACESYSGOOD,            :</p><br>
<ul>
<li>SIGTRAP â€” -    </li>
<li>SIGTRAP | 0x80 â€”    </li>
</ul><br>
<pre><code class="diff hljs"> int ptrace_attach(pid_t pid)<font></font>
 {<font></font>
         if (ptrace(PTRACE_ATTACH, pid, 0, 0) &lt; 0)<font></font>
                 return -1;<font></font>
<font></font>
         if (wait_for_process_stop(pid, SIGSTOP) &lt; 0)<font></font>
                 return -1;<font></font>
<font></font>
<span class="hljs-addition">+        /*     */</span>
<span class="hljs-addition">+        unsigned long options = PTRACE_O_TRACESYSGOOD;</span>
<span class="hljs-addition">+        if (ptrace(PTRACE_SETOPTIONS, pid, 0, options) &lt; 0)</span>
<span class="hljs-addition">+                return -1;</span><font></font>
<font></font>
         return 0;<font></font>
 }<font></font>
<font></font>
 static int wait_for_syscall_enter_exit_stop(pid_t pid)<font></font>
 {<font></font>
         if (ptrace(PTRACE_SYSCALL, pid, 0, 0) &lt; 0)<font></font>
                 return -1;<font></font>
<font></font>
<span class="hljs-deletion">-        if (wait_for_process_stop(pid, SIGTRAP) &lt; 0)</span>
<span class="hljs-addition">+        if (wait_for_process_stop(pid, SIGTRAP | 0x80) &lt; 0)</span><font></font>
                 return -1;<font></font>
<font></font>
         return 0;<font></font>
 }</code></pre><br>
<h3 id="zagruzka-shell-koda-v-pamyat"> -  </h3><br>
<p>-       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">write_shellcode</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        <span class="hljs-keyword">char</span> shellcode_text[SHELLCODE_TEXT_SIZE];
        <span class="hljs-keyword">size_t</span> shellcode_size = shellcode_end - shellcode_start;<font></font>
<font></font>
        <span class="hljs-comment">/*   ,  ,  . . */</span><font></font>
        prepare_shellcode(shellcode_text, shellcode_size);<font></font>
<font></font>
        <span class="hljs-comment">/*   -   */</span><font></font>
        write_remote_memory(target, shellcode_text_vaddr,<font></font>
                shellcode_text, shellcode_size);<font></font>
}</code></pre><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   -</a>    :      dlopen(),               .</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">copy_shellcode</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *shellcode_text,
                <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *shellcode_addr,
                <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *data, <span class="hljs-keyword">size_t</span> length)</span>
</span>{
        <span class="hljs-keyword">ptrdiff_t</span> offset = shellcode_addr - shellcode_start;
        <span class="hljs-built_in">memcpy</span>(shellcode_text + offset, data, length);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare_shellcode</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *shellcode_text, <span class="hljs-keyword">size_t</span> shellcode_size)</span>
</span>{<font></font>
        copy_shellcode(shellcode_text, shellcode_start,<font></font>
                shellcode_start, shellcode_size);<font></font>
<font></font>
        copy_shellcode(shellcode_text, shellcode_address_dlopen,<font></font>
                &amp;dlopen_vaddr, <span class="hljs-keyword">sizeof</span>(dlopen_vaddr));<font></font>
        copy_shellcode(shellcode_text, shellcode_address_dlsym,<font></font>
                &amp;dlsym_vaddr, <span class="hljs-keyword">sizeof</span>(dlsym_vaddr));<font></font>
        copy_shellcode(shellcode_text, shellcode_address_pthread_create,<font></font>
                &amp;pthread_create_vaddr, <span class="hljs-keyword">sizeof</span>(pthread_create_vaddr));<font></font>
        copy_shellcode(shellcode_text, shellcode_address_pthread_detach,<font></font>
                &amp;pthread_detach_vaddr, <span class="hljs-keyword">sizeof</span>(pthread_detach_vaddr));<font></font>
<font></font>
        copy_shellcode(shellcode_text, shellcode_address_payload,<font></font>
                payload, <span class="hljs-keyword">sizeof</span>(payload));<font></font>
        copy_shellcode(shellcode_text, shellcode_address_entry,<font></font>
                entry, <span class="hljs-keyword">sizeof</span>(entry));<font></font>
}</code></pre><br>
<p>    ,    ,      -:</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_start[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_dlopen[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_dlsym[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_pthread_create[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_pthread_detach[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_payload[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_address_entry[];
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> shellcode_end[];</code></pre><br>
<p>     ,              .</p><br>
<p>   -        .         /proc/$pid/mem, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">write_remote_memory</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> vaddr,
                <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *data, <span class="hljs-keyword">size_t</span> size)</span>
</span>{
        <span class="hljs-keyword">char</span> path[<span class="hljs-number">32</span>] = {<span class="hljs-number">0</span>};
        <span class="hljs-built_in">snprintf</span>(path, <span class="hljs-keyword">sizeof</span>(path), <span class="hljs-string">"/proc/%d/mem"</span>, pid);<font></font>
<font></font>
        <span class="hljs-comment">/*       */</span>
        <span class="hljs-keyword">int</span> fd = open(path, O_WRONLY);
        <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-comment">/*     */</span>
        <span class="hljs-keyword">if</span> (lseek(fd, vaddr, SEEK_SET) &lt; <span class="hljs-number">0</span>) {<font></font>
                close(fd);<font></font>
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">/*    */</span>
        <span class="hljs-keyword">int</span> err = do_write_remote_memory(fd, data, size);<font></font>
<font></font>
        close(fd);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> err;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_write_remote_memory</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *data, <span class="hljs-keyword">size_t</span> size)</span>
</span>{
        <span class="hljs-keyword">size_t</span> left = size;<font></font>
<font></font>
        <span class="hljs-comment">/*
         *    ,  ,    
         *   ,      
         *      .
         */</span>
        <span class="hljs-keyword">while</span> (left &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">ssize_t</span> wrote = write(fd, data, left);<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (wrote &lt; <span class="hljs-number">0</span>)
                        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
                data += wrote;<font></font>
                left -= wrote;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<h3 id="rezultaty-chetvyortogo-shaga">  </h3><br>
<p>,             - â€” Â« Â» .           .    - ,                .</p><br>
<h2 id="shag-5-zapusk-novogo-potoka"> 5.   </h2><br>
<p>    -        .  ,    :    %rip  -,  PTRACE_SETREGS,  PTRACE_CONT    .     .</p><br>
<p>,   ,    .      -?        ?</p><br>
<h3 id="pochemu-nuzhen-novyy-potok">   </h3><br>
<p> ,    .    ,          Â« Â»  .  ,      .      :</p><br>
<ul>
<li>     </li>
<li>  (async-signal-safe) </li>
</ul><br>
<p>     â€”     . dlopen()  pthread_create()     .        -  dlopen(),      dlopen()  ?</p><br>
<p>       -, ,   ,       . ,     pthread_create()    .     ,       (     ).     clone().</p><br>
<blockquote><strong>  pthread_create()?</strong><br>
<br>
    ,  -     ,         ?<br>
<br>
:          clone().<br>
<br>
         ,    (libc)    (pthread).   clone()       <em> </em> (thread control block, TCB)  <em> </em> (thread-local storage, TLS),        ,  . .     pthread_create()    ,    .<br>
<br>
   Â«Â»,      clone()        libc  pthread.        ,    .</blockquote><br>
<h3 id="podgotovka-k-zapusku-potoka">   </h3><br>
<p>     clone()      :</p><br>
<ul>
<li>     ?</li>
<li>   ?</li>
<li>   -?</li>
</ul><br>
<h4 id="obrabotka-zaversheniya-potoka">  </h4><br>
<p>     :     -?</p><br>
<p>    ,  -       :   ,   ,       ,       .</p><br>
<p>       .  ,     ,        . ?  :     exit().          ,     .</p><br>
<p>        .     exit()   -:</p><br>
<pre><code class="diff hljs"><span class="hljs-addition">+.set __NR_exit, 60</span><font></font>
 .set RTLD_LAZY, 1<font></font>
@@<font></font>
<span class="hljs-deletion">-       /*</span>
<span class="hljs-deletion">-        *  .</span>
<span class="hljs-deletion">-        */</span>
<span class="hljs-deletion">-       int     $3</span>
<span class="hljs-addition">+       /*</span>
<span class="hljs-addition">+        * exit(0);</span>
<span class="hljs-addition">+        */</span>
<span class="hljs-addition">+       xor     %rdi,%rdi</span>
<span class="hljs-addition">+       mov     $__NR_exit,%rax</span>
<span class="hljs-addition">+       syscall</span></code></pre><br>
<p> :   exit() â€”    exit()   .   exit()    <em></em>,    exit()    â€” <em> </em>   .    Linux     exit_group().</p><br>
<h4 id="vydelenie-pamyati-pod-stek">   </h4><br>
<p>    .         .     ,      ,   PROT_EXEC:</p><br>
<pre><code class="cpp hljs">shellcode_stack_vaddr =<font></font>
        remote_mmap(target, syscall_vaddr, <span class="hljs-number">0</span>,<font></font>
                SHELLCODE_STACK_SIZE,<font></font>
                PROT_READ | PROT_WRITE,<font></font>
                MAP_ANONYMOUS | MAP_PRIVATE | MAP_STACK |<font></font>
                MAP_GROWSDOWN, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);</code></pre><br>
<p>  ,   Linux  x86_64  <em> </em> â€”  Â«Â»  ,     .  mmap()      ,   clone()     .  ,    mmap()  MAP_GROWSDOWN,       ,    .</p><br>
<h4 id="opciya-ptrace_o_traceclone"> PTRACE_O_TRACECLONE</h4><br>
<p>       .       ,   -   .         waitpid(),     :      ,          .</p><br>
<p>       â€”   PTRACE_O_TRACECLONE.          .  ,       . ,      ,     ,    .      ,       PTRACE_ATTACH  ,    .</p><br>
<p>-,       :</p><br>
<pre><code class="diff hljs"><span class="hljs-deletion">-        unsigned long options = PTRACE_O_TRACESYSGOOD;</span>
<span class="hljs-addition">+        unsigned long options = PTRACE_O_TRACESYSGOOD | PTRACE_O_TRACECLONE;</span><font></font>
         if (ptrace(PTRACE_SETOPTIONS, pid, 0, options) &lt; 0)<font></font>
                 return -1;</code></pre><br>
<p>-,         clone(),    PTRACE_EVENT_CLONE,     ,  PTRACE_SYSCALL.        :</p><br>
<pre><code class="diff hljs"><span class="hljs-deletion">-void wait_for_syscall_completion(pid_t pid)</span>
<span class="hljs-addition">+void wait_for_syscall_completion(pid_t pid, long syscall)</span><font></font>
 {<font></font>
         wait_for_syscall_enter_exit_stop(pid);<font></font>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        /*  clone()   PTRACE_EVENT_CLONE */</span>
<span class="hljs-addition">+        if (syscall == __NR_clone)</span>
<span class="hljs-addition">+                wait_for_clone_event(pid);</span><font></font>
<font></font>
         wait_for_syscall_enter_exit_stop(pid);<font></font>
 }</code></pre><br>
<p>    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">wait_for_clone_event</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_CONT, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">int</span> event = SIGTRAP | (PTRACE_EVENT_CLONE &lt;&lt; <span class="hljs-number">8</span>);
        <span class="hljs-keyword">if</span> (wait_for_process_stop(pid, event) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>    clone()  PID  ,    .         :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clear_ptrace_options</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{<font></font>
        ptrace(PTRACE_SETOPTIONS, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
}</code></pre><br>
<p>  ,   clone()    ptrace(),  PTRACE_O_TRACECLONE.     ,     ,  -     .</p><br>
<h3 id="zapusk-novogo-potoka">  </h3><br>
<p>     ,   - .       clone()   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">spawn_shell_thread</span><span class="hljs-params">()</span>
</span>{<font></font>
       shell_tid = remote_clone(target, syscall_ret_vaddr,<font></font>
               CLONE_FILES | CLONE_FS | CLONE_IO | CLONE_SIGHAND |<font></font>
               CLONE_SYSVSEM | CLONE_THREAD | CLONE_VM,<font></font>
               <span class="hljs-comment">/*   **  */</span><font></font>
               shellcode_stack_vaddr + SHELLCODE_STACK_SIZE);<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (!shell_tid)
               <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">clone()    </a>:    ,   ,     ,  .      ,  .</p><br>
<p>CLONE_FILES, CLONE_FS, CLONE_IO, CLONE_SIGHAND, CLONE_SYSVSEM, CLONE_VM â€”         . ,   CLONE_FILES    <em></em>   ,    (  fork()).      â€”    <em></em> â€”      ,        .       . , CLONE_VM   ,       ,    .</p><br>
<p> CLONE_THREAD       <em></em>:    Linux â€”  Â«   Â»,     .  , ,  getpid()         , kill() â€”   -   , execve() â€”       ,   .</p><br>
<p> ,  clone()   fork():        ,    .      clone()      :    ,  â€”   .        . ( , ,        .)</p><br>
<p>   ,  pthread_create()    ,      ,    .     ?</p><br>
<h3 id="peredacha-upravleniya"> </h3><br>
<p>   fork()  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">pid_t</span> child = fork();<font></font>
<font></font>
<span class="hljs-keyword">if</span> (child &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">/* fork() ,    */</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">if</span> (child == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">/*     execve() */</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*     */</span></code></pre><br>
<p> ,     .  clone()                 .            .</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>. ,   clone()      ,    .      syscall   ret,       ,     .           .</p><br>
<h4 id="poisk-pary-instrukciy-syscall--ret">   SYSCALL + RET</h4><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a>,       .      ,     syscall   ret:</p><br>
<pre><code class="diff hljs"><span class="hljs-deletion">-if (region_size &lt; 2)</span>
<span class="hljs-addition">+if (region_size &lt; 3)</span><font></font>
         continue;<font></font>
<font></font>
 /*<font></font>
  * 0F 05 syscall<font></font>
<span class="hljs-addition">+ * C3    retq</span><font></font>
  */<font></font>
<span class="hljs-deletion">-for (size_t offset = 0; offset &lt; region_size - 1; offset++) {</span>
<span class="hljs-addition">+for (size_t offset = 0; offset &lt; region_size - 2; offset++) {</span><font></font>
         if (region_data[offset + 0] == 0x0F &amp;&amp;<font></font>
<span class="hljs-deletion">-            region_data[offset + 1] == 0x05)</span>
<span class="hljs-addition">+            region_data[offset + 1] == 0x05 &amp;&amp;</span>
<span class="hljs-addition">+            region_data[offset + 2] == 0xC3)</span><font></font>
         {<font></font>
                 return region-&gt;vaddr_low + offset;<font></font>
         }<font></font>
 }</code></pre><br>
<p> ,       .</p><br>
<h4 id="podgotovka-steka"> </h4><br>
<p>    .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> prepare_shellcode()</a>,    ,          :</p><br>
<pre><code class="diff hljs"> void write_shellcode(void)<font></font>
 {<font></font>
         char shellcode_text[SHELLCODE_TEXT_SIZE];<font></font>
         size_t shellcode_size = shellcode_end - shellcode_start;<font></font>
<font></font>
         /*   ,  ,  . . */<font></font>
         prepare_shellcode(shellcode_text, shellcode_size);<font></font>
<font></font>
         /*   -   */<font></font>
         write_remote_memory(target, shellcode_text_vaddr,<font></font>
                 shellcode_text, shellcode_size);<font></font>
<font></font>
<span class="hljs-addition">+        /*    Â«Â»   */</span>
<span class="hljs-addition">+        unsigned long retaddr_vaddr =</span>
<span class="hljs-addition">+                shellcode_stack_vaddr + SHELLCODE_STACK_SIZE - 8;</span>
<span class="hljs-addition">+        write_remote_memory(target, retaddr_vaddr,</span>
<span class="hljs-addition">+                &amp;shellcode_text_vaddr, sizeof(shellcode_text_vaddr));</span>
 }</code></pre><br>
<p> ,      ,     .</p><br>
<p> ,     ,   <em></em>. System V ABI ,   ( %rsp)     16    .  <code>shellcode_stack_vaddr + SHELLCODE_STACK_SIZE</code>  :       (  4096 ),     1 .  8 ,     ,      retq,      -    .   -   :</p><br>
<pre><code class="diff hljs"><span class="hljs-deletion">-        sub     $8,%rsp</span>
<span class="hljs-addition">+        sub     $16,%rsp  /*   */</span><font></font>
         mov     %rsp,%rdi<font></font>
         xor     %rsi,%rsi<font></font>
         mov     %rax,%rdx<font></font>
         xor     %rcx,%rcx<font></font>
         mov     shellcode_address_pthread_create(%rip),%rax<font></font>
         callq   *%rax</code></pre><br>
<p>    ,   %rsp    16       pthread_create().          SIGSEGV,     â€”     pthread_create()   ,       .</p><br>
<h4 id="zapusk-potoka"> </h4><br>
<p>       ,       - ,      clone():</p><br>
<pre><code class="diff hljs"> static int spawn_shell_thread()<font></font>
 {<font></font>
        shell_tid = remote_clone(target, syscall_ret_vaddr,<font></font>
                CLONE_FILES | CLONE_FS | CLONE_IO | CLONE_SIGHAND |<font></font>
                CLONE_SYSVSEM | CLONE_THREAD | CLONE_VM,<font></font>
                /*   **  */<font></font>
<span class="hljs-deletion">-               shellcode_stack_vaddr + SHELLCODE_STACK_SIZE);</span>
<span class="hljs-addition">+               shellcode_stack_vaddr + SHELLCODE_STACK_SIZE - 8);</span><font></font>
<font></font>
        if (!shell_tid)<font></font>
                return -1;<font></font>
<font></font>
        return 0;<font></font>
 }</code></pre><br>
<p>     ptrace()    SIGSTOP,     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ignore_thread_stop</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">return</span> wait_for_process_stop(pid, SIGSTOP);<font></font>
}</code></pre><br>
<p>.               ptrace():</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">resume_thread</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{<font></font>
        ptrace(PTRACE_CONT, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
}</code></pre><br>
<h3 id="zavershenie-potoka"> </h3><br>
<p> ,    ,  ,    exit().        waitpid().     â€”  CLONE_THREAD   wait()  ,â€”    PTRACE_O_TRACECLONE,      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">wait_for_process_exit</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">int</span> status = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (waitpid(pid, &amp;status, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!WIFEXITED(status))
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> WEXITSTATUS(status);<font></font>
}</code></pre><br>
<p>   pthread ,   ,  pthread_join()      pthread       ,        . ,  â€”  .       ,   ,  .</p><br>
<h4 id="osvobozhdenie-pamyati"> </h4><br>
<p>    ,  -   .     ,   -   ,      munmap():</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">remote_munmap</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> syscall_insn_vaddr,
                <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> addr, <span class="hljs-keyword">size_t</span> len)</span>
</span>{<font></font>
        perform_syscall(pid, syscall_insn_vaddr,<font></font>
                __NR_munmap, <span class="hljs-number">2</span>, (<span class="hljs-keyword">long</span>) addr, (<span class="hljs-keyword">long</span>) len);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unmap_shellcode</span><span class="hljs-params">()</span>
</span>{<font></font>
        remote_munmap(target, syscall_ret_vaddr,<font></font>
                shellcode_text_vaddr, SHELLCODE_TEXT_SIZE);<font></font>
<font></font>
        remote_munmap(target, syscall_ret_vaddr,<font></font>
                shellcode_stack_vaddr, SHELLCODE_STACK_SIZE);<font></font>
}</code></pre><br>
<p>,  ,     ,      â€”  ptrace()   .        (, SIGSTOP),    ,   <em> </em>    (    ):</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">stop_thread</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">if</span> (kill(pid, SIGSTOP) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (wait_for_process_stop(pid, SIGSTOP) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<h4 id="otklyuchenie-otladchika"> </h4><br>
<p>,      ,    .     PTRACE_DETACH:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ptrace_detach</span><span class="hljs-params">(<span class="hljs-keyword">pid_t</span> pid)</span>
</span>{
        <span class="hljs-keyword">if</span> (ptrace(PTRACE_DETACH, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<h3 id="rezultaty-pyatogo-shaga">  </h3><br>
<p>                  ,      .     ,         .   ,      .</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p>     ?   . ,       ,      .</p><br>
<p><img src="https://habrastorage.org/webt/0v/gu/we/0vguwedoumnnjh89zw5jtpaaltw.gif" alt="Gnome Control Centerã§ã®å°„å‡ºãƒ‡ãƒ¢"></p><br>
<p>   Linux    .     GTK+     .      ,       make:</p><br>
<pre><code class="bash hljs">libpayload.so: payload.c<font></font>
        $(CC) $(CFLAGS) $(shell pkg-config --cflags --libs gtk+-3.0) -shared -o <span class="hljs-variable">$@</span> $&lt;</code></pre><br>
<p>    entry()            GTK- â€”    GTK  UI      ,    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;glib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;gtk/gtk.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> gboolean <span class="hljs-title">actual_entry</span><span class="hljs-params">(gpointer _arg)</span>
</span>{
        <span class="hljs-comment">/*       : */</span><font></font>
        hook_gtk_entry_constructor();<font></font>
<font></font>
        <span class="hljs-comment">/*   FALSE,       */</span>
        <span class="hljs-keyword">return</span> FALSE;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">entry</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        <span class="hljs-comment">/*    -,   */</span>
        g_idle_add_full(G_PRIORITY_DEFAULT_IDLE, actual_entry, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br>
<p>,   GTK   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GtkEntry</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> "input-purpose"</a>     .       Â«Â»,    ,      .</p><br>
<p>GTK   glib â€”     â€”      GtkEntry       .    constructed(),     .    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">void</span> <span class="hljs-params">(*old_gtk_entry_constructed)</span><span class="hljs-params">(GObject *object)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">new_gtk_entry_constructed</span><span class="hljs-params">(GObject *object)</span>
</span>{<font></font>
        GtkEntry *entry = GTK_ENTRY(object);<font></font>
<font></font>
        <span class="hljs-comment">/*    */</span><font></font>
        old_gtk_entry_constructed(object);<font></font>
<font></font>
        <span class="hljs-comment">/*    ,  ,   entry */</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hook_gtk_entry_constructor</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
        <span class="hljs-comment">/*     GtkEntry */</span><font></font>
        GTypeClass *entry_type_class = g_type_class_peek(GTK_TYPE_ENTRY);<font></font>
        GObjectClass *entry_object_class = G_OBJECT_CLASS(entry_type_class);<font></font>
<font></font>
        <span class="hljs-comment">/*
         *     "constructed"     .
         */</span><font></font>
        old_gtk_entry_constructed = entry_object_class-&gt;constructed;<font></font>
        entry_object_class-&gt;constructed = new_gtk_entry_constructed;<font></font>
}</code></pre><br>
<p>  GtkEntry   :</p><br>
<ul>
<li>  ,  ,  </li>
<li>      </li>
</ul><br>
<p> ,    GtkEntry  <em></em>,   ,    .     ,    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">new_gtk_entry_constructed</span><span class="hljs-params">(GObject *object)</span>
</span>{<font></font>
        GtkEntry *entry = GTK_ENTRY(object);<font></font>
<font></font>
        old_gtk_entry_constructed(object);<font></font>
<font></font>
        <span class="hljs-comment">/*       */</span>
        g_signal_connect(entry, <span class="hljs-string">"notify::input-purpose"</span>,<font></font>
                G_CALLBACK(input_purpose_changed), <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
        <span class="hljs-comment">/*      */</span>
        g_signal_connect(entry, <span class="hljs-string">"icon-press"</span>,<font></font>
                G_CALLBACK(icon_pressed), <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
        <span class="hljs-comment">/*      */</span>
        g_signal_connect(entry, <span class="hljs-string">"icon-release"</span>,<font></font>
                G_CALLBACK(icon_released), <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br>
<p>  .                ,         .         .</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">input_purpose_changed</span><span class="hljs-params">(GtkEntry *entry)</span>
</span>{<font></font>
        GtkInputPurpose purpose = gtk_entry_get_input_purpose(entry);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (purpose == GTK_INPUT_PURPOSE_PASSWORD) {<font></font>
                gtk_entry_set_icon_activatable(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                        TRUE);<font></font>
                gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                        <span class="hljs-string">"list-remove"</span>);<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
                gtk_entry_set_icon_activatable(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                        FALSE);<font></font>
                gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                        <span class="hljs-literal">NULL</span>);<font></font>
        }<font></font>
}</code></pre><br>
<p>  : ,      ,   ,  -       ,      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">icon_pressed</span><span class="hljs-params">(GtkEntry *entry, GtkEntryIconPosition position)</span>
</span>{
        <span class="hljs-keyword">if</span> (position != GTK_ENTRY_ICON_PRIMARY)
                <span class="hljs-keyword">return</span>;<font></font>
<font></font>
        gtk_entry_set_visibility(entry, TRUE);<font></font>
        gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                <span class="hljs-string">"list-add"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">icon_released</span><span class="hljs-params">(GtkEntry *entry, GtkEntryIconPosition position)</span>
</span>{
        <span class="hljs-keyword">if</span> (position != GTK_ENTRY_ICON_PRIMARY)
                <span class="hljs-keyword">return</span>;<font></font>
<font></font>
        gtk_entry_set_visibility(entry, FALSE);<font></font>
        gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY,<font></font>
                <span class="hljs-string">"list-remove"</span>);<font></font>
}</code></pre><br>
<p>  .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubã§ã¯</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ãƒ–ãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼ã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGPLv2ï¼‰ã®å®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¡ãªã¿ã«ã€ç§ã¯æ—¢è£½ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„ã“ã¨ã«ã¤ã„ã¦å˜˜ã‚’ã¤ãã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã‚‚ã¡ã‚ã‚“ã€gdbã¯ä»–ã®äººã®ãƒ—ãƒ­ã‚»ã‚¹ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚</font></font></p><br>
<pre><code class="plaintext hljs">$ gdb --pid $(pgrep target) \<font></font>
      --batch \<font></font>
      -ex 'compile file -raw shell-code.c'</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473720/index.html">ä¿¡é ¼ã§ãã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹2ã¤ã®æ–¹æ³•</a></li>
<li><a href="../ja473722/index.html">é éš”éš”é›¢ã€ä¸å®‰ã€æŠ‘ã†ã¤</a></li>
<li><a href="../ja473726/index.html">Mutexã€Semaphoreã€ãŠã‚ˆã³async / awaitãŒä½•ã§ã‚ã‚‹ã‹ã‚’çŸ¥ã‚‹ã ã‘ã§ã¯ååˆ†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é‡å­ã‹ã‚‰ã™ã¹ã¦ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</a></li>
<li><a href="../ja473728/index.html">ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ä¸€èˆ¬çš„ãªå®Ÿè£…ã€‚ãƒ‹ã‚³ãƒ©ã‚¤ãƒ»ã‚·ãƒ–ã‚³</a></li>
<li><a href="../ja473732/index.html">10å„„ãƒ‰ãƒ«ã®åŒ—æ¥µåœä¸‹ã®ã‚±ãƒ¼ãƒ–ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æ§‹ç¯‰ã«ãŠã‘ã‚‹è©æ¬ºã®æ­´å²</a></li>
<li><a href="../ja473742/index.html">CADãŠã‚ˆã³GISç”¨ã®Epsonã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã€ãŠã‚ˆã³ã€Œå …ç‰¢ãªè¨­è¨ˆã€ã«é–¢ã™ã‚‹ä¸€è¨€</a></li>
<li><a href="../ja473748/index.html">åŠ´åƒçµŒæ¸ˆå­¦è€…ã®ãŸã‚ã®ãƒ™ã‚¸ã‚¨æ›²ç·š</a></li>
<li><a href="../ja473750/index.html">Stereopi + WebRTC =è‡ªå®…ã§ã®ãƒ†ãƒ¬ãƒ—ãƒ¬ã‚»ãƒ³ã‚¹</a></li>
<li><a href="../ja473752/index.html">ã‚³ãƒ”ãƒ¼æ™‚ã®Linuxã®ã‚³ãƒ”ãƒ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒˆã®ä½•ãŒå•é¡Œã«ãªã£ã¦ã„ã¾ã™ã‹</a></li>
<li><a href="../ja473756/index.html">HTTPS DNS-åŠåˆ†ã¨é–“é•ã£ãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>