<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📇 👩🏾‍⚖️ 🚒 2ライフハック：Microsoft SQL Serverのクラシック検索の代替手段 🛐 🧝🏽 👨🏼‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！Softpointの友達がMicrosoft SQL Serverに関する興味深い記事を作成しました。全文検索を使用する2つの実用的な例を解析します。
 
 

- LIKEによる通常の検索ではなく、「無限」の行（コメントなど）で検索します。 
- プレフィックス付きのドキュメン...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>2ライフハック：Microsoft SQL Serverのクラシック検索の代替手段</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/470139/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font><font style="vertical-align: inherit;">Softpointの友達がMicrosoft SQL Serverに関する興味深い記事を作成しました。</font><font style="vertical-align: inherit;">全文検索を使用する2つの実用的な例を解析します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LIKEによる通常の検索ではなく、「無限」の行（コメントなど）で検索します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレフィックス付きのドキュメント番号で検索します。</font><font style="vertical-align: inherit;">通常は全文検索を使用できない場合：定数プレフィックスがそれを妨害します。</font><font style="vertical-align: inherit;">2つのアプローチが分析されます。ドキュメント番号の前処理と独自のライブラリワードブレーカーの追加です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今すぐ参加！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/iu/to/cjiutotj7eknpw4cyapmoqw3yys.png"><a name="habracut"></a><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は発言者に発言権を与え</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ますギガバイトの蓄積データを効果的に検索することは、会計システムの一種の「聖杯」です。</font><font style="vertical-align: inherit;">誰もが彼を見つけて不滅の栄光を手に入れたいと思っていますが、何度も何度も検索していると、奇跡的な解決策は1つもないことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーは通常、部分文字列を検索したいという事実により、状況は複雑になります-どこかで、コメントの真ん中に目的の契約番号が「埋まっている」ことが判明します。どこかで、オペレーターはクライアントの名前を正確には覚えていませんが、彼の名前は「Alexey Evgrafovich」であることを覚えていました。どこかで、SEYUBLの所有権の繰り返し形式を省略し、組織の名前ですぐに検索する必要があります。従来のリレーショナルDBMSの場合、このような検索は非常に悪いニュースです。ほとんどの場合、そのような部分文字列検索は、テーブルの各行の系統的なスクロールに限定されます。特にテーブルのサイズが数十ギガバイトに増大する場合は特に、最も効果的な戦略ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の方法を探す際、私はよく「全文検索」を思い出します。</font><font style="vertical-align: inherit;">解決策を見つける喜びは通常、既存の実践をざっと見直すとすぐに過ぎます。</font><font style="vertical-align: inherit;">人気のある意見によると、全文検索は次のようになります：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成が難しい</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゆっくり更新</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップデート時にシステムがハングする</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある種の</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">愚かな</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">珍しい構文があります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼らが尋ねるものを見つけられません</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一連の神話は長い間続くことができますが、プラトンでさえ私たちに懐疑的であり、信仰に関する他人の意見を盲目的に受け入れないように教えてくれました。彼が描かれているほど悪魔がひどいものかどうか見てみましょうか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、調査に深くは関わっていません</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、重要な条件</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">については</font><b><font style="vertical-align: inherit;">すぐに同意します</font></b><font style="vertical-align: inherit;">。全文検索エンジンは、通常の文字列検索よりもはるかに多くのことができます。たとえば、同義語の辞書を定義し、「連絡先」という単語を使用して「電話」を検索できます。または、形式や末尾に関係なく単語を検索します。これらのオプションはユーザーにとって非常に便利ですが、この記事では、全文検索を従来の文字列検索の代替としてのみ検討します。つまり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、検索バーで指定される部分文字列のみを検索します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、類義語を考慮せず、単語を「通常の」形式やその他の魔法に変えることなく。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS SQL全文検索のしくみ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS SQLの全文検索機能は、メインのDBMSサービスから部分的に削除されています（記事の終わり近くで、これが非常に役立つ理由について説明します）。</font><font style="vertical-align: inherit;">検索では、通常のバランスツリーとは異なり、その構造で特別なインデックスが形成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全文検索インデックスを作成するには、1つの列のみで構成されるキーテーブルに一意のインデックスが存在する必要があります。これは、テーブルの行を識別するために使用される全文検索です。</font><font style="vertical-align: inherit;">多くの場合、テーブルにはすでにそのような主キーのインデックスがありますが、追加で作成する必要がある場合もあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フルテキスト検索インデックスは、非同期でトランザクションの外で作成されます。テーブルの行を変更すると、処理のためにキューに入れられます。インデックスを更新するプロセスは、テーブルの行（行）から、インデックスに「署名」されたすべての文字列値を受け取り、それらを別々の単語に分割します。この後、単語を特定の「標準」形式（たとえば、語尾なし）に縮小できるため、単語形式での検索が容易になります。 「ストップワード」がスローされます（前置詞、記事、その他の意味を持たない単語）。残りの単語から文字列へのリンクの一致は、全文検索インデックスに書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスに含まれるテーブルの各列は、このようなパイプラインを通過することがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長い行-&gt;ワードブレーカー-&gt;パーツ（単語）のセット-&gt;ステマー-&gt;正規化された単語-&gt; [オプション]ストップワードの例外-&gt;インデックスへの書き込み</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
既に述べた</font><font style="vertical-align: inherit;">ように、インデックス</font><font style="vertical-align: inherit;">の更新プロセスは非同期です。</font><font style="vertical-align: inherit;">したがって：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新はユーザーアクションをブロックしません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新は、行変更トランザクションの完了を待機し、コミットより前に変更の適用を開始します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フルテキストインデックスへの変更は、メイントランザクションに比べて少し遅れて適用されます。</font><font style="vertical-align: inherit;">つまり、行を追加してからその行が見つかるまでの間に、インデックス更新キューの長さに応じて遅延が発生します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスに含まれる要素の数は、クエリで監視できます。</font></font></li>
</ol><br>
<pre><code class="cs hljs">SELECT<font></font>
	cat.name,<font></font>
    FULLTEXTCATALOGPROPERTY(cat.name,<span class="hljs-string">'ItemCount'</span>) AS [ItemCount]<font></font>
FROM sys.fulltext_catalogs AS cat</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実用的なテスト。</font><font style="vertical-align: inherit;">物理的な検索 </font><font style="vertical-align: inherit;">名前による人</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルにデータを入力する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験では、「カウンターパーティ」が格納される1つのテーブルを持つ新しい空のベースを作成します。</font><font style="vertical-align: inherit;">「description」フィールド内には、契約の名前が記載された行があり、ここに取引相手の名前が記載されます。</font><font style="vertical-align: inherit;">このようなもの：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「ボロビックデミャンエメリヤノビッチとの合意」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または次のようなもの：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「犬。</font><font style="vertical-align: inherit;">Anatoly Avdeevich Borovik-Romanovと一緒に」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、私はそのような「アーキテクチャ」からすぐに自分自身を撮影したいと思いますが、残念ながら、「コメント」または「説明」のそのようなアプリケーションは、ビジネスユーザーの間でよく使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、「重み」のフィールドをいくつか追加します。テーブルに2列しかない場合は、単純なスキャンで瞬時に読み取られます。</font><font style="vertical-align: inherit;">スキャンが長くなるように、テーブルを「膨らませる」必要があります。</font><font style="vertical-align: inherit;">これにより、実際のビジネスケースに近づくことができます。「説明」をテーブルに格納するだけでなく、他の多くの[悪魔]有用な情報も格納します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function">create table <span class="hljs-title">partners</span> (<span class="hljs-params">id bigint identity (<span class="hljs-number">1</span>,<span class="hljs-number">1</span></span>) not <span class="hljs-literal">null</span>, 
	[description] <span class="hljs-title">nvarchar</span>(<span class="hljs-params">max</span>),
	[address] <span class="hljs-title">nvarchar</span>(<span class="hljs-params"><span class="hljs-number">256</span></span>) not <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> N'107240, ,  ., 168',
	[phone] <span class="hljs-title">nvarchar</span>(<span class="hljs-params"><span class="hljs-number">256</span></span>) not <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> N'+7 (<span class="hljs-params"><span class="hljs-number">495</span></span>) 111-222-33',
	[contact_name] <span class="hljs-title">nvarchar</span>(<span class="hljs-params"><span class="hljs-number">256</span></span>) not <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> N'',
	[bio] <span class="hljs-title">nvarchar</span>(<span class="hljs-params"><span class="hljs-number">2048</span></span>) not <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> N'     . , ,  .  ,    .        ,     .   ,  , ,       ,  .    . ,    ,   .       ,  ,            .       ,    ,     , .          ,   ,   .       .    .')
--  ,    ..       </span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の質問は、非常に多くのユニークな姓、名前、愛称をどこで得るかです。</font><font style="vertical-align: inherit;">私は、古い習慣によると、通常のロシアの学生、すなわち </font><font style="vertical-align: inherit;">ウィキペディアに行きました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページから取った名前カテゴリー：ロシアの男性の名前</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前からミドルネームを手動で書き換え、末尾を変更する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">姓の場合は少し複雑になります。</font><font style="vertical-align: inherit;">結局、「名酒」というカテゴリーが見つかりました。</font><font style="vertical-align: inherit;">Pythonと別のテーブルでの少しのシャーマニズムによって、46.5千の名前が判明しました。</font><font style="vertical-align: inherit;">（名前をダウンロードするためのスクリプトはこちらから入手できます）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、姓には奇妙な違いがありましたが、調査の目的では、これは完全に許容できました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0z/to/16/0zto16d8rkkkygbiuqvdorvlxdc.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は、ランダムな数の名前と愛称を各姓に添付するSQLスクリプトを作成しました。</font><font style="vertical-align: inherit;">5分の待機時間と別のテーブルには、すでに450万の組み合わせがありました。</font><font style="vertical-align: inherit;">悪くない！</font><font style="vertical-align: inherit;">姓ごとに、名前とミドルネームの組み合わせが20〜231あり、平均97の組み合わせが得られました。</font><font style="vertical-align: inherit;">名前と愛用者による分布は、「左側」にわずかに偏っていることがわかりましたが、よりバランスのとれたアルゴリズムを考え出すことは冗長に思えました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lb/yx/ug/lbyxugz2sjsri9uw7bi7rzornl4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データが準備できたら、実験を開始できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文検索の設定</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MS SQLレベルでフルテキストインデックスを作成します。</font><font style="vertical-align: inherit;">まず、このインデックス用のリポジトリ、つまりフルテキストカタログを作成する必要があります。</font></font><br>
<br>
<pre><code class="cs hljs">USE [like_vs_fulltext]<font></font>
GO<font></font>
CREATE FULLTEXT CATALOG [basic_ftc] WITH ACCENT_SENSITIVITY = OFF<font></font>
AS DEFAULT<font></font>
AUTHORIZATION [dbo]<font></font>
<font></font>
GO</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カタログがあり、テーブルにフルテキストインデックスを追加しようとしていますが、何も機能しません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-v/rd/ge/-vrdge8hjpp_c8pgt4j3imsmks4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
言ったように、フルテキストインデックスには、1つの一意の列を持つ通常のインデックスが必要です。</font><font style="vertical-align: inherit;">必須フィールド、つまり一意の識別子IDがすでにあることを思い出します。</font><font style="vertical-align: inherit;">一意のクラスターインデックスを作成します（ただし、クラスター化されていないもので十分です）。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function">create unique  clustered index ndx1 <span class="hljs-keyword">on</span> <span class="hljs-title">partners</span> (<span class="hljs-params">id</span>)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいインデックスを作成した後、最終的に全文検索インデックスを追加できます。</font><font style="vertical-align: inherit;">インデックスがいっぱいになるまで数分待ちましょう（非同期に更新されることに注意してください！）。</font><font style="vertical-align: inherit;">テストに進むことができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト中</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
検索の実際のアプリケーションに近い、最も単純なシナリオから始めましょう。 「リストビュー」-サーチマスクによる選択を伴う45行のウィンドウ選択をシミュレートします。新しいフルテキストインデックスを使用してリクエストを実行し、時間-0秒-を記録します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m8/ci/bk/m8cibkgbrwb2xkruwbspp3axfgk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、「いいね」による古い検証済み検索。結果を形成するのに3秒かかりました。それほど悪くはない、完全な敗北はうまくいきませんでした。多分それからそれは全文検索を構成することは意味をなさない-すべてうまくいくか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bl/gr/hl/blgrhlafampbhbssctycbcweuis.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、1つの重要な詳細を見逃しました。要求はソートなしで実行されました。まず、このようなクエリと「最初のNレコードの選択」を組み合わせると、保証されていない結果が返されます。各開始はランダムなNレコードを返す可能性があり、2つの連続した開始が同じデータセットを提供するという保証はありません。次に、「スライドウィンドウでリストを表示する」という場合、通常はこの「ウィンドウ」が任意の列、たとえば名前で並べ替えられます。結局のところ、オペレーターは次の「ウィンドウ」に移動したときに何が得られるかを知る必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験を修正します。たとえば、電話番号による並べ替えを追加し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tc/n-/i9/tcn-i9py1gxkrbrl927ygqqyudq.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フルテキスト検索は、耳をつんざくようなスコアで勝利します。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリプランを見ると、なぜそうなのかが明らかになります。クエリテキストに順序付けが追加されたため、実行中にソート操作が表示されました。これは、いわゆる「ブロッキング」操作であり、ソートするデータの全体量を受け取るまで要求を完了できません。最初の45レコードを取得することはできません。データセット全体を並べ替える必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ソートのためのデータを取得する段階で、劇的な違いが発生します。 「いいね」を使用した検索では、利用可能なテーブル全体を参照する必要があります。これには172秒かかります。ただし、全文検索には独自の最適化された構造があり、必要なすべてのエントリへのリンクがすぐに返されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gq/nu/fw/gqnufwndwjmo5skv5_uq6ewvdkc.png"><br>
<br>
<img src="https://habrastorage.org/webt/uv/ew/c9/uvewc93qvfchgagsclaqi55hvt8.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、軟膏にハエがあるべきですか？</font><font style="vertical-align: inherit;">ここに一つ。</font><font style="vertical-align: inherit;">最初に述べたように、全文検索は単語の最初からしか検索できません。</font><font style="vertical-align: inherit;">また、サブストリング「* oak *」で「Ivan Poddubny」を検索する場合、全文検索では有用な情報は何も表示されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、名前で検索する場合、これは最も一般的なシナリオではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">番号でドキュメントを検索する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もっと複雑なことを試してみましょう。</font><font style="vertical-align: inherit;">検索の2番目に一般的な使用例は、ドキュメントを番号の一部で見つけることです。</font><font style="vertical-align: inherit;">さらに、多くの場合、ドキュメント番号は2つの部分で構成されます。文字のプレフィックスと、先行ゼロを含む実際の番号です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのパーツ間にスペースやサービス文字はありません。</font><font style="vertical-align: inherit;">同時に、整数による検索は非常に不便です-接頭辞の後の重要な部分の始まりの前にある先行ゼロの数を覚えておく必要があります。</font><font style="vertical-align: inherit;">「そのまま」のフルテキスト検索は、そのようなシナリオでは単に役に立たないことがわかります。</font><font style="vertical-align: inherit;">修正してみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストのために、「ORG」タイプの一意の番号を持つ1350万のレコードを追加したdocumentという新しいテーブルを作成しました。</font><font style="vertical-align: inherit;">番号付けは順調で、すべての番号は「ORG」で始まりました。</font><font style="vertical-align: inherit;">あなたが始めることができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数値を事前分割する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全文検索では、単語を効果的に検索できます。</font><font style="vertical-align: inherit;">さて、彼を助け、「不快」な数を事前に便利な言葉に分解しましょう。</font><font style="vertical-align: inherit;">行動計画は次のとおりです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特別に変換された数値が格納されるソーステーブルに列を追加します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリガーを追加します。番号を変更すると、スペースで区切られたいくつかの小さな部分に分割されます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文検索は、文字列をスペースで分割する方法をすでに知っているので、変更された番号を問題なくインデックス付けします</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがどのように機能するか見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルに列を追加します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function">alter table document <span class="hljs-keyword">add</span> number_parts <span class="hljs-title">nvarchar</span>(<span class="hljs-params"><span class="hljs-number">128</span></span>) not <span class="hljs-literal">null</span> <span class="hljs-keyword">default</span> ''</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい列を埋めるトリガーは、重複の可能性を無視して「額」と書くことができます（「triple0000012」の数に含まれるトリプルの数はいくつですか？）そして、XMLマジックを追加して、一意の部分のみを記録できます。最初の実装はより高速になり、2番目の実装はよりコンパクトな結果になります。実際、選択は書き込み速度と読み取り速度のどちらかであり、状況に応じてより重要なものを選択します。次に、</font><font style="vertical-align: inherit;">既存の数値を処理する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/su/yi/jhsuyix1k3vmyz-m4_2lit8mn0c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全文索引を追加</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function">create fulltext index <span class="hljs-keyword">on</span> <span class="hljs-title">document</span> (<span class="hljs-params">number_parts</span>)
key index ndx1
with change_tracking</span> = Auto</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして結果を確認してください。</font><font style="vertical-align: inherit;">実験は同じです。ドキュメントのリストから「ウィンドウ」の選択をモデル化します。</font><font style="vertical-align: inherit;">以前のエラーは繰り返さず、この場合は日付順にソートしてリクエストをすぐに実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2a/mc/aq/2amcaqolncb-oewf7l9dfivqstq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動作します！</font><font style="vertical-align: inherit;">それでは、より本物に近い数値を試してみましょう</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fe/a4/k9/fea4k9kc2isour1u-jkv5fla1pm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。そうすると、失火が起こります。</font><font style="vertical-align: inherit;">検索文字列の長さが、保存されている「単語」の長さより長くなっています。</font><font style="vertical-align: inherit;">実際、検索データベースには4文字の単一行がないため、正直に空の結果が返されます。</font><font style="vertical-align: inherit;">検索文字列を分割して分割する必要があります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0z/tv/sy/0ztvsyfiijs2wuzppnutvugt-dy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font><font style="vertical-align: inherit;">もう一度検索します。</font><font style="vertical-align: inherit;">はい、彼はメンテナンスにオーバーヘッドを課しますが、結果は従来の検索より数百倍高速です。</font><font style="vertical-align: inherit;">カウントされた試行に注意しますが、次のセクションで、なんとかしてメンテナンスを簡略化しようとします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分なりに言葉に分解していきます！</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、単語はスペースで区切るべきだと誰が言ったのですか？多分私は単語の間にゼロが欲しい！ （また、可能であれば、接頭辞も無視され、足元に干渉しないようにします）。一般的に、これには不可能なことは何もありません。記事の最初から全文検索の操作スキームを思い出してみましょう。別のコンポーネントであるワードブレーカーは、単語に分解する責任があります。幸いなことに、マイクロソフトでは独自の「ワードブレーカー」を実装できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここから興味深い始まりです。 Wordbreakerは、フルテキスト検索エンジンに接続する独立したdllです。で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このライブラリの作成は非常に簡単であると言われています-IWordBreakerインターフェイスを実装するだけです。そして、C ++の短い初期化リストをいくつか示します。非常に成功し、適切なチュートリアルを見つけました！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/48/vk/hh/48vkhhkmxbga2tnxudfiktk2c4k.png"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出典</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
真剣に、インターネット上で独自のワーブレーカーを作成するためのドキュメントは非常に小さいです。さらに少ない例とテンプレート。しかし</font><font style="vertical-align: inherit;">、C ++の実装を記述して、区切り文字ではなく、単にトリプルで単語を分解</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親切な</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プロジェクト</font></a><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">まだ見つかりまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">（そうです、前のセクションと同じように！）さらに、プロジェクトフォルダーには、丁寧にコンパイルされたバイナリがすでに含まれています。検索エンジンに接続します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
差し込むだけ...簡単ではありません。手順を見ていきましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリをSQL Serverのあるフォルダーにコピーする必要があります：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/oy/tj/wk/oytjwkzpv1b8mo6uvysgipl7fq0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全文検索で新しい「言語」を登録</font><font style="vertical-align: inherit;">します</font></font><br>
<br>
<pre><code class="cs hljs">exec master.dbo.xp_instance_regwrite  <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>, <span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span>, <span class="hljs-string">'DefaultData'</span>, <span class="hljs-string">'REG_SZ'</span>, <span class="hljs-string">'sqlngram.dll'</span>
exec master.dbo.xp_instance_regwrite  <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>, <span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\CLSID\{0a275611-aa4d-4b39-8290-4baf77703f55}'</span>, <span class="hljs-string">'DefaultData'</span>, <span class="hljs-string">'REG_SZ'</span>, <span class="hljs-string">'sqlngram.dll'</span>
exec master.dbo.xp_instance_regwrite  <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>, <span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span>, <span class="hljs-string">'Locale'</span>, <span class="hljs-string">'REG_DWORD'</span>, <span class="hljs-number">1</span>
exec master.dbo.xp_instance_regwrite  <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>, <span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span>, <span class="hljs-string">'WBreakerClass'</span>, <span class="hljs-string">'REG_SZ'</span>, <span class="hljs-string">'{d225281a-7ca9-4a46-ae7d-c63a9d4815d4}'</span>
exec master.dbo.xp_instance_regwrite  <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>, <span class="hljs-string">'SOFTWARE\Microsoft\MSSQLSERVER\MSSearch\Language\ngram'</span>, <span class="hljs-string">'StemmerClass'</span>, <span class="hljs-string">'REG_SZ'</span>, <span class="hljs-string">'{0a275611-aa4d-4b39-8290-4baf77703f55}'</span>
exec sp_fulltext_service <span class="hljs-string">'verify_signature'</span> , <span class="hljs-number">0</span>;<font></font>
exec sp_fulltext_service <span class="hljs-string">'update_languages'</span>;<font></font>
exec sp_fulltext_service <span class="hljs-string">'restart_all_fdhosts'</span>;<font></font>
exec sp_help_fulltext_system_components <span class="hljs-string">'wordbreaker'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レジストリのいくつかのキーを手動で編集します（作成者はプロセスを自動化する予定でしたが、2016年以降のニュースはありません。しかし、これはもともと「実装例」であり、そのおかげであり</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dx/yd/iq/dxydiqkbefi03iseanfv_tzfcii.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ました</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">手順はプロジェクトページで詳しく説明されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できました。</font><font style="vertical-align: inherit;">1つのテーブルに2つのフルテキストインデックスは存在できないため、古いフルテキストインデックスを削除してみましょう。</font><font style="vertical-align: inherit;">新しいものを作成し、ドキュメント番号にインデックスを付けます。</font><font style="vertical-align: inherit;">キー列として、数字自体を示しています。これ以上、事前に壊れたサロゲート列は必要ありません。</font><font style="vertical-align: inherit;">新しくインストールしたワードブレーカーを使用するには、必ず「言語番号1」を指定してください。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function">drop fulltext index <span class="hljs-keyword">on</span> document 
go

create fulltext index <span class="hljs-keyword">on</span> <span class="hljs-title">document</span> (<span class="hljs-params">number Language <span class="hljs-number">1</span></span>)
key index ndx1
with change_tracking</span> = Auto</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小切手？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1p/se/zz/1psezzovwm3mnoweyyfkpoo6o34.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動作します！上で説明したすべての例と同じくらい速く動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のオプションが失敗した長い行を確認してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iq/to/n8/iqton8zugajg5e85tcaieenab7k.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
検索はユーザーとプログラマーにとって透過的に機能します。ワードブレーカーは、検索文字列を個別に分割し、目的の結果を見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、列やトリガーを追加する必要がないことがわかりました。つまり、ソリューションは以前の試みよりも単純です（読み取り：信頼性が高い）。まあ、サポートの面では、そのような実装はより単純で透過的であり、エラーの可能性は低くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、やめて、「もっと信頼できる」と言ったの？サードパーティのライブラリをDBMSに接続しました！そして、彼女が倒れたらどうなりますか？誤ってデータベースサービス全体を引き出してしまいます！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、記事の冒頭で、DBMSのメインプロセスとは別に、フルテキスト検索サービスについて説明しました。</font><font style="vertical-align: inherit;">これがなぜ重要なのかが明らかになるのはここです。</font><font style="vertical-align: inherit;">ライブラリは、フルテキストインデックスサービスに接続します。このサービスは、制限された権限で動作できます。</font><font style="vertical-align: inherit;">さらに重要なのは、サードパーティのコンポーネントが機能しなくなった場合、インデックスサービスのみが機能しなくなることです。</font><font style="vertical-align: inherit;">検索はしばらく停止します（ただし、既に非同期です）。データベースエンジンは、何も起こらなかったかのように動作し続けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要約する。</font><font style="vertical-align: inherit;">独自のワードブレーカーを追加することは、かなり難しい場合があります。</font><font style="vertical-align: inherit;">しかし、「長い間」プレイする場合、これらの努力はより大きな柔軟性とメンテナンスの容易さをもたらします。</font><font style="vertical-align: inherit;">いつものように、選択はあなた次第です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜこれがすべて必要なのですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味津々の読者はおそらく何度も疑問に思いました。「これはすべて素晴らしいですが、アプリケーションから検索クエリを変更できない場合、これらの機能をどのように使用できますか？」合理的な質問。フルテキストのMS SQL検索を含めるには、クエリの構文を変更する必要があり、多くの場合、これは既存のアーキテクチャでは不可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のテーブルではなく、同じ名前のテーブル値関数を「スリップ」することで、アプリケーションをだまそうとすることができます。これにより、必要な検索がすでに実行されます。検索を一種の外部データソースとしてバインドしようとすることができます。別のソリューションがあります-Softpoint Data Cluster-ソースアプリケーションとSQL Serverサービス間の「転送」をインストールし、トラフィックをリッスンし、特別なルールに従って「オンザフライ」でリクエストを変更できる特別なサービスです。これらのルールを使用すると、LIKEを使用して通常のクエリを検索し、全文検索を使用してそれらをCONTAINSに変換できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜそのような困難なのか？</font><font style="vertical-align: inherit;">それでも、検索速度は魅力的です。</font><font style="vertical-align: inherit;">負荷の高いシステムでは、オペレーターが数百万のテーブルでレコードを検索することが多いため、応答速度は非常に重要です。</font><font style="vertical-align: inherit;">最も頻繁な操作で時間を節約すると、追加の処理済みアプリケーションが数十個も発生します。これは実際のお金であり、どのビジネスでも満足しています。</font><font style="vertical-align: inherit;">結局、技術を研究して実装するための数日または数週間でさえ、オペレーターの効率が向上することで報われるでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事で言及されているすべてのスクリプトは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">github.com / frrrost / mssql_fulltext</font></a><font style="vertical-align: inherit;">リポジトリで入手できます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">著者について</font></font></h2><br>
<img src="https://habrastorage.org/webt/xh/rm/q5/xhrmq5imxl5i7n9cp6lfjejy9w8.png" align="left" width="120"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexander Denisov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -MS SQL Serverデータベースパフォーマンスアナリスト。</font><font style="vertical-align: inherit;">過去6年間、Softpointチームの一員として、他のユーザーのリクエストのボトルネックを見つけ、クライアントのデータベースを最大限に活用するのを支援してきました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja470125/index.html">他人のコードを厳密に判断しないでください</a></li>
<li><a href="../ja470127/index.html">長期記憶が長い作曲家</a></li>
<li><a href="../ja470129/index.html">宣言的なメモリ管理</a></li>
<li><a href="../ja470133/index.html">Prometheusでの時間参照によって歪ま​​ないメトリックを収集する方法</a></li>
<li><a href="../ja470135/index.html">プログラミングなしのインタラクティブなWebアプリケーション？かんたん！腕の中のマヴォ</a></li>
<li><a href="../ja470145/index.html">「注意してください、FAS！」：軍事チケットが広告で危険なのはなぜですか、なぜ数学を理解することが重要であり、裸の真実が常に必要かどうか</a></li>
<li><a href="../ja470149/index.html">Javaには不変のコレクションはありません-今もこれまでも</a></li>
<li><a href="../ja470153/index.html">データモデルディクショナリ</a></li>
<li><a href="../ja470155/index.html">Особенности национального распознавания образов</a></li>
<li><a href="../ja470159/index.html">素数生成</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>