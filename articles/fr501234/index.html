<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌀 📱 👋🏽 Routage rapide et NAT sous Linux 👩🏾‍🤝‍👨🏼 🍥 🗺️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les adresses IPv4 étant épuisées, de nombreux opérateurs de télécommunications sont confrontés à la nécessité d'organiser l'accès de leurs clients au ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Routage rapide et NAT sous Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les adresses IPv4 étant épuisées, de nombreux opérateurs de télécommunications sont confrontés à la nécessité d'organiser l'accès de leurs clients au réseau à l'aide de la traduction d'adresses. </font><font style="vertical-align: inherit;">Dans cet article, je vais vous expliquer comment obtenir des performances de niveau NAT de niveau opérateur sur les serveurs de base.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu d'histoire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sujet de manquer d'espace d'adressage IPv4 n'est plus nouveau. À un moment donné, des listes d'attente sont apparues dans RIPE, puis il y a eu des échanges sur lesquels ils ont échangé des blocs d'adresses et conclu des transactions pour leur loyer. Progressivement, les opérateurs télécoms ont commencé à fournir des services d'accès à Internet par la traduction d'adresses et de ports. Quelqu'un n'a pas réussi à obtenir suffisamment d'adresses pour donner une adresse «blanche» à chaque abonné, tandis que quelqu'un a commencé à économiser de l'argent en refusant d'acheter des adresses sur le marché secondaire. Les fabricants d’équipements de réseau ont soutenu cette idée, cette fonctionnalité nécessite généralement des modules d'extension ou des licences supplémentaires. Par exemple, avec Juniper dans la gamme de routeurs MX (à l'exception des derniers MX104 et MX204), NAPT peut être exécuté sur une carte de service MS-MIC distincte, Cisco ASR1k nécessite une licence GN,sur Cisco ASR9k, un module A9K-ISM-100 distinct et une licence A9K-CGN-LIC. En général, le plaisir coûte cher.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tâche d'effectuer NAT ne nécessite pas de ressources informatiques spécialisées; les processeurs à usage général installés, par exemple, dans n'importe quel routeur domestique, peuvent le résoudre. </font><font style="vertical-align: inherit;">À l'échelle du transporteur, ce problème peut être résolu en utilisant des serveurs de base exécutant FreeBSD (ipfw / pf) ou GNU / Linux (iptables). </font><font style="vertical-align: inherit;">Nous ne considérerons pas FreeBSD, car </font><font style="vertical-align: inherit;">J'ai refusé d'utiliser ce système d'exploitation pendant longtemps, alors concentrons-nous sur GNU / Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Activer la traduction d'adresse n'est pas du tout difficile. </font><font style="vertical-align: inherit;">Vous devez d'abord écrire la règle dans iptables dans la table nat:</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le système d'exploitation chargera le module nf_conntrack, qui surveillera toutes les connexions actives et effectuera les conversions nécessaires. </font><font style="vertical-align: inherit;">Il existe plusieurs subtilités. </font><font style="vertical-align: inherit;">Tout d'abord, étant donné que nous parlons de NAT à l'échelle du transporteur, il est nécessaire de resserrer les délais d'attente, car avec les valeurs par défaut, la taille de la table de traduction passera rapidement à des valeurs catastrophiques. </font><font style="vertical-align: inherit;">Voici un exemple des paramètres que j'ai utilisés sur mes serveurs:</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et d'autre part, comme la taille par défaut de la table de traduction n'est pas conçue pour fonctionner dans les conditions d'un opérateur télécom, elle doit être augmentée:</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Il est également nécessaire d'augmenter le nombre de compartiments pour une table de hachage qui stocke toutes les traductions (c'est une option du module nf_conntrack): </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après ces manipulations simples, une construction entièrement fonctionnelle est obtenue, qui peut traduire un grand nombre d'adresses client en un pool externe. Cependant, les performances de cette solution sont médiocres. Lors de mes premières tentatives d'utilisation de GNU / Linux pour NAT (vers 2013), j'ai pu obtenir des performances d'environ 7 Gbit / s à 0,8 Mpps par serveur (Xeon E5-1650v2). Depuis ce temps, de nombreuses optimisations différentes ont été faites dans la pile réseau du noyau GNU / Linux, les performances d'un serveur sur le même matériel ont augmenté de près de 18 à 19 Gbit / s à 1,8-1,9 Mpps (ce sont les valeurs limites), mais le besoin de volume de trafic, traité par un seul serveur, a augmenté beaucoup plus rapidement. En conséquence, des schémas d'équilibrage de charge pour différents serveurs ont été développés, mais tout cela a accru la complexité de la configuration,entretenir et maintenir la qualité des services fournis.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nftables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De nos jours, l'utilisation de DPDK et XDP est une direction à la mode dans le «transfert de paquets» logiciel. </font><font style="vertical-align: inherit;">De nombreux articles ont été écrits sur ce sujet, de nombreuses présentations ont été faites, des produits commerciaux apparaissent (par exemple, SKAT de VasExperts). </font><font style="vertical-align: inherit;">Mais dans les conditions de ressources limitées des programmeurs des opérateurs de télécommunications, il est assez problématique de couper une sorte de «part» sur la base de ces cadres. </font><font style="vertical-align: inherit;">Faire fonctionner une telle solution à l'avenir sera beaucoup plus difficile, en particulier, il sera nécessaire de développer des outils de diagnostic. </font><font style="vertical-align: inherit;">Par exemple, un tcpdump standard avec DPDK ne fonctionne tout simplement pas, et il ne "verra" pas les paquets renvoyés aux câbles à l'aide de XDP. </font><font style="vertical-align: inherit;">Au milieu de toutes les discussions sur les nouvelles technologies de sortie du transfert de paquets vers l'espace utilisateur, les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapports</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et les </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">articles</font></a><font style="vertical-align: inherit;"> sont passés inaperçus</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pablo Neira Ayuso, mainteneur iptables, sur le développement du délestage de flux dans nftables. Examinons ce mécanisme plus en détail.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'idée principale est que si le routeur a transmis les paquets d'une session des deux côtés du flux (la session TCP est passée à l'état ESTABLISHED), il n'est pas nécessaire de passer les paquets suivants de cette session à travers toutes les règles de pare-feu, car toutes ces vérifications aboutiront toutes à la même fin en transférant le paquet vers le routage. Oui, et en fait, le choix de la route n'a pas besoin d'être effectué - nous savons déjà quelle interface et quel hôte doivent transmettre les paquets au cours de cette session. Il ne reste plus qu'à sauvegarder ces informations et à les utiliser pour le routage à un stade précoce du traitement des paquets. Lors de l'exécution du NAT, il est également nécessaire d'enregistrer des informations sur les changements d'adresses et de ports convertis par le module nf_conntrack. Oui, bien sûr, dans ce cas, divers polysers et autres règles d'information-statistique dans iptables cessent de fonctionner,mais dans le cadre de la tâche d'un NAT permanent séparé ou, par exemple, d'une frontière, ce n'est pas si important, car les services sont répartis sur plusieurs appareils.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour utiliser cette fonction, nous avons besoin de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisez un noyau frais. </font><font style="vertical-align: inherit;">Malgré le fait que la fonctionnalité elle-même soit apparue dans le noyau 4.16, pendant un certain temps, elle était très "brute" et régulièrement appelée panique du noyau. </font><font style="vertical-align: inherit;">Tout s'est stabilisé vers décembre 2019, lorsque les noyaux LTS 4.19.90 et 5.4.5 ont été publiés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réécrivez les règles iptables au format nftables en utilisant une version assez récente de nftables. </font><font style="vertical-align: inherit;">Fonctionne bien dans la version 0.9.0</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est clair en principe avec le premier paragraphe, l'essentiel est de ne pas oublier d'inclure le module dans la configuration lors du montage (CONFIG_NFT_FLOW_OFFLOAD = m), alors le deuxième paragraphe nécessite une explication. </font><font style="vertical-align: inherit;">Les règles de nftables sont décrites différemment de celles d'iptables. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> révèle presque tous les points, il existe également des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertisseurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de règles </font><font style="vertical-align: inherit;">spéciaux </font><font style="vertical-align: inherit;">d'iptables en nftables. </font><font style="vertical-align: inherit;">Par conséquent, je ne donnerai qu'un exemple de configuration de NAT et de déchargement de flux. </font><font style="vertical-align: inherit;">Une petite légende pour un exemple: &lt;i_if&gt;, &lt;o_if&gt; sont les interfaces réseau à travers lesquelles le trafic passe, en réalité il peut y en avoir plus de deux. </font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt;, &lt;pool_addr_end&gt; - l'adresse de début et de fin de la plage d'adresses "blanches". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuration NAT est très simple:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le déchargement de flux est un peu plus compliqué, mais compréhensible:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, c'est toute la configuration. </font><font style="vertical-align: inherit;">Maintenant, tout le trafic TCP / UDP ira à la table fastnat et sera traité beaucoup plus rapidement.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">résultats</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour préciser à quel point cela est «beaucoup plus rapide», je vais joindre une capture d'écran de la charge sur deux serveurs réels avec le même matériel (Xeon E5-1650v2), également configurés, utilisant le même noyau Linux, mais exécutant NAT dans iptables (NAT4) et dans nftables (NAT5). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de graphique de paquets par seconde dans la capture d'écran, mais dans le profil de charge de ces serveurs, la taille moyenne des paquets est d'environ 800 octets, donc les valeurs vont jusqu'à 1,5 Mpps. </font><font style="vertical-align: inherit;">Comme vous pouvez le voir, la marge de performance du serveur avec nftables est énorme. </font><font style="vertical-align: inherit;">Actuellement, ce serveur traite jusqu'à 30 Gbit / s à 3 Mpps et est clairement capable de fonctionner dans la limitation physique du réseau à 40 Gbit / s, tout en disposant de ressources CPU gratuites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que ce matériel sera utile aux ingénieurs réseau qui tentent d'améliorer les performances de leurs serveurs.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501220/index.html">Analyse: une entreprise peut-elle avoir trop d'argent?</a></li>
<li><a href="../fr501222/index.html">Application de COBIT lors de l'élaboration d'une stratégie informatique</a></li>
<li><a href="../fr501224/index.html">Quels réseaux de neurones peuvent «chanter» et interpréter le death metal</a></li>
<li><a href="../fr501226/index.html">Recherche rapide de fichiers</a></li>
<li><a href="../fr501232/index.html">Comment un expert informatique peut-il gagner plus sur ses connaissances</a></li>
<li><a href="../fr501236/index.html">Alors, de quoi s'agit-il, le «repliement des protéines»?</a></li>
<li><a href="../fr501240/index.html">Audit de sécurité du site</a></li>
<li><a href="../fr501244/index.html">Le programmeur n'a pas à résoudre les problèmes commerciaux</a></li>
<li><a href="../fr501246/index.html">Graphiques Covid-19 corrects</a></li>
<li><a href="../fr501248/index.html">Temple de la renommée du milieu de travail JavaScript, partie 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>