<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüíº üë®üèø üöï Gr√°ficos 3D en el STM32F103 üëåüèø üëßüèø üéüÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una breve historia sobre c√≥mo empujar lo no editable y mostrar gr√°ficos tridimensionales en tiempo real utilizando un controlador que no tiene velocid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gr√°ficos 3D en el STM32F103</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496046/"><img src="https://habrastorage.org/getpro/habr/post_images/7e5/cf8/e1c/7e5cf8e1c0fbc2ee47c87c71d72e865f.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una breve historia sobre c√≥mo empujar lo no editable y mostrar gr√°ficos tridimensionales en tiempo real utilizando un controlador que no tiene velocidad ni memoria para esto.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2017 (a juzgar por la fecha de modificaci√≥n del archivo), decid√≠ cambiar de controladores AVR a STM32 m√°s potentes. Naturalmente, el primer controlador fue el ampliamente publicitado F103. No es menos natural que se rechazara el uso de tableros de depuraci√≥n listos para usar a favor de la fabricaci√≥n de uno desde cero de acuerdo con sus requisitos. Por extra√±o que parezca, casi no hab√≠a jambas (excepto que UART1 deber√≠a llevarse a un conector normal, y no con muletas en el cableado).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparaci√≥n con AVR, las caracter√≠sticas de la piedra son bastante decentes: reloj de 72 MHz (en la pr√°ctica, puede overclockear a 100 MHz, o incluso m√°s, ¬°pero bajo su propio riesgo y riesgo!), 20 kB de RAM y 64 kB de flash. Adem√°s, una tonelada de perif√©ricos, cuando se usa, el problema principal es no tener miedo de esta abundancia y darse cuenta de que no es necesario palear los diez registros para comenzar, es suficiente establecer tres bits en los correctos. Al menos hasta que quieras algo extra√±o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la primera euforia de la posesi√≥n de tal poder pas√≥, surgi√≥ un deseo de sondear sus l√≠mites. Como ejemplo efectivo, eleg√≠ el c√°lculo de gr√°ficos tridimensionales con todas estas matrices, iluminaci√≥n, modelos poligonales y un buffer Z con una pantalla de 320x240 en el controlador ili9341. Los dos problemas m√°s obvios a resolver son la velocidad y el volumen. Un tama√±o de pantalla de 320x240 a 16 bits por color proporciona 150 kB por fotograma. Pero la RAM total que tenemos es de solo 20 kB ... Y estos 150 kB deben transferirse a la pantalla al menos 10 veces por segundo, es decir, el tipo de cambio debe ser de al menos 1.5 MB / so 12 MB / s, que ya parece una carga significativa en el n√∫cleo. Afortunadamente, en este controlador hay un m√≥dulo RAP (acceso directo a memoria, tambi√©n conocido como Acceso directo a memoria, DMA), que permite no cargar el n√∫cleo con operaciones de transfusi√≥n de vac√≠o a vac√≠o.Es decir, puede preparar el b√∫fer, decirle al m√≥dulo "¬°aqu√≠ tiene el b√∫fer de datos, funciona!", Y en este momento preparar los datos para la pr√≥xima transferencia. Y teniendo en cuenta la capacidad de la pantalla para recibir datos en una secuencia, emerge el siguiente algoritmo: se resalta el b√∫fer frontal, desde el cual el DMA transfiere datos a la pantalla, el b√∫fer posterior en el que se realiza el renderizado y el b√∫fer Z utilizado para cortar en profundidad. Los buffers son una sola fila (o columna, lo que sea) de la pantalla. Y en lugar de 150 kB, solo necesitamos 1920 bytes (320 p√≠xeles por l√≠nea * 3 buffers * 2 bytes por punto), que se adapta perfectamente a la memoria. El segundo truco se basa en el hecho de que el c√°lculo de las matrices de transformaci√≥n y las coordenadas de los v√©rtices no se pueden realizar para cada fila, de lo contrario, la imagen se distorsionar√° de las formas m√°s extra√±as y su velocidad es desventajosa. En cambio, los c√°lculos "externos",es decir, la multiplicaci√≥n de las matrices de transformaci√≥n y su aplicaci√≥n a los v√©rtices se recalcula en cada cuadro, y luego se convierte en una representaci√≥n intermedia, que est√° optimizada para renderizarse en una imagen de 320x1.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por razones de gamberros, la biblioteca se parecer√° a OpenGL desde el exterior. Al igual que en OpenGL original, el renderizado comienza con la formaci√≥n de la matriz de transformaci√≥n: al borrar glLoadIdentity () se crea la unidad de matriz actual, luego un conjunto de transformaciones glRotateXY (...), glTranslate (...), cada una de las cuales se multiplica por la matriz actual. Dado que estos c√°lculos se realizar√°n solo una vez por cuadro, no hay requisitos especiales para la velocidad, puede hacerlo con flotadores simples, sin perversiones con n√∫meros de punto fijo. La matriz en s√≠ es una matriz de flotante [4] [4], asignada a una matriz unidimensional de flotante [16]; de hecho, este m√©todo generalmente se usa para matrices din√°micas, pero tambi√©n puede obtener un peque√±o beneficio de las matrices est√°ticas. Otro truco est√°ndar: en lugar de calcular constantemente senos y cosenos, que son muchos en las matrices de rotaci√≥n,cuente de antemano y escr√≠balos en la tableta. Para hacer esto, divida el c√≠rculo completo en 256 partes, calcule el valor del seno para cada uno y vu√©lvalo a la matriz sin_table []. Bueno, cualquiera de la escuela puede obtener el coseno del seno. Vale la pena se√±alar que las funciones de rotaci√≥n toman un √°ngulo no en radianes, sino en fracciones de una revoluci√≥n completa, despu√©s de la reducci√≥n al rango [0 ... 255]. Sin embargo, se han implementado funciones "honestas" que realizan la conversi√≥n de √°ngulo a l√≥bulos debajo del cap√≥.realizando conversi√≥n de √°ngulo a l√≥bulos debajo del cap√≥.realizando conversi√≥n de √°ngulo a l√≥bulos debajo del cap√≥.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la matriz est√° lista, puede comenzar a dibujar las primitivas. En general, en los gr√°ficos tridimensionales hay tres tipos de primitivas: un punto, una l√≠nea y un tri√°ngulo. Pero si nos interesan los modelos poligonales, solo se debe prestar atenci√≥n al tri√°ngulo. Su "representaci√≥n" se produce en la funci√≥n glDrawTriangle () o glDrawTriangleV (). La palabra "renderizado" est√° entre comillas porque no se produce renderizado en esta etapa. Simplemente multiplicamos todos los puntos de la primitiva por la matriz de transformaci√≥n, y luego extraemos de ellos las f√≥rmulas anal√≠ticas de los bordes y = ky * x + por, que nos permiten encontrar las intersecciones de los tres bordes del tri√°ngulo con la l√≠nea de salida actual. Descartamos uno de ellos, ya que no se encuentra en el intervalo entre los v√©rtices, sino en su continuaci√≥n.Es decir, para dibujar un marco, solo necesita pasar por todas las l√≠neas y para cada pintura el √°rea entre los puntos de intersecci√≥n. Pero si aplica este algoritmo "de frente", cada primitiva se superpondr√° a las que se dibujaron anteriormente. Necesitamos considerar la coordenada Z (profundidad) para que los tri√°ngulos se crucen bellamente. En lugar de simplemente imprimir punto por punto, consideraremos su coordenada Z y, en comparaci√≥n con la coordenada Z almacenada en el b√∫fer de profundidad, la salida (actualizando el b√∫fer Z) o la ignoraremos. Y para calcular la coordenada Z de cada punto de la l√≠nea que nos interesa, usamos la misma f√≥rmula de l√≠nea recta z = kz * y + bz calculada por los mismos dos puntos de intersecci√≥n con aristas. Como resultado, el objeto de la estructura triangular "semi-terminada" glTriangle consiste en tres coordenadas X de los v√©rtices (no tiene sentido almacenar las coordenadas Y y Z, se calcular√°n) y k,b coeficientes directos, bueno, color al mont√≥n. Aqu√≠, en contraste con el c√°lculo de las matrices de transformaci√≥n, la velocidad es cr√≠tica, por lo que ya usamos n√∫meros de punto fijo. Adem√°s, si para el t√©rmino b, la misma precisi√≥n es suficiente para las coordenadas (2 bytes), entonces la precisi√≥n del factor k, cuanto mayor sea mejor, entonces tomamos 4 bytes. Pero no es flotante, ya que trabajar con enteros es a√∫n m√°s r√°pido, incluso con el mismo tama√±o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, al llamar a un mont√≥n de glDrawTriangle (), preparamos una serie de tri√°ngulos semiacabados. En mi implementaci√≥n, los tri√°ngulos se deducen uno a la vez mediante llamadas a funciones expl√≠citas. De hecho, ser√≠a l√≥gico tener una matriz de tri√°ngulos con las direcciones de los v√©rtices, pero aqu√≠ decid√≠ no complicarme. De todos modos, la funci√≥n de representaci√≥n est√° escrita por robots, y no les importa si deben completar una matriz constante o escribir trescientas llamadas id√©nticas. Es hora de traducir los productos semiacabados de los tri√°ngulos en una hermosa imagen en la pantalla. Para hacer esto, se llama a la funci√≥n glSwapBuffers (). Como se describi√≥ anteriormente, recorre las l√≠neas de la pantalla, busca cada punto de intersecci√≥n con todos los tri√°ngulos y dibuja segmentos de acuerdo con el filtrado por profundidad. Despu√©s de representar cada l√≠nea, debe enviar esta l√≠nea a la pantalla. Para hacer esto, se inicia DMA, que indica la direcci√≥n de la cadena y su tama√±o.Mientras tanto, DMA funciona, puede cambiar a otro b√∫fer y representar la siguiente l√≠nea. Lo principal es no olvidarse de esperar el final de la transferencia si de repente termin√≥ de renderizar antes. Para visualizar la relaci√≥n de velocidades, agregu√© la inclusi√≥n de un LED rojo despu√©s del final del renderizado y apagado despu√©s de completar la espera DMA. Resulta algo as√≠ como PWM, que ajusta el brillo en funci√≥n de la latencia. Te√≥ricamente, en lugar de una espera "tonta", se podr√≠an usar interrupciones de DMA, pero luego no podr√≠a usarlas, y el algoritmo se habr√≠a vuelto mucho m√°s complicado. Para un programa de demostraci√≥n, esto es redundante.Para visualizar la relaci√≥n de velocidades, agregu√© la inclusi√≥n de un LED rojo despu√©s del final del renderizado y apagado despu√©s de completar la espera DMA. Resulta algo as√≠ como PWM, que ajusta el brillo en funci√≥n de la latencia. Te√≥ricamente, en lugar de una espera "tonta", se podr√≠an usar interrupciones de DMA, pero luego no podr√≠a usarlas, y el algoritmo se habr√≠a vuelto mucho m√°s complicado. Para un programa de demostraci√≥n, esto es redundante.Para visualizar la relaci√≥n de velocidades, agregu√© la inclusi√≥n de un LED rojo despu√©s del final del renderizado y apagado despu√©s de completar la espera DMA. Resulta algo as√≠ como PWM, que ajusta el brillo en funci√≥n de la latencia. Te√≥ricamente, en lugar de una espera "tonta", podr√≠an usarse interrupciones de DMA, pero luego no podr√≠a usarlas, y el algoritmo se habr√≠a vuelto mucho m√°s complicado. Para un programa de demostraci√≥n, esto es redundante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado de los procedimientos anteriores fue una imagen giratoria de tres planos de intersecci√≥n de diferentes colores, y con una velocidad bastante decente: el brillo del LED rojo es bastante alto, lo que indica un gran margen en el rendimiento del kernel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, si el n√∫cleo est√° inactivo, debe cargarlo. Y lo cargaremos con mejores modelos. Sin embargo, no olvide que la memoria sigue siendo muy limitada, por lo que el controlador no extraer√° demasiados pol√≠gonos f√≠sicamente. El c√°lculo m√°s simple mostr√≥ que despu√©s de restar la memoria en el b√∫fer de l√≠nea y similares, hab√≠a un lugar para 378 tri√°ngulos. Como la pr√°ctica ha demostrado, los modelos del antiguo pero interesante juego g√≥tico son perfectos para este tama√±o. En realidad, los modelos de una serpiente y una mosca de sangre fueron sacados de all√≠ (y ya al momento de escribir este art√≠culo y un glocoor, haciendo alarde de KDPV), despu√©s de lo cual el controlador se qued√≥ sin memoria flash. Pero los modelos de juegos no est√°n destinados a ser utilizados por un microcontrolador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que contienen animaci√≥n, texturas y similares, lo que no nos es √∫til y no cabe en la memoria. Afortunadamente, blender permite no solo guardarlos en * .obj, que es m√°s f√°cil de analizar, sino tambi√©n reducir la cantidad de pol√≠gonos si es necesario. Adem√°s, con la ayuda de un simple programa auto-escrito obj2arr * .obj, los archivos se ordenan en coordenadas, a partir de las cuales se forma un archivo * .h para su inclusi√≥n directa en el firmware.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero por ahora, los modelos se ven como simples manchas rizadas. En el modelo de prueba, esto no nos molest√≥, ya que todas las caras fueron pintadas en sus propios colores, pero no prescriben los mismos colores a cada pol√≠gono del modelo. No, por supuesto, puedes pintar una mosca en colores aleatorios, pero comprob√© que se ver√° bastante inesperadamente. Especialmente cuando los colores tambi√©n cambian en cada cuadro ... En su lugar, aplique otra gota de magia vectorial y agregue iluminaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√°lculo de la iluminaci√≥n en su versi√≥n primitiva consiste en calcular el producto escalar de la normalidad y la direcci√≥n de la fuente de luz, seguido de la multiplicaci√≥n por el color "nativo" de la cara.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos tres modelos: dos del juego y una prueba, desde la que comenzamos. Para cambiarlos, utilizaremos uno de los dos botones soldados en el tablero. Al mismo tiempo, puede agregar control sobre el procesador. Ya tenemos un control: un LED rojo asociado con la latencia DMA. Y el segundo LED verde parpadear√° con cada actualizaci√≥n de cuadro, para poder estimar la velocidad de cuadro. A simple vista, era de unos 15 fps.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/afyTgpuA6sc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, estoy satisfecho con el resultado: es bueno implementar algo que es fundamentalmente imposible de resolver de frente. </font><font style="vertical-align: inherit;">Por supuesto, todav√≠a hay mucho para optimizar y mejorar, pero no tiene mucho sentido. </font><font style="vertical-align: inherit;">Objetivamente, el controlador para gr√°ficos tridimensionales es d√©bil y ni siquiera se trata de velocidad, sino de RAM. </font><font style="vertical-align: inherit;">Sin embargo, como cualquier muestra de demoscene, este proyecto es valioso no por el resultado, sino por el proceso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si alguien est√° interesado de repente, el c√≥digo fuente est√° disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496036/index.html">C√≥digo abierto: infraestructura de prueba de CI / CD y Avito para Android</a></li>
<li><a href="../es496038/index.html">Bilirrubina: la mol√©cula responsable de la ictericia</a></li>
<li><a href="../es496040/index.html">10 Lifehacks Zen</a></li>
<li><a href="../es496042/index.html">Habr, no te informar√© de errores en tu sitio</a></li>
<li><a href="../es496044/index.html">Lanzamiento de naves espaciales y ... clima en las regiones</a></li>
<li><a href="../es496050/index.html">Tigres y leones contraen coronavirus en Nueva York</a></li>
<li><a href="../es496052/index.html">¬øC√≥mo puede una empresa de servicios evitar multas de un cliente? Un par de ventajas obvias de la automatizaci√≥n de procesos.</a></li>
<li><a href="../es496056/index.html">Digital: c√≥mo nos enga√±an los n√∫meros y los t√©rminos</a></li>
<li><a href="../es496058/index.html">¬øPor qu√© es necesario usar cosechadoras agr√≠colas rob√≥ticas, cu√°les son las dificultades y c√≥mo lo hicimos en dos a√±os?</a></li>
<li><a href="../es496080/index.html">Crear interacciones simples de IA con objetos del entorno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>