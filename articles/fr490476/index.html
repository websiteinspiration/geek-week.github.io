<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèø üßíüèΩ üëú Capteur sans fil pour l'ouverture et la fermeture avec des fonctionnalit√©s avanc√©es üòâ üßòüèæ üêµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je souhaite la bienvenue √† tous les lecteurs de Habr et surtout aux lecteurs de la rubrique "DIY or Do it yourself"! Et si je ne peux pas trouver quel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Capteur sans fil pour l'ouverture et la fermeture avec des fonctionnalit√©s avanc√©es</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490476/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je souhaite la bienvenue √† tous les lecteurs de Habr et surtout aux lecteurs de la rubrique "DIY or Do it yourself"! Et si je ne peux pas trouver quelque chose comme √ßa, je suis un Arduino, je peux ... Je ne touche pas au sujet principal de la gestion des cabines d'ascenseurs :). Apr√®s r√©flexion, pour une raison quelconque, je voulais faire un capteur d'ouverture et de fermeture. Ce capteur, comme le reste de mon m√©tier que je fais r√©cemment, est bas√© sur des puces de Nordic Semiconductor. Le capteur a d√©cid√© de le faire en deux versions, une sur la puce nRF52840, et la seconde sur la puce nRF52811.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zu/u9/48/zuu948wn8duosrmce4hvtao1une.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les versions, le module de puce nRF52840 a √©t√© utilis√© E73_2G4M08S1C soci√©t√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EBYTE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pour le module de puce verciya nRF52811 MC50SFA soci√©t√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MiNEW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Franchement, la recherche de puces nRF52811 abordables √©tait encore une aventure. </font><font style="vertical-align: inherit;">Mais √† la suite de cette aventure dans l'appareil, le module sur la puce nRF52811 de MINEW et les brioches sous la forme de plusieurs versions des puces soud√©es √† ces modules sont nRF52810 et nRF52832. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cn/yx/4l/cnyx4lcnu6q_isgpvrszxy7c9wy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonctionnalit√© principale de l'appareil est la d√©tection d'ouverture et de fermeture sur la base d'un interrupteur √† lames. </font><font style="vertical-align: inherit;">Le circuit du commutateur √† lames est re-phas√© avec anti-rebond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sch√©ma:</font></font><br>
<img src="https://habrastorage.org/webt/o7/io/x-/o7iox-c4oobmvx6zldll_m1vowu.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sch√©ma Arduino :)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/j4/au/cy/j4aucyctci1fdwtfdkbiz_exsyi.png"><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√©fl√©chissant √† ce qu'il conviendrait de diluer la fonctionnalit√© principale de ce capteur d'ouverture et de fermeture, j'ai d√©cid√© de voir ce qu'il y a sur le march√© √† ce sujet. Comme il s'est av√©r√© presque rien, le capteur d'ouverture et de fermeture est √©galement en Afrique le capteur d'ouverture et de fermeture. La solution la plus ¬´avanc√©e¬ª a √©t√© trouv√©e chez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REDMOND</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans leur capteur BLE (d'ailleurs, √©galement sur une puce nordique), en plus du commutateur √† lames, il y a un capteur de temp√©rature et un bouton capacitif impl√©ment√© sur la puce TTP223. Mais pour une raison quelconque, cela ne m'a pas sembl√© √™tre une bonne solution, pourquoi les lectures de temp√©rature pr√®s de la porte ou de la fen√™tre sont utiles (et ce qui a emp√™ch√© qu'elles soient mesur√©es par une puce) et dans quelles situations il convient d'utiliser le bouton du capteur accroch√© √† la fen√™tre ou √† la porte (enfin, sauf peut-√™tre l'entr√©e :)). En cons√©quence, j'ai d√©cid√© d'√©tendre les fonctions de s√©curit√© de mon capteur.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/7v/y7/fn7vy79b2eivip0yber_90a_zew.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le crit√®re de s√©lection principal √©tait la consommation de capteurs suppl√©mentaires, car il a √©t√© d√©cid√© d'utiliser une pile CR2032 dans ce capteur. Les gagnants parmi les candidats √©taient deux capteurs, l'acc√©l√©rom√®tre LIS2DW12 et le capteur de champ magn√©tique DRV5032FB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LIS2DW12 est actuellement probablement l'acc√©l√©rom√®tre le plus √©conomique. En mode basse consommation, cet acc√©l√©rom√®tre consomme 1 ŒºA ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fiche technique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Le capteur de champ magn√©tique DRV5032FB a √©galement montr√© d'excellentes caract√©ristiques de consommation. Sa consommation est d'environ 500nA ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fiche technique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'acc√©l√©rom√®tre a √©t√© d√©cid√© d'√™tre utilis√© en mode capteur de choc, et le capteur de champ magn√©tique pour sa destination. Si j'√©tais calme sur la fonctionnalit√© du capteur de choc, l'utilisation d'un capteur de champ magn√©tique est toujours une solution hautement exp√©rimentale, mais c'est mieux qu'un capteur de temp√©rature.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ni/64/sini6468k7gc4btzzjjwcaco8y8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La partie logicielle du projet a √©t√© r√©alis√©e pour faire fonctionner le capteur dans le r√©seau Maysensors. Au moins pour l'instant. Meisensors dans la variante de travail sur les puces nordiques (nRF24 (+ atmega 328, stm32f1), nRF51 et nRF52) au niveau inf√©rieur utilise le protocole propri√©taire nordique - Enhanced ShockBurst (ESB), garantissant ainsi la compatibilit√© des appareils sur nRF24 et nRF51-52. Maysensors est un projet Arduino ouvert autour duquel une communaut√© assez importante s'est d√©j√† form√©e dans de nombreux pays du monde. Mais les bonnes solutions sur les puces nRF52 sont qu'il n'est pas n√©cessaire d'utiliser des Maysensors (ESB). Il suffit de remplacer simplement le logiciel bas√© sur le protocole Zigbee ou BLE, car les puces sont multi-protocoles. ... En ce qui concerne le BLE, je m'√©loigne un peu, regardez ce qu'un magnifique Arduino NANO 33 Ble peut √™tre fabriqu√© √† partir du module E73_2G4M08S1C,le co√ªt de mon NANO 33 est de 4 $.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/8f/vh/ot8fvhkkqsnzw_vhcqy7rubbgg0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'esquisse du capteur a √©t√© r√©alis√©e en Arduino. L'IDE de biblioth√®ques suppl√©mentaires a √©t√© utilis√©e pour la biblioth√®que de l'acc√©l√©rom√®tre LIS2DW12, un peu modifi√©e par moi dans la partie des r√©glages par d√©faut des registres, dans ma version √ßa marche imm√©diatement avec les r√©glages de la version la plus basse de la consommation d'√©nergie ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disponible sur mon git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je d√©crirai la logique du programme. Dans le mode de fonctionnement principal, le capteur est dans un r√™ve avec des interruptions externes configur√©es, seulement 4 interruptions. Il existe deux configurations d'interruptions: les configurations reconfigurent les interruptions pendant le fonctionnement du programme, en fonction de l'√©tat du commutateur √† lames. Si la porte est ouverte, les interruptions du capteur de choc et du capteur de champ magn√©tique sont d√©sactiv√©es. D√®s que la porte se ferme, des interruptions pour deux de ces capteurs sont activ√©es. J'ai √©galement rencontr√© le fait que lors de l'ouverture, il y avait des situations o√π le capteur de choc √©tait d√©clench√© avant l'interrupteur √† lames, il provenait de vibrations lors de l'ouverture de la serrure. Ce probl√®me n'a √©t√© enregistr√© qu'avec la sensibilit√© √©lev√©e configur√©e de l'acc√©l√©rom√®tre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour √©liminer ce probl√®me, une attente de 2 secondes a √©t√© introduite lors du d√©clenchement de l'acc√©l√©rom√®tre, pendant laquelle la broche du commutateur √† lames est surveill√©e. Si pendant l'attente, un changement de niveau se produit sur la broche du commutateur √† lames, alors le traitement suppl√©mentaire de l'√©v√©nement par interruption de l'acc√©l√©rom√®tre s'arr√™te et le traitement de l'√©v√©nement √† partir du commutateur √† lames commence.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le capteur a un mode de configuration. Lorsque le bouton de service est enfonc√©, le capteur se r√©veille en cas d'interruption, le module radio passe en mode d'√©coute et attend les commandes entrantes du contr√¥leur UD. Si une commande est re√ßue, le capteur √©crit une nouvelle valeur dans la m√©moire et passe imm√©diatement en mode de fonctionnement en se mettant en veille. Pour envoyer la commande suivante, l'activation du mode de configuration doit √™tre r√©p√©t√©e. Si en mode configuration, le capteur ne re√ßoit rien dans les 30 secondes, il passe √©galement en mode de fonctionnement apr√®s cette heure et se met en veille. En plus du mode de configuration, √† partir du bouton de service, vous pouvez d√©marrer la pr√©sentation des capteurs du capteur et r√©initialiser les param√®tres d'usine (le capteur oublie le r√©seau auquel il a √©t√© ajout√©, l'enregistrement du capteur apr√®s la r√©initialisation doit √™tre refait).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jn/1f/j3/jn1fj3ih6xil_iyk_c5abhzmg8q.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/u-/bt/gd/u-btgdierfsy0aqpvt2yhmimjic.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/gk/mr/ml/gkmrmlazpn6iwyxujq_82tk0ipc.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/do/en/m6/doenm6q7xz4ri8cxv57gipihkbq.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/er/x9/wu/erx9wumdn9jpozoie_o20c_kmqe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour programmer le capteur dans Arduino IDE, vous devez ajouter la prise en charge des cartes suivantes: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sandeepmistry / arduino-nRF5 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysensors / ArduinoBoards</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Libraries: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mysensor </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LIS2DW12</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Programmer: st-link, j-link.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programme de croquis</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> configMode = <span class="hljs-number">0</span>;
<span class="hljs-keyword">int8_t</span> int_status = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> door_status = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> check;
<span class="hljs-keyword">bool</span> magnet_status = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> nosleep = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> button_flag = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> onoff = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> flag_update_transport_param;
<span class="hljs-keyword">bool</span> flag_sendRoute_parent;
<span class="hljs-keyword">bool</span> flag_no_present;
<span class="hljs-keyword">bool</span> flag_nogateway_mode;
<span class="hljs-keyword">bool</span> flag_find_parent_process;
<span class="hljs-keyword">bool</span> flag_fcount;
<span class="hljs-keyword">bool</span> Ack_TL;
<span class="hljs-keyword">bool</span> Ack_FP;
<span class="hljs-keyword">bool</span> PRESENT_ACK;
<span class="hljs-keyword">bool</span> send_a;
<span class="hljs-keyword">bool</span> batt_flag;<font></font>
byte conf_vibro_set = <span class="hljs-number">2</span>;<font></font>
byte err_delivery_beat;<font></font>
byte problem_mode_count;<font></font>
<span class="hljs-keyword">uint8_t</span>  countbatt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> batt_cap;
<span class="hljs-keyword">uint8_t</span> old_batt_cap = <span class="hljs-number">100</span>;
<span class="hljs-keyword">uint32_t</span> BATT_TIME;
<span class="hljs-keyword">uint32_t</span> SLEEP_TIME = <span class="hljs-number">10800000</span>;
<span class="hljs-keyword">uint32_t</span> SLEEP_NOGW = <span class="hljs-number">60000</span>;
<span class="hljs-keyword">uint32_t</span> oldmillis;
<span class="hljs-keyword">uint32_t</span> newmillis;
<span class="hljs-keyword">uint32_t</span> previousMillis;
<span class="hljs-keyword">uint32_t</span> lightMillisR;
<span class="hljs-keyword">uint32_t</span> configMillis;
<span class="hljs-keyword">uint32_t</span> interrupt_time;
<span class="hljs-keyword">uint32_t</span> SLEEP_TIME_W;
<span class="hljs-keyword">uint32_t</span> axel_time;
<span class="hljs-keyword">uint32_t</span> axel_time0;
<span class="hljs-keyword">int16_t</span> myid;
<span class="hljs-keyword">int16_t</span> mypar;
<span class="hljs-keyword">int16_t</span> old_mypar = <span class="hljs-number">-1</span>;
<span class="hljs-keyword">bool</span> vibro = <span class="hljs-number">1</span>;
<span class="hljs-keyword">uint32_t</span> PIN_BUTTON_MASK;
<span class="hljs-keyword">uint32_t</span> AXEL_INT_MASK;
<span class="hljs-keyword">uint32_t</span> GERKON_INT_MASK;
<span class="hljs-keyword">uint32_t</span> MAGNET_INT_MASK;
<span class="hljs-keyword">float</span> ODR_1Hz6_LP_ONLY = <span class="hljs-number">1.6f</span>;
<span class="hljs-keyword">float</span> ODR_12Hz5 = <span class="hljs-number">12.5f</span>;
<span class="hljs-keyword">float</span> ODR_25Hz = <span class="hljs-number">25.0f</span>;
<span class="hljs-keyword">float</span> ODR_50Hz = <span class="hljs-number">50.0f</span>;
<span class="hljs-keyword">float</span> ODR_100Hz = <span class="hljs-number">100.0f</span>;
<span class="hljs-keyword">float</span> ODR_200Hz = <span class="hljs-number">200.0f</span>;
<span class="hljs-keyword">volatile</span> byte axelIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte gerkIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte magIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte buttIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint16_t</span> batteryVoltage;
<span class="hljs-keyword">int16_t</span> linkQuality;
<span class="hljs-keyword">int16_t</span> old_linkQuality;<font></font>
<font></font>
<span class="hljs-comment">//#define MY_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> MY_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_DISABLED_SERIAL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_RADIO_NRF5_ESB</span>
<span class="hljs-keyword">int16_t</span> mtwr;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_TRANSPORT_WAIT_READY_MS (mtwr)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_NRF5_ESB_PA_LEVEL (NRF5_PA_MAX)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;MySensors.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"app_gpiote.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"nrf_gpio.h"</span></span><font></font>
}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> APP_GPIOTE_MAX_USERS 1</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">app_gpiote_user_id_t</span> m_gpiote_user_id;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;LIS2DW12Sensor.h&gt;</span></span><font></font>
LIS2DW12Sensor *lis2;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DWS_CHILD_ID 0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> V_SENS_CHILD_ID 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> M_CHILD_ID 2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEVEL_SENSIV_V_SENS_CHILD_ID 230</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIGNAL_Q_ID 250</span><font></font>
<font></font>
<span class="hljs-function">MyMessage <span class="hljs-title">dwsMsg</span><span class="hljs-params">(DWS_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">mMsg</span><span class="hljs-params">(M_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">vibroMsg</span><span class="hljs-params">(V_SENS_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">conf_vsensMsg</span><span class="hljs-params">(LEVEL_SENSIV_V_SENS_CHILD_ID, V_VAR1)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SN <span class="hljs-meta-string">"DOOR &amp; WINDOW SENS"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SV <span class="hljs-meta-string">"1.12"</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">()</span> </span>{<font></font>
  board_Init();<font></font>
  happy_init();<font></font>
  delay(<span class="hljs-number">500</span>);<font></font>
  batteryVoltage = hwCPUVoltage();<font></font>
  digitalWrite(BLUE_LED, LOW);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">presentation</span><span class="hljs-params">()</span>
</span>{<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">10</span>);<font></font>
<font></font>
  check = sendSketchInfo(SN, SV);<font></font>
  wait(<span class="hljs-number">30</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">30</span>);<font></font>
    check = sendSketchInfo(SN, SV);<font></font>
    wait(<span class="hljs-number">30</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(DWS_CHILD_ID, S_DOOR, <span class="hljs-string">"STATUS RS SENS"</span>);<font></font>
  wait(<span class="hljs-number">40</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">40</span>);<font></font>
    check = present(DWS_CHILD_ID, S_DOOR, <span class="hljs-string">"STATUS RS SENS"</span>);<font></font>
    wait(<span class="hljs-number">40</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(V_SENS_CHILD_ID, S_VIBRATION, <span class="hljs-string">"STATUS SHOCK SENS"</span>);<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    check = present(V_SENS_CHILD_ID, S_VIBRATION, <span class="hljs-string">"STATUS SHOCK SENS"</span>);<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(M_CHILD_ID, S_DOOR, <span class="hljs-string">"ANTI-MAGNET ALARM"</span>);<font></font>
  wait(<span class="hljs-number">60</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">60</span>);<font></font>
    check = present(M_CHILD_ID, S_DOOR, <span class="hljs-string">"ANTI-MAGNET ALARM"</span>);<font></font>
    wait(<span class="hljs-number">60</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(SIGNAL_Q_ID, S_CUSTOM, <span class="hljs-string">"SIGNAL %"</span>);<font></font>
  wait(<span class="hljs-number">70</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">70</span>);<font></font>
    check = present(SIGNAL_Q_ID, S_CUSTOM, <span class="hljs-string">"SIGNAL %"</span>);<font></font>
    wait(<span class="hljs-number">70</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(LEVEL_SENSIV_V_SENS_CHILD_ID, S_CUSTOM, <span class="hljs-string">"SENS LEVEL VIBRO"</span>);<font></font>
  wait(<span class="hljs-number">80</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">80</span>);<font></font>
    check = present(LEVEL_SENSIV_V_SENS_CHILD_ID, S_CUSTOM, <span class="hljs-string">"SENS LEVEL VIBRO"</span>);<font></font>
    wait(<span class="hljs-number">80</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
  wait(<span class="hljs-number">90</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">90</span>);<font></font>
    check = send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
    wait(<span class="hljs-number">90</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">10</span>);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
  digitalWrite(BLUE_LED, HIGH);<font></font>
  config_Happy_node();<font></font>
  sensors_Init();<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (flag_update_transport_param == <span class="hljs-number">1</span>) {<font></font>
    update_Happy_transport();<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (flag_sendRoute_parent == <span class="hljs-number">1</span>) {<font></font>
    present_only_parent();<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (flag_find_parent_process == <span class="hljs-number">1</span>) {<font></font>
        find_parent_process();<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (configMode == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((axelIntStatus == AXEL_INT) || (buttIntStatus == PIN_BUTTON) || (gerkIntStatus == GERKON_INT) || (magIntStatus == MAGNET_INT)) {<font></font>
          nosleep = <span class="hljs-number">1</span>;<font></font>
          newmillis = millis();<font></font>
          interrupt_time = newmillis - oldmillis;<font></font>
          BATT_TIME = BATT_TIME - interrupt_time;<font></font>
          <span class="hljs-keyword">if</span> (BATT_TIME &lt; <span class="hljs-number">60000</span>) {<font></font>
            BATT_TIME = SLEEP_TIME;<font></font>
            batteryVoltage = hwCPUVoltage();<font></font>
            batt_flag = <span class="hljs-number">1</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (gerkIntStatus == GERKON_INT) {<font></font>
            send_Gerkon();<font></font>
            axel_time = millis();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (magIntStatus == MAGNET_INT) {<font></font>
            send_Magnet();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (axelIntStatus == AXEL_INT) {
            <span class="hljs-keyword">if</span> (millis() - axel_time0 &gt;= <span class="hljs-number">2000</span>) {<font></font>
              send_Axel();<font></font>
              nosleep = <span class="hljs-number">0</span>;<font></font>
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == LOW) {<font></font>
                send_Gerkon();<font></font>
                axel_time = millis();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
            }<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (buttIntStatus == PIN_BUTTON) {
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">0</span>) {<font></font>
              button_flag = <span class="hljs-number">1</span>;<font></font>
              previousMillis = millis();<font></font>
              ledsOff();<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">0</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">1750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">70</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(BLUE_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) {<font></font>
                ledsOff();<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">3750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">50</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(GREEN_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">3750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) {<font></font>
                ledsOff();<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">5750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">30</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(RED_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> (millis() - previousMillis &gt; <span class="hljs-number">5750</span>) {<font></font>
                ledsOff();<font></font>
              }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">1</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &lt;= <span class="hljs-number">1750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, BLUE_LED);<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
                presentation();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">3750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, GREEN_LED);<font></font>
                configMode = <span class="hljs-number">1</span>;<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                configMillis = millis();<font></font>
                interrupt_Init(<span class="hljs-number">1</span>);<font></font>
                NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
                NRF5_ESB_startListening();<font></font>
                wait(<span class="hljs-number">50</span>);<font></font>
              }<font></font>
<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">5750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, RED_LED);
                <span class="hljs-comment">//new_device();</span><font></font>
              }<font></font>
<font></font>
              <span class="hljs-keyword">if</span> ((((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">3750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">5750</span>))) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
            }<font></font>
          }<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
          batteryVoltage = hwCPUVoltage();<font></font>
          BATT_TIME = SLEEP_TIME;<font></font>
          sendBatteryStatus(<span class="hljs-number">1</span>);<font></font>
          nosleep = <span class="hljs-number">0</span>;<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (millis() - configMillis &gt; <span class="hljs-number">30000</span>) {<font></font>
          blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, GREEN_LED);<font></font>
          configMode = <span class="hljs-number">0</span>;<font></font>
          nosleep = <span class="hljs-number">0</span>;<font></font>
          interrupt_Init(<span class="hljs-number">0</span>);<font></font>
          NRF_POWER-&gt;DCDCEN = <span class="hljs-number">1</span>;<font></font>
          wait(<span class="hljs-number">50</span>);<font></font>
        }<font></font>
      }<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (buttIntStatus == PIN_BUTTON) {
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">0</span>) {<font></font>
          button_flag = <span class="hljs-number">1</span>;<font></font>
          nosleep = <span class="hljs-number">1</span>;<font></font>
          previousMillis = millis();<font></font>
          ledsOff();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">0</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">1750</span>)) {
            <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">25</span>) {<font></font>
              lightMillisR = millis();<font></font>
              onoff = !onoff;<font></font>
              digitalWrite(GREEN_LED, onoff);<font></font>
            }<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) {<font></font>
            ledsOff();<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) {
            <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">25</span>) {<font></font>
              lightMillisR = millis();<font></font>
              onoff = !onoff;<font></font>
              digitalWrite(RED_LED, onoff);<font></font>
            }<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> (millis() - previousMillis &gt; <span class="hljs-number">4000</span>) {<font></font>
            ledsOff();<font></font>
          }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">1</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &lt;= <span class="hljs-number">1750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, BLUE_LED);<font></font>
            button_flag = <span class="hljs-number">0</span>;<font></font>
            buttIntStatus = <span class="hljs-number">0</span>;<font></font>
            check_parent();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, RED_LED);
            <span class="hljs-comment">//new_device();</span><font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> ((((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>))) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
            button_flag = <span class="hljs-number">0</span>;<font></font>
            buttIntStatus = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        check_parent();<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (_transportSM.failureCounter &gt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    _transportConfig.parentNodeId = loadState(<span class="hljs-number">101</span>);<font></font>
    _transportConfig.nodeId = myid;<font></font>
    _transportConfig.distanceGW = loadState(<span class="hljs-number">103</span>);<font></font>
    mypar = _transportConfig.parentNodeId;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
    flag_fcount = <span class="hljs-number">1</span>;<font></font>
    err_delivery_beat = <span class="hljs-number">6</span>;<font></font>
    happy_node_mode();<font></font>
    gateway_fail();<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (nosleep == <span class="hljs-number">0</span>) {<font></font>
    oldmillis = millis();<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    buttIntStatus = <span class="hljs-number">0</span>;<font></font>
    gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
    magIntStatus = <span class="hljs-number">0</span>;<font></font>
    sleep(SLEEP_TIME_W, <span class="hljs-literal">false</span>);<font></font>
    nosleep = <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">blinky</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> pulses, <span class="hljs-keyword">uint8_t</span> repit, <span class="hljs-keyword">uint8_t</span> ledColor)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>; x &lt; repit; x++) {
    <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {<font></font>
      wait(<span class="hljs-number">150</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pulses; i++) {
      <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {<font></font>
        wait(<span class="hljs-number">40</span>);<font></font>
      }<font></font>
      digitalWrite(ledColor, LOW);<font></font>
      wait(<span class="hljs-number">10</span>);<font></font>
      digitalWrite(ledColor, HIGH);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">board_Init</span><span class="hljs-params">()</span> </span>{<font></font>
  pinMode(PIN_BUTTON, INPUT_PULLUP);<font></font>
  pinMode(MAGNET_INT, INPUT);<font></font>
  pinMode(GERKON_INT, INPUT);<font></font>
  pinMode(AXEL_INT, INPUT);<font></font>
  pinMode(RED_LED, OUTPUT);<font></font>
  pinMode(GREEN_LED, OUTPUT);<font></font>
  pinMode(BLUE_LED, OUTPUT);<font></font>
  ledsOff();<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">1</span>;<font></font>
  wait(<span class="hljs-number">5</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> MY_DEBUG</span>
  NRF_UART0-&gt;ENABLE = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">5</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-comment">//NRF_NFCT-&gt;TASKS_DISABLE = 1;</span>
  <span class="hljs-comment">// NRF_NVMC-&gt;CONFIG = 1;</span>
  <span class="hljs-comment">// NRF_UICR-&gt;NFCPINS = 0;</span>
  <span class="hljs-comment">// NRF_NVMC-&gt;CONFIG = 0;</span>
  <span class="hljs-comment">// NRF_SAADC -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM0  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM1  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM2  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_TWIM1 -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_TWIS1 -&gt;ENABLE = 0;</span>
  NRF_RADIO-&gt;TXPOWER = <span class="hljs-number">8</span>;<font></font>
  wait(<span class="hljs-number">5</span>);<font></font>
<font></font>
  conf_vibro_set = loadState(<span class="hljs-number">230</span>);
  <span class="hljs-keyword">if</span> ((conf_vibro_set &gt; <span class="hljs-number">5</span>) || (conf_vibro_set == <span class="hljs-number">0</span>)) {<font></font>
    conf_vibro_set = <span class="hljs-number">2</span>;<font></font>
    saveState(<span class="hljs-number">230</span>, conf_vibro_set);<font></font>
  }<font></font>
<font></font>
  blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ledsOff</span><span class="hljs-params">()</span> </span>{<font></font>
  digitalWrite(RED_LED, HIGH);<font></font>
  digitalWrite(GREEN_LED, HIGH);<font></font>
  digitalWrite(BLUE_LED, HIGH);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">happy_init</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">//hwWriteConfig(EEPROM_NODE_ID_ADDRESS, 255); // ******************** checking the node config reset *************************</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (hwReadConfig(EEPROM_NODE_ID_ADDRESS) == <span class="hljs-number">0</span>) {<font></font>
    hwWriteConfig(EEPROM_NODE_ID_ADDRESS, <span class="hljs-number">255</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (loadState(<span class="hljs-number">100</span>) == <span class="hljs-number">0</span>) {<font></font>
    saveState(<span class="hljs-number">100</span>, <span class="hljs-number">255</span>);<font></font>
  }<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"EEPROM NODE ID: %d\n"</span>), hwReadConfig(EEPROM_NODE_ID_ADDRESS));<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"USER MEMORY SECTOR NODE ID: %d\n"</span>), loadState(<span class="hljs-number">100</span>));<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (hwReadConfig(EEPROM_NODE_ID_ADDRESS) == <span class="hljs-number">255</span>) {<font></font>
    mtwr = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    mtwr = <span class="hljs-number">11000</span>;<font></font>
    no_present();<font></font>
  }<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MY_TRANSPORT_WAIT_MS: %d\n"</span>), mtwr);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">no_present</span><span class="hljs-params">()</span> </span>{<font></font>
  _coreConfig.presentationSent = <span class="hljs-literal">true</span>;<font></font>
  _coreConfig.nodeRegistered = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interrupt_Init</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> start)</span> </span>{
  <span class="hljs-comment">//***</span>
  <span class="hljs-comment">//SET</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_NOPULL</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_PULLUP</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_PULLDOWN</span>
  <span class="hljs-comment">//***</span><font></font>
  nrf_gpio_cfg_input(PIN_BUTTON, NRF_GPIO_PIN_PULLUP);<font></font>
  nrf_gpio_cfg_input(AXEL_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  nrf_gpio_cfg_input(GERKON_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  nrf_gpio_cfg_input(MAGNET_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  APP_GPIOTE_INIT(APP_GPIOTE_MAX_USERS);<font></font>
  PIN_BUTTON_MASK = <span class="hljs-number">1</span> &lt;&lt; PIN_BUTTON;<font></font>
  AXEL_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; AXEL_INT;<font></font>
  GERKON_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; GERKON_INT;<font></font>
  MAGNET_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; MAGNET_INT;
  <span class="hljs-comment">//  app_gpiote_user_register(p_user_id, pins_low_to_high_mask, pins_high_to_low_mask, event_handler)</span>
  <span class="hljs-keyword">if</span> (start == <span class="hljs-number">0</span>) {<font></font>
    app_gpiote_user_register(&amp;m_gpiote_user_id, AXEL_INT_MASK | GERKON_INT_MASK, GERKON_INT_MASK | MAGNET_INT_MASK | PIN_BUTTON_MASK, gpiote_event_handler);<font></font>
    wait(<span class="hljs-number">5</span>);<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start == <span class="hljs-number">1</span>) {<font></font>
    app_gpiote_user_register(&amp;m_gpiote_user_id, GERKON_INT_MASK, GERKON_INT_MASK | MAGNET_INT_MASK | PIN_BUTTON_MASK, gpiote_event_handler);<font></font>
    wait(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
  app_gpiote_user_enable(m_gpiote_user_id);<font></font>
  wait(<span class="hljs-number">5</span>);<font></font>
  axelIntStatus = <span class="hljs-number">0</span>;<font></font>
  buttIntStatus = <span class="hljs-number">0</span>;<font></font>
  gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
  magIntStatus = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">gpiote_event_handler</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> event_pins_low_to_high, <span class="hljs-keyword">uint32_t</span> event_pins_high_to_low)</span>
</span>{<font></font>
  MY_HW_RTC-&gt;CC[<span class="hljs-number">0</span>] = (MY_HW_RTC-&gt;COUNTER + <span class="hljs-number">2</span>); <span class="hljs-comment">// Taken from d0016 example code, ends the sleep delay</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (PIN_BUTTON_MASK &amp; event_pins_high_to_low) {
    <span class="hljs-keyword">if</span> ((buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>)) {<font></font>
      buttIntStatus = PIN_BUTTON;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (AXEL_INT_MASK &amp; event_pins_low_to_high) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (door_status == <span class="hljs-number">1</span>)) {<font></font>
        axelIntStatus = AXEL_INT;<font></font>
        axel_time0 = millis();<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> ((GERKON_INT_MASK &amp; event_pins_low_to_high) || (GERKON_INT_MASK &amp; event_pins_high_to_low)) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>)) {<font></font>
        gerkIntStatus = GERKON_INT;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (MAGNET_INT_MASK &amp; event_pins_high_to_low) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (door_status == <span class="hljs-number">1</span>)) {<font></font>
        magIntStatus = MAGNET_INT;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sensors_Init</span><span class="hljs-params">()</span> </span>{<font></font>
  Wire.begin();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
  lis2 = <span class="hljs-keyword">new</span> LIS2DW12Sensor (&amp;Wire);<font></font>
  vibro_Init();<font></font>
  <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == HIGH) {<font></font>
      door_status = <span class="hljs-number">1</span>;<font></font>
      interrupt_Init(<span class="hljs-number">0</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      door_status = <span class="hljs-number">0</span>;<font></font>
      interrupt_Init(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
    send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
<font></font>
    SLEEP_TIME_W = SLEEP_TIME;<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    buttIntStatus = <span class="hljs-number">0</span>;<font></font>
    gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
    magIntStatus = <span class="hljs-number">0</span>;<font></font>
    sendBatteryStatus(<span class="hljs-number">0</span>);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    axel_time = millis();<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    interrupt_Init(<span class="hljs-number">0</span>);<font></font>
    blinky(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, RED_LED);<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">config_Happy_node</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (mtwr == <span class="hljs-number">0</span>) {<font></font>
    myid = getNodeId();<font></font>
    saveState(<span class="hljs-number">100</span>, myid);<font></font>
    mypar = _transportConfig.parentNodeId;<font></font>
    old_mypar = mypar;<font></font>
    saveState(<span class="hljs-number">101</span>, mypar);<font></font>
    saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (mtwr != <span class="hljs-number">0</span>) {<font></font>
    myid = getNodeId();<font></font>
    <span class="hljs-keyword">if</span> (myid != loadState(<span class="hljs-number">100</span>)) {<font></font>
      saveState(<span class="hljs-number">100</span>, myid);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">true</span>) {<font></font>
      mypar = _transportConfig.parentNodeId;<font></font>
      <span class="hljs-keyword">if</span> (mypar != loadState(<span class="hljs-number">101</span>)) {<font></font>
        saveState(<span class="hljs-number">101</span>, mypar);<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (_transportConfig.distanceGW != loadState(<span class="hljs-number">102</span>)) {<font></font>
        saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
      }<font></font>
      present_only_parent();<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">false</span>)<font></font>
    {<font></font>
      no_present();<font></font>
      flag_fcount = <span class="hljs-number">1</span>;<font></font>
      err_delivery_beat = <span class="hljs-number">6</span>;<font></font>
      _transportConfig.nodeId = myid;<font></font>
      _transportConfig.parentNodeId = loadState(<span class="hljs-number">101</span>);<font></font>
      _transportConfig.distanceGW = loadState(<span class="hljs-number">102</span>);<font></font>
      mypar = _transportConfig.parentNodeId;<font></font>
      happy_node_mode();<font></font>
      gateway_fail();<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Axel</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (millis() - axel_time &gt;= <span class="hljs-number">5000</span>) {<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
<font></font>
    send_a = send(vibroMsg.<span class="hljs-built_in">set</span>(vibro));<font></font>
    wait(<span class="hljs-number">50</span>);
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
      send_a = send(vibroMsg.<span class="hljs-built_in">set</span>(vibro));<font></font>
      wait(<span class="hljs-number">100</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
        flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
        err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
        err_delivery_beat++;<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
        <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
          gateway_fail();<font></font>
          CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
    axel_time = millis();<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Gerkon</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == HIGH) {<font></font>
    door_status = <span class="hljs-number">1</span>;<font></font>
    interrupt_Init(<span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    door_status = <span class="hljs-number">0</span>;<font></font>
    interrupt_Init(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (door_status == <span class="hljs-number">1</span>) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
  send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
    send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
    wait(<span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
      send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
      wait(<span class="hljs-number">150</span>);<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
    err_delivery_beat = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
      flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
      err_delivery_beat++;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
        gateway_fail();<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Magnet</span><span class="hljs-params">()</span> </span>{<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  send_a = send(mMsg.<span class="hljs-built_in">set</span>(magnet_status));<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
    send_a = send(mMsg.<span class="hljs-built_in">set</span>(magnet_status));<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
    err_delivery_beat = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
      flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
      err_delivery_beat++;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
        gateway_fail();<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  magIntStatus = <span class="hljs-number">0</span>;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">new_device</span><span class="hljs-params">()</span> </span>{<font></font>
  hwWriteConfig(EEPROM_NODE_ID_ADDRESS, <span class="hljs-number">255</span>);<font></font>
  saveState(<span class="hljs-number">100</span>, <span class="hljs-number">255</span>);<font></font>
  wdt_enable(WDTO_15MS);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update_Happy_transport</span><span class="hljs-params">()</span> </span>{<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: UPDATE TRANSPORT CONFIGURATION\n"</span>));<font></font>
  mypar = _transportConfig.parentNodeId;<font></font>
  <span class="hljs-keyword">if</span> (mypar != loadState(<span class="hljs-number">101</span>))<font></font>
  {<font></font>
    saveState(<span class="hljs-number">101</span>, mypar);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (_transportConfig.distanceGW != loadState(<span class="hljs-number">102</span>))<font></font>
  {<font></font>
    saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
  }<font></font>
  present_only_parent();<font></font>
  wait(<span class="hljs-number">50</span>);<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
  flag_update_transport_param = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">present_only_parent</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (old_mypar != mypar) {<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: SEND LITTLE PRESENT:) WITH PARENT ID\n"</span>));
    <span class="hljs-keyword">if</span> (_sendRoute(build(_msgTmp, <span class="hljs-number">0</span>, NODE_SENSOR_ID, C_INTERNAL, <span class="hljs-number">6</span>).<span class="hljs-built_in">set</span>(mypar))) {<font></font>
      flag_sendRoute_parent = <span class="hljs-number">0</span>;<font></font>
      old_mypar = mypar;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      flag_sendRoute_parent = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">happy_node_mode</span><span class="hljs-params">()</span> </span>{<font></font>
  _transportSM.findingParentNode = <span class="hljs-literal">false</span>;<font></font>
  _transportSM.transportActive = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.uplinkOk = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.pingActive = <span class="hljs-literal">false</span>;<font></font>
  _transportSM.failureCounter = <span class="hljs-number">0</span>;<font></font>
  _transportSM.uplinkOk = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.failureCounter = <span class="hljs-number">0u</span>;<font></font>
  _transportSM.failedUplinkTransmissions = <span class="hljs-number">0u</span>;<font></font>
  transportSwitchSM(stReady);<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"TRANSPORT: %d\n"</span>), isTransportReady());<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">gateway_fail</span><span class="hljs-params">()</span> </span>{<font></font>
  flag_nogateway_mode = <span class="hljs-number">1</span>;<font></font>
  flag_update_transport_param = <span class="hljs-number">0</span>;<font></font>
  SLEEP_TIME_W = SLEEP_NOGW;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">check_parent</span><span class="hljs-params">()</span> </span>{<font></font>
  _transportSM.findingParentNode = <span class="hljs-literal">true</span>;<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: SEND FIND PARENT REQUEST, WAIT RESPONSE\n"</span>));<font></font>
  _sendRoute(build(_msg, <span class="hljs-number">255</span>, NODE_SENSOR_ID, C_INTERNAL, <span class="hljs-number">7</span>).<span class="hljs-built_in">set</span>(<span class="hljs-string">""</span>));<font></font>
  wait(<span class="hljs-number">1500</span>, C_INTERNAL, <span class="hljs-number">8</span>);
  <span class="hljs-keyword">if</span> (_msg.sensor == <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">if</span> (mGetCommand(_msg) == <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">if</span> (_msg.type == <span class="hljs-number">8</span>) {<font></font>
        Ack_FP = <span class="hljs-number">1</span>;<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: PARENT RESPONSE FOUND\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (Ack_FP == <span class="hljs-number">1</span>) {<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: FIND PARENT PROCESS\n"</span>));<font></font>
    Ack_FP = <span class="hljs-number">0</span>;<font></font>
    transportSwitchSM(stParent);<font></font>
    flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
    flag_find_parent_process = <span class="hljs-number">1</span>;<font></font>
    problem_mode_count = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.findingParentNode = <span class="hljs-literal">false</span>;<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: PARENT RESPONSE NOT FOUND\n"</span>));<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"TRANSPORT: %d\n"</span>), isTransportReady());<font></font>
    nosleep = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (problem_mode_count &lt; <span class="hljs-number">9</span>) {<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"PROBLEM MODE COUNTER: %d\n"</span>), problem_mode_count);<font></font>
      problem_mode_count++;<font></font>
      SLEEP_TIME_W = SLEEP_TIME_W + SLEEP_TIME_W;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">find_parent_process</span><span class="hljs-params">()</span> </span>{<font></font>
  flag_update_transport_param = <span class="hljs-number">1</span>;<font></font>
  flag_find_parent_process = <span class="hljs-number">0</span>;<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: STANDART TRANSPORT MODE IS RESTORED\n"</span>));<font></font>
  err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
  SLEEP_TIME_W = SLEEP_TIME;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendBatteryStatus</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> start)</span> </span>{<font></font>
  batt_cap = battery_level_in_percent(batteryVoltage);<font></font>
  <span class="hljs-keyword">if</span> (start == <span class="hljs-number">1</span>) {
    <span class="hljs-comment">//if (batt_cap &lt; old_batt_cap) {</span>
    sendBatteryLevel(battery_level_in_percent(batteryVoltage), <span class="hljs-number">1</span>);<font></font>
    wait(<span class="hljs-number">1500</span>, C_INTERNAL, I_BATTERY_LEVEL);<font></font>
    old_batt_cap = batt_cap;<font></font>
    <span class="hljs-comment">// }</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    sendBatteryLevel(battery_level_in_percent(batteryVoltage), <span class="hljs-number">1</span>);<font></font>
    wait(<span class="hljs-number">1500</span>, C_INTERNAL, I_BATTERY_LEVEL);<font></font>
  }<font></font>
<font></font>
  linkQuality = calculationRxQuality();<font></font>
  <span class="hljs-keyword">if</span> (linkQuality != old_linkQuality) {<font></font>
    wait(<span class="hljs-number">10</span>);<font></font>
    sendSignalStrength(linkQuality);<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    old_linkQuality = linkQuality;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">sendSignalStrength</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int16_t</span> level, <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> ack)</span>
</span>{
  <span class="hljs-keyword">return</span> _sendRoute(build(_msgTmp, GATEWAY_ADDRESS, SIGNAL_Q_ID, C_SET, V_VAR1,<font></font>
                          ack).<span class="hljs-built_in">set</span>(level));<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int16_t</span> <span class="hljs-title">calculationRxQuality</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int16_t</span> nRFRSSI_temp = transportGetReceivingRSSI();
  <span class="hljs-keyword">int16_t</span> nRFRSSI = <span class="hljs-built_in">map</span>(nRFRSSI_temp, <span class="hljs-number">-85</span>, <span class="hljs-number">-40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (nRFRSSI &lt; <span class="hljs-number">0</span>) {<font></font>
    nRFRSSI = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (nRFRSSI &gt; <span class="hljs-number">100</span>) {<font></font>
    nRFRSSI = <span class="hljs-number">100</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> nRFRSSI;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">(<span class="hljs-keyword">const</span> MyMessage &amp; message)</span>
</span>{
  <span class="hljs-keyword">if</span> (message.sensor == LEVEL_SENSIV_V_SENS_CHILD_ID) {
    <span class="hljs-keyword">if</span> (message.type == V_VAR1) {<font></font>
      conf_vibro_set = message.getByte();<font></font>
      vibro_Init();<font></font>
      saveState(<span class="hljs-number">230</span>, conf_vibro_set);<font></font>
      wait(<span class="hljs-number">200</span>);<font></font>
      send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
      wait(<span class="hljs-number">200</span>);<font></font>
      blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, GREEN_LED);<font></font>
      configMode = <span class="hljs-number">0</span>;<font></font>
      nosleep = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vibro_Init</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">1</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_1Hz6_LP_ONLY;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">2</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_12Hz5;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">3</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_25Hz;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">4</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_100Hz;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">5</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_200Hz;<font></font>
  }<font></font>
  lis2-&gt;Enable_X();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
  lis2-&gt;Enable_Wake_Up_Detection();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une liste compl√®te des fichiers de projet est disponible sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant que syst√®me UD, j'utilise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Majordomo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> depuis longtemps </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans cet article, je vais d√©crire un exemple du fonctionnement du capteur dans le r√©seau Maysensors via le contr√¥leur UD. </font><font style="vertical-align: inherit;">Dans ce mode de r√©alisation, les donn√©es du capteur sont envoy√©es via la passerelle Maysensors au syst√®me UD. </font><font style="vertical-align: inherit;">Majordomo impl√©mente la prise en charge du protocole Mysensors </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un module s√©par√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le module de t√©l√©chargement et d'installation est disponible sur le march√© des modules compl√©mentaires du syst√®me UD dans la section "√©quipements". </font></font><br>
<img src="https://habrastorage.org/webt/22/ho/ia/22hoiaoqgc-wbzualelk3bhxks8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le moment, l'impl√©mentation de Majordomo UD est la plus compl√®te, prise en charge:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les types de donn√©es mesensors,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travailler avec OTA,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travailler avec plusieurs r√©seaux √† la fois dans un seul module (multi-gate), </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge des appareils SmartSleep, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demander des donn√©es aux capteurs du r√©seau au d√©marrage du module, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande de confirmation de livraison de message, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prise en charge des demandes de service, telles que la collecte de donn√©es, le rythme cardiaque, la pr√©sentation, le red√©marrage,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travailler avec NodeManager</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a bien s√ªr des failles, le support pr√©c√©demment ajout√© pour les passerelles s√©rie, dans le processus de d√©veloppement naturel du syst√®me, Majordomo a command√© une longue dur√©e de vie et n'est pas actuellement pris en charge. </font><font style="vertical-align: inherit;">Je n'ai m√™me pas eu l'occasion de tester ce type de portail dans le Majordomo, car cette fonctionnalit√© est devenue indisponible avant que je d√©couvre Mysensors. </font><font style="vertical-align: inherit;">Le d√©veloppeur du module a promis d'ajouter √† nouveau cette fonctionnalit√© d'ici septembre 2019, mais l'automne du 19 est pass√© et il n'y a toujours pas de support pour la s√©rie de passerelles :(. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez √©galement utiliser les passerelles Mysensors mqtt avec Majordomo, mais pas via le module Mysensors, mais via le module MQTT.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon capteur, les capteurs de choc et de champ magn√©tique ne transmettent qu'un seul lorsqu'ils sont d√©clench√©s, ce qui s'est av√©r√© √™tre un petit probl√®me. Le module Simple Devices ne prend pas en charge ces types de capteurs, il existe bien s√ªr un capteur commun, mais sa personnalisation des param√®tres est tr√®s limit√©e. Lors de l'ajout d'un capteur, un probl√®me inconfortable √©tait que lorsque l'unit√© suivante venait du capteur, je devais d√©marrer une minuterie inverse afin qu'apr√®s un intervalle de temps sp√©cifi√© dans la minuterie, z√©ro soit √©crit dans la propri√©t√© de l'objet. Mais comme tout fonctionne par la m√©thode de ¬´mise √† jour du statut¬ª, puis en √©crivant le z√©ro, le module meysensors recevant un nouvel √©tat a envoy√© un message au r√©seau avec ces donn√©es √† mon appareil, et le point est z√©ro.La solution la plus simple m'a sembl√© ajouter une nouvelle m√©thode dans laquelle l'√©tat de property1 √† property2 sera transf√©r√© et un temporisateur sera d√©marr√© pour √©crire z√©ro dans property2. Un objet cr√©√© dans des appareils simples fonctionnera avec property2 et dans le module Maysensors avec property1.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/n0/ui/nen0uibfj0kw4wuupvbxr9z7zoo.png"><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;getProperty(<span class="hljs-string">'value2'</span>) == <span class="hljs-string">'1'</span>){
<span class="hljs-keyword">$this</span>-&gt;setProperty(<span class="hljs-string">'status'</span>,<span class="hljs-string">'1'</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, dans la m√©thode de mise √† jour de l'√©tat de l'objet souhait√©, vous devez ajouter un d√©but de minuterie:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> (gg(<span class="hljs-string">"MysensorsSmoke03.status"</span>) == <span class="hljs-string">"1"</span>) {<font></font>
SetTimeOut(<span class="hljs-string">'AlarmShock'</span>,<span class="hljs-string">'sg("MysensorsSmoke03.status","0");'</span>,<span class="hljs-number">10</span>);<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vid√©o avec le fonctionnement du capteur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le syst√®me Majordomo et l'application Majordroid. </font><font style="vertical-align: inherit;">Je vous recommande de la regarder, dans la mesure du possible, pour montrer le fonctionnement de la fonctionnalit√© principale, et bien s√ªr vos go√ªts et vos abonnements seront particuli√®rement pr√©cieux pour ma petite cha√Æne maison, mais en cliquant sur la cloche, vous ne manquerez pas une vid√©o avec mes nouveaux capteurs;).</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OmclWv2vLog" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carte d'appareil a √©t√© r√©alis√©e √† l'aide du programme DeepTrace. </font><font style="vertical-align: inherit;">Le d√©veloppement de cet √©diteur pour le d√©veloppement de l'√©lectronique m'a permis une fois d'√©tendre consid√©rablement mes capacit√©s. </font><font style="vertical-align: inherit;">Je constate que je ne suis pas ing√©nieur √©lectronique professionnel, mon exp√©rience dans le d√©veloppement domestique de cartes m√®res est d'un an et demi ou deux ans. </font><font style="vertical-align: inherit;">√Ä tous ceux qui fabriquent leurs appareils sur une planche √† pain, je recommande d'essayer d'apprendre une sorte d'√©diteur, YouTube regorge de manuels vid√©o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/qn/oc/qhqnocyny82yvitjx84lso-irzo.png"><br>
<br>
<img src="https://habrastorage.org/webt/dw/vi/ez/dwviez3dctkm_yuxfawnlto9lrm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prise en charge des puces nRF5 dans Maysensors est bas√©e sur la biblioth√®que Sandeep Mistry - arduino-nRF5. Mais cette biblioth√®que ne prend pas en charge les puces nRF52840, nRF52810 et les puces nRF52811 enti√®rement nouvelles. J'ai d√ª bifurquer et ajouter le support pour ces puces, un transfert et une adaptation ont √©t√© effectu√©s √† partir du SDK nordique. Il n'y avait pas de support pour le p√©riph√©rique logiciel car il n'y a pas de besoin particulier d'utiliser Mysensors, et il n'y avait pas de support pour Port1 pour les puces nRF52840. Plus r√©cemment, mes recherches sur ce sujet et celles d'un autre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membre de la communaut√© Maysensors ont √©t√© combin√©es,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et en cons√©quence, le support pour nRF52840 a d√©j√† √©t√© obtenu avec port1, les broches sont devenues juste une mer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le bo√Ætier du capteur a √©t√© d√©velopp√© dans le programme SolidWorks, il a √©galement √©t√© ma√Ætris√© ind√©pendamment des le√ßons sur YouTube il y a environ un an. Le bo√Ætier a √©t√© imprim√© sur une imprimante ANYCUBIC FOTON SLA. La qualit√© et la pr√©cision de l'impression dont j'√©tais tr√®s satisfait. Le seul point n√©gatif est un choix plut√¥t m√©diocre de r√©sines UV avec lesquelles ces imprimantes domestiques peuvent fonctionner. Dimensions de l'appareil dans le bo√Ætier: Long 43 mm, Largeur 26 mm, Hauteur 12,5 mm. Dimensions du bo√Ætier avec aimant: Longueur 37 mm, Largeur 11 mm, Hauteur 12,5 mm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/my/hm/97/myhm97dmggj8d7sdauhlx9oyk5c.png"><br>
<br>
<img src="https://habrastorage.org/webt/wz/9j/cy/wz9jcyajh87x1l7zlncvy_eb1sy.png"><br>
<br>
<img src="https://habrastorage.org/webt/e4/u-/rw/e4u-rwqymkdi701zplhs_b3kn-e.png"><br>
<br>
<img src="https://habrastorage.org/webt/r1/ve/h4/r1veh45ljjnvdwjlappikjgxr_g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La consommation du capteur dans un r√™ve variait de 4 ŒºA √† 7 ŒºA, selon la puce s√©lectionn√©e. La consommation en mode de transfert de donn√©es √©tait de 8 mA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le capteur utilise une pile CR2032. Toutes les mesures ont √©t√© faites par le "multifiler" chinois :) en raison de l'absence d'un profileur en raison de son co√ªt assez important :(.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appareil peut √™tre r√©p√©t√©, utiliser le croquis √©crit ou √©crire le v√¥tre. </font><font style="vertical-align: inherit;">Pour r√©p√©ter le capteur, tout ce dont vous avez besoin est dispos√© sur mon github ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerberas, code, mod√®les de bo√Ætier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si quelqu'un est pr√™t √† aider √† l'√©criture de logiciels sous le protocole ZIGBEE, je serai heureux de coop√©rer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes int√©ress√© par ce projet, rendez-vous dans le groupe des t√©l√©grammes, ils recevront toujours une assistance pour ma√Ætriser non seulement le protocole </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maysensors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais aussi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur nRF5, ils vous conseilleront rapidement sur tous les probl√®mes de programmation nRF52 dans Arduino IDE et pas seulement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les chariots discutent o√π j'habite et des gens comme moi - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@MYSENSORS_RUS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bon √† tous!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490464/index.html">√Ä propos d'une tentative infructueuse de droit d'auteur brutal ou de 68 milliards de titres qui ne changeront rien</a></li>
<li><a href="../fr490466/index.html">Feuille de route des disciplines math√©matiques pour l'apprentissage automatique, partie 2 (probabilit√©s)</a></li>
<li><a href="../fr490470/index.html">OWASP Moscou 2020/1</a></li>
<li><a href="../fr490472/index.html">Comme j'ai √©crit une crypto-monnaie semi-d√©centralis√©e en PHP. (Partie 1 - Collecte des biblioth√®ques)</a></li>
<li><a href="../fr490474/index.html">STM32 Partie 1: Les bases</a></li>
<li><a href="../fr490478/index.html">Station de soudage DIY DIY v2</a></li>
<li><a href="../fr490480/index.html">O Tiling-wm en 2 mots</a></li>
<li><a href="../fr490484/index.html">G√©rer les capteurs de maison intelligente avec l'Assistant Google</a></li>
<li><a href="../fr490490/index.html">Week-end de lecture: 10 documents sur les effets du son sur la sant√© - de ¬´l'hygi√®ne du bruit¬ª au bon sommeil et au GTD</a></li>
<li><a href="../fr490492/index.html">Un robot d'entrep√¥t apprend √† trier les choses non standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>