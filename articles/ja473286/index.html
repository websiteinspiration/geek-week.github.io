<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍃 👨🏿‍🎓 🍻 XDPに対するDDoS攻撃に対する保護を記述します。核部分 🙄 👩🏾‍🔧 🤹🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="EXpress Data Path（XDP）テクノロジーにより、パケットがカーネルネットワークスタックに到着する前に、Linuxインターフェイスでトラフィックを任意に処理できます。XDPの適用-DDoS攻撃に対する保護（CloudFlare）、高度なフィルター、統計収集（Netflix）。XDPプロ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>XDPに対するDDoS攻撃に対する保護を記述します。核部分</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473286/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXpress Data Path（XDP）テクノロジーにより、パケットがカーネルネットワークスタックに到着する前に、Linuxインターフェイスでトラフィックを任意に処理できます。</font><font style="vertical-align: inherit;">XDPの適用-DDoS攻撃に対する保護（CloudFlare）、高度なフィルター、統計収集（Netflix）。</font><font style="vertical-align: inherit;">XDPプログラムはeBPF仮想マシンによって実行されるため、フィルターのタイプに応じて、独自のコードと使用可能なカーネル関数の両方に制限があります。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は、多数のXDP素材の欠点を埋めることを目的としています。</font><font style="vertical-align: inherit;">まず、XDPの機能をすぐに迂回する既製のコードを提供します。検証のために準備されているか、単純すぎて問題を引き起こしません。</font><font style="vertical-align: inherit;">コードを最初から作成しようとすると、一般的なエラーの処理方法がわかりません。</font><font style="vertical-align: inherit;">第二に、VMとハードウェアなしでXDPをローカルでテストする方法は、独自の落とし穴があるにもかかわらずカバーされていません。</font><font style="vertical-align: inherit;">このテキストは、XDPとeBPFに関心のあるネットワーキングとLinuxに詳しいプログラマーを対象としています。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この部分では、XDPフィルターがどのように組み立てられ、どのようにテストされるかを詳しく調べ、次に、パケット処理レベルでよく知られたSYN Cookieメカニズムの単純なバージョンを記述します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信頼できる顧客の</font><font style="vertical-align: inherit;">「ホワイトリスト」は作成しませんが</font><font style="vertical-align: inherit;">、カウンターを維持し、フィルターを管理してください-十分なログ。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cで記述します。これはファッショナブルではありませんが、実用的です。</font><font style="vertical-align: inherit;">すべてのコードは、末尾のリンクを介してGitHubで利用でき、記事で説明されている段階に従ってコミットに分割されます。</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、XDosと私の領域にとって現実的なタスクであるため、DDoS攻撃からの反発のためのミニソリューションが開発されます。</font><font style="vertical-align: inherit;">ただし、主な目標はテクノロジーに対処することであり、これは既成の保護を作成するためのガイドではありません。</font><font style="vertical-align: inherit;">トレーニングコードは最適化されておらず、一部のニュアンスが省略されています。</font></font></p><br>
<h2 id="kratkiy-obzor-xdp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XDPの概要</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントと既存の記事を複製しないように、要点のみを概説します。</font></font></p><br>
<p>,     .    . &nbsp;    :   &nbsp; (<code>XDP_PASS</code>),   (<code>XDP_DROP</code>) &nbsp; &nbsp; (<code>XDP_TX</code>).    ,    &nbsp;<code>XDP_TX</code>.      (<code>XDP_ABORTED</code>) &nbsp; , &nbsp;  <code>assert(0)</code>&nbsp;— &nbsp;.</p><br>
<p>  eBPF (extended Berkley Packet Filter)   ,    ,   &nbsp; &nbsp;&nbsp;  .    :</p><br>
<ul>
<li>  ( ).</li>
<li>   ,    (  C  ).</li>
<li>         .</li>
<li>  ,  &nbsp;  &nbsp; .</li>
<li>      (eBPF helpers).</li>
</ul><br>
<p>     :</p><br>
<ol>
<li>  (, <code>kernel.c</code>)    (<code>kernel.o</code>) &nbsp;   eBPF. &nbsp; 2019  &nbsp;eBPF  Clang &nbsp; &nbsp;GCC&nbsp;10.1.</li>
<li> &nbsp;     &nbsp;  (,    ),   ID  , &nbsp;    .   &nbsp;     &nbsp;ID  ,     ( ).     , &nbsp;  ,    &nbsp;  .</li>
<li>   .    &nbsp; &nbsp;  &nbsp;.   &nbsp; , &nbsp; ,  ,&nbsp;—    .</li>
<li>        eBPF &nbsp;    (just-in-time).</li>
<li>  &nbsp; &nbsp;  .</li>
</ol><br>
<p> XDP  &nbsp;,   &nbsp;  ,&nbsp;, &nbsp;,    &nbsp;.  &nbsp;, eBPF     &nbsp;,   &nbsp;XDP   &nbsp; Linux.</p><br>
<h2 id="podgotovka-okruzheniya"> </h2><br>
<h3 id="sborka"></h3><br>
<p>Clang       &nbsp; eBPF,    &nbsp; :</p><br>
<ol>
<li>  &nbsp;C &nbsp;- LLVM (<code>clang -emit-llvm</code>).</li>
<li> - &nbsp;  eBPF (<code>llc -march=bpf -filetype=obj</code>).</li>
</ol><br>
<p>&nbsp;     &nbsp;  &nbsp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">&nbsp; </a>. ,      (<code>KVER</code>).   &nbsp;<code>helpers/</code>:</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> KVER=v5.3.7
<span class="hljs-built_in">export</span> BASE=https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/plain/tools/testing/selftests/bpf<font></font>
wget -P helpers --content-disposition <span class="hljs-string">"<span class="hljs-variable">${BASE}</span>/bpf_helpers.h?h=<span class="hljs-variable">${KVER}</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${BASE}</span>/bpf_endian.h?h=<span class="hljs-variable">${KVER}</span>"</span>
<span class="hljs-built_in">unset</span> KVER BASE</code></pre><br>
<p>Makefile &nbsp;Arch Linux ( 5.3.7):</p><br>
<pre><code class="plaintext hljs">CLANG ?= clang<font></font>
LLC ?= llc<font></font>
<font></font>
KDIR ?= /lib/modules/$(shell uname -r)/build<font></font>
ARCH ?= $(subst x86_64,x86,$(shell uname -m))<font></font>
<font></font>
CFLAGS = \<font></font>
    -Ihelpers \<font></font>
    \<font></font>
    -I$(KDIR)/include \<font></font>
    -I$(KDIR)/include/uapi \<font></font>
    -I$(KDIR)/include/generated/uapi \<font></font>
    -I$(KDIR)/arch/$(ARCH)/include \<font></font>
    -I$(KDIR)/arch/$(ARCH)/include/generated \<font></font>
    -I$(KDIR)/arch/$(ARCH)/include/uapi \<font></font>
    -I$(KDIR)/arch/$(ARCH)/include/generated/uapi \<font></font>
    -D__KERNEL__ \<font></font>
    \<font></font>
    -fno-stack-protector -O2 -g<font></font>
<font></font>
xdp_%.o: xdp_%.c Makefile<font></font>
    $(CLANG) -c -emit-llvm $(CFLAGS) $&lt; -o - | \<font></font>
    $(LLC) -march=bpf -filetype=obj -o $@<font></font>
<font></font>
.PHONY: all clean<font></font>
<font></font>
all: xdp_filter.o<font></font>
<font></font>
clean:<font></font>
    rm -f ./*.o</code></pre><br>
<p><code>KDIR</code>   &nbsp; , <code>ARCH</code>&nbsp;—  .  &nbsp;     .</p><br>
<div class="spoiler"><b class="spoiler_title">   Debian 10 ( 4.19.67)</b><div class="spoiler_text"><pre><code class="plaintext hljs">#  <font></font>
CLANG ?= clang<font></font>
LLC ?= llc-7<font></font>
<font></font>
#  <font></font>
KDIR ?= /usr/src/linux-headers-$(shell uname -r)<font></font>
ARCH ?= $(subst x86_64,x86,$(shell uname -m))<font></font>
<font></font>
#    -I<font></font>
CFLAGS = \<font></font>
    -Ihelpers \<font></font>
    \<font></font>
    -I/usr/src/linux-headers-4.19.0-6-common/include \<font></font>
    -I/usr/src/linux-headers-4.19.0-6-common/arch/$(ARCH)/include \<font></font>
    #   </code></pre></div></div><br>
<p><code>CFLAGS</code>   &nbsp;  &nbsp;  &nbsp; .  <code>__KERNEL__</code> , &nbsp; UAPI (userspace API)  &nbsp; ,     &nbsp;.</p><br>
<p>    (<code>-fno-stack-protector</code>),     eBPF       .    ,    - eBPF .</p><br>
<p>  ,       &nbsp;:</p><br>
<pre><code class="plaintext hljs">#include &lt;uapi/linux/bpf.h&gt;<font></font>
<font></font>
#include &lt;bpf_helpers.h&gt;<font></font>
<font></font>
SEC("prog")<font></font>
int xdp_main(struct xdp_md* ctx) {<font></font>
    return XDP_PASS;<font></font>
}<font></font>
<font></font>
char _license[] SEC("license") = "GPL";</code></pre><br>
<p> <code>make</code>  <code>xdp_filter.o</code>.    ?</p><br>
<h3 id="testovyy-stend"> </h3><br>
<p>    : &nbsp;   &nbsp;&nbsp;   .      Linux &nbsp; IP,  , &nbsp;   &nbsp; .</p><br>
<p>  veth (virtual Ethernet)  :     , «»   .     (&nbsp;    <code>ip</code>  &nbsp;<code>root</code>):</p><br>
<pre><code class="bash hljs">ip link add xdp-remote <span class="hljs-built_in">type</span> veth peer name xdp-local</code></pre><br>
<p> <code>xdp-remote</code> &nbsp;<code>xdp-local</code>&nbsp;—  . &nbsp;<code>xdp-local</code> (192.0.2.1/24)   , &nbsp;<code>xdp-remote</code> (192.0.2.2/24)    .   :   &nbsp; , &nbsp;Linux &nbsp;   &nbsp; &nbsp;  .      <code>iptables</code>, &nbsp;   , &nbsp; &nbsp;.      (network namespaces,  netns).</p><br>
<p>     ,   &nbsp; NetFilter,  &nbsp;  &nbsp; netns.    &nbsp;-  , &nbsp;     netns. &nbsp; &nbsp;       ,    &nbsp;Linux &nbsp;&nbsp; &nbsp;netns.</p><br>
<p>    <code>xdp-test</code> &nbsp;  <code>xdp-remote</code>.</p><br>
<pre><code class="bash hljs">ip netns add xdp-test<font></font>
ip link <span class="hljs-built_in">set</span> dev xdp-remote netns xdp-test</code></pre><br>
<p> ,  &nbsp;<code>xdp-test</code>, &nbsp; «» <code>xdp-local</code> (  &nbsp;netns &nbsp;) &nbsp;&nbsp;  &nbsp;192.0.2.1   &nbsp;<code>xdp-remote</code>,      &nbsp;192.0.2.0/24,   .   &nbsp;&nbsp; .</p><br>
<p>&nbsp;  netns   &nbsp; .    &nbsp;netns,   <code>ip ...</code> &nbsp;    <code>ip netns exec</code>:</p><br>
<pre><code class="bash hljs">ip netns <span class="hljs-built_in">exec</span> xdp-test \<font></font>
    ip address add 192.0.2.2/24 dev xdp-remote<font></font>
ip netns <span class="hljs-built_in">exec</span> xdp-test \<font></font>
    ip link <span class="hljs-built_in">set</span> xdp-remote up</code></pre><br>
<p>  ,  &nbsp; &nbsp; <code>xdp-local</code> &nbsp;  &nbsp;:</p><br>
<pre><code class="bash hljs">    ip address add 192.0.2.1/24 dev xdp-local<font></font>
    ip link <span class="hljs-built_in">set</span> xdp-local up</code></pre><br>
<p>  <code>tcpdump -tnevi xdp-local</code>,  , &nbsp;,  &nbsp;<code>xdp-test</code>,  &nbsp; :</p><br>
<pre><code class="bash hljs">ip netns <span class="hljs-built_in">exec</span> xdp-test   ping 192.0.2.1</code></pre><br>
<p>   &nbsp;<code>xdp-test</code>. &nbsp;  ,   &nbsp;, ,     <code>sudo ./stand up</code> &nbsp;   <code>sudo ./stand down</code>.</p><br>
<h3 id="trassirovka"></h3><br>
<p>  &nbsp; :</p><br>
<pre><code class="bash hljs">ip -force link <span class="hljs-built_in">set</span> dev xdp-local xdp object xdp_filter.o verbose</code></pre><br>
<p> <code>-force</code> ,    ,    . «No news is good news» &nbsp;&nbsp; ,  &nbsp;  .  <code>verbose</code> , &nbsp;&nbsp;   &nbsp;   &nbsp; :</p><br>
<pre><code class="plaintext hljs">Verifier analysis:<font></font>
<font></font>
0: (b7) r0 = 2<font></font>
1: (95) exit</code></pre><br>
<p>  &nbsp;:</p><br>
<pre><code class="bash hljs">ip link <span class="hljs-built_in">set</span> dev xdp-local xdp off</code></pre><br>
<p>&nbsp;   <code>sudo ./stand attach</code> &nbsp;<code>sudo ./stand detach</code>.</p><br>
<p> ,  , &nbsp;<code>ping</code>  , &nbsp;&nbsp; ?  .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>bpf_trace_printk()</code></a>  &nbsp;<code>printf()</code>, &nbsp;  &nbsp; ,  , &nbsp;  .  <code>bpf_printk()</code>  .</p><br>
<pre><code class="diff hljs">   SEC("prog")<font></font>
   int xdp_main(struct xdp_md* ctx) {<font></font>
<span class="hljs-addition">+      bpf_printk("got packet: %p\n", ctx);</span><font></font>
       return XDP_PASS;<font></font>
   }</code></pre><br>
<p>  &nbsp;  ,   :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">echo</span> -n 1 | sudo tee /sys/kernel/debug/tracing/options/trace_printk</code></pre><br>
<p>  :</p><br>
<pre><code class="bash hljs">cat /sys/kernel/debug/tracing/trace_pipe</code></pre><br>
<p>     <code>sudo ./stand log</code>.</p><br>
<p>Ping    &nbsp;  :</p><br>
<pre><code class="plaintext hljs">&lt;...&gt;-110930 [004] ..s1 78803.244967: 0: got packet: 00000000ac510377</code></pre><br>
<p>  &nbsp; ,    :</p><br>
<pre><code class="plaintext hljs">0: (bf) r3 = r1<font></font>
1: (18) r1 = 0xa7025203a7465<font></font>
3: (7b) *(u64 *)(r10 -8) = r1<font></font>
4: (18) r1 = 0x6b63617020746f67<font></font>
6: (7b) *(u64 *)(r10 -16) = r1<font></font>
7: (bf) r1 = r10<font></font>
8: (07) r1 += -16<font></font>
9: (b7) r2 = 16<font></font>
10: (85) call bpf_trace_printk#6<font></font>
&lt;...&gt;</code></pre><br>
<p> &nbsp;, &nbsp;&nbsp; &nbsp;eBPF   ,      &nbsp;— immediate-  :</p><br>
<pre><code class="bash hljs">$ python -c <span class="hljs-string">"import binascii; print(bytes(reversed(binascii.unhexlify('0a7025203a74656b63617020746f67'))))"</span>
b<span class="hljs-string">'got packet: %p\n'</span></code></pre><br>
<p>&nbsp;       .</p><br>
<h3 id="otpravka-paketov-xdp">  XDP</h3><br>
<p> :       .   &nbsp;  ,    &nbsp;   &nbsp;, &nbsp;   &nbsp;.</p><br>
<pre><code class="diff hljs">       bpf_printk("got packet: %p\n", ctx);
<span class="hljs-deletion">-      return XDP_PASS;</span>
<span class="hljs-addition">+      return XDP_TX;</span>
   }</code></pre><br>
<p> <code>tcpdump</code> &nbsp;<code>xdp-remote</code>.      &nbsp; ICMP Echo Request &nbsp;  ICMP Echo Reply. &nbsp;&nbsp;. ,   <code>XDP_TX</code>    <code>xdp-local</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,    <code>xdp-remote</code>    ,   , &nbsp;  .</p><br>
<div class="spoiler"><b class="spoiler_title">   ?</b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   &nbsp;</a>   perf events, ,     , &nbsp; &nbsp; &nbsp;eBPF  eBPF.</p><br>
<blockquote>     ,        .</blockquote><br>
<pre><code class="bash hljs">$ sudo perf trace --call-graph dwarf -e <span class="hljs-string">'xdp:*'</span><font></font>
   0.000 ping/123455 xdp:xdp_bulk_tx:ifindex=19 action=TX sent=0 drops=1 err=-6<font></font>
                                     veth_xdp_flush_bq ([veth])<font></font>
                                     veth_xdp_flush_bq ([veth])<font></font>
                                     veth_poll ([veth])<font></font>
                                     &lt;...&gt;</code></pre><br>
<p>   6?</p><br>
<pre><code class="bash hljs">$ errno 6<font></font>
ENXIO 6 No such device or address</code></pre><br>
<p> <code>veth_xdp_flush_bq()</code>    &nbsp;<code>veth_xdp_xmit()</code>, &nbsp; &nbsp;<code>ENXIO</code> &nbsp; .</p></div></div><br>
<p>   (<code>XDP_PASS</code>) &nbsp; <code>xdp_dummy.c</code>,   &nbsp;Makefile,  &nbsp;<code>xdp-remote</code>:</p><br>
<pre><code class="bash hljs">ip netns <span class="hljs-built_in">exec</span> remote \<font></font>
    ip link <span class="hljs-built_in">set</span> dev int xdp object dummy.o</code></pre><br>
<p> <code>tcpdump</code>  , &nbsp;:</p><br>
<pre><code class="plaintext hljs">62:57:8e:70:44:64 &gt; 26:0e:25:37:8f:96, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 13762, offset 0, flags [DF], proto ICMP (1), length 84)<font></font>
    192.0.2.2 &gt; 192.0.2.1: ICMP echo request, id 46966, seq 1, length 64<font></font>
62:57:8e:70:44:64 &gt; 26:0e:25:37:8f:96, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 13762, offset 0, flags [DF], proto ICMP (1), length 84)<font></font>
    192.0.2.2 &gt; 192.0.2.1: ICMP echo request, id 46966, seq 1, length 64</code></pre><br>
<p>     ARP,    (  <code>sudo ./stand detach</code>),  <code>ping</code>,    &nbsp; .  &nbsp;, &nbsp; <code>XDP_TX</code>  &nbsp;&nbsp;ARP, &nbsp; <br>
  <code>xdp-test</code>  «» MAC- 192.0.2.1,  &nbsp;   IP.</p><br>
<h2 id="postanovka-zadachi"> </h2><br>
<p> &nbsp; :  &nbsp;XDP  SYN cookies.</p><br>
<p>&nbsp;   DDoS-  SYN flood,   &nbsp;. &nbsp;  (TCP handshake)   SYN,   &nbsp; ,  SYNACK- &nbsp; ACK.    SYN- &nbsp;  &nbsp;  &nbsp; &nbsp;  &nbsp; .      &nbsp; , &nbsp; &nbsp; , &nbsp;   &nbsp;,   &nbsp;,  .</p><br>
<p> &nbsp; &nbsp;SYN- , &nbsp;  SYNACK-,    , &nbsp;ACK-,  ,  &nbsp;SYN-,  &nbsp;?     &nbsp; ACK.  SYN cookie  ,   &nbsp;<code>seqnum</code>   &nbsp; &nbsp;,  &nbsp; .  ACK   &nbsp; ,      &nbsp; &nbsp;<code>acknum</code>.  <code>acknum</code>  &nbsp;,     , &nbsp; &nbsp; -&nbsp; .</p><br>
<p>SYN cookie   &nbsp; Linux &nbsp;   , &nbsp;SYN    &nbsp;.</p><br>
<div class="spoiler"><b class="spoiler_title">  TCP handshake</b><div class="spoiler_text"><p>TCP      , ,  TCP  HTTP-.   &nbsp; &nbsp;. &nbsp;  TCP    &nbsp;32-  :</p><br>
<ul>
<li><p>     . &nbsp;SYN , &nbsp;    &nbsp;.  ACK , &nbsp;     &nbsp; <code>acknum</code>.      &nbsp; &nbsp; , , SYNACK-.</p><br>
</li>
<li><p>Sequence number (seqnum)   &nbsp;  &nbsp; ,   &nbsp; . ,  &nbsp;  &nbsp;X&nbsp;    &nbsp;N, &nbsp;  &nbsp;    N+X. &nbsp;        .</p><br>
</li>
<li><p>Acknowledgement number (acknum)&nbsp;— &nbsp; , &nbsp;seqnum, &nbsp; &nbsp;  , &nbsp;   &nbsp;,   &nbsp;.</p><br>
</li>
</ul><br>
<p>&nbsp;     <code>seqnum</code> &nbsp;<code>acknum</code>.   SYN- &nbsp; <code>seqnum = X</code>.   SYNACK-,    <code>seqnum = Y</code> &nbsp; <code>acknum = X + 1</code>.  &nbsp;SYNACK  ACK-, &nbsp;<code>seqnum = X + 1</code>, <code>acknum = Y + 1</code>.      .</p><br>
<p>  &nbsp;  , TCP    &nbsp;.</p></div></div><br>
<div class="spoiler"><b class="spoiler_title"> SYN cookies &nbsp; ?</b><div class="spoiler_text"><p>-,   SYNACK &nbsp;ACK,    &nbsp;—   . -, &nbsp;SYN-&nbsp;— &nbsp; &nbsp;!&nbsp;—   ,  &nbsp;  . &nbsp;  SYN-,      , &nbsp;    &nbsp; .  TCP &nbsp; , &nbsp;  &nbsp;    .</p></div></div><br>
<p>&nbsp;  , XDP-   :</p><br>
<ul>
<li> SYN  SYNACK &nbsp;cookie;</li>
<li>&nbsp;ACK  RST ( );</li>
<li>  .</li>
</ul><br>
<p>   &nbsp; :</p><br>
<pre><code class="plaintext hljs">   Ethernet,<font></font>
     .<font></font>
   IPv4,<font></font>
     .<font></font>
    ,               (*)<font></font>
           ,<font></font>
         .<font></font>
   TCP,<font></font>
     .     (**)<font></font>
  SYN,<font></font>
     SYN-ACK  cookie.<font></font>
  ACK,<font></font>
      acknum   cookie,<font></font>
         .<font></font>
         N  .    (*)<font></font>
     RST.   (**)<font></font>
    .</code></pre><br>
<p> <code>(*)</code>  , &nbsp;    &nbsp;— &nbsp;    &nbsp;,   TCP handshake &nbsp; SYN cookie &nbsp; seqnum.</p><br>
<p>&nbsp; <code>(**)</code>,  &nbsp;  ,   .</p><br>
<h2 id="realizaciya-tcp-handshake"> TCP handshake</h2><br>
<h3 id="razbor-paketa-i-verifikaciya-koda">    </h3><br>
<p>    : Ethernet (<code>uapi/linux/if_ether.h</code>), IPv4 (<code>uapi/linux/ip.h</code>) &nbsp;TCP (<code>uapi/linux/tcp.h</code>).  &nbsp;  &nbsp;&nbsp;  -&nbsp;,  &nbsp;<code>atomic64_t</code>,     &nbsp;.</p><br>
<p> ,  &nbsp;C  &nbsp; ,    &nbsp; ,    eBPF &nbsp;   , &nbsp;, ,  &nbsp; .</p><br>
<pre><code class="plaintext hljs">#define INTERNAL static __attribute__((always_inline))</code></pre><br>
<p> <code>LOG()</code>   &nbsp; .</p><br>
<p>    &nbsp;.   , &nbsp;    , , <code>process_ether()</code> ,   <code>ether</code>. &nbsp;       &nbsp; .   &nbsp;—  XDP.   SYN &nbsp;ACK   .</p><br>
<pre><code class="plaintext hljs">struct Packet {<font></font>
    struct xdp_md* ctx;<font></font>
<font></font>
    struct ethhdr* ether;<font></font>
    struct iphdr* ip;<font></font>
    struct tcphdr* tcp;<font></font>
};<font></font>
<font></font>
INTERNAL int process_tcp_syn(struct Packet* packet) { return XDP_PASS; }<font></font>
INTERNAL int process_tcp_ack(struct Packet* packet) { return XDP_PASS; }<font></font>
INTERNAL int process_tcp(struct Packet* packet) { ... }<font></font>
INTERNAL int process_ip(struct Packet* packet) { ... }<font></font>
<font></font>
INTERNAL int<font></font>
process_ether(struct Packet* packet) {<font></font>
    struct ethhdr* ether = packet-&gt;ether;<font></font>
<font></font>
    LOG("Ether(proto=0x%x)", bpf_ntohs(ether-&gt;h_proto));<font></font>
<font></font>
    if (ether-&gt;h_proto != bpf_ntohs(ETH_P_IP)) {<font></font>
        return XDP_PASS;<font></font>
    }<font></font>
<font></font>
    // B<font></font>
    struct iphdr* ip = (struct iphdr*)(ether + 1);<font></font>
    if ((void*)(ip + 1) &gt; (void*)packet-&gt;ctx-&gt;data_end) {<font></font>
        return XDP_DROP; /* malformed packet */<font></font>
    }<font></font>
<font></font>
    packet-&gt;ip = ip;<font></font>
    return process_ip(packet);<font></font>
}<font></font>
<font></font>
SEC("prog")<font></font>
int xdp_main(struct xdp_md* ctx) {<font></font>
    struct Packet packet;<font></font>
    packet.ctx = ctx;<font></font>
<font></font>
    // A<font></font>
    struct ethhdr* ether = (struct ethhdr*)(void*)ctx-&gt;data;<font></font>
    if ((void*)(ether + 1) &gt; (void*)ctx-&gt;data_end) {<font></font>
        return XDP_PASS;<font></font>
    }<font></font>
<font></font>
    packet.ether = ether;<font></font>
    return process_ether(&amp;packet);<font></font>
}</code></pre><br>
<p>  &nbsp;,  A &nbsp;B.  &nbsp;A,  , &nbsp;&nbsp;   :</p><br>
<pre><code class="plaintext hljs">Verifier analysis:<font></font>
<font></font>
&lt;...&gt;<font></font>
11: (7b) *(u64 *)(r10 -48) = r1<font></font>
12: (71) r3 = *(u8 *)(r7 +13)<font></font>
invalid access to packet, off=13 size=1, R7(id=0,off=0,r=0)<font></font>
R7 offset is outside of the packet<font></font>
processed 11 insns (limit 1000000) max_states_per_insn 0 total_states 0 peak_states 0 mark_read 0<font></font>
<font></font>
Error fetching program/map!</code></pre><br>
<p>  <code>invalid access to packet, off=13 size=1, R7(id=0,off=0,r=0)</code>:   ,    &nbsp;   &nbsp;. &nbsp;  , &nbsp;   ,     (12) &nbsp;,    :</p><br>
<pre><code class="bash hljs">llvm-objdump -S xdp_filter.o | less</code></pre><br>
<p>&nbsp;    &nbsp;</p><br>
<pre><code class="plaintext hljs">LOG("Ether(proto=0x%x)", bpf_ntohs(ether-&gt;h_proto));</code></pre><br>
<p>&nbsp; , &nbsp; &nbsp;<code>ether</code>. &nbsp; .</p><br>
<h3 id="otvet-na-syn">  SYN</h3><br>
<p> &nbsp; &nbsp;—   SYNACK- &nbsp; <code>seqnum</code>,  &nbsp;  &nbsp;SYN cookie.    &nbsp;<code>process_tcp_syn()</code> &nbsp;.</p><br>
<h4 id="proverka-paketa"> </h4><br>
<p>  ,    , ,  &nbsp;:</p><br>
<pre><code class="plaintext hljs">/* Required to verify checksum calculation */<font></font>
const void* data_end = (const void*)ctx-&gt;data_end;</code></pre><br>
<p>&nbsp;      5.1, &nbsp;     <code>data_end</code> &nbsp;<code>(const void*)ctx-&gt;data_end</code>. &nbsp;   5.3.1 &nbsp;  . ,   &nbsp;  , &nbsp;&nbsp;. &nbsp;— &nbsp;     .</p><br>
<p>      ; &nbsp;<code>MAX_CSUM_BYTES</code> .</p><br>
<pre><code class="plaintext hljs">const u32 ip_len = ip-&gt;ihl * 4;<font></font>
if ((void*)ip + ip_len &gt; data_end) {<font></font>
    return XDP_DROP; /* malformed packet */<font></font>
}<font></font>
if (ip_len &gt; MAX_CSUM_BYTES) {<font></font>
    return XDP_ABORTED; /* implementation limitation */<font></font>
}<font></font>
<font></font>
const u32 tcp_len = tcp-&gt;doff * 4;<font></font>
if ((void*)tcp + tcp_len &gt; (void*)ctx-&gt;data_end) {<font></font>
    return XDP_DROP; /* malformed packet */<font></font>
}<font></font>
if (tcp_len &gt; MAX_CSUM_BYTES) {<font></font>
    return XDP_ABORTED; /* implementation limitation */<font></font>
}</code></pre><br>
<h4 id="razvorot-paketa"> </h4><br>
<p> <code>seqnum</code>  <code>acknum</code>,  ACK (SYN  ):</p><br>
<pre><code class="plaintext hljs">const u32 cookie = 42;<font></font>
tcp-&gt;ack_seq = bpf_htonl(bpf_ntohl(tcp-&gt;seq) + 1);<font></font>
tcp-&gt;seq = bpf_htonl(cookie);<font></font>
tcp-&gt;ack = 1;</code></pre><br>
<p>   TCP,  IP &nbsp;MAC-.    &nbsp;XDP-,  <code>memcpy()</code>&nbsp;— ,   Clang.</p><br>
<pre><code class="plaintext hljs">const u16 temp_port = tcp-&gt;source;<font></font>
tcp-&gt;source = tcp-&gt;dest;<font></font>
tcp-&gt;dest = temp_port;<font></font>
<font></font>
const u32 temp_ip = ip-&gt;saddr;<font></font>
ip-&gt;saddr = ip-&gt;daddr;<font></font>
ip-&gt;daddr = temp_ip;<font></font>
<font></font>
struct ethhdr temp_ether = *ether;<font></font>
memcpy(ether-&gt;h_dest, temp_ether.h_source, ETH_ALEN);<font></font>
memcpy(ether-&gt;h_source, temp_ether.h_dest, ETH_ALEN);</code></pre><br>
<h4 id="pereschet-kontrolnyh-summ">  </h4><br>
<p>  IPv4 &nbsp;TCP    16-  &nbsp;, &nbsp;   &nbsp;, &nbsp; &nbsp;  .  ,    &nbsp;   &nbsp; .    : &nbsp;64  .    &nbsp;  ,    .</p><br>
<p>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">RFC 1624</a> &nbsp;, &nbsp;   ,      .   &nbsp;, &nbsp; &nbsp;  .</p><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">#define MAX_CSUM_WORDS 32<font></font>
#define MAX_CSUM_BYTES (MAX_CSUM_WORDS * 2)<font></font>
<font></font>
INTERNAL u32<font></font>
sum16(const void* data, u32 size, const void* data_end) {<font></font>
    u32 s = 0;<font></font>
#pragma unroll<font></font>
    for (u32 i = 0; i &lt; MAX_CSUM_WORDS; i++) {<font></font>
        if (2*i &gt;= size) {<font></font>
            return s; /* normal exit */<font></font>
        }<font></font>
        if (data + 2*i + 1 + 1 &gt; data_end) {<font></font>
            return 0; /* should be unreachable */<font></font>
        }<font></font>
        s += ((const u16*)data)[i];<font></font>
    }<font></font>
    return s;<font></font>
}</code></pre><br>
<p> &nbsp;, &nbsp;<code>size</code>   ,    ,      .</p><br>
<p>&nbsp;32-     :</p><br>
<pre><code class="plaintext hljs">INTERNAL u32<font></font>
sum16_32(u32 v) {<font></font>
    return (v &gt;&gt; 16) + (v &amp; 0xffff);<font></font>
}</code></pre><br>
<p>    &nbsp;  :</p><br>
<pre><code class="plaintext hljs">ip-&gt;check = 0;<font></font>
ip-&gt;check = carry(sum16(ip, ip_len, data_end));<font></font>
<font></font>
u32 tcp_csum = 0;<font></font>
tcp_csum += sum16_32(ip-&gt;saddr);<font></font>
tcp_csum += sum16_32(ip-&gt;daddr);<font></font>
tcp_csum += 0x0600;<font></font>
tcp_csum += tcp_len &lt;&lt; 8;<font></font>
tcp-&gt;check = 0;<font></font>
tcp_csum += sum16(tcp, tcp_len, data_end);<font></font>
tcp-&gt;check = carry(tcp_csum);<font></font>
<font></font>
return XDP_TX;</code></pre><br>
<p> <code>carry()</code>  &nbsp;32-  16-   ,  RFC&nbsp;791.</p><br>
<h4 id="proverka-rukopozhatiya-tcp">  TCP</h4><br>
<p>    &nbsp;<code>netcat</code>,   ACK, &nbsp; Linux  RST-, &nbsp;   &nbsp; SYN&nbsp;—    &nbsp;SYNACK &nbsp; &nbsp;- &nbsp;&nbsp;    , &nbsp; &nbsp; .</p><br>
<pre><code class="bash hljs">$ sudo ip netns <span class="hljs-built_in">exec</span> xdp-test   nc -nv 192.0.2.1 6666<font></font>
192.0.2.1 6666: Connection reset by peer</code></pre><br>
<p>     &nbsp; <code>tcpdump</code> &nbsp;<code>xdp-remote</code>  , , <code>hping3</code> &nbsp; &nbsp;  .</p><br>
<h3 id="syn-cookie">SYN cookie</h3><br>
<p>&nbsp;  XDP   .    , ,  &nbsp; .  Linux, ,   SipHash, &nbsp;  &nbsp;XDP   &nbsp; .</p><br>
<p>   TODO,  &nbsp; :</p><br>
<ul>
<li><p>XDP- &nbsp;  <code>cookie_seed</code> (  ) &nbsp; ,   &nbsp;,  &nbsp;    &nbsp; .</p><br>
</li>
<li><p>  SYN cookie &nbsp;ACK-  &nbsp; , &nbsp; IP  ,    &nbsp;.</p><br>
</li>
</ul><br>
<p>  :</p><br>
<pre><code class="bash hljs">$ sudoip netns <span class="hljs-built_in">exec</span> xdp-test   nc -nv 192.0.2.1 6666<font></font>
192.0.2.1 6666: Connection reset by peer</code></pre><br>
<p>&nbsp;    (<code>flags=0x2</code>&nbsp;—  SYN, <code>flags=0x10</code>&nbsp;—  ACK):</p><br>
<pre><code class="plaintext hljs">Ether(proto=0x800)<font></font>
  IP(src=0x20e6e11a dst=0x20e6e11e proto=6)<font></font>
    TCP(sport=50836 dport=6666 flags=0x2)<font></font>
Ether(proto=0x800)<font></font>
  IP(src=0xfe2cb11a dst=0xfe2cb11e proto=6)<font></font>
    TCP(sport=50836 dport=6666 flags=0x10)<font></font>
      cookie matches for client 20200c0</code></pre><br>
<p>    IP,  &nbsp; SYN flood &nbsp;, &nbsp;  &nbsp;ACK flood,   :</p><br>
<pre><code class="bash hljs">sudo ip netns <span class="hljs-built_in">exec</span> xdp-test   hping3 --flood -A -s 1111 -p 2222 192.0.2.1</code></pre><br>
<p> &nbsp;:</p><br>
<pre><code class="plaintext hljs">Ether(proto=0x800)<font></font>
  IP(src=0x15bd11a dst=0x15bd11e proto=6)<font></font>
    TCP(sport=3236 dport=2222 flags=0x10)<font></font>
      cookie mismatch</code></pre><br>
<h2 id="zaklyuchenie"></h2><br>
<p> eBPF   XDP     &nbsp;  , &nbsp;&nbsp; &nbsp;. , XDP&nbsp;—   &nbsp;  , &nbsp;&nbsp;  , &nbsp;DPDK &nbsp;  kernel bypass. &nbsp; , XDP     , , &nbsp;&nbsp;,   &nbsp; &nbsp; .  &nbsp;  ,   &nbsp;&nbsp; &nbsp; &nbsp; userspace-.</p><br>
<p>  ,   ,       ,     userspace-   .</p><br>
<p>:</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なgithubコード</font></font></strong></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bpftraceチートシート</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPFおよびXDPリファレンスガイド</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XDPチュートリアル</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PoC：RustからeBPFへのコンパイル</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473274/index.html">10月28日から11月3日までのモスクワでのデジタルイベント</a></li>
<li><a href="../ja473276/index.html">10月28日から11月3日までのサンクトペテルブルクでのデジタルイベント</a></li>
<li><a href="../ja473278/index.html">Windowsターミナルアップデート：プレビュー1910</a></li>
<li><a href="../ja473282/index.html">パルテノン神殿。スラムドッグの億万長者：ブフマン兄弟が億万長者になった経緯とオンラインのVologda-グローバル</a></li>
<li><a href="../ja473284/index.html">シニア、テックリード、アーキテクト-次は何ですか？作業ルーチンに対処する方法と次に進むには？</a></li>
<li><a href="../ja473288/index.html">コードを最初から構築します。レベルを上げます</a></li>
<li><a href="../ja473290/index.html">ジュリア。プロジェクトはどこから始めますか？...</a></li>
<li><a href="../ja473292/index.html">モバイル＃319開発者向けの興味深い資料のダイジェスト（10月21〜27日）</a></li>
<li><a href="../ja473294/index.html">メモリ管理またはあまり頻繁に足を撃たない</a></li>
<li><a href="../ja473296/index.html">お金のないスタートアップ。個人的体験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>