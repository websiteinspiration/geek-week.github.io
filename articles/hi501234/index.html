<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСйЁЯП╜тАНЁЯПн ЁЯШО тЬбя╕П рд▓рд┐рдирдХреНрд╕ рдкрд░ рдлрд╛рд╕реНрдЯ рд░реВрдЯрд┐рдВрдЧ рдФрд░ NAT ЁЯСиЁЯП╜тАНЁЯТ╝ ЁЯОж ЁЯРГ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдЬреИрд╕рд╛ рдХрд┐ IPv4 рдкрддреЗ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдП рд╣реИрдВ, рдХрдИ рджреВрд░рд╕рдВрдЪрд╛рд░ рдСрдкрд░реЗрдЯрд░реЛрдВ рдХреЛ рдкрддрд╛ рдЕрдиреБрд╡рд╛рдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдЕрдкрдиреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рдкрд╣реБрдВрдЪ рдХреЛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>рд▓рд┐рдирдХреНрд╕ рдкрд░ рдлрд╛рд╕реНрдЯ рд░реВрдЯрд┐рдВрдЧ рдФрд░ NAT</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬреИрд╕рд╛ рдХрд┐ IPv4 рдкрддреЗ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдП рд╣реИрдВ, рдХрдИ рджреВрд░рд╕рдВрдЪрд╛рд░ рдСрдкрд░реЗрдЯрд░реЛрдВ рдХреЛ рдкрддрд╛ рдЕрдиреБрд╡рд╛рдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдЕрдкрдиреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рдкрд╣реБрдВрдЪ рдХреЛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </font><font style="vertical-align: inherit;">рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдЖрдкрдХреЛ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рдХрдореЛрдбрд┐рдЯреА рд╕рд░реНрд╡рд░ рдкрд░ рдХреИрд░рд┐рдпрд░ рдЧреНрд░реЗрдб NAT рд╕реНрддрд░ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХреИрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрддрд┐рд╣рд╛рд╕ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IPv4 рдПрдбреНрд░реЗрд╕ рд╕реНрдкреЗрд╕ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХрд╛ рд╡рд┐рд╖рдп рдЕрдм рдирдпрд╛ рдирд╣реАрдВ рд╣реИред рдХреБрдЫ рдмрд┐рдВрджреБ рдкрд░, рдкреНрд░рддреАрдХреНрд╖рд╛ рд╕реВрдЪреА RIPE рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреА, рдлрд┐рд░ рдРрд╕реЗ рдПрдХреНрд╕рдЪреЗрдВрдЬ рдереЗ, рдЬрд┐рди рдкрд░ рдЙрдиреНрд╣реЛрдВрдиреЗ рдкрддреЗ рдХреЗ рдмреНрд▓реЙрдХ рдХрд╛ рдХрд╛рд░реЛрдмрд╛рд░ рдХрд┐рдпрд╛ рдФрд░ рдЕрдкрдиреЗ рдХрд┐рд░рд╛рдП рдХреЗ рд▓реЗрдирджреЗрди рдХрд╛ рдирд┐рд╖реНрдХрд░реНрд╖ рдирд┐рдХрд╛рд▓рд╛ред рдзреАрд░реЗ-рдзреАрд░реЗ, рджреВрд░рд╕рдВрдЪрд╛рд░ рдСрдкрд░реЗрдЯрд░реЛрдВ рдиреЗ рдкрддреЗ рдФрд░ рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреЗ рдЕрдиреБрд╡рд╛рдж рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрдВрдЯрд░рдиреЗрдЯ рдПрдХреНрд╕реЗрд╕ рд╕реЗрд╡рд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛ред рдХрд┐рд╕реА рдиреЗ рдкреНрд░рддреНрдпреЗрдХ рдЧреНрд░рд╛рд╣рдХ рдХреЛ "рд╢реНрд╡реЗрдд" рдкрддрд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдкрддреЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдирд╣реАрдВ рдХрд┐рдпрд╛, рдЬрдмрдХрд┐ рдХрд┐рд╕реА рдиреЗ рджреНрд╡рд┐рддреАрдпрдХ рдмрд╛рдЬрд╛рд░ рдореЗрдВ рдкрддреЗ рдЦрд░реАрджрдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░рдХреЗ рдкреИрд╕реЗ рдмрдЪрд╛рдиреЗ рд╢реБрд░реВ рдХрд░ рджрд┐рдПред рдиреЗрдЯрд╡рд░реНрдХ рдЙрдкрдХрд░рдг рдирд┐рд░реНрдорд╛рддрд╛рдУрдВ рдиреЗ рдЗрд╕ рд╡рд┐рдЪрд╛рд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд┐рдпрд╛, рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рд▓рд┐рдП рдЖрдорддреМрд░ рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╕реНрддрд╛рд░ рдореЙрдбреНрдпреВрд▓ рдпрд╛ рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, MX рд░рд╛рдЙрдЯрд░ рд▓рд╛рдЗрдирдЕрдк (рдирд╡реАрдирддрдо MX104 рдФрд░ MX204 рдХреЛ рдЫреЛрдбрд╝рдХрд░) рдореЗрдВ рдЬреБрдирд┐рдкрд░ рдХреЗ рд╕рд╛рде, NAPT рдХреЛ рдПрдХ рдЕрд▓рдЧ MS-MIC рд╕реЗрд╡рд╛ рдХрд╛рд░реНрдб рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╕рд┐рд╕реНрдХреЛ ASR1k рдХреЛ рдПрдХ GN рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ,рд╕рд┐рд╕реНрдХреЛ ASR9k рдкрд░, рдПрдХ рдЕрд▓рдЧ A9K-ISM-100 рдореЙрдбреНрдпреВрд▓ рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдП A9K-CGN-LIC рд▓рд╛рдЗрд╕реЗрдВрд╕ред рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдЦреБрд╢реА рдореЗрдВ рдмрд╣реБрдд рдкреИрд╕рд╛ рдЦрд░реНрдЪ рд╣реЛрддрд╛ рд╣реИред</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NAT рдкреНрд░рджрд░реНрд╢рди рдХрд░рдиреЗ рдХреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рдХрдВрдкреНрдпреВрдЯрд┐рдВрдЧ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдпреЛрдЬрди рдкреНрд░реЛрд╕реЗрд╕рд░ рдЬреЛ рд╕реНрдерд╛рдкрд┐рдд рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХрд┐рд╕реА рднреА рд╣реЛрдо рд░рд╛рдЙрдЯрд░ рдореЗрдВ, рдЗрд╕реЗ рд╣рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдПрдХ рд╡рд╛рд╣рдХ рдкреИрдорд╛рдиреЗ рдкрд░, FreeBSD (ipfw / pf) рдпрд╛ GNU / Linux (iptables) рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓реЗ рдХрдореЛрдбрд┐рдЯреА рд╕рд░реНрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рдо FreeBSD рдкрд░ рд╡рд┐рдЪрд╛рд░ рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ, рдХреНрдпреЛрдВрдХрд┐ </font><font style="vertical-align: inherit;">рдореИрдВрдиреЗ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдЗрд╕ рдУрдПрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░ рджрд┐рдпрд╛, рдЗрд╕рд▓рд┐рдП рдЬреАрдПрдирдпреВ / рд▓рд┐рдирдХреНрд╕ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реЗрдВред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдкрддреЗ рдХрд╛ рдЕрдиреБрд╡рд╛рдж рдЪрд╛рд▓реВ рдХрд░рдирд╛ рдмрд┐рд▓реНрдХреБрд▓ рднреА рдореБрд╢реНрдХрд┐рд▓ рдирд╣реАрдВ рд╣реИред </font><font style="vertical-align: inherit;">рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рдиреЗрдЯ рдЯреЗрдмрд▓ рдореЗрдВ iptables рдореЗрдВ рдирд┐рдпрдо рд▓рд┐рдЦрдирд╛ рд╣реЛрдЧрд╛:</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо nf_conntrack рдореЙрдбреНрдпреВрд▓ рдХреЛ рд▓реЛрдб рдХрд░реЗрдЧрд╛, рдЬреЛ рд╕рднреА рд╕рдХреНрд░рд┐рдп рдХрдиреЗрдХреНрд╢рдиреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдЧрд╛ рдФрд░ рдЖрд╡рд╢реНрдпрдХ рд░реВрдкрд╛рдВрддрд░рдг рдХрд░реЗрдЧрд╛ред </font><font style="vertical-align: inherit;">рдХрдИ рд╕реВрдХреНрд╖реНрдорддрд╛рдПрдВ рд╣реИрдВред </font><font style="vertical-align: inherit;">рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЪреВрдВрдХрд┐ рд╣рдо рд╡рд╛рд╣рдХ рдХреЗ рдкреИрдорд╛рдиреЗ рдкрд░ NAT рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЯрд╛рдЗрдордЖрдЙрдЯ рдХреЛ рдХрд╕рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рдиреЛрдВ рдХреЗ рд╕рд╛рде, рдЕрдиреБрд╡рд╛рдж рддрд╛рд▓рд┐рдХрд╛ рдХрд╛ рдЖрдХрд╛рд░ рдЬрд▓реНрджреА рд╕реЗ рднрдпрд╛рд╡рд╣ рдореВрд▓реНрдпреЛрдВ рддрдХ рдмрдврд╝ рдЬрд╛рдПрдЧрд╛ред </font><font style="vertical-align: inherit;">рдиреАрдЪреЗ рдЙрди рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдЬреЛ рдореИрдВрдиреЗ рдЕрдкрдиреЗ рд╕рд░реНрд╡рд░ рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдереЗ:</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдФрд░ рджреВрд╕рд░реА рдмрд╛рдд, рдЪреВрдВрдХрд┐ рдЯреЗрд▓реАрдХреЙрдо рдСрдкрд░реЗрдЯрд░ рдХреА рд╢рд░реНрддреЛрдВ рдореЗрдВ рдЕрдиреБрд╡рд╛рдж рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдЖрдХрд╛рд░ рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕реЗ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП:</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 рд╕рднреА рдЕрдиреБрд╡рд╛рджреЛрдВ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╣реИрд╢ рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдмрд╛рд▓реНрдЯреА рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рд╡реГрджреНрдзрд┐ рдХрд░рдирд╛ рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реИ (рдпрд╣ nf_conntrack рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИ): </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрди рд╕рд░рд▓ рдЬреЛрдбрд╝рддреЛрдбрд╝ рдХреЗ рдмрд╛рдж, рдПрдХ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдирд┐рд░реНрдорд╛рдг рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдХреНрд▓рд╛рдЗрдВрдЯ рдкрддреЗ рдХреЛ рдмрд╛рд╣рд░реА рдкреВрд▓ рдореЗрдВ рдЕрдиреБрд╡рд╛рдж рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЗрд╕ рд╕рдорд╛рдзрд╛рди рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдЦрд░рд╛рдм рд╣реИред рдПрдирдПрдЯреА (2013 рдХреЗ рдЖрд╕рдкрд╛рд╕) рдХреЗ рд▓рд┐рдП рдЬреАрдПрдирдпреВ / рд▓рд┐рдирдХреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдореЗрд░реЗ рдкрд╣рд▓реЗ рдкреНрд░рдпрд╛рд╕ рдореЗрдВ, рдореИрдВ рдкреНрд░рддрд┐ рд╕рд░реНрд╡рд░ (рдПрдХреНрд╕реЛрди рдИ 5-1650 рд╡реА 2) 0.8Mpps рдкрд░ рд▓рдЧрднрдЧ 7Gbit / s рдкреНрд░рджрд░реНрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдерд╛ред рдЙрд╕ рд╕рдордп рд╕реЗ, GNU / Linux рдХрд░реНрдиреЗрд▓ рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдЯреИрдХ рдореЗрдВ рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЕрдиреБрдХреВрд▓рди рдХрд┐рдП рдЧрдП рд╣реИрдВ, рдПрдХ рд╣реА рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдкрд░ рдПрдХ рд╕рд░реНрд╡рд░ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рд▓рдЧрднрдЧ 1.8-1.9 Mpps рдкрд░ 18-19 Gbit / s рддрдХ рдмрдврд╝ рдЧрдпрд╛ рд╣реИ (рдпреЗ рд╕реАрдорд╛ рдорд╛рди рдереЗ), рд▓реЗрдХрд┐рди рдЯреНрд░реИрдлрд╝рд┐рдХ рд╡реЙрд▓реНрдпреВрдо рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛, рдПрдХ рдПрдХрд▓ рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд╕рд╛рдзрд┐рдд, рдмрд╣реБрдд рддреЗрдЬреА рд╕реЗ рдмрдврд╝рд╛ред рдирддреАрдЬрддрди, рд╡рд┐рднрд┐рдиреНрди рд╕рд░реНрд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рд▓реЛрдб рд╕рдВрддреБрд▓рди рдпреЛрдЬрдирд╛рдПрдВ рд╡рд┐рдХрд╕рд┐рдд рдХреА рдЧрдИрдВ, рд▓реЗрдХрд┐рди рдЗрди рд╕рднреА рдиреЗ рд╕реЗрдЯрдЕрдк рдХреА рдЬрдЯрд┐рд▓рддрд╛ рдХреЛ рдмрдврд╝рд╛ рджрд┐рдпрд╛,рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рд╕реЗрд╡рд╛рдУрдВ рдХреА рдЧреБрдгрд╡рддреНрддрд╛ рдХреА рд╕реЗрд╡рд╛ рдФрд░ рд░рдЦрд░рдЦрд╛рд╡ред</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nftables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЖрдЬрдХрд▓, DPDK рдФрд░ XDP рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ "рдкреИрдХреЗрдЯ рдЯреНрд░рд╛рдВрд╕рдлрд░" рдореЗрдВ рдПрдХ рдлреИрд╢рдиреЗрдмрд▓ рджрд┐рд╢рд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд▓реЗрдЦ рд▓рд┐рдЦреЗ рдЧрдП рд╣реИрдВ, рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рд╕реНрддреБрддрд┐рдХрд░рдг рдХрд┐рдП рдЧрдП рд╣реИрдВ, рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдЙрддреНрдкрд╛рдж рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╡рд╛рд╕рдкреЗрд░реНрдЯреНрд╕ рд╕реЗ SKAT)ред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рджреВрд░рд╕рдВрдЪрд╛рд░ рдСрдкрд░реЗрдЯрд░реЛрдВ рд╕реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдорд░реЛрдВ рдХреЗ рд╕реАрдорд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рд╢рд░реНрддреЛрдВ рдореЗрдВ, рдЗрди рд░реВрдкрд░реЗрдЦрд╛рдУрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреЗ "рд╢реЗрдпрд░" рдореЗрдВ рдХрдЯреМрддреА рдХрд░рдирд╛ рдХрд╛рдлреА рд╕рдорд╕реНрдпрд╛рдЧреНрд░рд╕реНрдд рд╣реИред </font><font style="vertical-align: inherit;">рднрд╡рд┐рд╖реНрдп рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреЗ рд╕рдорд╛рдзрд╛рди рдХреЛ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░рдирд╛ рдЕрдзрд┐рдХ рдХрдард┐рди рд╣реЛрдЧрд╛, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдиреИрджрд╛рдирд┐рдХ тАЛтАЛрдЙрдкрдХрд░рдг рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдЧрд╛ред </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, DPDK рдХреЗ рд╕рд╛рде рдПрдХ рдирд┐рдпрдорд┐рдд tcpdump рд╕рд┐рд░реНрдл рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ XDP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рддрд╛рд░реЛрдВ рдХреЛ рд╡рд╛рдкрд╕ "рднреЗрдЬреЗ рдЧрдП" рдкреИрдХреЗрдЯ рдирд╣реАрдВ рдорд┐рд▓рд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдЕрдВрддрд░рд┐рдХреНрд╖ рдХреЛ рдкреИрдХреЗрдЯ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирдИ рддрдХрдиреАрдХреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рднреА рдЪрд░реНрдЪрд╛рдУрдВ рдХреЗ рдмреАрдЪ, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд░рд┐рдкреЛрд░реНрдЯ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдФрд░ </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">рд▓реЗрдЦ</font></a><font style="vertical-align: inherit;"> рдХрд┐рд╕реА рдХрд╛ рдзреНрдпрд╛рди рдирд╣реАрдВ рдЧрдпрд╛</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд╛рдмреНрд▓реЛ рдиреАрд░рд╛ рдЕрдпреБрд╕реЛ, iptables рдЕрдиреБрдЪрд░, nftables рдореЗрдВ рдлреНрд▓реЛ рдСрдлрд╝рд▓реЛрдбрд┐рдВрдЧ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдкрд░ред рдЖрдЗрдП рдЗрд╕ рддрдВрддреНрд░ рдХреЛ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рджреЗрдЦреЗрдВред</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдореБрдЦреНрдп рд╡рд┐рдЪрд╛рд░ рдпрд╣ рд╣реИ рдХрд┐ рдпрджрд┐ рд░рд╛рдЙрдЯрд░ рд╕реНрдЯреНрд░реАрдо рдХреЗ рджреЛрдиреЛрдВ рдХрд┐рдирд╛рд░реЛрдВ рдкрд░ рдПрдХ рд╕рддреНрд░ рдХреЗ рдкреИрдХреЗрдЯ рдкрд╛рд░рд┐рдд рдХрд░ рджреЗрддрд╛ рд╣реИ (рдЯреАрд╕реАрдкреА рд╕рддреНрд░ рд╕реНрдерд╛рдкрд┐рдд рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЪрд▓рд╛ рдЧрдпрд╛ рд╣реИ), рддреЛ рдЗрд╕ рд╕рддреНрд░ рдХреЗ рдмрд╛рдж рдХреЗ рдкреИрдХреЗрдЯреЛрдВ рдХреЛ рд╕рднреА рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдореЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрди рд╕рднреА рдЬрд╛рдБрдЪреЛрдВ рдХреЛ рдкреИрдХреЗрдЯ рдХреЛ рдЖрдЧреЗ рд░рд╛рдЙрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдХреЗ рд╕рднреА рд╕рдорд╛рди рдЕрдВрдд рд╣реЛрдВрдЧреЗред рд╣рд╛рдВ, рдФрд░ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдорд╛рд░реНрдЧ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ - рд╣рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рд╕рддреНрд░ рдХреЗ рджреМрд░рд╛рди рдХреМрди рд╕реЗ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдФрд░ рдХреМрди рд╕реЗ рд╣реЛрд╕реНрдЯ рдХреЛ рдкреИрдХреЗрдЯ рдХреЛ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рдХреЗрд╡рд▓ рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд╕рд╣реЗрдЬрдиреЗ рдФрд░ рдкреИрдХреЗрдЯ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рдПрдХ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЪрд░рдг рдореЗрдВ рдорд╛рд░реНрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдиреА рд╣реБрдИ рд╣реИред NAT рдкреНрд░рджрд░реНрд╢рди рдХрд░рддреЗ рд╕рдордп, рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ nf_conntrack рдореЙрдбреНрдпреВрд▓ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдкрддреЗ рдФрд░ рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдкрд░ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред рд╣рд╛рдВ, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, iptables рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдкреЙрд▓рд┐рд╕рд░реНрд╕ рдФрд░ рдЕрдиреНрдп рд╕реВрдЪрдирд╛-рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рдирд┐рдпрдо рдХрд╛рдо рдХрд░рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддреЗ рд╣реИрдВ,рд▓реЗрдХрд┐рди рдПрдХ рдЕрд▓рдЧ рдЦрдбрд╝реЗ NAT рдХреЗ рдХрд╛рд░реНрдп рдХреЗ рднрд╛рдЧ рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рд╕реАрдорд╛, рдпрд╣ рдЗрддрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рд╡рд┐рддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд┐рдиреНрдпрд╛рд╕</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдЪрд╛рд╣рд┐рдП:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рддрд╛рдЬрд╛ рдЧрд┐рд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред </font><font style="vertical-align: inherit;">рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд╡рдЬреВрдж рдХрд┐ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗрд╡рд▓ 4.16 рдХрд░реНрдиреЗрд▓ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ, рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдпрд╣ рдмрд╣реБрдд "рдХрдЪреНрдЪрд╛" рдерд╛ рдФрд░ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдХрд░реНрдиреЗрд▓ рдЖрддрдВрдХ рдХрд╣рд╛ рдЬрд╛рддрд╛ рдерд╛ред </font><font style="vertical-align: inherit;">рджрд┐рд╕рдВрдмрд░ 2019 рдХреЗ рдЖрд╕рдкрд╛рд╕ рд╕рдм рдХреБрдЫ рд╕реНрдерд┐рд░ рд╣реЛ рдЧрдпрд╛, рдЬрдм рдПрд▓рдЯреАрдПрд╕ рдЧреБрдард▓реА 4.19.90 рдФрд░ 5.4.5 рдЬрд╛рд░реА рдХреА рдЧрдИред</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nftables рдХреЗ рдПрдХ рд╣рд╛рд▓ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ nftables рдкреНрд░рд╛рд░реВрдк рдореЗрдВ iprables рдирд┐рдпрдо рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦреЗрдВред </font><font style="vertical-align: inherit;">рд╕рдВрд╕реНрдХрд░рдг 0.9.0 рдореЗрдВ рдареАрдХ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрджрд┐ рдкрд╣рд▓реЗ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдХреЗ рд╕рд╛рде рд╕рд┐рджреНрдзрд╛рдВрдд рдореЗрдВ рд╕рдм рдХреБрдЫ рд╕реНрдкрд╖реНрдЯ рд╣реИ, рддреЛ рдореБрдЦреНрдп рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рджреМрд░рд╛рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдореЙрдбреНрдпреВрд▓ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдирд╛ рди рднреВрд▓реЗрдВ (CONFIG_NFT_FLOW_OFFLOAD = m), рддреЛ рджреВрд╕рд░реЗ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдХреЛ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">Nftables рдирд┐рдпрдореЛрдВ рдХреЛ iptables рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрд╛рдлреА рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреНрд░рд▓реЗрдЦрди</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рдЧрднрдЧ рд╕рднреА рдмрд┐рдВрджреБрдУрдВ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, </font><font style="vertical-align: inherit;">iptables рд╕реЗ nftables рдореЗрдВ </font><font style="vertical-align: inherit;">рд╡рд┐рд╢реЗрд╖ </font><font style="vertical-align: inherit;">рдирд┐рдпрдо </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрдиреНрд╡рд░реНрдЯрд░реНрд╕</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рднреА рд╣реИрдВ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдЗрд╕рд▓рд┐рдП, рдореИрдВ рдХреЗрд╡рд▓ NAT рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдФрд░ рдСрдлрд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рджреВрдВрдЧрд╛ред </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ рдЫреЛрдЯреА рдХрд┐рдВрд╡рджрдВрддреА: &lt;i_if&gt;, &lt;o_if&gt; рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлреЗрд╕ рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдЧреБрдЬрд░рддрд╛ рд╣реИ, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рджреЛ рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt;, &lt;pool_addr_end&gt; - "рд╕рдлреЗрдж" рдкрддреЛрдВ рдХреА рд╢реНрд░реЗрдгреА рдХрд╛ рдЖрд░рдВрдн рдФрд░ рдЕрдВрдд рдкрддрд╛ред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NAT рд╡рд┐рдиреНрдпрд╛рд╕ рдмрд╣реБрдд рд╕рд░рд▓ рд╣реИ:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдлреНрд▓реЛ рдСрдлрд╝рд▓реЛрдб рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рдЬрдЯрд┐рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рд╕рдордЭрдиреЗ рдпреЛрдЧреНрдп рд╣реИ:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдпрд╣ рдкреВрд░рд╛ рд╕реЗрдЯрдЕрдк рд╣реИред </font><font style="vertical-align: inherit;">рдЕрдм рд╕рднреА рдЯреАрд╕реАрдкреА / рдпреВрдбреАрдкреА рдЯреНрд░реИрдлрд┐рдХ рдлрд╛рд╕реНрдЯрдиреИрдЯ рдЯреЗрдмрд▓ рдкрд░ рдЬрд╛рдПрдВрдЧреЗ рдФрд░ рдмрд╣реБрдд рддреЗрдЬреА рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рд╣реЛрдВрдЧреЗред</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд░рд┐рдгрд╛рдо</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдпрд╣ "рдХрд┐рддрдирд╛ рддреЗрдЬ" рд╣реИ, рдореИрдВ рдПрдХ рд╣реА рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ (Xeon E5-1650v2) рдХреЗ рд╕рд╛рде рджреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рд░реНрд╡рд░реЛрдВ рдкрд░ рд▓реЛрдб рдХреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдХреЛ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реВрдВрдЧрд╛, рд╕рдорд╛рди рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рд▓реЗрдХрд┐рди iptables (NAT4) рдореЗрдВ NAT рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдореЗрдВ nftables (NAT5)ред </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рдкреНрд░рддрд┐ рд╕реЗрдХрдВрдб рдХреЛрдИ рдкреИрдХреЗрдЯ рдЧреНрд░рд╛рдл рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрди рд╕рд░реНрд╡рд░реЛрдВ рдХреЗ рд▓реЛрдб рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рдФрд╕рдд рдкреИрдХреЗрдЯ рдХрд╛ рдЖрдХрд╛рд░ рд▓рдЧрднрдЧ 800 рдмрд╛рдЗрдЯреНрд╕ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдорд╛рди 1.5Mpps рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, nftables рдХреЗ рд╕рд╛рде рд╕рд░реНрд╡рд░ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдорд╛рд░реНрдЬрд┐рди рдмрд╣реБрдд рдмрдбрд╝рд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╡рд░реНрддрдорд╛рди рдореЗрдВ, рдпрд╣ рд╕рд░реНрд╡рд░ 3Gpps рдкрд░ 30Gbit / s рддрдХ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдореБрдлреНрдд CPU рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд╣реЛрддреЗ рд╣реБрдП 40Gbps рдиреЗрдЯрд╡рд░реНрдХ рдХреА рднреМрддрд┐рдХ рд╕реАрдорд╛ рдореЗрдВ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЪрд▓рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИред </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдпрд╣ рд╕рд╛рдордЧреНрд░реА рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЬреАрдирд┐рдпрд░реЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧреА рдЬреЛ рдЕрдкрдиреЗ рд╕рд░реНрд╡рд░ рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рдмреЗрд╣рддрд░ рдмрдирд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВрдЧреЗред</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi501220/index.html">рдкрд╛рд░реНрд╕рд┐рдВрдЧ: рдХреНрдпрд╛ рдХрд┐рд╕реА рдХрдВрдкрдиреА рдХреЗ рдкрд╛рд╕ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдкреИрд╕рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ?</a></li>
<li><a href="../hi501222/index.html">IT рд░рдгрдиреАрддрд┐ рдмрдирд╛рддреЗ рд╕рдордп COBIT рдХрд╛ рдЕрдиреБрдкреНрд░рдпреЛрдЧ</a></li>
<li><a href="../hi501224/index.html">рдХреНрдпрд╛ рддрдВрддреНрд░рд┐рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ "рдзрд╛рддреБ" рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдореГрддреНрдпреБ рдзрд╛рддреБ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi501226/index.html">рддреНрд╡рд░рд┐рдд рдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬ</a></li>
<li><a href="../hi501232/index.html">рдПрдХ рдЖрдИрдЯреА рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рдЕрдкрдиреЗ рдЬреНрдЮрд╛рди рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреИрд╕реЗ рдХрдорд╛ рд╕рдХрддрд╛ рд╣реИ</a></li>
<li><a href="../hi501236/index.html">рддреЛ рдпрд╣ рд╕рдм рдХреНрдпрд╛ рд╣реИ, "рдкреНрд░реЛрдЯреАрди рдлреЛрд▓реНрдбрд┐рдВрдЧ"?</a></li>
<li><a href="../hi501240/index.html">рд╕рд╛рдЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рдСрдбрд┐рдЯ</a></li>
<li><a href="../hi501244/index.html">рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреЛ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ</a></li>
<li><a href="../hi501246/index.html">рд╕рд╣реА рдХреЛрд╡рд┐рдж -19 рдЧреНрд░рд╛рдлрд┐рдХреНрд╕</a></li>
<li><a href="../hi501248/index.html">рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛рд░реНрдпрд╕реНрдерд▓ рд╣реЙрд▓ рдСрдл рдлрд╝реЗрдо, рднрд╛рдЧ 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>