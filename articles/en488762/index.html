<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïß üíå üë®‚Äçüî¨ Elegant asynchronous programming with promises üëéüèª üë¥üèæ üàµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends! 
 
 Promises (promises) are a relatively new feature of JavaScript that allows you to delay the execution of an action until the co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Elegant asynchronous programming with promises</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488762/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good day, friends! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promises (promises) are a relatively new feature of JavaScript that allows you to delay the execution of an action until the completion of the previous action or to respond to an unsuccessful action. </font><font style="vertical-align: inherit;">This contributes to the correct determination of the sequence of asynchronous operations. </font><font style="vertical-align: inherit;">This article discusses how promises work, how they are used in the Web API, and how you can write your own promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conditions: basic computer literacy, knowledge of the basics of JS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objective: understand what promises are and how they are used.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What are promises?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We briefly reviewed the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promises</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the first article of the course, here we will consider them in more detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In essence, a promise is an object that represents an intermediate state of an operation - it ‚Äúpromises‚Äù that the result will be returned in the future. It is not known exactly when the operation will be completed and when the result will be returned, but there is a guarantee that when the operation is completed, your code will either do something with the result or gracefully handle the error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a rule, how much time an asynchronous operation takes (not too long!) Is of less interest to us than the possibility of an immediate response to its completion. And, of course, it's nice to know that the rest of the code is not blocked.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most common promises are Web APIs that return promises. Let's look at a hypothetical video chat application. The application has a window with a list of friends of the user, clicking on the button next to the name (or avatar) of the user starts a video call. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The button handler calls </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUserMedia ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to access the user's camera and microphone. From the moment getUserMedia () contacts the user for permission (to use devices, which device to use if the user has several microphones or cameras, only a voice call, among other things), getUserMedia () expects not only the user's decision, but also release devices if they are currently in use. In addition, the user may not respond immediately. All this can lead to large delays in time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a request for permission to use devices is made from the main thread, the browser is blocked until getUserMedia () is complete. It is unacceptable. Without promises, everything in the browser becomes ‚Äúnon-clickable‚Äù until the user gives permission to use the microphone and camera. Therefore, instead of waiting for the user's decision and returning a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaStream</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for a stream created from sources (camera and microphone), getUserMedia () returns a promise that MediaStream processes as soon as it becomes available. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The video chat application code might look like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span> <span class="hljs-title">CallButton</span>(<span class="hljs-params">evt</span>)</span>{<font></font>
    setStatusMessage(<span class="hljs-string">'Calling...'</span>)<font></font>
    navigator.mediaDevices.getUserMedia({<span class="hljs-attr">video</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>})<font></font>
    .then(<span class="hljs-function"><span class="hljs-params">chatStream</span> =&gt;</span> {<font></font>
        selfViewElem.srcObject = chatStream<font></font>
        chatStream.getTracks().forEach(<span class="hljs-function"><span class="hljs-params">track</span> =&gt;</span> myPeerConnection.addTrack(track, chatStream))<font></font>
        setStatusMessage(<span class="hljs-string">'Connected'</span>)<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {<font></font>
        setStatusMessage(<span class="hljs-string">'Failed to connect'</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function begins by calling setStatusMessage (), displaying the message 'Calling ...', which serves as an indicator that an attempt is being made to make a call. Then getUserMedia () is called, requesting a stream that contains video and audio tracks. Once the stream is formed, a video element is installed to display the stream from the camera called 'self view', audio tracks are added to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTCPeerConnection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is a connection to another user. After that, the status is updated to 'Connected'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If getUserMedia () fails, the catch block is launched. It uses setStatusMessage () to display an error message.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that the call to getUserMedia () is returned even if the video stream has not yet been received. </font><font style="vertical-align: inherit;">Even if the handleCallButton () function returned control to the code that called it, as soon as getUserMedia () completed execution, it would call the handler. </font><font style="vertical-align: inherit;">Until the application ‚Äúunderstands‚Äù that the broadcast has begun, getUserMedia () will be in standby mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: you can learn more about this in the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSignals and video calls‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This article provides more complete code than the one we used in the example.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Callback Functions Problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand why promises are a good solution, it‚Äôs useful to look at the old way of writing callbacks to see what their problems were. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, consider ordering pizza. </font><font style="vertical-align: inherit;">A successful pizza order consists of several steps that must be performed in order, one after the other:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choose the filling. </font><font style="vertical-align: inherit;">This can take some time if you think about it for a long time, and fail if you change your mind and order a curry.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We place an order. </font><font style="vertical-align: inherit;">Cooking pizza takes some time and may fail if the restaurant lacks the necessary ingredients.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get pizza and eat. </font><font style="vertical-align: inherit;">Receiving pizza may fail if, for example, we cannot pay for the order.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An old-style pseudocode using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">callback functions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> might look like this:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{<font></font>
    placeOrder(toppings, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{<font></font>
        collectOrder(order, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
            eatPizza(pizza)<font></font>
        }, failureCallback)<font></font>
    }, failureCallback)<font></font>
}, failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code is hard to read and maintain (it is often called the ‚Äúhell of callbacks‚Äù or the ‚Äúhell of callbacks‚Äù). </font><font style="vertical-align: inherit;">The failureCallback () function must be called at each nesting level. </font><font style="vertical-align: inherit;">There are other problems.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use promises</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promises make the code cleaner, easier to understand and support. </font><font style="vertical-align: inherit;">If we rewrite the pseudocode using asynchronous promises, we get the following:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">toppings</span>)</span>{
    <span class="hljs-keyword">return</span> placeOrder(toppings)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">order</span>)</span>{
    <span class="hljs-keyword">return</span> collectOrder(order)<font></font>
})<font></font>
.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pizza</span>)</span>{<font></font>
    eatPizza(pizza)<font></font>
})<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is much better - we see what happens, we use one .catch () block to handle all errors, the function does not block the main stream (so we can play video games while waiting for pizza), each operation is guaranteed to be performed after the previous one is completed. </font><font style="vertical-align: inherit;">Since every promise returns a promise, we can use the .then chain. </font><font style="vertical-align: inherit;">Great, right? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using arrow functions, pseudo-code can be further simplified:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span><font></font>
    placeOrder(toppings)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span><font></font>
    collectOrder(order)<font></font>
)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span><font></font>
    eatPizza(pizza)     <font></font>
)<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Or even like this:</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings()<font></font>
.then(<span class="hljs-function"><span class="hljs-params">toppings</span> =&gt;</span> placeOrder(toppings))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">order</span> =&gt;</span> collectOrder(order))<font></font>
.then(<span class="hljs-function"><span class="hljs-params">pizza</span> =&gt;</span> eatPizza(pizza))<font></font>
.catch(failureCallback)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This works because () =&gt; x is identical to () =&gt; {return x}. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can even do this (since functions simply pass parameters, we don‚Äôt need layering):</font></font><br>
<br>
<pre><code class="javascript hljs">chooseToppings().then(placeOrder).then(collectOrder).then(eatPizza).catch(failureCallback)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such code is more difficult to read and cannot be used with more complex constructs than in pseudocode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: pseudo-code can still be improved using async / await, which will be discussed in a future article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At its core, promises are similar to event listeners, but with some differences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A promise is fulfilled only once (success or failure). </font><font style="vertical-align: inherit;">It cannot be executed twice or switch from success to failure or vice versa after the operation is completed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the promise is completed, and we add a callback function to process its result, then this function will be called, despite the fact that the event occurred before the function was added.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basic promise syntax: a real example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Knowing promises is important because many Web APIs use them in functions that perform potentially complex tasks. Working with modern web technologies involves the use of promises. Later we will learn how to write our own promises, but for now, let's look at a few simple examples that can be found in the Web API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first example, we use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fetch ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">to get the image from the network, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blob ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">to convert the contents of the response body to a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object </font><font style="vertical-align: inherit;">and display this object inside the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;img&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> element </font><font style="vertical-align: inherit;">. This example is very similar to the example from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but we will do it a little differently.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: the following example will not work if you simply run it from a file (i.e. using file: // URL). You need to run it through a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">local server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or using online solutions such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glitch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub pages</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. First of all, upload the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that we will receive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Add the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;script&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> element </font><font style="vertical-align: inherit;">to the end of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;body&gt;</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Inside the &lt;script&gt; element, add the following line:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise = fetch(<span class="hljs-string">'coffee.jpg'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fetch () method, which takes the image URL as a parameter, is used to get the image from the network. As the second parameter, we can specify an object with settings, but for now we will restrict ourselves to a simple option. We store the promise returned by fetch () in the promise variable. As noted earlier, a promise is an object that represents an intermediate state ‚Äî the official name for a given state is pending. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. To work with the result of the successful completion of the promise (in our case, when </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Response</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> returns </font><font style="vertical-align: inherit;">), we call the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">.then ()</font></a><font style="vertical-align: inherit;"> method</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The callback function inside the .then () block (often referred to as the executor) is launched only when the promise completes successfully and the Response object is returned - they say that the promise has completed (fulfilled, fullfilled). </font><font style="vertical-align: inherit;">Response is passed as a parameter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">The operation of the .then () block is similar to the operation of the AddEventListener () event listener. </font><font style="vertical-align: inherit;">It is triggered only after the event occurs (after fulfilling the promise). </font><font style="vertical-align: inherit;">The difference between the two is that .then () can only be called once, while the listener is designed for multiple calls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After receiving the response, we call the blob () method to convert the response into a Blob object. </font><font style="vertical-align: inherit;">It looks like this:</font></font><br>
<br>
<pre><code class="javascript hljs">response =&gt; response.blob()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... which is a short entry for:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>)</span>{
    <span class="hljs-keyword">return</span> response.blob()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK, enough words. </font><font style="vertical-align: inherit;">Add the following after the first line:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise2 = promise.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Each call to .then () creates a new promise. </font><font style="vertical-align: inherit;">This is very useful: since blob () also returns a promise, we can process the Blob object by calling .then () on the second promise. </font><font style="vertical-align: inherit;">Given that we want to do something more complicated than calling the method and returning the result, we need to wrap the body of the function in curly braces (otherwise, an exception will be thrown): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the following to the end of the code:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> promise3 = promise2.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Let's fill in the body of the executing function. </font><font style="vertical-align: inherit;">Add the following lines to the braces:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
<span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image.src = objectURL<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we call the URL.createObjectURL () method, passing it as a Blob parameter, which returned the second promise. </font><font style="vertical-align: inherit;">We get a link to the object. </font><font style="vertical-align: inherit;">Then we create an &lt;img&gt; element, set the src attribute with the value of the object link and add it to the DOM so that the image appears on the page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you save the HTML and load it in a browser, you will see that the image is displayed as expected. </font><font style="vertical-align: inherit;">Great job! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">You have probably noticed that these examples are somewhat contrived. </font><font style="vertical-align: inherit;">You could do without the fetch () and blob () methods and assign the &lt;img&gt; corresponding URL, coffee.jpg. </font><font style="vertical-align: inherit;">We went this way to demonstrate working with promises with a simple example.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Failure Response</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We forgot something - we don‚Äôt have an error handler in case one of the promises fails (will be rejected). </font><font style="vertical-align: inherit;">We can add an error handler using the .catch () method. </font><font style="vertical-align: inherit;">Let's do that:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> errorCase = promise3.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to see this in action, specify the wrong image URL and reload the page. </font><font style="vertical-align: inherit;">An error message will appear in the console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, if we do not add the .catch () block, an error message will also be displayed in the console. </font><font style="vertical-align: inherit;">However .catch () allows us to handle errors the way we want it. </font><font style="vertical-align: inherit;">In a real application, your .catch () block may try to retake the image or display the default image, or ask the user to select another image or do something else. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">Watch a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">live demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Block merging</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, the approach we used to write the code is not optimal. </font><font style="vertical-align: inherit;">We deliberately went this way so that you can understand what is happening at each stage. </font><font style="vertical-align: inherit;">As previously shown, we can combine .then () blocks (and .catch () blocks). </font><font style="vertical-align: inherit;">Our code can be rewritten as follows (also see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple-fetch-chained.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on GitHub):</font></font><br>
<br>
<pre><code class="javascript hljs">fetch(<span class="hljs-string">'coffee.jpg'</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.blob())<font></font>
.then(<span class="hljs-function"><span class="hljs-params">myBlob</span> =&gt;</span> {
    <span class="hljs-keyword">let</span> objectURL = URL.createObjectURL(myBlob)
    <span class="hljs-keyword">let</span> image = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
    image.src = objectURL<font></font>
    <span class="hljs-built_in">document</span>.body.appendChild(image)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation: '</span> + e.message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remember that the value returned by the promise is passed as a parameter to the next function executor of the .then () block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">The .then () /. Catch () blocks in promises are asynchronous equivalents of the synchronous try ... catch block. </font><font style="vertical-align: inherit;">Remember: synchronous try ... catch will not work in asynchronous code.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promise Terminology Conclusions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let‚Äôs take stock and write a short guide that you can use in the future. </font><font style="vertical-align: inherit;">To consolidate knowledge, we recommend that you read the previous section several times. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. When the promise is created, they say that it is in a state of expectation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. When the promise is returned, they say that it was completed (resolved):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. A successfully completed promise is called fulfilled. </font><font style="vertical-align: inherit;">It returns the value that can be obtained through the chain from .then () at the end of the promise. </font><font style="vertical-align: inherit;">The executing function in the .then () block contains the value returned by the promise.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. An unsuccessfully completed promise is called rejected. </font><font style="vertical-align: inherit;">It returns the reason, the error message that led to the rejection of the promise. </font><font style="vertical-align: inherit;">This reason can be obtained through the .catch () block at the end of the promise.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the code after several promises</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We learned the basics of using promises. Now let's look at more advanced features. The chain from .then () is fine, but what if we want to call several blocks of promises one by one? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can do this using the standard Promise.all () method. This method takes an array of promises as a parameter and returns a new promise when all the promises in the array are fulfilled. It looks something like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([a,b,c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
        ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If all the promises are fulfilled, the array executor of the .then () block will be passed as a parameter. If at least one of the promises is not fulfilled, the entire block will be rejected. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be very helpful. Imagine that we receive information for dynamically filling the user interface with content on our page. In many cases, it is more reasonable to receive all the information and display it on the page later than displaying the information in parts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at another example: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Download </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a page template</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and place the &lt;script&gt; tag before the closing &lt;/body&gt; tag. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Download the source files ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coffee.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tea.jpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">description.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) or replace them with yours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. In the script, we first define a function that returns the promises that we pass to Promise.all (). </font><font style="vertical-align: inherit;">This will be easy to do if we run Promise.all () after completing the three fetch () operations. </font><font style="vertical-align: inherit;">We can do the following:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> a = fetch(url1)
<span class="hljs-keyword">let</span> b = fetch(url2)
<span class="hljs-keyword">let</span> c = fetch(url3)<font></font>
<font></font>
<span class="hljs-built_in">Promise</span>.all([a, b, c]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
    ...<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the promise is fulfilled, the ‚Äúvalues‚Äù variable will contain three Response objects, one from each completed fetch () operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, we do not want this. </font><font style="vertical-align: inherit;">It doesn't matter to us when the fetch () operations complete. </font><font style="vertical-align: inherit;">What we really want is the loaded data. </font><font style="vertical-align: inherit;">This means that we want to run the Promise.all () block after receiving valid blob representing images and valid text strings. </font><font style="vertical-align: inherit;">We can write a function that does this; </font><font style="vertical-align: inherit;">add the following to your &lt;script&gt; element:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'There has been a problem with your fetch operation '</span> + e.message)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks a bit complicated, so let's go through the code step by step: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. First of all, we declare a function and pass it the URL and the type of the resulting file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. The structure of the function is similar to that we saw in the first example - we call the fetch () function to get the file at a specific URL and then transfer the file to another promise that returns the decoded (read) response body. </font><font style="vertical-align: inherit;">In the previous example, it was always the blob () method. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. There are two differences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the second return promise depends on the type of value. </font><font style="vertical-align: inherit;">Inside the executing function, we use the if ... else if operator to return the promise depending on the type of file we need to decode (in this case, we choose between blob and text, but the example can be easily extended to work with other types).</font></font></li>
<li>-,     ¬´return¬ª   fetch().       ,     (..   ,  blob()  text(),  ,  ,   ).  ,  return     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. At the end, we call the .catch () method to handle any errors that may occur in promises in the array passed to .all (). If one of the promises is rejected, the catch block will let us know what promise the problem was with. The .all () block will still execute, but it won‚Äôt display the results for which there were errors. If you want .all () to be rejected, add a .catch () block at the end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code inside the function is asynchronous and based on promises, so the whole function works like a promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Next, we call our function three times to start the process of receiving and decoding images and text, and put each of the promises in a variable. Add the following:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> coffee = fetchAndDecode(<span class="hljs-string">'coffee.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> tea = fetchAndDecode(<span class="hljs-string">'tea.jpg'</span>, <span class="hljs-string">'blob'</span>)
<span class="hljs-keyword">let</span> description = fetchAndDecode(<span class="hljs-string">'description.txt'</span>, <span class="hljs-string">'text'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Next, we declare a Promise.all () block to execute some code only after all three promises have been fulfilled. </font><font style="vertical-align: inherit;">Add a block with an empty executor function inside .then ():</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">Promise</span>.all([coffee, tea, description]).then(<span class="hljs-function"><span class="hljs-params">values</span> =&gt;</span> {<font></font>
<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see that it takes an array of promises as a parameter. </font><font style="vertical-align: inherit;">The contractor will start only after all three promises are fulfilled; </font><font style="vertical-align: inherit;">when this happens, the result of each promise (the decoded response body) will be placed in an array, this can be represented as [coffee-results, tea-results, description-results]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Finally, add the following to the executor (here we use a fairly simple synchronous code to put the results in variables (creating URL objects from blob) and display images and text on the page):</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">console</span>.log(values)
<span class="hljs-comment">//       </span>
<span class="hljs-keyword">let</span> objectURL1 = URL.createObjectURL(values[<span class="hljs-number">0</span>])
<span class="hljs-keyword">let</span> objectURL2 = URL.createObjectURL(values[<span class="hljs-number">1</span>])
<span class="hljs-keyword">let</span> descText = values[<span class="hljs-number">2</span>]<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> image1 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)
<span class="hljs-keyword">let</span> image2 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>)<font></font>
image1.src = objectURL1<font></font>
image2.src = objectURL2<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(image1)
<span class="hljs-built_in">document</span>.body.appendChild(image2)<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">let</span> para = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'p'</span>)<font></font>
para.textContent = descText<font></font>
<span class="hljs-built_in">document</span>.body.appendChild(para)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Save the changes and reload the page. You should see that all user interface components are loading, although this does not look very attractive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. If you have any difficulties, you can compare your version of the code with ours - here is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">live demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. In order to improve this code, you can loop through the displayed elements, receiving and decoding each, and then loop through the results inside Promise.all (), launching different functions to display each result depending on its type. This will allow you to work with any number of elements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, you can determine the type of the resulting file without having to explicitly specify the type property. This, for example, can be done with</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">response.headers.get ('content-type')</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for checking </font><font style="vertical-align: inherit;">the HTTP Protocol </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content-Type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> header </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the code after fulfilling / rejecting the promise</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Often, you may need to execute code after a promise has been completed, regardless of whether it was executed or rejected. </font><font style="vertical-align: inherit;">Previously, we had to include the same code in both the .then () block and the .catch () block, for example:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
    runFinalCode()<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In modern browsers, the .finally () method is available, which allows you to run the code after the promise is completed, which avoids repetition and makes the code more elegant. </font><font style="vertical-align: inherit;">The code from the previous example can be rewritten as follows:</font></font><br>
<br>
<pre><code class="javascript hljs">myPromise<font></font>
.then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<font></font>
    doSomething(response)<font></font>
})<font></font>
.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {<font></font>
    returnError(e)<font></font>
})<font></font>
.finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    runFinalCode()<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see the use of this approach with a real example - the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">live demo promise-finally.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">It works the same as Promise.all () from the previous example, except that we add finally () to the end of the chain in the fetchAndDecode () function:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchAndDecode</span>(<span class="hljs-params">url, type</span>)</span>{
    <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'blob'</span>){
            <span class="hljs-keyword">return</span> response.blob()<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'text'</span>){
            <span class="hljs-keyword">return</span> response.text()<font></font>
        }<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`There has been a problem with your fetch operation for resource "<span class="hljs-subst">${url}</span>": <span class="hljs-subst">${e.message}</span>`</span>)<font></font>
    }).finally(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`fetch attempt for "<span class="hljs-subst">${url}</span>" finished.`</span>)<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will receive a message about the completion of each attempt to get the file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">then () / catch () / finally () is the asynchronous equivalent of synchronous try () / catch () / finally ().</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writing Your Own Promise</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The good news is that you already know how to do it. </font><font style="vertical-align: inherit;">When you combine multiple promises with .then (), or combine them to provide specific functionality, you create your own asynchronous and promise-based functions. </font><font style="vertical-align: inherit;">Take for example our fetchAndDecode () function from the previous example. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Combining various promise-based APIs to create specific functionality is the most common way to work with promises, which shows the flexibility and power of modern APIs. </font><font style="vertical-align: inherit;">However, there is another way.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constructor Promise ()</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can create your own promise using the Promise () constructor. This may be necessary in a situation where you have code from the old asynchronous API that you need to "oversize." This is done in order to be able to simultaneously work both with existing, old code, libraries or ‚Äúframeworks‚Äù, and with new promise-based code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at a simple example - here we wrap the setTimeout () call in a promise - this will start the function in 2 seconds, which will fulfill the promise (using the resolve () call passed) with the string ‚ÄúSuccess!‚Äù.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {<font></font>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
        resolve(<span class="hljs-string">'Success!'</span>)<font></font>
    }, <span class="hljs-number">2000</span>)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
resolve () and reject () are functions that are called to fulfill or reject a new promise. </font><font style="vertical-align: inherit;">In this case, the promise is fulfilled with the string ‚ÄúSuccess!‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you call this promise, you can add a .then () block to it to further work with the ‚ÄúSuccess!‚Äù Line. </font><font style="vertical-align: inherit;">So we can output a line in the message:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise<font></font>
.then(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {<font></font>
    alert(message)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... or so:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise.then(alert)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Watch a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">live demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The given example is not very flexible - the promise can only be fulfilled with a simple line, we do not have an error handler - reject () (actually setTimeout () does not need an error handler, so in this case it does not matter). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">Why resolve () rather than fulfill ()? </font><font style="vertical-align: inherit;">At the moment, the answer is this: it's hard to explain.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We work with a rejection of a promise</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can create a rejected promise using the reject () method - just like resolve (), reject () takes a simple value, but unlike resolve (), the simple value is not the result, but the reason for the rejection, i.e. </font><font style="vertical-align: inherit;">an error that is passed to the .catch () block. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's expand the previous example by adding a condition for rejecting a promise, as well as the ability to receive messages other than a success message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Take the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and rewrite it like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">timeoutPromise</span>(<span class="hljs-params">message, interval</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span>(message === <span class="hljs-string">''</span> || <span class="hljs-keyword">typeof</span> message !== <span class="hljs-string">'string'</span>){<font></font>
            reject(<span class="hljs-string">'Message is empty or not a string'</span>)<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(interval &lt; <span class="hljs-number">0</span> || <span class="hljs-keyword">typeof</span> interval !== number){<font></font>
            reject(<span class="hljs-string">'Interval is negative or not a number'</span>)<font></font>
        } <span class="hljs-keyword">else</span>{<font></font>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
                resolve(message)<font></font>
            }, interval)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we pass two arguments to the function - message and interval (time delay). </font><font style="vertical-align: inherit;">In a function, we return a Promise object. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the Promise constructor, we perform several checks using if ... else structures:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, we check the message. </font><font style="vertical-align: inherit;">If it is empty or is not a string, then we reject the promise and report an error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly, we check the time delay. </font><font style="vertical-align: inherit;">If it is negative or not a number, then we also reject the promise and report an error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, if both arguments are OK, display the message after a certain time (interval) using setTimeout ().</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since timeoutPromise () returns a promise, we can add .then (), .catch (), etc. to it to improve its functionality. </font><font style="vertical-align: inherit;">Let's do that:</font></font><br>
<br>
<pre><code class="javascript hljs">timeoutPromise(<span class="hljs-string">'Hello there!'</span>, <span class="hljs-number">1000</span>)<font></font>
.then(<span class="hljs-function"><span class="hljs-params">message</span> =&gt;</span> {<font></font>
    alert(message)<font></font>
}).catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error: '</span> + e)<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After saving the changes and running the code, you will see a message after one second. </font><font style="vertical-align: inherit;">Now try passing an empty string as a message or a negative number as an interval. </font><font style="vertical-align: inherit;">You will see an error message as a result of rejecting the promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note. </font><font style="vertical-align: inherit;">You can find our version of this example on GitHub - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">custom-promise2.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More realistic example.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The example we examined makes it easy to understand the concept, but it is not truly asynchronous. Asynchrony in the example is simulated using setTimeout (), although it still shows the usefulness of promises for creating functions with a reasonable workflow, good error handling, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One example of a useful asynchronous application that uses the Promise () constructor is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idb library (IndexedDB with usability)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jake Archibald. </font><font style="vertical-align: inherit;">This library allows you to use the IndexedDB API (based on the API callback functions for storing and retrieving data on the client side), written in the old style, with promises. </font><font style="vertical-align: inherit;">If you look at the main library file, you will see that it uses the same techniques that we examined above. </font><font style="vertical-align: inherit;">The following code converts the basic query model used by many IndexedDB methods to a promise compatible model:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promisifyRequest</span>(<span class="hljs-params">request</span>)</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{<font></font>
        request.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            resolve(request.result)<font></font>
        }<font></font>
<font></font>
        request.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<font></font>
            reject(request.error)<font></font>
        }<font></font>
    })<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This adds a couple of event handlers that fulfill or reject the promise, as appropriate:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the request </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">succeeds</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the onsuccess handler fulfills the promise with the result of the request.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the request </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fails</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the onerror handler rejects the promise with the error of the request.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promises are a great way to create asynchronous applications when we don‚Äôt know what value the function will return or how long it will take. They allow you to work with a sequence of asynchronous operations without using deeply nested callback functions, and they support the error handling style of the synchronous try ... catch statement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promises are supported by all modern browsers. The one exception is Opera Mini and IE11 and its earlier versions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we have considered far from all the features of promises, only the most interesting and useful ones. You'll get to know other features and techniques if you want to learn more about promises.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most modern Web APIs are based on promises, so promises need to be known. </font><font style="vertical-align: inherit;">Among these Web APIs we can name </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web Audio API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Media Capture and Streams</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc. Promises will become more and more popular, so their study and understanding is an important step towards mastering modern JavaScript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúCommon Mistakes in JavaScript Promises Everyone Should Know About</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">‚Äù </font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Constructive criticism is welcome.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488750/index.html">Dinosaur Walk: Two Large Computers of the 20th Century</a></li>
<li><a href="../en488752/index.html">Golang + Phaser3 = MMORPG - We make the basis for the endless generation of the world</a></li>
<li><a href="../en488754/index.html">All at once: automatic check of the bundle size</a></li>
<li><a href="../en488756/index.html">How to work with the Google Sheets API (Google Sheets API v4) in R using the new googlesheets4 package</a></li>
<li><a href="../en488758/index.html">DEFCON Conference 27. Internet Scam Recognition</a></li>
<li><a href="../en488766/index.html">Art and Technology: University of Massachusetts Lowell</a></li>
<li><a href="../en488768/index.html">Bloody hell, or How to swear in English to be mistaken for a cultured person</a></li>
<li><a href="../en488770/index.html">Work with the KOMPAS-3D API ‚Üí Lesson 17 ‚Üí Text document</a></li>
<li><a href="../en488776/index.html">Accessibility Enhancements in Visual Studio 2019 for Mac</a></li>
<li><a href="../en488778/index.html">Data structures: a list that can do everything *</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>