<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµÔ∏è üåô üî± Why we chose Kotlin as one of our target languages. Part 2: Kotlin Multiplatform üçò üíáüèæ üò®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue the series of articles on introducing the Kotlin language into our development process. Look for the first part here . 
 
 In 2017, the am...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Why we chose Kotlin as one of our target languages. Part 2: Kotlin Multiplatform</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/499820/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue the series of articles on introducing the Kotlin language into our development process. Look for the first part </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2017, the ambitious project from Jetbrains saw the light of day, offering a new perspective on cross-platform development. Compiling kotlin code into native code of various platforms! We in Domklik, in turn, are always looking for ways to optimize the development process. What could be better than reusing code, we thought? That's right - do not write code at all. And so that everything works as you want. But while this does not happen. And if there is a solution that would allow us, without spending too much effort, to use a single code base for different platforms, why not try?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So hello everyone! </font><font style="vertical-align: inherit;">My name is Gennady Vasilkov, I am an android developer at Domklik and today I want to share with you our experience in developing Kotlin Multiplatform for mobile devices, tell us what difficulties we encountered, how we solved and what we ended up with. </font><font style="vertical-align: inherit;">The topic will surely be of interest to those who want to try Kotlin MPP (Multiplatform projects), or have already tried it, but did not finish production. </font><font style="vertical-align: inherit;">Or brought, but not as I would like. </font><font style="vertical-align: inherit;">I will try to convey our vision of how the process of developing and delivering developed libraries should be arranged (using one of them as an example, I will tell you the beginning of our development path in Kotlin MPP). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Would you like stories how we did it? </font><font style="vertical-align: inherit;">We have them!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ax/yh/d9/axyhd9vvdn715-ifysok3lk0gpg.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Briefly about technology</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who have not yet heard or not plunged into the topic, it hangs in the Java world and just goes to the Kotlin world (or doesn't go, but peeps): Kotlin MPP is a technology that allows you to use once written code on many platforms at once. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The development is, not surprisingly, in the Kotlin language in IntelliJ IDEA or Android Studio. The plus is that all android developers (at least with us) know and love both the language and these wonderful development environments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also a big plus in compiling the resulting code into languages ‚Äã‚Äãnative to each platform (OBJ-C, JS, everything is clear with JVM).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, everything is cool. </font><font style="vertical-align: inherit;">In my opinion, Kotlin Multiplatform is ideal for taking business logic to libraries. </font><font style="vertical-align: inherit;">It is also possible to write an application completely, but for now it looks too extreme, but library development is suitable for such large projects as ours.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A little technical, to understand how the project works on the Kotlin MPP</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The build system is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gradle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it supports syntax in groovy and kotlin script (kts).</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kotlin MPP has the concept of targets - target platforms. </font><font style="vertical-align: inherit;">In these blocks, the operating systems we need are configured, the native code of which will compile our code on Kotlin. </font><font style="vertical-align: inherit;">In the picture below 2 targets are implemented, jvm and js (the picture is partially taken from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><br>
<img src="https://habrastorage.org/webt/xw/sd/qk/xwsdqkspxy9vbirtocrlj0cf2n8.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Support for other platforms is implemented in the same way.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source sets - the name itself is clear that source codes for platforms are stored here. </font><font style="vertical-align: inherit;">There is a Common source set and platform (there are as many of them as there are targets in the project, this is followed by the IDE). </font><font style="vertical-align: inherit;">It is impossible not to mention the expect-actual mechanism here. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/yn/mw/3cynmwhc0ctyakpsq1awmjk9gmu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The mechanism allows accessing platform-specific code from the Common module. </font><font style="vertical-align: inherit;">We declare expect declaration in the Common module and implement it in the platform ones. </font><font style="vertical-align: inherit;">Below is an example of using the mechanism to get the date on devices:</font></font><br>
<br>
<pre><code class="kotlin hljs">Common:<font></font>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">expect</span> <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span><font></font>
<font></font>
Android/JVM:<font></font>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span> <font></font>
    <span class="hljs-keyword">get</span>() = java.lang.System.currentTimeMillis()<font></font>
<font></font>
iOS:<font></font>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span> <font></font>
    <span class="hljs-keyword">get</span>() = platform.Foundation.NSDate().timeIntervalSince1970.toLong()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see for the platform modules, the Java and iOS Foundation system libraries are available, respectively.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These points are enough to understand what will be discussed later.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our experience</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, at some point, we decided that everything was accepted by Kotlin MPP (then it was also called Kotlin / Native) as a standard and we started to write libraries into which we took out the common code. </font><font style="vertical-align: inherit;">At first it was code only for mobile platforms, at some point they added support for jvm backend. </font><font style="vertical-align: inherit;">On android, the development and publication of the developed libraries did not cause problems, on iOS, in practice, they encountered some problems, but they were successfully solved and a working model for developing and publishing frameworks was worked out.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Time for something to hang around!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have carried out various functionalities in separate libraries that we use in the main project.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Analytics</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background of occurrence</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's no secret that all mobile applications collect a bunch of analytics. Events are hung with all significant and not very events (for example, in our application more than 600 various metrics are collected). And what is metric collection? In a simple way, this is a call to a function that sends an event with a certain key to the bowels of the analytics engine. And then it goes into a variety of analytics systems like firebase, appmetrica and others. What problems are there with this? Constant duplication of the same (plus or minus) code on two platforms! Yes, and the human factor can not be found anywhere - the developers could be mistaken, both in the name of the keys and in the meta-data set transmitted with the event. This clearly needs to be written once and used on each platform. An ideal candidate for making general logic and testing technology (this is our test pen in Kotlin Mpp).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to implement</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We transferred the events themselves to the library (in the form of functions with a wired key and a set of required meta-data in the arguments) and wrote a new logic for processing these events. </font><font style="vertical-align: inherit;">The event format was unified and a handler engine (bus) was created, into which all events poured. </font><font style="vertical-align: inherit;">And for various systems of analytics, adapter listeners wrote (a very useful solution turned out to be, when adding any new analytics we can easily redirect everything, or selectively, each event to a new analytics).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vc/zh/vq/vczhvqo8-r4ap2r0tmwoczqloqe.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting in the implementation process</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the features of the implementation of working with streams in Kotlin / Native for iOS, you can‚Äôt just take and work with the Kotlin object as a singleton and write data there at any time. </font><font style="vertical-align: inherit;">All objects that transfer their state between threads must be frozen (there is a freeze () function for this). </font><font style="vertical-align: inherit;">But the library, among other things, stores a state that can change during the life of the application. </font><font style="vertical-align: inherit;">There are several ways to resolve this situation, we settled on the simplest:</font></font><br>
<br>
<pre><code class="kotlin hljs">Common:<font></font>
<font></font>
<span class="hljs-keyword">expect</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicReference</span>&lt;<span class="hljs-type">T</span>&gt;</span>(value_: T) {<font></font>
    <span class="hljs-keyword">var</span> value: T<font></font>
}<font></font>
<font></font>
Android:<font></font>
<font></font>
<span class="hljs-keyword">actual</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicReference</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span></span>(value_: T) {<font></font>
    <span class="hljs-keyword">actual</span> <span class="hljs-keyword">var</span> value: T = value_<font></font>
}<font></font>
<font></font>
iOS:<font></font>
<font></font>
<span class="hljs-keyword">actual</span> <span class="hljs-keyword">typealias</span> AtomicReference&lt;V&gt; = kotlin.<span class="hljs-keyword">native</span>.concurrent.AtomicReference&lt;V&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This option is suitable for simple state storage. </font><font style="vertical-align: inherit;">In our case, the platform configuration is stored:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">object</span> Config {<font></font>
    <span class="hljs-keyword">val</span> platform = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> manufacturer = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> model = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> deviceId = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> appVersion = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> sessionId = AtomicReference&lt;String?&gt;(<span class="hljs-string">""</span>)<font></font>
    <span class="hljs-keyword">var</span> debug = AtomicReference&lt;<span class="hljs-built_in">Boolean</span>&gt;(<span class="hljs-literal">false</span>)<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is this needed? We do not get some information at the start of the application, when the module should already be loaded and its objects are already in frozen state. In order to add this information to the config and then it could be read from different streams on iOS and such a move is required. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also faced the issue of publishing the library. And if Android didn‚Äôt have any problems with this, then the method proposed by official documentation at that time to connect the assembled framework directly to the iOS project did not suit us for a number of reasons, I wanted to get new versions as simple and transparent as possible. Plus, versioning is supported.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution is to connect the framework via a pod file. </font><font style="vertical-align: inherit;">To do this, they generated the podspec file and the framework itself, put them in the repository and connecting the library to the project became very simple and convenient for iOS developers. </font><font style="vertical-align: inherit;">Also, again, for the convenience of development, we collect a single artifact for all architectures, the so-called fat framework (actually a bold binary in which all architectures and added meta files generated by the kotlin plugin get along together). </font><font style="vertical-align: inherit;">The implementation of this whole thing under the spoiler:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who cares how we did it before the official decision</font></font></b>
                        <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the kotlin plugin has collected for us a bunch of different frameworks for different architectures, we manually create a new universal framework into which we copy meta data from any (in our case, we took arm64):</font></font><br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//add meta files (headers, modules and plist) from arm64 platform</span><font></font>
task copyMeta() {<font></font>
    dependsOn build<font></font>
<font></font>
    doLast {<font></font>
        copy {<font></font>
            from(<span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/bin/iphone/main/release/framework/<span class="hljs-subst">${frameworkName}</span>.framework"</span>)<font></font>
            into <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/iphone_universal/<span class="hljs-subst">${frameworkName}</span>.framework"</span><font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
,    ,   ,   .     lipo,    :<br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//merge binary files into one</span><font></font>
task lipo(type: Exec) {<font></font>
    dependsOn copyMeta<font></font>
<font></font>
    def frameworks = files(<font></font>
            <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/bin/iphone32/main/release/framework/<span class="hljs-subst">${frameworkName}</span>.framework/<span class="hljs-variable">$frameworkName</span>"</span>,
            <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/bin/iphone/main/release/framework/<span class="hljs-subst">${frameworkName}</span>.framework/<span class="hljs-variable">$frameworkName</span>"</span>,
            <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/bin/iphoneSim/main/release/framework/<span class="hljs-subst">${frameworkName}</span>.framework/<span class="hljs-variable">$frameworkName</span>"</span><font></font>
    )<font></font>
    def output = file(<span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/iphone_universal/<span class="hljs-subst">${frameworkName}</span>.framework/<span class="hljs-variable">$frameworkName</span>"</span>)<font></font>
    inputs.files frameworks<font></font>
    outputs.file output<font></font>
    executable = <span class="hljs-string">'lipo'</span><font></font>
    args = frameworks.files<font></font>
    args += [<span class="hljs-string">'-create'</span>, <span class="hljs-string">'-output'</span>, output]<font></font>
}<font></font>
</code></pre><br>
  ,     -       Kotlin MPP   Info.plist   UIRequiredDeviceCapabilities,        (    ).       PlistBuddy:<br>
<pre><code class="kotlin hljs"><span class="hljs-comment">//workaround</span>
<span class="hljs-comment">//remove UIRequiredDeviceCapabilities key from plist file (because we copy this file from arm64, only arm64 architecture was available)</span><font></font>
task editPlistFile(type: Exec) {<font></font>
    dependsOn lipo<font></font>
<font></font>
    executable = <span class="hljs-string">"/bin/sh"</span>
    def script = <span class="hljs-string">'./scripts/edit_plist_file.sh'</span>
    def command = <span class="hljs-string">"Delete :UIRequiredDeviceCapabilities"</span>
    def file = <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/iphone_universal/<span class="hljs-subst">${frameworkName}</span>.framework/Info.plist"</span><font></font>
<font></font>
    args += [script, command, file]<font></font>
}<font></font>
</code></pre><br>
edit_plist_file.sh:<br>
<pre><code class="bash hljs">/usr/libexec/PlistBuddy -c <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
</code></pre><br>
 ,  zip      (    podspec ):<br>
<pre><code class="kotlin hljs">task zipIosFramework(type: Zip) {<font></font>
    dependsOn editPlistFile<font></font>
    from <span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/iphone_universal/"</span>
    include <span class="hljs-string">'**/*'</span><font></font>
    archiveName = iosArtifactName<font></font>
    destinationDir(file(<span class="hljs-string">"<span class="hljs-variable">$buildDir</span>/iphone_universal_zipped/"</span>))<font></font>
}<font></font>
</code></pre><br>
  podspec :<br>
<pre><code class="kotlin hljs">task generatePodspecFile(type: Exec) {<font></font>
    dependsOn zipIosFramework<font></font>
<font></font>
    executable = <span class="hljs-string">"/bin/sh"</span><font></font>
<font></font>
    def script = <span class="hljs-string">'./scripts/generate_podspec_file.sh'</span><font></font>
<font></font>
    def templateStr = <span class="hljs-string">"version_name"</span>
    def sourceFile = <span class="hljs-string">'./podspec/template.podspec'</span>
    def replaceStr = <span class="hljs-string">"<span class="hljs-variable">$version</span>"</span><font></font>
<font></font>
    args += [script, templateStr, replaceStr, sourceFile, generatedPodspecFile]<font></font>
}<font></font>
</code></pre><br>
 generate_podscpec_file.sh      :<br>
<pre><code class="bash hljs">sed -e s/<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>/<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>/g &lt;<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span> &gt;<span class="hljs-string">"<span class="hljs-variable">$4</span>"</span>
</code></pre><br>
   curl        :<br>
<pre><code class="kotlin hljs">task uploadIosFrameworkToNexus(type: Exec) {<font></font>
    dependsOn generatePodspecFile<font></font>
<font></font>
    executable = <span class="hljs-string">"/bin/sh"</span>
    def body = <span class="hljs-string">"-s -k -v --user \'<span class="hljs-variable">$userName</span>:<span class="hljs-variable">$password</span>\' "</span> +
            <span class="hljs-string">"--upload-file <span class="hljs-variable">$buildDir</span>/iphone_universal_zipped/<span class="hljs-variable">$iosArtifactName</span> <span class="hljs-variable">$iosUrlRepoPath</span>"</span>
    args += [<span class="hljs-string">'-c'</span>, <span class="hljs-string">"curl <span class="hljs-variable">$body</span>"</span>]<font></font>
}<font></font>
<font></font>
task uploadPodspecFileToNexus(type: Exec) {<font></font>
    dependsOn uploadIosFrameworkToNexus<font></font>
<font></font>
    executable = <span class="hljs-string">"/bin/sh"</span>
    def body = <span class="hljs-string">"-s -k -v --user \'<span class="hljs-variable">$userName</span>:<span class="hljs-variable">$password</span>\' "</span> +
            <span class="hljs-string">"--upload-file <span class="hljs-variable">$generatedPodspecFile</span> <span class="hljs-variable">$iosUrlRepoPath</span>"</span>
    args += [<span class="hljs-string">'-c'</span>, <span class="hljs-string">"curl <span class="hljs-variable">$body</span>"</span>]<font></font>
}<font></font>
</code></pre><br>
        :<br>
<pre><code class="kotlin hljs">task createAndUploadUniversalIosFramework() {<font></font>
    dependsOn uploadPodspecFileToNexus<font></font>
    doLast {<font></font>
        println <span class="hljs-string">'createAndUploadUniversalIosFramework complete'</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
Profit!<br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the time of writing, there are official solutions for creating a fat framework and generating a podspec file (and generally integration with CocoaPods). </font><font style="vertical-align: inherit;">So we just have to upload the created framework and podspec file to the repository and connect the project in iOS in the same way as before:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  fat framework  Jetbrains</a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  podspec   Jetbrains</a><br>
</li>
</ul><br>
<br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After implementing such a scheme with a single place for storing events, a mechanism for processing and sending metrics, our process of adding new metrics was reduced to the fact that one developer adds a new function to the library, which describes the event key and the necessary meta-data that the developer must transmit for a particular event . Further, the developer of another platform simply downloads a new version of the library and uses the new function in the right place. It has become much easier to maintain the consistency of the entire analytics system; it is also much easier now to change the internal implementation of the event bus. For example, at some point, for one of our analysts, it was necessary for us to implement our own event buffer, which was done immediately in the library, without the need to change the code on the platforms. Profit!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We continue to transfer more and more code to Kotlin MPP, in the following articles I will continue the story of our introduction to the world of cross-platform development using two more libraries as examples, in which serialization and the database were used, and work over time. </font><font style="vertical-align: inherit;">I‚Äôll tell you about the restrictions that were encountered when using several kotlin frameworks in one iOS project and how to get around this limitation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now briefly about the results of our research</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ Everything works stably in production. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ Unified code base of business service logic for all platforms (fewer errors and discrepancy). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ Reduced support costs and reduced development time for new requirements. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
+ We increase the expertise of developers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Related Links</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kotlin Multiplatform website: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.jetbrains.com/lp/mobilecrossplatform</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ZY: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I don‚Äôt want to repeat about laconicism of the language, and therefore focus on business logic when writing code. I can advise several articles that </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cover </font><font style="vertical-align: inherit;">this topic: </font><font style="vertical-align: inherit;">‚ÄúKotlin under the hood - see decompiled bytecode‚Äù - an article describing the operation of the Kotlin compiler and covering the basic structure of the language. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/425077</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Two parts of the article "Kotlin, compilation in bytecode and performance", supplementing the previous article. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/ru/company/inforion/blog/330060 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/ru/company/inforion/blog/330064</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasha Finkelstein‚Äôs report ‚ÄúKotlin - two years in production and not a single gap‚Äù, which is based on the experience of using and implementing Kotlin in our company. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.youtube.com/watch?v=nCDWb7O1ZW4</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495342/index.html">Settlement of bank cards in trade - creating an open dataset and infographic in Google Data Studio</a></li>
<li><a href="../en495344/index.html">Unify it: how Lamoda makes its Go services consistent</a></li>
<li><a href="../en495346/index.html">From error to alert with actions</a></li>
<li><a href="../en495348/index.html">Research: How Covid-19 Affects Email Marketing Performance</a></li>
<li><a href="../en499818/index.html">Uzbek Telegram Marketing</a></li>
<li><a href="../en499822/index.html">Wireless access point vs router: what are the differences?</a></li>
<li><a href="../en499824/index.html">The digest of events for HR and IT recruiters in May 2020</a></li>
<li><a href="../en499826/index.html">Distributed blood pressure</a></li>
<li><a href="../en499832/index.html">How to quickly and safely organize the remote work of employees? We talk about different approaches: with VDI and not only</a></li>
<li><a href="../en499834/index.html">Meet the Felix Arithmometer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>