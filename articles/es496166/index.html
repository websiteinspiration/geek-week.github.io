<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏾 👱 🕴🏼 Doctrine ResultSetMapping con ejemplos 🍇 🎃 🖖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doctrine ORM proporciona al desarrollador medios convenientes para obtener datos. Este es un potente DQL para trabajar de forma orientada a objetos y ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Doctrine ResultSetMapping con ejemplos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496166/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doctrine ORM proporciona al desarrollador medios convenientes para obtener datos. </font><font style="vertical-align: inherit;">Este es un potente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para trabajar de forma orientada a objetos y un conveniente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generador de consultas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , simple e intuitivo de usar. </font><font style="vertical-align: inherit;">Cubren la mayoría de las necesidades, pero a veces se hace necesario usar consultas SQL optimizadas o específicas para un DBMS en particular. </font><font style="vertical-align: inherit;">Para trabajar con resultados de consultas en código, es importante comprender cómo funciona el mapeo en Doctrine.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6v/jr/gx/6vjrgxkxjkih5otk5mussb5_cma.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Doctrine ORM se basa en el patrón </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Mapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que aísla la representación relacional de la representación del objeto y convierte los datos entre ellos. </font><font style="vertical-align: inherit;">Uno de los componentes clave de este proceso es el objeto </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMapping</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que describe cómo transformar los resultados de la consulta del modelo relacional al objeto uno. </font><font style="vertical-align: inherit;">Doctrine siempre usa ResultSetMapping para representar los resultados de la consulta, pero generalmente este objeto se crea sobre la base de anotaciones o configuraciones yaml, xml, permanece oculto a los ojos del desarrollador, por lo tanto, no todos conocen sus capacidades. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obtener ejemplos de cómo trabajar con ResultSetMapping, utilizaré MySQL y la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de datos de muestra de los empleados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura DB</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oc/qf/zy/ocqfzydztc0ia9euzhyalw8cksa.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Describamos las entidades Departamento, Empleado, Salario, con las cuales continuaremos trabajando más. </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Departamento</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Mapping</span> <span class="hljs-title">as</span> <span class="hljs-title">ORM</span>;<font></font>
<font></font>
<span class="hljs-comment">/**
 * Departments
 *
 * <span class="hljs-doctag">@ORM</span>\Table(name="departments", uniqueConstraints={<span class="hljs-doctag">@ORM</span>\UniqueConstraint(name="dept_name", columns={"dept_name"})})
 * <span class="hljs-doctag">@ORM</span>\Entity
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Department</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> string
     *
     * <span class="hljs-doctag">@ORM</span>\Column(name="dept_no", type="string", length=4, nullable=false, options={"fixed"=true})
     * <span class="hljs-doctag">@ORM</span>\Id
     * <span class="hljs-doctag">@ORM</span>\GeneratedValue(strategy="IDENTITY")
     */</span>
    <span class="hljs-keyword">private</span> $deptNo;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> string
     *
     * <span class="hljs-doctag">@ORM</span>\Column(name="dept_name", type="string", length=40, nullable=false)
     */</span>
    <span class="hljs-keyword">private</span> $deptName;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> \Doctrine\Common\Collections\Collection
     *
     * <span class="hljs-doctag">@ORM</span>\ManyToMany(targetEntity="Employee", mappedBy="deptNo")
     */</span>
    <span class="hljs-keyword">private</span> $empNo;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Constructor
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;empNo = <span class="hljs-keyword">new</span> \Doctrine\Common\Collections\ArrayCollection();<font></font>
    }<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empleado</font></font></b><div class="spoiler_text"><br>
&lt;?php<br>
<br>
namespace App\Entity;<br>
<br>
use Doctrine\ORM\Mapping as ORM;<br>
<br>
/**<br>
 * Employees<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Table(name=«employees»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Entity<br>
 */<br>
class Employee<br>
{<br>
 /**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> int<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«emp_no», type=«integer», nullable=false)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\GeneratedValue(strategy=«IDENTITY»)<br>
 */<br>
 private $empNo;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«birth_date», type=«date», nullable=false)<br>
 */<br>
 private $birthDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«first_name», type=«string», length=14, nullable=false)<br>
 */<br>
 private $firstName;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«last_name», type=«string», length=16, nullable=false)<br>
 */<br>
 private $lastName;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«gender», type=«string», length=0, nullable=false)<br>
 */<br>
 private $gender;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«hire_date», type=«date», nullable=false)<br>
 */<br>
 private $hireDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> \Doctrine\Common\Collections\Collection<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\ManyToMany(targetEntity=«Department», inversedBy=«empNo»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\JoinTable(name=«dept_manager»,<br>
 * joinColumns={<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«emp_no», referencedColumnName=«emp_no»)<br>
 * },<br>
 * inverseJoinColumns={<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«dept_no», referencedColumnName=«dept_no»)<br>
 * }<br>
 * )<br>
 */<br>
 private $deptNo;<br>
<br>
/**<br>
 * Constructor<br>
 */<br>
 public function __construct()<br>
 {<br>
 $this-&gt;deptNo = new \Doctrine\Common\Collections\ArrayCollection();<br>
 }<br>
<br>
}<br>
<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salario</font></font></b><div class="spoiler_text">&lt;?php<br>
<br>
namespace App\Entity;<br>
<br>
use Doctrine\ORM\Mapping as ORM;<br>
<br>
/**<br>
 * Salaries<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Table(name=«salaries», indexes={@ORM\Index(name=«IDX_E6EEB84BA2F57F47», columns={«emp_no»})})<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Entity<br>
 */<br>
class Salary<br>
{<br>
 /**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«from_date», type=«date», nullable=false)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\GeneratedValue(strategy=«NONE»)<br>
 */<br>
 private $fromDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> int<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«salary», type=«integer», nullable=false)<br>
 */<br>
 private $salary;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Column(name=«to_date», type=«date», nullable=false)<br>
 */<br>
 private $toDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> Employee<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\OneToOne(targetEntity=«Employee»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\JoinColumns({<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«emp_no», referencedColumnName=«emp_no»)<br>
 * })<br>
 */<br>
 private $empNo;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">var</a> Employee<br>
 *<br>
 */<br>
 private $employee;<br>
<br>
}<br>
<br>
</div></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado de la entidad</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con uno simple, seleccione todos los departamentos de la base y proyecte en el Departamento:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMapping();<font></font>
        $rsm-&gt;addEntityResult(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_no'</span>, <span class="hljs-string">'deptNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'deptName'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">'SELECT * FROM departments'</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addEntityResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indica en qué clase se proyectará nuestra muestra, y los métodos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addFieldResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indican una asignación entre columnas de muestra y campos de objeto. </font><font style="vertical-align: inherit;">La consulta SQL pasada al método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">createNativeQuery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se transferirá a la base de datos en este formulario y Doctrine no la modificará de ninguna manera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena recordar que Entity necesariamente tiene un identificador único, que debe incluirse en fieldResult.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado de la entidad unida</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seleccionamos los departamentos en los que hay empleados contratados después de principios de 2000, junto con estos empleados.</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMapping();<font></font>
        $rsm-&gt;addEntityResult(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_no'</span>, <span class="hljs-string">'deptNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'deptName'</span>);<font></font>
<font></font>
        $rsm-&gt;addJoinedEntityResult(Employee::class, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'empNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'firstName'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'last_name'</span>, <span class="hljs-string">'lastName'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'birth_date'</span>, <span class="hljs-string">'birthDate'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'gender'</span>, <span class="hljs-string">'gender'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'hire_date'</span>, <span class="hljs-string">'hireDate'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">"
        SELECT *
            FROM departments d
            JOIN dept_emp ON d.dept_no = dept_emp.dept_no
            JOIN employees e on dept_emp.emp_no = e.emp_no
        WHERE e.hire_date &gt; DATE ('1999-12-31')
       "</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMappingBuilder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, trabajar directamente con el objeto ResultSetMapping es algo complicado y lo hace extremadamente detallado para describir la comparación de la selección y los objetos. Además, Doctrine proporciona una herramienta más conveniente: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMappingBuilder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que es un contenedor en RSM y agrega métodos más convenientes para trabajar con el mapeo. Por ejemplo, el método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generateSelectClause</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que le permite crear un parámetro para la parte SELECT de la consulta con una descripción de los campos necesarios para la selección. La solicitud anterior puede reescribirse en una forma más simple.</font></font><br>
<br>
<pre><code class="php hljs">        $sql = <span class="hljs-string">"
        SELECT {$rsm-&gt;generateSelectClause()}
            FROM departments d
            JOIN dept_emp ON d.dept_no = dept_emp.dept_no
            JOIN employees e on dept_emp.emp_no = e.emp_no
        WHERE e.hire_date &gt; DATE ('1999-12-31')
       "</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena señalar que si no especifica todos los campos del objeto creado, Doctrine devolverá un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objeto parcial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuyo uso puede estar justificado en algunos casos, pero </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">su comportamiento es peligroso y no se recomienda</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En cambio, ResultSetMappingBuilder le permite no especificar cada campo de la clase final, sino utilizar entidades descritas a través de anotaciones (configuraciones yaml, xml). </font><font style="vertical-align: inherit;">Reescribimos nuestro RSM de la solicitud anterior, teniendo en cuenta estos métodos:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMappingBuilder(<span class="hljs-keyword">$this</span>-&gt;entityManager);<font></font>
        $rsm-&gt;addRootEntityFromClassMetadata(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addJoinedEntityFromClassMetadata(Employee::class, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'empNo'</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado escalar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El uso generalizado de la entidad descrita no está justificado, puede conducir a problemas de rendimiento, ya que Doctrine necesita crear muchos objetos que no se utilizarán por completo en el futuro. </font><font style="vertical-align: inherit;">Para tales casos, se proporciona una herramienta de mapeo de resultados escalares, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addScalarResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elija el salario promedio para cada departamento:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> ResultSetMappingBuilder(<span class="hljs-keyword">$this</span>-&gt;entityManager);<font></font>
<font></font>
        $rsm-&gt;addScalarResult(<span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'department'</span>, <span class="hljs-string">'string'</span>);<font></font>
        $rsm-&gt;addScalarResult(<span class="hljs-string">'avg_salary'</span>, <span class="hljs-string">'salary'</span>, <span class="hljs-string">'integer'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">"
            SELECT d.dept_name, AVG(s.salary) AS avg_salary
            FROM departments d
            JOIN dept_emp de on d.dept_no = de.dept_no
            JOIN employees e on de.emp_no = e.emp_no
            JOIN salaries s on e.emp_no = s.emp_no
            GROUP BY d.dept_name
        "</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer argumento para el método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addScalarResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el nombre de la columna en el conjunto de resultados, y el segundo es la clave de la matriz de resultados que Doctrine devolverá. </font><font style="vertical-align: inherit;">El tercer parámetro es el tipo del valor del resultado. </font><font style="vertical-align: inherit;">El valor de retorno siempre será una matriz de matrices.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapeo DTO</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero trabajar con matrices, especialmente cuando tienen una estructura compleja, no es muy conveniente. </font><font style="vertical-align: inherit;">Debe tener en cuenta los nombres de las claves, los tipos de campo. </font><font style="vertical-align: inherit;">Doctrine DQL tiene la capacidad de usar DTO simples en los resultados de la selección, por ejemplo:</font></font><br>
<br>
<pre><code class="php hljs">    SELECT <span class="hljs-keyword">NEW</span> DepartmentSalary(d.dept_no, avg_salary) <span class="hljs-keyword">FROM</span> …</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué pasa con Native Query y RSM? </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doctrine no proporciona capacidades documentadas para crear nuevos DTO</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero al usar la propiedad </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newObjectMappings,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podemos especificar los objetos a los que queremos asignar los resultados de la selección. </font><font style="vertical-align: inherit;">A diferencia de Entity, UnitOfWork no controlará estos objetos y no es necesario que estén en los espacios de nombres especificados en la configuración. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Complemente RSM del ejemplo anterior:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm-&gt;newObjectMappings[<span class="hljs-string">'dept_name'</span>] = [
            <span class="hljs-string">'className'</span> =&gt; DepartmentSalary::class,
            <span class="hljs-string">'argIndex'</span> =&gt; <span class="hljs-number">0</span>,
            <span class="hljs-string">'objIndex'</span> =&gt; <span class="hljs-number">0</span>,<font></font>
        ];<font></font>
<font></font>
        $rsm-&gt;newObjectMappings[<span class="hljs-string">'avg_salary'</span>] = [
            <span class="hljs-string">'className'</span> =&gt; DepartmentSalary::class,
            <span class="hljs-string">'argIndex'</span> =&gt; <span class="hljs-number">1</span>,
            <span class="hljs-string">'objIndex'</span> =&gt; <span class="hljs-number">0</span>,<font></font>
        ];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clave en la matriz del campo newObjectMappings apunta a la columna resultante, pero su valor es otra matriz que describe el objeto que se está creando. </font><font style="vertical-align: inherit;">La clave </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">className</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> define el nombre de clase del nuevo objeto, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">argIndex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el orden del argumento en el constructor del objeto, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objIndex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el orden del objeto, si queremos obtener varios objetos de cada fila de la selección.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meta resultado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado meta se usa para obtener metadatos de columnas, como claves foráneas o columnas discriminadoras. </font><font style="vertical-align: inherit;">Desafortunadamente, no pude encontrar un ejemplo basado en la base de datos de empleados, así que tengo que limitarme a una descripción y ejemplos de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> ResultSetMapping;<font></font>
        $rsm-&gt;addEntityResult(<span class="hljs-string">'User'</span>, <span class="hljs-string">'u'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'id'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'name'</span>);<font></font>
        $rsm-&gt;addMetaResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'address_id'</span>, <span class="hljs-string">'address_id'</span>);<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;_em-&gt;createNativeQuery(<span class="hljs-string">'SELECT id, name, address_id FROM users WHERE name = ?'</span>, $rsm);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, utilizando el método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addMetaResult,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le decimos a Doctine que la tabla de usuarios tiene una clave externa en las direcciones, pero en lugar de cargar la asociación en la memoria (carga ansiosa), creamos un objeto proxy que almacena el identificador de la entidad y, cuando se accede, carga ella de la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las bases de datos relacionales clásicas no ofrecen mecanismos de herencia de tablas, mientras que la herencia está muy extendida en el modelo de objetos. </font><font style="vertical-align: inherit;">El resultado de nuestra selección se puede proyectar en la jerarquía de clases, de acuerdo con algún atributo, que es el valor de la columna &lt;discriminator_column&gt; en la selección resultante. </font><font style="vertical-align: inherit;">En este caso, podemos decirle a RSM qué columna Doctrine debería determinar la clase instanciada mediante el método </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setDiscriminatorColumn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Doctrine es muy rico en varias características, incluidas aquellas que no todos los desarrolladores conocen. </font><font style="vertical-align: inherit;">En esta publicación, intenté presentar una comprensión de la operación de uno de los componentes clave de ORM: ResultSetMapping en combinación con Native Query. </font><font style="vertical-align: inherit;">Usar consultas verdaderamente complejas y específicas de la plataforma mientras se mantiene la disponibilidad y la comprensión de los ejemplos sería una tarea difícil, porque se hace hincapié en comprender el trabajo de ResultSetMapping. </font><font style="vertical-align: inherit;">Después de eso, puede usarlo en consultas realmente complejas para sus bases de datos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496154/index.html">Automatización de servicio al cliente: una solución integral de DeepPavlov</a></li>
<li><a href="../es496156/index.html">Cómo los sistemas de análisis de tráfico detectan tácticas de piratas informáticos por MITER ATT & CK, Parte 3</a></li>
<li><a href="../es496160/index.html">Estudiamos el motor VoIP Mediastreamer2. Parte 5</a></li>
<li><a href="../es496162/index.html">Terraform, mono repositorios y cumplimiento como código</a></li>
<li><a href="../es496164/index.html">Durante la crisis perdí mi trabajo y ahora tengo miedo de escribir código inteligente para no asustar las últimas vacantes</a></li>
<li><a href="../es496170/index.html">Estamos condenados # 1 // Udalenka en crisis y muerte de originalidad</a></li>
<li><a href="../es496174/index.html">Aumento de la demanda de análisis, equipos de productos, Amazon, Israel, Singapur, trabajo remoto, etc., se discutió mucho.</a></li>
<li><a href="../es496176/index.html">Gran conferencia virtual: experiencia del mundo real en la protección de datos de empresas digitales modernas</a></li>
<li><a href="../es496178/index.html">Swift 5.2. Resumen de todos los cambios</a></li>
<li><a href="../es496180/index.html">Cuida la sombra de la juventud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>