<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>◻️ 💇🏿 🐀 インデックスの忘却をやめ、テストで実行プランのチェックを開始する方法 💓 🤝 👈🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="少し前に、不愉快な話が私に起こりました。それがgithub上の小さなプロジェクトのきっかけとなり、この記事につながりました。
 
 典型的な日、定期的なリリース：すべてのタスクはQAエンジニアによってチェックおよびダウンされるため、神聖な牛の穏やかさをもって、ステージに「ロール」します。アプリケーシ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>インデックスの忘却をやめ、テストで実行プランのチェックを開始する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/454066/"><img src="https://habrastorage.org/webt/cb/kk/ps/cbkkpswi947gczpzqmwkyh2pwmm.jpeg" alt="CDPV"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し前に、不愉快な話が私に起こりました。それがgithub上の小さなプロジェクトのきっかけとなり、この記事につながりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
典型的な日、定期的なリリース：すべてのタスクはQAエンジニアによってチェックおよびダウンされるため、神聖な牛の穏やかさをもって、ステージに「ロール」します。アプリケーションはログで適切に動作します-沈黙。切り替えを行うことにします（ステージ&lt;-&gt;製品）。切り替えて、計器を見ます... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数分経ちますが、飛行は安定しています。 QAエンジニアが煙のテストを行い、アプリケーションが何らかの形で不自然に遅くなっていることに気付きました。キャッシュをウォームアップするためにオフに書き込みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数分経過すると、最初の苦情は最初の行からのものです。データがクライアントから非常に長時間ダウンロードされ、アプリケーションの速度が低下し、応答に時間がかかります。私たちは心配し始めます...ログを見て、考えられる理由を探します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数分後、DB管理者から手紙が届きます。</font><font style="vertical-align: inherit;">彼らは、データベース（以下、データベースと呼びます）に対するクエリの実行時間がすべての可能な境界を突破し、無限になりがちであると書いています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は監視を開き（私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaMelody</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">）、これらの要求を見つけました。</font><font style="vertical-align: inherit;">PGAdminを起動して再現します。</font><font style="vertical-align: inherit;">本当に長い。</font><font style="vertical-align: inherit;">「説明」を追加して、実行計画を確認します...つまり、インデックスについて忘れていました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードレビューでは不十分なのはなぜですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その事件は私に多くを教えました。</font><font style="vertical-align: inherit;">はい、私は1時間「消火」し、次のような方法で製品に直接適切なインデックスを作成しました（CONCURRENTLYオプションを忘れないでください）：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> CONCURRENTLY <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> ix_pets_name 
<span class="hljs-keyword">ON</span> pets_table (name_column);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同意します。これは、ダウンタイムを伴う展開と同じでした。私が取り組んでいるアプリケーションの場合、これは受け入れられません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は結論を出し、コードレビューのチェックリストに特別な太字のポイントを追加しました。開発プロセス中にリポジトリクラスの1つが追加/変更されたことがわかった場合、SQL移行をチェックして、そこでインデックスを作成および変更するスクリプトの存在を確認します。彼がそこにいない場合、私は著者に質問を書いています：彼はここでインデックスが必要ないことを確信していますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データが少ない場合はインデックスが不要である可能性がありますが、行数が数百万でカウントされているテーブルで作業すると、インデックスエラーが致命的になり、記事の冒頭で説明したようになる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、プルリクエスト（以下PR）の作成者に、HQLで作成したクエリが少なくとも部分的にインデックスでカバーされていることを100％確認するよう依頼します（インデックススキャンが使用されます）。</font><font style="vertical-align: inherit;">このために、開発者は：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションを起動します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログで変換された（HQL-&gt; SQL）クエリを探します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGAdminまたは別のデータベース管理ツールを開きます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実験を妨げないように、ローカルデータベースに、テストに許容される量のデータを生成します（最低10K-20Kレコード）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求を満たす</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行計画を要求する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それを注意深く研究し、適切な結論を導き出す</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを追加/変更し、実行プランが適切であることを確認します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストのカバレッジがチェックしたPRの購読を解除します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストのリスクと重大度を専門的に評価し、そのアクションを再確認できます</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
日常的な行動や人的要因はたくさんありますが、しばらくの間は満足していて、それで生活していました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帰り道に</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは、少なくとも時々、音楽やポッドキャストを聴かずに仕事から離れることが非常に役立つと言います。</font><font style="vertical-align: inherit;">現時点では、人生について考えるだけで、興味深い結論やアイデアに出会うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある日、私は家に帰って、その日何が起こったのか考えました。</font><font style="vertical-align: inherit;">いくつかのレビューがあり、それぞれをチェックリストでチェックして、上記の一連のアクションを実行しました。</font><font style="vertical-align: inherit;">あの時はとても疲れたんだ、一体何なんだ？</font><font style="vertical-align: inherit;">これを自動的に行うことは不可能ですか？..私はこのアイデアをすばやく「ギャッシュ」したいと思って、一歩踏み出しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の定式化</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行計画において開発者にとって最も重要なことは何ですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、seqは、インデックスがないために大量のデータをスキャンします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、次のテストを行う必要がありました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">製品に似た構成のデータベースで実行</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JPAリポジトリ（Hibernate）によって作成されたデータベースクエリをインターセプトします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行計画を取得</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行計画をパースし、チェックに便利なデータ構造に配置する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assertメソッドの便利なセットを使用して、期待値をチェックします。</font><font style="vertical-align: inherit;">たとえば、そのseqスキャンは使用されません。</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトタイプを作成して、この仮説をすばやくテストする必要がありました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューションアーキテクチャ</font></font></h2><br>
<img src="https://habrastorage.org/webt/6e/2i/bz/6e2ibz7cl8roycahqee4yb1lqqq.png" alt="checkinxアーキテクチャ"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決される最初の問題は、バージョンと設定が製品で使用されているものと一致する実際のデータベースでテストを開始することでした。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">DockerとTestContainersの</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
おかげで</font><font style="vertical-align: inherit;">、この問題を解決しています。</font><font style="vertical-align: inherit;">
SqlInterceptor、ExecutionPlanQuery、ExecutionPlanParse、およびAssertServiceは、現在Postgresに実装しているインターフェイスです。</font><font style="vertical-align: inherit;">他のデータベースを実装する計画です。</font><font style="vertical-align: inherit;">参加したい場合-ようこそ。</font><font style="vertical-align: inherit;">コードはKotlinで書かれています。</font><font style="vertical-align: inherit;">
これらすべてをまとめてGitHubに投稿し、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">checkinx-utils</font></a><font style="vertical-align: inherit;">を呼び出し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを繰り返す必要はありません。Maven/ Gradleでcheckinxに依存関係を接続し、便利なアサートを使用するだけです。</font><font style="vertical-align: inherit;">これを行う方法については、以下で詳しく説明します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CheckInxコンポーネントの相互作用の説明</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxyDataSource</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決される最初の問題は、実行の準備ができているデータベースクエリのインターセプトでした。</font><font style="vertical-align: inherit;">質問などせずに、すでに確立されたパラメータを使用 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、実際のdataSourceを特定のプロキシでラップする必要があります。これにより、クエリ実行パイプラインに統合され、それに応じてそれらがインターセプトされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのようなProxyDataSourceはすでに多くの人によって実装されています。</font><font style="vertical-align: inherit;">私は既製の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ttddyy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューション</font><font style="vertical-align: inherit;">を使用しました。これにより、必要なリクエストをインターセプトするリスナーをインストールできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DataSourceWrapper（BeanPostProcessor）クラスを使用して元のDataSourceを置き換えます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SqlInterceptor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本質的に、そのstart（）メソッドはリスナーをproxyDataSourceに設定し、要求のインターセプトを開始して、それらを内部ステートメントリストに格納します。</font><font style="vertical-align: inherit;">stop（）メソッドはそれぞれ、インストールされたリスナーを削除します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExecutionPlanQuery</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、元のリクエストが実行プランのリクエストに変換されます。</font><font style="vertical-align: inherit;">Postgresの場合、これはクエリキーワード "EXPLAIN"への追加です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このクエリはtestcontaindersから同じデータベースで実行され、「生の」実行プラン（行のリスト）が返されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExecutionPlanParser</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「未加工」の実行計画で作業するのは不便です。</font><font style="vertical-align: inherit;">したがって、ノード（PlanNode）で構成されるツリーに解析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のExecutionPlanの例を使用してPlanNodeフィールドを分析してみましょう。</font></font><br>
<br>
<pre><code class="sql hljs">Index Scan using ix_pets_age on pets &nbsp;(cost=0.29..8.77 rows=1 width=36)<font></font>
 &nbsp;Index Cond: (age &lt; 10)<font></font>
 &nbsp;Filter: ((name)::text = 'Jack'::text)</code></pre><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">物件</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raw：文字列</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペットでix_pets_ageを使用したインデックススキャン（コスト= 0.29..8.77行= 1幅= 36）</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース文字列</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル：文字列？</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペット</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル名</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ターゲット：文字列？</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ix_pets_age</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックス名</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対象範囲：文字列？</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックススキャン</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コーティング</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CoverageLevel</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハーフ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コーティングの抽象化（ZERO、HALF、FULL）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子：MutableList &lt;PlanNode&gt;</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">子ノード</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロパティ：MutableList &lt;Pair &lt;String、String &gt;&gt;</font></font></td>
<td><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：インデックス条件、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：（年齢&lt;10）; </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：フィルター、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：（（name）:: text = 'Jack' :: text）</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロパティ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その他：MutableList &lt;String&gt;</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在のバージョンのcheckinxでは認識できなかったすべてのこと</font></font></td>
</tr>
</tbody></table></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AssertService</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パーサーによって返されたデータ構造ですでに正常に動作することはすでに可能です。</font><font style="vertical-align: inherit;">CheckInxAssertServiceは、上記のPlanNodeツリーの一連のチェックです。</font><font style="vertical-align: inherit;">それはあなたがチェックのあなた自身のラムダを設定するか、または私の意見では最も人気のある定義済みのラムダを使用することを可能にします。</font><font style="vertical-align: inherit;">たとえば、クエリにシーケンススキャンが含まれないようにしたり、特定のインデックスが使用されているかどうかを確認したりします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カバレッジレベル</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常に重要な列挙型です。個別に説明します。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOT_USING</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のターゲット（インデックス）が使用されていないことを確認します</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼロ</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスは使用されません（Seq Scan）</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハーフ</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスによるクエリの部分的なカバレッジ（インデックススキャン）。</font><font style="vertical-align: inherit;">たとえば、検索はインデックスによって実行されますが、結果のデータではテーブルを参照します</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いっぱい</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスによるクエリの全範囲（インデックスのみのスキャン）</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">わからない</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不明な報道。</font><font style="vertical-align: inherit;">何らかの理由でインストールできませんでした。</font></font><br>
</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、いくつかの使用例を確認します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CheckInxを使用したテスト例</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitHub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checkinx-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">別のプロジェクトを作成し</font><font style="vertical-align: inherit;">ました。ペットテーブルのJPAリポジトリを実装し、このリポジトリでカバレッジやインデックスなどをチェックするためのテストを行いました。</font><font style="vertical-align: inherit;">そこを出発点として見ると便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようなテストがあるかもしれません：</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFindByLocation</span><span class="hljs-params">()</span></span> {
 &nbsp;&nbsp;<span class="hljs-comment">// ARRANGE</span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> location = <span class="hljs-string">"Moscow"</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//   ,      10-20.</span>
 &nbsp;&nbsp;<span class="hljs-comment">//   TestNG      @BeforeClass</span>
 &nbsp;&nbsp;IntRange(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>).forEach {
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">val</span> pet = Pet()<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pet.id = UUID.randomUUID()<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pet.age = it<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pet.location = <span class="hljs-string">"Saint Petersburg"</span>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pet.name = <span class="hljs-string">"Jack-<span class="hljs-variable">$it</span>"</span><font></font>
<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;repository.save(pet)<font></font>
 &nbsp;&nbsp;}<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ACT</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//   </span><font></font>
 &nbsp;&nbsp;sqlInterceptor.startInterception()<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//  </span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> pets = repository.findByLocation(location)<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//  </span><font></font>
 &nbsp;&nbsp;sqlInterceptor.stopInterception()<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ASSERT</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//       </span>
 &nbsp;&nbsp;assertEquals(<span class="hljs-number">1</span>, sqlInterceptor.statements.size.toLong())<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ,    ix_pets_location    (Index Scan)</span>
 &nbsp;&nbsp;checkInxAssertService.assertCoverage(CoverageLevel.HALF, <span class="hljs-string">"ix_pets_location"</span>, sqlInterceptor.statements[<span class="hljs-number">0</span>])<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//        ,      Seq Scan,      </span>
 &nbsp;&nbsp;checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[<span class="hljs-number">0</span>])<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ...  ,    </span><font></font>
 &nbsp;&nbsp;checkInxAssertService.assertPlan(plan) {<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it.coverageLevel.level &lt; CoverageLevel.FULL.level<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装計画は次のようになります。</font></font><br>
<br>
<pre><code class="sql hljs">Index Scan using ix_pets_location on pets pet0_ &nbsp;(cost=0.29..4.30 rows=1 width=46)<font></font>
 &nbsp;Index Cond: ((location)::text = 'Moscow'::text)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...または、インデックスを忘れた場合（テストは赤くなります）：</font></font><br>
<br>
<pre><code class="sql hljs">Seq Scan on pets pet0_ &nbsp;(cost=0.00..19.00 rows=4 width=84)<font></font>
 &nbsp;Filter: ((location)::text = 'Moscow'::text)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のプロジェクトでは、ほとんどの場合、実行プランにSeq Scanがないという最も単純なアサートを使用しています。</font></font><br>
<br>
<pre><code class="kotlin hljs">checkInxAssertService.assertCoverage(CoverageLevel.HALF, sqlInterceptor.statements[<span class="hljs-number">0</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなテストの存在は、少なくとも実装計画を調査したことを示唆しています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、プロジェクト管理がより明確になり、コードのドキュメント化と予測可能性が向上します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">経験豊富なモード</font></font></b><div class="spoiler_text">   heckInxAssertService,    ,      (ExecutionPlanParser) , ,  «» execution plan (  ExecutionPlanQuery).<br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFindByLocation</span><span class="hljs-params">()</span></span> {
 &nbsp;&nbsp;<span class="hljs-comment">// ARRANGE</span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> location = <span class="hljs-string">"Moscow"</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ACT</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//   </span><font></font>
 &nbsp;&nbsp;sqlInterceptor.startInterception()<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//  </span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> pets = repository.findByLocation(location)
 &nbsp;&nbsp;<span class="hljs-comment">//  </span><font></font>
 &nbsp;&nbsp;sqlInterceptor.stopInterception()<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ASSERT</span><font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//  ""  </span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> executionPlan = executionPlanQuery.execute(sqlInterceptor.statements[<span class="hljs-number">0</span>])<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">//    - </span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> plan = executionPlanParser.parse(executionPlan)<font></font>
 &nbsp;&nbsp;assertNotNull(plan)<font></font>
<font></font>
 &nbsp;&nbsp;<span class="hljs-comment">// ...   </span>
 &nbsp;&nbsp;<span class="hljs-keyword">val</span> rootNode = plan.rootPlanNode<font></font>
 &nbsp;&nbsp;assertEquals(<span class="hljs-string">"Index Scan"</span>, rootNode.coverage)<font></font>
 &nbsp;&nbsp;assertEquals(<span class="hljs-string">"ix_pets_location"</span>, rootNode.target)<font></font>
 &nbsp;&nbsp;assertEquals(<span class="hljs-string">"pets pet0_"</span>, rootNode.table)<font></font>
}</code></pre></div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトへの接続</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のプロジェクトでは、そのようなテストを別のグループに割り当て、それを集中統合テストと呼びました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
checkinx-utilsを使用して接続および開始するのは簡単です。</font><font style="vertical-align: inherit;">ビルドスクリプトから始めましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にリポジトリを接続します。</font><font style="vertical-align: inherit;">いつか私はcheckinxをmavenにアップロードしますが、今はアーティファクトをGitHubからjitpack経由でのみダウンロードできます。</font></font><br>
<br>
<pre><code class="plaintext hljs">repositories {<font></font>
 &nbsp;// ...<font></font>
 &nbsp;&nbsp;maven { url 'https://jitpack.io' }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、依存関係を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">dependencies {<font></font>
// ...<font></font>
 &nbsp;&nbsp;implementation 'com.github.tinkoffcreditsystems:checkinx-utils:0.2.0'<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成を追加して接続を完了します。</font><font style="vertical-align: inherit;">現在、Postgresのみがサポートされています。</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Profile(<span class="hljs-meta-string">"test"</span>)</span>
<span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">open</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckInxConfig</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストプロファイルに注意してください。</font><font style="vertical-align: inherit;">それ以外の場合は、ProdにProxyDataSourceがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgresConfigはいくつかのBeanを接続します：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DataSourceWrapper</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgresInterceptor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgresExecutionPlanParser</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgresExecutionPlanQuery</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CheckInxAssertServiceImpl</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のAPIで提供されていない何らかのカスタマイズが必要な場合は、いつでもBeanの1つを実装に置き換えることができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既知の問題点</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring CGLIBプロキシが原因で、DataSourceWrapperが元のdataSourceを置き換えることができない場合があります。</font><font style="vertical-align: inherit;">この場合、DataSourceがBeanPostProcessorに到達するのではなく、ScopedProxyFactoryBeanに到達し、型チェックに問題があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も簡単な解決策は、テスト用のHikariDataSourceを手動で作成することです。</font><font style="vertical-align: inherit;">次に、構成は次のようになります。</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Profile(<span class="hljs-meta-string">"test"</span>)</span>
<span class="hljs-meta">@ImportAutoConfiguration(classes = [PostgresConfig::class])</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">open</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckInxConfig</span> </span>{
 &nbsp;&nbsp;<span class="hljs-meta">@Primary</span>
 &nbsp;&nbsp;<span class="hljs-meta">@Bean</span>
 &nbsp;&nbsp;<span class="hljs-meta">@ConfigurationProperties(<span class="hljs-meta-string">"spring.datasource"</span>)</span>
 &nbsp;&nbsp;<span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dataSource</span><span class="hljs-params">()</span></span>: DataSource {
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> DataSourceBuilder.create()<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.type(HikariDataSource::<span class="hljs-keyword">class</span>.&lt;i&gt;java&lt;/i&gt;)<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build()<font></font>
 &nbsp;&nbsp;}<font></font>
<font></font>
 &nbsp;&nbsp;@Bean<font></font>
 &nbsp;&nbsp;@ConfigurationProperties(<span class="hljs-string">"spring.datasource.configuration"</span>)
 &nbsp;&nbsp;<span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dataSource</span><span class="hljs-params">(properties: <span class="hljs-type">DataSourceProperties</span>)</span></span>: HikariDataSource {
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> properties.initializeDataSourceBuilder()<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.type(HikariDataSource::<span class="hljs-keyword">class</span>.&lt;i&gt;java&lt;/i&gt;)<font></font>
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.build()<font></font>
 &nbsp;&nbsp;}<font></font>
}</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発計画</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私以外の誰かがこれを必要とするかどうかを知りたいですか？</font><font style="vertical-align: inherit;">これを行うには、調査を作成します。</font><font style="vertical-align: inherit;">正直にお答えさせていただきます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本当に必要なものを確認し、assertメソッドの標準リストを拡張してください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のデータベースの実装を記述します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlInterceptor.statements [0]の構造は非常に明白ではありません。改善したいと思います。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰かが参加して、コトリンで練習することである程度の信用を得たいと思っているとうれしいです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメントがあることは間違いありません。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリプランナーが製品でどのように動作するかを予測することは不可能</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><i><font style="vertical-align: inherit;">それはすべて、収集された統計に依存し</font></i><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに、プランナー。</font><font style="vertical-align: inherit;">以前に収集された統計を使用して、テストされているものとは異なる計画を構築できます。</font><font style="vertical-align: inherit;">意味が少し異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プランナーの役割は、リクエストを改善することであり、悪化させることではありません。</font><font style="vertical-align: inherit;">したがって、明らかな理由もなく、突然Seq Scanを使用することはありませんが、無意識のうちに使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CheckInxが必要なのは、テストを作成するときに、クエリ実行プランを調べてインデックスを作成する可能性を検討することを忘れないでください。逆の場合も同様です。ここでは、インデックスが不要であり、Seq Scanに満足していることをテストで明確に示します。</font><font style="vertical-align: inherit;">これにより、コードレビューに関する不要な質問を省くことができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/TinkoffCreditSystems/checkinx-utils</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/dsemyriazhko/checkinx-demo</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/ttddyy/datasource-proxy</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://mvnrepository.com/artifact/org.testcontainers/postgresql</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/javamelody/javamelody/wiki</a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454056/index.html">異なるデータセンターのKubernetesクラスターを接続する方法</a></li>
<li><a href="../ja454058/index.html">C＃コードを測定するための便利なツール</a></li>
<li><a href="../ja454060/index.html">速度に依存しない非同期回路の予期しない外観</a></li>
<li><a href="../ja454062/index.html">法人電話-スイスのナイフのように：在庫、チャット、サポートコール、お問い合わせ用</a></li>
<li><a href="../ja454064/index.html">AIの秘話</a></li>
<li><a href="../ja454070/index.html">通勤用のモノホイールの選択</a></li>
<li><a href="../ja454072/index.html">5Gに関する嘘の最大の5つの例</a></li>
<li><a href="../ja454076/index.html">DotNext 2019 Piter：小さなレポート</a></li>
<li><a href="../ja454078/index.html">SMSと登録なしで無料の「モバイルコンテンツ」。メガホン詐欺の詳細</a></li>
<li><a href="../ja454082/index.html">プラスチック波：海の生態学的災害</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>