<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩 🈂️ ⛎ 大きなLinuxページでのPostgreSQLのベンチマーク 🆒 📔 🧜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Linuxカーネルは、パフォーマンスに影響を与える可能性のある幅広い構成オプションを提供します。すべては、アプリケーションとワークロードに適した構成を取得することです。他のデータベースと同様に、PostgreSQLは最適な構成のためにLinuxカーネルを使用します。調整が不十分な設定では、パフォーマ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>大きなLinuxページでのPostgreSQLのベンチマーク</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458910/"><img width="40%" align="left" src="https://habrastorage.org/webt/u0/hs/uc/u0hsucgpyp_pgw1mwtyzdtkvd1o.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxカーネルは、パフォーマンスに影響を与える可能性のある幅広い構成オプションを提供します。すべては、アプリケーションとワークロードに適した構成を取得することです。他のデータベースと同様に、PostgreSQLは最適な構成のためにLinuxカーネルを使用します。調整が不十分な設定では、パフォーマンスが低下する可能性があります。したがって、パフォーマンスの低下を避けるために、各チューニングセッション後にデータベースのパフォーマンスを測定することが重要です。以前の出版物の1つである「PostgreSQL最適化のためのLinuxカーネルパラメーターのチューニング」では、最も有用なLinuxカーネルパラメーターのいくつかと、それらがデータベースパフォーマンスの向上にどのように役立つかについて説明しました。次に、異なるPostgreSQLワークロードで大きなLinuxページを設定した後、テスト結果を共有します。さまざまなPostgreSQLの負荷サイズと同時クライアント数に対して徹底的なテストを実行しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試験機</font></font></h2> <br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supermicroサーバー：</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> インテル®Xeon®CPU E5-2683 v3 @ 2.00 GHz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2ソケット/ 28コア/ 56スレッド</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> メモリ：256GBのRAM</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ストレージ：SAMSUNG SM863 1.9TB Enterprise SSD</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ファイルシステム：ext4 / xfs</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OS：Ubuntu 16.04.4、カーネル4.13.0-36-generic</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PostgreSQL：バージョン11</font></font></li>
</ul><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxカーネル設定</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
透明なラージページ（Transparent HugePages）を無効にする以外に、最適化や調整を行わずにデフォルトのカーネル設定を使用しました。</font><font style="vertical-align: inherit;">透過的な大きなページはデフォルトで有効になっており、ページサイズが強調表示されます。これは、データベースでの使用には推奨されない場合があります。</font><font style="vertical-align: inherit;">通常、データベースには、透明な大きなページではカバーされない大きな固定サイズのページが必要です。</font><font style="vertical-align: inherit;">したがって、この機能を無効にして、デフォルトでクラシックラージページを使用することを常にお勧めします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLの設定</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのテストで統一されたPostgreSQL設定を使用して、大きなLinuxページのさまざまな設定でさまざまなPostgreSQLワークロードを記録しました。</font><font style="vertical-align: inherit;">すべてのテストで使用されるPostgreSQLの設定は次のとおりです</font></font><br>
<br>
<sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。postgresql.conf</font></font></sup><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">shared_buffers</span> = <span class="hljs-string">'64GB'</span>
work_mem = <span class="hljs-string">'1GB'</span>
random_page_cost = <span class="hljs-string">'1'</span> 
maintenance_work_mem = <span class="hljs-string">'2GB'</span>
synchronous_commit = <span class="hljs-string">'on'</span>
seq_page_cost = <span class="hljs-string">'1'</span> 
max_wal_size = <span class="hljs-string">'100GB'</span>
checkpoint_timeout = <span class="hljs-string">'10min'</span>
synchronous_commit = <span class="hljs-string">'on'</span>
checkpoint_completion_target = <span class="hljs-string">'0.9'</span>
autovacuum_vacuum_scale_factor = <span class="hljs-string">'0.4'</span>
effective_cache_size = <span class="hljs-string">'200GB'</span>
min_wal_size = <span class="hljs-string">'1GB'</span>
wal_compression = <span class="hljs-string">'ON'</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストスキーム</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストでは、テストスキームが重要な役割を果たします。</font><font style="vertical-align: inherit;">すべてのテストは、実行ごとに30分間3回実行されます。</font><font style="vertical-align: inherit;">私はこれら3つの指標の平均を取った。</font><font style="vertical-align: inherit;">テストは、PostgreSQL </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbench</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンステストツールを使用して行われました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">pgbenchはスケール係数で動作し、1つのスケール係数は約16 MBのワークロードです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなページ（HugePages）</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linuxでは、デフォルトで4Kページのメモリと大きなページが使用されます。 BSDにはスーパーページがあり、Windowsにはラージページがあります。 PostgreSQLはラージページのみをサポートします（Linux）。メモリ使用量が多い場合、ページが小さいとパフォーマンスが低下します。ラージページをインストールすることで、アプリケーションに割り当てられるメモリを増やし、したがって、割り当て/スワッピング中に発生する運用コストを削減します。つまり、大きなページを使用すると生産性が向上します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 GBの大きなページサイズを使用する場合の大きなページの設定を次に示します。この情報は/ procからいつでも取得できます。</font></font><br>
<br>
<sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ cat / proc / meminfo | grep -i huge</font></font></sup><br>
<br>
<pre><code class="nginx hljs">AnonHugePages:         0 <span class="hljs-attribute">kB</span>
ShmemHugePages:        <span class="hljs-number">0</span> kB<font></font>
HugePages_Total:     <span class="hljs-number">100</span>
HugePages_Free:       <span class="hljs-number">97</span>
HugePages_Rsvd:       <span class="hljs-number">63</span>
HugePages_Surp:        <span class="hljs-number">0</span>
Hugepagesize:    <span class="hljs-number">1048576</span> kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大きなページの詳細については、以前のブログ投稿をご覧ください。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.percona.com/blog/2018/08/29/tune-linux-kernel-parameters-for-postgresql-optimization/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
通常、大きなページサイズは2 MBと1 GBなので、1 GBのサイズを使用するのが理にかなっています2 MBというはるかに小さいサイズの代わりに。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kerneltalks.com/services/what-is-huge-pages-in-linux /</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試験結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストは、大きなページのさまざまなサイズの全体的な影響を示します。最初のテストスイートは、大きなページを含まないLinux 4Kのデフォルトのページサイズで作成されました。透過的な巨大なページも無効にされ、これらのすべてのテストを通じて無効のままであったことに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、2 MBの大きなページで2番目のテストセットが実行されました。最後に、3番目のテストセットは、1 GBの大きなページで実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのテストはすべてPostgreSQLバージョン11で実行されました。セットには、さまざまなサイズのデータ​​ベースとクライアントの組み合わせが含まれています。以下のグラフは、Y軸にTPS（トランザクション/秒）、データベースサイズ、およびX軸に沿ってデータベースサイズあたりのクライアント数を使用したこれらのテストのパフォーマンス比較結果を示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/pu/1r/1kpu1rufj-fpl3iszxtzvnjxfgg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のグラフから、サイズが共有メモリ内の以前に割り当てられたバッファに残っている場合、クライアントの数とデータベースのサイズによって、ラージページでのパフォーマンスが向上することがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストは、クライアント数と比較したTPSを示しています。この場合、データベースのサイズは48 GBです。 Y軸にはTPSがあり、X軸には接続されているクライアントの数があります。データベースサイズは、64 GBに設定されている共有バッファに収まるほど十分に小さいです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fc/j_/kn/fcj_knw5ujqg-vvyzcxnl2wkclu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラージページが1 GBに設定されている場合、クライアントが多いほど、相対的なパフォーマンスが向上します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のグラフは、96 GBのデータベースサイズを除いて、上記のグラフと同じです。</font><font style="vertical-align: inherit;">これは、64 GBに設定されている共有バッファのサイズを超えています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z8/6r/je/z86rjeljjqfr_nyaylzzpv7xf9q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでの重要な観察は、1 GBのラージページでのパフォーマンスはクライアントの数が増えると増加し、最終的には2 MBのラージページや4 KBの標準ページサイズよりもパフォーマンスが向上することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストは、データベースのサイズに応じてTPSを示します。</font><font style="vertical-align: inherit;">この場合、接続されているクライアントの数は32です。Y軸にはTPS、X軸にはデータベースサイズがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/90/oi/cg90oidu2mlqyp40deo9fzcmlki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予想どおり、データベースが事前に割り当てられた大きなページを超えると、パフォーマンスが大幅に低下します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の重要な推奨事項の1つは、Transparent HugePagesを無効にすることです。</font><font style="vertical-align: inherit;">大きなページが有効になっている共有バッファにデータベースを配置すると、パフォーマンスが大幅に向上します。</font><font style="vertical-align: inherit;">大きなページのサイズを選択するには、少量の試行錯誤が必要ですが、データベースサイズが大きい場合、TPSが大幅に増加する可能性がありますが、共有バッファーに収まるほど小さいままです。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458900/index.html">モデムとしてのコンソールカートリッジ</a></li>
<li><a href="../ja458902/index.html">5つの一般的な初心者のPythonの間違い</a></li>
<li><a href="../ja458904/index.html">Rのアニメーション化された棒グラフを使用したNBAチームの勝利数の視覚化</a></li>
<li><a href="../ja458906/index.html">[エカテリンブルク、発表] Flutteron-Flutterの開発に関するワークショップ</a></li>
<li><a href="../ja458908/index.html">ネットワーク経由でドキュメントをスキャンする</a></li>
<li><a href="../ja458912/index.html">imapsyncを使用してZimbraに移行する</a></li>
<li><a href="../ja458914/index.html">Unityでゲームを作成するために知っておくべきこと（必要ではない）</a></li>
<li><a href="../ja458916/index.html">Reactの内部で。実装を一から作成する</a></li>
<li><a href="../ja458918/index.html">ハイパーカジュアルゲームのデザインから学べること</a></li>
<li><a href="../ja458920/index.html">DevOpsファンのための会議</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>